<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Associating threadpool queues with CPU cores. by VSadov &#xB7; Pull Request #18403 &#xB7; dotnet/coreclr &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Associating threadpool queues with CPU cores. by VSadov · Pull Request #18403 · dotnet/coreclr · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>There appears to be an issue with threads trampling on one another due to queue sharing. Repro:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span><span class="pl-en">System</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Diagnostics</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Linq</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Runtime</span>.<span class="pl-en">CompilerServices</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Text</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Threading</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Threading</span>.<span class="pl-en">Tasks</span>;

<span class="pl-k">static</span><span class="pl-k">class</span><span class="pl-en">TaskTreeOrderTest</span>
{
    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-k">int</span><span class="pl-smi">ThreadCount</span><span class="pl-k">=</span><span class="pl-smi">Environment</span>.<span class="pl-smi">ProcessorCount</span><span class="pl-k">*</span><span class="pl-c1">2</span>;
    <span class="pl-k">private</span><span class="pl-k">const</span><span class="pl-k">byte</span><span class="pl-smi">TreeDepth</span><span class="pl-k">=</span><span class="pl-c1">8</span>;
    <span class="pl-k">private</span><span class="pl-k">const</span><span class="pl-k">byte</span><span class="pl-smi">ItemCountPerNode</span><span class="pl-k">=</span><span class="pl-c1">8</span>;

    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">void</span><span class="pl-en">Main</span>()
    {
        <span class="pl-smi">ThreadPool</span>.<span class="pl-en">SetMinThreads</span>(<span class="pl-smi">ThreadCount</span>, <span class="pl-smi">ThreadCount</span>);
        <span class="pl-smi">ThreadPool</span>.<span class="pl-en">SetMaxThreads</span>(<span class="pl-smi">ThreadCount</span>, <span class="pl-smi">ThreadCount</span>);

        <span class="pl-k">var</span><span class="pl-smi">threadArrayCapacity</span><span class="pl-k">=</span> (<span class="pl-smi">ThreadCount</span><span class="pl-k">+</span><span class="pl-c1">1</span>) <span class="pl-k">*</span><span class="pl-c1">16</span>;
        <span class="pl-k">var</span><span class="pl-smi">taskLatencySquareSumsUs</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">double</span>[<span class="pl-smi">threadArrayCapacity</span>];

        <span class="pl-k">const</span><span class="pl-k">int</span><span class="pl-smi">LatencyBucketCount</span><span class="pl-k">=</span><span class="pl-c1">6</span>;
        <span class="pl-k">var</span><span class="pl-smi">taskLatencyCountsBuckets</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">int</span>[<span class="pl-smi">LatencyBucketCount</span>][];
        <span class="pl-k">var</span><span class="pl-smi">taskLatencySumsUsBuckets</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">double</span>[<span class="pl-smi">LatencyBucketCount</span>][];
        <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">b</span><span class="pl-k">=</span><span class="pl-c1">0</span>; <span class="pl-smi">b</span><span class="pl-k">&lt;</span><span class="pl-smi">LatencyBucketCount</span>; <span class="pl-k">++</span><span class="pl-smi">b</span>)
        {
            <span class="pl-smi">taskLatencyCountsBuckets</span>[<span class="pl-smi">b</span>] <span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">int</span>[<span class="pl-smi">threadArrayCapacity</span>];
            <span class="pl-smi">taskLatencySumsUsBuckets</span>[<span class="pl-smi">b</span>] <span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">double</span>[<span class="pl-smi">threadArrayCapacity</span>];
        }

        (<span class="pl-smi">byte</span>, <span class="pl-smi">byte</span>) <span class="pl-en">TaskCommon</span>(<span class="pl-k">object</span><span class="pl-smi">data</span>)
        {
            <span class="pl-k">var</span><span class="pl-smi">startTicksShifted</span><span class="pl-k">=</span><span class="pl-smi">Stopwatch</span>.<span class="pl-en">GetTimestamp</span>() <span class="pl-k">&lt;&lt;</span><span class="pl-c1">16</span>;
            <span class="pl-k">var</span><span class="pl-smi">ulongData</span><span class="pl-k">=</span> (<span class="pl-k">ulong</span>)(<span class="pl-k">long</span>)<span class="pl-smi">data</span>;
            <span class="pl-k">var</span><span class="pl-smi">scheduleTicksShifted</span><span class="pl-k">=</span> (<span class="pl-k">long</span>)(<span class="pl-smi">ulongData</span><span class="pl-k">&amp;</span><span class="pl-k">~</span>(<span class="pl-k">ulong</span>)<span class="pl-c1">0xffff</span>);
            <span class="pl-k">var</span><span class="pl-smi">latencyUs</span><span class="pl-k">=</span><span class="pl-smi">scheduleTicksShifted</span><span class="pl-k">==</span><span class="pl-c1">0</span><span class="pl-k">?</span><span class="pl-c1">0</span><span class="pl-k">:</span><span class="pl-en">TicksToUs</span>((<span class="pl-smi">startTicksShifted</span><span class="pl-k">-</span><span class="pl-smi">scheduleTicksShifted</span>) <span class="pl-k">&gt;&gt;</span><span class="pl-c1">16</span>);
            <span class="pl-k">var</span><span class="pl-smi">depth</span><span class="pl-k">=</span> (<span class="pl-k">byte</span>)((<span class="pl-k">ushort</span>)<span class="pl-smi">ulongData</span><span class="pl-k">&gt;&gt;</span><span class="pl-c1">8</span>);
            <span class="pl-k">var</span><span class="pl-smi">itemCount</span><span class="pl-k">=</span> (<span class="pl-k">byte</span>)<span class="pl-smi">ulongData</span>;

            <span class="pl-k">if</span> (<span class="pl-smi">scheduleTicksShifted</span><span class="pl-k">!=</span><span class="pl-c1">0</span>)
            {
                <span class="pl-k">var</span><span class="pl-smi">threadArrayIndex</span><span class="pl-k">=</span><span class="pl-smi">t_threadArrayIndex</span>;
                <span class="pl-k">if</span> (<span class="pl-smi">threadArrayIndex</span><span class="pl-k">==</span><span class="pl-c1">0</span>)
                    <span class="pl-smi">threadArrayIndex</span><span class="pl-k">=</span><span class="pl-en">InitializeThreadArrayIndex</span>();

                <span class="pl-k">int</span><span class="pl-smi">bucketIndex</span>;
                <span class="pl-k">if</span> (<span class="pl-smi">latencyUs</span><span class="pl-k">&lt;</span><span class="pl-c1">1</span>)
                    <span class="pl-smi">bucketIndex</span><span class="pl-k">=</span><span class="pl-c1">0</span>;
                <span class="pl-k">else</span><span class="pl-k">if</span> (<span class="pl-smi">latencyUs</span><span class="pl-k">&lt;</span><span class="pl-c1">10</span>)
                    <span class="pl-smi">bucketIndex</span><span class="pl-k">=</span><span class="pl-c1">1</span>;
                <span class="pl-k">else</span><span class="pl-k">if</span> (<span class="pl-smi">latencyUs</span><span class="pl-k">&lt;</span><span class="pl-c1">100</span>)
                    <span class="pl-smi">bucketIndex</span><span class="pl-k">=</span><span class="pl-c1">2</span>;
                <span class="pl-k">else</span><span class="pl-k">if</span> (<span class="pl-smi">latencyUs</span><span class="pl-k">&lt;</span><span class="pl-c1">1000</span>)
                    <span class="pl-smi">bucketIndex</span><span class="pl-k">=</span><span class="pl-c1">3</span>;
                <span class="pl-k">else</span><span class="pl-k">if</span> (<span class="pl-smi">latencyUs</span><span class="pl-k">&lt;</span><span class="pl-c1">10000</span>)
                    <span class="pl-smi">bucketIndex</span><span class="pl-k">=</span><span class="pl-c1">4</span>;
                <span class="pl-k">else</span><span class="pl-smi">bucketIndex</span><span class="pl-k">=</span><span class="pl-c1">5</span>;

                <span class="pl-k">++</span><span class="pl-smi">taskLatencyCountsBuckets</span>[<span class="pl-smi">bucketIndex</span>][<span class="pl-smi">threadArrayIndex</span>];
                <span class="pl-smi">taskLatencySumsUsBuckets</span>[<span class="pl-smi">bucketIndex</span>][<span class="pl-smi">threadArrayIndex</span>] <span class="pl-k">+=</span><span class="pl-smi">latencyUs</span>;
                <span class="pl-smi">taskLatencySquareSumsUs</span>[<span class="pl-smi">threadArrayIndex</span>] <span class="pl-k">+=</span><span class="pl-smi">latencyUs</span><span class="pl-k">&lt;=</span><span class="pl-c1">1</span><span class="pl-k">?</span><span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-smi">latencyUs</span><span class="pl-k">*</span><span class="pl-smi">latencyUs</span>;
            }

            <span class="pl-k">return</span> (<span class="pl-smi">depth</span>, <span class="pl-smi">itemCount</span>);
        }

        <span class="pl-c"><span class="pl-c">//</span> Simulate parallel test execution under directory tree</span><span class="pl-en">Func</span>&lt;<span class="pl-k">object</span>, <span class="pl-en">Task</span>&lt;<span class="pl-k">bool</span>&gt;&gt; <span class="pl-smi">searchStart</span><span class="pl-k">=</span><span class="pl-c1">null</span>;
        <span class="pl-smi">searchStart</span><span class="pl-k">=</span><span class="pl-en">async</span><span class="pl-smi">data</span> =&gt;
        {
            (<span class="pl-smi">var</span><span class="pl-smi">depth</span>, <span class="pl-smi">var</span><span class="pl-smi">itemCount</span>) <span class="pl-k">=</span><span class="pl-en">TaskCommon</span>(<span class="pl-smi">data</span>);
            <span class="pl-en">Random</span><span class="pl-smi">rng</span><span class="pl-k">=</span><span class="pl-smi">t_rng</span>;
            <span class="pl-k">if</span> (<span class="pl-smi">rng</span><span class="pl-k">==</span><span class="pl-c1">null</span>)
                <span class="pl-smi">t_rng</span><span class="pl-k">=</span><span class="pl-smi">rng</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Random</span>();

            <span class="pl-k">if</span> (<span class="pl-smi">depth</span><span class="pl-k">==</span><span class="pl-c1">0</span>)
            {
                <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">i</span><span class="pl-k">=</span><span class="pl-c1">0</span>; <span class="pl-smi">i</span><span class="pl-k">&lt;</span><span class="pl-smi">itemCount</span>; <span class="pl-k">++</span><span class="pl-smi">i</span>)
                {
                    <span class="pl-c"><span class="pl-c">//</span> Simulate rare test failure</span><span class="pl-k">if</span> (<span class="pl-smi">rng</span>.<span class="pl-en">Next</span>(<span class="pl-c1">1_000_000</span>) <span class="pl-k">==</span><span class="pl-c1">0</span>)
                        <span class="pl-k">return</span><span class="pl-c1">false</span>;
                }
                <span class="pl-k">return</span><span class="pl-c1">true</span>;
            }

            <span class="pl-en">Task</span>&lt;<span class="pl-k">bool</span>&gt; <span class="pl-smi">processRemainingItemsTask</span><span class="pl-k">=</span><span class="pl-c1">null</span>;
            <span class="pl-k">if</span> (<span class="pl-smi">itemCount</span><span class="pl-k">&gt;</span><span class="pl-c1">1</span>)
                <span class="pl-smi">processRemainingItemsTask</span><span class="pl-k">=</span><span class="pl-en">ScheduleTask</span>(<span class="pl-smi">searchStart</span>, <span class="pl-smi">depth</span>, (<span class="pl-k">byte</span>)(<span class="pl-smi">itemCount</span><span class="pl-k">-</span><span class="pl-c1">1</span>));

            <span class="pl-k">bool</span><span class="pl-smi">success</span><span class="pl-k">=</span><span class="pl-smi">itemCount</span><span class="pl-k">==</span><span class="pl-c1">0</span><span class="pl-k">||</span><span class="pl-k">await</span><span class="pl-en">searchStart</span>(<span class="pl-en">PackParameters</span>(<span class="pl-c1">0</span>, (<span class="pl-k">byte</span>)(<span class="pl-smi">depth</span><span class="pl-k">-</span><span class="pl-c1">1</span>), <span class="pl-smi">ItemCountPerNode</span>));

            <span class="pl-k">if</span> (<span class="pl-smi">processRemainingItemsTask</span><span class="pl-k">!=</span><span class="pl-c1">null</span><span class="pl-k">&amp;&amp;</span><span class="pl-k">!</span><span class="pl-k">await</span><span class="pl-smi">processRemainingItemsTask</span>)
                <span class="pl-smi">success</span><span class="pl-k">=</span><span class="pl-c1">false</span>;
            <span class="pl-k">return</span><span class="pl-smi">success</span>;
        };
        <span class="pl-en">var</span><span class="pl-smi">scheduleTaskWorkItem</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">ScheduleTaskWorkItem</span>(<span class="pl-smi">searchStart</span>);

        <span class="pl-en">ScheduleGlobalWorkItem</span>(scheduleTaskWorkItem);

        <span class="pl-en">var</span><span class="pl-smi">sw</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Stopwatch</span>();
        <span class="pl-en">var</span><span class="pl-smi">sb</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">StringBuilder</span>();
        <span class="pl-en">var</span><span class="pl-smi">taskLatencyCountDiffs</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">int</span>[<span class="pl-smi">LatencyBucketCount</span>];
        <span class="pl-en">var</span><span class="pl-smi">taskLatencySumDiffsUs</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">double</span>[<span class="pl-smi">LatencyBucketCount</span>];
        <span class="pl-en">var</span><span class="pl-smi">taskLatencyBucketNames</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">string</span>[]
        {
            <span class="pl-s"><span class="pl-pds">"</span>                &lt;      1 us<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>                &lt;     10 us<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>                &lt;    100 us<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>                &lt;   1000 us<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>                &lt;  10000 us<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>                &gt;= 10000 us<span class="pl-pds">"</span></span>
        };
        <span class="pl-en">while</span> (true)
        {
            <span class="pl-k">double</span><span class="pl-smi">taskLatencySquareSumDiff</span><span class="pl-k">=</span><span class="pl-c1">0</span>;
            <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">b</span><span class="pl-k">=</span><span class="pl-c1">0</span>; <span class="pl-smi">b</span><span class="pl-k">&lt;</span><span class="pl-smi">LatencyBucketCount</span>; <span class="pl-k">++</span><span class="pl-smi">b</span>)
            {
                <span class="pl-smi">taskLatencyCountDiffs</span>[<span class="pl-smi">b</span>] <span class="pl-k">=</span><span class="pl-c1">0</span>;
                <span class="pl-smi">taskLatencySumDiffsUs</span>[<span class="pl-smi">b</span>] <span class="pl-k">=</span><span class="pl-c1">0</span>;
                <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">i</span><span class="pl-k">=</span><span class="pl-c1">16</span>; <span class="pl-smi">i</span><span class="pl-k">&lt;</span><span class="pl-smi">threadArrayCapacity</span>; <span class="pl-smi">i</span><span class="pl-k">+=</span><span class="pl-c1">16</span>)
                {
                    <span class="pl-smi">taskLatencyCountDiffs</span>[<span class="pl-smi">b</span>] <span class="pl-k">-=</span><span class="pl-smi">taskLatencyCountsBuckets</span>[<span class="pl-smi">b</span>][<span class="pl-smi">i</span>];
                    <span class="pl-smi">taskLatencySumDiffsUs</span>[<span class="pl-smi">b</span>] <span class="pl-k">-=</span><span class="pl-smi">taskLatencySumsUsBuckets</span>[<span class="pl-smi">b</span>][<span class="pl-smi">i</span>];
                    <span class="pl-smi">taskLatencySquareSumDiff</span><span class="pl-k">-=</span><span class="pl-smi">taskLatencySquareSumsUs</span>[<span class="pl-smi">i</span>];
                }
            }

            <span class="pl-smi">sw</span>.<span class="pl-en">Restart</span>();
            <span class="pl-smi">Thread</span>.<span class="pl-en">Sleep</span>(<span class="pl-c1">500</span>);
            <span class="pl-smi">sw</span>.<span class="pl-en">Stop</span>();

            <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">b</span><span class="pl-k">=</span><span class="pl-c1">0</span>; <span class="pl-smi">b</span><span class="pl-k">&lt;</span><span class="pl-smi">LatencyBucketCount</span>; <span class="pl-k">++</span><span class="pl-smi">b</span>)
            {
                <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">i</span><span class="pl-k">=</span><span class="pl-c1">16</span>; <span class="pl-smi">i</span><span class="pl-k">&lt;</span><span class="pl-smi">threadArrayCapacity</span>; <span class="pl-smi">i</span><span class="pl-k">+=</span><span class="pl-c1">16</span>)
                {
                    <span class="pl-smi">taskLatencyCountDiffs</span>[<span class="pl-smi">b</span>] <span class="pl-k">+=</span><span class="pl-smi">taskLatencyCountsBuckets</span>[<span class="pl-smi">b</span>][<span class="pl-smi">i</span>];
                    <span class="pl-smi">taskLatencySumDiffsUs</span>[<span class="pl-smi">b</span>] <span class="pl-k">+=</span><span class="pl-smi">taskLatencySumsUsBuckets</span>[<span class="pl-smi">b</span>][<span class="pl-smi">i</span>];
                    <span class="pl-smi">taskLatencySquareSumDiff</span><span class="pl-k">+=</span><span class="pl-smi">taskLatencySquareSumsUs</span>[<span class="pl-smi">i</span>];
                }
            }

            <span class="pl-k">var</span><span class="pl-smi">pendingWorkItemCount</span><span class="pl-k">=</span><span class="pl-smi">ThreadPool</span>.<span class="pl-smi">PendingWorkItemCount</span>;

            <span class="pl-k">double</span><span class="pl-smi">elapsedS</span><span class="pl-k">=</span><span class="pl-smi">sw</span>.<span class="pl-smi">Elapsed</span>.<span class="pl-smi">TotalSeconds</span>;
            <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">b</span><span class="pl-k">=</span><span class="pl-c1">0</span>; <span class="pl-smi">b</span><span class="pl-k">&lt;</span><span class="pl-smi">LatencyBucketCount</span>; <span class="pl-k">++</span><span class="pl-smi">b</span>)
            {
                <span class="pl-smi">sb</span>.<span class="pl-en">AppendLine</span>(
                    <span class="pl-s"><span class="pl-pds">$"</span>{<span class="pl-smi">taskLatencyBucketNames</span>[<span class="pl-smi">b</span>]} | <span class="pl-pds">"</span></span><span class="pl-k">+</span><span class="pl-s"><span class="pl-pds">$"</span>Count/s: {<span class="pl-smi">taskLatencyCountDiffs</span>[<span class="pl-smi">b</span>] <span class="pl-k">/</span><span class="pl-smi">elapsedS</span>,<span class="pl-c1">15</span>:<span class="pl-c1">0.000</span>} | <span class="pl-pds">"</span></span><span class="pl-k">+</span><span class="pl-s"><span class="pl-pds">$"</span>Average latency (us): {<span class="pl-smi">taskLatencySumDiffsUs</span>[<span class="pl-smi">b</span>] <span class="pl-k">/</span><span class="pl-smi">taskLatencyCountDiffs</span>[<span class="pl-smi">b</span>],<span class="pl-c1">15</span>:<span class="pl-c1">0.000</span>}<span class="pl-pds">"</span></span>);
            }
            <span class="pl-smi">sb</span>.<span class="pl-en">AppendLine</span>(<span class="pl-s"><span class="pl-pds">$"</span>Biased average latency (us) | {<span class="pl-smi">Math</span>.<span class="pl-en">Sqrt</span>(<span class="pl-smi">taskLatencySquareSumDiff</span><span class="pl-k">/</span><span class="pl-smi">taskLatencyCountDiffs</span>.<span class="pl-en">Sum</span>()),<span class="pl-c1">15</span>:<span class="pl-c1">0.000</span>}<span class="pl-pds">"</span></span>);
            <span class="pl-smi">sb</span>.<span class="pl-en">AppendLine</span>(<span class="pl-s"><span class="pl-pds">$"</span>                   Count/ms | {<span class="pl-smi">taskLatencyCountDiffs</span>.<span class="pl-en">Sum</span>() <span class="pl-k">/</span> (<span class="pl-smi">elapsedS</span><span class="pl-k">*</span><span class="pl-c1">1000</span>),<span class="pl-c1">15</span>:<span class="pl-c1">0.000</span>}<span class="pl-pds">"</span></span>);
            <span class="pl-smi">sb</span>.<span class="pl-en">AppendLine</span>(<span class="pl-s"><span class="pl-pds">$"</span>    Pending work item count | {<span class="pl-smi">pendingWorkItemCount</span>,<span class="pl-c1">11</span>}<span class="pl-pds">"</span></span>);
            <span class="pl-smi">Console</span>.<span class="pl-en">WriteLine</span>(<span class="pl-smi">sb</span>.<span class="pl-en">ToString</span>());
            <span class="pl-smi">sb</span>.<span class="pl-en">Clear</span>();
        }
    }

    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">int</span><span class="pl-smi">s_previousThreadArrayIndex</span>;

    [<span class="pl-en">ThreadStatic</span>]
    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">int</span><span class="pl-smi">t_threadArrayIndex</span>;

    [<span class="pl-en">ThreadStatic</span>]
    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-en">Random</span><span class="pl-smi">t_rng</span>;

    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-k">double</span><span class="pl-smi">TicksPerUs</span><span class="pl-k">=</span><span class="pl-smi">Stopwatch</span>.<span class="pl-smi">Frequency</span><span class="pl-k">/</span> (<span class="pl-k">double</span>)<span class="pl-c1">1_000_000</span>;
    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">double</span><span class="pl-en">TicksToUs</span>(<span class="pl-k">long</span><span class="pl-smi">ticks</span>) <span class="pl-k">=&gt;</span><span class="pl-smi">ticks</span><span class="pl-k">/</span><span class="pl-smi">TicksPerUs</span>;

    [<span class="pl-en">MethodImpl</span>(<span class="pl-smi">MethodImplOptions</span>.<span class="pl-smi">NoInlining</span>)]
    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">int</span><span class="pl-en">InitializeThreadArrayIndex</span>()
    {
        <span class="pl-k">if</span> (<span class="pl-smi">t_threadArrayIndex</span><span class="pl-k">!=</span><span class="pl-c1">0</span>)
            <span class="pl-k">throw</span><span class="pl-k">new</span><span class="pl-en">InvalidOperationException</span>();
        <span class="pl-k">int</span><span class="pl-smi">i</span><span class="pl-k">=</span><span class="pl-smi">Interlocked</span>.<span class="pl-en">Increment</span>(<span class="pl-k">ref</span><span class="pl-smi">s_previousThreadArrayIndex</span>) <span class="pl-k">*</span><span class="pl-c1">16</span>;
        <span class="pl-smi">t_threadArrayIndex</span><span class="pl-k">=</span><span class="pl-smi">i</span>;
        <span class="pl-k">return</span><span class="pl-smi">i</span>;
    }

    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">object</span><span class="pl-en">PackParameters</span>(<span class="pl-k">long</span><span class="pl-smi">ticks</span>, <span class="pl-k">byte</span><span class="pl-smi">depth</span>, <span class="pl-k">byte</span><span class="pl-smi">itemCount</span>) <span class="pl-k">=&gt;</span>
        (<span class="pl-smi">ticks</span><span class="pl-k">&lt;&lt;</span><span class="pl-c1">16</span>) <span class="pl-k">|</span> (<span class="pl-k">ushort</span>)((<span class="pl-k">ushort</span>)<span class="pl-smi">depth</span><span class="pl-k">&lt;&lt;</span><span class="pl-c1">8</span>) <span class="pl-k">|</span><span class="pl-smi">itemCount</span>;

    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-en">Task</span>&lt;<span class="pl-k">bool</span>&gt; <span class="pl-en">ScheduleTask</span>(<span class="pl-en">Func</span>&lt;<span class="pl-k">object</span>, <span class="pl-en">Task</span>&lt;<span class="pl-k">bool</span>&gt;&gt; <span class="pl-smi">func</span>, <span class="pl-k">byte</span><span class="pl-smi">depth</span>, <span class="pl-k">byte</span><span class="pl-smi">itemCount</span>)
    {
        <span class="pl-k">var</span><span class="pl-smi">t</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Task</span>&lt;<span class="pl-en">Task</span>&lt;<span class="pl-k">bool</span>&gt;&gt;(<span class="pl-smi">func</span>, <span class="pl-en">PackParameters</span>(<span class="pl-smi">Stopwatch</span>.<span class="pl-en">GetTimestamp</span>(), <span class="pl-smi">depth</span>, <span class="pl-smi">itemCount</span>));
        <span class="pl-smi">t</span>.<span class="pl-en">Start</span>();
        <span class="pl-k">return</span><span class="pl-smi">t</span>.<span class="pl-en">Unwrap</span>();
    }

    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">void</span><span class="pl-en">ScheduleGlobalWorkItem</span>(<span class="pl-en">IThreadPoolWorkItem</span><span class="pl-smi">workItem</span>) <span class="pl-k">=&gt;</span><span class="pl-smi">ThreadPool</span>.<span class="pl-en">UnsafeQueueUserWorkItem</span>(<span class="pl-smi">workItem</span>, <span class="pl-smi">preferLocal</span>: <span class="pl-c1">false</span>);

    <span class="pl-k">private</span><span class="pl-k">sealed</span><span class="pl-k">class</span><span class="pl-en">ScheduleTaskWorkItem</span> : <span class="pl-en">IThreadPoolWorkItem</span>
    {
        <span class="pl-k">private</span><span class="pl-en">Func</span>&lt;<span class="pl-k">object</span>, <span class="pl-en">Task</span>&lt;<span class="pl-k">bool</span>&gt;&gt; <span class="pl-smi">_taskStart</span>;

        <span class="pl-k">public</span><span class="pl-en">ScheduleTaskWorkItem</span>(<span class="pl-en">Func</span>&lt;<span class="pl-k">object</span>, <span class="pl-en">Task</span>&lt;<span class="pl-k">bool</span>&gt;&gt; <span class="pl-smi">taskStart</span>) <span class="pl-k">=&gt;</span><span class="pl-smi">_taskStart</span><span class="pl-k">=</span><span class="pl-smi">taskStart</span>;

        <span class="pl-k">async</span> void IThreadPoolWorkItem.<span class="pl-en">Execute</span>()
        {
            <span class="pl-k">var</span><span class="pl-smi">startTicks</span><span class="pl-k">=</span><span class="pl-smi">Stopwatch</span>.<span class="pl-en">GetTimestamp</span>();
            <span class="pl-k">await</span><span class="pl-en">ScheduleTask</span>(<span class="pl-smi">_taskStart</span>, <span class="pl-smi">TreeDepth</span>, <span class="pl-smi">ItemCountPerNode</span>);
            <span class="pl-k">var</span><span class="pl-smi">endTicks</span><span class="pl-k">=</span><span class="pl-smi">Stopwatch</span>.<span class="pl-en">GetTimestamp</span>();
            <span class="pl-smi">Console</span>.<span class="pl-en">WriteLine</span>(
                <span class="pl-s"><span class="pl-pds">$"</span>-------------------------------- <span class="pl-pds">"</span></span><span class="pl-k">+</span><span class="pl-s"><span class="pl-pds">$"</span>{<span class="pl-en">TicksToUs</span>(<span class="pl-smi">endTicks</span><span class="pl-k">-</span><span class="pl-smi">startTicks</span>) <span class="pl-k">/</span><span class="pl-c1">1000</span>,<span class="pl-c1">15</span>:<span class="pl-c1">0.000</span><span class="pl-smi">ms</span>} <span class="pl-pds">"</span></span><span class="pl-k">+</span><span class="pl-s"><span class="pl-pds">$"</span>--------------------------------{<span class="pl-smi">Environment</span>.<span class="pl-smi">NewLine</span>}<span class="pl-pds">"</span></span>);

            <span class="pl-en">ScheduleGlobalWorkItem</span>(<span class="pl-k">this</span>);
        }
    }
}</pre></div><p>I tried to sort of simulate parallel test execution with a depth-first search through simulated directories, or just a general depth-first search. Upon visiting a node in the tree (a directory), a task is scheduled to process the remaining children at that depth while the visitor processes one child in depth-first fashion. Each of those tasks would again schedule another task to process the remaining children while processing one child.</p><p>Before:</p><pre><code>--------------------------------     4002.962 ms --------------------------------

                &lt;      1 us | Count/s:       24744.556 | Average latency (us):           0.889
                &lt;     10 us | Count/s:     3690695.825 | Average latency (us):           1.116
                &lt;    100 us | Count/s:      518347.648 | Average latency (us):          20.164
                &lt;   1000 us | Count/s:        8430.773 | Average latency (us):         648.340
                &lt;  10000 us | Count/s:        5314.880 | Average latency (us):        4125.855
                &gt;= 10000 us | Count/s:        1182.849 | Average latency (us):       20465.543
Biased average latency (us) |        1792.411
                   Count/ms |        4248.717
    Pending work item count |          75

                &lt;      1 us | Count/s:       28780.910 | Average latency (us):           0.885
                &lt;     10 us | Count/s:     3673167.601 | Average latency (us):           1.116
                &lt;    100 us | Count/s:      515960.725 | Average latency (us):          20.128
                &lt;   1000 us | Count/s:        8632.307 | Average latency (us):         647.784
                &lt;  10000 us | Count/s:        5121.193 | Average latency (us):        4286.862
                &gt;= 10000 us | Count/s:        1437.080 | Average latency (us):       25437.611
Biased average latency (us) |        1939.106
                   Count/ms |        4233.100
    Pending work item count |          74

                &lt;      1 us | Count/s:       23358.023 | Average latency (us):           0.890
                &lt;     10 us | Count/s:     3686806.194 | Average latency (us):           1.115
                &lt;    100 us | Count/s:      517698.654 | Average latency (us):          20.140
                &lt;   1000 us | Count/s:        8531.761 | Average latency (us):         656.063
                &lt;  10000 us | Count/s:        5309.087 | Average latency (us):        4293.581
                &gt;= 10000 us | Count/s:        1371.351 | Average latency (us):       33306.076
Biased average latency (us) |        4380.721
                   Count/ms |        4243.075
    Pending work item count |          75

                &lt;      1 us | Count/s:       29220.008 | Average latency (us):           0.886
                &lt;     10 us | Count/s:     3641870.549 | Average latency (us):           1.117
                &lt;    100 us | Count/s:      511642.685 | Average latency (us):          20.150
                &lt;   1000 us | Count/s:        8411.190 | Average latency (us):         651.754
                &lt;  10000 us | Count/s:        5158.572 | Average latency (us):        4226.089
                &gt;= 10000 us | Count/s:        1497.394 | Average latency (us):       25436.375
Biased average latency (us) |        2015.481
                   Count/ms |        4197.800
    Pending work item count |          75

                &lt;      1 us | Count/s:       22742.143 | Average latency (us):           0.890
                &lt;     10 us | Count/s:     3673435.542 | Average latency (us):           1.115
                &lt;    100 us | Count/s:      515746.550 | Average latency (us):          20.128
                &lt;   1000 us | Count/s:        8444.148 | Average latency (us):         660.146
                &lt;  10000 us | Count/s:        5257.603 | Average latency (us):        4224.866
                &gt;= 10000 us | Count/s:        1395.841 | Average latency (us):       32506.831
Biased average latency (us) |        4324.338
                   Count/ms |        4227.022
    Pending work item count |          73

                &lt;      1 us | Count/s:       30626.793 | Average latency (us):           0.884
                &lt;     10 us | Count/s:     3651167.078 | Average latency (us):           1.117
                &lt;    100 us | Count/s:      513081.858 | Average latency (us):          20.141
                &lt;   1000 us | Count/s:        8372.721 | Average latency (us):         657.792
                &lt;  10000 us | Count/s:        5176.332 | Average latency (us):        4347.262
                &gt;= 10000 us | Count/s:        1410.288 | Average latency (us):       28624.315
Biased average latency (us) |        2984.782
                   Count/ms |        4209.835
    Pending work item count |          79

                &lt;      1 us | Count/s:       26408.640 | Average latency (us):           0.885
                &lt;     10 us | Count/s:     3674182.513 | Average latency (us):           1.116
                &lt;    100 us | Count/s:      515831.268 | Average latency (us):          20.143
                &lt;   1000 us | Count/s:        8445.039 | Average latency (us):         658.852
                &lt;  10000 us | Count/s:        5397.430 | Average latency (us):        4231.808
                &gt;= 10000 us | Count/s:        1389.615 | Average latency (us):       26672.509
Biased average latency (us) |        2633.646
                   Count/ms |        4231.655
    Pending work item count |          69

                &lt;      1 us | Count/s:       32783.746 | Average latency (us):           0.881
                &lt;     10 us | Count/s:     3628520.909 | Average latency (us):           1.119
                &lt;    100 us | Count/s:      509873.106 | Average latency (us):          20.153
                &lt;   1000 us | Count/s:        8482.784 | Average latency (us):         648.593
                &lt;  10000 us | Count/s:        5202.827 | Average latency (us):        4228.868
                &gt;= 10000 us | Count/s:        1444.131 | Average latency (us):       23712.969
Biased average latency (us) |        2018.200
                   Count/ms |        4186.308
    Pending work item count |          61

--------------------------------     3975.624 ms --------------------------------
</code></pre><p>Highest latencies, pending work item count, and throughput are somewhat stable.</p><p>After (without prototype fixes above):</p><pre><code>--------------------------------     6353.504 ms --------------------------------

                &lt;      1 us | Count/s:      417426.511 | Average latency (us):           0.714
                &lt;     10 us | Count/s:     1946215.729 | Average latency (us):           1.273
                &lt;    100 us | Count/s:      259480.021 | Average latency (us):          20.984
                &lt;   1000 us | Count/s:       13478.388 | Average latency (us):         336.676
                &lt;  10000 us | Count/s:       18187.303 | Average latency (us):        4782.717
                &gt;= 10000 us | Count/s:       75027.276 | Average latency (us):      117167.900
Biased average latency (us) |       75911.307
                   Count/ms |        2729.815
    Pending work item count |        7276

                &lt;      1 us | Count/s:      402144.501 | Average latency (us):           0.714
                &lt;     10 us | Count/s:     1889516.783 | Average latency (us):           1.267
                &lt;    100 us | Count/s:      256847.026 | Average latency (us):          20.721
                &lt;   1000 us | Count/s:        9422.161 | Average latency (us):         345.595
                &lt;  10000 us | Count/s:        8353.205 | Average latency (us):        4336.369
                &gt;= 10000 us | Count/s:       70433.135 | Average latency (us):      162822.743
Biased average latency (us) |       74668.565
                   Count/ms |        2636.717
    Pending work item count |       26622

                &lt;      1 us | Count/s:      410443.218 | Average latency (us):           0.720
                &lt;     10 us | Count/s:     1916025.762 | Average latency (us):           1.269
                &lt;    100 us | Count/s:      259114.694 | Average latency (us):          20.735
                &lt;   1000 us | Count/s:       10926.144 | Average latency (us):         347.645
                &lt;  10000 us | Count/s:        9353.543 | Average latency (us):        4193.634
                &gt;= 10000 us | Count/s:       72095.373 | Average latency (us):      313375.126
Biased average latency (us) |      138522.198
                   Count/ms |        2677.959
    Pending work item count |       36676

                &lt;      1 us | Count/s:      412860.031 | Average latency (us):           0.712
                &lt;     10 us | Count/s:     1937285.838 | Average latency (us):           1.268
                &lt;    100 us | Count/s:      261069.548 | Average latency (us):          20.960
                &lt;   1000 us | Count/s:       10783.635 | Average latency (us):         343.608
                &lt;  10000 us | Count/s:        9698.128 | Average latency (us):        4446.942
                &gt;= 10000 us | Count/s:       75475.525 | Average latency (us):      438130.779
Biased average latency (us) |      203218.412
                   Count/ms |        2707.173
    Pending work item count |       59381

                &lt;      1 us | Count/s:      432722.150 | Average latency (us):           0.717
                &lt;     10 us | Count/s:     2030056.099 | Average latency (us):           1.266
                &lt;    100 us | Count/s:      275790.794 | Average latency (us):          21.157
                &lt;   1000 us | Count/s:       10886.067 | Average latency (us):         381.148
                &lt;  10000 us | Count/s:       11660.014 | Average latency (us):        4394.552
                &gt;= 10000 us | Count/s:       70446.731 | Average latency (us):      538562.356
Biased average latency (us) |      231838.804
                   Count/ms |        2831.562
    Pending work item count |       43905

                &lt;      1 us | Count/s:      419699.905 | Average latency (us):           0.718
                &lt;     10 us | Count/s:     1789718.807 | Average latency (us):           1.289
                &lt;    100 us | Count/s:      240757.521 | Average latency (us):          21.130
                &lt;   1000 us | Count/s:       10019.027 | Average latency (us):         359.446
                &lt;  10000 us | Count/s:       10616.826 | Average latency (us):        4630.261
                &gt;= 10000 us | Count/s:       69069.345 | Average latency (us):      527723.084
Biased average latency (us) |      246489.303
                   Count/ms |        2539.881
    Pending work item count |       44743

                &lt;      1 us | Count/s:      410651.545 | Average latency (us):           0.723
                &lt;     10 us | Count/s:     1910855.099 | Average latency (us):           1.269
                &lt;    100 us | Count/s:      257608.178 | Average latency (us):          21.061
                &lt;   1000 us | Count/s:       10239.421 | Average latency (us):         345.401
                &lt;  10000 us | Count/s:       10227.845 | Average latency (us):        4635.634
                &gt;= 10000 us | Count/s:       75212.574 | Average latency (us):      655883.153
Biased average latency (us) |      312401.286
                   Count/ms |        2674.795
    Pending work item count |       44590

                &lt;      1 us | Count/s:      460119.029 | Average latency (us):           0.719
                &lt;     10 us | Count/s:     1791300.033 | Average latency (us):           1.297
                &lt;    100 us | Count/s:      239890.947 | Average latency (us):          20.967
                &lt;   1000 us | Count/s:       10326.240 | Average latency (us):         363.193
                &lt;  10000 us | Count/s:       10762.308 | Average latency (us):        4416.084
                &gt;= 10000 us | Count/s:       74089.679 | Average latency (us):      591813.365
Biased average latency (us) |      293369.118
                   Count/ms |        2586.488
    Pending work item count |       42336

                &lt;      1 us | Count/s:      433782.832 | Average latency (us):           0.724
                &lt;     10 us | Count/s:     1812622.439 | Average latency (us):           1.285
                &lt;    100 us | Count/s:      243260.597 | Average latency (us):          21.002
                &lt;   1000 us | Count/s:        9944.413 | Average latency (us):         343.540
                &lt;  10000 us | Count/s:        9971.728 | Average latency (us):        4363.041
                &gt;= 10000 us | Count/s:       75971.258 | Average latency (us):      606262.814
Biased average latency (us) |      303235.668
                   Count/ms |        2585.553
    Pending work item count |       39541

                &lt;      1 us | Count/s:      435765.082 | Average latency (us):           0.718
                &lt;     10 us | Count/s:     1915851.053 | Average latency (us):           1.276
                &lt;    100 us | Count/s:      257271.279 | Average latency (us):          21.098
                &lt;   1000 us | Count/s:       11111.863 | Average latency (us):         338.808
                &lt;  10000 us | Count/s:       12500.606 | Average latency (us):        4467.817
                &gt;= 10000 us | Count/s:       75599.910 | Average latency (us):      540766.188
Biased average latency (us) |      259995.255
                   Count/ms |        2708.100
    Pending work item count |       32057

                &lt;      1 us | Count/s:      411993.816 | Average latency (us):           0.728
                &lt;     10 us | Count/s:     1821767.465 | Average latency (us):           1.276
                &lt;    100 us | Count/s:      241291.569 | Average latency (us):          20.905
                &lt;   1000 us | Count/s:       10559.307 | Average latency (us):         342.365
                &lt;  10000 us | Count/s:       13435.008 | Average latency (us):        4798.244
                &gt;= 10000 us | Count/s:       77001.172 | Average latency (us):      419577.170
Biased average latency (us) |      241865.034
                   Count/ms |        2576.048
    Pending work item count |       22061

                &lt;      1 us | Count/s:      338189.329 | Average latency (us):           0.713
                &lt;     10 us | Count/s:     1924425.142 | Average latency (us):           1.252
                &lt;    100 us | Count/s:      254636.372 | Average latency (us):          20.816
                &lt;   1000 us | Count/s:       11922.714 | Average latency (us):         340.422
                &lt;  10000 us | Count/s:       12791.814 | Average latency (us):        4411.685
                &gt;= 10000 us | Count/s:       73628.780 | Average latency (us):      453434.557
Biased average latency (us) |      262407.245
                   Count/ms |        2615.594
    Pending work item count |       12040

--------------------------------     6309.281 ms --------------------------------
</code></pre><p>Probably due to <code>TryPop</code> giving up on contention, the pending work item counts and highest latencies are much higher, and throughput is lower.</p><p>With prototype fixes above:</p><pre><code>--------------------------------     8338.280 ms --------------------------------

                &lt;      1 us | Count/s:       31033.630 | Average latency (us):           0.872
                &lt;     10 us | Count/s:     1794530.873 | Average latency (us):           1.386
                &lt;    100 us | Count/s:      240720.058 | Average latency (us):          18.476
                &lt;   1000 us | Count/s:       16525.944 | Average latency (us):         216.844
                &lt;  10000 us | Count/s:        2481.911 | Average latency (us):        2582.900
                &gt;= 10000 us | Count/s:         672.103 | Average latency (us):       30689.792
Biased average latency (us) |        1777.863
                   Count/ms |        2085.965
    Pending work item count |          44

                &lt;      1 us | Count/s:       28052.525 | Average latency (us):           0.878
                &lt;     10 us | Count/s:     1754760.278 | Average latency (us):           1.419
                &lt;    100 us | Count/s:      233681.615 | Average latency (us):          18.228
                &lt;   1000 us | Count/s:       17659.677 | Average latency (us):         202.853
                &lt;  10000 us | Count/s:        2552.527 | Average latency (us):        2491.033
                &gt;= 10000 us | Count/s:         767.897 | Average latency (us):       33670.568
Biased average latency (us) |        2520.193
                   Count/ms |        2037.475
    Pending work item count |          40

                &lt;      1 us | Count/s:       25902.901 | Average latency (us):           0.867
                &lt;     10 us | Count/s:     1572976.793 | Average latency (us):           1.463
                &lt;    100 us | Count/s:      207367.154 | Average latency (us):          18.124
                &lt;   1000 us | Count/s:       17092.880 | Average latency (us):         194.710
                &lt;  10000 us | Count/s:        2332.350 | Average latency (us):        2241.505
                &gt;= 10000 us | Count/s:         927.883 | Average latency (us):       52474.493
Biased average latency (us) |        6152.295
                   Count/ms |        1826.600
    Pending work item count |         693

                &lt;      1 us | Count/s:       10454.743 | Average latency (us):           0.881
                &lt;     10 us | Count/s:     1264116.532 | Average latency (us):           1.503
                &lt;    100 us | Count/s:      164797.055 | Average latency (us):          17.822
                &lt;   1000 us | Count/s:       14948.978 | Average latency (us):         182.101
                &lt;  10000 us | Count/s:        2030.974 | Average latency (us):        2176.157
                &gt;= 10000 us | Count/s:         691.271 | Average latency (us):      128948.315
Biased average latency (us) |       12681.084
                   Count/ms |        1457.040
    Pending work item count |         110

                &lt;      1 us | Count/s:       14041.509 | Average latency (us):           0.874
                &lt;     10 us | Count/s:     1250482.270 | Average latency (us):           1.526
                &lt;    100 us | Count/s:      162579.544 | Average latency (us):          17.785
                &lt;   1000 us | Count/s:       15356.745 | Average latency (us):         178.082
                &lt;  10000 us | Count/s:        2009.821 | Average latency (us):        2070.270
                &gt;= 10000 us | Count/s:         679.020 | Average latency (us):      105140.977
Biased average latency (us) |       13544.594
                   Count/ms |        1445.149
    Pending work item count |          92

                &lt;      1 us | Count/s:       14060.226 | Average latency (us):           0.880
                &lt;     10 us | Count/s:     1282035.069 | Average latency (us):           1.485
                &lt;    100 us | Count/s:      168090.426 | Average latency (us):          17.954
                &lt;   1000 us | Count/s:       14575.788 | Average latency (us):         187.046
                &lt;  10000 us | Count/s:        1999.988 | Average latency (us):        2328.801
                &gt;= 10000 us | Count/s:         678.984 | Average latency (us):       80702.822
Biased average latency (us) |       13081.498
                   Count/ms |        1481.440
    Pending work item count |          87

                &lt;      1 us | Count/s:       18048.164 | Average latency (us):           0.869
                &lt;     10 us | Count/s:     1263674.981 | Average latency (us):           1.512
                &lt;    100 us | Count/s:      164876.993 | Average latency (us):          17.894
                &lt;   1000 us | Count/s:       14956.806 | Average latency (us):         181.926
                &lt;  10000 us | Count/s:        1988.275 | Average latency (us):        2137.143
                &gt;= 10000 us | Count/s:         762.626 | Average latency (us):       72133.323
Biased average latency (us) |       14602.249
                   Count/ms |        1464.308
    Pending work item count |          80

                &lt;      1 us | Count/s:       14344.843 | Average latency (us):           0.882
                &lt;     10 us | Count/s:     1297946.140 | Average latency (us):           1.472
                &lt;    100 us | Count/s:      170760.335 | Average latency (us):          17.997
                &lt;   1000 us | Count/s:       14344.843 | Average latency (us):         186.100
                &lt;  10000 us | Count/s:        1997.482 | Average latency (us):        2255.822
                &gt;= 10000 us | Count/s:         615.809 | Average latency (us):       56198.016
Biased average latency (us) |        7941.093
                   Count/ms |        1500.009
    Pending work item count |          78

                &lt;      1 us | Count/s:       18135.857 | Average latency (us):           0.874
                &lt;     10 us | Count/s:     1295835.310 | Average latency (us):           1.484
                &lt;    100 us | Count/s:      170143.565 | Average latency (us):          17.983
                &lt;   1000 us | Count/s:       14645.274 | Average latency (us):         183.720
                &lt;  10000 us | Count/s:        1965.156 | Average latency (us):        2245.704
                &gt;= 10000 us | Count/s:         616.786 | Average latency (us):       85971.684
Biased average latency (us) |       17152.553
                   Count/ms |        1501.342
    Pending work item count |          72

                &lt;      1 us | Count/s:       14835.312 | Average latency (us):           0.880
                &lt;     10 us | Count/s:     1305744.777 | Average latency (us):           1.471
                &lt;    100 us | Count/s:      171723.838 | Average latency (us):          18.004
                &lt;   1000 us | Count/s:       14387.820 | Average latency (us):         184.533
                &lt;  10000 us | Count/s:        1953.397 | Average latency (us):        2254.579
                &gt;= 10000 us | Count/s:         690.693 | Average latency (us):       66026.951
Biased average latency (us) |       14296.471
                   Count/ms |        1509.336
    Pending work item count |          70

                &lt;      1 us | Count/s:       15208.036 | Average latency (us):           0.874
                &lt;     10 us | Count/s:     1275724.883 | Average latency (us):           1.506
                &lt;    100 us | Count/s:      166591.457 | Average latency (us):          17.882
                &lt;   1000 us | Count/s:       15058.136 | Average latency (us):         178.179
                &lt;  10000 us | Count/s:        2001.262 | Average latency (us):        2110.332
                &gt;= 10000 us | Count/s:         673.577 | Average latency (us):      143445.854
Biased average latency (us) |       32582.389
                   Count/ms |        1475.257
    Pending work item count |          65

                &lt;      1 us | Count/s:        9989.831 | Average latency (us):           0.872
                &lt;     10 us | Count/s:     1273969.859 | Average latency (us):           1.508
                &lt;    100 us | Count/s:      165889.917 | Average latency (us):          17.829
                &lt;   1000 us | Count/s:       15177.233 | Average latency (us):         177.097
                &lt;  10000 us | Count/s:        2016.243 | Average latency (us):        2022.399
                &gt;= 10000 us | Count/s:         620.233 | Average latency (us):      144251.228
Biased average latency (us) |       33408.934
                   Count/ms |        1467.663
    Pending work item count |          54

                &lt;      1 us | Count/s:       12826.037 | Average latency (us):           0.877
                &lt;     10 us | Count/s:     1274746.564 | Average latency (us):           1.504
                &lt;    100 us | Count/s:      166355.066 | Average latency (us):          17.859
                &lt;   1000 us | Count/s:       15007.826 | Average latency (us):         179.232
                &lt;  10000 us | Count/s:        2103.937 | Average latency (us):        2414.525
                &gt;= 10000 us | Count/s:         671.469 | Average latency (us):       93834.215
Biased average latency (us) |       25678.577
                   Count/ms |        1471.711
    Pending work item count |          53

                &lt;      1 us | Count/s:       15289.610 | Average latency (us):           0.866
                &lt;     10 us | Count/s:     1252234.396 | Average latency (us):           1.538
                &lt;    100 us | Count/s:      162216.941 | Average latency (us):          17.727
                &lt;   1000 us | Count/s:       15583.379 | Average latency (us):         172.501
                &lt;  10000 us | Count/s:        2108.912 | Average latency (us):        2154.295
                &gt;= 10000 us | Count/s:         704.268 | Average latency (us):      166529.897
Biased average latency (us) |       43510.814
                   Count/ms |        1448.138
    Pending work item count |          47

                &lt;      1 us | Count/s:       11714.624 | Average latency (us):           0.882
                &lt;     10 us | Count/s:     1254750.374 | Average latency (us):           1.532
                &lt;    100 us | Count/s:      162777.449 | Average latency (us):          17.695
                &lt;   1000 us | Count/s:       15639.596 | Average latency (us):         172.981
                &lt;  10000 us | Count/s:        2086.965 | Average latency (us):        2126.463
                &gt;= 10000 us | Count/s:         653.514 | Average latency (us):       66590.378
Biased average latency (us) |       18344.391
                   Count/ms |        1447.623
    Pending work item count |          41

                &lt;      1 us | Count/s:       16515.245 | Average latency (us):           0.870
                &lt;     10 us | Count/s:     1304474.830 | Average latency (us):           1.471
                &lt;    100 us | Count/s:      171368.027 | Average latency (us):          18.024
                &lt;   1000 us | Count/s:       14352.627 | Average latency (us):         186.433
                &lt;  10000 us | Count/s:        1960.359 | Average latency (us):        2201.218
                &gt;= 10000 us | Count/s:         628.171 | Average latency (us):       71403.866
Biased average latency (us) |       19161.381
                   Count/ms |        1509.299
    Pending work item count |          43

                &lt;      1 us | Count/s:       11235.325 | Average latency (us):           0.881
                &lt;     10 us | Count/s:     1259978.141 | Average latency (us):           1.525
                &lt;    100 us | Count/s:      163662.728 | Average latency (us):          17.743
                &lt;   1000 us | Count/s:       15477.531 | Average latency (us):         174.308
                &lt;  10000 us | Count/s:        2127.917 | Average latency (us):        2182.331
                &gt;= 10000 us | Count/s:         663.879 | Average latency (us):       45405.471
Biased average latency (us) |        3844.446
                   Count/ms |        1453.146
    Pending work item count |          44

                &lt;      1 us | Count/s:       12325.176 | Average latency (us):           0.882
                &lt;     10 us | Count/s:     1275652.806 | Average latency (us):           1.502
                &lt;    100 us | Count/s:      166655.447 | Average latency (us):          17.911
                &lt;   1000 us | Count/s:       14881.653 | Average latency (us):         179.481
                &lt;  10000 us | Count/s:        2037.010 | Average latency (us):        2144.985
                &gt;= 10000 us | Count/s:         589.507 | Average latency (us):       57906.353
Biased average latency (us) |        6051.593
                   Count/ms |        1472.142
    Pending work item count |          45

                &lt;      1 us | Count/s:        9830.693 | Average latency (us):           0.877
                &lt;     10 us | Count/s:     1253830.721 | Average latency (us):           1.535
                &lt;    100 us | Count/s:      162351.382 | Average latency (us):          17.708
                &lt;   1000 us | Count/s:       15667.242 | Average latency (us):         172.310
                &lt;  10000 us | Count/s:        2118.667 | Average latency (us):        2124.627
                &gt;= 10000 us | Count/s:         630.347 | Average latency (us):       45496.248
Biased average latency (us) |        3404.621
                   Count/ms |        1444.429
    Pending work item count |          39

                &lt;      1 us | Count/s:       11209.796 | Average latency (us):           0.878
                &lt;     10 us | Count/s:     1271428.619 | Average latency (us):           1.511
                &lt;    100 us | Count/s:      165429.121 | Average latency (us):          17.800
                &lt;   1000 us | Count/s:       15231.082 | Average latency (us):         176.338
                &lt;  10000 us | Count/s:        2031.070 | Average latency (us):        2141.567
                &gt;= 10000 us | Count/s:         678.969 | Average latency (us):       50736.966
Biased average latency (us) |        5856.000
                   Count/ms |        1466.009
    Pending work item count |          35

                &lt;      1 us | Count/s:       10319.488 | Average latency (us):           0.878
                &lt;     10 us | Count/s:     1238566.167 | Average latency (us):           1.554
                &lt;    100 us | Count/s:      159880.073 | Average latency (us):          17.628
                &lt;   1000 us | Count/s:       16004.545 | Average latency (us):         169.078
                &lt;  10000 us | Count/s:        2136.274 | Average latency (us):        2085.964
                &gt;= 10000 us | Count/s:         630.376 | Average latency (us):       41289.099
Biased average latency (us) |        3409.634
                   Count/ms |        1427.537
    Pending work item count |          34

--------------------------------    10938.968 ms --------------------------------
</code></pre><p>Pending work item count has stabilized somewhat, but still spikes frequently due to the issue (not always visible in the output). Highest latencies still worse than baseline. Throughput is lower still. I believe due to thread assignment to queues being balanced on proc ID changes, there is even more thread movement between queues and more cross-trampling of work streams.</p><p>In the baseline one thread's perspective would be one task scheduled per depth while going down the tree on one path. When a leaf is reached, the thread would pop the most recently scheduled work item (at the lowest depth) and continue processing that top-level branch of the tree in depth-first order. Meanwhile another thread would steal the oldest item (a high-depth node) and mostly independently process another top-level branch, and so on for the remaining threads.</p><p>With this change when there are more threads than the processor count, consider two threads T0 and T1 operating on one queue. Suppose T0 is going down the tree on one path and added a few work items one for each depth. T1 would initially steal an old item (a top-level high-depth node) and start processing that similarly to the baseline. However, while T0 is happily processing one top-level branch, T1 tramples on it by scheduling a bunch of work items for the other top-level branch. T0 gets detracted from its work stream and is forced to work on T1's payload. So the search is still mostly depth-first but at times it becomes a bit more breadth-first. This keeps happening from time to time, and every time it happens it causes work items that are already in their shared local queue to get backed up. I'm not sure exactly why it's slower, I had expected equivalent throughput, bad latency, and unexpected order of execution (which can show up in the UI if this was actual test execution).</p><p>The issue also exists on Linux and numbers are somewhat similar. The issue mostly disappears with the prototype fixes when <code>ThreadCount == Environment.ProcessorCount</code>, but then there's also hill climbing.</p><p>It's quite possible I did something wrong in the test as well, so please do double-check it, but I think the theory at least is valid.</p><p>I'm not sure there is a good way to solve that problem with a shared queue model. It may help in this particular case to always steal items in LIFO order but that would not solve the problem and I don't think that's the right solution. As far as I can tell the best way to solve this problem is to not allow threads to trample on one another by scheduling and taking work items from the same queue such that their work stream occurs in natural order and is not detracted, which would imply a thread-local queue model.</p><p>Perhaps a better model would be to use thread-local queues and to associate them with a proc ID (along with balancing thread assignments, checking proc ID frequently, etc., which I still feel is a bit unfortunate but may be necessary to solve some issues). Such that only the thread can ever add items to its own queue, but other threads associated with the same proc ID can take items from it in LIFO order before going to the global queue. Work items coming in from outside the thread pool could be spread out among processors in some uniform fashion, as inserting them at the opposite end of the queue should not trample on the thread's work stream. It feels to me like that could be implemented efficiently.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>