<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Turning Signal App into a Coarse Tracking Device - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Turning Signal App into a Coarse Tracking Device - linksfor.dev(s)"/>
    <meta property="article:author" content="https://medium.com/@CE2Wells"/>
    <meta property="og:description" content="Signal Private Messenger&#x2019;s ease of use, multiplatform support, and end-to-end encryption for both text and calls have attracted millions&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://medium.com/tenable-techblog/turning-signal-app-into-a-coarse-tracking-device-643eb4298447"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Turning Signal App into a Coarse Tracking Device</title>
<div class="readable">
        <h1>Turning Signal App into a Coarse Tracking Device</h1>
            <div>by https://medium.com/@CE2Wells</div>
            <div>Reading time: 9-12 minutes</div>
        <div>Posted here: 20 May 2020</div>
        <p><a href="https://medium.com/tenable-techblog/turning-signal-app-into-a-coarse-tracking-device-643eb4298447">https://medium.com/tenable-techblog/turning-signal-app-into-a-coarse-tracking-device-643eb4298447</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><section><div><div><div><div><div><div><p><a rel="noopener" href="https://medium.com/@CE2Wells?source=post_page-----643eb4298447----------------------"><img alt="David Wells" src="https://miro.medium.com/fit/c/96/96/2*GElu1JH-bOYu09XyXeWmpA.jpeg" width="48" height="48"></a></p></div></div></div></div><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*zKw5RvnISAgCAXWcJk9JJw.png?q=20" width="410" height="412" role="presentation"></p><p><img width="410" height="412" srcset="https://miro.medium.com/max/552/1*zKw5RvnISAgCAXWcJk9JJw.png 276w, https://miro.medium.com/max/820/1*zKw5RvnISAgCAXWcJk9JJw.png 410w" sizes="410px" role="presentation" src="https://miro.medium.com/max/410/1*zKw5RvnISAgCAXWcJk9JJw.png"></p></div></div></div></figure><p id="9d64" data-selectable-paragraph=""><em>UPDATED 5/20/2020: The blog post was updated to reflect the availability of updated versions of Signal on the Google Play Store and Apple App Store.</em></p><p id="ffde" data-selectable-paragraph="">Signal Private Messenger’s ease of use, multiplatform support, and end-to-end encryption for both text and calls have attracted millions of users per day. Even Edward Snowden, the well known American Whistleblower, <a href="https://twitter.com/Snowden/status/661313394906161152" target="_blank" rel="noopener nofollow">claims “I use Signal every day.”</a></p><p id="33bd" data-selectable-paragraph="">So this month, when I disclosed a way to leak a user’s DNS server simply by ringing their Signal number (CVE-2020–5753), I was happy to see how fast they <a href="https://github.com/signalapp/webrtc/commit/8000931e422aa796412c9a4a188be63a1ab830ae" target="_blank" rel="noopener nofollow">patched it</a>. Revealing a Signal user’s DNS server can potentially reveal coarse location, but as we will later see, <strong>in instances such as Google Public DNS (8.8.8.8/8.8.4.4) and others, this attack can narrow the location down to the Signal user’s city due to usage of </strong><a href="https://developers.google.com/speed/public-dns/docs/ecs" target="_blank" rel="noopener nofollow"><strong>EDNS Client Subnet</strong>.</a></p><p id="a056" data-selectable-paragraph="">The Signal team let us know that updated versions for Android and iOS will be available. Signal is an open source application and due to our disclosure policy, we disclose issues once any patch or information pertaining a vulnerability goes public, such as this case. From our investigation, the affected Android versions are Signal v4.59.0 and up, while for iOS<strong> </strong>the affected WebRTC update was introduced in 3.8.0.34.</p><p id="9586" data-selectable-paragraph="">For certain Signal users, this issue could be quite serious, while average users aren’t as likely to be impacted. It’s worth mentioning that this is not an issue in Signal’s code, but due to WebRTC doing DNS requests. Other messaging apps could also be vulnerable to this. Signal has since notified the Chromium team and submitted a proposed patch. Those discussions are ongoing.</p><p id="236f" data-selectable-paragraph="">Signal uses its own fork of <a href="https://github.com/signalapp/webrtc" target="_blank" rel="noopener nofollow">WebRTC </a>for voice/video calls with remote peers. In order for WebRTC to connect with a remote peer, it must discover a valid connection path for the local and remote peer to communicate. WebRTC makes use of “signalling” for this, which involves using an intermediate signaling server that exchanges each peer’s public/private IP addresses (ICE Candidates) so that each peer can discover each other and eventually establish an optimal connection.</p><p id="d140" data-selectable-paragraph="">As a protection, Signal will <strong>not </strong>send your public/private IP addresses if a user receives a call from someone who is not a contact. Additionally, if a Signal user wishes to hide their private/public IP addresses even from contacts who call, then it has an option “Always Relay Calls” in its privacy options, which will never include your public/private IPs in the ICE Candidates. Instead, it will just send the IP of a nearby Signal TURN server for the calling peer to connect to and relay the audio/video call through it instead. One interesting thing I observed about this signaling process is that it <strong>occurs before a Signal user decides to answer the call</strong>. I thought this could lead to an interesting attack surface, with the goal of having a completely unknown phone number ringing a remote Signal user’s phone to reveal <em>some </em>kind of network information even if they have “Always Relay Calls” enabled. Can this be done?</p><p id="98da" data-selectable-paragraph="">Signal being <a href="https://github.com/signalapp/" target="_blank" rel="noopener nofollow">open source</a> made my life a little easier in figuring out how to do this. I mentioned some of these ICE Candidate protections in place. Due to these protections, I was forced to find something clever in order to circumvent and somehow leak information. In reading the <a href="https://tools.ietf.org/html/rfc5245" target="_blank" rel="noopener nofollow">RFC for ICE</a>, I found that it supports domain names for ICE Candidates.</p><blockquote><p id="1dc4" data-selectable-paragraph="">&lt;connection-address&gt;: is taken from RFC 4566 [RFC4566]. It is the IP address of the candidate, allowing for IPv4 addresses, IPv6 addresses, and fully qualified domain names (FQDNs).</p></blockquote><p id="9d39" data-selectable-paragraph="">And in 2018, WebRTC had support added for this <a href="https://webrtc-review.googlesource.com/c/src/+/85540/16" target="_blank" rel="noopener nofollow">https://webrtc-review.googlesource.com/c/src/+/85540/16</a>. Since Signal uses WebRTC under the hood, I figured we could just slip in a domain name for one of the ICE Candidates so that when I ring a phone (and trigger the ICE Candidate exchange) the callee will have no other choice but to resolve the domain name I supply. If I own the authoritative nameserver for the domain I supply, I can log the IP that tries to query my nameserver. That IP address will be the DNS server being used by the remote Signal user, which is typically geographically near(ish) to the user. Again, the callee will perform this domain query before the call is even answered. In fact, I found that I could easily force a DNS lookup before the phone even “rings”, then shut down the call, so all the callee would see is “missed call” notification — no ring. Meanwhile, on my nameserver side, we see an incoming DNS query from the remote Signal user’s current DNS resolver.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*V2RoX28u9SMkO3hR?q=20" width="1400" height="56" role="presentation"></p><p><img width="1400" height="56" srcset="https://miro.medium.com/max/552/0*V2RoX28u9SMkO3hR 276w, https://miro.medium.com/max/1104/0*V2RoX28u9SMkO3hR 552w, https://miro.medium.com/max/1280/0*V2RoX28u9SMkO3hR 640w, https://miro.medium.com/max/1400/0*V2RoX28u9SMkO3hR 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">Our Authoritative Nameserver Logging Incoming Request</figcaption></figure><p id="11f4" data-selectable-paragraph="">To implement this, I simply modified this routine in Signal and compiled Signal App to my “attacker” phone. <a href="https://github.com/signalapp/Signal-Android/blob/3f7d0688fc76fd56ef0a562ae5293d91a67d6500/app/src/main/java/org/thoughtcrime/securesms/service/WebRtcCallService.java#L1688" target="_blank" rel="noopener nofollow">https://github.com/signalapp/Signal-Android/blob/3f7d0688fc76fd56ef0a562ae5293d91a67d6500/app/src/main/java/org/thoughtcrime/securesms/service/WebRtcCallService.java#L1688</a></p><p id="cbfd" data-selectable-paragraph="">In it, I added additional ICE Candidates to the <em>iceCandidateParcels </em>list. These additional ICE Candidates had my domain in them (which I own an authoritative nameserver for).</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*tYC9Qnwse224gO39?q=20" width="1295" height="209" role="presentation"></p><p><img width="1295" height="209" srcset="https://miro.medium.com/max/552/0*tYC9Qnwse224gO39 276w, https://miro.medium.com/max/1104/0*tYC9Qnwse224gO39 552w, https://miro.medium.com/max/1280/0*tYC9Qnwse224gO39 640w, https://miro.medium.com/max/1400/0*tYC9Qnwse224gO39 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">Modified Version of WebRtcCallService.java</figcaption></figure><p id="e2de" data-selectable-paragraph="">For each ICE Candidate (as well as each call), I generate a unique subdomain for two reasons:</p><ul><li id="6eae" data-selectable-paragraph="">Identify the specific incoming requests in my nameserver logging</li><li id="560b" data-selectable-paragraph="">Ensure it will bypass any DNS caching, that way I’m always forcing the callee’s DNS server to query my nameserver.</li></ul><h2 id="8708" data-selectable-paragraph="">Results</h2><p id="c72d" data-selectable-paragraph="">After testing this multiple times in various locations I found the DNS location accuracy was usually accurate within ~400 mile radius depending on ISP/DNS configuration and could answer questions such as, what country or sometimes part of the country someone is currently in. One other thing to consider is not only location identification through a DNS server, but identifying location through ISP switches. For example, I am at home now…exploiting myself with a burner Signal phone …I leak the DNS server that my phone is currently using on my home network and I see it’s a DNS server from Cox ISP in Southern California…which is correct, as I live in Southern California and use Cox ISP.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/36/0*2Aho8baqQ2qwbSpW?q=20" width="448" height="760" role="presentation"></p><p><img width="448" height="760" srcset="https://miro.medium.com/max/552/0*2Aho8baqQ2qwbSpW 276w, https://miro.medium.com/max/896/0*2Aho8baqQ2qwbSpW 448w" sizes="448px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph="">My DNS Server Sitting at Home</figcaption></figure><p id="faf9" data-selectable-paragraph="">I now go outside and walk to Starbucks across the street, as I left the house and am now on 4G, I exploit myself again with another mysterious missed call to leak my new DNS server being used…</p><figure><div><div><div><p><img src="https://miro.medium.com/max/34/0*NJrMAwdZwDQk2NMX?q=20" width="475" height="862" role="presentation"></p><p><img width="475" height="862" srcset="https://miro.medium.com/max/552/0*NJrMAwdZwDQk2NMX 276w, https://miro.medium.com/max/950/0*NJrMAwdZwDQk2NMX 475w" sizes="475px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph="">My DNS Server after Walking Outside</figcaption></figure><p id="1c01" data-selectable-paragraph="">Ok…looks like it’s a Verizon DNS server up in San Jose, indicating I’m probably away from any known Wi-Fi network on a mobile carrier.</p><p id="eb99" data-selectable-paragraph="">I then connect to Starbucks Wi-Fi. I did another Signal DNS leak call on myself which revealed an OpenDNS server IP address in the Southern California area.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/34/0*NPUtnxb9RfeDHxrO?q=20" width="451" height="794" role="presentation"></p><p><img width="451" height="794" srcset="https://miro.medium.com/max/552/0*NPUtnxb9RfeDHxrO 276w, https://miro.medium.com/max/902/0*NPUtnxb9RfeDHxrO 451w" sizes="451px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph="">My DNS Server at Starbucks</figcaption></figure><p id="b29a" data-selectable-paragraph="">With this information, an attacker knows I’m <strong>not </strong>home at this time. If the attacker cared more, they could even build a profile of frequent DNS servers I use to map out my usual locations such as “at work,” “at home,” “at coffee shop,” “at friend’s house,” etc.</p><p id="20b8" data-selectable-paragraph="">I tested this with a few other locations and networks as well. Here is a fellow employee who volunteered for this test. The DNS server in this case came from Pennsylvania, which is the same state he resided in at the time I did the test.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/34/0*K8jjxy0T601hwYsP?q=20" width="508" height="908" role="presentation"></p><p><img width="508" height="908" srcset="https://miro.medium.com/max/552/0*K8jjxy0T601hwYsP 276w, https://miro.medium.com/max/1016/0*K8jjxy0T601hwYsP 508w" sizes="508px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph="">Locating Pennsylvania User</figcaption></figure><p id="0d50" data-selectable-paragraph="">A couple odd DNS curve balls did come. For example, in one instance I was in California connected to some restaurant’s Wi-Fi network and it had me resolving queries from…Miami, FL. Another test with a different coworker in Pennsylvania resolved from Toronto for one of the network tests, which was still around ~400 miles away but definitely pushing it.</p><p id="00ec" data-selectable-paragraph="">In these instances, a repetitive attack over a week could better narrow down location as there will be more DNS servers leaked to better map out general location using multiple data points, additionally, <strong>if one of these DNS servers throughout an attack ends up using EDNS Client Subnet (such as Google Public DNS), then we can leak much finer location information…</strong></p><p id="e5d8" data-selectable-paragraph="">Some DNS servers, such as the commonly used Google Public DNS (8.8.8.8/8.8.4.4), use <a href="https://developers.google.com/speed/public-dns/faq" target="_blank" rel="noopener nofollow">EDNS Client Subnet</a>. This will forward part of the originating client’s IP address (First 3 octets) to the nameserver. This makes location narrowing much more fine tuned for this attack. Below we see a snippet explaining EDNS Client Subnet.</p><blockquote><p id="1a1a" data-selectable-paragraph="">This allows resolvers to pass in part of the client’s IP address (the first 24/56 bits or less for IPv4/IPv6 respectively) as the source IP in the DNS message, so that name servers can return optimized results based on the user’s location rather than that of the resolver.</p></blockquote><p id="c26d" data-selectable-paragraph="">Let’s see some examples. In this scenario, we leak a volunteer’s DNS server in the midwest that is using EDNS Client Subnet. Our nameserver was forwarded the first 3 octets of the user’s ACTUAL IP address (last 2 octets blurred) in the Additional Records/Client Subnet field of the request.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*hDvxaPLyLvlDuWDb?q=20" width="1400" height="416" role="presentation"></p><p><img width="1400" height="416" srcset="https://miro.medium.com/max/552/0*hDvxaPLyLvlDuWDb 276w, https://miro.medium.com/max/1104/0*hDvxaPLyLvlDuWDb 552w, https://miro.medium.com/max/1280/0*hDvxaPLyLvlDuWDb 640w, https://miro.medium.com/max/1400/0*hDvxaPLyLvlDuWDb 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">EDNS Client Subnet Capture</figcaption></figure><p id="c189" data-selectable-paragraph="">Looking up this IP subnet, it narrowed the location just a couple miles away from his actual location.</p><p id="4ec9" data-selectable-paragraph="">I then tested this on myself, as I happened to be on a network using Google Public DNS. After ringing my number from my burner phone, we ended up revealing the exact city I was in after looking up this forwarded Client Subnet.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*WQbEyZ-mzVeGXwKV?q=20" width="1400" height="460" role="presentation"></p><p><img width="1400" height="460" srcset="https://miro.medium.com/max/552/0*WQbEyZ-mzVeGXwKV 276w, https://miro.medium.com/max/1104/0*WQbEyZ-mzVeGXwKV 552w, https://miro.medium.com/max/1280/0*WQbEyZ-mzVeGXwKV 640w, https://miro.medium.com/max/1400/0*WQbEyZ-mzVeGXwKV 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">EDNS Client Subnet Capture</figcaption></figure><p id="b28b" data-selectable-paragraph="">One of the biggest issues with this is that you cannot prevent some unknown Signal number from ringing your phone and trying to reveal your location/ISP info. It’s also very common to be on a network that is using EDNS Client Subnet at some point in your normal phone usage, which we have seen pinpoints your location down to the city. If you are concerned with this, I recommend updating Signal Android to version 4.59.11 or Signal iOS to version 3.8.4. If you are unable to update to these versions, I recommend using a mobile VPN app that tunnels DNS traffic. In my testing I found Private Internet Access and Psiphon VPN apps do just this and prevent leak from working.</p></div></div></section></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>