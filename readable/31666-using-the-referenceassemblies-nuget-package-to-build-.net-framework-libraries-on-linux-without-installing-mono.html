<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using the ReferenceAssemblies NuGet package to build .NET Framework libraries on Linux, without installing Mono -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Using the ReferenceAssemblies NuGet package to build .NET Framework libraries on Linux, without installing Mono</h1><div><div class="post-content"><p>In this post I show how you can build .NET projects that target .NET Framework versions on Linux, <em>without</em> using Mono. By using <a href="https://www.nuget.org/packages/Microsoft.NETFramework.ReferenceAssemblies/1.0.0-preview.2">the new <em>Microsoft.NETFramework.ReferenceAssemblies</em> NuGet packages</a> from Microsoft you don't need to install anything more than the .NET Core SDK!</p><blockquote><p>tl;dr; To build .NET Framework libraries on Linux, add the following to your project file: <code>&lt;PackageReference Include="Microsoft.NETFramework.ReferenceAssemblies" PrivateAssets="All" Version="1.0.0-preview.2" /&gt;</code></p></blockquote><h2 id="background-building-full-framework-libraries-on-linux" class="heading-with-anchor">Background: Building full-framework libraries on Linux<a href="#background-building-full-framework-libraries-on-linux"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>If you're building .NET Standard NuGet packages, and you want to provide the best experience for your users (<a href="https://twitter.com/terrajobst/status/997262020108926976">and avoid some dependency hell</a>) then you'll want to check out the advice on <a href="https://docs.microsoft.com/en-us/dotnet/standard/library-guidance/cross-platform-targeting">cross-platform targeting</a>. There's a lot of DOs and DON'Ts there, but I tend to boil it down to the following: if you're targeting <em>any</em> version of .NET Standard, then you need the following target frameworks at a minimum:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFrameworks</span><span class="token punctuation">&gt;</span></span>netstandard2.0;net461;net472<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFrameworks</span><span class="token punctuation">&gt;</span></span></code></pre><p>If you're targeting .NET Standard 1.x too then add that in to the mix, the important point is to include the two .NET Framework targets to avoid issues with the .NET Standard 2.0 shim.</p><p>This gives a bit of an issue - the full .NET framework targets mean the library can theoretically only be built on Windows. In <a href="/building-net-framework-asp-net-core-apps-on-linux-using-mono-and-the-net-cli/">a previous post</a> I showed how to work around this for Linux by installing Mono and using the assemblies it provides. In that post I showed that you could actually <em>run</em> a .NET Framework test suite too. This has worked very well for me so far but it has a couple of down sides</p><ul><li>It requires you install Mono</li><li>It requires adding <a href="https://andrewlock.net/building-net-framework-asp-net-core-apps-on-linux-using-mono-and-the-net-cli/#adding-frameworkpathoverrides-for-linux">a somewhat hacky <em>.props</em> file</a></li><li>It's not officially supported, so if it doesn't work, you're on your own</li></ul><p>The <em>.props</em> file sets the <code>FrameworkPathOverride</code> MSBuild variable to the Mono reference assemblies which is how we are able to build. But <a href="https://github.com/dotnet/sdk/issues/335#issuecomment-371422656">as Jon Skeet points out in this comment</a>, Mono isn't actually required. We just need a way of easily getting the reference assemblies to compile against. This is what Microsoft have provided with the <em>Microsoft.NETFramework.ReferenceAssemblies</em> package.</p><h2 id="retrieving-reference-assemblies-from-nuget-with-microsoft-netframework-referenceassemblies" class="heading-with-anchor">Retrieving reference assemblies from NuGet with Microsoft.NETFramework.ReferenceAssemblies<a href="#retrieving-reference-assemblies-from-nuget-with-microsoft-netframework-referenceassemblies"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>I was completely unaware of the Microsoft.NETFramework.ReferenceAssemblies NuGet until I saw this tweet by <a href="https://twitter.com/RehanSaeedUK">Muhammad Rehan Saeed</a>:</p><p>This is really good news - all you need to build libraries that target full .NET Framework on Linux is the .NET Core SDK! </p><p>Let's take an example. You can create a .NET Core class library using <code>dotnet new classlib</code>, which will give a <em>.csproj</em> file that looks something like this:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span><span class="token attr-name">Sdk</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.NET.Sdk<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFramework</span><span class="token punctuation">&gt;</span></span>netstandard2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFramework</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Project</span><span class="token punctuation">&gt;</span></span></code></pre><p>Rename the <code>TargetFramework</code> element to <code>TargetFrameworks</code> and add the extra targets:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span><span class="token attr-name">Sdk</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.NET.Sdk<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFrameworks</span><span class="token punctuation">&gt;</span></span>netstandard2.0;net461;net472<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFrameworks</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Project</span><span class="token punctuation">&gt;</span></span></code></pre><p>If you try and build with <code>dotnet build</code> on Linux at this point, you'll see an error something like the following:</p><pre class="language-bash"><code class="language-bash">/usr/share/dotnet/sdk/2.1.700/Microsoft.Common.CurrentVersion.targets<span class="token punctuation">(</span>1175,5<span class="token punctuation">)</span>: 
error MSB3644: The reference assemblies <span class="token keyword">for</span> framework <span class="token string">".NETFramework,Version=v4.6.1"</span> 
were not found. To resolve this, <span class="token function">install</span> the SDK or Targeting Pack <span class="token keyword">for</span> this framework 
version or retarget your application to a version of the framework <span class="token keyword">for</span><span class="token function">which</span> you have 
the SDK or Targeting Pack installed. Note that assemblies will be resolved from the 
Global Assembly Cache <span class="token punctuation">(</span>GAC<span class="token punctuation">)</span> and will be used <span class="token keyword">in</span> place of reference assemblies. 
Therefore your assembly may not be correctly targeted <span class="token keyword">for</span> the framework you intend.
</code></pre><p>Now for the magic. Add the <em>Microsoft.NETFramework.ReferenceAssemblies</em> package to your project file:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span><span class="token attr-name">Sdk</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.NET.Sdk<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFrameworks</span><span class="token punctuation">&gt;</span></span>netstandard2.0;net461;net472<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFrameworks</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.NETFramework.ReferenceAssemblies<span class="token punctuation">"</span></span><span class="token attr-name">PrivateAssets</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>All<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1.0.0-preview.2<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Project</span><span class="token punctuation">&gt;</span></span></code></pre><p>and suddenly the build succeeds!</p><pre class="language-bash"><code class="language-bash">Build succeeded.
    0 Warning<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    0 Error<span class="token punctuation">(</span>s<span class="token punctuation">)</span></code></pre><blockquote><p>Using the <code>PrivateAssets</code> attribute prevents the <em>Microsoft.NETFramework.ReferenceAssemblies</em> package from "leaking" into dependent projects or published NuGet packages; it's a build-time dependency only. </p></blockquote><p>Simply having to add a package to your library is a <em>much</em> better experience than having to explicitly install Mono. On top of that, <a href="https://github.com/dotnet/sdk/issues/335#issuecomment-497976291">this will be the supported approach from now on</a>. But it gets better - in the .NET Core 3.0 SDK, <a href="https://github.com/dotnet/designs/pull/33#issuecomment-498362109">the reference assembly packages will be automatically used if necessary</a>, so in theory there's no workarounds required at all!</p><p>If you're interested in how the package works, I suggest <a href="https://github.com/dotnet/designs/pull/33">reading the relevant issue</a>, but I'll provide a high-level outline here. </p><p>We'll start with <a href="https://www.nuget.org/packages/Microsoft.NETFramework.ReferenceAssemblies/">the <em>Microsoft.NETFramework.ReferenceAssemblies</em> NuGet package</a> itself. This package is a meta-package that contains no code, but has a dependency on a different NuGet package for each of the supported .NET Framework versions:</p><p><img src="/content/images/2019/reference_assemblies_01.png" alt="The Microsoft.NETFramework.ReferenceAssemblies nuget.org page showing its dependencies"></p><p>So for example, for the .NET Framework 4.6.1 target, the meta-package depends on <a href="https://www.nuget.org/packages/Microsoft.NETFramework.ReferenceAssemblies.net461/"><em>Microsoft.NETFramework.ReferenceAssemblies.net461</em></a>. This approach ensures that you only download the reference assemblies for the framework versions you're actually targeting. </p><p>If you open up one of the Framework-specific NuGet packages you'll find two things in the <em>build</em> folder:</p><ul><li>A <em>.targets</em> file</li><li>A <em>.NETFramework</em> folder full of the reference assemblies (&gt;100MB!)</li></ul><p>The <em>.targets</em> file serves a similar purpose to <a href="https://andrewlock.net/building-net-framework-asp-net-core-apps-on-linux-using-mono-and-the-net-cli/#adding-frameworkpathoverrides-for-linux">the <em>.props</em> file in my previous post</a> - it tells MSBuild where to find the framework libraries. The example below is from the .NET 4.6.1 package:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token attr-name">Condition</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span> (<span class="token punctuation">'</span>$(TargetFrameworkIdentifier)<span class="token punctuation">'</span> == <span class="token punctuation">'</span>.NETFramework<span class="token punctuation">'</span>) And (<span class="token punctuation">'</span>$(TargetFrameworkVersion)<span class="token punctuation">'</span> == <span class="token punctuation">'</span>v4.6.1<span class="token punctuation">'</span>) <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFrameworkRootPath</span><span class="token punctuation">&gt;</span></span>$(MSBuildThisFileDirectory)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFrameworkRootPath</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EnableFrameworkPathOverride</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EnableFrameworkPathOverride</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NoStdLib</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>NoStdLib</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token attr-name">Condition</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span> (<span class="token punctuation">'</span>$(TargetFrameworkIdentifier)<span class="token punctuation">'</span> == <span class="token punctuation">'</span>.NETFramework<span class="token punctuation">'</span>) And (<span class="token punctuation">'</span>$(TargetFrameworkVersion)<span class="token punctuation">'</span> == <span class="token punctuation">'</span>v4.6.1<span class="token punctuation">'</span>) <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Reference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mscorlib<span class="token punctuation">"</span></span><span class="token attr-name">Pack</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Project</span><span class="token punctuation">&gt;</span></span></code></pre><p>This sets the <code>TargetFrameworkRootPath</code> parameter to the folder containing the <em>.targets</em> file. MSBuild traverses down the NuGet package's folder structure (<em>.NETFramework\v4.6.1</em>), to find the dlls, and finds the reference assemblies:</p><p><img src="/content/images/2019/reference_assemblies_02.png" alt="The reference assemblies downloaded in the NuGet package"></p><p>I've tested out the packages using both the .NET Core 2.1 SDK and 2.2 SDK, and it's worked brilliantly both times. Give it a try!</p><h2 id="resources" class="heading-with-anchor">Resources<a href="#resources"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>