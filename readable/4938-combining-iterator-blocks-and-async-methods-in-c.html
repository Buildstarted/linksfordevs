<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Combining iterator blocks and async methods in C# -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Combining iterator blocks and async methods in C#</h1><div><div class="entry-content col-12 sharepostcontent"><div class="row justify-content-center"><div class="col-md-4"><div><img src="https://devblogs.microsoft.com/premier-developer/wp-content/uploads/sites/31/2019/06/Sergey-Tepliakov-150x150.jpg" width="58" height="58" alt="Sergey Tepliakov" class="avatar avatar-58 wp-user-avatar wp-user-avatar-58 alignnone photo"><p>Sergey</p></div></div></div><p>September 5th, 2018</p><p>One of the best traits of a well-designed system is composability. Large systems are complex and hierarchical and one of the best ways to fight accidental complexity is to compose a system from smaller components. You write and test each component independently then you glue them together to achieve a higher-level behavior.</p><p>Programming languages usually designed to have “composable” features as well. You should be able to use multiple features together and the entire thing should just work. In C# you can compose different features together, and everything works. Unless it isn’t.</p><p>Recently I stumbled across a piece of C# code that shows the complexity of the language and demonstrates how easy these days to make mistakes by combining different language features. C# language is complex, and it is important to understand the features deep enough to use them correctly.</p><p>Let’s review the following code:</p><div id="crayon-5e39e5549d3ed359138934" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">public static IEnumerable&lt;Task&lt;int&gt;&gt; ParseFile(string path)
{
    if (string.IsNullOrEmpty(path)) throw new ArgumentNullException(nameof(path));

    // OpenWithRetryPolicyAsync uses RetryPolicy to try to open the file more than once.
    // The method throws FileNotFoundException if the file does not exists.
    using (var file = OpenWithRetryPolicyAsync(path).Result)
    {
        using (var reader = new StreamReader(file))
        {
            // Let's assume that the first line contains a number of entries.

            // Using int.Parse for simplicities sake
            var numberOfEntries = int.Parse(reader.ReadLine());

            for (int entry = 0; entry &lt; numberOfEntries; entry++)
            {
                yield return ReadAndParseAsync(reader);
            }
        }
    }
}

private static async Task&lt;int&gt; ReadAndParseAsync(StreamReader reader)
{
    string line = await reader.ReadLineAsync();
    return int.Parse(line);
}

public static IEnumerable&lt;Task&lt;int&gt;&gt; ParseAndLogIfNeeded(string path)
{
    try
    {
        return ParseFile(path);
    }
    catch (Exception e)
    {
        Console.WriteLine($"Failed to parse the file: {e.Message}");
        return Enumerable.Empty&lt;Task&lt;int&gt;&gt;();
    }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-1">1</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-2">2</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-3">3</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-4">4</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-5">5</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-6">6</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-7">7</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-8">8</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-9">9</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-10">10</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-11">11</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-12">12</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-13">13</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-14">14</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-15">15</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-16">16</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-17">17</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-18">18</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-19">19</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-20">20</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-21">21</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-22">22</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-23">23</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-24">24</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-25">25</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-26">26</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-27">27</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-28">28</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-29">29</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-30">30</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-31">31</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-32">32</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-33">33</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-34">34</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-35">35</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-36">36</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-37">37</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-38">38</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-39">39</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-40">40</p><p class="crayon-num" data-line="crayon-5e39e5549d3ed359138934-41">41</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-1"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-i">IEnumerable</span><span class="crayon-h">&lt;</span><span class="crayon-i">Task</span><span class="crayon-h">&lt;</span><span class="crayon-t">int</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">ParseFile</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">path</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-e">IsNullOrEmpty</span><span class="crayon-sy">(</span><span class="crayon-i">path</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-st">throw</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">ArgumentNullException</span><span class="crayon-sy">(</span><span class="crayon-e">nameof</span><span class="crayon-sy">(</span><span class="crayon-i">path</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// OpenWithRetryPolicyAsync uses RetryPolicy to try to open the file more than once.</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// The method throws FileNotFoundException if the file does not exists.</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">file</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-e">OpenWithRetryPolicyAsync</span><span class="crayon-sy">(</span><span class="crayon-i">path</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">Result</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">reader</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">StreamReader</span><span class="crayon-sy">(</span><span class="crayon-i">file</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Let's assume that the first line contains a number of entries.</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Using int.Parse for simplicities sake</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">numberOfEntries</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-sy">.</span><span class="crayon-e">Parse</span><span class="crayon-sy">(</span><span class="crayon-i">reader</span><span class="crayon-sy">.</span><span class="crayon-e">ReadLine</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-i">entry</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-i">entry</span><span class="crayon-h"></span><span class="crayon-h">&lt;</span><span class="crayon-h"></span><span class="crayon-i">numberOfEntries</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-i">entry</span>++<span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">yield </span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-e">ReadAndParseAsync</span><span class="crayon-sy">(</span><span class="crayon-i">reader</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-22"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-24"><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-e">async </span><span class="crayon-i">Task</span><span class="crayon-h">&lt;</span><span class="crayon-t">int</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">ReadAndParseAsync</span><span class="crayon-sy">(</span><span class="crayon-e">StreamReader </span><span class="crayon-i">reader</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-25"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">line</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-e">await </span><span class="crayon-i">reader</span><span class="crayon-sy">.</span><span class="crayon-e">ReadLineAsync</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-sy">.</span><span class="crayon-e">Parse</span><span class="crayon-sy">(</span><span class="crayon-i">line</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-28"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-30"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-i">IEnumerable</span><span class="crayon-h">&lt;</span><span class="crayon-i">Task</span><span class="crayon-h">&lt;</span><span class="crayon-t">int</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">ParseAndLogIfNeeded</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">path</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-31"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">try</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-e">ParseFile</span><span class="crayon-sy">(</span><span class="crayon-i">path</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">catch</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-i">Exception</span><span class="crayon-h"></span><span class="crayon-i">e</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-s">"Failed to parse the file: {e.Message}"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-i">Enumerable</span><span class="crayon-sy">.</span><span class="crayon-i">Empty</span><span class="crayon-h">&lt;</span><span class="crayon-i">Task</span><span class="crayon-h">&lt;</span><span class="crayon-t">int</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d3ed359138934-41"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>The code of <code>OpenWithRetryPolicyAsync</code> method is not relevant for our discussion so I moved the code to the end of the blog post.</p><ol><li>Exception handling and iterator blocks</li></ol><p>Iterator blocks are quite different from regular methods. If a method returns <code>IEnumerable&lt;T&gt;</code> or <code>IEnumerator&lt;T&gt;</code> and has <code>yield return</code> in it, the compiler completely changes the semantics of the method. The method becomes lazy and it’ll be executed not when the method is called, but rather when the sequence is consumed.</p><p>This behavior may catch you off-guard especially when the result of the iterator block is “transformed” using other lazily evaluated functions, like LINQ operators:</p><div id="crayon-5e39e5549d405811741873" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">var s1 = ParseFile(null); // no exceptions

var s2 = s1.Select(t =&gt; t.GetAwaiter().GetResult()).Where(r =&gt; r == 42); // no exceptions

if (s2.Any()) // throws an exception, potentially in completely different subsystem!
{ }</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e39e5549d405811741873-1"><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">s1</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-e">ParseFile</span><span class="crayon-sy">(</span><span class="crayon-t">null</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-c">// no exceptions</span></p><p class="crayon-line" id="crayon-5e39e5549d405811741873-3"><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">s2</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">s1</span><span class="crayon-sy">.</span><span class="crayon-e">Select</span><span class="crayon-sy">(</span><span class="crayon-i">t</span><span class="crayon-h"></span>=<span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">t</span><span class="crayon-sy">.</span><span class="crayon-e">GetAwaiter</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetResult</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Where</span><span class="crayon-sy">(</span><span class="crayon-i">r</span><span class="crayon-h"></span>=<span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">r</span><span class="crayon-h"></span>==<span class="crayon-h"></span><span class="crayon-cn">42</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-c">// no exceptions</span></p><p class="crayon-line" id="crayon-5e39e5549d405811741873-5"><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-i">s2</span><span class="crayon-sy">.</span><span class="crayon-e">Any</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-c">// throws an exception, potentially in completely different subsystem!</span></p><p class="crayon-line" id="crayon-5e39e5549d405811741873-6"><span class="crayon-sy">{</span><span class="crayon-h"></span><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>This means that <code>ParseFile</code> method never throws when the method is called, and the catch block <code>ParseAndLogIfNeeded</code> is effectively unreachable and will never handle any errors.</p><ol start="2"><li>Observing <code>ex.Message</code> is not enough</li></ol><p><strong>Exceptions are like ogres, they have layers.</strong> In many cases, exceptions are nested with absolutely unactionable information in the top-level <code>Message</code> property.</p><p>Let’s suppose we resolved laziness issue by calling <code>.ToList()</code>: <code>try { return ParseFile(path).ToList();}</code>.</p><p>If a given <code>path</code> does not exist, then <code>OpenWithRetryPolicyAsync</code> throws <code>FileNotFoundException</code>. But because the method is asynchronous, the actual error will be wrapped in <code>AggregateException</code>. And in this case, the log file (the console in this case) will contain a very useful error message: “One or more error occurred”.</p><p>And <code>AggregateException</code> is not the only example: <code>TypeLoadExcpetion</code> and <code>TargetInvocationException</code> never contain relevant information in <code>Message</code>property. In other cases, you need to know a stack trace or an inner exception in order to understand the root cause of an issue.</p><p>In the perfect world, you would never even catch <code>System.Exception</code>, but in reality, this suggestion isn’t practical. So if you ended up catching generic exception type without re-throwing it, at least trace the full exception instance. Believe me, you’ll save yourself hours of investigation time in the future.</p><ol start="3"><li>Prefer calling <code>GetAwaiter().GetResult</code> over <code>.Result</code></li></ol><p>Blocking asynchronous operations is another anti-pattern that should never be used. But similarly to another anti-pattern mentioned above, you have to use it in practice from time to time to avoid viral asynchrony of the code.</p><p>There are 3 ways to synchronously wait for the result of a task-based operation: <code>.Result</code>, <code>.Wait</code> and <code>GetAwaiter().GetResult()</code>. The first two operations will throw <code>AggregateException</code> if the task fails and <code>GetAwaiter().GetResult()</code> will unwrap and throw the first exception from task’s <code>AggregateException</code>.</p><p>In some rare cases, a task is backed by more than one operation and <code>AggregateException</code> is what you need. But in the majority tasks are backed by an asynchronous operation that could have only one error, and propagating it directly simplifies exception handling a lot, especially when a caller does not expect to get an <code>AggregateException</code> at all.</p><ol start="4"><li>Using block and the lifetime of asynchronous operations</li></ol><p>All the issues we discussed before are important but more or less obvious for experienced developers. The last one is a bit subtler.</p><p>Let’s take a closer look at the lifetime of the <code>file</code> variable in <code>ParseFile</code>. The compiler generates a state machine and calls a generated “finally block” to close the file when all the items of the sequence are produced. But the problem is that the method “yields” tasks (not values) and if the last task is not synchronous, then the task may read a file when the file is already closed!</p><p>Here what may happen if the caller of <code>ParseFile</code> calls <code>ToList()</code> on the result to eagerly obtain all the elements from the sequence and if the tasks are not completed synchronously:</p><div id="crayon-5e39e5549d414303467187" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">Step 1: Opening the file 
Step 2: Yielding Task0 
Step 3: Yielding Task1 
Step 4: Closing the file 
Step 5-6: Tasks 0 and 1 are reading the file and failing with `ObjectDisposeException`</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e39e5549d414303467187-1"><span class="crayon-i">Step</span><span class="crayon-h"></span><span class="crayon-cn">1</span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-e">Opening </span><span class="crayon-e">the </span><span class="crayon-e">file </span></p><p class="crayon-line" id="crayon-5e39e5549d414303467187-2"><span class="crayon-i">Step</span><span class="crayon-h"></span><span class="crayon-cn">2</span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-e">Yielding </span><span class="crayon-e">Task0 </span></p><p class="crayon-line" id="crayon-5e39e5549d414303467187-3"><span class="crayon-i">Step</span><span class="crayon-h"></span><span class="crayon-cn">3</span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-e">Yielding </span><span class="crayon-e">Task1 </span></p><p class="crayon-line" id="crayon-5e39e5549d414303467187-4"><span class="crayon-i">Step</span><span class="crayon-h"></span><span class="crayon-cn">4</span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-e">Closing </span><span class="crayon-e">the </span><span class="crayon-e">file </span></p><p class="crayon-line" id="crayon-5e39e5549d414303467187-5"><span class="crayon-i">Step</span><span class="crayon-h"></span><span class="crayon-cn">5</span>-<span class="crayon-cn">6</span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-i">Tasks</span><span class="crayon-h"></span><span class="crayon-cn">0</span><span class="crayon-h"></span><span class="crayon-st">and</span><span class="crayon-h"></span><span class="crayon-cn">1</span><span class="crayon-h"></span><span class="crayon-e">are </span><span class="crayon-e">reading </span><span class="crayon-e">the </span><span class="crayon-e">file </span><span class="crayon-st">and</span><span class="crayon-h"></span><span class="crayon-e">failing </span><span class="crayon-i">with</span><span class="crayon-h"></span><span class="crayon-sy">`</span><span class="crayon-i">ObjectDisposeException</span><span class="crayon-sy">`</span></p></div></td></tr></tbody></table></div></div><p>The issue may be in your code for years and manifest itself in some weird ways. For instance, the code may work fine on Windows for small files when <code>ReadLineAsync()</code>returns synchronously because the data is prefetched, but fail in other cases if <code>ReadLineAsync</code> will do an actual IO. (This is actually exactly how we discovered the issue: once we tried to run the code on MacOS we started getting the errors consistently.)</p><h4>How to solve the main issue?</h4><p>To be honest, I’m not a big fan of <code>IEnumerable&lt;Task&gt;</code>. The main issue from my perspective, that the semantics of a method is not clear. Just by looking at a method signature it is hard to tell if the sequence is “hot” or “cold”. If the sequence is “cold” and lazy, then the tasks in the sequence are initiated one by one. If the sequence is “hot” and is backed by a collection, then all the tasks are running already.</p><p>“The right” approach depends on your needs. If clients will use all the items of the result all the time, then just use <code>Task&lt;List&lt;T&gt;&gt;</code>. As the author of a function, you should think about an ease of use and clarity of your functions. Types can be a useful source of information and you should try to express your intent as clearly as possible.</p><p>Asynchronous sequences could be useful in some cases. For instance, you may use <code>IEnumerable&lt;Task&gt;</code> if the sequence contains many elements, the time for getting the next element is high, and clients may need only the first few elements. But in this case, you should explain your intent in comments or, even better, use something like <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.servicefabric.data.iasyncenumerable-1?view=azure-dotnet"><code>IAsyncEnumerable&lt;T&gt;</code></a>.</p><p>The idea of async streams is not new and you may find types similar to <code>IAsyncEnumerable&lt;T&gt;</code> in many projects. The idiom is so widely used that the C# language authors consider having a language feature to consume async streams using <code>await foreach</code> syntax. (For more information, see <a href="https://github.com/dotnet/csharplang/blob/master/proposals/async-streams.md">Async Streams</a> proposal).</p><h4>The source code of <code>OpenWithRetryPolicyAsync</code></h4><div id="crayon-5e39e5549d421664120051" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">private class RetryIfFileNotFoundPolicy : ITransientErrorDetectionStrategy
{
    public bool IsTransient(Exception ex) =&gt; ex is FileNotFoundException;
}

public static async Task&lt;FileStream&gt; OpenWithRetryPolicyAsync(string path)
{
    // Trying opening the file more then once.
    return await new RetryPolicy&lt;RetryIfFileNotFoundPolicy&gt;(retryCount: 5)
        .ExecuteAsync(() =&gt; Task.FromResult(new FileStream(path, FileMode.Open)));
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e39e5549d421664120051-1"><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-i">RetryIfFileNotFoundPolicy</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-e">ITransientErrorDetectionStrategy</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">bool</span><span class="crayon-h"></span><span class="crayon-e">IsTransient</span><span class="crayon-sy">(</span><span class="crayon-e">Exception </span><span class="crayon-i">ex</span><span class="crayon-sy">)</span><span class="crayon-h"></span>=<span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">ex </span><span class="crayon-st">is</span><span class="crayon-h"></span><span class="crayon-i">FileNotFoundException</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-4"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-6"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-e">async </span><span class="crayon-i">Task</span><span class="crayon-h">&lt;</span><span class="crayon-i">FileStream</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">OpenWithRetryPolicyAsync</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">path</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-7"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Trying opening the file more then once.</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-e">await </span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-i">RetryPolicy</span><span class="crayon-h">&lt;</span><span class="crayon-i">RetryIfFileNotFoundPolicy</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">retryCount</span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-cn">5</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-e">ExecuteAsync</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"></span>=<span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">Task</span><span class="crayon-sy">.</span><span class="crayon-e">FromResult</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">FileStream</span><span class="crayon-sy">(</span><span class="crayon-i">path</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">FileMode</span><span class="crayon-sy">.</span><span class="crayon-i">Open</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e39e5549d421664120051-11"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><div class="authorinfoarea"><div><p>Senior Software Engineer,&nbsp;Tools for Software Engineers</p><p><strong>Follow Sergey</strong>&nbsp;&nbsp;&nbsp;<a class="no-underline stayinformed" aria-label="Sergey Tepliakov Twitter profile" target="_blank" href="https://twitter.com/STeplyakov"></a><a class="no-underline stayinformed" aria-label="Sergey Tepliakov LinkedIn profile" target="_blank" href="https://www.linkedin.com/in/sergeyteplyakov"><i class="fa fa-linkedin"></i></a><a class="no-underline stayinformed" aria-label="Sergey Tepliakov GitHub profile" target="_blank" href="https://github.com/SergeyTeplyakov"><i class="fa fa-github"></i></a><a class="no-underline stayinformed hvr-pop" aria-label="Sergey Tepliakov RSS Feed" target="_blank" href="https://devblogs.microsoft.com/premier-developer/author/seteplia/feed/"></a></p></div></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>