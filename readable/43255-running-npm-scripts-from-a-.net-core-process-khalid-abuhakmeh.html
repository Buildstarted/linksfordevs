<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Running NPM Scripts From A .NET Core Process | Khalid Abuhakmeh -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Running NPM Scripts From A .NET Core Process  |
      Khalid Abuhakmeh</h1><div><div class="post-content"><p>It’s 2019, and no one can argue that to be a successful developer, you need a couple of tools in your toolbox. For ASP.NET developers, they can build web applications and run Kestrel as a web server. For front end developers, many UI frameworks have their own hot-reload capable web servers. In this post, I’ll show you .NET developers how to start a front end web server from their .NET Core process and use that in their C# application.</p><p><strong>Download the project at <a href="https://github.com/khalidabuhakmeh/ChildProcesses">GitHub</a>.</strong></p><h2 id="why-run-npm-scripts-from-net-core">Why Run NPM Scripts From .NET Core</h2><p>Like I mentioned above, many web frameworks come with their web servers. By using these internal webservers, developers get access to many features they wouldn’t otherwise. Some highlights include hot-reloading when development files change and extra debugging capabilities. Running these servers from .NET Core allows us to read the output and create variables for our .NET Core application to use (as you’ll see later).</p><p>Before we get started, we’ll need NodeJs, NPM, and .NET Core.</p><h2 id="setting-up-the-script">Setting up the Script</h2><p>In a new .NET Core application, we’ll need to set up a <code class="highlighter-rouge">packages.json</code> file. This file will have our development dependency and UI framework of our choice. In this example, I am using <a href="https://parceljs.org/">Parcel</a> to bundle and minify my assets. And as it stands today, it also has [an internal webserver][parcel-sever]. We’ll use the server to serve those assets to our C# application.</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"></span><span class="nl">"name"</span><span class="p">:</span><span class="w"></span><span class="s2">"ChildProcesses"</span><span class="p">,</span><span class="w"></span><span class="nl">"version"</span><span class="p">:</span><span class="w"></span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w"></span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"></span><span class="p">{},</span><span class="w"></span><span class="nl">"devDependencies"</span><span class="p">:</span><span class="w"></span><span class="p">{</span><span class="w"></span><span class="nl">"parcel"</span><span class="p">:</span><span class="w"></span><span class="s2">"^1.12.4"</span><span class="w"></span><span class="p">},</span><span class="w"></span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"></span><span class="p">{</span><span class="w"></span><span class="nl">"dev"</span><span class="p">:</span><span class="w"></span><span class="s2">"parcel ./src/index.html"</span><span class="p">,</span><span class="w"></span><span class="nl">"build"</span><span class="p">:</span><span class="w"></span><span class="s2">"parcel build ./src/index.html"</span><span class="p">,</span><span class="w"></span><span class="nl">"watch"</span><span class="p">:</span><span class="w"></span><span class="s2">"parcel watch ./src/index.html"</span><span class="w"></span><span class="p">}</span><span class="w"></span><span class="p">}</span><span class="w"></span></code></pre></div></div><p>Parcel has three commands that are of interest to us.</p><ul><li><code class="highlighter-rouge">build</code>: creates our assets for production</li><li><code class="highlighter-rouge">watch</code>: creates our assets for development and rebuilds them when they change.</li><li><code class="highlighter-rouge">dev</code>: like <code class="highlighter-rouge">watch</code> but with a web server</li></ul><p>We could run any of the scripts from our .NET Core application, but likely to run <code class="highlighter-rouge">dev</code> or <code class="highlighter-rouge">watch</code> during our development process. If you want to run <code class="highlighter-rouge">build</code>, I suggest <a href="https://khalidabuhakmeh.com/kick-ass-with-aspnet-core-vue-components-and-parcel">my previous post, which shows how you can run NPM scripts during the build process</a>.</p><h2 id="the-net-core-application">The .NET Core Application</h2><p>Let’s look at the final product of running the NPM script in our .NET Core application.</p><div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span><span class="nn">System</span><span class="p">;</span><span class="k">using</span><span class="nn">System.Threading</span><span class="p">;</span><span class="k">using</span><span class="nn">System.Threading.Tasks</span><span class="p">;</span><span class="k">namespace</span><span class="nn">ChildProcesses</span><span class="p">{</span><span class="k">static</span><span class="k">class</span><span class="nc">Program</span><span class="p">{</span><span class="k">static</span><span class="k">async</span><span class="n">Task</span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="n">args</span><span class="p">)</span><span class="p">{</span><span class="k">using</span><span class="nn">var</span><span class="n">parcel</span><span class="p">=</span><span class="k">new</span><span class="nf">NpmScript</span><span class="p">();</span><span class="k">await</span><span class="n">parcel</span><span class="p">.</span><span class="nf">RunAsync</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">);</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">parcel</span><span class="p">.</span><span class="n">HasServer</span><span class="p">?</span><span class="s">$"From ASP.NET Core. Parcel is started (</span><span class="p">{</span><span class="n">parcel</span><span class="p">.</span><span class="n">HasServer</span><span class="p">}</span><span class="s">) @ </span><span class="p">{</span><span class="n">parcel</span><span class="p">.</span><span class="n">Url</span><span class="p">}</span><span class="s"> at process: </span><span class="p">{</span><span class="n">parcel</span><span class="p">.</span><span class="n">ProcessId</span><span class="p">}</span><span class="s">"</span><span class="p">:</span><span class="s">"Script has executed."</span><span class="p">);</span><span class="k">await</span><span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">4</span><span class="p">));</span><span class="p">}</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>In the code, we create a new <code class="highlighter-rouge">NpmScript</code> class, and then run the process. The <code class="highlighter-rouge">NpmScript</code> class does a few things that I think folks will appreciate.</p><ol><li>It will wait for the Parcel process to complete running.</li><li>It will parse the output for the webserver</li><li>In the off chance we are not running the webserver, it will timeout and succeed</li><li>We can write the console output of our NPM script to an <code class="highlighter-rouge">Action</code></li><li>It will throw if the process fails to start.</li><li>The node process is a child process of our .NET Core application. When our app stops, so will all child processes.</li></ol><p>After we run it, we get the following results:</p><p><img src="https://d33wubrfki0l68.cloudfront.net/ca1edbee1dc96c5c3315a2a484bb69dba5363283/ba0f7/assets/images/generated/netcore_npm/running_process-710-b7abb3.png" alt="running the process" srcset="https://d33wubrfki0l68.cloudfront.net/48a78b206296cd8556250751d060e6ae7c36e8e2/26612/assets/images/generated/netcore_npm/running_process-400-b7abb3.png 400w, https://d33wubrfki0l68.cloudfront.net/a178cf519d82babefaba091c0c71c6b7aeffb12b/d2e29/assets/images/generated/netcore_npm/running_process-600-b7abb3.png 600w, https://d33wubrfki0l68.cloudfront.net/ca1edbee1dc96c5c3315a2a484bb69dba5363283/ba0f7/assets/images/generated/netcore_npm/running_process-710-b7abb3.png 710w"></p><p>Here is the Node process running in activity monitor.</p><p><img src="https://d33wubrfki0l68.cloudfront.net/3c3069dbb869ddcd4094f4803a04df6b145936c2/1ce55/assets/images/generated/netcore_npm/running_process_activity-800-425e68.png" alt="running the process with activity monitor" srcset="https://d33wubrfki0l68.cloudfront.net/2d47b7e1dcd8c7cd9a5e7242a4d53d6986324524/6ee2f/assets/images/generated/netcore_npm/running_process_activity-400-425e68.png 400w, https://d33wubrfki0l68.cloudfront.net/fded4d5b2ac2ecec301e8850142b9bc6a27dfb0e/901ec/assets/images/generated/netcore_npm/running_process_activity-600-425e68.png 600w, https://d33wubrfki0l68.cloudfront.net/3c3069dbb869ddcd4094f4803a04df6b145936c2/1ce55/assets/images/generated/netcore_npm/running_process_activity-800-425e68.png 800w, https://d33wubrfki0l68.cloudfront.net/05968f49d32417146cf5560e1e9346dcb7f19eaf/a48ee/assets/images/generated/netcore_npm/running_process_activity-852-425e68.png 852w"></p><p>When we close out the .NET Core application, we no longer see the node child processes.</p><p><img src="https://d33wubrfki0l68.cloudfront.net/17c0a3a00d19ebb7a0aba16ca88264256f0808f8/0f131/assets/images/generated/netcore_npm/running_process_activity_done-800-011609.png" alt="running the process with activity monitor empty" srcset="https://d33wubrfki0l68.cloudfront.net/8bef26d4047eea0693411df0c9ce4d4111f47a09/e794d/assets/images/generated/netcore_npm/running_process_activity_done-400-011609.png 400w, https://d33wubrfki0l68.cloudfront.net/a9b83b7b214c2e6e1b77763c1dbea6a465ef5dbd/68462/assets/images/generated/netcore_npm/running_process_activity_done-600-011609.png 600w, https://d33wubrfki0l68.cloudfront.net/17c0a3a00d19ebb7a0aba16ca88264256f0808f8/0f131/assets/images/generated/netcore_npm/running_process_activity_done-800-011609.png 800w, https://d33wubrfki0l68.cloudfront.net/326122861f12982c73efd861196490a94a7cc385/5f393/assets/images/generated/netcore_npm/running_process_activity_done-1000-011609.png 1000w"></p><h2 id="the-npmscript-class">The NpmScript Class</h2><p>The following is the implementation of <code class="highlighter-rouge">NpmScript</code>, which uses a <code class="highlighter-rouge">Process</code> class to execute our NPM scripts.</p><div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span><span class="k">class</span><span class="nc">NpmScript</span><span class="p">:</span><span class="n">IDisposable</span><span class="p">{</span><span class="k">private</span><span class="k">readonly</span><span class="kt">string</span><span class="n">scriptName</span><span class="p">;</span><span class="k">private</span><span class="k">static</span><span class="k">readonly</span><span class="n">Regex</span><span class="n">urls</span><span class="p">=</span><span class="k">new</span><span class="nf">Regex</span><span class="p">(</span><span class="s">"(ht|f)tp(s?)\\:\\/\\/[0-9a-zA-Z]([-.\\w]*[0-9a-zA-Z])*(:(0-9)*)*(\\/?)([a-zA-Z0-9\\-\\.\\?\\,\\'\\/\\\\\\+&amp;%\\$#_]*)?"</span><span class="p">,</span><span class="n">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="p">|</span><span class="n">RegexOptions</span><span class="p">.</span><span class="n">Compiled</span><span class="p">);</span><span class="k">private</span><span class="n">Process</span><span class="n">process</span><span class="p">;</span><span class="k">public</span><span class="kt">string</span><span class="n">Url</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">private</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">bool</span><span class="n">HasServer</span><span class="p">=&gt;</span><span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">Url</span><span class="p">);</span><span class="k">public</span><span class="kt">int</span><span class="n">ProcessId</span><span class="p">=&gt;</span><span class="n">process</span><span class="p">?.</span><span class="n">Id</span><span class="p">??</span><span class="m">0</span><span class="p">;</span><span class="k">private</span><span class="k">readonly</span><span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span><span class="n">signal</span><span class="p">=</span><span class="k">new</span><span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;(</span><span class="k">false</span><span class="p">);</span><span class="c1">/// &lt;summary&gt;</span><span class="c1">/// Will execute a script name with default value of "dev"</span><span class="c1">/// i.e. npm run [script name]</span><span class="c1">/// &lt;/summary&gt;</span><span class="c1">/// &lt;param name="scriptName"&gt;&lt;/param&gt;</span><span class="k">public</span><span class="nf">NpmScript</span><span class="p">(</span><span class="kt">string</span><span class="n">scriptName</span><span class="p">=</span><span class="s">"dev"</span><span class="p">)</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="n">scriptName</span><span class="p">=</span><span class="n">scriptName</span><span class="p">;</span><span class="p">}</span><span class="c1">/// &lt;summary&gt;</span><span class="c1">/// Will wait for npm to start up and retrieve the first url from the output.</span><span class="c1">/// **Only use this to run the development server.**</span><span class="c1">/// &lt;/summary&gt;</span><span class="c1">/// &lt;param name="output"&gt;&lt;/param&gt;</span><span class="c1">/// &lt;param name="timeout"&gt;In milliseconds&lt;/param&gt;</span><span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span><span class="k">public</span><span class="k">async</span><span class="n">Task</span><span class="nf">RunAsync</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span><span class="n">output</span><span class="p">=</span><span class="k">null</span><span class="p">,</span><span class="kt">int</span><span class="n">timeout</span><span class="p">=</span><span class="m">2000</span><span class="p">)</span><span class="p">{</span><span class="k">lock</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">process</span><span class="p">==</span><span class="k">null</span><span class="p">)</span><span class="p">{</span><span class="kt">var</span><span class="n">info</span><span class="p">=</span><span class="k">new</span><span class="nf">ProcessStartInfo</span><span class="p">(</span><span class="s">"npm"</span><span class="p">)</span><span class="p">{</span><span class="n">RedirectStandardOutput</span><span class="p">=</span><span class="k">true</span><span class="p">,</span><span class="n">RedirectStandardError</span><span class="p">=</span><span class="k">true</span><span class="p">,</span><span class="n">Arguments</span><span class="p">=</span><span class="s">$"run </span><span class="p">{</span><span class="n">scriptName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span><span class="n">UseShellExecute</span><span class="p">=</span><span class="k">false</span><span class="p">,</span><span class="p">};</span><span class="n">process</span><span class="p">=</span><span class="n">Process</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="n">process</span><span class="p">.</span><span class="n">EnableRaisingEvents</span><span class="p">=</span><span class="k">true</span><span class="p">;</span><span class="n">process</span><span class="p">.</span><span class="nf">BeginOutputReadLine</span><span class="p">();</span><span class="n">process</span><span class="p">.</span><span class="nf">BeginErrorReadLine</span><span class="p">();</span><span class="c1">// Process the NPM output and attempt</span><span class="c1">// to find a URL. This will stop processing</span><span class="c1">// when it finds the first URL</span><span class="n">process</span><span class="p">.</span><span class="n">OutputDataReceived</span><span class="p">+=</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="n">eventArgs</span><span class="p">)</span><span class="p">=&gt;</span><span class="p">{</span><span class="n">output</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">eventArgs</span><span class="p">.</span><span class="n">Data</span><span class="p">);</span><span class="k">if</span><span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">eventArgs</span><span class="p">.</span><span class="n">Data</span><span class="p">)</span><span class="p">&amp;&amp;</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">Url</span><span class="p">))</span><span class="p">{</span><span class="kt">var</span><span class="n">results</span><span class="p">=</span><span class="n">urls</span><span class="p">.</span><span class="nf">Matches</span><span class="p">(</span><span class="n">eventArgs</span><span class="p">.</span><span class="n">Data</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span><span class="p">{</span><span class="n">Url</span><span class="p">=</span><span class="n">results</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">Value</span><span class="p">;</span><span class="n">signal</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="k">true</span><span class="p">);</span><span class="p">}</span><span class="p">}</span><span class="p">};</span><span class="c1">// Terrible things have happened</span><span class="c1">// so we can stop waiting for the success</span><span class="c1">// event to occur, because it ain't happening</span><span class="n">process</span><span class="p">.</span><span class="n">ErrorDataReceived</span><span class="p">+=</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="n">args</span><span class="p">)</span><span class="p">=&gt;</span><span class="p">{</span><span class="n">output</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Data</span><span class="p">);</span><span class="k">if</span><span class="p">(!</span><span class="n">signal</span><span class="p">.</span><span class="n">Task</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span><span class="p">{</span><span class="n">signal</span><span class="p">.</span><span class="nf">SetException</span><span class="p">(</span><span class="k">new</span><span class="nf">Exception</span><span class="p">(</span><span class="s">"npm web server failed to start"</span><span class="p">));</span><span class="p">}</span><span class="p">};</span><span class="c1">// set a timeout to wait for the process</span><span class="c1">// to finish starting and find the Url. If it doesn't then we</span><span class="c1">// assume that the user just ran a script</span><span class="kt">var</span><span class="n">cancellationTokenSource</span><span class="p">=</span><span class="k">new</span><span class="nf">CancellationTokenSource</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span><span class="n">cancellationTokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">.</span><span class="nf">Register</span><span class="p">(()</span><span class="p">=&gt;</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">Task</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="c1">// we don't want to wait for a url anymore</span><span class="n">Url</span><span class="p">=</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span><span class="n">signal</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="k">true</span><span class="p">);</span><span class="p">},</span><span class="k">false</span><span class="p">);</span><span class="p">}</span><span class="p">}</span><span class="k">await</span><span class="n">signal</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="k">void</span><span class="nf">Dispose</span><span class="p">()</span><span class="p">{</span><span class="n">process</span><span class="p">?.</span><span class="nf">Dispose</span><span class="p">();</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><h2 id="conclusion">Conclusion</h2><p>While you could run your frontend web server and .NET Core application as two separate processes, I believe this approach has some benefits that you should consider. First, NPM scripts run as a child process of your .NET Core application. More importantly, you can parse the output of your NPM scripts to create variables to use in your .NET Core applications (think ASP.NET Core). Finally, you can programmatically know whether the NPM scripts succeeded or failed, which can save you hours of debugging. If you’re a .NET Core developer, but still want to use the latest UI frameworks that the JavaScript community has to offer, I hope you consider using this approach. Also, feel free to modify the <code class="highlighter-rouge">NpmScript</code> class to meet your needs.</p><p><strong>Download the project at <a href="https://github.com/khalidabuhakmeh/ChildProcesses">GitHub</a>.</strong></p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>