<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Microservices with ASP.NET Core 3.1 | Pro Code Guide - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Microservices with ASP.NET Core 3.1 | Pro Code Guide - linksfor.dev(s)"/>
    <meta property="article:author" content="procoder"/>
    <meta property="og:description" content="This article will cover in detail how to create Microservices with ASP.NET Core with Serilog, Exception Handling, Swagger UI, Health Checks &amp; Docker."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://procodeguide.com/programming/microservices-asp-net-core/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Microservices with ASP.NET Core 3.1 | Pro Code Guide</title>
<div class="readable">
        <h1>Microservices with ASP.NET Core 3.1 | Pro Code Guide</h1>
            <div>by procoder</div>
            <div>Reading time: 22-28 minutes</div>
        <div>Posted here: 20 Jul 2020</div>
        <p><a href="https://procodeguide.com/programming/microservices-asp-net-core/">https://procodeguide.com/programming/microservices-asp-net-core/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><p>Microservices is a type of Architecture in which application is created as multiple small independent serviceable components. This article will cover in detail how to create microservices with ASP.NET Core, Serilog, Swagger UI, Health Checks &amp; Docker containers.</p><h2><span id="Microservices_Architecture"></span>Microservices Architecture<span></span></h2><figure><img alt="Microservices with ASP.NET Core" data-srcset="https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-1024x459.png 1024w, https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-300x135.png 300w, https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-768x344.png 768w, https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core.png 1200w" data-src="https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-1024x459.png" data-sizes="(max-width: 1024px) 100vw, 1024px" src="https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-1024x459.png" sizes="(max-width: 1024px) 100vw, 1024px" srcset="https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-1024x459.png 1024w, https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-300x135.png 300w, https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core-768x344.png 768w, https://procodeguide.com/wp-content/uploads/2020/06/Microservices-With-ASP.NET-Core.png 1200w"></figure><p>The Microservices architecture style is shown in the figure above. Microservices Architecture is a style in which one large application is developed as a set of small independent services. Here each service implements a specific functionality and has its own data store. Each service functionality should be small enough to implement just one use case and big enough to provide some value. Each service should be deployable separately so that it can be scaled independently. As far as possible these services should be independent of each other and if there is a need for inter-service communication then some lightweight communication protocol can be used.</p><p><strong>Identity Provider</strong> is used to provide user authentication services to an application.</p><blockquote><p>To know details about Identity Provider &amp; also to know about how to secure your ASP.NET Core based application you can check my series on <strong><em><span><a href="https://procodeguide.com/programming/asp-net-core-security/" target="_blank" aria-label="undefined (opens in a new tab)" rel="noreferrer noopener">ASP.NET Core Security</a></span></em></strong></p></blockquote><p><strong>API Gateway</strong> is a single entry point for all requests that help in managing the endpoints and coordinates with different services.</p><p><strong>Container</strong> is a standard unit of software that bundles application or feature and all of its dependencies so that application can be deployed quickly and reliably on any new system that has container host.</p><p><strong>Container Orchestration</strong> is a piece of software that is used to manage the life-cycle of containers in a large application. This helps to scale application on basis of the load.</p><p><strong>Microservice</strong> is the actual small independent service which is bundled in a container along with it dependencies</p><p><strong>Data Store</strong> is used to store microservice data and the basic principle is that each service manages its own data.</p><h2><span id="Monolithic_v/s_Microservices"></span>Monolithic v/s Microservices<span></span></h2><table id="tablepress-1"><thead><tr><th>Monolithic</th><th>Microservices</th></tr></thead><tbody><tr><td>Single service/application should contain all the business functionality</td><td>Single service should contains only one business functionality</td></tr><tr><td>All service are tightly coupled</td><td>All services are loosely coupled</td></tr><tr><td>Application is developed in one single programming language</td><td>Each service can be in different programming language</td></tr><tr><td>Single database for all services.</td><td>Each service has separate database</td></tr><tr><td>All services needs to be deployed together on VM</td><td>Each service can be deployed on separate VM</td></tr><tr><td>All services run in same process so if one service goes down then whole application breaks</td><td>Each service runs in different process so failure of one service does not affects other services</td></tr><tr><td>Difficult to scale a particular service as new instance will have to have all services</td><td>Can be Scaled easily as any single service can be deployed independently</td></tr><tr><td>Single large team works on whole application</td><td>Separate small team work on each Service which are more focused.</td></tr><tr><td>Simple to develop &amp; test small applications</td><td>Add complexity to the application by the fact that its a distributed system</td></tr></tbody></table><div><p><strong>Here is a one of the good books on Rest API with ASP.NET Core</strong></p><p><a target="_blank" href="https://www.amazon.com/gp/product/B07MXLQR34/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B07MXLQR34&amp;linkCode=as2&amp;tag=procodeguide-20&amp;linkId=a52aaeafdbad97e14d26c92464a3193c" rel="noopener noreferrer" data-geniuslink="//buy.geni.us/Proxy.ashx?TSID=112063&amp;GR_URL=https%3A%2F%2Fwww.amazon.com%2Fgp%2Fproduct%2FB07MXLQR34%2Fref%3Das_li_tl%3Fie%3DUTF8%26camp%3D1789%26creative%3D9325%26creativeASIN%3DB07MXLQR34%26linkCode%3Das2%26tag%3Dprocodeguide-20%26linkId%3Da52aaeafdbad97e14d26c92464a3193c&amp;dtb=1"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;MarketPlace=US&amp;ASIN=B07MXLQR34&amp;ServiceVersion=20070822&amp;ID=AsinImage&amp;WS=1&amp;Format=_SL250_&amp;tag=procodeguide-20"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=procodeguide-20&amp;l=am2&amp;o=1&amp;a=B07MXLQR34" alt="" width="1" height="1"></p></div><h2><span id="Why_microservices_with_ASP_NET_Core"></span>Why microservices with ASP.NET Core?<span></span></h2><p>.NET Core provides following advantages which works for microservices</p><ul><li>A light-weight framework built from ground up</li><li>Cross-platform support</li><li>Optimized for containerization</li></ul><h2><span id="Implement_Microservices_with_ASP_NET_Core"></span>Implement Microservices with ASP.NET Core<span></span></h2><figure><div> <p><iframe title="Microservices with ASP.NET Core" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" data-src="https://www.youtube.com/embed/vgQ5ephbITQ?feature=oembed" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" name="fitvid0"></iframe></p></div></figure><p>Here we will cover in detail the step by step process to create microservice with ASP.NET Core. We will be creating an order service that will provide endpoints to Add, Cancel, Get Order By Id &amp; Get Order(s) By Customer Id in the application. This demo has been executed in Visual Studio 2019 version 16.6.2</p><h3><span id="Create_Service_with_CRUD_operations"></span>Create Service with CRUD operations<span></span></h3><h4><span id="Create_ASP_NET_Core_Project"></span>Create ASP.NET Core Project<span></span></h4><p>For microservices demo we will be creating a ASP.NET Core 3.1 Web API project.</p><figure><img alt="ASP.NET Core 3.1 API Project Creation" data-srcset="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-1024x308.png 1024w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-300x90.png 300w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-768x231.png 768w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project.png 1238w" data-src="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-1024x308.png" data-sizes="(max-width: 1024px) 100vw, 1024px" src="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-1024x308.png" srcset="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-1024x308.png 1024w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-300x90.png 300w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project-768x231.png 768w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-3.1-API-Project.png 1238w"></figure><h4><span id="Implement_Order_Service"></span>Implement Order Service <span></span></h4><p>We will be creating order microservice which will contain functionality only related to orders. We will be implementing following endpoints</p><ul><li>Add – To create a new order</li><li>Cancel – To cancel an existing order</li><li>GetById – Get Order by Id</li><li>GetByCustomerId – Get all orders for Customer Id</li></ul><p>Below we will quickly add the entity model for Order &amp; enable entity framework core for order microservice.</p><blockquote><p>If you need further details on how an entity framework works then check my other article on <strong><em><a href="https://procodeguide.com/programming/entity-framework-core-in-asp-net-core/" target="_blank" rel="noreferrer noopener">Entity Framework Core in ASP.NET Core 3.1</a></em></strong></p></blockquote><h5>Add Model</h5><p>Add an order entity class</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public class Order
{
    public string Id { get; set; }
    public string ProductId { get; set; }
    public double Cost { get; set; }
    public DateTime Placed { get; set; }
    public string CustomerId { get; set; }
    public string Status { get; set; }
}</pre><h5>Add CRUD operations to the API with entity framework core</h5><p>We will make use of Entity Framework Core to implement database operations for the order service.</p><h6>Install required packages for entity framework core</h6><pre data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">Install-Package Microsoft.EntityFrameworkCore
Install-Package Microsoft.EntityFrameworkCore.Design
Install-Package Microsoft.EntityFrameworkCore.SqlServer
Install-Package Microsoft.EntityFrameworkCore.Tools</pre><h6>Add database context class</h6><p>This is the main class that co-ordinates with entity framework functionality for a given model class.</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public interface IApplicationDbContext
{
    DbSet&lt;Order&gt; Orders { get; set; }
    Task&lt;int&gt; SaveChanges();
}</pre><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public class ApplicationDbContext : DbContext, IApplicationDbContext
{
    public ApplicationDbContext(DbContextOptions&lt;ApplicationDbContext&gt; options)
            : base(options)
    {
    }
    public DbSet&lt;Order&gt; Orders { get; set; }
    public new async Task&lt;int&gt; SaveChanges()
    {
        return await base.SaveChangesAsync();
    }
}</pre><h6>Add Order Repository</h6><p>The repository is a component that encapsulates the objects related to data storage and operations performed over them. DbContext is passed as a parameter in the constructor using dependency injection.</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public interface IOrderRepository
{
    Task&lt;string&gt; Add(Order order);
    Task&lt;Order&gt; GetById(string id);
    Task&lt;string&gt; Cancel(string id);
    Task&lt;Order&gt; GetByCustomerId(string custid);
}</pre><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public class OrderRepository : IOrderRepository
{
    private IApplicationDbContext _dbcontext;
    public OrderRepository(IApplicationDbContext dbcontext)
    {
        _dbcontext = dbcontext;
    }

    public async Task&lt;string&gt; Add(Order order)
    {
        _dbcontext.Orders.Add(order);
        await _dbcontext.SaveChanges();
        return order.Id;
    }

    public async Task&lt;string&gt; Cancel(string id)
    {
        var orderupt = await _dbcontext.Orders.Where(orderdet =&gt; orderdet.Id == id).FirstOrDefaultAsync();
        if (orderupt == null) return "Order does not exists";

        orderupt.Status = "Cancelled";

        await _dbcontext.SaveChanges();
        return "Order Cancelled Successfully";
    }

    public async Task&lt;Order&gt; GetByCustomerId(string custid)
    {
        var order = await _dbcontext.Orders.Where(orderdet =&gt; orderdet.CustomerId == custid).FirstOrDefaultAsync();
        return order;
    }

    public async Task&lt;Order&gt; GetById(string id)
    {
        var order = await _dbcontext.Orders.Where(orderdet =&gt; orderdet.Id == id).FirstOrDefaultAsync();
        return order;
    }
}</pre><h6>Connect application to the database</h6><p>Specify the SQL Server connection string in appsettings.json file.</p><pre data-enlighter-language="json" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\mssqllocaldb;Database=OrderDb;Trusted_Connection=True;MultipleActiveResultSets=true"
  }</pre><h6>Register services in startup class</h6><p>You need to configure the database context &amp; order repository as a service in method ConfigureServices in the startup class</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;
                    options.UseSqlServer(
                    Configuration.GetConnectionString("DefaultConnection"),
                    ef =&gt; ef.MigrationsAssembly(typeof(ApplicationDbContext).Assembly.FullName)));
    services.AddScoped&lt;IApplicationDbContext&gt;(provider =&gt; provider.GetService&lt;ApplicationDbContext&gt;());

    services.AddTransient&lt;IOrderRepository, OrderRepository&gt;(); services.AddControllers();

//Remaining code has been removed
}
</pre><h6>Add Migrations</h6><p>To automate the migrations &amp; create a database we need to run the following commands in the package manager console.</p><pre data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">add-migration InitialMigration
update-database</pre><figure><img alt="EF Core Migrations" width="401" height="421" data-srcset="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Migrations.png 535w, https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Migrations-286x300.png 286w" data-src="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Migrations.png" data-sizes="(max-width: 401px) 100vw, 401px" src="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Migrations.png" srcset="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Migrations.png 535w, https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Migrations-286x300.png 286w"></figure><figure><img alt="EF Core Generated Database" width="393" height="509" data-srcset="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Generated-Database.png 524w, https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Generated-Database-232x300.png 232w" data-src="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Generated-Database.png" data-sizes="(max-width: 393px) 100vw, 393px" src="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Generated-Database.png" srcset="https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Generated-Database.png 524w, https://procodeguide.com/wp-content/uploads/2020/06/EF-Core-Generated-Database-232x300.png 232w"></figure><p>One thing to note here is that table is created for order details only. Product &amp; Customer tables are not created with foreign key reference as you have to keep microservice small &amp; focussed on one single functionality. Product &amp; Customer will be in a separate database of their own with their own microservice implementation. If you need product details or customer details to be displayed as part of order details then you need to call respective microservice and fetch required details.</p><h6>Add Order Controller</h6><p>Here is the code for the order controller which has been added to expose the endpoints of the order microservice. Order Repository has been passed as a constructor parameter using dependency injection</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">[Route("api/[controller]")]
[ApiController]
public class OrderController : ControllerBase
{
    private IOrderRepository _orderRepository;
    public OrderController(IOrderRepository orderRepository)
    {
        _orderRepository = orderRepository;
    }

    [HttpPost]
    [Route("Add")]
    public async Task&lt;ActionResult&gt; Add([FromBody] Order orderdet)
    {
        string orderid = await _orderRepository.Add(orderdet);
        return Ok(orderid);
    }

    [HttpGet]
    [Route("GetByCustomerId/{id}")]
    public async Task&lt;ActionResult&gt; GetByCustomerId(string id)
    {
        var orders = await _orderRepository.GetByCustomerId(id);
        return Ok(orders);
    }

    [HttpGet]
    [Route("GetById/{id}")]
    public async Task&lt;ActionResult&gt; GetById(string id)
    {
        var orderdet = await _orderRepository.GetById(id);
        return Ok(orderdet);
    }

    [HttpDelete]
    [Route("Cancel/{id}")]
    public async Task&lt;IActionResult&gt; Cancel(string id)
    {
        string resp = await _orderRepository.Cancel(id);
        return Ok(resp);
    }
}</pre><p>Our order service is ready to perform operations. But to make it a microservice we will have to enable features like Logging, Exception Handling, Documentation, Monitoring, Containerization, etc.</p><h3><span id="Add_Web_API_versioning"></span>Add Web API versioning<span></span></h3><p>Microservices should be easy to change without breaking existing clients and also should be able to support multiple versions side by side so Web API versioning will help us achieve this.</p><p>Web API versioning is a feature using which we can implement multiple versions of the same API so that different clients can work with the required version of API.</p><h4><span id="Implement_Web_API_versioning_using_URL"></span>Implement Web API versioning using URL<span></span></h4><p>In Web API versioning using URL, the version number is part of the URL i.e. http://server:port/api/v1/order/add</p><h5>Install Web API versioning package</h5><pre data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">Install-Package Microsoft.AspNetCore.Mvc.Versioning</pre><h5>Configure Web API versioning in Startup class</h5><p>Enable support for Web API versioning in ConfigureServices method in the startup.cs file.</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public void ConfigureServices(IServiceCollection services)
{
    services.AddApiVersioning(apiVerConfig =&gt;
    {
        apiVerConfig.AssumeDefaultVersionWhenUnspecified = true;
        apiVerConfig.DefaultApiVersion = new ApiVersion(new DateTime(2020, 6, 6));
    });
    //Remaining code has been removed
 }</pre><h5>Add URL Web API versioning to order controller</h5><p>You need to add parameter v{version:apiVersion} in route attribute like R<em>oute(“api/v{version:apiVersion}/[controller]”)</em> so that API version becomes part of URL.</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">[ApiVersion("1.0")]
[Route("api/v{version:apiVersion}/[controller]")]
[ApiController]
public class OrderController : ControllerBase
{
//Remaining code has been removed
}</pre><blockquote><p>If you need further details on Web API versioning in ASP.NET Core then check my other article on <strong><em><a href="https://procodeguide.com/programming/asp-net-core-web-api-versioning/" target="_blank" rel="noreferrer noopener">Web API Versioning in ASP.NET Core 3.1</a></em></strong></p></blockquote><h3><span id="Add_logging_to_microservice"></span>Add logging to microservice<span></span></h3><p>After deploying to production it should be easy to track and analyze issues. Logs help us to analyze complex issues which sometimes might be difficult to simulate. There will always be a need to troubleshoot application issues for which logs will be required for analysis.</p><h4><span id="Implement_logging_with_Serilog"></span>Implement logging with Serilog<span></span></h4><p>There are many third-party providers and one of these is <strong><em><a rel="noreferrer noopener" href="https://serilog.net/" target="_blank">Serilog</a></em></strong>. Serilog is a popular third party logging provider that is supported in ASP.NET Core Logging.</p><h5>Install required Serilog packages</h5><pre data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">Install-Package Serilog.AspNetCore
Install-Package Serilog.Extensions.Logging
Install-Package Serilog.Extensions.Hosting
Install-Package Serilog.Sinks.RollingFile
Install-Package Serilog.Sinks.Async</pre><h5>Add Serilog configuration</h5><p>Serilog RollingFile Sink is implemented by adding configuration to the appsettings.json file. Log level can be specified by setting the log level value in the property named MinimumLevel.</p><pre data-enlighter-language="json" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">  "Serilog": {
    "MinimumLevel": "Information",
    "WriteTo": [
      {
        "Name": "Async",
        "Args": {
          "configure": [
            {
              "Name": "RollingFile",
              "Args": {
                "pathFormat": "Serilogs\AppLogs-{Date}.log",
                "outputTemplate": "{Timestamp:HH:mm:ss.fff zzz} [{Level}] {Message}{NewLine}{Exception}",
                "fileSizeLimitBytes": 10485760
              }
            }
          ]
        }
      }
    ]
  }</pre><h5>Configure Serilog in Program &amp; Startup class</h5><p>Add UseSerilog() to CreateDefaultBuilder in Program.cs</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public static IHostBuilder CreateHostBuilder(string[] args) =&gt;
    Host.CreateDefaultBuilder(args)
        .UseSerilog()
        .ConfigureWebHostDefaults(webBuilder =&gt;
        {
            webBuilder.UseStartup&lt;Startup&gt;();
        });</pre><p>Load Serilog configuration from appsettings.json file in Startup.cs</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public Startup(IConfiguration configuration)
{
    Configuration = configuration;

    Log.Logger = new LoggerConfiguration()
        .ReadFrom.Configuration(configuration)
        .CreateLogger();
}</pre><h5>Add logging in order controller</h5><p>Serilog.Log class has been used to add logs with method Debug for debugging &amp; Error in case of some exception.</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">[HttpPost]
[Route("Add")]
public async Task&lt;ActionResult&gt; Add([FromBody] Order orderdet)
{
    try
    {
        Log.Debug("Order Addition Started");
        Log.Debug("Order Addition Input", orderdet);
        string orderid = await _orderRepository.Add(orderdet);
        Log.Debug("Order Addition Output", orderid);
        return Ok(orderid);
    }
    catch (Exception ex)
    {
        Log.Error("Order Addition Failed", ex);
        throw new Exception("Order Addition Failed", innerException: ex);
    }
}
//Remaining code has been removed</pre><p>Here for demonstration purposes, I have added logging feature only to the controller action ‘Add’ but as good practice, you need to add logs in a complete application with proper log levels which can assist in debugging complex issues on production. Since this is microservice, Async log writing has been configured as that reduces the overhead of logging calls by delegating work to a background thread.</p><p>Also, one more thing to note here is if you are running ASP.NET core application in docker container then you need to be careful with log file location as if you store the log file in the same container itself then there is a possibility of losing that data. In containerized environment logs should be stored on some persistent volume.</p><blockquote><p>If you need further details on Logging with Serilog in ASP.NET Core then check my other article on <strong><em><a href="https://procodeguide.com/programming/aspnet-core-logging-with-serilog/" target="_blank" rel="noreferrer noopener">ASP.NET Core Logging with Serilog</a></em></strong></p></blockquote><div><p><a target="_blank" href="https://www.amazon.com/gp/product/B07L3D19MY/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B07L3D19MY&amp;linkCode=as2&amp;tag=procodeguide-20&amp;linkId=3dcd0406c95f8fc1f3d312d5c4f9c4a5" rel="noopener noreferrer" data-geniuslink="//buy.geni.us/Proxy.ashx?TSID=112063&amp;GR_URL=https%3A%2F%2Fwww.amazon.com%2Fgp%2Fproduct%2FB07L3D19MY%2Fref%3Das_li_tl%3Fie%3DUTF8%26camp%3D1789%26creative%3D9325%26creativeASIN%3DB07L3D19MY%26linkCode%3Das2%26tag%3Dprocodeguide-20%26linkId%3D3dcd0406c95f8fc1f3d312d5c4f9c4a5&amp;dtb=1"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;MarketPlace=US&amp;ASIN=B07L3D19MY&amp;ServiceVersion=20070822&amp;ID=AsinImage&amp;WS=1&amp;Format=_SL250_&amp;tag=procodeguide-20"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=procodeguide-20&amp;l=am2&amp;o=1&amp;a=B07L3D19MY" width="1" height="1" alt=""></p></div><h3><span id="Add_service_monitoring_mechanism"></span>Add service monitoring mechanism<span></span></h3><p>It is always good to keep a check on whether our service is up and running or functioning properly. Before our clients inform us about our broken service we should be able to proactively identify our broken services and take corrective actions. Healthchecks allow us to check if service is healthy i.e. up &amp; running. Healthcheck endpoint can also be used to check its status from loadbalancer &amp; disable a server on load balancer if our service returned failure for healthcheck on that server.</p><h4><span id="Implement_microservice_monitoring_using_ASP_NET_Core_Healthchecks"></span>Implement microservice monitoring using ASP.NET Core Healthchecks<span></span></h4><p>Healthchecks is an in-built middleware in ASP.NET Core for reporting the health of an application. Healthchecks can be exposed as one more endpoint in the application.</p><h5>Install healthchecks packages</h5><p>Using package manager console install the required packages for healthchecks</p><pre data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">Install-Package Microsoft.Extensions.Diagnostics.HealthChecks
Install-Package Microsoft.Extensions.Diagnostics.HealthChecks.EntityFrameworkCore</pre><h5>Configure healthchecks ins Startup class</h5><p>Here we have configured basic application health check &amp; Entity Framework database context health check that confirms that the app can communicate with the database configured for an Entity Framework Core DbContext</p><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddHealthChecks()
        .AddDbContextCheck&lt;ApplicationDbContext&gt;();
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        app.UseHealthChecks("/checkhealth");
   }

    //Remaining code has been removed
}</pre><p>You can check  the service health using URL http://serverip:port/checkhealth</p><h3><span id="Create_documentation_for_microservice"></span>Create documentation for microservice<span></span></h3><p>It is always good to maintain updated documentation for microservices. Other teams should be able to refer to these API specifications and consume microservice accordingly. We will be implementing Swashbuckle.AspNetCore for generating Swagger documents for order microservice.</p><h4><span id="Implement_documentation_using_Swashbuckle_Swagger"></span>Implement documentation using Swashbuckle Swagger<span></span></h4><p>Swashbuckle is an open-source library to generate swagger documentation for ASP.NET Core Web API. This documentation can be used to explore and test API.</p><h5>Install required swashbuckle swagger packages</h5><p>Using package manager console install the required packages for swashbuckle</p><pre data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">Install-Package Swashbuckle.AspNetCore
Install-Package Microsoft.OpenApi</pre><h5>Configure swagger ins Startup class</h5><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddSwaggerGen(options =&gt;
        {
            options.SwaggerDoc("v1", new Microsoft.OpenApi.Models.OpenApiInfo
            {
                Title = "Microservice - Order Web API",
                Version = "v1",
                Description = "Sample microservice for order",
            });
        });
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        app.UseSwagger();
        app.UseSwaggerUI(options =&gt; options.SwaggerEndpoint("/swagger/v1/swagger.json", "PlaceInfo Services"));
    }

    //Remaining code has been removed
}</pre><p>Below is the documentation generated with swagger for order microservice</p><figure><img alt="ASP.NET Core Swagger" data-srcset="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1024x468.png 1024w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-300x137.png 300w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-768x351.png 768w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1536x701.png 1536w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1320x603.png 1320w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger.png 1914w" data-src="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1024x468.png" data-sizes="(max-width: 1024px) 100vw, 1024px" src="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1024x468.png" srcset="https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1024x468.png 1024w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-300x137.png 300w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-768x351.png 768w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1536x701.png 1536w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger-1320x603.png 1320w, https://procodeguide.com/wp-content/uploads/2020/06/ASP.NET-Core-Swagger.png 1914w"></figure><h3><span id="Add_containerization_to_microservice"></span>Add containerization to microservice<span></span></h3><p>Containerization is used to bundle an application or feature of an application, all of it dependencies &amp; its configuration in a container image. This image is deployed on the host operating system and bundled application works as a unit. This concept of container images allows us to deploy these across environments with little or no modifications at all. This way it is easy to scale out microservice quickly as the new containers can be easily deployed for short term purposes.</p><p>Docker will be used to add containerization to our microservice. Docker is an open-source project for creating containers that can run on docker host either on cloud or on-premises.</p><h4><span id="Implement_containerization_using_Docker"></span>Implement containerization using Docker<span></span></h4><p>To enable docker support in ASP.NET Core project right on the project in the solution explorer and select Add=&gt;Docker Support from the Menu</p><figure><img alt="Enable Docker in ASP.NET Core" width="435" height="489" data-srcset="https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core.png 869w, https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core-267x300.png 267w, https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core-768x863.png 768w" data-src="https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core.png" data-sizes="(max-width: 435px) 100vw, 435px" src="https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core.png" srcset="https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core.png 869w, https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core-267x300.png 267w, https://procodeguide.com/wp-content/uploads/2020/06/Enable-Docker-in-ASP.NET-Core-768x863.png 768w"></figure><p>This will enable docker and also create a Dockerfile to the project as shown below</p><pre data-enlighter-language="powershell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">#See https://aka.ms/containerfastmode to understand how Visual Studio uses this Dockerfile to build your images for faster debugging.

#Depending on the operating system of the host machines(s) that will build or run the containers, the image specified in the FROM statement may need to be changed.
#For more information, please see https://aka.ms/containercompat

FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-nanoserver-sac2016 AS base
WORKDIR /app
EXPOSE 80

FROM mcr.microsoft.com/dotnet/core/sdk:3.1-nanoserver-sac2016 AS build
WORKDIR /src
COPY ["ProCodeGuide.Sample.Microservice/ProCodeGuide.Sample.Microservice.csproj", "ProCodeGuide.Sample.Microservice/"]
RUN dotnet restore "ProCodeGuide.Sample.Microservice/ProCodeGuide.Sample.Microservice.csproj"
COPY . .
WORKDIR "/src/ProCodeGuide.Sample.Microservice"
RUN dotnet build "ProCodeGuide.Sample.Microservice.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "ProCodeGuide.Sample.Microservice.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "ProCodeGuide.Sample.Microservice.dll"]</pre><p>This makes the application run within a container on the Docker host. For this to work <strong><em><a href="https://docs.docker.com/docker-for-windows/install/" target="_blank" aria-label="undefined (opens in a new tab)" rel="noreferrer noopener"><span>docker desktop </span></a></em></strong>should be installed on the windows machine.</p><h2><span id="Benefits_of_Microservices"></span>Benefits of Microservices<span></span></h2><ul><li><strong>Gentle Learning Curve</strong>&nbsp;– As business functionality is broken into small services it allows developers to learn just the functionality of that service only.</li><li><strong>Better Scaling</strong>&nbsp;– Each service is deployed independently and so can be scaled separately.</li><li><strong>Lesser time to market</strong>&nbsp;– Application development cycle can be shorter as each service component is independent of each other.</li><li><strong>Fault Isolation</strong>&nbsp;– Failure of one service does not affect the operation of other services.</li><li><strong>No dependency</strong>&nbsp;on a single programming language &amp; deployment model.</li><li><strong>Parallel &amp; Fast development</strong>&nbsp;of different Services is possible as separate teams are working on different services.</li></ul><h2><span id="Drawbacks_with_Microservices"></span>Drawbacks with Microservices<span></span></h2><ul><li>Small independent services require coordination among each other which may be not simple as compared to Monolith Application</li><li>Managing distributed transactions across multiple services can be complex.</li><li>There are Multiple Services/Components to Monitor.</li><li>Testing can be little time consuming as each independent service needs to be tested before integrated testing.</li><li>Whole deployment architecture for large applications becomes very Complex to Manage.</li></ul><p>Microservices Architecture is about better handling a large &amp; complex system but to achieve that it exposes its own set of complexities &amp; implementation Challenges. Despite the disadvantages or problems, the benefits of adopting Microservices are driving factors for many companies to implement Microservices.</p><h2><span id="Best_Practices"></span>Best Practices<span></span></h2><ul><li>Microservice should implement only one single functionality that should be able to deliver value.</li><li>Each Microservice should have their own datastore and this should not be shared across services.</li><li>Always maintain updated documentation for Microservices.</li><li>Use containers for the deployment of services.</li><li>DevOps &amp; CI/CD practices</li></ul><h2><span id="Summary"></span>Summary<span></span></h2><p>We covered what is microservice architecture and how to get started with microservices with ASP.NET Core 3.1. I have not covered one more important feature of microservice i.e automated testing. Automated unit testing is a very vast topic in itself and I will do a separate article on it.</p><p>Quick recap on microservices characteristics</p><ul><li>Microservices is a type of Architecture in which application is created as multiple small independent serviceable components</li><li>Microservice should contain only single business functionality and should be small enough to stay focussed and big enough to deliver value.</li><li>Each Microservice should have its own data store.</li><li>Microservices can communicate with each other using lightweight protocol i.e. over HTTP or Advanced Message Queue Protocol (AMQP)</li><li>Microservice can be deployed independently on a separate VM and can be scaled independently.</li><li>There are benefits in implementing API Gateway for large &amp; Complex Microservices based Applications.</li></ul><h2><span id="Source_code_download"></span>Source code download<span></span></h2><figure><div></div></figure><h6>Hope you found this article useful</h6><p><a target="_blank" href="https://www.buymeacoffee.com/ProCodeGuide"><img alt="Buy me a coffee" data-src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><span>Buy me a coffee</span></a></p><p>  <a target="_blank" href="https://www.amazon.com/gp/product/B01N9E92QY/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B01N9E92QY&amp;linkCode=as2&amp;tag=procodeguide-20&amp;linkId=d14d103d984ea7bef6841079589e1573" data-geniuslink="//buy.geni.us/Proxy.ashx?TSID=112063&amp;GR_URL=https%3A%2F%2Fwww.amazon.com%2Fgp%2Fproduct%2FB01N9E92QY%2Fref%3Das_li_tl%3Fie%3DUTF8%26camp%3D1789%26creative%3D9325%26creativeASIN%3DB01N9E92QY%26linkCode%3Das2%26tag%3Dprocodeguide-20%26linkId%3Dd14d103d984ea7bef6841079589e1573&amp;dtb=1"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;MarketPlace=US&amp;ASIN=B01N9E92QY&amp;ServiceVersion=20070822&amp;ID=AsinImage&amp;WS=1&amp;Format=_SL250_&amp;tag=procodeguide-20"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=procodeguide-20&amp;l=am2&amp;o=1&amp;a=B01N9E92QY" width="1" height="1" alt=""></p></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>