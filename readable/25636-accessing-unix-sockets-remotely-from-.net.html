<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Accessing UNIX sockets remotely from .NET -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Accessing UNIX sockets remotely from .NET</h1><div><div class="entry-content standard-post"><img width="1566" height="809" src="https://developers.redhat.com/blog/wp-content/uploads/2019/05/ssh-unix-sockets.jpg" class="single-post-featured-img wp-post-image" alt="Accessing UNIX sockets remotely from .NET" srcset="https://developers.redhat.com/blog/wp-content/uploads/2019/05/ssh-unix-sockets.jpg 1566w, https://developers.redhat.com/blog/wp-content/uploads/2019/05/ssh-unix-sockets-300x155.jpg 300w, https://developers.redhat.com/blog/wp-content/uploads/2019/05/ssh-unix-sockets-768x397.jpg 768w, https://developers.redhat.com/blog/wp-content/uploads/2019/05/ssh-unix-sockets-1024x529.jpg 1024w" sizes="(max-width: 1566px) 100vw, 1566px"><p>Many Linux services (like D-Bus, PostgreSQL, Docker, etc.) are made accessible locally using a UNIX socket. In this article, we’ll show how you can access such services remotely from .NET using SSH port forwarding.<span id="more-598497"></span></p><h2>UNIX sockets</h2><p><a href="http://man7.org/linux/man-pages/man7/unix.7.html">UNIX domain sockets</a> provide a way to exchange data between processes running on the same host. This approach also brings some security features. First, it isn’t possible to access them via the network. Second, we can identify the userid of the other process and use that to authorize the user. And, finally, UNIX domain sockets are identified with a path in the file system. To access a service, the user must have permissions to the path. <a href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux">SELinux</a> allows even more fine-grained control.</p><p>To access such services remotely, we could make them accessible using TCP sockets instead of UNIX sockets. However, this makes the service responsible for implementing authentication (identifying users) and encryption (ensuring the messages can’t be understood by a third party). Alternatively, we can use SSH port forwarding.</p><h2>SSH port forwarding</h2><p><a href="https://www.ssh.com/ssh/">Secure shell (SSH)</a> is a well-known, secure mechanism for running commands on a remote machine. SSH includes a mechanism for authenticating against the remote system, and it provides an encrypted channel for communication.</p><p>A (perhaps less known) feature of SSH is its ability to forward ports. Port forwarding means that a remote socket is made available locally. To do that, the <code>ssh</code> client program will open up a local socket and any connection made to that socket will be forwarded over the secure channel and delivered to the socket on the remote machine by the SSH server.</p><p>A port forward can be set up by passing the <code>-L</code> flag to the <code>ssh</code> client:</p><pre>-L [bind_address:]port:host:hostport
-L [bind_address:]port:remote_socket
-L local_socket:host:hostport
-L local_socket:remote_socket
</pre><p>As you can see, we need to specify the local end and the remote end. We can use UNIX sockets (identified by a file system path) or TCP sockets (identified as a <code>host:port</code>).</p><p>For example, to make the remote PostgreSQL server running on <code>mydbserver.org</code> available on the local machine at port <code>1234</code>, we can use the following command:</p><pre>ssh -L localhost:1234:/var/run/postgresql/.s.PGSQL.5432 mydbserver.org sleep 10
</pre><p>Our <code>-L</code> argument has <code>localhost:1234</code> for the local TCP end and the path <code>/var/run/postgresql/.s.PGSQL.5432</code> as the remote UNIX socket end. We are providing the <code>sleep 10</code> command to make the <code>ssh</code> command exit in case no TCP connections are forwarded in 10 seconds.</p><p>The <code>ssh</code> program is not only available on Linux, but it is also part of Windows 10. In the next section, we’ll wrap it with a .NET class to provide a cross-platform way to set up a port forward.</p><h2>Port forwarding from .NET</h2><p><a href="https://raw.githubusercontent.com/tmds/dotnet-linux-howto/master/PortForward/PortForward.cs">PortForward.cs</a> provides a simple <code>PortForward</code> class that wraps the <code>ssh</code> client to do port forwarding.</p><p>The following example shows how to use it in combination with the <a href="https://www.nuget.org/packages/Npgsql/">Npgsql package</a> to connect to a PostgreSQL server:</p><pre>using (var portForward = await PortForward.ForwardAsync("tmds@192.168.100.169:/var/run/postgresql/.s.PGSQL.5432"))
{
    var connectionString = $"Server={portForward.IPEndPoint.Address};Port={portForward.IPEndPoint.Port};Database=postgres;User ID=tmds";
    using (var connection = new NpgsqlConnection(connectionString))
    {
        connection.Open();
        Console.WriteLine($"PostgreSQL version: {connection.PostgreSqlVersion}");
    }
}
</pre><p>In this example, we are using the preconfigured private key of the user. You can also explicitly specify a key file using <code>PortForwardOptions.IdentityFile</code>:</p><pre>var portForward = await PortForward.ForwardAsync(..., o =&gt; o.IdentityFile = "mysecretkeyfile");
</pre><h2>Conclusion</h2><p>In this article, you’ve learned how SSH port forwarding allows you to access remote UNIX sockets. We’ve shown how you can set up port forwarding using the <code>ssh</code> client program and use that from a .NET application.</p><h3 class="jp-relatedposts-headline"><em>Related</em></h3></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>