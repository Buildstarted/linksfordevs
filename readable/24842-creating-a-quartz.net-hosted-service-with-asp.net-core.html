<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Creating a Quartz.NET hosted service with ASP.NET Core -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Creating a Quartz.NET hosted service with ASP.NET Core</h1><div><div class="post-content"><p>In this post I describe how to run Quartz.NET jobs using an <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-2.2">ASP.NET Core hosted service</a>. I show how to create a simple <code>IJob</code>, a custom <code>IJobFactory</code>, and a <code>QuartzHostedService</code> that runs jobs while your application is running. I'll also touch on some of the issues to aware of, namely of using scoped services inside singleton classes.</p><h2 id="introduction-what-is-quartz-net-" class="heading-with-anchor">Introduction - what is Quartz.NET?<a href="#introduction-what-is-quartz-net-"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>As per <a href="https://www.quartz-scheduler.net/">their website</a>:</p><blockquote><p>Quartz.NET is a full-featured, open source job scheduling system that can be used from smallest apps to large scale enterprise systems.</p></blockquote><p>It's an old staple of many ASP.NET developers, used as a way of running background tasks on a timer, in a reliable, clustered, way. Using Quartz.NET with ASP.NET Core is pretty similar - Quartz.NET supports .NET Standard 2.0, so you can easily use it in your applications.</p><p>Quartz.NET has two main concepts:</p><ul><li>A <strong>job</strong>. This is the background tasks that you want to run on some sort of schedule. </li><li>A <strong>scheduler</strong>. This is responsible for running jobs based on triggers, on a time-based schedule.</li></ul><p>ASP.NET Core has good support for running "background tasks" via way of <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services">hosted services</a>. Hosted services are started when your ASP.NET Core app starts, and run in the background for the lifetime of the application. By creating a Quartz.NET hosted service, you can use a standard ASP.NET Core application for running your tasks in the background.</p><blockquote><p>This sort of non-HTTP scenario is also possible with the "generic host", <a href="https://andrewlock.net/the-asp-net-core-generic-host-namespace-clashes-and-extension-methods/">but for various reasons</a> I generally don't use those at the moment. This should hopefully improve in ASP.NET Core 3.0 with the extra investment going into these non-HTTP scenarios.</p></blockquote><p>While it's possible to create <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-2.2#timed-background-tasks">a "timed" background service</a>, (that runs a tasks every 10 minutes, for example), Quartz.NET provides a far more robust solution. You can ensure tasks only run at specific times of the day (e.g. 2:30am), or only on specific days, or any combination by using a <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/crontriggers.html">Cron trigger</a>. It also allows you to run multiple instances of your application in a clustered fashion, so that only a single instance can run a given task at any one time.</p><p>In this post I'll show the basics of creating a Quartz.NET job and scheduling it to run on a timer in a hosted service.</p><h2 id="installing-quartz-net" class="heading-with-anchor">Installing Quartz.NET<a href="#installing-quartz-net"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Quartz.NET is a .NET Standard 2.0 NuGet package, so it should be easy to install in your application. For this test I created an ASP.NET Core project and chose the Empty template. You can install the Quartz.NET package using <code>dotnet add package Quartz</code>. If you view the <em>.csproj</em> for the project, it should look something like this:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span><span class="token attr-name">Sdk</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.NET.Sdk.Web<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFramework</span><span class="token punctuation">&gt;</span></span>netcoreapp2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFramework</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AspNetCoreHostingModel</span><span class="token punctuation">&gt;</span></span>InProcess<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AspNetCoreHostingModel</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.App<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Quartz<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.0.7<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Project</span><span class="token punctuation">&gt;</span></span></code></pre><h2 id="creating-an-ijob" class="heading-with-anchor">Creating an IJob<a href="#creating-an-ijob"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>For the actual background work we are scheduling, we're just going to use a "hello world" implementation that writes to an <code>ILogger&lt;&gt;</code> (and hence to the console). You should implement the Quartz interface <code>IJob</code> which contains a single asynchronous <code>Execute()</code> method. Note that we're using dependency injection here to inject the logger into the constructor.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Logging<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">;</span><span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token class-name">DisallowConcurrentExecution</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">HelloWorldJob</span><span class="token punctuation">:</span><span class="token class-name">IJob</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span> ILogger<span class="token operator">&lt;</span>HelloWorldJob<span class="token operator">&gt;</span> _logger<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">HelloWorldJob</span><span class="token punctuation">(</span>ILogger<span class="token operator">&lt;</span>HelloWorldJob<span class="token operator">&gt;</span> logger<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">Task</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>I also decorated the job with the <code>[DisallowConcurrentExecution]</code> attribute. This attribute <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/more-about-jobs.html#job-state-and-concurrency">prevents Quartz.NET from trying to run the same job concurrently</a>. </p><h2 id="creating-an-ijobfactory" class="heading-with-anchor">Creating an IJobFactory<a href="#creating-an-ijobfactory"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Next, we need to tell Quartz how it should create instances of <code>IJob</code>. By default, Quartz will try and "new-up" instances of the job using <code>Activator.CreateInstance</code>, effectively calling <code>new HelloWorldJob()</code>. Unfortunately, as we're using constructor injection, that won't work. Instead, we can provide a custom <code>IJobFactory</code> that hooks into the ASP.NET Core dependency injection container (<code>IServiceProvider</code>):</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">.</span>Spi<span class="token punctuation">;</span><span class="token keyword">using</span> System<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">SingletonJobFactory</span><span class="token punctuation">:</span><span class="token class-name">IJobFactory</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IServiceProvider</span> _serviceProvider<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">SingletonJobFactory</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _serviceProvider <span class="token operator">=</span> serviceProvider<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">IJob</span><span class="token function">NewJob</span><span class="token punctuation">(</span><span class="token class-name">TriggerFiredBundle</span> bundle<span class="token punctuation">,</span><span class="token class-name">IScheduler</span> scheduler<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> _serviceProvider<span class="token punctuation">.</span><span class="token function">GetRequiredService</span><span class="token punctuation">(</span>bundle<span class="token punctuation">.</span>JobDetail<span class="token punctuation">.</span>JobType<span class="token punctuation">)</span><span class="token keyword">as</span> IJob<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ReturnJob</span><span class="token punctuation">(</span><span class="token class-name">IJob</span> job<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>This factory takes an <code>IServiceProvider</code> in the constructor, and implements the <code>IJobFactory</code> interface. The important method is the <code>NewJob()</code> method, in which the factory has to return the <code>IJob</code> requested by the Quartz scheduler. In this implementation we delegate directly to the <code>IServiceProvider</code>, and let the DI container find the required instance. The cast to <code>IJob</code> at the end is required because the non-generic version of <code>GetRequiredService</code> returns an <code>object</code>.</p><p>The <code>ReturnJob</code> method is where the scheduler tries to return (i.e. destroy) a job that was created by the factory. Unfortunately, there's no mechanism for doing so with the built-in <code>IServiceProvider</code>. We can't create a new <code>IScopeService</code> that fits into the required Quartz API, so we're stuck only being able to create singleton jobs.</p><blockquote><p>This is important. With the above implementation, it is only safe to create <code>IJob</code> implementations that are <strong>Singletons</strong> (or transient).</p></blockquote><h2 id="configuring-the-job" class="heading-with-anchor">Configuring the Job<a href="#configuring-the-job"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>I'm only showing a single <code>IJob</code> implementation here, but we want the Quartz hosted service to be a generic implementation that works for any number of jobs. To help with that, we create a simple DTO called <code>JobSchedule</code> that we'll use to define the timer schedule for a given job type:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> System<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">JobSchedule</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token function">JobSchedule</span><span class="token punctuation">(</span><span class="token class-name">Type</span> jobType<span class="token punctuation">,</span><span class="token keyword">string</span> cronExpression<span class="token punctuation">)</span><span class="token punctuation">{</span>
        JobType <span class="token operator">=</span> jobType<span class="token punctuation">;</span>
        CronExpression <span class="token operator">=</span> cronExpression<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">Type</span> JobType <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">string</span> CronExpression <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The <code>JobType</code> is the .NET type of the job (<code>HelloWorldJob</code> for our example), and <code>CronExpression</code> is a <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/crontriggers.html">Quartz.NET Cron expression</a>. Cron expressions allow complex timer scheduling so you can set rules like "fire every half hour between the hours of 8 am and 10 am, on the 5th and 20th of every month". Just be sure to <a href="https://www.quartz-scheduler.net/documentation/quartz-3.x/tutorial/crontriggers.html">check the documentation</a> for examples as not all Cron expressions used by different systems are interchangeable.</p><p>We'll add the job to DI and configure its schedule in <code>Startup.ConfigureServices()</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Builder<span class="token punctuation">;</span><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Hosting<span class="token punctuation">;</span><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Http<span class="token punctuation">;</span><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">.</span>Impl<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">.</span>Spi<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">IJobFactory</span><span class="token punctuation">,</span><span class="token class-name">SingletonJobFactory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">ISchedulerFactory</span><span class="token punctuation">,</span><span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">HelloWorldJob</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token class-name">JobSchedule</span><span class="token punctuation">(</span>
        jobType<span class="token punctuation">:</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>HelloWorldJob<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cronExpression<span class="token punctuation">:</span><span class="token string">"0/5 * * * * ?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>This code adds four things as singletons to the DI container: </p><ul><li>The <code>SingletonJobFactory</code> shown earlier, used for creating the job instances.</li><li>An implementation of <code>ISchedulerFactory</code>, the built-in <code>StdSchedulerFactory</code>, which handles scheduling and managing jobs </li><li>The <code>HelloWorldJob</code> job itself</li><li>An instance of <code>JobSchedule</code> for the <code>HelloWorldJob</code> with a Cron expression to run every 5 seconds. </li></ul><p>There's only one piece missing now that brings them all together, the <code>QuartzHostedService</code>.</p><h2 id="creating-the-quartzhostedservice" class="heading-with-anchor">Creating the QuartzHostedService<a href="#creating-the-quartzhostedservice"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The <code>QuartzHostedService</code> is an implementation of <code>IHostedService</code> that sets up the Quartz scheduler, and starts it running in the background. Due to the design of Quartz, we can implement <code>IHostedService</code> directly, instead of the <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/multi-container-microservice-net-applications/background-tasks-with-ihostedservice">more common approach of deriving from the base <code>BackgroundService</code> class</a>. The full code for the service is listed below, and I'll discuss it afterwards.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> System<span class="token punctuation">;</span><span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span><span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span><span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Hosting<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">;</span><span class="token keyword">using</span> Quartz<span class="token punctuation">.</span>Spi<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">QuartzHostedService</span><span class="token punctuation">:</span><span class="token class-name">IHostedService</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">ISchedulerFactory</span> _schedulerFactory<span class="token punctuation">;</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IJobFactory</span> _jobFactory<span class="token punctuation">;</span><span class="token keyword">private</span><span class="token keyword">readonly</span> IEnumerable<span class="token operator">&lt;</span>JobSchedule<span class="token operator">&gt;</span> _jobSchedules<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">QuartzHostedService</span><span class="token punctuation">(</span><span class="token class-name">ISchedulerFactory</span> schedulerFactory<span class="token punctuation">,</span><span class="token class-name">IJobFactory</span> jobFactory<span class="token punctuation">,</span>
        IEnumerable<span class="token operator">&lt;</span>JobSchedule<span class="token operator">&gt;</span> jobSchedules<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _schedulerFactory <span class="token operator">=</span> schedulerFactory<span class="token punctuation">;</span>
        _jobSchedules <span class="token operator">=</span> jobSchedules<span class="token punctuation">;</span>
        _jobFactory <span class="token operator">=</span> jobFactory<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">IScheduler</span> Scheduler <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">async</span><span class="token class-name">Task</span><span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Scheduler <span class="token operator">=</span><span class="token keyword">await</span> _schedulerFactory<span class="token punctuation">.</span><span class="token function">GetScheduler</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Scheduler<span class="token punctuation">.</span>JobFactory <span class="token operator">=</span> _jobFactory<span class="token punctuation">;</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> jobSchedule <span class="token keyword">in</span> _jobSchedules<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> job <span class="token operator">=</span><span class="token function">CreateJob</span><span class="token punctuation">(</span>jobSchedule<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> trigger <span class="token operator">=</span><span class="token function">CreateTrigger</span><span class="token punctuation">(</span>jobSchedule<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> Scheduler<span class="token punctuation">.</span><span class="token function">ScheduleJob</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> trigger<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">await</span> Scheduler<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">async</span><span class="token class-name">Task</span><span class="token function">StopAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">await</span> Scheduler<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span><span class="token keyword">static</span><span class="token class-name">IJobDetail</span><span class="token function">CreateJob</span><span class="token punctuation">(</span><span class="token class-name">JobSchedule</span> schedule<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> jobType <span class="token operator">=</span> schedule<span class="token punctuation">.</span>JobType<span class="token punctuation">;</span><span class="token keyword">return</span> JobBuilder
            <span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>jobType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span>jobType<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithDescription</span><span class="token punctuation">(</span>jobType<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span><span class="token keyword">static</span><span class="token class-name">ITrigger</span><span class="token function">CreateTrigger</span><span class="token punctuation">(</span><span class="token class-name">JobSchedule</span> schedule<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> TriggerBuilder
            <span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span>$<span class="token string">"{schedule.JobType.FullName}.trigger"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCronSchedule</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span>CronExpression<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithDescription</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span>CronExpression<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The <code>QuartzHostedService</code> has three dependencies: the <code>ISchedulerFactory</code> and <code>IJobFactory</code> we configured in <code>Startup</code>, and an <code>IEnumerable&lt;JobSchedule&gt;</code>. We only added a single <code>JobSchedule</code> to the DI container (for the <code>HelloWorldJob</code>), but if you register more job schedules with the DI container they'll all be injected here.</p><p><code>StartAsync</code> is called when the application starts up and is where we configure Quartz. We start by creating an instance of <code>IScheduler</code>, assigning it to a property for use later, and setting the <code>JobFactory</code> for the scheduler to the injected instance:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">async</span><span class="token class-name">Task</span><span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span>
    Scheduler <span class="token operator">=</span><span class="token keyword">await</span> _schedulerFactory<span class="token punctuation">.</span><span class="token function">GetScheduler</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Scheduler<span class="token punctuation">.</span>JobFactory <span class="token operator">=</span> _jobFactory<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>Next, we loop through the injected job schedules, and create a Quartz <code>IJobDetail</code> and <code>ITrigger</code> for each one using the <code>CreateJob</code> and <code>CreateTrigger</code> helper methods at the end of the class. If you don't like how this part works, or need more control over the configuration, you can easily customise it by extending the <code>JobSchedule</code> DTO as you see fit.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">async</span><span class="token class-name">Task</span><span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> jobSchedule <span class="token keyword">in</span> _jobSchedules<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> job <span class="token operator">=</span><span class="token function">CreateJob</span><span class="token punctuation">(</span>jobSchedule<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> trigger <span class="token operator">=</span><span class="token function">CreateTrigger</span><span class="token punctuation">(</span>jobSchedule<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> Scheduler<span class="token punctuation">.</span><span class="token function">ScheduleJob</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> trigger<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">private</span><span class="token keyword">static</span><span class="token class-name">IJobDetail</span><span class="token function">CreateJob</span><span class="token punctuation">(</span><span class="token class-name">JobSchedule</span> schedule<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> jobType <span class="token operator">=</span> schedule<span class="token punctuation">.</span>JobType<span class="token punctuation">;</span><span class="token keyword">return</span> JobBuilder
        <span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>jobType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span>jobType<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithDescription</span><span class="token punctuation">(</span>jobType<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span><span class="token keyword">static</span><span class="token class-name">ITrigger</span><span class="token function">CreateTrigger</span><span class="token punctuation">(</span><span class="token class-name">JobSchedule</span> schedule<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> TriggerBuilder
        <span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span>$<span class="token string">"{schedule.JobType.FullName}.trigger"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCronSchedule</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span>CronExpression<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithDescription</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span>CronExpression<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>Finally, once all the jobs are scheduled, you call <code>Scheduler.Start()</code> to actually start the Quartz.NET scheduler processing in the background. When the app shuts down, the framework will call <code>StopAsync()</code>, at which point you can call <code>Scheduler.Stop()</code> to safely shut down the scheduler process.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">async</span><span class="token class-name">Task</span><span class="token function">StopAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">await</span> Scheduler<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>You can register the hosted service using the <code>AddHostedService()</code> extension method in <code>Startup.ConfigureServices</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHostedService</span><span class="token punctuation">&lt;</span><span class="token class-name">QuartzHostedService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>If you run the application, you should see the background task running every 5 seconds and writing to the Console (or wherever you have logging configured)</p><p><img src="/content/images/2019/quartz_service.png" alt="Background service writing Hello World to console repeatedly"></p><h2 id="using-scoped-services-in-jobs" class="heading-with-anchor">Using scoped services in jobs<a href="#using-scoped-services-in-jobs"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>There's one big problem with the implementation as described in this post: you can only create Singleton or Transient jobs. That means you can't use any dependencies that are registered as Scoped services. For example, you can't inject an EF Core <code>DatabaseContext</code> into your <code>IJob</code> implementation, as you'll have a <a href="http://blog.ploeh.dk/2014/06/02/captive-dependency/">captive dependency</a> problem. </p><p>Working around this isn't a big issue: you can inject an <code>IServiceProvider</code> and create your own scope, <a href="/the-dangers-and-gotchas-of-using-scoped-services-when-configuring-options-in-asp-net-core/#3-creating-a-new-scope-in-iconfigureoptions">similar to the solution for a similar problem in a previous post</a>. For example, if you need to use a scoped service in your <code>HelloWorldJob</code>, you could use something like the following:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">HelloWorldJob</span><span class="token punctuation">:</span><span class="token class-name">IJob</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IServiceProvider</span> _provider<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">HelloWorldJob</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> provider<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _provider <span class="token operator">=</span> provider<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">Task</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> _provider<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> service <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token punctuation">&lt;</span><span class="token class-name">IScopedService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>This ensures a new scope is created every time the job runs, so you can retrieve (and dispose) scoped services inside the <code>IJob</code>. Unfortunately things do get a little messy. In the next post I'll show a variation on this approach that is a little cleaner.</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>In this post I introduced Quartz.NET and showed how you could use it to schedule background jobs to run in ASP.NET Core using <code>IHostedService</code>. The example shown in this post is best for singleton or transient jobs, which isn't ideal, as consuming scoped services is clumsy. In the next post, I'll show a variation on this approach that makes using scoped services easier.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>