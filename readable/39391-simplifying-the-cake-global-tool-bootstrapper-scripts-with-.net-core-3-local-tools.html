<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Simplifying the Cake global tool bootstrapper scripts with .NET Core 3 local tools -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Simplifying the Cake global tool bootstrapper scripts with .NET Core 3 local tools</h1><div><div class="post-content"><p>In this post I show how you can simplify your Cake global tool bootstrapper scripts by taking <a href="/new-in-net-core-3-local-tools/">advantage of local tools, introduced in .NET Core 3.0</a>. </p><p>I described the new local tools feature (introduced in .NET Core 3.0) in <a href="/new-in-net-core-3-local-tools/">a recent post</a>. I'm not going to recap the details of local tools here, so if you haven't already, I strongly recommend reading that post. In this post, I'm going to take the scripts I've been using to bootstrap and run Cake <a href="/a-bootstrapper-script-for-the-cake-net-core-global-tool-on-windows/">on Windows using PowerShell</a> and Linux using <a href="/how-to-build-with-cake-on-linux-using-cake-coreclr-or-the-cake-global-tool/">bash</a> or <a href="/a-bootstrapper-script-for-the-cake-net-core-global-tool-on-alpine-using-ash/">sh</a>, and simplify them by taking advantage of the .NET Core local tools.</p><h2 id="prerequisites" class="heading-with-anchor">Prerequisites<a href="#prerequisites"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>For the scripts shown in this post, I make a few assumptions:</p><ul><li>Your build environment already has the .NET Core 3.0 SDK installed.</li><li>You have created a <em>dotnet-tools.json</em> manifest in the default location for your repository (<a href="/new-in-net-core-3-local-tools/">as described in my previous post</a>).</li><li>You have specified version <code>0.35.0</code>(or higher) of the <code>Cake.Tool</code> global tool in the tool manifest. This version is compatible with .NET Core 3.0.</li></ul><p>If you need to install the .NET Core SDK as well, then I suggest either using one of <a href="https://github.com/cake-build/cake/blob/06e7983704/build.sh">the more comprehensive Cake bootstrapper scripts</a>, or <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-install-script">the official dotnet-install scripts</a>.</p><p>You can create a <em>dotnet-tools.json</em> manifest in your project and add the latest version of the Cake tool by running the following from your project's root folder:</p><pre class="language-bash"><code class="language-bash">dotnet new tool-manifest
dotnet tool <span class="token function">install</span> Cake.Tool
</code></pre><p>The <em>dotnet-tools.json</em> manifest should be checked-in to your source code repository.</p><p>I always like to have a <em>build.ps1</em> or <em>build.sh</em> script in a project's root directory, to make it easy to run a full build, whether on a CI machine or locally. With the introduction of local tools to .NET Core 3.0 these scripts have become even simpler:</p><pre class="language-powershell"><code class="language-powershell"><span class="token namespace">[CmdletBinding()]</span><span class="token keyword">Param</span><span class="token punctuation">(</span><span class="token namespace">[string]</span><span class="token variable">$Script</span> = <span class="token string">"build.cake"</span><span class="token punctuation">,</span><span class="token namespace">[string]</span><span class="token variable">$Target</span><span class="token punctuation">,</span><span class="token namespace">[Parameter(Position=0,Mandatory=$false,ValueFromRemainingArguments=$true)]</span><span class="token namespace">[string[]]</span><span class="token variable">$ScriptArgs</span><span class="token punctuation">)</span>
&amp; dotnet tool restore

<span class="token variable">$cakeArguments</span> = @<span class="token punctuation">(</span><span class="token string">"<span class="token variable">$Script</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$Target</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$cakeArguments</span><span class="token operator">+=</span><span class="token string">"--target=<span class="token variable">$Target</span>"</span><span class="token punctuation">}</span><span class="token variable">$cakeArguments</span><span class="token operator">+=</span><span class="token variable">$ScriptArgs</span>

&amp; dotnet tool run dotnet<span class="token operator">-</span>cake <span class="token operator">--</span><span class="token variable">$cakeArguments</span><span class="token keyword">exit</span><span class="token variable">$LASTEXITCODE</span></code></pre><p>This script essentially only does four things:</p><ul><li>Define the arguments for the script, to make it easy to specify a Cake script file or a custom target.</li><li>Restore the local tools using the <em>dotnet-tools.json</em> manifest, by running <code>dotnet tool restore</code>.</li><li>Parse the arguments provided to the script into the format required by the Cake global tool</li><li>Execute the Cake global tool by running <code>dotnet tool run dotnet-cake</code> and passing in the arguments parsed in the previous step</li></ul><p>In <a href="/a-bootstrapper-script-for-the-cake-net-core-global-tool-on-windows/">the previous version</a> of the script (for pre-.NET Core 3.0), I installed <em>global</em> tools "locally", which means you have to faff around making sure you have the correct version installed (as you can only "globally" install a single version of a tool). With local tools you can have multiple versions of a tool available, so that all goes away!</p><p>To run the script, run <code>.\build.ps1</code>, or pass in a target to run:</p><pre class="language-powershell"><code class="language-powershell">&gt; <span class="token punctuation">.</span>\build<span class="token punctuation">.</span>ps1 <span class="token operator">-</span>Target=Clean
Tool <span class="token string">'cake.tool'</span><span class="token punctuation">(</span>version <span class="token string">'0.35.0'</span><span class="token punctuation">)</span> was restored<span class="token punctuation">.</span> Available commands: dotnet<span class="token operator">-</span>cake

Restore was successful<span class="token punctuation">.</span>
Running Target: Clean
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>Obviously the bootstrapper script isn't something you're going to have to look at very often, so some complexity in there isn't a big issue. But then again, the less code you have to look after the better!</p><blockquote><p>The script is arguably so simple now, that it's pretty much unnecessary. I would still include it though, as it makes it obvious to consumers of your project how to run the build.</p></blockquote><p>Next in line for trimming is the bash bootstrapper script. <a href="/how-to-build-with-cake-on-linux-using-cake-coreclr-or-the-cake-global-tool/#building-on-linux-with-the-cake-global-tool">Previously</a> we had to make sure we installed the correct version of the Cake global tool, and had to work out the required directories etc. With local tools, that all goes away: </p><pre class="language-bash"><code class="language-bash">
SCRIPT<span class="token operator">=</span><span class="token string">"build.cake"</span>
CAKE_ARGUMENTS<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span><span class="token string">"<span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="547014">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token keyword">case</span><span class="token variable">$1</span><span class="token keyword">in</span>
        -s<span class="token operator">|</span>--script<span class="token punctuation">)</span> SCRIPT<span class="token operator">=</span><span class="token string">"<span class="token variable">$2</span>"</span><span class="token punctuation">;</span><span class="token function">shift</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        --<span class="token punctuation">)</span><span class="token function">shift</span><span class="token punctuation">;</span> CAKE_ARGUMENTS+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"<span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="85a1c5">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        *<span class="token punctuation">)</span> CAKE_ARGUMENTS+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"<span class="token variable">$1</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    esac
    <span class="token function">shift</span><span class="token keyword">done</span>
dotnet tool restore

<span class="token keyword">if</span><span class="token punctuation">[</span><span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span><span class="token keyword">echo</span><span class="token string">"An error occured while installing Cake."</span><span class="token keyword">exit</span> 1
<span class="token keyword">fi</span>
dotnet tool run dotnet-cake <span class="token string">"<span class="token variable">$SCRIPT</span>"</span><span class="token string">"<span class="token variable">${CAKE_ARGUMENTS[@]}</span>"</span></code></pre><p>This bash script is only doing three steps:</p><ul><li>Parse arguments</li><li>Restore the .NET Core local tools</li><li>Run the restored Cake global tool</li></ul><p>This script will work for environments where you have bash available, such as on Debian or Ubuntu distributions. If you're building on the tiny Alpine distribution, you'll need to use the script from the next section instead.</p><p>Alpine uses the <a href="https://en.wikipedia.org/wiki/Almquist_shell">Almquist (ash) shell</a> instead of bash, so you can't use "bash-isms" like arrays. The script below is a slight modification of the previous script which uses string concatenation in place of arrays:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
SCRIPT<span class="token operator">=</span><span class="token string">"build.cake"</span>
CAKE_ARGUMENTS<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">for</span> i <span class="token keyword">in</span><span class="token string">"<span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="486c08">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token keyword">case</span><span class="token variable">$1</span><span class="token keyword">in</span>
        -s<span class="token operator">|</span>--script<span class="token punctuation">)</span> SCRIPT<span class="token operator">=</span><span class="token string">"<span class="token variable">$2</span>"</span><span class="token punctuation">;</span><span class="token function">shift</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        --<span class="token punctuation">)</span><span class="token function">shift</span><span class="token punctuation">;</span> CAKE_ARGUMENTS<span class="token operator">=</span><span class="token string">"<span class="token variable">${CAKE_ARGUMENTS}</span><span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dafe9a">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        *<span class="token punctuation">)</span> CAKE_ARGUMENTS<span class="token operator">=</span><span class="token string">"<span class="token variable">${CAKE_ARGUMENTS}</span><span class="token variable">$1</span>"</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    esac
    <span class="token function">shift</span><span class="token keyword">done</span><span class="token keyword">set</span> -- <span class="token variable">${CAKE_ARGUMENTS}</span>
dotnet tool restore

<span class="token keyword">if</span><span class="token punctuation">[</span><span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span><span class="token keyword">echo</span><span class="token string">"An error occured while installing Cake."</span><span class="token keyword">exit</span> 1
<span class="token keyword">fi</span>

dotnet tool run dotnet-cake  <span class="token string">"--"</span><span class="token string">"<span class="token variable">$SCRIPT</span>"</span><span class="token string">"<span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="af8bef">[email&nbsp;protected]</a></span>"</span></code></pre><p>This version also addresses <a href="/a-bootstrapper-script-for-the-cake-net-core-global-tool-on-alpine-using-ash/#executing-cake-using-the-provided-arguments">the use of <code>eval</code> from my previous version of the script</a>. That's not related to local tools, I just finally came across <a href="https://unix.stackexchange.com/a/444949">this StackExchange answer</a> that showed how to use <code>set --</code> to replace the <code>"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d0f490">[email&nbsp;protected]</a>"</code> pseudo-array. That makes me much happier!</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>This post showed how you can use the .NET Core 3 global tools feature to simplify your Cake bootstrapper scripts. With a simple JSON file and two .NET Core CLI commands, you can restore and run any .NET Core global tools you need. If you need to install additional tools for your build, you could include them in your manifest file too, or <a href="https://twitter.com/devlead/status/1182262717740126208">let Cake manage that for you as described here</a>.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>