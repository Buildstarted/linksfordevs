<!DOCTYPE html>
<html lang="en">
<head>
    <title>
prometheus-net/prometheus-net: .NET Standard library to instrument apps for the Prometheus metrics and monitoring system -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>prometheus-net/prometheus-net: .NET Standard library to instrument apps for the Prometheus metrics and monitoring system</h1><div><div id="" class="markdown-body entry-content p-5"><h1><a id="user-content-prometheus-net" class="anchor" aria-hidden="true" href="#prometheus-net"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>prometheus-net</h1><p>This is a .NET library for instrumenting your applications and exporting metrics to <a href="http://prometheus.io/" rel="nofollow">Prometheus</a>.</p><p><a href="https://dev.azure.com/prometheus-net/prometheus-net/_build/latest?definitionId=1" rel="nofollow"><img src="https://camo.githubusercontent.com/36dd1fa0f22513c593a4113325d6fa3314bc437f/68747470733a2f2f6465762e617a7572652e636f6d2f70726f6d6574686575732d6e65742f70726f6d6574686575732d6e65742f5f617069732f6275696c642f7374617475732f70726f6d6574686575732d6e6574" alt="Build status" data-canonical-src="https://dev.azure.com/prometheus-net/prometheus-net/_apis/build/status/prometheus-net"></a><a href="https://www.nuget.org/packages/prometheus-net/" rel="nofollow"><img src="https://camo.githubusercontent.com/183a469fbc3af555f528245baa75acfe53cd4f0e/68747470733a2f2f696d672e736869656c64732e696f2f6e756765742f762f70726f6d6574686575732d6e65742e737667" alt="Nuget" data-canonical-src="https://img.shields.io/nuget/v/prometheus-net.svg"></a><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/198063f6192e22e07ac7ec73f6a598f31082768c/68747470733a2f2f696d672e736869656c64732e696f2f6e756765742f64742f70726f6d6574686575732d6e65742e737667"><img src="https://camo.githubusercontent.com/198063f6192e22e07ac7ec73f6a598f31082768c/68747470733a2f2f696d672e736869656c64732e696f2f6e756765742f64742f70726f6d6574686575732d6e65742e737667" alt="Nuget" data-canonical-src="https://img.shields.io/nuget/dt/prometheus-net.svg"></a></p><p><a target="_blank" rel="noopener noreferrer" href="/prometheus-net/prometheus-net/blob/master/Screenshot.png"><img src="/prometheus-net/prometheus-net/raw/master/Screenshot.png" alt=""></a></p><p>The library targets <a href="https://docs.microsoft.com/en-us/dotnet/standard/net-standard" rel="nofollow">.NET Standard 2.0</a> which supports the following runtimes (and newer):</p><ul><li>.NET Framework 4.6.1</li><li>.NET Core 2.0</li><li>Mono 5.4</li></ul><p>The ASP.NET Core specific functionality requires ASP.NET Core 2.1 or newer. The .NET Core specific functionality requires .NET Core 2.1 or newer.</p><p>Related projects:</p><h1><a id="user-content-table-of-contents" class="anchor" aria-hidden="true" href="#table-of-contents"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Table of contents</h1><h1><a id="user-content-best-practices-and-usage" class="anchor" aria-hidden="true" href="#best-practices-and-usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Best practices and usage</h1><p>This library allows you to instrument your code with custom metrics and provides some built-in metric collection integrations for ASP.NET Core.</p><p>The documentation here is only a minimal quick start. For detailed guidance on using Prometheus in your solutions, refer to the <a href="https://groups.google.com/forum/#!forum/prometheus-users" rel="nofollow">prometheus-users discussion group</a>. You are also expected to be familiar with the <a href="https://prometheus.io/docs/introduction/overview/" rel="nofollow">Prometheus user guide</a>.</p><p>Four types of metrics are available: Counter, Gauge, Summary and Histogram. See the documentation on <a href="http://prometheus.io/docs/concepts/metric_types/" rel="nofollow">metric types</a> and <a href="http://prometheus.io/docs/practices/instrumentation/#counter-vs.-gauge-vs.-summary" rel="nofollow">instrumentation best practices</a> to learn what each is good for.</p><p><strong>The <code>Metrics</code> class is the main entry point to the API of this library.</strong> The most common practice in C# code is to have a <code>static readonly</code> field for each metric that you wish to export from a given class.</p><p>More complex patterns may also be used (e.g. combining with dependency injection). The library is quite tolerant of different usage models - if the API allows it, it will generally work fine and provide satisfactory performance. The library is thread-safe.</p><h1><a id="user-content-installation" class="anchor" aria-hidden="true" href="#installation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installation</h1><p>Nuget package for general use and metrics export via HttpListener or to Pushgateway: <a href="https://www.nuget.org/packages/prometheus-net" rel="nofollow">prometheus-net</a></p><blockquote><p>Install-Package prometheus-net</p></blockquote><p>Nuget package for ASP.NET Core middleware and stand-alone Kestrel metrics server: <a href="https://www.nuget.org/packages/prometheus-net.AspNetCore" rel="nofollow">prometheus-net.AspNetCore</a></p><blockquote><p>Install-Package prometheus-net.AspNetCore</p></blockquote><p>Nuget package for ASP.NET Web API middleware on .NET Framework: <a href="https://www.nuget.org/packages/prometheus-net.NetFramework.AspNet" rel="nofollow">prometheus-net.NetFramework.AspNet</a></p><blockquote><p>Install-Package prometheus-net.NetFramework.AspNet</p></blockquote><h1><a id="user-content-quick-start" class="anchor" aria-hidden="true" href="#quick-start"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Quick start</h1><p>After installing the library, you should:</p><ol><li>Initialize some metrics and start updating their values.</li><li>Publish the collected metrics over HTTP.</li><li>Configure the Prometheus server to poll your app for metrics on regular intervals.</li></ol><p>The chapters below describe the various ways you can initialize or update metrics and the ways in which they can be published.</p><p>The following is a minimal implementation that simply increments a counter once a second, publishing the metrics on <a href="http://localhost:1234/metrics" rel="nofollow">http://localhost:1234/metrics</a></p><div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span><span class="pl-en">Prometheus</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Threading</span>;

<span class="pl-k">class</span><span class="pl-en">Program</span>
{
    <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Counter</span><span class="pl-smi">TickTock</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>.<span class="pl-en">CreateCounter</span>(<span class="pl-s"><span class="pl-pds">"</span>sampleapp_ticks_total<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Just keeps on ticking<span class="pl-pds">"</span></span>);

    <span class="pl-k">static</span><span class="pl-k">void</span><span class="pl-en">Main</span>()
    {
        <span class="pl-k">var</span><span class="pl-smi">server</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">MetricServer</span>(<span class="pl-smi">hostname</span>: <span class="pl-s"><span class="pl-pds">"</span>localhost<span class="pl-pds">"</span></span>, <span class="pl-smi">port</span>: <span class="pl-c1">1234</span>);
        <span class="pl-smi">server</span>.<span class="pl-en">Start</span>();

        <span class="pl-k">while</span> (<span class="pl-c1">true</span>)
        {
            <span class="pl-smi">TickTock</span>.<span class="pl-en">Inc</span>();
            <span class="pl-smi">Thread</span>.<span class="pl-en">Sleep</span>(<span class="pl-smi">TimeSpan</span>.<span class="pl-en">FromSeconds</span>(<span class="pl-c1">1</span>));
        }
    }
}</pre></div><h1><a id="user-content-counters" class="anchor" aria-hidden="true" href="#counters"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Counters</h1><p>Counters only increase in value and reset to zero when the process restarts.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Counter</span><span class="pl-smi">ProcessedJobCount</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateCounter</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_jobs_processed_total<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Number of processed jobs.<span class="pl-pds">"</span></span>);

...

<span class="pl-en">ProcessJob</span>();
<span class="pl-smi">ProcessedJobCount</span>.<span class="pl-en">Inc</span>();</pre></div><h1><a id="user-content-gauges" class="anchor" aria-hidden="true" href="#gauges"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Gauges</h1><p>Gauges can have any numeric value and change arbitrarily.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Gauge</span><span class="pl-smi">JobsInQueue</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateGauge</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_jobs_queued<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Number of jobs waiting for processing in the queue.<span class="pl-pds">"</span></span>);

...

<span class="pl-smi">jobQueue</span>.<span class="pl-en">Enqueue</span>(<span class="pl-smi">job</span>);
<span class="pl-smi">JobsInQueue</span>.<span class="pl-en">Inc</span>();

...

<span class="pl-k">var</span><span class="pl-smi">job</span><span class="pl-k">=</span><span class="pl-smi">jobQueue</span>.<span class="pl-en">Dequeue</span>();
<span class="pl-smi">JobsInQueue</span>.<span class="pl-en">Dec</span>();</pre></div><h1><a id="user-content-summary" class="anchor" aria-hidden="true" href="#summary"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Summary</h1><p>Summaries track the trends in events over time (10 minutes by default).</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Summary</span><span class="pl-smi">RequestSizeSummary</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateSummary</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_request_size_bytes<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Summary of request sizes (in bytes) over last 10 minutes.<span class="pl-pds">"</span></span>);

...

<span class="pl-smi">RequestSizeSummary</span>.<span class="pl-en">Observe</span>(<span class="pl-smi">request</span>.<span class="pl-smi">Length</span>);</pre></div><p>By default, only the sum and total count are reported. You may also specify quantiles to measure:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Summary</span><span class="pl-smi">RequestSizeSummary</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateSummary</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_request_size_bytes<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Summary of request sizes (in bytes) over last 10 minutes.<span class="pl-pds">"</span></span>,
        <span class="pl-k">new</span><span class="pl-en">SummaryConfiguration</span>
        {
            <span class="pl-smi">Objectives</span><span class="pl-k">=</span><span class="pl-k">new</span>[]
            {
                <span class="pl-k">new</span><span class="pl-en">QuantileEpsilonPair</span>(<span class="pl-c1">0.5</span>, <span class="pl-c1">0.05</span>),
                <span class="pl-k">new</span><span class="pl-en">QuantileEpsilonPair</span>(<span class="pl-c1">0.9</span>, <span class="pl-c1">0.05</span>),
                <span class="pl-k">new</span><span class="pl-en">QuantileEpsilonPair</span>(<span class="pl-c1">0.95</span>, <span class="pl-c1">0.01</span>),
                <span class="pl-k">new</span><span class="pl-en">QuantileEpsilonPair</span>(<span class="pl-c1">0.99</span>, <span class="pl-c1">0.005</span>),
            }
        });</pre></div><p>The epsilon indicates the absolute error allowed in measurements. For more information, refer to the <a href="https://prometheus.io/docs/practices/histograms/" rel="nofollow">Prometheus documentation on summaries and histograms</a>.</p><h1><a id="user-content-histogram" class="anchor" aria-hidden="true" href="#histogram"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Histogram</h1><p>Histograms track the size and number of events in buckets. This allows for aggregatable calculation of quantiles.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Histogram</span><span class="pl-smi">OrderValueHistogram</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateHistogram</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_order_value_usd<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Histogram of received order values (in USD).<span class="pl-pds">"</span></span>,
        <span class="pl-k">new</span><span class="pl-en">HistogramConfiguration</span>
        {
            <span class="pl-c"><span class="pl-c">//</span> We divide measurements in 10 buckets of $100 each, up to $1000.</span><span class="pl-smi">Buckets</span><span class="pl-k">=</span><span class="pl-smi">Histogram</span>.<span class="pl-en">LinearBuckets</span>(<span class="pl-smi">start</span>: <span class="pl-c1">100</span>, <span class="pl-smi">width</span>: <span class="pl-c1">100</span>, <span class="pl-smi">count</span>: <span class="pl-c1">10</span>)
        });

...

<span class="pl-smi">OrderValueHistogram</span>.<span class="pl-en">Observe</span>(<span class="pl-smi">order</span>.<span class="pl-smi">TotalValueUsd</span>);</pre></div><h1><a id="user-content-measuring-operation-duration" class="anchor" aria-hidden="true" href="#measuring-operation-duration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Measuring operation duration</h1><p>Timers can be used to report the duration of an operation (in seconds) to a Summary, Histogram, Gauge or Counter. Wrap the operation you want to measure in a using block.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Histogram</span><span class="pl-smi">LoginDuration</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateHistogram</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_login_duration_seconds<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Histogram of login call processing durations.<span class="pl-pds">"</span></span>);

...

<span class="pl-k">using</span> (<span class="pl-en">LoginDuration</span>.<span class="pl-en">NewTimer</span>())
{
    <span class="pl-en">IdentityManager</span>.<span class="pl-en">AuthenticateUser</span>(<span class="pl-en">Request</span>.<span class="pl-en">Credentials</span>);
}</pre></div><h1><a id="user-content-tracking-in-progress-operations" class="anchor" aria-hidden="true" href="#tracking-in-progress-operations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tracking in-progress operations</h1><p>You can use <code>Gauge.TrackInProgress()</code> to track how many concurrent operations are taking place. Wrap the operation you want to track in a using block.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Gauge</span><span class="pl-smi">DocumentImportsInProgress</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateGauge</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_document_imports_in_progress<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Number of import operations ongoing.<span class="pl-pds">"</span></span>);

...

<span class="pl-k">using</span> (<span class="pl-en">DocumentImportsInProgress</span>.<span class="pl-en">TrackInProgress</span>())
{
    <span class="pl-en">DocumentRepository</span>.<span class="pl-en">ImportDocument</span>(<span class="pl-en">path</span>);
}</pre></div><h1><a id="user-content-counting-exceptions" class="anchor" aria-hidden="true" href="#counting-exceptions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Counting exceptions</h1><p>You can use <code>Counter.CountExceptions()</code> to count the number of exceptions that occur while executing some code.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Counter</span><span class="pl-smi">FailedDocumentImports</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateCounter</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_document_imports_failed_total<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Number of import operations that failed.<span class="pl-pds">"</span></span>);

...

<span class="pl-smi">FailedDocumentImports</span>.<span class="pl-en">CountExceptions</span>(() <span class="pl-k">=&gt;</span><span class="pl-smi">DocumentRepository</span>.<span class="pl-en">ImportDocument</span>(<span class="pl-smi">path</span>));</pre></div><p>You can also filter the exception types to observe:</p><div class="highlight highlight-source-cs"><pre><span class="pl-smi">FailedDocumentImports</span>.<span class="pl-en">CountExceptions</span>(() <span class="pl-k">=&gt;</span><span class="pl-smi">DocumentRepository</span>.<span class="pl-en">ImportDocument</span>(<span class="pl-smi">path</span>), <span class="pl-smi">IsImportRelatedException</span>);

<span class="pl-k">bool</span><span class="pl-en">IsImportRelatedException</span>(<span class="pl-en">Exception</span><span class="pl-smi">ex</span>)
{
    <span class="pl-c"><span class="pl-c">//</span> Do not count "access denied" exceptions - those are user error for pointing us to a forbidden file.</span><span class="pl-k">if</span> (<span class="pl-smi">ex</span><span class="pl-k">is</span><span class="pl-en">UnauthorizedAccessException</span>)
        <span class="pl-k">return</span><span class="pl-c1">false</span>;

    <span class="pl-k">return</span><span class="pl-c1">true</span>;
}</pre></div><h1><a id="user-content-labels" class="anchor" aria-hidden="true" href="#labels"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Labels</h1><p>All metrics can have labels, allowing grouping of related time series.</p><p>See the best practices on <a href="http://prometheus.io/docs/practices/naming/" rel="nofollow">naming</a>
and <a href="http://prometheus.io/docs/practices/instrumentation/#use-labels" rel="nofollow">labels</a>.</p><p>Taking a counter as an example:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Counter</span><span class="pl-smi">RequestCountByMethod</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateCounter</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_requests_total<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Number of requests received, by HTTP method.<span class="pl-pds">"</span></span>,
        <span class="pl-k">new</span><span class="pl-en">CounterConfiguration</span>
        {
            <span class="pl-c"><span class="pl-c">//</span> Here you specify only the names of the labels.</span><span class="pl-smi">LabelNames</span><span class="pl-k">=</span><span class="pl-k">new</span>[] { <span class="pl-s"><span class="pl-pds">"</span>method<span class="pl-pds">"</span></span> }
        });

...

<span class="pl-c"><span class="pl-c">//</span> You can specify the values for the labels later, once you know the right values (e.g in your request handler code).</span><span class="pl-smi">counter</span>.<span class="pl-en">WithLabels</span>(<span class="pl-s"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>).<span class="pl-en">Inc</span>();</pre></div><p>NB! Best practices of metric design is to <strong>minimize the number of different label values</strong>. For example:</p><ul><li>HTTP request method is a good choice for labeling - there are not many values.</li><li>URL is a bad choice for labeling - it has many possible values and would lead to significant data processing inefficiency.</li></ul><h1><a id="user-content-when-are-metrics-published" class="anchor" aria-hidden="true" href="#when-are-metrics-published"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>When are metrics published?</h1><p>Metrics without labels are published immediately after the <code>Metrics.CreateX()</code> call. Metrics that use labels are published when you provide the label values for the first time.</p><p>Sometimes you want to delay publishing a metric until you have loaded some data and have a meaningful value to supply for it. The API allows you to suppress publishing of the initial value until you decide the time is right.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">Gauge</span><span class="pl-smi">UsersLoggedIn</span><span class="pl-k">=</span><span class="pl-smi">Metrics</span>
    .<span class="pl-en">CreateGauge</span>(<span class="pl-s"><span class="pl-pds">"</span>myapp_users_logged_in<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Number of active user sessions<span class="pl-pds">"</span></span>,
        <span class="pl-k">new</span><span class="pl-en">GaugeConfiguration</span>
        {
            <span class="pl-smi">SuppressInitialValue</span><span class="pl-k">=</span><span class="pl-c1">true</span>
        });

...

<span class="pl-c"><span class="pl-c">//</span> After setting the value for the first time, the metric becomes published.</span><span class="pl-smi">UsersLoggedIn</span>.<span class="pl-en">Set</span>(<span class="pl-en">LoadSessions</span>().<span class="pl-smi">Count</span>);</pre></div><p>You can also use <code>.Publish()</code> on a metric to mark it as ready to be published without modifying the initial value (e.g. to publish a zero).</p><h1><a id="user-content-aspnet-core-exporter-middleware" class="anchor" aria-hidden="true" href="#aspnet-core-exporter-middleware"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ASP.NET Core exporter middleware</h1><p>For projects built with ASP.NET Core, a middleware plugin is provided.</p><p>If you use the default Visual Studio project template, modify <code>Startup.cs</code> as follows:</p><ul><li>ASP.NET Core 3 or newer
<ul><li>Add <code>endpoints.MapMetrics()</code> to the endpoint configuration under <code>app.UseEndpoints</code>.</li></ul></li><li>ASP.NET Core 2
<ul><li>Add <code>app.UseMetricServer()</code> to the top of the <code>Configure</code> method.</li></ul></li></ul><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Configure</span>(<span class="pl-en">IApplicationBuilder</span><span class="pl-smi">app</span>, ...)
{
    <span class="pl-c"><span class="pl-c">//</span> ASP.NET Core 2</span><span class="pl-smi">app</span>.<span class="pl-en">UseMetricServer</span>();

    <span class="pl-c"><span class="pl-c">//</span> ...</span><span class="pl-c"><span class="pl-c">//</span> ASP.NET Core 3 or newer</span><span class="pl-smi">app</span>.<span class="pl-en">UseEndpoints</span>(<span class="pl-smi">endpoints</span><span class="pl-k">=&gt;</span>
    {
        <span class="pl-c"><span class="pl-c">//</span> ...</span><span class="pl-smi">endpoints</span>.<span class="pl-en">MapMetrics</span>();
    };
}</pre></div><p>The default configuration will publish metrics on the <code>/metrics</code> URL.</p><p>The ASP.NET Core functionality is delivered in the <code>prometheus-net.AspNetCore</code> NuGet package.</p><h1><a id="user-content-aspnet-core-http-request-metrics" class="anchor" aria-hidden="true" href="#aspnet-core-http-request-metrics"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ASP.NET Core HTTP request metrics</h1><p>The library exposes some metrics from ASP.NET Core applications:</p><ul><li>Number of HTTP requests in progress.</li><li>Total number of received HTTP requests.</li><li>Duration of HTTP requests.</li></ul><p>These metrics include labels for status code, HTTP method, Controller and Action.</p><p>The ASP.NET Core functionality is delivered in the <code>prometheus-net.AspNetCore</code> NuGet package.</p><p>You can expose HTTP metrics by modifying your <code>Startup.Configure()</code> method:</p><ul><li>ASP.NET Core 3 or newer
<ul><li>After <code>app.UseRouting()</code> add <code>app.UseHttpMetrics()</code>.</li></ul></li><li>ASP.NET Core 2
<ul><li>After <code>app.UseMetricServer()</code> add <code>app.UseHttpMetrics()</code>.</li></ul></li></ul><p>Example <code>Startup.cs</code> (ASP.NET Core 3):</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Configure</span>(<span class="pl-en">IApplicationBuilder</span><span class="pl-smi">app</span>, ...)
{
    <span class="pl-c"><span class="pl-c">//</span> ...</span><span class="pl-smi">app</span>.<span class="pl-en">UseRouting</span>();
    <span class="pl-smi">app</span>.<span class="pl-en">UseHttpMetrics</span>();

    <span class="pl-c"><span class="pl-c">//</span> ...</span>
}</pre></div><p>NB! Exception handler middleware that changes HTTP response codes must be registered <strong>after</strong><code>UseHttpMetrics()</code> in order to ensure that prometheus-net reports the correct HTTP response status code.</p><h1><a id="user-content-aspnet-core-with-basic-authentication" class="anchor" aria-hidden="true" href="#aspnet-core-with-basic-authentication"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ASP.NET Core with basic authentication</h1><p>You may wish to restrict access to the metrics export URL. This can be accomplished using any ASP.NET Core authentication mechanism, as prometheus-net integrates directly into the composable ASP.NET Core request processing pipeline.</p><p>For a simple example we can take <a href="https://www.johanbostrom.se/blog/adding-basic-auth-to-your-mvc-application-in-dotnet-core" rel="nofollow">BasicAuthMiddleware by Johan Boström</a> which can be integrated by replacing the <code>app.UseMetricServer()</code> line with the following code block:</p><div class="highlight highlight-source-cs"><pre><span class="pl-smi">app</span>.<span class="pl-en">Map</span>(<span class="pl-s"><span class="pl-pds">"</span>/metrics<span class="pl-pds">"</span></span>, <span class="pl-smi">metricsApp</span><span class="pl-k">=&gt;</span>
{
    <span class="pl-smi">metricsApp</span>.<span class="pl-en">UseMiddleware</span>&lt;<span class="pl-en">BasicAuthMiddleware</span>&gt;(<span class="pl-s"><span class="pl-pds">"</span>Contoso Corporation<span class="pl-pds">"</span></span>);

    <span class="pl-c"><span class="pl-c">//</span> We already specified URL prefix in .Map() above, no need to specify it again here.</span><span class="pl-smi">metricsApp</span>.<span class="pl-en">UseMetricServer</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
});</pre></div><h1><a id="user-content-aspnet-web-api-exporter" class="anchor" aria-hidden="true" href="#aspnet-web-api-exporter"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ASP.NET Web API exporter</h1><p>The easiest way to export metrics from an ASP.NET Web API app on the full .NET Framework is to use <code>AspNetMetricServer</code> in your <code>Global.asax.cs</code> file:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">protected</span><span class="pl-k">void</span><span class="pl-en">Application_Start</span>(<span class="pl-k">object</span><span class="pl-smi">sender</span>, <span class="pl-en">EventArgs</span><span class="pl-smi">e</span>)
{
    <span class="pl-smi">AspNetMetricServer</span>.<span class="pl-en">RegisterRoutes</span>(<span class="pl-smi">GlobalConfiguration</span>.<span class="pl-smi">Configuration</span>);
}</pre></div><p>The above snippet exposes metrics on the <code>/metrics</code> URL.</p><p>The <code>AspNetMetricServer</code> class is provided by the <code>prometheus-net.NetFramework.AspNet</code> NuGet package.</p><h1><a id="user-content-kestrel-stand-alone-server" class="anchor" aria-hidden="true" href="#kestrel-stand-alone-server"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kestrel stand-alone server</h1><p>In some situation, you may wish to start a stand-alone metric server using Kestrel (e.g. if your app has no other HTTP-accessible functionality).</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span><span class="pl-smi">metricServer</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">KestrelMetricServer</span>(<span class="pl-smi">port</span>: <span class="pl-c1">1234</span>);
<span class="pl-smi">metricServer</span>.<span class="pl-en">Start</span>();</pre></div><p>The default configuration will publish metrics on the <code>/metrics</code> URL.</p><h1><a id="user-content-publishing-to-pushgateway" class="anchor" aria-hidden="true" href="#publishing-to-pushgateway"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Publishing to Pushgateway</h1><p>Metrics can be posted to a <a href="https://prometheus.io/docs/practices/pushing/" rel="nofollow">Pushgateway</a> server.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span><span class="pl-smi">pusher</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">MetricPusher</span>(<span class="pl-k">new</span><span class="pl-en">MetricPusherOptions</span>
{
    <span class="pl-smi">Endpoint</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>https://pushgateway.example.org:9091/metrics<span class="pl-pds">"</span></span>,
    <span class="pl-smi">Job</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>some_job<span class="pl-pds">"</span></span>
});

<span class="pl-smi">pusher</span>.<span class="pl-en">Start</span>();</pre></div><h1><a id="user-content-publishing-to-pushgateway-with-basic-authentication" class="anchor" aria-hidden="true" href="#publishing-to-pushgateway-with-basic-authentication"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Publishing to Pushgateway with basic authentication</h1><p>You can use a custom HttpClient to supply credentials for the Pushgateway.</p><div class="highlight highlight-source-cs"><pre><span class="pl-c"><span class="pl-c">//</span> Placeholder username and password here - replace with your own data.</span><span class="pl-k">var</span><span class="pl-smi">headerValue</span><span class="pl-k">=</span><span class="pl-smi">Convert</span>.<span class="pl-en">ToBase64String</span>(<span class="pl-smi">Encoding</span>.<span class="pl-smi">UTF8</span>.<span class="pl-en">GetBytes</span>(<span class="pl-s"><span class="pl-pds">"</span>username:password<span class="pl-pds">"</span></span>));
<span class="pl-k">var</span><span class="pl-smi">httpClient</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">HttpClient</span>();
<span class="pl-smi">httpClient</span>.<span class="pl-smi">DefaultRequestHeaders</span>.<span class="pl-smi">Authorization</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">AuthenticationHeaderValue</span>(<span class="pl-s"><span class="pl-pds">"</span>Basic<span class="pl-pds">"</span></span>, <span class="pl-smi">headerValue</span>);

<span class="pl-k">var</span><span class="pl-smi">pusher</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">MetricPusher</span>(<span class="pl-k">new</span><span class="pl-en">MetricPusherOptions</span>
{
    <span class="pl-smi">Endpoint</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>https://pushgateway.example.org:9091/metrics<span class="pl-pds">"</span></span>,
    <span class="pl-smi">Job</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>some_job<span class="pl-pds">"</span></span>,
    <span class="pl-smi">HttpClientProvider</span><span class="pl-k">=</span> () <span class="pl-k">=&gt;</span><span class="pl-smi">httpClient</span>
});

<span class="pl-smi">pusher</span>.<span class="pl-en">Start</span>();</pre></div><h1><a id="user-content-publishing-via-standalone-http-handler" class="anchor" aria-hidden="true" href="#publishing-via-standalone-http-handler"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Publishing via standalone HTTP handler</h1><p>As a fallback option for scenarios where Kestrel or ASP.NET Core hosting is unsuitable, an <code>HttpListener</code> based metrics server implementation is also available.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span><span class="pl-smi">metricServer</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">MetricServer</span>(<span class="pl-smi">port</span>: <span class="pl-c1">1234</span>);
<span class="pl-smi">metricServer</span>.<span class="pl-en">Start</span>();</pre></div><p>The default configuration will publish metrics on the <code>/metrics</code> URL.</p><p><code>MetricServer.Start()</code> may throw an access denied exception on Windows if your user does not have the right to open a web server on the specified port. You can use the <em>netsh</em> command to grant yourself the required permissions:</p><blockquote><p>netsh http add urlacl url=http://+:1234/metrics user=DOMAIN\user</p></blockquote><h1><a id="user-content-publishing-raw-metrics-document" class="anchor" aria-hidden="true" href="#publishing-raw-metrics-document"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Publishing raw metrics document</h1><p>In scenarios where you handle publishing via a custom endpoint, you can export the entire metrics data set as a Prometheus text document.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">await</span><span class="pl-smi">Metrics</span>.<span class="pl-smi">DefaultRegistry</span>.<span class="pl-en">CollectAndExportAsTextAsync</span>(<span class="pl-smi">outputStream</span>);</pre></div><h1><a id="user-content-just-in-time-updates" class="anchor" aria-hidden="true" href="#just-in-time-updates"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Just-in-time updates</h1><p>In some scenarios you may want to only collect data when it is requested by Prometheus. To easily implement this scenario prometheus-net enables you to register a callback before every collection occurs. Register your callback using <code>Metrics.DefaultRegistry.AddBeforeCollectCallback()</code>.</p><p>Every callback will be executed before each collection, which will not finish until every callback has finished executing. Prometheus will expect each scrape to complete within a certain amount of seconds. To avoid timeouts, ensure that any registered callbacks execute quickly.</p><ul><li>A synchronous callback (of type <code>Action</code>) should not take more than a few milliseconds. Do not read data from remote systems in these callbacks.</li><li>An asynchronous callback (of type <code>Func&lt;CancellationToken, Task&gt;</code>) is more suitable for long-running data collection work (lasting a few seconds). You can use asynchronous callbacks for reading data from remote systems.</li></ul><div class="highlight highlight-source-cs"><pre><span class="pl-smi">Metrics</span>.<span class="pl-smi">DefaultRegistry</span>.<span class="pl-en">AddBeforeCollectCallback</span>(<span class="pl-k">async</span> (<span class="pl-smi">cancel</span>) <span class="pl-k">=&gt;</span>
{
    <span class="pl-c"><span class="pl-c">//</span> Probe a remote system.</span><span class="pl-k">var</span><span class="pl-smi">response</span><span class="pl-k">=</span><span class="pl-k">await</span><span class="pl-smi">httpClient</span>.<span class="pl-en">GetAsync</span>(<span class="pl-s"><span class="pl-pds">"</span>https://google.com<span class="pl-pds">"</span></span>, <span class="pl-smi">cancel</span>);

    <span class="pl-c"><span class="pl-c">//</span> Increase a counter by however many bytes we loaded.</span><span class="pl-smi">googlePageBytes</span>.<span class="pl-en">Inc</span>(<span class="pl-smi">response</span>.<span class="pl-smi">Content</span>.<span class="pl-smi">Headers</span>.<span class="pl-smi">ContentLength</span><span class="pl-k">??</span><span class="pl-c1">0</span>);
});</pre></div><h1><a id="user-content-suppressing-default-metrics" class="anchor" aria-hidden="true" href="#suppressing-default-metrics"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Suppressing default metrics</h1><p>The library provides some sample metrics about the current process out of the box, simply to ensure that some output is produced in a default configuration. If these metrics are not desirable you may remove them by calling <code>Metrics.SuppressDefaultMetrics()</code> before registering any of your own metrics.</p><h1><a id="user-content-diagnosticsource-integration" class="anchor" aria-hidden="true" href="#diagnosticsource-integration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DiagnosticSource integration</h1><p><a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md">.NET Core provides the DiagnosticSource mechanism for reporting diagnostic events</a>, used widely by .NET and ASP.NET Core classes. To expose basic data on these events via Prometheus, you can use the <code>DiagnosticSourceAdapter</code> class:</p><div class="highlight highlight-source-cs"><pre><span class="pl-c"><span class="pl-c">//</span> An optional "options" parameter is available to customize adapter behavior.</span><span class="pl-k">var</span><span class="pl-smi">diagnosticSourceRegistration</span><span class="pl-k">=</span><span class="pl-smi">DiagnosticSourceAdapter</span>.<span class="pl-en">StartListening</span>();

...

<span class="pl-c"><span class="pl-c">//</span> Stops listening for DiagnosticSource events.</span><span class="pl-smi">diagnosticSourceRegistration</span>.<span class="pl-en">Dispose</span>();</pre></div><p>Any events that occur are exported as Prometheus metrics, indicating the name of the event source and the name of the event:</p><pre><code>diagnostic_events_total{source="Microsoft.AspNetCore",event="Microsoft.AspNetCore.Mvc.AfterAction"} 4
diagnostic_events_total{source="HttpHandlerDiagnosticListener",event="System.Net.Http.Request"} 8
</code></pre><p>The level of detail obtained from this is rather low - only the total count for each event is exported. For more fine-grained analytics, you need to listen to DiagnosticSource events on your own and create custom metrics that can understand the meaning of each particular type of event that is of interest to you.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>