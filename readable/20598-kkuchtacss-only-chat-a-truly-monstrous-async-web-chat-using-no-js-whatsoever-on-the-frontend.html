<!DOCTYPE html>
<html lang="en">
<head>
    <title>
kkuchta/css-only-chat: A truly monstrous async web chat using no JS whatsoever on the frontend -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>kkuchta/css-only-chat: A truly monstrous async web chat using no JS whatsoever on the frontend</h1><div><div id="" class="markdown-body entry-content p-5"><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/351e844d827387206d272a9781bee8b0baa5458a/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f64576b78415a5467394e6241687652714f652f67697068792e676966"><img src="https://camo.githubusercontent.com/351e844d827387206d272a9781bee8b0baa5458a/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f64576b78415a5467394e6241687652714f652f67697068792e676966" alt="" data-canonical-src="https://media.giphy.com/media/dWkxAZTg9NbAhvRqOe/giphy.gif"></a></p><h1><a id="user-content-css-only-chat" class="anchor" aria-hidden="true" href="#css-only-chat"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CSS-Only Chat</h1><p>A truly monstrous async web chat using no JS whatsoever on the frontend.</p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/cc225eb13b645b00744c19995f7ff66a7c74f315/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f6d43436c5353367862693875732f67697068792e676966"><img src="https://camo.githubusercontent.com/cc225eb13b645b00744c19995f7ff66a7c74f315/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f6d43436c5353367862693875732f67697068792e676966" alt="" data-canonical-src="https://media.giphy.com/media/mCClSS6xbi8us/giphy.gif"></a></p><h1><a id="user-content-wait-what" class="anchor" aria-hidden="true" href="#wait-what"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Wait what</h1><p>This is an asynchronous chat that sends + receives messages in the browser with no reloads and no javascript.</p><h2><a id="user-content-ok-so-how" class="anchor" aria-hidden="true" href="#ok-so-how"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ok so how</h2><p>Background-images loaded via pseudoselectors + a forever-loading index page (remember <a href="https://en.wikipedia.org/wiki/Comet_(programming)" rel="nofollow">Comet</a>?).</p><h2><a id="user-content-say-that-again" class="anchor" aria-hidden="true" href="#say-that-again"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Say that again?</h2><p>Ok, so there are two things we need the browser to do: send data and receive data.  Let's start with the first.</p><h3><a id="user-content-sending-data" class="anchor" aria-hidden="true" href="#sending-data"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sending Data</h3><p>CSS is really limited in what it can do.  However, we <em>can</em> use it to effectively detect button presses:</p><pre><code>.some-button:active {
  background-image: url('some_image.jpg')
}
</code></pre><p>What's cool is that a browser won't actually load that background image until this selector is used - that is, when this button is pressed.  So now we have a way to trigger a request to a server of our choice on a button press.  That sounds like data sending!</p><p>Now, of course, this only works once per button (since a browser won't try to load that image twice), but it's a start.</p><h3><a id="user-content-receiving-data" class="anchor" aria-hidden="true" href="#receiving-data"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Receiving Data</h3><p>Since we can't use JS, it's really hard to change a page after it's already been loaded.  But it <em>is</em> possible.</p><p>Back before websockets were widely supported, we had to use clever hacks if we wanted to push data from a server to a client in an ongoing basis.  One such hack was just to make the page never finish loading.  It turns out that you can tell the browser to start rendering a page before it's finished loading (using the <code>Transfer-Encoding: chunked</code> http header).  And when you do that, you don't <em>actually</em> have to stop loading the page.  You can just keep adding stuff to the bottom of the html forever, at whatever rate you want.</p><p>So, for example, you could start sending a normal html page, then just stop sending html (while still telling the client you're sending) until you're ready to deliver another message.</p><p>Now, all this lets us do is periodically append html to the page.  What can we do with that?  How about, when you load the index page, this happens:</p><ol><li>We load up the first pile of html we want to show.  A welcome message, etc.</li><li>We stop loading html for a while until we want to send some sort of update.</li><li>Now we load up a <code>&lt;style&gt;</code> element that <code>display: none</code>'s all the previous html</li><li>Then we load up whatever <em>new</em> html we want to show</li><li>Finally we wait until the next update we want to send and GOTO 3.</li></ol><h3><a id="user-content-single-use-buttons" class="anchor" aria-hidden="true" href="#single-use-buttons"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Single-use buttons?</h3><p>Ok, so we have that problem earlier where each button is only single-use.  It tries to send a get request once, then never will again.</p><p>Thankfully, our method of receiving data fixes that for us.  Here's what happens:</p><ol><li>We show an "a" button whose background image is like "img/a".</li><li>When you press it, the server receives the image request for "a"</li><li>The server then pushes an update to the client to hide the current button and replace it with one whose background images is "image/aa".</li></ol><p>If the buttons you pressed were "h", "e", and "l", then the "a" button's background image url would be "img/hela".  And since we're replacing all buttons every time you press one, the single-use button problem goes away!</p><h3><a id="user-content-misc-other-details" class="anchor" aria-hidden="true" href="#misc-other-details"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Misc other details</h3><ul><li>We actually encode a bit more info into the button urls (like each client's id)</li><li>Because the data-sending and data-receiving happens on different threads, we need inter-thread communication.  That sounds like work, so we'll just use Redis pubsub for that.</li></ul><h3><a id="user-content-faq" class="anchor" aria-hidden="true" href="#faq"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FAQ</h3><p><strong>What inspired this?</strong> Chernobyl, Hindenburg, The Tacoma Narrows Bridge...</p><p><strong>Really?</strong> No, it was this <a href="https://twitter.com/davywtf/status/1124130932573839360" rel="nofollow">clever tweet</a> by davywtf.</p><p><strong>Why's your code suck</strong> Why do <em>you</em> suck?</p><p><strong>No but really</strong> Because I was mostly making this up as I went.  There's a lot of exploratory coding here that I only minimally cleaned up.  If I rebuilt it I'd store the UI state for a client in redis and just push it out in its entirety when needed via a single generic screen-updating mechanism.</p><p><strong>What could go wrong with this technique?</strong> Broken by browser bg-image handling changes; long-request timeouts; running out of threads; fast-clicking bugs; generic concurrency headaches; poor handling by proxies; it's crazy inaccessible; etc etc</p><p><strong>Should I use this in real life?</strong> Dear god yes.</p><p><strong>I have an idea for how this could be made better/worse/hackier</strong><a href="https://twitter.com/kkuchta" rel="nofollow">Tweet at me (@kkuchta)</a>.  I'm always down to see a terrible idea taken further!</p><h3><a id="user-content-practical-details" class="anchor" aria-hidden="true" href="#practical-details"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Practical Details</h3><p>If you want to install and use this locally you should:</p><ol><li>Re-evaluate your life choices</li><li>If you simply must continue, check out INSTALL.md</li></ol><p>If you want to contribute, see number 1 above.  After that, just fork this repo, make a change, and then open a PR against this repo.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>