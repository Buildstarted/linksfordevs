<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Code to mark a SQL string before it&#x27;s passed to Dapper. - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Code to mark a SQL string before it&#x27;s passed to Dapper. - linksfor.dev(s)"/>
    <meta property="og:description" content="Code to mark a SQL string before it&#x27;s passed to Dapper. - ExampleUsage.cs"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://gist.github.com/NickCraver/c6f371bf8df37e05c4f09fd3c02ef6a2"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">ðŸŽ‰</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Code to mark a SQL string before it&#x27;s passed to Dapper.</title>
<div class="readable">
        <h1>Code to mark a SQL string before it&#x27;s passed to Dapper.</h1>
            <div>Reading time: 5-7 minutes</div>
        <div>Posted here: 18 Mar 2019</div>
        <p><a href="https://gist.github.com/NickCraver/c6f371bf8df37e05c4f09fd3c02ef6a2">https://gist.github.com/NickCraver/c6f371bf8df37e05c4f09fd3c02ef6a2</a></p>
        <hr/>
<div id="readability-page-1" class="page"><p>
    Code to mark a SQL string before it's passed to Dapper.
  </p><div>
  <div id="file-marksqlstring-cs">
      
    

  <div itemprop="text">
      
<table data-tab-size="8">
      <tbody><tr>
        <td id="file-marksqlstring-cs-L1" data-line-number="1"></td>
        <td id="file-marksqlstring-cs-LC1"><span>private</span> <span>static</span> <span>readonly</span> <span>ConcurrentDictionary</span>&lt;<span>MarkedSqlStringKey</span>, <span>string</span>&gt; <span>MarkedSql</span> <span>=</span> <span>new</span> <span>ConcurrentDictionary</span>&lt;<span>MarkedSqlStringKey</span>, <span>string</span>&gt;();</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L2" data-line-number="2"></td>
        <td id="file-marksqlstring-cs-LC2">
</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L3" data-line-number="3"></td>
        <td id="file-marksqlstring-cs-LC3"><span>private</span> <span>struct</span> <span>MarkedSqlStringKey</span> : <span>IEquatable</span>&lt;<span>MarkedSqlStringKey</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L4" data-line-number="4"></td>
        <td id="file-marksqlstring-cs-LC4">{</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L5" data-line-number="5"></td>
        <td id="file-marksqlstring-cs-LC5">    <span>public</span> <span>string</span> <span>Sql</span> { <span>get</span>; }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L6" data-line-number="6"></td>
        <td id="file-marksqlstring-cs-LC6">    <span>public</span> <span>string</span> <span>Path</span> { <span>get</span>; }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L7" data-line-number="7"></td>
        <td id="file-marksqlstring-cs-LC7">    <span>public</span> <span>int</span> <span>LineNumber</span> { <span>get</span>; }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L8" data-line-number="8"></td>
        <td id="file-marksqlstring-cs-LC8">    <span>public</span> <span>string</span> <span>Comment</span> { <span>get</span>; }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L9" data-line-number="9"></td>
        <td id="file-marksqlstring-cs-LC9">    <span>public</span> <span>MarkedSqlStringKey</span>(<span>string</span> <span>sql</span>, <span>string</span> <span>path</span>, <span>int</span> <span>lineNumber</span>, <span>string</span> <span>comment</span>)</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L10" data-line-number="10"></td>
        <td id="file-marksqlstring-cs-LC10">    {</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L11" data-line-number="11"></td>
        <td id="file-marksqlstring-cs-LC11">        <span>Sql</span> <span>=</span> <span>sql</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L12" data-line-number="12"></td>
        <td id="file-marksqlstring-cs-LC12">        <span>Path</span> <span>=</span> <span>path</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L13" data-line-number="13"></td>
        <td id="file-marksqlstring-cs-LC13">        <span>LineNumber</span> <span>=</span> <span>lineNumber</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L14" data-line-number="14"></td>
        <td id="file-marksqlstring-cs-LC14">        <span>Comment</span> <span>=</span> <span>comment</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L15" data-line-number="15"></td>
        <td id="file-marksqlstring-cs-LC15">    }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L16" data-line-number="16"></td>
        <td id="file-marksqlstring-cs-LC16">    <span>public</span> <span>bool</span> <span>Equals</span>(<span>MarkedSqlStringKey</span> <span>other</span>)</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L17" data-line-number="17"></td>
        <td id="file-marksqlstring-cs-LC17">    {</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L18" data-line-number="18"></td>
        <td id="file-marksqlstring-cs-LC18">        <span>return</span> </td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L19" data-line-number="19"></td>
        <td id="file-marksqlstring-cs-LC19">            <span>string</span>.<span>Equals</span>(<span>Sql</span>, <span>other</span>.<span>Sql</span>) <span>&amp;&amp;</span> </td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L20" data-line-number="20"></td>
        <td id="file-marksqlstring-cs-LC20">            <span>string</span>.<span>Equals</span>(<span>Path</span>, <span>other</span>.<span>Path</span>) <span>&amp;&amp;</span> </td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L21" data-line-number="21"></td>
        <td id="file-marksqlstring-cs-LC21">            <span>LineNumber</span> <span>==</span> <span>other</span>.<span>LineNumber</span> <span>&amp;&amp;</span> </td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L22" data-line-number="22"></td>
        <td id="file-marksqlstring-cs-LC22">            <span>string</span>.<span>Equals</span>(<span>Comment</span>, <span>other</span>.<span>Comment</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L23" data-line-number="23"></td>
        <td id="file-marksqlstring-cs-LC23">    }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L24" data-line-number="24"></td>
        <td id="file-marksqlstring-cs-LC24">    <span>public</span> <span>override</span> <span>bool</span> <span>Equals</span>(<span>object</span> <span>obj</span>)</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L25" data-line-number="25"></td>
        <td id="file-marksqlstring-cs-LC25">    {</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L26" data-line-number="26"></td>
        <td id="file-marksqlstring-cs-LC26">        <span>if</span> (<span>ReferenceEquals</span>(<span>null</span>, <span>obj</span>)) <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L27" data-line-number="27"></td>
        <td id="file-marksqlstring-cs-LC27">        <span>return</span> <span>obj</span> <span>is</span> <span>MarkedSqlStringKey</span> <span>&amp;&amp;</span> <span>Equals</span>((<span>MarkedSqlStringKey</span>) <span>obj</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L28" data-line-number="28"></td>
        <td id="file-marksqlstring-cs-LC28">    }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L29" data-line-number="29"></td>
        <td id="file-marksqlstring-cs-LC29">    <span>public</span> <span>override</span> <span>int</span> <span>GetHashCode</span>()</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L30" data-line-number="30"></td>
        <td id="file-marksqlstring-cs-LC30">    {</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L31" data-line-number="31"></td>
        <td id="file-marksqlstring-cs-LC31">        <span>unchecked</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L32" data-line-number="32"></td>
        <td id="file-marksqlstring-cs-LC32">        {</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L33" data-line-number="33"></td>
        <td id="file-marksqlstring-cs-LC33">            <span>var</span> <span>hashCode</span> <span>=</span> <span>Sql</span><span>?</span>.<span>GetHashCode</span>() <span>??</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L34" data-line-number="34"></td>
        <td id="file-marksqlstring-cs-LC34">            <span>hashCode</span> <span>=</span> (<span>hashCode</span><span>*</span><span>397</span>) <span>^</span> (<span>Path</span><span>?</span>.<span>GetHashCode</span>() <span>??</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L35" data-line-number="35"></td>
        <td id="file-marksqlstring-cs-LC35">            <span>hashCode</span> <span>=</span> (<span>hashCode</span><span>*</span><span>397</span>) <span>^</span> <span>LineNumber</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L36" data-line-number="36"></td>
        <td id="file-marksqlstring-cs-LC36">            <span>hashCode</span> <span>=</span> (<span>hashCode</span><span>*</span><span>397</span>) <span>^</span> (<span>Comment</span><span>?</span>.<span>GetHashCode</span>() <span>??</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L37" data-line-number="37"></td>
        <td id="file-marksqlstring-cs-LC37">            <span>return</span> <span>hashCode</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L38" data-line-number="38"></td>
        <td id="file-marksqlstring-cs-LC38">        }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L39" data-line-number="39"></td>
        <td id="file-marksqlstring-cs-LC39">    }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L40" data-line-number="40"></td>
        <td id="file-marksqlstring-cs-LC40">}</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L41" data-line-number="41"></td>
        <td id="file-marksqlstring-cs-LC41">
</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L42" data-line-number="42"></td>
        <td id="file-marksqlstring-cs-LC42"><span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L43" data-line-number="43"></td>
        <td id="file-marksqlstring-cs-LC43"><span><span>///</span> Takes a SQL query, and inserts the path and line in as a comment.</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L44" data-line-number="44"></td>
        <td id="file-marksqlstring-cs-LC44"><span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L45" data-line-number="45"></td>
        <td id="file-marksqlstring-cs-LC45"><span>private</span> <span>static</span> <span>string</span> <span>MarkSqlString</span>(<span>string</span> <span>sql</span>, <span>string</span> <span>path</span>, <span>int</span> <span>lineNumber</span>, <span>string</span> <span>comment</span>)</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L46" data-line-number="46"></td>
        <td id="file-marksqlstring-cs-LC46">{</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L47" data-line-number="47"></td>
        <td id="file-marksqlstring-cs-LC47">    <span>if</span> (<span>path</span>.<span>IsNullOrEmpty</span>() <span>||</span> <span>lineNumber</span> <span>==</span> <span>0</span>) <span>return</span> <span>sql</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L48" data-line-number="48"></td>
        <td id="file-marksqlstring-cs-LC48">    <span>var</span> <span>key</span> <span>=</span> <span>new</span> <span>MarkedSqlStringKey</span>(<span>sql</span>, <span>path</span>, <span>lineNumber</span>, <span>comment</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L49" data-line-number="49"></td>
        <td id="file-marksqlstring-cs-LC49">    <span><span>//</span> Have we seen this before???</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L50" data-line-number="50"></td>
        <td id="file-marksqlstring-cs-LC50">    <span>string</span> <span>output</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L51" data-line-number="51"></td>
        <td id="file-marksqlstring-cs-LC51">    <span>if</span> (<span>MarkedSql</span>.<span>TryGetValue</span>(<span>key</span>, <span>out</span> <span>output</span>)) <span>return</span> <span>output</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L52" data-line-number="52"></td>
        <td id="file-marksqlstring-cs-LC52">    <span><span>//</span> nope</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L53" data-line-number="53"></td>
        <td id="file-marksqlstring-cs-LC53">    <span>var</span> <span>commentWrap</span> <span>=</span> <span><span>"</span> <span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L54" data-line-number="54"></td>
        <td id="file-marksqlstring-cs-LC54">    <span>var</span> <span>i</span> <span>=</span> <span>sql</span>.<span>IndexOf</span>(<span>Environment</span>.<span>NewLine</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L55" data-line-number="55"></td>
        <td id="file-marksqlstring-cs-LC55">    <span><span>//</span> if we didn't find \n, or it was the very end, go to the first space method</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L56" data-line-number="56"></td>
        <td id="file-marksqlstring-cs-LC56">    <span>if</span> (<span>i</span> <span>&lt;</span> <span>0</span> <span>||</span> <span>i</span> <span>==</span> <span>sql</span>.<span>Length</span> <span>-</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L57" data-line-number="57"></td>
        <td id="file-marksqlstring-cs-LC57">    {</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L58" data-line-number="58"></td>
        <td id="file-marksqlstring-cs-LC58">        <span>i</span> <span>=</span> <span>sql</span>.<span>IndexOf</span>(<span>' '</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L59" data-line-number="59"></td>
        <td id="file-marksqlstring-cs-LC59">        <span>commentWrap</span> <span>=</span> <span>Environment</span>.<span>NewLine</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L60" data-line-number="60"></td>
        <td id="file-marksqlstring-cs-LC60">    }</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L61" data-line-number="61"></td>
        <td id="file-marksqlstring-cs-LC61">    <span>if</span> (<span>i</span> <span>&lt;</span> <span>0</span>) <span>return</span> <span>sql</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L62" data-line-number="62"></td>
        <td id="file-marksqlstring-cs-LC62">    <span><span>//</span> Grab one directory and the file name worth of the path</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L63" data-line-number="63"></td>
        <td id="file-marksqlstring-cs-LC63">    <span><span>//</span>   this dodges problems with the build server using temp dirs</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L64" data-line-number="64"></td>
        <td id="file-marksqlstring-cs-LC64">    <span><span>//</span>   but also gives us enough info to uniquely identify a queries location</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L65" data-line-number="65"></td>
        <td id="file-marksqlstring-cs-LC65">    <span>var</span> <span>split</span> <span>=</span> <span>path</span>.<span>LastIndexOf</span>(<span>'<span>\\</span>'</span>) <span>-</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L66" data-line-number="66"></td>
        <td id="file-marksqlstring-cs-LC66">    <span>if</span> (<span>split</span> <span>&lt;</span> <span>0</span>) <span>return</span> <span>sql</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L67" data-line-number="67"></td>
        <td id="file-marksqlstring-cs-LC67">    <span>split</span> <span>=</span> <span>path</span>.<span>LastIndexOf</span>(<span>'<span>\\</span>'</span>, <span>split</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L68" data-line-number="68"></td>
        <td id="file-marksqlstring-cs-LC68">    <span>if</span> (<span>split</span> <span>&lt;</span> <span>0</span>) <span>return</span> <span>sql</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L69" data-line-number="69"></td>
        <td id="file-marksqlstring-cs-LC69">    <span>split</span><span>++</span>; <span><span>//</span> just for Craver</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L70" data-line-number="70"></td>
        <td id="file-marksqlstring-cs-LC70">    <span>var</span> <span>sqlComment</span> <span>=</span> <span><span>"</span> /* <span>"</span></span> <span>+</span> <span>path</span>.<span>Substring</span>(<span>split</span>) <span>+</span> <span><span>"</span>@<span>"</span></span> <span>+</span> <span>lineNumber</span>.<span>ToString</span>() <span>+</span> (<span>comment</span>.<span>HasValue</span>() <span>?</span> <span><span>"</span> - <span>"</span></span> <span>+</span> <span>comment</span> <span>:</span> <span><span>"</span><span>"</span></span>) <span>+</span> <span><span>"</span> */<span>"</span></span> <span>+</span> <span>commentWrap</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L71" data-line-number="71"></td>
        <td id="file-marksqlstring-cs-LC71">    <span>var</span> <span>ret</span> <span>=</span> <span>sql</span>.<span>Substring</span>(<span>0</span>, <span>i</span>) <span>+</span> <span>sqlComment</span> <span>+</span> <span>sql</span>.<span>Substring</span>(<span>i</span>);</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L72" data-line-number="72"></td>
        <td id="file-marksqlstring-cs-LC72">    <span><span>//</span> Cache, don't allocate all this pass again</span></td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L73" data-line-number="73"></td>
        <td id="file-marksqlstring-cs-LC73">    <span>MarkedSql</span>[<span>key</span>] <span>=</span> <span>ret</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L74" data-line-number="74"></td>
        <td id="file-marksqlstring-cs-LC74">    <span>return</span> <span>ret</span>;</td>
      </tr>
      <tr>
        <td id="file-marksqlstring-cs-L75" data-line-number="75"></td>
        <td id="file-marksqlstring-cs-LC75">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>