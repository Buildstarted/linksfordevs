<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Retweeting Twitter Mentions On Demand with Twilio SMS and ASP.NET Core - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Retweeting Twitter Mentions On Demand with Twilio SMS and ASP.NET Core - linksfor.dev(s)"/>
    <meta property="article:author" content="By David Pine&#xA;      2020-03-19"/>
    <meta property="og:description" content="Programming tutorial demonstrating how to retweet Twitter mentions on demand from SMS messages sent through Twilio Programmable SMS and the Twitter API using an ASP.NET Core app running on an Azure app service."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.twilio.com/blog/retweeting-twitter-mentions-on-demand-twilio-sms-asp-net-core-azure"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Retweeting Twitter Mentions On Demand with Twilio SMS and ASP.NET Core</title>
<div class="readable">
        <h1>Retweeting Twitter Mentions On Demand with Twilio SMS and ASP.NET Core</h1>
            <div>by By David Pine&#xA;      2020-03-19</div>
            <div>Reading time: 29-37 minutes</div>
        <div>Posted here: 19 Mar 2020</div>
        <p><a href="https://www.twilio.com/blog/retweeting-twitter-mentions-on-demand-twilio-sms-asp-net-core-azure">https://www.twilio.com/blog/retweeting-twitter-mentions-on-demand-twilio-sms-asp-net-core-azure</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
      

      <section>
        
          <ul>
        
          
          
    
      


<article>
  <header>
  
  
  </header>
  <section>
    
    <div><div><p>If you’re a developer, chances are you are on Twitter. It’s where all the cool developers like to tweet code snippets, ideas, and boasts about programming projects!</p>
<p>If you’re like me, you probably don’t like notifications on your phone.</p>
<p>I mean, text messages, sure, those are fine, but not notifications from <em>apps</em>.</p>
<p>Fortunately, there’s a way to get important Twitter notifications and respond to them without leaving the comfort of your texting environment. You can retweet mentions without having to install an app on your phone or open your phone’s browser.</p>
<p>This post demonstrates how to leverage <a href="https://www.twilio.com/sms">Twilio Programmable SMS</a>&nbsp;in conjunction with ASP.NET Core, the Twitter API, and Microsoft Azure to receive a text message when someone mentions you on Twitter. You’ll also be able to retweet the Twitter mention directly from your SMS client with a quick reply. There are four parts to the project:</p>
<ol>
<li>Setting up a Twitter application</li>
<li>Setting up a Twilio phone number with Programmable SMS</li>
<li>Building an ASP.NET Core Web Application</li>
<li>Deploying the web application to Azure</li>
</ol>
<h2>Prerequisites</h2>
<ul>
<li><a href="https://github.com/join">GitHub</a>&nbsp;account (if you want to fork the project source code, free)</li>
<li><a href="https://signup.live.com/signup">Microsoft</a>&nbsp;account (free, required to create an Azure account)</li>
<li><a href="https://azure.microsoft.com/en-us/free/">Azure</a>&nbsp;account (trial account with 12 months of free services)</li>
<li><a href="http://www.twilio.com/referral/SsO64F">Twilio</a>&nbsp;account (Use this link to get a $10 credit on your free trial account.)</li>
<li><a href="https://developer.twitter.com/en/apps/create">Twitter Developer</a>&nbsp;account (free)</li>
<li><a href="https://dotnet.microsoft.com/download">.NET Core 3.1 SDK</a>&nbsp;(version 3.1.101+)</li>
<li><a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 2019</a>&nbsp;(The Community Edition is free.)</li>
<li><a href="https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7">PowerShell 7</a>&nbsp;(or a comparable way of setting environment variables on your system)</li>
</ul>
<p>To get the most out of this post you should have knowledge of:</p>
<ul>
<li>ASP.NET Core</li>
<li>C# 8</li>
<li>Twitter</li>
</ul>
<p>A <a href="https://github.com/IEvangelist/IEvangelist.Retweet">companion repository</a>&nbsp;for this project is available on GitHub.</p>
<h2>Setting up a Twitter application</h2>
<p>You’ll need a <a href="https://developer.twitter.com/">Twitter Developer</a>&nbsp;account to build the application presented in this post. Only the free Standard API level is required.</p>
<p>Note&nbsp;that there is an approval process for new Twitter Developer accounts. Approval usually takes less than an hour, but may take longer if there are questions about the information you submit. Be sure to answer the registration questions completely and be sure to watch your email inbox in case Twitter wants more information on your application. It’s a good idea to get this process started while you proceed with the rest of the process.</p>
<p>Once your Twitter Developer account has been approved you’ll need to <a href="https://developer.twitter.com/en/apps/create">create a Twitter application</a>. Use the preceding link to go directly to the app creation page. You will be asked to provide a number of pieces of information to create the app:</p>
<p><em>App name</em>:&nbsp;This is whatever name you want to give your Twitter app.&nbsp;Your app name will appear as the source of Tweets and in user-facing authorization screens.</p>
<p><em>Application description</em>:&nbsp;This should contain a description of your app and what it does. Like the app name, it will be visible to users of your app.</p>
<p><em>Website URL</em>:&nbsp;This should contain a URL that links to a website related to your Twitter app. For the purpose of the demo app, you can enter your company website, your personal web page, or another relevant website address.</p>
<p><strong>Note:</strong>&nbsp;<em>Do not use twilio.com for any of the URLs you provide.</em></p>
<p>Tell us how this app will be used:&nbsp;This should contain a detailed explanation of what you intend to do with your Twitter app. The information here helps Twitter employees understand how your app will be used.</p>
<p>The <em>Enable Sign in with Twitter</em>&nbsp;option is an optional one that should only be selected if the Twitter application will be used to sign in with Twitter. If it is selected, a “Callback URL” should be provided. For the purposes of this app, leave this option unchecked.</p>
<p>After entering the required details, click the <strong>Create</strong>&nbsp;button to create your Twitter app.</p>
<p>Once the app is created, click <strong>Details</strong>&nbsp;next to the app name in the <em>Apps</em>&nbsp;list. Select the <em>Keys and Tokens</em>&nbsp;tab.</p>
<p>Copy your <em>API key</em>&nbsp;and <em>API secret key</em>&nbsp;from the <em>Consumer API keys</em>&nbsp;section to a safe place.</p>
<p>Click the <strong>Generate</strong>&nbsp;button to generate an <em>Access token</em>&nbsp;and A<em>ccess token secret</em>. Copy them somewhere safe. Close the panel.</p>
<p>When you return to the <em>Keys and Tokens</em>&nbsp;tab you should see an <em>Access token &amp; access token secret</em>&nbsp;section. The value for <em>Access level</em>&nbsp;should be “Read and write.”</p>
<p>Your work with the Twitter Developer Dashboard is complete.</p>
<p>Store your Twitter keys and tokens as environment variables. On Windows, use the following PowerShell instructions. Make sure to use double underscores (<code>__</code>) where shown.</p></div></div>
<div>

<div>
    <div><pre><span><span>[Action[string, string]]</span><span>$setx</span> <span>=</span> <span>{</span> <span>param</span><span>(</span><span>$key</span><span>,</span> <span>$val</span><span>)</span> <span>[System.Environment]</span><span>::</span><span>SetEnvironmentVariable</span><span>(</span><span>$key</span><span>,</span> <span>$val</span><span>,</span> <span>[System.EnvironmentVariableTarget]</span><span>::</span><span>User</span><span>)</span> <span>}</span>
</span><span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'Authentication__Twitter__ConsumerKey'</span><span>,</span> <span>'[Consumer API key]'</span><span>)</span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'Authentication__Twitter__ConsumerSecret'</span><span>,</span> <span>'[Consumer API secret key]'</span><span>)</span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'Authentication__Twitter__AccessToken'</span><span>,</span> <span>'[Access token]'</span><span>)</span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'Authentication__Twitter__AccessTokenSecret'</span><span>,</span> <span>'[Access token secret]'</span><span>)</span>
</span></pre></div>
</div>
</div>
<div><p>To verify that these environment variables have been correctly created and assigned, execute the following PowerShell command:</p></div>
<div>

<div>
    <div><pre><span><span>[System.Environment]</span><span>::</span><span>GetEnvironmentVariables</span><span>(</span><span>'User'</span><span>)</span> <span>`</span>
</span><span>    <span>|</span> <span>Out-String</span> <span>-Stream</span> <span>`</span>
</span><span>    <span>|</span> <span>select-string</span> <span>-Pattern</span> <span>"Auth.+?"</span>
</span></pre></div>
</div>
</div>
<div><div><h2>Getting started&nbsp;with Twilio Programmable SMS</h2>
<p>You’ll need a free <a href="http://www.twilio.com/referral/SsO64F">Twilio trial account&nbsp;</a>and a Twilio phone number with SMS capabilities to build this project with Twilio Programmable SMS. Getting set up will take just a few minutes.</p>
<p>Once you have a Twilio account and have registered a mobile device, go to the <a href="https://twilio.com/console">Twilio Console</a>&nbsp;and perform the following steps:</p>
<p>On the <em>Console Dashboard</em>&nbsp;home, locate your <em>Account SID</em>&nbsp;and <em>Auth Token</em>&nbsp;and copy them to a safe place.</p>
<p>Select the <em>Phone Numbers</em>&nbsp;tab (<strong>#</strong>) and Click the <strong>+</strong>&nbsp;button to buy a number. (For new users the nominal fee is covered by the credit on your trial account, shown on the Dashboard.)</p>
<p>Select the appropriate value for <em>Country</em>&nbsp;and check the SMS&nbsp;box in the <em>Capabilities</em>&nbsp;list, then click <strong>Search</strong><em>.</em>&nbsp;Select a number from the list and click <strong>Buy</strong>. Review the capabilities for the number and click <strong>Buy &lt;phone number&gt;</strong>.</p>
<p>You should see the information page for the phone number you’ve selected. Copy the values from the <em>Phone Number</em>&nbsp;and <em>Phone Number SID</em>&nbsp;to a safe place.</p>
<p>The credentials you just acquired are user secrets, so it’s a good idea not to store them in the project source code. One way to keep them safe and make them accessible in your project configuration is to store them as environment variables on your development machine.</p>
<p>ASP.NET Core can access environment variables and they can be used as properties of an&nbsp;<code>IConfiguration</code> object in the <code>Startup</code> class. You can also load configuration variables from the&nbsp;<em>appsettings.development.json</em> file.</p>
<p>If you have PowerShell installed on your Windows, macOS, &nbsp;Linux, or ARM system, execute the following commands in a PowerShell console window, substituting your credentials for the placeholders. For other operating system shells, use comparable commands to create the same environment variables. The environment variables will map to an instance of the <code>IOptions&lt;T&gt;</code>. More on that later.</p></div></div>
<div>

<div>
    <div><pre><span><span>[Action[string, string]]</span><span>$setx</span> <span>=</span> <span>{</span> <span>param</span><span>(</span><span>$key</span><span>,</span> <span>$val</span><span>)</span> <span>[System.Environment]</span><span>::</span><span>SetEnvironmentVariable</span><span>(</span><span>$key</span><span>,</span> <span>$val</span><span>,</span> <span>[System.EnvironmentVariableTarget]</span><span>::</span><span>User</span><span>)</span> <span>}</span>
</span><span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'TWILIO_ACCOUNT_SID'</span><span>,</span> <span>'[Account SID]'</span><span>)</span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'TWILIO_AUTH_TOKEN'</span><span>,</span> <span>'[Auth token]'</span><span>)</span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'TWILIO_SMS_PHONE_NUMBER'</span><span>,</span> <span>'[Twilio phone number]'</span><span>)</span>
</span><span><span>$setx</span><span>.</span><span>Invoke</span><span>(</span><span>'TO_PHONE_NUMBER, '</span><span>[To phone number]</span><span>')</span>
</span><span><span>$setx.Invoke('</span><span>TWITTER_HANDLE</span><span>,</span> <span>'[Twitter handle]'</span><span>)</span>
</span></pre></div>
</div>
</div>
<div><p>To verify that these environment variables have been correctly created and assigned, execute the following PowerShell command:</p></div>
<div>

<div>
    <div><pre><span><span>[System.Environment]</span><span>::</span><span>GetEnvironmentVariables</span><span>(</span><span>'User'</span><span>)</span> <span>`</span>
</span><span>    <span>|</span> <span>Out-String</span> <span>-Stream</span> <span>`</span>
</span><span>    <span>|</span> <span>select-string</span> <span>-Pattern</span> <span>"T.+?"</span> <span>`</span>
</span><span>    <span>|</span> <span>Sort</span>
</span></pre></div>
</div>
</div>
<div><p>If you prefer, or if your development environment requires it, you can place these values in the <em>appsettings.development.json</em>&nbsp;file as follows, but be careful not to expose this file in a source code repository or other easily accessible location.</p></div>
<div>

<div>
    <div><pre><span><span>{</span>
</span><span>  <span>"Logging"</span><span>:</span> <span>{</span>
</span><span>    <span>"LogLevel"</span><span>:</span> <span>{</span>
</span><span>      <span>"Default"</span><span>:</span> <span>"Warning"</span>
</span><span>    <span>}</span>
</span><span>  <span>},</span>
</span><span>  <span>"AllowedHosts"</span><span>:</span> <span>"*"</span><span>,</span>
</span><span>  <span>"Settings"</span><span>:</span> <span>{</span>
</span><span>    <span>"TwilioAccountSid"</span><span>:</span> <span>"[Account SID]"</span><span>,</span>
</span><span>    <span>"TwilioAuthToken"</span><span>:</span> <span>"[Auth token]"</span><span>,</span>
</span><span>    <span>"TwilioSmsPhoneNumber"</span><span>:</span> <span>"[Twilio phone number]"</span><span>,</span>
</span><span>    <span>"ToPhoneNumber"</span><span>:</span> <span>"[To phone number]"</span><span>,</span>
</span><span>    <span>"TwitterHandle"</span><span>:</span> <span>"[Twitter handle]"</span>
</span><span>  <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><div><h2>Creating the ASP.NET Core Web Application</h2>
<p>Create a new ASP.NET Core Web Application called <em>TwilioHeartsTwitter</em>&nbsp;with the Visual Studio 2019 user interface or with the .NET CLI. The following is the appropriate .NET CLI command-line instruction:</p></div></div>
<div>

<div>
    <div><pre><span>dotnet new web -n TwilioHeartsTwitter
</span></pre></div>
</div>
</div>
<div><div><h3>Add the required NuGet packages</h3>
<p>The ASP.NET Core Web Application will use the <a href="https://www.nuget.org/packages/Twilio/">Twilio</a>, <a href="https://www.nuget.org/packages/Twilio.AspNet.Core/">Twilio.AspNet.Core</a>,&nbsp;and <a href="https://www.nuget.org/packages/TweetinviAPI/">TweetinviAPI</a>&nbsp;packages. Install them with the NuGet Package Manager, Package Manager Console, or the following .NET CLI command-line instructions:</p></div></div>
<div>

<div>
    <div><pre><span>dotnet add package Twilio
</span><span>dotnet add package Twilio.AspNet.Core
</span><span>dotnet add package TweetinviAPI
</span></pre></div>
</div>
</div>
<div><p>The <em>TwilioHeartsTwitter.csproj</em>&nbsp;file should include the package references in an <code>&lt;ItemGroup&gt;</code> node, as shown below, if the command completed successfully. The version numbers in your project may be higher; just be certain that they are equal to or greater than the &nbsp;versions shown.</p></div>
<div>

<div>
    <div><pre><span><span>&lt;ItemGroup&gt;</span>
</span><span>  <span>&lt;PackageReference</span> <span>Include=</span><span>"TweetinviAPI"</span> <span>Version=</span><span>"4.0.3"</span> <span>/&gt;</span>
</span><span>  <span>&lt;PackageReference</span> <span>Include=</span><span>"Twilio"</span> <span>Version=</span><span>"5.37.5"</span> <span>/&gt;</span>
</span><span>  <span>&lt;PackageReference</span> <span>Include=</span><span>"Twilio.AspNet.Core"</span> <span>Version=</span><span>"5.33.1"</span> <span>/&gt;</span>
</span><span><span>&lt;/ItemGroup&gt;</span>
</span></pre></div>
</div>
</div>
<div><div><h3>Create the web app project folder and file structure</h3>
<p>Create the following folders and files under the <em>TwilioHeartsTwitter</em>&nbsp;project/folder:</p>
<p>TwilioHeartsTwitter<br>├── Controllers<br>│ &nbsp; └── TextMessageController.cs<br>├── Options<br>│ &nbsp; └── Settings.cs<br>└── Services<br>&nbsp; &nbsp; ├── ITwitterClient.cs<br>&nbsp; &nbsp; ├── MentionsListener.cs<br>&nbsp; &nbsp; └── TwitterClient.cs</p>
<p>If you’re using Visual Studio 2019 your&nbsp;Solution Explorer&nbsp;folder and file structure should look like the following when you’re finished:</p>
<p><img alt="Visual Studio 2019 Solution Explorer screenshot" height="689" sizes="500px" src="https://twilio-cms-prod.s3.amazonaws.com/images/MsA42pc1bu_UicayRZJ6MPppYhevp1Yeg_BO-XnG6Vs4rL.width-500.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/MsA42pc1bu_UicayRZJ6MPppYhevp1Yeg_BO-XnG6Vs4rL.width-500.png 500w, https://twilio-cms-prod.s3.amazonaws.com/images/MsA42pc1bu_UicayRZJ6MPppYhevp1Yeg_BO-XnG6Vs4r.width-1000.png 661w" width="500"></p>
<h3>Create the application startup and configuration</h3>
<p>The following steps will take you through the process of coding the <em>TwilioHeartsTwitter</em>&nbsp;web application. As you assemble the code, pay attention to the packages included through the <code>using</code> declarations and the places where the user secrets are loaded from environment variables (or the <em>appsettings.Development.json</em>&nbsp;file) through the Configuration Manager.</p>
<p>As you assemble the code you’ll probably note that various class and assembly names will <a href="https://en.wikipedia.org/wiki/Lint_(software)">lint</a>. Don’t worry about reference errors until you’re finished; you’re assembling the application in a different order than you might build it on your own to make it easier to follow the program execution.</p>
<p>Replace the existing contents of the <em>Program.cs</em>&nbsp;file in the project root folder with the following C# code:</p></div></div>
<div>

<div>
    <div><pre><span><span>using</span> <span>System.Threading.Tasks</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Hosting</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Hosting</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>TwilioHeartsTwitter</span>
</span><span><span>{</span>
</span><span>    <span>public</span> <span>class</span> <span>Program</span>
</span><span>    <span>{</span>
</span><span>        <span>public</span> <span>static</span> <span>Task</span> <span>Main</span><span>(</span><span>string</span><span>[]</span> <span>args</span><span>)</span> <span>=&gt;</span>
</span><span>            <span>CreateHostBuilder</span><span>(</span><span>args</span><span>).</span><span>Build</span><span>().</span><span>RunAsync</span><span>();</span>
</span><span>
</span><span>        <span>static</span> <span>IHostBuilder</span> <span>CreateHostBuilder</span><span>(</span><span>string</span><span>[]</span> <span>args</span><span>)</span> <span>=&gt;</span>
</span><span>            <span>Host</span><span>.</span><span>CreateDefaultBuilder</span><span>(</span><span>args</span><span>)</span>
</span><span>                <span>.</span><span>ConfigureWebHostDefaults</span><span>(</span>
</span><span>                    <span>webBuilder</span> <span>=&gt;</span> <span>webBuilder</span><span>.</span><span>UseStartup</span><span>&lt;</span><span>Startup</span><span>&gt;());</span>
</span><span>    <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><div><p>The <code>Program</code> class is the main entry point into the executable. It creates a <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-3.1">host</a>&nbsp;and configures the host startup using the <code>Startup</code> class.</p>
<p>Replace the contents of the <em>Startup.cs</em>&nbsp;file in the root project folder with the following C# code:</p></div></div>
<div>

<div>
    <div><pre><span><span>using</span> <span>TwilioHeartsTwitter.Options</span><span>;</span>
</span><span><span>using</span> <span>TwilioHeartsTwitter.Services</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Builder</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Hosting</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Configuration</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.DependencyInjection</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Hosting</span><span>;</span>
</span><span><span>using</span> <span>Tweetinvi</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>TwilioHeartsTwitter</span>
</span><span><span>{</span>
</span><span>    <span>public</span> <span>class</span> <span>Startup</span>
</span><span>    <span>{</span>
</span><span>        <span>readonly</span> <span>IConfiguration</span> <span>_configuration</span><span>;</span>
</span><span>
</span><span>        <span>public</span> <span>Startup</span><span>(</span><span>IConfiguration</span> <span>configuration</span><span>)</span> <span>=&gt;</span>
</span><span>            <span>_configuration</span> <span>=</span> <span>configuration</span><span>;</span>
</span><span>
</span><span>        <span>public</span> <span>void</span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> <span>services</span><span>)</span>
</span><span>        <span>{</span>
</span><span>            <span>services</span><span>.</span><span>Configure</span><span>&lt;</span><span>Settings</span><span>&gt;(</span><span>settings</span> <span>=&gt;</span>
</span><span>            <span>{</span>
</span><span>                <span>settings</span><span>.</span><span>TwilioAccountSid</span> <span>=</span> <span>_configuration</span><span>[</span><span>"TWILIO_ACCOUNT_SID"</span><span>];</span>
</span><span>                <span>settings</span><span>.</span><span>TwilioAuthToken</span> <span>=</span> <span>_configuration</span><span>[</span><span>"TWILIO_AUTH_TOKEN"</span><span>];</span>
</span><span>                <span>settings</span><span>.</span><span>TwilioSmsPhoneNumber</span> <span>=</span> <span>_configuration</span><span>[</span><span>"TWILIO_SMS_PHONE_NUMBER"</span><span>];</span>
</span><span>                <span>settings</span><span>.</span><span>ToPhoneNumber</span> <span>=</span> <span>_configuration</span><span>[</span><span>"TO_PHONE_NUMBER"</span><span>];</span>
</span><span>                <span>settings</span><span>.</span><span>TwitterHandle</span> <span>=</span> <span>_configuration</span><span>[</span><span>"TWITTER_HANDLE"</span><span>];</span>
</span><span>            <span>});</span>
</span><span>
</span><span>            <span>Auth</span><span>.</span><span>SetUserCredentials</span><span>(</span>
</span><span>                <span>_configuration</span><span>[</span><span>"Authentication:Twitter:ConsumerKey"</span><span>],</span>
</span><span>                <span>_configuration</span><span>[</span><span>"Authentication:Twitter:ConsumerSecret"</span><span>],</span>
</span><span>                <span>_configuration</span><span>[</span><span>"Authentication:Twitter:AccessToken"</span><span>],</span>
</span><span>                <span>_configuration</span><span>[</span><span>"Authentication:Twitter:AccessTokenSecret"</span><span>]);</span>
</span><span>
</span><span>            <span>services</span><span>.</span><span>AddSingleton</span><span>&lt;</span><span>ITwitterClient</span><span>,</span> <span>TwitterClient</span><span>&gt;();</span>
</span><span>            <span>services</span><span>.</span><span>AddHostedService</span><span>&lt;</span><span>MentionsListener</span><span>&gt;();</span>
</span><span>
</span><span>            <span>services</span><span>.</span><span>AddControllers</span><span>();</span>
</span><span>        <span>}</span>
</span><span>
</span><span>        <span>public</span> <span>void</span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> <span>app</span><span>,</span> <span>IWebHostEnvironment</span> <span>env</span><span>)</span>
</span><span>        <span>{</span>
</span><span>            <span>if</span> <span>(</span><span>env</span><span>.</span><span>IsDevelopment</span><span>())</span>
</span><span>            <span>{</span>
</span><span>                <span>app</span><span>.</span><span>UseDeveloperExceptionPage</span><span>();</span>
</span><span>            <span>}</span>
</span><span>
</span><span>            <span>app</span><span>.</span><span>UseHttpsRedirection</span><span>()</span>
</span><span>                <span>.</span><span>UseRouting</span><span>()</span>
</span><span>                <span>.</span><span>UseAuthorization</span><span>()</span>
</span><span>                <span>.</span><span>UseEndpoints</span><span>(</span><span>endpoints</span> <span>=&gt;</span> <span>endpoints</span><span>.</span><span>MapControllers</span><span>());</span>
</span><span>        <span>}</span>
</span><span>    <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><div><p>The <code>Startup</code> class is instantiated with an instance of the <code>IConfiguration</code> class, which is stored in a class-scoped variable. By convention, there are two common methods in a startup class:</p>
<table>
<tbody>
<tr>
<td colspan="1">
<p>Method</p>
</td>
<td colspan="1">
<p>Description</p>
</td>
</tr>
<tr>
<td colspan="1">
<p><code>ConfigureServices</code></p>
</td>
<td colspan="1">
<p>Adds services to a service collection for the purpose of dependency injection</p>
</td>
</tr>
<tr>
<td colspan="1">
<p><code>Configure</code></p>
</td>
<td colspan="1">
<p>Configures services for use</p>
</td>
</tr>
</tbody>
</table>
<p>The <code>ConfigureServices</code> method maps <code>Settings</code> to the <code>_configuration</code> instance. Using the <code>_configuration</code> object, several values for Twitter authentication are assigned to the static properties of <a href="https://github.com/linvi/tweetinvi/wiki/Authentication">Tweetinvi.Auth</a>.</p>
<p>Next, a singleton instance of the <code>ITwitterClient</code> interface is registered in the <code>services</code> collection using the corresponding implementation in <code>TwitterClient</code>. This will ensure that the application only ever has one single instance of the implementation available through <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1">Dependency Injection</a>. The <code>MentionsListener</code> class is registered as a hosted service and the standard <code>AddControllers</code> function is used to ensure all the Web API controller services are available.</p>
<p>The <code>Configure</code> method body is where services are configured. If the environment is "Development", the developer exception page is added and this is standard procedure. Next, HTTPs redirection, routing, and authorization are all added as well. Finally, the endpoints are configured by mapping to the application’s controllers.</p>
<h3>Define the Settings class</h3>
<p>In the code you just created, the <code>Settings</code> class is mapped to the configuration. This is a simple property bag with a few things of interest: These properties map from either the JSON configuration in the <em>appsettings.json</em>&nbsp;file, or environment variables. With these mappings, they’re available as part of dependency injection when asking for an <code>IOptions&lt;Settings&gt;</code> instance. Each instance of the <code>Settings</code> class is provided by the framework middleware in fully-populated form through constructor injection.</p>
<p>Replace the contents of the <em>Settings.cs</em>&nbsp;file in the <em>Options</em>&nbsp;directory with the following C# code:</p></div></div>
<div>

<div>
    <div><pre><span><span>namespace</span> <span>TwilioHeartsTwitter.Options</span>
</span><span><span>{</span>
</span><span>    <span>public</span> <span>class</span> <span>Settings</span>
</span><span>    <span>{</span>
</span><span>        <span>/// &lt;summary&gt;</span>
</span><span>        <span>/// The primary Twilio account SID, displayed prominently on your twilio.com/console dashboard.</span>
</span><span>        <span>/// &lt;/summary&gt;</span>
</span><span>        <span>public</span> <span>string</span> <span>TwilioAccountSid</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>        
</span><span>        <span>/// &lt;summary&gt;</span>
</span><span>        <span>/// The auth token for your primary Twilio account, hidden on your twilio.com/console dashboard.</span>
</span><span>        <span>/// &lt;/summary&gt;</span>
</span><span>        <span>public</span> <span>string</span> <span>TwilioAuthToken</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>
</span><span>        <span>/// &lt;summary&gt;</span>
</span><span>        <span>/// The Twilio phone number to text from (in the following format: +12345678900).</span>
</span><span>        <span>/// &lt;/summary&gt;</span>
</span><span>        <span>public</span> <span>string</span> <span>TwilioFromPhoneNumber</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>
</span><span>        <span>/// &lt;summary&gt;</span>
</span><span>        <span>/// The user's phone number to send texts to (in the following format: +12345678900).</span>
</span><span>        <span>/// &lt;/summary&gt;</span>
</span><span>        <span>public</span> <span>string</span> <span>ToPhoneNumber</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>
</span><span>        <span>/// &lt;summary&gt;</span>
</span><span>        <span>/// The amount of time to wait between Twitter API mention timeline calls.</span>
</span><span>        <span>/// &lt;/summary&gt;</span>
</span><span>        <span>public</span> <span>int</span> <span>DelayBetweenMentionCalls</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> <span>60</span><span>_000</span><span>;</span>
</span><span>
</span><span>        <span>/// &lt;summary&gt;</span>
</span><span>        <span>/// The user's twitter handle to monitor for mentions (exclude the @ prefix).</span>
</span><span>        <span>/// &lt;/summary&gt;</span>
</span><span>        <span>public</span> <span>string</span> <span>TwitterHandle</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>    <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><div><p>This is a POCO, a “plain ol’ class object,” so it doesn’t require a single <code>using</code> directive.</p>
<h3>Create the Twitter client</h3>
<p>The <code>ITwitterClient</code> interface represents the intentions this application will use from Twitter. Copy and paste the following C# code into the <em>ITwitterClient.cs</em>&nbsp;file:</p></div></div>
<div>

<div>
    <div><pre><span><span>using</span> <span>System.Threading.Tasks</span><span>;</span>
</span><span><span>using</span> <span>Tweetinvi.Models</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>IEvangelist.Services</span>
</span><span><span>{</span>
</span><span>    <span>public</span> <span>interface</span> <span>ITwitterClient</span>
</span><span>    <span>{</span>
</span><span>        <span>Task</span><span>&lt;</span><span>IMention</span><span>&gt;</span> <span>GetMostRecentMentionedTweetAsync</span><span>();</span>
</span><span>
</span><span>        <span>Task</span><span>&lt;</span><span>ITweet</span><span>&gt;</span> <span>RetweetMostRecentMentionAsync</span><span>();</span>
</span><span>    <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><p>This interface defines two methods. The <code>GetMostRecentMentionedTweetAsync</code> method returns a <code>Task&lt;IMention&gt;</code> and the <code>RetweetMostRecentMentionAsync</code> method returns a <code>Task&lt;ITweet&gt;</code>. While the contracts seem rather straightforward, the actual implementation is a bit more involved. Copy and paste the following C# code into the <em>TwitterClient.cs</em>` file:</p></div>
<div>

<div>
    <div><pre><span><span>using</span> <span>System</span><span>;</span>
</span><span><span>using</span> <span>System.Linq</span><span>;</span>
</span><span><span>using</span> <span>System.Threading.Tasks</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Logging</span><span>;</span>
</span><span><span>using</span> <span>Tweetinvi</span><span>;</span>
</span><span><span>using</span> <span>Tweetinvi.Models</span><span>;</span>
</span><span><span>using</span> <span>Tweetinvi.Parameters</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>TwilioHeartsTwitter.Services</span>
</span><span><span>{</span>
</span><span>    <span>public</span> <span>class</span> <span>TwitterClient</span> <span>:</span> <span>ITwitterClient</span>
</span><span>    <span>{</span>
</span><span>        <span>readonly</span> <span>ILogger</span><span>&lt;</span><span>TwitterClient</span><span>&gt;</span> <span>_logger</span><span>;</span>
</span><span>        <span>long?</span> <span>_lastMentionId</span> <span>=</span> <span>null</span><span>;</span>
</span><span>
</span><span>        <span>public</span> <span>TwitterClient</span><span>(</span><span>ILogger</span><span>&lt;</span><span>TwitterClient</span><span>&gt;</span> <span>logger</span><span>)</span> <span>=&gt;</span> <span>_logger</span> <span>=</span> <span>logger</span><span>;</span>
</span><span>
</span><span>        <span>async</span> <span>Task</span><span>&lt;</span><span>IMention</span><span>&gt;</span> <span>ITwitterClient</span><span>.</span><span>GetMostRecentMentionedTweetAsync</span><span>()</span>
</span><span>        <span>{</span>
</span><span>            <span>var</span> <span>mentions</span> <span>=</span> <span>await</span> <span>Task</span><span>.</span><span>Run</span><span>(()</span> <span>=&gt;</span>
</span><span>            <span>{</span>
</span><span>                <span>var</span> <span>parameters</span> <span>=</span> <span>new</span> <span>MentionsTimelineParameters</span>
</span><span>                <span>{</span>
</span><span>                    <span>MaximumNumberOfTweetsToRetrieve</span> <span>=</span> <span>1</span><span>,</span>
</span><span>                    <span>TrimUser</span> <span>=</span> <span>false</span>
</span><span>                <span>};</span>
</span><span>
</span><span>                <span>if</span> <span>(</span><span>_lastMentionId</span><span>.</span><span>HasValue</span><span>)</span>
</span><span>                <span>{</span>
</span><span>                    <span>parameters</span><span>.</span><span>SinceId</span> <span>=</span> <span>_lastMentionId</span><span>.</span><span>Value</span><span>;</span>
</span><span>                <span>}</span>
</span><span>
</span><span>                <span>return</span> <span>Timeline</span><span>.</span><span>GetMentionsTimeline</span><span>(</span><span>parameters</span><span>);</span>
</span><span>            <span>});</span>
</span><span>
</span><span>            <span>var</span> <span>mostRecentMention</span> <span>=</span>
</span><span>                <span>mentions</span><span>?.</span><span>OrderByDescending</span><span>(</span><span>mention</span> <span>=&gt;</span> <span>mention</span><span>.</span><span>CreatedAt</span><span>)</span>
</span><span>                        <span>.</span><span>FirstOrDefault</span><span>();</span>
</span><span>
</span><span>
</span><span>            <span>if</span> <span>(</span><span>mostRecentMention</span> <span>!=</span> <span>null</span><span>)</span>
</span><span>            <span>{</span>
</span><span>                <span>_lastMentionId</span> <span>=</span> <span>mostRecentMention</span><span>.</span><span>Id</span><span>;</span>
</span><span>            <span>}</span>
</span><span>
</span><span>            <span>return</span> <span>mostRecentMention</span><span>;</span>
</span><span>        <span>}</span>
</span><span>
</span><span>        <span>Task</span><span>&lt;</span><span>ITweet</span><span>&gt;</span> <span>ITwitterClient</span><span>.</span><span>RetweetMostRecentMentionAsync</span><span>()</span>
</span><span>        <span>{</span>
</span><span>            <span>try</span>
</span><span>            <span>{</span>
</span><span>                <span>return</span> <span>Task</span><span>.</span><span>Run</span><span>(()</span> <span>=&gt;</span> <span>Tweet</span><span>.</span><span>PublishRetweet</span><span>(</span><span>_lastMentionId</span><span>.</span><span>Value</span><span>));</span>
</span><span>            <span>}</span>
</span><span>            <span>catch</span> <span>(</span><span>Exception</span> <span>ex</span><span>)</span>
</span><span>            <span>{</span>
</span><span>                <span>_logger</span><span>.</span><span>LogError</span><span>(</span><span>ex</span><span>.</span><span>Message</span><span>,</span> <span>ex</span><span>);</span>
</span><span>                <span>return</span> <span>Task</span><span>.</span><span>FromResult</span><span>&lt;</span><span>ITweet</span><span>&gt;(</span><span>null</span><span>);</span>
</span><span>            <span>}</span>
</span><span>        <span>}</span>
</span><span>    <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><div><p>The constructor takes an <code>ILogger&lt;TwitterClient&gt;</code> instance and assigns it to a class-scoped variable.</p>
<p>The implementation of the <code>GetMostRecentMentionedTweetAsync</code> function starts by declaring a <code>mentions</code> variable that is assigned to the invocation of a <code>Task.Run</code> lambda expression. Within the lambda expression several parameters are instantiated and the state of the <code>_lastMentionId</code> variable is evaluated. If it has a value, it is used as the <code>SinceId</code> for the parameter set.</p>
<p>The call to <code>Timeline.GetMentionsTimeline</code> from the TweetinviAPI library accepts the parameters and returns the last several mentions. The results are then ordered descending by their <code>CreatedAt</code> date, ensuring that the most recent mention is at the top. From the ordered mentions, a filter is applied capturing the first in the list or to the default, which would be <code>null</code> in this case. If the most recent mention is not <code>null</code> its <code>Id</code> is assigned to the <code>_lastMentionId</code>. Since this implementation was registered as a singleton, it is safe to maintain state in this manner without too much concern.</p>
<p>Next, the <code>RetweetMostRecentMentionAsync</code> function will try to retweet the <code>_lastMentionId</code>, if available, using the <code>Tweet.PublishRetweet</code> function. If it is not available, or there was an errant condition, the error is handled gracefully by logging the message. This is truly exceptional, and the call would have never been invoked in this order without first having a mention in the application state.</p>
<h3>Create the Mentions Listener</h3>
<p>The Twitter client capabilities enable a polling architecture, where mentions can occasionally be requested. Copy and paste the following code into the <em>MentionsListener.cs</em>&nbsp;file:</p></div></div>
<div>

<div>
    <div><pre><span><span>using</span> <span>System</span><span>;</span>
</span><span><span>using</span> <span>System.Threading</span><span>;</span>
</span><span><span>using</span> <span>System.Threading.Tasks</span><span>;</span>
</span><span><span>using</span> <span>TwilioHeartsTwitter.Options</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Hosting</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Logging</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Options</span><span>;</span>
</span><span><span>using</span> <span>Twilio</span><span>;</span>
</span><span><span>using</span> <span>Twilio.Rest.Api.V2010.Account</span><span>;</span>
</span><span><span>using</span> <span>Twilio.Types</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>TwilioHeartsTwitter.Services</span>
</span><span><span>{</span>
</span><span>    <span>public</span> <span>class</span> <span>MentionsListener</span> <span>:</span> <span>BackgroundService</span>
</span><span>    <span>{</span>
</span><span>        <span>readonly</span> <span>ILogger</span><span>&lt;</span><span>MentionsListener</span><span>&gt;</span> <span>_logger</span><span>;</span>
</span><span>        <span>readonly</span> <span>Settings</span> <span>_settings</span><span>;</span>
</span><span>        <span>readonly</span> <span>ITwitterClient</span> <span>_twitterClient</span><span>;</span>
</span><span>
</span><span>        <span>public</span> <span>MentionsListener</span><span>(</span>
</span><span>            <span>ILogger</span><span>&lt;</span><span>MentionsListener</span><span>&gt;</span> <span>logger</span><span>,</span>
</span><span>            <span>IOptions</span><span>&lt;</span><span>Settings</span><span>&gt;</span> <span>options</span><span>,</span>
</span><span>            <span>ITwitterClient</span> <span>twitterClient</span><span>)</span>
</span><span>        <span>{</span>
</span><span>            <span>_logger</span> <span>=</span> <span>logger</span><span>;</span>
</span><span>            <span>_settings</span> <span>=</span> <span>options</span><span>.</span><span>Value</span><span>;</span>
</span><span>            <span>_twitterClient</span> <span>=</span> <span>twitterClient</span><span>;</span>
</span><span>
</span><span>            <span>TwilioClient</span><span>.</span><span>Init</span><span>(</span>
</span><span>                <span>_settings</span><span>.</span><span>TwilioAccountSid</span><span>,</span>
</span><span>                <span>_settings</span><span>.</span><span>TwilioAuthToken</span><span>);</span>
</span><span>        <span>}</span>
</span><span>
</span><span>        <span>protected</span> <span>override</span> <span>async</span> <span>Task</span> <span>ExecuteAsync</span><span>(</span><span>CancellationToken</span> <span>stoppingToken</span><span>)</span>
</span><span>        <span>{</span>
</span><span>            <span>long</span> <span>lastId</span> <span>=</span> <span>0</span><span>;</span>
</span><span>            <span>while</span> <span>(!</span><span>stoppingToken</span><span>.</span><span>IsCancellationRequested</span><span>)</span>
</span><span>            <span>{</span>
</span><span>                <span>try</span>
</span><span>                <span>{</span>
</span><span>                    <span>// Rate limited to 75 calls per 15 minutes, 5 calls per minute.</span>
</span><span>                    <span>// We rely on the configured delay: DelayBetweenMentionCalls...</span>
</span><span>                    <span>var</span> <span>mention</span> <span>=</span> <span>await</span> <span>_twitterClient</span><span>.</span><span>GetMostRecentMentionedTweetAsync</span><span>();</span>
</span><span>                    <span>if</span> <span>(</span><span>mention</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>lastId</span> <span>!=</span> <span>mention</span><span>.</span><span>Id</span><span>)</span>
</span><span>                    <span>{</span>
</span><span>                        <span>if</span> <span>(</span><span>mention</span><span>.</span><span>FullText</span>
</span><span>                                   <span>.</span><span>Contains</span><span>(</span><span>_settings</span><span>.</span><span>TwitterHandle</span><span>,</span> <span>StringComparison</span><span>.</span><span>OrdinalIgnoreCase</span><span>))</span>
</span><span>                        <span>{</span>
</span><span>                            <span>_</span> <span>=</span> <span>await</span> <span>MessageResource</span><span>.</span><span>CreateAsync</span><span>(</span>
</span><span>                                <span>body</span><span>:</span> <span>$</span><span>"{mention.Url}. Someone mentioned you on Twitter! Reply with 'Yes' to retweet this..."</span><span>,</span>
</span><span>                                <span>from</span><span>:</span> <span>new</span> <span>PhoneNumber</span><span>(</span><span>_settings</span><span>.</span><span>TwilioSmsPhoneNumber</span><span>),</span>
</span><span>                                <span>to</span><span>:</span> <span>new</span> <span>PhoneNumber</span><span>(</span><span>_settings</span><span>.</span><span>ToPhoneNumber</span><span>));</span>
</span><span>
</span><span>                            <span>lastId</span> <span>=</span> <span>mention</span><span>.</span><span>Id</span><span>;</span>
</span><span>                        <span>}</span>
</span><span>                    <span>}</span>
</span><span>                <span>}</span>
</span><span>                <span>catch</span> <span>(</span><span>Exception</span> <span>ex</span><span>)</span>
</span><span>                <span>{</span>
</span><span>                    <span>_logger</span><span>.</span><span>LogError</span><span>(</span><span>ex</span><span>.</span><span>Message</span><span>,</span> <span>ex</span><span>);</span>
</span><span>                <span>}</span>
</span><span>                <span>finally</span>
</span><span>                <span>{</span>
</span><span>                    <span>await</span> <span>Task</span><span>.</span><span>Delay</span><span>(</span>
</span><span>                        <span>_settings</span><span>.</span><span>DelayBetweenMentionCalls</span><span>,</span>
</span><span>                        <span>stoppingToken</span><span>);</span>
</span><span>                <span>}</span>
</span><span>            <span>}</span>
</span><span>        <span>}</span>
</span><span>    <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><div><p>The first thing you’ll probably notice about this class is that it inherits the <code>BackgroundService</code>. This means it can override the <code>ExecuteAsync</code> function of a background service. The concept of a background service running within an ASP.NET Core Web Application has been around for a while now. Hosted services are rather powerful, as they provide a way to have an in-process means of communication between the request and response pipeline and a service that is always executing.</p>
<p>The communication channel makes it easier to share statefulness and communicate. The class declares three simple fields: a <code>_logger</code> instance, a <code>_settings</code> instance, and the implementation of the <code>ITwitterClient</code>. The constructor initializes these fields and then calls <code>TwilioClient.Init</code> using the Twilio Account SID and Auth Token required by the Twilio API.</p>
<p>The <code>ExecuteAsync</code> function takes a <code>stoppingToken</code> that is used to signal application termination. This is how the background service knows when to perform cleanup and stop executing, otherwise a continuous loop routine is executed. Before the <code>while</code> loop is initiated the <code>lastId</code> variable is assigned to <code>0</code>, then while the token has not been signaled to stop execution begins. The subroutine is as follows:</p>
<p>1. Ask the <code>_twitterClient</code> for the most recent tweet that mentioned you</p>
<p>2. If there is a mention available and it’s <code>Id</code> is not the same as the <code>lastId</code>, check to verify that the full text does in fact contain your Twitter handle</p>
<p>3. Text to the configured phone number<br>(a) Share that someone mentioned you on Twitter<br>(b) Share the Tweet URL, either at the beginning or end of the text for it to render a preview on the device<br>(c) Ask for the recipient to reply with "Yes" to retweet the mention</p>
<p>4. Store the <code>lastId<br></code></p>
<p>5. Wait for a configured amount of time</p>
<p>6. Continue with step 1 if the <code>stoppingToken</code> was not canceled</p>
<h3>Create the text message controller</h3>
<p>Now, you’re probably thinking: "Wait a second, how do I handle the SMS text message response?" Don’t worry, this is rather easy with the Twilio.AspNet.Core library. Copy and paste the following C# code into the <em>TextMessageController.cs</em>&nbsp;file:</p></div></div>
<div>

<div>
    <div><pre><span><span>using</span> <span>System</span><span>;</span>
</span><span><span>using</span> <span>System.Threading.Tasks</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Mvc</span><span>;</span>
</span><span><span>using</span> <span>Twilio.AspNet.Core</span><span>;</span>
</span><span><span>using</span> <span>Twilio.TwiML</span><span>;</span>
</span><span><span>using</span> <span>TwilioHeartsTwitter.Services</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>TwilioHeartsTwitter.Controllers</span>
</span><span><span>{</span>
</span><span><span>    [ApiController, Route("api/twitter")]</span>
</span><span>    <span>public</span> <span>class</span> <span>TextMessageController</span> <span>:</span> <span>TwilioController</span>
</span><span>    <span>{</span>
</span><span>        <span>readonly</span> <span>ITwitterClient</span> <span>_twitterClient</span><span>;</span>
</span><span>
</span><span>        <span>public</span> <span>TextMessageController</span><span>(</span><span>ITwitterClient</span> <span>twitterClient</span><span>)</span>
</span><span>            <span>=&gt;</span> <span>_twitterClient</span> <span>=</span> <span>twitterClient</span><span>;</span>
</span><span>
</span><span><span>        [HttpPost, Route("retweet")]</span>
</span><span>        <span>public</span> <span>async</span> <span>ValueTask</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span> <span>HandleTwilioWebhook</span><span>()</span>
</span><span>        <span>{</span>
</span><span>            <span>var</span> <span>requestBody</span> <span>=</span> <span>Request</span><span>.</span><span>Form</span><span>[</span><span>"Body"</span><span>];</span>
</span><span>
</span><span>            <span>var</span> <span>response</span> <span>=</span> <span>new</span> <span>MessagingResponse</span><span>();</span>
</span><span>            <span>if</span> <span>(</span><span>string</span><span>.</span><span>Equals</span><span>(</span><span>"Yes"</span><span>,</span> <span>requestBody</span><span>,</span> <span>StringComparison</span><span>.</span><span>OrdinalIgnoreCase</span><span>))</span>
</span><span>            <span>{</span>
</span><span>                <span>await</span> <span>_twitterClient</span><span>.</span><span>RetweetMostRecentMentionAsync</span><span>();</span>
</span><span>                <span>response</span><span>.</span><span>Message</span><span>(</span><span>"Done!"</span><span>);</span>
</span><span>            <span>}</span>
</span><span>
</span><span>            <span>return</span> <span>TwiML</span><span>(</span><span>response</span><span>);</span>
</span><span>        <span>}</span>
</span><span>    <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>
</div>
<div><div><p>This controller inherits the <code>TwilioController</code>, which exposes the base function called <code>TwiML</code> which accepts a <code>MessageResponse</code> instance. This controller uses the same instance of the <code>ITwitterClient</code> implementation registered as a singleton and it has one simple API endpoint, <em>api/twitter/retweet</em>. This endpoint is actually the Twilio webhook, which is configured in the Twilio Console for Programmable SMS. You won’t need to make any changes to your Twilio phone number for this to work properly.</p>
<p>When the configured phone number receives text messages the webhook is invoked. The request body contains the text message, and as you can see it's relatively easy; if the response is "yes", ask the <code>_twitterClient</code> to retweet the most recent mention and reply with "Done".</p>
<h2>Deploying the completed application to Azure</h2>
<p>The application compiles successfully and will run on your local machine. You may even get an SMS message if someone has mentioned you on Twitter recently. But for the complete process to function correctly the app will need to be deployed to an environment where the <em>api/twitter</em>&nbsp;endpoint defined in <code>TextMessageController</code> can be seen by the Twitter API.</p>
<p>An Azure App Service is a great place to do this, and you can publish the app directly from Visual Studio 2019. Follow <a href="https://docs.microsoft.com/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2019">these instructions</a>&nbsp;to publish this application to Azure.</p>
<p>To complete the deployment you’ll need to set the environment variables in Azure. To do this, open the <a href="https://portal.azure.com/">Azure portal</a>&nbsp;and navigate to the <em>App Services</em>&nbsp;resource that you created during the publish process. Select the <em>Configuration</em>&nbsp;blade under the <em>Settings</em>&nbsp;node. Then click + New application setting&nbsp;to configure environment variables.</p>
<p>Enter name/value pairs for each of the environment variables you created on your local machine. Add each of the following names and their corresponding values:</p>
<ul>
<li>Authentication__Twitter__ConsumerKey</li>
<li>Authentication__Twitter__ConsumerSecret</li>
<li>Authentication__Twitter__AccessToken</li>
<li>Authentication__Twitter__AccessTokenSecret</li>
<li>TWILIO_ACCOUNT_SID</li>
<li>TWILIO_AUTH_TOKEN</li>
<li>TWILIO_SMS_PHONE_NUMBER</li>
<li>TO_PHONE_NUMBER</li>
<li>TWITTER_HANDLE</li>
</ul>
<p>Once all of these name/value pairs have been assigned, click the Save&nbsp;button to restart your App Service instance.</p>
<h2>Testing the completed application</h2>
<div><p>After the app is published and configured it will execute&nbsp;automatically. </p><p>While executing, and if anyone mentions you on Twitter, expect some text messages from Twilio. Respond to them with "Yes" and those mentions will automatically be retweeted. Here is an example of this sequence in action:</p></div>
<p>Someone mentions you on Twitter.</p>
<p><img alt="Twitter mobile application screenshot" height="178" sizes="500px" src="https://twilio-cms-prod.s3.amazonaws.com/images/X068xIiJO7xXU8j3vVzBTmeLT5ap4WRl_d5BaHiiJjnINq.width-500.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/X068xIiJO7xXU8j3vVzBTmeLT5ap4WRl_d5BaHiiJjnINq.width-500.png 500w, https://twilio-cms-prod.s3.amazonaws.com/images/X068xIiJO7xXU8j3vVzBTmeLT5ap4WRl_d5BaHiiJjnIN.width-1000.png 598w" width="500"></p>
<p>You get a text message letting you know that someone mentioned you, and you can preview the Tweet on your device.</p>
<p><img alt="Mobile phone SMS text application screenshot" height="970" sizes="448px" src="https://twilio-cms-prod.s3.amazonaws.com/images/w4sn8p7QaUHXCUgL5cYx0nrDeH6b-1006R8upQwgyTffNN.width-500.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/w4sn8p7QaUHXCUgL5cYx0nrDeH6b-1006R8upQwgyTffNN.width-500.png 448w, https://twilio-cms-prod.s3.amazonaws.com/images/w4sn8p7QaUHXCUgL5cYx0nrDeH6b-1006R8upQwgyTffN.width-1000.png 448w" width="448"></p>
<p>After you reply with "Yes", the Tweet will be retweeted on your behalf.</p>
<p><img alt="Mobile phone Twitter app screenshot" height="251" sizes="500px" src="https://twilio-cms-prod.s3.amazonaws.com/images/PS_SzN56_dlKeJvTTum9B6IgYKLc81fBsiV_F1867fD-yV.width-500.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/PS_SzN56_dlKeJvTTum9B6IgYKLc81fBsiV_F1867fD-yV.width-500.png 500w, https://twilio-cms-prod.s3.amazonaws.com/images/PS_SzN56_dlKeJvTTum9B6IgYKLc81fBsiV_F1867fD-y.width-1000.png 598w" width="500"></p>
<p>If this works using your phone and Twitter handle you’ve successfully built a new way to power-up your social media presence. Good job: fame awaits!</p>
<h2>Summary</h2>
<p>Now that you’ve finished building and deploying the project in this post you have covered a lot of ground. You’ve set up a Twitter application so you can access and manipulate tweets using the Twitter API. You have configured a Twilio phone number to send and receive SMS messages programmatically. You’ve built an ASP.NET Core Web Application that exposes a REST API, and you’ve deployed the app to an Azure App Service so it will always be available. Now you have a system that notifies you by text message when someone mentions you on Twitter so you can retweet with a quick text response.</p>
<p>You can see how this application could scale for someone who is managing a company or institutional Twitter account. By responsively retweeting the right mentions the account manager can work on the go when it might not always be convenient to use mobile or desktop apps.</p>
<h2>Additional resources</h2>
<p>The <a href="https://github.com/IEvangelist/IEvangelist.Retweet">companion repository</a>&nbsp;on GitHub includes a branch with one possible approach to caching results and managing SMS status callbacks.</p>
<p><a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/">Asynchronous programming with async and await</a>&nbsp;– an excellent introduction to asynchronous programming in the <em>C# Programming Guide</em>&nbsp;on docs.microsoft.com.</p>
<p><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1">Dependency injection in ASP.NET Core</a>&nbsp;– docs.microsoft.com information about the dependence injection middleware used in this application.</p>
<p><a href="https://github.com/linvi/tweetinvi">Tweetinvi</a>&nbsp;– Learn more about this C# .NET library that wraps the Twitter REST API, and consider making a <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=4W8BCYB4FVSN6">donation</a>&nbsp;in support of this software provided under an MIT License.</p>
<p><a href="https://www.twilio.com/docs/sms">Twilio Docs: Programmable SMS</a>&nbsp;– Quickstarts for a number of languages, tutorials, and complete API reference documentation.</p>
<p><a href="https://www.twilio.com/quest">TwilioQuest</a>&nbsp;– Do something to brag about on Twitter: play TQ3, discover your power to change the world with code, and help plant trees in Australia all at the same time.</p>
<p><em>David Pine is a 2x <a href="https://mvp.microsoft.com/en-us/publicprofile/5002736">Microsoft MVP</a>, <a href="https://developers.google.com/experts/people/david-pine">Google Developer Expert</a>, <a href="https://www.twilio.com/champions">Twilio Champion</a>, <a href="https://davidpine.net/speaking/">international speaker</a>,&nbsp;and works in Developer Relations at Microsoft. You can follow him on Twitter at <a href="https://twitter.com/davidpine7">@davidpine7</a>. Be sure to check out his blog at <a href="https://davidpine.net/">https://davidpine.net</a>.</em></p></div></div>
    

    


    
      




    
  </section>
</article>


    
    

        
          </ul>
        
      </section>
    </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>