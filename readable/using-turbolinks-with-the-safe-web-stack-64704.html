<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using Turbolinks with the SAFE web stack - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Using Turbolinks with the SAFE web stack - linksfor.dev(s)"/>
    <meta property="article:author" content="Viktor Andersson"/>
    <meta property="og:description" content="&#x201C;Do you really need a single-page application for that?&#x201D;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://viktorvan.github.io/fsharp/safe-stack-turbolinks/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Using Turbolinks with the SAFE web stack</title>
<div class="readable">
        <h1>Using Turbolinks with the SAFE web stack</h1>
            <div>by Viktor Andersson</div>
            <div>Reading time: 18-23 minutes</div>
        <div>Posted here: 23 Jul 2020</div>
        <p><a href="https://viktorvan.github.io/fsharp/safe-stack-turbolinks/">https://viktorvan.github.io/fsharp/safe-stack-turbolinks/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><section itemprop="text">
        
          
        
        <p>“Do you really need a single-page application for that?”</p>

<h3 id="background---what-is-turbolinks">Background - What is Turbolinks?<a href="#background---what-is-turbolinks" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>Turbolinks is a javascript library that gives your web application the look and feel of a single-page application, without really being one. The idea is that it intercepts any navigation and instead of reloading the page at that point, it fetches the page in the background and just switches the whole html &lt;body&gt; from response with the current body. A little simplified of course.</p>

<p>From the Turbolinks documentation:</p>

<blockquote>
  <p>Turbolinks® makes navigating your web application faster. Get the performance benefits of a single-page application without the added complexity of a client-side JavaScript framework. Use HTML to render your views on the server side and link to pages as usual. When you follow a link, Turbolinks automatically fetches the page, swaps in its &lt;body&gt;, and merges its &lt;head&gt;, all without incurring the cost of a full page load.</p>
</blockquote>

<p>Turbolinks can be a good compromise when only a little interactivity is needed on the frontend, and you don’t want to setup a full single page application. It gives the user the feel a single-page application, but most of the business logic can be kept server-side.</p>

<p>I was previously using Elmish for this application, and so far I prefer this “simpler” solution I ended up with when using Turbolinks. But I should say that this is a quite simple application. If there is a lot of stuff going on the client-side I wouldn’t hesitate to use Elmish. Or maybe a hybrid approach with Turbolinks for most of the application and the <a href="https://zaid-ajaj.github.io/Feliz/#/Hooks/UseElmish">Feliz.UseElmish</a> React hook for any complicated components.</p>

<p>Turbolinks is originally a Ruby on Rails feature, but it really is just a javascript library that you load on your client, so you can use it with any webstack that uses javascript on the frontend<sup id="fnref:1"><a href="#fn:1">1</a></sup>. In this example I am using the F# <a href="https://safe-stack.github.io/">SAFE webstack</a> with <a href="https://saturnframework.org/">Saturn</a>/<a href="https://github.com/giraffe-fsharp/Giraffe">Giraffe</a>, if you for some reason prefer to work with something else, maybe C# and ASP.NET Core MVC it is still possible to benefit from using Turbolinks, of course.</p>

<h3 id="the-demo-application">The demo application<a href="#the-demo-application" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>The demo application is a simplified version of an application I am using to keep track of how many eggs my chickens are laying. It is a very simple application where you can select a date and see what chickens that have laid an egg that day. You can also add/remove eggs; click on a chicken to add an egg, click on an egg to remove it. At the bottom we display some totals. Simple as that.</p>

<p><img src="https://viktorvan.github.io/assets/images/safe-turbolinks-demo-application.gif" alt="demo application"></p>

<p>The complete demo application is available on <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo">github</a>.</p>

<h3 id="our-goals">Our goals<a href="#our-goals" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>So the goals we are reaching for with our Turbolinks enabled application is to:</p>

<ol>
  <li>Render all html on the server.</li>
  <li>Navigate different dates: use Turbolinks to out-of-the-box handle page navigation.</li>
  <li>Edit data (add/remove eggs): use add some client side interactivity with javascript (or fable, rather).</li>
  <li>Deal with redirects</li>
</ol>

<h3 id="step-1-render-all-html-on-the-server">Step 1. Render all html on the server<a href="#step-1-render-all-html-on-the-server" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>I started out with an existing elmish application, so I was previously rendering the views with Fable, using <a href="https://zaid-ajaj.github.io/Feliz/">Feliz</a> and <a href="https://dzoukr.github.io/Feliz.Bulma/">Feliz.Bulma</a>. The client was then using <a href="https://zaid-ajaj.github.io/Fable.Remoting/">Fable.Remoting</a> to load and save data from the backend. 
The interface for the Fable.Remoting api was initially:</p>

<div><div><pre><code><span>type</span> <span>IChickenApi</span> <span>=</span>
        <span>{</span> <span>GetAllChickens</span><span>:</span> <span>NotFutureDate</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>Chicken</span> <span>list</span><span>&gt;</span>
          <span>GetEggCount</span><span>:</span> <span>NotFutureDate</span> <span>*</span> <span>ChickenId</span> <span>list</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>Map</span><span>&lt;</span><span>ChickenId</span><span>,</span> <span>EggCount</span><span>&gt;&gt;</span> 
          <span>AddEgg</span><span>:</span> <span>ChickenId</span> <span>*</span> <span>NotFutureDate</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>unit</span><span>&gt;</span>
          <span>RemoveEgg</span><span>:</span> <span>ChickenId</span> <span>*</span> <span>NotFutureDate</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>unit</span><span>&gt;</span> <span>}</span>
</code></pre></div></div>

<p>For completeness, here are the types it’s using</p>
<div><div><pre><code><span>type</span> <span>ChickenId</span> <span>=</span> <span>ChickenId</span> <span>of</span> <span>Guid</span>
<span>type</span> <span>EggCount</span> <span>=</span> <span>EggCount</span> <span>of</span> <span>int</span>
<span>type</span> <span>Chicken</span> <span>=</span>
    <span>{</span> <span>Id</span><span>:</span> <span>ChickenId</span>
      <span>Name</span><span>:</span> <span>string</span>
      <span>ImageUrl</span><span>:</span> <span>ImageUrl</span> <span>option</span>
      <span>Breed</span><span>:</span> <span>string</span> 
      <span>TotalCount</span><span>:</span> <span>EggCount</span> <span>}</span>
<span>type</span> <span>NotFutureDate</span> <span>=</span>
    <span>{</span> <span>Year</span><span>:</span> <span>int</span>
      <span>Month</span><span>:</span> <span>int</span>
      <span>Day</span><span>:</span> <span>int</span> <span>}</span>
</code></pre></div></div>

<p>In our Turbolinks application the html will be rendered on the server instead, so i need to move my views to the backend. The backend I am using (Saturn/Giraffe) has a view engine that i could use, but there is even a view engine available for <a href="https://github.com/dbrattli/feliz.viewengine">Feliz and Feliz.Bulma</a>. So that made my work really easy, I could just copy my views from the client to the server, and remove anything related to event listeners, <code>onchange</code>, <code>onselect</code>, etc.</p>

<p>This means I will no longer be needing the <code>Get...</code> functions in the <code>IChickenApi</code>. That data will now be returned as a single html view from the backend. The browser client no longer needs to be dealing with updating react views with the chicken and eggcount data returned from the api. It just needs to display the html. Simple. We are left with some edit functions that we will be using in a later step:</p>

<div><div><pre><code><span>type</span> <span>IChickenApi</span> <span>=</span>
        <span>{</span> <span>AddEgg</span><span>:</span> <span>ChickenId</span> <span>*</span> <span>NotFutureDate</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>unit</span><span>&gt;</span>
          <span>RemoveEgg</span><span>:</span> <span>ChickenId</span> <span>*</span> <span>NotFutureDate</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>unit</span><span>&gt;</span> <span>}</span>
</code></pre></div></div>

<p>And I have made the following addition in my <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/-blob/master/src/Server/Server.fs">server setup</a>:</p>

<div><div><pre><code><span>// Server.fs</span>

<span>let</span> <span>defaultRoute</span><span>()</span> <span>=</span> <span>sprintf</span> <span>"/chickens?date=%s"</span> <span>(</span><span>NotFutureDate</span><span>.</span><span>today</span><span>()</span><span>.</span><span>ToString</span><span>()</span><span>)</span>
<span>let</span> <span>browser</span> <span>=</span> <span>router</span> <span>{</span>
    <span>get</span> <span>"/"</span> <span>(</span><span>redirectTo</span> <span>false</span> <span>(</span><span>defaultRoute</span><span>()</span><span>))</span>
    <span>get</span> <span>"/chickens"</span> <span>chickensView</span>
<span>}</span>
</code></pre></div></div>

<p>where <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/src/Server/Views/Chickens.fs">chickensView</a> renders the html.</p>

<p>We can now navigate the application as a normal server application and use the arrow buttons to change date. We cannot use the datepicker yet though, or add/remove eggs, since that requires some javascript on the client side. We will fix that in later steps.</p>

<h3 id="step-2-navigate-dates-using-turbolinks">Step 2. Navigate dates using Turbolinks<a href="#step-2-navigate-dates-using-turbolinks" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>To enable Turbolinks you could just add it in a script tag in your html head:</p>
<div><div><pre><code><span>&lt;script </span><span>src=</span><span>"https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.1.1/turbolinks.js"</span><span>&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>but since I will be adding some javascript of my own and will be creating my own javascript bundle, I will <a href="https://github.com/turbolinks/turbolinks#installation-using-npm">install Turbolinks with npm</a> and require it instead:</p>

<div><div><pre><code><span>npm</span> <span>install</span> <span>--save</span> <span>turbolinks</span>
</code></pre></div></div>

<div><div><pre><code><span>// Turbolinks.fs</span>
<span>module</span> <span>Client</span><span>.</span><span>Turbolinks</span>

<span>open</span> <span>Fable</span><span>.</span><span>Core</span><span>.</span><span>JsInterop</span>

<span>type</span> <span>private</span> <span>ITurbolinksLib</span> <span>=</span>
    <span>abstract</span> <span>start</span> <span>:</span> <span>unit</span> <span>-&gt;</span> <span>unit</span>
    <span>abstract</span> <span>clearCache</span> <span>:</span> <span>unit</span> <span>-&gt;</span> <span>unit</span>
    <span>abstract</span> <span>visit</span> <span>:</span> <span>string</span> <span>-&gt;</span> <span>unit</span>

<span>let</span> <span>private</span> <span>turbolinks</span> <span>:</span> <span>ITurbolinksLib</span> <span>=</span> <span>importDefault</span> <span>"turbolinks"</span>

<span>let</span> <span>start</span><span>()</span> <span>=</span> <span>turbolinks</span><span>.</span><span>start</span><span>()</span>
<span>let</span> <span>visit</span> <span>url</span> <span>=</span> <span>turbolinks</span><span>.</span><span>visit</span> <span>url</span>
<span>let</span> <span>reset</span><span>()</span> <span>=</span>
    <span>turbolinks</span><span>.</span><span>clearCache</span><span>()</span>
    <span>turbolinks</span><span>.</span><span>visit</span> <span>""</span>
</code></pre></div></div>

<p>then, in my client <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/src/Client/App.fs">entry-point</a> I add</p>
<div><div><pre><code><span>// App.fs</span>
<span>Turbolinks</span><span>.</span><span>start</span><span>()</span>
</code></pre></div></div>

<p>If I run the app now, and try to navigate using the navigation arrows, there are no longer any page reloads in the browser. Scripts and css are only loaded on the first page load. Turbolinks is doing it’s magic and intercepting navigation events and loading the data in the background. It also caches any visited pages, and will display the cached version while loading new data from the server.</p>

<h4 id="step-2b-dealing-with-permanent-elements">Step 2b. Dealing with “permanent” elements<a href="#step-2b-dealing-with-permanent-elements" title="Permalink"><span>Permalink</span><i></i></a></h4>

<p>For this example i have added a navbar to the application, it displays the version of the application. On a narrow screen the link will be replaced with a burger menu button which the user can choose to expand. Except, there is no longer any javascript that expands that menu since I removed everything from the Elmish application. Let’s add that functionality back again<sup id="fnref:2"><a href="#fn:2">2</a></sup>:</p>

<p>First we need to setup webpack to bundle our client scripts. I am using the webpack.config.js generated by the <a href="https://safe-stack.github.io/docs/template-overview/">safe-template</a> as starting point. Since we no longer will be running the client as a single page application I remove all the sections related to the webpack-dev-server. Also, we won’t be serving an index.html directly, that is going to be rendered by our server, so I remove the index.html file and the HtmlWebpackPlugin. This is my resulting <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/webpack.config.js">webpack.config.js</a><sup id="fnref:3"><a href="#fn:3">3</a></sup>.</p>

<p>We need to add an event listener for the navbar burger button that toggles <code>is-active</code> class on the corresponding navbar elements.</p>

<p>First some functions to toggle the classes:</p>

<div><div><pre><code><span>open</span> <span>Browser</span>

<span>let</span> <span>toggleClass</span> <span>className</span> <span>(</span><span>e</span><span>:</span> <span>Element</span><span>)</span> <span>=</span>
    <span>let</span> <span>newClasses</span> <span>=</span>
        <span>if</span> <span>e</span><span>.</span><span>className</span><span>.</span><span>Contains</span><span>(</span><span>className</span><span>)</span> <span>then</span>
            <span>e</span><span>.</span><span>className</span><span>.</span><span>Replace</span><span>(</span><span>className</span><span>,</span> <span>""</span><span>)</span>
        <span>else</span>
            <span>e</span><span>.</span><span>className</span> <span>+</span> <span>" "</span> <span>+</span> <span>className</span>
    <span>e</span><span>.</span><span>className</span> <span>&lt;-</span> <span>newClasses</span>

<span>let</span> <span>toggleNavbarMenu</span> <span>()</span> <span>=</span>
    <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>"chickencheck-navbar-burger"</span><span>)</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>ofObj</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>iter</span> <span>(</span><span>toggleClass</span> <span>"is-active"</span><span>)</span>
    <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>"chickencheck-navbar-menu"</span><span>)</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>ofObj</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>iter</span> <span>(</span><span>toggleClass</span> <span>"is-active"</span><span>)</span>
</code></pre></div></div>

<p>then, using event delegation we add the following event listener:</p>

<div><div><pre><code><span>// App.fs</span>

<span>document</span><span>.</span><span>onclick</span> <span>&lt;-</span>
    <span>fun</span> <span>ev</span> <span>-&gt;</span>
        <span>let</span> <span>target</span> <span>=</span> <span>ev</span><span>.</span><span>target</span> <span>:?&gt;</span> <span>Element</span>
        <span>if</span> <span>target</span><span>.</span><span>closest</span><span>(</span><span>".navbar-burger"</span><span>).</span><span>IsSome</span> <span>then</span>
            <span>Navbar</span><span>.</span><span>toggleNavbarMenu</span><span>()</span>
</code></pre></div></div>

<p>But we will be adding some more onclick events later on, let’s refactor this a bit. The <a href="https://fsharpforfunandprofit.com/posts/convenience-active-patterns/">Active Pattern</a> feature of F# will come in handy here, let’s define a pattern for our navbar button target:</p>

<div><div><pre><code>    <span>let</span> <span>(|</span><span>NavbarBurger</span><span>|_|)</span> <span>(</span><span>target</span><span>:</span> <span>Element</span><span>)</span> <span>=</span>
        <span>if</span> <span>target</span><span>.</span><span>closest</span><span>(</span><span>".navbar-burger"</span><span>).</span><span>IsSome</span> <span>then</span> 
            <span>Some</span> <span>NavbarBurger</span> 
        <span>else</span> 
            <span>None</span>
</code></pre></div></div>

<p>and then use it when we add the event listener:</p>

<div><div><pre><code><span>// App.fs</span>
<span>document</span><span>.</span><span>onclick</span> <span>&lt;-</span>
    <span>fun</span> <span>ev</span> <span>-&gt;</span>
        <span>match</span> <span>ev</span><span>.</span><span>target</span> <span>:?&gt;</span> <span>Element</span> <span>with</span>
        <span>|</span> <span>NavbarBurger</span> <span>-&gt;</span> <span>Navbar</span><span>.</span><span>toggleNavbarMenu</span><span>()</span>
        <span>|</span> <span>_</span> <span>-&gt;</span> <span>()</span>
</code></pre></div></div>

<p>if we try it out now, it <em>almost</em> works as expected:</p>

<p><img src="https://viktorvan.github.io/assets/images/safe-turbolinks-toggle-navbar-menu1.gif" alt="toggling navbar menu"></p>

<p>When navigating to another date, we expect that menu stays expanded, but it’s doesn’t. When Turbolinks replaces the html body with the new one it fetched from the server it will overwrite any changes we have done with javascript. But there is a solution for this, we need to mark our navbar with the <a href="https://github.com/turbolinks/turbolinks#persisting-elements-across-page-loads"><code>data-turbolinks-permanent</code></a> attribute<sup id="fnref:4"><a href="#fn:4">4</a></sup>:</p>

<div><div><pre><code>    <span>Bulma</span><span>.</span><span>navbar</span> <span>[</span>
        <span>prop</span><span>.</span><span>id</span> <span>"chickencheck-navbar"</span>
        <span>prop</span><span>.</span><span>custom</span> <span>(</span><span>"data-turbolinks-permanent"</span><span>,</span> <span>""</span><span>)</span>
        <span>// ...</span>
</code></pre></div></div>

<p>With this attribute in place Turbolinks will save that element and transfer it to the new page, preserving the data and event listeners. Now the navbar menu will stay expanded even when navigating:</p>

<p><img src="https://viktorvan.github.io/assets/images/safe-turbolinks-toggle-navbar-menu2.gif" alt="toggling navbar menu"></p>

<h4 id="step-2c-using-the-date-input-to-navigate-dates">Step 2c. Using the date input to navigate dates<a href="#step-2c-using-the-date-input-to-navigate-dates" title="Permalink"><span>Permalink</span><i></i></a></h4>

<p>Now let’s hook up the datepicker to actually do some navigation. For cross-platform styling of the date input I am using <a href="https://creativebulma.net/product/calendar">Bulma.Calendar</a>. The Bulma-calendar datepicker needs to be attached (or refreshed) every time we load the page, so we need to add some initialization code when our page is loaded. But we cannot do this in <code>window.onload</code> since with Turbolinks active this event is only triggered once on first page load. Instead we need to do our initialization in the Turbolinks custom event <code>turbolinks:load</code>:</p>

<div><div><pre><code><span>// App.fs</span>

<span>document</span><span>.</span><span>addEventListener</span><span>(</span><span>"turbolinks:load"</span><span>,</span> <span>fun</span> <span>_</span> <span>-&gt;</span>
    <span>Datepicker</span><span>.</span><span>init</span> <span>()</span><span>)</span>

<span>// Datepicker.fs</span>
<span>let</span> <span>init</span><span>()</span> <span>=</span>

    <span>let</span> <span>datepicker</span> <span>=</span> <span>getDatePickerElement</span><span>()</span>
    <span>datepicker</span><span>.</span><span>OnSelect</span><span>(</span><span>fun</span> <span>_</span> <span>-&gt;</span>
        <span>let</span> <span>date</span> <span>=</span>
            <span>datepicker</span><span>.</span><span>date</span><span>.</span><span>start</span>
            <span>|&gt;</span> <span>Option</span><span>.</span><span>ofNullable</span>
            <span>|&gt;</span> <span>Option</span><span>.</span><span>map</span> <span>NotFutureDate</span><span>.</span><span>create</span>
            <span>|&gt;</span> <span>Option</span><span>.</span><span>defaultValue</span> <span>(</span><span>NotFutureDate</span><span>.</span><span>today</span><span>()</span><span>)</span>
        <span>if</span> <span>date</span> <span>&lt;&gt;</span> <span>currentDate</span> <span>then</span>
            <span>let</span> <span>dateQueryStr</span> <span>=</span> <span>sprintf</span> <span>"?date=%s"</span> <span>(</span><span>date</span><span>.</span><span>ToString</span><span>()</span><span>)</span>
            <span>Turbolinks</span><span>.</span><span>visit</span><span>(</span><span>window</span><span>.</span><span>location</span><span>.</span><span>pathname</span> <span>+</span> <span>dateQueryStr</span><span>))</span>
    <span>)</span>
</code></pre></div></div>

<p>I have omitted and simplified a little bit here<sup id="fnref:5"><a href="#fn:5">5</a></sup>, but the gist is that we attach an event listener and if the date has changed we use Turbolinks to programmatically navigate to the page for the new date using <code>Turbolinks.visit(url)</code>. <code>visit</code> works just like if we navigated by clicking a hyperlink, if a preview is available it is displayed first while the new page is loaded in the background.</p>

<p>Now we can use the datepicker to navigate:</p>

<p><img src="https://viktorvan.github.io/assets/images/safe-turbolinks-datepicker.gif" alt="navigating with datepicker"></p>

<h3 id="step-3-edit-data">Step 3. Edit data<a href="#step-3-edit-data" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>Now let’s implement the last missing feature, adding and removing eggs for chickens.</p>

<p>With Turbolinks, when we editing data we don’t want to submit a form like in a normal web application. The suggested pattern from the <a href="https://github.com/turbolinks/turbolinks#redirecting-after-a-form-submission">Turbolinks documentation</a> is to submit the form data with XHR and then return javascript from the server that performs a <code>Turbolinks.visit(url)</code> and optionally <code>Turbolinks.clearCache()</code> if the cache needs to be cleared.</p>

<p>I.e. we need to send a request to the server, use visit to redirect to the page we want to end up at, and also clear the Turbolinks cache. I think Fable.Remoting is really convenient for client-server communication with Fable, so I will use that. Also I already had implemented a Fable.Remoting api in my Elmish version of this application.</p>

<p>The type signatures for the addEgg/removeEgg functions looks like this:</p>

<div><div><pre><code><span>type</span> <span>IChickenApi</span> <span>=</span>
        <span>{</span> <span>AddEgg</span><span>:</span> <span>ChickenId</span> <span>*</span> <span>NotFutureDate</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>unit</span><span>&gt;</span>
          <span>RemoveEgg</span><span>:</span> <span>ChickenId</span> <span>*</span> <span>NotFutureDate</span> <span>-&gt;</span> <span>Async</span><span>&lt;</span><span>unit</span><span>&gt;</span> <span>}</span>
</code></pre></div></div>

<p>When we are adding/removing eggs we need to know the id of the chicken we are performing the operation on. When rendering the html in the server this id is set as a data attribute on the chicken card and egg icon respectively. For convenience I have added a type extension to <code>Element</code> for easy access. In the same way <code>currentDate</code> is read from another data attribute:</p>

<div><div><pre><code><span>module</span> <span>DataAttributes</span> <span>=</span>
    <span>let</span> <span>parseChickenId</span> <span>(</span><span>element</span><span>:</span> <span>Element</span><span>)</span> <span>=</span>
        <span>element</span><span>?</span><span>dataset</span><span>?</span><span>chickenId</span>
        <span>|&gt;</span> <span>ChickenId</span><span>.</span><span>parse</span>

    <span>let</span> <span>parseCurrentDate</span><span>()</span> <span>=</span>
        <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>sprintf</span> <span>"[%s]"</span> <span>DataAttributes</span><span>.</span><span>CurrentDate</span><span>)?</span><span>dataset</span><span>?</span><span>currentDate</span>
        <span>|&gt;</span> <span>NotFutureDate</span><span>.</span><span>parse</span>

<span>type</span> <span>Element</span> <span>with</span>
    <span>member</span> <span>this</span><span>.</span><span>ChickenId</span> <span>=</span> <span>DataAttributes</span><span>.</span><span>parseChickenId</span><span>(</span><span>this</span><span>)</span>
</code></pre></div></div>

<p>Add new active patterns, that also returns the parsed ChickenId:</p>

<div><div><pre><code><span>let</span> <span>private</span> <span>tryGetEggIconElement</span> <span>(</span><span>target</span><span>:</span> <span>Element</span><span>)</span> <span>=</span>
    <span>target</span><span>.</span><span>closest</span><span>(</span><span>".egg-icon"</span><span>)</span>

<span>let</span> <span>(|</span><span>EggIcon</span><span>|_|)</span> <span>(</span><span>target</span><span>:</span> <span>Element</span><span>)</span> <span>=</span>
    <span>target</span>
    <span>|&gt;</span> <span>tryGetEggIconElement</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>map</span> <span>(</span><span>fun</span> <span>e</span> <span>-&gt;</span> <span>EggIcon</span> <span>e</span><span>.</span><span>ChickenId</span><span>)</span>

<span>let</span> <span>private</span> <span>tryGetChickenCardElement</span> <span>(</span><span>target</span><span>:</span> <span>Element</span><span>)</span> <span>=</span>
    <span>if</span> <span>(</span><span>tryGetEggIconElement</span> <span>target</span> <span>|&gt;</span> <span>Option</span><span>.</span><span>isSome</span><span>)</span> <span>then</span> <span>None</span>
    <span>else</span>
        <span>target</span><span>.</span><span>closest</span><span>(</span><span>".chicken-card"</span><span>)</span>

<span>let</span> <span>(|</span><span>ChickenCard</span><span>|_|)</span> <span>(</span><span>target</span><span>:</span> <span>Element</span><span>)</span> <span>=</span>
    <span>target</span>
    <span>|&gt;</span> <span>tryGetChickenCardElement</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>map</span> <span>(</span><span>fun</span> <span>e</span> <span>-&gt;</span> <span>ChickenCard</span> <span>e</span><span>.</span><span>ChickenId</span><span>)</span>
</code></pre></div></div>

<p>Hook them up in App.fs:</p>

<div><div><pre><code><span>// App.fs</span>
<span>let</span> <span>api</span> <span>:</span> <span>IChickensApi</span> <span>=</span>
    <span>Remoting</span><span>.</span><span>createApi</span><span>()</span>
    <span>|&gt;</span> <span>Remoting</span><span>.</span><span>withRouteBuilder</span> <span>Route</span><span>.</span><span>builder</span>
    <span>|&gt;</span> <span>Remoting</span><span>.</span><span>buildProxy</span><span>&lt;</span><span>IChickensApi</span><span>&gt;</span>

<span>let</span> <span>currentDate</span><span>()</span> <span>=</span> <span>DataAttributes</span><span>.</span><span>parseCurrentDate</span><span>()</span>

<span>document</span><span>.</span><span>onclick</span> <span>&lt;-</span>
    <span>fun</span> <span>ev</span> <span>-&gt;</span>
        <span>match</span> <span>ev</span><span>.</span><span>target</span> <span>:?&gt;</span> <span>element</span> <span>with</span>
        <span>|</span> <span>NavbarBurger</span> <span>-&gt;</span> <span>Navbar</span><span>.</span><span>ToggleNavbarMenu</span><span>()</span>
        <span>|</span> <span>ChickenCard</span> <span>chickenId</span> <span>-&gt;</span> <span>Chickens</span><span>.</span><span>addEgg</span> <span>api</span> <span>chickenId</span> <span>(</span><span>currentDate</span><span>()</span><span>)</span>
        <span>|</span> <span>EggIcon</span> <span>chickenId</span> <span>-&gt;</span> <span>Chickens</span><span>.</span><span>removeEgg</span> <span>api</span> <span>chickenId</span> <span>(</span><span>currentDate</span><span>()</span><span>)</span>
        <span>|</span> <span>_</span> <span>-&gt;</span> <span>()</span>
</code></pre></div></div>

<p>And the implementation of addEgg/removeEgg:</p>

<div><div><pre><code><span>let</span> <span>addEgg</span> <span>(</span><span>api</span><span>:</span> <span>IChickensApi</span><span>)</span> <span>(</span><span>scrollPosition</span><span>:</span> <span>ScrollPositionService</span><span>)</span> <span>=</span>
    <span>fun</span> <span>chickenId</span> <span>date</span> <span>-&gt;</span>
        <span>async</span> <span>{</span>
            <span>try</span>
                <span>window</span><span>.</span><span>event</span><span>.</span><span>stopPropagation</span><span>()</span>
                <span>showEggLoader</span> <span>chickenId</span>
                <span>do</span><span>!</span> <span>api</span><span>.</span><span>AddEgg</span><span>(</span><span>chickenId</span><span>,</span> <span>date</span><span>)</span>
                <span>Turbolinks</span><span>.</span><span>reset</span><span>()</span>
            <span>with</span> <span>exn</span> <span>-&gt;</span>
                <span>eprintf</span> <span>"addEgg failed: %s"</span> <span>exn</span><span>.</span><span>Message</span>
        <span>}</span>
        <span>|&gt;</span> <span>Async</span><span>.</span><span>StartImmediate</span>

<span>let</span> <span>removeEgg</span> <span>(</span><span>api</span><span>:</span> <span>IChickensApi</span><span>)</span> <span>(</span><span>scrollPosition</span><span>:</span> <span>ScrollPositionService</span><span>)</span> <span>=</span>
    <span>fun</span> <span>chickenId</span> <span>date</span> <span>-&gt;</span>
        <span>async</span> <span>{</span>
            <span>try</span>
                <span>window</span><span>.</span><span>event</span><span>.</span><span>stopPropagation</span><span>()</span>
                <span>hideEggIcon</span> <span>chickenId</span>
                <span>showEggLoader</span> <span>chickenId</span>
                <span>do</span><span>!</span> <span>api</span><span>.</span><span>RemoveEgg</span><span>(</span><span>chickenId</span><span>,</span> <span>date</span><span>)</span>
                <span>Turbolinks</span><span>.</span><span>reset</span><span>()</span>
            <span>with</span> <span>exn</span> <span>-&gt;</span>
                <span>eprintf</span> <span>"removeEgg failed: %s"</span> <span>exn</span><span>.</span><span>Message</span>
        <span>}</span>
        <span>|&gt;</span> <span>Async</span><span>.</span><span>StartImmediate</span>
</code></pre></div></div>

<p><code>hideEggIcon</code> / <code>showEggLoader</code> are helper functions to show a loading spinner while waiting for the response from the server:</p>

<div><div><pre><code><span>let</span> <span>private</span> <span>hideEggIcon</span> <span>(</span><span>id</span><span>:</span> <span>ChickenId</span><span>)</span> <span>=</span>
    <span>let</span> <span>selector</span> <span>=</span> <span>sprintf</span> <span>".egg-icon[%s]"</span> <span>(</span><span>DataAttributes</span><span>.</span><span>chickenIdStr</span> <span>id</span><span>)</span>
    <span>document</span><span>.</span><span>querySelector</span> <span>selector</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>ofObj</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>iter</span> <span>(</span><span>HtmlHelper</span><span>.</span><span>toggleClass</span> <span>"is-hidden"</span><span>)</span>

<span>let</span> <span>private</span> <span>showEggLoader</span> <span>(</span><span>id</span><span>:</span> <span>ChickenId</span><span>)</span> <span>=</span>
    <span>let</span> <span>selector</span> <span>=</span> <span>sprintf</span> <span>".egg-icon-loader[%s]"</span> <span>(</span><span>DataAttributes</span><span>.</span><span>chickenIdStr</span> <span>id</span><span>)</span>
    <span>document</span><span>.</span><span>querySelector</span> <span>selector</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>ofObj</span>
    <span>|&gt;</span> <span>Option</span><span>.</span><span>iter</span> <span>(</span><span>HtmlHelper</span><span>.</span><span>toggleClass</span> <span>"is-hidden"</span><span>)</span>
</code></pre></div></div>

<h4 id="step-3b-saving-scroll-position">Step 3b. Saving scroll position<a href="#step-3b-saving-scroll-position" title="Permalink"><span>Permalink</span><i></i></a></h4>

<p>If we try out the application now, we can see that adding and removing adds works… but if we scroll the page it jumps back to the top every time we make an edit:</p>

<p><img src="https://viktorvan.github.io/assets/images/safe-turbolinks-scroll-position.gif" alt="without storing scroll position"></p>

<p>This is caused by the call to <code>Turbolinks.visit()</code>. To fix this we can add a <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/src/Client/ScrollPositionService.fs">helper</a> to save and recall the scroll position:</p>

<div><div><pre><code><span>// ScrollPositionService.fs</span>
<span>open</span> <span>Browser</span>

<span>type</span> <span>ScrollPositionService</span><span>()</span> <span>=</span>
    <span>let</span> <span>mutable</span> <span>scrollPosition</span> <span>=</span> <span>None</span>
    <span>member</span> <span>this</span><span>.</span><span>Save</span><span>()</span> <span>=</span>
        <span>scrollPosition</span> <span>&lt;-</span> <span>Some</span> <span>{|</span> <span>X</span> <span>=</span> <span>window</span><span>.</span><span>scrollX</span><span>;</span> <span>Y</span> <span>=</span> <span>window</span><span>.</span><span>scrollY</span> <span>|}</span>
    <span>member</span> <span>this</span><span>.</span><span>Recall</span><span>()</span> <span>=</span>
        <span>scrollPosition</span>
        <span>|&gt;</span> <span>Option</span><span>.</span><span>iter</span> <span>(</span><span>fun</span> <span>p</span> <span>-&gt;</span> <span>window</span><span>.</span><span>scrollTo</span><span>(</span><span>p</span><span>.</span><span>X</span><span>,</span> <span>p</span><span>.</span><span>Y</span><span>))</span>
        <span>scrollPosition</span> <span>&lt;-</span> <span>None</span>
</code></pre></div></div>

<p>And we hook into another custom Turbolinks event “turbolinks:before-cache” to save the scroll position, then recall it in “turbolinks:load”:</p>

<div><div><pre><code><span>// App.fs</span>

<span>document</span><span>.</span><span>addEventListener</span><span>(</span><span>"turbolinks:before-cache"</span><span>,</span> <span>fun</span> <span>_</span> <span>-&gt;</span>
    <span>CompositionRoot</span><span>.</span><span>scrollPositionService</span><span>.</span><span>Save</span><span>()</span><span>)</span>

<span>document</span><span>.</span><span>addEventListener</span><span>(</span><span>"turbolinks:load"</span><span>,</span> <span>fun</span> <span>_</span> <span>-&gt;</span>
    <span>CompositionRoot</span><span>.</span><span>scrollPositionService</span><span>.</span><span>Recall</span><span>()</span>
    <span>Datepicker</span><span>.</span><span>init</span> <span>()</span><span>)</span>
<span>)</span>
</code></pre></div></div>

<p>And voilà, the page no longer jumps to the top when we add or remove eggs.</p>

<h3 id="step-4-deal-with-redirects">Step 4. Deal with redirects<a href="#step-4-deal-with-redirects" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>One last thing.</p>

<p>If we click on the link “ChickenCheck” in the navbar we are taken back to the root of the home page. On the server this will redirect us to the chickens page for the current date <code>/chickens/date?&lt;currentDate&gt;</code>. If we try it we can see that the url in our browser stays at the root of the homepage. This is expected, <a href="https://github.com/turbolinks/turbolinks#following-redirects">from the documentation</a>: “Turbolinks makes requests using XMLHttpRequest, which transparently follows redirects. There’s no way for Turbolinks to tell whether a request resulted in a redirect without additional cooperation from the server.”</p>

<p>To fix this we need to add a custom response header “Turbolinks-Location” to all requests initiated by Turbolinks (with request header “Turbolinks-Referrer”). Turbolinks will then replace the last entry in the browser history with this value. So in our server setup we add this code:</p>

<div><div><pre><code><span>// Server.fs</span>
<span>let</span> <span>setTurbolinksLocationHeader</span> <span>:</span> <span>HttpHandler</span> <span>=</span>
    <span>let</span> <span>isTurbolink</span> <span>(</span><span>ctx</span><span>:</span> <span>HttpContext</span><span>)</span> <span>=</span>
        <span>ctx</span><span>.</span><span>Request</span><span>.</span><span>Headers</span><span>.</span><span>ContainsKey</span> <span>"Turbolinks-Referrer"</span>

    <span>fun</span> <span>next</span> <span>ctx</span> <span>-&gt;</span>
        <span>task</span> <span>{</span>
            <span>if</span> <span>isTurbolink</span> <span>ctx</span> <span>then</span>
                <span>ctx</span><span>.</span><span>SetHttpHeader</span> <span>"Turbolinks-Location"</span> <span>(</span><span>ctx</span><span>.</span><span>Request</span><span>.</span><span>Path</span> <span>+</span> <span>ctx</span><span>.</span><span>Request</span><span>.</span><span>QueryString</span><span>)</span>
            <span>return</span><span>!</span> <span>next</span> <span>ctx</span>
        <span>}</span>
</code></pre></div></div>

<p>And add this httphandler to our server pipeline. Since I am using Saturn I can do this by “plugging” it into my endpointPipeline:</p>

<div><div><pre><code><span>let</span> <span>endpointPipe</span> <span>=</span> <span>pipeline</span> <span>{</span>
    <span>plug</span> <span>putSecureBrowserHeaders</span>
    <span>plug</span> <span>head</span>
    <span>plug</span> <span>setTurbolinksLocationHeader</span>
<span>}</span>
</code></pre></div></div>

<p>And we’re done!</p>

<h3 id="conclusions">Conclusions<a href="#conclusions" title="Permalink"><span>Permalink</span><i></i></a></h3>

<p>In this small application I feel that using Turbolinks greatly simplified my code. I could get rid of a lot of Elmish boiler-plate, Models and Messages. And I only needed to deal with rendering html in one place in the server where I had all information readily available. In the elmish application I had to deal with several kinds of updates to the views, e.g. The user changed date -&gt; fetch new eggCount and update the view; The user added an egg -&gt; update the eggCount for the correct chicken view + update the total count in the statistics section.
Albeit we had to add some event listener setup, but with the Active Patterns I feel it turned out pretty clean.</p>

<p>With that said I think there absolutely are use cases, i.e. apps with a lot going on at the client side, where I would prefer to use Elmish, or <a href="https://zaid-ajaj.github.io/Feliz/#/Hooks/UseElmish">Feliz.UseElmish</a>.</p>



        
      </section></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>