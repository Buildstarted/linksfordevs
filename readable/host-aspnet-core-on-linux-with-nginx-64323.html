<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Host ASP.NET Core on Linux with Nginx - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Host ASP.NET Core on Linux with Nginx - linksfor.dev(s)"/>
    <meta property="article:author" content="Rick-Anderson"/>
    <meta property="og:description" content="Learn how to setup Nginx as a reverse proxy on Ubuntu 16.04 to forward HTTP traffic to an ASP.NET Core web app running on Kestrel."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Host ASP.NET Core on Linux with Nginx</title>
<div class="readable">
        <h1>Host ASP.NET Core on Linux with Nginx</h1>
            <div>by Rick-Anderson</div>
            <div>Reading time: 21-26 minutes</div>
        <div>Posted here: 15 Jul 2020</div>
        <p><a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1">https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1</a></p>
        <hr/>
<div id="readability-page-1" class="page">


	<div data-bi-name="body">

		<div>

			

			<section>
				<div>


				<div id="main-column">

					<main id="main" role="main" data-bi-name="content" lang="en-us" dir="ltr">



						

						<ul data-bi-name="page info" lang="en-us" dir="ltr">
							<li>
								<time data-article-date="" aria-label="Article review date" datetime="2020-04-10T00:00:00.000Z" data-article-date-source="ms.date">04/10/2020</time>
							</li>
								<li>14 minutes to read</li>
								<li>
									<a href="https://github.com/dotnet/AspNetCore.Docs/blob/master/aspnetcore/host-and-deploy/linux-nginx.md" title="10 Contributors" aria-label="10 Contributors">
										
									</a>
								</li>
						</ul>

						<nav id="center-doc-outline" data-bi-name="intopic toc" role="navigation" aria-label="Article Outline">
							<h3>In this article</h3>
						<ol><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#publish-and-copy-over-the-app">Publish and copy over the app</a></li><li><a href="#configure-a-reverse-proxy-server">Configure a reverse proxy server</a></li><li><a href="#monitor-the-app">Monitor the app</a></li><li><a href="#data-protection">Data protection</a></li><li><a href="#long-request-header-fields">Long request header fields</a></li><li><a href="#secure-the-app">Secure the app</a></li><li><a href="#additional-nginx-suggestions">Additional Nginx suggestions</a></li><li><a href="#additional-resources">Additional resources</a></li></ol></nav>

						<!-- <content> -->
							<p>By <a href="https://twitter.com/sshirhatti" data-linktype="external">Sourabh Shirhatti</a></p>
<p>This guide explains setting up a production-ready ASP.NET Core environment on an Ubuntu 16.04 server. These instructions likely work with newer versions of Ubuntu, but the instructions haven't been tested with newer versions.</p>
<p>For information on other Linux distributions supported by ASP.NET Core, see <a href="https://docs.microsoft.com/en-us/dotnet/core/linux-prerequisites" data-linktype="absolute-path">Prerequisites for .NET Core on Linux</a>.</p>
<div>
<p><span aria-hidden="true"></span> Note</p>
<p>For Ubuntu 14.04, <em>supervisord</em> is recommended as a solution for monitoring the Kestrel process. <em>systemd</em> isn't available on Ubuntu 14.04. For Ubuntu 14.04 instructions, see the <a href="https://github.com/dotnet/AspNetCore.Docs/blob/e9c1419175c4dd7e152df3746ba1df5935aaafd5/aspnetcore/publishing/linuxproduction.md" data-linktype="external">previous version of this topic</a>.</p>
</div>
<p>This guide:</p>
<ul>
<li>Places an existing ASP.NET Core app behind a reverse proxy server.</li>
<li>Sets up the reverse proxy server to forward requests to the Kestrel web server.</li>
<li>Ensures the web app runs on startup as a daemon.</li>
<li>Configures a process management tool to help restart the web app.</li>
</ul>
<h2 id="prerequisites"><a href="#prerequisites" aria-labelledby="prerequisites"></a>Prerequisites</h2>
<ol>
<li>Access to an Ubuntu 16.04 server with a standard user account with sudo privilege.</li>
<li>Install the .NET Core runtime on the server.
<ol>
<li>Visit the <a href="https://dotnet.microsoft.com/download/dotnet-core" data-linktype="external">Download .NET Core page</a>.</li>
<li>Select the latest non-preview .NET Core version.</li>
<li>Download the latest non-preview runtime in the table under <strong>Run apps - Runtime</strong>.</li>
<li>Select the Linux <strong>Package manager instructions</strong> link and follow the Ubuntu instructions for your version of Ubuntu.</li>
</ol>
</li>
<li>An existing ASP.NET Core app.</li>
</ol>
<p>At any point in the future after upgrading the shared framework, restart the ASP.NET Core apps hosted by the server.</p>
<h2 id="publish-and-copy-over-the-app"><a href="#publish-and-copy-over-the-app" aria-labelledby="publish-and-copy-over-the-app"></a>Publish and copy over the app</h2>
<p>Configure the app for a <a href="https://docs.microsoft.com/en-us/dotnet/core/deploying/#framework-dependent-deployments-fdd" data-linktype="absolute-path">framework-dependent deployment</a>.</p>
<p>If the app is run locally and isn't configured to make secure connections (HTTPS), adopt either of the following approaches:</p>
<ul>
<li>Configure the app to handle secure local connections. For more information, see the <a href="#https-configuration" data-linktype="self-bookmark">HTTPS configuration</a> section.</li>
<li>Remove <code>https://localhost:5001</code> (if present) from the <code>applicationUrl</code> property in the <em>Properties/launchSettings.json</em> file.</li>
</ul>
<p>Run <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-publish" data-linktype="absolute-path">dotnet publish</a> from the development environment to package an app into a directory (for example, <em>bin/Release/&lt;target_framework_moniker&gt;/publish</em>) that can run on the server:</p>
<pre tabindex="0"><code data-author-content="dotnet publish --configuration Release
"><span><span>dotnet</span> <span>publish</span><span> --configuration</span> Release
</span></code></pre>
<p>The app can also be published as a <a href="https://docs.microsoft.com/en-us/dotnet/core/deploying/#self-contained-deployments-scd" data-linktype="absolute-path">self-contained deployment</a> if you prefer not to maintain the .NET Core runtime on the server.</p>
<p>Copy the ASP.NET Core app to the server using a tool that integrates into the organization's workflow (for example, SCP, SFTP). It's common to locate web apps under the <em>var</em> directory (for example, <em>var/www/helloapp</em>).</p>
<div>
<p><span aria-hidden="true"></span> Note</p>
<p>Under a production deployment scenario, a continuous integration workflow does the work of publishing the app and copying the assets to the server.</p>
</div>
<p>Test the app:</p>
<ol>
<li>From the command line, run the app: <code>dotnet &lt;app_assembly&gt;.dll</code>.</li>
<li>In a browser, navigate to <code>http://&lt;serveraddress&gt;:&lt;port&gt;</code> to verify the app works on Linux locally.</li>
</ol>
<h2 id="configure-a-reverse-proxy-server"><a href="#configure-a-reverse-proxy-server" aria-labelledby="configure-a-reverse-proxy-server"></a>Configure a reverse proxy server</h2>
<p>A reverse proxy is a common setup for serving dynamic web apps. A reverse proxy terminates the HTTP request and forwards it to the ASP.NET Core app.</p>
<h3 id="use-a-reverse-proxy-server"><a href="#use-a-reverse-proxy-server" aria-labelledby="use-a-reverse-proxy-server"></a>Use a reverse proxy server</h3>
<p>Kestrel is great for serving dynamic content from ASP.NET Core. However, the web serving capabilities aren't as feature rich as servers such as IIS, Apache, or Nginx. A reverse proxy server can offload work such as serving static content, caching requests, compressing requests, and HTTPS termination from the HTTP server. A reverse proxy server may reside on a dedicated machine or may be deployed alongside an HTTP server.</p>
<p>For the purposes of this guide, a single instance of Nginx is used. It runs on the same server, alongside the HTTP server. Based on requirements, a different setup may be chosen.</p>
<p>Because requests are forwarded by reverse proxy, use the <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-3.1" data-linktype="relative-path">Forwarded Headers Middleware</a> from the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.HttpOverrides/" data-linktype="external">Microsoft.AspNetCore.HttpOverrides</a> package. The middleware updates the <code>Request.Scheme</code>, using the <code>X-Forwarded-Proto</code> header, so that redirect URIs and other security policies work correctly.</p>
<p>Forwarded Headers Middleware should run before other middleware. This ordering ensures that the middleware relying on forwarded headers information can consume the header values for processing. To run Forwarded Headers Middleware after diagnostics and error handling middleware, see <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-3.1#fhmo" data-linktype="relative-path">Forwarded Headers Middleware order</a>.</p>
<p>Invoke the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersextensions.useforwardedheaders" data-linktype="absolute-path">UseForwardedHeaders</a> method at the top of <code>Startup.Configure</code> before calling other middleware. Configure the middleware to forward the <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code> headers:</p>
<pre tabindex="0"><code data-author-content="// using Microsoft.AspNetCore.HttpOverrides;

app.UseForwardedHeaders(new ForwardedHeadersOptions
{
    ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto
});

app.UseAuthentication();
"><span><span>// using Microsoft.AspNetCore.HttpOverrides;</span>

app.UseForwardedHeaders(<span>new</span> ForwardedHeadersOptions
{
    ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto
});

app.UseAuthentication();
</span></code></pre>
<p>If no <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions" data-linktype="absolute-path">ForwardedHeadersOptions</a> are specified to the middleware, the default headers to forward are <code>None</code>.</p>
<p>Proxies running on loopback addresses (127.0.0.0/8, [::1]), including the standard localhost address (127.0.0.1), are trusted by default. If other trusted proxies or networks within the organization handle requests between the Internet and the web server, add them to the list of <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.knownproxies" data-linktype="absolute-path">KnownProxies</a> or <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.knownnetworks" data-linktype="absolute-path">KnownNetworks</a> with <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions" data-linktype="absolute-path">ForwardedHeadersOptions</a>. The following example adds a trusted proxy server at IP address 10.0.0.100 to the Forwarded Headers Middleware <code>KnownProxies</code> in <code>Startup.ConfigureServices</code>:</p>
<pre tabindex="0"><code data-author-content="// using System.Net;

services.Configure<ForwardedHeadersOptions>(options =>
{
    options.KnownProxies.Add(IPAddress.Parse(&quot;10.0.0.100&quot;));
});
"><span><span>// using System.Net;</span>

services.Configure&lt;ForwardedHeadersOptions&gt;(options =&gt;
{
    options.KnownProxies.Add(IPAddress.Parse(<span>"10.0.0.100"</span>));
});
</span></code></pre>
<p>For more information, see <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-3.1" data-linktype="relative-path">Configure ASP.NET Core to work with proxy servers and load balancers</a>.</p>
<h3 id="install-nginx"><a href="#install-nginx" aria-labelledby="install-nginx"></a>Install Nginx</h3>
<p>Use <code>apt-get</code> to install Nginx. The installer creates a <em>systemd</em> init script that runs Nginx as daemon on system startup. Follow the installation instructions for Ubuntu at <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/install/#official-debian-ubuntu-packages" data-linktype="external">Nginx: Official Debian/Ubuntu packages</a>.</p>
<div>
<p><span aria-hidden="true"></span> Note</p>
<p>If optional Nginx modules are required, building Nginx from source might be required.</p>
</div>
<p>Since Nginx was installed for the first time, explicitly start it by running:</p>
<pre tabindex="0"><code data-author-content="sudo service nginx start
"><span>sudo service nginx start
</span></code></pre>
<p>Verify a browser displays the default landing page for Nginx. The landing page is reachable at <code>http://&lt;server_IP_address&gt;/index.nginx-debian.html</code>.</p>
<h3 id="configure-nginx"><a href="#configure-nginx" aria-labelledby="configure-nginx"></a>Configure Nginx</h3>
<p>To configure Nginx as a reverse proxy to forward requests to your ASP.NET Core app, modify <em>/etc/nginx/sites-available/default</em>. Open it in a text editor, and replace the contents with the following:</p>
<pre tabindex="0"><code data-author-content="server {
    listen        80;
    server_name   example.com *.example.com;
    location / {
        proxy_pass         http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection keep-alive;
        proxy_set_header   Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}
"><span><span>server</span> {
    <span>listen</span>        <span>80</span>;
    <span>server_name</span>   example.com <span>*.example.com</span>;
    <span>location</span> / {
        <span>proxy_pass</span>         http://localhost:5000;
        <span>proxy_http_version</span> <span>1</span>.<span>1</span>;
        <span>proxy_set_header</span>   Upgrade <span>$http_upgrade</span>;
        <span>proxy_set_header</span>   Connection keep-alive;
        <span>proxy_set_header</span>   Host <span>$host</span>;
        <span>proxy_cache_bypass</span> <span>$http_upgrade</span>;
        <span>proxy_set_header</span>   X-Forwarded-For <span>$proxy_add_x_forwarded_for</span>;
        <span>proxy_set_header</span>   X-Forwarded-Proto <span>$scheme</span>;
    }
}
</span></code></pre>
<p>If the app is a Blazor Server app that relies on SignalR WebSockets, see <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/host-and-deploy/server?view=aspnetcore-3.1#linux-with-nginx" data-linktype="relative-path">Host and deploy ASP.NET Core Blazor Server</a> for information on how to set the <code>Connection</code> header.</p>
<p>When no <code>server_name</code> matches, Nginx uses the default server. If no default server is defined, the first server in the configuration file is the default server. As a best practice, add a specific default server which returns a status code of 444 in your configuration file. A default server configuration example is:</p>
<pre tabindex="0"><code data-author-content="server {
    listen   80 default_server;
    # listen [::]:80 default_server deferred;
    return   444;
}
"><span><span>server</span> {
    <span>listen</span>   <span>80</span> default_server;
    <span># listen [::]:80 default_server deferred;</span>
    <span>return</span>   <span>444</span>;
}
</span></code></pre>
<p>With the preceding configuration file and default server, Nginx accepts public traffic on port 80 with host header <code>example.com</code> or <code>*.example.com</code>. Requests not matching these hosts won't get forwarded to Kestrel. Nginx forwards the matching requests to Kestrel at <code>http://localhost:5000</code>. See <a href="https://nginx.org/docs/http/request_processing.html" data-linktype="external">How nginx processes a request</a> for more information. To change Kestrel's IP/port, see <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-3.1#endpoint-configuration" data-linktype="relative-path">Kestrel: Endpoint configuration</a>.</p>
<div>
<p><span aria-hidden="true"></span> Warning</p>
<p>Failure to specify a proper <a href="https://nginx.org/docs/http/server_names.html" data-linktype="external">server_name directive</a> exposes your app to security vulnerabilities. Subdomain wildcard binding (for example, <code>*.example.com</code>) doesn't pose this security risk if you control the entire parent domain (as opposed to <code>*.com</code>, which is vulnerable). See <a href="https://tools.ietf.org/html/rfc7230#section-5.4" data-linktype="external">rfc7230 section-5.4</a> for more information.</p>
</div>
<p>Once the Nginx configuration is established, run <code>sudo nginx -t</code> to verify the syntax of the configuration files. If the configuration file test is successful, force Nginx to pick up the changes by running <code>sudo nginx -s reload</code>.</p>
<p>To directly run the app on the server:</p>
<ol>
<li>Navigate to the app's directory.</li>
<li>Run the app: <code>dotnet &lt;app_assembly.dll&gt;</code>, where <code>app_assembly.dll</code> is the assembly file name of the app.</li>
</ol>
<p>If the app runs on the server but fails to respond over the Internet, check the server's firewall and confirm that port 80 is open. If using an Azure Ubuntu VM, add a Network Security Group (NSG) rule that enables inbound port 80 traffic. There's no need to enable an outbound port 80 rule, as the outbound traffic is automatically granted when the inbound rule is enabled.</p>
<p>When done testing the app, shut the app down with <code>Ctrl+C</code> at the command prompt.</p>
<h2 id="monitor-the-app"><a href="#monitor-the-app" aria-labelledby="monitor-the-app"></a>Monitor the app</h2>
<p>The server is setup to forward requests made to <code>http://&lt;serveraddress&gt;:80</code> on to the ASP.NET Core app running on Kestrel at <code>http://127.0.0.1:5000</code>. However, Nginx isn't set up to manage the Kestrel process. <em>systemd</em> can be used to create a service file to start and monitor the underlying web app. <em>systemd</em> is an init system that provides many powerful features for starting, stopping, and managing processes.</p>
<h3 id="create-the-service-file"><a href="#create-the-service-file" aria-labelledby="create-the-service-file"></a>Create the service file</h3>
<p>Create the service definition file:</p>
<pre tabindex="0"><code data-author-content="sudo nano /etc/systemd/system/kestrel-helloapp.service
"><span>sudo nano /etc/systemd/system/kestrel-helloapp.service
</span></code></pre>
<p>The following is an example service file for the app:</p>
<pre tabindex="0"><code data-author-content="[Unit]
Description=Example .NET Web API App running on Ubuntu

[Service]
WorkingDirectory=/var/www/helloapp
ExecStart=/usr/bin/dotnet /var/www/helloapp/helloapp.dll
Restart=always
# Restart service after 10 seconds if the dotnet service crashes:
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=dotnet-example
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

[Install]
WantedBy=multi-user.target
"><span><span>[Unit]</span>
<span>Description</span>=Example .NET Web API App running <span>on</span> Ubuntu
<span>
[Service]</span>
<span>WorkingDirectory</span>=/var/www/helloapp
<span>ExecStart</span>=/usr/bin/dotnet /var/www/helloapp/helloapp.dll
<span>Restart</span>=always
<span># Restart service after 10 seconds if the dotnet service crashes:</span>
<span>RestartSec</span>=<span>10</span>
<span>KillSignal</span>=SIGINT
<span>SyslogIdentifier</span>=dotnet-example
<span>User</span>=www-data
<span>Environment</span>=ASPNETCORE_ENVIRONMENT=Production
<span>Environment</span>=DOTNET_PRINT_TELEMETRY_MESSAGE=<span>false</span>
<span>
[Install]</span>
<span>WantedBy</span>=multi-user.target
</span></code></pre>
<p>In the preceding example, the user that manages the service is specified by the <code>User</code> option. The user (<code>www-data</code>) must exist and have proper ownership of the app's files.</p>
<p>Use <code>TimeoutStopSec</code> to configure the duration of time to wait for the app to shut down after it receives the initial interrupt signal. If the app doesn't shut down in this period, SIGKILL is issued to terminate the app. Provide the value as unitless seconds (for example, <code>150</code>), a time span value (for example, <code>2min 30s</code>), or <code>infinity</code> to disable the timeout. <code>TimeoutStopSec</code> defaults to the value of <code>DefaultTimeoutStopSec</code> in the manager configuration file (<em>systemd-system.conf</em>, <em>system.conf.d</em>, <em>systemd-user.conf</em>, <em>user.conf.d</em>). The default timeout for most distributions is 90 seconds.</p>
<pre tabindex="0"><code data-author-content="# The default value is 90 seconds for most distributions.
TimeoutStopSec=90
"># The default value is 90 seconds for most distributions.
TimeoutStopSec=90
</code></pre>
<p>Linux has a case-sensitive file system. Setting ASPNETCORE_ENVIRONMENT to "Production" results in searching for the configuration file <em>appsettings.Production.json</em>, not <em>appsettings.production.json</em>.</p>
<p>Some values (for example, SQL connection strings) must be escaped for the configuration providers to read the environment variables. Use the following command to generate a properly escaped value for use in the configuration file:</p>
<pre tabindex="0"><code data-author-content="systemd-escape &quot;<value-to-escape>&quot;
"><span>systemd-escape "&lt;value-to-escape&gt;"
</span></code></pre>
<div data-moniker="aspnetcore-3.0 aspnetcore-3.1 aspnetcore-5.0">
<p>Colon (<code>:</code>) separators aren't supported in environment variable names. Use a double underscore (<code>__</code>) in place of a colon. The <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-3.1#environment-variables" data-linktype="relative-path">Environment Variables configuration provider</a> converts double-underscores into colons when environment variables are read into configuration. In the following example, the connection string key <code>ConnectionStrings:DefaultConnection</code> is set into the service definition file as <code>ConnectionStrings__DefaultConnection</code>:</p>
</div>
<div data-moniker="aspnetcore-2.1 aspnetcore-2.2">
<p>Colon (<code>:</code>) separators aren't supported in environment variable names. Use a double underscore (<code>__</code>) in place of a colon. The <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-3.1#environment-variables-configuration-provider" data-linktype="relative-path">Environment Variables configuration provider</a> converts double-underscores into colons when environment variables are read into configuration. In the following example, the connection string key <code>ConnectionStrings:DefaultConnection</code> is set into the service definition file as <code>ConnectionStrings__DefaultConnection</code>:</p>
</div>
<pre tabindex="0"><code data-author-content="Environment=ConnectionStrings__DefaultConnection={Connection String}
">Environment=ConnectionStrings__DefaultConnection={Connection String}
</code></pre>
<p>Save the file and enable the service.</p>
<pre tabindex="0"><code data-author-content="sudo systemctl enable kestrel-helloapp.service
"><span>sudo systemctl <span>enable</span> kestrel-helloapp.service
</span></code></pre>
<p>Start the service and verify that it's running.</p>
<pre tabindex="0"><code data-author-content="sudo systemctl start kestrel-helloapp.service
sudo systemctl status kestrel-helloapp.service

◝ kestrel-helloapp.service - Example .NET Web API App running on Ubuntu
    Loaded: loaded (/etc/systemd/system/kestrel-helloapp.service; enabled)
    Active: active (running) since Thu 2016-10-18 04:09:35 NZDT; 35s ago
Main PID: 9021 (dotnet)
    CGroup: /system.slice/kestrel-helloapp.service
            └─9021 /usr/local/bin/dotnet /var/www/helloapp/helloapp.dll
">sudo systemctl start kestrel-helloapp.service
sudo systemctl status kestrel-helloapp.service

◝ kestrel-helloapp.service - Example .NET Web API App running on Ubuntu
    Loaded: loaded (/etc/systemd/system/kestrel-helloapp.service; enabled)
    Active: active (running) since Thu 2016-10-18 04:09:35 NZDT; 35s ago
Main PID: 9021 (dotnet)
    CGroup: /system.slice/kestrel-helloapp.service
            └─9021 /usr/local/bin/dotnet /var/www/helloapp/helloapp.dll
</code></pre>
<p>With the reverse proxy configured and Kestrel managed through systemd, the web app is fully configured and can be accessed from a browser on the local machine at <code>http://localhost</code>. It's also accessible from a remote machine, barring any firewall that might be blocking. Inspecting the response headers, the <code>Server</code> header shows the ASP.NET Core app being served by Kestrel.</p>
<pre tabindex="0"><code data-author-content="HTTP/1.1 200 OK
Date: Tue, 11 Oct 2016 16:22:23 GMT
Server: Kestrel
Keep-Alive: timeout=5, max=98
Connection: Keep-Alive
Transfer-Encoding: chunked
">HTTP/1.1 200 OK
Date: Tue, 11 Oct 2016 16:22:23 GMT
Server: Kestrel
Keep-Alive: timeout=5, max=98
Connection: Keep-Alive
Transfer-Encoding: chunked
</code></pre>
<h3 id="view-logs"><a href="#view-logs" aria-labelledby="view-logs"></a>View logs</h3>
<p>Since the web app using Kestrel is managed using <code>systemd</code>, all events and processes are logged to a centralized journal. However, this journal includes all entries for all services and processes managed by <code>systemd</code>. To view the <code>kestrel-helloapp.service</code>-specific items, use the following command:</p>
<pre tabindex="0"><code data-author-content="sudo journalctl -fu kestrel-helloapp.service
"><span>sudo journalctl -fu kestrel-helloapp.service
</span></code></pre>
<p>For further filtering, time options such as <code>--since today</code>, <code>--until 1 hour ago</code> or a combination of these can reduce the amount of entries returned.</p>
<pre tabindex="0"><code data-author-content="sudo journalctl -fu kestrel-helloapp.service --since &quot;2016-10-18&quot; --until &quot;2016-10-18 04:00&quot;
"><span>sudo journalctl -fu kestrel-helloapp.service --since <span>"2016-10-18"</span> --until <span>"2016-10-18 04:00"</span>
</span></code></pre>
<h2 id="data-protection"><a href="#data-protection" aria-labelledby="data-protection"></a>Data protection</h2>
<p>The <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/introduction?view=aspnetcore-3.1" data-linktype="relative-path">ASP.NET Core Data Protection stack</a> is used by several ASP.NET Core <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-3.1" data-linktype="relative-path">middlewares</a>, including authentication middleware (for example, cookie middleware) and cross-site request forgery (CSRF) protections. Even if Data Protection APIs aren't called by user code, data protection should be configured to create a persistent cryptographic <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-management?view=aspnetcore-3.1" data-linktype="relative-path">key store</a>. If data protection isn't configured, the keys are held in memory and discarded when the app restarts.</p>
<p>If the key ring is stored in memory when the app restarts:</p>
<ul>
<li>All cookie-based authentication tokens are invalidated.</li>
<li>Users are required to sign in again on their next request.</li>
<li>Any data protected with the key ring can no longer be decrypted. This may include <a href="https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-3.1#aspnet-core-antiforgery-configuration" data-linktype="relative-path">CSRF tokens</a> and <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/app-state?view=aspnetcore-3.1#tempdata" data-linktype="relative-path">ASP.NET Core MVC TempData cookies</a>.</li>
</ul>
<p>To configure data protection to persist and encrypt the key ring, see:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-storage-providers?view=aspnetcore-3.1" data-linktype="relative-path">Key storage providers in ASP.NET Core</a></li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-encryption-at-rest?view=aspnetcore-3.1" data-linktype="relative-path">Key encryption at rest in Windows and Azure using ASP.NET Core</a></li>
</ul>
<h2 id="long-request-header-fields"><a href="#long-request-header-fields" aria-labelledby="long-request-header-fields"></a>Long request header fields</h2>
<p>Proxy server default settings typically limit request header fields to 4 K or 8 K depending on the platform. An app may require fields longer than the default (for example, apps that use <a href="https://azure.microsoft.com/services/active-directory/" data-linktype="external">Azure Active Directory</a>). If longer fields are required, the proxy server's default settings require adjustment. The values to apply depend on the scenario. For more information, see your server's documentation.</p>
<ul>
<li><a href="https://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffer_size" data-linktype="external">proxy_buffer_size</a></li>
<li><a href="https://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffers" data-linktype="external">proxy_buffers</a></li>
<li><a href="https://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_busy_buffers_size" data-linktype="external">proxy_busy_buffers_size</a></li>
<li><a href="https://nginx.org/docs/http/ngx_http_core_module.html#large_client_header_buffers" data-linktype="external">large_client_header_buffers</a></li>
</ul>
<div>
<p><span aria-hidden="true"></span> Warning</p>
<p>Don't increase the default values of proxy buffers unless necessary. Increasing these values increases the risk of buffer overrun (overflow) and Denial of Service (DoS) attacks by malicious users.</p>
</div>
<h2 id="secure-the-app"><a href="#secure-the-app" aria-labelledby="secure-the-app"></a>Secure the app</h2>
<h3 id="enable-apparmor"><a href="#enable-apparmor" aria-labelledby="enable-apparmor"></a>Enable AppArmor</h3>
<p>Linux Security Modules (LSM) is a framework that's part of the Linux kernel since Linux 2.6. LSM supports different implementations of security modules. <a href="https://wiki.ubuntu.com/AppArmor" data-linktype="external">AppArmor</a> is a LSM that implements a Mandatory Access Control system which allows confining the program to a limited set of resources. Ensure AppArmor is enabled and properly configured.</p>
<h3 id="configure-the-firewall"><a href="#configure-the-firewall" aria-labelledby="configure-the-firewall"></a>Configure the firewall</h3>
<p>Close off all external ports that are not in use. Uncomplicated firewall (ufw) provides a front end for <code>iptables</code> by providing a CLI for configuring the firewall.</p>
<div>
<p><span aria-hidden="true"></span> Warning</p>
<p>A firewall will prevent access to the whole system if not configured correctly. Failure to specify the correct SSH port will effectively lock you out of the system if you are using SSH to connect to it. The default port is 22. For more information, see the <a href="https://help.ubuntu.com/community/UFW" data-linktype="external">introduction to ufw</a> and the <a href="https://manpages.ubuntu.com/manpages/bionic/man8/ufw.8.html" data-linktype="external">manual</a>.</p>
</div>
<p>Install <code>ufw</code> and configure it to allow traffic on any ports needed.</p>
<pre tabindex="0"><code data-author-content="sudo apt-get install ufw

sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

sudo ufw enable
"><span>sudo apt-get install ufw

sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

sudo ufw <span>enable</span>
</span></code></pre>
<h3 id="secure-nginx"><a href="#secure-nginx" aria-labelledby="secure-nginx"></a>Secure Nginx</h3>
<h4 id="change-the-nginx-response-name"><a href="#change-the-nginx-response-name" aria-labelledby="change-the-nginx-response-name"></a>Change the Nginx response name</h4>
<p>Edit <em>src/http/ngx_http_header_filter_module.c</em>:</p>
<pre tabindex="0"><code data-author-content="static char ngx_http_server_string[] = &quot;Server: Web Server&quot; CRLF;
static char ngx_http_server_full_string[] = &quot;Server: Web Server&quot; CRLF;
">static char ngx_http_server_string[] = "Server: Web Server" CRLF;
static char ngx_http_server_full_string[] = "Server: Web Server" CRLF;
</code></pre>
<h4 id="configure-options"><a href="#configure-options" aria-labelledby="configure-options"></a>Configure options</h4>
<p>Configure the server with additional required modules. Consider using a web app firewall, such as <a href="https://www.modsecurity.org/" data-linktype="external">ModSecurity</a>, to harden the app.</p>
<h4 id="https-configuration"><a href="#https-configuration" aria-labelledby="https-configuration"></a>HTTPS configuration</h4>
<p><strong>Configure the app for secure (HTTPS) local connections</strong></p>
<p>The <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-run" data-linktype="absolute-path">dotnet run</a> command uses the app's <em>Properties/launchSettings.json</em> file, which configures the app to listen on the URLs provided by the <code>applicationUrl</code> property (for example, <code>https://localhost:5001;http://localhost:5000</code>).</p>
<p>Configure the app to use a certificate in development for the <code>dotnet run</code> command or development environment (F5 or Ctrl+F5 in Visual Studio Code) using one of the following approaches:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-3.1#configuration" data-linktype="relative-path">Replace the default certificate from configuration</a> (<em>Recommended</em>)</li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-3.1#configurehttpsdefaultsactionhttpsconnectionadapteroptions" data-linktype="relative-path">KestrelServerOptions.ConfigureHttpsDefaults</a></li>
</ul>
<p><strong>Configure the reverse proxy for secure (HTTPS) client connections</strong></p>
<ul>
<li><p>Configure the server to listen to HTTPS traffic on port <code>443</code> by specifying a valid certificate issued by a trusted Certificate Authority (CA).</p>
</li>
<li><p>Harden the security by employing some of the practices depicted in the following <em>/etc/nginx/nginx.conf</em> file. Examples include choosing a stronger cipher and redirecting all traffic over HTTP to HTTPS.</p>
</li>
<li><p>Adding an <code>HTTP Strict-Transport-Security</code> (HSTS) header ensures all subsequent requests made by the client are over HTTPS.</p>
</li>
<li><p>If HTTPS will be disabled in the future, use one of the following approaches:</p>
<ul>
<li>Don't add the HSTS header.</li>
<li>Choose a short <code>max-age</code> value.</li>
</ul>
</li>
</ul>
<p>Add the <em>/etc/nginx/proxy.conf</em> configuration file:</p>
<pre tabindex="0"><code data-author-content="proxy_redirect          off;
proxy_set_header        Host $host;
proxy_set_header        X-Real-IP $remote_addr;
proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header        X-Forwarded-Proto $scheme;
client_max_body_size    10m;
client_body_buffer_size 128k;
proxy_connect_timeout   90;
proxy_send_timeout      90;
proxy_read_timeout      90;
proxy_buffers           32 4k;
"><span><span>proxy_redirect</span>          <span>off</span>;
<span>proxy_set_header</span>        Host <span>$host</span>;
<span>proxy_set_header</span>        X-Real-IP <span>$remote_addr</span>;
<span>proxy_set_header</span>        X-Forwarded-For <span>$proxy_add_x_forwarded_for</span>;
<span>proxy_set_header</span>        X-Forwarded-Proto <span>$scheme</span>;
<span>client_max_body_size</span>    <span>10m</span>;
<span>client_body_buffer_size</span> <span>128k</span>;
<span>proxy_connect_timeout</span>   <span>90</span>;
<span>proxy_send_timeout</span>      <span>90</span>;
<span>proxy_read_timeout</span>      <span>90</span>;
<span>proxy_buffers</span>           <span>32</span> <span>4k</span>;
</span></code></pre>
<p>Edit the <em>/etc/nginx/nginx.conf</em> configuration file. The example contains both <code>http</code> and <code>server</code> sections in one configuration file.</p>
<pre tabindex="0"><code highlight-lines="2" data-author-content="http {
    include        /etc/nginx/proxy.conf;
    limit_req_zone $binary_remote_addr zone=one:10m rate=5r/s;
    server_tokens  off;

    sendfile on;
    keepalive_timeout   29; # Adjust to the lowest possible value that makes sense for your use case.
    client_body_timeout 10; client_header_timeout 10; send_timeout 10;

    upstream helloapp{
        server localhost:5000;
    }

    server {
        listen     *:80;
        add_header Strict-Transport-Security max-age=15768000;
        return     301 https://$host$request_uri;
    }

    server {
        listen                    *:443 ssl;
        server_name               example.com;
        ssl_certificate           /etc/ssl/certs/testCert.crt;
        ssl_certificate_key       /etc/ssl/certs/testCert.key;
        ssl_protocols             TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_ciphers               &quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&quot;;
        ssl_ecdh_curve            secp384r1;
        ssl_session_cache         shared:SSL:10m;
        ssl_session_tickets       off;
        ssl_stapling              on; #ensure your cert is capable
        ssl_stapling_verify       on; #ensure your cert is capable

        add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;;
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;

        #Redirects all traffic
        location / {
            proxy_pass http://helloapp;
            limit_req  zone=one burst=10 nodelay;
        }
    }
}
"><span><span>http</span> {</span>
<mark>    <span>include</span>        /etc/nginx/proxy.conf;</mark>
<span>    <span>limit_req_zone</span> <span>$binary_remote_addr</span> zone=one:<span>10m</span> rate=5r/s;
    <span>server_tokens</span>  <span>off</span>;

    <span>sendfile</span> <span>on</span>;
    <span>keepalive_timeout</span>   <span>29</span>; <span># Adjust to the lowest possible value that makes sense for your use case.</span>
    <span>client_body_timeout</span> <span>10</span>; <span>client_header_timeout</span> <span>10</span>; <span>send_timeout</span> <span>10</span>;

    <span>upstream</span> helloapp{
        <span>server</span> localhost:<span>5000</span>;
    }

    <span>server</span> {
        <span>listen</span>     *:<span>80</span>;
        <span>add_header</span> Strict-Transport-Security max-age=<span>15768000</span>;
        <span>return</span>     <span>301</span> https://<span>$host</span><span>$request_uri</span>;
    }

    <span>server</span> {
        <span>listen</span>                    *:<span>443</span> ssl;
        <span>server_name</span>               example.com;
        <span>ssl_certificate</span>           /etc/ssl/certs/testCert.crt;
        <span>ssl_certificate_key</span>       /etc/ssl/certs/testCert.key;
        <span>ssl_protocols</span>             TLSv1.<span>1</span> TLSv1.<span>2</span>;
        <span>ssl_prefer_server_ciphers</span> <span>on</span>;
        <span>ssl_ciphers</span>               <span>"EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH"</span>;
        <span>ssl_ecdh_curve</span>            secp384r1;
        <span>ssl_session_cache</span>         shared:SSL:<span>10m</span>;
        <span>ssl_session_tickets</span>       <span>off</span>;
        <span>ssl_stapling</span>              <span>on</span>; <span>#ensure your cert is capable</span>
        <span>ssl_stapling_verify</span>       <span>on</span>; <span>#ensure your cert is capable</span>

        <span>add_header</span> Strict-Transport-Security <span>"max-age=63072000; includeSubdomains; preload"</span>;
        <span>add_header</span> X-Frame-Options DENY;
        <span>add_header</span> X-Content-Type-Options nosniff;

        <span>#Redirects all traffic</span>
        <span>location</span> / {
            <span>proxy_pass</span> http://helloapp;
            <span>limit_req</span>  zone=one burst=<span>10</span> nodelay;
        }
    }
}
</span></code></pre><h4 id="secure-nginx-from-clickjacking"><a href="#secure-nginx-from-clickjacking" aria-labelledby="secure-nginx-from-clickjacking"></a>Secure Nginx from clickjacking</h4>
<p><a href="https://blog.qualys.com/securitylabs/2015/10/20/clickjacking-a-common-implementation-mistake-that-can-put-your-websites-in-danger" data-linktype="external">Clickjacking</a>, also known as a <em>UI redress attack</em>, is a malicious attack where a website visitor is tricked into clicking a link or button on a different page than they're currently visiting. Use <code>X-FRAME-OPTIONS</code> to secure the site.</p>
<p>To mitigate clickjacking attacks:</p>
<ol>
<li><p>Edit the <em>nginx.conf</em> file:</p>
<pre tabindex="0"><code data-author-content="sudo nano /etc/nginx/nginx.conf
"><span>sudo nano /etc/nginx/nginx.conf
</span></code></pre>
<p>Add the line <code>add_header X-Frame-Options "SAMEORIGIN";</code>.</p>
</li>
<li><p>Save the file.</p>
</li>
<li><p>Restart Nginx.</p>
</li>
</ol>
<h4 id="mime-type-sniffing"><a href="#mime-type-sniffing" aria-labelledby="mime-type-sniffing"></a>MIME-type sniffing</h4>
<p>This header prevents most browsers from MIME-sniffing a response away from the declared content type, as the header instructs the browser not to override the response content type. With the <code>nosniff</code> option, if the server says the content is "text/html", the browser renders it as "text/html".</p>
<p>Edit the <em>nginx.conf</em> file:</p>
<pre tabindex="0"><code data-author-content="sudo nano /etc/nginx/nginx.conf
"><span>sudo nano /etc/nginx/nginx.conf
</span></code></pre>
<p>Add the line <code>add_header X-Content-Type-Options "nosniff";</code> and save the file, then restart Nginx.</p>
<h2 id="additional-nginx-suggestions"><a href="#additional-nginx-suggestions" aria-labelledby="additional-nginx-suggestions"></a>Additional Nginx suggestions</h2>
<p>After upgrading the shared framework on the server, restart the ASP.NET Core apps hosted by the server.</p>
<h2 id="additional-resources"><a href="#additional-resources" aria-labelledby="additional-resources"></a>Additional resources</h2>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/core/linux-prerequisites" data-linktype="absolute-path">Prerequisites for .NET Core on Linux</a></li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/install/#official-debian-ubuntu-packages" data-linktype="external">Nginx: Binary Releases: Official Debian/Ubuntu packages</a></li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/test/troubleshoot?view=aspnetcore-3.1" data-linktype="relative-path">Troubleshoot and debug ASP.NET Core projects</a></li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-3.1" data-linktype="relative-path">Configure ASP.NET Core to work with proxy servers and load balancers</a></li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/" data-linktype="external">NGINX: Using the Forwarded header</a></li>
</ul>

						<!-- </content> -->

						</main>

						<!-- recommended content page section -->

							<nav data-bi-name="recommendation-bottom" hidden="" id="recommended-content-center" aria-labelledby="recommended-content-center-title">
								<h3 id="recommended-content-center-title">Related Articles</h3>
							</nav>

						<!-- end recommended content page section -->

						<!-- page rating section -->
								
						<!-- end page rating section -->


						<!-- feedback section -->
<section data-bi-name="feedback-section">

    <h2 id="feedback">Feedback</h2>

    <div>
        <p aria-hidden="true" id="send-feedback-about">Submit and view feedback for</p>

        
    </div>

    
</section>

						<!-- end feedback section -->

						<!-- feedback report section -->
						<!-- end feedback report section -->

						
					</div>

					

					<!--end of div.columns -->
				</div>

			<!--end of .primary-holder -->
			</section>

			
		</div>

		<!--end of .mainContainer -->
	</div>

	

	

	
	<span id="adobe-target-experiment-container" hidden=""></span>


</div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>