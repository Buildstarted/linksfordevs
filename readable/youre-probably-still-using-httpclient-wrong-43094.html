<!DOCTYPE html>
<html lang="en">
<head>
    <title>
You&#x27;re (probably still) using HttpClient wrong... - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="You&#x27;re (probably still) using HttpClient wrong... - linksfor.dev(s)"/>
    <meta property="og:description" content="I try to optimize the fetching and deserialization of data in dotnet core as much as possible. HttpClientFactory and streams are my best friends."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://josefottosson.se/you-are-probably-still-using-httpclient-wrong-and-it-is-destabilizing-your-software/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - You&#x27;re (probably still) using HttpClient wrong...</title>
<div class="readable">
        <h1>You&#x27;re (probably still) using HttpClient wrong...</h1>
            <div>Reading time: 35-45 minutes</div>
        <div>Posted here: 26 Nov 2019</div>
        <p><a href="https://josefottosson.se/you-are-probably-still-using-httpclient-wrong-and-it-is-destabilizing-your-software/">https://josefottosson.se/you-are-probably-still-using-httpclient-wrong-and-it-is-destabilizing-your-software/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><article>

<section>
<div>
<p><em>Required reading before reading this blog post</em>:<br>
<a href="https://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/">You're using HttpClient wrong and it is destabilizing your software</a></p>
<h2 id="tldr">TL;DR</h2>
<ul>
<li>Don't use .Result.</li>
<li>Stream the response instead of storing the whole response in a string.</li>
<li>If you really care about performance, create a custom json deserializer.</li>
<li>Reuse HttpClient (or use IHttpClientFactory).</li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>All code in this blog post can be found <a href="https://github.com/joseftw/JOS.HttpClient">here</a> together with instructions on how to run the benchmarks. This post focuses on dotnet core, the benchmarks are run on dotnet core 3 preview3.</p>
<p>HttpClient is really easy to use, and because of that, it's also really easy to use it wrong. Since it's so easy to use, nobody takes the time to really learn how to use it correctly, my code works, why should I change it? My goal with this post is to show how to use HttpClient in the most efficient way.<br>
What do I mean by <em>the most efficient way</em>?</p>
<ul>
<li>Try to run as fast as possible</li>
<li>Try to allocate as little memory as possible</li>
</ul>
<p><a href="https://www.stevejgordon.co.uk/demystifying-httpclient-internals-sendasync-flow-for-httprequestmessage">Steve Gordon</a> has a bunch of posts regarding HttpClient, I really recommend that you check out his blog if you want to learn more.</p>
<h2 id="theproblem">The problem</h2>
<p>We want to fetch JSON data from an external API and return a subset of it from a controller.<br>
Our architecture will look like this:<br>
Controller -&gt; IGetAllProjectsQuery -&gt; IGitHubClient.<br>
The Query is responsible for mapping the data from DTOs to "domain models".<br>
Note: We will NOT use the real GitHub API, I've created a API that returns dummy data, I just choose to name it GitHub to make the code more...authentic.</p>
<p>The size of the json response will differ between the <a href="#benchmarks">benchmarks</a>, we will run the benchmarks 4 times with the following sizes:</p>
<ul>
<li>10 items ~ 11 KB</li>
<li>100 items ~ 112 KB</li>
<li>1 000 items ~ 1 116 KB</li>
<li>10 000 items ~ 11 134 KB</li>
</ul>
<h2 id="errorhandling">Error handling</h2>
<p>I've intentionally left out all error handling here because I wanted to focus on the code that fetches/deserializes data. I have another post coming up that's full with opinions of how to use HttpClient through out your code base with many different third party integrations together with error handling, Polly and so on, so stay tuned!</p>
<h2 id="withoutihttpclientfactory">Without <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-requests">IHttpClientFactory</a></h2>
<p>This is just to show how one could do this before the IHttpClientFactory existed.<br>
If you don't have access to IHttpClientFactory for whatever reason, look at Version 2 and store the HttpClient as a private field so that it could be reused. Also, don't forget to read the <a href="#optimization">Optimization</a> section!</p>
<h3 id="version0">Version 0</h3>
<p>Ah, only a few lines of code, what could POSSIBLY be wrong with this code?<br>
This code creates a new <code>HttpClient</code> in a using statement, calls <code>.Result</code> on <code>GetStringAsync</code> and <strong>saves the whole response in a string</strong>. It was hard writing this code because it goes against everything I stand for :).</p>
<p><em><strong>Version0Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version0Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion0</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClient.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span>
<span>{</span>
    <span>public</span> IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>using</span> <span>(</span><span>var</span> httpClient <span>=</span> <span>new</span> <span>HttpClient</span><span>{</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span><span>}</span><span>)</span>
        <span>{</span>
            <span>var</span> result <span>=</span> httpClient<span>.</span><span>GetStringAsync</span><span>(</span>GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>.</span>Result<span>;</span>
            <span>return</span> JsonConvert<span>.</span>DeserializeObject<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>result<span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<p><strong>NONE</strong></p>
<h4 id="cons">Cons</h4>
<ul>
<li>Using <code>.Result</code> on an asynchronous method. It's never a good idea, never.<br>
<strong>But what if I use <code>.GetAwaiter().GetResult()</code>???</strong><br>
Nope, still bad. You can read more about common async gotchas/pitfalls/recommendations <a href="https://github.com/davidfowl/AspNetCoreDiagnosticScenarios/blob/master/AsyncGuidance.md">here</a>. It's written by David Fowler (<em>member of the ASP.NET team</em>), he knows what he's talking about.</li>
</ul>
<blockquote data-conversation="none" data-lang="sv"><p lang="en" dir="ltr">There's no god way to run an async method in a sync context. They're all bad :) <a href="https://t.co/zG0RhkAzkY">https://t.co/zG0RhkAzkY</a></p>— David Fowler (@davidfowl) <a href="https://twitter.com/davidfowl/status/1104533307205705728?ref_src=twsrc%5Etfw">10 mars 2019</a></blockquote>

<ul>
<li>Creating a new <code>HttpClient</code> for every call in a using statement. <code>HttpClient</code> should not be disposed (well, it should, but not by you, more on that further down where I talk about <code>IHttpClientFactory</code>.</li>
<li>Fetching the whole response and storing it as a string, this is obviously bad when working with large response objects, they will end up on the <a href="https://docs.microsoft.com/en-us/dotnet/standard/garbage-collection/fundamentals#generations">Large object heap</a> if they are larger than <em>85 000</em> bytes.</li>
</ul>
<h3 id="version1">Version 1</h3>
<p>We have now wrapped the return type in a <code>Task&lt;&gt;</code> and also added the async keyword. This allows us to <code>await</code> the call to <code>.GetStringAsync</code>.</p>
<p><em><strong>Version1Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version1Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion1</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClient.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>using</span> <span>(</span><span>var</span> httpClient <span>=</span> <span>new</span> <span>HttpClient</span> <span>{</span> BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span> <span>}</span><span>)</span>
        <span>{</span>
            <span>var</span> result <span>=</span> <span>await</span> httpClient<span>.</span><span>GetStringAsync</span><span>(</span>GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>
            <span>return</span> JsonConvert<span>.</span>DeserializeObject<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>result<span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>The request to the API is asynchronous.</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>Creating a new HttpClient for every call in a using statement.</li>
<li>Fetching and storing the whole response in a string.</li>
</ul>
<h3 id="version2">Version 2</h3>
<p>We are now creating a <code>HttpClient</code> in the constructor and then storing it as a field so that we can reuse it. <em>Note, all implementations of the GitHubClients so far are intended to be used/registered as singeltons</em></p>
<p><em><strong>Version2Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version2Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion2</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClient.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>HttpClient</span> _httpClient<span>;</span>

    <span>public</span> <span>GitHubClient</span><span>(</span><span>)</span>
    <span>{</span>
        _httpClient <span>=</span> <span>new</span> <span>HttpClient</span> <span>{</span> BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span> <span>}</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> result <span>=</span> <span>await</span> _httpClient<span>.</span><span>GetStringAsync</span><span>(</span>GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>
        <span>return</span> JsonConvert<span>.</span>DeserializeObject<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>result<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>The request to the API is asynchronous.</li>
<li>Reusing the <code>HttpClient</code></li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>Fetching and storing the whole response in a string.</li>
<li>Since we are resuing the <code>HttpClient</code> forever, DNS changes won't be respected. You can read more about that <a href="https://github.com/dotnet/corefx/issues/11224">here</a>.</li>
</ul>
<h2 id="withihttpclientfactory">With <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-requests">IHttpClientFactory</a></h2>
<p>As you have seen so far, it's really easy to use <code>HttpClient</code> wrong, <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests">here's what Microsoft has to say about it</a>.</p>
<blockquote>
<p>The original and well-known HttpClient class can be easily used, but in some cases, it isn't being properly used by many developers.<br>
As a first issue, while this class is disposable, using it with the using statement is not the best choice because even when you dispose HttpClient object, the underlying socket is not immediately released and can cause a serious issue named ‘sockets exhaustion’.</p>
</blockquote>
<blockquote>
<p>Therefore, HttpClient is intended to be instantiated once and reused throughout the life of an application. Instantiating an HttpClient class for every request will exhaust the number of sockets available under heavy loads. That issue will result in SocketException errors. Possible approaches to solve that problem are based on the creation of the HttpClient object as singleton or static.</p>
</blockquote>
<blockquote>
<p>But there’s a second issue with HttpClient that you can have when you use it as singleton or static object. In this case, a singleton or static HttpClient doesn't respect DNS changes.<br>
To address those mentioned issues and make the management of HttpClient instances easier, .NET Core 2.1 introduced a new HttpClientFactory...</p>
</blockquote>
<h3 id="version3">Version 3</h3>
<p>Here, we are injecting the <code>IHttpClientFactory</code> and then using it to create a new HttpClient every time the method gets called.<br>
Yes, we are creating a new HttpClient every time, that's not a bad thing anymore since we are using the <code>IHttpClientFactory</code>.<br>
Straight from Microsoft:</p>
<blockquote>
<p>Each time you get an HttpClient object from the IHttpClientFactory, a new instance is returned. <strong>But each HttpClient uses an HttpMessageHandler that's pooled and reused by the IHttpClientFactory to reduce resource consumption, as long as the HttpMessageHandler's lifetime hasn't expired.</strong><br>
Pooling of handlers is desirable as each handler typically manages its own underlying HTTP connections; creating more handlers than necessary can result in connection delays. Some handlers also keep connections open indefinitely, which can prevent the handler from reacting to DNS changes.</p>
</blockquote>
<p><em><strong>Version3Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version3Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion3</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span>AddHttpClient</span><span>(</span><span>"GitHub"</span><span>,</span> x <span>=</span><span>&gt;</span> <span>{</span> x<span>.</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span><span>;</span> <span>}</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClient.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>IHttpClientFactory</span> _httpClientFactory<span>;</span>

    <span>public</span> <span>GitHubClient</span><span>(</span><span>IHttpClientFactory</span> httpClientFactory<span>)</span>
    <span>{</span>
        _httpClientFactory <span>=</span> httpClientFactory <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>httpClientFactory<span>)</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> httpClient <span>=</span> _httpClientFactory<span>.</span><span>CreateClient</span><span>(</span><span>"GitHub"</span><span>)</span><span>;</span>
        <span>var</span> result <span>=</span> <span>await</span> httpClient<span>.</span><span>GetStringAsync</span><span>(</span>GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>
        <span>return</span> JsonConvert<span>.</span>DeserializeObject<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>result<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>Using <code>IHttpClientFactory</code></li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>Using a <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-2.2#named-clients">named client</a> instead of a <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-2.2#typed-clients">typed one</a>.</li>
<li>Fetching and storing the whole response in a string.</li>
</ul>
<h3 id="version4">Version 4</h3>
<p>Here we are using a typed client instead of a named one. We are registering the typed client with the <code>.AddHttpClient&lt;&gt;</code> method. Note that we also changed the registration of <code>GetAllProjectsQuery</code> from singleton to transient since typed clients are registered as transient.</p>
<p><em><strong>Version4Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version4Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion4</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddTransient</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddHttpClient</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span>x <span>=</span><span>&gt;</span> <span>{</span> x<span>.</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span><span>;</span> <span>}</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClient.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>HttpClient</span> _httpClient<span>;</span>

    <span>public</span> <span>GitHubClient</span><span>(</span><span>HttpClient</span> httpClient<span>)</span>
    <span>{</span>
        _httpClient <span>=</span> httpClient <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>httpClient<span>)</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> result <span>=</span> <span>await</span> _httpClient<span>.</span><span>GetStringAsync</span><span>(</span>GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>
        <span>return</span> JsonConvert<span>.</span>DeserializeObject<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>result<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>Using <code>IHttpClientFactory</code></li>
<li>Using a typed client</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>Needed to change the lifetime of GetAllProjectsQuery from singleton to transient.</li>
<li>Fetching and storing the whole response in a string.</li>
</ul>
<h3 id="version5">Version 5</h3>
<p>I really want my <code>GetAllProjectsQuery</code> to be a singleton. To be able to solve this I've created a <code>GitHubClientFactory</code> that returns a <code>GitHubClient</code>. The trick here is that it resolves the <code>GitHubClient</code> from the ServiceProvider, thus injecting all dependencies that we need, no need to new it up ourselfes. Who taught me that? <a href="https://www.stevejgordon.co.uk/ihttpclientfactory-patterns-using-typed-clients-from-singleton-services">Steve of course</a>.</p>
<p><em><strong>Version5Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version5Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion5</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddHttpClient</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span>x <span>=</span><span>&gt;</span> <span>{</span> x<span>.</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span><span>;</span> <span>}</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClientFactory</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClientFactory.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClientFactory</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>IServiceProvider</span> _serviceProvider<span>;</span>

    <span>public</span> <span>GitHubClientFactory</span><span>(</span><span>IServiceProvider</span> serviceProvider<span>)</span>
    <span>{</span>
        _serviceProvider <span>=</span> serviceProvider<span>;</span>
    <span>}</span>

    <span>public</span> <span>GitHubClient</span> <span>Create</span><span>(</span><span>)</span>
    <span>{</span>
        <span>return</span> _serviceProvider<span>.</span><span><span>GetRequiredService</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<pre><code><span>public</span> <span>class</span> <span>GetAllProjectsQuery</span> <span>:</span> <span>IGetAllProjectsQuery</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>GitHubClientFactory</span> _gitHubClientFactory<span>;</span>

    <span>public</span> <span>GetAllProjectsQuery</span><span>(</span><span>GitHubClientFactory</span> gitHubClientFactory<span>)</span>
    <span>{</span>
        _gitHubClientFactory <span>=</span> gitHubClientFactory <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>gitHubClientFactory<span>)</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>Project<span>&gt;</span><span>&gt;</span> <span>Execute</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> gitHubClient <span>=</span> _gitHubClientFactory<span>.</span><span>Create</span><span>(</span><span>)</span><span>;</span>
        <span>var</span> response <span>=</span> <span>await</span> gitHubClient<span>.</span><span>GetRepositories</span><span>(</span><span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>
        <span>return</span> response<span>.</span><span>Select</span><span>(</span>x <span>=</span><span>&gt;</span> <span>new</span> <span>Project</span><span>(</span>x<span>.</span>Name<span>,</span> x<span>.</span>Url<span>,</span> x<span>.</span>Stars<span>)</span><span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><code>GitHubClient.cs</code><br>
Looks the same as Version 4.</p>
<h4 id="pros">Pros</h4>
<ul>
<li>Using <code>IHttpClientFactory</code></li>
<li>Using a typed client</li>
<li>GetAllProjectsQuery is now a singleton again</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>Fetching and storing the whole response in a string.</li>
</ul>
<h2 id="optimization">Optimization</h2>
<p>So, with version 5 we are using a typed client and GetAllProjectsQuery is registered as a singleton, nice, only thing left is to try to get the code perform as good as possible, I have a few tricks :).</p>
<h3 id="version6">Version 6</h3>
<p>We are now using the <code>.SendAsync</code> method instead of <code>GetStringAsync</code>. This is to allow us to stream the response instead of fetching it as a string. I've added the HttpCompletionOption.ResponseContentRead parameter to the code for brevity, it's the default option.<br>
Now we are streaming the response from the HttpClient straight into the Deserialize method. We are also injecting the JsonSerializer that we have registered as a singleton.</p>
<p><em><strong>Version6Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version6Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion6</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddHttpClient</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span>x <span>=</span><span>&gt;</span> <span>{</span> x<span>.</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span><span>;</span> <span>}</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClientFactory</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>JsonSerializer</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClient.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>HttpClient</span> _httpClient<span>;</span>
    <span>private</span> <span>readonly</span> <span>JsonSerializer</span> _jsonSerializer<span>;</span>

    <span>public</span> <span>GitHubClient</span><span>(</span><span>HttpClient</span> httpClient<span>,</span> <span>JsonSerializer</span> jsonSerializer<span>)</span>
    <span>{</span>
        _httpClient <span>=</span> httpClient <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>httpClient<span>)</span><span>)</span><span>;</span>
        _jsonSerializer <span>=</span> jsonSerializer <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>jsonSerializer<span>)</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> request <span>=</span> <span>CreateRequest</span><span>(</span><span>)</span><span>;</span>
        <span>var</span> result <span>=</span> <span>await</span> _httpClient<span>.</span><span>SendAsync</span><span>(</span>request<span>,</span> HttpCompletionOption<span>.</span>ResponseContentRead<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>

        <span>using</span> <span>(</span><span>var</span> responseStream <span>=</span> <span>await</span> result<span>.</span>Content<span>.</span><span>ReadAsStreamAsync</span><span>(</span><span>)</span><span>)</span>
        <span>{</span>
            <span>using</span> <span>(</span><span>var</span> streamReader <span>=</span> <span>new</span> <span>StreamReader</span><span>(</span>responseStream<span>)</span><span>)</span>
            <span>using</span> <span>(</span><span>var</span> jsonTextReader <span>=</span> <span>new</span> <span>JsonTextReader</span><span>(</span>streamReader<span>)</span><span>)</span>
            <span>{</span>
                <span>return</span> _jsonSerializer<span>.</span>Deserialize<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>jsonTextReader<span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>

    <span>private</span> <span>static</span> <span>HttpRequestMessage</span> <span>CreateRequest</span><span>(</span><span>)</span>
    <span>{</span>
        <span>return</span> <span>new</span> <span>HttpRequestMessage</span><span>(</span>HttpMethod<span>.</span>Get<span>,</span> GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>Using <code>IHttpClientFactory</code></li>
<li>Using a typed client</li>
<li>Streaming the response</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>ResponseContentRead</li>
</ul>
<h3 id="version7">Version 7</h3>
<p>The only difference here is that we are using ResponseHeadersRead instead of ResponseContentRead. You can read more about the difference between ResponseContentRead vs ResponseHeadersRead <a href="https://medium.com/@szntb/getting-burnt-with-httpclient-9c1712151039">here</a> but it basically boils down to that methods using ResponseContentRead waits until both the headers AND content is read where as methods using ResponseHeadersRead just reads the headers and then returns.</p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>HttpClient</span> _httpClient<span>;</span>
    <span>private</span> <span>readonly</span> <span>JsonSerializer</span> _jsonSerializer<span>;</span>

    <span>public</span> <span>GitHubClient</span><span>(</span><span>HttpClient</span> httpClient<span>,</span> <span>JsonSerializer</span> jsonSerializer<span>)</span>
    <span>{</span>
        _httpClient <span>=</span> httpClient <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>httpClient<span>)</span><span>)</span><span>;</span>
        _jsonSerializer <span>=</span> jsonSerializer <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>jsonSerializer<span>)</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> request <span>=</span> <span>CreateRequest</span><span>(</span><span>)</span><span>;</span>
        <span>var</span> result <span>=</span> <span>await</span> _httpClient<span>.</span><span>SendAsync</span><span>(</span>request<span>,</span> HttpCompletionOption<span>.</span>ResponseHeadersRead<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>

        <span>using</span> <span>(</span><span>var</span> responseStream <span>=</span> <span>await</span> result<span>.</span>Content<span>.</span><span>ReadAsStreamAsync</span><span>(</span><span>)</span><span>)</span>
        <span>{</span>
            <span>using</span> <span>(</span><span>var</span> streamReader <span>=</span> <span>new</span> <span>StreamReader</span><span>(</span>responseStream<span>)</span><span>)</span>
            <span>using</span> <span>(</span><span>var</span> jsonTextReader <span>=</span> <span>new</span> <span>JsonTextReader</span><span>(</span>streamReader<span>)</span><span>)</span>
            <span>{</span>
                <span>return</span> _jsonSerializer<span>.</span>Deserialize<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>jsonTextReader<span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>

    <span>private</span> <span>static</span> <span>HttpRequestMessage</span> <span>CreateRequest</span><span>(</span><span>)</span>
    <span>{</span>
        <span>return</span> <span>new</span> <span>HttpRequestMessage</span><span>(</span>HttpMethod<span>.</span>Get<span>,</span> GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>Using <code>IHttpClientFactory</code></li>
<li>Using a typed client</li>
<li>Streaming the response</li>
<li>Using ResponseHeadersRead</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>Maybe the json deserialization could be improved?</li>
</ul>
<h3 id="version8">Version 8</h3>
<p>Here we've created a custom Json deserializer for JSON.Net, you can find a bunch of performance tips regarding JSON.Net <a href="https://www.newtonsoft.com/json/help/html/Performance.htm">here</a>.</p>
<p><em><strong>Version8Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version8Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion8</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddHttpClient</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span>x <span>=</span><span>&gt;</span> <span>{</span> x<span>.</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span><span>;</span> <span>}</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClientFactory</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>JsonSerializer</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>ProjectDeserializer</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>ProjectDeserializer.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>ProjectDeserializer</span>
<span>{</span>
    <span>public</span> IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span> <span>Deserialize</span><span>(</span><span>JsonTextReader</span> jsonTextReader<span>)</span>
    <span>{</span>
        <span>var</span> repositories <span>=</span> <span>new</span> <span><span>List</span><span>&lt;</span><span>GitHubRepositoryDto</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        <span>var</span> currentPropertyName <span>=</span> <span>string</span><span>.</span>Empty<span>;</span>
        <span>GitHubRepositoryDto</span> repository <span>=</span> <span>null</span><span>;</span>
        <span>while</span> <span>(</span>jsonTextReader<span>.</span><span>Read</span><span>(</span><span>)</span><span>)</span>
        <span>{</span>
            <span>switch</span> <span>(</span>jsonTextReader<span>.</span>TokenType<span>)</span>
            <span>{</span>
                <span>case</span> JsonToken<span>.</span>StartObject<span>:</span>
                    repository <span>=</span> <span>new</span> <span>GitHubRepositoryDto</span><span>(</span><span>)</span><span>;</span>
                    <span>continue</span><span>;</span>
                <span>case</span> JsonToken<span>.</span>EndObject<span>:</span>
                    repositories<span>.</span><span>Add</span><span>(</span>repository<span>)</span><span>;</span>
                    <span>continue</span><span>;</span>
                <span>case</span> JsonToken<span>.</span>PropertyName<span>:</span>
                    currentPropertyName <span>=</span> jsonTextReader<span>.</span>Value<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>
                    <span>continue</span><span>;</span>
                <span>case</span> JsonToken<span>.</span>String<span>:</span>
                    <span>switch</span> <span>(</span>currentPropertyName<span>)</span>
                    <span>{</span>
                        <span>case</span> <span>"name"</span><span>:</span>
                            repository<span>.</span>Name <span>=</span> jsonTextReader<span>.</span>Value<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>
                            <span>continue</span><span>;</span>
                        <span>case</span> <span>"url"</span><span>:</span>
                            repository<span>.</span>Url <span>=</span> jsonTextReader<span>.</span>Value<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>
                            <span>continue</span><span>;</span>
                    <span>}</span>
                    <span>continue</span><span>;</span>
                <span>case</span> JsonToken<span>.</span>Integer<span>:</span>
                    <span>switch</span> <span>(</span>currentPropertyName<span>)</span>
                    <span>{</span>
                        <span>case</span> <span>"stars"</span><span>:</span>
                            repository<span>.</span>Stars <span>=</span> <span>int</span><span>.</span><span>Parse</span><span>(</span>jsonTextReader<span>.</span>Value<span>.</span><span>ToString</span><span>(</span><span>)</span><span>)</span><span>;</span>
                            <span>continue</span><span>;</span>
                    <span>}</span>
                    <span>continue</span><span>;</span>
            <span>}</span>
        <span>}</span>
        <span>return</span> repositories<span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><em><strong>GitHubClient.cs</strong></em></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>HttpClient</span> _httpClient<span>;</span>
    <span>private</span> <span>readonly</span> <span>ProjectDeserializer</span> _projectDeserializer<span>;</span>

    <span>public</span> <span>GitHubClient</span><span>(</span><span>HttpClient</span> httpClient<span>,</span> <span>ProjectDeserializer</span> projectDeserializer<span>)</span>
    <span>{</span>
        _httpClient <span>=</span> httpClient <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>httpClient<span>)</span><span>)</span><span>;</span>
        _projectDeserializer <span>=</span> projectDeserializer <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>projectDeserializer<span>)</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> request <span>=</span> <span>CreateRequest</span><span>(</span><span>)</span><span>;</span>
        <span>var</span> result <span>=</span> <span>await</span> _httpClient<span>.</span><span>SendAsync</span><span>(</span>request<span>,</span> HttpCompletionOption<span>.</span>ResponseHeadersRead<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>

        <span>using</span> <span>(</span><span>var</span> streamReader <span>=</span> <span>new</span> <span>StreamReader</span><span>(</span><span>await</span> result<span>.</span>Content<span>.</span><span>ReadAsStreamAsync</span><span>(</span><span>)</span><span>)</span><span>)</span>
        <span>using</span> <span>(</span><span>var</span> jsonTextReader <span>=</span> <span>new</span> <span>JsonTextReader</span><span>(</span>streamReader<span>)</span><span>)</span>
        <span>{</span>
            <span>return</span> _projectDeserializer<span>.</span><span>Deserialize</span><span>(</span>jsonTextReader<span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>

    <span>private</span> <span>static</span> <span>HttpRequestMessage</span> <span>CreateRequest</span><span>(</span><span>)</span>
    <span>{</span>
        <span>return</span> <span>new</span> <span>HttpRequestMessage</span><span>(</span>HttpMethod<span>.</span>Get<span>,</span> GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>Using <code>IHttpClientFactory</code></li>
<li>Using a typed client</li>
<li>Streaming the response</li>
<li>Using ResponseHeadersRead</li>
<li>Optimized the json deserialization</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>As pointed out in the comments, we are still blocking when we are deserializing the response.</li>
</ul>
<h3 id="version9">Version 9</h3>
<p>This version uses <a href="https://docs.microsoft.com/en-us/dotnet/api/system.text.json?view=netcore-3.0">the new json serializer from Microsoft</a>.</p>
<p><em><strong>Version9Configurator.cs</strong></em></p>
<pre><code><span>public</span> <span>static</span> <span>class</span> <span>Version9Configurator</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>void</span> <span>AddVersion9</span><span>(</span><span>this</span> <span>IServiceCollection</span> services<span>)</span>
    <span>{</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GetAllProjectsQuery</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddHttpClient</span><span>&lt;</span><span>GitHubClient</span><span>&gt;</span></span><span>(</span><span>"GitHubClient.Version9"</span><span>,</span> x <span>=</span><span>&gt;</span> <span>{</span> x<span>.</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span>GitHubConstants<span>.</span>ApiBaseUrl<span>)</span><span>;</span> <span>}</span><span>)</span><span>;</span>
        services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>GitHubClientFactory</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p><strong>GitHubClient.cs</strong></p>
<pre><code><span>public</span> <span>class</span> <span>GitHubClient</span> <span>:</span> <span>IGitHubClient</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>HttpClient</span> _httpClient<span>;</span>

    <span>public</span> <span>GitHubClient</span><span>(</span><span>HttpClient</span> httpClient<span>)</span>
    <span>{</span>
        _httpClient <span>=</span> httpClient <span>?</span><span>?</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>httpClient<span>)</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IReadOnlyCollection<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span> <span>GetRepositories</span><span>(</span><span>)</span>
    <span>{</span>
        <span>var</span> request <span>=</span> <span>CreateRequest</span><span>(</span><span>)</span><span>;</span>
        <span>var</span> result <span>=</span> <span>await</span> _httpClient<span>.</span><span>SendAsync</span><span>(</span>request<span>,</span> HttpCompletionOption<span>.</span>ResponseHeadersRead<span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span>

        <span>using</span> <span>(</span><span>var</span> contentStream <span>=</span> <span>await</span> result<span>.</span>Content<span>.</span><span>ReadAsStreamAsync</span><span>(</span><span>)</span><span>)</span>
        <span>{</span>
            <span>return</span> <span>await</span> JsonSerializer<span>.</span>DeserializeAsync<span>&lt;</span>List<span>&lt;</span>GitHubRepositoryDto<span>&gt;</span><span>&gt;</span><span>(</span>contentStream<span>,</span> DefaultJsonSerializerOptions<span>.</span>Options<span>)</span><span>;</span><span>;</span>
        <span>}</span>
    <span>}</span>

    <span>private</span> <span>static</span> <span>HttpRequestMessage</span> <span>CreateRequest</span><span>(</span><span>)</span>
    <span>{</span>
        <span>return</span> <span>new</span> <span>HttpRequestMessage</span><span>(</span>HttpMethod<span>.</span>Get<span>,</span> GitHubConstants<span>.</span>RepositoriesPath<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<h4 id="pros">Pros</h4>
<ul>
<li>Using <code>IHttpClientFactory</code></li>
<li>Using a typed client</li>
<li>Streaming the response</li>
<li>Using ResponseHeadersRead</li>
<li>Using the new System.Text.Json serializer that allows async deserialization.</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>?</li>
</ul>
<h3 id="version10">Version 10</h3>
<p>Your version! Do you think you can make an even better version than my best version? Feel free to send a <a href="https://github.com/joseftw/JOS.HttpClient">PR on GitHub</a> and I will happily add it to the benchmarks and to this post!</p>
<h2 id="benchmarks">Benchmarks</h2>
<p>Time for some data!</p>
<p>I will run the different benchmarks four times, I will change how many items the API returns between the benchmarks.</p>
<ul>
<li>First run: 10 items ~ 11 KB</li>
<li>Second run: 100 items ~ 112 KB</li>
<li>Third run: 1 000 items ~ 1 116 KB</li>
<li>Fourth run: 10 000 items ~ 11 134 KB</li>
</ul>
<p>Every pass in the benchmark run invokes the method 50 times.</p>
<h3 id="benchmark1">Benchmark 1</h3>
<p>This benchmark resolves the GetAllProjectsQuery from the ServiceProvider, fetches the data with the GitHubClient, deserializes it and then maps it to domain objects.</p>
<h4 id="10projects">10 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-VJTEAD : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |       Mean |     Error |      StdDev |     Median | Ratio | RatioSD | Gen 0 | Gen 1 | Gen 2 | Allocated |
|--------- |-----------:|----------:|------------:|-----------:|------:|--------:|------:|------:|------:|----------:|
| Version0 | 1,000.1 us |  19.87 us |    43.62 us |   983.6 us |  1.00 |    0.00 |     - |     - |     - |  75.51 KB |
| Version1 | 3,127.8 us | 482.61 us | 1,423.00 us | 3,948.8 us |  2.53 |    1.64 |     - |     - |     - |  75.29 KB |
| Version2 |   397.0 us |   9.22 us |    26.75 us |   395.4 us |  0.41 |    0.03 |     - |     - |     - |   58.1 KB |
| Version3 |   389.1 us |   7.76 us |    20.03 us |   387.1 us |  0.39 |    0.03 |     - |     - |     - |  60.23 KB |
| Version4 |   407.0 us |  10.31 us |    29.92 us |   399.3 us |  0.41 |    0.03 |     - |     - |     - |  59.32 KB |
| Version5 |   421.8 us |   9.65 us |    27.99 us |   417.3 us |  0.43 |    0.03 |     - |     - |     - |   59.3 KB |
| Version6 |   412.4 us |  12.27 us |    35.59 us |   406.1 us |  0.43 |    0.04 |     - |     - |     - |  53.27 KB |
| Version7 |   394.1 us |   7.84 us |    21.33 us |   393.5 us |  0.40 |    0.03 |     - |     - |     - |  44.25 KB |
| Version8 |   367.4 us |   7.86 us |    22.43 us |   362.7 us |  0.37 |    0.03 |     - |     - |     - |  44.51 KB |
| Version9 | 1,124.6 us |  23.09 us |    39.83 us | 1,116.9 us |  1.11 |    0.06 |     - |     - |     - |  60.97 KB |
</code></pre>
<p><strong>Things to note</strong><br>
Version 7 and 8 allocates the least amount of memory. Version9 that uses the new <code>System.Text.Json</code> serializer allocates <strong>more</strong> than Version 7 and 8 and performs quite bad in general, will this trend continue?</p>
<h4 id="100projects">100 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-LOIBJZ : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |     Mean |     Error |    StdDev | Ratio | RatioSD |   Gen 0 |   Gen 1 |   Gen 2 | Allocated |
|--------- |---------:|----------:|----------:|------:|--------:|--------:|--------:|--------:|----------:|
| Version0 | 9.125 ms | 0.1798 ms | 0.2521 ms |  1.00 |    0.00 | 80.0000 | 40.0000 | 40.0000 | 499.21 KB |
| Version1 | 8.977 ms | 0.1731 ms | 0.1852 ms |  0.98 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 499.58 KB |
| Version2 | 7.911 ms | 0.1979 ms | 0.3082 ms |  0.87 |    0.04 | 80.0000 | 40.0000 | 40.0000 | 482.74 KB |
| Version3 | 7.885 ms | 0.1266 ms | 0.1057 ms |  0.86 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 483.85 KB |
| Version4 | 8.000 ms | 0.1556 ms | 0.1792 ms |  0.87 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 483.96 KB |
| Version5 | 7.812 ms | 0.1544 ms | 0.1585 ms |  0.85 |    0.02 | 80.0000 | 40.0000 | 40.0000 | 483.96 KB |
| Version6 | 7.829 ms | 0.1505 ms | 0.1673 ms |  0.85 |    0.03 | 80.0000 | 20.0000 | 20.0000 | 396.49 KB |
| Version7 | 7.912 ms | 0.1574 ms | 0.1933 ms |  0.86 |    0.03 | 60.0000 |       - |       - | 306.16 KB |
| Version8 | 7.526 ms | 0.0877 ms | 0.0685 ms |  0.82 |    0.03 | 60.0000 |       - |       - | 309.23 KB |
| Version9 | 8.547 ms | 0.1663 ms | 0.1708 ms |  0.93 |    0.03 | 20.0000 |       - |       - | 106.67 KB |
</code></pre>
<p><strong>Things to note</strong><br>
As soon as the size of the json response increased, Version 9 really starts to shine. Version 7 and 8 is not even close when it comes to allocation.</p>
<h4 id="1000projects">1 000 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-LGGORO : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |     Mean |    Error |   StdDev |   Median | Ratio | RatioSD |    Gen 0 |    Gen 1 |    Gen 2 |  Allocated |
|--------- |---------:|---------:|---------:|---------:|------:|--------:|---------:|---------:|---------:|-----------:|
| Version0 | 83.04 ms | 2.763 ms | 8.147 ms | 84.11 ms |  1.00 |    0.00 | 940.0000 | 660.0000 | 400.0000 | 4673.49 KB |
| Version1 | 82.84 ms | 3.010 ms | 8.876 ms | 83.35 ms |  1.00 |    0.13 | 940.0000 | 660.0000 | 400.0000 | 4673.26 KB |
| Version2 | 82.90 ms | 3.000 ms | 8.847 ms | 85.61 ms |  1.01 |    0.16 | 960.0000 | 660.0000 | 420.0000 | 4657.06 KB |
| Version3 | 82.76 ms | 2.990 ms | 8.816 ms | 85.76 ms |  1.01 |    0.15 | 900.0000 | 620.0000 | 380.0000 | 4657.83 KB |
| Version4 | 82.65 ms | 2.870 ms | 8.463 ms | 85.89 ms |  1.01 |    0.16 | 900.0000 | 600.0000 | 380.0000 | 4657.94 KB |
| Version5 | 82.86 ms | 3.107 ms | 9.161 ms | 85.37 ms |  1.01 |    0.16 | 940.0000 | 660.0000 | 400.0000 | 4658.11 KB |
| Version6 | 82.76 ms | 3.146 ms | 9.276 ms | 85.78 ms |  1.01 |    0.16 | 740.0000 | 460.0000 | 220.0000 |  3757.4 KB |
| Version7 | 82.95 ms | 3.090 ms | 9.112 ms | 85.88 ms |  1.01 |    0.15 | 540.0000 | 240.0000 |        - | 2852.27 KB |
| Version8 | 83.06 ms | 2.971 ms | 8.761 ms | 86.83 ms |  1.01 |    0.12 | 560.0000 | 220.0000 |        - | 2883.18 KB |
| Version9 | 82.76 ms | 3.068 ms | 9.047 ms | 86.88 ms |  1.00 |    0.13 | 100.0000 |  40.0000 |        - |  564.68 KB |
</code></pre>
<p><strong>Things to note</strong><br>
Version 9 continues to keep the allocations really low compared to the other verisons.<br>
Except for Version 9, it's only version 7 and 8 that does not cause any gen 2 collects. Version 6 that uses ResponseContentRead causes gen 2 collects but version 7 that uses ResponseHeadersRead does not...</p>
<h4 id="10000projects">10 000 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-WPDQER : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |       Mean |    Error |   StdDev | Ratio | RatioSD |     Gen 0 |     Gen 1 |     Gen 2 | Allocated |
|--------- |-----------:|---------:|---------:|------:|--------:|----------:|----------:|----------:|----------:|
| Version0 |   805.2 ms | 15.08 ms | 14.10 ms |  1.00 |    0.00 | 5740.0000 | 1840.0000 |  980.0000 |  53.98 MB |
| Version1 |   804.1 ms | 16.00 ms | 17.12 ms |  1.00 |    0.02 | 5720.0000 | 1780.0000 |  980.0000 |  53.98 MB |
| Version2 |   811.2 ms | 15.96 ms | 17.08 ms |  1.01 |    0.02 | 5740.0000 | 1880.0000 |  980.0000 |  53.96 MB |
| Version3 |   814.2 ms | 15.79 ms | 14.77 ms |  1.01 |    0.03 | 5680.0000 | 1740.0000 |  980.0000 |  53.96 MB |
| Version4 |   806.5 ms | 13.47 ms | 12.60 ms |  1.00 |    0.03 | 5780.0000 | 1960.0000 |  980.0000 |  53.96 MB |
| Version5 |   803.7 ms | 16.06 ms | 20.88 ms |  1.00 |    0.03 | 5740.0000 | 1880.0000 |  980.0000 |  53.96 MB |
| Version6 | 1,094.9 ms | 28.47 ms | 82.59 ms |  1.20 |    0.19 | 5580.0000 | 1520.0000 | 1000.0000 |  36.36 MB |
| Version7 | 1,108.4 ms | 21.23 ms | 23.60 ms |  1.38 |    0.04 | 4980.0000 | 1300.0000 |  640.0000 |  27.55 MB |
| Version8 | 1,090.0 ms | 21.67 ms | 20.27 ms |  1.35 |    0.04 | 5120.0000 | 1340.0000 |  640.0000 |  27.85 MB |
| Version9 | 1,070.7 ms | 20.35 ms | 19.03 ms |  1.33 |    0.03 | 1000.0000 |  380.0000 |  180.0000 |   5.12 MB |
</code></pre>
<p><strong>Things to note</strong><br>
Version 9, do I need to say more?</p>
<h3 id="benchmark2">Benchmark 2</h3>
<p>This benchmark resolves the GitHubClient from the ServiceProvider, fetches the data and deserializes it.</p>
<h4 id="10projects">10 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-VJTEAD : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |       Mean |    Error |   StdDev | Ratio | RatioSD | Gen 0 | Gen 1 | Gen 2 | Allocated |
|--------- |-----------:|---------:|---------:|------:|--------:|------:|------:|------:|----------:|
| Version0 | 1,057.4 us | 31.31 us | 91.35 us |  1.00 |    0.00 |     - |     - |     - |  74.01 KB |
| Version1 | 1,014.1 us | 20.26 us | 49.32 us |  0.94 |    0.09 |     - |     - |     - |  75.29 KB |
| Version2 |   392.1 us |  7.82 us | 14.11 us |  0.35 |    0.02 |     - |     - |     - |  58.78 KB |
| Version3 |   396.3 us |  7.92 us | 18.66 us |  0.36 |    0.03 |     - |     - |     - |  59.84 KB |
| Version4 |   416.3 us |  8.62 us | 23.46 us |  0.39 |    0.04 |     - |     - |     - |  59.73 KB |
| Version5 |   402.1 us |  8.02 us | 21.54 us |  0.38 |    0.03 |     - |     - |     - |  59.77 KB |
| Version6 |   406.5 us |  8.30 us | 20.82 us |  0.38 |    0.03 |     - |     - |     - |  53.61 KB |
| Version7 |   402.0 us |  8.00 us | 19.16 us |  0.37 |    0.03 |     - |     - |     - |  44.52 KB |
| Version8 |   361.6 us |  7.43 us | 17.36 us |  0.33 |    0.03 |     - |     - |     - |  44.82 KB |
| Version9 | 1,157.0 us | 21.72 us | 20.31 us |  1.00 |    0.05 |     - |     - |     - |  61.89 KB |

</code></pre>
<p><strong>Things to note</strong><br>
Same pattern as in benchmark 1, version 7 and 8 allocates the least amount while version 9 is lagging somewhat behind.</p>
<h4 id="100projects">100 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-LOIBJZ : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |     Mean |     Error |    StdDev | Ratio | RatioSD |   Gen 0 |   Gen 1 |   Gen 2 | Allocated |
|--------- |---------:|----------:|----------:|------:|--------:|--------:|--------:|--------:|----------:|
| Version0 | 9.032 ms | 0.1826 ms | 0.1954 ms |  1.00 |    0.00 | 80.0000 | 40.0000 | 40.0000 | 494.61 KB |
| Version1 | 9.012 ms | 0.1387 ms | 0.1297 ms |  1.00 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 494.67 KB |
| Version2 | 7.833 ms | 0.1551 ms | 0.1375 ms |  0.87 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 477.84 KB |
| Version3 | 7.946 ms | 0.1581 ms | 0.1402 ms |  0.88 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 478.95 KB |
| Version4 | 8.035 ms | 0.1491 ms | 0.2041 ms |  0.89 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 479.03 KB |
| Version5 | 7.855 ms | 0.1564 ms | 0.1463 ms |  0.87 |    0.03 | 80.0000 | 40.0000 | 40.0000 | 479.03 KB |
| Version6 | 7.809 ms | 0.1505 ms | 0.1478 ms |  0.87 |    0.03 | 60.0000 | 20.0000 | 20.0000 |  391.6 KB |
| Version7 | 7.854 ms | 0.2158 ms | 0.2120 ms |  0.87 |    0.03 | 60.0000 |       - |       - | 301.25 KB |
| Version8 | 7.649 ms | 0.1515 ms | 0.2022 ms |  0.84 |    0.03 | 60.0000 |       - |       - | 304.33 KB |
| Version9 | 8.562 ms | 0.1706 ms | 0.2335 ms |  0.95 |    0.04 | 20.0000 |       - |       - | 101.75 KB |
</code></pre>
<p><strong>Things to note</strong><br>
Same pattern as in benchmark 1, Version 9 starts to shine as soon as the repsonse body size goes up.</p>
<h4 id="1000projects">1 000 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-LGGORO : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |     Mean |    Error |   StdDev |   Median | Ratio | RatioSD |    Gen 0 |    Gen 1 |    Gen 2 |  Allocated |
|--------- |---------:|---------:|---------:|---------:|------:|--------:|---------:|---------:|---------:|-----------:|
| Version0 | 82.55 ms | 3.107 ms | 9.162 ms | 84.51 ms |  1.00 |    0.00 | 880.0000 | 660.0000 | 360.0000 | 4626.39 KB |
| Version1 | 82.81 ms | 3.103 ms | 9.149 ms | 82.97 ms |  1.02 |    0.17 | 900.0000 | 660.0000 | 380.0000 | 4626.44 KB |
| Version2 | 82.82 ms | 3.092 ms | 9.116 ms | 85.60 ms |  1.02 |    0.16 | 940.0000 | 620.0000 | 400.0000 | 4609.61 KB |
| Version3 | 82.82 ms | 3.095 ms | 9.125 ms | 84.20 ms |  1.02 |    0.17 | 960.0000 | 660.0000 | 420.0000 | 4610.88 KB |
| Version4 | 82.98 ms | 3.050 ms | 8.994 ms | 85.04 ms |  1.02 |    0.17 | 960.0000 | 660.0000 | 420.0000 | 4610.91 KB |
| Version5 | 82.95 ms | 3.048 ms | 8.986 ms | 85.12 ms |  1.02 |    0.17 | 940.0000 | 660.0000 | 420.0000 | 4610.86 KB |
| Version6 | 82.95 ms | 2.961 ms | 8.729 ms | 85.36 ms |  1.02 |    0.16 | 740.0000 | 420.0000 | 220.0000 |  3710.1 KB |
| Version7 | 82.73 ms | 3.238 ms | 9.549 ms | 82.98 ms |  1.02 |    0.20 | 540.0000 | 200.0000 |        - | 2805.17 KB |
| Version8 | 82.83 ms | 3.021 ms | 8.907 ms | 87.16 ms |  1.02 |    0.16 | 540.0000 | 220.0000 |        - | 2836.09 KB |
| Version9 | 82.74 ms | 3.033 ms | 8.944 ms | 87.21 ms |  1.02 |    0.17 |  80.0000 |  20.0000 |        - |   517.5 KB |
</code></pre>
<h4 id="10000projects">10 000 projects</h4>
<pre><code>BenchmarkDotNet=v0.12.0, OS=Windows 10.0.19025
Intel Core i7-8750H CPU 2.20GHz (Coffee Lake), 1 CPU, 12 logical and 6 physical cores
.NET Core SDK=3.1.100-preview3-014645
  [Host]     : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT
  Job-WPDQER : .NET Core 3.1.0 (CoreCLR 4.700.19.53102, CoreFX 4.700.19.55104), X64 RyuJIT

Runtime=.NET Core 3.1  InvocationCount=50  UnrollFactor=1  

|   Method |     Mean |    Error |   StdDev | Ratio | RatioSD |     Gen 0 |     Gen 1 |    Gen 2 | Allocated |
|--------- |---------:|---------:|---------:|------:|--------:|----------:|----------:|---------:|----------:|
| Version0 | 810.4 ms | 12.61 ms | 11.79 ms |  1.00 |    0.00 | 5740.0000 | 2000.0000 | 980.0000 |  53.52 MB |
| Version1 | 814.2 ms | 16.12 ms | 19.80 ms |  1.00 |    0.03 | 5760.0000 | 2000.0000 | 980.0000 |  53.52 MB |
| Version2 | 808.4 ms | 12.23 ms | 11.44 ms |  1.00 |    0.02 | 5820.0000 | 2000.0000 | 980.0000 |   53.5 MB |
| Version3 | 816.5 ms | 15.44 ms | 17.17 ms |  1.01 |    0.02 | 5820.0000 | 2000.0000 | 980.0000 |  53.51 MB |
| Version4 | 808.7 ms | 13.64 ms | 12.76 ms |  1.00 |    0.03 | 5820.0000 | 2000.0000 | 980.0000 |  53.51 MB |
| Version5 | 808.0 ms | 14.11 ms | 13.20 ms |  1.00 |    0.02 | 5800.0000 | 1960.0000 | 960.0000 |  53.51 MB |
| Version6 | 809.7 ms | 11.95 ms | 11.18 ms |  1.00 |    0.02 | 5780.0000 | 2000.0000 | 980.0000 |   35.9 MB |
| Version7 | 808.9 ms | 12.36 ms | 11.56 ms |  1.00 |    0.02 | 5040.0000 | 1520.0000 | 640.0000 |  27.09 MB |
| Version8 | 813.6 ms | 16.17 ms | 16.60 ms |  1.00 |    0.03 | 5120.0000 | 1220.0000 | 540.0000 |  27.39 MB |
| Version9 | 811.0 ms | 15.26 ms | 14.98 ms |  1.00 |    0.03 |  860.0000 |  300.0000 | 140.0000 |   4.66 MB |
</code></pre>

</div>
</section>


</article></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>