<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How an anti ad-blocker works: Reverse-engineering BlockAdBlock - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="How an anti ad-blocker works: Reverse-engineering BlockAdBlock - linksfor.dev(s)"/>
    <meta property="og:description" content="How I reversed an ad-blocker blocker and learned some history about ad-blocking."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://xy2.dev/article/re-bab/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - How an anti ad-blocker works: Reverse-engineering BlockAdBlock</title>
<div class="readable">
        <h1>How an anti ad-blocker works: Reverse-engineering BlockAdBlock</h1>
            <div>Reading time: 27-34 minutes</div>
        <div>Posted here: 01 Apr 2020</div>
        <p><a href="https://xy2.dev/article/re-bab/">https://xy2.dev/article/re-bab/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><p>If you've used an adblocker, you may have seen <a href="https://blockadblock.com/">BlockAdBlock</a>.
This script detects your ad-blocker and disables website access until you deactivate your adblocker.
But I found myself wondering how it worked.
How does an anti ad-blocker detect adblockers?
And how do adblockers react and block ad-block-blockers?</p><h2 id="reverse-engineering-through-time">Reverse-engineering through time</h2><p>The first thing I did was look at <a href="https://blockadblock.com/configure.php">their site</a>.
BlockAdBlock offers a configurator that allows to specify how long to wait, and how the script even appeared, creating different <em>versions</em> of the script.</p><p>And this got me thinking about versions. What if I could not look at one version, but <strong>all</strong> of them? So I did. I went back in time, using the <strong><a href="https://archive.org/web/">Wayback Machine</a></strong>.
After I downloaded all versions, I took a look and hashed them:</p><details><summary>The list of all BlockAdBlock versions, with <code>sha1sum</code>. <em><small>Click to unroll!</small></em></summary><div><pre><code data-lang="plaintext"><span>6d5eafab2ca816ccd049ad8f796358c0a7a43cf3  20151007203811.js
</span><span>065b4aa813b219abbce76ad20a3216b3481b11bb  20151113115955.js
</span><span>d5dec97a775b2e563f3e4359e4f8f1c3645ba0e5  20160121132336.js
</span><span>8add06cbb79bc25114bd7a2083067ceea9fbb354  20160318193101.js
</span>8add06cbb79bc25114bd7a2083067ceea9fbb354  20160319042810.js
8add06cbb79bc25114bd7a2083067ceea9fbb354  20160331051645.js
8add06cbb79bc25114bd7a2083067ceea9fbb354  20160406061855.js
8add06cbb79bc25114bd7a2083067ceea9fbb354  20160408025028.js
<span>555637904dc9e4bfc6f08bdcae92f0ba0f443ebf  20160415083215.js
</span><span>d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20161120215354.js
</span>d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170525201720.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170606090847.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170703211338.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170707211652.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170813090718.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170915094808.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171005180631.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171019162109.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171109101135.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171127113945.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171211042454.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171227031408.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180202000800.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180412213253.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180419060636.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180530223228.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180815042610.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20181029233809.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20181122190948.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20181122205748.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190324081812.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190420155244.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190424200651.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190903121933.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20200112084838.js
</code></pre></div></details><p>There were six versions, and the last one is from 2016, although I still see sites using BlockAdBlock today.
This is a huge win, because we can reverse the script once, then reverse each <abbr title="Difference between two files, here between our versions">diff</abbr>. We can see scrapped ideas and even leftover debug code.</p><p>You can find <a href="https://github.com/xy2iii/BlockAdBlock-reversed">each version on GitHub</a>.
If you'd like to look at each diff, see <a href="https://github.com/xy2iii/bab-history">this repository</a> where each commit is a different version. <small>I'll include links to the source for each section of this reversing, don't worry.</small></p><h2 id="unpacking">Unpacking</h2><p>As we look at the code, we find that it is not minified, but instead packed by a <a href="http://dean.edwards.name/packer/">JS packer</a> by Dean Edwards.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup></p><details open=""><summary>Dean Edwards’ <a href="http://dean.edwards.name/packer/">packer</a> in BlockAdBlock: only an argument's name changes.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span></code></pre></td><td><pre><code data-lang="js"><span>eval</span><span>(</span><span>function</span><span>(</span><span>p</span><span>,</span> <span>a</span><span>,</span> <span>c</span><span>,</span> <span>k</span><span>,</span> <span>e</span><span>,</span> <span>d</span><span>)</span> <span>{</span>
    <span>e</span> <span>=</span> <span>function</span><span>(</span><span>c</span><span>)</span> <span>{</span>
        <span>return</span> <span>(</span><span>c</span> <span>&lt;</span> <span>a</span> <span>?</span> <span>''</span> <span>:</span> <span>e</span><span>(</span><span>parseInt</span><span>(</span><span>c</span> <span>/</span> <span>a</span><span>)</span><span>)</span><span>)</span> <span>+</span> <span>(</span><span>(</span><span>c</span> <span>=</span> <span>c</span> <span>%</span> <span>a</span><span>)</span> <span>&gt;</span> <span>35</span> <span>?</span> <span>String</span><span>.</span><span>fromCharCode</span><span>(</span><span>c</span> <span>+</span> <span>29</span><span>)</span> <span>:</span> <span>c</span><span>.</span><span>toString</span><span>(</span><span>36</span><span>)</span><span>)</span>
    <span>}</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>''</span><span>.</span><span>replace</span><span>(</span><span>/^/</span><span>,</span> <span>String</span><span>)</span><span>)</span> <span>{</span>
        <span>while</span> <span>(</span><span>c</span><span>--</span><span>)</span> <span>{</span>
            <span>d</span><span>[</span><span>e</span><span>(</span><span>c</span><span>)</span><span>]</span> <span>=</span> <span>k</span><span>[</span><span>c</span><span>]</span> <span>||</span> <span>e</span><span>(</span><span>c</span><span>)</span>
        <span>}</span>
        <span>k</span> <span>=</span> <span>[</span><span>function</span><span>(</span><span>e</span><span>)</span> <span>{</span>
            <span>return</span> <span>d</span><span>[</span><span>e</span><span>]</span>
        <span>}</span><span>]</span><span>;</span>
        <span>e</span> <span>=</span> <span>function</span><span>(</span><span>)</span> <span>{</span>
            <span>return</span> <span>'\\w+'</span>
        <span>}</span><span>;</span>
        <span>c</span> <span>=</span> <span>1</span>
    <span>}</span><span>;</span>
    <span>while</span> <span>(</span><span>c</span><span>--</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>k</span><span>[</span><span>c</span><span>]</span><span>)</span> <span>{</span>
            <span>p</span> <span>=</span> <span>p</span><span>.</span><span>replace</span><span>(</span><span>new</span> <span>RegExp</span><span>(</span><span>'\\b'</span> <span>+</span> <span>e</span><span>(</span><span>c</span><span>)</span> <span>+</span> <span>'\\b'</span><span>,</span> <span>'g'</span><span>)</span><span>,</span> <span>k</span><span>[</span><span>c</span><span>]</span><span>)</span>
        <span>}</span>
    <span>}</span>
    <span>return</span> <span>p</span>
<span>}</span><span>(</span><span>'0.1("2 3 4 5 6 7 8\'d. 9, h? a b c d e f g");i j=\'a\'+\'k\'+\'e\'+\'l\'+\'n\'+\'m\'+\'e\';'</span><span>,</span><span>24</span><span>,</span><span>24</span><span>,</span>
<span>'console|log|This|code|will|get|unpacked|then|eval|Cool||||||||huh|let|you|w|s||o'</span><span>.</span><span>split</span><span>(</span><span>'|'</span><span>)</span><span>,</span><span>0</span><span>,</span><span>{</span><span>}</span><span>)</span><span>)</span>
</code></pre></td></tr></tbody></table></div></div></details><p>Thankfully, we don't have to worry about this.
The packer's weakness is that any code it unpacks must be passed to <code>eval()</code>.
If we replace the <code>eval()</code> with something like <code>console.log()</code>, suddently we get the whole source code and the packer is defeated.<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></p><p>Once we've done that for each version, we can examine each version, as well as the added features over the years.</p><h2 id="version-1----november-2015-initial-script">Version 1 (? - November 2015): initial script</h2><p>We start by taking a look at <code>20151007203811.js</code>, around November 2015.<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup> Although this first version does very little adblock-blocking, it allows us to take a look at BlockAdBlock's architecture, without the cruft that accumulated over the years.</p><h3 id="architecture">Architecture</h3><p>In three sentences:</p><ul><li>BlockAdBlock is a closure returning an object with three functions:<ul><li><code>bab()</code>, which sets up bait most of the time, calling <code>check</code></li><li><code>check()</code>, which checks if the adblocker blocked the bait, calling <code>arm</code></li><li><code>arm()</code>, which creates the overlay.</li></ul></li><li>The entrypoint, <code>bab()</code>, is then fired after a set amount of time.</li><li>The three returned functions are generated with arguments from the closure, which are set in the <a href="https://blockadblock.com/configure.php">BlockAdBlock customizer</a>.</li></ul><details open=""><summary>The code is built around a closure, assigned to a global object with a random name.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span></code></pre></td><td><pre><code data-lang="js"><span>var</span> <span>randomID</span> <span>=</span> <span>''</span><span>,</span>
    <span>e</span> <span>=</span> <span>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span><span>;</span>
<span>for</span> <span>(</span><span>var</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>12</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>randomID</span> <span>+=</span> 
    <span>e</span><span>.</span><span>charAt</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>e</span><span>.</span><span>length</span><span>)</span><span>)</span><span>;</span>
<span>var</span> <span>setTimeoutDelay</span> <span>=</span> <span>7</span><span>;</span> <span>// Delay after which to call BlockAdBlock
</span><span></span><span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span> <span>=</span> <span>...</span>
</code></pre></td></tr></tbody></table></div></div></details><details open=""><summary>It returns a three-function object: <code>bab</code>, <code>check</code> and <code>arm</code>.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span><span>7
</span><span>8
</span></code></pre></td><td><pre><code data-lang="js"><span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span> <span>=</span> <span>(</span><span>function</span><span>(</span><span>)</span> <span>{</span>
    <span>var</span> <span>eid</span> <span>=</span> <span>...</span>
    <span>return</span> <span>{</span>
        <span>bab</span><span>:</span> <span>function</span><span>(</span><span>check</span><span>,</span> <span>passed_eid</span><span>)</span> <span>{</span><span>}</span><span>,</span>
        <span>check</span><span>:</span> <span>function</span><span>(</span><span>checkPredicate</span><span>,</span> <span>unused</span><span>)</span> <span>{</span><span>}</span><span>,</span>
        <span>arm</span><span>:</span> <span>function</span><span>(</span><span>)</span> <span>{</span><span>}</span>
    <span>}</span>
<span>}</span><span>)</span><span>(</span><span>)</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><details open=""><summary>The entrypoint, <code>bab()</code>, is called via <code>setTimeout()</code>.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td><td><pre><code data-lang="js"><span>setTimeout</span><span>(</span><span>'window[\'\' + randomID + \'\'] \
</span><span>.bab(window[\'\' + randomID + \'\'].check, \
</span><span>     window[\'\' + randomID + \'\'].bab_elementid)'</span><span>,</span> <span>setTimeoutDelay</span> <span>*</span> <span>1000</span><span>)</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><p>The closure has outer variables. Two of them serve to keep state in the script:</p><ul><li><code>adblockDetected</code> is 1 if an adblocker is detected.</li><li><code>nagMode</code> is a customization option. If set, the script will only nag you once to disable your adblocker, rather than block access.</li></ul><details><summary>Other outer variables in the closure control apparence and behavior, set in the <a href="https://blockadblock.com/configure.php">customizer</a>.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span></code></pre></td><td><pre><code data-lang="js"><span>var</span> <span>eid</span> <span>=</span> <span>' ad_box'</span><span>,</span> <span>// Name of the bait.
</span><span></span>    <span>__u1</span> <span>=</span> <span>1</span><span>,</span> <span>// Unused.
</span><span></span>
    <span>// Colors for the blockadblock prompt.
</span><span></span>    <span>overlayColor</span> <span>=</span> <span>'#EEEEEE'</span><span>,</span>
    <span>textColor</span> <span>=</span> <span>'#777777'</span><span>,</span>
    <span>buttonBackgroundColor</span> <span>=</span> <span>'#adb8ff'</span><span>,</span>
    <span>buttonColor</span> <span>=</span> <span>'#FFFFFF'</span><span>,</span>

    <span>__u2</span> <span>=</span> <span>''</span><span>,</span> <span>// Unused.
</span><span></span>
    <span>// Text to display when the blockadblock prompt is shown.
</span><span></span>    <span>welcomeText</span> <span>=</span> <span>'Sorry for the interruption...'</span><span>,</span>
    <span>primaryText</span> <span>=</span> <span>'It looks like you\'re using an ad blocker. That\'s okay.  Who doesn\'t?'</span><span>,</span>
    <span>subtextText</span> <span>=</span> <span>'But without advertising-income, we can\'t keep making this site awesome.'</span><span>,</span>
    <span>buttonText</span> <span>=</span> <span>'I understand, I have disabled my ad blocker.  Let me in!'</span><span>,</span>

    <span>// If 1, adblock was detected.
</span><span></span>    <span>adblockDetected</span> <span>=</span> <span>0</span><span>,</span>
    <span>// If 1, BlockAdBlock will only nag the visitor once, rather than block access.
</span><span></span>    <span>nagMode</span> <span>=</span> <span>0</span><span>,</span>

    <span>// The blockadblock domain, reversed.
</span><span></span>    <span>bab_domain</span> <span>=</span> <span>'moc.kcolbdakcolb'</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><p>BlockAdBlock's central detection method is by creating “bait” ad elements, that look like real ads.
It then checks if the adblocker blocked them.</p><details open=""><summary>A bait is created: a fake div pretending to be an ad, but hidden out of view.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span></code></pre></td><td><pre><code data-lang="js"><span>bab</span><span>:</span> <span>function</span><span>(</span><span>check</span><span>,</span> <span>passed_eid</span><span>)</span> <span>{</span>
    <span>// Wait for the document to be ready.
</span><span></span>    <span>if</span> <span>(</span><span>typeof</span> <span>document</span><span>.</span><span>body</span> <span>==</span> <span>'undefined'</span><span>)</span> <span>{</span>
        <span>return</span>
    <span>}</span><span>;</span>

    <span>var</span> <span>delay</span> <span>=</span> <span>'0.1'</span><span>,</span> 
        <span>passed_eid</span> <span>=</span> <span>eid</span> <span>?</span> <span>eid</span> <span>:</span> <span>'banner_ad'</span><span>,</span>
        <span>bait</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>'DIV'</span><span>)</span><span>;</span>
        
    <span>bait</span><span>.</span><span>id</span> <span>=</span> <span>passed_eid</span><span>;</span>
    <span>bait</span><span>.</span><span>style</span><span>.</span><span>position</span> <span>=</span> <span>'absolute'</span><span>;</span>
    <span>bait</span><span>.</span><span>style</span><span>.</span><span>left</span> <span>=</span> <span>'-999px'</span><span>;</span>
    <span>bait</span><span>.</span><span>appendChild</span><span>(</span><span>document</span><span>.</span><span>createTextNode</span><span>(</span><span>' '</span><span>)</span><span>)</span><span>;</span>
    <span>document</span><span>.</span><span>body</span><span>.</span><span>appendChild</span><span>(</span><span>bait</span><span>)</span><span>;</span>
    <span>...</span>
</code></pre></td></tr></tbody></table></div></div></details><details open=""><summary>Afterwards, <code>check</code> if the bait was removed by the adblocker.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span></code></pre></td><td><pre><code data-lang="js">    <span>...</span>
    <span>setTimeout</span><span>(</span><span>function</span><span>(</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>bait</span><span>)</span> <span>{</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>clientHeight</span> <span>==</span> <span>0</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>clientWidth</span> <span>==</span> <span>0</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>display</span> <span>==</span> <span>'hidden'</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>visibility</span> <span>==</span> <span>'none'</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>opacity</span> <span>==</span> <span>0</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>left</span> <span>&lt;</span> <span>1000</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>top</span> <span>&lt;</span> <span>1000</span><span>)</span><span>,</span> <span>delay</span><span>)</span>
        <span>}</span> <span>else</span> <span>{</span>
            <span>check</span><span>(</span><span>true</span><span>,</span> <span>delay</span><span>)</span>
        <span>}</span>
    <span>}</span><span>,</span> <span>125</span><span>)</span>
<span>}</span>
</code></pre></td></tr></tbody></table></div></div></details><details open=""><summary><code>check</code> will trigger if the predicate was true, and trigger <code>arm</code>.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span></code></pre></td><td><pre><code data-lang="js"><span>check</span><span>:</span> <span>function</span><span>(</span><span>checkPredicate</span><span>,</span> <span>unused</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>(</span><span>checkPredicate</span><span>)</span> <span>&amp;&amp;</span> <span>(</span><span>adblockDetected</span> <span>==</span> <span>0</span><span>)</span><span>)</span> <span>{</span>
        <span>adblockDetected</span> <span>=</span> <span>1</span><span>;</span>
        <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>arm</span><span>(</span><span>)</span>
    <span>}</span> <span>else</span> <span>{</span><span>}</span>
<span>}</span>
</code></pre></td></tr></tbody></table></div></div></details><h3 id="nag-mode">Nag mode</h3><p>BlockAdBlock has an feature called “nag mode”: in this mode, BlockAdBlock will only tell you to remove your adblocker once, instead of blocking you on each visit.
It does so by setting a <code>localStorage</code> item after the first visit.</p><p>If we could set this for every, could we bypass BlockAdBlock forever? Unfortunately, BlockAdBlock checks beforehand if the script has been configured to nag mode, so this won't work for default usage, which is to block every time.</p><details open=""><summary>The start of <code>arm</code>, checking for nag mode.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span><span> 2
</span></span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span></code></pre></td><td><pre><code data-lang="js"><span>arm</span><span>:</span> <span>function</span><span>(</span><span>)</span> <span>{</span>
<span>    <span>if</span> <span>(</span><span>nagMode</span> <span>==</span> <span>1</span><span>)</span> <span>{</span>
</span>        <span>var</span> <span>babNag</span> <span>=</span> <span>sessionStorage</span><span>.</span><span>getItem</span><span>(</span><span>'babn'</span><span>)</span><span>;</span>
        <span>if</span> <span>(</span><span>babNag</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
            <span>return</span> <span>true</span> <span>// Stop the script.
</span><span></span>        <span>}</span> <span>else</span> <span>{</span>
            <span>sessionStorage</span><span>.</span><span>setItem</span><span>(</span><span>'babn'</span><span>,</span> <span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>+</span> <span>1</span><span>)</span> <span>*</span> <span>1000</span><span>)</span>
        <span>}</span>
    <span>}</span><span>;</span>
    <span>...</span>
</code></pre></td></tr></tbody></table></div></div></details><h3 id="blocking-blockadblock-version-1">Blocking BlockAdBlock, version 1</h3><p>Adblockers work by using what's called filters: lines of code that can block network requests and hide elements on the page.
By creating “bait” elements, BlockAdBlock triggers these filters on purpose.</p><p>With this simple defense, BlockAdBlock works against all major adblockers, like uBlock Origin, AdBlock Plus and Ghostery. To counter against this, we must write our own filter that's active only on BlockAdBlock-enhanced websites.</p><p><a href="https://help.eyeo.com/en/adblockplus/how-to-write-filters">Writing adblock filters</a> is a bit tricky.
The kind of filter we need is a <strong><a href="https://help.eyeo.com/en/adblockplus/how-to-write-filters#content-filters">content filter</a></strong>, which blocks elements on the page generated after download. Since the bait ad has an id of <code>banner_ad</code>, we create an <a href="https://help.eyeo.com/en/adblockplus/how-to-write-filters#elemhide_basic">element hiding exception</a>, marked <code>#@#</code>, for all elements <code>#</code> with id <code>banner_ad</code>, and put it in our adblocker's custom filter list.</p><p>Putting it all together, we get:</p><details open=""><summary>Defeating BlockAdBlock, version 1.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span></code></pre></td><td><pre><code data-lang="css"><span>localhost</span><span>#</span><span>@</span><span>#</span> <span>#</span><span>banner_ad</span>
</code></pre></td></tr></tbody></table></div></div></details><p>This counters BlockAdBlock successfully. The solution may seem basic, but it got the job done for a long time in the <a href="https://github.com/reek/anti-adblock-killer/blob/master/anti-adblock-killer-filters.txt#L150">Anti-AdBlock-Killer filter list</a>.</p><h2 id="version-2-november-2015---january-2016-a-few-improvements">Version 2 (November 2015 - January 2016): a few improvements</h2><p>There's a subtle bug in the first <a href="#bab-bait-ad-creation">bait ad creation</a> implementation above: the div that's created has no content, so it creates a 0 height by 0 width div.
Later, the code checks if the div was removed if the height and width of the bait div was empty. But since the div had 0 height, BlockAdBlock would always trigger.<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup></p><details open=""><summary>Fixing the empty div bug.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre><code data-lang="js"><span>bab</span><span>:</span> <span>function</span><span>(</span><span>...</span><span>)</span> <span>{</span>
    <span>bait</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>'DIV'</span><span>)</span><span>;</span>
    <span>...</span>
    <span>bait</span><span>.</span><span>appendChild</span><span>(</span><span>document</span><span>.</span><span>createTextNode</span><span>(</span><span>'Â '</span><span>)</span><span>)</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><h3 id="detection-via-fake-image-ads">Detection via fake image ads</h3><p>In this method, we create a fake image with a random name on <code>doubleclick.net</code>. Adblockers will block the image, thinking it to be an ad's image. However, this requires no change to block in our filter.</p><details open=""><summary>Creating a fake image ad.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre><code data-lang="js"><span>bab</span><span>:</span> <span>function</span><span>(</span><span>...</span><span>)</span> <span>{</span>
    <span>bait</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>'DIV'</span><span>)</span><span>;</span>
    <span>bait</span><span>.</span><span>innerHTML</span> <span>=</span> <span>'&lt;img src="http://doubleclick.net/'</span> <span>+</span> <span>randomStr</span><span>(</span><span>)</span> <span>+</span> <span>'.jpg"&gt;'</span><span>;</span>
    <span>...</span>
</code></pre></td></tr></tbody></table></div></div></details><p>The other notable difference is the use of a <code>setInterval</code> timer instead of just checking once if the trigger is set.
It newly checks if the image ad still exists, and if its <code>src</code> attribute hasn't been modified, by checking the contents of the bait.</p><details open=""><summary>A new <code>setInterval</code>, and checking for the image's existence.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span><span>10
</span></span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span></code></pre></td><td><pre><code data-lang="js">    <span>...</span>
    <span>checkCallback</span> <span>=</span> <span>setInterval</span><span>(</span><span>function</span><span>(</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>bait</span><span>)</span> <span>{</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>clientHeight</span> <span>==</span> <span>0</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>clientWidth</span> <span>==</span> <span>0</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>display</span> <span>==</span> <span>'hidden'</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>visibility</span> <span>==</span> <span>'none'</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>check</span><span>(</span><span>(</span><span>bait</span><span>.</span><span>opacity</span> <span>==</span> <span>0</span><span>)</span><span>,</span> <span>delay</span><span>)</span><span>;</span>
            <span>try</span> <span>{</span>
<span>                <span>check</span><span>(</span><span>(</span><span>document</span><span>.</span><span>getElementById</span><span>(</span><span>'banner_ad'</span><span>)</span><span>.</span><span>innerHTML</span><span>.</span><span>indexOf</span><span>(</span><span>'click'</span><span>)</span> <span>==</span> <span>-</span><span>1</span><span>)</span><span>,</span> <span>delay</span><span>)</span>
</span>            <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span><span>}</span>
        <span>}</span> <span>else</span> <span>{</span>
            <span>check</span><span>(</span><span>true</span><span>,</span> <span>delay</span><span>)</span>
        <span>}</span>
    <span>}</span><span>,</span> <span>1000</span>
</code></pre></td></tr></tbody></table></div></div></details><h2 id="version-3-november-2015---march-2016-generalized-baiting">Version 3 (November 2015 - March 2016): generalized baiting</h2><h3 id="bait-ad-creation-randomized-ids">Bait ad creation: randomized IDs</h3><p>The only change in this version, though a significant one, is the appearance of randomized IDs for the bait ad.
A new ID is taken from a list of ad IDs at page load, and is used for the bait ad, now placed in the middle of the page.</p><details><summary>The list of random bait IDs.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span><span>34
</span><span>35
</span><span>36
</span><span>37
</span><span>38
</span><span>39
</span><span>40
</span><span>41
</span><span>42
</span><span>43
</span><span>44
</span><span>45
</span><span>46
</span><span>47
</span><span>48
</span><span>49
</span><span>50
</span><span>51
</span><span>52
</span><span>53
</span><span>54
</span><span>55
</span><span>56
</span></code></pre></td><td><pre><code data-lang="js"><span>var</span> <span>baitIDs</span> <span>=</span> <span>[</span>
  <span>"ad-left"</span><span>,</span>
  <span>"adBannerWrap"</span><span>,</span>
  <span>"ad-frame"</span><span>,</span>
  <span>"ad-header"</span><span>,</span>
  <span>"ad-img"</span><span>,</span>
  <span>"ad-inner"</span><span>,</span>
  <span>"ad-label"</span><span>,</span>
  <span>"ad-lb"</span><span>,</span>
  <span>"ad-footer"</span><span>,</span>
  <span>"ad-container"</span><span>,</span>
  <span>"ad-container-1"</span><span>,</span>
  <span>"ad-container-2"</span><span>,</span>
  <span>"Ad300x145"</span><span>,</span>
  <span>"Ad300x250"</span><span>,</span>
  <span>"Ad728x90"</span><span>,</span>
  <span>"AdArea"</span><span>,</span>
  <span>"AdFrame1"</span><span>,</span>
  <span>"AdFrame2"</span><span>,</span>
  <span>"AdFrame3"</span><span>,</span>
  <span>"AdFrame4"</span><span>,</span>
  <span>"AdLayer1"</span><span>,</span>
  <span>"AdLayer2"</span><span>,</span>
  <span>"Ads_google_01"</span><span>,</span>
  <span>"Ads_google_02"</span><span>,</span>
  <span>"Ads_google_03"</span><span>,</span>
  <span>"Ads_google_04"</span><span>,</span>
  <span>"DivAd"</span><span>,</span>
  <span>"DivAd1"</span><span>,</span>
  <span>"DivAd2"</span><span>,</span>
  <span>"DivAd3"</span><span>,</span>
  <span>"DivAdA"</span><span>,</span>
  <span>"DivAdB"</span><span>,</span>
  <span>"DivAdC"</span><span>,</span>
  <span>"AdImage"</span><span>,</span>
  <span>"AdDiv"</span><span>,</span>
  <span>"AdBox160"</span><span>,</span>
  <span>"AdContainer"</span><span>,</span>
  <span>"glinkswrapper"</span><span>,</span>
  <span>"adTeaser"</span><span>,</span>
  <span>"banner_ad"</span><span>,</span>
  <span>"adBanner"</span><span>,</span>
  <span>"adbanner"</span><span>,</span>
  <span>"adAd"</span><span>,</span>
  <span>"bannerad"</span><span>,</span>
  <span>" ad_box"</span><span>,</span>
  <span>" ad_channel"</span><span>,</span>
  <span>" adserver"</span><span>,</span>
  <span>" bannerid"</span><span>,</span>
  <span>"adslot"</span><span>,</span>
  <span>"popupad"</span><span>,</span>
  <span>"adsense"</span><span>,</span>
  <span>"google_ad"</span><span>,</span>
  <span>"outbrain-paid"</span><span>,</span>
  <span>"sponsored_link"</span>
<span>]</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><details open=""><summary>Random ID generation.</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span></code></pre></td><td><pre><code data-lang="js">    <span>randomBaitID</span> <span>=</span> <span>baitIDs</span><span>[</span> <span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>baitIDs</span><span>.</span><span>length</span><span>)</span> <span>]</span><span>,</span>
    <span>...</span>
    <span>var</span> <span>passed_eid</span> <span>=</span> <span>randomBaitID</span><span>;</span>
    <span>bait</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>'DIV'</span><span>)</span><span>;</span>    
    <span>bait</span><span>.</span><span>id</span> <span>=</span> <span>passed_eid</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><h3 id="blocking-blockadblock-version-3-to-latest">Blocking BlockAdBlock, version 3 to latest</h3><p>BlockAdBlock uses the blind spot of adblockers: if the filter allows all the above IDs, then it also allows genuine ads to pass through.
If you don't allow blocking the above IDs, then other filters which may use these IDs in their filters to target ads will not work anymore.</p><p>In a way, BlockAdBlock is <strong>forcing the adblocker to make itself useless</strong>.</p><p>In adblockers, we can run arbitrary JS before anything in the page runs. We could try to delete the BlockAdBlock object prematurely.
But to do that, we need the name of the object BlockAdBlock is attached to, <a href="#architecture">which is randomized each run,</a> which would require running the code.</p><p>uBlock Origin took another approach. The code is ran by <code>eval</code>, so what if we could define our own <code>eval</code> function that would block execution if we detect BlockAdBlock? In JS the <code>Proxy</code> object can accomplish this: any property, affectation and method can be replaced for any object.</p><p>This could be bypassed by not <code>eval</code>ing the initial BlockAdBlock payload and using it directly, so we also proxy the entrypoint: the <code>setTimeout</code> call. Since setTimeout is passed a string and not a function, we check the string.</p><details open=""><summary>Defeating BlockAdBlock in <a href="https://github.com/gorhill/uBlock/blob/master/src/web_accessible_resources/nobab.js">uBlock Origin (src)</a>.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span></code></pre></td><td><pre><code data-lang="js"><span>const</span> <span>signatures</span> <span>=</span> <span>[</span>
    <span>[</span> <span>'blockadblock'</span> <span>]</span><span>,</span>
    <span>[</span> <span>'babasbm'</span> <span>]</span><span>,</span>
    <span>[</span> <span>/getItem\('babn'\)/</span> <span>]</span><span>,</span>
    <span>[</span>
        <span>'getElementById'</span><span>,</span>
        <span>'String.fromCharCode'</span><span>,</span>
        <span>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span><span>,</span>
        <span>'charAt'</span><span>,</span>
        <span>'DOMContentLoaded'</span><span>,</span>
        <span>'AdBlock'</span><span>,</span>
        <span>'addEventListener'</span><span>,</span>
        <span>'doScroll'</span><span>,</span>
        <span>'fromCharCode'</span><span>,</span>
        <span>'&lt;&lt;2|r&gt;&gt;4'</span><span>,</span>
        <span>'sessionStorage'</span><span>,</span>
        <span>'clientWidth'</span><span>,</span>
        <span>'localStorage'</span><span>,</span>
        <span>'Math'</span><span>,</span>
        <span>'random'</span>
    <span>]</span><span>,</span>
<span>]</span><span>;</span>
<span>const</span> <span>check</span> <span>=</span> <span>function</span><span>(</span><span>s</span><span>)</span> <span>{</span>
    <span>// check for signature 
</span><span></span><span>}</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><details open=""><summary><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxying</a> the <code>eval</code> and <code>setTimeout</code> functions.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span></code></pre></td><td><pre><code data-lang="js"><span>window</span><span>.</span><span>eval</span> <span>=</span> <span>new</span> <span>Proxy</span><span>(</span><span>window</span><span>.</span><span>eval</span><span>,</span> <span>{</span>
    <span>apply</span><span>:</span> <span>function</span><span>(</span><span>target</span><span>,</span> <span>thisArg</span><span>,</span> <span>args</span><span>)</span> <span>{</span>
        <span>const</span> <span>a</span> <span>=</span> <span>args</span><span>[</span><span>0</span><span>]</span><span>;</span>
        <span>if</span> <span>(</span> <span>typeof</span> <span>a</span> <span>!==</span> <span>'string'</span> <span>||</span> <span>!</span><span>check</span><span>(</span><span>a</span><span>)</span> <span>)</span> <span>{</span>
            <span>return</span> <span>target</span><span>.</span><span>apply</span><span>(</span><span>thisArg</span><span>,</span> <span>args</span><span>)</span><span>;</span>
        <span>}</span> 
        <span>// BAB detected: clean up.
</span><span></span>        <span>if</span> <span>(</span> <span>document</span><span>.</span><span>body</span> <span>)</span> <span>{</span>
            <span>document</span><span>.</span><span>body</span><span>.</span><span>style</span><span>.</span><span>removeProperty</span><span>(</span><span>'visibility'</span><span>)</span><span>;</span>
        <span>}</span>
        <span>let</span> <span>el</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>'babasbmsgx'</span><span>)</span><span>;</span>
        <span>if</span> <span>(</span> <span>el</span> <span>)</span> <span>{</span>
            <span>el</span><span>.</span><span>parentNode</span><span>.</span><span>removeChild</span><span>(</span><span>el</span><span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>
<span>}</span><span>)</span><span>;</span>
<span>window</span><span>.</span><span>setTimeout</span> <span>=</span> <span>new</span> <span>Proxy</span><span>(</span><span>window</span><span>.</span><span>setTimeout</span><span>,</span> <span>{</span>
    <span>apply</span><span>:</span> <span>function</span><span>(</span><span>target</span><span>,</span> <span>thisArg</span><span>,</span> <span>args</span><span>)</span> <span>{</span>
        <span>const</span> <span>a</span> <span>=</span> <span>args</span><span>[</span><span>0</span><span>]</span><span>;</span>
        <span>// Check that the passed string is not the BAB entrypoint.
</span><span></span>        <span>if</span> <span>(</span>
            <span>typeof</span> <span>a</span> <span>!==</span> <span>'string'</span> <span>||</span>
            <span>/\.bab_elementid.$/</span><span>.</span><span>test</span><span>(</span><span>a</span><span>)</span> <span>===</span> <span>false</span>
        <span>)</span> <span>{</span>
            <span>return</span> <span>target</span><span>.</span><span>apply</span><span>(</span><span>thisArg</span><span>,</span> <span>args</span><span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>
<span>}</span><span>)</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><p>As we are now using a <a href="https://github.com/gorhill/uBlock/wiki/Static-filter-syntax#scriptlet-injection">scriptlet</a>, a custom piece of code ran by the adblocker, the filter changes slightly:</p><details open=""><summary>Defeating BlockAdBlock, all versions: the filter.</summary></details><h2 id="version-4-january-2016---april-2016-experimental-features">Version 4 (January 2016 - April 2016): experimental features</h2><p>The above detection method was made in <a href="https://github.com/uBlockOrigin/uAssets/blob/91f936dbaeaa681fab4d9259a818458db2200e74/assets/ublock/resources.txt#L493">January 2016, according to uBlock Origin commit history</a>, and has not changed in concept since its inception.
BlockAdBlock never tried to work around this filter after its creation, by changing its code architecture. Instead, it continued development with more features. And when we go over to the BlockAdBlock page, we see an interesting tab: “Need more anti-adblock power?".</p><picture>
<source srcset="bab-advanced-detection.webp"><img src="https://xy2.dev/article/re-bab/bab-advanced-detection.png" alt="Advanced detection"></picture><p>Although those defenses are only available in a special tab, they are included in all scripts and executed by fittingly-named variables. In version 4, two are implemented:</p><ul><li><code>aDefOne</code>, the “specific defense for AdSense sites”.</li><li><code>aDefTwo</code>, the “special element defense”.</li></ul><p>There's something I should mention before we go. When reversing this version, one function caught my eye:
</p><details open=""><summary>A debug <code>console.log()</code> that's used in the code!</summary><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span></code></pre></td><td><pre><code data-lang="js"><span>function</span> <span>consolelog</span><span>(</span><span>e</span><span>)</span> <span>{</span>
    <span>// "Dev mode" check: developpers of BAB must set window.consolelog to 1.
</span><span></span>    <span>if</span> <span>(</span><span>window</span><span>.</span><span>consolelog</span> <span>==</span> <span>1</span><span>)</span> <span>{</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>e</span><span>)</span>
    <span>}</span>
<span>}</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><p>These debug comments are only available in this version of the code. If I hadn't been reversing each version, I never would have caught it. These comments provide valuable information on how the code works.</p><h3 id="advanced-defense-adsense">Advanced defense: AdSense</h3><p>All of these special defenses are put in <code>check</code> and not in <code>arm</code>, like the architecture would suggest.
This would suggest a change of developer that was perhaps unfamiliar with the codebase.</p><p>If AdSense is active on the page, we check that the ads which are supposed to be there still exist. If they're gone because of the adblocker, then BlockAdBlock activates.</p><details open=""><summary>A clever defense: check if existing ads, created by AdSense, are gone.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span><span>13
</span></span><span>14
</span><span><span>15
</span></span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span></code></pre></td><td><pre><code data-lang="js"><span>function</span> <span>check</span><span>(</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>var</span> <span>q</span> <span>=</span> <span>'ins.adsbygoogle'</span><span>,</span>
        <span>// Selects all Google ads in the document.
</span><span></span>        <span>adsbygoogleQuery</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>q</span><span>)</span><span>;</span>

    <span>if</span> <span>(</span><span>(</span><span>adsbygoogleQuery</span><span>)</span> <span>&amp;&amp;</span> <span>(</span><span>adblockDetected</span> <span>==</span> <span>0</span><span>)</span><span>)</span> <span>{</span>
        <span>// Ads are not blocked, since the bait ad is still there,
</span><span></span>        <span>// and adblockDetected hasn't been set
</span><span></span>        <span>if</span> <span>(</span><span>aDefOne</span> <span>==</span> <span>'yes'</span><span>)</span> <span>{</span>
            <span>consolelog</span><span>(</span><span>'case2: standard bait says ads are NOT blocked.'</span><span>)</span><span>;</span>
            <span>var</span> <span>adsbygoogle</span> <span>=</span> <span>'//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js'</span><span>;</span>
<span>            <span>if</span> <span>(</span><span>scriptExists</span><span>(</span><span>adsbygoogle</span><span>)</span><span>)</span> <span>{</span>
</span>                <span>consolelog</span><span>(</span><span>'case2: And Adsense pre-exists.'</span><span>)</span><span>;</span>
<span>                <span>if</span> <span>(</span><span>adsbygoogleQuery</span><span>.</span><span>innerHTML</span><span>.</span><span>replace</span><span>(</span><span>/\s/g</span><span>,</span> <span>''</span><span>)</span><span>.</span><span>length</span> <span>==</span> <span>0</span><span>)</span> <span>{</span>
</span>                    <span>// The ad's content was cleared, so...
</span><span></span>                    <span>consolelog</span><span>(</span><span>'case2: Ads are blocked.'</span><span>)</span><span>;</span>
                    <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>arm</span><span>(</span><span>)</span>
                <span>}</span>
            <span>}</span>
        <span>}</span><span>;</span>
        <span>adblockDetected</span> <span>=</span> <span>1</span>
    <span>}</span>
    <span>...</span>
</code></pre></td></tr></tbody></table></div></div></details><p>The <code>scriptExists</code> implementation looks for a given script within the page. In this case, it will detect the Adsense script if it exists.<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup></p><details open=""><summary>Compare the passed script URL against all scripts currently on the page.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span><span> 7
</span></span><span> 8
</span><span> 9
</span><span>10
</span></code></pre></td><td><pre><code data-lang="js"><span>function</span> <span>scriptExists</span><span>(</span><span>href</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>href</span><span>)</span> <span>href</span> <span>=</span> <span>href</span><span>.</span><span>substr</span><span>(</span><span>href</span><span>.</span><span>length</span> <span>-</span> <span>15</span><span>)</span><span>;</span>
    <span>var</span> <span>scripts</span> <span>=</span> <span>document</span><span>.</span><span>getElementsByTagName</span><span>(</span><span>'script'</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span><span>var</span> <span>i</span> <span>=</span> <span>scripts</span><span>.</span><span>length</span><span>;</span> <span>i</span><span>--</span><span>;</span><span>)</span> <span>{</span>
        <span>var</span> <span>src</span> <span>=</span> <span>String</span><span>(</span><span>scripts</span><span>[</span><span>i</span><span>]</span><span>.</span><span>src</span><span>)</span><span>;</span>
        <span>if</span> <span>(</span><span>src</span><span>)</span> <span>src</span> <span>=</span> <span>src</span><span>.</span><span>substr</span><span>(</span><span>src</span><span>.</span><span>length</span> <span>-</span> <span>15</span><span>)</span><span>;</span>
<span>        <span>if</span> <span>(</span><span>src</span> <span>===</span> <span>href</span><span>)</span> <span>return</span> <span>true</span>
</span>    <span>}</span><span>;</span>
    <span>return</span> <span>false</span>
<span>}</span><span>;</span>
</code></pre></td></tr></tbody></table></div></div></details><h3 id="advanced-defense-special-element-defense">Advanced defense: Special element defense</h3><p>This method, unlike the first one, has a disclaimer: <em>“Please test after installation to ensure compatibility with your site."</em> To contextualize where we are in the code, let's look at <code>check</code>:</p><details open=""><summary>This special defense only triggers if adblock wasn't detected and there is no AdSense script on the page.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span><span>13
</span></span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span></code></pre></td><td><pre><code data-lang="js"><span>check</span><span>:</span> <span>function</span><span>(</span><span>checkPredicate</span><span>,</span> <span>unused</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>(</span><span>checkPredicate</span><span>)</span> <span>&amp;&amp;</span> <span>(</span><span>adblockDetected</span> <span>==</span> <span>0</span><span>)</span><span>)</span> <span>{</span>
        <span>// Adblocker detected, arm
</span><span></span>    <span>}</span> <span>else</span> <span>{</span>
        <span>var</span> <span>q</span> <span>=</span> <span>'ins.adsbygoogle'</span><span>,</span>
            <span>adsbygoogleQuery</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>q</span><span>)</span><span>;</span>

        <span>if</span> <span>(</span><span>(</span><span>adsbygoogleQuery</span><span>)</span> <span>&amp;&amp;</span> <span>(</span><span>adblockDetected</span> <span>==</span> <span>0</span><span>)</span><span>)</span> <span>{</span>
            <span>if</span> <span>(</span><span>aDefOne</span> <span>==</span> <span>'yes'</span><span>)</span> <span>{</span>
                <span>// Special defense one: AdSense defense (see above)
</span><span></span>            <span>}</span><span>;</span>
        <span>}</span> <span>else</span> <span>{</span>
<span>            <span>if</span> <span>(</span><span>adblockDetected</span> <span>==</span> <span>0</span><span>)</span> <span>{</span>
</span>                <span>if</span> <span>(</span><span>aDefTwo</span> <span>==</span> <span>'yes'</span><span>)</span> <span>{</span>
                    <span>// Special defense two: Special element defense
</span><span></span>                <span>}</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
</code></pre></td></tr></tbody></table></div></div></details><p>So why the disclaimer? This method tries to include the AdSense script. If it doens't load, it's likely the adblocker blocked the network request, so BlockAdBlock triggers.
But this may mess up some web sites, hence the warning.</p><details open=""><summary>If we fail to load AdSense, trigger the overlay.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span><span>10
</span></span><span><span>11
</span></span><span><span>12
</span></span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span></code></pre></td><td><pre><code data-lang="js"><span>if</span> <span>(</span><span>aDefTwo</span> <span>==</span> <span>'yes'</span><span>)</span> <span>{</span>
    <span>/* Add Google ad code to head.
</span><span>        If it errors, the adblocker must have blocked the connection. */</span>
    <span>var</span> <span>googleAdCode</span> <span>=</span> <span>'//static.doubleclick.net/instream/ad_status.js'</span><span>;</span>
    <span>consolelog</span><span>(</span><span>'case3: standard bait says ads are NOT blocked. Maybe ???\
</span><span>      No Adsense is found. Attempting to add Google ad code to head...'</span><span>)</span><span>;</span>
    <span>var</span> <span>script</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>'script'</span><span>)</span><span>;</span>
    <span>script</span><span>.</span><span>setAttribute</span><span>(</span><span>'type'</span><span>,</span> <span>'text/javascript'</span><span>)</span><span>;</span>
    <span>script</span><span>.</span><span>setAttribute</span><span>(</span><span>'src'</span><span>,</span> <span>googleAdCode</span><span>)</span><span>;</span>
<span>    <span>script</span><span>.</span><span>onerror</span> <span>=</span> <span>function</span><span>(</span><span>)</span> <span>{</span>
</span><span>        <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>arm</span><span>(</span><span>)</span>
</span><span>    <span>}</span><span>;</span>
</span>    <span>adblockDetected</span> <span>=</span> <span>1</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>scriptExists</span><span>(</span><span>googleAdCode</span><span>)</span><span>)</span> <span>{</span>
        <span>document</span><span>.</span><span>getElementsByTagName</span><span>(</span><span>'head'</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>appendChild</span><span>(</span><span>script</span><span>)</span>
    <span>}</span><span>;</span>
    <span>adsbygoogleQuery</span> <span>=</span> <span>0</span><span>;</span>
    <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>check</span> <span>=</span> <span>function</span><span>(</span><span>)</span> <span>{</span>
        <span>return</span>
    <span>}</span>
<span>}</span>
</code></pre></td></tr></tbody></table></div></div></details><p>And indeed, most adblockers fall for it and block the request.
However, there's one adblocker that I haven't mentionned until this point. Let's talk about the <a href="https://brave.com/fr/">Brave browser</a>.</p><h3 id="brave-browsers-answer-to-blockadblock">Brave Browser's answer to BlockAdBlock</h3><p>Until now I've examined uBlock Origin's response against BlockAdBlock. And it works, but it needs a specific filter to be added for each site that has BlockAdBlock on it.
Brave is impressive because it detects and circumvents BlockAdBlock directly on all versions, without any action needed.
Although we can't learn how without a lot of effort, as Brave is closed source, we can examine how it counters the above defense if we look in DevTools.</p><p>Instead of blocking the <code>ad_status.js</code> request, it lets it through but loads a <strong>0-byte fake Google Ads instead</strong>. This clever trick fools BlockAdBlock, because <code>onerror</code> fires only if the network request fails.</p><picture>
<source srcset="chromium-brave.webp"><img src="https://xy2.dev/article/re-bab/chromium-brave.png" alt="Chromium with adblocker &amp; Brave vs BlockAdBlock: network requests"></picture><h2 id="version-5-march-2016---november-2016">Version 5 (March 2016 - November 2016)</h2><h3 id="advanced-defense-favicon-spam">Advanced defense: Favicon spam</h3><p>The only change of note in this version is that the second advanced defense was rewritten, but still holds the same basic principle: try network requests that will be blocked by the adblocker. This time, however, it tries to load favicons instead of AdSense.</p><p>Brave evades this detection in the same was as above. It loads the images correctly, but creates fake 1x1 images.</p><details open=""><summary>Favicon spam. <code>baitImages</code> generates bait images, too.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span><span>15
</span></span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span><span>20
</span></span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span></code></pre></td><td><pre><code data-lang="js"><span>if</span> <span>(</span><span>aDefTwo</span> <span>==</span> <span>'yes'</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span> <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>ranAlready</span><span>)</span> <span>{</span><span>/</span>
        <span>var</span> <span>favicons</span> <span>=</span> <span>[</span>
            <span>"//www.google.com/adsense/start/images/favicon.ico"</span><span>,</span>
            <span>"//www.gstatic.com/adx/doubleclick.ico"</span><span>,</span>
            <span>"//advertising.yahoo.com/favicon.ico"</span><span>,</span>
            <span>"//ads.twitter.com/favicon.ico"</span><span>,</span>
            <span>"//www.doubleclickbygoogle.com/favicon.ico"</span>
            <span>]</span><span>,</span>
            <span>len</span> <span>=</span> <span>favicons</span><span>.</span><span>length</span><span>,</span>
            <span>img</span> <span>=</span> <span>favicons</span><span>[</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>len</span><span>)</span><span>]</span><span>,</span>
        <span>...</span>
        <span>baitImages</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>2</span><span>)</span> <span>+</span> <span>1</span><span>)</span><span>;</span> <span>// creates bait images
</span><span></span>        <span>var</span> <span>m</span> <span>=</span> <span>new</span> <span>Image</span><span>(</span><span>)</span><span>;</span>
<span>        <span>m</span><span>.</span><span>onerror</span> <span>=</span> <span>function</span><span>(</span><span>)</span> <span>{</span>
</span>            <span>baitImages</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>2</span><span>)</span> <span>+</span> <span>1</span><span>)</span><span>;</span>
            <span>c</span><span>.</span><span>src</span> <span>=</span> <span>imgCopy</span><span>;</span>
            <span>baitImages</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>2</span><span>)</span> <span>+</span> <span>1</span><span>)</span>
        <span>}</span><span>;</span>
<span>        <span>c</span><span>.</span><span>onerror</span> <span>=</span> <span>function</span><span>(</span><span>)</span> <span>{</span>
</span>            <span>adblockDetected</span> <span>=</span> <span>1</span><span>;</span>
            <span>baitImages</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>3</span><span>)</span> <span>+</span> <span>1</span><span>)</span><span>;</span>
            <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>arm</span><span>(</span><span>)</span>
        <span>}</span><span>;</span>
        <span>m</span><span>.</span><span>src</span> <span>=</span> <span>img</span><span>;</span>
        <span>baitImages</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>3</span><span>)</span> <span>+</span> <span>1</span><span>)</span><span>;</span>
        <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>ranAlready</span> <span>=</span> <span>true</span>
    <span>}</span><span>;</span>
<span>}</span>
</code></pre></td></tr></tbody></table></div></div></details><h2 id="version-6-april-2016---november-2016-blocking-brave">Version 6 (April 2016 - November 2016): blocking Brave</h2><p>So far BlockAdBlock's techniques, although simplistic at first, have grown in terms of complexity and detection rate.
But there's still one enemy left unconquered: the Brave browser.</p><h3 id="advanced-defense-fake-favicon-detection">Advanced defense: Fake favicon detection</h3><p>Why did BlockAdBlock switch from trying to load a script to an image (a favicon)?
The answer is this code, which is put inside the “favicon spam” defense and activates if the Brave defense is active.</p><details open=""><summary>Detecting Brave Browser: check the response for a fake image.</summary><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span><span> 7
</span></span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span></code></pre></td><td><pre><code data-lang="js"><span>if</span> <span>(</span><span>aDefTwo</span> <span>==</span> <span>'yes'</span><span>)</span> <span>{</span>
    <span>baitImages</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span> <span>*</span> <span>3</span><span>)</span> <span>+</span> <span>1</span><span>)</span><span>;</span>
    <span>// earlier favicon code...
</span><span></span>    <span>var</span> <span>m</span> <span>=</span> <span>new</span> <span>Image</span><span>(</span><span>)</span><span>;</span>
    <span>if</span> <span>(</span><span>(</span><span>aDefThree</span> <span>%</span> <span>3</span><span>)</span> <span>==</span> <span>0</span><span>)</span> <span>{</span>
        <span>m</span><span>.</span><span>onload</span> <span>=</span> <span>function</span><span>(</span><span>)</span> <span>{</span>
<span>            <span>if</span> <span>(</span><span>(</span><span>m</span><span>.</span><span>width</span> <span>&lt;</span> <span>8</span><span>)</span> <span>&amp;&amp;</span> <span>(</span><span>m</span><span>.</span><span>width</span> <span>&gt;</span> <span>0</span><span>)</span><span>)</span> <span>{</span>
</span>                <span>window</span><span>[</span><span>''</span> <span>+</span> <span>randomID</span> <span>+</span> <span>''</span><span>]</span><span>.</span><span>arm</span><span>(</span><span>)</span>
            <span>}</span>
        <span>}</span>
    <span>}</span><span>;</span>
<span>}</span>
</code></pre></td></tr></tbody></table></div></div></details><p>With this method, Brave is defeated, and other adblockers will be detected if they run the code (most, like uBlock Origin, outright block it in the first place.)</p><p>After this update, around the end of November 2016, BlockAdBlock disappeared from the web. Although their “advanced defense” techniques work, they were never enabled for the majority of users. This was their last update, and their last post on both Twitter and their site was sometimes in late 2017</p><p>However, the legacy BlockAdBlock left is significant. And even though it can be trivially blocked nowadays, I still see BlockAdBlock used in today's sites.</p><h2 id="conclusion">Conclusion</h2><p>In the end, who will win the arms race between ad-blockers and ad-blockers-blockers? Only time can tell, but I think ad-blockers still have the advantage. As the arms race evolves, ad-blockers will have to use more and more contrived techniques and completely custom code, as watching BlockAdBlock's evolution over time hopefully shows.</p><p>On the other hand, blockers have the advantage of stable systems and powerful filtering tools via filter lists, and have access to JavaScript, too: with these systems, it only takes one person to figure out how to defeat the adblocker and update the filter list with new sites.</p><p>By analysing BlockAdBlock's evolution over time, as well as various ad blocker's responses, we managed to draw a picture of the small war between BlockAdBlock and ad blockers, and in the process learnt how ad-blockers-blockers block the ad-blockers.</p><p><a href="https://github.com/xy2iii/BlockAdBlock-reversed">You can find my reverse-engineering on GitHub</a>. Thank you for reading.</p><section role="doc-endnotes"><hr><ol><li id="fn:1" role="doc-endnote"><p>If you want an intuition of how it works, try pasting the below example into a JS console and then look at the code. If you're interested in its inner workings, <a href="https://github.com/evanw/packer/blob/master/packer.js">here's the source code</a>. <a href="#fnref:1" role="doc-backlink">↩︎</a></p></li><li id="fn:2" role="doc-endnote"><p>Don't believe me? Try changing <code>eval</code> to <code>console.log</code> in the first line of the above example and you might find something hidden… <a href="#fnref:2" role="doc-backlink">↩︎</a></p></li><li id="fn:3" role="doc-endnote"><p>The timestamp says <code>201510</code>, so shouldn't it be October? The reason for this is that we don't know when the script changed. All we know is:</p><ul><li>On 2015-10, there was one version saved: <code>20151007203811.js</code>.</li><li>On 2015-11, there was a new version: <code>20151113115955.js</code>.</li></ul><p>As far as we know, the script could have been changed the day before the second timestamp. As such, I err on the cautious side when timing the versions. <a href="#fnref:3" role="doc-backlink">↩︎</a></p></li><li id="fn:4" role="doc-endnote"><p>The tests for v1, above, were made while fixing this bug in the v1 script. <a href="#fnref:4" role="doc-backlink">↩︎</a></p></li><li id="fn:5" role="doc-endnote"><p>Thanks to <a href="https://www.reddit.com/r/javascript/comments/fs9030/how_an_anti_adblocker_works_reverseengineering/fm18g9m?utm_source=share&amp;utm_medium=web2x">McStroyer on Reddit</a> for pointing this out. <a href="#fnref:5" role="doc-backlink">↩︎</a></p></li></ol></section></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>