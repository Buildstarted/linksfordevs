<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Asynchronous messaging with Azure Service Bus - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Asynchronous messaging with Azure Service Bus - linksfor.dev(s)"/>
    <meta property="og:description" content="This article presents how to implement asynchronous communication between microservices using Azure Service Bus"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://daniel-krzyczkowski.github.io/Asynchronous-Messaging-With-Azure-Service-Bus/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Asynchronous messaging with Azure Service Bus</title>
<div class="readable">
        <h1>Asynchronous messaging with Azure Service Bus</h1>
            <div>Reading time: 25-31 minutes</div>
        <div>Posted here: 20 Jul 2020</div>
        <p><a href="https://daniel-krzyczkowski.github.io/Asynchronous-Messaging-With-Azure-Service-Bus/">https://daniel-krzyczkowski.github.io/Asynchronous-Messaging-With-Azure-Service-Bus/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
      
        <header>
          
          
        </header>
      

      <section itemprop="text">
        
        <p>
<img src="https://daniel-krzyczkowski.github.io/images/devisland/article37/assets/MicroservicesAzureServiceBusCommunication1.png?raw=true" alt="Asynchronous messaging With Azure Service Bus">
</p>



<p>The Microservices architecture style becomes more and more popular. There are many crucial parts of the solution that have to be taken into consideration and one of them is communication. How to communicate asynchronously between microservices to make sure that they are not tightly-coupled? In this article, I would like to present and discuss how to use the Azure Service Bus to implement asynchronous communication between microservices.</p>



<p>To demonstrate how to use Azure Service Bus to provide asynchronous communication between microservices I decided to start the development of a sample solution called Cars Island. Source code is available on <a href="https://github.com/Daniel-Krzyczkowski/MicrosoftAzure/tree/master/asp-net-core-microservices-with-azure-and-docker">my GitHub.</a>. This project is based on the <a href="https://github.com/dotnet-architecture/eShopOnContainers">eShop on containers solution</a> which I found a bit heavy so that is why I decided to create my solution. In the Cars Island solution there are four microservices:</p>

<p>
<img src="https://daniel-krzyczkowski.github.io/images/devisland/article37/assets/MicroservicesAzureServiceBusCommunication2.png?raw=true" alt="Image not found">
</p>

<p>In this article, we are going to talk about communication between <em>Catalog</em> microservice and <em>Reservation</em> microservice. Just to remind - we would like to use Azure Service Bus to inform other services that specific events happened. In this case, we will talk about changing the price per day for renting the car. Once the price per day is changed in the <em>Catalog</em> microservice, we would like to inform <em>Reservation</em> microservice about it.</p>

<h2 id="car-price-per-day-changed-integration-event">Car price per day changed integration event</h2>

<p>When talking about communication between microservices we are talking about integration events in this case. We do not want to tightly couple microservices, that is why we will use the Azure Service Bus and <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/publisher-subscriber">Publish/Subscribe</a> pattern to provide asynchronous communication. In the <em>Catalog</em> microservice, there is a class called <em>CarPricePerDayChangedIntegrationEvent</em>:</p>

<div><div><pre><code>    <span>public</span> <span>class</span> <span>CarPricePerDayChangedIntegrationEvent</span> <span>:</span> <span>IntegrationEvent</span>
    <span>{</span>
        <span>public</span> <span>Guid</span> <span>CarId</span> <span>{</span> <span>get</span><span>;</span> <span>private</span> <span>set</span><span>;</span> <span>}</span>

        <span>public</span> <span>decimal</span> <span>NewPricePerDay</span> <span>{</span> <span>get</span><span>;</span> <span>private</span> <span>set</span><span>;</span> <span>}</span>

        <span>public</span> <span>decimal</span> <span>OldPricePerDay</span> <span>{</span> <span>get</span><span>;</span> <span>private</span> <span>set</span><span>;</span> <span>}</span>

        <span>public</span> <span>CarPricePerDayChangedIntegrationEvent</span><span>(</span><span>Guid</span> <span>carId</span><span>,</span> <span>decimal</span> <span>newPricePerDay</span><span>,</span> <span>decimal</span> <span>oldPricePerDay</span><span>)</span>
        <span>{</span>
            <span>CarId</span> <span>=</span> <span>carId</span><span>;</span>
            <span>NewPricePerDay</span> <span>=</span> <span>newPricePerDay</span><span>;</span>
            <span>OldPricePerDay</span> <span>=</span> <span>oldPricePerDay</span><span>;</span>
        <span>}</span>
    <span>}</span>
</code></pre></div></div>

<p>As we can see there is information about the old price per day for renting the car and new price per day. There is also a car ID to identify the car for which the price was updated. In the base, an abstract class called <em>IntegrationEvent</em> two properties should always bee included in the event information so the ID and creation date:</p>

<div><div><pre><code>    <span>public</span> <span>abstract</span> <span>class</span> <span>IntegrationEvent</span>
    <span>{</span>
        <span>[</span><span>JsonConstructor</span><span>]</span>
        <span>public</span> <span>IntegrationEvent</span><span>()</span>
        <span>{</span>
            <span>Id</span> <span>=</span> <span>Guid</span><span>.</span><span>NewGuid</span><span>();</span>
            <span>CreationDate</span> <span>=</span> <span>DateTime</span><span>.</span><span>UtcNow</span><span>;</span>
        <span>}</span>

        <span>[</span><span>JsonProperty</span><span>]</span>
        <span>public</span> <span>Guid</span> <span>Id</span> <span>{</span> <span>get</span><span>;</span> <span>private</span> <span>set</span><span>;</span> <span>}</span>

        <span>[</span><span>JsonProperty</span><span>]</span>
        <span>public</span> <span>DateTime</span> <span>CreationDate</span> <span>{</span> <span>get</span><span>;</span> <span>private</span> <span>set</span><span>;</span> <span>}</span>
    <span>}</span>
</code></pre></div></div>

<p>Of course there can be many different events but to make it simple we are going to talk about price change event.</p>

<h2 id="car-price-per-day-changed-integration-event-handler">Car price per day changed integration event handler</h2>

<p>For each event we need of course event handler. For the <em>CarPricePerDayChangedIntegrationEvent</em> we need <em>CarPricePerDayChangedIntegrationEventHandler</em> which is located in the <em>Reservation</em> microservice:</p>

<div><div><pre><code>    <span>public</span> <span>class</span> <span>CarPricePerDayChangedIntegrationEventHandler</span> <span>:</span> <span>IIntegrationEventHandler</span><span>&lt;</span><span>CarPricePerDayChangedIntegrationEvent</span><span>&gt;</span>
    <span>{</span>
        <span>private</span> <span>readonly</span> <span>ILogger</span><span>&lt;</span><span>CarPricePerDayChangedIntegrationEventHandler</span><span>&gt;</span> <span>_logger</span><span>;</span>
        <span>private</span> <span>readonly</span> <span>IReservationRepository</span> <span>_reservationRepository</span><span>;</span>

        <span>public</span> <span>CarPricePerDayChangedIntegrationEventHandler</span><span>(</span><span>ILogger</span><span>&lt;</span><span>CarPricePerDayChangedIntegrationEventHandler</span><span>&gt;</span> <span>logger</span><span>,</span>
                                                            <span>IReservationRepository</span> <span>reservationRepository</span><span>)</span>
        <span>{</span>
            <span>_logger</span> <span>=</span> <span>logger</span> <span>??</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span><span>logger</span><span>));</span>
            <span>_reservationRepository</span> <span>=</span> <span>reservationRepository</span> <span>??</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span><span>reservationRepository</span><span>));</span>
        <span>}</span>

        <span>public</span> <span>async</span> <span>Task</span> <span>HandleAsync</span><span>(</span><span>CarPricePerDayChangedIntegrationEvent</span> <span>@event</span><span>)</span>
        <span>{</span>
            <span>_logger</span><span>.</span><span>LogInformation</span><span>(</span><span>"Handling integration event: {IntegrationEventId} - ({@IntegrationEvent})"</span><span>,</span> <span>@event</span><span>.</span><span>Id</span><span>,</span> <span>@event</span><span>);</span>

            <span>var</span> <span>userIds</span> <span>=</span> <span>_reservationRepository</span><span>.</span><span>GetUsers</span><span>();</span>

            <span>foreach</span> <span>(</span><span>var</span> <span>id</span> <span>in</span> <span>userIds</span><span>)</span>
            <span>{</span>
                <span>var</span> <span>customerReservation</span> <span>=</span> <span>await</span> <span>_reservationRepository</span><span>.</span><span>GetReservationAsync</span><span>(</span><span>id</span><span>);</span>

                <span>await</span> <span>UpdatePriceInCustomerReservation</span><span>(</span><span>@event</span><span>.</span><span>CarId</span><span>,</span> <span>@event</span><span>.</span><span>NewPricePerDay</span><span>,</span> <span>@event</span><span>.</span><span>OldPricePerDay</span><span>,</span> <span>customerReservation</span><span>);</span>
            <span>}</span>
        <span>}</span>

        <span>private</span> <span>async</span> <span>Task</span> <span>UpdatePriceInCustomerReservation</span><span>(</span><span>Guid</span> <span>carId</span><span>,</span> <span>decimal</span> <span>newPrice</span><span>,</span>
                                                            <span>decimal</span> <span>oldPrice</span><span>,</span> <span>CustomerReservation</span> <span>reservation</span><span>)</span>
        <span>{</span>
            <span>if</span> <span>(</span><span>carId</span> <span>==</span> <span>reservation</span><span>.</span><span>Car</span><span>.</span><span>Id</span><span>)</span>
            <span>{</span>
                <span>_logger</span><span>.</span><span>LogInformation</span><span>(</span><span>$"</span><span>{</span><span>nameof</span><span>(</span><span>CarPricePerDayChangedIntegrationEventHandler</span><span>)}</span><span> - Updating car price in reservation for the customer: </span><span>{</span><span>reservation</span><span>.</span><span>CustomerId</span><span>}</span><span>"</span><span>,</span> <span>reservation</span><span>.</span><span>CustomerId</span><span>);</span>

                <span>if</span> <span>(</span><span>reservation</span><span>.</span><span>Car</span><span>.</span><span>PricePerDay</span> <span>==</span> <span>oldPrice</span><span>)</span>
                <span>{</span>
                    <span>reservation</span><span>.</span><span>Car</span><span>.</span><span>PricePerDay</span> <span>=</span> <span>newPrice</span><span>;</span>
                <span>}</span>
                <span>await</span> <span>_reservationRepository</span><span>.</span><span>UpdateReservationAsync</span><span>(</span><span>reservation</span><span>);</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
</code></pre></div></div>

<p>As we can see in the source code above, we are able to handle the event related to chaning the price per day. We can access repository with reservations, find all reservations where this specific car was reserved (with the specific ID) and we can update this price.</p>

<h2 id="event-bus-implementation">Event bus implementation</h2>

<p>In the project called <em>CarsIsland.EventBus</em> we can find all the source code that is shared among microservices in the solution to provide asynchronous communication with Azure Service Bus. Let’s start with subscriptions. In our solution, there can be many events sent. There will be an event emitted when the car price per day changed, when the customer completed the payment or when the customer canceled the reservation. Now some of the microservices can be interested in receiving such events so they can react and update the data related to their domain. In our case, if there is a chance in the <em>Catalog</em> microservice related to car price per day, <em>Reservation</em> microservice should be notified to update this price on the reservation.</p>

<h3 id="subscription-manager">Subscription manager</h3>

<p>As mentioned above we would like to make sure that each microservice will receive only these events to which it subscribed. All others should be ignored. To make it possible we need a subscription manager. This class will be responsible for managing events subscriptions and providing specific handlers so these events can be handled by specific microservice. Let’s look at the <em>IEventBusSubscriptionsManager</em> interface:</p>

<div><div><pre><code>    <span>public</span> <span>interface</span> <span>IEventBusSubscriptionsManager</span>
    <span>{</span>
        <span>bool</span> <span>IsEmpty</span> <span>{</span> <span>get</span><span>;</span> <span>}</span>

        <span>event</span> <span>EventHandler</span><span>&lt;</span><span>string</span><span>&gt;</span> <span>OnEventRemoved</span><span>;</span>

        <span>void</span> <span>AddSubscription</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;()</span>
           <span>where</span> <span>T</span> <span>:</span> <span>IntegrationEvent</span>
           <span>where</span> <span>TH</span> <span>:</span> <span>IIntegrationEventHandler</span><span>&lt;</span><span>T</span><span>&gt;;</span>

        <span>void</span> <span>RemoveSubscription</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;()</span>
           <span>where</span> <span>TH</span> <span>:</span> <span>IIntegrationEventHandler</span><span>&lt;</span><span>T</span><span>&gt;</span>
           <span>where</span> <span>T</span> <span>:</span> <span>IntegrationEvent</span><span>;</span>

        <span>bool</span> <span>HasSubscriptionsForEvent</span><span>&lt;</span><span>T</span><span>&gt;()</span> <span>where</span> <span>T</span> <span>:</span> <span>IntegrationEvent</span><span>;</span>

        <span>bool</span> <span>HasSubscriptionsForEvent</span><span>(</span><span>string</span> <span>eventName</span><span>);</span>

        <span>Type</span> <span>GetEventTypeByName</span><span>(</span><span>string</span> <span>eventName</span><span>);</span>

        <span>void</span> <span>Clear</span><span>();</span>

        <span>IEnumerable</span><span>&lt;</span><span>SubscriptionInfo</span><span>&gt;</span> <span>GetHandlersForEvent</span><span>&lt;</span><span>T</span><span>&gt;()</span> <span>where</span> <span>T</span> <span>:</span> <span>IntegrationEvent</span><span>;</span>

        <span>IEnumerable</span><span>&lt;</span><span>SubscriptionInfo</span><span>&gt;</span> <span>GetHandlersForEvent</span><span>(</span><span>string</span> <span>eventName</span><span>);</span>

        <span>string</span> <span>GetEventKey</span><span>&lt;</span><span>T</span><span>&gt;();</span>
    <span>}</span>
</code></pre></div></div>

<p>As we can see there are operations like adding subscription, removing it or verifying whether subscription for specific event exists. The implementation of this interface is available in the <em>InMemoryEventBusSubscriptionsManager</em> class in the same project.</p>

<h3 id="azure-service-bus-event-bus">Azure Service Bus Event Bus</h3>

<p>Once we have subscription manager we have to also connect to the Azure Service Bus to be able to publish events and receive them asynchronously. To do it we have to implement class called <em>AzureServiceBusEventBus</em> where we use <a href="https://www.nuget.org/packages/Microsoft.Azure.ServiceBus/">Azure Service Bus SDK</a>:</p>

<div><div><pre><code>    <span>public</span> <span>class</span> <span>AzureServiceBusEventBus</span> <span>:</span> <span>IEventBus</span>
    <span>{</span>
        <span>private</span> <span>readonly</span> <span>SubscriptionClient</span> <span>_subscriptionClient</span><span>;</span>
        <span>private</span> <span>readonly</span> <span>IEventBusSubscriptionsManager</span> <span>_subscriptionManager</span><span>;</span>
        <span>private</span> <span>readonly</span> <span>IServiceBusConnectionManagementService</span> <span>_serviceBusConnectionManagementService</span><span>;</span>
        <span>private</span> <span>readonly</span> <span>IServiceProvider</span> <span>_serviceProvider</span><span>;</span>
        <span>private</span> <span>readonly</span> <span>ILogger</span><span>&lt;</span><span>AzureServiceBusEventBus</span><span>&gt;</span> <span>_logger</span><span>;</span>

        <span>public</span> <span>AzureServiceBusEventBus</span><span>(</span><span>IServiceBusConnectionManagementService</span> <span>serviceBusConnectionManagementService</span><span>,</span>
                        <span>IEventBusSubscriptionsManager</span> <span>subscriptionManager</span><span>,</span>
                        <span>IServiceProvider</span> <span>serviceProvider</span><span>,</span>
                        <span>ILogger</span><span>&lt;</span><span>AzureServiceBusEventBus</span><span>&gt;</span> <span>logger</span><span>,</span>
                        <span>string</span> <span>subscriptionClientName</span><span>)</span>
        <span>{</span>
            <span>_serviceBusConnectionManagementService</span> <span>=</span> <span>serviceBusConnectionManagementService</span><span>;</span>
            <span>_subscriptionManager</span> <span>=</span> <span>subscriptionManager</span><span>;</span>
            <span>_subscriptionClient</span> <span>=</span> <span>_subscriptionClient</span> <span>=</span> <span>new</span> <span>SubscriptionClient</span><span>(</span><span>_serviceBusConnectionManagementService</span><span>.</span><span>ServiceBusConnectionStringBuilder</span><span>,</span>
                <span>subscriptionClientName</span><span>);</span>
            <span>_serviceProvider</span> <span>=</span> <span>serviceProvider</span><span>;</span>
            <span>_logger</span> <span>=</span> <span>logger</span><span>;</span>
        <span>}</span>

        <span>public</span> <span>async</span> <span>Task</span> <span>SetupAsync</span><span>()</span>
        <span>{</span>
            <span>try</span>
            <span>{</span>
                <span>await</span> <span>RemoveDefaultRuleAsync</span><span>();</span>
                <span>RegisterSubscriptionClientMessageHandler</span><span>();</span>
            <span>}</span>

            <span>catch</span> <span>(</span><span>MessagingEntityNotFoundException</span><span>)</span>
            <span>{</span>
                <span>_logger</span><span>.</span><span>LogWarning</span><span>(</span><span>"The messaging entity '{DefaultRuleName}' Could not be found."</span><span>,</span> <span>RuleDescription</span><span>.</span><span>DefaultRuleName</span><span>);</span>
            <span>}</span>
        <span>}</span>

        <span>public</span> <span>async</span> <span>Task</span> <span>PublishAsync</span><span>(</span><span>IntegrationEvent</span> <span>@event</span><span>)</span>
        <span>{</span>
            <span>var</span> <span>eventName</span> <span>=</span> <span>@event</span><span>.</span><span>GetType</span><span>().</span><span>Name</span><span>;</span>
            <span>var</span> <span>jsonMessage</span> <span>=</span> <span>JsonConvert</span><span>.</span><span>SerializeObject</span><span>(</span><span>@event</span><span>);</span>
            <span>var</span> <span>body</span> <span>=</span> <span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetBytes</span><span>(</span><span>jsonMessage</span><span>);</span>

            <span>var</span> <span>message</span> <span>=</span> <span>new</span> <span>Message</span>
            <span>{</span>
                <span>MessageId</span> <span>=</span> <span>Guid</span><span>.</span><span>NewGuid</span><span>().</span><span>ToString</span><span>(),</span>
                <span>Body</span> <span>=</span> <span>body</span><span>,</span>
                <span>Label</span> <span>=</span> <span>eventName</span><span>,</span>
            <span>};</span>

            <span>var</span> <span>topicClient</span> <span>=</span> <span>_serviceBusConnectionManagementService</span><span>.</span><span>CreateTopicClient</span><span>();</span>
            <span>await</span> <span>topicClient</span><span>.</span><span>SendAsync</span><span>(</span><span>message</span><span>);</span>
        <span>}</span>

        <span>public</span> <span>async</span> <span>Task</span> <span>SubscribeAsync</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;()</span>
            <span>where</span> <span>T</span> <span>:</span> <span>IntegrationEvent</span>
            <span>where</span> <span>TH</span> <span>:</span> <span>IIntegrationEventHandler</span><span>&lt;</span><span>T</span><span>&gt;</span>
        <span>{</span>
            <span>var</span> <span>eventName</span> <span>=</span> <span>typeof</span><span>(</span><span>T</span><span>).</span><span>Name</span><span>;</span>

            <span>var</span> <span>containsKey</span> <span>=</span> <span>_subscriptionManager</span><span>.</span><span>HasSubscriptionsForEvent</span><span>&lt;</span><span>T</span><span>&gt;();</span>
            <span>if</span> <span>(!</span><span>containsKey</span><span>)</span>
            <span>{</span>
                <span>try</span>
                <span>{</span>
                    <span>await</span> <span>_subscriptionClient</span><span>.</span><span>AddRuleAsync</span><span>(</span><span>new</span> <span>RuleDescription</span>
                    <span>{</span>
                        <span>Filter</span> <span>=</span> <span>new</span> <span>CorrelationFilter</span> <span>{</span> <span>Label</span> <span>=</span> <span>eventName</span> <span>},</span>
                        <span>Name</span> <span>=</span> <span>eventName</span>
                    <span>});</span>
                <span>}</span>
                <span>catch</span> <span>(</span><span>ServiceBusException</span><span>)</span>
                <span>{</span>
                    <span>_logger</span><span>.</span><span>LogWarning</span><span>(</span><span>"The messaging entity '{eventName}' already exists."</span><span>,</span> <span>eventName</span><span>);</span>
                <span>}</span>
            <span>}</span>

            <span>_logger</span><span>.</span><span>LogInformation</span><span>(</span><span>"Subscribing to event '{EventName}' with '{EventHandler}'"</span><span>,</span> <span>eventName</span><span>,</span> <span>typeof</span><span>(</span><span>TH</span><span>).</span><span>Name</span><span>);</span>
            <span>_subscriptionManager</span><span>.</span><span>AddSubscription</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;();</span>
        <span>}</span>

        <span>public</span> <span>async</span> <span>Task</span> <span>UnsubscribeAsync</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;()</span>
            <span>where</span> <span>T</span> <span>:</span> <span>IntegrationEvent</span>
            <span>where</span> <span>TH</span> <span>:</span> <span>IIntegrationEventHandler</span><span>&lt;</span><span>T</span><span>&gt;</span>
        <span>{</span>
            <span>var</span> <span>eventName</span> <span>=</span> <span>typeof</span><span>(</span><span>T</span><span>).</span><span>Name</span><span>;</span>

            <span>try</span>
            <span>{</span>
                <span>await</span> <span>_subscriptionClient</span><span>.</span><span>RemoveRuleAsync</span><span>(</span><span>eventName</span><span>);</span>
            <span>}</span>
            <span>catch</span> <span>(</span><span>MessagingEntityNotFoundException</span><span>)</span>
            <span>{</span>
                <span>_logger</span><span>.</span><span>LogWarning</span><span>(</span><span>"The messaging entity '{eventName}' Could not be found."</span><span>,</span> <span>eventName</span><span>);</span>
            <span>}</span>

            <span>_logger</span><span>.</span><span>LogInformation</span><span>(</span><span>"Unsubscribing from event '{EventName}'"</span><span>,</span> <span>eventName</span><span>);</span>
            <span>_subscriptionManager</span><span>.</span><span>RemoveSubscription</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;();</span>
        <span>}</span>

        <span>private</span> <span>void</span> <span>RegisterSubscriptionClientMessageHandler</span><span>()</span>
        <span>{</span>
            <span>_subscriptionClient</span><span>.</span><span>RegisterMessageHandler</span><span>(</span>
                <span>async</span> <span>(</span><span>message</span><span>,</span> <span>token</span><span>)</span> <span>=&gt;</span>
                <span>{</span>
                    <span>var</span> <span>eventName</span> <span>=</span> <span>message</span><span>.</span><span>Label</span><span>;</span>
                    <span>var</span> <span>messageData</span> <span>=</span> <span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetString</span><span>(</span><span>message</span><span>.</span><span>Body</span><span>);</span>

                    <span>if</span> <span>(</span><span>await</span> <span>ProcessEvent</span><span>(</span><span>eventName</span><span>,</span> <span>messageData</span><span>))</span>
                    <span>{</span>
                        <span>await</span> <span>_subscriptionClient</span><span>.</span><span>CompleteAsync</span><span>(</span><span>message</span><span>.</span><span>SystemProperties</span><span>.</span><span>LockToken</span><span>);</span>
                    <span>}</span>
                <span>},</span>
                <span>new</span> <span>MessageHandlerOptions</span><span>(</span><span>ExceptionReceivedHandler</span><span>)</span> <span>{</span> <span>MaxConcurrentCalls</span> <span>=</span> <span>10</span><span>,</span> <span>AutoComplete</span> <span>=</span> <span>false</span> <span>});</span>
        <span>}</span>

        <span>private</span> <span>Task</span> <span>ExceptionReceivedHandler</span><span>(</span><span>ExceptionReceivedEventArgs</span> <span>exceptionReceivedEventArgs</span><span>)</span>
        <span>{</span>
            <span>var</span> <span>ex</span> <span>=</span> <span>exceptionReceivedEventArgs</span><span>.</span><span>Exception</span><span>;</span>
            <span>var</span> <span>context</span> <span>=</span> <span>exceptionReceivedEventArgs</span><span>.</span><span>ExceptionReceivedContext</span><span>;</span>

            <span>_logger</span><span>.</span><span>LogError</span><span>(</span><span>ex</span><span>,</span> <span>"ERROR handling message: '{ExceptionMessage}' - Context: '{ExceptionContext}'"</span><span>,</span> <span>ex</span><span>.</span><span>Message</span><span>,</span> <span>context</span><span>);</span>

            <span>return</span> <span>Task</span><span>.</span><span>CompletedTask</span><span>;</span>
        <span>}</span>

        <span>private</span> <span>async</span> <span>Task</span><span>&lt;</span><span>bool</span><span>&gt;</span> <span>ProcessEvent</span><span>(</span><span>string</span> <span>eventName</span><span>,</span> <span>string</span> <span>message</span><span>)</span>
        <span>{</span>
            <span>var</span> <span>processed</span> <span>=</span> <span>false</span><span>;</span>
            <span>if</span> <span>(</span><span>_subscriptionManager</span><span>.</span><span>HasSubscriptionsForEvent</span><span>(</span><span>eventName</span><span>))</span>
            <span>{</span>
                <span>var</span> <span>subscriptions</span> <span>=</span> <span>_subscriptionManager</span><span>.</span><span>GetHandlersForEvent</span><span>(</span><span>eventName</span><span>);</span>
                <span>foreach</span> <span>(</span><span>var</span> <span>subscription</span> <span>in</span> <span>subscriptions</span><span>)</span>
                <span>{</span>
                    <span>var</span> <span>handler</span> <span>=</span> <span>_serviceProvider</span><span>.</span><span>GetRequiredService</span><span>(</span><span>subscription</span><span>.</span><span>HandlerType</span><span>);</span>
                    <span>if</span> <span>(</span><span>handler</span> <span>==</span> <span>null</span><span>)</span> <span>continue</span><span>;</span>

                    <span>var</span> <span>eventType</span> <span>=</span> <span>_subscriptionManager</span><span>.</span><span>GetEventTypeByName</span><span>(</span><span>eventName</span><span>);</span>
                    <span>var</span> <span>integrationEvent</span> <span>=</span> <span>JsonConvert</span><span>.</span><span>DeserializeObject</span><span>(</span><span>message</span><span>,</span> <span>eventType</span><span>);</span>
                    <span>var</span> <span>concreteType</span> <span>=</span> <span>typeof</span><span>(</span><span>IIntegrationEventHandler</span><span>&lt;&gt;).</span><span>MakeGenericType</span><span>(</span><span>eventType</span><span>);</span>
                    <span>await</span> <span>(</span><span>Task</span><span>)</span><span>concreteType</span><span>.</span><span>GetMethod</span><span>(</span><span>"HandleAsync"</span><span>).</span><span>Invoke</span><span>(</span><span>handler</span><span>,</span> <span>new</span> <span>object</span><span>[]</span> <span>{</span> <span>integrationEvent</span> <span>});</span>
                    <span>processed</span> <span>=</span> <span>true</span><span>;</span>
                <span>}</span>
            <span>}</span>

            <span>return</span> <span>processed</span><span>;</span>
        <span>}</span>

        <span>private</span> <span>async</span> <span>Task</span> <span>RemoveDefaultRuleAsync</span><span>()</span>
        <span>{</span>
            <span>try</span>
            <span>{</span>
                <span>await</span> <span>_subscriptionClient</span><span>.</span><span>RemoveRuleAsync</span><span>(</span><span>RuleDescription</span><span>.</span><span>DefaultRuleName</span><span>);</span>
            <span>}</span>
            <span>catch</span> <span>(</span><span>MessagingEntityNotFoundException</span><span>)</span>
            <span>{</span>
                <span>_logger</span><span>.</span><span>LogWarning</span><span>(</span><span>"The messaging entity '{DefaultRuleName}' Could not be found."</span><span>,</span> <span>RuleDescription</span><span>.</span><span>DefaultRuleName</span><span>);</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
</code></pre></div></div>

<p>There are few points here worth mentioning. First of all, please note that every time we subscribe to the event we are doing it using two steps:</p>

<ol>
  <li>We verify whether subscription already exists using subscription manager instance</li>
  <li>If this is new subscription, we use <em>SubscriptionClient</em> instance from the Azure Service Bus SDK to subscribe to specific event</li>
  <li>We add information about the subscription using subscription manager instance</li>
</ol>

<div><div><pre><code>        <span>public</span> <span>async</span> <span>Task</span> <span>SubscribeAsync</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;()</span>
            <span>where</span> <span>T</span> <span>:</span> <span>IntegrationEvent</span>
            <span>where</span> <span>TH</span> <span>:</span> <span>IIntegrationEventHandler</span><span>&lt;</span><span>T</span><span>&gt;</span>
        <span>{</span>
            <span>var</span> <span>eventName</span> <span>=</span> <span>typeof</span><span>(</span><span>T</span><span>).</span><span>Name</span><span>;</span>

            <span>var</span> <span>containsKey</span> <span>=</span> <span>_subscriptionManager</span><span>.</span><span>HasSubscriptionsForEvent</span><span>&lt;</span><span>T</span><span>&gt;();</span>
            <span>if</span> <span>(!</span><span>containsKey</span><span>)</span>
            <span>{</span>
                <span>try</span>
                <span>{</span>
                    <span>await</span> <span>_subscriptionClient</span><span>.</span><span>AddRuleAsync</span><span>(</span><span>new</span> <span>RuleDescription</span>
                    <span>{</span>
                        <span>Filter</span> <span>=</span> <span>new</span> <span>CorrelationFilter</span> <span>{</span> <span>Label</span> <span>=</span> <span>eventName</span> <span>},</span>
                        <span>Name</span> <span>=</span> <span>eventName</span>
                    <span>});</span>
                <span>}</span>
                <span>catch</span> <span>(</span><span>ServiceBusException</span><span>)</span>
                <span>{</span>
                    <span>_logger</span><span>.</span><span>LogWarning</span><span>(</span><span>"The messaging entity '{eventName}' already exists."</span><span>,</span> <span>eventName</span><span>);</span>
                <span>}</span>
            <span>}</span>

            <span>_logger</span><span>.</span><span>LogInformation</span><span>(</span><span>"Subscribing to event '{EventName}' with '{EventHandler}'"</span><span>,</span> <span>eventName</span><span>,</span> <span>typeof</span><span>(</span><span>TH</span><span>).</span><span>Name</span><span>);</span>
            <span>_subscriptionManager</span><span>.</span><span>AddSubscription</span><span>&lt;</span><span>T</span><span>,</span> <span>TH</span><span>&gt;();</span>
        <span>}</span>
</code></pre></div></div>

<p>Similar steps have a place when we want to unubscribe:</p>

<ol>
  <li>we use <em>SubscriptionClient</em> instance from the Azure Service Bus SDK to unsubscribe to specific event</li>
  <li>We remove information about subscription from the subscription manager instance</li>
</ol>

<p>We can then publish information about specific event using <em>PublishAsync</em> method:</p>

<div><div><pre><code>        <span>public</span> <span>async</span> <span>Task</span> <span>PublishAsync</span><span>(</span><span>IntegrationEvent</span> <span>@event</span><span>)</span>
        <span>{</span>
            <span>var</span> <span>eventName</span> <span>=</span> <span>@event</span><span>.</span><span>GetType</span><span>().</span><span>Name</span><span>;</span>
            <span>var</span> <span>jsonMessage</span> <span>=</span> <span>JsonConvert</span><span>.</span><span>SerializeObject</span><span>(</span><span>@event</span><span>);</span>
            <span>var</span> <span>body</span> <span>=</span> <span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetBytes</span><span>(</span><span>jsonMessage</span><span>);</span>

            <span>var</span> <span>message</span> <span>=</span> <span>new</span> <span>Message</span>
            <span>{</span>
                <span>MessageId</span> <span>=</span> <span>Guid</span><span>.</span><span>NewGuid</span><span>().</span><span>ToString</span><span>(),</span>
                <span>Body</span> <span>=</span> <span>body</span><span>,</span>
                <span>Label</span> <span>=</span> <span>eventName</span><span>,</span>
            <span>};</span>

            <span>var</span> <span>topicClient</span> <span>=</span> <span>_serviceBusConnectionManagementService</span><span>.</span><span>CreateTopicClient</span><span>();</span>
            <span>await</span> <span>topicClient</span><span>.</span><span>SendAsync</span><span>(</span><span>message</span><span>);</span>
        <span>}</span>
</code></pre></div></div>

<p>We can also receive information about events that happened in other microservices:</p>

<div><div><pre><code>        <span>private</span> <span>void</span> <span>RegisterSubscriptionClientMessageHandler</span><span>()</span>
        <span>{</span>
            <span>_subscriptionClient</span><span>.</span><span>RegisterMessageHandler</span><span>(</span>
                <span>async</span> <span>(</span><span>message</span><span>,</span> <span>token</span><span>)</span> <span>=&gt;</span>
                <span>{</span>
                    <span>var</span> <span>eventName</span> <span>=</span> <span>message</span><span>.</span><span>Label</span><span>;</span>
                    <span>var</span> <span>messageData</span> <span>=</span> <span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetString</span><span>(</span><span>message</span><span>.</span><span>Body</span><span>);</span>

                    <span>if</span> <span>(</span><span>await</span> <span>ProcessEvent</span><span>(</span><span>eventName</span><span>,</span> <span>messageData</span><span>))</span>
                    <span>{</span>
                        <span>await</span> <span>_subscriptionClient</span><span>.</span><span>CompleteAsync</span><span>(</span><span>message</span><span>.</span><span>SystemProperties</span><span>.</span><span>LockToken</span><span>);</span>
                    <span>}</span>
                <span>},</span>
                <span>new</span> <span>MessageHandlerOptions</span><span>(</span><span>ExceptionReceivedHandler</span><span>)</span> <span>{</span> <span>MaxConcurrentCalls</span> <span>=</span> <span>10</span><span>,</span> <span>AutoComplete</span> <span>=</span> <span>false</span> <span>});</span>
        <span>}</span>
</code></pre></div></div>

<p>In the <em>ProcessEvent</em> method we can check the subscription and if it exists we can process the event:</p>

<div><div><pre><code>        <span>private</span> <span>async</span> <span>Task</span><span>&lt;</span><span>bool</span><span>&gt;</span> <span>ProcessEvent</span><span>(</span><span>string</span> <span>eventName</span><span>,</span> <span>string</span> <span>message</span><span>)</span>
        <span>{</span>
            <span>var</span> <span>processed</span> <span>=</span> <span>false</span><span>;</span>
            <span>if</span> <span>(</span><span>_subscriptionManager</span><span>.</span><span>HasSubscriptionsForEvent</span><span>(</span><span>eventName</span><span>))</span>
            <span>{</span>
                <span>var</span> <span>subscriptions</span> <span>=</span> <span>_subscriptionManager</span><span>.</span><span>GetHandlersForEvent</span><span>(</span><span>eventName</span><span>);</span>
                <span>foreach</span> <span>(</span><span>var</span> <span>subscription</span> <span>in</span> <span>subscriptions</span><span>)</span>
                <span>{</span>
                    <span>var</span> <span>handler</span> <span>=</span> <span>_serviceProvider</span><span>.</span><span>GetRequiredService</span><span>(</span><span>subscription</span><span>.</span><span>HandlerType</span><span>);</span>
                    <span>if</span> <span>(</span><span>handler</span> <span>==</span> <span>null</span><span>)</span> <span>continue</span><span>;</span>

                    <span>var</span> <span>eventType</span> <span>=</span> <span>_subscriptionManager</span><span>.</span><span>GetEventTypeByName</span><span>(</span><span>eventName</span><span>);</span>
                    <span>var</span> <span>integrationEvent</span> <span>=</span> <span>JsonConvert</span><span>.</span><span>DeserializeObject</span><span>(</span><span>message</span><span>,</span> <span>eventType</span><span>);</span>
                    <span>var</span> <span>concreteType</span> <span>=</span> <span>typeof</span><span>(</span><span>IIntegrationEventHandler</span><span>&lt;&gt;).</span><span>MakeGenericType</span><span>(</span><span>eventType</span><span>);</span>
                    <span>await</span> <span>(</span><span>Task</span><span>)</span><span>concreteType</span><span>.</span><span>GetMethod</span><span>(</span><span>"HandleAsync"</span><span>).</span><span>Invoke</span><span>(</span><span>handler</span><span>,</span> <span>new</span> <span>object</span><span>[]</span> <span>{</span> <span>integrationEvent</span> <span>});</span>
                    <span>processed</span> <span>=</span> <span>true</span><span>;</span>
                <span>}</span>
            <span>}</span>

            <span>return</span> <span>processed</span><span>;</span>
        <span>}</span>
</code></pre></div></div>

<p>In the above method we can see that we pass the event to specific event handler. I encourage to check the whole source code of the Cars Island solution to understand the flow.</p>

<h2 id="emitting-events">Emitting events</h2>

<p>Once we know how to send and receive events with the Azure Service Bus, we can see how these events are emitted and received in the sample scenario. As I mentioned at the beginning, we are going to update car price per day in each reservation once the price is updated in the catalog for a specific car.</p>

<h3 id="emit-event-in-the-catalog-microservice">Emit event in the Catalog microservice</h3>

<p>Let’s start with the <em>Catalog</em> microservice. In the <em>CarsCatalogController</em> class there is a method responsible for updating car’s details in the catalog:</p>

<div><div><pre><code>        <span>/// &lt;summary&gt;</span>
        <span>/// Update existing car in the catalog</span>
        <span>/// &lt;/summary&gt;</span>
        <span>[</span><span>HttpPut</span><span>]</span>
        <span>[</span><span>ProducesResponseType</span><span>((</span><span>int</span><span>)</span><span>HttpStatusCode</span><span>.</span><span>NotFound</span><span>)]</span>
        <span>[</span><span>ProducesResponseType</span><span>((</span><span>int</span><span>)</span><span>HttpStatusCode</span><span>.</span><span>NoContent</span><span>)]</span>
        <span>public</span> <span>async</span> <span>Task</span><span>&lt;</span><span>ActionResult</span><span>&gt;</span> <span>UpdateCarAsync</span><span>([</span><span>FromBody</span><span>]</span> <span>Car</span> <span>carToUpdate</span><span>)</span>
        <span>{</span>
            <span>var</span> <span>existingCarFromTheCatalog</span> <span>=</span> <span>await</span> <span>_carCatalogDbContext</span><span>.</span><span>Cars</span><span>.</span><span>SingleOrDefaultAsync</span><span>(</span><span>i</span> <span>=&gt;</span> <span>i</span><span>.</span><span>Id</span> <span>==</span> <span>carToUpdate</span><span>.</span><span>Id</span><span>);</span>

            <span>if</span> <span>(</span><span>existingCarFromTheCatalog</span> <span>==</span> <span>null</span><span>)</span>
            <span>{</span>
                <span>return</span> <span>NotFound</span><span>(</span><span>new</span> <span>{</span> <span>Message</span> <span>=</span> <span>$"Car with id </span><span>{</span><span>carToUpdate</span><span>.</span><span>Id</span><span>}</span><span> not found."</span> <span>});</span>
            <span>}</span>

            <span>else</span>
            <span>{</span>
                <span>existingCarFromTheCatalog</span><span>.</span><span>Brand</span> <span>=</span> <span>carToUpdate</span><span>.</span><span>Brand</span><span>;</span>
                <span>existingCarFromTheCatalog</span><span>.</span><span>Model</span> <span>=</span> <span>carToUpdate</span><span>.</span><span>Model</span><span>;</span>

                <span>var</span> <span>oldPricePerDay</span> <span>=</span> <span>existingCarFromTheCatalog</span><span>.</span><span>PricePerDay</span><span>;</span>
                <span>var</span> <span>hasPricePerDayChanged</span> <span>=</span> <span>existingCarFromTheCatalog</span><span>.</span><span>PricePerDay</span> <span>!=</span> <span>carToUpdate</span><span>.</span><span>PricePerDay</span><span>;</span>
                <span>existingCarFromTheCatalog</span><span>.</span><span>PricePerDay</span> <span>=</span> <span>carToUpdate</span><span>.</span><span>PricePerDay</span><span>;</span>

                <span>_carCatalogDbContext</span><span>.</span><span>Cars</span><span>.</span><span>Update</span><span>(</span><span>existingCarFromTheCatalog</span><span>);</span>

                <span>if</span> <span>(</span><span>hasPricePerDayChanged</span><span>)</span>
                <span>{</span>
                    <span>var</span> <span>pricePerDayChangedEvent</span> <span>=</span> <span>new</span> <span>CarPricePerDayChangedIntegrationEvent</span><span>(</span><span>existingCarFromTheCatalog</span><span>.</span><span>Id</span><span>,</span>
                                                                                            <span>existingCarFromTheCatalog</span><span>.</span><span>PricePerDay</span><span>,</span>
                                                                                            <span>oldPricePerDay</span><span>);</span>

                    <span>await</span> <span>_catalogIntegrationEventService</span><span>.</span><span>AddAndSaveEventAsync</span><span>(</span><span>pricePerDayChangedEvent</span><span>);</span>
                    <span>await</span> <span>_catalogIntegrationEventService</span><span>.</span><span>PublishEventsThroughEventBusAsync</span><span>(</span><span>pricePerDayChangedEvent</span><span>);</span>
                <span>}</span>

                <span>else</span>
                <span>{</span>
                    <span>await</span> <span>_carCatalogDbContext</span><span>.</span><span>SaveChangesAsync</span><span>();</span>
                <span>}</span>
                <span>return</span> <span>NoContent</span><span>();</span>
            <span>}</span>
        <span>}</span>
</code></pre></div></div>
<p>As we can see in above sample, if the price has changed, we would like to update it in the database and also emit the event so other microservices know about this change. In this case, we create <em>CarPricePerDayChangedIntegrationEvent</em> instance with information about the old and new price per day for a specific car. Let’s omit <em>AddAndSaveEventAsync</em> for now as it is not related to the topic. The important line is this one:</p>

<div><div><pre><code>      <span>await</span> <span>_catalogIntegrationEventService</span><span>.</span><span>PublishEventsThroughEventBusAsync</span><span>(</span><span>pricePerDayChangedEvent</span><span>);</span>
</code></pre></div></div>

<p>Using the above line, we are able to send the event through the Azure Service Bus. All other microservices which subscribed will receive it.</p>

<h3 id="receive-event-in-the-reservation-microservice">Receive event in the Reservation microservice</h3>

<p>Once the event is emitted, we can receive it. In the <em>Reservation</em> microservice we have to subscribe to <em>CarPricePerDayChangedIntegrationEvent</em> event. In the <em>IntegrationServiceCollectionExtensions</em> class in the <em>API</em> project there is a source code responsible for setting up Azure Service Bus connection. This is also the place where we can specify to which events we would like to subscribe to:</p>

<div><div><pre><code>        <span>public</span> <span>static</span> <span>IServiceCollection</span> <span>AddIntegrationServices</span><span>(</span><span>this</span> <span>IServiceCollection</span> <span>services</span><span>)</span>
        <span>{</span>
            <span>var</span> <span>serviceProvider</span> <span>=</span> <span>services</span><span>.</span><span>BuildServiceProvider</span><span>();</span>
            <span>var</span> <span>azureServiceBusConfiguration</span> <span>=</span> <span>serviceProvider</span><span>.</span><span>GetRequiredService</span><span>&lt;</span><span>IAzureServiceBusConfiguration</span><span>&gt;();</span>

            <span>services</span><span>.</span><span>AddSingleton</span><span>&lt;</span><span>IEventBusSubscriptionsManager</span><span>,</span> <span>InMemoryEventBusSubscriptionsManager</span><span>&gt;();</span>
            <span>services</span><span>.</span><span>AddTransient</span><span>&lt;</span><span>IIntegrationEventHandler</span><span>&lt;</span><span>CarPricePerDayChangedIntegrationEvent</span><span>&gt;,</span> <span>CarPricePerDayChangedIntegrationEventHandler</span><span>&gt;();</span>

            <span>services</span><span>.</span><span>AddSingleton</span><span>&lt;</span><span>IServiceBusConnectionManagementService</span><span>&gt;(</span><span>sp</span> <span>=&gt;</span>
            <span>{</span>
                <span>var</span> <span>logger</span> <span>=</span> <span>sp</span><span>.</span><span>GetRequiredService</span><span>&lt;</span><span>ILogger</span><span>&lt;</span><span>ServiceBusConnectionManagementService</span><span>&gt;&gt;();</span>
                <span>var</span> <span>serviceBusConnection</span> <span>=</span> <span>new</span> <span>ServiceBusConnectionStringBuilder</span><span>(</span><span>azureServiceBusConfiguration</span><span>.</span><span>ConnectionString</span><span>);</span>
                <span>return</span> <span>new</span> <span>ServiceBusConnectionManagementService</span><span>(</span><span>logger</span><span>,</span> <span>serviceBusConnection</span><span>);</span>
            <span>});</span>

            <span>services</span><span>.</span><span>AddSingleton</span><span>&lt;</span><span>IEventBus</span><span>,</span> <span>AzureServiceBusEventBus</span><span>&gt;(</span><span>sp</span> <span>=&gt;</span>
            <span>{</span>
                <span>var</span> <span>serviceBusConnectionManagementService</span> <span>=</span> <span>sp</span><span>.</span><span>GetRequiredService</span><span>&lt;</span><span>IServiceBusConnectionManagementService</span><span>&gt;();</span>
                <span>var</span> <span>logger</span> <span>=</span> <span>sp</span><span>.</span><span>GetRequiredService</span><span>&lt;</span><span>ILogger</span><span>&lt;</span><span>AzureServiceBusEventBus</span><span>&gt;&gt;();</span>
                <span>var</span> <span>eventBusSubcriptionsManager</span> <span>=</span> <span>sp</span><span>.</span><span>GetRequiredService</span><span>&lt;</span><span>IEventBusSubscriptionsManager</span><span>&gt;();</span>

                <span>var</span> <span>eventBus</span> <span>=</span> <span>new</span> <span>AzureServiceBusEventBus</span><span>(</span><span>serviceBusConnectionManagementService</span><span>,</span> <span>eventBusSubcriptionsManager</span><span>,</span>
                    <span>serviceProvider</span><span>,</span> <span>logger</span><span>,</span> <span>azureServiceBusConfiguration</span><span>.</span><span>SubscriptionClientName</span><span>);</span>
                <span>return</span> <span>eventBus</span><span>;</span>
            <span>});</span>


            <span>services</span><span>.</span><span>AddTransient</span><span>&lt;</span><span>Func</span><span>&lt;</span><span>DbConnection</span><span>,</span> <span>IEventLogService</span><span>&gt;&gt;(</span>
                    <span>sp</span> <span>=&gt;</span> <span>(</span><span>DbConnection</span> <span>connection</span><span>)</span> <span>=&gt;</span> <span>new</span> <span>EventLogService</span><span>(</span><span>connection</span><span>));</span>

            <span>serviceProvider</span> <span>=</span> <span>services</span><span>.</span><span>BuildServiceProvider</span><span>();</span>

            <span>var</span> <span>eventBus</span> <span>=</span> <span>serviceProvider</span><span>.</span><span>GetRequiredService</span><span>&lt;</span><span>IEventBus</span><span>&gt;();</span>
            <span>eventBus</span><span>.</span><span>SetupAsync</span><span>().</span><span>GetAwaiter</span><span>().</span><span>GetResult</span><span>();</span>
            <span>eventBus</span><span>.</span><span>SubscribeAsync</span><span>&lt;</span><span>CarPricePerDayChangedIntegrationEvent</span><span>,</span>
                                    <span>IIntegrationEventHandler</span><span>&lt;</span><span>CarPricePerDayChangedIntegrationEvent</span><span>&gt;&gt;()</span>
                                    <span>.</span><span>GetAwaiter</span><span>().</span><span>GetResult</span><span>();</span>

            <span>return</span> <span>services</span><span>;</span>
        <span>}</span>
</code></pre></div></div>

<p>As we can see, there is subscription manager specific type registered in the IoC container together with event handler responsible for handling events related to price changes for cars:</p>

<div><div><pre><code>            <span>services</span><span>.</span><span>AddSingleton</span><span>&lt;</span><span>IEventBusSubscriptionsManager</span><span>,</span> <span>InMemoryEventBusSubscriptionsManager</span><span>&gt;();</span>
            <span>services</span><span>.</span><span>AddTransient</span><span>&lt;</span><span>IIntegrationEventHandler</span><span>&lt;</span><span>CarPricePerDayChangedIntegrationEvent</span><span>&gt;,</span> <span>CarPricePerDayChangedIntegrationEventHandler</span><span>&gt;();</span>
</code></pre></div></div>

<p>There is also a factory method implemented responsible for creating <em>AzureServiceBusEventBus</em> instance.</p>

<h2 id="azure-service-bus-topics-and-subscriptions-in-the-azure-portal">Azure Service Bus topics and subscriptions in the Azure portal:</h2>

<p>There can be confusion related to how properly register topics and subscriptions in the Azure Service Bus. This is why I decided to include this information.</p>

<h3 id="topics">Topics</h3>

<p>There is one topic for the whole solution. It is called <em>cars-island-events</em>:</p>

<p>
<img src="https://daniel-krzyczkowski.github.io/images/devisland/article37/assets/MicroservicesAzureServiceBusCommunication3.PNG?raw=true" alt="Image not found">
</p>

<h3 id="subscriptions">Subscriptions</h3>

<p>There is one subscription per each microservice so for this example there is <em>Catalog</em> and <em>Reservation</em> subscription:</p>

<p>
<img src="https://daniel-krzyczkowski.github.io/images/devisland/article37/assets/MicroservicesAzureServiceBusCommunication4.PNG?raw=true" alt="Image not found">
</p>

<p>Please note that we filter events using <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/topic-filters">rules and labels</a> in the Azure Service Bus messages.</p>



<p>In this article I presented how to implement asynchronous communication between microservices using Azure Service Bus. It is a powerful service available in the Azure cloud. I encourage you to check the source code for the whole solution on <a href="https://github.com/Daniel-Krzyczkowski/MicrosoftAzure/tree/master/asp-net-core-microservices-with-azure-and-docker">my GitHub.</a></p>


        
      </section>

      

      


      
  

    </div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>