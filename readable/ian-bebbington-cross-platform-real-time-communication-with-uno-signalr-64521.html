<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Ian Bebbington - Cross-Platform Real-Time Communication with Uno &amp; SignalR - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Ian Bebbington - Cross-Platform Real-Time Communication with Uno &amp; SignalR - linksfor.dev(s)"/>
    <meta property="og:description" content="IObservable&lt;Opinion&gt;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://ian.bebbs.co.uk/posts/UnoChat"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Ian Bebbington - Cross-Platform Real-Time Communication with Uno &amp; SignalR</title>
<div class="readable">
        <h1>Ian Bebbington - Cross-Platform Real-Time Communication with Uno &amp; SignalR</h1>
            <div>Reading time: 28-36 minutes</div>
        <div>Posted here: 20 Jul 2020</div>
        <p><a href="https://ian.bebbs.co.uk/posts/UnoChat">https://ian.bebbs.co.uk/posts/UnoChat</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
                        <div>
                                <div id="content">
                                        

<h2 id="tldr">TL;DR</h2>
<p>In this article we will see how to use <a href="https://platform.uno/">Uno Platform</a> and <a href="https://docs.microsoft.com/en-us/aspnet/signalr/overview/getting-started/introduction-to-signalr">SignalR</a> to create applications that run on all major platforms - PC, Mac, Android, iOS <em><strong>and</strong></em> Web - and are capable of receiving real-time updates from a SignalR service. As you will see, these two technologies work incredibly well together, providing an elegant solution to a use-case which, just a few years ago, would have been fiendishly difficult.</p>
<p>All the source code for this post can be found in my <a href="https://github.com/ibebbs/UnoChat">UnoChat</a> repository on GitHub.</p>
<h2 id="intro">Intro</h2>
<p>A project I'm working on features a web-dashboard. Being a XAML fan, using Uno to create a web-assembly app was a complete a no-brainer... until I realised that I wanted the dashboard to feature real-time updates. Thanks to SignalR (and a host of subsequent technologies) real-time updates is nothing new for traditional web apps but how would these technologies fare when used with Uno/WebAssembly.</p>
<p>Hunting around, I had seen that a couple of people had tried this approach a while back but had hit various stumbling blocks along the way. As far as I could tell, no-one had yet managed to get a working solution which, as you might imagine, was a tad worrying.</p>
<p>Regardless, I knew that Uno and its compilation to WebAssembly (driven by the amazing work undertaken by the <a href="https://github.com/mono/mono">Mono team</a>) had progressed massively in the last year so I figured I'd give it a go to see if I could get any further. I was very much prepared for a bit of a slog here, expecting to have to dig into the internals of both Uno and SignalR in order to get it working. But I was <em>not</em> prepared for what actually happened:</p>
<p>It... just... worked.</p>
<p>First time.</p>
<p>With no kludges, no work-arounds, no untoward platform-specific code and no conditional compilation.</p>
<p>It really did <strong>Just Workâ„¢</strong>.</p>
<p>The following post shows how you can use these amazing technologies together to deliver real-time updates to a cross-platform app.</p>
<h2 id="ingredients">Ingredients</h2>
<p>To cook up this little sumptuous little dish, you will need a copy of Visual Studio 2019 with the following installed:</p>
<ol>
<li>"ASP.NET and Web development" workload</li>
<li>"Azure development" workload</li>
<li>"Universal Windows Platform development" workload</li>
<li>"Mobile development with .NET" workload</li>
<li>".NET Core cross-platform development" toolset</li>
<li>The <a href="https://marketplace.visualstudio.com/items?itemName=nventivecorp.uno-platform-addin">Uno Platform Solution Templates</a>.</li>
</ol>
<p>You will also need a (<a href="https://azure.microsoft.com/en-us/free/">free</a>) Azure account to which we'll publish our SignalR service so it's easily available to our client platforms.</p>
<h2 id="objective">Objective</h2>
<p>We're going to be building a version of the <a href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/signalr?view=aspnetcore-3.1&amp;tabs=visual-studio">"Get started with ASP.NET Core SignalR"</a> sample app but, instead of an "HTML+js" client, we're going to be using  Uno to write an app which can be compiled and run natively across multiple platforms <em>including</em> the web.</p>
<p>When we're finished, we'll have a solution which looks like this:</p>
<pre><code>UnoChat
<span>|- UnoChat.Service
|</span>- UnoChat.Client.Console
<span>|- UnoChat.Client.App
   |</span>- UnoChat.Client.App.Droid
   <span>|- UnoChat.Client.App.iOS
   |</span>- UnoChat.Client.App.macOS
   <span>|- UnoChat.Client.App.UWP
   |</span>- UnoChat.Client.App.Wasm
   <span>|- UnoChat.Client.App.Shared
</span></code></pre>
<p>We'll dive into each of these projects individually below with the occasional "F5" to test our progress.</p>
<p>Right, lets go!</p>
<h2 id="service-console-client-testing-deployment">Service, Console Client, Testing &amp; Deployment</h2>
<h3 id="unochat.service">UnoChat.Service</h3>
<p>We'll first create the SignalR service. As this is covered quite extensively in the <a href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/signalr?view=aspnetcore-3.1&amp;tabs=visual-studio">sample app</a> we're basing this article on I'm going to shoot through this pretty quickly, only covering notable differences and the code we should end up with.</p>
<p>Ok, start up Visual Studio 2019 and create a new project as shown here:</p>

<p>Now, follow the steps in the <a href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/signalr?view=aspnetcore-3.1&amp;tabs=visual-studio#create-a-signalr-hub">"Create a SignalR hub"</a> section of the sample app to create a <code>ChatHub : Hub</code> class in a <code>Hubs</code> folder within the <code>UnoChat.Service</code> project.</p>
<p>We'll continue with the configuration described in the <a href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/signalr?view=aspnetcore-3.1&amp;tabs=visual-studio#configure-signalr">"Configure SignalR"</a> but we'll also be adding a <a href="https://docs.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-3.1">CORS policy</a> such that we're able to connect to it from a locally hosted Wasm app. The final configuration of the <code>Startup</code> class in the <code>UnoChat.Service</code> project should look like this:</p>
<pre><code><span>using</span> Microsoft.AspNetCore.Builder;
<span>using</span> Microsoft.AspNetCore.Hosting;
<span>using</span> Microsoft.Extensions.Configuration;
<span>using</span> Microsoft.Extensions.DependencyInjection;
<span>using</span> Microsoft.Extensions.Hosting;

<span>namespace</span> UnoChat.Service
{
    <span>public</span> <span>class</span> Startup
    {
        <span><span>public</span> <span>Startup</span><span>(IConfiguration configuration)</span>
        </span>{
            Configuration = configuration;
        }

        <span>public</span> IConfiguration Configuration { get; }

        
        <span><span>public</span> <span>void</span> <span>ConfigureServices</span><span>(IServiceCollection services)</span>
        </span>{
            services.AddRazorPages();
            services.AddSignalR();

            services.AddCors(o =&gt; o.AddPolicy(
                 <span>"CorsPolicy"</span>,
                 builder =&gt; builder
                    .AllowAnyOrigin()
                    .AllowAnyMethod()
                    .AllowAnyHeader()
                 )
            );
        }

        
        <span><span>public</span> <span>void</span> <span>Configure</span><span>(IApplicationBuilder app, IWebHostEnvironment env)</span>
        </span>{
            <span>if</span> (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }
            <span>else</span>
            {
                app.UseExceptionHandler(<span>"/Error"</span>);
                
                app.UseHsts();
            }

            app.UseHttpsRedirection();
            app.UseStaticFiles();

            app.UseRouting();
            app.UseCors(<span>"CorsPolicy"</span>);

            app.UseAuthorization();

            app.UseEndpoints(endpoints =&gt;
            {
                endpoints.MapRazorPages();
                endpoints.MapHub&lt;Hubs.ChatHub&gt;(<span>"/chathub"</span>);
            });
        }
    }
}
</code></pre>
<p>And that's it. Seriously that's all we need to create a service which is able to provide real-time communication services to a whole host of client applications.... I know, right!</p>
<h3 id="unochat.client.console">UnoChat.Client.Console</h3>
<p>Next we'll create a quick console application to test our SignalR service prior to diving into a cross platform solution with Uno.</p>
<blockquote>
<p>BTW, the console app - by virtue of being .NET Core - is also cross-platform and will run on... well... <a href="https://docs.microsoft.com/en-us/dotnet/core/">pretty much anything</a>.</p>
</blockquote>
<p>So, right click on the "UnoChat" solution and add a new "Console App (.NET Core)" project as shown here:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/CreateNewNetCoreConsoleApp.png" alt="Create New Net Core Console App"></p><p>Then, add the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.SignalR.Client/"><code>Microsoft.AspNetCore.SignalR.Client</code> nuget package</a> to the <code>UnoChat.Client.Console</code> project as shown here:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/InstallMicrosoftAspNetCoreSignalRClientInUnoChatClientConsole.png" alt="Install Microsoft Asp Net Core SignalR Client In UnoChat Client Console"></p><p>Finally, replace the code in <code>Main.cs</code> with the following:</p>
<pre><code><span>using</span> Microsoft.AspNetCore.SignalR.Client;
<span>using</span> System.Threading.Tasks;

<span>namespace</span> UnoChat.Client.Console
{
    <span>using</span> Console = System.Console;

    <span>class</span> Program
    {
        <span><span>static</span> async Task <span>Main</span><span>(<span>string</span>[] args)</span>
        </span>{
            Console.WriteLine(<span>"Hi! Err... who are you?"</span>);

            var name = Console.ReadLine();

            Console.WriteLine($<span>"Ok {name} one second, we're going to connect to the SignalR server..."</span>);

            var connection = <span>new</span> HubConnectionBuilder()
                .WithUrl(<span>"http://localhost:61877/ChatHub"</span>)
                .WithAutomaticReconnect()
                .Build();

            connection.On&lt;<span>string</span>, <span>string</span>&gt;(<span>"ReceiveMessage"</span>, (user, message) =&gt; Console.WriteLine($<span>"{user}: {message}"</span>));

            await connection.StartAsync();

            Console.WriteLine($<span>"Aaaaaand we're connected. Enter a message and hit return to send it to other connected clients..."</span>);

            <span>while</span> (<span>true</span>)
            {
                var message = Console.ReadLine();

                await connection.InvokeAsync(<span>"SendMessage"</span>, name, message);
            }
        }
    }
}
</code></pre>
<blockquote>
<p>Note: You'll need to ensure the port number in the <code>.WithUrl("http://localhost:61877/ChatHub")</code> line is correct. You can find the port number your <code>UnoChat.Service</code> is set to use by right clicking on the <code>UnoChat.Service</code> project, selecting <code>Properties</code>, navigating to the <code>Debug</code> tab and examining the <code>App URL</code> setting in the <code>Web Server Settings</code> section as shown here:
<img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatServiceDebugSettings.png" alt="UnoChat Service Debug Settings"></p>
</blockquote>
<h3 id="local-testing">Local Testing</h3>
<p>Now we can test our service with our client console. Right click on the <code>UnoChat.Service</code> project and select <code>Debug-&gt;Start New Instance</code>. After a few seconds compilation a browser window should open and show something similar to this:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatServiceDebugBrowser.png" alt="UnoChat Service Debug Browser"></p><p>With that running, go back to Visual Studio and right click on the <code>UnoChat.Client.Console</code> project and again select <code>Debug-&gt;Start New Instance</code>. A console window should appear asking who you are. Enter a name, hit return and wait for the app to tell you that it has connected. At this point you can send messages to the <code>UnoChat.Service</code> which should be echoed back to the console window prefixed with your name as shown here:</p>
<video controls="" autoplay="" loop="">
  <source src="/Content/UnoChat/UnoChatClientConsoleDebug.mp4" type="video/mp4">
Your browser does not support the video tag
</video>
<p>Just to show we're not just echoing these things locally, right click on the <code>UnoChat.Client.Console</code> project again and start a second instance using <code>Debug-&gt;Start New Instance</code>. In this window enter a different name and wait for connection. Now when you send a message, you'll see it in both console windows as shown here:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatClientConsoleTwoInstances.png" alt="UnoChat Client Console Two Instances"></p><p>Pretty neat huh!</p>
<h3 id="deployment">Deployment</h3>
<p>With our SignalR service running nicely, lets deploy it to Azure by right clicking on the <code>UnoChat.Service</code> project and selecting <code>Publish...</code>. I'm not going to cover this process in too much detail as it's <a href="https://docs.microsoft.com/en-US/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2019">thoroughly documented elsewhere</a> but, if you've not done this before, the following screen shots should help you through:</p>
<table>
  <tbody><tr>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureI.png" alt="Publish UnoChat Service To Azure - Step 1"></td>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureII.png" alt="Publish UnoChat Service To Azure - Step 2"></td>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureIII.png" alt="Publish UnoChat Service To Azure - Step 3"></td>
  </tr>
  <tr>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureIV.png" alt="Publish UnoChat Service To Azure - Step 4"></td>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureV.png" alt="Publish UnoChat Service To Azure - Step 5"></td>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureVI.png" alt="Publish UnoChat Service To Azure - Step 6"></td>
  </tr>
  <tr>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureVII.png" alt="Publish UnoChat Service To Azure - Step 7"></td>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureVIII.png" alt="Publish UnoChat Service To Azure - Step 8"></td>
    <td><img src="https://ian.bebbs.co.uk/Content/UnoChat/PublishUnoChatServiceToAzureIX.png" alt="Publish UnoChat Service To Azure - Step 9"></td>
    <td></td>
  </tr>
</tbody></table>
<p>Still with me? Great.</p>
<p>Lets test our deployed SignalR service by updating the <code>.WithUrl("http://localhost:61877/ChatHub")</code> line in our <code>UnoChat.Client.Console</code> app to match the deployed service as shown in the last screenshot above; for me it's <code>.WithUrl("https://unochatservice20200716114254.azurewebsites.net/ChatHub")</code>. Once done you should be able to start the <code>UnoChat.Client.Console</code> app and send/receive messages to/from your deployed SignalR service.</p>
<p>Now for the magic...</p>
<h2 id="uno-client">Uno Client</h2>
<h3 id="creating-preparing-an-uno-project">Creating &amp; Preparing An Uno Project</h3>
<p>Back in Visual Studio, right click the <code>UnoChat</code> solution and <code>Add-&gt;New Project...</code>.  Select <code>Cross-Platform App (Uno Platform)</code> from the <code>Add a new project</code> dialog and click Next. Name it <code>UnoChat.Client</code> on the <code>Configure your new project</code> dialog and finally click <code>Create</code>:</p>

<p>To help keep my solution organised, I like to group all the Uno "head" projects in a solution folder. This is shown below but don't feel obliged to follow suit:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatClientSolutionFolder.png" alt="UnoChat Client Solution Folder"></p><p>Now, the first thing to do here is to get our dependencies in order using the following steps:</p>
<ol>
<li>Upgrade all <code>Uno.*</code> packages to the latest non-prelease versions (at the time of writing this is <code>Uno.UI</code> &amp; <code>Uno.UI.RemoteControl</code> to v2.4.4, <code>Uno.Wasm.Bootstrap</code> &amp; <code>Uno.Wasm.Bootstrap.DevServer</code> to v1.3.0)</li>
<li>Install the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.SignalR.Client/"><code>Microsoft.AspNetCore.SignalR.Client</code> nuget package</a> to all the head projects (UnoChat.Client.Droid, UnoChat.Client.iOS, etc, etc).</li>
<li>Install the <a href="https://www.nuget.org/packages/MVx.Observable/"><code>MVx.Observable</code> nuget package</a> to all the head projects (UnoChat.Client.Droid, UnoChat.Client.iOS, etc, etc).</li>
</ol>
<blockquote>
<p>Quick tip: Use the <code>Manage NuGet Packages for Solution...</code> option from the solution's right-click menu to get this done much faster than modifying individual projects.</p>
</blockquote>
<p>Lastly use the <code>Properties</code> window to change the <code>Root namespace</code> value for the <code>UnoChat.Client.Shared</code> project from <code>UnoChat.Client.Shared</code> to just <code>UnoChat.Client</code> (I'm kind hoping this change makes it into the Uno templates at some point).</p>
<h3 id="mvx.observable">MVx.Observable</h3>
<p>I like to implement UI/UX flows using behavioural, declarative and functional paradigms. I wrote <code>MVx.Observable</code> to be a "(mostly) unopinionated, light-weight alternative to ReactiveUI provided as a library <em>not a framework</em>" and have written about it extensively <a href="https://ian.bebbs.co.uk/posts/ReactiveBehaviors">here</a> and <a href="https://ian.bebbs.co.uk/posts/Uno#four-important-words">here</a>.</p>
<p>You don't <em>need</em> to use <code>MVx.Observable</code> to implement the functionality present in this project but I'd encourage you to at least give it a try as, like ReactiveUI, these patterns really can help manage UI state, ensure UX flows are testable and keep discrete behaviours... well, discrete.</p>
<p><code>MVx.Observable</code> uses <a href="https://www.nuget.org/packages/System.Reactive/"><code>System.Reactive</code></a> to embody it's behaviours in a reactive manner and, as these behaviours interact with the UI, we need to use <code>IScheduler</code> instances to ensure we update the UI from the correct thread. This is somewhat complicated by the fact that we're writing a cross-platform app which uses different <code>IScheduler</code> implementations to marshal updates to the appropriate platform threads. Fortunately, this complexity is easily tamed through the use of <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/partial-classes-and-methods">Partial Classes and Methods</a>.</p>
<p>In the <code>UnoChat.Client.Shared</code> project, add a <code>Schedulers.cs</code> file with the following content:</p>
<pre><code><span>using</span> System;
<span>using</span> System.Reactive.Concurrency;
<span>using</span> System.Threading;

<span>namespace</span> UnoChat.Client
{
    <span>public</span> <span>static</span> partial <span>class</span> Schedulers
    {
        <span><span>static</span> partial <span>void</span> <span>OverrideDispatchScheduler</span><span>(ref IScheduler scheduler)</span></span>;

        <span>private</span> <span>static</span> readonly Lazy&lt;IScheduler&gt; DispatcherScheduler = <span>new</span> Lazy&lt;IScheduler&gt;(
            () =&gt;
            {
                IScheduler scheduler = null;

                OverrideDispatchScheduler(ref scheduler);

                <span>return</span> scheduler == null
                    ? <span>new</span> SynchronizationContextScheduler(SynchronizationContext.Current)
                    : scheduler;
            }
        );

        <span>public</span> <span>static</span> IScheduler Dispatcher =&gt; DispatcherScheduler.Value;

        <span>public</span> <span>static</span> IScheduler Default =&gt; Scheduler.Default;
    }
}
</code></pre>
<p>Then, in the UWP head, override the <code>OverrideDispatchScheduler</code> method to provide the correct scheduler for the platform by adding a <code>Schedulers.cs</code> file to the head project with the following content:</p>
<pre><code><span>using</span> System.Reactive.Concurrency;
<span>using</span> Windows.UI.Xaml;

<span>namespace</span> UnoChat.Client
{
    <span>public</span> <span>static</span> partial <span>class</span> Schedulers
    {
        <span><span>static</span> partial <span>void</span> <span>OverrideDispatchScheduler</span><span>(ref IScheduler scheduler)</span>
        </span>{
            scheduler = <span>new</span> CoreDispatcherScheduler(Window.Current.Dispatcher);
        }
    }
}
</code></pre>
<p>Now we can safely use the scheduler in our solution knowing that we're able to easily marshal operations to and from the UI thread.</p>
<h3 id="viewmodel">ViewModel</h3>
<p>Leveraging <code>MVx.Observable</code> we're now going to create a <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93viewmodel">ViewModel</a> to manage all the interaction with SignalR ensuring we don't need have any logic in the view's code-behind.</p>
<p>Create a new <code>ViewModel</code> class in the <code>UnoChat.Client.Shared</code> project containing the following code:</p>
<pre><code><span>using</span> Microsoft.AspNetCore.SignalR.Client;
<span>using</span> System;
<span>using</span> System.Collections.Generic;
<span>using</span> System.ComponentModel;
<span>using</span> System.Linq;
<span>using</span> System.Reactive.Disposables;
<span>using</span> System.Reactive.Linq;
<span>using</span> System.Windows.Input;
<span>using</span> Uno.Extensions;

<span>namespace</span> UnoChat.Client
{
    <span>public</span> <span>class</span> ViewModel : INotifyPropertyChanged
    {
        <span>private</span> readonly MVx.Observable.Property&lt;<span>string</span>&gt; _name;
        <span>private</span> readonly MVx.Observable.Property&lt;HubConnectionState&gt; _state;
        <span>private</span> readonly MVx.Observable.Command _connect;

        <span>private</span> readonly MVx.Observable.Property&lt;<span>string</span>&gt; _lastMessageReceived;
        <span>private</span> readonly MVx.Observable.Property&lt;IEnumerable&lt;<span>string</span>&gt;&gt; _allMessages;
        <span>private</span> readonly MVx.Observable.Property&lt;<span>string</span>&gt; _messageToSend;
        <span>private</span> readonly MVx.Observable.Property&lt;<span>bool</span>&gt; _messageToSendIsEnabled;
        <span>private</span> readonly MVx.Observable.Command _sendMessage;

        <span>private</span> readonly HubConnection _connection;

        <span>public</span> event PropertyChangedEventHandler PropertyChanged;

        <span>private</span> <span>static</span> <span>string</span> DefaultName =&gt; typeof(ViewModel)
            .Assembly
            .GetName()
            .Name
            .Split(<span>'.'</span>)
            .Last();

        <span><span>public</span> <span>ViewModel</span><span>()</span>
        </span>{
            _name = <span>new</span> MVx.Observable.Property&lt;<span>string</span>&gt;(DefaultName, nameof(Name), args =&gt; PropertyChanged?.Invoke(<span>this</span>, args));
            _state = <span>new</span> MVx.Observable.Property&lt;HubConnectionState&gt;(HubConnectionState.Disconnected, nameof(State), args =&gt; PropertyChanged?.Invoke(<span>this</span>, args));
            _connect = <span>new</span> MVx.Observable.Command();
            _lastMessageReceived = <span>new</span> MVx.Observable.Property&lt;<span>string</span>&gt;(nameof(LastMessageReceived), args =&gt; PropertyChanged?.Invoke(<span>this</span>, args));
            _allMessages = <span>new</span> MVx.Observable.Property&lt;IEnumerable&lt;<span>string</span>&gt;&gt;(Enumerable.Empty&lt;<span>string</span>&gt;(), nameof(AllMessages), args =&gt; PropertyChanged?.Invoke(<span>this</span>, args));
            _messageToSend = <span>new</span> MVx.Observable.Property&lt;<span>string</span>&gt;(nameof(MessageToSend), args =&gt; PropertyChanged?.Invoke(<span>this</span>, args));
            _messageToSendIsEnabled = <span>new</span> MVx.Observable.Property&lt;<span>bool</span>&gt;(<span>false</span>, nameof(MessageToSendIsEnabled), args =&gt; PropertyChanged?.Invoke(<span>this</span>, args));
            _sendMessage = <span>new</span> MVx.Observable.Command();

            _connection = <span>new</span> HubConnectionBuilder()
                .WithUrl(<span>"https://unochatservice20200716114254.azurewebsites.net/ChatHub"</span>)
                .WithAutomaticReconnect()
                .Build();
        }

        <span><span>private</span> IDisposable <span>ShouldEnableConnectWhenNotConnected</span><span>()</span>
        </span>{
            <span>return</span> _state
                .Select(state =&gt; state == HubConnectionState.Disconnected)
                .ObserveOn(Schedulers.Dispatcher)
                .Subscribe(_connect);
        }

        <span><span>private</span> IDisposable <span>ShouldEnableMessageToSendWhenConnected</span><span>()</span>
        </span>{
            <span>return</span> _state
                .Select(state =&gt; state == HubConnectionState.Connected)
                .Subscribe(_messageToSendIsEnabled);
        }

        <span><span>private</span> IDisposable <span>ShouldConnectToServiceWhenConnectInvoked</span><span>()</span>
        </span>{
            <span>return</span> _connect
                .SelectMany(_ =&gt; Observable
                    .StartAsync(async () =&gt;
                    {
                        await _connection.StartAsync();
                        <span>return</span> _connection.State;
                    }))
                .ObserveOn(Schedulers.Dispatcher)
                .Subscribe(_state);
        }

        <span><span>private</span> IDisposable <span>ShouldDisconnectFromServiceWhenDisposed</span><span>()</span>
        </span>{
            <span>return</span> Disposable.Create(() =&gt; _ = _connection.StopAsync());
        }

        <span><span>private</span> IDisposable <span>ShouldListenForNewMessagesFromTheService</span><span>()</span>
        </span>{
            <span>return</span> Observable
                .Create&lt;<span>string</span>&gt;(
                    observer =&gt;
                    {
                        Action&lt;<span>string</span>, <span>string</span>&gt; onReceiveMessage =
                            (user, message) =&gt; observer.OnNext($<span>"{user}: {message}"</span>);

                        <span>return</span> _connection.On(<span>"ReceiveMessage"</span>, onReceiveMessage);
                    })
                .ObserveOn(Schedulers.Dispatcher)
                .Subscribe(_lastMessageReceived);
        }

        <span><span>private</span> IDisposable <span>ShouldAddNewMessagesToAllMessages</span><span>()</span>
        </span>{
            <span>return</span> _lastMessageReceived
                .Where(message =&gt; !<span>string</span>.IsNullOrWhiteSpace(message))
                .WithLatestFrom(_allMessages, (message, messages) =&gt; messages.Concat(message).ToArray())
                .Subscribe(_allMessages);
        }

        <span><span>private</span> IDisposable <span>ShouldEnableSendMessageWhenConnectedAndBothNameAndMessageToSendAreNotEmpty</span><span>()</span>
        </span>{
            <span>return</span> Observable
                .CombineLatest(_state, _name, _messageToSend, (state, name, message) =&gt; state == HubConnectionState.Connected &amp;&amp; !(<span>string</span>.IsNullOrWhiteSpace(name) || <span>string</span>.IsNullOrWhiteSpace(message)))
                .Subscribe(_sendMessage);
        }

        <span><span>private</span> IDisposable <span>ShouldSendMessageToServiceThenClearSentMessage</span><span>(IObservable&lt;object&gt; messageToSendBoxReturn)</span>
        </span>{
            var namedMessage = Observable
                .CombineLatest(_name, _messageToSend, (name, message) =&gt; (Name: name, Message: message));

            <span>return</span> Observable.Merge(_sendMessage, messageToSendBoxReturn)
                .WithLatestFrom(namedMessage, (_, tuple) =&gt; tuple)
                .Where(tuple =&gt; !<span>string</span>.IsNullOrEmpty(tuple.Message))
                .SelectMany(tuple =&gt; Observable
                    .StartAsync(() =&gt; _connection.InvokeAsync(<span>"SendMessage"</span>, tuple.Name, tuple.Message)))
                .Select(_ =&gt; <span>string</span>.Empty)
                .ObserveOn(Schedulers.Dispatcher)
                .Subscribe(_messageToSend);
        }

        <span><span>public</span> IDisposable <span>Activate</span><span>(IObservable&lt;object&gt; messageToSendBoxReturn)</span>
        </span>{
            <span>return</span> <span>new</span> CompositeDisposable(
                ShouldEnableConnectWhenNotConnected(),
                ShouldEnableMessageToSendWhenConnected(),
                ShouldConnectToServiceWhenConnectInvoked(),
                ShouldDisconnectFromServiceWhenDisposed(),
                ShouldListenForNewMessagesFromTheService(),
                ShouldAddNewMessagesToAllMessages(),
                ShouldEnableSendMessageWhenConnectedAndBothNameAndMessageToSendAreNotEmpty(),
                ShouldSendMessageToServiceThenClearSentMessage(messageToSendBoxReturn)
            );
        }

        <span>public</span> <span>string</span> Name
        {
            get =&gt; _name.Get();
            <span>set</span> =&gt; _name.Set(value);
        }

        <span>public</span> HubConnectionState State =&gt; _state.Get();

        <span>public</span> <span>string</span> LastMessageReceived =&gt; _lastMessageReceived.Get();

        <span>public</span> IEnumerable&lt;<span>string</span>&gt; AllMessages =&gt; _allMessages.Get();

        <span>public</span> <span>string</span> MessageToSend
        {
            get =&gt; _messageToSend.Get();
            <span>set</span> =&gt; _messageToSend.Set(value);
        }

        <span>public</span> <span>bool</span> MessageToSendIsEnabled =&gt; _messageToSendIsEnabled.Get();

        <span>public</span> ICommand Connect =&gt; _connect;

        <span>public</span> ICommand SendMessage =&gt; _sendMessage;
    }
}
</code></pre>
<p>While this code is fairly lengthy it includes a large number of behaviours such as asynchronous connection management and message handling for SignalR along with enabling and disabling controls based on the current state of the UI and/or connection. All these behaviours are separated into discrete methods allowing them to be easily modified, supplemented or removed by simply changing, adding or removing an appropriated named "ShouldXXXX" method.</p>
<h3 id="view">View</h3>
<p>With the ViewModel in place and taking care of all the fundamental logic for the application, we now need to use it from the view. In the code behind for <code>MainView.cs</code> add the following code:</p>
<pre><code><span>using</span> System;
<span>using</span> System.Reactive.Linq;
<span>using</span> Windows.UI.Xaml.Controls;
<span>using</span> Windows.UI.Xaml.Input;
<span>using</span> Windows.UI.Xaml.Navigation;



<span>namespace</span> UnoChat.Client
{
    
    
    
    <span>public</span> sealed partial <span>class</span> MainPage : Page
    {
        <span>private</span> readonly ViewModel _viewModel;
        <span>private</span> IDisposable _behaviours;

        <span><span>public</span> <span>MainPage</span><span>()</span>
        </span>{
            <span>this</span>.InitializeComponent();

            _viewModel = <span>new</span> ViewModel();
            DataContext = _viewModel;
        }

        <span><span>protected</span> override <span>void</span> <span>OnNavigatedTo</span><span>(NavigationEventArgs e)</span>
        </span>{
            base.OnNavigatedTo(e);

            var messageToSendReturn = Observable
                .FromEvent&lt;KeyEventHandler, KeyRoutedEventArgs&gt;(
                    handler =&gt; (s, k) =&gt; handler(k),
                    handler =&gt; MessageToSendTextBox.KeyUp += handler,
                    handler =&gt; MessageToSendTextBox.KeyUp -= handler)
                .Where(k =&gt; k.Key == Windows.System.VirtualKey.Enter);

            _behaviours = _viewModel.Activate(messageToSendReturn);
        }

        <span><span>protected</span> override <span>void</span> <span>OnNavigatingFrom</span><span>(NavigatingCancelEventArgs e)</span>
        </span>{
            base.OnNavigatingFrom(e);

            <span>if</span> (_behaviours != null)
            {
                _behaviours.Dispose();
                _behaviours = null;
            }
        }
    }
}
</code></pre>
<p>In this code we instantiate the ViewModel, set it as the View's <code>DataContext</code> and call it's <code>Activate</code> method when the user navigates to this view. Note how we pass an observable to the <code>Activate</code> method which will emit a value when the user hits return on the <code>MessageToSendTextBox</code>. This allows us to receive feedback from the UI without compromising View/ViewModel segregation.</p>
<p>The <code>Activate</code> method returns an <code>IDisposable</code> which, when disposed, will tear down all the associated behaviours, unsubscribe from events and release resources. Accordingly, we dispose of this <code>IDisposable</code> when the user navigates away from this view, thereby correctly managing the lifetime of the ViewModel's resources.</p>
<p>Finally, lets implement our UI by editing the <code>MainView.xaml</code> to the following:</p>
<pre><code><span>&lt;<span>Page</span>
    <span>x:Class</span>=<span>"UnoChat.Client.MainPage"</span>
    <span>xmlns</span>=<span>"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
    <span>xmlns:x</span>=<span>"http://schemas.microsoft.com/winfx/2006/xaml"</span>
    <span>xmlns:local</span>=<span>"using:UnoChat.Client"</span>
    <span>xmlns:d</span>=<span>"http://schemas.microsoft.com/expression/blend/2008"</span>
    <span>xmlns:mc</span>=<span>"http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
    <span>mc:Ignorable</span>=<span>"d"</span>&gt;</span>

    <span>&lt;<span>Grid</span> <span>Background</span>=<span>"{ThemeResource ApplicationPageBackgroundThemeBrush}"</span>&gt;</span>
        <span>&lt;<span>Grid.RowDefinitions</span>&gt;</span>
            <span>&lt;<span>RowDefinition</span> <span>Height</span>=<span>"Auto"</span>/&gt;</span>
            <span>&lt;<span>RowDefinition</span> <span>Height</span>=<span>"*"</span>/&gt;</span>
            <span>&lt;<span>RowDefinition</span> <span>Height</span>=<span>"Auto"</span>/&gt;</span>
        <span>&lt;/<span>Grid.RowDefinitions</span>&gt;</span>
        <span>&lt;<span>Grid.ColumnDefinitions</span>&gt;</span>
            <span>&lt;<span>ColumnDefinition</span> <span>Width</span>=<span>"Auto"</span>/&gt;</span>
            <span>&lt;<span>ColumnDefinition</span> <span>Width</span>=<span>"*"</span>/&gt;</span>
            <span>&lt;<span>ColumnDefinition</span> <span>Width</span>=<span>"Auto"</span>/&gt;</span>
        <span>&lt;/<span>Grid.ColumnDefinitions</span>&gt;</span>
        <span>&lt;<span>TextBlock</span> <span>Text</span>=<span>"Name:"</span> <span>Style</span>=<span>"{StaticResource BaseTextBlockStyle}"</span> <span>Grid.Row</span>=<span>"0"</span> <span>Grid.Column</span>=<span>"0"</span> <span>Margin</span>=<span>"4"</span> <span>VerticalAlignment</span>=<span>"Center"</span> /&gt;</span>
        <span>&lt;<span>TextBox</span> <span>Text</span>=<span>"{Binding Path=Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"</span> <span>Grid.Row</span>=<span>"0"</span> <span>Grid.Column</span>=<span>"1"</span> <span>Margin</span>=<span>"4"</span>/&gt;</span>
        <span>&lt;<span>Button</span> <span>Command</span>=<span>"{Binding Path=Connect}"</span> <span>Content</span>=<span>"Connect"</span> <span>Grid.Row</span>=<span>"0"</span> <span>Grid.Column</span>=<span>"2"</span> <span>Margin</span>=<span>"4"</span> <span>Padding</span>=<span>"16,4"</span> <span>HorizontalAlignment</span>=<span>"Stretch"</span>/&gt;</span>
        <span>&lt;<span>ItemsControl</span> <span>ItemsSource</span>=<span>"{Binding Path=AllMessages}"</span> <span>Grid.Row</span>=<span>"1"</span> <span>Grid.ColumnSpan</span>=<span>"3"</span> <span>Margin</span>=<span>"4"</span> /&gt;</span>
        <span>&lt;<span>TextBlock</span> <span>Text</span>=<span>"Message:"</span> <span>Style</span>=<span>"{StaticResource BaseTextBlockStyle}"</span> <span>Grid.Row</span>=<span>"2"</span> <span>Grid.Column</span>=<span>"0"</span> <span>Margin</span>=<span>"4"</span> <span>VerticalAlignment</span>=<span>"Center"</span>/&gt;</span>
        <span>&lt;<span>TextBox</span> <span>x:Name</span>=<span>"MessageToSendTextBox"</span> <span>Text</span>=<span>"{Binding Path=MessageToSend, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"</span> <span>IsEnabled</span>=<span>"{Binding Path=MessageToSendIsEnabled}"</span> <span>Grid.Row</span>=<span>"2"</span> <span>Grid.Column</span>=<span>"1"</span> <span>Margin</span>=<span>"4"</span>/&gt;</span>
        <span>&lt;<span>Button</span> <span>Command</span>=<span>"{Binding Path=SendMessage}"</span> <span>Content</span>=<span>"Send"</span> <span>Grid.Row</span>=<span>"2"</span> <span>Grid.Column</span>=<span>"2"</span> <span>Margin</span>=<span>"4"</span> <span>Padding</span>=<span>"16,4"</span> <span>HorizontalAlignment</span>=<span>"Stretch"</span>/&gt;</span>
    <span>&lt;/<span>Grid</span>&gt;</span>
<span>&lt;/<span>Page</span>&gt;</span>
</code></pre>
<p>And that's that. Let's give it a go!</p>
<h3 id="testing">Testing</h3>
<p>Set the <code>UnoChat.Client.UWP</code> project as the "Startup Project" and hit F5. After a short compilation cycle you should see the following:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatClientUWPRunningI.png" alt="UnoChat Client UWP Running - 1"></p><p>Click "Connect" and, after a short pause you should see the "Message" textbox become enabled. Enter some text in the "Message" textbox and click the "Send" button (or hit enter) and the message should be sent to SignalR. SignalR will then publish this message to all connected clients which, given we are one of the connected clients, will result in the message being sent back to us and being displayed in ItemsControl in the middle of the window as shown below:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatClientUWPRunningII.png" alt="UnoChat Client UWP Running - 2"></p><p>But having one client on one platform is no fun!</p>
<p>Lets kick off the Android head project by right clicking on it and selection <code>Debug-&gt;Start New Instance</code>. After another short compilation an Android Emulator should started and our app should be deployed to it then run. Clicking "Connect" then (after connection is complete) entering a message in the "Message" text box and hitting "Send" should result in the following:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatRunningOnUwpAndAndroid.png" alt="UnoChat Running On Uwp And Android"></p><p>Nice, two platforms for the price on one!</p>
<p>Now (and you'll need to be <a href="https://docs.microsoft.com/en-us/xamarin/ios/get-started/installation/windows/connecting-to-mac/">paired to a Mac for this</a>), right click the iOS head project and select <code>Debug-&gt;Start New Instance</code>. Once the iOS device emulator has started, follow the same steps as with with other head projects and you'll see the following:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatRunningOnUwpAndroidAndiOS.png" alt="UnoChat Running On Uwp, Android and iOS"></p><p>That's three for three.</p>
<p>Now, right click on the WASM head and select <code>Debug-&gt;Start New Instance</code>. After a short compilation you'll see a browser window appear and.... get stuck at the splash screen.</p>
<p>Booo! So close...</p>
<h3 id="getting-wasm-linked">Getting WASM Linked</h3>
<p>Opening the browser's "Developer Tools" with F12 we see this on the Console:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatWasmLinkerIssues.png" alt="UnoChat Wasm Link Issues"></p><p>Well, we've seen these "A suitable constructor ... could not be found" exceptions <a href="https://ian.bebbs.co.uk/posts/UnoWithSwagger#this-missing-links">before</a>. They're due to the assemblies containing the associated types being omitted by the Mono linker. By looking up which assemblies the various types belong to we're able to explicitly instruct the linker to include the assemblies by modifying the <code>LinkerConfig.xml</code> file in the WASM head project.</p>
<p>After a few "start -&gt; fail -&gt; find type -&gt; amend config" iterations I ended up with the following in my <code>LinkerConfig.xaml</code> file:</p>
<pre><code><span>&lt;<span>linker</span>&gt;</span>
  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"UnoChat.Client.Wasm"</span> /&gt;</span>
  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"Uno.UI"</span> /&gt;</span>

  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"Microsoft.AspnetCore.Http.Connections.Client"</span>/&gt;</span>
  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"Microsoft.Extensions.Options"</span>/&gt;</span>
  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"Microsoft.AspNetCore.SignalR.Client"</span>/&gt;</span>
  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"Microsoft.AspNetCore.SignalR.Client.Core"</span>/&gt;</span>
  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"Microsoft.AspNetCore.SignalR.Protocols.Json"</span>/&gt;</span>

  <span>&lt;<span>assembly</span> <span>fullname</span>=<span>"System.Core"</span>&gt;</span>
	
	  <span>&lt;<span>type</span> <span>fullname</span>=<span>"System.Linq.Expressions*"</span> /&gt;</span>
  <span>&lt;/<span>assembly</span>&gt;</span>
<span>&lt;/<span>linker</span>&gt;</span>
</code></pre>
<p>And, with this in place starting the WASM head resulted in:</p>
<p><img src="https://ian.bebbs.co.uk/Content/UnoChat/UnoChatWasmRunning.png" alt="UnoChat Wasm Running"></p><p>ooOOoo... exciting!! Could it be??</p>
<video controls="" autoplay="" loop="">
  <source src="/Content/UnoChat/UnoChatAllWingsCheckin.mp4" type="video/mp4">
Your browser does not support the video tag
</video>
<p>Yes, yes it could.</p>
<p>Here we have <code>UnoChat.Client.Console</code> (Red Leader), <code>UnoChat.Client.UWP</code> (Red 3), <code>UnoChat.Client.Wasm</code> (Red 6), <code>UnoChat.Client.Droid</code> (Red 5) and <code>UnoChat.Client.iOS</code> (Red Buttons) all connected to the SignalR service and all receiving real-time updates.</p>
<p>Nice.</p>
<h2 id="conclusion">Conclusion</h2>
<p>And there we go. In about an hour (hey I stopped for lunch) we have an app which is capable of receiving real-time updates and which runs on pretty much every OS - either natively or through the browser. Moreover, the code to deliver this somewhat epic feat is short, concise, maintainable and - most importantly - 99% shared amongst the various project heads.</p>
<p>The Uno platform really has matured amazingly well since I first blogged about it as part of last December's <a href="https://ian.bebbs.co.uk/posts/Uno">Third Annual C# Advent</a>. Back then I found that it worked... mostly... but not all the head projects functioned correctly and it required a whole host of kludges to get them all running from a shared codebase. Just over seven months later and the change is incredible: You now have an expectation of things working "out-of-the-box" and any minor difference/issue on a given platform to be an easy work around.</p>
<p>I can't wait to see what the Uno Platform has in store for us at <a href="https://platform.uno/blog/unoconf-2020-virtual-free-aug-12-2020-save-the-date/">UnoConf 2020</a> (personally I'm hoping for Uno on Linux and - most importantly - Raspberry Pis). Hope to see you all there on August 12th!</p>
<h2 id="lastly">Lastly...</h2>
<p>If you're interested in using the Uno Platform to deliver cross-platform apps or have an upcoming project for which you'd like evaluate Uno Platform's fit, then please feel free to drop me a line to discuss your project/ideas using any of the links below or from my <a href="https://ian.bebbs.co.uk/about">about page</a>. As a freelance software developer and remote contractor I'm always interested in hearing from potential new clients or about potential new collaborations.</p>



                                </div>
                        </div>
                </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>