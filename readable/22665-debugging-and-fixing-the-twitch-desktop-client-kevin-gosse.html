<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Debugging and fixing the Twitch desktop client - Kevin Gosse -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Debugging and fixing the Twitch desktop client - Kevin Gosse</h1><div><div class="ac ae af ag ah cz aj ak"><p id="5db2" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">Maybe I actually forgot to copy the file? Checking the modification date, the file was a few weeks old… Silly me!</p><p id="540c" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">Making extra sure to copy the right assembly this time, I tried again and… same result. Re-checking the file modification date, I noted it was back to a few weeks ago. Clearly, the application was overwriting it at startup, probably because of the auto-update feature. How to prevent that? I could find the auto-update code and patch it, but I decided it would be simpler to just remove the write permissions from the file. By chance, the auto-updater logged an error when failing to replace the file but wouldn’t prevent the application from starting.</p><p id="8323" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">After starting the application with the assembly properly patched, the aforementioned exception was gone. But the “Mods” page still wouldn’t load. I found other exceptions in the logs, more patching to do?</p><p id="11f6" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">After fixing two more of those exceptions and still seeing no change with the bug, I decided to take a step back. It looked like all those exceptions were caused by uninitialized variables and were just the consequence of using the default settings in the app. They were logged but properly handled in the code, so I probably was on the wrong track.</p><h1 id="ae59" class="ga gb dc bk bj gc de gd dg ge gf gg gh gi gj gk gl">Following a new lead: IPC</h1><p id="6941" class="fm fn dc bk fo b fp gm fr gn ft go fv gp fx gq fz cu">I decided to spend more time analyzing the logs of TwitchAgent, this time ignoring the exceptions. After a while, I noticed this sequence of events:</p><pre class="hb hc hd he hf ii ij ik"><span id="eaf5" class="il gb dc bk ig b eg im in r io">Connecting to IPC via pipe Twitch-App-Pipe-21572<br>Attempting Desktop Service connection.<br>Service connection timed out!<br>Attempting to reconnect. 2 attempts remaining<br>Attempting Desktop Service connection.<br>Service connection timed out!<br>Attempting to reconnect. 1 attempts remaining<br>Attempting Desktop Service connection.<br>Service connection timed out!<br>No connection retries remaining; performing safe shutdown.</span></pre><p id="6fd4" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">This seemed to match the logs I saw on TwitchUI! It seemed that the inter-process communication was failing for some reason. I suspected earlier that the application was using named pipes, so I started by confirming that in Process Explorer:</p><figure class="hb hc hd he hf gr cl cm paragraph-image"><p id="8a8e" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">Sure enough, there was a named pipe with the naming pattern seen in the logs. Maybe a permission issue? I tried launching the app with administrator rights, but it didn’t change anything. I also cross-checked the logs of the two processes to make sure they were using the same name to connect to the pipe.</p><p id="dfb5" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">I decided to check the code in TwitchAgent responsible for connecting to the pipe to see if I could find an obvious mistake. Unfortunately, the inter-process communication was handled by a native library, TwitchIPC.dll, and decompiling native code is outside of my skill set. Instead, I tried to write two custom console applications that communicated using that library… and it worked perfectly. So the issue wasn’t the library itself, but how the Twitch desktop app was using it. While writing my custom console application, I discovered that the TwitchIPC library had an integrated logger that could be activated by the caller. Seeing this, I decided to patch the TwitchAgent to enable those logs, the same way I did when fixing the exceptions. This allowed me to get the following logs:</p><pre class="hb hc hd he hf ii ij ik"><span id="c51a" class="il gb dc bk ig b eg im in r io">9:44:10 PM: Creating server for pipe Twitch-App-Pipe-16688<br>9:44:10 PM: Twitch-App-Pipe-16688: starting connection.<br>9:44:10 PM: Twitch-App-Pipe-16688: starting with endpoint: \\.\pipe\Twitch-App-Pipe-16688–0<br>9:44:10 PM: Twitch-App-Pipe-16688: started successfully<br>9:44:10 PM: Twitch-App-Pipe-16688: connecting to endpoint \\.\pipe\Twitch-App-Pipe-16688–1<br>9:44:10 PM: Twitch-App-Pipe-16688: connection finished with status: connectFailed<br>9:44:10 PM: Twitch-App-Pipe-16688: remote does not exist yet. waiting for incomming connection.<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:11 PM: Twitch-App-Pipe-16688: sending message of length: 218<br>9:44:11 PM: Twitch-App-Pipe-16688: sending message of length: 129<br>9:44:11 PM: Twitch-App-Pipe-16688: sending message of length: 116<br>9:44:13 PM: Twitch-App-Pipe-16688: disconnecting<br>9:44:13 PM: Twitch-App-Pipe-16688: shutting down</span></pre><p id="5831" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">What surprised me was how the agent was trying to send data (<em class="ih">sending message of length: 138</em>) even though the connection wasn’t properly established (<em class="ih">remote does not exist yet. waiting for incoming connection</em>). Maybe there was no buffering in TwitchIPC.dll, and TwitchAgent would send all the data before TwitchUI was ready to receive it? To test this hypothesis, I patched TwitchAgent once more, adding a semaphore to prevent the process from sending the data before the communication was established. But even so, the bug was still there! The logs would stop at <code class="hs id ie if ig b">remote does not exist yet. waiting for incoming connection</code>, and nothing more would happen. An unexpected side-effect of my semaphore was that it also prevented the process from auto-exiting, since the main thread was blocked on my lock. I used that opportunity to connect my custom console app to the named pipe… And I instantly received all the data! This meant that TwitchAgent was in fact working properly, the issue was on TwitchUI side.</p><h1 id="099d" class="ga gb dc bk bj gc de gd dg ge gf gg gh gi gj gk gl">Investigating TwitchUI</h1><p id="35ed" class="fm fn dc bk fo b fp gm fr gn ft go fv gp fx gq fz cu">From that point, I started digging further in the logs of the TwitchUI process. Another interesting side-effect of my semaphore was helping me to see the moment when TwitchAgent tried to establish the connection: if the CPU usage of the process fell to 0%, it meant that the process was waiting on the lock. Thanks to this, and by watching closely the sequence of logs from TwitchUI during the startup of the application, I finally noticed something peculiar: the TwitchUI process would log <code class="hs id ie if ig b">Reached attempt limit for process restarts; try to restart or reinstall</code><strong class="fo iz"><em class="ih">before</em></strong>TwitchAgent established the connection! I double-checked with the timestamps in the logs to confirm and indeed: TwitchAgent took about 20 seconds to start, but TwitchUI would make 3 connection attempts of 3 seconds each, giving up after 9 seconds in total. The bug was probably that TwitchAgent took longer to start after the update, but the developers didn’t think of adjusting the timeout on TwitchUI side. It also explained the randomness of the workarounds found on the forums, since it was a timing issue.</p><h1 id="0e16" class="ga gb dc bk bj gc de gd dg ge gf gg gh gi gj gk gl">One final step left</h1><p id="890e" class="fm fn dc bk fo b fp gm fr gn ft go fv gp fx gq fz cu">Finding the issue is great, but we still need to fix it. Given that I already had patched a few assemblies used by TwitchAgent, I was confident that I could do the same thing with TwitchUI to adjust the timeout. That’s when I discovered that TwitchUI was an <a href="https://electronjs.org/" class="at cg ip iq ir is" target="_blank" rel="noopener nofollow">Electron</a> app. DotPeek wouldn’t help me with that one.</p><p id="0825" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">Fortunately, by searching “decompile electron app” on Google, I quickly found <a class="at cg ip iq ir is" target="_blank" rel="noopener" href="/how-to-electron/how-to-get-source-code-of-any-electron-application-cbb5c7726c37">this article</a> that explained everything I needed to know. It was easy to decompile TwitchUI (or really more “unpack”, since an Electron app is just a Chromium frame running a web page) using a tool named “asar”. Using it, I was able to extract the Javascript code that ran in the process. It was minified, but after pasting it <a href="https://beautifier.io/" class="at cg ip iq ir is" target="_blank" rel="noopener nofollow">in a beautifier</a> and looking for the <code class="hs id ie if ig b">IPC Connection timed out</code> message I saw in the logs, I was able to find this code:</p><figure class="hb hc hd he hf gr"><p id="ba38" class="fm fn dc bk fo b fp fq fr fs ft fu fv fw fx fy fz cu">That confirmed the 3 seconds timeout I noticed in the logs. After changing the value to 60 seconds and re-launching the app, the bug was gone!</p></figure></figure></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>