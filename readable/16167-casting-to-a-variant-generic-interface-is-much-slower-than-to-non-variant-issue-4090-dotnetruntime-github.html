<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Casting to a variant generic interface is much slower than to non-variant &#xB7; Issue #4090 &#xB7; dotnet/runtime &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Casting to a variant generic interface is much slower than to non-variant · Issue #4090 · dotnet/runtime · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>I stumbled into this myself recently and did some investigation. Here are the details I provided on dotnet/coreclr#11094 that relate to this issue.</p><h1>Results Summary</h1><p>Using BenchmarkDotNet I've found that covariant and contravariant casting is approximately:</p><ul><li>200x slower than regular casting on .NET Framework.</li><li>60x slower than regular casting on .NET Core.</li><li>33x slower than generic casting on .NET Framework.</li><li>17x slower than generic casting on .NET Core.</li></ul><p>The code to reproduce these experiments and my investigation is found in this <a href="https://www.danielcrabtree.com/blog/191/casting-to-ienumerable-t-is-two-orders-of-magnitude-slower" rel="nofollow">blog post</a>.</p><p>Using BenchmarkDotNet I've found that covariant and contravariant casting + method call is approximately:</p><ul><li>3.25x slower than dynamic cast + method call on .NET Framework.</li><li>2.75x slower than dynamic cast + method call on .NET Core.</li></ul><p>The code to reproduce these experiments and my investigation is found in <a href="https://www.danielcrabtree.com/blog/214/covariant-and-contravariant-casting-is-3x-slower-than-dynamic" rel="nofollow">another blog post</a>. Note: these results exclude the first call to dynamic, which is ~1200x slower than the first call using covariant and contravariant casting.</p><p>Also, see the comments on my blog posts where readers have reproduced these results and conducted their own insightful experiments that lead to my findings.</p><h1>Test Environment and Raw .NET Core Results</h1><p>Please note that my blog posts only include the results from .NET Framework on 64bit RyuJIT. The results above are from .NET Framework on 64bit RyuJIT and .NET Core on 64bit RyuJIT. I have also run tests on .NET Framework on 32bit LegacyJIT and while there are absolute performance differences, the results are on the same order of magnitude as those presented above.</p><p>Here are the test environments as reported by BenchmarkDotNet for the results presented on my blog posts:</p><div class="highlight highlight-source-ini"><pre><span class="pl-k">BenchmarkDotNet</span>=v0.10.3.0, <span class="pl-k">OS</span>=Microsoft Windows NT 6.2.9200.0
<span class="pl-k">Processor</span>=Intel(R) Core(TM) i7 CPU 970 3.20GHz, <span class="pl-k">ProcessorCount</span>=12
<span class="pl-k">Frequency</span>=3128907 Hz, <span class="pl-k">Resolution</span>=319.6004 ns, <span class="pl-k">Timer</span>=TSC
  [Host]     : Clr 4.0.30319.42000, 64bit RyuJIT-v4.6.1637.0
  DefaultJob : Clr 4.0.30319.42000, 64bit RyuJIT-v4.6.1637.0

<span class="pl-k">BenchmarkDotNet</span>=v0.10.3.0, <span class="pl-k">OS</span>=Microsoft Windows NT 6.2.9200.0
<span class="pl-k">Processor</span>=Intel(R) Core(TM) i7 CPU 970 3.20GHz, <span class="pl-k">ProcessorCount</span>=12
<span class="pl-k">Frequency</span>=3128910 Hz, <span class="pl-k">Resolution</span>=319.6001 ns, <span class="pl-k">Timer</span>=TSC
  [Host]     : Clr 4.0.30319.42000, 32bit LegacyJIT-v4.6.1637.0
  DefaultJob : Clr 4.0.30319.42000, 32bit LegacyJIT-v4.6.1637.0</pre></div><p>Here are the results for .NET Core that are not on my blog post and the .NET Core test environment (the target framework is set to .NETCoreApp 1.1):</p><div class="highlight highlight-source-ini"><pre><span class="pl-k">BenchmarkDotNet</span>=v0.10.3.0, <span class="pl-k">OS</span>=Microsoft Windows 10.0.14393
<span class="pl-k">Processor</span>=Intel(R) Core(TM) i7 CPU 970 3.20GHz, <span class="pl-k">ProcessorCount</span>=12
<span class="pl-k">Frequency</span>=3128910 Hz, <span class="pl-k">Resolution</span>=319.6001 ns, <span class="pl-k">Timer</span>=TSC
dotnet cli <span class="pl-k">version</span>=1.0.3
  [Host]     : .NET Core 4.6.25009.03, 64bit RyuJIT
  DefaultJob : .NET Core 4.6.25009.03, 64bit RyuJIT

Casting Results:
==================================================
             Method |       Mean |    StdDev | Scaled | Scaled-StdDev |
------------------- |----------- |---------- |------- |-------------- |
         ObjectCast |  0.4848 ns | 0.0008 ns |   0.42 |          0.00 |
 ImplementationCast |  1.1616 ns | 0.0006 ns |   1.00 |          0.00 |
      InterfaceCast |  2.8750 ns | 0.0049 ns |   2.48 |          0.00 |
        GenericCast |  4.0288 ns | 0.0090 ns |   3.47 |          0.01 |
      CovariantCast | 70.5734 ns | 0.0317 ns |  60.76 |          0.04 |
  ContravariantCast | 71.1789 ns | 0.0116 ns |  61.28 |          0.03 |

Covariant Casting + Method Call Results:
==================================================
 |   Method |       Mean |    StdDev |     Median | Scaled | Scaled-StdDev |
 |--------- |----------- |---------- |----------- |------- |-------------- |
 |   Direct | 18.4310 ns | 0.1172 ns | 18.3872 ns |   1.00 |          0.00 |
 | Implicit | 18.3568 ns | 0.1045 ns | 18.2858 ns |   1.00 |          0.01 |
 | Explicit | 84.4047 ns | 0.2345 ns | 84.4041 ns |   4.58 |          0.03 |
 |  Dynamic | 30.6939 ns | 0.0023 ns | 30.6943 ns |   1.67 |          0.01 |

Contravariant Casting + Method Call Results:
==================================================
 |   Method |       Mean |    StdDev | Scaled | Scaled-StdDev |
 |--------- |----------- |---------- |------- |-------------- |
 |   Direct | 17.7818 ns | 0.0041 ns |   1.00 |          0.00 |
 | Implicit | 17.7725 ns | 0.0047 ns |   1.00 |          0.00 |
 | Explicit | 83.4591 ns | 0.0097 ns |   4.69 |          0.00 |
 |  Dynamic | 28.2057 ns | 0.0670 ns |   1.59 |          0.00 |</pre></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>