<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Reducing log verbosity with Serilog RequestLogging: Using Serilog.AspNetCore in ASP.NET Core 3.0 - Part 1 -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Reducing log verbosity with Serilog RequestLogging: Using Serilog.AspNetCore in ASP.NET Core 3.0 - Part 1</h1>
    <div class="post-content">
<p>One of the great aspects of ASP.NET Core is that logging is built-in to the framework. That means you can (if you want to) get access to all the deep infrastructural logs from your own standard logging infrastructure. The down side to this is that sometimes you can get <em>too many</em> logs. </p>
<p>In this short series I describe how to use <a href="https://github.com/serilog/serilog-aspnetcore#request-logging">Serilog&apos;s ASP.NET Core request logging feature</a>. In this first post I describe how to add the the Serilog <code>RequestLoggingMiddleware</code> to your application, and the benefits it provides. In subsequent posts I&apos;ll describe how to customise the behaviour further.</p>
<blockquote>
<p>I&apos;ve had these posts in draft for a while. Since then, <a href="https://nblumhardt.com/2019/10/serilog-in-aspnetcore-3">Nicholas Blumhardt, creator of Serilog, has written a comprehensive blog post on using Serilog with ASP.NET Core 3.0</a>. It&apos;s a very detailed (and opinionated) piece, that I strongly recommend reading. You&apos;ll find most of what I talk about in this series in his post, so check it out!</p>
</blockquote> <p>For this post we&apos;ll start with a basic ASP.NET Core 3.0 Razor pages app, created using <code>dotnet new webapp</code>. This creates a standard <em>Program.cs</em> that look like this:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IHostBuilder</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> webBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token punctuation">&lt;</span><span class="token class-name">Startup</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And a <em>Startup.cs</em> that configures the middleware pipeline in <code>Configure</code> as the following:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> <span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span><span class="token string">&quot;/Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseHsts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> endpoints<span class="token punctuation">.</span><span class="token function">MapRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>If you run the application and navigate to the home page, by default you&apos;ll see a number of logs in the Console for each request. The logs below are generated for a <em>single</em> request to the home page (there are additional requests for CSS and JS files after this that I&apos;ve not included):</p>
<pre class="language-bash"><code class="language-bash">info: Microsoft.AspNetCore.Hosting.Diagnostics<span class="token punctuation">[</span>1<span class="token punctuation">]</span> Request starting HTTP/2 GET https://localhost:5001/
info: Microsoft.AspNetCore.Routing.EndpointMiddleware<span class="token punctuation">[</span>0<span class="token punctuation">]</span> Executing endpoint <span class="token string">&apos;/Index&apos;</span>
info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker<span class="token punctuation">[</span>3<span class="token punctuation">]</span> Route matched with <span class="token punctuation">{</span>page <span class="token operator">=</span> <span class="token string">&quot;/Index&quot;</span><span class="token punctuation">}</span>. Executing page /Index
info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker<span class="token punctuation">[</span>101<span class="token punctuation">]</span> Executing handler method SerilogRequestLogging.Pages.IndexModel.OnGet - ModelState is Valid
info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker<span class="token punctuation">[</span>102<span class="token punctuation">]</span> Executed handler method OnGet, returned result <span class="token keyword">.</span>
info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker<span class="token punctuation">[</span>103<span class="token punctuation">]</span> Executing an implicit handler method - ModelState is Valid
info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker<span class="token punctuation">[</span>104<span class="token punctuation">]</span> Executed an implicit handler method, returned result Microsoft.AspNetCore.Mvc.RazorPages.PageResult.
info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker<span class="token punctuation">[</span>4<span class="token punctuation">]</span> Executed page /Index <span class="token keyword">in</span> 221.07510000000002ms
info: Microsoft.AspNetCore.Routing.EndpointMiddleware<span class="token punctuation">[</span>1<span class="token punctuation">]</span> Executed endpoint <span class="token string">&apos;/Index&apos;</span>
info: Microsoft.AspNetCore.Hosting.Diagnostics<span class="token punctuation">[</span>2<span class="token punctuation">]</span> Request finished <span class="token keyword">in</span> 430.9383ms 200 text/html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8
</code></pre>
<p>That&apos;s <strong>10</strong> logs for a single request. Now, to be clear, this was running in the <code>Development</code> environment, which by default logs everything in the <em>Microsoft</em> namespace of level &quot;Information&quot; or above. If we switch to the <code>Production</code> environment, the default template filters the logs to &quot;Warning&quot; for the <em>Microsoft</em> namespace. Navigating to the default home page now generates the following logs:</p>
<pre class="language-bash"><code class="language-bash">
</code></pre>
<p>That&apos;s right, no logs at all! All of the logs generated in the previous run are in the <em>Microsoft</em> namespaces, and are &quot;Information&quot; level, so they&apos;re <em>all</em> filtered out. Personally I feel like that&apos;s a bit heavy handed. It would be nice if the production version logged <em>something</em>, for correlation with other logs if nothing else. </p>
<p>One possible solution is to customise the filters applied to each namespace. For example, you could limit the <em>Microsoft.AspNetCore.Mvc.RazorPages</em> namespace to &quot;Warning&quot;, while leaving the more general <em>Microsoft</em> namespace as &quot;Information&quot;. Now you get a reduced set of logs:</p>
<pre class="language-bash"><code class="language-bash">info: Microsoft.AspNetCore.Hosting.Diagnostics<span class="token punctuation">[</span>1<span class="token punctuation">]</span> Request starting HTTP/2 GET https://localhost:5001/
info: Microsoft.AspNetCore.Routing.EndpointMiddleware<span class="token punctuation">[</span>0<span class="token punctuation">]</span> Executing endpoint <span class="token string">&apos;/Index&apos;</span>
info: Microsoft.AspNetCore.Routing.EndpointMiddleware<span class="token punctuation">[</span>1<span class="token punctuation">]</span> Executed endpoint <span class="token string">&apos;/Index&apos;</span>
info: Microsoft.AspNetCore.Hosting.Diagnostics<span class="token punctuation">[</span>2<span class="token punctuation">]</span> Request finished <span class="token keyword">in</span> 184.788ms 200 text/html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8
</code></pre>
<p>These logs have some useful information in them - the URL, HTTP method, timing information, endpoint etc. - and there&apos;s not <em>too</em> much redundancy. But it&apos;s still slightly annoying they&apos;re four separate log messages. </p>
<p>This is the issue Serilog&apos;s <code>RequestLoggingMiddleware</code> aims to deal with - instead of creating separate logs for each step in the request, create a single &quot;Summary&quot; log message containing all the pertinent information.</p> <p>The one dependency for using Serilog&apos;s <code>RequestLoggingMiddleware</code> is that you&apos;re using Serilog! In this section I&apos;ll describe the basics for adding Serilog to your ASP.NET Core app. If you already have Serilog installed, skip to the next section.</p>
<p>I described <a href="/adding-serilog-to-the-asp-net-core-generic-host/">how to add Serilog to a generic host application over a year ago</a>, and with ASP.NET Core now <a href="/ihostingenvironment-vs-ihost-environment-obsolete-types-in-net-core-3/#asp-net-core-merges-with-the-generic-host">re-platformed on top of the generic host infrastructure</a> the setup for ASP.NET Core 3.0 is <em>very</em> similar. The approach described in this post follows the suggestions + advice of the <a href="https://github.com/serilog/serilog-aspnetcore">Serilog.AspNetCore GitHub repository</a> (and the advice from <a href="https://nblumhardt.com/2019/10/serilog-in-aspnetcore-3">Nicholas Blumhardt&apos;s post too</a>).</p>
<p>Start by installing the <em>Serilog.AspNetCore</em> NuGet package, plus the Console and <a href="https://datalust.co/seq">Seq</a> Sinks, so that we can view the logs. You can do this from the command line by running:</p>
<pre class="language-bash"><code class="language-bash">dotnet add package Serilog.AspNetCore
dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.Sinks.Seq
</code></pre>
<p>Now it&apos;s time to replace the default logging with Serilog. There&apos;s a number of ways you can do this, but the suggested approach is to configure your logger in <code>Program.Main</code> <em>before you do anything else</em>. This goes against the approach used by ASP.NET Core in general, but is the approach suggested for Serilog. The result is that your <em>Program.cs</em> file becomes rather longer:</p>
<pre class="language-csharp"><code class="language-csharp">
<span class="token keyword">using</span> Serilog<span class="token punctuation">;</span>
<span class="token keyword">using</span> Serilog<span class="token punctuation">.</span>Events<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Override</span><span class="token punctuation">(</span><span class="token string">&quot;Microsoft&quot;</span><span class="token punctuation">,</span> LogEventLevel<span class="token punctuation">.</span>Information<span class="token punctuation">)</span> <span class="token punctuation">.</span>Enrich<span class="token punctuation">.</span><span class="token function">FromLogContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Seq</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:5341&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">try</span> <span class="token punctuation">{</span> Log<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token string">&quot;Starting host&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span> Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">&quot;Host terminated unexpectedly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span> Log<span class="token punctuation">.</span><span class="token function">CloseAndFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IHostBuilder</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">UseSerilog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> webBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token punctuation">&lt;</span><span class="token class-name">Startup</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>While more complex, this setup ensures that you will still get logs if your <em>appsettings.json</em> file is formatted incorrectly, or configuration files are missing, for example. If you run your application now you&apos;ll see the same 10 logs we did originally, just formatted slightly differently:</p>
<pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Request starting HTTP/2 GET https://localhost:5001/ <span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Executing endpoint <span class="token string">&apos;/Index&apos;</span>
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Route matched with <span class="token punctuation">{</span>page <span class="token operator">=</span> <span class="token string">&quot;/Index&quot;</span><span class="token punctuation">}</span>. Executing page /Index
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Executing handler method SerilogRequestLogging.Pages.IndexModel.OnGet - ModelState is Valid
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Executed handler method OnGet, returned result <span class="token keyword">.</span>
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Executing an implicit handler method - ModelState is Valid
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Executed an implicit handler method, returned result Microsoft.AspNetCore.Mvc.RazorPages.PageResult.
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Executed page /Index <span class="token keyword">in</span> 168.28470000000002ms
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Executed endpoint <span class="token string">&apos;/Index&apos;</span>
<span class="token punctuation">[</span>13:30:27 INF<span class="token punctuation">]</span> Request finished <span class="token keyword">in</span> 297.0663ms 200 text/html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8
</code></pre>
<p>We seem to have taken 2 steps forward and one step back here. Our logging configuration is more robust now by configuring it earlier in the application lifecycle, but we haven&apos;t actually solved the problem we set out to yet. To do that we&apos;ll add the <code>RequestLoggingMiddleware</code>.</p> <p>The <code>RequestLoggingMiddleware</code> is included in the <em>Serilog.AspNetCore</em> package and can be used to add a single &quot;summary&quot; log message for each request. If you&apos;ve already gone through the steps in the previous section, adding the middleware is simple. In your <code>Startup</code> class, call <code>UseSerilogRequestLogging()</code> at the point where you would like to record the logs:</p>
<pre class="language-csharp"><code class="language-csharp">
<span class="token keyword">using</span> Serilog<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> <span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{</span> app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseSerilogRequestLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> endpoints<span class="token punctuation">.</span><span class="token function">MapRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>As always with the ASP.NET Core middleware pipeline, <strong>order is important</strong>. When a request reaches the <code>RequestLoggingMiddleware</code> the middleware starts a timer, and passes the request on for handling by subsequent middleware. When a later middleware eventually generates a response (or throws an exception), the response passes <em>back</em> through the middleware pipeline to the request logger, which records the result and writes a summary log message. </p>
<p>Serilog can only log requests that reach the middleware. In the example above, I&apos;ve added the <code>RequestLoggingMiddleware</code> <em>after</em> the <code>StaticFilesMiddleware</code>. Requests that are handled by <code>UseStaticFiles</code> will short-circuit the pipeline, and won&apos;t be logged. Given the static files middleware is quite noisy that will often be the desired behaviour, but if you wish to log requests for static files too, you can move the serilog middleware earlier in the pipeline.</p>
<p>If we run the application one more time, you&apos;ll still see the original 10 log messages, but you&apos;ll see an <em>additional</em> log message from the Serilog <code>RequestLoggingMiddleware</code>, the penultimate message:</p>
<pre class="language-bash"><code class="language-bash">
<span class="token punctuation">[</span>14:15:44 INF<span class="token punctuation">]</span> Request starting HTTP/2 GET https://localhost:5001/ <span class="token punctuation">[</span>14:15:44 INF<span class="token punctuation">]</span> Executing endpoint <span class="token string">&apos;/Index&apos;</span>
<span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Route matched with <span class="token punctuation">{</span>page <span class="token operator">=</span> <span class="token string">&quot;/Index&quot;</span><span class="token punctuation">}</span>. Executing page /Index
<span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Executing handler method SerilogRequestLogging.Pages.IndexModel.OnGet - ModelState is Valid
<span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Executed handler method OnGet, returned result <span class="token keyword">.</span>
<span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Executing an implicit handler method - ModelState is Valid
<span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Executed an implicit handler method, returned result Microsoft.AspNetCore.Mvc.RazorPages.PageResult.
<span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Executed page /Index <span class="token keyword">in</span> 124.7462ms
<span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Executed endpoint <span class="token string">&apos;/Index&apos;</span> <span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> HTTP GET / responded 200 <span class="token keyword">in</span> 249.6985 ms <span class="token punctuation">[</span>14:15:45 INF<span class="token punctuation">]</span> Request finished <span class="token keyword">in</span> 274.283ms 200 text/html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8
</code></pre>
<p>There&apos;s a couple of things to note about this log:</p>
<ul>
<li>It includes most of the pertinent information you&apos;d want in a single message - HTTP method, URL Path, Status Code, duration.</li>
<li>The duration shown is <em>slightly</em> shorter than the value logged by Kestrel on the subsequent message. That&apos;s to be expected, as Serilog only starts timing when the request reaches its middleware, and stops timing when it returns (after generating a response).</li>
<li>In both cases, additional values are logged when you use structural logging. For example, the RequestId and SpanId (<a href="https://devblogs.microsoft.com/aspnet/improvements-in-net-core-3-0-for-troubleshooting-and-monitoring-distributed-apps/">used for tracing capabilities</a>) are logged as they are part of the logging scope. You can see this in the following image of the request logged to seq.</li>
<li>We do lose some information by default. For example, the endpoint name and Razor page handler are no longer logged. In subsequent posts I&apos;ll show how to add these to the summary log.</li>
</ul>
<p><img src="/content/images/2019/seq_request_logging.png" alt="RequestLoggingMiddleware logs to Seq showing structured logging includes additional properties"></p>
<p>All that remains to finish tidying things up is to filter out the Information-level log messages we&apos;re currently logging. Update your Serilog configuration in <em>Program.cs</em> to add the extra filter:</p>
<pre class="language-csharp"><code class="language-csharp">Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Override</span><span class="token punctuation">(</span><span class="token string">&quot;Microsoft&quot;</span><span class="token punctuation">,</span> LogEventLevel<span class="token punctuation">.</span>Information<span class="token punctuation">)</span> <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Override</span><span class="token punctuation">(</span><span class="token string">&quot;Microsoft.AspNetCore&quot;</span><span class="token punctuation">,</span> LogEventLevel<span class="token punctuation">.</span>Warning<span class="token punctuation">)</span> <span class="token punctuation">.</span>Enrich<span class="token punctuation">.</span><span class="token function">FromLogContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Seq</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:5341&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>With this final change, you&apos;ll now get a clean set of request logs containing summary data for each request:</p>
<pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>14:29:53 INF<span class="token punctuation">]</span> HTTP GET / responded 200 <span class="token keyword">in</span> 129.9509 ms
<span class="token punctuation">[</span>14:29:56 INF<span class="token punctuation">]</span> HTTP GET /Privacy responded 200 <span class="token keyword">in</span> 10.0724 ms
<span class="token punctuation">[</span>14:29:57 INF<span class="token punctuation">]</span> HTTP GET / responded 200 <span class="token keyword">in</span> 3.3341 ms
<span class="token punctuation">[</span>14:30:54 INF<span class="token punctuation">]</span> HTTP GET /Missing responded 404 <span class="token keyword">in</span> 16.7119 ms
</code></pre>
<p>In the next post I&apos;ll look at how we can enhance this log by recording additional data.</p> <p>In this post I described how you can use <em>Serilog.AspNetCore</em>&apos;s request logging middleware to reduce the number of logs generated for each ASP.NET Core request, while still recording summary data. If you&apos;re already using Serilog, this is very easy to enable. Simply call <code>UseSerilogRequestLogging()</code> in your <em>Startup.cs</em> file. </p>
<p>When a request reaches this middleware it will start a timer. When subsequent middleware generates a response (or throws an exception) the response passes back through the request logger, which records the result and writes a summary log message. </p>
<p>After adding the request logging middleware you can filter out more of the infrastructural logs generated by default in ASP.NET Core 3.0, without losing useful information.</p>
</div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>