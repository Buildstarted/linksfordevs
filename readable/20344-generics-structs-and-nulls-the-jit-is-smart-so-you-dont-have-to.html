<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Generics, structs and nulls &#x2013; the JIT is smart so you don&#x2019;t have to -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Generics, structs and nulls – the JIT is smart so you don’t have to</h1><div><div id="" class=""><h3>Generics, structs and nulls – the JIT is smart so you don’t have to <a href="/id/233783" rel="bookmark nofollow" title="Permalink"><span class="fa fa-link" aria-label="Permalink"></span></a></h3><p class="meta"><span class="fa fa-calendar" aria-label="Published"></span> 7 May 2019
	<span class="divider"></span><span class="fa fa-tags" aria-label="Tags"></span> .NET Core, JIT, RyuJIT
</p><p>Few days back I learned geeky little piece about JIT. This is exactly the type of knowledge you don’t have to use, maybe ever, yet it’s crucial the JIT handles it (so you don’t have to), because every smart instruction is performance gained. Literally, every instruction or every CPU cycle counts.</p><p>Let’s start with this piece fairly normal, minus the dummy return values, code in a generic class (C# 7.x).</p><pre><code class="language-csharp">class MyGeneric&lt;T&gt;
{
	T _instance;

	public MyGeneric(T instance)
	{
		_instance = instance;
	}

	public string Do()
	{
		if (_instance == null)
		{
			return "null";
		}
		return "foobar";
	}
}
</code></pre><p>If you’re here and still remember the title of this post you can probably see where this is going. When the <code>MyGeneric&lt;T&gt;</code> would be instantiated with <code>T</code> being a value type, the <code>null</code> check completely useless and always false. Because value type can’t be null. That means the whole <code>if</code> condition can be skipped and also the code in the <code>if</code> can be skipped. Not only skipped, even not generated at all. That would help not only memory usage, but also instruction cache, branch predictor, etc.</p><p>As you undoubtedly guessed, the JIT is doing that. Trying the fully optimized build, without (initially) debugger attached, with <code>MyGeneric&lt;DateTime&gt;</code> and <code>MyGeneric&lt;object&gt;</code> gives these assembly instructions (.NET Core 2.2.4, 64bit RyuJIT).</p><pre><code class="language-asm">00007FFA256115C0  movsx       rax,byte ptr [rcx]  
00007FFA256115C4  mov         rax,21739033068h  
00007FFA256115CE  mov         rax,qword ptr [rax]  
00007FFA256115D1  ret  
</code></pre><pre><code class="language-asm">00007FFA256115F0  cmp         qword ptr [rcx+8],0  
00007FFA256115F5  jne         00007FFA25611605  
00007FFA256115F7  mov         rax,21739033070h  
00007FFA25611601  mov         rax,qword ptr [rax]  
00007FFA25611604  ret  
00007FFA25611605  mov         rax,21739033068h  
00007FFA2561160F  mov         rax,qword ptr [rax]  
00007FFA25611612  ret
</code></pre><p>The second assembly clearly has the <code>if</code> (<code>cmp</code> and <code>jne</code>) logic compared to the first one that does not. Less instructions: ✓; less branching: ✓. All this is done conveniently for you. You don’t have to think about it (unless you’re actually part of the JIT team, of course) yet the code is “optimal”.</p><p>Plus, few of us can geek about it. Happy geeking.</p></div><div id="" class=""><p class="bio"><a href="/about"><img src="/assets/bio_image.png" alt="Profile Picture"></a>
		Jiří Činčura is an independent developer focusing on data and business layers, language constructs, parallelism and databases. Specifically Entity Framework, asynchronous and parallel programming, cloud and Azure. He's Microsoft Most Valuable Professional and you can read his articles, guides, tips and tricks at www.tabsoverspaces.com.
	</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>