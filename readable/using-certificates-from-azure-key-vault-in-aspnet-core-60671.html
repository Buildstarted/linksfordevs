<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using Certificates from Azure Key Vault in ASP.NET Core - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Using Certificates from Azure Key Vault in ASP.NET Core - linksfor.dev(s)"/>
    <meta property="article:author" content="April 9, 2020 &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;by damienbod &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;in .NET Core, Azure, Web&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xB7; 1 Comment"/>
    <meta property="og:description" content="This post shows how you can create and use X509 certificates in Azure Key Vault. The certificates are created using Azure CLI and are used inside an ASP.NET Core application. Code: StsServerIdentit&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://damienbod.com/2020/04/09/using-certificates-from-azure-key-vault-in-asp-net-core/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Using Certificates from Azure Key Vault in ASP.NET Core</title>
<div class="readable">
        <h1>Using Certificates from Azure Key Vault in ASP.NET Core</h1>
            <div>by April 9, 2020 &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;by damienbod &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;in .NET Core, Azure, Web&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xB7; 1 Comment</div>
            <div>Reading time: 11-13 minutes</div>
        <div>Posted here: 14 Apr 2020</div>
        <p><a href="https://damienbod.com/2020/04/09/using-certificates-from-azure-key-vault-in-asp-net-core/">https://damienbod.com/2020/04/09/using-certificates-from-azure-key-vault-in-asp-net-core/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>

							<p>This post shows how you can create and use X509 certificates in Azure Key Vault. The certificates are created using Azure CLI and are used inside an ASP.NET Core application.</p>
<p><strong>Code:</strong> <a href="https://github.com/damienbod/IdentityServer4AspNetCoreIdentityTemplate/tree/master/content/StsServerIdentity/Services/Certificate">StsServerIdentity/Services/Certificate</a> </p>
<p><strong>Setup using Azure CLI</strong></p>
<p>Azure CLI can be used to setup the Azure Key Vault and also create certificates for an existing Key Vault. Azure CLI is documented and can be downloaded here: <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="nofollow">https://docs.microsoft.com/en-us/cli/azure/install-azure-cli</a></p>
<p>When Azure CLI is installed and running, you need to login.</p>

<p>If the login does not work, you might have to allow your default browser to open the insecure redirect URL to complete the login. For example, when using Chrome, use the following to reset the HSTS. Unsecure URLs are required for this Azure <strong>az login</strong>. Maybe this should be fixed.</p>

<p><strong>Creating certificates in an Azure Key Vault</strong></p>
<p>A policy is required to create certificates in Azure Key Vault. You can get the default policy from your Azure subscription using the following request:</p>
<div><div id="highlighter_133706"><table><tbody><tr><td><p>1</p><p>2</p></td><td><div><p><code>az keyvault certificate </code><code>get</code><code>-</code><code>default</code><code>-policy | Out-File `</code></p><p><code>&nbsp;</code><code>-Encoding utf8 defaultpolicy.json</code></p></div></td></tr></tbody></table></div></div>
<p>Your policy could look like this:</p>
<div><div id="highlighter_299805"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p></td><td><div><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>"issuerParameters"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"certificateTransparency"</code><code>: </code><code>null</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"name"</code><code>: </code><code>"Self"</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"keyProperties"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"curve"</code><code>: </code><code>null</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"exportable"</code><code>: </code><code>true</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"keySize"</code><code>: 2048,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"keyType"</code><code>: </code><code>"RSA"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"reuseKey"</code><code>: </code><code>true</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"lifetimeActions"</code><code>: [</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"action"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"actionType"</code><code>: </code><code>"AutoRenew"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"trigger"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"daysBeforeExpiry"</code><code>: 90</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>],</code></p><p><code>&nbsp;&nbsp;</code><code>"secretProperties"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"contentType"</code><code>: </code><code>"application/x-pkcs12"</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"x509CertificateProperties"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"keyUsage"</code><code>: [</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"cRLSign"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"dataEncipherment"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"digitalSignature"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"keyEncipherment"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"keyAgreement"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"keyCertSign"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>],</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"subject"</code><code>: </code><code>"CN=CLIGetDefaultPolicy"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"validityInMonths"</code><code>: 12</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Now you can create a certificate in the Azure Key Vault. Using the policy above, enter an existing Key Vault name and the name of the certificate family.</p>
<div><div id="highlighter_174885"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p></td><td><div><p><code>az keyvault certificate create `</code></p><p><code>&nbsp;&nbsp;</code><code>--vault-name vaultName `</code></p><p><code>&nbsp;&nbsp;</code><code>-n certificatesKeyVaultName `</code></p><p><code>&nbsp;&nbsp;</code><code>--policy `@defaultpolicy.json</code></p></div></td></tr></tbody></table></div></div>
<p>This can be viewed in the Azure Portal Key Vault.</p>
<p><img data-attachment-id="13433" data-permalink="https://damienbod.com/2020/04/09/using-certificates-from-azure-key-vault-in-asp-net-core/keyvaultcertificates_01/" data-orig-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png" data-orig-size="1296,670" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="keyVaultCertificates_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=640" src="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=640&amp;h=331" alt="" width="640" height="331" srcset="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=640&amp;h=331 640w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=1280&amp;h=662 1280w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=150&amp;h=78 150w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=600&amp;h=310 600w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=768&amp;h=397 768w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_01.png?w=1024&amp;h=529 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Call the command a second time so that a second certificate is created.</p>
<p><img data-attachment-id="13434" data-permalink="https://damienbod.com/2020/04/09/using-certificates-from-azure-key-vault-in-asp-net-core/keyvaultcertificates_02/" data-orig-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png" data-orig-size="1424,830" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="keyVaultCertificates_02" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=640" src="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=640&amp;h=373" alt="" width="640" height="373" srcset="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=640&amp;h=373 640w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=1280&amp;h=746 1280w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=150&amp;h=87 150w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=600&amp;h=350 600w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=768&amp;h=448 768w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_02.png?w=1024&amp;h=597 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Using the certificates in ASP.NET Core </strong></p>
<p>The following example uses the created certificates for IdentityServer4 signing credentials. We will use the Azure Key Vault to get the new certificates. The newest certificate will be used for signing, the second newest will be used for support of existing sessions. This would make it possible to load a new certificate to the Key Vault, for example in a deployment, and when the hosted application is restarted, the certificates will be updated.</p>
<p>A configuration class is used to setup the certificate management. This can then be used to return the two certificates.</p>
<div><div id="highlighter_889957"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p></td><td><div><p><code>public</code> <code>class</code> <code>CertificateConfiguration</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>bool</code> <code>UseLocalCertStore { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>CertificateThumbprint { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>CertificateNameKeyVault { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>KeyVaultEndpoint { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>DevelopmentCertificatePfx { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>DevelopmentCertificatePassword { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>}</code></p><p><code>private</code> <code>static</code> <code>async</code> <code>Task&lt;(X509Certificate2 ActiveCertificate, X509Certificate2 SecondaryCertificate)&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>GetCertificates(IWebHostEnvironment environment, IConfiguration configuration)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>certificateConfiguration = </code><code>new</code> <code>CertificateConfiguration</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>CertificateNameKeyVault = configuration[</code><code>"CertificateNameKeyVault"</code><code>], </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>KeyVaultEndpoint = configuration[</code><code>"AzureKeyVaultEndpoint"</code><code>], </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>DevelopmentCertificatePfx = Path.Combine(environment.ContentRootPath, </code><code>"sts_dev_cert.pfx"</code><code>),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>DevelopmentCertificatePassword = </code><code>"1234"</code> </p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>};</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>(X509Certificate2 ActiveCertificate, X509Certificate2 SecondaryCertificate) </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certs = </code><code>await</code> <code>CertificateService.GetCertificates(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certificateConfiguration).ConfigureAwait(</code><code>false</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>certs;</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The GetCertificates can the be used to get the certificates from the Azure Key Vault. If the app.settings are configured for the Key Vault, the KeyVaultCertificateService will be used to get the certificates.</p>
<div><div id="highlighter_619846"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p></td><td><div><p><code>public</code> <code>static</code> <code>async</code> <code>Task&lt;(X509Certificate2 ActiveCertificate, X509Certificate2 SecondaryCertificate)&gt; GetCertificates(CertificateConfiguration certificateConfiguration)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>(X509Certificate2 ActiveCertificate, X509Certificate2 SecondaryCertificate) certs = (</code><code>null</code><code>, </code><code>null</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(certificateConfiguration.UseLocalCertStore)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>using</code> <code>X509Store store = </code><code>new</code> <code>X509Store(StoreName.My, StoreLocation.LocalMachine);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>store.Open(OpenFlags.ReadOnly);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>storeCerts = store.Certificates.Find(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>X509FindType.FindByThumbprint, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certificateConfiguration.CertificateThumbprint, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>false</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certs.ActiveCertificate = storeCerts[0];</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>store.Close();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>else</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(!</code><code>string</code><code>.IsNullOrEmpty(certificateConfiguration.KeyVaultEndpoint))</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>keyVaultCertificateService = </code><code>new</code> <code>KeyVaultCertificateService(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certificateConfiguration.KeyVaultEndpoint,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certificateConfiguration.CertificateNameKeyVault);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certs = </code><code>await</code> <code>keyVaultCertificateService</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.GetCertificatesFromKeyVault().ConfigureAwait(</code><code>false</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code><code>(certs.ActiveCertificate == </code><code>null</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certs.ActiveCertificate = </code><code>new</code> <code>X509Certificate2(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certificateConfiguration.DevelopmentCertificatePfx,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certificateConfiguration.DevelopmentCertificatePassword);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>certs;</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The KeyVaultCertificateService searches for the certificates and returns the two newest ones as required.</p>
<div><div id="highlighter_669496"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p></td><td><div><p><code>using</code> <code>System;</code></p><p><code>using</code> <code>System.Collections.Generic;</code></p><p><code>using</code> <code>System.Linq;</code></p><p><code>using</code> <code>System.Security.Cryptography.X509Certificates;</code></p><p><code>using</code> <code>System.Threading.Tasks;</code></p><p><code>using</code> <code>Microsoft.Azure.KeyVault;</code></p><p><code>using</code> <code>Microsoft.Azure.KeyVault.Models;</code></p><p><code>using</code> <code>Microsoft.Azure.Services.AppAuthentication;</code></p><p><code>namespace</code> <code>StsServerIdentity.Services.Certificate</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>class</code> <code>KeyVaultCertificateService</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>string</code> <code>_keyVaultEndpoint;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>string</code> <code>_certificateName;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>KeyVaultCertificateService(</code><code>string</code> <code>keyVaultEndpoint, </code><code>string</code> <code>certificateName)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(</code><code>string</code><code>.IsNullOrEmpty(keyVaultEndpoint))</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>throw</code> <code>new</code> <code>ArgumentException(</code><code>"missing keyVaultEndpoint"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><div><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_keyVaultEndpoint = keyVaultEndpoint; </code></p></div><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_certificateName = certificateName; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>async</code> <code>Task&lt;(X509Certificate2 ActiveCertificate, X509Certificate2 SecondaryCertificate)&gt; GetCertificatesFromKeyVault()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>(X509Certificate2 ActiveCertificate, X509Certificate2 SecondaryCertificate) certs = (</code><code>null</code><code>, </code><code>null</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>azureServiceTokenProvider = </code><code>new</code> <code>AzureServiceTokenProvider();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>keyVaultClient = </code><code>new</code> <code>KeyVaultClient(</code><code>new</code> <code>KeyVaultClient.AuthenticationCallback(azureServiceTokenProvider.KeyVaultTokenCallback));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>certificateItems = </code><code>await</code> <code>GetAllEnabledCertificateVersionsAsync(keyVaultClient);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>item = certificateItems.FirstOrDefault();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(item != </code><code>null</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certs.ActiveCertificate = </code><code>await</code> <code>GetCertificateAsync(item.Identifier.Identifier, keyVaultClient);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(certificateItems.Count &gt; 1)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>certs.SecondaryCertificate = </code><code>await</code> <code>GetCertificateAsync(certificateItems[1].Identifier.Identifier, keyVaultClient);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>certs;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>async</code> <code>Task&lt;List&lt;CertificateItem&gt;&gt; GetAllEnabledCertificateVersionsAsync( KeyVaultClient keyVaultClient)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>certificateVersions = </code><code>await</code> <code>keyVaultClient.GetCertificateVersionsAsync(_keyVaultEndpoint, _certificateName);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>certificateVersions</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.Where(certVersion =&gt; certVersion.Attributes.Enabled.HasValue &amp;&amp; certVersion.Attributes.Enabled.Value)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.OrderByDescending(certVersion =&gt; certVersion.Attributes.Created)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.ToList();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>async</code> <code>Task&lt;X509Certificate2&gt; GetCertificateAsync(</code><code>string</code> <code>identitifier, KeyVaultClient keyVaultClient)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>certificateVersionBundle = </code><code>await</code> <code>keyVaultClient.GetCertificateAsync(identitifier);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>certificatePrivateKeySecretBundle = </code><code>await</code> <code>keyVaultClient.GetSecretAsync(certificateVersionBundle.SecretIdentifier.Identifier);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>privateKeyBytes = Convert.FromBase64String(certificatePrivateKeySecretBundle.Value);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>certificateWithPrivateKey = </code><code>new</code> <code>X509Certificate2(privateKeyBytes, (</code><code>string</code><code>)</code><code>null</code><code>, X509KeyStorageFlags.MachineKeySet);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>certificateWithPrivateKey;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Now the certificates can be used in the ConfigureServices Startup method.</p>
<div><div id="highlighter_870862"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p></td><td><div><p><code>var</code> <code>x509Certificate2Certs = </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>GetCertificates(_environment, _configuration)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.GetAwaiter().GetResult();&nbsp; </code></p><p><code>var</code> <code>identityServer = services.AddIdentityServer()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.AddSigningCredential(x509Certificate2Certs.ActiveCertificate)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.AddInMemoryIdentityResources(Config.GetIdentityResources())</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.AddInMemoryApiResources(Config.GetApiResources())</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.AddInMemoryClients(Config.GetClients(stsConfig))</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.AddAspNetIdentity&lt;ApplicationUser&gt;()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.AddProfileService&lt;IdentityWithAdditionalClaimsProfileService&gt;();</code></p><p><code>if</code> <code>(x509Certificate2Certs.SecondaryCertificate != </code><code>null</code><code>)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>identityServer.AddValidationKey(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>x509Certificate2Certs.SecondaryCertificate);</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>When the IdentityServer4 hosted application is started, the signing credentials created from the certificates can be viewed using the jwks endpoint</p>
<p>/.well-known/openid-configuration/jwks</p>
<p><img data-attachment-id="13442" data-permalink="https://damienbod.com/2020/04/09/using-certificates-from-azure-key-vault-in-asp-net-core/keyvaultcertificates_03/" data-orig-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png" data-orig-size="1352,1214" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="keyVaultCertificates_03" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=640" src="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=640&amp;h=575" alt="" width="640" height="575" srcset="https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=640&amp;h=575 640w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=1280&amp;h=1150 1280w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=150&amp;h=135 150w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=600&amp;h=539 600w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=768&amp;h=690 768w, https://damienbod.files.wordpress.com/2020/03/keyvaultcertificates_03.png?w=1024&amp;h=919 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>If a new certificate is created in the Azure Key Vault, and the ASP.NET Core application is restarted, the latest certificate will be used to sign the tokens, and the previous certificate will also be supported for existing sessions.</p>
<p><strong>Improvements</strong></p>
<p>This shows one way how Azure Key Vault certificates can be used in an ASP.NET Core application. This could be improved in many ways. For example, it would be good if the certificates were rotated directly from the application, instead of a forced create and application restart. The async method is used in the ConfigureServices method. This could be added directly to the IdentityServer4 extension method for this by using a custom implementation. The next certificate which will be used, could also be made public before the existing certificate is replaced.</p>
<p><strong>Links:</strong></p>
<p><a href="https://github.com/damienbod/IdentityServer4AspNetCoreIdentityTemplate/issues/30" rel="nofollow">https://github.com/damienbod/IdentityServer4AspNetCoreIdentityTemplate/issues/30</a></p>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="nofollow">https://docs.microsoft.com/en-us/cli/azure/install-azure-cli</a></p>
<p><a href="https://damienbod.com/2018/12/23/using-azure-key-vault-with-asp-net-core-and-azure-app-services/">Using Azure Key Vault with ASP.NET Core and Azure App Services</a></p>
<p><a href="https://damienbod.com/2019/01/07/deploying-asp-net-core-app-services-using-azure-key-vault-and-azure-resource-manager-templates/">Deploying ASP.NET Core App Services using Azure Key Vault and Azure Resource Manager templates</a></p>
<p><a href="https://damienbod.com/2019/02/07/using-azure-key-vault-from-an-non-azure-app/">Using Azure Key Vault from a non-Azure App</a></p>

							
							
						</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>