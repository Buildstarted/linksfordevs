<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Static constructor broken (not always executed) &#xB7; Issue #13036 &#xB7; dotnet/runtime &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Static constructor broken (not always executed) · Issue #13036 · dotnet/runtime · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>After porting a server which has been running on Desktop Framework and Mono for years I noticed crashes due to static fields staying NULL meaning the static constructor did not execute.</p><p>According to the <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/static-constructors" rel="nofollow">documentation</a> I expect static constructors to run before an instance of the class is constructed, i.e. when the instance constructor runs all static fields have been initialized. This is not the case with .NET Core, in the following scenario the static <code>helper1</code> field is not initialized before the constructor.</p><p>While the static field itself is not accessed the static constructor has visible side effects. In my particular usage the constructor call done when initializing static fields will register the static instance globally. These registrations do not happen in .NET Core causing my server to crash because important logic is skipped.</p><details><summary>Example code</summary><div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span><span class="pl-en">System</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Runtime</span>.<span class="pl-en">CompilerServices</span>;

<span class="pl-k">namespace</span><span class="pl-en">NetCoreStaticConstructorBug</span>
{
    <span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">class</span><span class="pl-en">Program</span>
    {
        <span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">bool</span><span class="pl-smi">StaticConstructor1Executed</span><span class="pl-k">=</span><span class="pl-c1">false</span>;
        <span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">bool</span><span class="pl-smi">StaticConstructor2Executed</span><span class="pl-k">=</span><span class="pl-c1">false</span>;

        <span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">void</span><span class="pl-en">Main</span>(<span class="pl-k">string</span>[] <span class="pl-smi">args</span>)
        {
            <span class="pl-c"><span class="pl-c">//</span> outputs "False, False"</span><span class="pl-smi">Console</span>.<span class="pl-en">WriteLine</span>(<span class="pl-s"><span class="pl-pds">$"</span>{<span class="pl-smi">StaticConstructor1Executed</span>}, {<span class="pl-smi">StaticConstructor2Executed</span>}<span class="pl-pds">"</span></span>);

            <span class="pl-k">var</span><span class="pl-smi">runner1</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Runner1</span>();
            <span class="pl-k">var</span><span class="pl-smi">runner2</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Runner2</span>();

            <span class="pl-c"><span class="pl-c">//</span> outputs "False, True" on Core, "True, True" on Desktop/Mono</span><span class="pl-smi">Console</span>.<span class="pl-en">WriteLine</span>(<span class="pl-s"><span class="pl-pds">$"</span>{<span class="pl-smi">StaticConstructor1Executed</span>}, {<span class="pl-smi">StaticConstructor2Executed</span>}<span class="pl-pds">"</span></span>);

            <span class="pl-smi">RuntimeHelpers</span>.<span class="pl-en">RunClassConstructor</span>(<span class="pl-k">typeof</span>(<span class="pl-en">Runner1</span>).<span class="pl-smi">TypeHandle</span>);
            <span class="pl-smi">RuntimeHelpers</span>.<span class="pl-en">RunClassConstructor</span>(<span class="pl-k">typeof</span>(<span class="pl-en">Runner2</span>).<span class="pl-smi">TypeHandle</span>);

            <span class="pl-c"><span class="pl-c">//</span> outputs "True, True"</span><span class="pl-smi">Console</span>.<span class="pl-en">WriteLine</span>(<span class="pl-s"><span class="pl-pds">$"</span>{<span class="pl-smi">StaticConstructor1Executed</span>}, {<span class="pl-smi">StaticConstructor2Executed</span>}<span class="pl-pds">"</span></span>);
        }
    }

    <span class="pl-k">public</span><span class="pl-k">sealed</span><span class="pl-k">class</span><span class="pl-en">Runner1</span>
    {
        <span class="pl-k">private</span><span class="pl-k">static</span><span class="pl-en">Helper</span><span class="pl-smi">helper1</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Helper</span>();

        <span class="pl-k">private</span><span class="pl-k">sealed</span><span class="pl-k">class</span><span class="pl-en">Helper</span>
        {
            <span class="pl-k">public</span><span class="pl-en">Helper</span>()
            {
                <span class="pl-c"><span class="pl-c">//</span> in my actual program the Helper instances are network protocol</span><span class="pl-c"><span class="pl-c">//</span> handlers registering themselves globally with another singleton instance</span><span class="pl-smi">Program</span>.<span class="pl-smi">StaticConstructor1Executed</span><span class="pl-k">=</span><span class="pl-c1">true</span>;
            }
        }

        <span class="pl-k">public</span><span class="pl-en">Runner1</span>() { }
    }

    <span class="pl-k">public</span><span class="pl-k">sealed</span><span class="pl-k">class</span><span class="pl-en">Runner2</span>
    {
        <span class="pl-k">static</span><span class="pl-en">Runner2</span>()
        {
            <span class="pl-smi">Program</span>.<span class="pl-smi">StaticConstructor2Executed</span><span class="pl-k">=</span><span class="pl-c1">true</span>;
        }

        <span class="pl-k">public</span><span class="pl-en">Runner2</span>() { }
    }
}</pre></div></details><p>Note that <code>Runner2</code> executes the static constructor but <code>Runner1</code> does <em>not execute</em> on Core Framework. Observed on .NET Core 2.1.507 and 2.2.300, works fine on Desktop and Mono.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>