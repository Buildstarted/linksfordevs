<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Fixing Random, part 32 -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }
    </style>
</head>
<body>
    <div class="grid">
            <h1>Fixing Random, part 32</h1>
        
<div class="readable"><div class="entry-content"> <p><a href="https://ericlippert.com/2019/05/20/fixing-random-part-31/">Last time on FAIC</a> we reviewed the meaning of &#x201C;expected value&#x201D;: when you get a whole bunch of samples from a distribution, and a function on those samples, what is the average value of the function&#x2019;s value as the number of samples gets large?</p>
<p>I gave a naive implementation:</p>
<p><span><span>public</span><span>&#xA0;</span><span>static</span><span>&#xA0;</span><span>double</span><span>&#xA0;</span><span>ExpectedValue&lt;T&gt;</span><span>(</span><br>
<span>&#xA0; &#xA0;&#xA0;</span><span>this</span><span>&#xA0;</span><span>IDistribution</span><span>&lt;</span><span>T</span><span>&gt;</span><span>&#xA0;</span><span>d</span><span>,</span><br>
<span>&#xA0; &#xA0;&#xA0;</span><span>Func</span><span>&lt;</span><span>T</span><span>,</span><span>&#xA0;</span><span>double</span><span>&gt;</span><span>&#xA0;</span><span>f</span><span>)</span><span>&#xA0;</span><span>=&gt;</span><br>
<span>&#xA0;&#xA0;</span><span>d</span><span>.</span><span>Samples</span><span>()</span><span>.</span><span>Take</span><span>(</span><span>1000</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>f</span><span>)</span><span>.</span><span>Average</span><span>();</span></span></p>
<p><span><span>public</span><span>&#xA0;</span><span>static</span><span>&#xA0;</span><span>double</span><span>&#xA0;</span><span>ExpectedValue</span><span>(</span><br>
<span>&#xA0; &#xA0;&#xA0;</span><span>this</span><span>&#xA0;</span><span>IDistribution</span><span>&lt;double</span><span>&gt;</span><span>&#xA0;</span><span>d</span><span>)</span><span>&#xA0;</span><span>=&gt;</span><br>
<span>&#xA0;&#xA0;</span><span>d</span><span>.ExpectedValue(x=&gt;x);</span></span></p>
<p>Though short and sweet, this implementation has some problems; the most obvious one is that hard-coded 1000 in there; where did it come from? Nowhere in particular, that&#x2019;s where.</p>
<p>It seems highly likely that this is either too big, and we can compute a good estimate in fewer samples, or that it is too small, and we&#x2019;re missing some important values.</p>
<p>Let&#x2019;s explore a scenario where the number of samples is too small. The scenario will be <em>contrived</em>, but not <em>entirely</em> unrealistic.</p>
<p>Let&#x2019;s suppose we have an investment strategy; we invest a certain amount of money with this strategy, and when the strategy is complete, we have either more or less money than we started with. To simplify things, let&#x2019;s say that the &#x201C;outcome&#x201D; of this strategy is just a number between 0.0 and 1.0; 0.0 indicates that the strategy has completely failed, resulting in a loss, and 1.0 indicates that the strategy has completely succeeded, resulting in the maximum possible return.</p>
<p>Before we go on, I want to talk a bit about that &#x201C;resulting in a loss&#x201D; part. If you&#x2019;re a normal, sensible investor like me and you have $100 to invest, you buy a stock or a mutual fund for $100 because you believe it will increase in value. If it goes up to $110 you sell it and pocket the $10 profit. If it goes down to $90, you sell it and take the $10 loss. But in no case do you ever lose more than the $100 you invested. (Though of course you do pay fees on each trade whether it goes up or down; let&#x2019;s suppose those are negligible.) Our goal is to get that 10% return on investment.</p>
<p>Now consider the following much riskier strategy for spending $100 to speculate in the market: suppose there is a stock currently at $100 which we believe will go down, not up. We borrow a hundred shares from someone willing to lend them to us, and sell them for $10000. We pay the lender $100 interest for their trouble. Now if the stock goes down to $90, we buy the hundred shares back for $9000, return them to the owner, and we&#x2019;ve spent $100 but received $1000; we&#x2019;ve made a <strong>900%</strong> return on the $100 we &#x201C;invested&#x201D;. This is a &#x201C;short sale&#x201D;, and as you can see, you get a 900% return instead of a 10% return.</p>
<p>(I say &#x201C;invested&#x201D; in scare quotes because this isn&#x2019;t really investing; it&#x2019;s speculation. Which is a genteel word for &#x201C;gambling&#x201D;.)</p>
<p>But perhaps you also see the danger here. Suppose the stock goes down but only to $99.50. We buy back the shares for $9950, and we&#x2019;ve only gained $50 on the trade, so we&#x2019;ve lost half of our $100; in the &#x201C;long&#x201D; strategy, we would only have lost fifty cents; your losses can easily be bigger with the short strategy than with the long strategy.</p>
<p>But worse, what if the stock goes <strong>up</strong> to $110. We have to buy back those shares for $11000, so we&#x2019;ve &#x201C;invested&#x201D; $100 and gotten a &#x201C;return&#x201D; of -$1000, for a total loss of $1100 on a $100 investment. In a short sale if things go catastrophically wrong you can end up losing <em>more</em> than your original investment. A lot more!</p>
<p>As I often say, foreshadowing is the sign of a quality blog; let&#x2019;s continue with our example.</p>
<p>We have a process that produces values from 0.0 to 1.0 that indicates the &#x201C;success level&#x201D; of the strategy. What is the distribution of success level? Let&#x2019;s suppose it&#x2019;s a straightforward bell-shaped curve with the mean on the &#x201C;success&#x201D; side:</p>
<p><img class="alignnone size-full wp-image-6285" src="https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.14.22-pm.png?w=584" alt="Screen Shot 2019-05-20 at 1.14.22 PM.png" srcset="https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.14.22-pm.png?w=584 584w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.14.22-pm.png?w=1168 1168w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.14.22-pm.png?w=150 150w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.14.22-pm.png?w=300 300w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.14.22-pm.png?w=768 768w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.14.22-pm.png?w=1024 1024w" sizes="(max-width: 584px) 100vw, 584px"></p>
<p>This is a PDF, and extra bonus, it is normalized: the total area under the curve is 1.0. <strong>The vast majority of the time &#x2014; 99.9% &#x2014; our investment strategy produces an outcome between 0.48 and 1.0, so that&#x2019;s the area of the graph I&#x2019;m going to focus on.</strong></p> <p><strong>Aside:</strong> I know it looks a little weird seeing a bell-shaped curve that just cuts off abruptly at 1.0, but let&#x2019;s not stress about it. Again, this is a contrived example, and we&#x2019;ll see why it is irrelevant later.</p> <p>Now, I don&#x2019;t intend to imply that the &#x201C;success level&#x201D; is the <em>return</em>: I&#x2019;m not saying that most of the time we get a 75% return. Let&#x2019;s suppose that we&#x2019;ve worked out a function that translates &#x201C;strategy outcome level&#x201D; to the percentage gain on our investment. That is, if the function is 0.0, we&#x2019;ve not gained anything but we&#x2019;ve not lost anything either. If it is 0.5 then our profits are 50% of our investment; if it&#x2019;s -0.25 then we&#x2019;ve taken a net loss of 25% of our investment, and so on.</p>
<p>Let&#x2019;s propose such a function, and zoom in on the right side of the diagram where the 99.9% of cases are found: from 0.46 to 1.0. Here&#x2019;s our function:</p>
<p><img class="alignnone size-full wp-image-6286" src="https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.34.22-pm.png?w=584" alt="Screen Shot 2019-05-20 at 1.34.22 PM.png" srcset="https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.34.22-pm.png?w=584 584w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.34.22-pm.png?w=1166 1166w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.34.22-pm.png?w=150 150w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.34.22-pm.png?w=300 300w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.34.22-pm.png?w=768 768w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-1.34.22-pm.png?w=1024 1024w" sizes="(max-width: 584px) 100vw, 584px"></p>
<p>If our process produces an outcome of 0.54 or larger, we make between a 0% and an 18% return, which seems pretty good; after all the vast majority of the bulk of the distribution is to the right of 0.54. Now, in the unlikely case where we get an outcome from 0.48 to 0.54, we lose money; on the left hand end, we&#x2019;re losing almost 200%; that is, if we put in $100 we not only fail to make it back, we end up <em>owing</em> $100.</p>
<p>The question at hand, of course, is <strong>what is the average value of the &#x201C;profit function&#x201D; given the distribution of outcomes?</strong> That is, if we ran this strategy a thousand times, on average what return would we get?</p>
<p>Well, we already wrote the code, so let&#x2019;s run it: (Code can be found <a href="https://github.com/ericlippert/probability/tree/episode32">here</a>.)</p>
<p><span><span>var</span> <span>p </span><span>=</span><span>&#xA0;</span><span>Normal</span><span>.</span><span>Distribution</span><span>(</span><span>0.75</span><span>,</span><span>&#xA0;</span><span>0.09</span><span>);</span><br>
<span>double</span> <span>f</span><span>(</span><span>double</span><span>&#xA0;</span><span>x</span><span>)</span><span>&#xA0;</span><span>=&gt;</span><span><br>
</span><span>&#xA0; </span><span>Atan</span><span>(</span><span>1000</span><span>&#xA0;</span><span>*</span><span>&#xA0;</span><span>(</span><span>x</span><span>&#xA0;</span><span>&#x2013;</span><span>&#xA0;</span><span>.45</span><span>))</span><span>&#xA0;</span><span>*</span><span>&#xA0;</span><span>20</span><span>&#xA0;</span><span>&#x2013;</span><span>&#xA0;</span><span>31.2</span><span>;</span><br>
<span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>$&#x201D;</span><span>{</span><span>p</span><span>.</span><span>ExpectedValue</span><span>(</span><span>f</span><span>):</span><span>0.##</span><span>}</span><span>&#x201C;</span><span>);</span><br>
</span></p> <p><strong>Aside:</strong> I&#x2019;m ignoring the fact that if we get a sample out of the normal distribution that is greater than 1.0 or less than 0.0 we do not discard it. The region to the left of 0.0 is absurdly unlikely, and the region to the right of 1.0 has low probability and the value of the profit function is very flat. Writing a lot of fiddly code to correct for this problem would not change the estimated expected value much and would be a distraction from the far deeper problem we&#x2019;re about to discover.</p>
<p>Also, I&#x2019;m limiting the distribution to a support of 0.0 to 1.0 for pedagogical reasons; as we&#x2019;ll see in later episodes, we will eventually remove this restriction, so let&#x2019;s just ignore it now.</p> <p>We get the answer:</p>
<pre>0.14</pre>
<p>Super, we will get on average a 14% return on our investment with this strategy. Seems like a good investment; though we have a small chance of losing big, the much larger chance of getting a solid 0% to 18% return outweighs it. <em>On average.</em></p> <p><strong>Aside:</strong> It is important to realize that this 14% figure does not <em>necessarily</em> imply that <em>typically</em> we get a 14% return when we run this strategy, any more than the expected value of 3.5 implies that we&#x2019;ll <em>typically</em> get 3.5 when we roll a d6. The expected value only tells you what the average behaviour is; it doesn&#x2019;t tell you, for example, what the probability is that you&#x2019;ll lose everything. It tells you that if you ran this strategy a million times, on average you&#x2019;d get a 14% return, and that&#x2019;s <em>all</em> it tells you. Be careful when making decisions relying upon expected values!</p> <p>This 14% expected result totally makes sense, right? We know most of the time the result will be between 0% and 18%, so 14% seems like a totally reasonable expected value.</p>
<p>As one of my managers at Microsoft used to say: <em>would you bet your car on it?</em></p>
<p>Let&#x2019;s just run the code again to be sure.</p>
<pre>0.14</pre>
<p>Whew. That&#x2019;s a relief.</p>
<p>You know what they say: <em>doing the same thing twice and expecting different results is the definition of practicing the piano</em>, but I&#x2019;m still not satisfied. Let&#x2019;s run it another hundred times:</p>
<pre>0.14, 0.08, 0.09, 0.14, 0.08, 0.14, 0.14, 0.07, 0.07, 0.14, ...</pre>
<p>Oh dear me.</p>
<p>The expected return of our strategy is usually 14%; why it is sometimes <em>half</em> that? Yes, there is randomness in our algorithm, but surely it should not cause the value computed to vary so widely!</p>
<p>It seems like we cannot rely on this implementation, but why not? The code looks right.</p>
<p>As it turns out, I showed you <em>exactly the wrong part of the graphs</em> above. (Because I am devious.) I showed you the parts that make up 99.9% of the likely cases. Let&#x2019;s look at the graph of the profit-or-loss function over the whole range of outcomes from 0.0 to 1.0:</p>
<p><img class="alignnone size-full wp-image-6292" src="https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-5.09.29-pm.png?w=584" alt="Screen Shot 2019-05-20 at 5.09.29 PM.png" srcset="https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-5.09.29-pm.png?w=584 584w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-5.09.29-pm.png?w=150 150w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-5.09.29-pm.png?w=300 300w, https://ericlippert.files.wordpress.com/2019/05/screen-shot-2019-05-20-at-5.09.29-pm.png 731w" sizes="(max-width: 584px) 100vw, 584px"></p>
<p>OUCH. It&#x2019;s an approximation of a step function; in the original graph that started at 0.46, we should have noticed that the extremely steep part of the curve was trending downwards to the left at an alarming rate. If you have an outcome of 0.48 from our process, you&#x2019;re going to lose half your money; 0.46, you lose all your money and a little bit more. But by the time we get to 0.44, we&#x2019;re down to losing over 60 times your original investment; this is a catastrophic outcome.</p>
<p><strong>How likely is that catastrophic outcome?</strong> Let&#x2019;s zoom in on just that part of the probability distribution. I&#x2019;ll re-scale the profit function so that they fit on the same graph, so you can see where exactly the step happens:</p>
<p><img class="alignnone size-full wp-image-6294" src="https://ericlippert.files.wordpress.com/2019/05/2019-05-20-3.png?w=584" alt="2019-05-20 (3)" srcset="https://ericlippert.files.wordpress.com/2019/05/2019-05-20-3.png?w=584 584w, https://ericlippert.files.wordpress.com/2019/05/2019-05-20-3.png?w=1168 1168w, https://ericlippert.files.wordpress.com/2019/05/2019-05-20-3.png?w=150 150w, https://ericlippert.files.wordpress.com/2019/05/2019-05-20-3.png?w=300 300w, https://ericlippert.files.wordpress.com/2019/05/2019-05-20-3.png?w=768 768w, https://ericlippert.files.wordpress.com/2019/05/2019-05-20-3.png?w=1024 1024w" sizes="(max-width: 584px) 100vw, 584px"></p>
<p>This is a normalized PDF, so the probability of getting a particular outcome is equal to the area of the region under the curve. The region under the curve from 0.38 to 0.45 is a little less than a triangle with base 0.07 and height 0.02, so its area is in the ballpark of 0.0007. We will generate a sample in that region roughly once every 1400 samples.</p>
<p>But&#x2026; we&#x2019;re computing the expected value by <em>taking only a thousand samples</em>, so it is quite likely that we don&#x2019;t hit this region at all. The expected losses in that tiny area are so enormous that it changes the average every time we do sample from it. <strong>Whether you include a -60 value or not in the average is a huge influence as to whether the average is 0.14 or 0.07.&#xA0;</strong></p> <p><strong>Aside:</strong> if you run the expected value estimate a few thousand times or more it just gets crazier; sometimes the expected value is actually negative if we just by luck get more than one sample in this critical region.</p> <p>I contrived this example to produce occasional &#x201C;<a href="https://en.wikipedia.org/wiki/Black_swan_theory">black swan events</a>&#x201C;; obviously, our na&#xEF;ve algorithm for computing expected value does not take into account the difficulty of sampling a black swan event, and therefore produces inaccurate and inconsistent results.</p> <p><strong>Next time on FAIC:</strong> We know how to solve this problem exactly for discrete distributions; can we use some of those ideas to improve our estimate of the expected value in this scenario?</p> </div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>