<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Introducing Microsoft.FeatureManagement: Adding feature flags to an ASP.NET Core app -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Introducing Microsoft.FeatureManagement: Adding feature flags to an ASP.NET Core app</h1><div><div class="post-content"><p>In a <a href="https://www.youtube.com/watch?v=cmd0Vh6pFfE">recent .NET Community Standup</a>, a new library was introduced that's being built by the Azure team - <em>Microsoft.FeatureManagement</em>. In this post, I give a brief introduction to the library and how to use it in an ASP.NET Core app. This post just covers the basics - in later posts I'll show some of the ASP.NET Core-specific features, as well as how to create custom feature filters.</p><blockquote><p><em>Microsoft.FeatureManagement</em> is currently in preview, so some details may change when it's properly released.</p></blockquote><h2 id="introducing-microsoft-featuremanagement" class="heading-with-anchor">Introducing Microsoft.FeatureManagement<a href="#introducing-microsoft-featuremanagement"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>If you haven't heard of <em>Microsoft.FeatureManagement</em>, don't feel bad - it's not on GitHub yet, and isn't being developed by the core ASP.NET Core team, so it's definitely flying under the radar. Instead, it's being developed by the Azure team, so you'll <a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/">find what few docs there are under Azure rather than .NET Core</a>.</p><p>Despite being developed by the Azure team, <em>Microsoft.FeatureManagement</em> doesn't have any direct ties to Azure itself. Instead, it's a <a href="https://www.nuget.org/packages/Microsoft.FeatureManagement/1.0.0-preview-009000001-1251">.NET Standard 2.0 library that you can find on NuGet (in preview)</a>. There's also a package <em>Microsoft.FeatureManagement.AspNetCore</em> which adds TagHelper support if you need it.</p><p><em>Microsoft.FeatureManagement</em> is built on top of the <em>Microsoft.Extensions.Configuration</em> configuration system used in ASP.NET Core (but which can also be used in any .NET Standard app). It provides a centralised but extensible way for adding <a href="https://martinfowler.com/articles/feature-toggles.html">feature flags</a> to your system. This lets you roll out new features to a subset of users, limiting the availability of a feature by time, or performing A/B tests, for example.</p><p>As <em>Microsoft.FeatureManagement</em> is built on top of the configuration system, it can be controlled by any of the various configuration providers available. That means you can control features from an <em>appsettings.json</em> file, from environment variables, <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-2.2#custom-configuration-provider">from a database</a>, or from any number of other providers. Enabling and disabling features simply requires changing values in one of your configuration providers.</p><blockquote><p>If you're building an app of any size, it's very likely you'll already be using feature flags, and you may well be using the configuration system to control it. <em>Microsoft.FeatureManagement</em> mostly just formalises this approach, so if you're not using your own version already, it's worth taking a look.</p></blockquote><h2 id="how-it-works-simple-feature-flags" class="heading-with-anchor">How it works: simple feature flags<a href="#how-it-works-simple-feature-flags"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>I'll start off demonstrating the <em>Microsoft.FeatureManagement</em> package by adding a simple feature flag to an ASP.NET Core application that controls what welcome message we display on the home page. When the flag is off, we'll display "Welcome"; when the flag is on, we'll display "Welcome to the Beta":</p><p><img src="/content/images/2019/featureflag_compate.png" alt="Changing the message displayed on a Razor Page using feature flags"></p><h3 id="installing-the-package" class="heading-with-anchor">Installing the package<a href="#installing-the-package"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>In this example, I'm using an ASP.NET Core Web Application (Razor Pages) with Individual Authentication, but you can use any .NET Standard app that uses the <em>Microsoft.Extensions.Configuration</em> system.</p><p>First you need to install the <em>Microsoft.FeatureManagement</em> package. The package is in preview at the time of writing, so you'll need to enable the "previews" checkbox if you're using the NuGet GUI, and <a href="https://github.com/nuget/home/issues/4699">use the full version string</a> if you're using the <code>dotnet</code> CLI:</p><pre class="language-bash"><code class="language-bash">dotnet add package Microsoft.FeatureManagement --version 1.0.0-preview-009000001-1251
</code></pre><p>After adding it, your <em>.csproj</em> file should look something like this:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span><span class="token attr-name">Sdk</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.NET.Sdk.Web<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFramework</span><span class="token punctuation">&gt;</span></span>netcoreapp2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFramework</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AspNetCoreHostingModel</span><span class="token punctuation">&gt;</span></span>InProcess<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AspNetCoreHostingModel</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.App<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Razor.Design<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.2.0<span class="token punctuation">"</span></span><span class="token attr-name">PrivateAssets</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>All<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.FeatureManagement<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1.0.0-preview-009000001-1251<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Project</span><span class="token punctuation">&gt;</span></span></code></pre><p>Now you can add the required services to your DI container:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>FeatureManagement<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">Startup</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
        services<span class="token punctuation">.</span><span class="token function">AddFeatureManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>That's all the infrastructure out of the way, so it's time to actually add the flags to your application.</p><h3 id="adding-simple-feature-flags" class="heading-with-anchor">Adding simple feature flags<a href="#adding-simple-feature-flags"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>In order for the <em>FeatureManagement</em> library to "discover" your features, you should create a "FeatureManagement" section in your app's configuration. Each sub-key of the section is a separate feature flag. For example, in the following <em>appsettings.json</em> file, we've created a single feature flag, <code>NewWelcomeBanner</code>, and set it's value to <code>false</code></p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"Logging"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"LogLevel"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"Default"</span><span class="token operator">:</span><span class="token string">"Warning"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"FeatureManagement"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"NewWelcomeBanner"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>Remember, this is all driven by <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-2.2">the standard ASP.NET configuration providers</a>, so another way to configure the flag would be to create an environment variable <code>FeatureManagement__NewWelcomeBanner</code> and set its value to <code>"false"</code>. </p></blockquote><p>You now have a feature flag (currently disabled) available to your application, but we're not using it anywhere yet. Open up the code-behind for the home page of your application, <em>Index.cshtml.cs</em>, and inject the <code>IFeatureManager</code> into your page: </p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>FeatureManagement<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">IndexModel</span><span class="token punctuation">:</span><span class="token class-name">PageModel</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IFeatureManager</span> _featureManager<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">IndexModel</span><span class="token punctuation">(</span><span class="token class-name">IFeatureManager</span> featureManager<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _featureManager <span class="token operator">=</span> featureManager<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The <code>IFeatureManager</code> service allows you to interrogate the feature management system to identify whether a feature flag is enabled or not. <code>IFeatureManager</code> exposes a single method, for checking whether a feature flag is enabled:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">interface</span><span class="token class-name">IFeatureManager</span><span class="token punctuation">{</span><span class="token keyword">bool</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token keyword">string</span> feature<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>You'll notice that the feature is a string value, which should match the value you used in your configuration, <code>"NewWelcomeBanner"</code>. You can add a property to <code>PageModel</code>, and set it conditionally based on the value of the feature flag:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">IndexModel</span><span class="token punctuation">:</span><span class="token class-name">PageModel</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IFeatureManager</span> _featureManager<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">IndexModel</span><span class="token punctuation">(</span><span class="token class-name">IFeatureManager</span> featureManager<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _featureManager <span class="token operator">=</span> featureManager<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">string</span> WelcomeMessage <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">OnGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        WelcomeMessage <span class="token operator">=</span> _featureManager<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token string">"NewWelcomeBanner"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">"Welcome to the Beta"</span><span class="token punctuation">:</span><span class="token string">"Welcome"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>When you run your app, the feature flag is disabled (as we disabled it in configuration), so you'll see the standard "Welcome" headline:</p><p><img src="/content/images/2019/featureflag_pre_beta.png" alt="When the feature flag is disabled, the header says Welcome"></p><p>However, if you edit your <em>appsettings.json</em> file, set <code>"NewWelcomeBanner": true</code>, and reload the page, you'll see that the feature flag has been enabled, and the new banner is visible.</p><p><img src="/content/images/2019/featureflag_welcome_to_beta.png" alt="When the feature flag is enabled, the header says Welcome to the Beta"></p><blockquote><p>Thanks to the JSON file configuration provider, you don't have to restart your app - the configuration provider will automatically detect the change and update the feature flags on the fly.</p></blockquote><p>As already pointed out, the <em>Microsoft.FeatureManagement</em> library relies on the underlying configuration system, so if you want to adjust feature flags dynamically like this, you'll need to use a configuration provider that supports dynamic updating of configuration values like the file providers or <a href="https://docs.microsoft.com/en-us/aspnet/core/security/key-vault-configuration?view=aspnetcore-2.2">Azure Key Vault provider</a>.</p><h2 id="reducing-magic-strings" class="heading-with-anchor">Reducing magic-strings<a href="#reducing-magic-strings"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Feature flags are identified in code using magic-strings: <code>"NewWelcomeBanner"</code> in the previous example. Instead of scattering these around your code, <a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/use-feature-flags-dotnet-core#referencing">the docs recommend</a> creating a <code>FeatureFlags</code><code>enum</code>, and calling <code>nameof()</code> to reference the values, e.g: </p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">enum</span> FeatureFlags
<span class="token punctuation">{</span>
    NewWelcomeBanner
<span class="token punctuation">}</span><span class="token keyword">var</span> isEnabled <span class="token operator">=</span> _featureManager<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>FeatureFlags<span class="token punctuation">.</span>NewWelcomeBanner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Personally, I think I'd prefer to just use a static class and string constants, as it reduces the verbosity at the call site. But both approaches are essentially identical:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">class</span><span class="token class-name">FeatureFlags</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">const</span><span class="token keyword">string</span> NewWelcomeBanner <span class="token operator">=</span><span class="token string">"NewWelcomeBanner"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> isEnabled <span class="token operator">=</span> _featureManager<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span>FeatureFlags<span class="token punctuation">.</span>NewWelcomeBanner<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The features shown in this post (loading from configuration, <code>IFeatureManager</code>) are all part of the core <em>Microsoft.FeatureManagement</em> library, so you can use them in any .NET Standard 2.0 application. In the next post I'll introduce <em>Microsoft.FeatureManagement.AspNetCore</em> which provides ASP.NET Core-specific features like Tag Helpers and Action Filters that will make working with features easier in many ASP.NET Core apps.</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The <em>Microsoft.FeatureManagement</em> library is a new library being developed by the Azure team to standardise feature management in ASP.NET Core apps. It is currently in preview, and relies on the configuration system for controlling which features are enabled. In this post, I showed how to create simple features, and how to check for them in your apps using the <code>IFeatureManager</code> interface.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>