<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Argument written to stack too early on Linux &#xB7; Issue #10820 &#xB7; dotnet/runtime &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Argument written to stack too early on Linux · Issue #10820 · dotnet/runtime · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>I did try that fix, though after reading some more of the code around there it is probably not the right fix. It looks more like the problem is somewhere in <code>fgMakeOutgoingStructArgCopy</code>, though I haven't looked closer.</p><p>Anyway there is an instance of this in frameworks:</p><pre><code>Crossgen Diffs for System.Private.CoreLib.dll, framework assemblies for x64 linuxnonjit.dll
Summary:
(Lower is better)
Total bytes of diff: 114 (0,00 % of base)
    diff is a regression.
Top file regressions by size (bytes):
         114 : System.ComponentModel.TypeConverter.dasm (0,02 % of base)
1 total files with size differences (0 improved, 1 regressed), 128 unchanged.
Top method regressions by size (bytes):
         114 (2,04 % of base) : System.ComponentModel.TypeConverter.dasm - ColorConverter:ConvertTo(ref,ref,ref,ref):ref:this (2 methods)
Top method regressions by size (percentage):
         114 (2,04 % of base) : System.ComponentModel.TypeConverter.dasm - ColorConverter:ConvertTo(ref,ref,ref,ref):ref:this (2 methods)
1 total methods with size differences (0 improved, 1 regressed), 122948 unchanged.
Completed analysis in 21,65s
</code></pre><p>which is in this code:<br><a href="https://github.com/dotnet/corefx/blob/9ae14ba629e7547b2d27180431cfd7f5a3c14709/src/System.ComponentModel.TypeConverter/src/System/Drawing/ColorConverter.cs#L61">https://github.com/dotnet/corefx/blob/9ae14ba629e7547b2d27180431cfd7f5a3c14709/src/System.ComponentModel.TypeConverter/src/System/Drawing/ColorConverter.cs#L61</a><br>Currently it generates:</p><div class="highlight highlight-source-assembly"><pre><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">40H</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"> gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsi</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en">      gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rax</span><span class="pl-s1">,</span><span class="pl-en"> (reloc)</span><span class="pl-en"></span><span class="pl-k">call</span><span class="pl-en">     bword ptr </span><span class="pl-s1">[</span><span class="pl-v">rax</span><span class="pl-s1">]</span><span class="pl-en">CORINFO_HELP_READYTORUN_STATIC_BASE</span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">+</span><span class="pl-c1">18H</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">rax</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"> gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsi</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en">      gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">+</span><span class="pl-c1">18H</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rax</span><span class="pl-s1">,</span><span class="pl-en"> (reloc)</span><span class="pl-en"></span><span class="pl-k">call</span><span class="pl-en">     qword ptr </span><span class="pl-s1">[</span><span class="pl-v">rax</span><span class="pl-s1">]</span><span class="pl-en">Color:op_Equality(struct</span><span class="pl-s1">,</span><span class="pl-en">struct):bool</span></pre></div><p>I don't think this causes problems in this instance, but with the fix from above this becomes:</p><div class="highlight highlight-source-assembly"><pre><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rax</span><span class="pl-s1">,</span><span class="pl-en"> (reloc)</span><span class="pl-en"></span><span class="pl-k">call</span><span class="pl-en">     bword ptr </span><span class="pl-s1">[</span><span class="pl-v">rax</span><span class="pl-s1">]</span><span class="pl-en">CORINFO_HELP_READYTORUN_STATIC_BASE</span><span class="pl-en">G_M29275_IG09:</span><span class="pl-en"></span><span class="pl-k">movdqu</span><span class="pl-en"></span><span class="pl-v">xmm0</span><span class="pl-s1">,</span><span class="pl-en"> qword ptr </span><span class="pl-s1">[</span><span class="pl-v">rax</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">movdqu</span><span class="pl-en">   qword ptr </span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">98H</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">xmm0</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"> qword ptr </span><span class="pl-s1">[</span><span class="pl-v">rax</span><span class="pl-s1">+</span><span class="pl-c1">16</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en">      qword ptr </span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">88H</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-en">G_M29275_IG10:</span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">+</span><span class="pl-c1">18H</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">98H</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"> gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsi</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en">      gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">+</span><span class="pl-c1">18H</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">B0H</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"> gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsi</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en">      gword ptr </span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">rdi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">8</span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">movsq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rax</span><span class="pl-s1">,</span><span class="pl-en"> (reloc)</span><span class="pl-en"></span><span class="pl-k">call</span><span class="pl-en">     qword ptr </span><span class="pl-s1">[</span><span class="pl-v">rax</span><span class="pl-s1">]</span><span class="pl-en">Color:op_Equality(struct</span><span class="pl-s1">,</span><span class="pl-en">struct):bool</span></pre></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>