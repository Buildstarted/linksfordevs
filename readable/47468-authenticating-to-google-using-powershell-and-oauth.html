<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Authenticating to Google using PowerShell and OAuth -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Authenticating to Google using PowerShell and OAuth</h1>
    <article><p>At Stack we&#x2019;ve written and maintain a set of scripts named &#x201C;Dev-Local-Setup&#x201D; that our developers and designers can use to quickly provision their local environments. They assist in installing pre-requisites (things like Chocolatey, SQL Server, VS 2019, .NET Core SDKs), pulling down repos and provisioning databases and websites used by specific teams. They&#x2019;re packaged as a PowerShell module and used by a menu-driven CLI interface that makes it easy to perform those tasks quickly and efficiently.</p><p><img src="/img/dev-local-setup-1.png" width="640" alt="Dev-Local-Setup"><br><sub>Dev-Local-Setup</sub></p><p>We have a bunch of shared testing data that we store on a file share accessible over the VPN and we also synchronize to Google Drive to facilitate quick downloads for an audience that is spread all over the globe (downloading things from an NY-based data center can be sloooow when you&#x2019;re in Australia!).</p><p>Google Drive requires authentication in order to allow things to be downloaded so we have configured our scripts as an application in Google and use OAuth to obtain an access token whenever somebody needs to download resources stored there.</p><p>If you search around the web you&#x2019;ll find plenty of &#x201C;solutions&#x201D; to this issue, but most of them want you to obtain an access token and embed it in your script. I cannot stress what a <em>terrible</em> idea this is - never store secrets in source control, not to mention that the access token is tied to whoever writes the script. It&#x2019;s probably worth mentioning that if you need to fully automate script access to Google APIs I&#x2019;d suggest looking into service accounts and passing the relevant credentials from the environment that runs the script instead. Our approach is useful for when the script is used interactively.</p><p>Here&#x2019;s how we used to do things:</p><ul><li>Import the WinForms types into our PowerShell script</li><li>Construct a WinForms <code>Form</code> and embed a <code>WebBrowser</code> object in it</li><li>Hook the <code>ContentLoaded</code> event on the <code>WebBrowser</code> to detect URL changes</li><li>Navigate to the URI used to obtain an authorization token once a user has successfully authenticated.</li><li>Configure the redirect URI to be some surrogate that we can intercept using the <code>DOMLoaded</code> event</li><li>When we hit the surrogate URI we extract the <code>code</code> querystring parameter and use it to obtain an access token</li><li>Use the access token to download the resources we need!</li></ul><p>That has worked fine for a long time, but lately IE11 support has started to disappear across the web (including from <a href="https://meta.stackexchange.com/a/337986/267572">Stack Exchange</a>) and the Google authentication flows don&#x2019;t work reliably in the embedded frame. Our first attempt to fix this was to use Microsoft&#x2019;s <a href="https://docs.microsoft.com/en-us/windows/communitytoolkit/controls/wpf-winforms/webview"><code>WebView</code></a> component - this is an equivalent Winforms control that embeds Edge instead of IE11. Easy peasy, let&#x2019;s do it!</p><p><img src="/img/dev-local-setup-2.jpg" width="250" alt="Ruh roh"><br></p><p>Turns out it isn&#x2019;t that easy! Given the nature of the scripts - installing software and other privileged operations - we need to run in an elevated security context. This is our first roadblock - <code>WebView</code> has a real <a href="https://github.com/windows-toolkit/Microsoft.Toolkit.Win32/issues/13">hard time</a> doing anything when the security context is not that of a regular user. It appears that this is because some core infrastructure pieces of UWP applications (which Edge is) cannot run in an elevated security context.</p><p>If we run our scripts as a regular user we can get a modal to render the Edge-based browser but when we come to redirect to our surrogate URI (in our case it happens to be <code>https://localhost/</code>) the browser won&#x2019;t render anything. Eurgh, another roadblock! In this case UWP applications have additional security restrictions on accessing localhost in order to prevent port scanning - a common technique used by malware to determine whether a service is running or not. We can overcome this roadblock by running <code>checknetisolation LoopbackExempt -a -n=&quot;&quot;Microsoft.MicrosoftEdge_8wekyb3d8bbwe&quot;</code> but that doesn&#x2019;t feel like a good thing to do from scripts.</p><p>At this point we took a step back and re-considered our approach. The above roadblocks might well be solved by the new <a href="https://docs.microsoft.com/en-us/microsoft-edge/hosting/webview2"><code>WebView2</code></a> component that embeds the preview version of Edge based upon Chromium, but it&#x2019;s still in beta and requires us to install additional SDKs to work correctly.</p><p>We decided to take another approach - here&#x2019;s the crazy we decided upon&#x2026;</p><h3 id="create-a-web-server">Create a Web Server</h3><p>Create a bare-bones .NET Core 3.0 Kestrel-based application - a <code>.csproj</code> and a <code>.cs</code> contains everything we need to intercept a request to a surrogate URI. When we receive a valid request with an authorization code we output it to stdout and exit. If we receive an error we just exit. That looks a little like this:</p><p><strong>OAuthListener.csproj</strong></p><div class="highlight"><div class="chroma"><table class="lntable"><tr><td class="lntd"><pre class="chroma"><code class="language-xml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td><td class="lntd"><pre class="chroma"><code class="language-xml"><span class="nt">&lt;Project</span> <span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk.Web&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;PropertyGroup&gt;</span> <span class="nt">&lt;TargetFramework&gt;</span>netcoreapp3.0<span class="nt">&lt;/TargetFramework&gt;</span> <span class="nt">&lt;NoDefaultLaunchSettingsFile&gt;</span>true<span class="nt">&lt;/NoDefaultLaunchSettingsFile&gt;</span> <span class="nt">&lt;/PropertyGroup&gt;</span> <span class="nt">&lt;/Project&gt;</span></code></pre></td></tr></table></div></div><p><strong>Program.cs</strong></p><div class="highlight"><div class="chroma"><table class="lntable"><tr><td class="lntd"><pre class="chroma"><code class="language-cs"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td><td class="lntd"><pre class="chroma"><code class="language-cs"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Connections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span> <span class="k">namespace</span> <span class="nn">OAuthListener</span>
<span class="p">{</span> <span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">CancellationTokenSource</span> <span class="n">_cts</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">();</span> <span class="k">static</span> <span class="n">Task</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="na">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">WebHost</span><span class="p">.</span><span class="n">CreateDefaultBuilder</span><span class="p">()</span> <span class="c1">// prevent status messages being written to stdout
</span><span class="c1"></span> <span class="p">.</span><span class="n">SuppressStatusMessages</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="c1">// disable all logging to stdout
</span><span class="c1"></span> <span class="p">.</span><span class="n">ConfigureLogging</span><span class="p">(</span><span class="n">config</span> <span class="p">=&gt;</span> <span class="n">config</span><span class="p">.</span><span class="n">ClearProviders</span><span class="p">())</span> <span class="c1">// listen on the port passed on the args
</span><span class="c1"></span> <span class="p">.</span><span class="n">UseKestrel</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="n">ListenLocalhost</span><span class="p">(</span><span class="kt">int</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">args</span><span class="na">[0]</span><span class="p">)))</span> <span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">app</span> <span class="p">=&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="s">&quot;ERROR! Unable to retrieve authorization code.&quot;</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">code</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// we received an authorization code, output it to stdout
</span><span class="c1"></span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">code</span><span class="p">);</span> <span class="n">message</span> <span class="p">=</span> <span class="s">&quot;Done!&quot;</span><span class="p">;</span> <span class="p">}</span> <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">message</span> <span class="p">+</span> <span class="s">&quot; Check Dev-Local-Setup to continue&quot;</span><span class="p">);</span> <span class="c1">// cancel the cancellation token so the server stops
</span><span class="c1"></span> <span class="n">_cts</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span> <span class="p">})</span> <span class="p">)</span> <span class="p">.</span><span class="n">Build</span><span class="p">()</span> <span class="c1">// run asynchronously using the cancellation token
</span><span class="c1"></span> <span class="c1">// to signal when the process should end. This will be awaited
</span><span class="c1"></span> <span class="c1">// by the framework and the process will end when the cancellation
</span><span class="c1"></span> <span class="c1">// token is signalled.
</span><span class="c1"></span> <span class="p">.</span><span class="n">RunAsync</span><span class="p">(</span><span class="n">_cts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table></div></div><p>As part of our pre-requisites we install .NET Core 3.0 SDK so to execute this we simply <code>dotnet run</code> the project passing the port number we want to listen to.</p><h3 id="open-the-default-web-browser">Open the Default Web Browser</h3><p>Instead of opening a browser embedded in a Winforms modal we can simply use the user&#x2019;s default browser. This has a couple of advantages - we don&#x2019;t need to worry about elevation affecting things (this is effectively just performing a <code>Shell.Open</code> call which executes in the same privilege level as Windows Explorer) and often the developer is already authenticated to Google in that browser so it&#x2019;s less work overall.</p><p>When we construct the URL we configure our redirect URL to point at <code>http://localhost:&lt;port&gt;</code> where <code>&lt;port&gt;</code> is an arbitrary port number specified by our script in the next step&#x2026;</p><h3 id="using-from-powershell">Using from PowerShell</h3><p>Finally we hook it all together&#x2026;</p><div class="highlight"><div class="chroma"><table class="lntable"><tr><td class="lntd"><pre class="chroma"><code class="language-powershell"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td><td class="lntd"><pre class="chroma"><code class="language-powershell"><span class="k">function</span> <span class="nb">Get-GoogleAccessToken</span> <span class="p">{</span> <span class="k">Param</span><span class="p">(</span> <span class="no">[string]</span><span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Position</span> <span class="p">=</span> <span class="n">0</span><span class="p">,</span> <span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$true</span><span class="p">)]</span> <span class="nv">$Scope</span> <span class="p">)</span> <span class="nv">$accessToken</span> <span class="p">=</span> <span class="nv">$null</span><span class="p">;</span> <span class="c"># arbitrary port number to listen on</span> <span class="nv">$port</span> <span class="p">=</span> <span class="n">12345</span> <span class="c">#&#xA0;client identifier of your application configured in the Google Console</span> <span class="nv">$clientId</span> <span class="p">=</span> <span class="s2">&quot;&lt;your client id&gt;&quot;</span> <span class="c"># client secret of your application configured in the Google Console</span> <span class="nv">$clientSecret</span> <span class="p">=</span> <span class="s2">&quot;&lt;your client secret&gt;&quot;</span> <span class="c">#&#xA0;URL used to obtain start an OAuth authorization flow</span> <span class="nv">$url</span> <span class="p">=</span> <span class="s2">&quot;https://accounts.google.com/o/oauth2/v2/auth?client_id=$clientId&amp;redirect_uri=http://localhost:$port&amp;response_type=code&amp;scope=$Scope&quot;</span> <span class="c"># Kick off the default web browser</span> <span class="nb">Write-Host</span> <span class="s2">&quot;Launching web browser to authenticate to GDrive...&quot;</span> <span class="nb">Start-Process</span> <span class="nv">$url</span> <span class="c">#&#xA0;Spin up our .NET Core 3.0 application hostig the web server</span> <span class="nv">$authorizationCode</span> <span class="p">=</span> <span class="p">&amp;</span> <span class="n">dotnet</span> <span class="n">run</span> <span class="n">-p</span> <span class="p">.\</span><span class="n">OAuthListener</span> <span class="p">--</span> <span class="nv">$port</span> <span class="c"># if an authorization code was written to stdout then</span> <span class="c">#&#xA0;exchange it for an access token, otherwise output an error</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$authorizationCode</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$authorizationResponse</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://www.googleapis.com/oauth2/v4/token?code=$authorizationCode&amp;client_id=$clientId&amp;client_secret=$clientSecret&amp;redirect_uri=http://localhost:$port&amp;grant_type=authorization_code&quot;</span> <span class="n">-Method</span> <span class="n">Post</span> <span class="nv">$accessToken</span> <span class="p">=</span> <span class="nv">$authorizationResponse</span><span class="p">.</span><span class="n">access_token</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&quot;Unexpected error while retrieving access token&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span> <span class="p">}</span> <span class="k">return</span> <span class="nv">$accessToken</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table></div></div><p>Then to retrieve an access token and call an API using it (in our case to download a file from Google Drive):</p><div class="highlight"><div class="chroma"><table class="lntable"><tr><td class="lntd"><pre class="chroma"><code class="language-powershell"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td><td class="lntd"><pre class="chroma"><code class="language-powershell"><span class="c"># Grab the access token</span>
<span class="nv">$accessToken</span> <span class="p">=</span> <span class="nb">Get-GoogleAccessToken</span> <span class="n">-Scope</span> <span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">www</span><span class="p">.</span><span class="n">googleapis</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">auth</span><span class="p">/</span><span class="n">drive</span><span class="p">.</span><span class="n">readonly</span>
<span class="c">#&#xA0;Use it in an authorization header</span>
<span class="nv">$headers</span> <span class="p">=</span> <span class="p">@{</span> <span class="n">Authorization</span> <span class="p">=</span> <span class="s2">&quot;Bearer </span><span class="p">$(</span><span class="nv">$accessToken</span><span class="p">)</span><span class="s2">&quot;</span>
<span class="p">}</span>
<span class="c"># Download the file from Google Drive</span>
<span class="nv">$destFile</span> <span class="p">=</span> <span class="nb">Join-Path</span> <span class="nv">$env:TEMP</span> <span class="nv">$fileId</span>
<span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="s2">&quot;https://www.googleapis.com/drive/v3/files/</span><span class="p">$(</span><span class="nv">$fileId</span><span class="p">)</span><span class="s2">?alt=media&quot;</span> <span class="n">-Destination</span> <span class="nv">$destFile</span> <span class="n">-Headers</span> <span class="nv">$headers</span></code></pre></td></tr></table></div></div><p>And that&#x2019;s it! This approach seems to be a lot more reliable than our previous approach; we get to use a modern browser that doesn&#x2019;t have issues handling Google&#x2019;s OAuth flow and a simple web server that is trivial to understand&#x2026;</p></article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>