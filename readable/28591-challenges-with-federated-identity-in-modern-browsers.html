<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Challenges with Federated Identity in modern&#xA0;browsers -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Challenges with Federated Identity in modern&#xA0;browsers</h1>
    <div class="entry-content"> <p>Many websites offer a &#x201C;Log in&#x201D; capability where they don&#x2019;t manage the user&#x2019;s account; instead, they offer visitors the ability to &#x201C;<strong>Login with &lt;<em>identity provider</em>&gt;</strong>.&#x201D;</p>
<p>When the user clicks the Login button on the original <strong>relying party</strong>&#xA0;(RP) website, they are navigated to a login page at the <strong>identity provider</strong> (IP) (e.g. login.microsoft.com) and then redirected back to the RP. That original site then gets some amount of the user&#x2019;s identity info (e.g. their Name &amp; a unique identifier) but it never sees the user&#x2019;s password.</p>
<p>Such <a href="https://en.wikipedia.org/wiki/Federated_identity">Federated Identity</a>&#xA0;schemes have benefits for both the user and the RP site&#x2013; the user doesn&#x2019;t need to set up&#xA0;<em>yet another&#xA0;</em>password and the site doesn&#x2019;t have to worry about&#xA0;the <a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Password_Storage_Cheat_Sheet.md">complexity of safely storing</a> the user&#x2019;s password, managing forgotten passwords, etc.</p>
<p>In some cases, the federated identity login&#xA0;process (typically implemented as a JavaScript library) relies on navigating the user to a top-level page to log in, then back to the relying party website into which the library injects a frame back to the identity provider&#x2019;s website.</p>
<p><img class=" size-full wp-image-2059 aligncenter" src="https://textplain.files.wordpress.com/2019/07/federatedid-1.png?w=515" alt="FederatedID" srcset="https://textplain.files.wordpress.com/2019/07/federatedid-1.png 515w, https://textplain.files.wordpress.com/2019/07/federatedid-1.png?w=150 150w, https://textplain.files.wordpress.com/2019/07/federatedid-1.png?w=300 300w" sizes="(max-width: 515px) 100vw, 515px"></p>
<p>The authentication library in the RP top-level page communicates with the IP subframe (using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">postMessage</a> or the like) to get the logged-in user&#x2019;s identity information.</p>
<p>In&#xA0;<em>theory,</em>&#xA0;everything works great. The IP subframe in the RP page knows who the user is (by looking at its own cookies or <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage">HTML5 localStorage</a> or <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">indexedDB data</a>) and can release to the RP caller whatever identity information is appropriate.</p>
<p><em>Crucially</em>, however, notice that this login flow is entirely dependent upon the assumption that the IP subframe is accessing the same set of cookies, HTML5 storage, and/or indexedDB data as the top-level IP page. If the IP subframe&#xA0;<em>doesn&#x2019;t</em> have access to the same storage, then it won&#x2019;t recognize the user as logged in.</p>
<p>Unfortunately, this assumption has been problematic for many years, and it&#x2019;s becoming even more dangerous over time as browsers ramp up their security and privacy features.</p>
<p>The root of the problem is that the IP subframe is considered a <strong>third-party resource</strong>, because it comes from a different domain (identity.example) than the page (news.example) into which it is embedded.</p>
<p>For privacy and security reasons, browsers <em>might</em> treat third-party resources differently than first-party resources. Examples include:</p> <p>When a browser restricts access to storage for a 3rd party context, our <em>theoretically simple</em> login process falls apart. The IP subframe on the relying party doesn&#x2019;t see the user&#x2019;s login information because it is loaded in a 3rd party context. The authentication library is likely to conclude that the user is not logged in, and redirect them back to the login page. A frustrating and baffling infinite loop may result as the user is bounced between the RP and IP.</p>
<p>The <em>worst part&#xA0;</em>of all of this is that a site&#x2019;s login process might <em>usually&#xA0;</em>work, but fail depending on the user&#x2019;s browser choice, browser configuration, browser patch level, security zone assignments, or security/privacy extensions. As a result, a site owner <em>might not even notice </em>that some fraction of their users are unable to log in.</p>
<p>So, what&#x2019;s a web developer to do?</p>
<p>The first task is&#xA0;<em>awareness</em>: Understand how your federated login library works &#x2014; is it using cookies? Does it use subframes? Is the IP site likely to be considered a &#x201C;Tracker&#x201D; by <a href="https://disconnect.me/">popular privacy lists</a>?</p>
<p>The second task is to build designs that are more resilient to 3rd-party storage restrictions:</p>
<ul>
<li>Be sure to convey the <em>expected</em> state from the Identity Provider&#x2019;s login page back to the Relying Party. E.g. if your site automatically redirects from news.example to identity.example/login back to news.example/<strong>?loggedin=1</strong>, the RP page should take note of that URL parameter. If the authentication library still reports &#x201C;Not signed in&#x201D;, avoid an infinite loop and do not redirect back to the Identity Provider automatically.</li>
<li>Authentication libraries should consider conveying identity information back to the RP directly, which will then save that information in a first party context.For instance, the IP could send the identity data to the RP via a HTTP POST, and the RP could then store that data using its&#xA0;own&#xA0;<em>first party</em> cookies.</li>
<li>For browsers that support it, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage_Access_API">the Storage Access API</a>&#xA0;may be used to allow access to storage that would otherwise be unavailable in a 3rd-party context. Note that this API&#xA0;might require action on the part of the user (e.g. a frame click and a permission prompt).</li>
</ul>
<p>The final task is&#xA0;<em>verification:&#xA0;</em>Ensure that you&#x2019;re testing your site in modern browsers, with and without the privacy settings ratcheted up.</p>
<p>-Eric</p>
<p><sup>[1]</sup> P3P was removed from IE11 on Windows 10<br>
<sup>[2]</sup> In Windows 10 RS2, Edge 15 &#x201C;Spartan&#x201D; started sharing cookies across Security Zones, but HTML5 Storage and indexedDB remain partitioned.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>