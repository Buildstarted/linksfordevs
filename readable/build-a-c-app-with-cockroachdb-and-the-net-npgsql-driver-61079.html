<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Build a C# App with CockroachDB and the .NET Npgsql Driver - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Build a C# App with CockroachDB and the .NET Npgsql Driver - linksfor.dev(s)"/>
    <meta property="og:description" content="Learn how to use CockroachDB from a simple C# (.NET) application with a low-level client driver."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.cockroachlabs.com/docs/stable/build-a-csharp-app-with-cockroachdb.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Build a C# App with CockroachDB and the .NET Npgsql Driver</title>
<div class="readable">
        <h1>Build a C# App with CockroachDB and the .NET Npgsql Driver</h1>
            <div>Reading time: 20-26 minutes</div>
        <div>Posted here: 26 Apr 2020</div>
        <p><a href="https://www.cockroachlabs.com/docs/stable/build-a-csharp-app-with-cockroachdb.html">https://www.cockroachlabs.com/docs/stable/build-a-csharp-app-with-cockroachdb.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
  <!--
       TOC LEVEL: By default, a page TOC includes h2 and h3 headers. To limit a
       page TOC to h2 headers only, set `toc_not_nested: true` in the page's
       front-matter.
   -->
   
      
   

   

   

   <p>This tutorial shows you how build a simple C# application with CockroachDB and the .NET Npgsql driver.</p>

<p>We have tested the <a href="http://www.npgsql.org/">.NET Npgsql driver</a> enough to claim <strong>beta-level</strong> support. If you encounter problems, please <a href="https://github.com/cockroachdb/cockroach/issues/new">open an issue</a> with details to help us make progress toward full support.</p>

<h2 id="before-you-begin">Before you begin<a href="#before-you-begin" aria-label="Anchor link for: before you begin" data-anchorjs-icon=""></a></h2><ol>
<li><a href="https://www.cockroachlabs.com/docs/stable/install-cockroachdb.html">Install CockroachDB</a>.</li>
<li>Start up a <a href="https://www.cockroachlabs.com/docs/stable/secure-a-cluster.html">secure</a> or <a href="https://www.cockroachlabs.com/docs/stable/start-a-local-cluster.html">insecure</a> local cluster.</li>
<li>Choose the instructions that correspond to whether your cluster is secure or insecure:</li>
</ol>



<h2 id="step-1-create-a-net-project">Step 1. Create a .NET project<a href="#step-1-create-a-net-project" aria-label="Anchor link for: step 1 create a net project" data-anchorjs-icon=""></a></h2>

<div><pre><code data-lang="shell"><span></span>dotnet new console <span>-o</span> cockroachdb-test-app
</code></pre></div>


<p>The <code>dotnet</code> command creates a new app of type <code>console</code>. The <code>-o</code> parameter creates a directory named <code>cockroachdb-test-app</code> where your app will be stored and populates it with the required files. The <code>cd cockroachdb-test-app</code> command puts you into the newly created app directory.</p>

<h2 id="step-2-install-the-npgsql-driver">Step 2. Install the Npgsql driver<a href="#step-2-install-the-npgsql-driver" aria-label="Anchor link for: step 2 install the npgsql driver" data-anchorjs-icon=""></a></h2><p>Install the latest version of the <a href="https://www.nuget.org/packages/Npgsql/">Npgsql driver</a> into the .NET project using the built-in nuget package manager:</p>


<div><pre><code data-lang="shell"><span></span>dotnet add package Npgsql
</code></pre></div><section data-scope="secure">
<h2 id="step-3-create-the-maxroach-user-and-bank-database">Step 3. Create the <code>maxroach</code> user and <code>bank</code> database<a href="#step-3-create-the-maxroach-user-and-bank-database" aria-label="Anchor link for: step 3 create the maxroach user and bank database" data-anchorjs-icon=""></a></h2><i> </i><i> </i>

<p>Start the <a href="https://www.cockroachlabs.com/docs/stable/cockroach-sql.html">built-in SQL shell</a>:</p>


<div><pre><code data-lang="shell"><span></span>cockroach sql <span>--certs-dir</span><span>=</span>certs
</code></pre></div>
<p>In the SQL shell, issue the following statements to create the <code>maxroach</code> user and <code>bank</code> database:</p>


<div><pre><code data-lang="sql"><span></span><span>CREATE</span> <span>USER</span> <span>IF</span> <span>NOT</span> <span>EXISTS</span> <span>maxroach</span><span>;</span>
</code></pre></div>


<p>Give the <code>maxroach</code> user the necessary permissions:</p>


<div><pre><code data-lang="sql"><span></span><span>GRANT</span> <span>ALL</span> <span>ON</span> <span>DATABASE</span> <span>bank</span> <span>TO</span> <span>maxroach</span><span>;</span>
</code></pre></div>
<p>Exit the SQL shell:</p>



<h2 id="step-4-generate-a-certificate-for-the-maxroach-user">Step 4. Generate a certificate for the <code>maxroach</code> user<a href="#step-4-generate-a-certificate-for-the-maxroach-user" aria-label="Anchor link for: step 4 generate a certificate for the maxroach user" data-anchorjs-icon=""></a></h2><i> </i><i> </i>

<p>Create a certificate and key for the <code>maxroach</code> user by running the following command.  The code samples will run as this user.</p>


<div><pre><code data-lang="shell"><span></span>cockroach cert create-client maxroach <span>--certs-dir</span><span>=</span>certs <span>--ca-key</span><span>=</span>my-safe-directory/ca.key
</code></pre></div>
<h2 id="step-5-convert-the-key-file-for-use-by-c-programs">Step 5. Convert the key file for use by C# programs<a href="#step-5-convert-the-key-file-for-use-by-c-programs" aria-label="Anchor link for: step 5 convert the key file for use by c programs" data-anchorjs-icon=""></a></h2><i> </i><i> </i>

<p>The private key generated for user <code>maxroach</code> by CockroachDB is <a href="https://tools.ietf.org/html/rfc1421">PEM encoded</a>.  To read the key in a C# application, you will need to convert it into PKCS#12 format.</p>

<p>To convert the key to PKCS#12 format, run the following OpenSSL command on the <code>maxroach</code> user's key file in the directory where you stored your certificates:</p>


<div><pre><code data-lang="shell"><span></span>openssl pkcs12 <span>-inkey</span> client.maxroach.key <span>-password</span> pass: <span>-in</span> client.maxroach.crt <span>-export</span> <span>-out</span> client.maxroach.pfx
</code></pre></div>
<p>As of December 2018, you need to provide a password for this to work on macOS. See <a href="https://github.com/dotnet/corefx/issues/24225">https://github.com/dotnet/corefx/issues/24225</a>.</p>

<h2 id="step-6-run-the-c-code">Step 6. Run the C# code<a href="#step-6-run-the-c-code" aria-label="Anchor link for: step 6 run the c code" data-anchorjs-icon=""></a></h2><i> </i><i> </i>

<p>Now that you have created a database and set up encryption keys, in this section you will:</p>

<ul>
<li><a href="#basic-example">Create a table and insert some rows</a></li>
<li><a href="#transaction-example-with-retry-logic">Execute a batch of statements as a transaction</a></li>
</ul>

<h3 id="basic-example">Basic example<a href="#basic-example" aria-label="Anchor link for: basic example" data-anchorjs-icon=""></a></h3>

<p>Replace the contents of <code>cockroachdb-test-app/Program.cs</code> with the following code:</p>


<div><pre><code data-lang="csharp"><span>using</span> <span>System</span><span>;</span>
<span>using</span> <span>System.Data</span><span>;</span>
<span>using</span> <span>System.Security.Cryptography.X509Certificates</span><span>;</span>
<span>using</span> <span>System.Net.Security</span><span>;</span>
<span>using</span> <span>Npgsql</span><span>;</span>

<span>namespace</span> <span>Cockroach</span>
<span>{</span>
  <span>class</span> <span>MainClass</span>
  <span>{</span>
    <span>static</span> <span>void</span> <span>Main</span><span>(</span><span>string</span><span>[]</span> <span>args</span><span>)</span>
    <span>{</span>
      <span>var</span> <span>connStringBuilder</span> <span>=</span> <span>new</span> <span>NpgsqlConnectionStringBuilder</span><span>();</span>
      <span>connStringBuilder</span><span>.</span><span>Host</span> <span>=</span> <span>"localhost"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Port</span> <span>=</span> <span>26257</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>SslMode</span> <span>=</span> <span>SslMode</span><span>.</span><span>Require</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Username</span> <span>=</span> <span>"maxroach"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Database</span> <span>=</span> <span>"bank"</span><span>;</span>
      <span>Simple</span><span>(</span><span>connStringBuilder</span><span>.</span><span>ConnectionString</span><span>);</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>Simple</span><span>(</span><span>string</span> <span>connString</span><span>)</span>
    <span>{</span>
      <span>using</span> <span>(</span><span>var</span> <span>conn</span> <span>=</span> <span>new</span> <span>NpgsqlConnection</span><span>(</span><span>connString</span><span>))</span>
      <span>{</span>
        <span>conn</span><span>.</span><span>ProvideClientCertificatesCallback</span> <span>+=</span> <span>ProvideClientCertificatesCallback</span><span>;</span>
        <span>conn</span><span>.</span><span>UserCertificateValidationCallback</span> <span>+=</span> <span>UserCertificateValidationCallback</span><span>;</span>
        <span>conn</span><span>.</span><span>Open</span><span>();</span>

        <span>// Create the "accounts" table.</span>
        <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"CREATE TABLE IF NOT EXISTS accounts (id INT PRIMARY KEY, balance INT)"</span><span>,</span> <span>conn</span><span>).</span><span>ExecuteNonQuery</span><span>();</span>

        <span>// Insert two rows into the "accounts" table.</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>())</span>
        <span>{</span>
          <span>cmd</span><span>.</span><span>Connection</span> <span>=</span> <span>conn</span><span>;</span>
          <span>cmd</span><span>.</span><span>CommandText</span> <span>=</span> <span>"UPSERT INTO accounts(id, balance) VALUES(@id1, @val1), (@id2, @val2)"</span><span>;</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id1"</span><span>,</span> <span>1</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val1"</span><span>,</span> <span>1000</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id2"</span><span>,</span> <span>2</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val2"</span><span>,</span> <span>250</span><span>);</span>
          <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
        <span>}</span>

        <span>// Print out the balances.</span>
        <span>System</span><span>.</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>"Initial balances:"</span><span>);</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"SELECT id, balance FROM accounts"</span><span>,</span> <span>conn</span><span>))</span>
        <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
          <span>while</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
            <span>Console</span><span>.</span><span>Write</span><span>(</span><span>"	account {0}: {1}
"</span><span>,</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>0</span><span>),</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>1</span><span>));</span>
      <span>}</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>ProvideClientCertificatesCallback</span><span>(</span><span>X509CertificateCollection</span> <span>clientCerts</span><span>)</span>
    <span>{</span>
      <span>// To be able to add a certificate with a private key included, we must convert it to</span>
      <span>// a PKCS #12 format. The following openssl command does this:</span>
      <span>// openssl pkcs12 -password pass: -inkey client.maxroach.key -in client.maxroach.crt -export -out client.maxroach.pfx</span>
      <span>// As of 2018-12-10, you need to provide a password for this to work on macOS.</span>
      <span>// See https://github.com/dotnet/corefx/issues/24225</span>

      <span>// Note that the password used during X509 cert creation below</span>
      <span>// must match the password used in the openssl command above.</span>
      <span>clientCerts</span><span>.</span><span>Add</span><span>(</span><span>new</span> <span>X509Certificate2</span><span>(</span><span>"client.maxroach.pfx"</span><span>,</span> <span>"pass"</span><span>));</span>
    <span>}</span>

    <span>// By default, .Net does all of its certificate verification using the system certificate store.</span>
    <span>// This callback is necessary to validate the server certificate against a CA certificate file.</span>
    <span>static</span> <span>bool</span> <span>UserCertificateValidationCallback</span><span>(</span><span>object</span> <span>sender</span><span>,</span> <span>X509Certificate</span> <span>certificate</span><span>,</span> <span>X509Chain</span> <span>defaultChain</span><span>,</span> <span>SslPolicyErrors</span> <span>defaultErrors</span><span>)</span>
    <span>{</span>
      <span>X509Certificate2</span> <span>caCert</span> <span>=</span> <span>new</span> <span>X509Certificate2</span><span>(</span><span>"ca.crt"</span><span>);</span>
      <span>X509Chain</span> <span>caCertChain</span> <span>=</span> <span>new</span> <span>X509Chain</span><span>();</span>
      <span>caCertChain</span><span>.</span><span>ChainPolicy</span> <span>=</span> <span>new</span> <span>X509ChainPolicy</span><span>()</span>
      <span>{</span>
        <span>RevocationMode</span> <span>=</span> <span>X509RevocationMode</span><span>.</span><span>NoCheck</span><span>,</span>
        <span>RevocationFlag</span> <span>=</span> <span>X509RevocationFlag</span><span>.</span><span>EntireChain</span>
      <span>};</span>
      <span>caCertChain</span><span>.</span><span>ChainPolicy</span><span>.</span><span>ExtraStore</span><span>.</span><span>Add</span><span>(</span><span>caCert</span><span>);</span>

      <span>X509Certificate2</span> <span>serverCert</span> <span>=</span> <span>new</span> <span>X509Certificate2</span><span>(</span><span>certificate</span><span>);</span>

      <span>caCertChain</span><span>.</span><span>Build</span><span>(</span><span>serverCert</span><span>);</span>
      <span>if</span> <span>(</span><span>caCertChain</span><span>.</span><span>ChainStatus</span><span>.</span><span>Length</span> <span>==</span> <span>0</span><span>)</span>
      <span>{</span>
        <span>// No errors</span>
        <span>return</span> <span>true</span><span>;</span>
      <span>}</span>

      <span>foreach</span> <span>(</span><span>X509ChainStatus</span> <span>status</span> <span>in</span> <span>caCertChain</span><span>.</span><span>ChainStatus</span><span>)</span>
      <span>{</span>
        <span>// Check if we got any errors other than UntrustedRoot (which we will always get if we don't install the CA cert to the system store)</span>
        <span>if</span> <span>(</span><span>status</span><span>.</span><span>Status</span> <span>!=</span> <span>X509ChainStatusFlags</span><span>.</span><span>UntrustedRoot</span><span>)</span>
        <span>{</span>
          <span>return</span> <span>false</span><span>;</span>
        <span>}</span>
      <span>}</span>
      <span>return</span> <span>true</span><span>;</span>
    <span>}</span>

  <span>}</span>
<span>}</span>

</code></pre></div>
<p>Then, run the code to connect as the <code>maxroach</code> user.  This time, execute a batch of statements as an atomic transaction to transfer funds from one account to another, where all included statements are either committed or aborted:</p>



<p>The output should be:</p>
<div><pre><code data-lang="">Initial balances:
    account 1: 1000
    account 2: 250
</code></pre></div>
<h3 id="transaction-example-with-retry-logic">Transaction example (with retry logic)<a href="#transaction-example-with-retry-logic" aria-label="Anchor link for: transaction example with retry logic" data-anchorjs-icon=""></a></h3>

<p>Open <code>cockroachdb-test-app/Program.cs</code> again and replace the contents with the code shown below.</p>
<div><p>Note:</p>

<p>With the default <code>SERIALIZABLE</code> <a href="https://www.cockroachlabs.com/docs/stable/transactions.html#isolation-levels">isolation level</a>, CockroachDB may require the client to <a href="https://www.cockroachlabs.com/docs/stable/transactions.html#transaction-retries">retry a transaction</a> in case of read/write contention. CockroachDB provides a <a href="https://www.cockroachlabs.com/docs/stable/transactions.html#client-side-intervention">generic retry function</a> that runs inside a transaction and retries it as needed. The code sample below shows how it is used.
</p></div>


<div><pre><code data-lang="csharp"><span>using</span> <span>System</span><span>;</span>
<span>using</span> <span>System.Data</span><span>;</span>
<span>using</span> <span>System.Security.Cryptography.X509Certificates</span><span>;</span>
<span>using</span> <span>System.Net.Security</span><span>;</span>
<span>using</span> <span>Npgsql</span><span>;</span>

<span>namespace</span> <span>Cockroach</span>
<span>{</span>
  <span>class</span> <span>MainClass</span>
  <span>{</span>
    <span>static</span> <span>void</span> <span>Main</span><span>(</span><span>string</span><span>[]</span> <span>args</span><span>)</span>
    <span>{</span>
      <span>var</span> <span>connStringBuilder</span> <span>=</span> <span>new</span> <span>NpgsqlConnectionStringBuilder</span><span>();</span>
      <span>connStringBuilder</span><span>.</span><span>Host</span> <span>=</span> <span>"localhost"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Port</span> <span>=</span> <span>26257</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>SslMode</span> <span>=</span> <span>SslMode</span><span>.</span><span>Require</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Username</span> <span>=</span> <span>"maxroach"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Database</span> <span>=</span> <span>"bank"</span><span>;</span>
      <span>TxnSample</span><span>(</span><span>connStringBuilder</span><span>.</span><span>ConnectionString</span><span>);</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>TransferFunds</span><span>(</span><span>NpgsqlConnection</span> <span>conn</span><span>,</span> <span>NpgsqlTransaction</span> <span>tran</span><span>,</span> <span>int</span> <span>from</span><span>,</span> <span>int</span> <span>to</span><span>,</span> <span>int</span> <span>amount</span><span>)</span>
    <span>{</span>
      <span>int</span> <span>balance</span> <span>=</span> <span>0</span><span>;</span>
      <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"SELECT balance FROM accounts WHERE id = {0}"</span><span>,</span> <span>from</span><span>),</span> <span>conn</span><span>,</span> <span>tran</span><span>))</span>
      <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
      <span>{</span>
        <span>if</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
        <span>{</span>
          <span>balance</span> <span>=</span> <span>reader</span><span>.</span><span>GetInt32</span><span>(</span><span>0</span><span>);</span>
        <span>}</span>
        <span>else</span>
        <span>{</span>
          <span>throw</span> <span>new</span> <span>DataException</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"Account id={0} not found"</span><span>,</span> <span>from</span><span>));</span>
        <span>}</span>
      <span>}</span>
      <span>if</span> <span>(</span><span>balance</span> <span>&lt;</span> <span>amount</span><span>)</span>
      <span>{</span>
        <span>throw</span> <span>new</span> <span>DataException</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"Insufficient balance in account id={0}"</span><span>,</span> <span>from</span><span>));</span>
      <span>}</span>
      <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"UPDATE accounts SET balance = balance - {0} where id = {1}"</span><span>,</span> <span>amount</span><span>,</span> <span>from</span><span>),</span> <span>conn</span><span>,</span> <span>tran</span><span>))</span>
      <span>{</span>
        <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
      <span>}</span>
      <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"UPDATE accounts SET balance = balance + {0} where id = {1}"</span><span>,</span> <span>amount</span><span>,</span> <span>to</span><span>),</span> <span>conn</span><span>,</span> <span>tran</span><span>))</span>
      <span>{</span>
        <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
      <span>}</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>TxnSample</span><span>(</span><span>string</span> <span>connString</span><span>)</span>
    <span>{</span>
      <span>using</span> <span>(</span><span>var</span> <span>conn</span> <span>=</span> <span>new</span> <span>NpgsqlConnection</span><span>(</span><span>connString</span><span>))</span>
      <span>{</span>
        <span>conn</span><span>.</span><span>ProvideClientCertificatesCallback</span> <span>+=</span> <span>ProvideClientCertificatesCallback</span><span>;</span>
        <span>conn</span><span>.</span><span>UserCertificateValidationCallback</span> <span>+=</span> <span>UserCertificateValidationCallback</span><span>;</span>

        <span>conn</span><span>.</span><span>Open</span><span>();</span>

        <span>// Create the "accounts" table.</span>
        <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"CREATE TABLE IF NOT EXISTS accounts (id INT PRIMARY KEY, balance INT)"</span><span>,</span> <span>conn</span><span>).</span><span>ExecuteNonQuery</span><span>();</span>

        <span>// Insert two rows into the "accounts" table.</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>())</span>
        <span>{</span>
          <span>cmd</span><span>.</span><span>Connection</span> <span>=</span> <span>conn</span><span>;</span>
          <span>cmd</span><span>.</span><span>CommandText</span> <span>=</span> <span>"UPSERT INTO accounts(id, balance) VALUES(@id1, @val1), (@id2, @val2)"</span><span>;</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id1"</span><span>,</span> <span>1</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val1"</span><span>,</span> <span>1000</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id2"</span><span>,</span> <span>2</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val2"</span><span>,</span> <span>250</span><span>);</span>
          <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
        <span>}</span>

        <span>// Print out the balances.</span>
        <span>System</span><span>.</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>"Initial balances:"</span><span>);</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"SELECT id, balance FROM accounts"</span><span>,</span> <span>conn</span><span>))</span>
        <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
        <span>while</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
          <span>Console</span><span>.</span><span>Write</span><span>(</span><span>"	account {0}: {1}
"</span><span>,</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>0</span><span>),</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>1</span><span>));</span>

        <span>try</span>
        <span>{</span>
          <span>using</span> <span>(</span><span>var</span> <span>tran</span> <span>=</span> <span>conn</span><span>.</span><span>BeginTransaction</span><span>())</span>
          <span>{</span>
            <span>tran</span><span>.</span><span>Save</span><span>(</span><span>"cockroach_restart"</span><span>);</span>
            <span>while</span> <span>(</span><span>true</span><span>)</span>
            <span>{</span>
              <span>try</span>
              <span>{</span>
                <span>TransferFunds</span><span>(</span><span>conn</span><span>,</span> <span>tran</span><span>,</span> <span>1</span><span>,</span> <span>2</span><span>,</span> <span>100</span><span>);</span>
                <span>tran</span><span>.</span><span>Commit</span><span>();</span>
                <span>break</span><span>;</span>
              <span>}</span>
              <span>catch</span> <span>(</span><span>NpgsqlException</span> <span>e</span><span>)</span>
              <span>{</span>
                <span>// Check if the error code indicates a SERIALIZATION_FAILURE.</span>
                <span>if</span> <span>(</span><span>e</span><span>.</span><span>ErrorCode</span> <span>==</span> <span>40001</span><span>)</span>
                <span>{</span>
                  <span>// Signal the database that we will attempt a retry.</span>
                  <span>tran</span><span>.</span><span>Rollback</span><span>(</span><span>"cockroach_restart"</span><span>);</span>
                <span>}</span>
                <span>else</span>
                <span>{</span>
                  <span>throw</span><span>;</span>
                <span>}</span>
              <span>}</span>
            <span>}</span>
          <span>}</span>
        <span>}</span>
        <span>catch</span> <span>(</span><span>DataException</span> <span>e</span><span>)</span>
        <span>{</span>
          <span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>e</span><span>.</span><span>Message</span><span>);</span>
        <span>}</span>

        <span>// Now printout the results.</span>
        <span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>"Final balances:"</span><span>);</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"SELECT id, balance FROM accounts"</span><span>,</span> <span>conn</span><span>))</span>
        <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
        <span>while</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
          <span>Console</span><span>.</span><span>Write</span><span>(</span><span>"	account {0}: {1}
"</span><span>,</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>0</span><span>),</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>1</span><span>));</span>
      <span>}</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>ProvideClientCertificatesCallback</span><span>(</span><span>X509CertificateCollection</span> <span>clientCerts</span><span>)</span>
    <span>{</span>
      <span>// To be able to add a certificate with a private key included, we must convert it to</span>
      <span>// a PKCS #12 format. The following openssl command does this:</span>
      <span>// openssl pkcs12 -inkey client.maxroach.key -in client.maxroach.crt -export -out client.maxroach.pfx</span>
      <span>// As of 2018-12-10, you need to provide a password for this to work on macOS.</span>
      <span>// See https://github.com/dotnet/corefx/issues/24225</span>
      <span>clientCerts</span><span>.</span><span>Add</span><span>(</span><span>new</span> <span>X509Certificate2</span><span>(</span><span>"client.maxroach.pfx"</span><span>,</span> <span>"pass"</span><span>));</span>
    <span>}</span>

    <span>// By default, .Net does all of its certificate verification using the system certificate store.</span>
    <span>// This callback is necessary to validate the server certificate against a CA certificate file.</span>
    <span>static</span> <span>bool</span> <span>UserCertificateValidationCallback</span><span>(</span><span>object</span> <span>sender</span><span>,</span> <span>X509Certificate</span> <span>certificate</span><span>,</span> <span>X509Chain</span> <span>defaultChain</span><span>,</span> <span>SslPolicyErrors</span> <span>defaultErrors</span><span>)</span>
    <span>{</span>
      <span>X509Certificate2</span> <span>caCert</span> <span>=</span> <span>new</span> <span>X509Certificate2</span><span>(</span><span>"ca.crt"</span><span>);</span>
      <span>X509Chain</span> <span>caCertChain</span> <span>=</span> <span>new</span> <span>X509Chain</span><span>();</span>
      <span>caCertChain</span><span>.</span><span>ChainPolicy</span> <span>=</span> <span>new</span> <span>X509ChainPolicy</span><span>()</span>
      <span>{</span>
        <span>RevocationMode</span> <span>=</span> <span>X509RevocationMode</span><span>.</span><span>NoCheck</span><span>,</span>
        <span>RevocationFlag</span> <span>=</span> <span>X509RevocationFlag</span><span>.</span><span>EntireChain</span>
      <span>};</span>
      <span>caCertChain</span><span>.</span><span>ChainPolicy</span><span>.</span><span>ExtraStore</span><span>.</span><span>Add</span><span>(</span><span>caCert</span><span>);</span>

      <span>X509Certificate2</span> <span>serverCert</span> <span>=</span> <span>new</span> <span>X509Certificate2</span><span>(</span><span>certificate</span><span>);</span>

      <span>caCertChain</span><span>.</span><span>Build</span><span>(</span><span>serverCert</span><span>);</span>
      <span>if</span> <span>(</span><span>caCertChain</span><span>.</span><span>ChainStatus</span><span>.</span><span>Length</span> <span>==</span> <span>0</span><span>)</span>
      <span>{</span>
        <span>// No errors</span>
        <span>return</span> <span>true</span><span>;</span>
      <span>}</span>

      <span>foreach</span> <span>(</span><span>X509ChainStatus</span> <span>status</span> <span>in</span> <span>caCertChain</span><span>.</span><span>ChainStatus</span><span>)</span>
      <span>{</span>
        <span>// Check if we got any errors other than UntrustedRoot (which we will always get if we don't install the CA cert to the system store)</span>
        <span>if</span> <span>(</span><span>status</span><span>.</span><span>Status</span> <span>!=</span> <span>X509ChainStatusFlags</span><span>.</span><span>UntrustedRoot</span><span>)</span>
        <span>{</span>
          <span>return</span> <span>false</span><span>;</span>
        <span>}</span>
      <span>}</span>
      <span>return</span> <span>true</span><span>;</span>      
    <span>}</span>
  <span>}</span>
<span>}</span>

</code></pre></div>
<p>Then, run the code to connect as the <code>maxroach</code> user.  This time, execute a batch of statements as an atomic transaction to transfer funds from one account to another, where all included statements are either committed or aborted:</p>



<p>The output should be:</p>
<div><pre><code data-lang="">Initial balances:
    account 1: 1000
    account 2: 250
Final balances:
    account 1: 900
    account 2: 350
</code></pre></div>
<p>However, if you want to verify that funds were transferred from one account to another, use the <a href="https://www.cockroachlabs.com/docs/stable/cockroach-sql.html">built-in SQL client</a>:</p>


<div><pre><code data-lang="shell"><span></span>cockroach sql <span>--certs-dir</span><span>=</span>certs <span>--database</span><span>=</span>bank <span>-e</span> <span>'SELECT id, balance FROM accounts'</span>
</code></pre></div><div><pre><code data-lang="">  id | balance
+----+---------+
   1 |     900
   2 |     350
(2 rows)
</code></pre></div></section><section data-scope="insecure">
<h2 id="step-3-create-the-maxroach-user-and-bank-database">Step 3. Create the <code>maxroach</code> user and <code>bank</code> database<a href="#step-3-create-the-maxroach-user-and-bank-database" aria-label="Anchor link for: step 3 create the maxroach user and bank database" data-anchorjs-icon=""></a></h2>

<p>Start the <a href="https://www.cockroachlabs.com/docs/stable/cockroach-sql.html">built-in SQL shell</a>:</p>



<p>In the SQL shell, issue the following statements to create the <code>maxroach</code> user and <code>bank</code> database:</p>


<div><pre><code data-lang="sql"><span></span><span>CREATE</span> <span>USER</span> <span>IF</span> <span>NOT</span> <span>EXISTS</span> <span>maxroach</span><span>;</span>
</code></pre></div>


<p>Give the <code>maxroach</code> user the necessary permissions:</p>


<div><pre><code data-lang="sql"><span></span><span>GRANT</span> <span>ALL</span> <span>ON</span> <span>DATABASE</span> <span>bank</span> <span>TO</span> <span>maxroach</span><span>;</span>
</code></pre></div>
<p>Exit the SQL shell:</p>



<h2 id="step-4-run-the-c-code">Step 4. Run the C# code<a href="#step-4-run-the-c-code" aria-label="Anchor link for: step 4 run the c code" data-anchorjs-icon=""></a></h2>

<p>Now that you have created a database and set up encryption keys, in this section you will:</p>

<ul>
<li><a href="#basic2">Create a table and insert some rows</a></li>
<li><a href="#transaction2">Execute a batch of statements as a transaction</a></li>
</ul>



<h3 id="basic-example">Basic example<a href="#basic-example" aria-label="Anchor link for: basic example" data-anchorjs-icon=""></a></h3>

<p>Replace the contents of <code>cockroachdb-test-app/Program.cs</code> with the following code:</p>


<div><pre><code data-lang="csharp"><span>using</span> <span>System</span><span>;</span>
<span>using</span> <span>System.Data</span><span>;</span>
<span>using</span> <span>Npgsql</span><span>;</span>

<span>namespace</span> <span>Cockroach</span>
<span>{</span>
  <span>class</span> <span>MainClass</span>
  <span>{</span>
    <span>static</span> <span>void</span> <span>Main</span><span>(</span><span>string</span><span>[]</span> <span>args</span><span>)</span>
    <span>{</span>
      <span>var</span> <span>connStringBuilder</span> <span>=</span> <span>new</span> <span>NpgsqlConnectionStringBuilder</span><span>();</span>
      <span>connStringBuilder</span><span>.</span><span>Host</span> <span>=</span> <span>"localhost"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Port</span> <span>=</span> <span>26257</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>SslMode</span> <span>=</span> <span>SslMode</span><span>.</span><span>Disable</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Username</span> <span>=</span> <span>"maxroach"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Database</span> <span>=</span> <span>"bank"</span><span>;</span>
      <span>Simple</span><span>(</span><span>connStringBuilder</span><span>.</span><span>ConnectionString</span><span>);</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>Simple</span><span>(</span><span>string</span> <span>connString</span><span>)</span>
    <span>{</span>
      <span>using</span> <span>(</span><span>var</span> <span>conn</span> <span>=</span> <span>new</span> <span>NpgsqlConnection</span><span>(</span><span>connString</span><span>))</span>
      <span>{</span>
        <span>conn</span><span>.</span><span>Open</span><span>();</span>

        <span>// Create the "accounts" table.</span>
        <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"CREATE TABLE IF NOT EXISTS accounts (id INT PRIMARY KEY, balance INT)"</span><span>,</span> <span>conn</span><span>).</span><span>ExecuteNonQuery</span><span>();</span>

        <span>// Insert two rows into the "accounts" table.</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>())</span>
        <span>{</span>
          <span>cmd</span><span>.</span><span>Connection</span> <span>=</span> <span>conn</span><span>;</span>
          <span>cmd</span><span>.</span><span>CommandText</span> <span>=</span> <span>"UPSERT INTO accounts(id, balance) VALUES(@id1, @val1), (@id2, @val2)"</span><span>;</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id1"</span><span>,</span> <span>1</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val1"</span><span>,</span> <span>1000</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id2"</span><span>,</span> <span>2</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val2"</span><span>,</span> <span>250</span><span>);</span>
          <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
        <span>}</span>

        <span>// Print out the balances.</span>
        <span>System</span><span>.</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>"Initial balances:"</span><span>);</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"SELECT id, balance FROM accounts"</span><span>,</span> <span>conn</span><span>))</span>
        <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
          <span>while</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
            <span>Console</span><span>.</span><span>Write</span><span>(</span><span>"	account {0}: {1}
"</span><span>,</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>0</span><span>),</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>1</span><span>));</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
<span>}</span>

</code></pre></div>
<p>Then, run the code to connect as the <code>maxroach</code> user and execute some basic SQL statements: creating a table, inserting rows, and reading and printing the rows:</p>



<p>The output should be:</p>
<div><pre><code data-lang="">Initial balances:
    account 1: 1000
    account 2: 250
</code></pre></div>


<h3 id="transaction-example-with-retry-logic">Transaction example (with retry logic)<a href="#transaction-example-with-retry-logic" aria-label="Anchor link for: transaction example with retry logic" data-anchorjs-icon=""></a></h3>

<p>Open <code>cockroachdb-test-app/Program.cs</code> again and replace the contents with the code shown below.</p>
<div><p>Note:</p>

<p>With the default <code>SERIALIZABLE</code> <a href="https://www.cockroachlabs.com/docs/stable/transactions.html#isolation-levels">isolation level</a>, CockroachDB may require the client to <a href="https://www.cockroachlabs.com/docs/stable/transactions.html#transaction-retries">retry a transaction</a> in case of read/write contention. CockroachDB provides a <a href="https://www.cockroachlabs.com/docs/stable/transactions.html#client-side-intervention">generic retry function</a> that runs inside a transaction and retries it as needed. The code sample below shows how it is used.
</p></div>


<div><pre><code data-lang="csharp"><span>using</span> <span>System</span><span>;</span>
<span>using</span> <span>System.Data</span><span>;</span>
<span>using</span> <span>Npgsql</span><span>;</span>

<span>namespace</span> <span>Cockroach</span>
<span>{</span>
  <span>class</span> <span>MainClass</span>
  <span>{</span>
    <span>static</span> <span>void</span> <span>Main</span><span>(</span><span>string</span><span>[]</span> <span>args</span><span>)</span>
    <span>{</span>
      <span>var</span> <span>connStringBuilder</span> <span>=</span> <span>new</span> <span>NpgsqlConnectionStringBuilder</span><span>();</span>
      <span>connStringBuilder</span><span>.</span><span>Host</span> <span>=</span> <span>"localhost"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Port</span> <span>=</span> <span>26257</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>SslMode</span> <span>=</span> <span>SslMode</span><span>.</span><span>Disable</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Username</span> <span>=</span> <span>"maxroach"</span><span>;</span>
      <span>connStringBuilder</span><span>.</span><span>Database</span> <span>=</span> <span>"bank"</span><span>;</span>
      <span>TxnSample</span><span>(</span><span>connStringBuilder</span><span>.</span><span>ConnectionString</span><span>);</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>TransferFunds</span><span>(</span><span>NpgsqlConnection</span> <span>conn</span><span>,</span> <span>NpgsqlTransaction</span> <span>tran</span><span>,</span> <span>int</span> <span>from</span><span>,</span> <span>int</span> <span>to</span><span>,</span> <span>int</span> <span>amount</span><span>)</span>
    <span>{</span>
      <span>int</span> <span>balance</span> <span>=</span> <span>0</span><span>;</span>
      <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"SELECT balance FROM accounts WHERE id = {0}"</span><span>,</span> <span>from</span><span>),</span> <span>conn</span><span>,</span> <span>tran</span><span>))</span>
      <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
      <span>{</span>
        <span>if</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
        <span>{</span>
          <span>balance</span> <span>=</span> <span>reader</span><span>.</span><span>GetInt32</span><span>(</span><span>0</span><span>);</span>
        <span>}</span>
        <span>else</span>
        <span>{</span>
          <span>throw</span> <span>new</span> <span>DataException</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"Account id={0} not found"</span><span>,</span> <span>from</span><span>));</span>
        <span>}</span>
      <span>}</span>
      <span>if</span> <span>(</span><span>balance</span> <span>&lt;</span> <span>amount</span><span>)</span>
      <span>{</span>
        <span>throw</span> <span>new</span> <span>DataException</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"Insufficient balance in account id={0}"</span><span>,</span> <span>from</span><span>));</span>
      <span>}</span>
      <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"UPDATE accounts SET balance = balance - {0} where id = {1}"</span><span>,</span> <span>amount</span><span>,</span> <span>from</span><span>),</span> <span>conn</span><span>,</span> <span>tran</span><span>))</span>
      <span>{</span>
        <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
      <span>}</span>
      <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>String</span><span>.</span><span>Format</span><span>(</span><span>"UPDATE accounts SET balance = balance + {0} where id = {1}"</span><span>,</span> <span>amount</span><span>,</span> <span>to</span><span>),</span> <span>conn</span><span>,</span> <span>tran</span><span>))</span>
      <span>{</span>
        <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
      <span>}</span>
    <span>}</span>

    <span>static</span> <span>void</span> <span>TxnSample</span><span>(</span><span>string</span> <span>connString</span><span>)</span>
    <span>{</span>
      <span>using</span> <span>(</span><span>var</span> <span>conn</span> <span>=</span> <span>new</span> <span>NpgsqlConnection</span><span>(</span><span>connString</span><span>))</span>
      <span>{</span>
        <span>conn</span><span>.</span><span>Open</span><span>();</span>

        <span>// Create the "accounts" table.</span>
        <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"CREATE TABLE IF NOT EXISTS accounts (id INT PRIMARY KEY, balance INT)"</span><span>,</span> <span>conn</span><span>).</span><span>ExecuteNonQuery</span><span>();</span>

        <span>// Insert two rows into the "accounts" table.</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>())</span>
        <span>{</span>
          <span>cmd</span><span>.</span><span>Connection</span> <span>=</span> <span>conn</span><span>;</span>
          <span>cmd</span><span>.</span><span>CommandText</span> <span>=</span> <span>"UPSERT INTO accounts(id, balance) VALUES(@id1, @val1), (@id2, @val2)"</span><span>;</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id1"</span><span>,</span> <span>1</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val1"</span><span>,</span> <span>1000</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"id2"</span><span>,</span> <span>2</span><span>);</span>
          <span>cmd</span><span>.</span><span>Parameters</span><span>.</span><span>AddWithValue</span><span>(</span><span>"val2"</span><span>,</span> <span>250</span><span>);</span>
          <span>cmd</span><span>.</span><span>ExecuteNonQuery</span><span>();</span>
        <span>}</span>

        <span>// Print out the balances.</span>
        <span>System</span><span>.</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>"Initial balances:"</span><span>);</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"SELECT id, balance FROM accounts"</span><span>,</span> <span>conn</span><span>))</span>
        <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
        <span>while</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
          <span>Console</span><span>.</span><span>Write</span><span>(</span><span>"	account {0}: {1}
"</span><span>,</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>0</span><span>),</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>1</span><span>));</span>

        <span>try</span>
        <span>{</span>
          <span>using</span> <span>(</span><span>var</span> <span>tran</span> <span>=</span> <span>conn</span><span>.</span><span>BeginTransaction</span><span>())</span>
          <span>{</span>
            <span>tran</span><span>.</span><span>Save</span><span>(</span><span>"cockroach_restart"</span><span>);</span>
            <span>while</span> <span>(</span><span>true</span><span>)</span>
            <span>{</span>
              <span>try</span>
              <span>{</span>
                <span>TransferFunds</span><span>(</span><span>conn</span><span>,</span> <span>tran</span><span>,</span> <span>1</span><span>,</span> <span>2</span><span>,</span> <span>100</span><span>);</span>
                <span>tran</span><span>.</span><span>Commit</span><span>();</span>
                <span>break</span><span>;</span>
              <span>}</span>
              <span>catch</span> <span>(</span><span>NpgsqlException</span> <span>e</span><span>)</span>
              <span>{</span>
                <span>// Check if the error code indicates a SERIALIZATION_FAILURE.</span>
                <span>if</span> <span>(</span><span>e</span><span>.</span><span>ErrorCode</span> <span>==</span> <span>40001</span><span>)</span>
                <span>{</span>
                  <span>// Signal the database that we will attempt a retry.</span>
                  <span>tran</span><span>.</span><span>Rollback</span><span>(</span><span>"cockroach_restart"</span><span>);</span>
                <span>}</span>
                <span>else</span>
                <span>{</span>
                  <span>throw</span><span>;</span>
                <span>}</span>
              <span>}</span>
            <span>}</span>
          <span>}</span>
        <span>}</span>
        <span>catch</span> <span>(</span><span>DataException</span> <span>e</span><span>)</span>
        <span>{</span>
          <span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>e</span><span>.</span><span>Message</span><span>);</span>
        <span>}</span>

        <span>// Now printout the results.</span>
        <span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>"Final balances:"</span><span>);</span>
        <span>using</span> <span>(</span><span>var</span> <span>cmd</span> <span>=</span> <span>new</span> <span>NpgsqlCommand</span><span>(</span><span>"SELECT id, balance FROM accounts"</span><span>,</span> <span>conn</span><span>))</span>
        <span>using</span> <span>(</span><span>var</span> <span>reader</span> <span>=</span> <span>cmd</span><span>.</span><span>ExecuteReader</span><span>())</span>
        <span>while</span> <span>(</span><span>reader</span><span>.</span><span>Read</span><span>())</span>
          <span>Console</span><span>.</span><span>Write</span><span>(</span><span>"	account {0}: {1}
"</span><span>,</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>0</span><span>),</span> <span>reader</span><span>.</span><span>GetValue</span><span>(</span><span>1</span><span>));</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
<span>}</span>

</code></pre></div>
<p>Then, run the code to connect as the <code>maxroach</code> user.  This time, execute a batch of statements as an atomic transaction to transfer funds from one account to another, where all included statements are either committed or aborted:</p>



<p>The output should be:</p>
<div><pre><code data-lang="">Initial balances:
    account 1: 1000
    account 2: 250
Final balances:
    account 1: 900
    account 2: 350
</code></pre></div>
<p>However, if you want to verify that funds were transferred from one account to another, use the <a href="https://www.cockroachlabs.com/docs/stable/cockroach-sql.html">built-in SQL client</a>:</p>


<div><pre><code data-lang="shell"><span></span>cockroach sql <span>--insecure</span>  <span>--database</span><span>=</span>bank <span>-e</span> <span>'SELECT id, balance FROM accounts'</span>
</code></pre></div><div><pre><code data-lang="">  id | balance
+----+---------+
   1 |     900
   2 |     350
(2 rows)
</code></pre></div></section>
<h2 id="whats-next">What's next?<a href="#whats-next" aria-label="Anchor link for: whats next" data-anchorjs-icon=""></a></h2><p>Read more about using the <a href="http://www.npgsql.org/">.NET Npgsql driver</a>.</p>

<p>You might also be interested in the following pages:</p>

<ul>
<li><a href="https://www.cockroachlabs.com/docs/stable/connection-parameters.html">Client Connection Parameters</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/demo-data-replication.html">Data Replication</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/demo-fault-tolerance-and-recovery.html">Fault Tolerance &amp; Recovery</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/demo-automatic-rebalancing.html">Automatic Rebalancing</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/demo-automatic-cloud-migration.html">Cross-Cloud Migration</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/demo-follow-the-workload.html">Follow-the-Workload</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/orchestrate-a-local-cluster-with-kubernetes-insecure.html">Automated Operations</a></li>
</ul>


   
      <div id="feedback-prompt">
  <p>Was this page helpful?</p>
  <p><a href="#yes-feedback" id="yes-button" data-proofer-ignore="">Yes</a>
  <a href="#no-feedback" id="no-button" data-proofer-ignore="">No</a>
</p></div>



   

</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>