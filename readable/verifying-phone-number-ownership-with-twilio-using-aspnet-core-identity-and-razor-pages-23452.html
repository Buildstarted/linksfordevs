<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Verifying phone number ownership with Twilio using ASP.NET Core Identity and Razor Pages - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Verifying phone number ownership with Twilio using ASP.NET Core Identity and Razor Pages - linksfor.dev(s)"/>
    <meta property="og:description" content="In this post I show how to verify phone number ownership with Twilio&#x27;s Verify API in a Razor Pages app that uses ASP.NET Core Identity for user management"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://andrewlock.net/verifying-phone-number-ownership-with-twilio-using-asp-net-core-identity-and-razor-pages/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Verifying phone number ownership with Twilio using ASP.NET Core Identity and Razor Pages</title>
<div class="readable">
        <h1>Verifying phone number ownership with Twilio using ASP.NET Core Identity and Razor Pages</h1>
            <div>Reading time: 23-29 minutes</div>
        <div>Posted here: 14 May 2019</div>
        <p><a href="https://andrewlock.net/verifying-phone-number-ownership-with-twilio-using-asp-net-core-identity-and-razor-pages/">https://andrewlock.net/verifying-phone-number-ownership-with-twilio-using-asp-net-core-identity-and-razor-pages/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
<p>ASP.NET Core Identity is a membership system that adds user sign in and user management functionality to ASP.NET Core apps. It includes many features out of the box and has basic support for storing a phone number for a user. By default, ASP.NET Core Identity doesn't try to verify ownership of phone numbers, but you can add that functionality yourself by integrating Twilio’s identity verification features into your application.</p>
<p>In this post you'll learn how you can prove ownership of a phone number provided by a user using <a href="https://www.twilio.com/verify">Twilio Verify</a> in an ASP.NET Core application using Razor Pages. This involves sending a code in an SMS message to the provided phone number. The user enters the code received and Twilio confirms whether it is correct. If so, you can be confident the user has control of the provided phone number.</p>
<p>You typically only confirm phone number ownership once for a user. This is in contrast to two-factor authentication (2FA) where you might send an SMS code to the user every time they login. Twilio has a <a href="https://www.twilio.com/docs/authy">separate Authy API</a> for performing 2FA checks at login, but it won't be covered in this post. </p>
<blockquote>
<p>Note that this post uses <a href="https://www.twilio.com/docs/verify">version 1</a> of the Twilio Verify API. <a href="https://www.twilio.com/docs/verify/api-beta/migrating-1x-2x">Version 2.x of the API is currently in Beta</a>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites<a href="#prerequisites"></a></h2>
<p>To follow along with this post you'll need:</p>
<ul>
<li>A Twilio account (<a href="https://www.twilio.com/try-twilio">sign up for a free Twilio account here</a>)</li>
<li>A Twilio Verify Application (<a href="https://www.twilio.com/console/verify/applications">create a new Verify application here</a>)</li>
<li>.NET Core 2.2 SDK (<a href="https://dotnet.microsoft.com/download">version 2.2.102 or greater</a>)</li>
<li><a href="https://code.visualstudio.com/">VS Code</a>, <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 2017</a>, or other editor</li>
<li>A familiarity with Razor Pages (see a previous post for <a href="https://www.twilio.com/blog/introduction-asp-net-core-razor-pages">an introduction to Razor Pages</a>)</li>
</ul>
<p>You can find the complete code for this post <a href="https://github.com/andrewlock/TwilioSamples/tree/master/SendVerificationSmsDemo">on GitHub</a>.</p>
<h2 id="creating-the-case-study-project">Creating the case study project<a href="#creating-the-case-study-project"></a></h2>
<p>Using Visual Studio 2017+ or the .NET CLI, create a new solution and project with the following characteristics: </p>
<ul>
<li>Type: ASP.NET Core 2.2 Web Application (not MVC) with Visual C#</li>
<li>Name: SendVerificationSmsDemo</li>
<li>Solution directory</li>
<li>Git repository</li>
<li>https</li>
<li>Authentication: Individual user accounts, Store user accounts in-app</li>
</ul>
<p>ASP.NET Core Identity uses Entity Framework Core to store the users in the database, so be sure to run the database migrations in the project folder after building your app. Execute one of the following command line instructions to build the database:</p>
<p><strong>.NET CLI</strong></p>
<pre><code>dotnet ef database update
</code></pre>
<p><strong>Package Manager Console</strong></p>
<pre><code>update<span>-</span>database
</code></pre>
<h2 id="the-twilio-c-sdk-and-the-twilio-verify-api">The Twilio C# SDK and the Twilio Verify API<a href="#the-twilio-c-sdk-and-the-twilio-verify-api"></a></h2>
<p>The Twilio API is a typical REST API, but to make it easier to work with Twilio provides helper SDK libraries in a variety of languages. Previous posts have shown how to use the C# SDK <a href="https://www.twilio.com/blog/validate-phone-numbers-asp-net-core-identity-razor-pages-lookup">to validate phone numbers</a>, and <a href="https://www.twilio.com/blog/dependency-injection-twilio-sms-asp-net-core-2-1">how to customize it to work with the ASP.NET Core dependency injection container</a>.</p>
<p>Unfortunately, the C# SDK doesn't support the current version of the Twilio Verify API (v1.x), so you have to fall back to making "raw" HTTP requests with an <code>HttpClient</code>. The basic code required to do so is <a href="https://www.twilio.com/docs/verify/api/verification">described in the documentation</a>, but for conciseness it uses a bad practice: it creates an <code>HttpClient</code> manually in the code. </p>
<p>In ASP.NET Core 2.1 and above, you should use <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-requests"><code>HttpClientFactory</code></a> wherever possible. This class manages the lifetime of the underlying handlers and sockets for you, and so avoids performance issues you can hit at times of high load. You can learn about using <code>HttpClientFactory</code> with the Twilio SDK in <a href="https://www.twilio.com/blog/dependency-injection-twilio-sms-asp-net-core-2-1">a previous post on the Twilio blog</a>.</p>
<h3 id="creating-a-typed-client-for-the-twilio-verify-api">Creating a Typed client for the Twilio Verify API<a href="#creating-a-typed-client-for-the-twilio-verify-api"></a></h3>
<p>To make it easier to work with the Verify API, and to support <code>HttpClientFactory</code>, you will create a small <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-2.2#typed-clients">Typed client</a>. Create the <em>TwilioVerifyClient.cs</em> file in the root of your project, and replace the contents with the following code:</p>
<pre><code><span>using</span> System<span>;</span>
<span>using</span> System<span>.</span>Collections<span>.</span>Generic<span>;</span>
<span>using</span> System<span>.</span>Net<span>.</span>Http<span>;</span>
<span>using</span> System<span>.</span>Threading<span>.</span>Tasks<span>;</span>
<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>WebUtilities<span>;</span>
<span>using</span> Newtonsoft<span>.</span>Json<span>;</span>

<span>namespace</span> SendVerificationSmsDemo
<span>{</span>
    <span>public</span> <span>class</span> <span>TwilioVerifyClient</span>
    <span>{</span>
        <span>private</span> <span>readonly</span> <span>HttpClient</span> _client<span>;</span>
        <span>public</span> <span>TwilioVerifyClient</span><span>(</span><span>HttpClient</span> client<span>)</span>
        <span>{</span>
            _client <span>=</span> client<span>;</span>
        <span>}</span>

        <span>public</span> <span>async</span> Task<span>&lt;</span>TwilioSendVerificationCodeResponse<span>&gt;</span> <span>StartVerification</span><span>(</span><span>int</span> countryCode<span>,</span> <span>string</span> phoneNumber<span>)</span>
        <span>{</span>
            <span>var</span> requestContent <span>=</span> <span>new</span> <span>FormUrlEncodedContent</span><span>(</span><span>new</span><span>[</span><span>]</span> <span>{</span>
                <span>new</span> <span><span>KeyValuePair</span><span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>&gt;</span></span><span>(</span><span>"via"</span><span>,</span> <span>"sms"</span><span>)</span><span>,</span>
                <span>new</span> <span><span>KeyValuePair</span><span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>&gt;</span></span><span>(</span><span>"country_code"</span><span>,</span> countryCode<span>.</span><span>ToString</span><span>(</span><span>)</span><span>)</span><span>,</span>
                <span>new</span> <span><span>KeyValuePair</span><span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>&gt;</span></span><span>(</span><span>"phone_number"</span><span>,</span> phoneNumber<span>)</span><span>,</span>
            <span>}</span><span>)</span><span>;</span>

            <span>var</span> response <span>=</span> <span>await</span> _client<span>.</span><span>PostAsync</span><span>(</span><span>"protected/json/phones/verification/start"</span><span>,</span> requestContent<span>)</span><span>;</span>

            <span>var</span> content <span>=</span> <span>await</span> response<span>.</span>Content<span>.</span><span>ReadAsStringAsync</span><span>(</span><span>)</span><span>;</span>

            
            <span>return</span> JsonConvert<span>.</span><span><span>DeserializeObject</span><span>&lt;</span><span>TwilioSendVerificationCodeResponse</span><span>&gt;</span></span><span>(</span>content<span>)</span><span>;</span>
        <span>}</span>

        <span>public</span> <span>async</span> Task<span>&lt;</span>TwilioCheckCodeResponse<span>&gt;</span> <span>CheckVerificationCode</span><span>(</span><span>int</span> countryCode<span>,</span> <span>string</span> phoneNumber<span>,</span> <span>string</span> verificationCode<span>)</span>
        <span>{</span>
            <span>var</span> queryParams <span>=</span> <span>new</span> <span><span>Dictionary</span><span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>&gt;</span></span><span>(</span><span>)</span>
            <span>{</span>
                <span>{</span><span>"country_code"</span><span>,</span> countryCode<span>.</span><span>ToString</span><span>(</span><span>)</span><span>}</span><span>,</span>
                <span>{</span><span>"phone_number"</span><span>,</span> phoneNumber<span>}</span><span>,</span>
                <span>{</span><span>"verification_code"</span><span>,</span> verificationCode <span>}</span><span>,</span>
            <span>}</span><span>;</span>

            <span>var</span> url <span>=</span> QueryHelpers<span>.</span><span>AddQueryString</span><span>(</span><span>"protected/json/phones/verification/check"</span><span>,</span> queryParams<span>)</span><span>;</span>

            <span>var</span> response <span>=</span> <span>await</span> _client<span>.</span><span>GetAsync</span><span>(</span>url<span>)</span><span>;</span>

            <span>var</span> content <span>=</span> <span>await</span> response<span>.</span>Content<span>.</span><span>ReadAsStringAsync</span><span>(</span><span>)</span><span>;</span>

            
            <span>return</span> JsonConvert<span>.</span><span><span>DeserializeObject</span><span>&lt;</span><span>TwilioCheckCodeResponse</span><span>&gt;</span></span><span>(</span>content<span>)</span><span>;</span>
        <span>}</span>

        <span>public</span> <span>class</span> <span>TwilioCheckCodeResponse</span>
        <span>{</span>
            <span>public</span> <span>string</span> Message <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
            <span>public</span> <span>bool</span> Success <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>}</span>

        <span>public</span> <span>class</span> <span>TwilioSendVerificationCodeResponse</span>
        <span>{</span>
            <span>public</span> <span>string</span> Carrier <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
            <span>public</span> <span>bool</span> IsCellphone <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
            <span>public</span> <span>string</span> Message <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
            <span>public</span> <span>string</span> SecondsToExpire <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
            <span>public</span> <span>Guid</span> Uuid <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
            <span>public</span> <span>bool</span> Success <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>The <code>TwilioVerifyClient</code> has two methods, <code>StartVerification()</code> and <code>CheckVerificationCode()</code>, which handle creating HTTP requests with the correct format and calling the Twilio Verify API. The typed client accepts an <code>HttpClient</code> in its constructor, which will be created by the <code>HttpClientFactory</code> automatically for you. </p>
<p>The responses for the method are implemented as simple POCO objects that match the response returned by the Twilio Verify API. For simplicity, these are implemented here as nested classes of the <code>TwilioVerifyClient</code>, but you can move these to another file if you prefer.</p>
<h3 id="configuring-authentication-for-the-typed-client">Configuring authentication for the typed client<a href="#configuring-authentication-for-the-typed-client"></a></h3>
<p><code>HttpClientFactory</code> is not part of the base ASP.NET Core libraries, so you need to install the <code>Microsoft.Extensions.Http</code> NuGet package (version 2.2.0 or later). You can use the NuGet Package Manager, Package Manager Console CLI, or edit the <em>SendVerificationSmsDemo.csproj</em> file. After using any of these methods the <code>&lt;ItemGroup&gt;</code> section of the project file should look like this (version numbers may be higher):</p>
<pre><code><span><span><span>&lt;</span>ItemGroup</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Microsoft.AspNetCore.App<span>"</span></span> <span>/&gt;</span></span>
  <span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Microsoft.AspNetCore.Razor.Design<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>2.2.0<span>"</span></span> <span>PrivateAssets</span><span><span>=</span><span>"</span>All<span>"</span></span> <span>/&gt;</span></span>
  <span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Microsoft.Extensions.Http<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>2.2.0<span>"</span></span> <span>/&gt;</span></span>
<span><span><span>&lt;/</span>ItemGroup</span><span>&gt;</span></span>
</code></pre>
<p>To call the Twilio Verify API you'll need the Authy API Key for your Verify application (found in the <a href="https://www.twilio.com/console/verify/applications">Twilio Dashboard</a>). When developing locally you should store this using the Secrets Manager so it doesn't get accidentally committed to your source code repository. You can read about how and why to do that in <a href="https://www.twilio.com/blog/2018/05/user-secrets-in-a-net-core-web-app.html">this post on the Twilio Blog</a>. Your resulting <em>secrets.json</em> should look something like this:</p>
<pre><code><span>{</span>
  <span>"Twilio"</span><span>:</span> <span>{</span>
    <span>"VerifyApiKey"</span><span>:</span> <span>"DBxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
<span>}</span>
</code></pre>
<p>Finally, configure your <code>TwilioVerifyClient</code> with the correct BaseAddress and your API key by adding the following at the end of <code>ConfigureServices</code> in <em>Startup.cs</em>:</p>
<pre><code><span>public</span> <span>void</span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    

    <span>var</span> apiKey <span>=</span> Configuration<span>[</span><span>"Twilio:VerifyApiKey"</span><span>]</span><span>;</span>

    services<span>.</span><span><span>AddHttpClient</span><span>&lt;</span><span>TwilioVerifyClient</span><span>&gt;</span></span><span>(</span>client <span>=</span><span>&gt;</span>
    <span>{</span>
        client<span>.</span>BaseAddress <span>=</span> <span>new</span> <span>Uri</span><span>(</span><span>"https://api.authy.com/"</span><span>)</span><span>;</span>
        client<span>.</span>DefaultRequestHeaders<span>.</span><span>Add</span><span>(</span><span>"X-Authy-API-Key"</span><span>,</span> apiKey<span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>
<span>}</span>
</code></pre>
<p>Don't let the <code>authy</code> base URL confuse you: version 1 of the Verify API followed an interface structure that preceded the creation of Verify as a separate product. The version 2 Verify API normalizes the URI.</p>
<p>With the typed client configuration complete, you can start adding the phone verification functionality to your ASP.NET Core Identity application.</p>
<h2 id="adding-the-required-scaffolding-files">Adding the required scaffolding files<a href="#adding-the-required-scaffolding-files"></a></h2>
<p>In this post we're going to be adding some additional pages to the Identity area. Typically when you're adding or editing Identity pages in ASP.NET Core you should use the built-in scaffolding tools to generate the pages, as shown in <a href="https://www.twilio.com/blog/validate-phone-numbers-asp-net-core-identity-razor-pages-lookup">this post</a>. If you've already done that, you can skip this section. </p>
<p>Rather than adding all the Identity scaffolding, all you need for this post is a single file. Create the file __ViewImports.cshtml_ in the <em>Areas/Identity/Pages</em> folder and add the following code:</p>
<pre><code>@<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>Identity
@<span>using</span> SendVerificationSmsDemo<span>.</span>Areas<span>.</span>Identity
@<span>namespace</span> SendVerificationSmsDemo<span>.</span>Areas<span>.</span>Identity<span>.</span>Pages
@addTagHelper <span>*</span><span>,</span> Microsoft<span>.</span>AspNetCore<span>.</span>Mvc<span>.</span>TagHelpers
</code></pre>
<p>This adds all the required namespaces and tag helpers required by your Razor Pages. It will also light up the IntelliSense in Visual Studio. If you've already scaffolded Identity pages you'll already have this file!</p>
<h2 id="sending-a-verification-code-to-a-phone-number">Sending a verification code to a phone number<a href="#sending-a-verification-code-to-a-phone-number"></a></h2>
<p>The default ASP.NET Core Identity templates provide the functionality for <em>storing</em> a phone number for a user, but don't provide the capability to <em>verify ownership</em> of the number. In the post <a href="https://www.twilio.com/blog/validate-phone-numbers-asp-net-core-identity-razor-pages-lookup">Validating Phone Numbers in ASP.NET Core Identity Razor Pages with Twilio Lookup</a> you can learn how to <em>validate</em> a phone number by using the <a href="https://www.twilio.com/docs/lookup/api">Twilio Lookup API</a>. As noted in the post it’s a good idea to store the result formatted as <a href="https://www.twilio.com/docs/glossary/what-e164">an E.164 number</a>. </p>
<p>In version 1 of the Verify API you must provide the country dialing code and phone number as separate parameters. Consequently, if you're using version 1 of the Verify API it may be best to store these values separately for the <code>IdentityUser</code> user, instead of (or as well as) storing an E.164 number.</p>
<p>For simplicity, this post will gloss over storing the values separately. You’ll create a form that lets the user enter the values separately. In practice, you would automatically use the values attached to the user, rather than allowing them to enter in a new number.</p>
<p>Create a new Razor Page in the <em>Areas/Identity/Pages/Account</em> folder called <em>VerifyPhone.cshtml</em>. In the code-behind file <em>VerifyPhone.cshtml.cs</em> add the following <code>using</code> statements to the top of the file:</p>
<pre><code><span>using</span> System<span>.</span>ComponentModel<span>.</span>DataAnnotations<span>;</span>
<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>Authorization<span>;</span>
</code></pre>
<p>Next, replace the <code>VerifyPhoneModel</code> class with the following:</p>
<pre><code><span>[</span><span>Authorize</span><span>]</span>
<span>public</span> <span>class</span> <span>VerifyPhoneModel</span> <span>:</span> <span>PageModel</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>TwilioVerifyClient</span> _client<span>;</span>

    <span>public</span> <span>VerifyPhoneModel</span><span>(</span><span>TwilioVerifyClient</span> client<span>)</span>
    <span>{</span>
        _client <span>=</span> client<span>;</span>
    <span>}</span>

    <span>[</span><span>BindProperty</span><span>]</span>
    <span>public</span> <span>InputModel</span> Input <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>class</span> <span>InputModel</span>
    <span>{</span>
        <span>[</span><span>Required</span><span>]</span>
        <span>[</span><span>Display</span><span>(</span>Name <span>=</span> <span>"Country dialing code"</span><span>)</span><span>]</span>
        <span>public</span> <span>int</span> DialingCode <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

        <span>[</span><span>Required</span><span>]</span>
        <span>[</span><span>Phone</span><span>]</span>
        <span>[</span><span>Display</span><span>(</span>Name <span>=</span> <span>"Phone number"</span><span>)</span><span>]</span>
        <span>public</span> <span>string</span> PhoneNumber <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IActionResult<span>&gt;</span> <span>OnPostAsync</span><span>(</span><span>)</span>
    <span>{</span>
        <span>if</span> <span>(</span><span>!</span>ModelState<span>.</span>IsValid<span>)</span>
        <span>{</span>
            <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
        <span>}</span>

        <span>try</span>
        <span>{</span>
            <span>var</span> result <span>=</span> <span>await</span> _client<span>.</span><span>StartVerification</span><span>(</span>Input<span>.</span>DialingCode<span>,</span> Input<span>.</span>PhoneNumber<span>)</span><span>;</span>
            <span>if</span> <span>(</span>result<span>.</span>Success<span>)</span>
            <span>{</span>
                <span>return</span> <span>RedirectToPage</span><span>(</span><span>"ConfirmPhone"</span><span>,</span> <span>new</span> <span>{</span>Input<span>.</span>DialingCode<span>,</span> Input<span>.</span>PhoneNumber<span>}</span><span>)</span><span>;</span>
            <span>}</span>

            ModelState<span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span> $<span>"There was an error sending the verification code: {result.Message}"</span><span>)</span><span>;</span>
        <span>}</span>
        <span>catch</span> <span>(</span><span>Exception</span><span>)</span>
        <span>{</span>
            ModelState<span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span> 
                <span>"There was an error sending the verification code, please check the phone number is correct and try again"</span><span>)</span><span>;</span>
        <span>}</span>

        <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>The <code>InputModel</code> for the page is used to bind a simple form (screenshot below) for collecting the country dialing code and phone number to verify. The code doesn’t include an <code>OnGet</code> handler as the framework provides one implicitly. The <code>OnPost</code> handler is where the verification process begins.</p>
<p>The code provides some basic validation using DataAnnotation attributes (see the post <a href="https://www.twilio.com/blog/validate-phone-numbers-asp-net-core-identity-razor-pages-lookup">Validating Phone Numbers in ASP.NET Core Identity Razor Pages with Twilio Lookup</a> to learn about performing robust validation) and, if successful, it uses the injected <code>TwilioVerifyClient</code> to start verification. If the Verify API call is successful, the user is redirected to the <code>ConfirmPhone</code> page, which you'll create shortly. If the Verify API indicates the request failed, or if an exception is thrown, an error is added to the <code>ModelState</code>, and the page is re-displayed to the user.</p>
<p>The form itself consists of two text boxes and a submit button. Replace the contents of <em>VerifyPhone.cshtml</em> with the following Razor markup:</p>
<pre><code>@page
@model VerifyPhoneModel
@<span>{</span>
    ViewData<span>[</span><span>"Title"</span><span>]</span> <span>=</span> <span>"Verify phone number"</span><span>;</span>
<span>}</span>

<span>&lt;</span>h4<span>&gt;</span>@ViewData<span>[</span><span>"Title"</span><span>]</span><span>&lt;</span><span>/</span>h4<span>&gt;</span>
<span>&lt;</span>div <span>class</span><span>=</span><span>"row"</span><span>&gt;</span>
    <span>&lt;</span>div <span>class</span><span>=</span><span>"col-md-8"</span><span>&gt;</span>
        <span>&lt;</span>form method<span>=</span><span>"post"</span><span>&gt;</span>
            <span>&lt;</span>div asp<span>-</span>validation<span>-</span>summary<span>=</span><span>"ModelOnly"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;</span><span>&lt;</span><span>/</span>div<span>&gt;</span>
            <span>&lt;</span>div <span>class</span><span>=</span><span>"form-row"</span><span>&gt;</span>
                <span>&lt;</span>div <span>class</span><span>=</span><span>"form-group col-md-4"</span><span>&gt;</span>
                    <span>&lt;</span>label asp<span>-</span><span>for</span><span>=</span><span>"Input.DialingCode"</span><span>&gt;</span><span>&lt;</span><span>/</span>label<span>&gt;</span>
                    <span>&lt;</span>input asp<span>-</span><span>for</span><span>=</span><span>"Input.DialingCode"</span> <span>class</span><span>=</span><span>"form-control"</span> <span>/</span><span>&gt;</span>
                    <span>&lt;</span>span asp<span>-</span>validation<span>-</span><span>for</span><span>=</span><span>"Input.DialingCode"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;</span><span>&lt;</span><span>/</span>span<span>&gt;</span>
                <span>&lt;</span><span>/</span>div<span>&gt;</span>
                <span>&lt;</span>div <span>class</span><span>=</span><span>"form-group col-md-8"</span><span>&gt;</span>
                    <span>&lt;</span>label asp<span>-</span><span>for</span><span>=</span><span>"Input.PhoneNumber"</span><span>&gt;</span><span>&lt;</span><span>/</span>label<span>&gt;</span>
                    <span>&lt;</span>input asp<span>-</span><span>for</span><span>=</span><span>"Input.PhoneNumber"</span> <span>class</span><span>=</span><span>"form-control"</span> <span>/</span><span>&gt;</span>
                    <span>&lt;</span>span asp<span>-</span>validation<span>-</span><span>for</span><span>=</span><span>"Input.PhoneNumber"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;</span><span>&lt;</span><span>/</span>span<span>&gt;</span>
                <span>&lt;</span><span>/</span>div<span>&gt;</span>
            <span>&lt;</span><span>/</span>div<span>&gt;</span>
            <span>&lt;</span>button type<span>=</span><span>"submit"</span> <span>class</span><span>=</span><span>"btn btn-primary"</span><span>&gt;</span><span>Send</span> verification code<span>&lt;</span><span>/</span>button<span>&gt;</span>
        <span>&lt;</span><span>/</span>form<span>&gt;</span>
    <span>&lt;</span><span>/</span>div<span>&gt;</span>
<span>&lt;</span><span>/</span>div<span>&gt;</span>

@section Scripts <span>{</span>
    <span>&lt;</span><span>partial</span> name<span>=</span><span>"_ValidationScriptsPartial"</span> <span>/</span><span>&gt;</span>
<span>}</span>
</code></pre>
<p>When rendered, the form looks like the following:</p>
<p><img src="https://andrewlock.net/content/images/2019/twilio_verify_api_0.png" alt="The verify phone form"></p>
<p>To test the form, run your app, and navigate to <em>/Identity/Account/VerifyPhone</em>. Enter your country code and phone number and click <strong>Send verification code</strong>. If the phone number is valid, you’ll receive an SMS similar to the message shown below. Note that you can customize this message, including the language, terminology, and code length: see the <a href="https://www.twilio.com/docs/verify/api/verification#send-a-verification-code">Verify API documentation for details</a>.</p>
<pre><code>Your Twilio Verify API demo verification code is: 2933
</code></pre>
<p>Now you need to create the page where the user enters the code they receive.</p>
<h2 id="checking-the-verification-code">Checking the verification code<a href="#checking-the-verification-code"></a></h2>
<p>The check verification code page contains a single text box where the user enters the code they receive. Create a new Razor Page in the <em>Areas/Identity/Pages/Account</em> folder called <em>ConfirmPhone.cshtml</em>. In the code-behind file <em>ConfirmPhone.cshtml.cs</em> add the following <code>using</code> statements to the top of the file:</p>
<pre><code><span>using</span> System<span>.</span>ComponentModel<span>.</span>DataAnnotations<span>;</span>
<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>Authorization<span>;</span>
<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>Identity<span>;</span>
</code></pre>
<p>Next replace the <code>ConfirmPhoneModel</code> class with the following: </p>
<pre><code><span>[</span><span>Authorize</span><span>]</span>
<span>public</span> <span>class</span> <span>ConfirmPhoneModel</span> <span>:</span> <span>PageModel</span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>TwilioVerifyClient</span> _client<span>;</span>
    <span>private</span> <span>readonly</span> UserManager<span>&lt;</span>IdentityUser<span>&gt;</span> _userManager<span>;</span>

    <span>public</span> <span>ConfirmPhoneModel</span><span>(</span><span>TwilioVerifyClient</span> client<span>,</span> UserManager<span>&lt;</span>IdentityUser<span>&gt;</span> userManager<span>)</span>
    <span>{</span>
        _client <span>=</span> client<span>;</span>
        _userManager <span>=</span> userManager<span>;</span>
    <span>}</span>

    <span>[</span><span>BindProperty</span><span>(</span>SupportsGet <span>=</span> <span>true</span><span>)</span><span>]</span>
    <span>public</span> <span>InputModel</span> Input <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>class</span> <span>InputModel</span>
    <span>{</span>
        <span>[</span><span>Required</span><span>]</span>
        <span>[</span><span>Display</span><span>(</span>Name <span>=</span> <span>"Country dialing code"</span><span>)</span><span>]</span>
        <span>public</span> <span>int</span> DialingCode <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

        <span>[</span><span>Required</span><span>]</span>
        <span>[</span><span>Phone</span><span>]</span>
        <span>[</span><span>Display</span><span>(</span>Name <span>=</span> <span>"Phone number"</span><span>)</span><span>]</span>
        <span>public</span> <span>string</span> PhoneNumber <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

        <span>[</span><span>Required</span><span>]</span>
        <span>[</span><span>Display</span><span>(</span>Name <span>=</span> <span>"Code"</span><span>)</span><span>]</span>
        <span>public</span> <span>string</span> VerificationCode <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>}</span>

    <span>public</span> <span>async</span> Task<span>&lt;</span>IActionResult<span>&gt;</span> <span>OnPostAsync</span><span>(</span><span>)</span>
    <span>{</span>
        <span>if</span> <span>(</span><span>!</span>ModelState<span>.</span>IsValid<span>)</span>
        <span>{</span>
            <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
        <span>}</span>

        <span>try</span>
        <span>{</span>
            <span>var</span> result <span>=</span> <span>await</span> _client<span>.</span><span>CheckVerificationCode</span><span>(</span>Input<span>.</span>DialingCode<span>,</span> Input<span>.</span>PhoneNumber<span>,</span> Input<span>.</span>VerificationCode<span>)</span><span>;</span>
            <span>if</span> <span>(</span>result<span>.</span>Success<span>)</span>
            <span>{</span>
                <span>var</span> identityUser <span>=</span> <span>await</span> _userManager<span>.</span><span>GetUserAsync</span><span>(</span>User<span>)</span><span>;</span>
                identityUser<span>.</span>PhoneNumberConfirmed <span>=</span> <span>true</span><span>;</span>
                <span>var</span> updateResult <span>=</span>  <span>await</span> _userManager<span>.</span><span>UpdateAsync</span><span>(</span>identityUser<span>)</span><span>;</span>

                <span>if</span> <span>(</span>updateResult<span>.</span>Succeeded<span>)</span>
                <span>{</span>
                    <span>return</span> <span>RedirectToPage</span><span>(</span><span>"ConfirmPhoneSuccess"</span><span>)</span><span>;</span>
                <span>}</span>
                <span>else</span>
                <span>{</span>
                    ModelState<span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span> <span>"There was an error confirming the verification code, please try again"</span><span>)</span><span>;</span>
                <span>}</span>
            <span>}</span>
            <span>else</span>
            <span>{</span>
                ModelState<span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span> $<span>"There was an error confirming the verification code: {result.Message}"</span><span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>
        <span>catch</span> <span>(</span><span>Exception</span><span>)</span>
        <span>{</span>
            ModelState<span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span>
                <span>"There was an error confirming the code, please check the verification code is correct and try again"</span><span>)</span><span>;</span>
        <span>}</span>

        <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>As before, we can skip the <code>OnGet</code> handler, as that's provided implicitly by the framework. The <code>InputModel</code> has three parameters 1) the dialing code, 2) the phone number provided in the previous step, and 3) the verification code entered by the user. </p>
<p>For simplicity, the code passed the phone number and country code from the previous step to this page via the querystring. In practice, you would load these from the <code>IdentityUser</code> itself, as described earlier. </p>
<p>Calling the Twilio Verify API is simple thanks to the typed client. The dialing code and phone number from the previous step and the authentication code entered by the user are passed to the API. If the check is successful, the Verify API will return<code>result.Success=true</code>. You can store the confirmation result on the <code>IdentityUser</code> object directly by setting the <code>PhoneNumberConfirmed</code> property and saving the changes. </p>
<p>If everything completes successfully, you redirect the user to a simple <code>ConfirmPhoneSuccess</code> page (that you'll create shortly). If there are any errors or exceptions, an error is added to the <code>ModelState</code> and the page is redisplayed.</p>
<p>Replace the contents of <em>ConfirmPhone.cshtml</em> with the Razor markup below. For usability, the provided phone number is redisplayed in the page.</p>
<pre><code>@page
@model ConfirmPhoneModel
@<span>{</span>
    ViewData<span>[</span><span>"Title"</span><span>]</span> <span>=</span> <span>"Confirm phone number"</span><span>;</span>
<span>}</span>

<span>&lt;</span>h4<span>&gt;</span>@ViewData<span>[</span><span>"Title"</span><span>]</span><span>&lt;</span><span>/</span>h4<span>&gt;</span>
<span>&lt;</span>div <span>class</span><span>=</span><span>"row"</span><span>&gt;</span>
    <span>&lt;</span>div <span>class</span><span>=</span><span>"col-md-6"</span><span>&gt;</span>
        <span>&lt;</span>form method<span>=</span><span>"post"</span><span>&gt;</span>
            <span>&lt;</span>p<span>&gt;</span>
                <span>We</span> have sent a confirmation code to <span>(</span>@Model<span>.</span>Input<span>.</span>DialingCode<span>)</span> @<span>Model<span>.</span>Input<span>.</span>PhoneNumber</span>
                <span>Enter</span> the code you receive to confirm your phone number<span>.</span>
            <span>&lt;</span><span>/</span>p<span>&gt;</span>
            <span>&lt;</span>div asp<span>-</span>validation<span>-</span>summary<span>=</span><span>"All"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;</span><span>&lt;</span><span>/</span>div<span>&gt;</span>
            <span>&lt;</span>input asp<span>-</span><span>for</span><span>=</span><span>"Input.DialingCode"</span> type<span>=</span><span>"hidden"</span> <span>/</span><span>&gt;</span>
            <span>&lt;</span>input asp<span>-</span><span>for</span><span>=</span><span>"Input.PhoneNumber"</span> type<span>=</span><span>"hidden"</span> <span>/</span><span>&gt;</span>

            <span>&lt;</span>div <span>class</span><span>=</span><span>"form-group"</span><span>&gt;</span>
                <span>&lt;</span>label asp<span>-</span><span>for</span><span>=</span><span>"Input.VerificationCode"</span><span>&gt;</span><span>&lt;</span><span>/</span>label<span>&gt;</span>
                <span>&lt;</span>input asp<span>-</span><span>for</span><span>=</span><span>"Input.VerificationCode"</span> <span>class</span><span>=</span><span>"form-control"</span> type<span>=</span><span>"number"</span> <span>/</span><span>&gt;</span>
                <span>&lt;</span>span asp<span>-</span>validation<span>-</span><span>for</span><span>=</span><span>"Input.VerificationCode"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;</span><span>&lt;</span><span>/</span>span<span>&gt;</span>
            <span>&lt;</span><span>/</span>div<span>&gt;</span>
            <span>&lt;</span>button type<span>=</span><span>"submit"</span> <span>class</span><span>=</span><span>"btn btn-primary"</span><span>&gt;</span>Confirm<span>&lt;</span><span>/</span>button<span>&gt;</span>
        <span>&lt;</span><span>/</span>form<span>&gt;</span>
    <span>&lt;</span><span>/</span>div<span>&gt;</span>
<span>&lt;</span><span>/</span>div<span>&gt;</span>

@section Scripts <span>{</span>
    <span>&lt;</span><span>partial</span> name<span>=</span><span>"_ValidationScriptsPartial"</span> <span>/</span><span>&gt;</span>
<span>}</span>
</code></pre>
<p>When rendered, this looks like the following:</p>
<p><img src="https://andrewlock.net/content/images/2019/twilio_verify_api_1.png" alt="The confirm phone form"></p>
<p>Once the user successfully confirms their phone number you can be confident they have access to it and you can use it in other parts of your application with confidence.</p>
<h2 id="showing-a-confirmation-success-page">Showing a confirmation success page<a href="#showing-a-confirmation-success-page"></a></h2>
<p>To create a simple "congratulations" page for the user, create a new Razor Page in the <em>Areas/Identity/Pages/Account</em> folder called <em>ConfirmPhoneSuccess.cshtml</em>. You don't need to change the code-behind for this page, just add the following markup to <em>ConfirmPhoneSuccess.cshtml</em>:</p>
<pre><code>@page
@model ConfirmPhoneSuccessModel
@{
    ViewData["Title"] = "Phone number confirmed";
}

<span><span><span>&lt;</span>h1</span><span>&gt;</span></span>@ViewData["Title"]<span><span><span>&lt;/</span>h1</span><span>&gt;</span></span>
<span><span><span>&lt;</span>div</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>p</span><span>&gt;</span></span>
        Thank you for confirming your phone number.
    <span><span><span>&lt;/</span>p</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>a</span> <span>asp-page</span><span><span>=</span><span>"</span>/Index<span>"</span></span><span>&gt;</span></span>Back to home<span><span><span>&lt;/</span>a</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
</code></pre>
<p>After entering a correct verification code, users will be redirected to this page. From here, they can return to the home page.</p>
<p><img src="https://andrewlock.net/content/images/2019/twilio_verify_api_2.png" alt="The confirm phone form"></p>
<h2 id="trying-out-the-twilio-verify-functionality">Trying out the Twilio Verify functionality<a href="#trying-out-the-twilio-verify-functionality"></a></h2>
<p>Try out what you’ve just built by running the app. Follow these steps to validate a user’s ownership of a phone number with Verify:</p>
<p>Navigate to <em><a href="https://localhost:44348/Identity/Account/VerifyPhone">https://localhost:44348/Identity/Account/VerifyPhone</a></em> in your browser. Because this page is protected by ASP.NET Core Identity authorization, you’ll be redirected to the account log in page.</p>
<p>Register as a new user. You will be redirected to the /Identity/Account/VerifyPhone route and will see the rendered <em>VerifyPhone.cshtml</em> Razor page. At this point you can see the record for the user you created in the dbo.AspNetUsers table of the database aspnet-SendVerificationSmsDemo-&lt;GUID&gt;. Note that the phone number is <code>null</code>.</p>
<p>Enter a valid country code and phone number capable of receiving SMS text messages. Click <strong>Send verification code</strong>. You should be routed to a URI similar to <em>/Identity/Account/ConfirmPhone?DialingCode=44&amp;PhoneNumber=07123456789</em>, where the DialingCode and PhoneNumber reflect the values you entered.</p>
<p>In a matter of moments you should receive an SMS message with a verification code. Note that the message reflects the name of the application you created in Twilio Verify.</p>
<p>At this point you can go to the Verify console at <a href="https://www.twilio.com/console/verify/applications">https://www.twilio.com/console/verify/applications</a>. You should see a value of 1 in the SMS VERIFICATION STARTED column. Select the application matching the SMS message you received.</p>
<p>Enter the numeric code from the SMS message in the Code box on the <em>Confirm phone number</em> page and click <strong>Confirm</strong>. (Validation codes expire, so you need to do this within 10 minutes of receiving the code.)</p>
<p>If everything worked correctly you should be redirected to the <em>/Identity/Account/ConfirmPhoneSuccess</em> page. If you refresh the Verify Insights for your application in the Twilio Console you should see the successful validation reflected in statistics for the application.</p>
<p>Good work! You've successfully integrated Twilio Verify with ASP.NET Core 2.2 Identity.</p>
<h2 id="possible-improvements">Possible improvements<a href="#possible-improvements"></a></h2>
<p>This post showed the basic approach for using version 1 of the Verify API with ASP.NET Core Identity, but there are many improvements you could make:</p>
<ul>
<li><em>Store the country dialing code and phone number on the <code>IdentityUser</code></em>. This would be required for practical implementations, as you want to be sure that the phone number stored against the user is the one you are verifying! This would also simplify the code somewhat, as described previously.</li>
<li><em>Include a link the <code>VerifyPhone</code> page</em>. Currently you have to navigate manually to <code>Identity/Account/VerifyPhone</code>, but in practice you would want to add a link to it somewhere in your app. </li>
<li><em>Show the verification status of the phone number in the app</em>. By default, ASP.NET Core Identity doesn't display the <code>IdentityUser.PhoneNumberConfirmed</code> property anywhere in the app.</li>
<li><em>Only verify unconfirmed numbers</em>. Related to the previous improvement, you probably only want to verify phone numbers once, so you should check for <code>PhoneNumberConfirmed=true</code> in the <code>VerifyPhone</code> page, as well as hide any verification links.</li>
<li><em>Allow re-sending the code</em>. In some cases, users might find the verification code doesn't arrive. For a smoother user experience, you could add functionality to allow re-sending a confirmation code to the <code>ConfirmPhone</code> page.</li>
</ul>
<h2 id="summary">Summary<a href="#summary"></a></h2>
<p>In this post you saw how to use version 1 of the Twilio Verify API to confirm phone number ownership in an ASP.NET Core Identity application. You learned how to create a typed client for calling the API that uses best practices like <code>HttpClientFactory</code>, and how to use it from Razor Pages. This example took the simplistic route of asking users to re-enter their country dialing code and phone number, but in real applications you should store these in the <code>IdentityUser</code> directly.</p>
<p>You can find the complete sample code for this post <a href="https://github.com/andrewlock/TwilioSamples/tree/master/SendVerificationSmsDemo">on GitHub</a>.</p>
</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>