<!DOCTYPE html>
<html lang="en">
<head>
    <title>
GC.AllocateUninitializedArray should tighten its logic around when to return zeroed arrays &#xB7; Issue #13292 &#xB7; dotnet/runtime &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>GC.AllocateUninitializedArray should tighten its logic around when to return zeroed arrays · Issue #13292 · dotnet/runtime · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>In <a class="issue-link js-issue-link" data-error-text="Failed to load issue title" data-id="442459869" data-permission-text="Issue title is private" data-url="https://github.com/dotnet/coreclr/issues/24504" data-hovercard-type="pull_request" data-hovercard-url="/dotnet/coreclr/pull/24504/hovercard" href="https://github.com/dotnet/coreclr/pull/24504">dotnet/coreclr#24504</a>, the <code>ArrayPool&lt;T&gt;</code>-derived types were changed to use <code>GC.AllocateUninitializedArray&lt;T&gt;(...)</code> under the covers as a performance optimization. The <code>AllocateUninitializedArray</code> method uses <code>RuntimeHelpers.IsReferenceOrContainsReferences</code> as an implementation detail when determining whether to return a zeroed array or an uninitialized array back to the caller.</p><p><a href="https://github.com/dotnet/coreclr/blob/af9edac7acd4735eebd7a293b27b1c509989dae8/src/System.Private.CoreLib/src/System/GC.cs#L665-L668">https://github.com/dotnet/coreclr/blob/af9edac7acd4735eebd7a293b27b1c509989dae8/src/System.Private.CoreLib/src/System/GC.cs#L665-L668</a></p><p>This logic is a little too relaxed. It appears that the <code>AllocateUninitializedArray</code> method is trying to ask the question "Is any arbitrary bit pattern valid for type <em>T</em>?", but the <code>IsReferenceOrContainsReferences</code> method answers the separate question "Is type <em>T</em> 'interesting' to the GC?"</p><p>There are several value types where <code>IsReferenceOrContainsReferences</code> returns <em>false</em> but which cannot store arbitrary bit patterns without causing problems. Among them:</p><ul><li>System.Boolean (most consumers expect it to contain only <code>0</code> or <code>1</code>)</li><li>System.Decimal (see <a href="https://github.com/dotnet/coreclr/issues/16336">https://github.com/dotnet/coreclr/issues/16336</a>)</li><li>System.DateTime / System.DateTimeOffset</li><li>System.Runtime.InteropServices.GCHandle</li><li>System.Buffers.StandardFormat</li><li>System.Text.Rune</li></ul><p>The behaviors of calling instance methods on these types or of consuming these types when they've been initialized with arbitrary bit patterns is undefined, and it could result in anything from nonsensical answers being generated to crashing the runtime.</p><p>Normally we'd tell developers not to look at the elements of arrays returned by <code>GC.AllocateUninitializedArray</code> or <code>ArrayPool&lt;T&gt;.Rent</code>, but there are some situations where they might not be able to control it. For example, if I'm under the VS debugger and I step past a call to <code>AllocateUninitializedArray</code> or <code>Rent</code>, the debugger could start listing the array's elements automatically even though my own code wouldn't have done such a thing.</p><p>If we do not want to change <code>GC.AllocateUninitializedArray</code> (perhaps because we consider it an "unsafe" API), we should at least consider putting the stronger checks into the <code>ArrayPool&lt;T&gt;</code>-derived classes.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>