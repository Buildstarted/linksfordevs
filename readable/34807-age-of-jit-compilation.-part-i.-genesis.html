<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Age of JIT Compilation. Part I. Genesis -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Age of JIT Compilation. Part I. Genesis</h1>
    <div class="main-content-inner col-sm-12 col-md-8"> <a href="https://bit.ly/2I1Q0nf"> <img src="https://codingsight.com/wp-content/uploads/2019/06/DevOps_Coding_750x90.png"></a> <p id="primary" class="content-area"> <main id="main" class="site-main"> <article id="post-1305" class="post-1305 post type-post status-publish format-standard hentry category-net tag-clr tag-jit"> <div class="post-inner-content"> <header class="entry-header page-header"> </header> <div class="entry-content"> <p>The runtime topic of the .NET platform has been discussed for many times, while JIT itself, as well as a resulting code and interoperability with the execution environment, have not.</p>
<p>We will explore a rationale for the lack of inheritance in structs, unbound delegate roots, as well as a technique of invoking any method without reflection.</p> <h2>Genesis of Value Types</h2>
<p>Structs in the .NET framework are plain old structures (in terms of layout, mutability, etc.). They support OOP and .NET, the inheritance from System.ValueType, which is derived from System.Object, etc.).</p>
<p>To better understand why structs cannot be derived from other types, it is necessary to dig into CLR&#x2019;s method organization.</p>
<p>Instance-level methods have an implicit argument &#x2018;this&#x2019;, which is explicit indeed. While compiling a code, JIT creates the following signature:</p> <div id="crayon-5d693a0c22455814886035" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
ReturnType MethodName(Type this, &#x2026;arguments&#x2026;)</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c22455814886035-1"><span class="crayon-e">ReturnType </span><span class="crayon-e">MethodName</span><span class="crayon-sy">(</span><span class="crayon-e">Type </span><span class="crayon-r">this</span><span class="crayon-sy">,</span><span class="crayon-h"> </span>&#x2026;<span class="crayon-i">arguments</span>&#x2026;<span class="crayon-sy">)</span></div></div></td> </tr> </table> </div> </div> <p>
However, it is for reference types only.</p>
<p>As for value types, it has the following signature:</p> <div id="crayon-5d693a0c22464522694981" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-toolbar"><span class="crayon-title">Signature for value types</span> </div> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
ReturnType MethodName(ref Type this, &#x2026;arguments&#x2026;)</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c22464522694981-1"><span class="crayon-e">ReturnType </span><span class="crayon-e">MethodName</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"> </span><span class="crayon-e">Type </span><span class="crayon-r">this</span><span class="crayon-sy">,</span><span class="crayon-h"> </span>&#x2026;<span class="crayon-i">arguments</span>&#x2026;<span class="crayon-sy">)</span></div></div></td> </tr> </table> </div> </div> <p>
This is done to support mutability for structs, i.e. so that we can modify <em>this</em> pointer.</p>
<p>So, why is it impossible to derive structs from other types?</p>
<p>Suppose we have a virtual method of a base reference class. What should a compiler do in this case? Nothing. Constantly guessing and generating different code specializations (with either <em>byval</em> or <em>byref</em> semantics) in addition to <em>vtable</em> dispatch is ineffective. Also, we are adding boxing, which is required to correctly dispatch virtual method.</p>
<p>But&#x2026; the <em>ToString</em>,&#xA0;<em>GetHashCode</em>,&#xA0;and <em>Equals</em>&#xA0;methods are virtual methods of the parent <strong>System.Object</strong> class (a reference type)<strong>.</strong></p>
<p>They are exceptions. JIT knows about them and generates binding and specialization only for these methods.</p>
<h2><span>Unbound Delegates</span></h2>
<p>Reflection in the <strong>.NET</strong> framework allows us to create a delegate for both static and instance-level methods. However, there is a small issue &#x2013; it is necessary to create a new delegate per object&#x2019;s instance.</p>
<p>Consider the example:</p> <div id="crayon-5d693a0c22466065370054" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
class Program
{
    static void Main(string[] args)
    {
        var calc = new Calc() { FirstOperand = 2 };

        var addMethodInfo = typeof(Calc).GetMethod(&quot;Add&quot;, 
                                            BindingFlags.Public | BindingFlags.Instance);

        var addDelegate = (Func&lt;int, int&gt;)Delegate.CreateDelegate(
                                                        typeof(Func&lt;int, int&gt;), 
                                                        calc, 
                                                        addMethodInfo);

        Console.WriteLine(addDelegate(2)); // 4
    }
}

class Calc
{
    public int FirstOperand = 0;

    public int Add(int secondOperand)
    {
        return FirstOperand + secondOperand;
    }
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c22466065370054-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c22466065370054-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">calc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Calc</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">FirstOperand</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d693a0c22466065370054-7"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">addMethodInfo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Calc</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetMethod</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Add&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c22466065370054-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-m">Public</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-v">Instance</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c22466065370054-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">addDelegate</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Func</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-r">Delegate</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDelegate</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5d693a0c22466065370054-15"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-e">addDelegate</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// 4</span></div><div class="crayon-line" id="crayon-5d693a0c22466065370054-21"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">FirstOperand</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d693a0c22466065370054-23"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">secondOperand</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c22466065370054-25"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">FirstOperand</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">secondOperand</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> <p>
In order to do this, you need to use <strong>unbound delegates</strong>. However, they have one feature &#x2013; a different signature, where an additional argument is prepended &#x2013; a reference to an instance.</p>
<p>Thus, unbound delegates are the references to a real method.</p>
<p>As you can see, the <em>Add(int secondOperand) </em>signature will turn into the <em>Add</em><strong><em>(</em><em>Calc this</em></strong><em>, int secondOperand) </em>signature.</p>
<p>Let&#x2019;s check it:</p> <div id="crayon-5d693a0c22469808131629" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
class Program
{
    static void Main(string[] args)
    {
        var addMethodInfo = typeof(Calc).GetMethod(&quot;Add&quot;, 
                                            BindingFlags.Public | BindingFlags.Instance);

        var addDelegate = (Func&lt;Calc, int, int&gt;)Delegate.CreateDelegate(
                                                        typeof(Func&lt;Calc, int, int&gt;), 
                                                        null, 
                                                        addMethodInfo);

        Console.WriteLine(addDelegate(new Calc(), 2)); // 2
    }
}

class Calc
{
    public int FirstOperand = 0;

    public int Add(int secondOperand)
    {
        return FirstOperand + secondOperand;
    }
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c22469808131629-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c22469808131629-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">addMethodInfo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Calc</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetMethod</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Add&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c22469808131629-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-m">Public</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-v">Instance</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c22469808131629-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">addDelegate</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Func</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-r">Delegate</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDelegate</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5d693a0c22469808131629-9"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Func</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5d693a0c22469808131629-13"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-e">addDelegate</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Calc</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// 2</span></div><div class="crayon-line" id="crayon-5d693a0c22469808131629-19"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">FirstOperand</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d693a0c22469808131629-21"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">secondOperand</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c22469808131629-23"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">FirstOperand</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">secondOperand</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> <p>
Now declare the Calc type as <strong>struct</strong>&#xA0;and run the code again. ArgumentException would be thrown.</p>
<p>But we need to pass <strong>this byref </strong>argument to Func&lt;Calc,int,int&gt;.</p>
<p>How to do this?!</p>
<p>First, declare the FuncByRef delegate:</p> <div id="crayon-5d693a0c2246b771634823" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
delegate TResult FuncByRef&lt;T1, in T2, out TResult&gt;(ref T1 arg1, T2 arg2);</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c2246b771634823-1"><span class="crayon-r">delegate</span><span class="crayon-h"> </span><span class="crayon-e">TResult </span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">T1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">T2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">out</span><span class="crayon-h"> </span><span class="crayon-v">TResult</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"> </span><span class="crayon-e">T1 </span><span class="crayon-v">arg1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">T2 </span><span class="crayon-v">arg2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> <p>
Now, change the code again:</p> <div id="crayon-5d693a0c22478755806236" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
class Program
{
    delegate TResult FuncByRef&lt;T1, in T2, out TResult&gt;(ref T1 arg1, T2 arg2);

    static void Main(string[] args)
    {
        var addMethodInfo = typeof(Calc).GetMethod(&quot;Add&quot;, 
                                            BindingFlags.Public | BindingFlags.Instance);

        var addDelegate = (FuncByRef&lt;Calc, int, int&gt;)Delegate.CreateDelegate(
                                                        typeof(FuncByRef&lt;Calc, int, int&gt;),
                                                        null, 
                                                        addMethodInfo);
        var calc = new Calc();
        calc.FirstOperand = 123;

        Console.WriteLine(addDelegate(ref calc, 2)); // 125
    }
}

struct Calc
{
    public int FirstOperand;

    public int Add(int secondOperand)
    {
        return FirstOperand + secondOperand;
    }
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c22478755806236-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r">delegate</span><span class="crayon-h"> </span><span class="crayon-e">TResult </span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">T1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">T2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">out</span><span class="crayon-h"> </span><span class="crayon-v">TResult</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"> </span><span class="crayon-e">T1 </span><span class="crayon-v">arg1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">T2 </span><span class="crayon-v">arg2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d693a0c22478755806236-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c22478755806236-7"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">addMethodInfo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Calc</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetMethod</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Add&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c22478755806236-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-m">Public</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-v">Instance</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c22478755806236-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">addDelegate</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-r">Delegate</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDelegate</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5d693a0c22478755806236-11"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5d693a0c22478755806236-17"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-e">addDelegate</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"> </span><span class="crayon-v">calc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// 125</span></div><div class="crayon-line" id="crayon-5d693a0c22478755806236-25"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">secondOperand</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c22478755806236-27"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">FirstOperand</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">secondOperand</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> <h2>Verification evasion</h2>
<p>Consider a simple application:</p> <div id="crayon-5d693a0c2247c319970269" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
class Program
{
    static void Main(string[] args)
    {
        CallTest(new object());
        CallTestWithExlicitCasting(new object());
        Console.Read();
    }

    static void CallTest(object target)
    {
        Program p = target as Program;
        p.Test();
    }

    static void CallTestWithExlicitCasting(object target)
    {
        Program p = (Program)target;
        p.Test();
    }

    public void Test()
    {
        Console.WriteLine(&quot;Test&quot;);
    }
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c2247c319970269-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2247c319970269-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-e">CallTestWithExlicitCasting</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">object</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2247c319970269-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">CallTest</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"> </span><span class="crayon-v">target</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2247c319970269-12"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-i">Program</span><span class="crayon-h"> </span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">target </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">Program</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2247c319970269-16"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">CallTestWithExlicitCasting</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"> </span><span class="crayon-v">target</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2247c319970269-18"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-i">Program</span><span class="crayon-h"> </span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Program</span><span class="crayon-sy">)</span><span class="crayon-v">target</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2247c319970269-24"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Test&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> <p>
As you can see, the application will exit with NullReferenceException&#xA0;when calling CallTest().</p>
<p>Well, let&#x2019;s fix this situation by running <strong>ildasm</strong>.</p> <div id="crayon-5d693a0c2247e512927883" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
Visual Studio Command Promt -&gt; ildasm</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c2247e512927883-1"><span class="crayon-e">Visual </span><span class="crayon-e">Studio </span><span class="crayon-e">Command </span><span class="crayon-v">Promt</span><span class="crayon-h"> </span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-v">ildasm</span></div></div></td> </tr> </table> </div> </div> <p>
<a href="https://codingsight.com/wp-content/uploads/2017/04/1.png"><img src="https://codingsight.com/wp-content/uploads/2017/04/1.png" alt width="400"></a></p>
<p>Then,</p> <div id="crayon-5d693a0c22488912925939" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
File -&gt; Dump -&gt; Save as dialog -&gt; msiltricks_patch.il</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c22488912925939-1"><span class="crayon-v">File</span><span class="crayon-h"> </span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Dump</span><span class="crayon-h"> </span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-e">Save </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">dialog</span><span class="crayon-h"> </span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-v">msiltricks_patch</span><span class="crayon-sy">.</span><span class="crayon-v">il</span></div></div></td> </tr> </table> </div> </div> <p>
Open the stored file msiltricks_patch.il&#xA0;in any text editor and find a body of the CallTest method:</p> <div id="crayon-5d693a0c2248b623654449" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
.method private hidebysig static void  CallTest(object target) cil managed
{
  // Code size       14 (0xe)
  .maxstack  1
  .locals init ([0] class MSILTricks.Program p)
  IL_0000:  ldarg.0
  IL_0001:  isinst     MSILTricks.Program
  IL_0006:  stloc.0
  IL_0007:  ldloc.0
  IL_0008:  callvirt   instance void MSILTricks.Program::Test()
  IL_000d:  ret
} // end of method Program::CallTest</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c2248b623654449-1"><span class="crayon-sy">.</span><span class="crayon-e">method </span><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-e">hidebysig </span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-e">CallTest</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"> </span><span class="crayon-v">target</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">cil</span><span class="crayon-h"> </span><span class="crayon-e">managed</span></div><div class="crayon-line" id="crayon-5d693a0c2248b623654449-5"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-sy">.</span><span class="crayon-e">locals </span><span class="crayon-e">init</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-i">Program</span><span class="crayon-h"> </span><span class="crayon-v">p</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c2248b623654449-7"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-v">IL_0001</span><span class="crayon-o">:</span><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-e">isinst&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-e">Program</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2248b623654449-10"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-v">IL_0008</span><span class="crayon-o">:</span><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-e">callvirt&#xA0;&#xA0; </span><span class="crayon-e">instance </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-v">Program</span><span class="crayon-o">::</span><span class="crayon-e">Test</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2248b623654449-12"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-c">// end of method Program::CallTest</span></div></div></td> </tr> </table> </div> </div> <p>
Delete the IL_0001: isinst MSILTricks.Program line, i.e. <strong>isinst </strong>operator invocation (the <strong>as</strong> operator in C#).</p>
<p>The same should be done to the CallTestWithExlicitCasting method:</p> <div id="crayon-5d693a0c2248d387758301" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-toolbar"><span class="crayon-title">CallTestWithExlicitCasting</span> </div> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
.method private hidebysig static void  CallTestWithExlicitCasting(object target) cil managed
{
  // Code size       14 (0xe)
  .maxstack  1
  .locals init ([0] class MSILTricks.Program p)
  IL_0000:  ldarg.0
  IL_0001:  castclass  MSILTricks.Program
  IL_0006:  stloc.0
  IL_0007:  ldloc.0
  IL_0008:  callvirt   instance void MSILTricks.Program::Test()
  IL_000d:  ret
} // end of method Program::CallTestWithExlicitCasting</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c2248d387758301-1"><span class="crayon-sy">.</span><span class="crayon-e">method </span><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-e">hidebysig </span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-e">CallTestWithExlicitCasting</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"> </span><span class="crayon-v">target</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">cil</span><span class="crayon-h"> </span><span class="crayon-e">managed</span></div><div class="crayon-line" id="crayon-5d693a0c2248d387758301-5"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-sy">.</span><span class="crayon-e">locals </span><span class="crayon-e">init</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-i">Program</span><span class="crayon-h"> </span><span class="crayon-v">p</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d693a0c2248d387758301-7"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-v">IL_0001</span><span class="crayon-o">:</span><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-e">castclass&#xA0;&#xA0;</span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-e">Program</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2248d387758301-10"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-v">IL_0008</span><span class="crayon-o">:</span><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-e">callvirt&#xA0;&#xA0; </span><span class="crayon-e">instance </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-v">Program</span><span class="crayon-o">::</span><span class="crayon-e">Test</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2248d387758301-12"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-c">// end of method Program::CallTestWithExlicitCasting</span></div></div></td> </tr> </table> </div> </div> <p>
Delete the IL_0001: castclass MSILTricks.Program line, i.e. <strong>castclass</strong>&#xA0;operator invocation (the <strong>cast</strong> operator in C#).</p> <div id="crayon-5d693a0c2248f437888883" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
Visual Studio Command Promt -&gt; cd [your saved file dir]
Visual Studio Command Promt -&gt; ilasm msiltricks_patch.il</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d693a0c2248f437888883-1"><span class="crayon-e">Visual </span><span class="crayon-e">Studio </span><span class="crayon-e">Command </span><span class="crayon-v">Promt</span><span class="crayon-h"> </span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-i">cd</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">your </span><span class="crayon-e">saved </span><span class="crayon-e">file </span><span class="crayon-v">dir</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d693a0c2248f437888883-2"><span class="crayon-e">Visual </span><span class="crayon-e">Studio </span><span class="crayon-e">Command </span><span class="crayon-v">Promt</span><span class="crayon-h"> </span><span class="crayon-o">-&gt;</span><span class="crayon-h"> </span><span class="crayon-e">ilasm </span><span class="crayon-v">msiltricks_patch</span><span class="crayon-sy">.</span><span class="crayon-v">il</span></div></div></td> </tr> </table> </div> </div> <p>
Run <strong>msiltricks_patch.exe</strong>.</p>
<p>Thus, there are no exceptions, even <strong>AccessViolationException</strong>.</p>
<p>The thing is that our Test method does not have side effects and does not use <strong>this</strong>&#xA0;in its body.</p>
<h2><strong>Conclusion:</strong></h2>
<p><strong>&#xA0;</strong>We work with hardware. Variables of reference types are just addresses in memory &#x2013;&#xA0;<strong>DWORD. </strong>Casting types is nothing more than abstraction and protection at the compile time. The CPU works with memory addresses only. CLR provides these addresses while JIT compiles code using them.</p>
<p>By the way, <strong>callvirt</strong>&#xA0;instruction does not check for correctness of an object. For example, to get AccessViolationException just add a virtual method to the Program class and call it in the Test method&#x2019;s body.</p>
<h3>Also read:</h3>
<p><a href="https://codingsight.com/age-of-jit-compilation-part-2-clr-is-watching-you/">Age of JIT compilation.&#xA0;Part 2. CLR is watching you</a></p> </div> </div> </article> <a href="https://bit.ly/2XuaPwM"> <img src="https://codingsight.com/wp-content/uploads/2019/06/DevOps_Coding_750x90.png"></a> </main> </p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>