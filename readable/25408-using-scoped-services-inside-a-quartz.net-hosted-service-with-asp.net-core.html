<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using scoped services inside a Quartz.NET hosted service with ASP.NET Core -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }
    </style>
</head>
<body>
    <div class="grid">
            <h1>Using scoped services inside a Quartz.NET hosted service with ASP.NET Core</h1>
        
<div class="readable"><div class="post-content">
<p>In my <a href="/creating-a-quartz-net-hosted-service-with-asp-net-core/">previous post</a> I showed how you can create a Quartz.NET hosted service with ASP.NET Core and use it to run background tasks on a schedule. Unfortunately, due to the way way the Quartz.NET API works, using Scoped dependency injection services in your Quartz jobs is somewhat cumbersome. </p>
<p>In this post I show one way to make it easier to use scoped services in your jobs. You can use the same approach for managing <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html">&quot;unit-of-work&quot; patterns</a> with EF Core, and other cross-cutting concerns.</p>
<p>This post follows on directly from the <a href="/creating-a-quartz-net-hosted-service-with-asp-net-core/">previous post</a>, so I suggest reading that post first, if you haven&apos;t already.</p> <p>In the last post, we had a <code>HelloWorldJob</code> implementing <code>IJob</code> that simply wrote to the console. </p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorldJob</span> <span class="token punctuation">:</span> <span class="token class-name">IJob</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> ILogger<span class="token operator">&lt;</span>HelloWorldJob<span class="token operator">&gt;</span> _logger<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">HelloWorldJob</span><span class="token punctuation">(</span>ILogger<span class="token operator">&lt;</span>HelloWorldJob<span class="token operator">&gt;</span> logger<span class="token punctuation">)</span> <span class="token punctuation">{</span> _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We also had an <code>IJobFactory</code> implementation that retrieved an instance of the job from the DI container when required: </p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingletonJobFactory</span> <span class="token punctuation">:</span> <span class="token class-name">IJobFactory</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IServiceProvider</span> _serviceProvider<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">SingletonJobFactory</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span> _serviceProvider <span class="token operator">=</span> serviceProvider<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IJob</span> <span class="token function">NewJob</span><span class="token punctuation">(</span><span class="token class-name">TriggerFiredBundle</span> bundle<span class="token punctuation">,</span> <span class="token class-name">IScheduler</span> scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _serviceProvider<span class="token punctuation">.</span><span class="token function">GetRequiredService</span><span class="token punctuation">(</span>bundle<span class="token punctuation">.</span>JobDetail<span class="token punctuation">.</span>JobType<span class="token punctuation">)</span> <span class="token keyword">as</span> IJob<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ReturnJob</span><span class="token punctuation">(</span><span class="token class-name">IJob</span> job<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>These services were registered in <code>Startup.ConfigureServices()</code> as singletons:</p>
<pre class="language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">IJobFactory</span><span class="token punctuation">,</span> <span class="token class-name">SingletonJobFactory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">HelloWorldJob</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>That was fine for this very basic example, but what if you need to use some scoped services inside your <code>IJob</code>? For example, maybe you need to use an EF Core <code>DbContext</code> to loop over all your customers, send them an email, and update the customer record. We&apos;ll call that hypothetical task <code>EmailReminderJob</code>.</p> <p>The solution I showed in the previous post is to inject the <code>IServiceProvider</code> into your <code>IJob</code>, create a scope manually, and retrieve the necessary services from that. For example:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmailReminderJob</span> <span class="token punctuation">:</span> <span class="token class-name">IJob</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IServiceProvider</span> _provider<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">EmailReminderJob</span><span class="token punctuation">(</span> <span class="token class-name">IServiceProvider</span> provider<span class="token punctuation">)</span> <span class="token punctuation">{</span> _provider <span class="token operator">=</span> provider<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> _provider<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> dbContext <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token punctuation">&lt;</span><span class="token class-name">AppDbContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> emailSender <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token punctuation">&lt;</span><span class="token class-name">IEmailSender</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In many cases, this approach is absolutely fine. This is especially true if, instead of putting the implementation directly inside the job (as I did above), you use a <a href="https://github.com/jbogard/MediatR">mediator pattern</a> to handle cross-cutting concerns like unit-of-work or message dispatching. </p>
<p>If that&apos;s not the case, you might benefit from creating a helper job that can manage those things for you.</p> <p>To handle these issues, you can create an &quot;intermediary&quot; <code>IJob</code> implementation, <code>QuartzJobRunner</code>, that sits between the <code>IJobFactory</code> and the <code>IJob</code> you want to run. I&apos;ll get to the job implementation shortly, but first lets update the existing <code>IJobFactory</code> implementation to <em>always</em> return an instance of <code>QuartzJobRunner</code>, no matter which job is requested:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection<span class="token punctuation">;</span>
<span class="token keyword">using</span> Quartz<span class="token punctuation">;</span>
<span class="token keyword">using</span> Quartz<span class="token punctuation">.</span>Spi<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JobFactory</span> <span class="token punctuation">:</span> <span class="token class-name">IJobFactory</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IServiceProvider</span> _serviceProvider<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">JobFactory</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span> _serviceProvider <span class="token operator">=</span> serviceProvider<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IJob</span> <span class="token function">NewJob</span><span class="token punctuation">(</span><span class="token class-name">TriggerFiredBundle</span> bundle<span class="token punctuation">,</span> <span class="token class-name">IScheduler</span> scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _serviceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">QuartzJobRunner</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ReturnJob</span><span class="token punctuation">(</span><span class="token class-name">IJob</span> job<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>As you can see, the <code>NewJob()</code> method always returns an instance of <code>QuartzJobRunner</code>. We&apos;ll register <code>QuartzJobRunner</code> as a Singleton in <code>Startup.ConfigureServices()</code>, so we don&apos;t have to worry about the fact it isn&apos;t explicitly disposed.</p>
<pre class="language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">QuartzJobRunner</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>We&apos;ll create the <em>actual</em> required <code>IJob</code> instance inside <code>QuartzJobRunner</code>. The job of <code>QuartzJobRunner</code> is to create a scope, instantiate the requested <code>IJob</code>, and execute it:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection<span class="token punctuation">;</span>
<span class="token keyword">using</span> Quartz<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuartzJobRunner</span> <span class="token punctuation">:</span> <span class="token class-name">IJob</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IServiceProvider</span> _serviceProvider<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">QuartzJobRunner</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span> _serviceProvider <span class="token operator">=</span> serviceProvider<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> _serviceProvider<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> jobType <span class="token operator">=</span> context<span class="token punctuation">.</span>JobDetail<span class="token punctuation">.</span>JobType<span class="token punctuation">;</span> <span class="token keyword">var</span> job <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token function">GetRequiredService</span><span class="token punctuation">(</span>jobType<span class="token punctuation">)</span> <span class="token keyword">as</span> IJob<span class="token punctuation">;</span> <span class="token keyword">await</span> job<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>At this point, you might be wondering what we&apos;ve gained by adding this extra layer of indirection? There&apos;s two main advantages:</p>
<ul>
<li>We can register the <code>EmailReminderJob</code> as a <em>scoped</em> service, and directly inject any dependencies into its constructor</li>
<li>We can move other cross-cutting concerns into the <code>QuartzJobRunner</code> class.</li>
</ul> <p>Due to the fact the job instance is sourced from a scoped <code>IServiceProvder</code>, you can safely consume scoped services in the constructor of your job implementations. This makes the implementation of <code>EmailReminderJob</code> clearer, and follows the typical pattern of constructor injection. DI scoping issues can be tricky to understand if you&apos;re not familiar with them, so anything that stops you cutting yourself seems like a good idea to me:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">DisallowConcurrentExecution</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmailReminderJob</span> <span class="token punctuation">:</span> <span class="token class-name">IJob</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">AppDbContext</span> _dbContext<span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEmailSender</span> _emailSender<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">EmailReminderJob</span><span class="token punctuation">(</span><span class="token class-name">AppDbContext</span> dbContext<span class="token punctuation">,</span> <span class="token class-name">IEmailSender</span> emailSender<span class="token punctuation">)</span> <span class="token punctuation">{</span> _dbContext <span class="token operator">=</span> dbContext<span class="token punctuation">;</span> _emailSender <span class="token operator">=</span> emailSender<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>These <code>IJob</code> implementations can be registered using any lifetime (scoped or transient) in <code>Startup.ConfigureServices()</code> (the <code>JobSchedule</code> can still be a singleton):</p>
<pre class="language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">EmailReminderJob</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JobSchedule</span><span class="token punctuation">(</span> jobType<span class="token punctuation">:</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>EmailReminderJob<span class="token punctuation">)</span><span class="token punctuation">,</span> cronExpression<span class="token punctuation">:</span> <span class="token string">&quot;0 0 12 * * ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <p><code>QuartzJobRunner</code> handles the whole lifecycle of the <code>IJob</code> being executed: it fetches it from the container, executes it, and disposes of it (when the scope is disposed). Consequently, it is well placed for handling other cross-cutting concerns. </p>
<p>For example, imagine you have a service that needs to update the database, and send events to a message bus. You could handle that all inside each of your individual <code>IJob</code> implementations, or you could move the cross-cutting &quot;commit changes&quot; and &quot;dispatch message&quot; actions to the <code>QuartzJobRunner</code> instead.</p>
<blockquote>
<p>This example is obviously very basic. If the code here looks ok to you, I suggest watching <a href="https://www.youtube.com/watch?v=VvUdvte1V3s">Jimmy Bogard&apos;s &quot;Six Little Lines of Fail&quot;</a> talk, which describes some of the issues!</p>
</blockquote>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuartzJobRunner</span> <span class="token punctuation">:</span> <span class="token class-name">IJob</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IServiceProvider</span> _serviceProvider<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">QuartzJobRunner</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span> _serviceProvider <span class="token operator">=</span> serviceProvider<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> _serviceProvider<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> jobType <span class="token operator">=</span> context<span class="token punctuation">.</span>JobDetail<span class="token punctuation">.</span>JobType<span class="token punctuation">;</span> <span class="token keyword">var</span> job <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token function">GetRequiredService</span><span class="token punctuation">(</span>jobType<span class="token punctuation">)</span> <span class="token keyword">as</span> IJob<span class="token punctuation">;</span> <span class="token keyword">var</span> dbContext <span class="token operator">=</span> _serviceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">AppDbContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> messageBus <span class="token operator">=</span> _serviceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">IBus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">await</span> job<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">await</span> dbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">await</span> messageBus<span class="token punctuation">.</span><span class="token function">DispatchAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This implementation of <code>QuartzJobRunner</code> is very similar to the previous one, but before we execute the requested <code>IJob</code>, we retrieve the message bus and <code>DbContext</code> from the DI container. Once the job has successfully executed (i.e. it didn&apos;t throw), we save any uncommitted changes in the <code>DbContext</code>, and dispatch the events on the message bus. </p>
<p>Moving these functions into the <code>QuartzJobRunner</code> should reduce the duplication in your <code>IJob</code> implementations, and will make it easier to move to a more formalised pipeline and other patterns should you wish to later.</p> <p>I like the approach shown in this post (using an intermediate <code>QuartzJobRunner</code> class) for two main reasons:</p>
<ul>
<li>Your other <code>IJob</code> implementations don&apos;t need any knowledge of this infrastructure for creating scopes, and can just just bog-standard constructor injection</li>
<li>The <code>IJobFactory</code> doesn&apos;t have to do anything special to handle disposing jobs. The <code>QuartzJobRunner</code> takes care of that implicitly by creating and disposing of a scope.</li>
</ul>
<p>But the approach shown here isn&apos;t the only way to use scoped services in your jobs. <a href="https://twitter.com/AntarisZX">Matthew Abbot</a> <a href="https://gist.github.com/Antaris/9c3c097d31a90da279e3e6d78497a369">demonstrates an approach in this gist</a> that aims to implement the <code>IJobFactory</code> in a way that correctly disposes of jobs after they&apos;ve been run. It&apos;s a little clunky due to the interface API you have to match, but it&apos;s arguably much closer to the way you <em>should</em> implement it! Personally I think I&apos;ll stick to the <code>QuartzJobRunner</code> approach, but choose whichever works best for you &#x1F642;</p> <p>In this post, I showed how you can create an intermediate <code>IJob</code>, <code>QuartzJobRunner</code>, that is created whenever the scheduler needs to execute a job. This runner handles creating a DI scope, instantiating the requested job, and executing it, so the end <code>IJob</code> implementation can consume scoped services in its constructor. You can also use this approach for configuring a basic pipeline in the <code>QuartzJobRunner</code>, although there are better solutions to this, such as decorators, or behaviours in the <a href="https://github.com/jbogard/MediatR/wiki/Behaviors">MediatR library</a>.</p>
</div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>