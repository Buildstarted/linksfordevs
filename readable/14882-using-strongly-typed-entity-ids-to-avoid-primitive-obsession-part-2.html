<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using strongly-typed entity IDs to avoid primitive obsession (Part 2) -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Using strongly-typed entity IDs to avoid primitive obsession (Part 2)</h1><div><div class="post-content"><p>In my <a href="/using-strongly-typed-entity-ids-to-avoid-primitive-obsession-part-1/">previous post</a>, I described a common problem in which primitive arguments (e.g. <code>System.Guid</code> or <code>string</code>) are passed in the wrong order to a method, resulting in bugs. This problem is a symptom of primitive obsession; using primitive types to represent higher-level concepts. </p><blockquote><p>This post directly follow on from <a href="/using-strongly-typed-entity-ids-to-avoid-primitive-obsession-part-1/">my previous post</a>, so I strongly recommend reading that one first. </p></blockquote><p>In my previous post I described a strongly-typed ID that could be used to represent the ID of an object, for example an <code>OrderId</code> or a <code>UserId</code>. As a reminder, the implementation looked something like this:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">readonly</span><span class="token keyword">struct</span> OrderId <span class="token punctuation">:</span> IComparable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">,</span> IEquatable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">Guid</span> Value <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token function">OrderId</span><span class="token punctuation">(</span><span class="token class-name">Guid</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Value <span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token class-name">OrderId</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>One of the common complaints when fighting primitive obsession like this, is that it makes things more complex at the "edges" of the system, when converting between <code>Guid</code> and <code>OrderId</code> for example. The best answer to this is to try to use the strongly-typed IDs <em>everywhere</em>. </p><p>With the implementation described so far, this is easier said than done, so in this post I'll describe some helper classes you can use with strongly-typed IDs to make working with ASP.NET Core APIs simpler.</p><p><strong>tl;dr;</strong> You can skip to <a href="#a-full-example-implementation">a complete example implementation</a> including all the converters or <a href="#that-s-a-lot-of-boilerplate-code-">a Visual Studio snippet</a> if you wish.</p><h2 id="strongly-typed-ids-make-for-ugly-json-apis" class="heading-with-anchor">Strongly-typed IDs make for ugly JSON APIs<a href="#strongly-typed-ids-make-for-ugly-json-apis"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Lets imagine that you have a standard eCommerce app, <a href="/using-strongly-typed-entity-ids-to-avoid-primitive-obsession-part-1/#an-example-of-the-problem">as in the previous post</a>. You have an MVC API controller for your <code>Order</code>s, containing a single <code>Post</code> action for creating <code>Order</code>s.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">OrderController</span><span class="token punctuation">:</span><span class="token class-name">ControllerBase</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token class-name">IActionResult</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>As we have a strongly-typed IDs <code>Order</code>s and <code>User</code>s, the <code>Order</code> object now looks something like the following (instead of using <code>Guid</code>s for IDs):</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">Order</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">OrderId</span> Id <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">UserId</span> UserId <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">decimal</span> Total <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The problem is that our strongly-typed IDs mean that for MVC Model Binding to work as we expect, the posted JSON body would have to look something like this:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"Id"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"Value"</span><span class="token operator">:</span><span class="token string">"da63f7a0-a4a6-4dbe-a9a4-4bb72dde30dd"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"UserId"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"Value"</span><span class="token operator">:</span><span class="token string">"4bb20f98-f6d4-43bc-9fdf-5b74ce4ef751"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"Total"</span><span class="token operator">:</span><span class="token number">123.45</span><span class="token punctuation">}</span></code></pre><blockquote><p>Reading over this again, I actually don't think model binding would work at all in this case, though I haven't tested it since.</p></blockquote><p>Urgh, that's a bit of a mess. Luckily, we can simplify this using a <a href="https://www.newtonsoft.com/json/help/html/CustomJsonConverter.htm">custom <code>JsonConverter</code></a>. </p><h2 id="creating-a-custom-jsonconverter" class="heading-with-anchor">Creating a custom <code>JsonConverter</code><a href="#creating-a-custom-jsonconverter"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p><code>JsonConverter</code> in <a href="https://www.newtonsoft.com/json/help/html/CustomJsonConverter.htm">Newtonsoft.Json</a> can be used to customise how types are converted to and from JSON. in ASP.NET Core 2.x that also allows you to customize how types are serialised and deserialised during model binding. </p><blockquote><p>Note that in ASP.NET Core 3.0 JSON serialization will be changing. See <a href="https://github.com/dotnet/corefx/issues/33115">this GitHub issue</a> for details.</p></blockquote><p>The following example shows how to create a <code>JsonConverter</code> as a nested class of the strongly-typed ID. I've hidden the bulk of the <code>OrderId</code> class for brevity, but make sure to decorate the main strongly-typed ID class with the <code>[JsonConverter]</code> attribute:</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">JsonConverter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>OrderIdJsonConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">readonly</span><span class="token keyword">struct</span> OrderId <span class="token punctuation">:</span> IComparable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">,</span> IEquatable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">class</span><span class="token class-name">OrderIdJsonConverter</span><span class="token punctuation">:</span><span class="token class-name">JsonConverter</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">bool</span><span class="token function">CanConvert</span><span class="token punctuation">(</span><span class="token class-name">Type</span> objectType<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> objectType <span class="token operator">==</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">void</span><span class="token function">WriteJson</span><span class="token punctuation">(</span><span class="token class-name">JsonWriter</span> writer<span class="token punctuation">,</span><span class="token keyword">object</span><span class="token keyword">value</span><span class="token punctuation">,</span><span class="token class-name">JsonSerializer</span> serializer<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> id <span class="token operator">=</span><span class="token punctuation">(</span>OrderId<span class="token punctuation">)</span><span class="token keyword">value</span><span class="token punctuation">;</span>
            serializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> id<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">object</span><span class="token function">ReadJson</span><span class="token punctuation">(</span><span class="token class-name">JsonReader</span> reader<span class="token punctuation">,</span><span class="token class-name">Type</span> objectType<span class="token punctuation">,</span><span class="token keyword">object</span> existingValue<span class="token punctuation">,</span><span class="token class-name">JsonSerializer</span> serializer<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> guid <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token punctuation">&lt;</span><span class="token class-name">Guid</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>guid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Implementing the custom <code>JsonConverter</code> is relatively simple, and relies on the fact Newtonsoft.Json already knows how to serialize and deserialize <code>Guid</code>s:</p><ul><li>Override <code>CanConvert</code>: This converter can only convert <code>OrderId</code> types.</li><li>Override <code>WriteJson</code>: To serialize an <code>OrderId</code>, extract the <code>Guid Value</code>, and serialize that.</li><li>Override <code>ReadJson</code>: Start by deserializing a <code>Guid</code>, and create an <code>OrderId</code> from that. </li></ul><p>By using a custom <code>JsonConverter</code>, the serialized <code>Order</code> looks much cleaner and easier to work with:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"Id"</span><span class="token operator">:</span><span class="token string">"da63f7a0-a4a6-4dbe-a9a4-4bb72dde30dd"</span><span class="token punctuation">,</span><span class="token property">"UserId"</span><span class="token operator">:</span><span class="token string">"4bb20f98-f6d4-43bc-9fdf-5b74ce4ef751"</span><span class="token punctuation">,</span><span class="token property">"Total"</span><span class="token operator">:</span><span class="token number">123.45</span><span class="token punctuation">}</span></code></pre><p>In fact, it's exactly the same as the original <code>Order</code> object was before we converted to strongly-typed IDs.</p><p>So that's the JSON support working, lets move on to looking at another API method, a <code>GET</code> method.</p><h2 id="using-strongly-typed-ids-in-route-constraints" class="heading-with-anchor">Using strongly-typed IDs in route constraints<a href="#using-strongly-typed-ids-in-route-constraints"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>A common pattern with REST APIs is to include the ID of a resource in the URL. For example:</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">OrderController</span><span class="token punctuation">:</span><span class="token class-name">ControllerBase</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{id}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span> ActionResult<span class="token operator">&lt;</span>Order<span class="token operator">&gt;</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">OrderId</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>In this example, you'd expect to be able to retrieve an <code>Order</code> object from the API by sending a <code>GET</code> request to <code>/Order/7b-46-0c4</code>, where <code>7b-46-0c4</code> is the ID of the order (shortened for brevity). Unfortunately, if you try this, you'll get a slightly confusing <code>415 Unsupported Media Type</code> response:</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span><span class="token string">"https://tools.ietf.org/html/rfc7231#section-6.5.13"</span>,<span class="token string">"title"</span><span class="token keyword">:</span><span class="token string">"Unsupported Media Type"</span>,<span class="token string">"status"</span>:415,<span class="token string">"traceId"</span><span class="token keyword">:</span><span class="token string">"0HLLI5VFOFT3C:00000003"</span><span class="token punctuation">}</span></code></pre><p><img src="/content/images/2019/strongly_typed_id_1.png" alt="Unsupported Media Type response"></p><p>The problem is that the MVC framework doesn't know how to convert the string route segment <code>"7b-46-0c4"</code> into your <code>OrderId</code> type. We have a JSON converter that can convert strings to the <code>OrderId</code> type, but we're not converting from a JSON body in this case. </p><h2 id="creating-a-custom-type-converter" class="heading-with-anchor">Creating a custom type converter<a href="#creating-a-custom-type-converter"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>There's a couple of different ways you could solve this problem:</p><p>Creating a custom model binder is a relatively involved affair, but it gives you complete control over the binding process. In our case, we just need a simple <code>string</code> to <code>OrderId</code> conversion, and the <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/advanced/custom-model-binding?view=aspnetcore-2.2#model-binding-review">documentation suggests you should use a type converter</a> in this case. </p><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.componentmodel.typeconverter?view=netframework-4.7.2">Type converters</a> provide "a unified way of converting types of values to other types". In our case, all we need to support is converting from a <code>string</code> to <code>OrderId</code>. </p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">JsonConverter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>OrderIdJsonConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">TypeConverter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>OrderIdTypeConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">readonly</span><span class="token keyword">struct</span> OrderId <span class="token punctuation">:</span> IComparable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">,</span> IEquatable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">class</span><span class="token class-name">OrderIdTypeConverter</span><span class="token punctuation">:</span><span class="token class-name">TypeConverter</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">bool</span><span class="token function">CanConvertFrom</span><span class="token punctuation">(</span><span class="token class-name">ITypeDescriptorContext</span> context<span class="token punctuation">,</span><span class="token class-name">Type</span> sourceType<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> sourceType <span class="token operator">==</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">CanConvertFrom</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> sourceType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">object</span><span class="token function">ConvertFrom</span><span class="token punctuation">(</span><span class="token class-name">ITypeDescriptorContext</span> context<span class="token punctuation">,</span><span class="token class-name">CultureInfo</span> culture<span class="token punctuation">,</span><span class="token keyword">object</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> stringValue <span class="token operator">=</span><span class="token keyword">value</span><span class="token keyword">as</span><span class="token keyword">string</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>stringValue<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span> Guid<span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>stringValue<span class="token punctuation">,</span><span class="token keyword">out</span><span class="token keyword">var</span> guid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>guid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span><span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">ConvertFrom</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> culture<span class="token punctuation">,</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Derive from the base <code>TypeConverter</code> class, and override the <code>CanConvertFrom</code> method to indicate that you can handle <code>string</code>s. I've created the implementation as a nested class of <code>OrderId</code> for tidiness. </p><p>In the <code>ConvertFrom</code> method override, cast the provided value to a <code>string</code>, and try to parse it into a <code>Guid</code>. If all goes well, you can return a new <code>OrderId</code>, otherwise, just delegate to the base implementation. </p><p>Finally, decorate your strongly-typed ID with the <code>[TypeConverter]</code> attribute, and reference your implementation. </p><p>That's all you need to fix your issues - no extra types to register with the MVC framework and no messing with custom model binding or providers. I was actually surprised how simple this approach was, having never used <code>TypeConverter</code>s before! </p><p><img src="/content/images/2019/strongly_typed_id.png" alt="Example of the request working"></p><blockquote><p><a href="https://disq.us/p/213e7lq">Martin Liversage noted</a> that JSON.NET will use a <code>TypeConverter</code> where one exists, so you generally don't need <a href="#strongly-typed-ids-make-for-ugly-json-apis">the custom <code>JsonConverter</code> at all</a>!</p></blockquote><h2 id="other-type-converters-for-interfacing-with-the-world-" class="heading-with-anchor">Other type converters for interfacing with the world.<a href="#other-type-converters-for-interfacing-with-the-world-"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>With the two converters described above, you should be able to work seamlessly with your ASP.NET Core APIs, so there's no excuse for passing on using strongly-typed IDs there! </p><p>At the other end of the application, at the database, you may want to create similar converters. Given the number of possible ORMs and micro-ORMs, I won't go into the details here, but most will provide this functionality. For example, you can <a href="https://medium.com/dapper-net/custom-type-handling-4b447b97c620">create a custom <code>TypeHandler&lt;T&gt;</code> for Dapper</a> which would look something like the following:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">class</span><span class="token class-name">OrderIdTypeHandler</span><span class="token punctuation">:</span><span class="token class-name">SqlMapper<span class="token punctuation">.</span>TypeHandler</span><span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">void</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token class-name">IDbDataParameter</span> parameter<span class="token punctuation">,</span><span class="token class-name">OrderId</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        parameter<span class="token punctuation">.</span>Value <span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token class-name">OrderId</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Guid<span class="token punctuation">)</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>You would just need to register the custom handler with Dapper using <code>SqlMapper.AddTypeHandler(new OrderIdTypeHandler());</code></p><h2 id="a-full-example-implementation" class="heading-with-anchor">A full example implementation<a href="#a-full-example-implementation"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>I've been dribbling bits of implementation out in this post, so below is a full example implementation for an imaginary <code>FooId</code> type, including custom <code>JsonConverter</code> and a custom <code>TypeConverter</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">JsonConverter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>FooIdJsonConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">TypeConverter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>FooIdTypeConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">readonly</span><span class="token keyword">struct</span> FooId <span class="token punctuation">:</span> IComparable<span class="token operator">&lt;</span>FooId<span class="token operator">&gt;</span><span class="token punctuation">,</span> IEquatable<span class="token operator">&lt;</span>FooId<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">Guid</span> Value <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token function">FooId</span><span class="token punctuation">(</span><span class="token class-name">Guid</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Value <span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token class-name">FooId</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">new</span><span class="token class-name">FooId</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token class-name">FooId</span> Empty <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">FooId</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">bool</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token class-name">FooId</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">int</span><span class="token function">CompareTo</span><span class="token punctuation">(</span><span class="token class-name">FooId</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> Value<span class="token punctuation">.</span><span class="token function">CompareTo</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">bool</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token keyword">object</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token keyword">false</span><span class="token punctuation">;</span><span class="token keyword">return</span> obj <span class="token keyword">is</span><span class="token class-name">FooId</span> other <span class="token operator">&amp;&amp;</span><span class="token function">Equals</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">int</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> Value<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">string</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> Value<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">bool</span><span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span><span class="token class-name">FooId</span> a<span class="token punctuation">,</span><span class="token class-name">FooId</span> b<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> a<span class="token punctuation">.</span><span class="token function">CompareTo</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">bool</span><span class="token keyword">operator</span><span class="token operator">!=</span><span class="token punctuation">(</span><span class="token class-name">FooId</span> a<span class="token punctuation">,</span><span class="token class-name">FooId</span> b<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token operator">!</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span><span class="token class-name">FooIdJsonConverter</span><span class="token punctuation">:</span><span class="token class-name">JsonConverter</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">void</span><span class="token function">WriteJson</span><span class="token punctuation">(</span><span class="token class-name">JsonWriter</span> writer<span class="token punctuation">,</span><span class="token keyword">object</span><span class="token keyword">value</span><span class="token punctuation">,</span><span class="token class-name">JsonSerializer</span> serializer<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> id <span class="token operator">=</span><span class="token punctuation">(</span>FooId<span class="token punctuation">)</span><span class="token keyword">value</span><span class="token punctuation">;</span>
            serializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> id<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">object</span><span class="token function">ReadJson</span><span class="token punctuation">(</span><span class="token class-name">JsonReader</span> reader<span class="token punctuation">,</span><span class="token class-name">Type</span> objectType<span class="token punctuation">,</span><span class="token keyword">object</span> existingValue<span class="token punctuation">,</span><span class="token class-name">JsonSerializer</span> serializer<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> guid <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token punctuation">&lt;</span><span class="token class-name">Guid</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token keyword">new</span><span class="token class-name">FooId</span><span class="token punctuation">(</span>guid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">bool</span><span class="token function">CanConvert</span><span class="token punctuation">(</span><span class="token class-name">Type</span> objectType<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> objectType <span class="token operator">==</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>FooId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span><span class="token class-name">FooIdTypeConverter</span><span class="token punctuation">:</span><span class="token class-name">TypeConverter</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">bool</span><span class="token function">CanConvertFrom</span><span class="token punctuation">(</span><span class="token class-name">ITypeDescriptorContext</span> context<span class="token punctuation">,</span><span class="token class-name">Type</span> sourceType<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> sourceType <span class="token operator">==</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">CanConvertFrom</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> sourceType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">object</span><span class="token function">ConvertFrom</span><span class="token punctuation">(</span><span class="token class-name">ITypeDescriptorContext</span> context<span class="token punctuation">,</span><span class="token class-name">CultureInfo</span> culture<span class="token punctuation">,</span><span class="token keyword">object</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> stringValue <span class="token operator">=</span><span class="token keyword">value</span><span class="token keyword">as</span><span class="token keyword">string</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>stringValue<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span> Guid<span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>stringValue<span class="token punctuation">,</span><span class="token keyword">out</span><span class="token keyword">var</span> guid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token keyword">new</span><span class="token class-name">FooId</span><span class="token punctuation">(</span>guid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span><span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">ConvertFrom</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> culture<span class="token punctuation">,</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="that-s-a-lot-of-boilerplate-code-" class="heading-with-anchor">That's a lot of boilerplate code!<a href="#that-s-a-lot-of-boilerplate-code-"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Yes, I know. That's a lot of code for a simple ID type. I still think it's worth it, but there's no denying it's verbose… </p><blockquote><p>All the F# devs shouting at the screen right now…</p></blockquote><p>To try and counteract that somewhat, I've created a Visual Studio Snippet <a href="https://docs.microsoft.com/en-us/visualstudio/ide/walkthrough-creating-a-code-snippet?view=vs-2017#add-a-code-snippet-to-visual-studio">as described in the docs</a>. Copy the XML below into a file (<a href="/content/files/typedid.snippet">or download the snippet from here</a>) and <a href="https://docs.microsoft.com/en-us/visualstudio/ide/walkthrough-creating-a-code-snippet?view=vs-2017#add-a-code-snippet-to-visual-studio">import it into your IDE</a>. </p><p>Once it's imported, you can type <code>typedid</code>, hit <code>Tab</code> twice, type a new name for the ID and auto-generate all of that code! Note that you may need to add <code>Newtonsoft.Json</code> as a NuGet reference to your project if it's not already referenced.</p><p><img src="/content/images/2019/snippet.gif" alt="Screencast of the snippet in action"></p><p><a href="/content/files/typedid.snippet">The snippet</a> - feel free to customize as you see fit!</p><pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CodeSnippets</span><span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/VisualStudio/2005/CodeSnippet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CodeSnippet</span><span class="token attr-name">Format</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1.0.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Title</span><span class="token punctuation">&gt;</span></span>Strongly Typed ID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Description</span><span class="token punctuation">&gt;</span></span>Create a strongly typed ID struct<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Description</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Shortcut</span><span class="token punctuation">&gt;</span></span>typedid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Shortcut</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HelpUrl</span><span class="token punctuation">&gt;</span></span>https://andrewlock.net/using-strongly-typed-entity-ids-to-avoid-primitive-obsession-part-2/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HelpUrl</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Header</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Snippet</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Declarations</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Literal</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ID</span><span class="token punctuation">&gt;</span></span>TypedId<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ID</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToolTip</span><span class="token punctuation">&gt;</span></span>Replace with the name of your type<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToolTip</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Default</span><span class="token punctuation">&gt;</span></span>TypedId<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Default</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Literal</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Declarations</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Code</span><span class="token attr-name">Language</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>csharp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[[JsonConverter(typeof($TypedId$JsonConverter))]
    [TypeConverter(typeof($TypedId$TypeConverter))]
    public readonly struct $TypedId$ : IComparable&lt;$TypedId$&gt;, IEquatable&lt;$TypedId$&gt;
    {
        public Guid Value { get; }

        public $TypedId$(Guid value)
        {
            Value = value;
        }

        public static $TypedId$ New() =&gt; new $TypedId$(Guid.NewGuid());
        public static $TypedId$ Empty { get; } = new $TypedId$(Guid.Empty);

        public bool Equals($TypedId$ other) =&gt; this.Value.Equals(other.Value);
        public int CompareTo($TypedId$ other) =&gt; Value.CompareTo(other.Value);

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj)) return false;
            return obj is $TypedId$ other &amp;&amp; Equals(other);
        }

        public override int GetHashCode() =&gt; Value.GetHashCode();

        public override string ToString() =&gt; Value.ToString();
        public static bool operator ==($TypedId$ a, $TypedId$ b) =&gt; a.CompareTo(b) == 0;
        public static bool operator !=($TypedId$ a, $TypedId$ b) =&gt; !(a == b);

        class $TypedId$JsonConverter : JsonConverter
        {
            public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
            {
                var id = ($TypedId$)value;
                serializer.Serialize(writer, id.Value);
            }

            public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
            {
                var guid = serializer.Deserialize&lt;Guid&gt;(reader);
                return new $TypedId$(guid);
            }

            public override bool CanConvert(Type objectType)
            {
                return objectType == typeof($TypedId$);
            }
        }

        class $TypedId$TypeConverter : TypeConverter
        {
            public override bool CanConvertFrom(ITypeDescriptorContext context, Type sourceType)
            {
                return sourceType == typeof(string) || base.CanConvertFrom(context, sourceType);
            }

            public override object ConvertFrom(ITypeDescriptorContext context, CultureInfo culture, object value)
            {
                var stringValue = value as string;
                if (!string.IsNullOrEmpty(stringValue)
                    &amp;&amp; Guid.TryParse(stringValue, out var guid))
                {
                    return new $TypedId$(guid);
                }

                return base.ConvertFrom(context, culture, value);

            }
        }
    }]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Code</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Imports</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Namespace</span><span class="token punctuation">&gt;</span></span>System<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Namespace</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Namespace</span><span class="token punctuation">&gt;</span></span>System.ComponentModel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Namespace</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Namespace</span><span class="token punctuation">&gt;</span></span>System.Globalization<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Namespace</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Namespace</span><span class="token punctuation">&gt;</span></span>Newtonsoft.Json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Namespace</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Import</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Imports</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Snippet</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CodeSnippet</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CodeSnippets</span><span class="token punctuation">&gt;</span></span></code></pre><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Strongly-typed IDs can help avoid simple, but hard-to-spot, argument transposition errors. By using the types defined in this post, you can get all the benefits of the C# type system, without making your APIs clumsy to use, or adding translation code back-and-forth between <code>Guid</code>s and your strongly-typed IDs. In this post I showed how to create a custom <code>TypeConverter</code> and a custom <code>JsonConverter</code> for your types. Finally, I provided a complete example implementation, and a Visual Studio snippet for generating strongly-typed IDs in your own project. </p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>