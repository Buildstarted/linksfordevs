<!DOCTYPE html>
<html lang="en">
<head>
    <title>
The most copied StackOverflow snippet of all time is flawed! -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>The most copied StackOverflow snippet of all time is flawed!</h1>
    <article> <p><strong>In a recent study titled <em>Usage and Attribution of Stack Overflow Code Snippets in GitHub Projects</em>, an <a href="https://stackoverflow.com/a/3758880/276052">answer</a> I wrote almost a decade ago was found to be the most copied snippet on Stack Overflow. Ironically it happens to be buggy.</strong></p> <h2>A Long Long Time Ago&#x2026;</h2> <p>Back in 2010 I was sitting in my office and doing what I wasn&#x2019;t supposed to be doing: code golfing and chasing reputation on Stack Overflow.</p> <p>The following question got my attention: How do you print a byte count in a human readable format? That is, how do you format something like 123,456,789 bytes as &#x201C;123.5&#xA0;MB&#x201D;.</p> <div> <a href="https://stackoverflow.com/q/3758606/276052"><img alt="How to convert byte size into human-readable format in Java? Like 1024 should become &apos;1 Kb&apos; and 1024*1024 should become &apos;1 Mb&apos;." class="screenshot" src="the-most-copied-so-snippet/so-screenshot.png"></a> <div class="caption"> <p>The good ol&#x2019; 2010 look, courtesy the <a href="https://archive.org/web/">Wayback Machine</a>.</p> </div> </div> <p>The implicit spec here is that the resulting string should have a value between 1 and 999.9 followed by a suffix with an appropriate magnitude.</p> <p>One answer had already been posted. The code in that answer was based on a loop. The idea was simple: Try all magnitudes, going from the largest (EB = 10<sup>18</sup> bytes) down to the smallest (B = 1 byte) and use the first one that is smaller than the number of bytes. In pseudo code it looks something like this:</p> <pre><code>suffixes = [ <p class="text_lit">&quot;EB&quot;</p>, <p class="text_lit">&quot;PB&quot;</p>, <p class="text_lit">&quot;TB&quot;</p>, <p class="text_lit">&quot;GB&quot;</p>, <p class="text_lit">&quot;MB&quot;</p>, <p class="text_lit">&quot;kB&quot;</p>, <p class="text_lit">&quot;B&quot;</p> ]
magnitudes = [ <p class="num_lit">10<sup>18</sup></p>, <p class="num_lit">10<sup>15</sup></p>, <p class="num_lit">10<sup>12</sup></p>, <p class="num_lit">10<sup>9</sup></p>, <p class="num_lit">10<sup>6</sup></p>, <p class="num_lit">10<sup>3</sup></p>, <p class="num_lit">10<sup>0</sup></p> ]
i = <p class="num_lit">0</p>
<p class="keyword">while</p> (i &lt; magnitudes.length &amp;&amp; magnitudes[i] &gt; byteCount) i++
printf(<p class="text_lit">&quot;%.1f %s&quot;</p>, byteCount / magnitudes[i], suffixes[i])
</code></pre> <p>Usually when there&#x2019;s a correct answer posted that already has a positive score, it&#x2019;s hard to catch up with it. In Stack Overflow lingo it&#x2019;s referred to as the <a href="https://meta.stackexchange.com/q/9731/147319">Fastest Gun in the West Problem</a>. In this case the existing answer had a few flaws, so I still saw an opportunity to top it. At the very least, the loop based code could be cleaned up significantly.</p> <h2>This is Algebra, I know this!</h2> <p>Then it hit me. The kB, MB, GB,&#xA0;&#x2026; suffixes are nothing but powers of 1000 (or 1024 in <a href="https://en.wikipedia.org/wiki/Binary_prefix">IEC standard</a>) which means it should be possible to compute the right suffix using logarithms instead of a loop.</p> <p>Based on this idea, I posted the following:</p> <pre><code class="dynamic-font-size"><p class="keyword">public</p> <p class="keyword">static</p> <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a> <p class="static_method">humanReadableByteCount</p>(<p class="keyword">long</p> <p class="type">bytes</p>, <p class="keyword">boolean</p> <p class="type">si</p>) { <p class="keyword">int</p> <p class="type">unit</p> = <p class="type">si</p> ? <p class="num_lit">1000</p> : <p class="num_lit">1024</p>; <p class="keyword">if</p> (<p class="type">bytes</p> &lt; <p class="type">unit</p>) <p class="keyword">return</p> <p class="type">bytes</p> + <p class="text_lit">&quot; B&quot;</p>; <p class="keyword">int</p> <p class="type">exp</p> = (<p class="keyword">int</p>) (<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#log-double-"><p class="static_method">log</p></a>(<p class="type">bytes</p>) / <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#log-double-"><p class="static_method">log</p></a>(<p class="type">unit</p>)); <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a> <p class="type">pre</p> = (<p class="type">si</p> ? <p class="text_lit">&quot;kMGTPE&quot;</p> : <p class="text_lit">&quot;KMGTPE&quot;</p>).<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#charAt-int-"><p class="method">charAt</p></a>(<p class="type">exp</p>-<p class="num_lit">1</p>) + (<p class="type">si</p> ? <p class="text_lit">&quot;&quot;</p> : <p class="text_lit">&quot;i&quot;</p>); <p class="keyword">return</p> <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#format-java.lang.String-java.lang.Object:A-"><p class="static_method">format</p></a>(<p class="text_lit">&quot;%.1f %sB&quot;</p>, <p class="type">bytes</p> / <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#pow-double-double-"><p class="static_method">pow</p></a>(<p class="type">unit</p>, <p class="type">exp</p>), <p class="type">pre</p>);
}</code></pre> <p>Granted it&#x2019;s not very readable and <span class="no-wrap">log&#x2009;/&#x2009;pow</span> probably makes it less efficient than other solutions. But there were no loops and almost no branching which I thought was pretty neat.</p> <div class="article-box"> <p><strong>The math behind this</strong> is straight forward. The byte count is expressed as <span class="no-wrap">byteCount&#x205F;=&#x205F;1000<sup><em>s</em></sup></span> where <em>s</em> represents the scale. (For binary notation, base 1024 is used.) Solving for <em>s</em> gives <span class="no-wrap"><em>s</em>&#x205F;=&#x205F;log<sub>1000</sub>(byteCount)</span>.</p> <p>There&#x2019;s no log<sub>1000</sub> readily available in the API, but we can express it in terms of the natural logarithm as follows <span class="no-wrap"><em>s</em>&#x205F;=&#x205F;log(byteCount)&#x205F;/&#x205F;log(1000)</span>. We then floor <em>s</em> (cast to int) since if we for example have more than one megabyte (but not a full gigabyte) we want to use MB as magnitude.</p> <p>At this point if <span class="no-wrap"><em>s</em>&#x205F;=&#x205F;1</span> the scale is kilobytes, if <span class="no-wrap"><em>s</em>&#x205F;=&#x205F;2</span> the scale is megabytes, and so on. We divide the byteCount with 1000<sup><em>s</em></sup> and slap on the corresponding letter prefix.</p> </div> <p>All I could do now was to wait and see if the community would appreciate the answer. Little did I know that this would become the most copied snippet on Stack Overflow.</p> <h2>A Study on Attribution</h2> <p>Fast forward to 2018. A PhD student by the name Sebastian Baltes publishes a paper in the journal of <em>Empirical Software Engineering</em>. The title is <a href="https://doi.org/10.1007/s10664-018-9650-5"><em>Usage and Attribution of Stack Overflow Code Snippets in GitHub Projects</em></a> and it basically tries to answer one question: Is Stack Overflow&#x2019;s CC BY-SA 3.0 license respected? I.e. to what extent is proper attribution given, when copying code from Stack Overflow.</p> <p>As part of their analysis they extracted code snippets from the <a href="https://archive.org/details/stackexchange">Stack Overflow data dump</a> and matched them against code from public GitHub repos. Quoting the abstract:</p> <blockquote> <p><em>We present results of a large-scale empiricalstudy analyzing the usage and attribution of non-trivial Java code snippetsfrom SO answers in public GitHub (GH) projects.</em></p> </blockquote> <p>(Spoiler alert: No, most people do not include proper attribution.)</p> <p>In the paper, they include the following table:</p> <p>That answer at the top with id <a href="https://stackoverflow.com/a/3758880/276052">3758880</a> happens to be the answer I had posted eight years earlier. At this point the answer had over a hundreds of thousands of views and over a thousand upvotes.</p> <p>A quick search on GitHub indeed shows thousands of occurrences of <code>humanReadableByteCount</code>.</p> <p><img class="screenshot" src="the-most-copied-so-snippet/github-search.png"></p> <p>To check if you happen to have the code in a locally checked out repo:</p> <pre><code>$ git grep humanReadableByteCount
</code></pre> <div class="article-box"> <p><strong>Fun side story:</strong> How did I first hear about this study?</p> <p>Sebastian had found a match in the OpenJDK repository. There was no attribution and the OpenJDK license is not compatible with CC BY-SA 3.0. He <a href="http://mail.openjdk.java.net/pipermail/jdk9-dev/2016-December/005327.html">reached out to the dev mailing list</a> asking if the code on Stack Overflow was copied from OpenJDK, or if it was the other way around.</p> <p>The funny part here is that I used to work at Oracle, on the OpenJDK project, so a former colleague and friend of mine <a href="http://mail.openjdk.java.net/pipermail/jdk9-dev/2016-December/005328.html">replied</a> with the following:</p> <div class="indented"> <p>Hi,</p> <p>why not ask the author of this SO post (aioobe) directly? He is an OpenJDK contributor and was employed by Oracle at the time this code appeared in the OpenJDK source repos.</p> <p>/Claes</p> </div> <p>Oracle doesn&#x2019;t take these things lightly. I happen to know that some people at Oracle took a sigh of relief when they read this reply, and saw it as a bit of a triumph after the &#x201C;accusation&#x201D;.</p> <p>Sebastian then reached out to me to straighten it out, which I did: I had <em>not</em> yet started at Oracle when that commit was merged, and I did <em>not</em> contribute that patch. Jokes on Oracle. Shortly after an issue was <a href="https://bugs.openjdk.java.net/browse/JDK-8170860">filed</a> and the code was <a href="http://hg.openjdk.java.net/jdk9/jdk9/hotspot/rev/b552b596203f">removed</a>.</p> </div> <h2>The Bug</h2> <p>I bet you&#x2019;ve already given it some thought. What is that bug in the code snippet?</p> <p>Here it is again:</p> <pre><code class="dynamic-font-size"><p class="keyword">public</p> <p class="keyword">static</p> <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a> <p class="static_method">humanReadableByteCount</p>(<p class="keyword">long</p> <p class="type">bytes</p>, <p class="keyword">boolean</p> <p class="type">si</p>) { <p class="keyword">int</p> <p class="type">unit</p> = <p class="type">si</p> ? <p class="num_lit">1000</p> : <p class="num_lit">1024</p>; <p class="keyword">if</p> (<p class="type">bytes</p> &lt; <p class="type">unit</p>) <p class="keyword">return</p> <p class="type">bytes</p> + <p class="text_lit">&quot; B&quot;</p>; <p class="keyword">int</p> <p class="type">exp</p> = (<p class="keyword">int</p>) (<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#log-double-"><p class="static_method">log</p></a>(<p class="type">bytes</p>) / <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#log-double-"><p class="static_method">log</p></a>(<p class="type">unit</p>)); <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a> <p class="type">pre</p> = (<p class="type">si</p> ? <p class="text_lit">&quot;kMGTPE&quot;</p> : <p class="text_lit">&quot;KMGTPE&quot;</p>).<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#charAt-int-"><p class="method">charAt</p></a>(<p class="type">exp</p>-<p class="num_lit">1</p>) + (<p class="type">si</p> ? <p class="text_lit">&quot;&quot;</p> : <p class="text_lit">&quot;i&quot;</p>); <p class="keyword">return</p> <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#format-java.lang.String-java.lang.Object:A-"><p class="static_method">format</p></a>(<p class="text_lit">&quot;%.1f %sB&quot;</p>, <p class="type">bytes</p> / <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#pow-double-double-"><p class="static_method">pow</p></a>(<p class="type">unit</p>, <p class="type">exp</p>), <p class="type">pre</p>);
}</code></pre> <p>After exabytes, 10<sup>18</sup>, comes zettabytes, 10<sup>21</sup>. Could it be that a really large input causes an index out of bounds on the <code>&quot;kMGTPE&quot;</code> string? Nope. The maximum <code>long</code> value is <span class="no-wrap">2<sup>63</sup>&#x205F;-&#x205F;1&#x205F;&#x2248;&#x205F;9.2&#x205F;&#xD7;&#x205F;10<sup>18</sup></span>, so no <code>long</code> value will ever go beyond EB.</p> <p>Could it be a mix-up between SI and binary? Nope. There was a mix-up in an early version of the answer, but that was fixed rather quickly.</p> <p>Can <code>exp</code> end up being 0 causing <code>charAt(exp-1)</code> to fail? Nope. The first if-statement covers that case. The <code>exp</code> value will always be at least 1.</p> <p>Could there be some weird rounding error in the output? Now we&#x2019;re getting there&#x2026;</p> <h2>Lots of 9&#x2019;s</h2> <p>The solution works all the way up until it approaches 1 MB. When given 999,999 bytes as input, the result (in SI mode) is <code>&quot;1000.0 kB&quot;</code>. While it is true that 999,999 is closer to <span class="no-wrap">1,000&#x205F;&#xD7;&#x205F;1000<sup>1</sup></span> than it is to <span class="no-wrap">999.9&#x205F;&#xD7;&#x205F;1000<sup>1</sup></span>, the 1,000 &#x201C;significand&#x201D; is out of range according to spec. The correct result is <code>&quot;1.0 MB&quot;</code>.</p> <p>FWIW, <em>all</em> 22 answers posted, including the ones using Apache Commons and Android libraries, had this bug (or a variation of it) at the time of writing.</p> <p>So how do we fix this? First of all, we note that the exponent (<code>exp</code>) should change from &#x2018;k&#x2019; to &#x2018;M&#x2019; as soon as the number of bytes is closer to <span class="no-wrap">1&#x205F;&#xD7;&#x205F;1,000<sup>2</sup></span> (1 MB) than it is to <span class="no-wrap">999.9&#x205F;&#xD7;&#x205F;1000<sup>1</sup></span> (999.9 k). This happens at 999,950. Similarly, we should switch from &#x2018;M&#x2019; to &#x2018;G&#x2019; when we pass 999,950,000 and so on.</p> <p>To achieve this we calculate this threshold and bump <code>exp</code> if <code>bytes</code> is larger:</p> <pre><code><p class="keyword">if</p> (<p class="type">bytes</p> &gt;= <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#pow-double-double-"><p class="static_method">pow</p></a>(<p class="type">unit</p>, <p class="type">exp</p>) * (<p class="type">unit</p> - <p class="num_lit">0.05</p>)) <p class="type">exp</p>++;</code></pre> <p>With this change the code works well all the way up until the byte count approaches 1&#xA0;EB.</p> <h2>Even More 9&#x2019;s</h2> <p>Given the input 999,949,999,999,999,999 the result is now <code>1000.0 PB</code> while correct result is <code>999.9 PB</code>. Mathematically the code is accurate, so what&#x2019;s going on here?</p> <p>At this point we&#x2019;re running into the precision limitations of a <code>double</code>.</p> <div class="article-box"> <p>Due to the IEEE 754 representation floating point values close to zero are very dense, and large values are very sparse. In fact, half of all values are found between &#x2212;1 and 1, and when talking large doubles, a value as large as <code>Long.MAX_VALUE</code> means nothing. Literally.</p> <pre><code><span class="keyword">double</span> <span class="type">l1</span> = <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Double.html"><span class="type">Double</span></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Double.html#MAX_VALUE"><span class="static_final_field">MAX_VALUE</span></a>;
<span class="keyword">double</span> <span class="type">l2</span> = <span class="type">l1</span> - <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html"><span class="type">Long</span></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html#MAX_VALUE"><span class="static_final_field">MAX_VALUE</span></a>;
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html"><span class="type">System</span></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#err"><span class="static_final_field">err</span></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/io/PrintStream.html#println-boolean-"><span class="method">println</span></a>(<span class="type">l1</span> == <span class="type">l2</span>);  
</code></pre> <p>See <a href="bits-of-a-floating-point-value.html">Bits of a Floating Point Value</a> for a deep dive.</p> </div> <p>There are two problematic computations:</p> <ul> <li>The division in the <code>String.format</code> argument, and</li> <li>The threshold for bumping <code>exp</code>.</li> </ul> <p>We could switch to <code>BigDecimal</code>, but where&#x2019;s the fun in that?! Besides, it gets messy anyway because there&#x2019;s no <code>BigDecimal</code> log function in the standard API.</p> <h3>Scaling down intermediate values</h3> <p>For the first issue we can scale down the <code>bytes</code> value to a range where the the precision is better, and adjust <code>exp</code> accordingly. The end result is rounded off anyway, so it doesn&#x2019;t matter that we&#x2019;re throwing out the least significant digits.</p> <pre><code class="dynamic-font-size"><p class="keyword">if</p> (<p class="type">exp</p> &gt; <p class="num_lit">4</p>) { <p class="type">bytes</p> /= <p class="type">unit</p>; <p class="type">exp</p>--;
}
</code></pre> <h3>Adjusting the least significant bits</h3> <p>For the second issue, we <em>do</em> care about the least significant bits (999,949,99&#x2026;9 and 999,950,00&#x2026;0 should end up with different exponents) so this issue calls for a different solution.</p> <p>First we note that there are 12 different possible values for the threshold (6 for each mode), and only one of them ends up faulty. The faulty result can be uniquely identified by the fact that it ends with D00<sub>16</sub>. If this is the case we simply adjust it to the correct value.</p> <pre><code class="dynamic-font-size"><p class="keyword">long</p> <p class="type">th</p> = (<p class="keyword">long</p>) (<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#pow-double-double-"><p class="static_method">pow</p></a>(<p class="type">unit</p>, <p class="type">exp</p>) * (<p class="type">unit</p> - <p class="num_lit">0.05</p>));
<p class="keyword">if</p> (<p class="type">exp</p> &lt; <p class="num_lit">6</p> &amp;&amp; <p class="type">bytes</p> &gt;= <p class="type">th</p> - ((<p class="type">th</p> &amp; <p class="num_lit">0xFFF</p>) == <p class="num_lit">0xD00</p> ? <p class="num_lit">52</p> : <p class="num_lit">0</p>)) <p class="type">exp</p>++;
</code></pre> <p>Since we rely on specific bit patterns in floating-point results, we slap on <code>strictfp</code> to ensure it works regardless of the hardware running the code.</p> <h2>Negative input</h2> <p>It&#x2019;s unclear under what circumstances a negative byte count could be relevant, but since Java doesn&#x2019;t have unsigned <code>long</code>, we better deal with it. Right now an input such as &#x2212;10,000 results in <code>-10000 B</code>.</p> <p>Let&#x2019;s introduce <code>absBytes</code>:</p> <pre><code class="dynamic-font-size"><p class="keyword">long</p> <p class="field">absBytes</p> = <p class="type">bytes</p> == <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html"><p class="type">Long</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html#MIN_VALUE"><p class="static_final_field">MIN_VALUE</p></a> ? <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html"><p class="type">Long</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html#MAX_VALUE"><p class="static_final_field">MAX_VALUE</p></a> : <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#abs-int-"><p class="static_method">abs</p></a>(<p class="type">bytes</p>);
</code></pre> <p>The complicated expression is due to the fact that <code>-Long.MIN_VALUE == Long.MIN_VALUE</code>. Now we perform all computations related to <code>exp</code> using <code>absBytes</code> instead of <code>bytes</code>.</p> <h2>Final Version</h2> <p>Here&#x2019;s the final version of the code, golfed and compacted in the spirit of the original version:</p> <pre><code class="dynamic-font-size">
<p class="keyword">public</p> <p class="keyword">static</p> <p class="keyword">strictfp</p> <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a> <p class="static_method">humanReadableByteCount</p>(<p class="keyword">long</p> <p class="type">bytes</p>, <p class="keyword">boolean</p> <p class="type">si</p>) { <p class="keyword">int</p> <p class="type">unit</p> = <p class="type">si</p> ? <p class="num_lit">1000</p> : <p class="num_lit">1024</p>; <p class="keyword">long</p> <p class="type">absBytes</p> = <p class="type">bytes</p> == <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html"><p class="type">Long</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html#MIN_VALUE"><p class="static_final_field">MIN_VALUE</p></a> ? <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html"><p class="type">Long</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html#MAX_VALUE"><p class="static_final_field">MAX_VALUE</p></a> : <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#abs-long-"><p class="static_method">abs</p></a>(<p class="type">bytes</p>); <p class="keyword">if</p> (<p class="type">absBytes</p> &lt; <p class="type">unit</p>) <p class="keyword">return</p> <p class="type">bytes</p> + <p class="text_lit">&quot; B&quot;</p>; <p class="keyword">int</p> <p class="type">exp</p> = (<p class="keyword">int</p>) (<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#log-double-"><p class="static_method">log</p></a>(<p class="type">absBytes</p>) / <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#log-double-"><p class="static_method">log</p></a>(<p class="type">unit</p>)); <p class="keyword">long</p> <p class="type">th</p> = (<p class="keyword">long</p>) (<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#pow-double-double-"><p class="static_method">pow</p></a>(<p class="type">unit</p>, <p class="type">exp</p>) * (<p class="type">unit</p> - <p class="num_lit">0.05</p>)); <p class="keyword">if</p> (<p class="type">exp</p> &lt; <p class="num_lit">6</p> &amp;&amp; <p class="type">absBytes</p> &gt;= <p class="type">th</p> - ((<p class="type">th</p> &amp; <p class="num_lit">0xfff</p>) == <p class="num_lit">0xd00</p> ? <p class="num_lit">52</p> : <p class="num_lit">0</p>)) <p class="type">exp</p>++; <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a> <p class="type">pre</p> = (<p class="type">si</p> ? <p class="text_lit">&quot;kMGTPE&quot;</p> : <p class="text_lit">&quot;KMGTPE&quot;</p>).<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#charAt-int-"><p class="method">charAt</p></a>(<p class="type">exp</p> - <p class="num_lit">1</p>) + (<p class="type">si</p> ? <p class="text_lit">&quot;&quot;</p> : <p class="text_lit">&quot;i&quot;</p>); <p class="keyword">if</p> (<p class="type">exp</p> &gt; <p class="num_lit">4</p>) { <p class="type">bytes</p> /= <p class="type">unit</p>; <p class="type">exp</p> -= <p class="num_lit">1</p>; } <p class="keyword">return</p> <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><p class="type">String</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#format-java.lang.String-java.lang.Object:A-"><p class="static_method">format</p></a>(<p class="text_lit">&quot;%.1f %sB&quot;</p>, <p class="type">bytes</p> / <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html"><p class="type">Math</p></a>.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#pow-double-double-"><p class="static_method">pow</p></a>(<p class="type">unit</p>, <p class="type">exp</p>), <p class="type">pre</p>);
}
</code></pre> <p>Note that this started out as a challenge to avoid loops and excessive branching. After ironing out all corner cases the code is even less readable than the original version. Personally I would not copy this snippet into production code.</p> <p>For <strong>updated code that is of production quality</strong> see separate article: <a href="java/formatting-byte-size-to-human-readable-format.html">Formatting byte size to human readable format</a></p> <h2>Key Takeaways</h2> <ul> <li> <p>Stack Overflow snippets can be buggy, even if they have thousands of upvotes.</p> </li> <li> <p>Test all edge cases, <em>especially</em> for code copied from Stack Overflow.</p> </li> <li> <p>Floating-point arithmetic is hard.</p> </li> <li> <p>Do include proper attribution when copying code. Someone might just call you out on it.</p> </li> </ul> <div> <div class="article-comment" id="c1575414054-aveiSoh5"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/d4a2f69d78ee7a7cd0be47f92ad3a114?d=mp"></div> <div class="article-comment-content"> <div> <p>Whoa! What a writeup. Thanks for sharing</p> </div> <details> <summary class="article-comment-footer"> <span>by Nick&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> </div> </div> <div class="article-comment" id="c1575431393-aet3OPhu"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/af0c24a85eac0b47ac8027eb36e11e75?d=mp"></div> <div class="article-comment-content"> <div> <p>This is a really hard problem.</p> </div> <details> <summary class="article-comment-footer"> <span>by Ssuching&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> </div> </div> <div class="article-comment" id="c1575454325-abeCohl4"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/2f86996e30f54a0d42d93e5904b74e8c?d=mp"></div> <div class="article-comment-content"> <div> <p>Brilliant. Attitude too. Thanks a lot.</p> </div> <details> <summary class="article-comment-footer"> <span>by syjmick&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> </div> </div> <div class="article-comment" id="c1575455440-sho7Gaey"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/a01d535d38a2fe0aff4a981308915203?d=mp"></div> <div class="article-comment-content"> <div> <p>I think key takeaway here is: prefer short and simple loops over math. As you already said, the math is very hard to get exactly right (so, error prone and hard to read). But I believe it is also at least an order of magnitude slower than the loop-based solution.</p> <p>Did you run any benchmarks?</p> </div> <details> <summary class="article-comment-footer"> <span>by Ivan&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> <div class="article-comment" id="c1575475836-aoeu"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/99e100243aaa8b1469b1ed4e8bbecb06?d=mp"></div> <div class="article-comment-content"> <div> <p>In general I agree with you. In this particular case however, one should note that the rounding error, negative input, and floating-point precision problems would apply also to a simple loop solution.</p> <p>I have not done any benchmarking. Would be interesting for sure.</p> </div> <details> <summary class="article-comment-footer"> <span>by Andreas Lundblad&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> </div> </div> </div> </div> <div class="article-comment" id="c1575468068-Ai0eengu"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/4d400194f4d28fee7487eb826d463d9e?d=mp"></div> <div class="article-comment-content"> <div> <p>This is fantastically done. Thanks for posting this.</p> </div> <details> <summary class="article-comment-footer"> <span>by John Doe&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> </div> </div> <div class="article-comment" id="c1575532582-etha1ahJ"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/a2452b2d1c9315f8cc62c7290c9a26f2?d=mp"></div> <div class="article-comment-content"> <div> <p>This is very interesting article, I worked with floating point but always had difficulty to grasp the special cases of rounding. This article is good academic view of special cases to consider.</p> <p>Thanks! Five stars for this article.</p> </div> <details> <summary class="article-comment-footer"> <span>by Audiory&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> </div> </div> <div class="article-comment" id="c1575555484-auGh7hai"> <div class="article-comment-avatar"><img alt="User avatar" src="https://www.gravatar.com/avatar/38b8a18199083b31074a90b47810b1ce?d=mp"></div> <div class="article-comment-content"> <div> <p>This article was quite a journey! Thanks :)</p> </div> <details> <summary class="article-comment-footer"> <span>by swiatek7&#xA0;|&#xA0;</span> <span class="reply-button">Reply</span> </summary> </details> </div> </div> </div> </article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>