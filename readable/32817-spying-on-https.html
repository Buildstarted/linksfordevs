<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Spying on HTTPS -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Spying on HTTPS</h1>
    <div class="entry-content"> <p>When I launched Chrome <a href="https://twitter.com/ericlaw/status/1159848001415913474">on Thursday</a>, I saw something unexpected:</p>
<p><img class=" size-full wp-image-2142 aligncenter" src="https://textplain.files.wordpress.com/2019/08/sslkeylogfile.png?w=631" alt="SSLKeyLogfile" srcset="https://textplain.files.wordpress.com/2019/08/sslkeylogfile.png 631w, https://textplain.files.wordpress.com/2019/08/sslkeylogfile.png?w=150 150w, https://textplain.files.wordpress.com/2019/08/sslkeylogfile.png?w=300 300w" sizes="(max-width: 631px) 100vw, 631px"></p>
<p>While most users probably would have no idea what to make of this, I happened to know what it means&#x2013; Chrome is warning me that the system configuration is instructing it to leak the secret keys it uses to encrypt and decrypt HTTPS traffic to a stream on the local computer.</p>
<p>Looking at the Chrome source code, this warning was <a href="https://chromium.googlesource.com/chromium/src/+/a7a748796156366cb6c6172e91760d32d698f586">newly added last week</a>.&#xA0;More surprising was that I couldn&#x2019;t find this setting anywhere on my system. Opening a new console showed that it wasn&#x2019;t set:</p>
<pre>C:\WINDOWS\system32&gt;set sslkeylogfile
Environment variable sslkeylogfile not defined</pre>
<p>&#x2026;and opening up the System Properties &gt; Advanced &gt; Environment Variables UI showed that it wasn&#x2019;t set for either my user account or the system at large. Weird.</p>
<p>Fortunately, I understood from past <a href="https://textslashplain.com/2018/10/11/shellexecute-doesnt/">investigations</a> that a process can have different environment variables than the rest of the system, and&#xA0;<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a>&#xA0;can show the environment variables inside a running process. Opening Chrome.exe, we see that it indeed has an SSLKEYLOGFILE set:</p>
<p><img class=" size-full wp-image-2140 aligncenter" src="https://textplain.files.wordpress.com/2019/08/sslkeylogfileeb.png?w=508" alt="SSLKeyLogfileEB" srcset="https://textplain.files.wordpress.com/2019/08/sslkeylogfileeb.png 508w, https://textplain.files.wordpress.com/2019/08/sslkeylogfileeb.png?w=150 150w, https://textplain.files.wordpress.com/2019/08/sslkeylogfileeb.png?w=300 300w" sizes="(max-width: 508px) 100vw, 508px"></p>
<p>The unusual syntax with the leading <strong>\\.\</strong> means that this isn&#x2019;t a typical local file path but instead <a href="https://docs.microsoft.com/en-us/windows/win32/ipc/pipe-names">a named pipe</a>, which means that it doesn&#x2019;t map to a file on disk (e.g. C:\temp\sslkeys.txt) but instead to memory that another process can see.</p>
<p>The reason my machine was in this state was that earlier that morning, I&#x2019;d installed Avast Antivirus to attempt to <a href="https://crbug.com/990640">reproduce a bug</a>&#xA0;a Chrome user had hit. Avast is injecting the SSLKEYLOGFILE setting so that it can conduct a <a href="https://textslashplain.com/2018/02/14/understanding-the-limitations-of-https/">monster-in-the-browser attack</a> (MITB) and see the encrypted traffic going into Chrome.</p>
<p>Makers of antivirus products know that browsers are one of the primary vectors by which attackers compromise PCs, and as a consequence their security products often conduct MITB attacks in order to scan web content. Antivirus developers have two common techniques to scan content running in the browser:</p>
<ol>
<li>Code injection</li>
<li>Network interception</li>
</ol>
<h2>Code Injection</h2>
<p>The code injection technique relies upon injecting security code into the browser process. The problem with this approach is that <strong>native code injections</strong> are inherently fragile&#x2013; any update to the browser might move its functions and data structures around such that the security code will fail and crash the process. Browsers discourage native code injection, and the <a href="https://crbug.com/990640">bug</a>&#xA0;I was looking at was related to a new feature RendererCodeIntegrity which directs Windows to block loading any code not signed by Microsoft or Google into the browser&#x2019;s renderer processes. Another code-injection approach relies upon using a <strong>browser extension</strong> that operates within the APIs exposed by the browser&#x2013; this approach is more stable, but can address fewer threats.</p>
<p>Even well-written code injections can cause significant performance problems for browsers&#x2013; when I last looked at the state of the industry, performance costs ranged from 20% to 400%.</p>
<h2>Network Interception</h2>
<p>The Network interception technique relies upon scanning the HTTP and HTTPS traffic that goes into the browser process. Scanning HTTP traffic is straightforward (a simple proxy server can do it), but scanning HTTPS traffic is harder because the whole point of HTTPS is making it impossible for a network intermediary from viewing or modifying the plaintext network traffic.</p>
<p>Historically, the most common mechanism for security-scanning HTTPS traffic was to use a <strong>monster-in-the-middle (MITM) proxy server</strong> running on the local computer. The MITM would instruct Windows to trust a self-signed root certificate, and it would automatically generate new interception certificates for every secure site you visit. I spent over a decade working on such a MITM proxy server, the <a href="https://www.telerik.com/fiddler">Fiddler Web Debugger</a>.</p>
<p>There are many problems with using a MITM proxy, however. The primary problem is that it&#x2019;s very very hard to ensure that it behaves exactly as the browser does and that it does not <em>introduce security vulnerabilities.</em> For instance, if the MITM&#x2019;s certificate verification logic has bugs, then it might accept a bogus certificate from a spoof server and the user would not be warned&#x2013; Avast used to use a MITM proxy and had <a href="https://www.thesafemac.com/avasts-man-in-the-middle/">exactly this bug;</a> they were not alone. Similarly, the MITM might not support the most secure versions of protocols supported by the browser and the server (e.g. TLS/1.3) and thus using the MITM would degrade security. Some protocol features (e.g. Client Certificates) are incompatible with MITM proxies. And lastly, some security features (specifically certificate pinning) are fundamentally incompatible with MITM certificates and are <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/security/faq.md#How-does-key-pinning-interact-with-local-proxies-and-filters">disabled when MITM certificates</a> are used.</p>
<p>Given the shortcomings of using a MITM proxy, it appears that Avast has moved on to a newer technique, using the&#xA0;<strong>SSLKeyLogFile&#xA0;</strong>to leak the secret keys HTTPS negotiates on each connection to encrypt the traffic. Firefox and Chromium support this feature, and it enables decryption of TLS traffic without using the MITM certificate generation techniques. While browser vendors are wary of any sort of interception of HTTPS traffic, this approach is generally <a href="https://twitter.com/agl__/status/1159946851115683840">preferable</a>&#xA0;to MITM proxies.</p>
<p>There&#x2019;s some worry that Chrome&#x2019;s new notification bar might drive security vendors back to using more dangerous techniques, so this notification <a href="https://twitter.com/agl__/status/1159961623001325568">might not</a> make its way into the stable release of Chrome.</p>
<p>When it comes to browser architecture, tradeoffs abound.</p>
<p>-Eric</p>
<h2>Appendix: Peeking at the Keys</h2>
<p>If we were to point the SSLKeyLog setting at a regular file instead of a named pipe:</p>
<pre>chrome --ssl-key-log-file=C:\temp\sslkeys.txt</pre>
<p>We can examine the file&#x2019;s contents as we browse to reveal the secrets:</p>
<p><img class="alignnone size-full wp-image-2141" src="https://textplain.files.wordpress.com/2019/08/exportedkeys.png?w=800" alt="ExportedKeys" srcset="https://textplain.files.wordpress.com/2019/08/exportedkeys.png?w=800 800w, https://textplain.files.wordpress.com/2019/08/exportedkeys.png?w=150 150w, https://textplain.files.wordpress.com/2019/08/exportedkeys.png?w=300 300w, https://textplain.files.wordpress.com/2019/08/exportedkeys.png?w=768 768w, https://textplain.files.wordpress.com/2019/08/exportedkeys.png?w=1024 1024w, https://textplain.files.wordpress.com/2019/08/exportedkeys.png 1290w" sizes="(max-width: 800px) 100vw, 800px"></p>
<p>This file alone isn&#x2019;t useful to a human, but you <a href="https://wiki.wireshark.org/TLS?action=show&amp;redirect=SSL#Using_the_.28Pre.29-Master-Secret">can</a> <a href="https://jimshaver.net/2015/02/11/decrypting-tls-browser-traffic-with-wireshark-the-easy-way/">configure</a>&#xA0;tools like WireShark to make use of it and automatically decrypt captured TLS traffic back to plaintext.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>