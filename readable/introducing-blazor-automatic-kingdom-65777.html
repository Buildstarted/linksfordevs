<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Introducing Blazor Automatic Kingdom - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Introducing Blazor Automatic Kingdom - linksfor.dev(s)"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://blazorhelpwebsite.com/ViewBlogPost/39"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Introducing Blazor Automatic Kingdom</title>
<div class="readable">
        <h1>Introducing Blazor Automatic Kingdom</h1>
            <div>Reading time: 9-11 minutes</div>
        <div>Posted here: 17 Aug 2020</div>
        <p><a href="https://blazorhelpwebsite.com/ViewBlogPost/39">https://blazorhelpwebsite.com/ViewBlogPost/39</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><!--!-->
    <div><!--!-->
        <!--!--><p><img alt="image" src="https://blazorhelpwebsite.com/blogs/9ac949bf-433e-4b65-9f08-c412b9e27efb/Windows-Live-Writer/883a688a069a_1022E/image3.png" width="596" height="291"></p> <p>The Blazor application, <a href="https://automatickingdom.com/" target="_blank">Automatic Kingdom</a>, is designed to allow users to create programs, using visual blocks, to control 3D objects and animation.</p> <p>The code in this article is based on the <a href="https://github.com/ADefWebserver/AutomaticKingdom/releases/tag/v00.00.01-alpha" target="_blank">00.00.01 Alpha Release</a>. To run the code, you will need <a href="https://visualstudio.microsoft.com/vs/preview/" target="_blank">Visual Studio Studio 2019 Preview</a> (or higher) with <a href="https://dotnet.microsoft.com/download/dotnet/5.0" target="_blank">.Net Core 5</a>.</p> <p><img src="https://blazorhelpwebsite.com/uploads/BlogPostImages/AutomaticKingdomAnimation.gif"></p> <p>The application is built using the following technology stack:</p> <ul> <li><a href="https://developers.google.com/blockly" target="_blank">Blockly</a> – A JavaScript program that allows you to create block-based visual programming languages. Widely used in programs such as <a href="https://developers.googleblog.com/2019/01/scratch-30s-new-programming-blocks.html" target="_blank">MIT’s Scratch 3.0</a> and <a href="https://www.microsoft.com/en-us/makecode?rtc=1" target="_blank">Microsoft’s MakeCode</a>, this provides a visual tool to allow the end user to control the intent of the final program using a visual design.  </li><li><a href="https://github.com/richorama/IronBlock" target="_blank">IronBlock</a> – <strong>Blockly</strong> automatically generates XML, JavaScript, Python, PHP, Lua, and Dart, but not C#. <strong>IronBlock</strong> converts the XML output to C#.  </li><li><a href="https://github.com/oleg-shilo/cs-script.core" target="_blank">CS-Script.Core</a> – While <strong>Iron Block</strong> creates valid C#, executing that C# code, inside a <strong>Blazor</strong> application, is actually quite complicated. The <strong>CS-Script</strong> library provides that important functionality.  </li><li><a href="https://github.com/canhorn/EventHorizon.Blazor.Interop.Generator" target="_blank">EventHorizon.Blazor.Babylon.js</a> – The ultimate goal is to display rich 3D graphics and animation using <strong>Babylon.js</strong>. However, <strong>Babylon.js</strong> is a JavaScript library. The <strong>EventHorizen</strong> library allows <strong>Babylon.js</strong> to be programmed using C# code.  </li><li><a href="https://www.babylonjs.com/" target="_blank">Babylon.js</a> – This library provides a powerful 3D graphics engine to display the final result.</li></ul>   <p><img alt="image" src="https://blazorhelpwebsite.com/blogs/9ac949bf-433e-4b65-9f08-c412b9e27efb/Windows-Live-Writer/883a688a069a_1022E/image8.png" width="526" height="365"></p> <p>You can download and run the code, or use it at: <a href="https://automatickingdom.com/" target="_blank">https://automatickingdom.com</a>.</p> <p><img alt="image" src="https://blazorhelpwebsite.com/blogs/9ac949bf-433e-4b65-9f08-c412b9e27efb/Windows-Live-Writer/883a688a069a_1022E/image11.png" width="282" height="161"></p> <p>The toolbox provides access to the blocks, including custom blocks, that allow you to define program execution logic on the main design screen.</p> <p><img alt="image" src="https://blazorhelpwebsite.com/blogs/9ac949bf-433e-4b65-9f08-c412b9e27efb/Windows-Live-Writer/883a688a069a_1022E/image14.png" width="355" height="179"></p> <p>In the current implementation, a <em>input</em>&nbsp;<strong>WorldObject</strong> that consists of either “<em>Idle</em>”, “<em>Attacked</em>”, or “<em>Calm</em>” will be passed to the code block, and a <strong>AnimationLoopResult</strong> value, consisting of either “<em>Idle</em>”, “<em>Attack</em>”, or “<em>Walk</em>” needs to be passed as the <em>output</em>.</p> <p><img alt="image" src="https://blazorhelpwebsite.com/blogs/9ac949bf-433e-4b65-9f08-c412b9e27efb/Windows-Live-Writer/883a688a069a_1022E/image17.png" width="329" height="388"></p> <p>Clicking the <strong>C# Code</strong> button displays the current logic as C# code.</p> <p><img alt="image" src="https://blazorhelpwebsite.com/blogs/9ac949bf-433e-4b65-9f08-c412b9e27efb/Windows-Live-Writer/883a688a069a_1022E/image20.png" width="333" height="258"></p> <p>Clicking the <strong>Run Code</strong> button displays an <em>Avatar</em> using <strong>Babylon.js</strong>.</p> <p><img alt="image" src="https://blazorhelpwebsite.com/blogs/9ac949bf-433e-4b65-9f08-c412b9e27efb/Windows-Live-Writer/883a688a069a_1022E/image23.png" width="331" height="254"></p> <p>You can select a value to input to the code, and view the result in the <strong>Babylon.js</strong> animation.</p>  <p><strong>Blockly</strong> is implemented in the <strong>Blazor Server</strong> application by using a <strong>Div</strong> with a <strong>@ref</strong> to the <strong>@blocklyDiv</strong> variable:</p> <pre><pre><span>&lt;</span><span>div</span> <span>style</span>=<span>"width: 100%"</span><span>&gt;</span>
</pre><pre>    <span>&lt;</span><span>div</span> @<span>ref</span>=<span>"@blocklyDiv"</span> <span>style</span>=<span>"display: inline-block; height: 480px; width: 100%"</span><span>&gt;</span><span>&lt;/</span><span>div</span><span>&gt;</span>
</pre><pre><span>&lt;/</span><span>div</span><span>&gt;</span>
</pre><pre></pre></pre>

<p>When the <strong>.razor </strong>control loads, the following code runs:</p>
<pre><pre>    <span>protected</span> <span>override</span> async Task OnAfterRenderAsync(<span>bool</span> firstRender)
</pre><pre>    {
</pre><pre>        <span>if</span> (firstRender)
</pre><pre>        {
</pre><pre>            await AutomaticKingdomInterop.DemoWorkspace(
</pre><pre>                JSRuntime,
</pre><pre>                blocklyDiv,
</pre><pre>                toolbox,
</pre><pre>                startBlocks
</pre><pre>                );
</pre><pre>        }
</pre><pre>    }
</pre><pre></pre></pre>

<p>This calls the following <strong>JavaScript Interop</strong> code that calls the <strong>JavaScript</strong> that creates the <strong>Blockly</strong> workspace:</p>
<pre><pre>        <span>internal</span> <span>static</span> ValueTask&lt;<span>object</span>&gt; DemoWorkspace(
</pre><pre>            IJSRuntime jsRuntime,
</pre><pre>            ElementReference blocklyDiv,
</pre><pre>            ElementReference toolbox,
</pre><pre>            ElementReference startBlocks)
</pre><pre>        {
</pre><pre>            <span>return</span> jsRuntime.InvokeAsync&lt;<span>object</span>&gt;(
</pre><pre>                "<span>BlocklyFunctions.createDemoWorkspace</span>",
</pre><pre>                blocklyDiv,
</pre><pre>                toolbox,
</pre><pre>                startBlocks);
</pre><pre>        }
</pre><pre></pre></pre>

<p>The <strong>JavaScript</strong> that actually creates the <strong>Blockly</strong> workspace, and passes the result back to the <strong>Div</strong>, is contained in the <strong>_Host.cshtml</strong> file:</p>
<pre><pre>        <span>window</span>.BlocklyFunctions = {
</pre><pre>            createDemoWorkspace: <span>function</span> (blocklyDiv, toolbox, startBlocks) {
</pre><pre>                demoWorkspace = Blockly.inject(blocklyDiv,
</pre><pre>                    {
</pre><pre>                        media: 'media/',
</pre><pre>                        toolbox: toolbox
</pre><pre>                    });
</pre><pre>                Blockly.Xml.domToWorkspace(startBlocks,
</pre><pre>                    demoWorkspace);
</pre><pre>            }
</pre><pre></pre></pre>

<p><strong>Note:</strong> You can use the <a href="https://blockly-demo.appspot.com/static/demos/blockfactory/index.html" target="_blank">Blockly Developer Tools</a> to create custom Blockly blocks and the custom toolbox.</p>


<p><strong>IronBlock</strong> takes the <strong>XML</strong> created by <strong>Blockly</strong>, that is retrieved using this line of code:</p>
<pre><pre>XMLText = await AutomaticKingdomInterop.GetXML(JSRuntime);
</pre><pre></pre></pre>
<p>… and turns it into <strong>C#</strong> code:</p>
<pre><pre>            var parser = <span>new</span> Parser()
</pre><pre>                .AddStandardBlocks()
</pre><pre>                .Parse(XMLText);
</pre><pre>            var syntaxTree = parser.Generate();
</pre><pre>            <span>string</span> code = syntaxTree.NormalizeWhitespace().ToFullString();
</pre><pre>            <span>// Get C# Code</span>
</pre><pre>            var script = GenerateScript(code);
</pre><pre></pre></pre>


<p>The C# code, produced by <strong>IronBlock</strong>, needs to be <em>adjusted</em> (for example to add required imports and namespaces). We do that using the <strong>ConvertScript</strong> method:</p>
<pre><pre>    <span>public</span> <span>static</span> <span>string</span> ConvertScript(<span>string</span> code)
</pre><pre>    {
</pre><pre>        <span>string</span> FinalCode = "<span></span>";
</pre><pre>        <span>// Remove existing opening bracket</span>
</pre><pre>        FinalCode = code.Substring(1, (code.Length - 1));
</pre><pre>        <span>string</span> StartingCode =
</pre><pre>            @"<span>using System.Collections.Generic;
</span></pre><pre>                using System.Linq;
</pre><pre>                public class Script
</pre><pre>                {";
</pre><pre>        <span>// Add a class around existing code</span>
</pre><pre>        FinalCode = StartingCode + FinalCode;
</pre><pre>        <span>// Make AnimationLoop Public</span>
</pre><pre>        FinalCode = FinalCode.Replace(
</pre><pre>            "<span>dynamic AnimationLoop(dynamic WorldObject)</span>", 
</pre><pre>            "<span>public dynamic AnimationLoop(dynamic WorldObject)</span>");
</pre><pre>        <span>return</span> FinalCode;
</pre><pre>    }
</pre><pre></pre></pre>

<p>CS-Script allows that code to loaded and executed:</p>
<pre><pre>        <span>// Load the code</span>
</pre><pre>        dynamic CsScript = CSScript.Evaluator.LoadCode(ConvertScript(code));
</pre><pre>        <span>// Call the AnimationLoop methods, passing it the WorldObject</span>
</pre><pre>        var result = CsScript.AnimationLoop(WorldObject);
</pre><pre></pre></pre>

<p>The <em>result</em> variable represents the output of the <strong>C#</strong> code.</p>


<p>We now need to display the animation in <strong>Babylon.js</strong>.</p>
<p><strong>EventHorizon.Blazor.BabylonJS</strong> allows us to use <strong>C#</strong> code to easily do that.</p>

<p>First, a method set up the scene:</p>
<pre><pre>        <span>public</span> async ValueTask CreateScene()
</pre><pre>        {
</pre><pre>            var canvas = await Canvas.GetElementById(
</pre><pre>                "<span>game-window</span>"
</pre><pre>            );
</pre><pre>            var engine = await Engine.NewEngine(
</pre><pre>                canvas,
</pre><pre>                <span>true</span>
</pre><pre>            );
</pre><pre>            var scene = await Scene.NewScene(
</pre><pre>                engine
</pre><pre>            );
</pre><pre>            var light0 = await PointLight.NewPointLight(
</pre><pre>                "<span>Omni</span>",
</pre><pre>                await Vector3.NewVector3(
</pre><pre>                    0,
</pre><pre>                    100,
</pre><pre>                    8
</pre><pre>                ),
</pre><pre>                scene
</pre><pre>            );
</pre><pre>            var light1 = await HemisphericLight.NewHemisphericLight(
</pre><pre>                "<span>HemisphericLight</span>",
</pre><pre>                await Vector3.NewVector3(
</pre><pre>                    0,
</pre><pre>                    100,
</pre><pre>                    8
</pre><pre>                ),
</pre><pre>                scene
</pre><pre>            );
</pre><pre>            var Player = await SceneLoader.ImportMesh(
</pre><pre>                <span>null</span>,
</pre><pre>                "<span>assets/</span>",
</pre><pre>                "<span>Player.glb</span>",
</pre><pre>                scene,
</pre><pre>                <span>new</span> EventHorizon.Blazor.Server.Interop.Callbacks.ActionCallback&lt;
</pre><pre>                    AbstractMesh[], IParticleSystem[], Skeleton[], AnimationGroup[]&gt;(
</pre><pre>                    async (arg1, arg2, arg3, arg4) =&gt;
</pre><pre>                {
</pre><pre>                    <span>foreach</span> (var animation <span>in</span> arg4)
</pre><pre>                    {
</pre><pre>                        await animation.stop();
</pre><pre>                        _animationMap.Add(await animation.get_name(), animation);
</pre><pre>                    }
</pre><pre>                    <span>if</span> (_animationMap.Count &gt; 0)
</pre><pre>                    {
</pre><pre>                        _runningAnimation = _animationMap.First().Value;
</pre><pre>                        await _runningAnimation.start(<span>true</span>);
</pre><pre>                    }
</pre><pre>                })
</pre><pre>            );
</pre><pre>            var camera = await ArcRotateCamera.NewArcRotateCamera(
</pre><pre>                "<span>ArcRotateCamera</span>",
</pre><pre>                (<span>decimal</span>)(System.Math.PI / 2),
</pre><pre>                (<span>decimal</span>)(System.Math.PI / 4),
</pre><pre>                3,
</pre><pre>                await Vector3.NewVector3(0, 1, 0),
</pre><pre>                scene
</pre><pre>            );
</pre><pre>            await camera.set_lowerRadiusLimit(2);
</pre><pre>            await camera.set_upperRadiusLimit(10);
</pre><pre>            await camera.set_wheelDeltaPercentage(0.01m);
</pre><pre>            await scene.set_activeCamera(camera);
</pre><pre>            await camera.attachControl(
</pre><pre>                canvas,
</pre><pre>                <span>false</span>
</pre><pre>            );
</pre><pre>            await engine.runRenderLoop(() =&gt; Task
</pre><pre>            .Run(() =&gt; scene.render(<span>true</span>, <span>false</span>)));
</pre><pre>            _engine = engine;
</pre><pre>        }
</pre><pre></pre><pre></pre><pre></pre></pre>
<p>Then another method allows the animations to be <em>triggered</em>:</p>
<pre><pre>        <span>public</span> async ValueTask RunAnimation(<span>string</span> name)
</pre><pre>        {
</pre><pre>            <span>if</span> (_runningAnimation != <span>null</span>)
</pre><pre>            {
</pre><pre>                await _runningAnimation.stop();
</pre><pre>                _runningAnimation = <span>null</span>;
</pre><pre>            }
</pre><pre>            <span>if</span> (_animationMap.ContainsKey(name))
</pre><pre>            {
</pre><pre>                await _animationMap[name].play(<span>true</span>);
</pre><pre>                _runningAnimation = _animationMap[name];
</pre><pre>            }
</pre><pre>        }
</pre><pre></pre></pre>


<ul>
<li>Multiplayer applications 
</li><li>Allowing custom blocks to be created in the application</li></ul>


<p><a href="http://automatickingdom.com/" target="_blank">AutomaticKingdom.com</a></p>
<p><a href="https://github.com/ADefWebserver/AutomaticKingdom" target="_blank">AutomaticKingdom Github</a> (<a href="https://github.com/ADefWebserver/AutomaticKingdom/releases/tag/v00.00.01-alpha" target="_blank">00.00.01 Alpha Release</a>)</p>
<p><a href="https://github.com/ADefWebserver/AutomaticKingdom/issues/4" target="_blank">Implement WorldObject #4</a></p>
<p><a href="https://github.com/richorama/IronBlock" target="_blank">https://github.com/richorama/IronBlock</a></p>
<p><a href="https://github.com/canhorn/EventHorizon.Blazor.TypeScript.Interop.Generator" target="_blank">https://github.com/canhorn/EventHorizon.Blazor.TypeScript.Interop.Generator</a></p>
<p><a href="https://developers.google.com/blockly" target="_blank">Blockly</a></p>
<p><a href="https://www.babylonjs.com/" target="_blank">www.babylonjs.com</a></p><!--!-->
    </div><!--!-->
</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>