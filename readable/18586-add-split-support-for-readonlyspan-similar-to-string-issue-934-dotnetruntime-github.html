<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Add &#x27;split&#x27; support for ReadOnlySpan similar to string &#xB7; Issue #934 &#xB7; dotnet/runtime &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Add 'split' support for ReadOnlySpan<char> similar to string · Issue #934 · dotnet/runtime · GitHub</char></h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p><strong>Latest Update:</strong></p><p><strong>New proposal to re-review:</strong> Enumerator returns <code>Range</code> instead of <code>ReadOnlySpan&lt;T&gt;</code></p><div class="highlight highlight-source-cs"><pre><span class="pl-k">partial</span><span class="pl-k">class</span><span class="pl-en">MemoryExtensions</span>
{
    <span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">SpanSplitEnumerator</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-en">Split</span>&lt;<span class="pl-en">T</span>&gt;(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-smi">span</span>, <span class="pl-en">T</span><span class="pl-smi">separator</span>,
        <span class="pl-en">StringSplitOptions</span><span class="pl-smi">options</span><span class="pl-k">=</span><span class="pl-smi">StringSplitOptions</span>.<span class="pl-smi">None</span>) <span class="pl-k">where</span><span class="pl-en">T</span> : <span class="pl-en">IEquatable</span>&lt;<span class="pl-en">T</span>&gt; {}

    <span class="pl-k">public</span><span class="pl-k">ref</span><span class="pl-k">struct</span><span class="pl-en">SpanSplitEnumerator</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-k">where</span><span class="pl-en">T</span> : <span class="pl-en">IEquatable</span>&lt;<span class="pl-en">T</span>&gt;
    {
        <span class="pl-k">public</span><span class="pl-en">SpanSplitEnumerator</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-en">GetEnumerator</span>() { <span class="pl-k">return</span><span class="pl-k">this</span>;  }
        <span class="pl-k">public</span><span class="pl-k">bool</span><span class="pl-en">MoveNext</span>();
        <span class="pl-k">public</span><span class="pl-en">Range</span><span class="pl-smi">Current</span> { <span class="pl-k">get</span>; }
    }
}</pre></div><p><strong>Previously approved API Proposal</strong></p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">SpanSplitEnumerator</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-en">Split</span>(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-smi">span</span>, <span class="pl-en">T</span><span class="pl-smi">seperator</span>,
    <span class="pl-en">StringSplitOptions</span><span class="pl-smi">options</span><span class="pl-k">=</span><span class="pl-smi">StringSplitOptions</span>.<span class="pl-smi">None</span>) <span class="pl-k">where</span><span class="pl-en">T</span> : <span class="pl-en">IEquatable</span>&lt;<span class="pl-en">T</span>&gt; {}

<span class="pl-k">public</span><span class="pl-k">ref</span><span class="pl-k">struct</span><span class="pl-en">SpanSplitEnumerator</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-k">where</span><span class="pl-en">T</span> : <span class="pl-en">IEquatable</span>&lt;<span class="pl-en">T</span>&gt;
{
    <span class="pl-k">public</span><span class="pl-en">SpanSplitEnumerator</span><span class="pl-en">GetEnumerator</span>() { <span class="pl-k">return</span><span class="pl-k">this</span>;  }
    <span class="pl-k">public</span><span class="pl-k">bool</span><span class="pl-en">MoveNext</span>();
    <span class="pl-k">public</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-en">T</span>&gt; <span class="pl-smi">Current</span> { <span class="pl-k">get</span>; }
}</pre></div><p>Split off from <a href="https://github.com/dotnet/corefx/issues/21395#issuecomment-359342832">https://github.com/dotnet/corefx/issues/21395#issuecomment-359342832</a></p><p><em>From <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/Joe4evr/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/Joe4evr">@Joe4evr</a> on January 21, 2018 23:16</em></p><blockquote><p>Can I throw in another suggestion? I'd really like to see some ability to split a <code>ReadOnlySpan&lt;char&gt;</code>. Obviously, you can't return a collection of <code>Span</code>s directly, but isn't that what <code>Memory&lt;T&gt;</code> is for?</p></blockquote><div class="highlight highlight-source-cs"><pre><span class="pl-c"><span class="pl-c">//</span> equivalent to the overloads of 'String.Split()'</span><span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IReadOnlyList</span>&lt;<span class="pl-en">ReadOnlyMemory</span>&lt;<span class="pl-k">char</span>&gt;&gt; <span class="pl-en">Split</span>(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">span</span>, <span class="pl-k">char</span>[] <span class="pl-smi">seperator</span>);
<span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IReadOnlyList</span>&lt;<span class="pl-en">ReadOnlyMemory</span>&lt;<span class="pl-k">char</span>&gt;&gt; <span class="pl-en">Split</span>(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">span</span>, <span class="pl-k">char</span>[] <span class="pl-smi">seperator</span>, <span class="pl-k">int</span><span class="pl-smi">count</span>);
<span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IReadOnlyList</span>&lt;<span class="pl-en">ReadOnlyMemory</span>&lt;<span class="pl-k">char</span>&gt;&gt; <span class="pl-en">Split</span>(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">span</span>, <span class="pl-k">char</span>[] <span class="pl-smi">seperator</span>, <span class="pl-k">int</span><span class="pl-smi">count</span>, <span class="pl-en">StringSplitOptions</span><span class="pl-smi">options</span>);
<span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IReadOnlyList</span>&lt;<span class="pl-en">ReadOnlyMemory</span>&lt;<span class="pl-k">char</span>&gt;&gt; <span class="pl-en">Split</span>(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">span</span>, <span class="pl-k">char</span>[] <span class="pl-smi">seperator</span>, <span class="pl-en">StringSplitOptions</span><span class="pl-smi">options</span>);
<span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IReadOnlyList</span>&lt;<span class="pl-en">ReadOnlyMemory</span>&lt;<span class="pl-k">char</span>&gt;&gt; <span class="pl-en">Split</span>(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">span</span>, <span class="pl-k">string</span>[] <span class="pl-smi">seperator</span>, <span class="pl-k">int</span><span class="pl-smi">count</span>, <span class="pl-en">StringSplitOptions</span><span class="pl-smi">options</span>);
<span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IReadOnlyList</span>&lt;<span class="pl-en">ReadOnlyMemory</span>&lt;<span class="pl-k">char</span>&gt;&gt; <span class="pl-en">Split</span>(<span class="pl-k">this</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">span</span>, <span class="pl-k">string</span>[] <span class="pl-smi">seperator</span>, <span class="pl-en">StringSplitOptions</span><span class="pl-smi">options</span>);</pre></div><blockquote><p>The reason for choosing <code>IReadOnlyList&lt;T&gt;</code>  is to make the resulting collection indexable, just like <code>string[]</code>. It would be nice if the implementation is <code>ImmutableArray&lt;T&gt;</code>, but I'm not sure if that's a concern for distribution and such.</p></blockquote><hr><p><em>From <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/ahsonkhan/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/ahsonkhan">@ahsonkhan</a> on January 22, 2018 01:36</em></p><blockquote><p><a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/Joe4evr/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/Joe4evr">@Joe4evr</a>, out of curiosity, do you have a scenario atm where these APIs would be useful? If so, can you please show the code sample?</p></blockquote><blockquote><p>I would replace the char[] overloads with ReadOnlySpan&lt;char&gt;. However, I am not sure about adding the split APIs, in general, given they have to allocate. Is there a way to avoid allocating? Also, given these are string-like APIs for span, it is strange to have an overload that takes a string[]. Maybe all these would fit better on ReadOnlyMemory instead, especially given the return type.</p></blockquote><hr><p><em>From <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/Joe4evr/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/Joe4evr">@Joe4evr</a> on January 22, 2018 08:35</em></p><blockquote><p>My scenario is taking a relatively big string of user input and then parsing that to populate a more complex object. So rather than take the whole string at once, I'd like to parse it in pieces at a time. It'd be pretty nice if this can be facilitated by the <code>Span</code>/<code>Memory&lt;T&gt;</code> APIs so that this code won't have to allocate an extra 30-40 tiny strings whenever it runs.</p></blockquote><blockquote><p>Admittedly, I only started on this particular case earlier today, mostly to experiment and find out how much I could get out of the Span APIs at this time.</p></blockquote><blockquote><p>Maybe it was a bit naive of me to expect a collection like I did, but I'd at least like to see some API to deal with this scenario a little easier, because I'll probably not be the only one looking to split a span up into smaller chunks like this.</p></blockquote><hr><p><em>From <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/stephentoub/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/stephentoub">@stephentoub</a> on January 22, 2018 08:41</em></p><blockquote><p>Splitting support would be good, but I don't think it would look like the proposed methods; as <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/ahsonkhan/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/ahsonkhan">@ahsonkhan</a> points out, that would result in a lot of allocation (including needing to copy the whole input string to the heap, since you can't store the span into a returned interface implementation).</p></blockquote><blockquote><p>I would instead expect a design more like an iterator implemented as a ref struct, e.g.</p></blockquote><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">ref</span><span class="pl-k">struct</span><span class="pl-en">CharSpanSplitter</span>
{
    <span class="pl-k">public</span><span class="pl-en">CharSpanSplitter</span>(<span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">value</span>, <span class="pl-k">char</span><span class="pl-smi">separator</span>, <span class="pl-en">StringSplitOptions</span><span class="pl-smi">options</span>);
    <span class="pl-k">public</span><span class="pl-k">bool</span><span class="pl-en">TryMoveNext</span>(<span class="pl-k">out</span><span class="pl-en">ReadOnlySpan</span>&lt;<span class="pl-k">char</span>&gt; <span class="pl-smi">result</span>);
}</pre></div><p>cc <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/KrzysztofCwalina/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/KrzysztofCwalina">@KrzysztofCwalina</a>, <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/stephentoub/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/stephentoub">@stephentoub</a>, <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/Joe4evr/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/Joe4evr">@Joe4evr</a></p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>