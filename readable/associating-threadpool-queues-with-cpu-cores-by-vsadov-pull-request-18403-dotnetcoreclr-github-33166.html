<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Associating threadpool queues with CPU cores. by VSadov &#xB7; Pull Request #18403 &#xB7; dotnet/coreclr - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Associating threadpool queues with CPU cores. by VSadov &#xB7; Pull Request #18403 &#xB7; dotnet/coreclr - linksfor.dev(s)"/>
    <meta property="article:author" content="VSadov"/>
    <meta property="og:description" content="New implementation of ThreadPool work queues as lock-free queues softly associated with CPU cores.&#xA;The implementation avoids 1:1 strict mapping between work queues and working threads which is ofte..."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://github.com/dotnet/coreclr/pull/18403"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
				<a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Associating threadpool queues with CPU cores. by VSadov &#xB7; Pull Request #18403 &#xB7; dotnet/coreclr</title>
<div class="readable">
        <h1>Associating threadpool queues with CPU cores. by VSadov &#xB7; Pull Request #18403 &#xB7; dotnet/coreclr</h1>
            <div>by VSadov</div>
            <div>Reading time: 3-4 minutes</div>
        <div>Posted here: 16 Aug 2019</div>
        <p><a href="https://github.com/dotnet/coreclr/pull/18403">https://github.com/dotnet/coreclr/pull/18403</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div data-commit-hovercards-enabled="">
        <div itemscope="" itemtype="http://schema.org/SoftwareSourceCode">
    <main id="js-repo-pjax-container" data-pjax-container="">
      
<!-- base sha1: &quot;24b4e11161cf217672fcd3c62158b12c93822e18&quot; -->
<!-- head sha1: &quot;fe91b49d09d0524d2cfbc54e1f04cb5206c9f361&quot; -->

  




  









  


<div>
  <div>

    
    
  <div data-pjax="">
    
      <div data-prompt="signup">
    <div>
      <div>
        <h3>Join GitHub today</h3>
        <p>GitHub is home to over 40 million developers working together to host and review code, manage projects, and build software together.</p>
        <p><a data-hydro-click="{&quot;event_type&quot;:&quot;authentication.click&quot;,&quot;payload&quot;:{&quot;location_in_page&quot;:&quot;files signup prompt&quot;,&quot;repository_id&quot;:null,&quot;auth_type&quot;:&quot;SIGN_UP&quot;,&quot;originating_url&quot;:&quot;https://github.com/dotnet/coreclr/pull/18403&quot;,&quot;user_id&quot;:null}}" data-hydro-click-hmac="841230f71701d425a0462ca89b4a75fc11aba8f16d380ca00eed78a9e17ff83d" data-ga-click="(Logged out) Sign up prompt, clicked Sign up, text:sign-up" href="https://github.com/join?source=prompt-pr-show&amp;source_repo=dotnet%2Fcoreclr">Sign up</a>
      </p></div>
    </div>
  </div>



  


  <div>
    
  


      <include-fragment src="/dotnet/coreclr/pull/18403/show_partial?partial=pull_requests%2Ftabs">
    


  </include-fragment>


    <h2>Conversation</h2>
    <div id="discussion_bucket" data-channel="pull_request:193807659:timeline">
      
<div>

  <div>
        <div data-quote-markdown=".js-comment-body" data-issue-and-pr-hovercards-enabled="" data-team-hovercards-enabled="">
      <div data-channel="marked-as-read:pull-request:193807659">

        



        

  


  
  


  
  



  
  



  
  



  
  
<div data-gid="MDE3OlJlbmFtZWRUaXRsZUV2ZW50MTY4OTk3NjMzMA==">
  
        <div data-team-hovercards-enabled="" id="event-1689976330">
  
  <div>

    

        <p><a data-hovercard-type="user" data-hovercard-url="/users/VSadov/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/VSadov"><img height="20" width="20" alt="@VSadov" src="https://avatars2.githubusercontent.com/u/8218165?s=60&amp;v=4"></a>
  <a data-hovercard-type="user" data-hovercard-url="/users/VSadov/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/VSadov">VSadov</a>
  


      
changed the title
<del>[WIP] Queue</del>

<ins>[WIP] Associate work-stealing threadpool queues with cores.</ins></p><a href="#event-1689976330"><relative-time datetime="2018-06-20T00:33:50Z" title="Jun 19, 2018, 5:33 PM PDT">on Jun 19, 2018</relative-time></a>

  </div>
</div>


  


  


  


  




</div>

  
  



  
  



  
  



  
  




  

    
  



    
  



    
  



    
  



    
  



    
  



    
  


    
  



    
  


    
  



    
  



    
  



    
  



    
  



    
  



    
  



    
  



    
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzAxNDM4MDA5">
  
      

<div>
  
<div id="pullrequestreview-301438009" data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzAxNDM4MDA5" data-channel="pull_request_review:301438009" data-url="/_render_node/MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzAxNDM4MDA5/pull_request_reviews/body">

  <div>
    
<p><a data-hovercard-type="user" data-hovercard-url="/users/lpereira/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/lpereira"><img height="40" width="40" alt="@lpereira" src="https://avatars0.githubusercontent.com/u/15001?s=88&amp;v=4"></a>

</p>


    


    


  </div>
</div>

  
        



</div>

</div>

    
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0Q29tbWl0MTkzODA3NjU5OjAxNzRkZjM0MzgyMjAyY2Q3MzFiN2E2YWI5NmM1NmNlODk4NjhmNWY=">
  
      <div>
    
  <div>
      <div>
        
        <div>
          

<div data-channel="repo:30092893:commit:0174df34382202cd731b7a6ab96c56ce89868f5f" data-url="/dotnet/coreclr/pull/18403/commits/0174df34382202cd731b7a6ab96c56ce89868f5f/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/VSadov/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/VSadov">
          <img height="20" width="20" alt="@VSadov" src="https://avatars2.githubusercontent.com/u/8218165?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
    <div>
      <pre>…ly associated with CPU cores.

    The implementation avoids 1:1 strict mapping between work queues and working threads which is often a far greater number than the number of cores.

    This implementation improves handling of cases where the number of workers needs to exceeds the number of cores and causes precipitous performance drops because:
    - the cost of snooping/stealing does not grow with the number of workers.
    - the local queues tend to be deeper (since there are fewer of them) and thus stealing is less frequent and less contentious with enqueuing/popping.
    - reduced likelihood that the workitem will have to execute on a core different from where it was scheduled.</pre>
    </div>
</div>


        </div>
      </div>
      <div>
        
        <div>
          

<div data-channel="repo:30092893:commit:d6dd2747c01834d83b28a9139fdf048f4a7438af" data-url="/dotnet/coreclr/pull/18403/commits/d6dd2747c01834d83b28a9139fdf048f4a7438af/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/VSadov/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/VSadov">
          <img height="20" width="20" alt="@VSadov" src="https://avatars2.githubusercontent.com/u/8218165?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
    <div>
      <pre>…ueue to ensure that continuously nonempty global queue does not delay retirement of old segments.

This is not a very common scenario, generally happening only at start up, but mitigation is also simple.</pre>
    </div>
</div>


        </div>
      </div>
      <div>
        
        <div>
          

<div data-channel="repo:30092893:commit:f5095c7035458f32971ef97698c3f2c5fd73c602" data-url="/dotnet/coreclr/pull/18403/commits/f5095c7035458f32971ef97698c3f2c5fd73c602/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/VSadov/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/VSadov">
          <img height="20" width="20" alt="@VSadov" src="https://avatars2.githubusercontent.com/u/8218165?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
    
</div>


        </div>
      </div>
      <div>
        
        <div>
          

<div data-channel="repo:30092893:commit:991c2eba1204b927c616d5f2411273ab4cd1b17a" data-url="/dotnet/coreclr/pull/18403/commits/991c2eba1204b927c616d5f2411273ab4cd1b17a/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/VSadov/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/VSadov">
          <img height="20" width="20" alt="@VSadov" src="https://avatars2.githubusercontent.com/u/8218165?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
    <div>
      <pre>Moving to a different core while dispatching is a rare occurence, but when it does happen we do not want to neglect our local queue for too long since that can result in a batch of high-latency outliers.</pre>
    </div>
</div>


        </div>
      </div>
  </div>
</div>


</div>

    
  


    
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzEwMjgyMDk2">
  
      

<div>
  
<div id="pullrequestreview-310282096" data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzEwMjgyMDk2" data-channel="pull_request_review:310282096" data-url="/_render_node/MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzEwMjgyMDk2/pull_request_reviews/body">

  <div>
    
<p><a data-hovercard-type="user" data-hovercard-url="/users/benaadams/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/benaadams"><img height="40" width="40" alt="@benaadams" src="https://avatars0.githubusercontent.com/u/1142958?s=88&amp;v=4"></a>

</p>


    


    


  </div>
</div>

  
        



</div>

</div>

    
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0Q29tbWl0MTkzODA3NjU5OmZlOTFiNDlkMDlkMDUyNGQyY2ZiYzU0ZTFmMDRjYjUyMDZjOWYzNjE=">
  
      <div>
  <div>
      <div>
        
        <div>
          

<div data-channel="repo:30092893:commit:fe91b49d09d0524d2cfbc54e1f04cb5206c9f361" data-url="/dotnet/coreclr/pull/18403/commits/fe91b49d09d0524d2cfbc54e1f04cb5206c9f361/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/VSadov/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/VSadov">
          <img height="20" width="20" alt="@VSadov" src="https://avatars2.githubusercontent.com/u/8218165?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
</div>


        </div>
      </div>
  </div>
</div>


</div>

    
  



    
  


    
  



    
  





<!-- Rendered timeline since 2019-12-02 11:38:55 -->



      </div>

      
    </div>

</div>

    
</div>



    </div>
  </div>
  


  </div>


  </div>
</div>

    </main>
  </div>
  

  </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>