<!DOCTYPE html>
<html lang="en">
<head>
    <title>
IdentityServer4 UI and Web API Basic Security - Code Maze - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="IdentityServer4 UI and Web API Basic Security - Code Maze - linksfor.dev(s)"/>
    <meta property="og:description" content="In this article, we are going to learn how to add IdentityServer4 UI in the project and how to setup the basic Web API protection using IS4"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://code-maze.com/identityserver4-ui-webapi-basic-security/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title">devring.club</span>
				<a href="https://devring.club/site/1/previous" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - IdentityServer4 UI and Web API Basic Security - Code Maze</title>
<div class="readable">
        <h1>IdentityServer4 UI and Web API Basic Security - Code Maze</h1>
            <div>Reading time: 11-13 minutes</div>
        <div>Posted here: 07 Apr 2020</div>
        <p><a href="https://code-maze.com/identityserver4-ui-webapi-basic-security/">https://code-maze.com/identityserver4-ui-webapi-basic-security/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
																<article id="post-52055">
														
							
														
							
														
							<div>
															<div>
									<p><div><p><a href="https://code-maze.com/ultimate-aspnet-core-3-web-api/?topb=true" target="_blank"><img src="https://code-maze.com/wp-content/uploads/2020/01/Code-Maze-Book-Collection-V3-1024x483.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/01/Code-Maze-Book-Collection-V3-1024x483.png" alt="Code Maze Book Collection V3" width="775" height="366" data-pagespeed-url-hash="2051067523" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></a></p><p>Looking to learn how to build <strong>great APIs</strong>? Or become <strong>even better</strong> at it? Check our newest book <strong><a href="https://code-maze.com/ultimate-aspnet-core-3-web-api/?topb=true" target="_blank" rel="noopener">Ultimate ASP.NET Core 3 Web API</a>.</strong> Learn how to create a full production-ready ASP.NET Core API using only the <strong>latest and greatest technologies</strong>. Bonus materials awaiting inside!</p></div>We have set up our identity server but we lack UI for the users to enter their credentials. We’ve shown how we can retrieve our token but for better user experience, we have to add UI to our Authorization Server. So, adding IdentityServer4 UI is our goal for this article. Additionally, we are going to learn how we can protect our API and the way to access protected resources. This will be a basic protection setup, but we are going to enhance it during this series.</p>
<p>To download the source code for the starting projects, you can visit the&nbsp;<a href="https://github.com/CodeMazeBlog/identity-server-4-aspnetcore/tree/identityserver4-ui-webapi-basic-security" target="_blank" rel="nofollow noopener noreferrer">IdentityServer4 UI repository (Start folder)</a>.</p>
<p>For the ending project’s source code, you can visit the <a href="https://github.com/CodeMazeBlog/identity-server-4-aspnetcore/tree/identityserver4-ui-webapi-basic-security" target="_blank" rel="nofollow noopener noreferrer">IdentityServer4 UI repository (End folder)</a>.</p>
<p>To navigate through the entire series, visit the&nbsp;<a href="https://code-maze.com/identityserver-4-series/" target="_blank" rel="noopener noreferrer">IdentityServer4 series&nbsp;</a>page.</p>
<p>This article is divided into the following sections:</p>
<ul>
<li><a href="#installing-identity-server-ui">Installing IdentityServer4 UI and Overview</a></li>
<li><a href="#file-inspection">File Inspection And Configuration</a></li>
<li><a href="#testing-is4-ui">Testing IdentityServer4 UI</a></li>
<li><a href="#configuring-api-resource">Configuring API Resources</a></li>
<li><a href="#securing-webapi">Securing Web API</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<h2 id="installing-identity-server-ui">Installing IdentityServer4 UI and Overview</h2>
<p>If we start our authorization server now, we are going to see a not found page in a browser for sure. Even though the server works, this is not user-friendly at all. So let’s do something about that. There is already created UI for the IdentityServer which is easy to install and modify, and we are going to use it for our project.</p>
<p>So, the first thing we are going to do is to open a PowerShell window and navigate to the folder where we have our OAuth project (…\CompanyEmployees.OAuth\CompanyEmployees.OAuth). Once the window is up, let’s execute a command to download the entire UI project:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3da1354781094" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>iex</span><span> </span><span>(</span><span>(</span><span>New-Object</span><span> </span><span>System</span><span>.</span><span>Net</span><span>.</span><span>WebClient</span><span>)</span><span>.</span><span>DownloadString</span><span>(</span><span>'https://raw.githubusercontent.com/IdentityServer/IdentityServer4.Quickstart.UI/master/getmaster.ps1'</span><span>)</span><span>)</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>After a couple of seconds, we can see a confirmation about installed Quickstart, Views and wwwroot folders:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/10-UI-installed-confirmation.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/10-UI-installed-confirmation.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/10-UI-installed-confirmation.png" alt="IdentityServer4 UI installed confirmation" width="601" height="113" srcset="https://code-maze.com/wp-content/uploads/2020/04/10-UI-installed-confirmation.png 601w, https://code-maze.com/wp-content/uploads/2020/04/10-UI-installed-confirmation-300x56.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/10-UI-installed-confirmation.png 601w, https://code-maze.com/wp-content/uploads/2020/04/10-UI-installed-confirmation-300x56.png 300w" sizes="(max-width: 601px) 100vw, 601px"></a></p>
<p><strong>NOTE:&nbsp;</strong>If you have a problem with some controllers in the UI project, please remove all the downloaded folders and copy/paste them from our repository. They did an update of UI for the 4.0 Preview 3 version, and many things are not working, even if you update your IdentityServer4 NuGet Package to the 4.0 preview version. Of course, this will be fixed for sure, but for now, please use these three folders from our repository.</p>
<h2 id="file-inspection">File Inspection And Configuration</h2>
<p>If we inspect the SolutionExplorer window of our project, we are going to see three additional folders:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/11-UI-Inspection.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/11-UI-Inspection.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/11-UI-Inspection.png" alt="IdentityServer4 UI Inspection" width="330" height="674" srcset="https://code-maze.com/wp-content/uploads/2020/04/11-UI-Inspection.png 330w, https://code-maze.com/wp-content/uploads/2020/04/11-UI-Inspection-147x300.png 147w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/11-UI-Inspection.png 330w, https://code-maze.com/wp-content/uploads/2020/04/11-UI-Inspection-147x300.png 147w" sizes="(max-width: 330px) 100vw, 330px"></a></p>
<p>We can see the <code>wwwroot</code> folder with the static files required for the UI. There is the <code>Quickstart</code> folder with different controllers, models, and additional classes. Finally, there is the <code>Views</code> folder with different views (.cshtml files) inside. Everything we downloaded is easy to maintain and modify so, this speeds up the UI creation process a lot. For our examples the default created files will be quite enough.</p>
<p>Now, we have to configure this UI.</p>
<p>So, the first thing we are going to do is to modify the <code>Configure</code> method in the <code>Startup</code> class:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3da6007995295" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p></div>
				</td>
						<td><div><p><span>public</span><span> </span><span>void</span><span> </span><span>Configure</span><span>(</span><span>IApplicationBuilder </span><span>app</span><span>,</span><span> </span><span>IWebHostEnvironment </span><span>env</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>env</span><span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseStaticFiles</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseIdentityServer</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseEndpoints</span><span>(</span><span>endpoints</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>endpoints</span><span>.</span><span>MapDefaultControllerRoute</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>With the <code>UseStaticFiles</code> method, we enable serving static files from the <code>wwwroot</code> folder. Additionally, we are adding routing and authorization to the pipeline and configuring endpoints to use a default <code>/Home/Index</code> endpoint. If we open the <code>Quickstart/Home</code> folder, we are going to find a <code>HomeController</code> with the <code>Index</code> action inside. So, this is our entry point.</p>
<p>We have to modify the <code>ConfigureServices</code> method as well:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3da8125881151" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>void</span><span> </span><span>ConfigureServices</span><span>(</span><span>IServiceCollection </span><span>services</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>services</span><span>.</span><span>AddIdentityServer</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddInMemoryIdentityResources</span><span>(</span><span>InMemoryConfig</span><span>.</span><span>GetIdentityResources</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddTestUsers</span><span>(</span><span>InMemoryConfig</span><span>.</span><span>GetUsers</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddInMemoryClients</span><span>(</span><span>InMemoryConfig</span><span>.</span><span>GetClients</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddDeveloperSigningCredential</span><span>(</span><span>)</span><span>;</span><span> </span><span>//not something we want to use in a production environment;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>services</span><span>.</span><span>AddControllersWithViews</span><span>(</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Excellent. Now, we can test our UI.</p>
<h2 id="testing-is4-ui"><span lang="SR-LATN-RS">Testing IdentityServer4 UI</span></h2>
<p>Let’s start the application. It should automatically navigate to <code>localhost:5005</code> and show the <code>Welcome</code> page:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4.png" alt="Welcome page IS4 - IdentityServer4 UI" width="633" height="448" srcset="https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4.png 633w, https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4-300x212.png 300w, https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4-400x284.png 400w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4.png 633w, https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4-300x212.png 300w, https://code-maze.com/wp-content/uploads/2020/04/12-Welcome-page-IS4-400x284.png 400w" sizes="(max-width: 633px) 100vw, 633px"></a></p>
<p>If we click the discovery document link, we are going to see different endpoints we’ve been talking about in <a href="https://code-maze.com/identityserver4-integration-aspnetcore/" target="_blank" rel="noopener noreferrer">a previous article</a>.</p>
<p>Let’s click on the here link and enter credentials from one of our test users:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/13-Login-IS4.gif"><img src="https://code-maze.com/wp-content/plugins/a3-lazy-load/assets/images/lazy_placeholder.gif" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/13-Login-IS4.gif" alt="Login IS4 - IdentityServer4 UI" width="864" height="568"></a></p>
<p>So, we see everything is working as expected. We can logout as well by clicking the username (Mick) and then the Logout link. In the rest of the series, we are going to use this UI quite frequently.</p>
<p>Now, let’s see how we can protect our API using the authorization server.</p>
<h2 id="configuring-api-resource">Configuring API Resources</h2>
<p>The first thing we have to do is to add our API resource in the Authorization Server. As we did with the <code>IdentityResources</code>, in <a href="https://code-maze.com/identityserver4-integration-aspnetcore/" target="_blank" rel="noopener noreferrer">a previous article</a> to support different identity-related data, we are going to support our API resource as well. So, let’s add additional code in the <code>InMemoryConfig</code> class in the <code>OAuth</code> project:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3dab523750016" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>static</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>ApiResource</span><span>&gt;</span><span> </span><span>GetApiResources</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>ApiResource</span><span>&gt;</span><span> </span><span>{</span><span> </span><span>new</span><span> </span><span>ApiResource</span><span>(</span><span>"companyApi"</span><span>,</span><span> </span><span>"CompanyEmployee API"</span><span>)</span><span> </span><span>}</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>As you can see, we can add multiple API resources, but for now, we add only one with the name and displayname parameters.</p>
<p>Additionally, we have to modify the client:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3dac373162183" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>static</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>Client</span><span>&gt;</span><span> </span><span>GetClients</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>Client</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Client</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ClientId</span><span> </span>=<span> </span><span>"company-employee"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ClientSecrets</span><span> </span>=<span> </span><span>new</span><span> </span><span>[</span><span>]</span><span> </span><span>{</span><span> </span><span>new</span><span> </span><span>Secret</span><span>(</span><span>"codemazesecret"</span><span>.</span><span>Sha512</span><span>(</span><span>)</span><span>)</span><span> </span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AllowedGrantTypes</span><span> </span>=<span> </span><span>GrantTypes</span><span>.</span><span>ResourceOwnerPasswordAndClientCredentials</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AllowedScopes</span><span> </span>=<span> </span><span>{</span><span> </span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>OpenId</span><span>,</span><span> </span><span>"companyApi"</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>}</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We just add additional scope to support our API resource.</p>
<p>Finally, we have to include this configuration in the <code>ConfigureServices</code> method:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3dad190117810" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>services</span><span>.</span><span>AddIdentityServer</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddInMemoryApiResources</span><span>(</span><span>InMemoryConfig</span><span>.</span><span>GetApiResources</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddInMemoryIdentityResources</span><span>(</span><span>InMemoryConfig</span><span>.</span><span>GetIdentityResources</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddTestUsers</span><span>(</span><span>InMemoryConfig</span><span>.</span><span>GetUsers</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddInMemoryClients</span><span>(</span><span>InMemoryConfig</span><span>.</span><span>GetClients</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddDeveloperSigningCredential</span><span>(</span><span>)</span><span>;</span><span> </span><span>//not something we want to use in a production environment;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>That is all regarding the IdentityServer configuration and we can continue with the API security logic.</p>
<h2 id="securing-webapi">Securing Web API</h2>
<p>Before we configure our middleware to support IdentityServer, we have to install a Nuget package to help us in the process:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/14-JwtBearer-package.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/14-JwtBearer-package.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/14-JwtBearer-package.png" alt="JwtBearer package" width="575" height="61" srcset="https://code-maze.com/wp-content/uploads/2020/04/14-JwtBearer-package.png 575w, https://code-maze.com/wp-content/uploads/2020/04/14-JwtBearer-package-300x32.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/14-JwtBearer-package.png 575w, https://code-maze.com/wp-content/uploads/2020/04/14-JwtBearer-package-300x32.png 300w" sizes="(max-width: 575px) 100vw, 575px"></a></p>
<p>After the installation, we can modify the <code>ConfigureServices</code> method in the <code>Startup</code> class:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3dae331632119" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>services</span><span>.</span><span>AddAuthentication</span><span>(</span><span>"Bearer"</span><span>)</span></p><p><span>&nbsp;&nbsp; </span><span>.</span><span>AddJwtBearer</span><span>(</span><span>"Bearer"</span><span>,</span><span> </span><span>opt</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp; </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>opt</span><span>.</span><span>RequireHttpsMetadata</span><span> </span>=<span> </span><span>false</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>opt</span><span>.</span><span>Authority</span><span> </span>=<span> </span><span>"https://localhost:5005"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>opt</span><span>.</span><span>Audience</span><span> </span>=<span> </span><span>"companyApi"</span><span>;</span></p><p><span>&nbsp;&nbsp; </span><span>}</span><span>)</span><span>;</span></p><p><span>services</span><span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We use the <code>AddAuthentication</code> method to add authentication services to the IOC in our project. Moreover, we use the <code>AddJwtBearer</code> method to configure support for our Authorization Server. In that method, we specify several options:</p>
<ul>
<li>RequireHttpsMetadata – We set this to false because we are in a development environment and we don’t require HTTPS</li>
<li>Authority – Address to use when sending OpenID Connect calls</li>
<li>Audience – Audience value for received OpenID Connect tokens. This value has to be the same as the one provided in the authorization server configuration</li>
</ul>
<p>We have to do one more thing in the <code>Configure</code> class:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3daf129319479" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>app</span><span>.</span><span>UseAuthentication</span><span>(</span><span>)</span><span>;</span></p><p><span>app</span><span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Now, all we have to do is to protect our action in the <code>CompaneesController</code> by placing the<code> [Authorize]</code> attribute on top of the action or controller itself. For that, we have to include <code>Microsoft.AspNetCore.Authorization</code> endpoint in the controller.</p>
<p>Let’s start both applications and send a request with Postman:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api.png" alt="Unauthorized access to web api" width="886" height="260" srcset="https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api.png 886w, https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api-300x88.png 300w, https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api-768x225.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api.png 886w, https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api-300x88.png 300w, https://code-maze.com/wp-content/uploads/2020/04/15-Unauthorized-access-to-web-api-768x225.png 768w" sizes="(max-width: 886px) 100vw, 886px"></a></p>
<p>As expected, we get the 401 – Unauthorized response.<!-- <span id="ezoic-pub-ad-placeholder-176" class="ezoic-adpicker-ad" data-ezadblocked='true'></span> --><!-- placeholder 176 blocked.  Reason : no sizes --></p>
<p>Now, to provide access to the authorized resource, we are going to send another request, but to the authorization server first:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server.png" alt="Token received from auth server" width="981" height="593" srcset="https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server.png 981w, https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server-300x181.png 300w, https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server-768x464.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server.png 981w, https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server-300x181.png 300w, https://code-maze.com/wp-content/uploads/2020/04/16-Token-received-from-auth-server-768x464.png 768w" sizes="(max-width: 981px) 100vw, 981px"></a></p>
<p>Great, we have a token. Let’s copy our token and add it to the previous request as the Authorization parameter in the Headers tab:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API.png" alt="Retreived data from API" width="890" height="432" srcset="https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API.png 890w, https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API-300x146.png 300w, https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API-768x373.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API.png 890w, https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API-300x146.png 300w, https://code-maze.com/wp-content/uploads/2020/04/17-Retreived-data-from-API-768x373.png 768w" sizes="(max-width: 890px) 100vw, 890px"></a></p>
<p>And, there we go. We have the required data. So, we are authorized to communicate with our API.</p>
<h3>Inspecting Console Logs</h3>
<p>Now, let’s take a look at the console window of the IdentityServer project:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer.png" alt="API call to IdentityServer" width="961" height="308" srcset="https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer.png 961w, https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer-300x96.png 300w, https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer-768x246.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer.png 961w, https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer-300x96.png 300w, https://code-maze.com/wp-content/uploads/2020/04/18-API-call-to-IdentityServer-768x246.png 768w" sizes="(max-width: 961px) 100vw, 961px"></a></p>
<p>What we can see here is that our API sent a request to the /.well-known/openid-configuration/jwks endpoint to retrieve a public key from the identity server to validate our token.</p>
<p>We can validate that this communication is taking place by modifying our token in Postman. If we do that, we are going to get 401 for sure as a result, because the token is tempered with and is valid no more:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token.png" alt="Tempered token - IdentityServer4 UI" width="960" height="470" srcset="https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token.png 960w, https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token-300x147.png 300w, https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token-768x376.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token.png 960w, https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token-300x147.png 300w, https://code-maze.com/wp-content/uploads/2020/04/19-Tempered-token-768x376.png 768w" sizes="(max-width: 960px) 100vw, 960px"></a></p>
<p>Excellent. We can see the communication between our API and the Identity Server is working flawlessly.</p>
<h3><span lang="SR-LATN-RS">Inspecting Claims</span></h3>
<p>Finally, we can inspect the claims from the token. To do that let’s add a single code line in the <code>GetCompanies</code> action:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5e8c178ba3db0681123938" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>var</span><span> </span><span>claims</span><span> </span>=<span> </span><span>User</span><span>.</span><span>Claims</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>After we acquire a valid token again and send a request to our API, we can see all the claims:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/20-Inspecting-claims.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/20-Inspecting-claims.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/20-Inspecting-claims.png" alt="Inspecting claims" width="657" height="339" srcset="https://code-maze.com/wp-content/uploads/2020/04/20-Inspecting-claims.png 657w, https://code-maze.com/wp-content/uploads/2020/04/20-Inspecting-claims-300x155.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/20-Inspecting-claims.png 657w, https://code-maze.com/wp-content/uploads/2020/04/20-Inspecting-claims-300x155.png 300w" sizes="(max-width: 657px) 100vw, 657px"></a></p>
<p>So, we can see all the data from the access token provided as a Bearer token in our request. And we can confirm that this token is not tampered with, because at this point, the token is already validated and the API has all the required information from it.</p>
<p>Of course, we’ve used the Client_Credentials flow in this example, but if you use the ResourceOwnerPassword flow, we are going to get additional claims for sure:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow.png" alt="Inspecting claims ROP flow" width="902" height="262" srcset="https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow.png 902w, https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow-300x87.png 300w, https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow-768x223.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow.png 902w, https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow-300x87.png 300w, https://code-maze.com/wp-content/uploads/2020/04/21-Inspecting-claims-ROP-flow-768x223.png 768w" sizes="(max-width: 902px) 100vw, 902px"></a></p>
<p>If we decode this token, we are going to get the same result:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token.png" alt="Decoded token" width="1183" height="714" srcset="https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token.png 1183w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-300x181.png 300w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-1024x618.png 1024w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-768x464.png 768w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-1080x652.png 1080w" data-srcset="https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token.png 1183w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-300x181.png 300w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-1024x618.png 1024w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-768x464.png 768w, https://code-maze.com/wp-content/uploads/2020/04/22-Decoded-token-1080x652.png 1080w" sizes="(max-width: 1183px) 100vw, 1183px"></a></p>
<p>Excellent. Everything works as expected.</p>
<h2 id="conclusion">Conclusion</h2>
<p>So, we have learned how to add the UI part to our authorization server and also how to protect our Web API by using two different flows. Of course, we are going to learn more about API protection with additional flows and we are going to use this UI for that purpose as well.</p>
<p>In the next article, we are going to learn how to use the Hybrid flow to protect our web application.</p>

</div>
														</div>
														

																				</article>

						
						
												
										
				
			</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>