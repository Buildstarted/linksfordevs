<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Measure Two Hundred Times, Tweak Twice -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Measure Two Hundred Times, Tweak Twice</h1>
    <div><p>My buddy <a href="https://twitter.com/purekrome">Pure.Krome</a> stopped by the JabbR nerd chat with a question.</p>
<blockquote>
<p>With this code, would a string be created <em>each time</em> the response was generated?</p>
</blockquote>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp">httpResponse<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">&quot;Cache-Control&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> $<span class="token string">&quot;public,max-age={seconds},must-revalidate&quot;</span><span class="token punctuation">;</span></code></pre></div>
<p><a href="https://twitter.com/davidwengier">David Wengier</a> helpfully provided an answer (yes), and why (a bling-string is just a <code class="language-text">string.Format()</code> call when it&#x2019;s converted to IL). But, in TRUE NERD FASHION, we took things to the extreme with some helpful and not-helpful alternatives. </p>
<p>Mr. Wengier also has a <a href="https://www.youtube.com/watch?v=24qazsRnc40">talk on pragmatic performance</a> that is worth the watch and inspired me to sit down and play with <a href="https://benchmarkdotnet.org/">BenchmarkDotNet</a> for the first time.</p>
<p>BenchmarkDotNet is a wonderful tool for micro-benchmarking. When you have a small bit of code and you want to know if one option is better or worse than another, you need a miro-benchmarking tool. It will run though a bunch of iterations for you and present a cleaner picture than if you put a timer on each end yourself.</p>
<p>Below, I set up a .NET Core console app, create a class to hold the benchmarks I want to compare, and then tell the BenchmarkRunner to go to town. By default, the output will be sent to the console window.</p>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">CoreJob</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Strings</span>
<span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token class-name">Benchmark</span><span class="token punctuation">(</span>Baseline <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">ArgumentsSource</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>PassingInts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">BlingString</span><span class="token punctuation">(</span><span class="token keyword">int</span> seconds<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> $<span class="token string">&quot;public,max-age={seconds},must-revalidate&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">PassingInts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">60</span><span class="token punctuation">;</span> <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">;</span> <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> summary <span class="token operator">=</span> BenchmarkRunner<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Run</span><span class="token punctuation">&lt;</span><span class="token class-name">Strings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And, spoiler alert, the <code class="language-text">BlingString(seconds)</code> method is not speedy. But, it&#x2019;s not horrible. I&#x2019;m going to throw my pragmatic hat in the bushes and come up with some alternatives. Then I&#x2019;ll order a shiny, new pragmatic hat and discuss trade-offs.</p>
<p>First, the easy alternative. If we want execution speed, then let&#x2019;s just hard-code something in. Everything gets cached for an hour.</p>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp"> <span class="token punctuation">[</span><span class="token class-name">Benchmark</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">Literal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;public,max-age=3600,must-revalidate&quot;</span><span class="token punctuation">;</span></code></pre></div>
<p>If <code class="language-text">BlingString</code> is our skateboard, then <code class="language-text">Literal()</code> is the super-charged sport bike. There is no computation. BenchmarkDotNet is confused why it&#x2019;s here.</p>
<div class="gatsby-highlight"><pre class="language-text"><code class="language-text">Strings.Literal: Core -&gt; The method duration is indistinguishable from the empty method duration</code></pre></div>
<p>That&#x2019;s interesting but&#x2026; well, only until one of your teammates uses your cache header function when they want to cache a critical lookup for just a second. Then your high-frequency trading app trades on stale data. The investors lose millions. And you swear you&#x2019;ll never use C# again.</p>
<p>So, now we know that literals are fast. And, we know that <code class="language-text">string.Format()</code> (our bling string) is slow. If we could just cache strings we&#x2019;ve returned before&#x2026;</p>
<p>It turns out, in fact, that we can do just that.</p>
<p>One of the collection objects in .NET is the <code class="language-text">ConcurrentDictionary</code>. It&#x2019;s thread-safe (well, enough for our usage) and, as importantly, it has a <code class="language-text">GetOrAdd</code> method we can use</p>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token class-name">TValue</span> <span class="token function">GetOrAdd</span><span class="token punctuation">(</span><span class="token class-name">TKey</span> key<span class="token punctuation">,</span>&#x2002;Func<span class="token operator">&lt;</span>TKey<span class="token punctuation">,</span>&#x2002;TValue<span class="token operator">&gt;</span> valueFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>If a given key exists, then the value is returned. </p>
<p>If the key does not exist, then the Func is called to generate the value. The value is then added to the dictionary and returned. Broadly, this means we can store our cached strings and generate new ones only when needed.</p>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp"> <span class="token keyword">private</span> ConcurrentDictionary<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">&gt;</span> LittleShopOfHorrors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">ConcurrentDictionary</span><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">[</span><span class="token class-name">Benchmark</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">ArgumentsSource</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>PassingInts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">LookupDictionary</span><span class="token punctuation">(</span><span class="token keyword">int</span> seconds<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> LittleShopOfHorrors<span class="token punctuation">.</span><span class="token function">GetOrAdd</span><span class="token punctuation">(</span>seconds<span class="token punctuation">,</span> s <span class="token operator">=</span><span class="token operator">&gt;</span> $<span class="token string">&quot;public,max-age={s},must-revalidate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>But, this has a glaring problem that <a href="https://twitter.com/adandy_">Aaron Dandy</a> pointed out &#x201C;dictionaries fill up&#x201D;. That is, there&#x2019;s no limit to how big our dictionary can grow. Other developers, intentionally (adversarial) or not, might leave you with a 2GB dictionary full of unused values.</p>
<p>Anyway, this part of the journey is to keep some brainstorming ideas going. We don&#x2019;t have our pragmatic hat on so we don&#x2019;t care about memory!</p>
<p>On to a couple of more elegant ideas propsed by David&#x2026;</p>
<p>First, if we&#x2019;re fairly sure that we will often see many requests for the same value at once, we can implement a poor cache. Just track what we&#x2019;ve seen last and use that if it matches.</p>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp"> <span class="token keyword">private</span> <span class="token keyword">int</span> _lastSeconds <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">string</span> _lastHeader <span class="token operator">=</span> <span class="token string">&quot;public,max-age=3600,must-revalidate&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">[</span><span class="token class-name">Benchmark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">ArgumentsSource</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>PassingInts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">LastCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_lastSeconds <span class="token operator">!=</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span> _lastSeconds <span class="token operator">=</span> seconds<span class="token punctuation">;</span> _lastHeader <span class="token operator">=</span> $<span class="token string">&quot;public,max-age={seconds},must-revalidate&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> _lastHeader<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></div>
<p>This retains the flexibility of working for any number of seconds passed in while betting on most calls using the same value.</p>
<p>The next option is to just take all but a couple options off of the table. We can use an enum to control what is returned.</p>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp"> <span class="token keyword">public</span> <span class="token keyword">enum</span> CacheLengths <span class="token punctuation">{</span> Short <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> Medium <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> Long <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token class-name">Benchmark</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">ArgumentsSource</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>PassingEnums<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">LiteralByChoice</span><span class="token punctuation">(</span><span class="token class-name">CacheLengths</span> cacheLength<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>cacheLength<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> CacheLengths<span class="token punctuation">.</span>Short<span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token string">&quot;public,max-age=60,must-revalidate&quot;</span><span class="token punctuation">;</span> <span class="token keyword">case</span> CacheLengths<span class="token punctuation">.</span>Medium<span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token string">&quot;public,max-age=3600,must-revalidate&quot;</span><span class="token punctuation">;</span> <span class="token keyword">case</span> CacheLengths<span class="token punctuation">.</span>Long<span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token string">&quot;public,max-age=86400,must-revalidate&quot;</span><span class="token punctuation">;</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token string">&quot;public,max-age=0&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></pre></div>
<p>Now, obviously, this is very inflexible. But, on the other hand, it allows the original author to provide a clearer indication of what the impact of a given value is.</p>
<p>Last, I came up with what I feel is a more esoteric option. I learned a lot about some parts of the framework that I didn&#x2019;t know before. I can keep this knowledge filed away in case I need it in the future. And, of course, we&#x2019;re not going to limit ourselves until we see what the runtime characteristics are.</p>
<div class="gatsby-highlight"><pre class="language-csharp"><code class="language-csharp"> <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">int</span> Entries <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">int</span> StepSize <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _acceptableSeconds <span class="token operator">=</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Entries<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>seconds <span class="token operator">=</span><span class="token operator">&gt;</span> seconds <span class="token operator">*</span> StepSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _fuckYouImATrain <span class="token operator">=</span> _acceptableSeconds<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>seconds <span class="token operator">=</span><span class="token operator">&gt;</span> $<span class="token string">&quot;public,max-age={seconds},must-revalidate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">[</span><span class="token class-name">Benchmark</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">ArgumentsSource</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>PassingInts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">FindNearest</span><span class="token punctuation">(</span><span class="token keyword">int</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> idx <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">BinarySearch</span><span class="token punctuation">(</span>_acceptableSeconds<span class="token punctuation">,</span> <span class="token function">RoundToNearest</span><span class="token punctuation">(</span>seconds<span class="token punctuation">,</span> StepSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> _fuckYouImATrain<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">~</span>idx <span class="token operator">&lt;</span> Entries <span class="token operator">?</span> _fuckYouImATrain<span class="token punctuation">[</span><span class="token operator">~</span>idx<span class="token punctuation">]</span> <span class="token punctuation">:</span> _fuckYouImATrain<span class="token punctuation">[</span><span class="token class-name">Entries</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></div>
<p>We create some acceptable values for <code class="language-text">seconds</code>. And then we create a string array of cache headers generated from those acceptable values.</p>
<p>When <code class="language-text">FindNearest(seconds)</code> is called, we want to find the closest matching header. We know that we store strings generated in 60 second increments. So, if <code class="language-text">FindNearest(50)</code>, <code class="language-text">FindNearest(60)</code>, or <code class="language-text">FindNearest(59)</code> is called, then we want to find the nearest match to <code class="language-text">60</code> (in this case).</p>
<p>This code is, honestly, a mess from top to bottom:</p>
<ul>
<li>It relies on keys and values being the same length and in the same order. </li>
<li>The returned value does not follow the principal of least surprise because there&#x2019;s no obviously correlation between what you pass in and what you receive back (better naming would help a little). </li>
<li>From a maintenance standpoint, you&#x2019;ll need to remember what operator <code class="language-text">~</code> is each time you read the code;</li>
<li>you&#x2019;ll have to know why you&#x2019;re using either the index or the XORed compliment of the index</li>
<li>and you&#x2019;ll have to think about bounds checking.</li>
</ul>
<p>But, if the speed is there then maybe&#x2026; maybe&#x2026; it&#x2019;s worth it.</p>
<p>Let&#x2019;s put it all together (<a href="https://gist.github.com/hyrmn/160fe639d4e5627be16fbeb4ae3b2cdf">gist here</a>) and see what those numbers look like.</p>
<p><figure class="gatsby-resp-image-figure"> <span class="gatsby-resp-image-wrapper"> <a class="gatsby-resp-image-link" href="/static/3589debf16918128fe1eaa93bcc3b10c/5f7a2/run_results.png"> <span class="gatsby-resp-image-background-image"></span> <img class="gatsby-resp-image-image" alt="BenchmarkDotNet results" src="/static/3589debf16918128fe1eaa93bcc3b10c/dbb61/run_results.png" srcset="https://hyr.mn/static/3589debf16918128fe1eaa93bcc3b10c/19bd1/run_results.png 163w, https://hyr.mn/static/3589debf16918128fe1eaa93bcc3b10c/d3bcb/run_results.png 325w, https://hyr.mn/static/3589debf16918128fe1eaa93bcc3b10c/dbb61/run_results.png 650w, https://hyr.mn/static/3589debf16918128fe1eaa93bcc3b10c/5f7a2/run_results.png 923w" sizes="(max-width: 650px) 100vw, 650px"> </a> </span> <figcaption class="gatsby-resp-image-figcaption">BenchmarkDotNet results</figcaption> </figure></p>
<p>A look at the results will tell us that, by far, the bling string approach is the worst with a mean time of about 250 nanoseconds per call. </p>
<p>Our enum option is the best contender if we can live with the constraints while the the simple cache approach is perfect if we&#x2019;ll often use the same value in subsequent calls (it trends towards the bling string performance the less often that&#x2019;s true).</p>
<p>The lookup dictionary is next fastest while our binary search is slow enough that it hardly seems worth the trouble. This is because search time for the dictionary is an <code class="language-text">O(1)</code> operation while the binary search is, on average, <code class="language-text">O(log n)</code>. (Thanks <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">Wikipedia</a>!)</p>
<p>So, pragmatic hat back on. What&#x2019;s the best option? That depends! Look at that, after reading all the way to here, I pull out a trite catchphrase. This is where we need to understand our system. We don&#x2019;t care about optimizing the 97% that doesn&#x2019;t matter; we need to apply ourselves to the 3% that does. </p>
<p>If this method is called on every single HTTP request, but it&#x2019;s an internal app that gets called 1000 a day, then who cares! Leave the bling string in place. If this is only called when an image is requested from blob storage and the cache time is an hour, then maybe just hard-code it and be done.</p>
<p>On the other hand, if this is part of some critical infrastructure where saving milliseconds will net you a comfortable end-of-year bonus, then it&#x2019;s time to dig in and make some harder choices that depend on understanding your system.</p>
<p>When we optimize code, we have to keep mutiple audiences in mind. There&#x2019;s the callers of our code. Which design choice keeps the API straightforward and unsurprising? There&#x2019;s future maintenance devs (including yourself after you&#x2019;ve forgotten the reasoning behind your change). Which change makes the code straightforward? What can we do to minimize breaking logic changes? And, of course, the runtime. Which change has a positive impact on execution time? Which change is least likely to have unintended runtime consequences if misused?</p>
<p>Lots of questions but no answers. But, with a solid handle on writing small benchmarks to evaluate options, you&#x2019;ll be better equiped to make choices within the scope of the applications that you write and maintain.</p></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>