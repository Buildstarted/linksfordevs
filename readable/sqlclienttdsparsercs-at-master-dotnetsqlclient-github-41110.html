<!DOCTYPE html>
<html lang="en">
<head>
    <title>
dotnet/SqlClient - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="dotnet/SqlClient - linksfor.dev(s)"/>
    <meta property="og:description" content="Microsoft.Data.SqlClient provides database connectivity to SQL Server for .NET applications. - dotnet/SqlClient"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://github.com/dotnet/SqlClient/blob/master/src/Microsoft.Data.SqlClient/netfx/src/Microsoft/Data/SqlClient/TdsParser.cs"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - dotnet/SqlClient</title>
<div class="readable">
        <h1>dotnet/SqlClient</h1>
            <div>Reading time: 918-1167 minutes</div>
        <div>Posted here: 08 Nov 2019</div>
        <p><a href="https://github.com/dotnet/SqlClient/blob/master/src/Microsoft.Data.SqlClient/netfx/src/Microsoft/Data/SqlClient/TdsParser.cs">https://github.com/dotnet/SqlClient/blob/master/src/Microsoft.Data.SqlClient/netfx/src/Microsoft/Data/SqlClient/TdsParser.cs</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div itemprop="text">
      
<table data-tab-size="4">
      <tbody><tr>
        <td id="L1" data-line-number="1"></td>
        <td id="LC1"><span><span>//</span> Licensed to the .NET Foundation under one or more agreements.</span></td>
      </tr>
      <tr>
        <td id="L2" data-line-number="2"></td>
        <td id="LC2"><span><span>//</span> The .NET Foundation licenses this file to you under the MIT license.</span></td>
      </tr>
      <tr>
        <td id="L3" data-line-number="3"></td>
        <td id="LC3"><span><span>//</span> See the LICENSE file in the project root for more information.</span></td>
      </tr>
      <tr>
        <td id="L4" data-line-number="4"></td>
        <td id="LC4">
</td>
      </tr>
      <tr>
        <td id="L5" data-line-number="5"></td>
        <td id="LC5"><span>using</span> <span>System</span>;</td>
      </tr>
      <tr>
        <td id="L6" data-line-number="6"></td>
        <td id="LC6"><span>using</span> <span>System</span>.<span>Collections</span>.<span>Generic</span>;</td>
      </tr>
      <tr>
        <td id="L7" data-line-number="7"></td>
        <td id="LC7"><span>using</span> <span>System</span>.<span>Data</span>;</td>
      </tr>
      <tr>
        <td id="L8" data-line-number="8"></td>
        <td id="LC8"><span>using</span> <span>System</span>.<span>Data</span>.<span>SqlTypes</span>;</td>
      </tr>
      <tr>
        <td id="L9" data-line-number="9"></td>
        <td id="LC9"><span>using</span> <span>System</span>.<span>Diagnostics</span>;</td>
      </tr>
      <tr>
        <td id="L10" data-line-number="10"></td>
        <td id="LC10"><span>using</span> <span>System</span>.<span>Globalization</span>;</td>
      </tr>
      <tr>
        <td id="L11" data-line-number="11"></td>
        <td id="LC11"><span>using</span> <span>System</span>.<span>IO</span>;</td>
      </tr>
      <tr>
        <td id="L12" data-line-number="12"></td>
        <td id="LC12"><span>using</span> <span>System</span>.<span>Runtime</span>.<span>CompilerServices</span>;</td>
      </tr>
      <tr>
        <td id="L13" data-line-number="13"></td>
        <td id="LC13"><span>using</span> <span>System</span>.<span>Runtime</span>.<span>InteropServices</span>;</td>
      </tr>
      <tr>
        <td id="L14" data-line-number="14"></td>
        <td id="LC14"><span>using</span> <span>System</span>.<span>Security</span>.<span>Cryptography</span>.<span>X509Certificates</span>;</td>
      </tr>
      <tr>
        <td id="L15" data-line-number="15"></td>
        <td id="LC15"><span>using</span> <span>System</span>.<span>Text</span>;</td>
      </tr>
      <tr>
        <td id="L16" data-line-number="16"></td>
        <td id="LC16"><span>using</span> <span>System</span>.<span>Threading</span>;</td>
      </tr>
      <tr>
        <td id="L17" data-line-number="17"></td>
        <td id="LC17"><span>using</span> <span>System</span>.<span>Threading</span>.<span>Tasks</span>;</td>
      </tr>
      <tr>
        <td id="L18" data-line-number="18"></td>
        <td id="LC18"><span>using</span> <span>System</span>.<span>Xml</span>;</td>
      </tr>
      <tr>
        <td id="L19" data-line-number="19"></td>
        <td id="LC19"><span>using</span> <span>Microsoft</span>.<span>Data</span>.<span>Common</span>;</td>
      </tr>
      <tr>
        <td id="L20" data-line-number="20"></td>
        <td id="LC20"><span>using</span> <span>Microsoft</span>.<span>Data</span>.<span>Sql</span>;</td>
      </tr>
      <tr>
        <td id="L21" data-line-number="21"></td>
        <td id="LC21"><span>using</span> <span>Microsoft</span>.<span>Data</span>.<span>SqlClient</span>.<span>DataClassification</span>;</td>
      </tr>
      <tr>
        <td id="L22" data-line-number="22"></td>
        <td id="LC22"><span>using</span> <span>Microsoft</span>.<span>Data</span>.<span>SqlClient</span>.<span>Server</span>;</td>
      </tr>
      <tr>
        <td id="L23" data-line-number="23"></td>
        <td id="LC23"><span>using</span> <span>Microsoft</span>.<span>Data</span>.<span>SqlTypes</span>;</td>
      </tr>
      <tr>
        <td id="L24" data-line-number="24"></td>
        <td id="LC24">
</td>
      </tr>
      <tr>
        <td id="L25" data-line-number="25"></td>
        <td id="LC25"><span>namespace</span> <span>Microsoft</span>.<span>Data</span>.<span>SqlClient</span></td>
      </tr>
      <tr>
        <td id="L26" data-line-number="26"></td>
        <td id="LC26">{</td>
      </tr>
      <tr>
        <td id="L27" data-line-number="27"></td>
        <td id="LC27">
</td>
      </tr>
      <tr>
        <td id="L28" data-line-number="28"></td>
        <td id="LC28">    <span><span>//</span> The TdsParser Object controls reading/writing to the netlib, parsing the tds,</span></td>
      </tr>
      <tr>
        <td id="L29" data-line-number="29"></td>
        <td id="LC29">    <span><span>//</span> and surfacing objects to the user.</span></td>
      </tr>
      <tr>
        <td id="L30" data-line-number="30"></td>
        <td id="LC30">    <span>sealed</span> <span>internal</span> <span>class</span> <span>TdsParser</span></td>
      </tr>
      <tr>
        <td id="L31" data-line-number="31"></td>
        <td id="LC31">    {</td>
      </tr>
      <tr>
        <td id="L32" data-line-number="32"></td>
        <td id="LC32">        <span>private</span> <span>static</span> <span>int</span> <span>_objectTypeCount</span>; <span><span>//</span> Bid counter</span></td>
      </tr>
      <tr>
        <td id="L33" data-line-number="33"></td>
        <td id="LC33">        <span>internal</span> <span>readonly</span> <span>int</span> <span>_objectID</span> <span>=</span> <span>System</span>.<span>Threading</span>.<span>Interlocked</span>.<span>Increment</span>(<span>ref</span> <span>_objectTypeCount</span>);</td>
      </tr>
      <tr>
        <td id="L34" data-line-number="34"></td>
        <td id="LC34">
</td>
      </tr>
      <tr>
        <td id="L35" data-line-number="35"></td>
        <td id="LC35">        <span>static</span> <span>Task</span> <span>completedTask</span>;</td>
      </tr>
      <tr>
        <td id="L36" data-line-number="36"></td>
        <td id="LC36">        <span>static</span> <span>Task</span> <span>CompletedTask</span></td>
      </tr>
      <tr>
        <td id="L37" data-line-number="37"></td>
        <td id="LC37">        {</td>
      </tr>
      <tr>
        <td id="L38" data-line-number="38"></td>
        <td id="LC38">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L39" data-line-number="39"></td>
        <td id="LC39">            {</td>
      </tr>
      <tr>
        <td id="L40" data-line-number="40"></td>
        <td id="LC40">                <span>if</span> (<span>completedTask</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L41" data-line-number="41"></td>
        <td id="LC41">                {</td>
      </tr>
      <tr>
        <td id="L42" data-line-number="42"></td>
        <td id="LC42">                    <span>completedTask</span> <span>=</span> <span>Task</span>.<span>FromResult</span>&lt;<span>object</span>&gt;(<span>null</span>);</td>
      </tr>
      <tr>
        <td id="L43" data-line-number="43"></td>
        <td id="LC43">                }</td>
      </tr>
      <tr>
        <td id="L44" data-line-number="44"></td>
        <td id="LC44">                <span>return</span> <span>completedTask</span>;</td>
      </tr>
      <tr>
        <td id="L45" data-line-number="45"></td>
        <td id="LC45">            }</td>
      </tr>
      <tr>
        <td id="L46" data-line-number="46"></td>
        <td id="LC46">        }</td>
      </tr>
      <tr>
        <td id="L47" data-line-number="47"></td>
        <td id="LC47">
</td>
      </tr>
      <tr>
        <td id="L48" data-line-number="48"></td>
        <td id="LC48">        <span>internal</span> <span>int</span> <span>ObjectID</span></td>
      </tr>
      <tr>
        <td id="L49" data-line-number="49"></td>
        <td id="LC49">        {</td>
      </tr>
      <tr>
        <td id="L50" data-line-number="50"></td>
        <td id="LC50">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L51" data-line-number="51"></td>
        <td id="LC51">            {</td>
      </tr>
      <tr>
        <td id="L52" data-line-number="52"></td>
        <td id="LC52">                <span>return</span> <span>_objectID</span>;</td>
      </tr>
      <tr>
        <td id="L53" data-line-number="53"></td>
        <td id="LC53">            }</td>
      </tr>
      <tr>
        <td id="L54" data-line-number="54"></td>
        <td id="LC54">        }</td>
      </tr>
      <tr>
        <td id="L55" data-line-number="55"></td>
        <td id="LC55">
</td>
      </tr>
      <tr>
        <td id="L56" data-line-number="56"></td>
        <td id="LC56">
</td>
      </tr>
      <tr>
        <td id="L57" data-line-number="57"></td>
        <td id="LC57">        <span><span>//</span> ReliabilitySection Usage:</span></td>
      </tr>
      <tr>
        <td id="L58" data-line-number="58"></td>
        <td id="LC58">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L59" data-line-number="59"></td>
        <td id="LC59">        <span><span>//</span> #if DEBUG</span></td>
      </tr>
      <tr>
        <td id="L60" data-line-number="60"></td>
        <td id="LC60">        <span><span>//</span>        TdsParser.ReliabilitySection tdsReliabilitySection = new TdsParser.ReliabilitySection();</span></td>
      </tr>
      <tr>
        <td id="L61" data-line-number="61"></td>
        <td id="LC61">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L62" data-line-number="62"></td>
        <td id="LC62">        <span><span>//</span>        RuntimeHelpers.PrepareConstrainedRegions();</span></td>
      </tr>
      <tr>
        <td id="L63" data-line-number="63"></td>
        <td id="LC63">        <span><span>//</span>        try {</span></td>
      </tr>
      <tr>
        <td id="L64" data-line-number="64"></td>
        <td id="LC64">        <span><span>//</span>            tdsReliabilitySection.Start();</span></td>
      </tr>
      <tr>
        <td id="L65" data-line-number="65"></td>
        <td id="LC65">        <span><span>//</span> #else</span></td>
      </tr>
      <tr>
        <td id="L66" data-line-number="66"></td>
        <td id="LC66">        <span><span>//</span>        {</span></td>
      </tr>
      <tr>
        <td id="L67" data-line-number="67"></td>
        <td id="LC67">        <span><span>//</span> #endif //DEBUG</span></td>
      </tr>
      <tr>
        <td id="L68" data-line-number="68"></td>
        <td id="LC68">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L69" data-line-number="69"></td>
        <td id="LC69">        <span><span>//</span>        // code that requires reliability</span></td>
      </tr>
      <tr>
        <td id="L70" data-line-number="70"></td>
        <td id="LC70">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L71" data-line-number="71"></td>
        <td id="LC71">        <span><span>//</span>        }</span></td>
      </tr>
      <tr>
        <td id="L72" data-line-number="72"></td>
        <td id="LC72">        <span><span>//</span> #if DEBUG</span></td>
      </tr>
      <tr>
        <td id="L73" data-line-number="73"></td>
        <td id="LC73">        <span><span>//</span>        finally {</span></td>
      </tr>
      <tr>
        <td id="L74" data-line-number="74"></td>
        <td id="LC74">        <span><span>//</span>            tdsReliabilitySection.Stop();</span></td>
      </tr>
      <tr>
        <td id="L75" data-line-number="75"></td>
        <td id="LC75">        <span><span>//</span>        }</span></td>
      </tr>
      <tr>
        <td id="L76" data-line-number="76"></td>
        <td id="LC76">        <span><span>//</span>  #endif //DEBUG</span></td>
      </tr>
      <tr>
        <td id="L77" data-line-number="77"></td>
        <td id="LC77">
</td>
      </tr>
      <tr>
        <td id="L78" data-line-number="78"></td>
        <td id="LC78">        <span>internal</span> <span>struct</span> <span>ReliabilitySection</span></td>
      </tr>
      <tr>
        <td id="L79" data-line-number="79"></td>
        <td id="LC79">        {</td>
      </tr>
      <tr>
        <td id="L80" data-line-number="80"></td>
        <td id="LC80">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L81" data-line-number="81"></td>
        <td id="LC81">            <span><span>//</span> do not allocate TLS data in RETAIL bits</span></td>
      </tr>
      <tr>
        <td id="L82" data-line-number="82"></td>
        <td id="LC82">            [<span>ThreadStatic</span>]</td>
      </tr>
      <tr>
        <td id="L83" data-line-number="83"></td>
        <td id="LC83">            <span>private</span> <span>static</span> <span>int</span> <span>s_reliabilityCount</span>; <span><span>//</span> initialized to 0 by CLR</span></td>
      </tr>
      <tr>
        <td id="L84" data-line-number="84"></td>
        <td id="LC84">
</td>
      </tr>
      <tr>
        <td id="L85" data-line-number="85"></td>
        <td id="LC85">            <span>private</span> <span>bool</span> <span>m_started</span>;  <span><span>//</span> initialized to false (not started) by CLR</span></td>
      </tr>
      <tr>
        <td id="L86" data-line-number="86"></td>
        <td id="LC86">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L87" data-line-number="87"></td>
        <td id="LC87">
</td>
      </tr>
      <tr>
        <td id="L88" data-line-number="88"></td>
        <td id="LC88">            [<span>Conditional</span>(<span><span>"</span>DEBUG<span>"</span></span>)]</td>
      </tr>
      <tr>
        <td id="L89" data-line-number="89"></td>
        <td id="LC89">            <span>internal</span> <span>void</span> <span>Start</span>()</td>
      </tr>
      <tr>
        <td id="L90" data-line-number="90"></td>
        <td id="LC90">            {</td>
      </tr>
      <tr>
        <td id="L91" data-line-number="91"></td>
        <td id="LC91">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L92" data-line-number="92"></td>
        <td id="LC92">                <span>Debug</span>.<span>Assert</span>(<span>!</span><span>m_started</span>);</td>
      </tr>
      <tr>
        <td id="L93" data-line-number="93"></td>
        <td id="LC93">
</td>
      </tr>
      <tr>
        <td id="L94" data-line-number="94"></td>
        <td id="LC94">                <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L95" data-line-number="95"></td>
        <td id="LC95">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L96" data-line-number="96"></td>
        <td id="LC96">                {</td>
      </tr>
      <tr>
        <td id="L97" data-line-number="97"></td>
        <td id="LC97">                }</td>
      </tr>
      <tr>
        <td id="L98" data-line-number="98"></td>
        <td id="LC98">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L99" data-line-number="99"></td>
        <td id="LC99">                {</td>
      </tr>
      <tr>
        <td id="L100" data-line-number="100"></td>
        <td id="LC100">                    <span>++</span><span>s_reliabilityCount</span>;</td>
      </tr>
      <tr>
        <td id="L101" data-line-number="101"></td>
        <td id="LC101">                    <span>m_started</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L102" data-line-number="102"></td>
        <td id="LC102">                }</td>
      </tr>
      <tr>
        <td id="L103" data-line-number="103"></td>
        <td id="LC103">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L104" data-line-number="104"></td>
        <td id="LC104">            }</td>
      </tr>
      <tr>
        <td id="L105" data-line-number="105"></td>
        <td id="LC105">
</td>
      </tr>
      <tr>
        <td id="L106" data-line-number="106"></td>
        <td id="LC106">            [<span>Conditional</span>(<span><span>"</span>DEBUG<span>"</span></span>)]</td>
      </tr>
      <tr>
        <td id="L107" data-line-number="107"></td>
        <td id="LC107">            <span>internal</span> <span>void</span> <span>Stop</span>()</td>
      </tr>
      <tr>
        <td id="L108" data-line-number="108"></td>
        <td id="LC108">            {</td>
      </tr>
      <tr>
        <td id="L109" data-line-number="109"></td>
        <td id="LC109">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L110" data-line-number="110"></td>
        <td id="LC110">                <span><span>//</span> cannot assert m_started - ThreadAbortException can be raised before Start is called</span></td>
      </tr>
      <tr>
        <td id="L111" data-line-number="111"></td>
        <td id="LC111">
</td>
      </tr>
      <tr>
        <td id="L112" data-line-number="112"></td>
        <td id="LC112">                <span>if</span> (<span>m_started</span>)</td>
      </tr>
      <tr>
        <td id="L113" data-line-number="113"></td>
        <td id="LC113">                {</td>
      </tr>
      <tr>
        <td id="L114" data-line-number="114"></td>
        <td id="LC114">                    <span>Debug</span>.<span>Assert</span>(<span>s_reliabilityCount</span> <span>&gt;</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L115" data-line-number="115"></td>
        <td id="LC115">
</td>
      </tr>
      <tr>
        <td id="L116" data-line-number="116"></td>
        <td id="LC116">                    <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L117" data-line-number="117"></td>
        <td id="LC117">                    <span>try</span></td>
      </tr>
      <tr>
        <td id="L118" data-line-number="118"></td>
        <td id="LC118">                    {</td>
      </tr>
      <tr>
        <td id="L119" data-line-number="119"></td>
        <td id="LC119">                    }</td>
      </tr>
      <tr>
        <td id="L120" data-line-number="120"></td>
        <td id="LC120">                    <span>finally</span></td>
      </tr>
      <tr>
        <td id="L121" data-line-number="121"></td>
        <td id="LC121">                    {</td>
      </tr>
      <tr>
        <td id="L122" data-line-number="122"></td>
        <td id="LC122">                        <span>--</span><span>s_reliabilityCount</span>;</td>
      </tr>
      <tr>
        <td id="L123" data-line-number="123"></td>
        <td id="LC123">                        <span>m_started</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L124" data-line-number="124"></td>
        <td id="LC124">                    }</td>
      </tr>
      <tr>
        <td id="L125" data-line-number="125"></td>
        <td id="LC125">                }</td>
      </tr>
      <tr>
        <td id="L126" data-line-number="126"></td>
        <td id="LC126">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L127" data-line-number="127"></td>
        <td id="LC127">            }</td>
      </tr>
      <tr>
        <td id="L128" data-line-number="128"></td>
        <td id="LC128">
</td>
      </tr>
      <tr>
        <td id="L129" data-line-number="129"></td>
        <td id="LC129">            <span><span>//</span> you need to setup for a thread abort somewhere before you call this method</span></td>
      </tr>
      <tr>
        <td id="L130" data-line-number="130"></td>
        <td id="LC130">            [<span>Conditional</span>(<span><span>"</span>DEBUG<span>"</span></span>)]</td>
      </tr>
      <tr>
        <td id="L131" data-line-number="131"></td>
        <td id="LC131">            <span>internal</span> <span>static</span> <span>void</span> <span>Assert</span>(<span>string</span> <span>message</span>)</td>
      </tr>
      <tr>
        <td id="L132" data-line-number="132"></td>
        <td id="LC132">            {</td>
      </tr>
      <tr>
        <td id="L133" data-line-number="133"></td>
        <td id="LC133">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L134" data-line-number="134"></td>
        <td id="LC134">                <span>Debug</span>.<span>Assert</span>(<span>s_reliabilityCount</span> <span>&gt;</span> <span>0</span>, <span>message</span>);</td>
      </tr>
      <tr>
        <td id="L135" data-line-number="135"></td>
        <td id="LC135">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L136" data-line-number="136"></td>
        <td id="LC136">            }</td>
      </tr>
      <tr>
        <td id="L137" data-line-number="137"></td>
        <td id="LC137">        }</td>
      </tr>
      <tr>
        <td id="L138" data-line-number="138"></td>
        <td id="LC138">
</td>
      </tr>
      <tr>
        <td id="L139" data-line-number="139"></td>
        <td id="LC139">        <span><span>//</span> Default state object for parser</span></td>
      </tr>
      <tr>
        <td id="L140" data-line-number="140"></td>
        <td id="LC140">        <span>internal</span> <span>TdsParserStateObject</span> <span>_physicalStateObj</span> <span>=</span> <span>null</span>; <span><span>//</span> Default stateObj and connection for Dbnetlib and non-MARS SNI.</span></td>
      </tr>
      <tr>
        <td id="L141" data-line-number="141"></td>
        <td id="LC141">
</td>
      </tr>
      <tr>
        <td id="L142" data-line-number="142"></td>
        <td id="LC142">        <span><span>//</span> Also, default logical stateObj and connection for MARS over SNI.</span></td>
      </tr>
      <tr>
        <td id="L143" data-line-number="143"></td>
        <td id="LC143">        <span>internal</span> <span>TdsParserStateObject</span> <span>_pMarsPhysicalConObj</span> <span>=</span> <span>null</span>; <span><span>//</span> With MARS enabled, cached physical stateObj and connection.</span></td>
      </tr>
      <tr>
        <td id="L144" data-line-number="144"></td>
        <td id="LC144">
</td>
      </tr>
      <tr>
        <td id="L145" data-line-number="145"></td>
        <td id="LC145">        <span><span>//</span> Must keep this around - especially for callbacks on pre-MARS</span></td>
      </tr>
      <tr>
        <td id="L146" data-line-number="146"></td>
        <td id="LC146">        <span><span>//</span> ReadAsync which will return if physical connection broken!</span></td>
      </tr>
      <tr>
        <td id="L147" data-line-number="147"></td>
        <td id="LC147">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L148" data-line-number="148"></td>
        <td id="LC148">        <span><span>//</span> Per Instance TDS Parser variables</span></td>
      </tr>
      <tr>
        <td id="L149" data-line-number="149"></td>
        <td id="LC149">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L150" data-line-number="150"></td>
        <td id="LC150">
</td>
      </tr>
      <tr>
        <td id="L151" data-line-number="151"></td>
        <td id="LC151">        <span><span>//</span> Constants</span></td>
      </tr>
      <tr>
        <td id="L152" data-line-number="152"></td>
        <td id="LC152">        <span>const</span> <span>int</span> <span>constBinBufferSize</span> <span>=</span> <span>4096</span>; <span><span>//</span> Size of the buffer used to read input parameter of type Stream</span></td>
      </tr>
      <tr>
        <td id="L153" data-line-number="153"></td>
        <td id="LC153">        <span>const</span> <span>int</span> <span>constTextBufferSize</span> <span>=</span> <span>4096</span>; <span><span>//</span> Size of the buffer (in chars) user to read input parameter of type TextReader</span></td>
      </tr>
      <tr>
        <td id="L154" data-line-number="154"></td>
        <td id="LC154">
</td>
      </tr>
      <tr>
        <td id="L155" data-line-number="155"></td>
        <td id="LC155">        <span><span>//</span> State variables</span></td>
      </tr>
      <tr>
        <td id="L156" data-line-number="156"></td>
        <td id="LC156">        <span>internal</span> <span>TdsParserState</span> <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>Closed</span>; <span><span>//</span> status flag for connection</span></td>
      </tr>
      <tr>
        <td id="L157" data-line-number="157"></td>
        <td id="LC157">
</td>
      </tr>
      <tr>
        <td id="L158" data-line-number="158"></td>
        <td id="LC158">        <span>private</span> <span>string</span> <span>_server</span> <span>=</span> <span><span>"</span><span>"</span></span>;                            <span><span>//</span> name of server that the parser connects to</span></td>
      </tr>
      <tr>
        <td id="L159" data-line-number="159"></td>
        <td id="LC159">
</td>
      </tr>
      <tr>
        <td id="L160" data-line-number="160"></td>
        <td id="LC160">        <span>internal</span> <span>volatile</span> <span>bool</span> <span>_fResetConnection</span> <span>=</span> <span>false</span>;                 <span><span>//</span> flag to denote whether we are needing to call sp_reset</span></td>
      </tr>
      <tr>
        <td id="L161" data-line-number="161"></td>
        <td id="LC161">        <span>internal</span> <span>volatile</span> <span>bool</span> <span>_fPreserveTransaction</span> <span>=</span> <span>false</span>;             <span><span>//</span> flag to denote whether we need to preserve the transaction when reseting</span></td>
      </tr>
      <tr>
        <td id="L162" data-line-number="162"></td>
        <td id="LC162">
</td>
      </tr>
      <tr>
        <td id="L163" data-line-number="163"></td>
        <td id="LC163">        <span>private</span> <span>SqlCollation</span> <span>_defaultCollation</span>;                         <span><span>//</span> default collation from the server</span></td>
      </tr>
      <tr>
        <td id="L164" data-line-number="164"></td>
        <td id="LC164">
</td>
      </tr>
      <tr>
        <td id="L165" data-line-number="165"></td>
        <td id="LC165">        <span>private</span> <span>int</span> <span>_defaultCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L166" data-line-number="166"></td>
        <td id="LC166">
</td>
      </tr>
      <tr>
        <td id="L167" data-line-number="167"></td>
        <td id="LC167">        <span>private</span> <span>int</span> <span>_defaultLCID</span>;</td>
      </tr>
      <tr>
        <td id="L168" data-line-number="168"></td>
        <td id="LC168">
</td>
      </tr>
      <tr>
        <td id="L169" data-line-number="169"></td>
        <td id="LC169">        <span>internal</span> <span>Encoding</span> <span>_defaultEncoding</span> <span>=</span> <span>null</span>;                  <span><span>//</span> for sql character data</span></td>
      </tr>
      <tr>
        <td id="L170" data-line-number="170"></td>
        <td id="LC170">
</td>
      </tr>
      <tr>
        <td id="L171" data-line-number="171"></td>
        <td id="LC171">        <span>private</span> <span>static</span> <span>EncryptionOptions</span> <span>_sniSupportedEncryptionOption</span> <span>=</span> <span>SNILoadHandle</span>.<span>SingletonInstance</span>.<span>Options</span>;</td>
      </tr>
      <tr>
        <td id="L172" data-line-number="172"></td>
        <td id="LC172">
</td>
      </tr>
      <tr>
        <td id="L173" data-line-number="173"></td>
        <td id="LC173">        <span>private</span> <span>static</span> SNINativeMethodWrapper.<span>SqlClientCertificateDelegate</span> <span>_clientCertificateCallback</span> <span>=</span> <span>new</span> <span>SNINativeMethodWrapper</span>.<span>SqlClientCertificateDelegate</span>(<span>ClientCertificateDelegate</span>);</td>
      </tr>
      <tr>
        <td id="L174" data-line-number="174"></td>
        <td id="LC174">
</td>
      </tr>
      <tr>
        <td id="L175" data-line-number="175"></td>
        <td id="LC175">        <span>private</span> <span>EncryptionOptions</span> <span>_encryptionOption</span> <span>=</span> <span>_sniSupportedEncryptionOption</span>;</td>
      </tr>
      <tr>
        <td id="L176" data-line-number="176"></td>
        <td id="LC176">
</td>
      </tr>
      <tr>
        <td id="L177" data-line-number="177"></td>
        <td id="LC177">        <span>private</span> <span>SqlInternalTransaction</span> <span>_currentTransaction</span>;</td>
      </tr>
      <tr>
        <td id="L178" data-line-number="178"></td>
        <td id="LC178">        <span>private</span> <span>SqlInternalTransaction</span> <span>_pendingTransaction</span>;    <span><span>//</span> pending transaction for Yukon and beyond.</span></td>
      </tr>
      <tr>
        <td id="L179" data-line-number="179"></td>
        <td id="LC179">        <span><span>//</span> SQLHOT 483</span></td>
      </tr>
      <tr>
        <td id="L180" data-line-number="180"></td>
        <td id="LC180">        <span><span>//</span>  need to hold on to the transaction id if distributed transaction merely rolls back without defecting.</span></td>
      </tr>
      <tr>
        <td id="L181" data-line-number="181"></td>
        <td id="LC181">        <span>private</span> <span>long</span> <span>_retainedTransactionId</span> <span>=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>;</td>
      </tr>
      <tr>
        <td id="L182" data-line-number="182"></td>
        <td id="LC182">
</td>
      </tr>
      <tr>
        <td id="L183" data-line-number="183"></td>
        <td id="LC183">        <span><span>//</span> This counter is used for the entire connection to track the open result count for all</span></td>
      </tr>
      <tr>
        <td id="L184" data-line-number="184"></td>
        <td id="LC184">        <span><span>//</span> operations not under a transaction.</span></td>
      </tr>
      <tr>
        <td id="L185" data-line-number="185"></td>
        <td id="LC185">        <span>private</span> <span>int</span> <span>_nonTransactedOpenResultCount</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L186" data-line-number="186"></td>
        <td id="LC186">
</td>
      </tr>
      <tr>
        <td id="L187" data-line-number="187"></td>
        <td id="LC187">        <span><span>//</span> Connection reference</span></td>
      </tr>
      <tr>
        <td id="L188" data-line-number="188"></td>
        <td id="LC188">        <span>private</span> <span>SqlInternalConnectionTds</span> <span>_connHandler</span>;</td>
      </tr>
      <tr>
        <td id="L189" data-line-number="189"></td>
        <td id="LC189">
</td>
      </tr>
      <tr>
        <td id="L190" data-line-number="190"></td>
        <td id="LC190">        <span><span>//</span> Async/Mars variables</span></td>
      </tr>
      <tr>
        <td id="L191" data-line-number="191"></td>
        <td id="LC191">        <span>private</span> <span>bool</span> <span>_fMARS</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L192" data-line-number="192"></td>
        <td id="LC192">
</td>
      </tr>
      <tr>
        <td id="L193" data-line-number="193"></td>
        <td id="LC193">        <span>internal</span> <span>bool</span> <span>_loginWithFailover</span> <span>=</span> <span>false</span>; <span><span>//</span> set to true while connect in failover mode so parser state object can adjust its logic</span></td>
      </tr>
      <tr>
        <td id="L194" data-line-number="194"></td>
        <td id="LC194">
</td>
      </tr>
      <tr>
        <td id="L195" data-line-number="195"></td>
        <td id="LC195">        <span>internal</span> <span>AutoResetEvent</span> <span>_resetConnectionEvent</span> <span>=</span> <span>null</span>;  <span><span>//</span> Used to serialize executes and call reset on first execute only.</span></td>
      </tr>
      <tr>
        <td id="L196" data-line-number="196"></td>
        <td id="LC196">
</td>
      </tr>
      <tr>
        <td id="L197" data-line-number="197"></td>
        <td id="LC197">        <span>internal</span> <span>TdsParserSessionPool</span> <span>_sessionPool</span> <span>=</span> <span>null</span>;  <span><span>//</span> initialized only when we're a MARS parser.</span></td>
      </tr>
      <tr>
        <td id="L198" data-line-number="198"></td>
        <td id="LC198">
</td>
      </tr>
      <tr>
        <td id="L199" data-line-number="199"></td>
        <td id="LC199">        <span><span>//</span> Version variables</span></td>
      </tr>
      <tr>
        <td id="L200" data-line-number="200"></td>
        <td id="LC200">        <span>private</span> <span>bool</span> <span>_isShiloh</span> <span>=</span> <span>false</span>; <span><span>//</span> set to true if we connect to a 8.0 server (SQL 2000) or later</span></td>
      </tr>
      <tr>
        <td id="L201" data-line-number="201"></td>
        <td id="LC201">
</td>
      </tr>
      <tr>
        <td id="L202" data-line-number="202"></td>
        <td id="LC202">        <span>private</span> <span>bool</span> <span>_isShilohSP1</span> <span>=</span> <span>false</span>; <span><span>//</span> set to true if speaking to Shiloh SP1 or later</span></td>
      </tr>
      <tr>
        <td id="L203" data-line-number="203"></td>
        <td id="LC203">
</td>
      </tr>
      <tr>
        <td id="L204" data-line-number="204"></td>
        <td id="LC204">        <span>private</span> <span>bool</span> <span>_isYukon</span> <span>=</span> <span>false</span>; <span><span>//</span> set to true if speaking to Yukon or later</span></td>
      </tr>
      <tr>
        <td id="L205" data-line-number="205"></td>
        <td id="LC205">
</td>
      </tr>
      <tr>
        <td id="L206" data-line-number="206"></td>
        <td id="LC206">        <span>private</span> <span>bool</span> <span>_isKatmai</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L207" data-line-number="207"></td>
        <td id="LC207">
</td>
      </tr>
      <tr>
        <td id="L208" data-line-number="208"></td>
        <td id="LC208">        <span>private</span> <span>bool</span> <span>_isDenali</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L209" data-line-number="209"></td>
        <td id="LC209">
</td>
      </tr>
      <tr>
        <td id="L210" data-line-number="210"></td>
        <td id="LC210">        <span>private</span> <span>byte</span>[] <span>_sniSpnBuffer</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L211" data-line-number="211"></td>
        <td id="LC211">
</td>
      </tr>
      <tr>
        <td id="L212" data-line-number="212"></td>
        <td id="LC212">        <span><span>//</span> UNDONE - need to have some for both instances - both command and default???</span></td>
      </tr>
      <tr>
        <td id="L213" data-line-number="213"></td>
        <td id="LC213">
</td>
      </tr>
      <tr>
        <td id="L214" data-line-number="214"></td>
        <td id="LC214">        <span><span>//</span> SqlStatistics</span></td>
      </tr>
      <tr>
        <td id="L215" data-line-number="215"></td>
        <td id="LC215">        <span>private</span> <span>SqlStatistics</span> <span>_statistics</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L216" data-line-number="216"></td>
        <td id="LC216">
</td>
      </tr>
      <tr>
        <td id="L217" data-line-number="217"></td>
        <td id="LC217">        <span>private</span> <span>bool</span> <span>_statisticsIsInTransaction</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L218" data-line-number="218"></td>
        <td id="LC218">
</td>
      </tr>
      <tr>
        <td id="L219" data-line-number="219"></td>
        <td id="LC219">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L220" data-line-number="220"></td>
        <td id="LC220">        <span><span>//</span> STATIC TDS Parser variables</span></td>
      </tr>
      <tr>
        <td id="L221" data-line-number="221"></td>
        <td id="LC221">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L222" data-line-number="222"></td>
        <td id="LC222">
</td>
      </tr>
      <tr>
        <td id="L223" data-line-number="223"></td>
        <td id="LC223">        <span><span>//</span> NIC address caching</span></td>
      </tr>
      <tr>
        <td id="L224" data-line-number="224"></td>
        <td id="LC224">        <span>private</span> <span>static</span> <span>byte</span>[] <span>s_nicAddress</span>;             <span><span>//</span> cache the NIC address from the registry</span></td>
      </tr>
      <tr>
        <td id="L225" data-line-number="225"></td>
        <td id="LC225">
</td>
      </tr>
      <tr>
        <td id="L226" data-line-number="226"></td>
        <td id="LC226">        <span><span>//</span> SSPI variables</span></td>
      </tr>
      <tr>
        <td id="L227" data-line-number="227"></td>
        <td id="LC227">        <span>private</span> <span>static</span> <span>bool</span> <span>s_fSSPILoaded</span> <span>=</span> <span>false</span>; <span><span>//</span> bool to indicate whether library has been loaded</span></td>
      </tr>
      <tr>
        <td id="L228" data-line-number="228"></td>
        <td id="LC228">
</td>
      </tr>
      <tr>
        <td id="L229" data-line-number="229"></td>
        <td id="LC229">        <span>private</span> <span>volatile</span> <span>static</span> <span>UInt32</span> <span>s_maxSSPILength</span> <span>=</span> <span>0</span>;     <span><span>//</span> variable to hold max SSPI data size, keep for token from server</span></td>
      </tr>
      <tr>
        <td id="L230" data-line-number="230"></td>
        <td id="LC230">
</td>
      </tr>
      <tr>
        <td id="L231" data-line-number="231"></td>
        <td id="LC231">        <span><span>//</span> textptr sequence</span></td>
      </tr>
      <tr>
        <td id="L232" data-line-number="232"></td>
        <td id="LC232">        <span>private</span> <span>static</span> <span>readonly</span> <span>byte</span>[] <span>s_longDataHeader</span> <span>=</span> { <span>0x10</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span>, <span>0xff</span> };</td>
      </tr>
      <tr>
        <td id="L233" data-line-number="233"></td>
        <td id="LC233">
</td>
      </tr>
      <tr>
        <td id="L234" data-line-number="234"></td>
        <td id="LC234">        <span>private</span> <span>static</span> <span>object</span> <span>s_tdsParserLock</span> <span>=</span> <span>new</span> <span>object</span>();</td>
      </tr>
      <tr>
        <td id="L235" data-line-number="235"></td>
        <td id="LC235">
</td>
      </tr>
      <tr>
        <td id="L236" data-line-number="236"></td>
        <td id="LC236">        <span><span>//</span> Various other statics</span></td>
      </tr>
      <tr>
        <td id="L237" data-line-number="237"></td>
        <td id="LC237">        <span>private</span> <span>const</span> <span>int</span> <span>ATTENTION_TIMEOUT</span> <span>=</span> <span>5000</span>;  <span><span>//</span> internal attention timeout, in ticks</span></td>
      </tr>
      <tr>
        <td id="L238" data-line-number="238"></td>
        <td id="LC238">
</td>
      </tr>
      <tr>
        <td id="L239" data-line-number="239"></td>
        <td id="LC239">        <span><span>//</span> XML metadata substitue sequence</span></td>
      </tr>
      <tr>
        <td id="L240" data-line-number="240"></td>
        <td id="LC240">        <span>private</span> <span>static</span> <span>readonly</span> <span>byte</span>[] <span>s_xmlMetadataSubstituteSequence</span> <span>=</span> { <span>0xe7</span>, <span>0xff</span>, <span>0xff</span>, <span>0x00</span>, <span>0x00</span>, <span>0x00</span>, <span>0x00</span>, <span>0x00</span> };</td>
      </tr>
      <tr>
        <td id="L241" data-line-number="241"></td>
        <td id="LC241">
</td>
      </tr>
      <tr>
        <td id="L242" data-line-number="242"></td>
        <td id="LC242">        <span><span>//</span> size of Guid  (e.g. _clientConnectionId, ActivityId.Id)</span></td>
      </tr>
      <tr>
        <td id="L243" data-line-number="243"></td>
        <td id="LC243">        <span>private</span> <span>const</span> <span>int</span> <span>GUID_SIZE</span> <span>=</span> <span>16</span>;</td>
      </tr>
      <tr>
        <td id="L244" data-line-number="244"></td>
        <td id="LC244">
</td>
      </tr>
      <tr>
        <td id="L245" data-line-number="245"></td>
        <td id="LC245">        <span><span>//</span> NOTE: You must take the internal connection's _parserLock before modifying this</span></td>
      </tr>
      <tr>
        <td id="L246" data-line-number="246"></td>
        <td id="LC246">        <span>internal</span> <span>bool</span> <span>_asyncWrite</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L247" data-line-number="247"></td>
        <td id="LC247">
</td>
      </tr>
      <tr>
        <td id="L248" data-line-number="248"></td>
        <td id="LC248">        <span><span>//</span> TCE supported flag, used to determine if new TDS fields are present. This is</span></td>
      </tr>
      <tr>
        <td id="L249" data-line-number="249"></td>
        <td id="LC249">        <span><span>//</span> useful when talking to downlevel/uplevel server.</span></td>
      </tr>
      <tr>
        <td id="L250" data-line-number="250"></td>
        <td id="LC250">        <span>private</span> <span>bool</span> <span>_serverSupportsColumnEncryption</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L251" data-line-number="251"></td>
        <td id="LC251">
</td>
      </tr>
      <tr>
        <td id="L252" data-line-number="252"></td>
        <td id="LC252">        <span><span>//</span> now data length is 1 byte</span></td>
      </tr>
      <tr>
        <td id="L253" data-line-number="253"></td>
        <td id="LC253">        <span><span>//</span> First bit is 1 indicating client support failover partner with readonly intent</span></td>
      </tr>
      <tr>
        <td id="L254" data-line-number="254"></td>
        <td id="LC254">        <span>private</span> <span>static</span> <span>readonly</span> <span>byte</span>[] <span>s_FeatureExtDataAzureSQLSupportFeatureRequest</span> <span>=</span> { <span>0x01</span> };</td>
      </tr>
      <tr>
        <td id="L255" data-line-number="255"></td>
        <td id="LC255">
</td>
      </tr>
      <tr>
        <td id="L256" data-line-number="256"></td>
        <td id="LC256">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L257" data-line-number="257"></td>
        <td id="LC257">        <span><span>///</span> Get or set if column encryption is supported by the server.</span></td>
      </tr>
      <tr>
        <td id="L258" data-line-number="258"></td>
        <td id="LC258">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L259" data-line-number="259"></td>
        <td id="LC259">        <span>internal</span> <span>bool</span> <span>IsColumnEncryptionSupported</span></td>
      </tr>
      <tr>
        <td id="L260" data-line-number="260"></td>
        <td id="LC260">        {</td>
      </tr>
      <tr>
        <td id="L261" data-line-number="261"></td>
        <td id="LC261">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L262" data-line-number="262"></td>
        <td id="LC262">            {</td>
      </tr>
      <tr>
        <td id="L263" data-line-number="263"></td>
        <td id="LC263">                <span>return</span> <span>_serverSupportsColumnEncryption</span>;</td>
      </tr>
      <tr>
        <td id="L264" data-line-number="264"></td>
        <td id="LC264">            }</td>
      </tr>
      <tr>
        <td id="L265" data-line-number="265"></td>
        <td id="LC265">            <span>set</span></td>
      </tr>
      <tr>
        <td id="L266" data-line-number="266"></td>
        <td id="LC266">            {</td>
      </tr>
      <tr>
        <td id="L267" data-line-number="267"></td>
        <td id="LC267">                <span>_serverSupportsColumnEncryption</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L268" data-line-number="268"></td>
        <td id="LC268">            }</td>
      </tr>
      <tr>
        <td id="L269" data-line-number="269"></td>
        <td id="LC269">        }</td>
      </tr>
      <tr>
        <td id="L270" data-line-number="270"></td>
        <td id="LC270">
</td>
      </tr>
      <tr>
        <td id="L271" data-line-number="271"></td>
        <td id="LC271">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L272" data-line-number="272"></td>
        <td id="LC272">        <span><span>///</span> TCE version supported by the server</span></td>
      </tr>
      <tr>
        <td id="L273" data-line-number="273"></td>
        <td id="LC273">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L274" data-line-number="274"></td>
        <td id="LC274">        <span>internal</span> <span>byte</span> <span>TceVersionSupported</span> { <span>get</span>; <span>set</span>; }</td>
      </tr>
      <tr>
        <td id="L275" data-line-number="275"></td>
        <td id="LC275">
</td>
      </tr>
      <tr>
        <td id="L276" data-line-number="276"></td>
        <td id="LC276">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L277" data-line-number="277"></td>
        <td id="LC277">        <span><span>///</span> Type of enclave being used by the server</span></td>
      </tr>
      <tr>
        <td id="L278" data-line-number="278"></td>
        <td id="LC278">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L279" data-line-number="279"></td>
        <td id="LC279">        <span>internal</span> <span>string</span> <span>EnclaveType</span> { <span>get</span>; <span>set</span>; }</td>
      </tr>
      <tr>
        <td id="L280" data-line-number="280"></td>
        <td id="LC280">
</td>
      </tr>
      <tr>
        <td id="L281" data-line-number="281"></td>
        <td id="LC281">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L282" data-line-number="282"></td>
        <td id="LC282">        <span><span>///</span> Get if data classification is enabled by the server.</span></td>
      </tr>
      <tr>
        <td id="L283" data-line-number="283"></td>
        <td id="LC283">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L284" data-line-number="284"></td>
        <td id="LC284">        <span>internal</span> <span>bool</span> <span>IsDataClassificationEnabled</span></td>
      </tr>
      <tr>
        <td id="L285" data-line-number="285"></td>
        <td id="LC285">        {</td>
      </tr>
      <tr>
        <td id="L286" data-line-number="286"></td>
        <td id="LC286">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L287" data-line-number="287"></td>
        <td id="LC287">            {</td>
      </tr>
      <tr>
        <td id="L288" data-line-number="288"></td>
        <td id="LC288">                <span>return</span> (<span>DataClassificationVersion</span> <span>!=</span> <span>TdsEnums</span>.<span>DATA_CLASSIFICATION_NOT_ENABLED</span>);</td>
      </tr>
      <tr>
        <td id="L289" data-line-number="289"></td>
        <td id="LC289">            }</td>
      </tr>
      <tr>
        <td id="L290" data-line-number="290"></td>
        <td id="LC290">        }</td>
      </tr>
      <tr>
        <td id="L291" data-line-number="291"></td>
        <td id="LC291">
</td>
      </tr>
      <tr>
        <td id="L292" data-line-number="292"></td>
        <td id="LC292">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L293" data-line-number="293"></td>
        <td id="LC293">        <span><span>///</span> Get or set data classification version.  A value of 0 means that sensitivity classification is not enabled.</span></td>
      </tr>
      <tr>
        <td id="L294" data-line-number="294"></td>
        <td id="LC294">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L295" data-line-number="295"></td>
        <td id="LC295">        <span>internal</span> <span>int</span> <span>DataClassificationVersion</span> { <span>get</span>; <span>set</span>; }</td>
      </tr>
      <tr>
        <td id="L296" data-line-number="296"></td>
        <td id="LC296">
</td>
      </tr>
      <tr>
        <td id="L297" data-line-number="297"></td>
        <td id="LC297">        <span>internal</span> <span>TdsParser</span>(<span>bool</span> <span>MARS</span>, <span>bool</span> <span>fAsynchronous</span>)</td>
      </tr>
      <tr>
        <td id="L298" data-line-number="298"></td>
        <td id="LC298">        {</td>
      </tr>
      <tr>
        <td id="L299" data-line-number="299"></td>
        <td id="LC299">            <span>_fMARS</span> <span>=</span> <span>MARS</span>; <span><span>//</span> may change during Connect to pre Yukon servers</span></td>
      </tr>
      <tr>
        <td id="L300" data-line-number="300"></td>
        <td id="LC300">            <span>_physicalStateObj</span> <span>=</span> <span>new</span> <span>TdsParserStateObject</span>(<span>this</span>);</td>
      </tr>
      <tr>
        <td id="L301" data-line-number="301"></td>
        <td id="LC301">            <span>DataClassificationVersion</span> <span>=</span> <span>TdsEnums</span>.<span>DATA_CLASSIFICATION_NOT_ENABLED</span>;</td>
      </tr>
      <tr>
        <td id="L302" data-line-number="302"></td>
        <td id="LC302">        }</td>
      </tr>
      <tr>
        <td id="L303" data-line-number="303"></td>
        <td id="LC303">
</td>
      </tr>
      <tr>
        <td id="L304" data-line-number="304"></td>
        <td id="LC304">        <span>internal</span> <span>SqlInternalConnectionTds</span> <span>Connection</span></td>
      </tr>
      <tr>
        <td id="L305" data-line-number="305"></td>
        <td id="LC305">        {</td>
      </tr>
      <tr>
        <td id="L306" data-line-number="306"></td>
        <td id="LC306">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L307" data-line-number="307"></td>
        <td id="LC307">            {</td>
      </tr>
      <tr>
        <td id="L308" data-line-number="308"></td>
        <td id="LC308">                <span>return</span> <span>_connHandler</span>;</td>
      </tr>
      <tr>
        <td id="L309" data-line-number="309"></td>
        <td id="LC309">            }</td>
      </tr>
      <tr>
        <td id="L310" data-line-number="310"></td>
        <td id="LC310">        }</td>
      </tr>
      <tr>
        <td id="L311" data-line-number="311"></td>
        <td id="LC311">
</td>
      </tr>
      <tr>
        <td id="L312" data-line-number="312"></td>
        <td id="LC312">        <span>internal</span> <span>SqlInternalTransaction</span> <span>CurrentTransaction</span></td>
      </tr>
      <tr>
        <td id="L313" data-line-number="313"></td>
        <td id="LC313">        {</td>
      </tr>
      <tr>
        <td id="L314" data-line-number="314"></td>
        <td id="LC314">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L315" data-line-number="315"></td>
        <td id="LC315">            {</td>
      </tr>
      <tr>
        <td id="L316" data-line-number="316"></td>
        <td id="LC316">                <span>return</span> <span>_currentTransaction</span>;</td>
      </tr>
      <tr>
        <td id="L317" data-line-number="317"></td>
        <td id="LC317">            }</td>
      </tr>
      <tr>
        <td id="L318" data-line-number="318"></td>
        <td id="LC318">            <span>set</span></td>
      </tr>
      <tr>
        <td id="L319" data-line-number="319"></td>
        <td id="LC319">            {</td>
      </tr>
      <tr>
        <td id="L320" data-line-number="320"></td>
        <td id="LC320">                <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>==</span> <span>_currentTransaction</span></td>
      </tr>
      <tr>
        <td id="L321" data-line-number="321"></td>
        <td id="LC321">                          <span>||</span> <span>null</span> <span>==</span> <span>_currentTransaction</span></td>
      </tr>
      <tr>
        <td id="L322" data-line-number="322"></td>
        <td id="LC322">                          <span>||</span> <span>null</span> <span>==</span> <span>value</span></td>
      </tr>
      <tr>
        <td id="L323" data-line-number="323"></td>
        <td id="LC323">                          <span>||</span> (<span>null</span> <span>!=</span> <span>_currentTransaction</span> <span>&amp;&amp;</span> <span>!</span><span>_currentTransaction</span>.<span>IsLocal</span>), <span><span>"</span>attempting to change current transaction?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L324" data-line-number="324"></td>
        <td id="LC324">
</td>
      </tr>
      <tr>
        <td id="L325" data-line-number="325"></td>
        <td id="LC325">                <span><span>//</span> If there is currently a transaction active, we don't want to</span></td>
      </tr>
      <tr>
        <td id="L326" data-line-number="326"></td>
        <td id="LC326">                <span><span>//</span> change it; this can occur when there is a delegated transaction</span></td>
      </tr>
      <tr>
        <td id="L327" data-line-number="327"></td>
        <td id="LC327">                <span><span>//</span> and the user attempts to do an API begin transaction; in these</span></td>
      </tr>
      <tr>
        <td id="L328" data-line-number="328"></td>
        <td id="LC328">                <span><span>//</span> cases, it's safe to ignore the set.</span></td>
      </tr>
      <tr>
        <td id="L329" data-line-number="329"></td>
        <td id="LC329">                <span>if</span> ((<span>null</span> <span>==</span> <span>_currentTransaction</span> <span>&amp;&amp;</span> <span>null</span> <span>!=</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L330" data-line-number="330"></td>
        <td id="LC330">                  <span>||</span> (<span>null</span> <span>!=</span> <span>_currentTransaction</span> <span>&amp;&amp;</span> <span>null</span> <span>==</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L331" data-line-number="331"></td>
        <td id="LC331">                {</td>
      </tr>
      <tr>
        <td id="L332" data-line-number="332"></td>
        <td id="LC332">                    <span>_currentTransaction</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L333" data-line-number="333"></td>
        <td id="LC333">                }</td>
      </tr>
      <tr>
        <td id="L334" data-line-number="334"></td>
        <td id="LC334">            }</td>
      </tr>
      <tr>
        <td id="L335" data-line-number="335"></td>
        <td id="LC335">        }</td>
      </tr>
      <tr>
        <td id="L336" data-line-number="336"></td>
        <td id="LC336">
</td>
      </tr>
      <tr>
        <td id="L337" data-line-number="337"></td>
        <td id="LC337">        <span>internal</span> <span>int</span> <span>DefaultLCID</span></td>
      </tr>
      <tr>
        <td id="L338" data-line-number="338"></td>
        <td id="LC338">        {</td>
      </tr>
      <tr>
        <td id="L339" data-line-number="339"></td>
        <td id="LC339">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L340" data-line-number="340"></td>
        <td id="LC340">            {</td>
      </tr>
      <tr>
        <td id="L341" data-line-number="341"></td>
        <td id="LC341">                <span>return</span> <span>_defaultLCID</span>;</td>
      </tr>
      <tr>
        <td id="L342" data-line-number="342"></td>
        <td id="LC342">            }</td>
      </tr>
      <tr>
        <td id="L343" data-line-number="343"></td>
        <td id="LC343">        }</td>
      </tr>
      <tr>
        <td id="L344" data-line-number="344"></td>
        <td id="LC344">
</td>
      </tr>
      <tr>
        <td id="L345" data-line-number="345"></td>
        <td id="LC345">        <span>internal</span> <span>EncryptionOptions</span> <span>EncryptionOptions</span></td>
      </tr>
      <tr>
        <td id="L346" data-line-number="346"></td>
        <td id="LC346">        {</td>
      </tr>
      <tr>
        <td id="L347" data-line-number="347"></td>
        <td id="LC347">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L348" data-line-number="348"></td>
        <td id="LC348">            {</td>
      </tr>
      <tr>
        <td id="L349" data-line-number="349"></td>
        <td id="LC349">                <span>return</span> <span>_encryptionOption</span>;</td>
      </tr>
      <tr>
        <td id="L350" data-line-number="350"></td>
        <td id="LC350">            }</td>
      </tr>
      <tr>
        <td id="L351" data-line-number="351"></td>
        <td id="LC351">            <span>set</span></td>
      </tr>
      <tr>
        <td id="L352" data-line-number="352"></td>
        <td id="LC352">            {</td>
      </tr>
      <tr>
        <td id="L353" data-line-number="353"></td>
        <td id="LC353">                <span>_encryptionOption</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L354" data-line-number="354"></td>
        <td id="LC354">            }</td>
      </tr>
      <tr>
        <td id="L355" data-line-number="355"></td>
        <td id="LC355">        }</td>
      </tr>
      <tr>
        <td id="L356" data-line-number="356"></td>
        <td id="LC356">
</td>
      </tr>
      <tr>
        <td id="L357" data-line-number="357"></td>
        <td id="LC357">        <span>internal</span> <span>bool</span> <span>IsYukonOrNewer</span></td>
      </tr>
      <tr>
        <td id="L358" data-line-number="358"></td>
        <td id="LC358">        {</td>
      </tr>
      <tr>
        <td id="L359" data-line-number="359"></td>
        <td id="LC359">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L360" data-line-number="360"></td>
        <td id="LC360">            {</td>
      </tr>
      <tr>
        <td id="L361" data-line-number="361"></td>
        <td id="LC361">                <span>return</span> <span>_isYukon</span>;</td>
      </tr>
      <tr>
        <td id="L362" data-line-number="362"></td>
        <td id="LC362">            }</td>
      </tr>
      <tr>
        <td id="L363" data-line-number="363"></td>
        <td id="LC363">        }</td>
      </tr>
      <tr>
        <td id="L364" data-line-number="364"></td>
        <td id="LC364">
</td>
      </tr>
      <tr>
        <td id="L365" data-line-number="365"></td>
        <td id="LC365">        <span>internal</span> <span>bool</span> <span>IsKatmaiOrNewer</span></td>
      </tr>
      <tr>
        <td id="L366" data-line-number="366"></td>
        <td id="LC366">        {</td>
      </tr>
      <tr>
        <td id="L367" data-line-number="367"></td>
        <td id="LC367">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L368" data-line-number="368"></td>
        <td id="LC368">            {</td>
      </tr>
      <tr>
        <td id="L369" data-line-number="369"></td>
        <td id="LC369">                <span>return</span> <span>_isKatmai</span>;</td>
      </tr>
      <tr>
        <td id="L370" data-line-number="370"></td>
        <td id="LC370">            }</td>
      </tr>
      <tr>
        <td id="L371" data-line-number="371"></td>
        <td id="LC371">        }</td>
      </tr>
      <tr>
        <td id="L372" data-line-number="372"></td>
        <td id="LC372">
</td>
      </tr>
      <tr>
        <td id="L373" data-line-number="373"></td>
        <td id="LC373">        <span>internal</span> <span>bool</span> <span>MARSOn</span></td>
      </tr>
      <tr>
        <td id="L374" data-line-number="374"></td>
        <td id="LC374">        {</td>
      </tr>
      <tr>
        <td id="L375" data-line-number="375"></td>
        <td id="LC375">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L376" data-line-number="376"></td>
        <td id="LC376">            {</td>
      </tr>
      <tr>
        <td id="L377" data-line-number="377"></td>
        <td id="LC377">                <span>return</span> <span>_fMARS</span>;</td>
      </tr>
      <tr>
        <td id="L378" data-line-number="378"></td>
        <td id="LC378">            }</td>
      </tr>
      <tr>
        <td id="L379" data-line-number="379"></td>
        <td id="LC379">        }</td>
      </tr>
      <tr>
        <td id="L380" data-line-number="380"></td>
        <td id="LC380">
</td>
      </tr>
      <tr>
        <td id="L381" data-line-number="381"></td>
        <td id="LC381">        <span>internal</span> <span>SqlInternalTransaction</span> <span>PendingTransaction</span></td>
      </tr>
      <tr>
        <td id="L382" data-line-number="382"></td>
        <td id="LC382">        {</td>
      </tr>
      <tr>
        <td id="L383" data-line-number="383"></td>
        <td id="LC383">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L384" data-line-number="384"></td>
        <td id="LC384">            {</td>
      </tr>
      <tr>
        <td id="L385" data-line-number="385"></td>
        <td id="LC385">                <span>return</span> <span>_pendingTransaction</span>;</td>
      </tr>
      <tr>
        <td id="L386" data-line-number="386"></td>
        <td id="LC386">            }</td>
      </tr>
      <tr>
        <td id="L387" data-line-number="387"></td>
        <td id="LC387">            <span>set</span></td>
      </tr>
      <tr>
        <td id="L388" data-line-number="388"></td>
        <td id="LC388">            {</td>
      </tr>
      <tr>
        <td id="L389" data-line-number="389"></td>
        <td id="LC389">                <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>!=</span> <span>value</span>, <span><span>"</span>setting a non-null PendingTransaction?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L390" data-line-number="390"></td>
        <td id="LC390">                <span>_pendingTransaction</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L391" data-line-number="391"></td>
        <td id="LC391">            }</td>
      </tr>
      <tr>
        <td id="L392" data-line-number="392"></td>
        <td id="LC392">        }</td>
      </tr>
      <tr>
        <td id="L393" data-line-number="393"></td>
        <td id="LC393">
</td>
      </tr>
      <tr>
        <td id="L394" data-line-number="394"></td>
        <td id="LC394">        <span>internal</span> <span>string</span> <span>Server</span></td>
      </tr>
      <tr>
        <td id="L395" data-line-number="395"></td>
        <td id="LC395">        {</td>
      </tr>
      <tr>
        <td id="L396" data-line-number="396"></td>
        <td id="LC396">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L397" data-line-number="397"></td>
        <td id="LC397">            {</td>
      </tr>
      <tr>
        <td id="L398" data-line-number="398"></td>
        <td id="LC398">                <span>return</span> <span>_server</span>;</td>
      </tr>
      <tr>
        <td id="L399" data-line-number="399"></td>
        <td id="LC399">            }</td>
      </tr>
      <tr>
        <td id="L400" data-line-number="400"></td>
        <td id="LC400">        }</td>
      </tr>
      <tr>
        <td id="L401" data-line-number="401"></td>
        <td id="LC401">
</td>
      </tr>
      <tr>
        <td id="L402" data-line-number="402"></td>
        <td id="LC402">        <span>internal</span> <span>TdsParserState</span> <span>State</span></td>
      </tr>
      <tr>
        <td id="L403" data-line-number="403"></td>
        <td id="LC403">        {</td>
      </tr>
      <tr>
        <td id="L404" data-line-number="404"></td>
        <td id="LC404">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L405" data-line-number="405"></td>
        <td id="LC405">            {</td>
      </tr>
      <tr>
        <td id="L406" data-line-number="406"></td>
        <td id="LC406">                <span>return</span> <span>_state</span>;</td>
      </tr>
      <tr>
        <td id="L407" data-line-number="407"></td>
        <td id="LC407">            }</td>
      </tr>
      <tr>
        <td id="L408" data-line-number="408"></td>
        <td id="LC408">            <span>set</span></td>
      </tr>
      <tr>
        <td id="L409" data-line-number="409"></td>
        <td id="LC409">            {</td>
      </tr>
      <tr>
        <td id="L410" data-line-number="410"></td>
        <td id="LC410">                <span>_state</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L411" data-line-number="411"></td>
        <td id="LC411">            }</td>
      </tr>
      <tr>
        <td id="L412" data-line-number="412"></td>
        <td id="LC412">        }</td>
      </tr>
      <tr>
        <td id="L413" data-line-number="413"></td>
        <td id="LC413">
</td>
      </tr>
      <tr>
        <td id="L414" data-line-number="414"></td>
        <td id="LC414">        <span>internal</span> <span>SqlStatistics</span> <span>Statistics</span></td>
      </tr>
      <tr>
        <td id="L415" data-line-number="415"></td>
        <td id="LC415">        {</td>
      </tr>
      <tr>
        <td id="L416" data-line-number="416"></td>
        <td id="LC416">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L417" data-line-number="417"></td>
        <td id="LC417">            {</td>
      </tr>
      <tr>
        <td id="L418" data-line-number="418"></td>
        <td id="LC418">                <span>return</span> <span>_statistics</span>;</td>
      </tr>
      <tr>
        <td id="L419" data-line-number="419"></td>
        <td id="LC419">            }</td>
      </tr>
      <tr>
        <td id="L420" data-line-number="420"></td>
        <td id="LC420">            <span>set</span></td>
      </tr>
      <tr>
        <td id="L421" data-line-number="421"></td>
        <td id="LC421">            {</td>
      </tr>
      <tr>
        <td id="L422" data-line-number="422"></td>
        <td id="LC422">                <span>_statistics</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L423" data-line-number="423"></td>
        <td id="LC423">            }</td>
      </tr>
      <tr>
        <td id="L424" data-line-number="424"></td>
        <td id="LC424">        }</td>
      </tr>
      <tr>
        <td id="L425" data-line-number="425"></td>
        <td id="LC425">
</td>
      </tr>
      <tr>
        <td id="L426" data-line-number="426"></td>
        <td id="LC426">        <span>private</span> <span>bool</span> <span>IncludeTraceHeader</span></td>
      </tr>
      <tr>
        <td id="L427" data-line-number="427"></td>
        <td id="LC427">        {</td>
      </tr>
      <tr>
        <td id="L428" data-line-number="428"></td>
        <td id="LC428">            <span>get</span></td>
      </tr>
      <tr>
        <td id="L429" data-line-number="429"></td>
        <td id="LC429">            {</td>
      </tr>
      <tr>
        <td id="L430" data-line-number="430"></td>
        <td id="LC430">                <span>return</span> (<span>_isDenali</span> <span>&amp;&amp;</span> <span>Bid</span>.<span>TraceOn</span> <span>&amp;&amp;</span> <span>Bid</span>.<span>IsOn</span>(<span>ActivityCorrelator</span>.<span>CorrelationTracePoints</span>));</td>
      </tr>
      <tr>
        <td id="L431" data-line-number="431"></td>
        <td id="LC431">            }</td>
      </tr>
      <tr>
        <td id="L432" data-line-number="432"></td>
        <td id="LC432">
</td>
      </tr>
      <tr>
        <td id="L433" data-line-number="433"></td>
        <td id="LC433">        }</td>
      </tr>
      <tr>
        <td id="L434" data-line-number="434"></td>
        <td id="LC434">
</td>
      </tr>
      <tr>
        <td id="L435" data-line-number="435"></td>
        <td id="LC435">
</td>
      </tr>
      <tr>
        <td id="L436" data-line-number="436"></td>
        <td id="LC436">        <span>internal</span> <span>int</span> <span>IncrementNonTransactedOpenResultCount</span>()</td>
      </tr>
      <tr>
        <td id="L437" data-line-number="437"></td>
        <td id="LC437">        {</td>
      </tr>
      <tr>
        <td id="L438" data-line-number="438"></td>
        <td id="LC438">            <span><span>//</span> IMPORTANT - this increments the connection wide open result count for all</span></td>
      </tr>
      <tr>
        <td id="L439" data-line-number="439"></td>
        <td id="LC439">            <span><span>//</span> operations not under a transaction!  Do not call if you intend to modify the</span></td>
      </tr>
      <tr>
        <td id="L440" data-line-number="440"></td>
        <td id="LC440">            <span><span>//</span> count for a transaction!</span></td>
      </tr>
      <tr>
        <td id="L441" data-line-number="441"></td>
        <td id="LC441">            <span>Debug</span>.<span>Assert</span>(<span>_nonTransactedOpenResultCount</span> <span>&gt;=</span> <span>0</span>, <span><span>"</span>Unexpected result count state<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L442" data-line-number="442"></td>
        <td id="LC442">            <span>int</span> <span>result</span> <span>=</span> <span>Interlocked</span>.<span>Increment</span>(<span>ref</span> <span>_nonTransactedOpenResultCount</span>);</td>
      </tr>
      <tr>
        <td id="L443" data-line-number="443"></td>
        <td id="LC443">            <span>return</span> <span>result</span>;</td>
      </tr>
      <tr>
        <td id="L444" data-line-number="444"></td>
        <td id="LC444">        }</td>
      </tr>
      <tr>
        <td id="L445" data-line-number="445"></td>
        <td id="LC445">
</td>
      </tr>
      <tr>
        <td id="L446" data-line-number="446"></td>
        <td id="LC446">        <span>internal</span> <span>void</span> <span>DecrementNonTransactedOpenResultCount</span>()</td>
      </tr>
      <tr>
        <td id="L447" data-line-number="447"></td>
        <td id="LC447">        {</td>
      </tr>
      <tr>
        <td id="L448" data-line-number="448"></td>
        <td id="LC448">            <span><span>//</span> IMPORTANT - this decrements the connection wide open result count for all</span></td>
      </tr>
      <tr>
        <td id="L449" data-line-number="449"></td>
        <td id="LC449">            <span><span>//</span> operations not under a transaction!  Do not call if you intend to modify the</span></td>
      </tr>
      <tr>
        <td id="L450" data-line-number="450"></td>
        <td id="LC450">            <span><span>//</span> count for a transaction!</span></td>
      </tr>
      <tr>
        <td id="L451" data-line-number="451"></td>
        <td id="LC451">            <span>Interlocked</span>.<span>Decrement</span>(<span>ref</span> <span>_nonTransactedOpenResultCount</span>);</td>
      </tr>
      <tr>
        <td id="L452" data-line-number="452"></td>
        <td id="LC452">            <span>Debug</span>.<span>Assert</span>(<span>_nonTransactedOpenResultCount</span> <span>&gt;=</span> <span>0</span>, <span><span>"</span>Unexpected result count state<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L453" data-line-number="453"></td>
        <td id="LC453">        }</td>
      </tr>
      <tr>
        <td id="L454" data-line-number="454"></td>
        <td id="LC454">
</td>
      </tr>
      <tr>
        <td id="L455" data-line-number="455"></td>
        <td id="LC455">        <span>internal</span> <span>void</span> <span>ProcessPendingAck</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L456" data-line-number="456"></td>
        <td id="LC456">        {</td>
      </tr>
      <tr>
        <td id="L457" data-line-number="457"></td>
        <td id="LC457">            <span>if</span> (<span>stateObj</span>.<span>_attentionSent</span>)</td>
      </tr>
      <tr>
        <td id="L458" data-line-number="458"></td>
        <td id="LC458">            {</td>
      </tr>
      <tr>
        <td id="L459" data-line-number="459"></td>
        <td id="LC459">                <span>ProcessAttention</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L460" data-line-number="460"></td>
        <td id="LC460">            }</td>
      </tr>
      <tr>
        <td id="L461" data-line-number="461"></td>
        <td id="LC461">        }</td>
      </tr>
      <tr>
        <td id="L462" data-line-number="462"></td>
        <td id="LC462">
</td>
      </tr>
      <tr>
        <td id="L463" data-line-number="463"></td>
        <td id="LC463">        <span>internal</span> <span>void</span> <span>Connect</span>(<span>ServerInfo</span> <span>serverInfo</span>,</td>
      </tr>
      <tr>
        <td id="L464" data-line-number="464"></td>
        <td id="LC464">                              <span>SqlInternalConnectionTds</span> <span>connHandler</span>,</td>
      </tr>
      <tr>
        <td id="L465" data-line-number="465"></td>
        <td id="LC465">                              <span>bool</span> <span>ignoreSniOpenTimeout</span>,</td>
      </tr>
      <tr>
        <td id="L466" data-line-number="466"></td>
        <td id="LC466">                              <span>long</span> <span>timerExpire</span>,</td>
      </tr>
      <tr>
        <td id="L467" data-line-number="467"></td>
        <td id="LC467">                              <span>bool</span> <span>encrypt</span>,</td>
      </tr>
      <tr>
        <td id="L468" data-line-number="468"></td>
        <td id="LC468">                              <span>bool</span> <span>trustServerCert</span>,</td>
      </tr>
      <tr>
        <td id="L469" data-line-number="469"></td>
        <td id="LC469">                              <span>bool</span> <span>integratedSecurity</span>,</td>
      </tr>
      <tr>
        <td id="L470" data-line-number="470"></td>
        <td id="LC470">                              <span>bool</span> <span>withFailover</span>,</td>
      </tr>
      <tr>
        <td id="L471" data-line-number="471"></td>
        <td id="LC471">                              <span>bool</span> <span>isFirstTransparentAttempt</span>,</td>
      </tr>
      <tr>
        <td id="L472" data-line-number="472"></td>
        <td id="LC472">                              <span>SqlAuthenticationMethod</span> <span>authType</span>,</td>
      </tr>
      <tr>
        <td id="L473" data-line-number="473"></td>
        <td id="LC473">                              <span>string</span> <span>certificate</span>,</td>
      </tr>
      <tr>
        <td id="L474" data-line-number="474"></td>
        <td id="LC474">                              <span>ServerCertificateValidationCallback</span> <span>serverCallback</span>,</td>
      </tr>
      <tr>
        <td id="L475" data-line-number="475"></td>
        <td id="LC475">                              <span>ClientCertificateRetrievalCallback</span> <span>clientCallback</span>,</td>
      </tr>
      <tr>
        <td id="L476" data-line-number="476"></td>
        <td id="LC476">                              <span>bool</span> <span>useOriginalAddressInfo</span>,</td>
      </tr>
      <tr>
        <td id="L477" data-line-number="477"></td>
        <td id="LC477">                              <span>bool</span> <span>disableTnir</span>,</td>
      </tr>
      <tr>
        <td id="L478" data-line-number="478"></td>
        <td id="LC478">                              <span>SqlAuthenticationProviderManager</span> <span>sqlAuthProviderManager</span>)</td>
      </tr>
      <tr>
        <td id="L479" data-line-number="479"></td>
        <td id="LC479">        {</td>
      </tr>
      <tr>
        <td id="L480" data-line-number="480"></td>
        <td id="LC480">            <span>if</span> (<span>_state</span> <span>!=</span> <span>TdsParserState</span>.<span>Closed</span>)</td>
      </tr>
      <tr>
        <td id="L481" data-line-number="481"></td>
        <td id="LC481">            {</td>
      </tr>
      <tr>
        <td id="L482" data-line-number="482"></td>
        <td id="LC482">                <span>Debug</span>.<span>Fail</span>(<span><span>"</span>TdsParser.Connect called on non-closed connection!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L483" data-line-number="483"></td>
        <td id="LC483">                <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L484" data-line-number="484"></td>
        <td id="LC484">            }</td>
      </tr>
      <tr>
        <td id="L485" data-line-number="485"></td>
        <td id="LC485">
</td>
      </tr>
      <tr>
        <td id="L486" data-line-number="486"></td>
        <td id="LC486">            <span>_connHandler</span> <span>=</span> <span>connHandler</span>;</td>
      </tr>
      <tr>
        <td id="L487" data-line-number="487"></td>
        <td id="LC487">            <span>_loginWithFailover</span> <span>=</span> <span>withFailover</span>;</td>
      </tr>
      <tr>
        <td id="L488" data-line-number="488"></td>
        <td id="LC488">
</td>
      </tr>
      <tr>
        <td id="L489" data-line-number="489"></td>
        <td id="LC489">            <span>UInt32</span> <span>sniStatus</span> <span>=</span> <span>SNILoadHandle</span>.<span>SingletonInstance</span>.<span>SNIStatus</span>;</td>
      </tr>
      <tr>
        <td id="L490" data-line-number="490"></td>
        <td id="LC490">            <span>if</span> (<span>sniStatus</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L491" data-line-number="491"></td>
        <td id="LC491">            {</td>
      </tr>
      <tr>
        <td id="L492" data-line-number="492"></td>
        <td id="LC492">                <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L493" data-line-number="493"></td>
        <td id="LC493">                <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L494" data-line-number="494"></td>
        <td id="LC494">                <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L495" data-line-number="495"></td>
        <td id="LC495">                <span>Debug</span>.<span>Fail</span>(<span><span>"</span>SNI returned status != success, but no error thrown?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L496" data-line-number="496"></td>
        <td id="LC496">            }</td>
      </tr>
      <tr>
        <td id="L497" data-line-number="497"></td>
        <td id="LC497">
</td>
      </tr>
      <tr>
        <td id="L498" data-line-number="498"></td>
        <td id="LC498">            <span><span>//</span>Create LocalDB instance if necessary</span></td>
      </tr>
      <tr>
        <td id="L499" data-line-number="499"></td>
        <td id="LC499">            <span>if</span> (<span>connHandler</span>.<span>ConnectionOptions</span>.<span>LocalDBInstance</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L500" data-line-number="500"></td>
        <td id="LC500">                <span>LocalDBAPI</span>.<span>CreateLocalDBInstance</span>(<span>connHandler</span>.<span>ConnectionOptions</span>.<span>LocalDBInstance</span>);</td>
      </tr>
      <tr>
        <td id="L501" data-line-number="501"></td>
        <td id="LC501">
</td>
      </tr>
      <tr>
        <td id="L502" data-line-number="502"></td>
        <td id="LC502">            <span>if</span> (<span>integratedSecurity</span> <span>||</span> <span>authType</span> <span>==</span> <span>SqlAuthenticationMethod</span>.<span>ActiveDirectoryIntegrated</span>)</td>
      </tr>
      <tr>
        <td id="L503" data-line-number="503"></td>
        <td id="LC503">            {</td>
      </tr>
      <tr>
        <td id="L504" data-line-number="504"></td>
        <td id="LC504">                <span>LoadSSPILibrary</span>();</td>
      </tr>
      <tr>
        <td id="L505" data-line-number="505"></td>
        <td id="LC505">                <span><span>//</span> now allocate proper length of buffer</span></td>
      </tr>
      <tr>
        <td id="L506" data-line-number="506"></td>
        <td id="LC506">                <span>_sniSpnBuffer</span> <span>=</span> <span>new</span> <span>byte</span>[<span>SNINativeMethodWrapper</span>.<span>SniMaxComposedSpnLength</span>];</td>
      </tr>
      <tr>
        <td id="L507" data-line-number="507"></td>
        <td id="LC507">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; SSPI or Active Directory Authentication Library for SQL Server based integrated authentication<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L508" data-line-number="508"></td>
        <td id="LC508">            }</td>
      </tr>
      <tr>
        <td id="L509" data-line-number="509"></td>
        <td id="LC509">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L510" data-line-number="510"></td>
        <td id="LC510">            {</td>
      </tr>
      <tr>
        <td id="L511" data-line-number="511"></td>
        <td id="LC511">                <span>_sniSpnBuffer</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L512" data-line-number="512"></td>
        <td id="LC512">                <span>if</span> (<span>authType</span> <span>==</span> <span>SqlAuthenticationMethod</span>.<span>ActiveDirectoryPassword</span>)</td>
      </tr>
      <tr>
        <td id="L513" data-line-number="513"></td>
        <td id="LC513">                {</td>
      </tr>
      <tr>
        <td id="L514" data-line-number="514"></td>
        <td id="LC514">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; Active Directory Password authentication<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L515" data-line-number="515"></td>
        <td id="LC515">                }</td>
      </tr>
      <tr>
        <td id="L516" data-line-number="516"></td>
        <td id="LC516">                <span>else</span> <span>if</span> (<span>authType</span> <span>==</span> <span>SqlAuthenticationMethod</span>.<span>SqlPassword</span>)</td>
      </tr>
      <tr>
        <td id="L517" data-line-number="517"></td>
        <td id="LC517">                {</td>
      </tr>
      <tr>
        <td id="L518" data-line-number="518"></td>
        <td id="LC518">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; SQL Password authentication<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L519" data-line-number="519"></td>
        <td id="LC519">                }</td>
      </tr>
      <tr>
        <td id="L520" data-line-number="520"></td>
        <td id="LC520">                <span>else</span> <span>if</span> (<span>authType</span> <span>==</span> <span>SqlAuthenticationMethod</span>.<span>ActiveDirectoryInteractive</span>)</td>
      </tr>
      <tr>
        <td id="L521" data-line-number="521"></td>
        <td id="LC521">                {</td>
      </tr>
      <tr>
        <td id="L522" data-line-number="522"></td>
        <td id="LC522">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; Active Directory Interactive authentication<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L523" data-line-number="523"></td>
        <td id="LC523">                }</td>
      </tr>
      <tr>
        <td id="L524" data-line-number="524"></td>
        <td id="LC524">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L525" data-line-number="525"></td>
        <td id="LC525">                {</td>
      </tr>
      <tr>
        <td id="L526" data-line-number="526"></td>
        <td id="LC526">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; SQL authentication<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L527" data-line-number="527"></td>
        <td id="LC527">                }</td>
      </tr>
      <tr>
        <td id="L528" data-line-number="528"></td>
        <td id="LC528">            }</td>
      </tr>
      <tr>
        <td id="L529" data-line-number="529"></td>
        <td id="LC529">
</td>
      </tr>
      <tr>
        <td id="L530" data-line-number="530"></td>
        <td id="LC530">            <span>byte</span>[] <span>instanceName</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L531" data-line-number="531"></td>
        <td id="LC531">
</td>
      </tr>
      <tr>
        <td id="L532" data-line-number="532"></td>
        <td id="LC532">            <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span> <span>!=</span> <span>null</span>, <span><span>"</span>SqlConnectionInternalTds handler can not be null at this point.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L533" data-line-number="533"></td>
        <td id="LC533">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>EndPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>PreLoginBegin</span>);</td>
      </tr>
      <tr>
        <td id="L534" data-line-number="534"></td>
        <td id="LC534">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>SetAndBeginPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>InitializeConnection</span>);</td>
      </tr>
      <tr>
        <td id="L535" data-line-number="535"></td>
        <td id="LC535">
</td>
      </tr>
      <tr>
        <td id="L536" data-line-number="536"></td>
        <td id="LC536">            <span>bool</span> <span>fParallel</span> <span>=</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>MultiSubnetFailover</span>;</td>
      </tr>
      <tr>
        <td id="L537" data-line-number="537"></td>
        <td id="LC537">
</td>
      </tr>
      <tr>
        <td id="L538" data-line-number="538"></td>
        <td id="LC538">            <span>TransparentNetworkResolutionState</span> <span>transparentNetworkResolutionState</span>;</td>
      </tr>
      <tr>
        <td id="L539" data-line-number="539"></td>
        <td id="LC539">            <span>if</span> (<span>_connHandler</span>.<span>ConnectionOptions</span>.<span>TransparentNetworkIPResolution</span> <span>&amp;&amp;</span> <span>!</span><span>disableTnir</span>)</td>
      </tr>
      <tr>
        <td id="L540" data-line-number="540"></td>
        <td id="LC540">            {</td>
      </tr>
      <tr>
        <td id="L541" data-line-number="541"></td>
        <td id="LC541">                <span>if</span> (<span>isFirstTransparentAttempt</span>)</td>
      </tr>
      <tr>
        <td id="L542" data-line-number="542"></td>
        <td id="LC542">                    <span>transparentNetworkResolutionState</span> <span>=</span> <span>TransparentNetworkResolutionState</span>.<span>SequentialMode</span>;</td>
      </tr>
      <tr>
        <td id="L543" data-line-number="543"></td>
        <td id="LC543">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L544" data-line-number="544"></td>
        <td id="LC544">                    <span>transparentNetworkResolutionState</span> <span>=</span> <span>TransparentNetworkResolutionState</span>.<span>ParallelMode</span>;</td>
      </tr>
      <tr>
        <td id="L545" data-line-number="545"></td>
        <td id="LC545">            }</td>
      </tr>
      <tr>
        <td id="L546" data-line-number="546"></td>
        <td id="LC546">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L547" data-line-number="547"></td>
        <td id="LC547">                <span>transparentNetworkResolutionState</span> <span>=</span> <span>TransparentNetworkResolutionState</span>.<span>DisabledMode</span>;</td>
      </tr>
      <tr>
        <td id="L548" data-line-number="548"></td>
        <td id="LC548">
</td>
      </tr>
      <tr>
        <td id="L549" data-line-number="549"></td>
        <td id="LC549">            <span>int</span> <span>totalTimeout</span> <span>=</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>ConnectTimeout</span>;</td>
      </tr>
      <tr>
        <td id="L550" data-line-number="550"></td>
        <td id="LC550">
</td>
      </tr>
      <tr>
        <td id="L551" data-line-number="551"></td>
        <td id="LC551">            <span>_physicalStateObj</span>.<span>CreatePhysicalSNIHandle</span>(<span>serverInfo</span>.<span>ExtendedServerName</span>, <span>ignoreSniOpenTimeout</span>, <span>timerExpire</span>,</td>
      </tr>
      <tr>
        <td id="L552" data-line-number="552"></td>
        <td id="LC552">                        <span>out</span> <span>instanceName</span>, <span>_sniSpnBuffer</span>, <span>false</span>, <span>true</span>, <span>fParallel</span>, <span>transparentNetworkResolutionState</span>, <span>totalTimeout</span>);</td>
      </tr>
      <tr>
        <td id="L553" data-line-number="553"></td>
        <td id="LC553">
</td>
      </tr>
      <tr>
        <td id="L554" data-line-number="554"></td>
        <td id="LC554">            <span>if</span> (<span>TdsEnums</span>.<span>SNI_SUCCESS</span> <span>!=</span> <span>_physicalStateObj</span>.<span>Status</span>)</td>
      </tr>
      <tr>
        <td id="L555" data-line-number="555"></td>
        <td id="LC555">            {</td>
      </tr>
      <tr>
        <td id="L556" data-line-number="556"></td>
        <td id="LC556">                <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L557" data-line-number="557"></td>
        <td id="LC557">
</td>
      </tr>
      <tr>
        <td id="L558" data-line-number="558"></td>
        <td id="LC558">                <span><span>//</span> Since connect failed, free the unmanaged connection memory.</span></td>
      </tr>
      <tr>
        <td id="L559" data-line-number="559"></td>
        <td id="LC559">                <span><span>//</span> HOWEVER - only free this after the netlib error was processed - if you</span></td>
      </tr>
      <tr>
        <td id="L560" data-line-number="560"></td>
        <td id="LC560">                <span><span>//</span> don't, the memory for the connection object might not be accurate and thus</span></td>
      </tr>
      <tr>
        <td id="L561" data-line-number="561"></td>
        <td id="LC561">                <span><span>//</span> a bad error could be returned (as it was when it was freed to early for me).</span></td>
      </tr>
      <tr>
        <td id="L562" data-line-number="562"></td>
        <td id="LC562">                <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L563" data-line-number="563"></td>
        <td id="LC563">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|ERR|SEC&gt; Login failure<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L564" data-line-number="564"></td>
        <td id="LC564">                <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L565" data-line-number="565"></td>
        <td id="LC565">                <span>Debug</span>.<span>Fail</span>(<span><span>"</span>SNI returned status != success, but no error thrown?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L566" data-line-number="566"></td>
        <td id="LC566">            }</td>
      </tr>
      <tr>
        <td id="L567" data-line-number="567"></td>
        <td id="LC567">
</td>
      </tr>
      <tr>
        <td id="L568" data-line-number="568"></td>
        <td id="LC568">            <span>_server</span> <span>=</span> <span>serverInfo</span>.<span>ResolvedServerName</span>;</td>
      </tr>
      <tr>
        <td id="L569" data-line-number="569"></td>
        <td id="LC569">
</td>
      </tr>
      <tr>
        <td id="L570" data-line-number="570"></td>
        <td id="LC570">            <span>if</span> (<span>null</span> <span>!=</span> <span>connHandler</span>.<span>PoolGroupProviderInfo</span>)</td>
      </tr>
      <tr>
        <td id="L571" data-line-number="571"></td>
        <td id="LC571">            {</td>
      </tr>
      <tr>
        <td id="L572" data-line-number="572"></td>
        <td id="LC572">                <span><span>//</span> If we are pooling, check to see if we were processing an</span></td>
      </tr>
      <tr>
        <td id="L573" data-line-number="573"></td>
        <td id="LC573">                <span><span>//</span> alias which has changed, which means we need to clean out</span></td>
      </tr>
      <tr>
        <td id="L574" data-line-number="574"></td>
        <td id="LC574">                <span><span>//</span> the pool. See Webdata 104293.</span></td>
      </tr>
      <tr>
        <td id="L575" data-line-number="575"></td>
        <td id="LC575">                <span><span>//</span> This should not apply to routing, as it is not an alias change, routed connection</span></td>
      </tr>
      <tr>
        <td id="L576" data-line-number="576"></td>
        <td id="LC576">                <span><span>//</span> should still use VNN of AlwaysOn cluster as server for pooling purposes.</span></td>
      </tr>
      <tr>
        <td id="L577" data-line-number="577"></td>
        <td id="LC577">                <span>connHandler</span>.<span>PoolGroupProviderInfo</span>.<span>AliasCheck</span>(<span>serverInfo</span>.<span>PreRoutingServerName</span> <span>==</span> <span>null</span> <span>?</span></td>
      </tr>
      <tr>
        <td id="L578" data-line-number="578"></td>
        <td id="LC578">                    <span>serverInfo</span>.<span>ResolvedServerName</span> <span>:</span> <span>serverInfo</span>.<span>PreRoutingServerName</span>);</td>
      </tr>
      <tr>
        <td id="L579" data-line-number="579"></td>
        <td id="LC579">            }</td>
      </tr>
      <tr>
        <td id="L580" data-line-number="580"></td>
        <td id="LC580">            <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span>;</td>
      </tr>
      <tr>
        <td id="L581" data-line-number="581"></td>
        <td id="LC581">            <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_PreLoginBeforeSuccessfullWrite</span>; <span><span>//</span> SQL BU DT 376766</span></td>
      </tr>
      <tr>
        <td id="L582" data-line-number="582"></td>
        <td id="LC582">            <span>_physicalStateObj</span>.<span>TimeoutTime</span> <span>=</span> <span>timerExpire</span>;</td>
      </tr>
      <tr>
        <td id="L583" data-line-number="583"></td>
        <td id="LC583">
</td>
      </tr>
      <tr>
        <td id="L584" data-line-number="584"></td>
        <td id="LC584">            <span>bool</span> <span>marsCapable</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L585" data-line-number="585"></td>
        <td id="LC585">
</td>
      </tr>
      <tr>
        <td id="L586" data-line-number="586"></td>
        <td id="LC586">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>EndPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>InitializeConnection</span>);</td>
      </tr>
      <tr>
        <td id="L587" data-line-number="587"></td>
        <td id="LC587">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>SetAndBeginPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>SendPreLoginHandshake</span>);</td>
      </tr>
      <tr>
        <td id="L588" data-line-number="588"></td>
        <td id="LC588">
</td>
      </tr>
      <tr>
        <td id="L589" data-line-number="589"></td>
        <td id="LC589">            <span>UInt32</span> <span>result</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SniGetConnectionId</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>ref</span> <span>_connHandler</span>.<span>_clientConnectionId</span>);</td>
      </tr>
      <tr>
        <td id="L590" data-line-number="590"></td>
        <td id="LC590">            <span>Debug</span>.<span>Assert</span>(<span>result</span> <span>==</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>, <span><span>"</span>Unexpected failure state upon calling SniGetConnectionId<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L591" data-line-number="591"></td>
        <td id="LC591">
</td>
      </tr>
      <tr>
        <td id="L592" data-line-number="592"></td>
        <td id="LC592">            <span><span>//</span> UNDONE - send "" for instance now, need to fix later</span></td>
      </tr>
      <tr>
        <td id="L593" data-line-number="593"></td>
        <td id="LC593">            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; Sending prelogin handshake<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L594" data-line-number="594"></td>
        <td id="LC594">            <span>SendPreLoginHandshake</span>(<span>instanceName</span>, <span>encrypt</span>, <span>!</span><span>string</span>.<span>IsNullOrEmpty</span>(<span>certificate</span>), <span>useOriginalAddressInfo</span>);</td>
      </tr>
      <tr>
        <td id="L595" data-line-number="595"></td>
        <td id="LC595">
</td>
      </tr>
      <tr>
        <td id="L596" data-line-number="596"></td>
        <td id="LC596">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>EndPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>SendPreLoginHandshake</span>);</td>
      </tr>
      <tr>
        <td id="L597" data-line-number="597"></td>
        <td id="LC597">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>SetAndBeginPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>ConsumePreLoginHandshake</span>);</td>
      </tr>
      <tr>
        <td id="L598" data-line-number="598"></td>
        <td id="LC598">
</td>
      </tr>
      <tr>
        <td id="L599" data-line-number="599"></td>
        <td id="LC599">            <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_PreLogin</span>;</td>
      </tr>
      <tr>
        <td id="L600" data-line-number="600"></td>
        <td id="LC600">
</td>
      </tr>
      <tr>
        <td id="L601" data-line-number="601"></td>
        <td id="LC601">            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; Consuming prelogin handshake<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L602" data-line-number="602"></td>
        <td id="LC602">            <span>PreLoginHandshakeStatus</span> <span>status</span> <span>=</span> <span>ConsumePreLoginHandshake</span>(<span>authType</span>, <span>encrypt</span>, <span>trustServerCert</span>, <span>integratedSecurity</span>, <span>serverCallback</span>, <span>clientCallback</span>,</td>
      </tr>
      <tr>
        <td id="L603" data-line-number="603"></td>
        <td id="LC603">                                                                      <span>out</span> <span>marsCapable</span>, <span>out</span> <span>_connHandler</span>.<span>_fedAuthRequired</span>);</td>
      </tr>
      <tr>
        <td id="L604" data-line-number="604"></td>
        <td id="LC604">
</td>
      </tr>
      <tr>
        <td id="L605" data-line-number="605"></td>
        <td id="LC605">            <span>if</span> (<span>status</span> <span>==</span> <span>PreLoginHandshakeStatus</span>.<span>InstanceFailure</span>)</td>
      </tr>
      <tr>
        <td id="L606" data-line-number="606"></td>
        <td id="LC606">            {</td>
      </tr>
      <tr>
        <td id="L607" data-line-number="607"></td>
        <td id="LC607">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; Prelogin handshake unsuccessful. Reattempting prelogin handshake<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L608" data-line-number="608"></td>
        <td id="LC608">                <span>_physicalStateObj</span>.<span>Dispose</span>(); <span><span>//</span> Close previous connection</span></td>
      </tr>
      <tr>
        <td id="L609" data-line-number="609"></td>
        <td id="LC609">
</td>
      </tr>
      <tr>
        <td id="L610" data-line-number="610"></td>
        <td id="LC610">                <span><span>//</span> On Instance failure re-connect and flush SNI named instance cache.</span></td>
      </tr>
      <tr>
        <td id="L611" data-line-number="611"></td>
        <td id="LC611">                <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Connect</span>;</td>
      </tr>
      <tr>
        <td id="L612" data-line-number="612"></td>
        <td id="LC612">                <span>_physicalStateObj</span>.<span>CreatePhysicalSNIHandle</span>(<span>serverInfo</span>.<span>ExtendedServerName</span>, <span>ignoreSniOpenTimeout</span>, <span>timerExpire</span>, <span>out</span> <span>instanceName</span>, <span>_sniSpnBuffer</span>, <span>true</span>, <span>true</span>, <span>fParallel</span>, <span>transparentNetworkResolutionState</span>, <span>totalTimeout</span>);</td>
      </tr>
      <tr>
        <td id="L613" data-line-number="613"></td>
        <td id="LC613">
</td>
      </tr>
      <tr>
        <td id="L614" data-line-number="614"></td>
        <td id="LC614">                <span>if</span> (<span>TdsEnums</span>.<span>SNI_SUCCESS</span> <span>!=</span> <span>_physicalStateObj</span>.<span>Status</span>)</td>
      </tr>
      <tr>
        <td id="L615" data-line-number="615"></td>
        <td id="LC615">                {</td>
      </tr>
      <tr>
        <td id="L616" data-line-number="616"></td>
        <td id="LC616">                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L617" data-line-number="617"></td>
        <td id="LC617">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|ERR|SEC&gt; Login failure<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L618" data-line-number="618"></td>
        <td id="LC618">                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L619" data-line-number="619"></td>
        <td id="LC619">                }</td>
      </tr>
      <tr>
        <td id="L620" data-line-number="620"></td>
        <td id="LC620">
</td>
      </tr>
      <tr>
        <td id="L621" data-line-number="621"></td>
        <td id="LC621">                <span>UInt32</span> <span>retCode</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SniGetConnectionId</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>ref</span> <span>_connHandler</span>.<span>_clientConnectionId</span>);</td>
      </tr>
      <tr>
        <td id="L622" data-line-number="622"></td>
        <td id="LC622">                <span>Debug</span>.<span>Assert</span>(<span>retCode</span> <span>==</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>, <span><span>"</span>Unexpected failure state upon calling SniGetConnectionId<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L623" data-line-number="623"></td>
        <td id="LC623">
</td>
      </tr>
      <tr>
        <td id="L624" data-line-number="624"></td>
        <td id="LC624">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; Sending prelogin handshake<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L625" data-line-number="625"></td>
        <td id="LC625">                <span>SendPreLoginHandshake</span>(<span>instanceName</span>, <span>encrypt</span>, <span>!</span><span>string</span>.<span>IsNullOrEmpty</span>(<span>certificate</span>), <span>useOriginalAddressInfo</span>);</td>
      </tr>
      <tr>
        <td id="L626" data-line-number="626"></td>
        <td id="LC626">                <span>status</span> <span>=</span> <span>ConsumePreLoginHandshake</span>(<span>authType</span>, <span>encrypt</span>, <span>trustServerCert</span>, <span>integratedSecurity</span>, <span>serverCallback</span>, <span>clientCallback</span>, <span>out</span> <span>marsCapable</span>,</td>
      </tr>
      <tr>
        <td id="L627" data-line-number="627"></td>
        <td id="LC627">                                                  <span>out</span> <span>_connHandler</span>.<span>_fedAuthRequired</span>);</td>
      </tr>
      <tr>
        <td id="L628" data-line-number="628"></td>
        <td id="LC628">
</td>
      </tr>
      <tr>
        <td id="L629" data-line-number="629"></td>
        <td id="LC629">                <span><span>//</span> Don't need to check for Sphinx failure, since we've already consumed</span></td>
      </tr>
      <tr>
        <td id="L630" data-line-number="630"></td>
        <td id="LC630">                <span><span>//</span> one pre-login packet and know we are connecting to Shiloh.</span></td>
      </tr>
      <tr>
        <td id="L631" data-line-number="631"></td>
        <td id="LC631">                <span>if</span> (<span>status</span> <span>==</span> <span>PreLoginHandshakeStatus</span>.<span>InstanceFailure</span>)</td>
      </tr>
      <tr>
        <td id="L632" data-line-number="632"></td>
        <td id="LC632">                {</td>
      </tr>
      <tr>
        <td id="L633" data-line-number="633"></td>
        <td id="LC633">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|ERR|SEC&gt; Prelogin handshake unsuccessful. Login failure<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L634" data-line-number="634"></td>
        <td id="LC634">                    <span>throw</span> <span>SQL</span>.<span>InstanceFailure</span>();</td>
      </tr>
      <tr>
        <td id="L635" data-line-number="635"></td>
        <td id="LC635">                }</td>
      </tr>
      <tr>
        <td id="L636" data-line-number="636"></td>
        <td id="LC636">            }</td>
      </tr>
      <tr>
        <td id="L637" data-line-number="637"></td>
        <td id="LC637">            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Connect|SEC&gt; Prelogin handshake successful<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L638" data-line-number="638"></td>
        <td id="LC638">
</td>
      </tr>
      <tr>
        <td id="L639" data-line-number="639"></td>
        <td id="LC639">            <span>if</span> (<span>_fMARS</span> <span>&amp;&amp;</span> <span>marsCapable</span>)</td>
      </tr>
      <tr>
        <td id="L640" data-line-number="640"></td>
        <td id="LC640">            {</td>
      </tr>
      <tr>
        <td id="L641" data-line-number="641"></td>
        <td id="LC641">                <span><span>//</span> if user explictly disables mars or mars not supported, don't create the session pool</span></td>
      </tr>
      <tr>
        <td id="L642" data-line-number="642"></td>
        <td id="LC642">                <span>_sessionPool</span> <span>=</span> <span>new</span> <span>TdsParserSessionPool</span>(<span>this</span>);</td>
      </tr>
      <tr>
        <td id="L643" data-line-number="643"></td>
        <td id="LC643">            }</td>
      </tr>
      <tr>
        <td id="L644" data-line-number="644"></td>
        <td id="LC644">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L645" data-line-number="645"></td>
        <td id="LC645">            {</td>
      </tr>
      <tr>
        <td id="L646" data-line-number="646"></td>
        <td id="LC646">                <span>_fMARS</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L647" data-line-number="647"></td>
        <td id="LC647">            }</td>
      </tr>
      <tr>
        <td id="L648" data-line-number="648"></td>
        <td id="LC648">
</td>
      </tr>
      <tr>
        <td id="L649" data-line-number="649"></td>
        <td id="LC649">            <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L650" data-line-number="650"></td>
        <td id="LC650">        }</td>
      </tr>
      <tr>
        <td id="L651" data-line-number="651"></td>
        <td id="LC651">
</td>
      </tr>
      <tr>
        <td id="L652" data-line-number="652"></td>
        <td id="LC652">        <span>internal</span> <span>void</span> <span>RemoveEncryption</span>()</td>
      </tr>
      <tr>
        <td id="L653" data-line-number="653"></td>
        <td id="LC653">        {</td>
      </tr>
      <tr>
        <td id="L654" data-line-number="654"></td>
        <td id="LC654">            <span>Debug</span>.<span>Assert</span>((<span>_encryptionOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>) <span>==</span> <span>EncryptionOptions</span>.<span>LOGIN</span>, <span><span>"</span>Invalid encryption option state<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L655" data-line-number="655"></td>
        <td id="LC655">
</td>
      </tr>
      <tr>
        <td id="L656" data-line-number="656"></td>
        <td id="LC656">            <span>UInt32</span> <span>error</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L657" data-line-number="657"></td>
        <td id="LC657">
</td>
      </tr>
      <tr>
        <td id="L658" data-line-number="658"></td>
        <td id="LC658">            <span><span>//</span> Remove SSL (Encryption) SNI provider since we only wanted to encrypt login.</span></td>
      </tr>
      <tr>
        <td id="L659" data-line-number="659"></td>
        <td id="LC659">            <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNIRemoveProvider</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>SNINativeMethodWrapper</span>.<span>ProviderEnum</span>.<span>SSL_PROV</span>);</td>
      </tr>
      <tr>
        <td id="L660" data-line-number="660"></td>
        <td id="LC660">            <span>if</span> (<span>error</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L661" data-line-number="661"></td>
        <td id="LC661">            {</td>
      </tr>
      <tr>
        <td id="L662" data-line-number="662"></td>
        <td id="LC662">                <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L663" data-line-number="663"></td>
        <td id="LC663">                <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L664" data-line-number="664"></td>
        <td id="LC664">            }</td>
      </tr>
      <tr>
        <td id="L665" data-line-number="665"></td>
        <td id="LC665">            <span><span>//</span> create a new packet encryption changes the internal packet size Bug# 228403</span></td>
      </tr>
      <tr>
        <td id="L666" data-line-number="666"></td>
        <td id="LC666">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L667" data-line-number="667"></td>
        <td id="LC667">            { }   <span><span>//</span> EmptyTry/Finally to avoid FXCop violation</span></td>
      </tr>
      <tr>
        <td id="L668" data-line-number="668"></td>
        <td id="LC668">            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L669" data-line-number="669"></td>
        <td id="LC669">            {</td>
      </tr>
      <tr>
        <td id="L670" data-line-number="670"></td>
        <td id="LC670">                <span>_physicalStateObj</span>.<span>ClearAllWritePackets</span>();</td>
      </tr>
      <tr>
        <td id="L671" data-line-number="671"></td>
        <td id="LC671">            }</td>
      </tr>
      <tr>
        <td id="L672" data-line-number="672"></td>
        <td id="LC672">        }</td>
      </tr>
      <tr>
        <td id="L673" data-line-number="673"></td>
        <td id="LC673">
</td>
      </tr>
      <tr>
        <td id="L674" data-line-number="674"></td>
        <td id="LC674">        <span>internal</span> <span>void</span> <span>EnableMars</span>()</td>
      </tr>
      <tr>
        <td id="L675" data-line-number="675"></td>
        <td id="LC675">        {</td>
      </tr>
      <tr>
        <td id="L676" data-line-number="676"></td>
        <td id="LC676">            <span>if</span> (<span>_fMARS</span>)</td>
      </tr>
      <tr>
        <td id="L677" data-line-number="677"></td>
        <td id="LC677">            {</td>
      </tr>
      <tr>
        <td id="L678" data-line-number="678"></td>
        <td id="LC678">                <span><span>//</span> Cache physical stateObj and connection.</span></td>
      </tr>
      <tr>
        <td id="L679" data-line-number="679"></td>
        <td id="LC679">                <span>_pMarsPhysicalConObj</span> <span>=</span> <span>_physicalStateObj</span>;</td>
      </tr>
      <tr>
        <td id="L680" data-line-number="680"></td>
        <td id="LC680">
</td>
      </tr>
      <tr>
        <td id="L681" data-line-number="681"></td>
        <td id="LC681">                <span>UInt32</span> <span>error</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L682" data-line-number="682"></td>
        <td id="LC682">                <span>UInt32</span> <span>info</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L683" data-line-number="683"></td>
        <td id="LC683">
</td>
      </tr>
      <tr>
        <td id="L684" data-line-number="684"></td>
        <td id="LC684">                <span><span>//</span> Add SMUX (MARS) SNI provider.</span></td>
      </tr>
      <tr>
        <td id="L685" data-line-number="685"></td>
        <td id="LC685">                <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNIAddProvider</span>(<span>_pMarsPhysicalConObj</span>.<span>Handle</span>, <span>SNINativeMethodWrapper</span>.<span>ProviderEnum</span>.<span>SMUX_PROV</span>, <span>ref</span> <span>info</span>);</td>
      </tr>
      <tr>
        <td id="L686" data-line-number="686"></td>
        <td id="LC686">
</td>
      </tr>
      <tr>
        <td id="L687" data-line-number="687"></td>
        <td id="LC687">                <span>if</span> (<span>error</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L688" data-line-number="688"></td>
        <td id="LC688">                {</td>
      </tr>
      <tr>
        <td id="L689" data-line-number="689"></td>
        <td id="LC689">                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L690" data-line-number="690"></td>
        <td id="LC690">                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L691" data-line-number="691"></td>
        <td id="LC691">                }</td>
      </tr>
      <tr>
        <td id="L692" data-line-number="692"></td>
        <td id="LC692">
</td>
      </tr>
      <tr>
        <td id="L693" data-line-number="693"></td>
        <td id="LC693">                <span><span>//</span> HACK HACK HACK - for Async only</span></td>
      </tr>
      <tr>
        <td id="L694" data-line-number="694"></td>
        <td id="LC694">                <span><span>//</span> Have to post read to intialize MARS - will get callback on this when connection goes</span></td>
      </tr>
      <tr>
        <td id="L695" data-line-number="695"></td>
        <td id="LC695">                <span><span>//</span> down or is closed.</span></td>
      </tr>
      <tr>
        <td id="L696" data-line-number="696"></td>
        <td id="LC696">
</td>
      </tr>
      <tr>
        <td id="L697" data-line-number="697"></td>
        <td id="LC697">                <span>IntPtr</span> <span>temp</span> <span>=</span> <span>IntPtr</span>.<span>Zero</span>;</td>
      </tr>
      <tr>
        <td id="L698" data-line-number="698"></td>
        <td id="LC698">
</td>
      </tr>
      <tr>
        <td id="L699" data-line-number="699"></td>
        <td id="LC699">                <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L700" data-line-number="700"></td>
        <td id="LC700">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L701" data-line-number="701"></td>
        <td id="LC701">                { }</td>
      </tr>
      <tr>
        <td id="L702" data-line-number="702"></td>
        <td id="LC702">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L703" data-line-number="703"></td>
        <td id="LC703">                {</td>
      </tr>
      <tr>
        <td id="L704" data-line-number="704"></td>
        <td id="LC704">                    <span>_pMarsPhysicalConObj</span>.<span>IncrementPendingCallbacks</span>();</td>
      </tr>
      <tr>
        <td id="L705" data-line-number="705"></td>
        <td id="LC705">
</td>
      </tr>
      <tr>
        <td id="L706" data-line-number="706"></td>
        <td id="LC706">                    <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNIReadAsync</span>(<span>_pMarsPhysicalConObj</span>.<span>Handle</span>, <span>ref</span> <span>temp</span>);</td>
      </tr>
      <tr>
        <td id="L707" data-line-number="707"></td>
        <td id="LC707">
</td>
      </tr>
      <tr>
        <td id="L708" data-line-number="708"></td>
        <td id="LC708">                    <span>if</span> (<span>temp</span> <span>!=</span> <span>IntPtr</span>.<span>Zero</span>)</td>
      </tr>
      <tr>
        <td id="L709" data-line-number="709"></td>
        <td id="LC709">                    {</td>
      </tr>
      <tr>
        <td id="L710" data-line-number="710"></td>
        <td id="LC710">                        <span><span>//</span> Be sure to release packet, otherwise it will be leaked by native.</span></td>
      </tr>
      <tr>
        <td id="L711" data-line-number="711"></td>
        <td id="LC711">                        <span>SNINativeMethodWrapper</span>.<span>SNIPacketRelease</span>(<span>temp</span>);</td>
      </tr>
      <tr>
        <td id="L712" data-line-number="712"></td>
        <td id="LC712">                    }</td>
      </tr>
      <tr>
        <td id="L713" data-line-number="713"></td>
        <td id="LC713">                }</td>
      </tr>
      <tr>
        <td id="L714" data-line-number="714"></td>
        <td id="LC714">                <span>Debug</span>.<span>Assert</span>(<span>IntPtr</span>.<span>Zero</span> <span>==</span> <span>temp</span>, <span><span>"</span>unexpected syncReadPacket without corresponding SNIPacketRelease<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L715" data-line-number="715"></td>
        <td id="LC715">                <span>if</span> (<span>TdsEnums</span>.<span>SNI_SUCCESS_IO_PENDING</span> <span>!=</span> <span>error</span>)</td>
      </tr>
      <tr>
        <td id="L716" data-line-number="716"></td>
        <td id="LC716">                {</td>
      </tr>
      <tr>
        <td id="L717" data-line-number="717"></td>
        <td id="LC717">                    <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>SNI_SUCCESS</span> <span>!=</span> <span>error</span>, <span><span>"</span>Unexpected successfull read async on physical connection before enabling MARS!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L718" data-line-number="718"></td>
        <td id="LC718">                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L719" data-line-number="719"></td>
        <td id="LC719">                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L720" data-line-number="720"></td>
        <td id="LC720">                }</td>
      </tr>
      <tr>
        <td id="L721" data-line-number="721"></td>
        <td id="LC721">
</td>
      </tr>
      <tr>
        <td id="L722" data-line-number="722"></td>
        <td id="LC722">                <span>_physicalStateObj</span> <span>=</span> <span>CreateSession</span>(); <span><span>//</span> Create and open default MARS stateObj and connection.</span></td>
      </tr>
      <tr>
        <td id="L723" data-line-number="723"></td>
        <td id="LC723">            }</td>
      </tr>
      <tr>
        <td id="L724" data-line-number="724"></td>
        <td id="LC724">        }</td>
      </tr>
      <tr>
        <td id="L725" data-line-number="725"></td>
        <td id="LC725">
</td>
      </tr>
      <tr>
        <td id="L726" data-line-number="726"></td>
        <td id="LC726">        <span>internal</span> <span>TdsParserStateObject</span> <span>CreateSession</span>()</td>
      </tr>
      <tr>
        <td id="L727" data-line-number="727"></td>
        <td id="LC727">        {</td>
      </tr>
      <tr>
        <td id="L728" data-line-number="728"></td>
        <td id="LC728">            <span>TdsParserStateObject</span> <span>session</span> <span>=</span> <span>new</span> <span>TdsParserStateObject</span>(<span>this</span>, (<span>SNIHandle</span>)<span>_pMarsPhysicalConObj</span>.<span>Handle</span>, <span>true</span>);</td>
      </tr>
      <tr>
        <td id="L729" data-line-number="729"></td>
        <td id="LC729">            <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L730" data-line-number="730"></td>
        <td id="LC730">            {</td>
      </tr>
      <tr>
        <td id="L731" data-line-number="731"></td>
        <td id="LC731">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.CreateSession|ADV&gt; %d# created session %d<span>\n</span><span>"</span></span>, <span>ObjectID</span>, <span>session</span>.<span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L732" data-line-number="732"></td>
        <td id="LC732">            }</td>
      </tr>
      <tr>
        <td id="L733" data-line-number="733"></td>
        <td id="LC733">            <span>return</span> <span>session</span>;</td>
      </tr>
      <tr>
        <td id="L734" data-line-number="734"></td>
        <td id="LC734">        }</td>
      </tr>
      <tr>
        <td id="L735" data-line-number="735"></td>
        <td id="LC735">
</td>
      </tr>
      <tr>
        <td id="L736" data-line-number="736"></td>
        <td id="LC736">        <span>internal</span> <span>TdsParserStateObject</span> <span>GetSession</span>(<span>object</span> <span>owner</span>)</td>
      </tr>
      <tr>
        <td id="L737" data-line-number="737"></td>
        <td id="LC737">        {</td>
      </tr>
      <tr>
        <td id="L738" data-line-number="738"></td>
        <td id="LC738">            <span>TdsParserStateObject</span> <span>session</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L739" data-line-number="739"></td>
        <td id="LC739">
</td>
      </tr>
      <tr>
        <td id="L740" data-line-number="740"></td>
        <td id="LC740">            <span><span>//</span> TODO: Ideally, we would not care what we do here -- the session pooler would know whether it should have either one (non-MARS) or many (MARS) sessions.</span></td>
      </tr>
      <tr>
        <td id="L741" data-line-number="741"></td>
        <td id="LC741">
</td>
      </tr>
      <tr>
        <td id="L742" data-line-number="742"></td>
        <td id="LC742">            <span>if</span> (<span>MARSOn</span>)</td>
      </tr>
      <tr>
        <td id="L743" data-line-number="743"></td>
        <td id="LC743">            {</td>
      </tr>
      <tr>
        <td id="L744" data-line-number="744"></td>
        <td id="LC744">                <span>session</span> <span>=</span> <span>_sessionPool</span>.<span>GetSession</span>(<span>owner</span>);</td>
      </tr>
      <tr>
        <td id="L745" data-line-number="745"></td>
        <td id="LC745">
</td>
      </tr>
      <tr>
        <td id="L746" data-line-number="746"></td>
        <td id="LC746">                <span>Debug</span>.<span>Assert</span>(<span>!</span><span>session</span>.<span>_pendingData</span>, <span><span>"</span>pending data on a pooled MARS session<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L747" data-line-number="747"></td>
        <td id="LC747">                <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L748" data-line-number="748"></td>
        <td id="LC748">                {</td>
      </tr>
      <tr>
        <td id="L749" data-line-number="749"></td>
        <td id="LC749">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.GetSession|ADV&gt; %d# getting session %d from pool<span>\n</span><span>"</span></span>, <span>ObjectID</span>, <span>session</span>.<span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L750" data-line-number="750"></td>
        <td id="LC750">                }</td>
      </tr>
      <tr>
        <td id="L751" data-line-number="751"></td>
        <td id="LC751">            }</td>
      </tr>
      <tr>
        <td id="L752" data-line-number="752"></td>
        <td id="LC752">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L753" data-line-number="753"></td>
        <td id="LC753">            {</td>
      </tr>
      <tr>
        <td id="L754" data-line-number="754"></td>
        <td id="LC754">                <span>session</span> <span>=</span> <span>_physicalStateObj</span>;</td>
      </tr>
      <tr>
        <td id="L755" data-line-number="755"></td>
        <td id="LC755">                <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L756" data-line-number="756"></td>
        <td id="LC756">                {</td>
      </tr>
      <tr>
        <td id="L757" data-line-number="757"></td>
        <td id="LC757">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.GetSession|ADV&gt; %d# getting physical session %d<span>\n</span><span>"</span></span>, <span>ObjectID</span>, <span>session</span>.<span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L758" data-line-number="758"></td>
        <td id="LC758">                }</td>
      </tr>
      <tr>
        <td id="L759" data-line-number="759"></td>
        <td id="LC759">            }</td>
      </tr>
      <tr>
        <td id="L760" data-line-number="760"></td>
        <td id="LC760">            <span>Debug</span>.<span>Assert</span>(<span>session</span>.<span>_outputPacketNumber</span> <span>==</span> <span>1</span>, <span><span>"</span>The packet number is expected to be 1<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L761" data-line-number="761"></td>
        <td id="LC761">            <span>return</span> <span>session</span>;</td>
      </tr>
      <tr>
        <td id="L762" data-line-number="762"></td>
        <td id="LC762">        }</td>
      </tr>
      <tr>
        <td id="L763" data-line-number="763"></td>
        <td id="LC763">
</td>
      </tr>
      <tr>
        <td id="L764" data-line-number="764"></td>
        <td id="LC764">        <span>internal</span> <span>void</span> <span>PutSession</span>(<span>TdsParserStateObject</span> <span>session</span>)</td>
      </tr>
      <tr>
        <td id="L765" data-line-number="765"></td>
        <td id="LC765">        {</td>
      </tr>
      <tr>
        <td id="L766" data-line-number="766"></td>
        <td id="LC766">            <span>session</span>.<span>AssertStateIsClean</span>();</td>
      </tr>
      <tr>
        <td id="L767" data-line-number="767"></td>
        <td id="LC767">
</td>
      </tr>
      <tr>
        <td id="L768" data-line-number="768"></td>
        <td id="LC768">            <span>if</span> (<span>MARSOn</span>)</td>
      </tr>
      <tr>
        <td id="L769" data-line-number="769"></td>
        <td id="LC769">            {</td>
      </tr>
      <tr>
        <td id="L770" data-line-number="770"></td>
        <td id="LC770">                <span><span>//</span> This will take care of disposing if the parser is closed</span></td>
      </tr>
      <tr>
        <td id="L771" data-line-number="771"></td>
        <td id="LC771">                <span>_sessionPool</span>.<span>PutSession</span>(<span>session</span>);</td>
      </tr>
      <tr>
        <td id="L772" data-line-number="772"></td>
        <td id="LC772">            }</td>
      </tr>
      <tr>
        <td id="L773" data-line-number="773"></td>
        <td id="LC773">            <span>else</span> <span>if</span> ((<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Closed</span>) <span>||</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Broken</span>))</td>
      </tr>
      <tr>
        <td id="L774" data-line-number="774"></td>
        <td id="LC774">            {</td>
      </tr>
      <tr>
        <td id="L775" data-line-number="775"></td>
        <td id="LC775">                <span><span>//</span> Parser is closed\broken - dispose the stateObj</span></td>
      </tr>
      <tr>
        <td id="L776" data-line-number="776"></td>
        <td id="LC776">                <span>Debug</span>.<span>Assert</span>(<span>session</span> <span>==</span> <span>_physicalStateObj</span>, <span><span>"</span>MARS is off, but session to close is not the _physicalStateObj<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L777" data-line-number="777"></td>
        <td id="LC777">                <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Close</span>;</td>
      </tr>
      <tr>
        <td id="L778" data-line-number="778"></td>
        <td id="LC778">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L779" data-line-number="779"></td>
        <td id="LC779">                <span>_physicalStateObj</span>.<span>InvalidateDebugOnlyCopyOfSniContext</span>();</td>
      </tr>
      <tr>
        <td id="L780" data-line-number="780"></td>
        <td id="LC780">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L781" data-line-number="781"></td>
        <td id="LC781">                <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L782" data-line-number="782"></td>
        <td id="LC782">            }</td>
      </tr>
      <tr>
        <td id="L783" data-line-number="783"></td>
        <td id="LC783">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L784" data-line-number="784"></td>
        <td id="LC784">            {</td>
      </tr>
      <tr>
        <td id="L785" data-line-number="785"></td>
        <td id="LC785">                <span><span>//</span> Non-MARS, and session is ok - remove its owner</span></td>
      </tr>
      <tr>
        <td id="L786" data-line-number="786"></td>
        <td id="LC786">                <span>_physicalStateObj</span>.<span>Owner</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L787" data-line-number="787"></td>
        <td id="LC787">            }</td>
      </tr>
      <tr>
        <td id="L788" data-line-number="788"></td>
        <td id="LC788">        }</td>
      </tr>
      <tr>
        <td id="L789" data-line-number="789"></td>
        <td id="LC789">
</td>
      </tr>
      <tr>
        <td id="L790" data-line-number="790"></td>
        <td id="LC790">        <span><span>//</span> This is called from a ThreadAbort - ensure that it can be run from a CER Catch</span></td>
      </tr>
      <tr>
        <td id="L791" data-line-number="791"></td>
        <td id="LC791">        <span>internal</span> <span>void</span> <span>BestEffortCleanup</span>()</td>
      </tr>
      <tr>
        <td id="L792" data-line-number="792"></td>
        <td id="LC792">        {</td>
      </tr>
      <tr>
        <td id="L793" data-line-number="793"></td>
        <td id="LC793">            <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>Broken</span>;</td>
      </tr>
      <tr>
        <td id="L794" data-line-number="794"></td>
        <td id="LC794">
</td>
      </tr>
      <tr>
        <td id="L795" data-line-number="795"></td>
        <td id="LC795">            <span>var</span> <span>stateObj</span> <span>=</span> <span>_physicalStateObj</span>;</td>
      </tr>
      <tr>
        <td id="L796" data-line-number="796"></td>
        <td id="LC796">            <span>if</span> (<span>stateObj</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L797" data-line-number="797"></td>
        <td id="LC797">            {</td>
      </tr>
      <tr>
        <td id="L798" data-line-number="798"></td>
        <td id="LC798">                <span>var</span> <span>stateObjHandle</span> <span>=</span> <span>stateObj</span>.<span>Handle</span>;</td>
      </tr>
      <tr>
        <td id="L799" data-line-number="799"></td>
        <td id="LC799">                <span>if</span> (<span>stateObjHandle</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L800" data-line-number="800"></td>
        <td id="LC800">                {</td>
      </tr>
      <tr>
        <td id="L801" data-line-number="801"></td>
        <td id="LC801">                    <span>stateObjHandle</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L802" data-line-number="802"></td>
        <td id="LC802">                }</td>
      </tr>
      <tr>
        <td id="L803" data-line-number="803"></td>
        <td id="LC803">            }</td>
      </tr>
      <tr>
        <td id="L804" data-line-number="804"></td>
        <td id="LC804">
</td>
      </tr>
      <tr>
        <td id="L805" data-line-number="805"></td>
        <td id="LC805">            <span>if</span> (<span>_fMARS</span>)</td>
      </tr>
      <tr>
        <td id="L806" data-line-number="806"></td>
        <td id="LC806">            {</td>
      </tr>
      <tr>
        <td id="L807" data-line-number="807"></td>
        <td id="LC807">                <span>var</span> <span>sessionPool</span> <span>=</span> <span>_sessionPool</span>;</td>
      </tr>
      <tr>
        <td id="L808" data-line-number="808"></td>
        <td id="LC808">                <span>if</span> (<span>sessionPool</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L809" data-line-number="809"></td>
        <td id="LC809">                {</td>
      </tr>
      <tr>
        <td id="L810" data-line-number="810"></td>
        <td id="LC810">                    <span>sessionPool</span>.<span>BestEffortCleanup</span>();</td>
      </tr>
      <tr>
        <td id="L811" data-line-number="811"></td>
        <td id="LC811">                }</td>
      </tr>
      <tr>
        <td id="L812" data-line-number="812"></td>
        <td id="LC812">
</td>
      </tr>
      <tr>
        <td id="L813" data-line-number="813"></td>
        <td id="LC813">                <span>var</span> <span>marsStateObj</span> <span>=</span> <span>_pMarsPhysicalConObj</span>;</td>
      </tr>
      <tr>
        <td id="L814" data-line-number="814"></td>
        <td id="LC814">                <span>if</span> (<span>marsStateObj</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L815" data-line-number="815"></td>
        <td id="LC815">                {</td>
      </tr>
      <tr>
        <td id="L816" data-line-number="816"></td>
        <td id="LC816">                    <span>var</span> <span>marsStateObjHandle</span> <span>=</span> <span>marsStateObj</span>.<span>Handle</span>;</td>
      </tr>
      <tr>
        <td id="L817" data-line-number="817"></td>
        <td id="LC817">                    <span>if</span> (<span>marsStateObjHandle</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L818" data-line-number="818"></td>
        <td id="LC818">                    {</td>
      </tr>
      <tr>
        <td id="L819" data-line-number="819"></td>
        <td id="LC819">                        <span>marsStateObjHandle</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L820" data-line-number="820"></td>
        <td id="LC820">                    }</td>
      </tr>
      <tr>
        <td id="L821" data-line-number="821"></td>
        <td id="LC821">                }</td>
      </tr>
      <tr>
        <td id="L822" data-line-number="822"></td>
        <td id="LC822">            }</td>
      </tr>
      <tr>
        <td id="L823" data-line-number="823"></td>
        <td id="LC823">        }</td>
      </tr>
      <tr>
        <td id="L824" data-line-number="824"></td>
        <td id="LC824">
</td>
      </tr>
      <tr>
        <td id="L825" data-line-number="825"></td>
        <td id="LC825">        <span>private</span> <span>void</span> <span>SendPreLoginHandshake</span>(<span>byte</span>[] <span>instanceName</span>, <span>bool</span> <span>encrypt</span>, <span>bool</span> <span>clientCertificate</span>, <span>bool</span> <span>useCtaip</span>)</td>
      </tr>
      <tr>
        <td id="L826" data-line-number="826"></td>
        <td id="LC826">        {</td>
      </tr>
      <tr>
        <td id="L827" data-line-number="827"></td>
        <td id="LC827">            <span><span>//</span> PreLoginHandshake buffer consists of:</span></td>
      </tr>
      <tr>
        <td id="L828" data-line-number="828"></td>
        <td id="LC828">            <span><span>//</span> 1) Standard header, with type = MT_PRELOGIN</span></td>
      </tr>
      <tr>
        <td id="L829" data-line-number="829"></td>
        <td id="LC829">            <span><span>//</span> 2) Consecutive 5 bytes for each option, (1 byte length, 2 byte offset, 2 byte payload length)</span></td>
      </tr>
      <tr>
        <td id="L830" data-line-number="830"></td>
        <td id="LC830">            <span><span>//</span> 3) Consecutive data blocks for each option</span></td>
      </tr>
      <tr>
        <td id="L831" data-line-number="831"></td>
        <td id="LC831">
</td>
      </tr>
      <tr>
        <td id="L832" data-line-number="832"></td>
        <td id="LC832">            <span><span>//</span> NOTE: packet data needs to be big endian - not the standard little endian used by</span></td>
      </tr>
      <tr>
        <td id="L833" data-line-number="833"></td>
        <td id="LC833">            <span><span>//</span> the rest of the parser.</span></td>
      </tr>
      <tr>
        <td id="L834" data-line-number="834"></td>
        <td id="LC834">
</td>
      </tr>
      <tr>
        <td id="L835" data-line-number="835"></td>
        <td id="LC835">            <span>_physicalStateObj</span>.<span>_outputMessageType</span> <span>=</span> <span>TdsEnums</span>.<span>MT_PRELOGIN</span>;</td>
      </tr>
      <tr>
        <td id="L836" data-line-number="836"></td>
        <td id="LC836">
</td>
      </tr>
      <tr>
        <td id="L837" data-line-number="837"></td>
        <td id="LC837">            <span><span>//</span> Initialize option offset into payload buffer</span></td>
      </tr>
      <tr>
        <td id="L838" data-line-number="838"></td>
        <td id="LC838">            <span><span>//</span> 5 bytes for each option (1 byte length, 2 byte offset, 2 byte payload length)</span></td>
      </tr>
      <tr>
        <td id="L839" data-line-number="839"></td>
        <td id="LC839">            <span>int</span> <span>offset</span> <span>=</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>NUMOPT</span> <span>*</span> <span>5</span> <span>+</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L840" data-line-number="840"></td>
        <td id="LC840">
</td>
      </tr>
      <tr>
        <td id="L841" data-line-number="841"></td>
        <td id="LC841">            <span>byte</span>[] <span>payload</span> <span>=</span> <span>new</span> <span>byte</span>[(<span>int</span>)<span>PreLoginOptions</span>.<span>NUMOPT</span> <span>*</span> <span>5</span> <span>+</span> <span>TdsEnums</span>.<span>MAX_PRELOGIN_PAYLOAD_LENGTH</span>];</td>
      </tr>
      <tr>
        <td id="L842" data-line-number="842"></td>
        <td id="LC842">            <span>int</span> <span>payloadLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L843" data-line-number="843"></td>
        <td id="LC843">
</td>
      </tr>
      <tr>
        <td id="L844" data-line-number="844"></td>
        <td id="LC844">            <span><span>//</span> UNDONE - need to do some length verification to ensure packet does not</span></td>
      </tr>
      <tr>
        <td id="L845" data-line-number="845"></td>
        <td id="LC845">            <span><span>//</span> get too big!!!  Not beyond it's max length!</span></td>
      </tr>
      <tr>
        <td id="L846" data-line-number="846"></td>
        <td id="LC846">
</td>
      </tr>
      <tr>
        <td id="L847" data-line-number="847"></td>
        <td id="LC847">            <span>for</span> (<span>int</span> <span>option</span> <span>=</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>VERSION</span>; <span>option</span> <span>&lt;</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>NUMOPT</span>; <span>option</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L848" data-line-number="848"></td>
        <td id="LC848">            {</td>
      </tr>
      <tr>
        <td id="L849" data-line-number="849"></td>
        <td id="LC849">                <span>int</span> <span>optionDataSize</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L850" data-line-number="850"></td>
        <td id="LC850">
</td>
      </tr>
      <tr>
        <td id="L851" data-line-number="851"></td>
        <td id="LC851">                <span><span>//</span> Fill in the option</span></td>
      </tr>
      <tr>
        <td id="L852" data-line-number="852"></td>
        <td id="LC852">                <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>option</span>);</td>
      </tr>
      <tr>
        <td id="L853" data-line-number="853"></td>
        <td id="LC853">
</td>
      </tr>
      <tr>
        <td id="L854" data-line-number="854"></td>
        <td id="LC854">                <span><span>//</span> Fill in the offset of the option data</span></td>
      </tr>
      <tr>
        <td id="L855" data-line-number="855"></td>
        <td id="LC855">                <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>offset</span> <span>&amp;</span> <span>0xff00</span>) <span>&gt;&gt;</span> <span>8</span>)); <span><span>//</span> send upper order byte</span></td>
      </tr>
      <tr>
        <td id="L856" data-line-number="856"></td>
        <td id="LC856">                <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>offset</span> <span>&amp;</span> <span>0x00ff</span>)); <span><span>//</span> send lower order byte</span></td>
      </tr>
      <tr>
        <td id="L857" data-line-number="857"></td>
        <td id="LC857">
</td>
      </tr>
      <tr>
        <td id="L858" data-line-number="858"></td>
        <td id="LC858">                <span>switch</span> (<span>option</span>)</td>
      </tr>
      <tr>
        <td id="L859" data-line-number="859"></td>
        <td id="LC859">                {</td>
      </tr>
      <tr>
        <td id="L860" data-line-number="860"></td>
        <td id="LC860">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>VERSION</span>:</td>
      </tr>
      <tr>
        <td id="L861" data-line-number="861"></td>
        <td id="LC861">                        <span>Version</span> <span>systemDataVersion</span> <span>=</span> <span>ADP</span>.<span>GetAssemblyVersion</span>();</td>
      </tr>
      <tr>
        <td id="L862" data-line-number="862"></td>
        <td id="LC862">
</td>
      </tr>
      <tr>
        <td id="L863" data-line-number="863"></td>
        <td id="LC863">                        <span><span>//</span> Major and minor</span></td>
      </tr>
      <tr>
        <td id="L864" data-line-number="864"></td>
        <td id="LC864">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>systemDataVersion</span>.<span>Major</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L865" data-line-number="865"></td>
        <td id="LC865">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>systemDataVersion</span>.<span>Minor</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L866" data-line-number="866"></td>
        <td id="LC866">
</td>
      </tr>
      <tr>
        <td id="L867" data-line-number="867"></td>
        <td id="LC867">                        <span><span>//</span> Build (Big Endian)</span></td>
      </tr>
      <tr>
        <td id="L868" data-line-number="868"></td>
        <td id="LC868">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>systemDataVersion</span>.<span>Build</span> <span>&amp;</span> <span>0xff00</span>) <span>&gt;&gt;</span> <span>8</span>);</td>
      </tr>
      <tr>
        <td id="L869" data-line-number="869"></td>
        <td id="LC869">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>systemDataVersion</span>.<span>Build</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L870" data-line-number="870"></td>
        <td id="LC870">
</td>
      </tr>
      <tr>
        <td id="L871" data-line-number="871"></td>
        <td id="LC871">                        <span><span>//</span> Sub-build (Little Endian)</span></td>
      </tr>
      <tr>
        <td id="L872" data-line-number="872"></td>
        <td id="LC872">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>systemDataVersion</span>.<span>Revision</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L873" data-line-number="873"></td>
        <td id="LC873">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>systemDataVersion</span>.<span>Revision</span> <span>&amp;</span> <span>0xff00</span>) <span>&gt;&gt;</span> <span>8</span>);</td>
      </tr>
      <tr>
        <td id="L874" data-line-number="874"></td>
        <td id="LC874">                        <span>offset</span> <span>+=</span> <span>6</span>;</td>
      </tr>
      <tr>
        <td id="L875" data-line-number="875"></td>
        <td id="LC875">                        <span>optionDataSize</span> <span>=</span> <span>6</span>;</td>
      </tr>
      <tr>
        <td id="L876" data-line-number="876"></td>
        <td id="LC876">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L877" data-line-number="877"></td>
        <td id="LC877">
</td>
      </tr>
      <tr>
        <td id="L878" data-line-number="878"></td>
        <td id="LC878">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>ENCRYPT</span>:</td>
      </tr>
      <tr>
        <td id="L879" data-line-number="879"></td>
        <td id="LC879">                        <span>if</span> (<span>_encryptionOption</span> <span>==</span> <span>EncryptionOptions</span>.<span>NOT_SUP</span>)</td>
      </tr>
      <tr>
        <td id="L880" data-line-number="880"></td>
        <td id="LC880">                        {</td>
      </tr>
      <tr>
        <td id="L881" data-line-number="881"></td>
        <td id="LC881">                            <span><span>//</span> If OS doesn't support encryption, inform server not supported.</span></td>
      </tr>
      <tr>
        <td id="L882" data-line-number="882"></td>
        <td id="LC882">                            <span>payload</span>[<span>payloadLength</span>] <span>=</span> (<span>byte</span>)<span>EncryptionOptions</span>.<span>NOT_SUP</span>;</td>
      </tr>
      <tr>
        <td id="L883" data-line-number="883"></td>
        <td id="LC883">                        }</td>
      </tr>
      <tr>
        <td id="L884" data-line-number="884"></td>
        <td id="LC884">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L885" data-line-number="885"></td>
        <td id="LC885">                        {</td>
      </tr>
      <tr>
        <td id="L886" data-line-number="886"></td>
        <td id="LC886">                            <span><span>//</span> Else, inform server of user request.</span></td>
      </tr>
      <tr>
        <td id="L887" data-line-number="887"></td>
        <td id="LC887">                            <span>if</span> (<span>encrypt</span>)</td>
      </tr>
      <tr>
        <td id="L888" data-line-number="888"></td>
        <td id="LC888">                            {</td>
      </tr>
      <tr>
        <td id="L889" data-line-number="889"></td>
        <td id="LC889">                                <span>payload</span>[<span>payloadLength</span>] <span>=</span> (<span>byte</span>)<span>EncryptionOptions</span>.<span>ON</span>;</td>
      </tr>
      <tr>
        <td id="L890" data-line-number="890"></td>
        <td id="LC890">                                <span>_encryptionOption</span> <span>=</span> <span>EncryptionOptions</span>.<span>ON</span>;</td>
      </tr>
      <tr>
        <td id="L891" data-line-number="891"></td>
        <td id="LC891">                            }</td>
      </tr>
      <tr>
        <td id="L892" data-line-number="892"></td>
        <td id="LC892">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L893" data-line-number="893"></td>
        <td id="LC893">                            {</td>
      </tr>
      <tr>
        <td id="L894" data-line-number="894"></td>
        <td id="LC894">                                <span>payload</span>[<span>payloadLength</span>] <span>=</span> (<span>byte</span>)<span>EncryptionOptions</span>.<span>OFF</span>;</td>
      </tr>
      <tr>
        <td id="L895" data-line-number="895"></td>
        <td id="LC895">                                <span>_encryptionOption</span> <span>=</span> <span>EncryptionOptions</span>.<span>OFF</span>;</td>
      </tr>
      <tr>
        <td id="L896" data-line-number="896"></td>
        <td id="LC896">                            }</td>
      </tr>
      <tr>
        <td id="L897" data-line-number="897"></td>
        <td id="LC897">
</td>
      </tr>
      <tr>
        <td id="L898" data-line-number="898"></td>
        <td id="LC898">                            <span><span>//</span> Inform server of user request.</span></td>
      </tr>
      <tr>
        <td id="L899" data-line-number="899"></td>
        <td id="LC899">                            <span>if</span> (<span>clientCertificate</span>)</td>
      </tr>
      <tr>
        <td id="L900" data-line-number="900"></td>
        <td id="LC900">                            {</td>
      </tr>
      <tr>
        <td id="L901" data-line-number="901"></td>
        <td id="LC901">                                <span>payload</span>[<span>payloadLength</span>] <span>|=</span> (<span>byte</span>)<span>EncryptionOptions</span>.<span>CLIENT_CERT</span>;</td>
      </tr>
      <tr>
        <td id="L902" data-line-number="902"></td>
        <td id="LC902">                                <span>_encryptionOption</span> <span>|=</span> <span>EncryptionOptions</span>.<span>CLIENT_CERT</span>;</td>
      </tr>
      <tr>
        <td id="L903" data-line-number="903"></td>
        <td id="LC903">                            }</td>
      </tr>
      <tr>
        <td id="L904" data-line-number="904"></td>
        <td id="LC904">                        }</td>
      </tr>
      <tr>
        <td id="L905" data-line-number="905"></td>
        <td id="LC905">
</td>
      </tr>
      <tr>
        <td id="L906" data-line-number="906"></td>
        <td id="LC906">                        <span><span>//</span> Add CTAIP if requested.</span></td>
      </tr>
      <tr>
        <td id="L907" data-line-number="907"></td>
        <td id="LC907">                        <span>if</span> (<span>useCtaip</span>)</td>
      </tr>
      <tr>
        <td id="L908" data-line-number="908"></td>
        <td id="LC908">                        {</td>
      </tr>
      <tr>
        <td id="L909" data-line-number="909"></td>
        <td id="LC909">                            <span>payload</span>[<span>payloadLength</span>] <span>|=</span> (<span>byte</span>)<span>EncryptionOptions</span>.<span>CTAIP</span>;</td>
      </tr>
      <tr>
        <td id="L910" data-line-number="910"></td>
        <td id="LC910">                            <span>_encryptionOption</span> <span>|=</span> <span>EncryptionOptions</span>.<span>CTAIP</span>;</td>
      </tr>
      <tr>
        <td id="L911" data-line-number="911"></td>
        <td id="LC911">                        }</td>
      </tr>
      <tr>
        <td id="L912" data-line-number="912"></td>
        <td id="LC912">
</td>
      </tr>
      <tr>
        <td id="L913" data-line-number="913"></td>
        <td id="LC913">                        <span>payloadLength</span> <span>+=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L914" data-line-number="914"></td>
        <td id="LC914">                        <span>offset</span> <span>+=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L915" data-line-number="915"></td>
        <td id="LC915">                        <span>optionDataSize</span> <span>=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L916" data-line-number="916"></td>
        <td id="LC916">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L917" data-line-number="917"></td>
        <td id="LC917">
</td>
      </tr>
      <tr>
        <td id="L918" data-line-number="918"></td>
        <td id="LC918">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>INSTANCE</span>:</td>
      </tr>
      <tr>
        <td id="L919" data-line-number="919"></td>
        <td id="LC919">                        <span>int</span> <span>i</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L920" data-line-number="920"></td>
        <td id="LC920">
</td>
      </tr>
      <tr>
        <td id="L921" data-line-number="921"></td>
        <td id="LC921">                        <span>while</span> (<span>instanceName</span>[<span>i</span>] <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L922" data-line-number="922"></td>
        <td id="LC922">                        {</td>
      </tr>
      <tr>
        <td id="L923" data-line-number="923"></td>
        <td id="LC923">                            <span>payload</span>[<span>payloadLength</span>] <span>=</span> <span>instanceName</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L924" data-line-number="924"></td>
        <td id="LC924">                            <span>payloadLength</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L925" data-line-number="925"></td>
        <td id="LC925">                            <span>i</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L926" data-line-number="926"></td>
        <td id="LC926">                        }</td>
      </tr>
      <tr>
        <td id="L927" data-line-number="927"></td>
        <td id="LC927">
</td>
      </tr>
      <tr>
        <td id="L928" data-line-number="928"></td>
        <td id="LC928">                        <span>payload</span>[<span>payloadLength</span>] <span>=</span> <span>0</span>; <span><span>//</span> null terminate</span></td>
      </tr>
      <tr>
        <td id="L929" data-line-number="929"></td>
        <td id="LC929">                        <span>payloadLength</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L930" data-line-number="930"></td>
        <td id="LC930">                        <span>i</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L931" data-line-number="931"></td>
        <td id="LC931">
</td>
      </tr>
      <tr>
        <td id="L932" data-line-number="932"></td>
        <td id="LC932">                        <span>offset</span> <span>+=</span> <span>i</span>;</td>
      </tr>
      <tr>
        <td id="L933" data-line-number="933"></td>
        <td id="LC933">                        <span>optionDataSize</span> <span>=</span> <span>i</span>;</td>
      </tr>
      <tr>
        <td id="L934" data-line-number="934"></td>
        <td id="LC934">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L935" data-line-number="935"></td>
        <td id="LC935">
</td>
      </tr>
      <tr>
        <td id="L936" data-line-number="936"></td>
        <td id="LC936">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>THREADID</span>:</td>
      </tr>
      <tr>
        <td id="L937" data-line-number="937"></td>
        <td id="LC937">                        <span>Int32</span> <span>threadID</span> <span>=</span> <span>TdsParserStaticMethods</span>.<span>GetCurrentThreadIdForTdsLoginOnly</span>();</td>
      </tr>
      <tr>
        <td id="L938" data-line-number="938"></td>
        <td id="LC938">
</td>
      </tr>
      <tr>
        <td id="L939" data-line-number="939"></td>
        <td id="LC939">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>0xff000000</span> <span>&amp;</span> <span>threadID</span>) <span>&gt;&gt;</span> <span>24</span>);</td>
      </tr>
      <tr>
        <td id="L940" data-line-number="940"></td>
        <td id="LC940">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>0x00ff0000</span> <span>&amp;</span> <span>threadID</span>) <span>&gt;&gt;</span> <span>16</span>);</td>
      </tr>
      <tr>
        <td id="L941" data-line-number="941"></td>
        <td id="LC941">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>0x0000ff00</span> <span>&amp;</span> <span>threadID</span>) <span>&gt;&gt;</span> <span>8</span>);</td>
      </tr>
      <tr>
        <td id="L942" data-line-number="942"></td>
        <td id="LC942">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>0x000000ff</span> <span>&amp;</span> <span>threadID</span>);</td>
      </tr>
      <tr>
        <td id="L943" data-line-number="943"></td>
        <td id="LC943">                        <span>offset</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L944" data-line-number="944"></td>
        <td id="LC944">                        <span>optionDataSize</span> <span>=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L945" data-line-number="945"></td>
        <td id="LC945">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L946" data-line-number="946"></td>
        <td id="LC946">
</td>
      </tr>
      <tr>
        <td id="L947" data-line-number="947"></td>
        <td id="LC947">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>MARS</span>:</td>
      </tr>
      <tr>
        <td id="L948" data-line-number="948"></td>
        <td id="LC948">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>_fMARS</span> <span>?</span> <span>1</span> <span>:</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L949" data-line-number="949"></td>
        <td id="LC949">                        <span>offset</span> <span>+=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L950" data-line-number="950"></td>
        <td id="LC950">                        <span>optionDataSize</span> <span>+=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L951" data-line-number="951"></td>
        <td id="LC951">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L952" data-line-number="952"></td>
        <td id="LC952">
</td>
      </tr>
      <tr>
        <td id="L953" data-line-number="953"></td>
        <td id="LC953">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>TRACEID</span>:</td>
      </tr>
      <tr>
        <td id="L954" data-line-number="954"></td>
        <td id="LC954">                        <span>byte</span>[] <span>connectionIdBytes</span> <span>=</span> <span>_connHandler</span>.<span>_clientConnectionId</span>.<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L955" data-line-number="955"></td>
        <td id="LC955">                        <span>Debug</span>.<span>Assert</span>(<span>GUID_SIZE</span> <span>==</span> <span>connectionIdBytes</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L956" data-line-number="956"></td>
        <td id="LC956">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>connectionIdBytes</span>, <span>0</span>, <span>payload</span>, <span>payloadLength</span>, <span>GUID_SIZE</span>);</td>
      </tr>
      <tr>
        <td id="L957" data-line-number="957"></td>
        <td id="LC957">                        <span>payloadLength</span> <span>+=</span> <span>GUID_SIZE</span>;</td>
      </tr>
      <tr>
        <td id="L958" data-line-number="958"></td>
        <td id="LC958">                        <span>offset</span> <span>+=</span> <span>GUID_SIZE</span>;</td>
      </tr>
      <tr>
        <td id="L959" data-line-number="959"></td>
        <td id="LC959">                        <span>optionDataSize</span> <span>=</span> <span>GUID_SIZE</span>;</td>
      </tr>
      <tr>
        <td id="L960" data-line-number="960"></td>
        <td id="LC960">
</td>
      </tr>
      <tr>
        <td id="L961" data-line-number="961"></td>
        <td id="LC961">                        <span>ActivityCorrelator</span>.<span>ActivityId</span> <span>actId</span> <span>=</span> <span>ActivityCorrelator</span>.<span>Next</span>();</td>
      </tr>
      <tr>
        <td id="L962" data-line-number="962"></td>
        <td id="LC962">                        <span>connectionIdBytes</span> <span>=</span> <span>actId</span>.<span>Id</span>.<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L963" data-line-number="963"></td>
        <td id="LC963">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>connectionIdBytes</span>, <span>0</span>, <span>payload</span>, <span>payloadLength</span>, <span>GUID_SIZE</span>);</td>
      </tr>
      <tr>
        <td id="L964" data-line-number="964"></td>
        <td id="LC964">                        <span>payloadLength</span> <span>+=</span> <span>GUID_SIZE</span>;</td>
      </tr>
      <tr>
        <td id="L965" data-line-number="965"></td>
        <td id="LC965">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>0x000000ff</span> <span>&amp;</span> <span>actId</span>.<span>Sequence</span>);</td>
      </tr>
      <tr>
        <td id="L966" data-line-number="966"></td>
        <td id="LC966">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>0x0000ff00</span> <span>&amp;</span> <span>actId</span>.<span>Sequence</span>) <span>&gt;&gt;</span> <span>8</span>);</td>
      </tr>
      <tr>
        <td id="L967" data-line-number="967"></td>
        <td id="LC967">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>0x00ff0000</span> <span>&amp;</span> <span>actId</span>.<span>Sequence</span>) <span>&gt;&gt;</span> <span>16</span>);</td>
      </tr>
      <tr>
        <td id="L968" data-line-number="968"></td>
        <td id="LC968">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>0xff000000</span> <span>&amp;</span> <span>actId</span>.<span>Sequence</span>) <span>&gt;&gt;</span> <span>24</span>);</td>
      </tr>
      <tr>
        <td id="L969" data-line-number="969"></td>
        <td id="LC969">                        <span>int</span> <span>actIdSize</span> <span>=</span> <span>GUID_SIZE</span> <span>+</span> <span>sizeof</span>(<span>UInt32</span>);</td>
      </tr>
      <tr>
        <td id="L970" data-line-number="970"></td>
        <td id="LC970">                        <span>offset</span> <span>+=</span> <span>actIdSize</span>;</td>
      </tr>
      <tr>
        <td id="L971" data-line-number="971"></td>
        <td id="LC971">                        <span>optionDataSize</span> <span>+=</span> <span>actIdSize</span>;</td>
      </tr>
      <tr>
        <td id="L972" data-line-number="972"></td>
        <td id="LC972">                        <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.SendPreLoginHandshake|INFO&gt; ClientConnectionID %ls, ActivityID %ls<span>\n</span><span>"</span></span>, <span>_connHandler</span>.<span>_clientConnectionId</span>.<span>ToString</span>(), <span>actId</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L973" data-line-number="973"></td>
        <td id="LC973">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L974" data-line-number="974"></td>
        <td id="LC974">
</td>
      </tr>
      <tr>
        <td id="L975" data-line-number="975"></td>
        <td id="LC975">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>FEDAUTHREQUIRED</span>:</td>
      </tr>
      <tr>
        <td id="L976" data-line-number="976"></td>
        <td id="LC976">                        <span>payload</span>[<span>payloadLength</span><span>++</span>] <span>=</span> <span>0x01</span>;</td>
      </tr>
      <tr>
        <td id="L977" data-line-number="977"></td>
        <td id="LC977">                        <span>offset</span> <span>+=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L978" data-line-number="978"></td>
        <td id="LC978">                        <span>optionDataSize</span> <span>+=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L979" data-line-number="979"></td>
        <td id="LC979">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L980" data-line-number="980"></td>
        <td id="LC980">
</td>
      </tr>
      <tr>
        <td id="L981" data-line-number="981"></td>
        <td id="LC981">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L982" data-line-number="982"></td>
        <td id="LC982">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>UNKNOWN option in SendPreLoginHandshake<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L983" data-line-number="983"></td>
        <td id="LC983">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L984" data-line-number="984"></td>
        <td id="LC984">                }</td>
      </tr>
      <tr>
        <td id="L985" data-line-number="985"></td>
        <td id="LC985">
</td>
      </tr>
      <tr>
        <td id="L986" data-line-number="986"></td>
        <td id="LC986">                <span><span>//</span> Write data length</span></td>
      </tr>
      <tr>
        <td id="L987" data-line-number="987"></td>
        <td id="LC987">                <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>optionDataSize</span> <span>&amp;</span> <span>0xff00</span>) <span>&gt;&gt;</span> <span>8</span>));</td>
      </tr>
      <tr>
        <td id="L988" data-line-number="988"></td>
        <td id="LC988">                <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>optionDataSize</span> <span>&amp;</span> <span>0x00ff</span>));</td>
      </tr>
      <tr>
        <td id="L989" data-line-number="989"></td>
        <td id="LC989">            }</td>
      </tr>
      <tr>
        <td id="L990" data-line-number="990"></td>
        <td id="LC990">
</td>
      </tr>
      <tr>
        <td id="L991" data-line-number="991"></td>
        <td id="LC991">            <span><span>//</span> Write out last option - to let server know the second part of packet completed</span></td>
      </tr>
      <tr>
        <td id="L992" data-line-number="992"></td>
        <td id="LC992">            <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>PreLoginOptions</span>.<span>LASTOPT</span>);</td>
      </tr>
      <tr>
        <td id="L993" data-line-number="993"></td>
        <td id="LC993">
</td>
      </tr>
      <tr>
        <td id="L994" data-line-number="994"></td>
        <td id="LC994">            <span><span>//</span> Write out payload</span></td>
      </tr>
      <tr>
        <td id="L995" data-line-number="995"></td>
        <td id="LC995">            <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>payload</span>, <span>payloadLength</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L996" data-line-number="996"></td>
        <td id="LC996">
</td>
      </tr>
      <tr>
        <td id="L997" data-line-number="997"></td>
        <td id="LC997">            <span><span>//</span> Flush packet</span></td>
      </tr>
      <tr>
        <td id="L998" data-line-number="998"></td>
        <td id="LC998">            <span>_physicalStateObj</span>.<span>WritePacket</span>(<span>TdsEnums</span>.<span>HARDFLUSH</span>);</td>
      </tr>
      <tr>
        <td id="L999" data-line-number="999"></td>
        <td id="LC999">        }</td>
      </tr>
      <tr>
        <td id="L1000" data-line-number="1000"></td>
        <td id="LC1000">
</td>
      </tr>
      <tr>
        <td id="L1001" data-line-number="1001"></td>
        <td id="LC1001">        <span>private</span> <span>PreLoginHandshakeStatus</span> <span>ConsumePreLoginHandshake</span>(<span>SqlAuthenticationMethod</span> <span>authType</span>, <span>bool</span> <span>encrypt</span>, <span>bool</span> <span>trustServerCert</span>, <span>bool</span> <span>integratedSecurity</span>, <span>ServerCertificateValidationCallback</span> <span>serverCallback</span>,</td>
      </tr>
      <tr>
        <td id="L1002" data-line-number="1002"></td>
        <td id="LC1002">                              <span>ClientCertificateRetrievalCallback</span> <span>clientCallback</span>, <span>out</span> <span>bool</span> <span>marsCapable</span>, <span>out</span> <span>bool</span> <span>fedAuthRequired</span>)</td>
      </tr>
      <tr>
        <td id="L1003" data-line-number="1003"></td>
        <td id="LC1003">        {</td>
      </tr>
      <tr>
        <td id="L1004" data-line-number="1004"></td>
        <td id="LC1004">
</td>
      </tr>
      <tr>
        <td id="L1005" data-line-number="1005"></td>
        <td id="LC1005">            <span><span>//</span> Assign default values</span></td>
      </tr>
      <tr>
        <td id="L1006" data-line-number="1006"></td>
        <td id="LC1006">            <span>marsCapable</span> <span>=</span> <span>_fMARS</span>;</td>
      </tr>
      <tr>
        <td id="L1007" data-line-number="1007"></td>
        <td id="LC1007">            <span>fedAuthRequired</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1008" data-line-number="1008"></td>
        <td id="LC1008">
</td>
      </tr>
      <tr>
        <td id="L1009" data-line-number="1009"></td>
        <td id="LC1009">            <span>bool</span> <span>isYukonOrLater</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1010" data-line-number="1010"></td>
        <td id="LC1010">
</td>
      </tr>
      <tr>
        <td id="L1011" data-line-number="1011"></td>
        <td id="LC1011">            <span>Debug</span>.<span>Assert</span>(<span>_physicalStateObj</span>.<span>_syncOverAsync</span>, <span><span>"</span>Should not attempt pends in a synchronous call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1012" data-line-number="1012"></td>
        <td id="LC1012">            <span>bool</span> <span>result</span> <span>=</span> <span>_physicalStateObj</span>.<span>TryReadNetworkPacket</span>();</td>
      </tr>
      <tr>
        <td id="L1013" data-line-number="1013"></td>
        <td id="LC1013">            <span>if</span> (<span>!</span><span>result</span>)</td>
      </tr>
      <tr>
        <td id="L1014" data-line-number="1014"></td>
        <td id="LC1014">            { <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>(); }</td>
      </tr>
      <tr>
        <td id="L1015" data-line-number="1015"></td>
        <td id="LC1015">
</td>
      </tr>
      <tr>
        <td id="L1016" data-line-number="1016"></td>
        <td id="LC1016">            <span>if</span> (<span>_physicalStateObj</span>.<span>_inBytesRead</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1017" data-line-number="1017"></td>
        <td id="LC1017">            {</td>
      </tr>
      <tr>
        <td id="L1018" data-line-number="1018"></td>
        <td id="LC1018">                <span><span>//</span> If the server did not respond then something has gone wrong and we need to close the connection</span></td>
      </tr>
      <tr>
        <td id="L1019" data-line-number="1019"></td>
        <td id="LC1019">                <span>_physicalStateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>0</span>, (<span>byte</span>)<span>0x00</span>, <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>PreloginError</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L1020" data-line-number="1020"></td>
        <td id="LC1020">                <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L1021" data-line-number="1021"></td>
        <td id="LC1021">                <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1022" data-line-number="1022"></td>
        <td id="LC1022">            }</td>
      </tr>
      <tr>
        <td id="L1023" data-line-number="1023"></td>
        <td id="LC1023">
</td>
      </tr>
      <tr>
        <td id="L1024" data-line-number="1024"></td>
        <td id="LC1024">            <span>if</span> (<span>!</span><span>_physicalStateObj</span>.<span>TryProcessHeader</span>())</td>
      </tr>
      <tr>
        <td id="L1025" data-line-number="1025"></td>
        <td id="LC1025">            { <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>(); }</td>
      </tr>
      <tr>
        <td id="L1026" data-line-number="1026"></td>
        <td id="LC1026">
</td>
      </tr>
      <tr>
        <td id="L1027" data-line-number="1027"></td>
        <td id="LC1027">            <span>if</span> (<span>_physicalStateObj</span>.<span>_inBytesPacket</span> <span>&gt;</span> <span>TdsEnums</span>.<span>MAX_PACKET_SIZE</span> <span>||</span> <span>_physicalStateObj</span>.<span>_inBytesPacket</span> <span>&lt;=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1028" data-line-number="1028"></td>
        <td id="LC1028">            {</td>
      </tr>
      <tr>
        <td id="L1029" data-line-number="1029"></td>
        <td id="LC1029">                <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>CorruptedTdsStream</span>);</td>
      </tr>
      <tr>
        <td id="L1030" data-line-number="1030"></td>
        <td id="LC1030">            }</td>
      </tr>
      <tr>
        <td id="L1031" data-line-number="1031"></td>
        <td id="LC1031">            <span>byte</span>[] <span>payload</span> <span>=</span> <span>new</span> <span>byte</span>[<span>_physicalStateObj</span>.<span>_inBytesPacket</span>];</td>
      </tr>
      <tr>
        <td id="L1032" data-line-number="1032"></td>
        <td id="LC1032">
</td>
      </tr>
      <tr>
        <td id="L1033" data-line-number="1033"></td>
        <td id="LC1033">            <span>Debug</span>.<span>Assert</span>(<span>_physicalStateObj</span>.<span>_syncOverAsync</span>, <span><span>"</span>Should not attempt pends in a synchronous call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1034" data-line-number="1034"></td>
        <td id="LC1034">            <span>result</span> <span>=</span> <span>_physicalStateObj</span>.<span>TryReadByteArray</span>(<span>payload</span>, <span>0</span>, <span>payload</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L1035" data-line-number="1035"></td>
        <td id="LC1035">            <span>if</span> (<span>!</span><span>result</span>)</td>
      </tr>
      <tr>
        <td id="L1036" data-line-number="1036"></td>
        <td id="LC1036">            { <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>(); }</td>
      </tr>
      <tr>
        <td id="L1037" data-line-number="1037"></td>
        <td id="LC1037">
</td>
      </tr>
      <tr>
        <td id="L1038" data-line-number="1038"></td>
        <td id="LC1038">            <span>if</span> (<span>payload</span>[<span>0</span>] <span>==</span> <span>0xaa</span>)</td>
      </tr>
      <tr>
        <td id="L1039" data-line-number="1039"></td>
        <td id="LC1039">            {</td>
      </tr>
      <tr>
        <td id="L1040" data-line-number="1040"></td>
        <td id="LC1040">                <span><span>//</span> If the first byte is 0xAA, we are connecting to a 6.5 or earlier server, which</span></td>
      </tr>
      <tr>
        <td id="L1041" data-line-number="1041"></td>
        <td id="LC1041">                <span><span>//</span> is not supported.  SQL BU DT 296425</span></td>
      </tr>
      <tr>
        <td id="L1042" data-line-number="1042"></td>
        <td id="LC1042">                <span>throw</span> <span>SQL</span>.<span>InvalidSQLServerVersionUnknown</span>();</td>
      </tr>
      <tr>
        <td id="L1043" data-line-number="1043"></td>
        <td id="LC1043">            }</td>
      </tr>
      <tr>
        <td id="L1044" data-line-number="1044"></td>
        <td id="LC1044">
</td>
      </tr>
      <tr>
        <td id="L1045" data-line-number="1045"></td>
        <td id="LC1045">            <span>int</span> <span>offset</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1046" data-line-number="1046"></td>
        <td id="LC1046">            <span>int</span> <span>payloadOffset</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1047" data-line-number="1047"></td>
        <td id="LC1047">            <span>int</span> <span>payloadLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1048" data-line-number="1048"></td>
        <td id="LC1048">            <span>int</span> <span>option</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1049" data-line-number="1049"></td>
        <td id="LC1049">
</td>
      </tr>
      <tr>
        <td id="L1050" data-line-number="1050"></td>
        <td id="LC1050">            <span>while</span> (<span>option</span> <span>!=</span> (<span>byte</span>)<span>PreLoginOptions</span>.<span>LASTOPT</span>)</td>
      </tr>
      <tr>
        <td id="L1051" data-line-number="1051"></td>
        <td id="LC1051">            {</td>
      </tr>
      <tr>
        <td id="L1052" data-line-number="1052"></td>
        <td id="LC1052">                <span>switch</span> (<span>option</span>)</td>
      </tr>
      <tr>
        <td id="L1053" data-line-number="1053"></td>
        <td id="LC1053">                {</td>
      </tr>
      <tr>
        <td id="L1054" data-line-number="1054"></td>
        <td id="LC1054">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>VERSION</span>:</td>
      </tr>
      <tr>
        <td id="L1055" data-line-number="1055"></td>
        <td id="LC1055">                        <span>payloadOffset</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1056" data-line-number="1056"></td>
        <td id="LC1056">                        <span>payloadLength</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1057" data-line-number="1057"></td>
        <td id="LC1057">
</td>
      </tr>
      <tr>
        <td id="L1058" data-line-number="1058"></td>
        <td id="LC1058">                        <span>byte</span> <span>majorVersion</span> <span>=</span> <span>payload</span>[<span>payloadOffset</span>];</td>
      </tr>
      <tr>
        <td id="L1059" data-line-number="1059"></td>
        <td id="LC1059">                        <span>byte</span> <span>minorVersion</span> <span>=</span> <span>payload</span>[<span>payloadOffset</span> <span>+</span> <span>1</span>];</td>
      </tr>
      <tr>
        <td id="L1060" data-line-number="1060"></td>
        <td id="LC1060">                        <span>int</span> <span>level</span> <span>=</span> (<span>payload</span>[<span>payloadOffset</span> <span>+</span> <span>2</span>] <span>&lt;&lt;</span> <span>8</span>) <span>|</span></td>
      </tr>
      <tr>
        <td id="L1061" data-line-number="1061"></td>
        <td id="LC1061">                                             <span>payload</span>[<span>payloadOffset</span> <span>+</span> <span>3</span>];</td>
      </tr>
      <tr>
        <td id="L1062" data-line-number="1062"></td>
        <td id="LC1062">
</td>
      </tr>
      <tr>
        <td id="L1063" data-line-number="1063"></td>
        <td id="LC1063">                        <span>isYukonOrLater</span> <span>=</span> <span>majorVersion</span> <span>&gt;=</span> <span>9</span>;</td>
      </tr>
      <tr>
        <td id="L1064" data-line-number="1064"></td>
        <td id="LC1064">                        <span>if</span> (<span>!</span><span>isYukonOrLater</span>)</td>
      </tr>
      <tr>
        <td id="L1065" data-line-number="1065"></td>
        <td id="LC1065">                        {</td>
      </tr>
      <tr>
        <td id="L1066" data-line-number="1066"></td>
        <td id="LC1066">                            <span>marsCapable</span> <span>=</span> <span>false</span>;            <span><span>//</span> If pre-Yukon, MARS not supported.</span></td>
      </tr>
      <tr>
        <td id="L1067" data-line-number="1067"></td>
        <td id="LC1067">                        }</td>
      </tr>
      <tr>
        <td id="L1068" data-line-number="1068"></td>
        <td id="LC1068">
</td>
      </tr>
      <tr>
        <td id="L1069" data-line-number="1069"></td>
        <td id="LC1069">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1070" data-line-number="1070"></td>
        <td id="LC1070">
</td>
      </tr>
      <tr>
        <td id="L1071" data-line-number="1071"></td>
        <td id="LC1071">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>ENCRYPT</span>:</td>
      </tr>
      <tr>
        <td id="L1072" data-line-number="1072"></td>
        <td id="LC1072">                        <span>payloadOffset</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1073" data-line-number="1073"></td>
        <td id="LC1073">                        <span>payloadLength</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1074" data-line-number="1074"></td>
        <td id="LC1074">
</td>
      </tr>
      <tr>
        <td id="L1075" data-line-number="1075"></td>
        <td id="LC1075">                        <span>EncryptionOptions</span> <span>serverOption</span> <span>=</span> (<span>EncryptionOptions</span>)<span>payload</span>[<span>payloadOffset</span>];</td>
      </tr>
      <tr>
        <td id="L1076" data-line-number="1076"></td>
        <td id="LC1076">                        <span><span>/*</span> internal enum EncryptionOptions {</span></td>
      </tr>
      <tr>
        <td id="L1077" data-line-number="1077"></td>
        <td id="LC1077"><span>                        OFF,</span></td>
      </tr>
      <tr>
        <td id="L1078" data-line-number="1078"></td>
        <td id="LC1078"><span>                        ON,</span></td>
      </tr>
      <tr>
        <td id="L1079" data-line-number="1079"></td>
        <td id="LC1079"><span>                        NOT_SUP,</span></td>
      </tr>
      <tr>
        <td id="L1080" data-line-number="1080"></td>
        <td id="LC1080"><span>                        REQ,</span></td>
      </tr>
      <tr>
        <td id="L1081" data-line-number="1081"></td>
        <td id="LC1081"><span>                        LOGIN</span></td>
      </tr>
      <tr>
        <td id="L1082" data-line-number="1082"></td>
        <td id="LC1082"><span>                    } <span>*/</span></span></td>
      </tr>
      <tr>
        <td id="L1083" data-line-number="1083"></td>
        <td id="LC1083">                        <span>switch</span> (<span>_encryptionOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>)</td>
      </tr>
      <tr>
        <td id="L1084" data-line-number="1084"></td>
        <td id="LC1084">                        {</td>
      </tr>
      <tr>
        <td id="L1085" data-line-number="1085"></td>
        <td id="LC1085">                            <span>case</span> (<span>EncryptionOptions</span>.<span>ON</span>):</td>
      </tr>
      <tr>
        <td id="L1086" data-line-number="1086"></td>
        <td id="LC1086">                                <span>if</span> (<span>serverOption</span> <span>==</span> <span>EncryptionOptions</span>.<span>NOT_SUP</span>)</td>
      </tr>
      <tr>
        <td id="L1087" data-line-number="1087"></td>
        <td id="LC1087">                                {</td>
      </tr>
      <tr>
        <td id="L1088" data-line-number="1088"></td>
        <td id="LC1088">                                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>TdsEnums</span>.<span>ENCRYPTION_NOT_SUPPORTED</span>, (<span>byte</span>)<span>0x00</span>, <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>EncryptionNotSupportedByServer</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L1089" data-line-number="1089"></td>
        <td id="LC1089">                                    <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L1090" data-line-number="1090"></td>
        <td id="LC1090">                                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1091" data-line-number="1091"></td>
        <td id="LC1091">                                }</td>
      </tr>
      <tr>
        <td id="L1092" data-line-number="1092"></td>
        <td id="LC1092">
</td>
      </tr>
      <tr>
        <td id="L1093" data-line-number="1093"></td>
        <td id="LC1093">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1094" data-line-number="1094"></td>
        <td id="LC1094">
</td>
      </tr>
      <tr>
        <td id="L1095" data-line-number="1095"></td>
        <td id="LC1095">                            <span>case</span> (<span>EncryptionOptions</span>.<span>OFF</span>):</td>
      </tr>
      <tr>
        <td id="L1096" data-line-number="1096"></td>
        <td id="LC1096">                                <span>if</span> ((<span>serverOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>) <span>==</span> <span>EncryptionOptions</span>.<span>OFF</span>)</td>
      </tr>
      <tr>
        <td id="L1097" data-line-number="1097"></td>
        <td id="LC1097">                                {</td>
      </tr>
      <tr>
        <td id="L1098" data-line-number="1098"></td>
        <td id="LC1098">                                    <span><span>//</span> Only encrypt login.</span></td>
      </tr>
      <tr>
        <td id="L1099" data-line-number="1099"></td>
        <td id="LC1099">                                    <span>_encryptionOption</span> <span>=</span> <span>EncryptionOptions</span>.<span>LOGIN</span> <span>|</span> (<span>_encryptionOption</span> <span>&amp;</span> <span>~</span><span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>);</td>
      </tr>
      <tr>
        <td id="L1100" data-line-number="1100"></td>
        <td id="LC1100">                                }</td>
      </tr>
      <tr>
        <td id="L1101" data-line-number="1101"></td>
        <td id="LC1101">                                <span>else</span> <span>if</span> ((<span>serverOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>) <span>==</span> <span>EncryptionOptions</span>.<span>REQ</span>)</td>
      </tr>
      <tr>
        <td id="L1102" data-line-number="1102"></td>
        <td id="LC1102">                                {</td>
      </tr>
      <tr>
        <td id="L1103" data-line-number="1103"></td>
        <td id="LC1103">                                    <span><span>//</span> Encrypt all.</span></td>
      </tr>
      <tr>
        <td id="L1104" data-line-number="1104"></td>
        <td id="LC1104">                                    <span>_encryptionOption</span> <span>=</span> <span>EncryptionOptions</span>.<span>ON</span> <span>|</span> (<span>_encryptionOption</span> <span>&amp;</span> <span>~</span><span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>);</td>
      </tr>
      <tr>
        <td id="L1105" data-line-number="1105"></td>
        <td id="LC1105">                                }</td>
      </tr>
      <tr>
        <td id="L1106" data-line-number="1106"></td>
        <td id="LC1106">
</td>
      </tr>
      <tr>
        <td id="L1107" data-line-number="1107"></td>
        <td id="LC1107">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1108" data-line-number="1108"></td>
        <td id="LC1108">
</td>
      </tr>
      <tr>
        <td id="L1109" data-line-number="1109"></td>
        <td id="LC1109">                            <span>case</span> (<span>EncryptionOptions</span>.<span>NOT_SUP</span>):</td>
      </tr>
      <tr>
        <td id="L1110" data-line-number="1110"></td>
        <td id="LC1110">                                <span>if</span> ((<span>serverOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>) <span>==</span> <span>EncryptionOptions</span>.<span>REQ</span>)</td>
      </tr>
      <tr>
        <td id="L1111" data-line-number="1111"></td>
        <td id="LC1111">                                {</td>
      </tr>
      <tr>
        <td id="L1112" data-line-number="1112"></td>
        <td id="LC1112">                                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>TdsEnums</span>.<span>ENCRYPTION_NOT_SUPPORTED</span>, (<span>byte</span>)<span>0x00</span>, <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>EncryptionNotSupportedByClient</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L1113" data-line-number="1113"></td>
        <td id="LC1113">                                    <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L1114" data-line-number="1114"></td>
        <td id="LC1114">                                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1115" data-line-number="1115"></td>
        <td id="LC1115">                                }</td>
      </tr>
      <tr>
        <td id="L1116" data-line-number="1116"></td>
        <td id="LC1116">
</td>
      </tr>
      <tr>
        <td id="L1117" data-line-number="1117"></td>
        <td id="LC1117">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1118" data-line-number="1118"></td>
        <td id="LC1118">
</td>
      </tr>
      <tr>
        <td id="L1119" data-line-number="1119"></td>
        <td id="LC1119">                            <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L1120" data-line-number="1120"></td>
        <td id="LC1120">                                <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Invalid client encryption option detected<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1121" data-line-number="1121"></td>
        <td id="LC1121">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1122" data-line-number="1122"></td>
        <td id="LC1122">                        }</td>
      </tr>
      <tr>
        <td id="L1123" data-line-number="1123"></td>
        <td id="LC1123">
</td>
      </tr>
      <tr>
        <td id="L1124" data-line-number="1124"></td>
        <td id="LC1124">                        <span><span>//</span> Check if the server will accept CTAIP.</span></td>
      </tr>
      <tr>
        <td id="L1125" data-line-number="1125"></td>
        <td id="LC1125">                        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1126" data-line-number="1126"></td>
        <td id="LC1126">                        <span>if</span> ((<span>_encryptionOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>CTAIP</span>) <span>!=</span> <span>0</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L1127" data-line-number="1127"></td>
        <td id="LC1127">                            (<span>serverOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>CTAIP</span>) <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1128" data-line-number="1128"></td>
        <td id="LC1128">                        {</td>
      </tr>
      <tr>
        <td id="L1129" data-line-number="1129"></td>
        <td id="LC1129">                            <span>_physicalStateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>TdsEnums</span>.<span>CTAIP_NOT_SUPPORTED</span>, (<span>byte</span>)<span>0x00</span>, <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>CTAIPNotSupportedByServer</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L1130" data-line-number="1130"></td>
        <td id="LC1130">                            <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L1131" data-line-number="1131"></td>
        <td id="LC1131">                            <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1132" data-line-number="1132"></td>
        <td id="LC1132">                        }</td>
      </tr>
      <tr>
        <td id="L1133" data-line-number="1133"></td>
        <td id="LC1133">
</td>
      </tr>
      <tr>
        <td id="L1134" data-line-number="1134"></td>
        <td id="LC1134">                        <span>if</span> ((<span>_encryptionOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>) <span>==</span> <span>EncryptionOptions</span>.<span>ON</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L1135" data-line-number="1135"></td>
        <td id="LC1135">                            (<span>_encryptionOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>OPTIONS_MASK</span>) <span>==</span> <span>EncryptionOptions</span>.<span>LOGIN</span>)</td>
      </tr>
      <tr>
        <td id="L1136" data-line-number="1136"></td>
        <td id="LC1136">                        {</td>
      </tr>
      <tr>
        <td id="L1137" data-line-number="1137"></td>
        <td id="LC1137">
</td>
      </tr>
      <tr>
        <td id="L1138" data-line-number="1138"></td>
        <td id="LC1138">                            <span>if</span> (<span>serverCallback</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L1139" data-line-number="1139"></td>
        <td id="LC1139">                            {</td>
      </tr>
      <tr>
        <td id="L1140" data-line-number="1140"></td>
        <td id="LC1140">                                <span>trustServerCert</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L1141" data-line-number="1141"></td>
        <td id="LC1141">                            }</td>
      </tr>
      <tr>
        <td id="L1142" data-line-number="1142"></td>
        <td id="LC1142">
</td>
      </tr>
      <tr>
        <td id="L1143" data-line-number="1143"></td>
        <td id="LC1143">                            <span>UInt32</span> <span>error</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1144" data-line-number="1144"></td>
        <td id="LC1144">
</td>
      </tr>
      <tr>
        <td id="L1145" data-line-number="1145"></td>
        <td id="LC1145">                            <span><span>//</span> If we're using legacy server certificate validation behavior (Authentication keyword not provided and not using access token), then validate if</span></td>
      </tr>
      <tr>
        <td id="L1146" data-line-number="1146"></td>
        <td id="LC1146">                            <span><span>//</span>     Encrypt=true and Trust Sever Certificate = false.</span></td>
      </tr>
      <tr>
        <td id="L1147" data-line-number="1147"></td>
        <td id="LC1147">                            <span><span>//</span> If using Authentication keyword or access token, validate if Trust Server Certificate=false.</span></td>
      </tr>
      <tr>
        <td id="L1148" data-line-number="1148"></td>
        <td id="LC1148">                            <span>bool</span> <span>shouldValidateServerCert</span> <span>=</span> (<span>encrypt</span> <span>&amp;&amp;</span> <span>!</span><span>trustServerCert</span>) <span>||</span> ((<span>authType</span> <span>!=</span> <span>SqlAuthenticationMethod</span>.<span>NotSpecified</span> <span>||</span> <span>_connHandler</span>.<span>_accessTokenInBytes</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> <span>!</span><span>trustServerCert</span>);</td>
      </tr>
      <tr>
        <td id="L1149" data-line-number="1149"></td>
        <td id="LC1149">
</td>
      </tr>
      <tr>
        <td id="L1150" data-line-number="1150"></td>
        <td id="LC1150">                            <span>UInt32</span> <span>info</span> <span>=</span> (<span>shouldValidateServerCert</span> <span>?</span> <span>TdsEnums</span>.<span>SNI_SSL_VALIDATE_CERTIFICATE</span> <span>:</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1151" data-line-number="1151"></td>
        <td id="LC1151">                                <span>|</span> (<span>isYukonOrLater</span> <span>&amp;&amp;</span> (<span>_encryptionOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>CLIENT_CERT</span>) <span>==</span> <span>0</span> <span>?</span> <span>TdsEnums</span>.<span>SNI_SSL_USE_SCHANNEL_CACHE</span> <span>:</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L1152" data-line-number="1152"></td>
        <td id="LC1152">
</td>
      </tr>
      <tr>
        <td id="L1153" data-line-number="1153"></td>
        <td id="LC1153">                            <span>if</span> (<span>encrypt</span> <span>&amp;&amp;</span> <span>!</span><span>integratedSecurity</span>)</td>
      </tr>
      <tr>
        <td id="L1154" data-line-number="1154"></td>
        <td id="LC1154">                            {</td>
      </tr>
      <tr>
        <td id="L1155" data-line-number="1155"></td>
        <td id="LC1155">                                <span><span>//</span> optimization: in case of SQL Authentication and encryption, set SNI_SSL_IGNORE_CHANNEL_BINDINGS to let SNI</span></td>
      </tr>
      <tr>
        <td id="L1156" data-line-number="1156"></td>
        <td id="LC1156">                                <span><span>//</span> know that it does not need to allocate/retrieve the Channel Bindings from the SSL context.</span></td>
      </tr>
      <tr>
        <td id="L1157" data-line-number="1157"></td>
        <td id="LC1157">                                <span>info</span> <span>|=</span> <span>TdsEnums</span>.<span>SNI_SSL_IGNORE_CHANNEL_BINDINGS</span>;</td>
      </tr>
      <tr>
        <td id="L1158" data-line-number="1158"></td>
        <td id="LC1158">                            }</td>
      </tr>
      <tr>
        <td id="L1159" data-line-number="1159"></td>
        <td id="LC1159">
</td>
      </tr>
      <tr>
        <td id="L1160" data-line-number="1160"></td>
        <td id="LC1160">                            <span><span>//</span> Add SSL (Encryption) SNI provider.</span></td>
      </tr>
      <tr>
        <td id="L1161" data-line-number="1161"></td>
        <td id="LC1161">                            <span>SNINativeMethodWrapper</span>.<span>AuthProviderInfo</span> <span>authInfo</span> <span>=</span> <span>new</span> <span>SNINativeMethodWrapper</span>.<span>AuthProviderInfo</span>();</td>
      </tr>
      <tr>
        <td id="L1162" data-line-number="1162"></td>
        <td id="LC1162">                            <span>authInfo</span>.<span>flags</span> <span>=</span> <span>info</span>;</td>
      </tr>
      <tr>
        <td id="L1163" data-line-number="1163"></td>
        <td id="LC1163">                            <span>authInfo</span>.<span>certId</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1164" data-line-number="1164"></td>
        <td id="LC1164">                            <span>authInfo</span>.<span>certHash</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1165" data-line-number="1165"></td>
        <td id="LC1165">                            <span>authInfo</span>.<span>clientCertificateCallbackContext</span> <span>=</span> <span>IntPtr</span>.<span>Zero</span>;</td>
      </tr>
      <tr>
        <td id="L1166" data-line-number="1166"></td>
        <td id="LC1166">                            <span>authInfo</span>.<span>clientCertificateCallback</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1167" data-line-number="1167"></td>
        <td id="LC1167">
</td>
      </tr>
      <tr>
        <td id="L1168" data-line-number="1168"></td>
        <td id="LC1168">                            <span>if</span> ((<span>_encryptionOption</span> <span>&amp;</span> <span>EncryptionOptions</span>.<span>CLIENT_CERT</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1169" data-line-number="1169"></td>
        <td id="LC1169">                            {</td>
      </tr>
      <tr>
        <td id="L1170" data-line-number="1170"></td>
        <td id="LC1170">
</td>
      </tr>
      <tr>
        <td id="L1171" data-line-number="1171"></td>
        <td id="LC1171">                                <span>string</span> <span>certificate</span> <span>=</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>Certificate</span>;</td>
      </tr>
      <tr>
        <td id="L1172" data-line-number="1172"></td>
        <td id="LC1172">
</td>
      </tr>
      <tr>
        <td id="L1173" data-line-number="1173"></td>
        <td id="LC1173">                                <span>if</span> (<span>certificate</span>.<span>StartsWith</span>(<span><span>"</span>subject:<span>"</span></span>, <span>StringComparison</span>.<span>OrdinalIgnoreCase</span>))</td>
      </tr>
      <tr>
        <td id="L1174" data-line-number="1174"></td>
        <td id="LC1174">                                {</td>
      </tr>
      <tr>
        <td id="L1175" data-line-number="1175"></td>
        <td id="LC1175">                                    <span>authInfo</span>.<span>certId</span> <span>=</span> <span>certificate</span>.<span>Substring</span>(<span>8</span>);</td>
      </tr>
      <tr>
        <td id="L1176" data-line-number="1176"></td>
        <td id="LC1176">                                }</td>
      </tr>
      <tr>
        <td id="L1177" data-line-number="1177"></td>
        <td id="LC1177">                                <span>else</span> <span>if</span> (<span>certificate</span>.<span>StartsWith</span>(<span><span>"</span>sha1:<span>"</span></span>, <span>StringComparison</span>.<span>OrdinalIgnoreCase</span>))</td>
      </tr>
      <tr>
        <td id="L1178" data-line-number="1178"></td>
        <td id="LC1178">                                {</td>
      </tr>
      <tr>
        <td id="L1179" data-line-number="1179"></td>
        <td id="LC1179">                                    <span>authInfo</span>.<span>certId</span> <span>=</span> <span>certificate</span>.<span>Substring</span>(<span>5</span>);</td>
      </tr>
      <tr>
        <td id="L1180" data-line-number="1180"></td>
        <td id="LC1180">                                    <span>authInfo</span>.<span>certHash</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L1181" data-line-number="1181"></td>
        <td id="LC1181">                                }</td>
      </tr>
      <tr>
        <td id="L1182" data-line-number="1182"></td>
        <td id="LC1182">
</td>
      </tr>
      <tr>
        <td id="L1183" data-line-number="1183"></td>
        <td id="LC1183">                                <span>if</span> (<span>clientCallback</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L1184" data-line-number="1184"></td>
        <td id="LC1184">                                {</td>
      </tr>
      <tr>
        <td id="L1185" data-line-number="1185"></td>
        <td id="LC1185">                                    <span>authInfo</span>.<span>clientCertificateCallbackContext</span> <span>=</span> <span>clientCallback</span>;</td>
      </tr>
      <tr>
        <td id="L1186" data-line-number="1186"></td>
        <td id="LC1186">                                    <span>authInfo</span>.<span>clientCertificateCallback</span> <span>=</span> <span>_clientCertificateCallback</span>;</td>
      </tr>
      <tr>
        <td id="L1187" data-line-number="1187"></td>
        <td id="LC1187">                                }</td>
      </tr>
      <tr>
        <td id="L1188" data-line-number="1188"></td>
        <td id="LC1188">                            }</td>
      </tr>
      <tr>
        <td id="L1189" data-line-number="1189"></td>
        <td id="LC1189">
</td>
      </tr>
      <tr>
        <td id="L1190" data-line-number="1190"></td>
        <td id="LC1190">                            <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNIAddProvider</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>SNINativeMethodWrapper</span>.<span>ProviderEnum</span>.<span>SSL_PROV</span>, <span>authInfo</span>);</td>
      </tr>
      <tr>
        <td id="L1191" data-line-number="1191"></td>
        <td id="LC1191">
</td>
      </tr>
      <tr>
        <td id="L1192" data-line-number="1192"></td>
        <td id="LC1192">                            <span>if</span> (<span>error</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L1193" data-line-number="1193"></td>
        <td id="LC1193">                            {</td>
      </tr>
      <tr>
        <td id="L1194" data-line-number="1194"></td>
        <td id="LC1194">                                <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L1195" data-line-number="1195"></td>
        <td id="LC1195">                                <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1196" data-line-number="1196"></td>
        <td id="LC1196">                            }</td>
      </tr>
      <tr>
        <td id="L1197" data-line-number="1197"></td>
        <td id="LC1197">
</td>
      </tr>
      <tr>
        <td id="L1198" data-line-number="1198"></td>
        <td id="LC1198">                            <span><span>//</span> in the case where an async connection is made, encryption is used and Windows Authentication is used,</span></td>
      </tr>
      <tr>
        <td id="L1199" data-line-number="1199"></td>
        <td id="LC1199">                            <span><span>//</span> wait for SSL handshake to complete, so that the SSL context is fully negotiated before we try to use its</span></td>
      </tr>
      <tr>
        <td id="L1200" data-line-number="1200"></td>
        <td id="LC1200">                            <span><span>//</span> Channel Bindings as part of the Windows Authentication context build (SSL handshake must complete</span></td>
      </tr>
      <tr>
        <td id="L1201" data-line-number="1201"></td>
        <td id="LC1201">                            <span><span>//</span> before calling SNISecGenClientContext).</span></td>
      </tr>
      <tr>
        <td id="L1202" data-line-number="1202"></td>
        <td id="LC1202">                            <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNIWaitForSSLHandshakeToComplete</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>_physicalStateObj</span>.<span>GetTimeoutRemaining</span>());</td>
      </tr>
      <tr>
        <td id="L1203" data-line-number="1203"></td>
        <td id="LC1203">                            <span>if</span> (<span>error</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L1204" data-line-number="1204"></td>
        <td id="LC1204">                            {</td>
      </tr>
      <tr>
        <td id="L1205" data-line-number="1205"></td>
        <td id="LC1205">                                <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L1206" data-line-number="1206"></td>
        <td id="LC1206">                                <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1207" data-line-number="1207"></td>
        <td id="LC1207">                            }</td>
      </tr>
      <tr>
        <td id="L1208" data-line-number="1208"></td>
        <td id="LC1208">
</td>
      </tr>
      <tr>
        <td id="L1209" data-line-number="1209"></td>
        <td id="LC1209">                            <span><span>//</span> Validate server certificate</span></td>
      </tr>
      <tr>
        <td id="L1210" data-line-number="1210"></td>
        <td id="LC1210">                            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1211" data-line-number="1211"></td>
        <td id="LC1211">                            <span>if</span> (<span>serverCallback</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L1212" data-line-number="1212"></td>
        <td id="LC1212">                            {</td>
      </tr>
      <tr>
        <td id="L1213" data-line-number="1213"></td>
        <td id="LC1213">                                <span>X509Certificate2</span> <span>serverCert</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1214" data-line-number="1214"></td>
        <td id="LC1214">
</td>
      </tr>
      <tr>
        <td id="L1215" data-line-number="1215"></td>
        <td id="LC1215">                                <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNISecGetServerCertificate</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>ref</span> <span>serverCert</span>);</td>
      </tr>
      <tr>
        <td id="L1216" data-line-number="1216"></td>
        <td id="LC1216">                                <span>if</span> (<span>error</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L1217" data-line-number="1217"></td>
        <td id="LC1217">                                {</td>
      </tr>
      <tr>
        <td id="L1218" data-line-number="1218"></td>
        <td id="LC1218">                                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L1219" data-line-number="1219"></td>
        <td id="LC1219">                                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1220" data-line-number="1220"></td>
        <td id="LC1220">                                }</td>
      </tr>
      <tr>
        <td id="L1221" data-line-number="1221"></td>
        <td id="LC1221">
</td>
      </tr>
      <tr>
        <td id="L1222" data-line-number="1222"></td>
        <td id="LC1222">                                <span>bool</span> <span>valid</span> <span>=</span> <span>serverCallback</span>(<span>serverCert</span>);</td>
      </tr>
      <tr>
        <td id="L1223" data-line-number="1223"></td>
        <td id="LC1223">                                <span>if</span> (<span>!</span><span>valid</span>)</td>
      </tr>
      <tr>
        <td id="L1224" data-line-number="1224"></td>
        <td id="LC1224">                                {</td>
      </tr>
      <tr>
        <td id="L1225" data-line-number="1225"></td>
        <td id="LC1225">                                    <span>throw</span> <span>SQL</span>.<span>InvalidServerCertificate</span>();</td>
      </tr>
      <tr>
        <td id="L1226" data-line-number="1226"></td>
        <td id="LC1226">                                }</td>
      </tr>
      <tr>
        <td id="L1227" data-line-number="1227"></td>
        <td id="LC1227">                            }</td>
      </tr>
      <tr>
        <td id="L1228" data-line-number="1228"></td>
        <td id="LC1228">
</td>
      </tr>
      <tr>
        <td id="L1229" data-line-number="1229"></td>
        <td id="LC1229">                            <span><span>//</span> create a new packet encryption changes the internal packet size Bug# 228403</span></td>
      </tr>
      <tr>
        <td id="L1230" data-line-number="1230"></td>
        <td id="LC1230">                            <span>try</span></td>
      </tr>
      <tr>
        <td id="L1231" data-line-number="1231"></td>
        <td id="LC1231">                            { } <span><span>//</span> EmptyTry/Finally to avoid FXCop violation</span></td>
      </tr>
      <tr>
        <td id="L1232" data-line-number="1232"></td>
        <td id="LC1232">                            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L1233" data-line-number="1233"></td>
        <td id="LC1233">                            {</td>
      </tr>
      <tr>
        <td id="L1234" data-line-number="1234"></td>
        <td id="LC1234">                                <span>_physicalStateObj</span>.<span>ClearAllWritePackets</span>();</td>
      </tr>
      <tr>
        <td id="L1235" data-line-number="1235"></td>
        <td id="LC1235">                            }</td>
      </tr>
      <tr>
        <td id="L1236" data-line-number="1236"></td>
        <td id="LC1236">                        }</td>
      </tr>
      <tr>
        <td id="L1237" data-line-number="1237"></td>
        <td id="LC1237">
</td>
      </tr>
      <tr>
        <td id="L1238" data-line-number="1238"></td>
        <td id="LC1238">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1239" data-line-number="1239"></td>
        <td id="LC1239">
</td>
      </tr>
      <tr>
        <td id="L1240" data-line-number="1240"></td>
        <td id="LC1240">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>INSTANCE</span>:</td>
      </tr>
      <tr>
        <td id="L1241" data-line-number="1241"></td>
        <td id="LC1241">                        <span>payloadOffset</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1242" data-line-number="1242"></td>
        <td id="LC1242">                        <span>payloadLength</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1243" data-line-number="1243"></td>
        <td id="LC1243">
</td>
      </tr>
      <tr>
        <td id="L1244" data-line-number="1244"></td>
        <td id="LC1244">                        <span>byte</span> <span>ERROR_INST</span> <span>=</span> <span>0x1</span>;</td>
      </tr>
      <tr>
        <td id="L1245" data-line-number="1245"></td>
        <td id="LC1245">                        <span>byte</span> <span>instanceResult</span> <span>=</span> <span>payload</span>[<span>payloadOffset</span>];</td>
      </tr>
      <tr>
        <td id="L1246" data-line-number="1246"></td>
        <td id="LC1246">
</td>
      </tr>
      <tr>
        <td id="L1247" data-line-number="1247"></td>
        <td id="LC1247">                        <span>if</span> (<span>instanceResult</span> <span>==</span> <span>ERROR_INST</span>)</td>
      </tr>
      <tr>
        <td id="L1248" data-line-number="1248"></td>
        <td id="LC1248">                        {</td>
      </tr>
      <tr>
        <td id="L1249" data-line-number="1249"></td>
        <td id="LC1249">                            <span><span>//</span> Check if server says ERROR_INST. That either means the cached info</span></td>
      </tr>
      <tr>
        <td id="L1250" data-line-number="1250"></td>
        <td id="LC1250">                            <span><span>//</span> we used to connect is not valid or we connected to a named instance</span></td>
      </tr>
      <tr>
        <td id="L1251" data-line-number="1251"></td>
        <td id="LC1251">                            <span><span>//</span> listening on default params.</span></td>
      </tr>
      <tr>
        <td id="L1252" data-line-number="1252"></td>
        <td id="LC1252">                            <span>return</span> <span>PreLoginHandshakeStatus</span>.<span>InstanceFailure</span>;</td>
      </tr>
      <tr>
        <td id="L1253" data-line-number="1253"></td>
        <td id="LC1253">                        }</td>
      </tr>
      <tr>
        <td id="L1254" data-line-number="1254"></td>
        <td id="LC1254">
</td>
      </tr>
      <tr>
        <td id="L1255" data-line-number="1255"></td>
        <td id="LC1255">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1256" data-line-number="1256"></td>
        <td id="LC1256">
</td>
      </tr>
      <tr>
        <td id="L1257" data-line-number="1257"></td>
        <td id="LC1257">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>THREADID</span>:</td>
      </tr>
      <tr>
        <td id="L1258" data-line-number="1258"></td>
        <td id="LC1258">                        <span><span>//</span> DO NOTHING FOR THREADID</span></td>
      </tr>
      <tr>
        <td id="L1259" data-line-number="1259"></td>
        <td id="LC1259">                        <span>offset</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L1260" data-line-number="1260"></td>
        <td id="LC1260">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1261" data-line-number="1261"></td>
        <td id="LC1261">
</td>
      </tr>
      <tr>
        <td id="L1262" data-line-number="1262"></td>
        <td id="LC1262">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>MARS</span>:</td>
      </tr>
      <tr>
        <td id="L1263" data-line-number="1263"></td>
        <td id="LC1263">                        <span>payloadOffset</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1264" data-line-number="1264"></td>
        <td id="LC1264">                        <span>payloadLength</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1265" data-line-number="1265"></td>
        <td id="LC1265">
</td>
      </tr>
      <tr>
        <td id="L1266" data-line-number="1266"></td>
        <td id="LC1266">                        <span>marsCapable</span> <span>=</span> (<span>payload</span>[<span>payloadOffset</span>] <span>==</span> <span>0</span> <span>?</span> <span>false</span> <span>:</span> <span>true</span>);</td>
      </tr>
      <tr>
        <td id="L1267" data-line-number="1267"></td>
        <td id="LC1267">
</td>
      </tr>
      <tr>
        <td id="L1268" data-line-number="1268"></td>
        <td id="LC1268">                        <span>Debug</span>.<span>Assert</span>(<span>payload</span>[<span>payloadOffset</span>] <span>==</span> <span>0</span> <span>||</span> <span>payload</span>[<span>payloadOffset</span>] <span>==</span> <span>1</span>, <span><span>"</span>Value for Mars PreLoginHandshake option not equal to 1 or 0!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1269" data-line-number="1269"></td>
        <td id="LC1269">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1270" data-line-number="1270"></td>
        <td id="LC1270">
</td>
      </tr>
      <tr>
        <td id="L1271" data-line-number="1271"></td>
        <td id="LC1271">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>TRACEID</span>:</td>
      </tr>
      <tr>
        <td id="L1272" data-line-number="1272"></td>
        <td id="LC1272">                        <span><span>//</span> DO NOTHING FOR TRACEID</span></td>
      </tr>
      <tr>
        <td id="L1273" data-line-number="1273"></td>
        <td id="LC1273">                        <span>offset</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L1274" data-line-number="1274"></td>
        <td id="LC1274">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1275" data-line-number="1275"></td>
        <td id="LC1275">
</td>
      </tr>
      <tr>
        <td id="L1276" data-line-number="1276"></td>
        <td id="LC1276">                    <span>case</span> (<span>int</span>)<span>PreLoginOptions</span>.<span>FEDAUTHREQUIRED</span>:</td>
      </tr>
      <tr>
        <td id="L1277" data-line-number="1277"></td>
        <td id="LC1277">                        <span>payloadOffset</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1278" data-line-number="1278"></td>
        <td id="LC1278">                        <span>payloadLength</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>] <span>&lt;&lt;</span> <span>8</span> <span>|</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1279" data-line-number="1279"></td>
        <td id="LC1279">
</td>
      </tr>
      <tr>
        <td id="L1280" data-line-number="1280"></td>
        <td id="LC1280">                        <span><span>//</span> Only 0x00 and 0x01 are accepted values from the server.</span></td>
      </tr>
      <tr>
        <td id="L1281" data-line-number="1281"></td>
        <td id="LC1281">                        <span>if</span> (<span>payload</span>[<span>payloadOffset</span>] <span>!=</span> <span>0x00</span> <span>&amp;&amp;</span> <span>payload</span>[<span>payloadOffset</span>] <span>!=</span> <span>0x01</span>)</td>
      </tr>
      <tr>
        <td id="L1282" data-line-number="1282"></td>
        <td id="LC1282">                        {</td>
      </tr>
      <tr>
        <td id="L1283" data-line-number="1283"></td>
        <td id="LC1283">                            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.ConsumePreLoginHandshake|ERR&gt; %d#, Server sent an unexpected value for FedAuthRequired PreLogin Option. Value was %d.<span>\n</span><span>"</span></span>, <span>ObjectID</span>, (<span>int</span>)<span>payload</span>[<span>payloadOffset</span>]);</td>
      </tr>
      <tr>
        <td id="L1284" data-line-number="1284"></td>
        <td id="LC1284">                            <span>throw</span> <span>SQL</span>.<span>ParsingErrorValue</span>(<span>ParsingErrorState</span>.<span>FedAuthRequiredPreLoginResponseInvalidValue</span>, (<span>int</span>)<span>payload</span>[<span>payloadOffset</span>]);</td>
      </tr>
      <tr>
        <td id="L1285" data-line-number="1285"></td>
        <td id="LC1285">                        }</td>
      </tr>
      <tr>
        <td id="L1286" data-line-number="1286"></td>
        <td id="LC1286">
</td>
      </tr>
      <tr>
        <td id="L1287" data-line-number="1287"></td>
        <td id="LC1287">                        <span><span>//</span> We must NOT use the response for the FEDAUTHREQUIRED PreLogin option, if the connection string option</span></td>
      </tr>
      <tr>
        <td id="L1288" data-line-number="1288"></td>
        <td id="LC1288">                        <span><span>//</span> was not using the new Authentication keyword or in other words, if Authentication=NotSpecified</span></td>
      </tr>
      <tr>
        <td id="L1289" data-line-number="1289"></td>
        <td id="LC1289">                        <span><span>//</span> Or AccessToken is not null, mean token based authentication is used.</span></td>
      </tr>
      <tr>
        <td id="L1290" data-line-number="1290"></td>
        <td id="LC1290">                        <span>if</span> ((<span>_connHandler</span>.<span>ConnectionOptions</span> <span>!=</span> <span>null</span></td>
      </tr>
      <tr>
        <td id="L1291" data-line-number="1291"></td>
        <td id="LC1291">                            <span>&amp;&amp;</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>Authentication</span> <span>!=</span> <span>SqlAuthenticationMethod</span>.<span>NotSpecified</span>)</td>
      </tr>
      <tr>
        <td id="L1292" data-line-number="1292"></td>
        <td id="LC1292">                            <span>||</span> <span>_connHandler</span>.<span>_accessTokenInBytes</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L1293" data-line-number="1293"></td>
        <td id="LC1293">                        {</td>
      </tr>
      <tr>
        <td id="L1294" data-line-number="1294"></td>
        <td id="LC1294">                            <span>fedAuthRequired</span> <span>=</span> <span>payload</span>[<span>payloadOffset</span>] <span>==</span> <span>0x01</span> <span>?</span> <span>true</span> <span>:</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1295" data-line-number="1295"></td>
        <td id="LC1295">                        }</td>
      </tr>
      <tr>
        <td id="L1296" data-line-number="1296"></td>
        <td id="LC1296">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1297" data-line-number="1297"></td>
        <td id="LC1297">
</td>
      </tr>
      <tr>
        <td id="L1298" data-line-number="1298"></td>
        <td id="LC1298">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L1299" data-line-number="1299"></td>
        <td id="LC1299">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>UNKNOWN option in ConsumePreLoginHandshake, option:<span>"</span></span> <span>+</span> <span>option</span>);</td>
      </tr>
      <tr>
        <td id="L1300" data-line-number="1300"></td>
        <td id="LC1300">
</td>
      </tr>
      <tr>
        <td id="L1301" data-line-number="1301"></td>
        <td id="LC1301">                        <span><span>//</span> DO NOTHING FOR THESE UNKNOWN OPTIONS</span></td>
      </tr>
      <tr>
        <td id="L1302" data-line-number="1302"></td>
        <td id="LC1302">                        <span>offset</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L1303" data-line-number="1303"></td>
        <td id="LC1303">
</td>
      </tr>
      <tr>
        <td id="L1304" data-line-number="1304"></td>
        <td id="LC1304">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1305" data-line-number="1305"></td>
        <td id="LC1305">                }</td>
      </tr>
      <tr>
        <td id="L1306" data-line-number="1306"></td>
        <td id="LC1306">
</td>
      </tr>
      <tr>
        <td id="L1307" data-line-number="1307"></td>
        <td id="LC1307">                <span>if</span> (<span>offset</span> <span>&lt;</span> <span>payload</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L1308" data-line-number="1308"></td>
        <td id="LC1308">                {</td>
      </tr>
      <tr>
        <td id="L1309" data-line-number="1309"></td>
        <td id="LC1309">                    <span>option</span> <span>=</span> <span>payload</span>[<span>offset</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L1310" data-line-number="1310"></td>
        <td id="LC1310">                }</td>
      </tr>
      <tr>
        <td id="L1311" data-line-number="1311"></td>
        <td id="LC1311">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L1312" data-line-number="1312"></td>
        <td id="LC1312">                {</td>
      </tr>
      <tr>
        <td id="L1313" data-line-number="1313"></td>
        <td id="LC1313">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L1314" data-line-number="1314"></td>
        <td id="LC1314">                }</td>
      </tr>
      <tr>
        <td id="L1315" data-line-number="1315"></td>
        <td id="LC1315">            }</td>
      </tr>
      <tr>
        <td id="L1316" data-line-number="1316"></td>
        <td id="LC1316">
</td>
      </tr>
      <tr>
        <td id="L1317" data-line-number="1317"></td>
        <td id="LC1317">            <span>return</span> <span>PreLoginHandshakeStatus</span>.<span>Successful</span>;</td>
      </tr>
      <tr>
        <td id="L1318" data-line-number="1318"></td>
        <td id="LC1318">        }</td>
      </tr>
      <tr>
        <td id="L1319" data-line-number="1319"></td>
        <td id="LC1319">
</td>
      </tr>
      <tr>
        <td id="L1320" data-line-number="1320"></td>
        <td id="LC1320">        <span>internal</span> <span>void</span> <span>Deactivate</span>(<span>bool</span> <span>connectionIsDoomed</span>)</td>
      </tr>
      <tr>
        <td id="L1321" data-line-number="1321"></td>
        <td id="LC1321">        {</td>
      </tr>
      <tr>
        <td id="L1322" data-line-number="1322"></td>
        <td id="LC1322">            <span><span>//</span> Called when the connection that owns us is deactivated.</span></td>
      </tr>
      <tr>
        <td id="L1323" data-line-number="1323"></td>
        <td id="LC1323">
</td>
      </tr>
      <tr>
        <td id="L1324" data-line-number="1324"></td>
        <td id="LC1324">            <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L1325" data-line-number="1325"></td>
        <td id="LC1325">            {</td>
      </tr>
      <tr>
        <td id="L1326" data-line-number="1326"></td>
        <td id="LC1326">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Deactivate|ADV&gt; %d# deactivating<span>\n</span><span>"</span></span>, <span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L1327" data-line-number="1327"></td>
        <td id="LC1327">            }</td>
      </tr>
      <tr>
        <td id="L1328" data-line-number="1328"></td>
        <td id="LC1328">
</td>
      </tr>
      <tr>
        <td id="L1329" data-line-number="1329"></td>
        <td id="LC1329">            <span>if</span> (<span>Bid</span>.<span>IsOn</span>(<span>Bid</span>.<span>ApiGroup</span>.<span>StateDump</span>))</td>
      </tr>
      <tr>
        <td id="L1330" data-line-number="1330"></td>
        <td id="LC1330">            {</td>
      </tr>
      <tr>
        <td id="L1331" data-line-number="1331"></td>
        <td id="LC1331">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Deactivate|STATE&gt; %d#, %ls<span>\n</span><span>"</span></span>, <span>ObjectID</span>, <span>TraceString</span>());</td>
      </tr>
      <tr>
        <td id="L1332" data-line-number="1332"></td>
        <td id="LC1332">            }</td>
      </tr>
      <tr>
        <td id="L1333" data-line-number="1333"></td>
        <td id="LC1333">
</td>
      </tr>
      <tr>
        <td id="L1334" data-line-number="1334"></td>
        <td id="LC1334">            <span>if</span> (<span>MARSOn</span>)</td>
      </tr>
      <tr>
        <td id="L1335" data-line-number="1335"></td>
        <td id="LC1335">            {</td>
      </tr>
      <tr>
        <td id="L1336" data-line-number="1336"></td>
        <td id="LC1336">                <span>_sessionPool</span>.<span>Deactivate</span>();</td>
      </tr>
      <tr>
        <td id="L1337" data-line-number="1337"></td>
        <td id="LC1337">            }</td>
      </tr>
      <tr>
        <td id="L1338" data-line-number="1338"></td>
        <td id="LC1338">
</td>
      </tr>
      <tr>
        <td id="L1339" data-line-number="1339"></td>
        <td id="LC1339">            <span>Debug</span>.<span>Assert</span>(<span>connectionIsDoomed</span> <span>||</span> <span>null</span> <span>==</span> <span>_pendingTransaction</span>, <span><span>"</span>pending transaction at disconnect?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1340" data-line-number="1340"></td>
        <td id="LC1340">
</td>
      </tr>
      <tr>
        <td id="L1341" data-line-number="1341"></td>
        <td id="LC1341">            <span>if</span> (<span>!</span><span>connectionIsDoomed</span> <span>&amp;&amp;</span> <span>null</span> <span>!=</span> <span>_physicalStateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1342" data-line-number="1342"></td>
        <td id="LC1342">            {</td>
      </tr>
      <tr>
        <td id="L1343" data-line-number="1343"></td>
        <td id="LC1343">                <span>if</span> (<span>_physicalStateObj</span>.<span>_pendingData</span>)</td>
      </tr>
      <tr>
        <td id="L1344" data-line-number="1344"></td>
        <td id="LC1344">                {</td>
      </tr>
      <tr>
        <td id="L1345" data-line-number="1345"></td>
        <td id="LC1345">                    <span>DrainData</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1346" data-line-number="1346"></td>
        <td id="LC1346">                }</td>
      </tr>
      <tr>
        <td id="L1347" data-line-number="1347"></td>
        <td id="LC1347">
</td>
      </tr>
      <tr>
        <td id="L1348" data-line-number="1348"></td>
        <td id="LC1348">                <span>if</span> (<span>_physicalStateObj</span>.<span>HasOpenResult</span>)</td>
      </tr>
      <tr>
        <td id="L1349" data-line-number="1349"></td>
        <td id="LC1349">                { <span><span>//</span> SQL BU DT 383773 - need to decrement openResultCount for all pending operations.</span></td>
      </tr>
      <tr>
        <td id="L1350" data-line-number="1350"></td>
        <td id="LC1350">                    <span>_physicalStateObj</span>.<span>DecrementOpenResultCount</span>();</td>
      </tr>
      <tr>
        <td id="L1351" data-line-number="1351"></td>
        <td id="LC1351">                }</td>
      </tr>
      <tr>
        <td id="L1352" data-line-number="1352"></td>
        <td id="LC1352">            }</td>
      </tr>
      <tr>
        <td id="L1353" data-line-number="1353"></td>
        <td id="LC1353">
</td>
      </tr>
      <tr>
        <td id="L1354" data-line-number="1354"></td>
        <td id="LC1354">            <span><span>//</span> Any active, non-distributed transaction must be rolled back.  We</span></td>
      </tr>
      <tr>
        <td id="L1355" data-line-number="1355"></td>
        <td id="LC1355">            <span><span>//</span> need to wait for distributed transactions to be completed by the</span></td>
      </tr>
      <tr>
        <td id="L1356" data-line-number="1356"></td>
        <td id="LC1356">            <span><span>//</span> transaction manager -- we don't want to automatically roll them</span></td>
      </tr>
      <tr>
        <td id="L1357" data-line-number="1357"></td>
        <td id="LC1357">            <span><span>//</span> back.</span></td>
      </tr>
      <tr>
        <td id="L1358" data-line-number="1358"></td>
        <td id="LC1358">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1359" data-line-number="1359"></td>
        <td id="LC1359">            <span><span>//</span> Note that when there is a transaction delegated to this connection,</span></td>
      </tr>
      <tr>
        <td id="L1360" data-line-number="1360"></td>
        <td id="LC1360">            <span><span>//</span> we will defer the deactivation of this connection until the</span></td>
      </tr>
      <tr>
        <td id="L1361" data-line-number="1361"></td>
        <td id="LC1361">            <span><span>//</span> transaction manager completes the transaction.</span></td>
      </tr>
      <tr>
        <td id="L1362" data-line-number="1362"></td>
        <td id="LC1362">            <span>SqlInternalTransaction</span> <span>currentTransaction</span> <span>=</span> <span>CurrentTransaction</span>;</td>
      </tr>
      <tr>
        <td id="L1363" data-line-number="1363"></td>
        <td id="LC1363">
</td>
      </tr>
      <tr>
        <td id="L1364" data-line-number="1364"></td>
        <td id="LC1364">            <span>if</span> (<span>null</span> <span>!=</span> <span>currentTransaction</span> <span>&amp;&amp;</span> <span>currentTransaction</span>.<span>HasParentTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L1365" data-line-number="1365"></td>
        <td id="LC1365">            {</td>
      </tr>
      <tr>
        <td id="L1366" data-line-number="1366"></td>
        <td id="LC1366">                <span>currentTransaction</span>.<span>CloseFromConnection</span>();</td>
      </tr>
      <tr>
        <td id="L1367" data-line-number="1367"></td>
        <td id="LC1367">                <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>==</span> <span>CurrentTransaction</span>, <span><span>"</span>rollback didn't clear current transaction?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1368" data-line-number="1368"></td>
        <td id="LC1368">            }</td>
      </tr>
      <tr>
        <td id="L1369" data-line-number="1369"></td>
        <td id="LC1369">
</td>
      </tr>
      <tr>
        <td id="L1370" data-line-number="1370"></td>
        <td id="LC1370">            <span>Statistics</span> <span>=</span> <span>null</span>; <span><span>//</span> must come after CleanWire or we won't count the stuff that happens there...</span></td>
      </tr>
      <tr>
        <td id="L1371" data-line-number="1371"></td>
        <td id="LC1371">        }</td>
      </tr>
      <tr>
        <td id="L1372" data-line-number="1372"></td>
        <td id="LC1372">
</td>
      </tr>
      <tr>
        <td id="L1373" data-line-number="1373"></td>
        <td id="LC1373">        <span><span>//</span> Used to close the connection and then free the memory allocated for the netlib connection.</span></td>
      </tr>
      <tr>
        <td id="L1374" data-line-number="1374"></td>
        <td id="LC1374">        <span>internal</span> <span>void</span> <span>Disconnect</span>()</td>
      </tr>
      <tr>
        <td id="L1375" data-line-number="1375"></td>
        <td id="LC1375">        {</td>
      </tr>
      <tr>
        <td id="L1376" data-line-number="1376"></td>
        <td id="LC1376">            <span>if</span> (<span>null</span> <span>!=</span> <span>_sessionPool</span>)</td>
      </tr>
      <tr>
        <td id="L1377" data-line-number="1377"></td>
        <td id="LC1377">            {</td>
      </tr>
      <tr>
        <td id="L1378" data-line-number="1378"></td>
        <td id="LC1378">                <span><span>//</span> MARSOn may be true, but _sessionPool not yet created</span></td>
      </tr>
      <tr>
        <td id="L1379" data-line-number="1379"></td>
        <td id="LC1379">                <span>_sessionPool</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L1380" data-line-number="1380"></td>
        <td id="LC1380">            }</td>
      </tr>
      <tr>
        <td id="L1381" data-line-number="1381"></td>
        <td id="LC1381">
</td>
      </tr>
      <tr>
        <td id="L1382" data-line-number="1382"></td>
        <td id="LC1382">            <span><span>//</span> Can close the connection if its open or broken</span></td>
      </tr>
      <tr>
        <td id="L1383" data-line-number="1383"></td>
        <td id="LC1383">            <span>if</span> (<span>_state</span> <span>!=</span> <span>TdsParserState</span>.<span>Closed</span>)</td>
      </tr>
      <tr>
        <td id="L1384" data-line-number="1384"></td>
        <td id="LC1384">            {</td>
      </tr>
      <tr>
        <td id="L1385" data-line-number="1385"></td>
        <td id="LC1385">                <span><span>//</span>benign assert - the user could close the connection before consuming all the data</span></td>
      </tr>
      <tr>
        <td id="L1386" data-line-number="1386"></td>
        <td id="LC1386">                <span><span>//</span>Debug.Assert(_physicalStateObj._inBytesUsed == _physicalStateObj._inBytesRead &amp;&amp; _physicalStateObj._outBytesUsed == _physicalStateObj._inputHeaderLen, "TDSParser closed with data not fully sent or consumed.");</span></td>
      </tr>
      <tr>
        <td id="L1387" data-line-number="1387"></td>
        <td id="LC1387">
</td>
      </tr>
      <tr>
        <td id="L1388" data-line-number="1388"></td>
        <td id="LC1388">                <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>Closed</span>;</td>
      </tr>
      <tr>
        <td id="L1389" data-line-number="1389"></td>
        <td id="LC1389">
</td>
      </tr>
      <tr>
        <td id="L1390" data-line-number="1390"></td>
        <td id="LC1390">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L1391" data-line-number="1391"></td>
        <td id="LC1391">                {</td>
      </tr>
      <tr>
        <td id="L1392" data-line-number="1392"></td>
        <td id="LC1392">                    <span><span>//</span> If the _physicalStateObj has an owner, we will delay the disposal until the owner is finished with it</span></td>
      </tr>
      <tr>
        <td id="L1393" data-line-number="1393"></td>
        <td id="LC1393">                    <span>if</span> (<span>!</span><span>_physicalStateObj</span>.<span>HasOwner</span>)</td>
      </tr>
      <tr>
        <td id="L1394" data-line-number="1394"></td>
        <td id="LC1394">                    {</td>
      </tr>
      <tr>
        <td id="L1395" data-line-number="1395"></td>
        <td id="LC1395">                        <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Close</span>;</td>
      </tr>
      <tr>
        <td id="L1396" data-line-number="1396"></td>
        <td id="LC1396">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L1397" data-line-number="1397"></td>
        <td id="LC1397">                        <span>_physicalStateObj</span>.<span>InvalidateDebugOnlyCopyOfSniContext</span>();</td>
      </tr>
      <tr>
        <td id="L1398" data-line-number="1398"></td>
        <td id="LC1398">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L1399" data-line-number="1399"></td>
        <td id="LC1399">                        <span>_physicalStateObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L1400" data-line-number="1400"></td>
        <td id="LC1400">                    }</td>
      </tr>
      <tr>
        <td id="L1401" data-line-number="1401"></td>
        <td id="LC1401">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L1402" data-line-number="1402"></td>
        <td id="LC1402">                    {</td>
      </tr>
      <tr>
        <td id="L1403" data-line-number="1403"></td>
        <td id="LC1403">                        <span><span>//</span> Remove the "initial" callback (this will allow the stateObj to be GC collected if need be)</span></td>
      </tr>
      <tr>
        <td id="L1404" data-line-number="1404"></td>
        <td id="LC1404">                        <span>_physicalStateObj</span>.<span>DecrementPendingCallbacks</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L1405" data-line-number="1405"></td>
        <td id="LC1405">                    }</td>
      </tr>
      <tr>
        <td id="L1406" data-line-number="1406"></td>
        <td id="LC1406">
</td>
      </tr>
      <tr>
        <td id="L1407" data-line-number="1407"></td>
        <td id="LC1407">                    <span><span>//</span> Not allocated until MARS is actually enabled in SNI.</span></td>
      </tr>
      <tr>
        <td id="L1408" data-line-number="1408"></td>
        <td id="LC1408">                    <span>if</span> (<span>null</span> <span>!=</span> <span>_pMarsPhysicalConObj</span>)</td>
      </tr>
      <tr>
        <td id="L1409" data-line-number="1409"></td>
        <td id="LC1409">                    {</td>
      </tr>
      <tr>
        <td id="L1410" data-line-number="1410"></td>
        <td id="LC1410">                        <span>_pMarsPhysicalConObj</span>.<span>Dispose</span>();</td>
      </tr>
      <tr>
        <td id="L1411" data-line-number="1411"></td>
        <td id="LC1411">                    }</td>
      </tr>
      <tr>
        <td id="L1412" data-line-number="1412"></td>
        <td id="LC1412">                }</td>
      </tr>
      <tr>
        <td id="L1413" data-line-number="1413"></td>
        <td id="LC1413">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L1414" data-line-number="1414"></td>
        <td id="LC1414">                {</td>
      </tr>
      <tr>
        <td id="L1415" data-line-number="1415"></td>
        <td id="LC1415">                    <span>_pMarsPhysicalConObj</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1416" data-line-number="1416"></td>
        <td id="LC1416">                }</td>
      </tr>
      <tr>
        <td id="L1417" data-line-number="1417"></td>
        <td id="LC1417">            }</td>
      </tr>
      <tr>
        <td id="L1418" data-line-number="1418"></td>
        <td id="LC1418">        }</td>
      </tr>
      <tr>
        <td id="L1419" data-line-number="1419"></td>
        <td id="LC1419">
</td>
      </tr>
      <tr>
        <td id="L1420" data-line-number="1420"></td>
        <td id="LC1420">        <span><span>//</span> Fires a single InfoMessageEvent</span></td>
      </tr>
      <tr>
        <td id="L1421" data-line-number="1421"></td>
        <td id="LC1421">        <span>private</span> <span>void</span> <span>FireInfoMessageEvent</span>(<span>SqlConnection</span> <span>connection</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>SqlError</span> <span>error</span>)</td>
      </tr>
      <tr>
        <td id="L1422" data-line-number="1422"></td>
        <td id="LC1422">        {</td>
      </tr>
      <tr>
        <td id="L1423" data-line-number="1423"></td>
        <td id="LC1423">
</td>
      </tr>
      <tr>
        <td id="L1424" data-line-number="1424"></td>
        <td id="LC1424">            <span>string</span> <span>serverVersion</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1425" data-line-number="1425"></td>
        <td id="LC1425">
</td>
      </tr>
      <tr>
        <td id="L1426" data-line-number="1426"></td>
        <td id="LC1426">            <span>Debug</span>.<span>Assert</span>(<span>connection</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>_connHandler</span>.<span>Connection</span> <span>==</span> <span>connection</span>);</td>
      </tr>
      <tr>
        <td id="L1427" data-line-number="1427"></td>
        <td id="LC1427">
</td>
      </tr>
      <tr>
        <td id="L1428" data-line-number="1428"></td>
        <td id="LC1428">            <span>if</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>OpenLoggedIn</span>)</td>
      </tr>
      <tr>
        <td id="L1429" data-line-number="1429"></td>
        <td id="LC1429">            {</td>
      </tr>
      <tr>
        <td id="L1430" data-line-number="1430"></td>
        <td id="LC1430">                <span>serverVersion</span> <span>=</span> <span>_connHandler</span>.<span>ServerVersion</span>;</td>
      </tr>
      <tr>
        <td id="L1431" data-line-number="1431"></td>
        <td id="LC1431">            }</td>
      </tr>
      <tr>
        <td id="L1432" data-line-number="1432"></td>
        <td id="LC1432">
</td>
      </tr>
      <tr>
        <td id="L1433" data-line-number="1433"></td>
        <td id="LC1433">            <span>SqlErrorCollection</span> <span>sqlErs</span> <span>=</span> <span>new</span> <span>SqlErrorCollection</span>();</td>
      </tr>
      <tr>
        <td id="L1434" data-line-number="1434"></td>
        <td id="LC1434">
</td>
      </tr>
      <tr>
        <td id="L1435" data-line-number="1435"></td>
        <td id="LC1435">            <span>sqlErs</span>.<span>Add</span>(<span>error</span>);</td>
      </tr>
      <tr>
        <td id="L1436" data-line-number="1436"></td>
        <td id="LC1436">
</td>
      </tr>
      <tr>
        <td id="L1437" data-line-number="1437"></td>
        <td id="LC1437">            <span>SqlException</span> <span>exc</span> <span>=</span> <span>SqlException</span>.<span>CreateException</span>(<span>sqlErs</span>, <span>serverVersion</span>, <span>_connHandler</span>);</td>
      </tr>
      <tr>
        <td id="L1438" data-line-number="1438"></td>
        <td id="LC1438">
</td>
      </tr>
      <tr>
        <td id="L1439" data-line-number="1439"></td>
        <td id="LC1439">            <span>bool</span> <span>notified</span>;</td>
      </tr>
      <tr>
        <td id="L1440" data-line-number="1440"></td>
        <td id="LC1440">            <span>connection</span>.<span>OnInfoMessage</span>(<span>new</span> <span>SqlInfoMessageEventArgs</span>(<span>exc</span>), <span>out</span> <span>notified</span>);</td>
      </tr>
      <tr>
        <td id="L1441" data-line-number="1441"></td>
        <td id="LC1441">            <span>if</span> (<span>notified</span>)</td>
      </tr>
      <tr>
        <td id="L1442" data-line-number="1442"></td>
        <td id="LC1442">            {</td>
      </tr>
      <tr>
        <td id="L1443" data-line-number="1443"></td>
        <td id="LC1443">                <span><span>//</span> observable side-effects, no retry</span></td>
      </tr>
      <tr>
        <td id="L1444" data-line-number="1444"></td>
        <td id="LC1444">                <span>stateObj</span>.<span>_syncOverAsync</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L1445" data-line-number="1445"></td>
        <td id="LC1445">            }</td>
      </tr>
      <tr>
        <td id="L1446" data-line-number="1446"></td>
        <td id="LC1446">            <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L1447" data-line-number="1447"></td>
        <td id="LC1447">        }</td>
      </tr>
      <tr>
        <td id="L1448" data-line-number="1448"></td>
        <td id="LC1448">
</td>
      </tr>
      <tr>
        <td id="L1449" data-line-number="1449"></td>
        <td id="LC1449">        <span>internal</span> <span>void</span> <span>DisconnectTransaction</span>(<span>SqlInternalTransaction</span> <span>internalTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L1450" data-line-number="1450"></td>
        <td id="LC1450">        {</td>
      </tr>
      <tr>
        <td id="L1451" data-line-number="1451"></td>
        <td id="LC1451">            <span>Debug</span>.<span>Assert</span>(<span>_currentTransaction</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>_currentTransaction</span> <span>==</span> <span>internalTransaction</span>, <span><span>"</span>disconnecting different transaction<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1452" data-line-number="1452"></td>
        <td id="LC1452">
</td>
      </tr>
      <tr>
        <td id="L1453" data-line-number="1453"></td>
        <td id="LC1453">            <span>if</span> (<span>_currentTransaction</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>_currentTransaction</span> <span>==</span> <span>internalTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L1454" data-line-number="1454"></td>
        <td id="LC1454">            {</td>
      </tr>
      <tr>
        <td id="L1455" data-line-number="1455"></td>
        <td id="LC1455">                <span>_currentTransaction</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1456" data-line-number="1456"></td>
        <td id="LC1456">            }</td>
      </tr>
      <tr>
        <td id="L1457" data-line-number="1457"></td>
        <td id="LC1457">        }</td>
      </tr>
      <tr>
        <td id="L1458" data-line-number="1458"></td>
        <td id="LC1458">
</td>
      </tr>
      <tr>
        <td id="L1459" data-line-number="1459"></td>
        <td id="LC1459">        <span>internal</span> <span>void</span> <span>RollbackOrphanedAPITransactions</span>()</td>
      </tr>
      <tr>
        <td id="L1460" data-line-number="1460"></td>
        <td id="LC1460">        {</td>
      </tr>
      <tr>
        <td id="L1461" data-line-number="1461"></td>
        <td id="LC1461">            <span><span>//</span> Any active, non-distributed transaction must be rolled back.</span></td>
      </tr>
      <tr>
        <td id="L1462" data-line-number="1462"></td>
        <td id="LC1462">            <span>SqlInternalTransaction</span> <span>currentTransaction</span> <span>=</span> <span>CurrentTransaction</span>;</td>
      </tr>
      <tr>
        <td id="L1463" data-line-number="1463"></td>
        <td id="LC1463">
</td>
      </tr>
      <tr>
        <td id="L1464" data-line-number="1464"></td>
        <td id="LC1464">            <span>if</span> (<span>null</span> <span>!=</span> <span>currentTransaction</span> <span>&amp;&amp;</span> <span>currentTransaction</span>.<span>HasParentTransaction</span> <span>&amp;&amp;</span> <span>currentTransaction</span>.<span>IsOrphaned</span>)</td>
      </tr>
      <tr>
        <td id="L1465" data-line-number="1465"></td>
        <td id="LC1465">            {</td>
      </tr>
      <tr>
        <td id="L1466" data-line-number="1466"></td>
        <td id="LC1466">                <span>currentTransaction</span>.<span>CloseFromConnection</span>();</td>
      </tr>
      <tr>
        <td id="L1467" data-line-number="1467"></td>
        <td id="LC1467">                <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>==</span> <span>CurrentTransaction</span>, <span><span>"</span>rollback didn't clear current transaction?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1468" data-line-number="1468"></td>
        <td id="LC1468">            }</td>
      </tr>
      <tr>
        <td id="L1469" data-line-number="1469"></td>
        <td id="LC1469">        }</td>
      </tr>
      <tr>
        <td id="L1470" data-line-number="1470"></td>
        <td id="LC1470">
</td>
      </tr>
      <tr>
        <td id="L1471" data-line-number="1471"></td>
        <td id="LC1471">        <span>internal</span> <span>void</span> <span>ThrowExceptionAndWarning</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>callerHasConnectionLock</span> <span>=</span> <span>false</span>, <span>bool</span> <span>asyncClose</span> <span>=</span> <span>false</span>)</td>
      </tr>
      <tr>
        <td id="L1472" data-line-number="1472"></td>
        <td id="LC1472">        {</td>
      </tr>
      <tr>
        <td id="L1473" data-line-number="1473"></td>
        <td id="LC1473">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>callerHasConnectionLock</span> <span>||</span> <span>_connHandler</span>.<span>_parserLock</span>.<span>ThreadMayHaveLock</span>(), <span><span>"</span>Caller claims to have lock, but connection lock is not taken<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1474" data-line-number="1474"></td>
        <td id="LC1474">
</td>
      </tr>
      <tr>
        <td id="L1475" data-line-number="1475"></td>
        <td id="LC1475">            <span>SqlException</span> <span>exception</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1476" data-line-number="1476"></td>
        <td id="LC1476">            <span>bool</span> <span>breakConnection</span>;</td>
      </tr>
      <tr>
        <td id="L1477" data-line-number="1477"></td>
        <td id="LC1477">
</td>
      </tr>
      <tr>
        <td id="L1478" data-line-number="1478"></td>
        <td id="LC1478">            <span><span>//</span> This function should only be called when there was an error or warning.  If there aren't any</span></td>
      </tr>
      <tr>
        <td id="L1479" data-line-number="1479"></td>
        <td id="LC1479">            <span><span>//</span> errors, the handler will be called for the warning(s).  If there was an error, the warning(s) will</span></td>
      </tr>
      <tr>
        <td id="L1480" data-line-number="1480"></td>
        <td id="LC1480">            <span><span>//</span> be copied to the end of the error collection so that the user may see all the errors and also the</span></td>
      </tr>
      <tr>
        <td id="L1481" data-line-number="1481"></td>
        <td id="LC1481">            <span><span>//</span> warnings that occurred.</span></td>
      </tr>
      <tr>
        <td id="L1482" data-line-number="1482"></td>
        <td id="LC1482">            <span><span>//</span> can be deleted)</span></td>
      </tr>
      <tr>
        <td id="L1483" data-line-number="1483"></td>
        <td id="LC1483">            <span>SqlErrorCollection</span> <span>temp</span> <span>=</span> <span>stateObj</span>.<span>GetFullErrorAndWarningCollection</span>(<span>out</span> <span>breakConnection</span>);</td>
      </tr>
      <tr>
        <td id="L1484" data-line-number="1484"></td>
        <td id="LC1484">
</td>
      </tr>
      <tr>
        <td id="L1485" data-line-number="1485"></td>
        <td id="LC1485">            <span>Debug</span>.<span>Assert</span>(<span>temp</span>.<span>Count</span> <span>&gt;</span> <span>0</span>, <span><span>"</span>TdsParser::ThrowExceptionAndWarning called with no exceptions or warnings!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1486" data-line-number="1486"></td>
        <td id="LC1486">            <span>if</span> (<span>temp</span>.<span>Count</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1487" data-line-number="1487"></td>
        <td id="LC1487">            {</td>
      </tr>
      <tr>
        <td id="L1488" data-line-number="1488"></td>
        <td id="LC1488">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.ThrowExceptionAndWarning|ERR&gt; Potential multi-threaded misuse of connection, unexpectedly empty warnings/errors under lock %d#<span>\n</span><span>"</span></span>, <span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L1489" data-line-number="1489"></td>
        <td id="LC1489">            }</td>
      </tr>
      <tr>
        <td id="L1490" data-line-number="1490"></td>
        <td id="LC1490">            <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span> <span>!=</span> <span>null</span>, <span><span>"</span>TdsParser::ThrowExceptionAndWarning called with null connectionHandler!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1491" data-line-number="1491"></td>
        <td id="LC1491">
</td>
      </tr>
      <tr>
        <td id="L1492" data-line-number="1492"></td>
        <td id="LC1492">            <span><span>//</span> Don't break the connection if it is already closed</span></td>
      </tr>
      <tr>
        <td id="L1493" data-line-number="1493"></td>
        <td id="LC1493">            <span>breakConnection</span> <span>&amp;=</span> (<span>TdsParserState</span>.<span>Closed</span> <span>!=</span> <span>_state</span>);</td>
      </tr>
      <tr>
        <td id="L1494" data-line-number="1494"></td>
        <td id="LC1494">            <span>if</span> (<span>breakConnection</span>)</td>
      </tr>
      <tr>
        <td id="L1495" data-line-number="1495"></td>
        <td id="LC1495">            {</td>
      </tr>
      <tr>
        <td id="L1496" data-line-number="1496"></td>
        <td id="LC1496">                <span>if</span> ((<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span>) <span>&amp;&amp;</span> (<span>_connHandler</span>.<span>ConnectionOptions</span>.<span>TransparentNetworkIPResolution</span> <span>||</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>MultiSubnetFailover</span> <span>||</span> <span>_loginWithFailover</span>) <span>&amp;&amp;</span> (<span>temp</span>.<span>Count</span> <span>==</span> <span>1</span>) <span>&amp;&amp;</span> ((<span>temp</span>[<span>0</span>].<span>Number</span> <span>==</span> <span>TdsEnums</span>.<span>TIMEOUT_EXPIRED</span>) <span>||</span> (<span>temp</span>[<span>0</span>].<span>Number</span> <span>==</span> <span>TdsEnums</span>.<span>SNI_WAIT_TIMEOUT</span>)))</td>
      </tr>
      <tr>
        <td id="L1497" data-line-number="1497"></td>
        <td id="LC1497">                {</td>
      </tr>
      <tr>
        <td id="L1498" data-line-number="1498"></td>
        <td id="LC1498">                    <span><span>//</span> DevDiv2 Bug 459546: With "MultiSubnetFailover=yes" in the Connection String, SQLClient incorrectly throws a Timeout using shorter time slice (3-4 seconds), not honoring the actual 'Connect Timeout'</span></td>
      </tr>
      <tr>
        <td id="L1499" data-line-number="1499"></td>
        <td id="LC1499">                    <span><span>//</span> http://vstfdevdiv:8080/DevDiv2/DevDiv/_workitems/edit/459546</span></td>
      </tr>
      <tr>
        <td id="L1500" data-line-number="1500"></td>
        <td id="LC1500">                    <span><span>//</span> For Multisubnet Failover we slice the timeout to make reconnecting faster (with the assumption that the server will not failover instantaneously)</span></td>
      </tr>
      <tr>
        <td id="L1501" data-line-number="1501"></td>
        <td id="LC1501">                    <span><span>//</span> However, when timeout occurs we need to not doom the internal connection and also to mark the TdsParser as closed such that the login will be will retried</span></td>
      </tr>
      <tr>
        <td id="L1502" data-line-number="1502"></td>
        <td id="LC1502">                    <span>breakConnection</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1503" data-line-number="1503"></td>
        <td id="LC1503">                    <span>Disconnect</span>();</td>
      </tr>
      <tr>
        <td id="L1504" data-line-number="1504"></td>
        <td id="LC1504">                }</td>
      </tr>
      <tr>
        <td id="L1505" data-line-number="1505"></td>
        <td id="LC1505">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L1506" data-line-number="1506"></td>
        <td id="LC1506">                {</td>
      </tr>
      <tr>
        <td id="L1507" data-line-number="1507"></td>
        <td id="LC1507">                    <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>Broken</span>;</td>
      </tr>
      <tr>
        <td id="L1508" data-line-number="1508"></td>
        <td id="LC1508">                }</td>
      </tr>
      <tr>
        <td id="L1509" data-line-number="1509"></td>
        <td id="LC1509">            }</td>
      </tr>
      <tr>
        <td id="L1510" data-line-number="1510"></td>
        <td id="LC1510">
</td>
      </tr>
      <tr>
        <td id="L1511" data-line-number="1511"></td>
        <td id="LC1511">            <span>Debug</span>.<span>Assert</span>(<span>temp</span> <span>!=</span> <span>null</span>, <span><span>"</span>TdsParser::ThrowExceptionAndWarning: 0 errors in collection<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1512" data-line-number="1512"></td>
        <td id="LC1512">            <span>if</span> (<span>temp</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>temp</span>.<span>Count</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1513" data-line-number="1513"></td>
        <td id="LC1513">            {</td>
      </tr>
      <tr>
        <td id="L1514" data-line-number="1514"></td>
        <td id="LC1514">                <span><span>//</span> Construct the exception now that we've collected all the errors</span></td>
      </tr>
      <tr>
        <td id="L1515" data-line-number="1515"></td>
        <td id="LC1515">                <span>string</span> <span>serverVersion</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L1516" data-line-number="1516"></td>
        <td id="LC1516">                <span>if</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>OpenLoggedIn</span>)</td>
      </tr>
      <tr>
        <td id="L1517" data-line-number="1517"></td>
        <td id="LC1517">                {</td>
      </tr>
      <tr>
        <td id="L1518" data-line-number="1518"></td>
        <td id="LC1518">                    <span>serverVersion</span> <span>=</span> <span>_connHandler</span>.<span>ServerVersion</span>;</td>
      </tr>
      <tr>
        <td id="L1519" data-line-number="1519"></td>
        <td id="LC1519">                }</td>
      </tr>
      <tr>
        <td id="L1520" data-line-number="1520"></td>
        <td id="LC1520">                <span>exception</span> <span>=</span> <span>SqlException</span>.<span>CreateException</span>(<span>temp</span>, <span>serverVersion</span>, <span>_connHandler</span>);</td>
      </tr>
      <tr>
        <td id="L1521" data-line-number="1521"></td>
        <td id="LC1521">                <span>if</span> (<span>exception</span>.<span>Procedure</span> <span>==</span> <span>TdsEnums</span>.<span>INIT_SSPI_PACKAGE</span>)</td>
      </tr>
      <tr>
        <td id="L1522" data-line-number="1522"></td>
        <td id="LC1522">                {</td>
      </tr>
      <tr>
        <td id="L1523" data-line-number="1523"></td>
        <td id="LC1523">                    <span>exception</span>.<span>_doNotReconnect</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L1524" data-line-number="1524"></td>
        <td id="LC1524">                }</td>
      </tr>
      <tr>
        <td id="L1525" data-line-number="1525"></td>
        <td id="LC1525">            }</td>
      </tr>
      <tr>
        <td id="L1526" data-line-number="1526"></td>
        <td id="LC1526">
</td>
      </tr>
      <tr>
        <td id="L1527" data-line-number="1527"></td>
        <td id="LC1527">            <span><span>//</span> call OnError outside of _ErrorCollectionLock to avoid deadlock</span></td>
      </tr>
      <tr>
        <td id="L1528" data-line-number="1528"></td>
        <td id="LC1528">            <span>if</span> (<span>exception</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L1529" data-line-number="1529"></td>
        <td id="LC1529">            {</td>
      </tr>
      <tr>
        <td id="L1530" data-line-number="1530"></td>
        <td id="LC1530">                <span>if</span> (<span>breakConnection</span>)</td>
      </tr>
      <tr>
        <td id="L1531" data-line-number="1531"></td>
        <td id="LC1531">                {</td>
      </tr>
      <tr>
        <td id="L1532" data-line-number="1532"></td>
        <td id="LC1532">                    <span><span>//</span> report exception to pending async operation</span></td>
      </tr>
      <tr>
        <td id="L1533" data-line-number="1533"></td>
        <td id="LC1533">                    <span><span>//</span> before OnConnectionClosed overrides the exception</span></td>
      </tr>
      <tr>
        <td id="L1534" data-line-number="1534"></td>
        <td id="LC1534">                    <span><span>//</span> due to connection close notification through references</span></td>
      </tr>
      <tr>
        <td id="L1535" data-line-number="1535"></td>
        <td id="LC1535">                    <span>var</span> <span>taskSource</span> <span>=</span> <span>stateObj</span>.<span>_networkPacketTaskSource</span>;</td>
      </tr>
      <tr>
        <td id="L1536" data-line-number="1536"></td>
        <td id="LC1536">                    <span>if</span> (<span>taskSource</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L1537" data-line-number="1537"></td>
        <td id="LC1537">                    {</td>
      </tr>
      <tr>
        <td id="L1538" data-line-number="1538"></td>
        <td id="LC1538">                        <span>taskSource</span>.<span>TrySetException</span>(<span>ADP</span>.<span>ExceptionWithStackTrace</span>(<span>exception</span>));</td>
      </tr>
      <tr>
        <td id="L1539" data-line-number="1539"></td>
        <td id="LC1539">                    }</td>
      </tr>
      <tr>
        <td id="L1540" data-line-number="1540"></td>
        <td id="LC1540">                }</td>
      </tr>
      <tr>
        <td id="L1541" data-line-number="1541"></td>
        <td id="LC1541">
</td>
      </tr>
      <tr>
        <td id="L1542" data-line-number="1542"></td>
        <td id="LC1542">                <span>if</span> (<span>asyncClose</span>)</td>
      </tr>
      <tr>
        <td id="L1543" data-line-number="1543"></td>
        <td id="LC1543">                {</td>
      </tr>
      <tr>
        <td id="L1544" data-line-number="1544"></td>
        <td id="LC1544">                    <span><span>//</span> Wait until we have the parser lock, then try to close</span></td>
      </tr>
      <tr>
        <td id="L1545" data-line-number="1545"></td>
        <td id="LC1545">                    <span>var</span> <span>connHandler</span> <span>=</span> <span>_connHandler</span>;</td>
      </tr>
      <tr>
        <td id="L1546" data-line-number="1546"></td>
        <td id="LC1546">                    <span>Action</span>&lt;<span>Action</span>&gt; <span>wrapCloseAction</span> <span>=</span> <span>closeAction</span> <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="L1547" data-line-number="1547"></td>
        <td id="LC1547">                    {</td>
      </tr>
      <tr>
        <td id="L1548" data-line-number="1548"></td>
        <td id="LC1548">                        <span>Task</span>.<span>Factory</span>.<span>StartNew</span>(() <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="L1549" data-line-number="1549"></td>
        <td id="LC1549">                        {</td>
      </tr>
      <tr>
        <td id="L1550" data-line-number="1550"></td>
        <td id="LC1550">                            <span>connHandler</span>.<span>_parserLock</span>.<span>Wait</span>(<span>canReleaseFromAnyThread</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L1551" data-line-number="1551"></td>
        <td id="LC1551">                            <span>connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L1552" data-line-number="1552"></td>
        <td id="LC1552">                            <span>try</span></td>
      </tr>
      <tr>
        <td id="L1553" data-line-number="1553"></td>
        <td id="LC1553">                            {</td>
      </tr>
      <tr>
        <td id="L1554" data-line-number="1554"></td>
        <td id="LC1554">                                <span>closeAction</span>();</td>
      </tr>
      <tr>
        <td id="L1555" data-line-number="1555"></td>
        <td id="LC1555">                            }</td>
      </tr>
      <tr>
        <td id="L1556" data-line-number="1556"></td>
        <td id="LC1556">                            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L1557" data-line-number="1557"></td>
        <td id="LC1557">                            {</td>
      </tr>
      <tr>
        <td id="L1558" data-line-number="1558"></td>
        <td id="LC1558">                                <span>connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1559" data-line-number="1559"></td>
        <td id="LC1559">                                <span>connHandler</span>.<span>_parserLock</span>.<span>Release</span>();</td>
      </tr>
      <tr>
        <td id="L1560" data-line-number="1560"></td>
        <td id="LC1560">                            }</td>
      </tr>
      <tr>
        <td id="L1561" data-line-number="1561"></td>
        <td id="LC1561">                        });</td>
      </tr>
      <tr>
        <td id="L1562" data-line-number="1562"></td>
        <td id="LC1562">                    };</td>
      </tr>
      <tr>
        <td id="L1563" data-line-number="1563"></td>
        <td id="LC1563">
</td>
      </tr>
      <tr>
        <td id="L1564" data-line-number="1564"></td>
        <td id="LC1564">                    <span>_connHandler</span>.<span>OnError</span>(<span>exception</span>, <span>breakConnection</span>, <span>wrapCloseAction</span>);</td>
      </tr>
      <tr>
        <td id="L1565" data-line-number="1565"></td>
        <td id="LC1565">                }</td>
      </tr>
      <tr>
        <td id="L1566" data-line-number="1566"></td>
        <td id="LC1566">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L1567" data-line-number="1567"></td>
        <td id="LC1567">                {</td>
      </tr>
      <tr>
        <td id="L1568" data-line-number="1568"></td>
        <td id="LC1568">                    <span><span>//</span> Let close know that we already have the _parserLock</span></td>
      </tr>
      <tr>
        <td id="L1569" data-line-number="1569"></td>
        <td id="LC1569">                    <span>bool</span> <span>threadAlreadyHadParserLockForClose</span> <span>=</span> <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span>;</td>
      </tr>
      <tr>
        <td id="L1570" data-line-number="1570"></td>
        <td id="LC1570">                    <span>if</span> (<span>callerHasConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L1571" data-line-number="1571"></td>
        <td id="LC1571">                    {</td>
      </tr>
      <tr>
        <td id="L1572" data-line-number="1572"></td>
        <td id="LC1572">                        <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L1573" data-line-number="1573"></td>
        <td id="LC1573">                    }</td>
      </tr>
      <tr>
        <td id="L1574" data-line-number="1574"></td>
        <td id="LC1574">                    <span>try</span></td>
      </tr>
      <tr>
        <td id="L1575" data-line-number="1575"></td>
        <td id="LC1575">                    {</td>
      </tr>
      <tr>
        <td id="L1576" data-line-number="1576"></td>
        <td id="LC1576">                        <span><span>//</span> the following handler will throw an exception or generate a warning event</span></td>
      </tr>
      <tr>
        <td id="L1577" data-line-number="1577"></td>
        <td id="LC1577">                        <span>_connHandler</span>.<span>OnError</span>(<span>exception</span>, <span>breakConnection</span>);</td>
      </tr>
      <tr>
        <td id="L1578" data-line-number="1578"></td>
        <td id="LC1578">                    }</td>
      </tr>
      <tr>
        <td id="L1579" data-line-number="1579"></td>
        <td id="LC1579">                    <span>finally</span></td>
      </tr>
      <tr>
        <td id="L1580" data-line-number="1580"></td>
        <td id="LC1580">                    {</td>
      </tr>
      <tr>
        <td id="L1581" data-line-number="1581"></td>
        <td id="LC1581">                        <span>if</span> (<span>callerHasConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L1582" data-line-number="1582"></td>
        <td id="LC1582">                        {</td>
      </tr>
      <tr>
        <td id="L1583" data-line-number="1583"></td>
        <td id="LC1583">                            <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>threadAlreadyHadParserLockForClose</span>;</td>
      </tr>
      <tr>
        <td id="L1584" data-line-number="1584"></td>
        <td id="LC1584">                        }</td>
      </tr>
      <tr>
        <td id="L1585" data-line-number="1585"></td>
        <td id="LC1585">                    }</td>
      </tr>
      <tr>
        <td id="L1586" data-line-number="1586"></td>
        <td id="LC1586">                }</td>
      </tr>
      <tr>
        <td id="L1587" data-line-number="1587"></td>
        <td id="LC1587">            }</td>
      </tr>
      <tr>
        <td id="L1588" data-line-number="1588"></td>
        <td id="LC1588">        }</td>
      </tr>
      <tr>
        <td id="L1589" data-line-number="1589"></td>
        <td id="LC1589">
</td>
      </tr>
      <tr>
        <td id="L1590" data-line-number="1590"></td>
        <td id="LC1590">        <span>internal</span> <span>SqlError</span> <span>ProcessSNIError</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1591" data-line-number="1591"></td>
        <td id="LC1591">        {</td>
      </tr>
      <tr>
        <td id="L1592" data-line-number="1592"></td>
        <td id="LC1592">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L1593" data-line-number="1593"></td>
        <td id="LC1593">            <span><span>//</span> There is an exception here for MARS as its possible that another thread has closed the connection just as we see an error</span></td>
      </tr>
      <tr>
        <td id="L1594" data-line-number="1594"></td>
        <td id="LC1594">            <span>Debug</span>.<span>Assert</span>(<span>SniContext</span>.<span>Undefined</span> <span>!=</span> <span>stateObj</span>.<span>DebugOnlyCopyOfSniContext</span> <span>||</span> ((<span>_fMARS</span>) <span>&amp;&amp;</span> ((<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Closed</span>) <span>||</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Broken</span>))), <span><span>"</span>SniContext must not be None<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1595" data-line-number="1595"></td>
        <td id="LC1595">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L1596" data-line-number="1596"></td>
        <td id="LC1596">            <span>SNINativeMethodWrapper</span>.<span>SNI_Error</span> <span>sniError</span> <span>=</span> <span>new</span> <span>SNINativeMethodWrapper</span>.<span>SNI_Error</span>();</td>
      </tr>
      <tr>
        <td id="L1597" data-line-number="1597"></td>
        <td id="LC1597">            <span>SNINativeMethodWrapper</span>.<span>SNIGetLastError</span>(<span>out</span> <span>sniError</span>);</td>
      </tr>
      <tr>
        <td id="L1598" data-line-number="1598"></td>
        <td id="LC1598">
</td>
      </tr>
      <tr>
        <td id="L1599" data-line-number="1599"></td>
        <td id="LC1599">            <span>if</span> (<span>sniError</span>.<span>sniError</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1600" data-line-number="1600"></td>
        <td id="LC1600">            {</td>
      </tr>
      <tr>
        <td id="L1601" data-line-number="1601"></td>
        <td id="LC1601">
</td>
      </tr>
      <tr>
        <td id="L1602" data-line-number="1602"></td>
        <td id="LC1602">                <span><span>//</span> handle special SNI error codes that are converted into exception which is not a SqlException.</span></td>
      </tr>
      <tr>
        <td id="L1603" data-line-number="1603"></td>
        <td id="LC1603">                <span>switch</span> (<span>sniError</span>.<span>sniError</span>)</td>
      </tr>
      <tr>
        <td id="L1604" data-line-number="1604"></td>
        <td id="LC1604">                {</td>
      </tr>
      <tr>
        <td id="L1605" data-line-number="1605"></td>
        <td id="LC1605">                    <span>case</span> (<span>int</span>)<span>SNINativeMethodWrapper</span>.<span>SniSpecialErrors</span>.<span>MultiSubnetFailoverWithMoreThan64IPs</span>:</td>
      </tr>
      <tr>
        <td id="L1606" data-line-number="1606"></td>
        <td id="LC1606">                        <span><span>//</span> Connecting with the MultiSubnetFailover connection option to a SQL Server instance configured with more than 64 IP addresses is not supported.</span></td>
      </tr>
      <tr>
        <td id="L1607" data-line-number="1607"></td>
        <td id="LC1607">                        <span>throw</span> <span>SQL</span>.<span>MultiSubnetFailoverWithMoreThan64IPs</span>();</td>
      </tr>
      <tr>
        <td id="L1608" data-line-number="1608"></td>
        <td id="LC1608">
</td>
      </tr>
      <tr>
        <td id="L1609" data-line-number="1609"></td>
        <td id="LC1609">                    <span>case</span> (<span>int</span>)<span>SNINativeMethodWrapper</span>.<span>SniSpecialErrors</span>.<span>MultiSubnetFailoverWithInstanceSpecified</span>:</td>
      </tr>
      <tr>
        <td id="L1610" data-line-number="1610"></td>
        <td id="LC1610">                        <span><span>//</span> Connecting to a named SQL Server instance using the MultiSubnetFailover connection option is not supported.</span></td>
      </tr>
      <tr>
        <td id="L1611" data-line-number="1611"></td>
        <td id="LC1611">                        <span>throw</span> <span>SQL</span>.<span>MultiSubnetFailoverWithInstanceSpecified</span>();</td>
      </tr>
      <tr>
        <td id="L1612" data-line-number="1612"></td>
        <td id="LC1612">
</td>
      </tr>
      <tr>
        <td id="L1613" data-line-number="1613"></td>
        <td id="LC1613">                    <span>case</span> (<span>int</span>)<span>SNINativeMethodWrapper</span>.<span>SniSpecialErrors</span>.<span>MultiSubnetFailoverWithNonTcpProtocol</span>:</td>
      </tr>
      <tr>
        <td id="L1614" data-line-number="1614"></td>
        <td id="LC1614">                        <span><span>//</span> Connecting to a SQL Server instance using the MultiSubnetFailover connection option is only supported when using the TCP protocol.</span></td>
      </tr>
      <tr>
        <td id="L1615" data-line-number="1615"></td>
        <td id="LC1615">                        <span>throw</span> <span>SQL</span>.<span>MultiSubnetFailoverWithNonTcpProtocol</span>();</td>
      </tr>
      <tr>
        <td id="L1616" data-line-number="1616"></td>
        <td id="LC1616">
</td>
      </tr>
      <tr>
        <td id="L1617" data-line-number="1617"></td>
        <td id="LC1617">                        <span><span>//</span> continue building SqlError instance</span></td>
      </tr>
      <tr>
        <td id="L1618" data-line-number="1618"></td>
        <td id="LC1618">                }</td>
      </tr>
      <tr>
        <td id="L1619" data-line-number="1619"></td>
        <td id="LC1619">            }</td>
      </tr>
      <tr>
        <td id="L1620" data-line-number="1620"></td>
        <td id="LC1620">
</td>
      </tr>
      <tr>
        <td id="L1621" data-line-number="1621"></td>
        <td id="LC1621">            <span><span>//</span> error.errorMessage is null terminated with garbage beyond that, since fixed length</span></td>
      </tr>
      <tr>
        <td id="L1622" data-line-number="1622"></td>
        <td id="LC1622">            <span>string</span> <span>errorMessage</span>;</td>
      </tr>
      <tr>
        <td id="L1623" data-line-number="1623"></td>
        <td id="LC1623">            <span>errorMessage</span> <span>=</span> <span>string</span>.<span>IsNullOrEmpty</span>(<span>sniError</span>.<span>errorMessage</span>) <span>?</span> <span>string</span>.<span>Empty</span> <span>:</span> <span>sniError</span>.<span>errorMessage</span>;</td>
      </tr>
      <tr>
        <td id="L1624" data-line-number="1624"></td>
        <td id="LC1624">            <span><span>//</span>  Format SNI errors and add Context Information</span></td>
      </tr>
      <tr>
        <td id="L1625" data-line-number="1625"></td>
        <td id="LC1625">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1626" data-line-number="1626"></td>
        <td id="LC1626">            <span><span>//</span>  General syntax is:</span></td>
      </tr>
      <tr>
        <td id="L1627" data-line-number="1627"></td>
        <td id="LC1627">            <span><span>//</span>  &lt;sqlclient message&gt;</span></td>
      </tr>
      <tr>
        <td id="L1628" data-line-number="1628"></td>
        <td id="LC1628">            <span><span>//</span>  (provider:&lt;SNIx provider&gt;, error: &lt;SNIx error code&gt; - &lt;SNIx error message&gt;)</span></td>
      </tr>
      <tr>
        <td id="L1629" data-line-number="1629"></td>
        <td id="LC1629">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1630" data-line-number="1630"></td>
        <td id="LC1630">            <span><span>//</span> errorMessage | sniError |</span></td>
      </tr>
      <tr>
        <td id="L1631" data-line-number="1631"></td>
        <td id="LC1631">            <span><span>//</span> -------------------------------------------</span></td>
      </tr>
      <tr>
        <td id="L1632" data-line-number="1632"></td>
        <td id="LC1632">            <span><span>//</span> ==null       | x        | must never happen</span></td>
      </tr>
      <tr>
        <td id="L1633" data-line-number="1633"></td>
        <td id="LC1633">            <span><span>//</span> !=null       | != 0     | retrieve corresponding errorMessage from resources</span></td>
      </tr>
      <tr>
        <td id="L1634" data-line-number="1634"></td>
        <td id="LC1634">            <span><span>//</span> !=null       | == 0     | replace text left of errorMessage</span></td>
      </tr>
      <tr>
        <td id="L1635" data-line-number="1635"></td>
        <td id="LC1635">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1636" data-line-number="1636"></td>
        <td id="LC1636">
</td>
      </tr>
      <tr>
        <td id="L1637" data-line-number="1637"></td>
        <td id="LC1637">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>errorMessage</span>), <span><span>"</span>Empty error message received from SNI<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1638" data-line-number="1638"></td>
        <td id="LC1638">
</td>
      </tr>
      <tr>
        <td id="L1639" data-line-number="1639"></td>
        <td id="LC1639">            <span>string</span> <span>sqlContextInfo</span> <span>=</span> <span>StringsHelper</span>.<span>GetString</span>(<span>Enum</span>.<span>GetName</span>(<span>typeof</span>(<span>SniContext</span>), <span>stateObj</span>.<span>SniContext</span>));</td>
      </tr>
      <tr>
        <td id="L1640" data-line-number="1640"></td>
        <td id="LC1640">
</td>
      </tr>
      <tr>
        <td id="L1641" data-line-number="1641"></td>
        <td id="LC1641">            <span>string</span> <span>providerRid</span> <span>=</span> <span>String</span>.<span>Format</span>(<span><span>"</span>SNI_PN{0}<span>"</span></span>, (<span>int</span>)<span>sniError</span>.<span>provider</span>);</td>
      </tr>
      <tr>
        <td id="L1642" data-line-number="1642"></td>
        <td id="LC1642">            <span>string</span> <span>providerName</span> <span>=</span> <span>StringsHelper</span>.<span>GetString</span>(<span>providerRid</span>);</td>
      </tr>
      <tr>
        <td id="L1643" data-line-number="1643"></td>
        <td id="LC1643">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>providerName</span>), <span><span>$"</span>invalid providerResourceId '{<span>providerRid</span>}'<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1644" data-line-number="1644"></td>
        <td id="LC1644">            <span>uint</span> <span>win32ErrorCode</span> <span>=</span> <span>sniError</span>.<span>nativeError</span>;</td>
      </tr>
      <tr>
        <td id="L1645" data-line-number="1645"></td>
        <td id="LC1645">
</td>
      </tr>
      <tr>
        <td id="L1646" data-line-number="1646"></td>
        <td id="LC1646">            <span>if</span> (<span>sniError</span>.<span>sniError</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1647" data-line-number="1647"></td>
        <td id="LC1647">            {</td>
      </tr>
      <tr>
        <td id="L1648" data-line-number="1648"></td>
        <td id="LC1648">                <span><span>//</span> Provider error. The message from provider is preceeded with non-localizable info from SNI</span></td>
      </tr>
      <tr>
        <td id="L1649" data-line-number="1649"></td>
        <td id="LC1649">                <span><span>//</span> strip provider info from SNI</span></td>
      </tr>
      <tr>
        <td id="L1650" data-line-number="1650"></td>
        <td id="LC1650">                <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1651" data-line-number="1651"></td>
        <td id="LC1651">                <span>int</span> <span>iColon</span> <span>=</span> <span>errorMessage</span>.<span>IndexOf</span>(<span>':'</span>);</td>
      </tr>
      <tr>
        <td id="L1652" data-line-number="1652"></td>
        <td id="LC1652">                <span>Debug</span>.<span>Assert</span>(<span>0</span> <span>&lt;=</span> <span>iColon</span>, <span><span>"</span>':' character missing in sni errorMessage<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1653" data-line-number="1653"></td>
        <td id="LC1653">                <span>Debug</span>.<span>Assert</span>(<span>errorMessage</span>.<span>Length</span> <span>&gt;</span> <span>iColon</span> <span>+</span> <span>1</span> <span>&amp;&amp;</span> <span>errorMessage</span>[<span>iColon</span> <span>+</span> <span>1</span>] <span>==</span> <span>' '</span>, <span><span>"</span>Expecting a space after the ':' character<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1654" data-line-number="1654"></td>
        <td id="LC1654">
</td>
      </tr>
      <tr>
        <td id="L1655" data-line-number="1655"></td>
        <td id="LC1655">                <span><span>//</span> extract the message excluding the colon and trailing cr/lf chars</span></td>
      </tr>
      <tr>
        <td id="L1656" data-line-number="1656"></td>
        <td id="LC1656">                <span>if</span> (<span>0</span> <span>&lt;=</span> <span>iColon</span>)</td>
      </tr>
      <tr>
        <td id="L1657" data-line-number="1657"></td>
        <td id="LC1657">                {</td>
      </tr>
      <tr>
        <td id="L1658" data-line-number="1658"></td>
        <td id="LC1658">                    <span>int</span> <span>len</span> <span>=</span> <span>errorMessage</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L1659" data-line-number="1659"></td>
        <td id="LC1659">                    <span>len</span> <span>-=</span> <span>2</span>;    <span><span>//</span> exclude "\r\n" sequence</span></td>
      </tr>
      <tr>
        <td id="L1660" data-line-number="1660"></td>
        <td id="LC1660">                    <span>iColon</span> <span>+=</span> <span>2</span>;  <span><span>//</span> skip over ": " sequence</span></td>
      </tr>
      <tr>
        <td id="L1661" data-line-number="1661"></td>
        <td id="LC1661">                    <span>len</span> <span>-=</span> <span>iColon</span>;</td>
      </tr>
      <tr>
        <td id="L1662" data-line-number="1662"></td>
        <td id="LC1662">                    <span><span>/*</span></span></td>
      </tr>
      <tr>
        <td id="L1663" data-line-number="1663"></td>
        <td id="LC1663"><span>                        The error message should come back in the following format: "TCP Provider: MESSAGE TEXT"</span></td>
      </tr>
      <tr>
        <td id="L1664" data-line-number="1664"></td>
        <td id="LC1664"><span>                        Fix Bug 370686, if the message is recieved on a Win9x OS, the error message will not contain MESSAGE TEXT</span></td>
      </tr>
      <tr>
        <td id="L1665" data-line-number="1665"></td>
        <td id="LC1665"><span>                        per Bug: 269574.  If we get a errormessage with no message text, just return the entire message otherwise</span></td>
      </tr>
      <tr>
        <td id="L1666" data-line-number="1666"></td>
        <td id="LC1666"><span>                        return just the message text.</span></td>
      </tr>
      <tr>
        <td id="L1667" data-line-number="1667"></td>
        <td id="LC1667"><span>                    <span>*/</span></span></td>
      </tr>
      <tr>
        <td id="L1668" data-line-number="1668"></td>
        <td id="LC1668">                    <span>if</span> (<span>len</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L1669" data-line-number="1669"></td>
        <td id="LC1669">                    {</td>
      </tr>
      <tr>
        <td id="L1670" data-line-number="1670"></td>
        <td id="LC1670">                        <span>errorMessage</span> <span>=</span> <span>errorMessage</span>.<span>Substring</span>(<span>iColon</span>, <span>len</span>);</td>
      </tr>
      <tr>
        <td id="L1671" data-line-number="1671"></td>
        <td id="LC1671">                    }</td>
      </tr>
      <tr>
        <td id="L1672" data-line-number="1672"></td>
        <td id="LC1672">                }</td>
      </tr>
      <tr>
        <td id="L1673" data-line-number="1673"></td>
        <td id="LC1673">            }</td>
      </tr>
      <tr>
        <td id="L1674" data-line-number="1674"></td>
        <td id="LC1674">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L1675" data-line-number="1675"></td>
        <td id="LC1675">            {</td>
      </tr>
      <tr>
        <td id="L1676" data-line-number="1676"></td>
        <td id="LC1676">                <span><span>//</span> SNI error. Replace the entire message</span></td>
      </tr>
      <tr>
        <td id="L1677" data-line-number="1677"></td>
        <td id="LC1677">                <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1678" data-line-number="1678"></td>
        <td id="LC1678">                <span>errorMessage</span> <span>=</span> <span>SQL</span>.<span>GetSNIErrorMessage</span>((<span>int</span>)<span>sniError</span>.<span>sniError</span>);</td>
      </tr>
      <tr>
        <td id="L1679" data-line-number="1679"></td>
        <td id="LC1679">
</td>
      </tr>
      <tr>
        <td id="L1680" data-line-number="1680"></td>
        <td id="LC1680">                <span><span>//</span> If its a LocalDB error, then nativeError actually contains a LocalDB-specific error code, not a win32 error code</span></td>
      </tr>
      <tr>
        <td id="L1681" data-line-number="1681"></td>
        <td id="LC1681">                <span>if</span> (<span>sniError</span>.<span>sniError</span> <span>==</span> (<span>int</span>)<span>SNINativeMethodWrapper</span>.<span>SniSpecialErrors</span>.<span>LocalDBErrorCode</span>)</td>
      </tr>
      <tr>
        <td id="L1682" data-line-number="1682"></td>
        <td id="LC1682">                {</td>
      </tr>
      <tr>
        <td id="L1683" data-line-number="1683"></td>
        <td id="LC1683">                    <span>errorMessage</span> <span>+=</span> <span>LocalDBAPI</span>.<span>GetLocalDBMessage</span>((<span>int</span>)<span>sniError</span>.<span>nativeError</span>);</td>
      </tr>
      <tr>
        <td id="L1684" data-line-number="1684"></td>
        <td id="LC1684">                    <span>win32ErrorCode</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1685" data-line-number="1685"></td>
        <td id="LC1685">                }</td>
      </tr>
      <tr>
        <td id="L1686" data-line-number="1686"></td>
        <td id="LC1686">            }</td>
      </tr>
      <tr>
        <td id="L1687" data-line-number="1687"></td>
        <td id="LC1687">            <span>errorMessage</span> <span>=</span> <span>string</span>.<span>Format</span>(<span><span>"</span>{0} (provider: {1}, error: {2} - {3})<span>"</span></span>,</td>
      </tr>
      <tr>
        <td id="L1688" data-line-number="1688"></td>
        <td id="LC1688">                <span>sqlContextInfo</span>, <span>providerName</span>, (<span>int</span>)<span>sniError</span>.<span>sniError</span>, <span>errorMessage</span>);</td>
      </tr>
      <tr>
        <td id="L1689" data-line-number="1689"></td>
        <td id="LC1689">
</td>
      </tr>
      <tr>
        <td id="L1690" data-line-number="1690"></td>
        <td id="LC1690">            <span>return</span> <span>new</span> <span>SqlError</span>((<span>int</span>)<span>sniError</span>.<span>nativeError</span>, <span>0x00</span>, <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>,</td>
      </tr>
      <tr>
        <td id="L1691" data-line-number="1691"></td>
        <td id="LC1691">                                <span>_server</span>, <span>errorMessage</span>, <span>sniError</span>.<span>function</span>, (<span>int</span>)<span>sniError</span>.<span>lineNumber</span>, <span>win32ErrorCode</span>);</td>
      </tr>
      <tr>
        <td id="L1692" data-line-number="1692"></td>
        <td id="LC1692">        }</td>
      </tr>
      <tr>
        <td id="L1693" data-line-number="1693"></td>
        <td id="LC1693">
</td>
      </tr>
      <tr>
        <td id="L1694" data-line-number="1694"></td>
        <td id="LC1694">        <span>internal</span> <span>void</span> <span>CheckResetConnection</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1695" data-line-number="1695"></td>
        <td id="LC1695">        {</td>
      </tr>
      <tr>
        <td id="L1696" data-line-number="1696"></td>
        <td id="LC1696">            <span>if</span> (<span>_fResetConnection</span> <span>&amp;&amp;</span> <span>!</span><span>stateObj</span>.<span>_fResetConnectionSent</span>)</td>
      </tr>
      <tr>
        <td id="L1697" data-line-number="1697"></td>
        <td id="LC1697">            {</td>
      </tr>
      <tr>
        <td id="L1698" data-line-number="1698"></td>
        <td id="LC1698">                <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_outputPacketNumber</span> <span>==</span> <span>1</span> <span>||</span> <span>stateObj</span>.<span>_outputPacketNumber</span> <span>==</span> <span>2</span>, <span><span>"</span>In ResetConnection logic unexpectedly!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1699" data-line-number="1699"></td>
        <td id="LC1699">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L1700" data-line-number="1700"></td>
        <td id="LC1700">                {</td>
      </tr>
      <tr>
        <td id="L1701" data-line-number="1701"></td>
        <td id="LC1701">                    <span>if</span> (<span>_fMARS</span> <span>&amp;&amp;</span> <span>!</span><span>stateObj</span>.<span>_fResetEventOwned</span>)</td>
      </tr>
      <tr>
        <td id="L1702" data-line-number="1702"></td>
        <td id="LC1702">                    {</td>
      </tr>
      <tr>
        <td id="L1703" data-line-number="1703"></td>
        <td id="LC1703">                        <span><span>//</span> If using Async &amp; MARS and we do not own ResetEvent - grab it.  We need to not grab lock here</span></td>
      </tr>
      <tr>
        <td id="L1704" data-line-number="1704"></td>
        <td id="LC1704">                        <span><span>//</span> for case where multiple packets are sent to server from one execute.</span></td>
      </tr>
      <tr>
        <td id="L1705" data-line-number="1705"></td>
        <td id="LC1705">                        <span>stateObj</span>.<span>_fResetEventOwned</span> <span>=</span> <span>_resetConnectionEvent</span>.<span>WaitOne</span>(<span>stateObj</span>.<span>GetTimeoutRemaining</span>(), <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L1706" data-line-number="1706"></td>
        <td id="LC1706">
</td>
      </tr>
      <tr>
        <td id="L1707" data-line-number="1707"></td>
        <td id="LC1707">                        <span>if</span> (<span>stateObj</span>.<span>_fResetEventOwned</span>)</td>
      </tr>
      <tr>
        <td id="L1708" data-line-number="1708"></td>
        <td id="LC1708">                        {</td>
      </tr>
      <tr>
        <td id="L1709" data-line-number="1709"></td>
        <td id="LC1709">                            <span>if</span> (<span>stateObj</span>.<span>TimeoutHasExpired</span>)</td>
      </tr>
      <tr>
        <td id="L1710" data-line-number="1710"></td>
        <td id="LC1710">                            {</td>
      </tr>
      <tr>
        <td id="L1711" data-line-number="1711"></td>
        <td id="LC1711">                                <span><span>//</span> We didn't timeout on the WaitOne, but we timed out by the time we decremented stateObj._timeRemaining.</span></td>
      </tr>
      <tr>
        <td id="L1712" data-line-number="1712"></td>
        <td id="LC1712">                                <span>stateObj</span>.<span>_fResetEventOwned</span> <span>=</span> <span>!</span><span>_resetConnectionEvent</span>.<span>Set</span>();</td>
      </tr>
      <tr>
        <td id="L1713" data-line-number="1713"></td>
        <td id="LC1713">                                <span>stateObj</span>.<span>TimeoutTime</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1714" data-line-number="1714"></td>
        <td id="LC1714">                            }</td>
      </tr>
      <tr>
        <td id="L1715" data-line-number="1715"></td>
        <td id="LC1715">                        }</td>
      </tr>
      <tr>
        <td id="L1716" data-line-number="1716"></td>
        <td id="LC1716">
</td>
      </tr>
      <tr>
        <td id="L1717" data-line-number="1717"></td>
        <td id="LC1717">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>_fResetEventOwned</span>)</td>
      </tr>
      <tr>
        <td id="L1718" data-line-number="1718"></td>
        <td id="LC1718">                        {</td>
      </tr>
      <tr>
        <td id="L1719" data-line-number="1719"></td>
        <td id="LC1719">                            <span><span>//</span> We timed out waiting for ResetEvent.  Throw timeout exception and reset</span></td>
      </tr>
      <tr>
        <td id="L1720" data-line-number="1720"></td>
        <td id="LC1720">                            <span><span>//</span> the buffer.  Nothing else to do since we did not actually send anything</span></td>
      </tr>
      <tr>
        <td id="L1721" data-line-number="1721"></td>
        <td id="LC1721">                            <span><span>//</span> to the server.</span></td>
      </tr>
      <tr>
        <td id="L1722" data-line-number="1722"></td>
        <td id="LC1722">                            <span>stateObj</span>.<span>ResetBuffer</span>();</td>
      </tr>
      <tr>
        <td id="L1723" data-line-number="1723"></td>
        <td id="LC1723">                            <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span> <span>!=</span> <span>null</span>, <span><span>"</span>SqlConnectionInternalTds handler can not be null at this point.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1724" data-line-number="1724"></td>
        <td id="LC1724">                            <span>stateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>TdsEnums</span>.<span>TIMEOUT_EXPIRED</span>, (<span>byte</span>)<span>0x00</span>, <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>, <span>_server</span>, <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>GetErrorMessage</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>, <span>TdsEnums</span>.<span>SNI_WAIT_TIMEOUT</span>));</td>
      </tr>
      <tr>
        <td id="L1725" data-line-number="1725"></td>
        <td id="LC1725">                            <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span>.<span>_parserLock</span>.<span>ThreadMayHaveLock</span>(), <span><span>"</span>Thread is writing without taking the connection lock<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1726" data-line-number="1726"></td>
        <td id="LC1726">                            <span>ThrowExceptionAndWarning</span>(<span>stateObj</span>, <span>callerHasConnectionLock</span>: <span>true</span>);</td>
      </tr>
      <tr>
        <td id="L1727" data-line-number="1727"></td>
        <td id="LC1727">                        }</td>
      </tr>
      <tr>
        <td id="L1728" data-line-number="1728"></td>
        <td id="LC1728">                    }</td>
      </tr>
      <tr>
        <td id="L1729" data-line-number="1729"></td>
        <td id="LC1729">
</td>
      </tr>
      <tr>
        <td id="L1730" data-line-number="1730"></td>
        <td id="LC1730">                    <span>if</span> (<span>_fResetConnection</span>)</td>
      </tr>
      <tr>
        <td id="L1731" data-line-number="1731"></td>
        <td id="LC1731">                    {</td>
      </tr>
      <tr>
        <td id="L1732" data-line-number="1732"></td>
        <td id="LC1732">                        <span><span>//</span> Check again to see if we need to send reset.</span></td>
      </tr>
      <tr>
        <td id="L1733" data-line-number="1733"></td>
        <td id="LC1733">
</td>
      </tr>
      <tr>
        <td id="L1734" data-line-number="1734"></td>
        <td id="LC1734">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>stateObj</span>.<span>_fResetConnectionSent</span>, <span><span>"</span>Unexpected state for sending reset connection<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1735" data-line-number="1735"></td>
        <td id="LC1735">                        <span>Debug</span>.<span>Assert</span>(<span>_isShiloh</span>, <span><span>"</span>TdsParser.cs: Error!  _fResetConnection true when not going against Shiloh or later!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1736" data-line-number="1736"></td>
        <td id="LC1736">
</td>
      </tr>
      <tr>
        <td id="L1737" data-line-number="1737"></td>
        <td id="LC1737">                        <span>if</span> (<span>_fPreserveTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L1738" data-line-number="1738"></td>
        <td id="LC1738">                        {</td>
      </tr>
      <tr>
        <td id="L1739" data-line-number="1739"></td>
        <td id="LC1739">                            <span><span>//</span> if we are reseting, set bit in header by or'ing with other value</span></td>
      </tr>
      <tr>
        <td id="L1740" data-line-number="1740"></td>
        <td id="LC1740">                            <span>stateObj</span>.<span>_outBuff</span>[<span>1</span>] <span>=</span> (<span>Byte</span>)(<span>stateObj</span>.<span>_outBuff</span>[<span>1</span>] <span>|</span> <span>TdsEnums</span>.<span>ST_RESET_CONNECTION_PRESERVE_TRANSACTION</span>);</td>
      </tr>
      <tr>
        <td id="L1741" data-line-number="1741"></td>
        <td id="LC1741">                        }</td>
      </tr>
      <tr>
        <td id="L1742" data-line-number="1742"></td>
        <td id="LC1742">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L1743" data-line-number="1743"></td>
        <td id="LC1743">                        {</td>
      </tr>
      <tr>
        <td id="L1744" data-line-number="1744"></td>
        <td id="LC1744">                            <span><span>//</span> if we are reseting, set bit in header by or'ing with other value</span></td>
      </tr>
      <tr>
        <td id="L1745" data-line-number="1745"></td>
        <td id="LC1745">                            <span>stateObj</span>.<span>_outBuff</span>[<span>1</span>] <span>=</span> (<span>Byte</span>)(<span>stateObj</span>.<span>_outBuff</span>[<span>1</span>] <span>|</span> <span>TdsEnums</span>.<span>ST_RESET_CONNECTION</span>);</td>
      </tr>
      <tr>
        <td id="L1746" data-line-number="1746"></td>
        <td id="LC1746">                        }</td>
      </tr>
      <tr>
        <td id="L1747" data-line-number="1747"></td>
        <td id="LC1747">
</td>
      </tr>
      <tr>
        <td id="L1748" data-line-number="1748"></td>
        <td id="LC1748">                        <span>if</span> (<span>!</span><span>_fMARS</span>)</td>
      </tr>
      <tr>
        <td id="L1749" data-line-number="1749"></td>
        <td id="LC1749">                        {</td>
      </tr>
      <tr>
        <td id="L1750" data-line-number="1750"></td>
        <td id="LC1750">                            <span>_fResetConnection</span> <span>=</span> <span>false</span>; <span><span>//</span> If not MARS, can turn off flag now.</span></td>
      </tr>
      <tr>
        <td id="L1751" data-line-number="1751"></td>
        <td id="LC1751">                            <span>_fPreserveTransaction</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1752" data-line-number="1752"></td>
        <td id="LC1752">                        }</td>
      </tr>
      <tr>
        <td id="L1753" data-line-number="1753"></td>
        <td id="LC1753">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L1754" data-line-number="1754"></td>
        <td id="LC1754">                        {</td>
      </tr>
      <tr>
        <td id="L1755" data-line-number="1755"></td>
        <td id="LC1755">                            <span>stateObj</span>.<span>_fResetConnectionSent</span> <span>=</span> <span>true</span>; <span><span>//</span> Otherwise set flag so we don't resend on multiple packet execute.</span></td>
      </tr>
      <tr>
        <td id="L1756" data-line-number="1756"></td>
        <td id="LC1756">                        }</td>
      </tr>
      <tr>
        <td id="L1757" data-line-number="1757"></td>
        <td id="LC1757">                    }</td>
      </tr>
      <tr>
        <td id="L1758" data-line-number="1758"></td>
        <td id="LC1758">                    <span>else</span> <span>if</span> (<span>_fMARS</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_fResetEventOwned</span>)</td>
      </tr>
      <tr>
        <td id="L1759" data-line-number="1759"></td>
        <td id="LC1759">                    {</td>
      </tr>
      <tr>
        <td id="L1760" data-line-number="1760"></td>
        <td id="LC1760">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>stateObj</span>.<span>_fResetConnectionSent</span>, <span><span>"</span>Unexpected state on WritePacket ResetConnection<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1761" data-line-number="1761"></td>
        <td id="LC1761">
</td>
      </tr>
      <tr>
        <td id="L1762" data-line-number="1762"></td>
        <td id="LC1762">                        <span><span>//</span> Otherwise if Yukon and we grabbed the event, free it.  Another execute grabbed the event and</span></td>
      </tr>
      <tr>
        <td id="L1763" data-line-number="1763"></td>
        <td id="LC1763">                        <span><span>//</span> took care of sending the reset.</span></td>
      </tr>
      <tr>
        <td id="L1764" data-line-number="1764"></td>
        <td id="LC1764">                        <span>stateObj</span>.<span>_fResetEventOwned</span> <span>=</span> <span>!</span><span>_resetConnectionEvent</span>.<span>Set</span>();</td>
      </tr>
      <tr>
        <td id="L1765" data-line-number="1765"></td>
        <td id="LC1765">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>stateObj</span>.<span>_fResetEventOwned</span>, <span><span>"</span>Invalid AutoResetEvent state!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1766" data-line-number="1766"></td>
        <td id="LC1766">                    }</td>
      </tr>
      <tr>
        <td id="L1767" data-line-number="1767"></td>
        <td id="LC1767">                }</td>
      </tr>
      <tr>
        <td id="L1768" data-line-number="1768"></td>
        <td id="LC1768">                <span>catch</span> (<span>Exception</span>)</td>
      </tr>
      <tr>
        <td id="L1769" data-line-number="1769"></td>
        <td id="LC1769">                {</td>
      </tr>
      <tr>
        <td id="L1770" data-line-number="1770"></td>
        <td id="LC1770">                    <span>if</span> (<span>_fMARS</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_fResetEventOwned</span>)</td>
      </tr>
      <tr>
        <td id="L1771" data-line-number="1771"></td>
        <td id="LC1771">                    {</td>
      </tr>
      <tr>
        <td id="L1772" data-line-number="1772"></td>
        <td id="LC1772">                        <span><span>//</span> If exception thrown, and we are on Yukon and own the event, release it!</span></td>
      </tr>
      <tr>
        <td id="L1773" data-line-number="1773"></td>
        <td id="LC1773">                        <span>stateObj</span>.<span>_fResetConnectionSent</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L1774" data-line-number="1774"></td>
        <td id="LC1774">                        <span>stateObj</span>.<span>_fResetEventOwned</span> <span>=</span> <span>!</span><span>_resetConnectionEvent</span>.<span>Set</span>();</td>
      </tr>
      <tr>
        <td id="L1775" data-line-number="1775"></td>
        <td id="LC1775">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>stateObj</span>.<span>_fResetEventOwned</span>, <span><span>"</span>Invalid AutoResetEvent state!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1776" data-line-number="1776"></td>
        <td id="LC1776">                    }</td>
      </tr>
      <tr>
        <td id="L1777" data-line-number="1777"></td>
        <td id="LC1777">
</td>
      </tr>
      <tr>
        <td id="L1778" data-line-number="1778"></td>
        <td id="LC1778">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L1779" data-line-number="1779"></td>
        <td id="LC1779">                }</td>
      </tr>
      <tr>
        <td id="L1780" data-line-number="1780"></td>
        <td id="LC1780">            }</td>
      </tr>
      <tr>
        <td id="L1781" data-line-number="1781"></td>
        <td id="LC1781">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L1782" data-line-number="1782"></td>
        <td id="LC1782">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L1783" data-line-number="1783"></td>
        <td id="LC1783">            {</td>
      </tr>
      <tr>
        <td id="L1784" data-line-number="1784"></td>
        <td id="LC1784">                <span>Debug</span>.<span>Assert</span>(<span>!</span><span>_fResetConnection</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L1785" data-line-number="1785"></td>
        <td id="LC1785">                             (<span>_fResetConnection</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_fResetConnectionSent</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_fResetEventOwned</span>),</td>
      </tr>
      <tr>
        <td id="L1786" data-line-number="1786"></td>
        <td id="LC1786">                             <span><span>"</span>Unexpected state on else ResetConnection block in WritePacket<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1787" data-line-number="1787"></td>
        <td id="LC1787">            }</td>
      </tr>
      <tr>
        <td id="L1788" data-line-number="1788"></td>
        <td id="LC1788">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L1789" data-line-number="1789"></td>
        <td id="LC1789">        }</td>
      </tr>
      <tr>
        <td id="L1790" data-line-number="1790"></td>
        <td id="LC1790">
</td>
      </tr>
      <tr>
        <td id="L1791" data-line-number="1791"></td>
        <td id="LC1791">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1792" data-line-number="1792"></td>
        <td id="LC1792">        <span><span>//</span> Takes a 16 bit short and writes it.</span></td>
      </tr>
      <tr>
        <td id="L1793" data-line-number="1793"></td>
        <td id="LC1793">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1794" data-line-number="1794"></td>
        <td id="LC1794">        <span>internal</span> <span>byte</span>[] <span>SerializeShort</span>(<span>int</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1795" data-line-number="1795"></td>
        <td id="LC1795">        {</td>
      </tr>
      <tr>
        <td id="L1796" data-line-number="1796"></td>
        <td id="LC1796">            <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bShortBytes</span>)</td>
      </tr>
      <tr>
        <td id="L1797" data-line-number="1797"></td>
        <td id="LC1797">            {</td>
      </tr>
      <tr>
        <td id="L1798" data-line-number="1798"></td>
        <td id="LC1798">                <span>stateObj</span>.<span>_bShortBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>2</span>];</td>
      </tr>
      <tr>
        <td id="L1799" data-line-number="1799"></td>
        <td id="LC1799">            }</td>
      </tr>
      <tr>
        <td id="L1800" data-line-number="1800"></td>
        <td id="LC1800">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L1801" data-line-number="1801"></td>
        <td id="LC1801">            {</td>
      </tr>
      <tr>
        <td id="L1802" data-line-number="1802"></td>
        <td id="LC1802">                <span>Debug</span>.<span>Assert</span>(<span>2</span> <span>==</span> <span>stateObj</span>.<span>_bShortBytes</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L1803" data-line-number="1803"></td>
        <td id="LC1803">            }</td>
      </tr>
      <tr>
        <td id="L1804" data-line-number="1804"></td>
        <td id="LC1804">
</td>
      </tr>
      <tr>
        <td id="L1805" data-line-number="1805"></td>
        <td id="LC1805">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>stateObj</span>.<span>_bShortBytes</span>;</td>
      </tr>
      <tr>
        <td id="L1806" data-line-number="1806"></td>
        <td id="LC1806">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1807" data-line-number="1807"></td>
        <td id="LC1807">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>v</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1808" data-line-number="1808"></td>
        <td id="LC1808">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1809" data-line-number="1809"></td>
        <td id="LC1809">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L1810" data-line-number="1810"></td>
        <td id="LC1810">        }</td>
      </tr>
      <tr>
        <td id="L1811" data-line-number="1811"></td>
        <td id="LC1811">
</td>
      </tr>
      <tr>
        <td id="L1812" data-line-number="1812"></td>
        <td id="LC1812">        <span>internal</span> <span>void</span> <span>WriteShort</span>(<span>int</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1813" data-line-number="1813"></td>
        <td id="LC1813">        {</td>
      </tr>
      <tr>
        <td id="L1814" data-line-number="1814"></td>
        <td id="LC1814">            <span>ReliabilitySection</span>.<span>Assert</span>(<span><span>"</span>unreliable call to WriteShort<span>"</span></span>);  <span><span>//</span> you need to setup for a thread abort somewhere before you call this method</span></td>
      </tr>
      <tr>
        <td id="L1815" data-line-number="1815"></td>
        <td id="LC1815">
</td>
      </tr>
      <tr>
        <td id="L1816" data-line-number="1816"></td>
        <td id="LC1816">            <span>if</span> ((<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>2</span>) <span>&gt;</span> <span>stateObj</span>.<span>_outBuff</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L1817" data-line-number="1817"></td>
        <td id="LC1817">            {</td>
      </tr>
      <tr>
        <td id="L1818" data-line-number="1818"></td>
        <td id="LC1818">                <span><span>//</span> if all of the short doesn't fit into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1819" data-line-number="1819"></td>
        <td id="LC1819">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>v</span> <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L1820" data-line-number="1820"></td>
        <td id="LC1820">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L1821" data-line-number="1821"></td>
        <td id="LC1821">            }</td>
      </tr>
      <tr>
        <td id="L1822" data-line-number="1822"></td>
        <td id="LC1822">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L1823" data-line-number="1823"></td>
        <td id="LC1823">            {</td>
      </tr>
      <tr>
        <td id="L1824" data-line-number="1824"></td>
        <td id="LC1824">                <span><span>//</span> all of the short fits into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1825" data-line-number="1825"></td>
        <td id="LC1825">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span>] <span>=</span> (<span>byte</span>)(<span>v</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1826" data-line-number="1826"></td>
        <td id="LC1826">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>1</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1827" data-line-number="1827"></td>
        <td id="LC1827">                <span>stateObj</span>.<span>_outBytesUsed</span> <span>+=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L1828" data-line-number="1828"></td>
        <td id="LC1828">            }</td>
      </tr>
      <tr>
        <td id="L1829" data-line-number="1829"></td>
        <td id="LC1829">        }</td>
      </tr>
      <tr>
        <td id="L1830" data-line-number="1830"></td>
        <td id="LC1830">
</td>
      </tr>
      <tr>
        <td id="L1831" data-line-number="1831"></td>
        <td id="LC1831">        <span>internal</span> <span>void</span> <span>WriteUnsignedShort</span>(<span>ushort</span> <span>us</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1832" data-line-number="1832"></td>
        <td id="LC1832">        {</td>
      </tr>
      <tr>
        <td id="L1833" data-line-number="1833"></td>
        <td id="LC1833">            <span>WriteShort</span>((<span>short</span>)<span>us</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1834" data-line-number="1834"></td>
        <td id="LC1834">        }</td>
      </tr>
      <tr>
        <td id="L1835" data-line-number="1835"></td>
        <td id="LC1835">
</td>
      </tr>
      <tr>
        <td id="L1836" data-line-number="1836"></td>
        <td id="LC1836">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1837" data-line-number="1837"></td>
        <td id="LC1837">        <span><span>//</span> Takes a long and writes out an unsigned int</span></td>
      </tr>
      <tr>
        <td id="L1838" data-line-number="1838"></td>
        <td id="LC1838">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1839" data-line-number="1839"></td>
        <td id="LC1839">        <span>internal</span> <span>byte</span>[] <span>SerializeUnsignedInt</span>(<span>uint</span> <span>i</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1840" data-line-number="1840"></td>
        <td id="LC1840">        {</td>
      </tr>
      <tr>
        <td id="L1841" data-line-number="1841"></td>
        <td id="LC1841">            <span>return</span> <span>SerializeInt</span>((<span>int</span>)<span>i</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1842" data-line-number="1842"></td>
        <td id="LC1842">        }</td>
      </tr>
      <tr>
        <td id="L1843" data-line-number="1843"></td>
        <td id="LC1843">
</td>
      </tr>
      <tr>
        <td id="L1844" data-line-number="1844"></td>
        <td id="LC1844">        <span>internal</span> <span>void</span> <span>WriteUnsignedInt</span>(<span>uint</span> <span>i</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1845" data-line-number="1845"></td>
        <td id="LC1845">        {</td>
      </tr>
      <tr>
        <td id="L1846" data-line-number="1846"></td>
        <td id="LC1846">            <span>WriteInt</span>((<span>int</span>)<span>i</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L1847" data-line-number="1847"></td>
        <td id="LC1847">        }</td>
      </tr>
      <tr>
        <td id="L1848" data-line-number="1848"></td>
        <td id="LC1848">
</td>
      </tr>
      <tr>
        <td id="L1849" data-line-number="1849"></td>
        <td id="LC1849">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1850" data-line-number="1850"></td>
        <td id="LC1850">        <span><span>//</span> Takes an int and writes it as an int.</span></td>
      </tr>
      <tr>
        <td id="L1851" data-line-number="1851"></td>
        <td id="LC1851">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1852" data-line-number="1852"></td>
        <td id="LC1852">        <span>internal</span> <span>byte</span>[] <span>SerializeInt</span>(<span>int</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1853" data-line-number="1853"></td>
        <td id="LC1853">        {</td>
      </tr>
      <tr>
        <td id="L1854" data-line-number="1854"></td>
        <td id="LC1854">            <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bIntBytes</span>)</td>
      </tr>
      <tr>
        <td id="L1855" data-line-number="1855"></td>
        <td id="LC1855">            {</td>
      </tr>
      <tr>
        <td id="L1856" data-line-number="1856"></td>
        <td id="LC1856">                <span>stateObj</span>.<span>_bIntBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>4</span>];</td>
      </tr>
      <tr>
        <td id="L1857" data-line-number="1857"></td>
        <td id="LC1857">            }</td>
      </tr>
      <tr>
        <td id="L1858" data-line-number="1858"></td>
        <td id="LC1858">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L1859" data-line-number="1859"></td>
        <td id="LC1859">            {</td>
      </tr>
      <tr>
        <td id="L1860" data-line-number="1860"></td>
        <td id="LC1860">                <span>Debug</span>.<span>Assert</span>(<span>4</span> <span>==</span> <span>stateObj</span>.<span>_bIntBytes</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L1861" data-line-number="1861"></td>
        <td id="LC1861">            }</td>
      </tr>
      <tr>
        <td id="L1862" data-line-number="1862"></td>
        <td id="LC1862">
</td>
      </tr>
      <tr>
        <td id="L1863" data-line-number="1863"></td>
        <td id="LC1863">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1864" data-line-number="1864"></td>
        <td id="LC1864">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>stateObj</span>.<span>_bIntBytes</span>;</td>
      </tr>
      <tr>
        <td id="L1865" data-line-number="1865"></td>
        <td id="LC1865">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>v</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1866" data-line-number="1866"></td>
        <td id="LC1866">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1867" data-line-number="1867"></td>
        <td id="LC1867">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>16</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1868" data-line-number="1868"></td>
        <td id="LC1868">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>24</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1869" data-line-number="1869"></td>
        <td id="LC1869">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L1870" data-line-number="1870"></td>
        <td id="LC1870">        }</td>
      </tr>
      <tr>
        <td id="L1871" data-line-number="1871"></td>
        <td id="LC1871">
</td>
      </tr>
      <tr>
        <td id="L1872" data-line-number="1872"></td>
        <td id="LC1872">        <span>internal</span> <span>void</span> <span>WriteInt</span>(<span>int</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1873" data-line-number="1873"></td>
        <td id="LC1873">        {</td>
      </tr>
      <tr>
        <td id="L1874" data-line-number="1874"></td>
        <td id="LC1874">            <span>ReliabilitySection</span>.<span>Assert</span>(<span><span>"</span>unreliable call to WriteInt<span>"</span></span>);  <span><span>//</span> you need to setup for a thread abort somewhere before you call this method</span></td>
      </tr>
      <tr>
        <td id="L1875" data-line-number="1875"></td>
        <td id="LC1875">
</td>
      </tr>
      <tr>
        <td id="L1876" data-line-number="1876"></td>
        <td id="LC1876">            <span>if</span> ((<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>4</span>) <span>&gt;</span> <span>stateObj</span>.<span>_outBuff</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L1877" data-line-number="1877"></td>
        <td id="LC1877">            {</td>
      </tr>
      <tr>
        <td id="L1878" data-line-number="1878"></td>
        <td id="LC1878">                <span><span>//</span> if all of the int doesn't fit into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1879" data-line-number="1879"></td>
        <td id="LC1879">                <span>for</span> (<span>int</span> <span>shiftValue</span> <span>=</span> <span>0</span>; <span>shiftValue</span> <span>&lt;</span> <span>sizeof</span>(<span>int</span>) <span>*</span> <span>8</span>; <span>shiftValue</span> <span>+=</span> <span>8</span>)</td>
      </tr>
      <tr>
        <td id="L1880" data-line-number="1880"></td>
        <td id="LC1880">                {</td>
      </tr>
      <tr>
        <td id="L1881" data-line-number="1881"></td>
        <td id="LC1881">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>shiftValue</span>) <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L1882" data-line-number="1882"></td>
        <td id="LC1882">                }</td>
      </tr>
      <tr>
        <td id="L1883" data-line-number="1883"></td>
        <td id="LC1883">            }</td>
      </tr>
      <tr>
        <td id="L1884" data-line-number="1884"></td>
        <td id="LC1884">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L1885" data-line-number="1885"></td>
        <td id="LC1885">            {</td>
      </tr>
      <tr>
        <td id="L1886" data-line-number="1886"></td>
        <td id="LC1886">                <span><span>//</span> all of the int fits into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1887" data-line-number="1887"></td>
        <td id="LC1887">                <span><span>//</span> NOTE: We don't use a loop here for performance</span></td>
      </tr>
      <tr>
        <td id="L1888" data-line-number="1888"></td>
        <td id="LC1888">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span>] <span>=</span> (<span>byte</span>)(<span>v</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1889" data-line-number="1889"></td>
        <td id="LC1889">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>1</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1890" data-line-number="1890"></td>
        <td id="LC1890">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>2</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>16</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1891" data-line-number="1891"></td>
        <td id="LC1891">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>3</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>24</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1892" data-line-number="1892"></td>
        <td id="LC1892">                <span>stateObj</span>.<span>_outBytesUsed</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L1893" data-line-number="1893"></td>
        <td id="LC1893">            }</td>
      </tr>
      <tr>
        <td id="L1894" data-line-number="1894"></td>
        <td id="LC1894">        }</td>
      </tr>
      <tr>
        <td id="L1895" data-line-number="1895"></td>
        <td id="LC1895">
</td>
      </tr>
      <tr>
        <td id="L1896" data-line-number="1896"></td>
        <td id="LC1896">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1897" data-line-number="1897"></td>
        <td id="LC1897">        <span><span>//</span> Takes a float and writes it as a 32 bit float.</span></td>
      </tr>
      <tr>
        <td id="L1898" data-line-number="1898"></td>
        <td id="LC1898">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1899" data-line-number="1899"></td>
        <td id="LC1899">        <span>internal</span> <span>byte</span>[] <span>SerializeFloat</span>(<span>float</span> <span>v</span>)</td>
      </tr>
      <tr>
        <td id="L1900" data-line-number="1900"></td>
        <td id="LC1900">        {</td>
      </tr>
      <tr>
        <td id="L1901" data-line-number="1901"></td>
        <td id="LC1901">            <span>if</span> (<span>Single</span>.<span>IsInfinity</span>(<span>v</span>) <span>||</span> <span>Single</span>.<span>IsNaN</span>(<span>v</span>))</td>
      </tr>
      <tr>
        <td id="L1902" data-line-number="1902"></td>
        <td id="LC1902">            {</td>
      </tr>
      <tr>
        <td id="L1903" data-line-number="1903"></td>
        <td id="LC1903">                <span>throw</span> <span>ADP</span>.<span>ParameterValueOutOfRange</span>(<span>v</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L1904" data-line-number="1904"></td>
        <td id="LC1904">            }</td>
      </tr>
      <tr>
        <td id="L1905" data-line-number="1905"></td>
        <td id="LC1905">
</td>
      </tr>
      <tr>
        <td id="L1906" data-line-number="1906"></td>
        <td id="LC1906">            <span>return</span> <span>BitConverter</span>.<span>GetBytes</span>(<span>v</span>);</td>
      </tr>
      <tr>
        <td id="L1907" data-line-number="1907"></td>
        <td id="LC1907">        }</td>
      </tr>
      <tr>
        <td id="L1908" data-line-number="1908"></td>
        <td id="LC1908">
</td>
      </tr>
      <tr>
        <td id="L1909" data-line-number="1909"></td>
        <td id="LC1909">        <span>internal</span> <span>void</span> <span>WriteFloat</span>(<span>float</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1910" data-line-number="1910"></td>
        <td id="LC1910">        {</td>
      </tr>
      <tr>
        <td id="L1911" data-line-number="1911"></td>
        <td id="LC1911">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>BitConverter</span>.<span>GetBytes</span>(<span>v</span>);</td>
      </tr>
      <tr>
        <td id="L1912" data-line-number="1912"></td>
        <td id="LC1912">
</td>
      </tr>
      <tr>
        <td id="L1913" data-line-number="1913"></td>
        <td id="LC1913">            <span>stateObj</span>.<span>WriteByteArray</span>(<span>bytes</span>, <span>bytes</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L1914" data-line-number="1914"></td>
        <td id="LC1914">        }</td>
      </tr>
      <tr>
        <td id="L1915" data-line-number="1915"></td>
        <td id="LC1915">
</td>
      </tr>
      <tr>
        <td id="L1916" data-line-number="1916"></td>
        <td id="LC1916">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1917" data-line-number="1917"></td>
        <td id="LC1917">        <span><span>//</span> Takes a long and writes it as a long.</span></td>
      </tr>
      <tr>
        <td id="L1918" data-line-number="1918"></td>
        <td id="LC1918">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1919" data-line-number="1919"></td>
        <td id="LC1919">        <span>internal</span> <span>byte</span>[] <span>SerializeLong</span>(<span>long</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1920" data-line-number="1920"></td>
        <td id="LC1920">        {</td>
      </tr>
      <tr>
        <td id="L1921" data-line-number="1921"></td>
        <td id="LC1921">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L1922" data-line-number="1922"></td>
        <td id="LC1922">            <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bLongBytes</span>)</td>
      </tr>
      <tr>
        <td id="L1923" data-line-number="1923"></td>
        <td id="LC1923">            {</td>
      </tr>
      <tr>
        <td id="L1924" data-line-number="1924"></td>
        <td id="LC1924">                <span>stateObj</span>.<span>_bLongBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>8</span>];</td>
      </tr>
      <tr>
        <td id="L1925" data-line-number="1925"></td>
        <td id="LC1925">            }</td>
      </tr>
      <tr>
        <td id="L1926" data-line-number="1926"></td>
        <td id="LC1926">
</td>
      </tr>
      <tr>
        <td id="L1927" data-line-number="1927"></td>
        <td id="LC1927">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>stateObj</span>.<span>_bLongBytes</span>;</td>
      </tr>
      <tr>
        <td id="L1928" data-line-number="1928"></td>
        <td id="LC1928">            <span>Debug</span>.<span>Assert</span>(<span>8</span> <span>==</span> <span>bytes</span>.<span>Length</span>, <span><span>"</span>Cached buffer has wrong size<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1929" data-line-number="1929"></td>
        <td id="LC1929">
</td>
      </tr>
      <tr>
        <td id="L1930" data-line-number="1930"></td>
        <td id="LC1930">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>v</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1931" data-line-number="1931"></td>
        <td id="LC1931">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1932" data-line-number="1932"></td>
        <td id="LC1932">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>16</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1933" data-line-number="1933"></td>
        <td id="LC1933">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>24</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1934" data-line-number="1934"></td>
        <td id="LC1934">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>32</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1935" data-line-number="1935"></td>
        <td id="LC1935">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>40</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1936" data-line-number="1936"></td>
        <td id="LC1936">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>48</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1937" data-line-number="1937"></td>
        <td id="LC1937">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>56</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1938" data-line-number="1938"></td>
        <td id="LC1938">
</td>
      </tr>
      <tr>
        <td id="L1939" data-line-number="1939"></td>
        <td id="LC1939">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L1940" data-line-number="1940"></td>
        <td id="LC1940">        }</td>
      </tr>
      <tr>
        <td id="L1941" data-line-number="1941"></td>
        <td id="LC1941">
</td>
      </tr>
      <tr>
        <td id="L1942" data-line-number="1942"></td>
        <td id="LC1942">        <span>internal</span> <span>void</span> <span>WriteLong</span>(<span>long</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1943" data-line-number="1943"></td>
        <td id="LC1943">        {</td>
      </tr>
      <tr>
        <td id="L1944" data-line-number="1944"></td>
        <td id="LC1944">            <span>ReliabilitySection</span>.<span>Assert</span>(<span><span>"</span>unreliable call to WriteLong<span>"</span></span>);  <span><span>//</span> you need to setup for a thread abort somewhere before you call this method</span></td>
      </tr>
      <tr>
        <td id="L1945" data-line-number="1945"></td>
        <td id="LC1945">
</td>
      </tr>
      <tr>
        <td id="L1946" data-line-number="1946"></td>
        <td id="LC1946">            <span>if</span> ((<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>8</span>) <span>&gt;</span> <span>stateObj</span>.<span>_outBuff</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L1947" data-line-number="1947"></td>
        <td id="LC1947">            {</td>
      </tr>
      <tr>
        <td id="L1948" data-line-number="1948"></td>
        <td id="LC1948">                <span><span>//</span> if all of the long doesn't fit into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1949" data-line-number="1949"></td>
        <td id="LC1949">                <span>for</span> (<span>int</span> <span>shiftValue</span> <span>=</span> <span>0</span>; <span>shiftValue</span> <span>&lt;</span> <span>sizeof</span>(<span>long</span>) <span>*</span> <span>8</span>; <span>shiftValue</span> <span>+=</span> <span>8</span>)</td>
      </tr>
      <tr>
        <td id="L1950" data-line-number="1950"></td>
        <td id="LC1950">                {</td>
      </tr>
      <tr>
        <td id="L1951" data-line-number="1951"></td>
        <td id="LC1951">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>shiftValue</span>) <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L1952" data-line-number="1952"></td>
        <td id="LC1952">                }</td>
      </tr>
      <tr>
        <td id="L1953" data-line-number="1953"></td>
        <td id="LC1953">            }</td>
      </tr>
      <tr>
        <td id="L1954" data-line-number="1954"></td>
        <td id="LC1954">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L1955" data-line-number="1955"></td>
        <td id="LC1955">            {</td>
      </tr>
      <tr>
        <td id="L1956" data-line-number="1956"></td>
        <td id="LC1956">                <span><span>//</span> all of the long fits into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1957" data-line-number="1957"></td>
        <td id="LC1957">                <span><span>//</span> NOTE: We don't use a loop here for performance</span></td>
      </tr>
      <tr>
        <td id="L1958" data-line-number="1958"></td>
        <td id="LC1958">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span>] <span>=</span> (<span>byte</span>)(<span>v</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1959" data-line-number="1959"></td>
        <td id="LC1959">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>1</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1960" data-line-number="1960"></td>
        <td id="LC1960">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>2</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>16</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1961" data-line-number="1961"></td>
        <td id="LC1961">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>3</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>24</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1962" data-line-number="1962"></td>
        <td id="LC1962">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>4</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>32</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1963" data-line-number="1963"></td>
        <td id="LC1963">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>5</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>40</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1964" data-line-number="1964"></td>
        <td id="LC1964">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>6</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>48</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1965" data-line-number="1965"></td>
        <td id="LC1965">                <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>7</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>56</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1966" data-line-number="1966"></td>
        <td id="LC1966">                <span>stateObj</span>.<span>_outBytesUsed</span> <span>+=</span> <span>8</span>;</td>
      </tr>
      <tr>
        <td id="L1967" data-line-number="1967"></td>
        <td id="LC1967">            }</td>
      </tr>
      <tr>
        <td id="L1968" data-line-number="1968"></td>
        <td id="LC1968">        }</td>
      </tr>
      <tr>
        <td id="L1969" data-line-number="1969"></td>
        <td id="LC1969">
</td>
      </tr>
      <tr>
        <td id="L1970" data-line-number="1970"></td>
        <td id="LC1970">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1971" data-line-number="1971"></td>
        <td id="LC1971">        <span><span>//</span> Takes a long and writes part of it</span></td>
      </tr>
      <tr>
        <td id="L1972" data-line-number="1972"></td>
        <td id="LC1972">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L1973" data-line-number="1973"></td>
        <td id="LC1973">        <span>internal</span> <span>byte</span>[] <span>SerializePartialLong</span>(<span>long</span> <span>v</span>, <span>int</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L1974" data-line-number="1974"></td>
        <td id="LC1974">        {</td>
      </tr>
      <tr>
        <td id="L1975" data-line-number="1975"></td>
        <td id="LC1975">            <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>&lt;=</span> <span>8</span>, <span><span>"</span>Length specified is longer than the size of a long<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1976" data-line-number="1976"></td>
        <td id="LC1976">            <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>&gt;=</span> <span>0</span>, <span><span>"</span>Length should not be negative<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1977" data-line-number="1977"></td>
        <td id="LC1977">
</td>
      </tr>
      <tr>
        <td id="L1978" data-line-number="1978"></td>
        <td id="LC1978">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L1979" data-line-number="1979"></td>
        <td id="LC1979">
</td>
      </tr>
      <tr>
        <td id="L1980" data-line-number="1980"></td>
        <td id="LC1980">            <span><span>//</span> all of the long fits into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1981" data-line-number="1981"></td>
        <td id="LC1981">            <span>for</span> (<span>int</span> <span>index</span> <span>=</span> <span>0</span>; <span>index</span> <span>&lt;</span> <span>length</span>; <span>index</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L1982" data-line-number="1982"></td>
        <td id="LC1982">            {</td>
      </tr>
      <tr>
        <td id="L1983" data-line-number="1983"></td>
        <td id="LC1983">                <span>bytes</span>[<span>index</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> (<span>index</span> <span>*</span> <span>8</span>)) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L1984" data-line-number="1984"></td>
        <td id="LC1984">            }</td>
      </tr>
      <tr>
        <td id="L1985" data-line-number="1985"></td>
        <td id="LC1985">
</td>
      </tr>
      <tr>
        <td id="L1986" data-line-number="1986"></td>
        <td id="LC1986">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L1987" data-line-number="1987"></td>
        <td id="LC1987">        }</td>
      </tr>
      <tr>
        <td id="L1988" data-line-number="1988"></td>
        <td id="LC1988">
</td>
      </tr>
      <tr>
        <td id="L1989" data-line-number="1989"></td>
        <td id="LC1989">        <span>internal</span> <span>void</span> <span>WritePartialLong</span>(<span>long</span> <span>v</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L1990" data-line-number="1990"></td>
        <td id="LC1990">        {</td>
      </tr>
      <tr>
        <td id="L1991" data-line-number="1991"></td>
        <td id="LC1991">            <span>ReliabilitySection</span>.<span>Assert</span>(<span><span>"</span>unreliable call to WritePartialLong<span>"</span></span>);  <span><span>//</span> you need to setup for a thread abort somewhere before you call this method</span></td>
      </tr>
      <tr>
        <td id="L1992" data-line-number="1992"></td>
        <td id="LC1992">            <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>&lt;=</span> <span>8</span>, <span><span>"</span>Length specified is longer than the size of a long<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1993" data-line-number="1993"></td>
        <td id="LC1993">            <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>&gt;=</span> <span>0</span>, <span><span>"</span>Length should not be negative<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L1994" data-line-number="1994"></td>
        <td id="LC1994">
</td>
      </tr>
      <tr>
        <td id="L1995" data-line-number="1995"></td>
        <td id="LC1995">            <span>if</span> ((<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>length</span>) <span>&gt;</span> <span>stateObj</span>.<span>_outBuff</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L1996" data-line-number="1996"></td>
        <td id="LC1996">            {</td>
      </tr>
      <tr>
        <td id="L1997" data-line-number="1997"></td>
        <td id="LC1997">                <span><span>//</span> if all of the long doesn't fit into the buffer</span></td>
      </tr>
      <tr>
        <td id="L1998" data-line-number="1998"></td>
        <td id="LC1998">                <span>for</span> (<span>int</span> <span>shiftValue</span> <span>=</span> <span>0</span>; <span>shiftValue</span> <span>&lt;</span> <span>length</span> <span>*</span> <span>8</span>; <span>shiftValue</span> <span>+=</span> <span>8</span>)</td>
      </tr>
      <tr>
        <td id="L1999" data-line-number="1999"></td>
        <td id="LC1999">                {</td>
      </tr>
      <tr>
        <td id="L2000" data-line-number="2000"></td>
        <td id="LC2000">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> <span>shiftValue</span>) <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L2001" data-line-number="2001"></td>
        <td id="LC2001">                }</td>
      </tr>
      <tr>
        <td id="L2002" data-line-number="2002"></td>
        <td id="LC2002">            }</td>
      </tr>
      <tr>
        <td id="L2003" data-line-number="2003"></td>
        <td id="LC2003">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2004" data-line-number="2004"></td>
        <td id="LC2004">            {</td>
      </tr>
      <tr>
        <td id="L2005" data-line-number="2005"></td>
        <td id="LC2005">                <span><span>//</span> all of the long fits into the buffer</span></td>
      </tr>
      <tr>
        <td id="L2006" data-line-number="2006"></td>
        <td id="LC2006">                <span>for</span> (<span>int</span> <span>index</span> <span>=</span> <span>0</span>; <span>index</span> <span>&lt;</span> <span>length</span>; <span>index</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L2007" data-line-number="2007"></td>
        <td id="LC2007">                {</td>
      </tr>
      <tr>
        <td id="L2008" data-line-number="2008"></td>
        <td id="LC2008">                    <span>stateObj</span>.<span>_outBuff</span>[<span>stateObj</span>.<span>_outBytesUsed</span> <span>+</span> <span>index</span>] <span>=</span> (<span>byte</span>)((<span>v</span> <span>&gt;&gt;</span> (<span>index</span> <span>*</span> <span>8</span>)) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L2009" data-line-number="2009"></td>
        <td id="LC2009">                }</td>
      </tr>
      <tr>
        <td id="L2010" data-line-number="2010"></td>
        <td id="LC2010">                <span>stateObj</span>.<span>_outBytesUsed</span> <span>+=</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L2011" data-line-number="2011"></td>
        <td id="LC2011">            }</td>
      </tr>
      <tr>
        <td id="L2012" data-line-number="2012"></td>
        <td id="LC2012">        }</td>
      </tr>
      <tr>
        <td id="L2013" data-line-number="2013"></td>
        <td id="LC2013">
</td>
      </tr>
      <tr>
        <td id="L2014" data-line-number="2014"></td>
        <td id="LC2014">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L2015" data-line-number="2015"></td>
        <td id="LC2015">        <span><span>//</span> Takes a ulong and writes it as a ulong.</span></td>
      </tr>
      <tr>
        <td id="L2016" data-line-number="2016"></td>
        <td id="LC2016">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L2017" data-line-number="2017"></td>
        <td id="LC2017">        <span>internal</span> <span>void</span> <span>WriteUnsignedLong</span>(<span>ulong</span> <span>uv</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L2018" data-line-number="2018"></td>
        <td id="LC2018">        {</td>
      </tr>
      <tr>
        <td id="L2019" data-line-number="2019"></td>
        <td id="LC2019">            <span>WriteLong</span>((<span>long</span>)<span>uv</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L2020" data-line-number="2020"></td>
        <td id="LC2020">        }</td>
      </tr>
      <tr>
        <td id="L2021" data-line-number="2021"></td>
        <td id="LC2021">
</td>
      </tr>
      <tr>
        <td id="L2022" data-line-number="2022"></td>
        <td id="LC2022">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L2023" data-line-number="2023"></td>
        <td id="LC2023">        <span><span>//</span> Takes a double and writes it as a 64 bit double.</span></td>
      </tr>
      <tr>
        <td id="L2024" data-line-number="2024"></td>
        <td id="LC2024">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L2025" data-line-number="2025"></td>
        <td id="LC2025">        <span>internal</span> <span>byte</span>[] <span>SerializeDouble</span>(<span>double</span> <span>v</span>)</td>
      </tr>
      <tr>
        <td id="L2026" data-line-number="2026"></td>
        <td id="LC2026">        {</td>
      </tr>
      <tr>
        <td id="L2027" data-line-number="2027"></td>
        <td id="LC2027">            <span>if</span> (<span>Double</span>.<span>IsInfinity</span>(<span>v</span>) <span>||</span> <span>Double</span>.<span>IsNaN</span>(<span>v</span>))</td>
      </tr>
      <tr>
        <td id="L2028" data-line-number="2028"></td>
        <td id="LC2028">            {</td>
      </tr>
      <tr>
        <td id="L2029" data-line-number="2029"></td>
        <td id="LC2029">                <span>throw</span> <span>ADP</span>.<span>ParameterValueOutOfRange</span>(<span>v</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L2030" data-line-number="2030"></td>
        <td id="LC2030">            }</td>
      </tr>
      <tr>
        <td id="L2031" data-line-number="2031"></td>
        <td id="LC2031">
</td>
      </tr>
      <tr>
        <td id="L2032" data-line-number="2032"></td>
        <td id="LC2032">            <span>return</span> <span>BitConverter</span>.<span>GetBytes</span>(<span>v</span>);</td>
      </tr>
      <tr>
        <td id="L2033" data-line-number="2033"></td>
        <td id="LC2033">        }</td>
      </tr>
      <tr>
        <td id="L2034" data-line-number="2034"></td>
        <td id="LC2034">
</td>
      </tr>
      <tr>
        <td id="L2035" data-line-number="2035"></td>
        <td id="LC2035">        <span>internal</span> <span>void</span> <span>WriteDouble</span>(<span>double</span> <span>v</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L2036" data-line-number="2036"></td>
        <td id="LC2036">        {</td>
      </tr>
      <tr>
        <td id="L2037" data-line-number="2037"></td>
        <td id="LC2037">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>BitConverter</span>.<span>GetBytes</span>(<span>v</span>);</td>
      </tr>
      <tr>
        <td id="L2038" data-line-number="2038"></td>
        <td id="LC2038">
</td>
      </tr>
      <tr>
        <td id="L2039" data-line-number="2039"></td>
        <td id="LC2039">            <span>stateObj</span>.<span>WriteByteArray</span>(<span>bytes</span>, <span>bytes</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L2040" data-line-number="2040"></td>
        <td id="LC2040">        }</td>
      </tr>
      <tr>
        <td id="L2041" data-line-number="2041"></td>
        <td id="LC2041">
</td>
      </tr>
      <tr>
        <td id="L2042" data-line-number="2042"></td>
        <td id="LC2042">        <span>internal</span> <span>void</span> <span>PrepareResetConnection</span>(<span>bool</span> <span>preserveTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L2043" data-line-number="2043"></td>
        <td id="LC2043">        {</td>
      </tr>
      <tr>
        <td id="L2044" data-line-number="2044"></td>
        <td id="LC2044">            <span><span>//</span> Set flag to reset connection upon next use - only for use on shiloh!</span></td>
      </tr>
      <tr>
        <td id="L2045" data-line-number="2045"></td>
        <td id="LC2045">            <span>_fResetConnection</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2046" data-line-number="2046"></td>
        <td id="LC2046">            <span>_fPreserveTransaction</span> <span>=</span> <span>preserveTransaction</span>;</td>
      </tr>
      <tr>
        <td id="L2047" data-line-number="2047"></td>
        <td id="LC2047">        }</td>
      </tr>
      <tr>
        <td id="L2048" data-line-number="2048"></td>
        <td id="LC2048">
</td>
      </tr>
      <tr>
        <td id="L2049" data-line-number="2049"></td>
        <td id="LC2049">        <span>internal</span> <span>bool</span> <span>RunReliably</span>(<span>RunBehavior</span> <span>runBehavior</span>, <span>SqlCommand</span> <span>cmdHandler</span>, <span>SqlDataReader</span> <span>dataStream</span>, <span>BulkCopySimpleResultSet</span> <span>bulkCopyHandler</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L2050" data-line-number="2050"></td>
        <td id="LC2050">        {</td>
      </tr>
      <tr>
        <td id="L2051" data-line-number="2051"></td>
        <td id="LC2051">            <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L2052" data-line-number="2052"></td>
        <td id="LC2052">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L2053" data-line-number="2053"></td>
        <td id="LC2053">            {</td>
      </tr>
      <tr>
        <td id="L2054" data-line-number="2054"></td>
        <td id="LC2054">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L2055" data-line-number="2055"></td>
        <td id="LC2055">                <span>TdsParser</span>.<span>ReliabilitySection</span> <span>tdsReliabilitySection</span> <span>=</span> <span>new</span> <span>TdsParser</span>.<span>ReliabilitySection</span>();</td>
      </tr>
      <tr>
        <td id="L2056" data-line-number="2056"></td>
        <td id="LC2056">                <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L2057" data-line-number="2057"></td>
        <td id="LC2057">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L2058" data-line-number="2058"></td>
        <td id="LC2058">                {</td>
      </tr>
      <tr>
        <td id="L2059" data-line-number="2059"></td>
        <td id="LC2059">                    <span>tdsReliabilitySection</span>.<span>Start</span>();</td>
      </tr>
      <tr>
        <td id="L2060" data-line-number="2060"></td>
        <td id="LC2060">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L2061" data-line-number="2061"></td>
        <td id="LC2061">                    <span>return</span> <span>Run</span>(<span>runBehavior</span>, <span>cmdHandler</span>, <span>dataStream</span>, <span>bulkCopyHandler</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L2062" data-line-number="2062"></td>
        <td id="LC2062">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L2063" data-line-number="2063"></td>
        <td id="LC2063">                }</td>
      </tr>
      <tr>
        <td id="L2064" data-line-number="2064"></td>
        <td id="LC2064">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L2065" data-line-number="2065"></td>
        <td id="LC2065">                {</td>
      </tr>
      <tr>
        <td id="L2066" data-line-number="2066"></td>
        <td id="LC2066">                    <span>tdsReliabilitySection</span>.<span>Stop</span>();</td>
      </tr>
      <tr>
        <td id="L2067" data-line-number="2067"></td>
        <td id="LC2067">                }</td>
      </tr>
      <tr>
        <td id="L2068" data-line-number="2068"></td>
        <td id="LC2068">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L2069" data-line-number="2069"></td>
        <td id="LC2069">            }</td>
      </tr>
      <tr>
        <td id="L2070" data-line-number="2070"></td>
        <td id="LC2070">            <span>catch</span> (<span>OutOfMemoryException</span>)</td>
      </tr>
      <tr>
        <td id="L2071" data-line-number="2071"></td>
        <td id="LC2071">            {</td>
      </tr>
      <tr>
        <td id="L2072" data-line-number="2072"></td>
        <td id="LC2072">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L2073" data-line-number="2073"></td>
        <td id="LC2073">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L2074" data-line-number="2074"></td>
        <td id="LC2074">            }</td>
      </tr>
      <tr>
        <td id="L2075" data-line-number="2075"></td>
        <td id="LC2075">            <span>catch</span> (<span>StackOverflowException</span>)</td>
      </tr>
      <tr>
        <td id="L2076" data-line-number="2076"></td>
        <td id="LC2076">            {</td>
      </tr>
      <tr>
        <td id="L2077" data-line-number="2077"></td>
        <td id="LC2077">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L2078" data-line-number="2078"></td>
        <td id="LC2078">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L2079" data-line-number="2079"></td>
        <td id="LC2079">            }</td>
      </tr>
      <tr>
        <td id="L2080" data-line-number="2080"></td>
        <td id="LC2080">            <span>catch</span> (<span>ThreadAbortException</span>)</td>
      </tr>
      <tr>
        <td id="L2081" data-line-number="2081"></td>
        <td id="LC2081">            {</td>
      </tr>
      <tr>
        <td id="L2082" data-line-number="2082"></td>
        <td id="LC2082">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L2083" data-line-number="2083"></td>
        <td id="LC2083">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L2084" data-line-number="2084"></td>
        <td id="LC2084">            }</td>
      </tr>
      <tr>
        <td id="L2085" data-line-number="2085"></td>
        <td id="LC2085">        }</td>
      </tr>
      <tr>
        <td id="L2086" data-line-number="2086"></td>
        <td id="LC2086">
</td>
      </tr>
      <tr>
        <td id="L2087" data-line-number="2087"></td>
        <td id="LC2087">
</td>
      </tr>
      <tr>
        <td id="L2088" data-line-number="2088"></td>
        <td id="LC2088">        <span>internal</span> <span>bool</span> <span>Run</span>(<span>RunBehavior</span> <span>runBehavior</span>, <span>SqlCommand</span> <span>cmdHandler</span>, <span>SqlDataReader</span> <span>dataStream</span>, <span>BulkCopySimpleResultSet</span> <span>bulkCopyHandler</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L2089" data-line-number="2089"></td>
        <td id="LC2089">        {</td>
      </tr>
      <tr>
        <td id="L2090" data-line-number="2090"></td>
        <td id="LC2090">            <span>bool</span> <span>syncOverAsync</span> <span>=</span> <span>stateObj</span>.<span>_syncOverAsync</span>;</td>
      </tr>
      <tr>
        <td id="L2091" data-line-number="2091"></td>
        <td id="LC2091">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L2092" data-line-number="2092"></td>
        <td id="LC2092">            {</td>
      </tr>
      <tr>
        <td id="L2093" data-line-number="2093"></td>
        <td id="LC2093">                <span>stateObj</span>.<span>_syncOverAsync</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2094" data-line-number="2094"></td>
        <td id="LC2094">
</td>
      </tr>
      <tr>
        <td id="L2095" data-line-number="2095"></td>
        <td id="LC2095">                <span>bool</span> <span>dataReady</span>;</td>
      </tr>
      <tr>
        <td id="L2096" data-line-number="2096"></td>
        <td id="LC2096">                <span>bool</span> <span>result</span> <span>=</span> <span>TryRun</span>(<span>runBehavior</span>, <span>cmdHandler</span>, <span>dataStream</span>, <span>bulkCopyHandler</span>, <span>stateObj</span>, <span>out</span> <span>dataReady</span>);</td>
      </tr>
      <tr>
        <td id="L2097" data-line-number="2097"></td>
        <td id="LC2097">                <span>Debug</span>.<span>Assert</span>(<span>result</span> <span>==</span> <span>true</span>, <span><span>"</span>Should never return false when _syncOverAsync is set<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2098" data-line-number="2098"></td>
        <td id="LC2098">                <span>return</span> <span>dataReady</span>;</td>
      </tr>
      <tr>
        <td id="L2099" data-line-number="2099"></td>
        <td id="LC2099">            }</td>
      </tr>
      <tr>
        <td id="L2100" data-line-number="2100"></td>
        <td id="LC2100">            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L2101" data-line-number="2101"></td>
        <td id="LC2101">            {</td>
      </tr>
      <tr>
        <td id="L2102" data-line-number="2102"></td>
        <td id="LC2102">                <span>stateObj</span>.<span>_syncOverAsync</span> <span>=</span> <span>syncOverAsync</span>;</td>
      </tr>
      <tr>
        <td id="L2103" data-line-number="2103"></td>
        <td id="LC2103">            }</td>
      </tr>
      <tr>
        <td id="L2104" data-line-number="2104"></td>
        <td id="LC2104">        }</td>
      </tr>
      <tr>
        <td id="L2105" data-line-number="2105"></td>
        <td id="LC2105">
</td>
      </tr>
      <tr>
        <td id="L2106" data-line-number="2106"></td>
        <td id="LC2106">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L2107" data-line-number="2107"></td>
        <td id="LC2107">        <span><span>///</span> Checks if the given token is a valid TDS token</span></td>
      </tr>
      <tr>
        <td id="L2108" data-line-number="2108"></td>
        <td id="LC2108">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L2109" data-line-number="2109"></td>
        <td id="LC2109">        <span><span>///</span> &lt;<span><span>param</span></span> <span><span>name</span></span>=<span><span>"</span>token<span>"</span></span>&gt;Token to check&lt;/<span><span>param</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L2110" data-line-number="2110"></td>
        <td id="LC2110">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;True if the token is a valid TDS token, otherwise false&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L2111" data-line-number="2111"></td>
        <td id="LC2111">        <span>internal</span> <span>static</span> <span>bool</span> <span>IsValidTdsToken</span>(<span>byte</span> <span>token</span>)</td>
      </tr>
      <tr>
        <td id="L2112" data-line-number="2112"></td>
        <td id="LC2112">        {</td>
      </tr>
      <tr>
        <td id="L2113" data-line-number="2113"></td>
        <td id="LC2113">            <span>return</span> (</td>
      </tr>
      <tr>
        <td id="L2114" data-line-number="2114"></td>
        <td id="LC2114">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLERROR</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2115" data-line-number="2115"></td>
        <td id="LC2115">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLINFO</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2116" data-line-number="2116"></td>
        <td id="LC2116">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLLOGINACK</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2117" data-line-number="2117"></td>
        <td id="LC2117">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLENVCHANGE</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2118" data-line-number="2118"></td>
        <td id="LC2118">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLRETURNVALUE</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2119" data-line-number="2119"></td>
        <td id="LC2119">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLRETURNSTATUS</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2120" data-line-number="2120"></td>
        <td id="LC2120">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLCOLNAME</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2121" data-line-number="2121"></td>
        <td id="LC2121">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLCOLFMT</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2122" data-line-number="2122"></td>
        <td id="LC2122">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLRESCOLSRCS</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2123" data-line-number="2123"></td>
        <td id="LC2123">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDATACLASSIFICATION</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2124" data-line-number="2124"></td>
        <td id="LC2124">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLCOLMETADATA</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2125" data-line-number="2125"></td>
        <td id="LC2125">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLALTMETADATA</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2126" data-line-number="2126"></td>
        <td id="LC2126">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLTABNAME</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2127" data-line-number="2127"></td>
        <td id="LC2127">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLCOLINFO</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2128" data-line-number="2128"></td>
        <td id="LC2128">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLORDER</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2129" data-line-number="2129"></td>
        <td id="LC2129">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLALTROW</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2130" data-line-number="2130"></td>
        <td id="LC2130">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLROW</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2131" data-line-number="2131"></td>
        <td id="LC2131">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLNBCROW</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2132" data-line-number="2132"></td>
        <td id="LC2132">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDONE</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2133" data-line-number="2133"></td>
        <td id="LC2133">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDONEPROC</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2134" data-line-number="2134"></td>
        <td id="LC2134">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDONEINPROC</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2135" data-line-number="2135"></td>
        <td id="LC2135">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLROWCRC</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2136" data-line-number="2136"></td>
        <td id="LC2136">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLSECLEVEL</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2137" data-line-number="2137"></td>
        <td id="LC2137">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLPROCID</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2138" data-line-number="2138"></td>
        <td id="LC2138">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLOFFSET</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2139" data-line-number="2139"></td>
        <td id="LC2139">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLSSPI</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2140" data-line-number="2140"></td>
        <td id="LC2140">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLFEATUREEXTACK</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2141" data-line-number="2141"></td>
        <td id="LC2141">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLSESSIONSTATE</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L2142" data-line-number="2142"></td>
        <td id="LC2142">                <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLFEDAUTHINFO</span>);</td>
      </tr>
      <tr>
        <td id="L2143" data-line-number="2143"></td>
        <td id="LC2143">        }</td>
      </tr>
      <tr>
        <td id="L2144" data-line-number="2144"></td>
        <td id="LC2144">
</td>
      </tr>
      <tr>
        <td id="L2145" data-line-number="2145"></td>
        <td id="LC2145">        <span><span>//</span> Main parse loop for the top-level tds tokens, calls back into the I*Handler interfaces</span></td>
      </tr>
      <tr>
        <td id="L2146" data-line-number="2146"></td>
        <td id="LC2146">        <span>internal</span> <span>bool</span> <span>TryRun</span>(<span>RunBehavior</span> <span>runBehavior</span>, <span>SqlCommand</span> <span>cmdHandler</span>, <span>SqlDataReader</span> <span>dataStream</span>, <span>BulkCopySimpleResultSet</span> <span>bulkCopyHandler</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>bool</span> <span>dataReady</span>)</td>
      </tr>
      <tr>
        <td id="L2147" data-line-number="2147"></td>
        <td id="LC2147">        {</td>
      </tr>
      <tr>
        <td id="L2148" data-line-number="2148"></td>
        <td id="LC2148">            <span>ReliabilitySection</span>.<span>Assert</span>(<span><span>"</span>unreliable call to Run<span>"</span></span>);  <span><span>//</span> you need to setup for a thread abort somewhere before you call this method</span></td>
      </tr>
      <tr>
        <td id="L2149" data-line-number="2149"></td>
        <td id="LC2149">            <span>Debug</span>.<span>Assert</span>((<span>SniContext</span>.<span>Undefined</span> <span>!=</span> <span>stateObj</span>.<span>SniContext</span>) <span>&amp;&amp;</span>       <span><span>//</span> SniContext must not be Undefined</span></td>
      </tr>
      <tr>
        <td id="L2150" data-line-number="2150"></td>
        <td id="LC2150">                ((<span>stateObj</span>.<span>_attentionSent</span>) <span>||</span> ((<span>SniContext</span>.<span>Snix_Execute</span> <span>!=</span> <span>stateObj</span>.<span>SniContext</span>) <span>&amp;&amp;</span> (<span>SniContext</span>.<span>Snix_SendRows</span> <span>!=</span> <span>stateObj</span>.<span>SniContext</span>))),  <span><span>//</span> SniContext should not be Execute or SendRows unless attention was sent (and, therefore, we are looking for an ACK)</span></td>
      </tr>
      <tr>
        <td id="L2151" data-line-number="2151"></td>
        <td id="LC2151">                        <span><span>$"</span>Unexpected SniContext on call to TryRun; SniContext={<span>stateObj</span>.<span>SniContext</span>}<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2152" data-line-number="2152"></td>
        <td id="LC2152">
</td>
      </tr>
      <tr>
        <td id="L2153" data-line-number="2153"></td>
        <td id="LC2153">            <span>if</span> (<span>TdsParserState</span>.<span>Broken</span> <span>==</span> <span>State</span> <span>||</span> <span>TdsParserState</span>.<span>Closed</span> <span>==</span> <span>State</span>)</td>
      </tr>
      <tr>
        <td id="L2154" data-line-number="2154"></td>
        <td id="LC2154">            {</td>
      </tr>
      <tr>
        <td id="L2155" data-line-number="2155"></td>
        <td id="LC2155">                <span>dataReady</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2156" data-line-number="2156"></td>
        <td id="LC2156">                <span>return</span> <span>true</span>; <span><span>//</span> Just in case this is called in a loop, expecting data to be returned.</span></td>
      </tr>
      <tr>
        <td id="L2157" data-line-number="2157"></td>
        <td id="LC2157">            }</td>
      </tr>
      <tr>
        <td id="L2158" data-line-number="2158"></td>
        <td id="LC2158">
</td>
      </tr>
      <tr>
        <td id="L2159" data-line-number="2159"></td>
        <td id="LC2159">            <span>dataReady</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2160" data-line-number="2160"></td>
        <td id="LC2160">
</td>
      </tr>
      <tr>
        <td id="L2161" data-line-number="2161"></td>
        <td id="LC2161">            <span>do</span></td>
      </tr>
      <tr>
        <td id="L2162" data-line-number="2162"></td>
        <td id="LC2162">            {</td>
      </tr>
      <tr>
        <td id="L2163" data-line-number="2163"></td>
        <td id="LC2163">                <span><span>//</span> If there is data ready, but we didn't exit the loop, then something is wrong</span></td>
      </tr>
      <tr>
        <td id="L2164" data-line-number="2164"></td>
        <td id="LC2164">                <span>Debug</span>.<span>Assert</span>(<span>!</span><span>dataReady</span>, <span><span>"</span>dataReady not expected - did we forget to skip the row?<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2165" data-line-number="2165"></td>
        <td id="LC2165">
</td>
      </tr>
      <tr>
        <td id="L2166" data-line-number="2166"></td>
        <td id="LC2166">                <span>if</span> (<span>stateObj</span>.<span>_internalTimeout</span>)</td>
      </tr>
      <tr>
        <td id="L2167" data-line-number="2167"></td>
        <td id="LC2167">                {</td>
      </tr>
      <tr>
        <td id="L2168" data-line-number="2168"></td>
        <td id="LC2168">                    <span>runBehavior</span> <span>=</span> <span>RunBehavior</span>.<span>Attention</span>;</td>
      </tr>
      <tr>
        <td id="L2169" data-line-number="2169"></td>
        <td id="LC2169">                }</td>
      </tr>
      <tr>
        <td id="L2170" data-line-number="2170"></td>
        <td id="LC2170">
</td>
      </tr>
      <tr>
        <td id="L2171" data-line-number="2171"></td>
        <td id="LC2171">                <span>if</span> (<span>TdsParserState</span>.<span>Broken</span> <span>==</span> <span>State</span> <span>||</span> <span>TdsParserState</span>.<span>Closed</span> <span>==</span> <span>State</span>)</td>
      </tr>
      <tr>
        <td id="L2172" data-line-number="2172"></td>
        <td id="LC2172">                    <span>break</span>; <span><span>//</span> jump out of the loop if the state is already broken or closed.</span></td>
      </tr>
      <tr>
        <td id="L2173" data-line-number="2173"></td>
        <td id="LC2173">
</td>
      </tr>
      <tr>
        <td id="L2174" data-line-number="2174"></td>
        <td id="LC2174">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>_accumulateInfoEvents</span> <span>&amp;&amp;</span> (<span>stateObj</span>.<span>_pendingInfoEvents</span> <span>!=</span> <span>null</span>))</td>
      </tr>
      <tr>
        <td id="L2175" data-line-number="2175"></td>
        <td id="LC2175">                {</td>
      </tr>
      <tr>
        <td id="L2176" data-line-number="2176"></td>
        <td id="LC2176">                    <span>if</span> (<span>RunBehavior</span>.<span>Clean</span> <span>!=</span> (<span>RunBehavior</span>.<span>Clean</span> <span>&amp;</span> <span>runBehavior</span>))</td>
      </tr>
      <tr>
        <td id="L2177" data-line-number="2177"></td>
        <td id="LC2177">                    {</td>
      </tr>
      <tr>
        <td id="L2178" data-line-number="2178"></td>
        <td id="LC2178">                        <span>SqlConnection</span> <span>connection</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L2179" data-line-number="2179"></td>
        <td id="LC2179">                        <span>if</span> (<span>_connHandler</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2180" data-line-number="2180"></td>
        <td id="LC2180">                            <span>connection</span> <span>=</span> <span>_connHandler</span>.<span>Connection</span>; <span><span>//</span> SqlInternalConnection holds the user connection object as a weak ref</span></td>
      </tr>
      <tr>
        <td id="L2181" data-line-number="2181"></td>
        <td id="LC2181">                        <span><span>//</span> We are omitting checks for error.Class in the code below (see processing of INFO) since we know (and assert) that error class</span></td>
      </tr>
      <tr>
        <td id="L2182" data-line-number="2182"></td>
        <td id="LC2182">                        <span><span>//</span> error.Class &lt; TdsEnums.MIN_ERROR_CLASS for info message.</span></td>
      </tr>
      <tr>
        <td id="L2183" data-line-number="2183"></td>
        <td id="LC2183">                        <span><span>//</span> Also we know that TdsEnums.MIN_ERROR_CLASS&lt;TdsEnums.MAX_USER_CORRECTABLE_ERROR_CLASS</span></td>
      </tr>
      <tr>
        <td id="L2184" data-line-number="2184"></td>
        <td id="LC2184">                        <span>if</span> ((<span>connection</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> <span>connection</span>.<span>FireInfoMessageEventOnUserErrors</span>)</td>
      </tr>
      <tr>
        <td id="L2185" data-line-number="2185"></td>
        <td id="LC2185">                        {</td>
      </tr>
      <tr>
        <td id="L2186" data-line-number="2186"></td>
        <td id="LC2186">                            <span>foreach</span> (<span>SqlError</span> <span>error</span> <span>in</span> <span>stateObj</span>.<span>_pendingInfoEvents</span>)</td>
      </tr>
      <tr>
        <td id="L2187" data-line-number="2187"></td>
        <td id="LC2187">                                <span>FireInfoMessageEvent</span>(<span>connection</span>, <span>stateObj</span>, <span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2188" data-line-number="2188"></td>
        <td id="LC2188">                        }</td>
      </tr>
      <tr>
        <td id="L2189" data-line-number="2189"></td>
        <td id="LC2189">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L2190" data-line-number="2190"></td>
        <td id="LC2190">                            <span>foreach</span> (<span>SqlError</span> <span>error</span> <span>in</span> <span>stateObj</span>.<span>_pendingInfoEvents</span>)</td>
      </tr>
      <tr>
        <td id="L2191" data-line-number="2191"></td>
        <td id="LC2191">                                <span>stateObj</span>.<span>AddWarning</span>(<span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2192" data-line-number="2192"></td>
        <td id="LC2192">
</td>
      </tr>
      <tr>
        <td id="L2193" data-line-number="2193"></td>
        <td id="LC2193">                    }</td>
      </tr>
      <tr>
        <td id="L2194" data-line-number="2194"></td>
        <td id="LC2194">                    <span>stateObj</span>.<span>_pendingInfoEvents</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L2195" data-line-number="2195"></td>
        <td id="LC2195">                }</td>
      </tr>
      <tr>
        <td id="L2196" data-line-number="2196"></td>
        <td id="LC2196">
</td>
      </tr>
      <tr>
        <td id="L2197" data-line-number="2197"></td>
        <td id="LC2197">                <span>byte</span> <span>token</span>;</td>
      </tr>
      <tr>
        <td id="L2198" data-line-number="2198"></td>
        <td id="LC2198">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>token</span>))</td>
      </tr>
      <tr>
        <td id="L2199" data-line-number="2199"></td>
        <td id="LC2199">                {</td>
      </tr>
      <tr>
        <td id="L2200" data-line-number="2200"></td>
        <td id="LC2200">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2201" data-line-number="2201"></td>
        <td id="LC2201">                }</td>
      </tr>
      <tr>
        <td id="L2202" data-line-number="2202"></td>
        <td id="LC2202">
</td>
      </tr>
      <tr>
        <td id="L2203" data-line-number="2203"></td>
        <td id="LC2203">                <span>if</span> (<span>!</span><span>IsValidTdsToken</span>(<span>token</span>))</td>
      </tr>
      <tr>
        <td id="L2204" data-line-number="2204"></td>
        <td id="LC2204">                {</td>
      </tr>
      <tr>
        <td id="L2205" data-line-number="2205"></td>
        <td id="LC2205">                    <span>Debug</span>.<span>Fail</span>(<span><span>$"</span>unexpected token; token = {<span>token</span>,<span>-</span><span>2</span>:<span>X2</span>}<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2206" data-line-number="2206"></td>
        <td id="LC2206">                    <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>Broken</span>;</td>
      </tr>
      <tr>
        <td id="L2207" data-line-number="2207"></td>
        <td id="LC2207">                    <span>_connHandler</span>.<span>BreakConnection</span>();</td>
      </tr>
      <tr>
        <td id="L2208" data-line-number="2208"></td>
        <td id="LC2208">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.Run|ERR&gt; Potential multi-threaded misuse of connection, unexpected TDS token found %d#<span>\n</span><span>"</span></span>, <span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L2209" data-line-number="2209"></td>
        <td id="LC2209">                    <span>throw</span> <span>SQL</span>.<span>ParsingErrorToken</span>(<span>ParsingErrorState</span>.<span>InvalidTdsTokenReceived</span>, <span>token</span>); <span><span>//</span> MDAC 82443</span></td>
      </tr>
      <tr>
        <td id="L2210" data-line-number="2210"></td>
        <td id="LC2210">                }</td>
      </tr>
      <tr>
        <td id="L2211" data-line-number="2211"></td>
        <td id="LC2211">
</td>
      </tr>
      <tr>
        <td id="L2212" data-line-number="2212"></td>
        <td id="LC2212">                <span>int</span> <span>tokenLength</span>;</td>
      </tr>
      <tr>
        <td id="L2213" data-line-number="2213"></td>
        <td id="LC2213">                <span>if</span> (<span>!</span><span>TryGetTokenLength</span>(<span>token</span>, <span>stateObj</span>, <span>out</span> <span>tokenLength</span>))</td>
      </tr>
      <tr>
        <td id="L2214" data-line-number="2214"></td>
        <td id="LC2214">                {</td>
      </tr>
      <tr>
        <td id="L2215" data-line-number="2215"></td>
        <td id="LC2215">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2216" data-line-number="2216"></td>
        <td id="LC2216">                }</td>
      </tr>
      <tr>
        <td id="L2217" data-line-number="2217"></td>
        <td id="LC2217">
</td>
      </tr>
      <tr>
        <td id="L2218" data-line-number="2218"></td>
        <td id="LC2218">                <span>switch</span> (<span>token</span>)</td>
      </tr>
      <tr>
        <td id="L2219" data-line-number="2219"></td>
        <td id="LC2219">                {</td>
      </tr>
      <tr>
        <td id="L2220" data-line-number="2220"></td>
        <td id="LC2220">                    <span>case</span> <span>TdsEnums</span>.<span>SQLERROR</span>:</td>
      </tr>
      <tr>
        <td id="L2221" data-line-number="2221"></td>
        <td id="LC2221">                    <span>case</span> <span>TdsEnums</span>.<span>SQLINFO</span>:</td>
      </tr>
      <tr>
        <td id="L2222" data-line-number="2222"></td>
        <td id="LC2222">                        {</td>
      </tr>
      <tr>
        <td id="L2223" data-line-number="2223"></td>
        <td id="LC2223">                            <span>if</span> (<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLERROR</span>)</td>
      </tr>
      <tr>
        <td id="L2224" data-line-number="2224"></td>
        <td id="LC2224">                            {</td>
      </tr>
      <tr>
        <td id="L2225" data-line-number="2225"></td>
        <td id="LC2225">                                <span>stateObj</span>.<span>_errorTokenReceived</span> <span>=</span> <span>true</span>; <span><span>//</span> Keep track of the fact error token was received - for Done processing.</span></td>
      </tr>
      <tr>
        <td id="L2226" data-line-number="2226"></td>
        <td id="LC2226">                            }</td>
      </tr>
      <tr>
        <td id="L2227" data-line-number="2227"></td>
        <td id="LC2227">
</td>
      </tr>
      <tr>
        <td id="L2228" data-line-number="2228"></td>
        <td id="LC2228">                            <span>SqlError</span> <span>error</span>;</td>
      </tr>
      <tr>
        <td id="L2229" data-line-number="2229"></td>
        <td id="LC2229">                            <span>if</span> (<span>!</span><span>TryProcessError</span>(<span>token</span>, <span>stateObj</span>, <span>out</span> <span>error</span>))</td>
      </tr>
      <tr>
        <td id="L2230" data-line-number="2230"></td>
        <td id="LC2230">                            {</td>
      </tr>
      <tr>
        <td id="L2231" data-line-number="2231"></td>
        <td id="LC2231">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2232" data-line-number="2232"></td>
        <td id="LC2232">                            }</td>
      </tr>
      <tr>
        <td id="L2233" data-line-number="2233"></td>
        <td id="LC2233">
</td>
      </tr>
      <tr>
        <td id="L2234" data-line-number="2234"></td>
        <td id="LC2234">                            <span>if</span> (<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLINFO</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_accumulateInfoEvents</span>)</td>
      </tr>
      <tr>
        <td id="L2235" data-line-number="2235"></td>
        <td id="LC2235">                            {</td>
      </tr>
      <tr>
        <td id="L2236" data-line-number="2236"></td>
        <td id="LC2236">                                <span>Debug</span>.<span>Assert</span>(<span>error</span>.<span>Class</span> <span>&lt;</span> <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>, <span><span>"</span>INFO with class &gt; TdsEnums.MIN_ERROR_CLASS<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2237" data-line-number="2237"></td>
        <td id="LC2237">
</td>
      </tr>
      <tr>
        <td id="L2238" data-line-number="2238"></td>
        <td id="LC2238">                                <span>if</span> (<span>stateObj</span>.<span>_pendingInfoEvents</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2239" data-line-number="2239"></td>
        <td id="LC2239">                                    <span>stateObj</span>.<span>_pendingInfoEvents</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>SqlError</span>&gt;();</td>
      </tr>
      <tr>
        <td id="L2240" data-line-number="2240"></td>
        <td id="LC2240">                                <span>stateObj</span>.<span>_pendingInfoEvents</span>.<span>Add</span>(<span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2241" data-line-number="2241"></td>
        <td id="LC2241">                                <span>stateObj</span>.<span>_syncOverAsync</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2242" data-line-number="2242"></td>
        <td id="LC2242">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2243" data-line-number="2243"></td>
        <td id="LC2243">                            }</td>
      </tr>
      <tr>
        <td id="L2244" data-line-number="2244"></td>
        <td id="LC2244">
</td>
      </tr>
      <tr>
        <td id="L2245" data-line-number="2245"></td>
        <td id="LC2245">                            <span>if</span> (<span>RunBehavior</span>.<span>Clean</span> <span>!=</span> (<span>RunBehavior</span>.<span>Clean</span> <span>&amp;</span> <span>runBehavior</span>))</td>
      </tr>
      <tr>
        <td id="L2246" data-line-number="2246"></td>
        <td id="LC2246">                            {</td>
      </tr>
      <tr>
        <td id="L2247" data-line-number="2247"></td>
        <td id="LC2247">                                <span><span>//</span> If FireInfoMessageEventOnUserErrors is true, we have to fire event without waiting.</span></td>
      </tr>
      <tr>
        <td id="L2248" data-line-number="2248"></td>
        <td id="LC2248">                                <span><span>//</span> Otherwise we can go ahead and add it to errors/warnings collection.</span></td>
      </tr>
      <tr>
        <td id="L2249" data-line-number="2249"></td>
        <td id="LC2249">                                <span>SqlConnection</span> <span>connection</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L2250" data-line-number="2250"></td>
        <td id="LC2250">                                <span>if</span> (<span>_connHandler</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2251" data-line-number="2251"></td>
        <td id="LC2251">                                    <span>connection</span> <span>=</span> <span>_connHandler</span>.<span>Connection</span>; <span><span>//</span> SqlInternalConnection holds the user connection object as a weak ref</span></td>
      </tr>
      <tr>
        <td id="L2252" data-line-number="2252"></td>
        <td id="LC2252">
</td>
      </tr>
      <tr>
        <td id="L2253" data-line-number="2253"></td>
        <td id="LC2253">                                <span>if</span> ((<span>connection</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L2254" data-line-number="2254"></td>
        <td id="LC2254">                                    (<span>connection</span>.<span>FireInfoMessageEventOnUserErrors</span> <span>==</span> <span>true</span>) <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L2255" data-line-number="2255"></td>
        <td id="LC2255">                                    (<span>error</span>.<span>Class</span> <span>&lt;=</span> <span>TdsEnums</span>.<span>MAX_USER_CORRECTABLE_ERROR_CLASS</span>))</td>
      </tr>
      <tr>
        <td id="L2256" data-line-number="2256"></td>
        <td id="LC2256">                                {</td>
      </tr>
      <tr>
        <td id="L2257" data-line-number="2257"></td>
        <td id="LC2257">                                    <span><span>//</span> Fire SqlInfoMessage here</span></td>
      </tr>
      <tr>
        <td id="L2258" data-line-number="2258"></td>
        <td id="LC2258">                                    <span>FireInfoMessageEvent</span>(<span>connection</span>, <span>stateObj</span>, <span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2259" data-line-number="2259"></td>
        <td id="LC2259">                                }</td>
      </tr>
      <tr>
        <td id="L2260" data-line-number="2260"></td>
        <td id="LC2260">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L2261" data-line-number="2261"></td>
        <td id="LC2261">                                {</td>
      </tr>
      <tr>
        <td id="L2262" data-line-number="2262"></td>
        <td id="LC2262">                                    <span><span>//</span> insert error/info into the appropriate exception - warning if info, exception if error</span></td>
      </tr>
      <tr>
        <td id="L2263" data-line-number="2263"></td>
        <td id="LC2263">                                    <span>if</span> (<span>error</span>.<span>Class</span> <span>&lt;</span> <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>)</td>
      </tr>
      <tr>
        <td id="L2264" data-line-number="2264"></td>
        <td id="LC2264">                                    {</td>
      </tr>
      <tr>
        <td id="L2265" data-line-number="2265"></td>
        <td id="LC2265">                                        <span>stateObj</span>.<span>AddWarning</span>(<span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2266" data-line-number="2266"></td>
        <td id="LC2266">                                    }</td>
      </tr>
      <tr>
        <td id="L2267" data-line-number="2267"></td>
        <td id="LC2267">                                    <span>else</span> <span>if</span> (<span>error</span>.<span>Class</span> <span>&lt;</span> <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>)</td>
      </tr>
      <tr>
        <td id="L2268" data-line-number="2268"></td>
        <td id="LC2268">                                    {</td>
      </tr>
      <tr>
        <td id="L2269" data-line-number="2269"></td>
        <td id="LC2269">                                        <span><span>//</span> VSTFDEVDIV 479643: continue results processing for all non-fatal errors (&lt;20)</span></td>
      </tr>
      <tr>
        <td id="L2270" data-line-number="2270"></td>
        <td id="LC2270">
</td>
      </tr>
      <tr>
        <td id="L2271" data-line-number="2271"></td>
        <td id="LC2271">                                        <span>stateObj</span>.<span>AddError</span>(<span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2272" data-line-number="2272"></td>
        <td id="LC2272">
</td>
      </tr>
      <tr>
        <td id="L2273" data-line-number="2273"></td>
        <td id="LC2273">                                        <span><span>//</span> Add it to collection - but do NOT change run behavior UNLESS</span></td>
      </tr>
      <tr>
        <td id="L2274" data-line-number="2274"></td>
        <td id="LC2274">                                        <span><span>//</span> we are in an ExecuteReader call - at which time we will be throwing</span></td>
      </tr>
      <tr>
        <td id="L2275" data-line-number="2275"></td>
        <td id="LC2275">                                        <span><span>//</span> anyways so we need to consume all errors.  This is not the case</span></td>
      </tr>
      <tr>
        <td id="L2276" data-line-number="2276"></td>
        <td id="LC2276">                                        <span><span>//</span> if we have already given out a reader.  If we have already given out</span></td>
      </tr>
      <tr>
        <td id="L2277" data-line-number="2277"></td>
        <td id="LC2277">                                        <span><span>//</span> a reader we need to throw the error but not halt further processing.  We used to</span></td>
      </tr>
      <tr>
        <td id="L2278" data-line-number="2278"></td>
        <td id="LC2278">                                        <span><span>//</span> halt processing and that was a bug preventing the user from</span></td>
      </tr>
      <tr>
        <td id="L2279" data-line-number="2279"></td>
        <td id="LC2279">                                        <span><span>//</span> processing subsequent results.</span></td>
      </tr>
      <tr>
        <td id="L2280" data-line-number="2280"></td>
        <td id="LC2280">
</td>
      </tr>
      <tr>
        <td id="L2281" data-line-number="2281"></td>
        <td id="LC2281">                                        <span>if</span> (<span>null</span> <span>!=</span> <span>dataStream</span>)</td>
      </tr>
      <tr>
        <td id="L2282" data-line-number="2282"></td>
        <td id="LC2282">                                        { <span><span>//</span> Webdata 104560</span></td>
      </tr>
      <tr>
        <td id="L2283" data-line-number="2283"></td>
        <td id="LC2283">                                            <span>if</span> (<span>!</span><span>dataStream</span>.<span>IsInitialized</span>)</td>
      </tr>
      <tr>
        <td id="L2284" data-line-number="2284"></td>
        <td id="LC2284">                                            {</td>
      </tr>
      <tr>
        <td id="L2285" data-line-number="2285"></td>
        <td id="LC2285">                                                <span>runBehavior</span> <span>=</span> <span>RunBehavior</span>.<span>UntilDone</span>;</td>
      </tr>
      <tr>
        <td id="L2286" data-line-number="2286"></td>
        <td id="LC2286">                                            }</td>
      </tr>
      <tr>
        <td id="L2287" data-line-number="2287"></td>
        <td id="LC2287">                                        }</td>
      </tr>
      <tr>
        <td id="L2288" data-line-number="2288"></td>
        <td id="LC2288">                                    }</td>
      </tr>
      <tr>
        <td id="L2289" data-line-number="2289"></td>
        <td id="LC2289">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L2290" data-line-number="2290"></td>
        <td id="LC2290">                                    {</td>
      </tr>
      <tr>
        <td id="L2291" data-line-number="2291"></td>
        <td id="LC2291">                                        <span>stateObj</span>.<span>AddError</span>(<span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2292" data-line-number="2292"></td>
        <td id="LC2292">
</td>
      </tr>
      <tr>
        <td id="L2293" data-line-number="2293"></td>
        <td id="LC2293">                                        <span><span>//</span> Else we have a fatal error and we need to change the behavior</span></td>
      </tr>
      <tr>
        <td id="L2294" data-line-number="2294"></td>
        <td id="LC2294">                                        <span><span>//</span> since we want the complete error information in the exception.</span></td>
      </tr>
      <tr>
        <td id="L2295" data-line-number="2295"></td>
        <td id="LC2295">                                        <span><span>//</span> Besides - no further results will be received.</span></td>
      </tr>
      <tr>
        <td id="L2296" data-line-number="2296"></td>
        <td id="LC2296">                                        <span>runBehavior</span> <span>=</span> <span>RunBehavior</span>.<span>UntilDone</span>;</td>
      </tr>
      <tr>
        <td id="L2297" data-line-number="2297"></td>
        <td id="LC2297">                                    }</td>
      </tr>
      <tr>
        <td id="L2298" data-line-number="2298"></td>
        <td id="LC2298">                                }</td>
      </tr>
      <tr>
        <td id="L2299" data-line-number="2299"></td>
        <td id="LC2299">                            }</td>
      </tr>
      <tr>
        <td id="L2300" data-line-number="2300"></td>
        <td id="LC2300">                            <span>else</span> <span>if</span> (<span>error</span>.<span>Class</span> <span>&gt;=</span> <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>)</td>
      </tr>
      <tr>
        <td id="L2301" data-line-number="2301"></td>
        <td id="LC2301">                            {</td>
      </tr>
      <tr>
        <td id="L2302" data-line-number="2302"></td>
        <td id="LC2302">                                <span>stateObj</span>.<span>AddError</span>(<span>error</span>);</td>
      </tr>
      <tr>
        <td id="L2303" data-line-number="2303"></td>
        <td id="LC2303">                            }</td>
      </tr>
      <tr>
        <td id="L2304" data-line-number="2304"></td>
        <td id="LC2304">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2305" data-line-number="2305"></td>
        <td id="LC2305">                        }</td>
      </tr>
      <tr>
        <td id="L2306" data-line-number="2306"></td>
        <td id="LC2306">
</td>
      </tr>
      <tr>
        <td id="L2307" data-line-number="2307"></td>
        <td id="LC2307">                    <span>case</span> <span>TdsEnums</span>.<span>SQLCOLINFO</span>:</td>
      </tr>
      <tr>
        <td id="L2308" data-line-number="2308"></td>
        <td id="LC2308">                        {</td>
      </tr>
      <tr>
        <td id="L2309" data-line-number="2309"></td>
        <td id="LC2309">                            <span>if</span> (<span>null</span> <span>!=</span> <span>dataStream</span>)</td>
      </tr>
      <tr>
        <td id="L2310" data-line-number="2310"></td>
        <td id="LC2310">                            {</td>
      </tr>
      <tr>
        <td id="L2311" data-line-number="2311"></td>
        <td id="LC2311">                                <span>_SqlMetaDataSet</span> <span>metaDataSet</span>;</td>
      </tr>
      <tr>
        <td id="L2312" data-line-number="2312"></td>
        <td id="LC2312">                                <span>if</span> (<span>!</span><span>TryProcessColInfo</span>(<span>dataStream</span>.<span>MetaData</span>, <span>dataStream</span>, <span>stateObj</span>, <span>out</span> <span>metaDataSet</span>))</td>
      </tr>
      <tr>
        <td id="L2313" data-line-number="2313"></td>
        <td id="LC2313">                                {</td>
      </tr>
      <tr>
        <td id="L2314" data-line-number="2314"></td>
        <td id="LC2314">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2315" data-line-number="2315"></td>
        <td id="LC2315">                                }</td>
      </tr>
      <tr>
        <td id="L2316" data-line-number="2316"></td>
        <td id="LC2316">                                <span>if</span> (<span>!</span><span>dataStream</span>.<span>TrySetMetaData</span>(<span>metaDataSet</span>, <span>false</span>))</td>
      </tr>
      <tr>
        <td id="L2317" data-line-number="2317"></td>
        <td id="LC2317">                                {</td>
      </tr>
      <tr>
        <td id="L2318" data-line-number="2318"></td>
        <td id="LC2318">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2319" data-line-number="2319"></td>
        <td id="LC2319">                                }</td>
      </tr>
      <tr>
        <td id="L2320" data-line-number="2320"></td>
        <td id="LC2320">                                <span>dataStream</span>.<span>BrowseModeInfoConsumed</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2321" data-line-number="2321"></td>
        <td id="LC2321">                            }</td>
      </tr>
      <tr>
        <td id="L2322" data-line-number="2322"></td>
        <td id="LC2322">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2323" data-line-number="2323"></td>
        <td id="LC2323">                            { <span><span>//</span> no dataStream</span></td>
      </tr>
      <tr>
        <td id="L2324" data-line-number="2324"></td>
        <td id="LC2324">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>tokenLength</span>))</td>
      </tr>
      <tr>
        <td id="L2325" data-line-number="2325"></td>
        <td id="LC2325">                                {</td>
      </tr>
      <tr>
        <td id="L2326" data-line-number="2326"></td>
        <td id="LC2326">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2327" data-line-number="2327"></td>
        <td id="LC2327">                                }</td>
      </tr>
      <tr>
        <td id="L2328" data-line-number="2328"></td>
        <td id="LC2328">                            }</td>
      </tr>
      <tr>
        <td id="L2329" data-line-number="2329"></td>
        <td id="LC2329">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2330" data-line-number="2330"></td>
        <td id="LC2330">                        }</td>
      </tr>
      <tr>
        <td id="L2331" data-line-number="2331"></td>
        <td id="LC2331">
</td>
      </tr>
      <tr>
        <td id="L2332" data-line-number="2332"></td>
        <td id="LC2332">                    <span>case</span> <span>TdsEnums</span>.<span>SQLDONE</span>:</td>
      </tr>
      <tr>
        <td id="L2333" data-line-number="2333"></td>
        <td id="LC2333">                    <span>case</span> <span>TdsEnums</span>.<span>SQLDONEPROC</span>:</td>
      </tr>
      <tr>
        <td id="L2334" data-line-number="2334"></td>
        <td id="LC2334">                    <span>case</span> <span>TdsEnums</span>.<span>SQLDONEINPROC</span>:</td>
      </tr>
      <tr>
        <td id="L2335" data-line-number="2335"></td>
        <td id="LC2335">                        {</td>
      </tr>
      <tr>
        <td id="L2336" data-line-number="2336"></td>
        <td id="LC2336">                            <span><span>//</span> RunBehavior can be modified - see SQL BU DT 269516 &amp; 290090</span></td>
      </tr>
      <tr>
        <td id="L2337" data-line-number="2337"></td>
        <td id="LC2337">                            <span>if</span> (<span>!</span><span>TryProcessDone</span>(<span>cmdHandler</span>, <span>dataStream</span>, <span>ref</span> <span>runBehavior</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2338" data-line-number="2338"></td>
        <td id="LC2338">                            {</td>
      </tr>
      <tr>
        <td id="L2339" data-line-number="2339"></td>
        <td id="LC2339">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2340" data-line-number="2340"></td>
        <td id="LC2340">                            }</td>
      </tr>
      <tr>
        <td id="L2341" data-line-number="2341"></td>
        <td id="LC2341">                            <span>if</span> ((<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDONEPROC</span>) <span>&amp;&amp;</span> (<span>cmdHandler</span> <span>!=</span> <span>null</span>))</td>
      </tr>
      <tr>
        <td id="L2342" data-line-number="2342"></td>
        <td id="LC2342">                            {</td>
      </tr>
      <tr>
        <td id="L2343" data-line-number="2343"></td>
        <td id="LC2343">                                <span><span>//</span> If the current parse/read is for the results of describe parameter encryption RPC requests,</span></td>
      </tr>
      <tr>
        <td id="L2344" data-line-number="2344"></td>
        <td id="LC2344">                                <span><span>//</span> call a different handler which will update the describe parameter encryption RPC structures</span></td>
      </tr>
      <tr>
        <td id="L2345" data-line-number="2345"></td>
        <td id="LC2345">                                <span><span>//</span> with the results, instead of the actual user RPC requests.</span></td>
      </tr>
      <tr>
        <td id="L2346" data-line-number="2346"></td>
        <td id="LC2346">                                <span>if</span> (<span>cmdHandler</span>.<span>IsDescribeParameterEncryptionRPCCurrentlyInProgress</span>)</td>
      </tr>
      <tr>
        <td id="L2347" data-line-number="2347"></td>
        <td id="LC2347">                                {</td>
      </tr>
      <tr>
        <td id="L2348" data-line-number="2348"></td>
        <td id="LC2348">                                    <span>cmdHandler</span>.<span>OnDoneDescribeParameterEncryptionProc</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L2349" data-line-number="2349"></td>
        <td id="LC2349">                                }</td>
      </tr>
      <tr>
        <td id="L2350" data-line-number="2350"></td>
        <td id="LC2350">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L2351" data-line-number="2351"></td>
        <td id="LC2351">                                {</td>
      </tr>
      <tr>
        <td id="L2352" data-line-number="2352"></td>
        <td id="LC2352">                                    <span>cmdHandler</span>.<span>OnDoneProc</span>();</td>
      </tr>
      <tr>
        <td id="L2353" data-line-number="2353"></td>
        <td id="LC2353">                                }</td>
      </tr>
      <tr>
        <td id="L2354" data-line-number="2354"></td>
        <td id="LC2354">                            }</td>
      </tr>
      <tr>
        <td id="L2355" data-line-number="2355"></td>
        <td id="LC2355">
</td>
      </tr>
      <tr>
        <td id="L2356" data-line-number="2356"></td>
        <td id="LC2356">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2357" data-line-number="2357"></td>
        <td id="LC2357">                        }</td>
      </tr>
      <tr>
        <td id="L2358" data-line-number="2358"></td>
        <td id="LC2358">
</td>
      </tr>
      <tr>
        <td id="L2359" data-line-number="2359"></td>
        <td id="LC2359">                    <span>case</span> <span>TdsEnums</span>.<span>SQLORDER</span>:</td>
      </tr>
      <tr>
        <td id="L2360" data-line-number="2360"></td>
        <td id="LC2360">                        {</td>
      </tr>
      <tr>
        <td id="L2361" data-line-number="2361"></td>
        <td id="LC2361">                            <span><span>//</span> don't do anything with the order token so read off the pipe</span></td>
      </tr>
      <tr>
        <td id="L2362" data-line-number="2362"></td>
        <td id="LC2362">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>tokenLength</span>))</td>
      </tr>
      <tr>
        <td id="L2363" data-line-number="2363"></td>
        <td id="LC2363">                            {</td>
      </tr>
      <tr>
        <td id="L2364" data-line-number="2364"></td>
        <td id="LC2364">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2365" data-line-number="2365"></td>
        <td id="LC2365">                            }</td>
      </tr>
      <tr>
        <td id="L2366" data-line-number="2366"></td>
        <td id="LC2366">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2367" data-line-number="2367"></td>
        <td id="LC2367">                        }</td>
      </tr>
      <tr>
        <td id="L2368" data-line-number="2368"></td>
        <td id="LC2368">
</td>
      </tr>
      <tr>
        <td id="L2369" data-line-number="2369"></td>
        <td id="LC2369">                    <span>case</span> <span>TdsEnums</span>.<span>SQLALTMETADATA</span>:</td>
      </tr>
      <tr>
        <td id="L2370" data-line-number="2370"></td>
        <td id="LC2370">                        {</td>
      </tr>
      <tr>
        <td id="L2371" data-line-number="2371"></td>
        <td id="LC2371">                            <span>stateObj</span>.<span>CloneCleanupAltMetaDataSetArray</span>();</td>
      </tr>
      <tr>
        <td id="L2372" data-line-number="2372"></td>
        <td id="LC2372">
</td>
      </tr>
      <tr>
        <td id="L2373" data-line-number="2373"></td>
        <td id="LC2373">                            <span>if</span> (<span>stateObj</span>.<span>_cleanupAltMetaDataSetArray</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2374" data-line-number="2374"></td>
        <td id="LC2374">                            {</td>
      </tr>
      <tr>
        <td id="L2375" data-line-number="2375"></td>
        <td id="LC2375">                                <span><span>//</span> create object on demand (lazy creation)</span></td>
      </tr>
      <tr>
        <td id="L2376" data-line-number="2376"></td>
        <td id="LC2376">                                <span>stateObj</span>.<span>_cleanupAltMetaDataSetArray</span> <span>=</span> <span>new</span> <span>_SqlMetaDataSetCollection</span>();</td>
      </tr>
      <tr>
        <td id="L2377" data-line-number="2377"></td>
        <td id="LC2377">                            }</td>
      </tr>
      <tr>
        <td id="L2378" data-line-number="2378"></td>
        <td id="LC2378">
</td>
      </tr>
      <tr>
        <td id="L2379" data-line-number="2379"></td>
        <td id="LC2379">                            <span>_SqlMetaDataSet</span> <span>cleanupAltMetaDataSet</span>;</td>
      </tr>
      <tr>
        <td id="L2380" data-line-number="2380"></td>
        <td id="LC2380">                            <span>if</span> (<span>!</span><span>TryProcessAltMetaData</span>(<span>tokenLength</span>, <span>stateObj</span>, <span>out</span> <span>cleanupAltMetaDataSet</span>))</td>
      </tr>
      <tr>
        <td id="L2381" data-line-number="2381"></td>
        <td id="LC2381">                            {</td>
      </tr>
      <tr>
        <td id="L2382" data-line-number="2382"></td>
        <td id="LC2382">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2383" data-line-number="2383"></td>
        <td id="LC2383">                            }</td>
      </tr>
      <tr>
        <td id="L2384" data-line-number="2384"></td>
        <td id="LC2384">
</td>
      </tr>
      <tr>
        <td id="L2385" data-line-number="2385"></td>
        <td id="LC2385">                            <span>stateObj</span>.<span>_cleanupAltMetaDataSetArray</span>.<span>SetAltMetaData</span>(<span>cleanupAltMetaDataSet</span>);</td>
      </tr>
      <tr>
        <td id="L2386" data-line-number="2386"></td>
        <td id="LC2386">                            <span>if</span> (<span>null</span> <span>!=</span> <span>dataStream</span>)</td>
      </tr>
      <tr>
        <td id="L2387" data-line-number="2387"></td>
        <td id="LC2387">                            {</td>
      </tr>
      <tr>
        <td id="L2388" data-line-number="2388"></td>
        <td id="LC2388">                                <span>byte</span> <span>metadataConsumedByte</span>;</td>
      </tr>
      <tr>
        <td id="L2389" data-line-number="2389"></td>
        <td id="LC2389">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryPeekByte</span>(<span>out</span> <span>metadataConsumedByte</span>))</td>
      </tr>
      <tr>
        <td id="L2390" data-line-number="2390"></td>
        <td id="LC2390">                                {</td>
      </tr>
      <tr>
        <td id="L2391" data-line-number="2391"></td>
        <td id="LC2391">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2392" data-line-number="2392"></td>
        <td id="LC2392">                                }</td>
      </tr>
      <tr>
        <td id="L2393" data-line-number="2393"></td>
        <td id="LC2393">                                <span>if</span> (<span>!</span><span>dataStream</span>.<span>TrySetAltMetaDataSet</span>(<span>cleanupAltMetaDataSet</span>, (<span>TdsEnums</span>.<span>SQLALTMETADATA</span> <span>!=</span> <span>metadataConsumedByte</span>)))</td>
      </tr>
      <tr>
        <td id="L2394" data-line-number="2394"></td>
        <td id="LC2394">                                {</td>
      </tr>
      <tr>
        <td id="L2395" data-line-number="2395"></td>
        <td id="LC2395">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2396" data-line-number="2396"></td>
        <td id="LC2396">                                }</td>
      </tr>
      <tr>
        <td id="L2397" data-line-number="2397"></td>
        <td id="LC2397">                            }</td>
      </tr>
      <tr>
        <td id="L2398" data-line-number="2398"></td>
        <td id="LC2398">
</td>
      </tr>
      <tr>
        <td id="L2399" data-line-number="2399"></td>
        <td id="LC2399">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2400" data-line-number="2400"></td>
        <td id="LC2400">                        }</td>
      </tr>
      <tr>
        <td id="L2401" data-line-number="2401"></td>
        <td id="LC2401">
</td>
      </tr>
      <tr>
        <td id="L2402" data-line-number="2402"></td>
        <td id="LC2402">                    <span>case</span> <span>TdsEnums</span>.<span>SQLALTROW</span>:</td>
      </tr>
      <tr>
        <td id="L2403" data-line-number="2403"></td>
        <td id="LC2403">                        {</td>
      </tr>
      <tr>
        <td id="L2404" data-line-number="2404"></td>
        <td id="LC2404">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryStartNewRow</span>(<span>isNullCompressed</span>: <span>false</span>))</td>
      </tr>
      <tr>
        <td id="L2405" data-line-number="2405"></td>
        <td id="LC2405">                            { <span><span>//</span> altrows are not currently null compressed</span></td>
      </tr>
      <tr>
        <td id="L2406" data-line-number="2406"></td>
        <td id="LC2406">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2407" data-line-number="2407"></td>
        <td id="LC2407">                            }</td>
      </tr>
      <tr>
        <td id="L2408" data-line-number="2408"></td>
        <td id="LC2408">
</td>
      </tr>
      <tr>
        <td id="L2409" data-line-number="2409"></td>
        <td id="LC2409">                            <span><span>//</span> read will call run until dataReady. Must not read any data if return immediately set</span></td>
      </tr>
      <tr>
        <td id="L2410" data-line-number="2410"></td>
        <td id="LC2410">                            <span>if</span> (<span>RunBehavior</span>.<span>ReturnImmediately</span> <span>!=</span> (<span>RunBehavior</span>.<span>ReturnImmediately</span> <span>&amp;</span> <span>runBehavior</span>))</td>
      </tr>
      <tr>
        <td id="L2411" data-line-number="2411"></td>
        <td id="LC2411">                            {</td>
      </tr>
      <tr>
        <td id="L2412" data-line-number="2412"></td>
        <td id="LC2412">                                <span>ushort</span> <span>altRowId</span>;</td>
      </tr>
      <tr>
        <td id="L2413" data-line-number="2413"></td>
        <td id="LC2413">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>altRowId</span>))</td>
      </tr>
      <tr>
        <td id="L2414" data-line-number="2414"></td>
        <td id="LC2414">                                { <span><span>//</span> get altRowId</span></td>
      </tr>
      <tr>
        <td id="L2415" data-line-number="2415"></td>
        <td id="LC2415">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2416" data-line-number="2416"></td>
        <td id="LC2416">                                }</td>
      </tr>
      <tr>
        <td id="L2417" data-line-number="2417"></td>
        <td id="LC2417">
</td>
      </tr>
      <tr>
        <td id="L2418" data-line-number="2418"></td>
        <td id="LC2418">                                <span>if</span> (<span>!</span><span>TrySkipRow</span>(<span>stateObj</span>.<span>_cleanupAltMetaDataSetArray</span>.<span>GetAltMetaData</span>(<span>altRowId</span>), <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2419" data-line-number="2419"></td>
        <td id="LC2419">                                { <span><span>//</span> skip altRow</span></td>
      </tr>
      <tr>
        <td id="L2420" data-line-number="2420"></td>
        <td id="LC2420">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2421" data-line-number="2421"></td>
        <td id="LC2421">                                }</td>
      </tr>
      <tr>
        <td id="L2422" data-line-number="2422"></td>
        <td id="LC2422">                            }</td>
      </tr>
      <tr>
        <td id="L2423" data-line-number="2423"></td>
        <td id="LC2423">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2424" data-line-number="2424"></td>
        <td id="LC2424">                            {</td>
      </tr>
      <tr>
        <td id="L2425" data-line-number="2425"></td>
        <td id="LC2425">                                <span>dataReady</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2426" data-line-number="2426"></td>
        <td id="LC2426">                            }</td>
      </tr>
      <tr>
        <td id="L2427" data-line-number="2427"></td>
        <td id="LC2427">
</td>
      </tr>
      <tr>
        <td id="L2428" data-line-number="2428"></td>
        <td id="LC2428">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2429" data-line-number="2429"></td>
        <td id="LC2429">                        }</td>
      </tr>
      <tr>
        <td id="L2430" data-line-number="2430"></td>
        <td id="LC2430">
</td>
      </tr>
      <tr>
        <td id="L2431" data-line-number="2431"></td>
        <td id="LC2431">                    <span>case</span> <span>TdsEnums</span>.<span>SQLENVCHANGE</span>:</td>
      </tr>
      <tr>
        <td id="L2432" data-line-number="2432"></td>
        <td id="LC2432">                        {</td>
      </tr>
      <tr>
        <td id="L2433" data-line-number="2433"></td>
        <td id="LC2433">                            <span><span>//</span> ENVCHANGE must be processed synchronously (since it can modify the state of many objects)</span></td>
      </tr>
      <tr>
        <td id="L2434" data-line-number="2434"></td>
        <td id="LC2434">                            <span>stateObj</span>.<span>_syncOverAsync</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2435" data-line-number="2435"></td>
        <td id="LC2435">
</td>
      </tr>
      <tr>
        <td id="L2436" data-line-number="2436"></td>
        <td id="LC2436">                            <span>SqlEnvChange</span>[] <span>env</span>;</td>
      </tr>
      <tr>
        <td id="L2437" data-line-number="2437"></td>
        <td id="LC2437">                            <span>if</span> (<span>!</span><span>TryProcessEnvChange</span>(<span>tokenLength</span>, <span>stateObj</span>, <span>out</span> <span>env</span>))</td>
      </tr>
      <tr>
        <td id="L2438" data-line-number="2438"></td>
        <td id="LC2438">                            {</td>
      </tr>
      <tr>
        <td id="L2439" data-line-number="2439"></td>
        <td id="LC2439">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2440" data-line-number="2440"></td>
        <td id="LC2440">                            }</td>
      </tr>
      <tr>
        <td id="L2441" data-line-number="2441"></td>
        <td id="LC2441">
</td>
      </tr>
      <tr>
        <td id="L2442" data-line-number="2442"></td>
        <td id="LC2442">                            <span>for</span> (<span>int</span> <span>ii</span> <span>=</span> <span>0</span>; <span>ii</span> <span>&lt;</span> <span>env</span>.<span>Length</span>; <span>ii</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L2443" data-line-number="2443"></td>
        <td id="LC2443">                            {</td>
      </tr>
      <tr>
        <td id="L2444" data-line-number="2444"></td>
        <td id="LC2444">                                <span>if</span> (<span>env</span>[<span>ii</span>] <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>!</span><span>this</span>.<span>Connection</span>.<span>IgnoreEnvChange</span>)</td>
      </tr>
      <tr>
        <td id="L2445" data-line-number="2445"></td>
        <td id="LC2445">                                {</td>
      </tr>
      <tr>
        <td id="L2446" data-line-number="2446"></td>
        <td id="LC2446">                                    <span>switch</span> (<span>env</span>[<span>ii</span>].<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L2447" data-line-number="2447"></td>
        <td id="LC2447">                                    {</td>
      </tr>
      <tr>
        <td id="L2448" data-line-number="2448"></td>
        <td id="LC2448">                                        <span>case</span> <span>TdsEnums</span>.<span>ENV_BEGINTRAN</span>:</td>
      </tr>
      <tr>
        <td id="L2449" data-line-number="2449"></td>
        <td id="LC2449">                                        <span>case</span> <span>TdsEnums</span>.<span>ENV_ENLISTDTC</span>:</td>
      </tr>
      <tr>
        <td id="L2450" data-line-number="2450"></td>
        <td id="LC2450">                                            <span><span>//</span> When we get notification from the server of a new</span></td>
      </tr>
      <tr>
        <td id="L2451" data-line-number="2451"></td>
        <td id="LC2451">                                            <span><span>//</span> transaction, we move any pending transaction over to</span></td>
      </tr>
      <tr>
        <td id="L2452" data-line-number="2452"></td>
        <td id="LC2452">                                            <span><span>//</span> the current transaction, then we store the token in it.</span></td>
      </tr>
      <tr>
        <td id="L2453" data-line-number="2453"></td>
        <td id="LC2453">                                            <span><span>//</span> if there isn't a pending transaction, then it's either</span></td>
      </tr>
      <tr>
        <td id="L2454" data-line-number="2454"></td>
        <td id="LC2454">                                            <span><span>//</span> a TSQL transaction or a distributed transaction.</span></td>
      </tr>
      <tr>
        <td id="L2455" data-line-number="2455"></td>
        <td id="LC2455">                                            <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>==</span> <span>_currentTransaction</span>, <span><span>"</span>non-null current transaction with an ENV Change<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2456" data-line-number="2456"></td>
        <td id="LC2456">                                            <span>_currentTransaction</span> <span>=</span> <span>_pendingTransaction</span>;</td>
      </tr>
      <tr>
        <td id="L2457" data-line-number="2457"></td>
        <td id="LC2457">                                            <span>_pendingTransaction</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L2458" data-line-number="2458"></td>
        <td id="LC2458">
</td>
      </tr>
      <tr>
        <td id="L2459" data-line-number="2459"></td>
        <td id="LC2459">                                            <span>if</span> (<span>null</span> <span>!=</span> <span>_currentTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L2460" data-line-number="2460"></td>
        <td id="LC2460">                                            {</td>
      </tr>
      <tr>
        <td id="L2461" data-line-number="2461"></td>
        <td id="LC2461">                                                <span>_currentTransaction</span>.<span>TransactionId</span> <span>=</span> <span>env</span>[<span>ii</span>].<span>newLongValue</span>;   <span><span>//</span> this is defined as a ULongLong in the server and in the TDS Spec.</span></td>
      </tr>
      <tr>
        <td id="L2462" data-line-number="2462"></td>
        <td id="LC2462">                                            }</td>
      </tr>
      <tr>
        <td id="L2463" data-line-number="2463"></td>
        <td id="LC2463">                                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2464" data-line-number="2464"></td>
        <td id="LC2464">                                            {</td>
      </tr>
      <tr>
        <td id="L2465" data-line-number="2465"></td>
        <td id="LC2465">                                                <span>TransactionType</span> <span>transactionType</span> <span>=</span> (<span>TdsEnums</span>.<span>ENV_BEGINTRAN</span> <span>==</span> <span>env</span>[<span>ii</span>].<span>type</span>) <span>?</span> <span>TransactionType</span>.<span>LocalFromTSQL</span> <span>:</span> <span>TransactionType</span>.<span>Distributed</span>;</td>
      </tr>
      <tr>
        <td id="L2466" data-line-number="2466"></td>
        <td id="LC2466">                                                <span>_currentTransaction</span> <span>=</span> <span>new</span> <span>SqlInternalTransaction</span>(<span>_connHandler</span>, <span>transactionType</span>, <span>null</span>, <span>env</span>[<span>ii</span>].<span>newLongValue</span>);</td>
      </tr>
      <tr>
        <td id="L2467" data-line-number="2467"></td>
        <td id="LC2467">                                            }</td>
      </tr>
      <tr>
        <td id="L2468" data-line-number="2468"></td>
        <td id="LC2468">                                            <span>if</span> (<span>null</span> <span>!=</span> <span>_statistics</span> <span>&amp;&amp;</span> <span>!</span><span>_statisticsIsInTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L2469" data-line-number="2469"></td>
        <td id="LC2469">                                            {</td>
      </tr>
      <tr>
        <td id="L2470" data-line-number="2470"></td>
        <td id="LC2470">                                                <span>_statistics</span>.<span>SafeIncrement</span>(<span>ref</span> <span>_statistics</span>.<span>_transactions</span>);</td>
      </tr>
      <tr>
        <td id="L2471" data-line-number="2471"></td>
        <td id="LC2471">                                            }</td>
      </tr>
      <tr>
        <td id="L2472" data-line-number="2472"></td>
        <td id="LC2472">                                            <span>_statisticsIsInTransaction</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2473" data-line-number="2473"></td>
        <td id="LC2473">                                            <span>_retainedTransactionId</span> <span>=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>;</td>
      </tr>
      <tr>
        <td id="L2474" data-line-number="2474"></td>
        <td id="LC2474">                                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2475" data-line-number="2475"></td>
        <td id="LC2475">                                        <span>case</span> <span>TdsEnums</span>.<span>ENV_DEFECTDTC</span>:</td>
      </tr>
      <tr>
        <td id="L2476" data-line-number="2476"></td>
        <td id="LC2476">                                        <span>case</span> <span>TdsEnums</span>.<span>ENV_TRANSACTIONENDED</span>:</td>
      </tr>
      <tr>
        <td id="L2477" data-line-number="2477"></td>
        <td id="LC2477">                                        <span>case</span> <span>TdsEnums</span>.<span>ENV_COMMITTRAN</span>:</td>
      </tr>
      <tr>
        <td id="L2478" data-line-number="2478"></td>
        <td id="LC2478">                                            <span><span>//</span> SQLHOT 483</span></td>
      </tr>
      <tr>
        <td id="L2479" data-line-number="2479"></td>
        <td id="LC2479">                                            <span><span>//</span>  Must clear the retain id if the server-side transaction ends by anything other</span></td>
      </tr>
      <tr>
        <td id="L2480" data-line-number="2480"></td>
        <td id="LC2480">                                            <span><span>//</span>  than rollback.</span></td>
      </tr>
      <tr>
        <td id="L2481" data-line-number="2481"></td>
        <td id="LC2481">                                            <span>_retainedTransactionId</span> <span>=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>;</td>
      </tr>
      <tr>
        <td id="L2482" data-line-number="2482"></td>
        <td id="LC2482">                                            <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>ENV_ROLLBACKTRAN</span>;</td>
      </tr>
      <tr>
        <td id="L2483" data-line-number="2483"></td>
        <td id="LC2483">                                        <span>case</span> <span>TdsEnums</span>.<span>ENV_ROLLBACKTRAN</span>:</td>
      </tr>
      <tr>
        <td id="L2484" data-line-number="2484"></td>
        <td id="LC2484">                                            <span><span>//</span> When we get notification of a completed transaction</span></td>
      </tr>
      <tr>
        <td id="L2485" data-line-number="2485"></td>
        <td id="LC2485">                                            <span><span>//</span> we null out the current transaction.</span></td>
      </tr>
      <tr>
        <td id="L2486" data-line-number="2486"></td>
        <td id="LC2486">                                            <span>if</span> (<span>null</span> <span>!=</span> <span>_currentTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L2487" data-line-number="2487"></td>
        <td id="LC2487">                                            {</td>
      </tr>
      <tr>
        <td id="L2488" data-line-number="2488"></td>
        <td id="LC2488">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L2489" data-line-number="2489"></td>
        <td id="LC2489">                                                <span><span>//</span> Check null for case where Begin and Rollback obtained in the same message.</span></td>
      </tr>
      <tr>
        <td id="L2490" data-line-number="2490"></td>
        <td id="LC2490">                                                <span>if</span> (<span>SqlInternalTransaction</span>.<span>NullTransactionId</span> <span>!=</span> <span>_currentTransaction</span>.<span>TransactionId</span>)</td>
      </tr>
      <tr>
        <td id="L2491" data-line-number="2491"></td>
        <td id="LC2491">                                                {</td>
      </tr>
      <tr>
        <td id="L2492" data-line-number="2492"></td>
        <td id="LC2492">                                                    <span>Debug</span>.<span>Assert</span>(<span>_currentTransaction</span>.<span>TransactionId</span> <span>!=</span> <span>env</span>[<span>ii</span>].<span>newLongValue</span>, <span><span>"</span>transaction id's are not equal!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2493" data-line-number="2493"></td>
        <td id="LC2493">                                                }</td>
      </tr>
      <tr>
        <td id="L2494" data-line-number="2494"></td>
        <td id="LC2494">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L2495" data-line-number="2495"></td>
        <td id="LC2495">
</td>
      </tr>
      <tr>
        <td id="L2496" data-line-number="2496"></td>
        <td id="LC2496">                                                <span>if</span> (<span>TdsEnums</span>.<span>ENV_COMMITTRAN</span> <span>==</span> <span>env</span>[<span>ii</span>].<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L2497" data-line-number="2497"></td>
        <td id="LC2497">                                                {</td>
      </tr>
      <tr>
        <td id="L2498" data-line-number="2498"></td>
        <td id="LC2498">                                                    <span>_currentTransaction</span>.<span>Completed</span>(<span>TransactionState</span>.<span>Committed</span>);</td>
      </tr>
      <tr>
        <td id="L2499" data-line-number="2499"></td>
        <td id="LC2499">                                                }</td>
      </tr>
      <tr>
        <td id="L2500" data-line-number="2500"></td>
        <td id="LC2500">                                                <span>else</span> <span>if</span> (<span>TdsEnums</span>.<span>ENV_ROLLBACKTRAN</span> <span>==</span> <span>env</span>[<span>ii</span>].<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L2501" data-line-number="2501"></td>
        <td id="LC2501">                                                {</td>
      </tr>
      <tr>
        <td id="L2502" data-line-number="2502"></td>
        <td id="LC2502">                                                    <span><span>//</span>  Hold onto transaction id if distributed tran is rolled back.  This must</span></td>
      </tr>
      <tr>
        <td id="L2503" data-line-number="2503"></td>
        <td id="LC2503">                                                    <span><span>//</span>  be sent to the server on subsequent executions even though the transaction</span></td>
      </tr>
      <tr>
        <td id="L2504" data-line-number="2504"></td>
        <td id="LC2504">                                                    <span><span>//</span>  is considered to be rolled back.</span></td>
      </tr>
      <tr>
        <td id="L2505" data-line-number="2505"></td>
        <td id="LC2505">                                                    <span>if</span> (<span>_currentTransaction</span>.<span>IsDistributed</span> <span>&amp;&amp;</span> <span>_currentTransaction</span>.<span>IsActive</span>)</td>
      </tr>
      <tr>
        <td id="L2506" data-line-number="2506"></td>
        <td id="LC2506">                                                    {</td>
      </tr>
      <tr>
        <td id="L2507" data-line-number="2507"></td>
        <td id="LC2507">                                                        <span>_retainedTransactionId</span> <span>=</span> <span>env</span>[<span>ii</span>].<span>oldLongValue</span>;</td>
      </tr>
      <tr>
        <td id="L2508" data-line-number="2508"></td>
        <td id="LC2508">                                                    }</td>
      </tr>
      <tr>
        <td id="L2509" data-line-number="2509"></td>
        <td id="LC2509">                                                    <span>_currentTransaction</span>.<span>Completed</span>(<span>TransactionState</span>.<span>Aborted</span>);</td>
      </tr>
      <tr>
        <td id="L2510" data-line-number="2510"></td>
        <td id="LC2510">                                                }</td>
      </tr>
      <tr>
        <td id="L2511" data-line-number="2511"></td>
        <td id="LC2511">                                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L2512" data-line-number="2512"></td>
        <td id="LC2512">                                                {</td>
      </tr>
      <tr>
        <td id="L2513" data-line-number="2513"></td>
        <td id="LC2513">                                                    <span><span>//</span> TODO: While not techically necessary at this point, we are not certain whether TransactionEnded indicates Committed, Aborted or Unknown - this is fine for now, but we should investigate.</span></td>
      </tr>
      <tr>
        <td id="L2514" data-line-number="2514"></td>
        <td id="LC2514">                                                    <span>_currentTransaction</span>.<span>Completed</span>(<span>TransactionState</span>.<span>Unknown</span>);</td>
      </tr>
      <tr>
        <td id="L2515" data-line-number="2515"></td>
        <td id="LC2515">                                                }</td>
      </tr>
      <tr>
        <td id="L2516" data-line-number="2516"></td>
        <td id="LC2516">                                                <span>_currentTransaction</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L2517" data-line-number="2517"></td>
        <td id="LC2517">                                            }</td>
      </tr>
      <tr>
        <td id="L2518" data-line-number="2518"></td>
        <td id="LC2518">                                            <span>_statisticsIsInTransaction</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2519" data-line-number="2519"></td>
        <td id="LC2519">                                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2520" data-line-number="2520"></td>
        <td id="LC2520">                                        <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L2521" data-line-number="2521"></td>
        <td id="LC2521">                                            <span>_connHandler</span>.<span>OnEnvChange</span>(<span>env</span>[<span>ii</span>]);</td>
      </tr>
      <tr>
        <td id="L2522" data-line-number="2522"></td>
        <td id="LC2522">                                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2523" data-line-number="2523"></td>
        <td id="LC2523">                                    }</td>
      </tr>
      <tr>
        <td id="L2524" data-line-number="2524"></td>
        <td id="LC2524">                                }</td>
      </tr>
      <tr>
        <td id="L2525" data-line-number="2525"></td>
        <td id="LC2525">                            }</td>
      </tr>
      <tr>
        <td id="L2526" data-line-number="2526"></td>
        <td id="LC2526">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2527" data-line-number="2527"></td>
        <td id="LC2527">                        }</td>
      </tr>
      <tr>
        <td id="L2528" data-line-number="2528"></td>
        <td id="LC2528">                    <span>case</span> <span>TdsEnums</span>.<span>SQLLOGINACK</span>:</td>
      </tr>
      <tr>
        <td id="L2529" data-line-number="2529"></td>
        <td id="LC2529">                        {</td>
      </tr>
      <tr>
        <td id="L2530" data-line-number="2530"></td>
        <td id="LC2530">                            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryRun|SEC&gt; Received login acknowledgement token<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2531" data-line-number="2531"></td>
        <td id="LC2531">                            <span>SqlLoginAck</span> <span>ack</span>;</td>
      </tr>
      <tr>
        <td id="L2532" data-line-number="2532"></td>
        <td id="LC2532">                            <span>if</span> (<span>!</span><span>TryProcessLoginAck</span>(<span>stateObj</span>, <span>out</span> <span>ack</span>))</td>
      </tr>
      <tr>
        <td id="L2533" data-line-number="2533"></td>
        <td id="LC2533">                            {</td>
      </tr>
      <tr>
        <td id="L2534" data-line-number="2534"></td>
        <td id="LC2534">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2535" data-line-number="2535"></td>
        <td id="LC2535">                            }</td>
      </tr>
      <tr>
        <td id="L2536" data-line-number="2536"></td>
        <td id="LC2536">
</td>
      </tr>
      <tr>
        <td id="L2537" data-line-number="2537"></td>
        <td id="LC2537">                            <span>_connHandler</span>.<span>OnLoginAck</span>(<span>ack</span>);</td>
      </tr>
      <tr>
        <td id="L2538" data-line-number="2538"></td>
        <td id="LC2538">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2539" data-line-number="2539"></td>
        <td id="LC2539">                        }</td>
      </tr>
      <tr>
        <td id="L2540" data-line-number="2540"></td>
        <td id="LC2540">                    <span>case</span> <span>TdsEnums</span>.<span>SQLFEATUREEXTACK</span>:</td>
      </tr>
      <tr>
        <td id="L2541" data-line-number="2541"></td>
        <td id="LC2541">                        {</td>
      </tr>
      <tr>
        <td id="L2542" data-line-number="2542"></td>
        <td id="LC2542">                            <span>if</span> (<span>!</span><span>TryProcessFeatureExtAck</span>(<span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2543" data-line-number="2543"></td>
        <td id="LC2543">                            {</td>
      </tr>
      <tr>
        <td id="L2544" data-line-number="2544"></td>
        <td id="LC2544">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2545" data-line-number="2545"></td>
        <td id="LC2545">                            }</td>
      </tr>
      <tr>
        <td id="L2546" data-line-number="2546"></td>
        <td id="LC2546">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2547" data-line-number="2547"></td>
        <td id="LC2547">                        }</td>
      </tr>
      <tr>
        <td id="L2548" data-line-number="2548"></td>
        <td id="LC2548">                    <span>case</span> <span>TdsEnums</span>.<span>SQLFEDAUTHINFO</span>:</td>
      </tr>
      <tr>
        <td id="L2549" data-line-number="2549"></td>
        <td id="LC2549">                        {</td>
      </tr>
      <tr>
        <td id="L2550" data-line-number="2550"></td>
        <td id="LC2550">                            <span>_connHandler</span>.<span>_federatedAuthenticationInfoReceived</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2551" data-line-number="2551"></td>
        <td id="LC2551">                            <span>SqlFedAuthInfo</span> <span>info</span>;</td>
      </tr>
      <tr>
        <td id="L2552" data-line-number="2552"></td>
        <td id="LC2552">                            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryRun|SEC&gt; Received federated authentication info token<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2553" data-line-number="2553"></td>
        <td id="LC2553">                            <span>if</span> (<span>!</span><span>TryProcessFedAuthInfo</span>(<span>stateObj</span>, <span>tokenLength</span>, <span>out</span> <span>info</span>))</td>
      </tr>
      <tr>
        <td id="L2554" data-line-number="2554"></td>
        <td id="LC2554">                            {</td>
      </tr>
      <tr>
        <td id="L2555" data-line-number="2555"></td>
        <td id="LC2555">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2556" data-line-number="2556"></td>
        <td id="LC2556">                            }</td>
      </tr>
      <tr>
        <td id="L2557" data-line-number="2557"></td>
        <td id="LC2557">                            <span>_connHandler</span>.<span>OnFedAuthInfo</span>(<span>info</span>);</td>
      </tr>
      <tr>
        <td id="L2558" data-line-number="2558"></td>
        <td id="LC2558">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2559" data-line-number="2559"></td>
        <td id="LC2559">                        }</td>
      </tr>
      <tr>
        <td id="L2560" data-line-number="2560"></td>
        <td id="LC2560">                    <span>case</span> <span>TdsEnums</span>.<span>SQLSESSIONSTATE</span>:</td>
      </tr>
      <tr>
        <td id="L2561" data-line-number="2561"></td>
        <td id="LC2561">                        {</td>
      </tr>
      <tr>
        <td id="L2562" data-line-number="2562"></td>
        <td id="LC2562">                            <span>if</span> (<span>!</span><span>TryProcessSessionState</span>(<span>stateObj</span>, <span>tokenLength</span>, <span>_connHandler</span>.<span>_currentSessionData</span>))</td>
      </tr>
      <tr>
        <td id="L2563" data-line-number="2563"></td>
        <td id="LC2563">                            {</td>
      </tr>
      <tr>
        <td id="L2564" data-line-number="2564"></td>
        <td id="LC2564">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2565" data-line-number="2565"></td>
        <td id="LC2565">                            }</td>
      </tr>
      <tr>
        <td id="L2566" data-line-number="2566"></td>
        <td id="LC2566">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2567" data-line-number="2567"></td>
        <td id="LC2567">                        }</td>
      </tr>
      <tr>
        <td id="L2568" data-line-number="2568"></td>
        <td id="LC2568">                    <span>case</span> <span>TdsEnums</span>.<span>SQLCOLMETADATA</span>:</td>
      </tr>
      <tr>
        <td id="L2569" data-line-number="2569"></td>
        <td id="LC2569">                        {</td>
      </tr>
      <tr>
        <td id="L2570" data-line-number="2570"></td>
        <td id="LC2570">                            <span>if</span> (<span>tokenLength</span> <span>!=</span> <span>TdsEnums</span>.<span>VARNULL</span>)</td>
      </tr>
      <tr>
        <td id="L2571" data-line-number="2571"></td>
        <td id="LC2571">                            {</td>
      </tr>
      <tr>
        <td id="L2572" data-line-number="2572"></td>
        <td id="LC2572">                                <span>_SqlMetaDataSet</span> <span>metadata</span>;</td>
      </tr>
      <tr>
        <td id="L2573" data-line-number="2573"></td>
        <td id="LC2573">                                <span>if</span> (<span>!</span><span>TryProcessMetaData</span>(<span>tokenLength</span>, <span>stateObj</span>, <span>out</span> <span>metadata</span>,</td>
      </tr>
      <tr>
        <td id="L2574" data-line-number="2574"></td>
        <td id="LC2574">                                                        <span>cmdHandler</span> <span>!=</span> <span>null</span> <span>?</span> <span>cmdHandler</span>.<span>ColumnEncryptionSetting</span> <span>:</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>UseConnectionSetting</span>))</td>
      </tr>
      <tr>
        <td id="L2575" data-line-number="2575"></td>
        <td id="LC2575">                                {</td>
      </tr>
      <tr>
        <td id="L2576" data-line-number="2576"></td>
        <td id="LC2576">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2577" data-line-number="2577"></td>
        <td id="LC2577">                                }</td>
      </tr>
      <tr>
        <td id="L2578" data-line-number="2578"></td>
        <td id="LC2578">                                <span>stateObj</span>.<span>_cleanupMetaData</span> <span>=</span> <span>metadata</span>;</td>
      </tr>
      <tr>
        <td id="L2579" data-line-number="2579"></td>
        <td id="LC2579">                            }</td>
      </tr>
      <tr>
        <td id="L2580" data-line-number="2580"></td>
        <td id="LC2580">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2581" data-line-number="2581"></td>
        <td id="LC2581">                            {</td>
      </tr>
      <tr>
        <td id="L2582" data-line-number="2582"></td>
        <td id="LC2582">                                <span>if</span> (<span>cmdHandler</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2583" data-line-number="2583"></td>
        <td id="LC2583">                                {</td>
      </tr>
      <tr>
        <td id="L2584" data-line-number="2584"></td>
        <td id="LC2584">                                    <span>stateObj</span>.<span>_cleanupMetaData</span> <span>=</span> <span>cmdHandler</span>.<span>MetaData</span>;</td>
      </tr>
      <tr>
        <td id="L2585" data-line-number="2585"></td>
        <td id="LC2585">                                }</td>
      </tr>
      <tr>
        <td id="L2586" data-line-number="2586"></td>
        <td id="LC2586">                            }</td>
      </tr>
      <tr>
        <td id="L2587" data-line-number="2587"></td>
        <td id="LC2587">
</td>
      </tr>
      <tr>
        <td id="L2588" data-line-number="2588"></td>
        <td id="LC2588">                            <span>if</span> (<span>null</span> <span>!=</span> <span>dataStream</span>)</td>
      </tr>
      <tr>
        <td id="L2589" data-line-number="2589"></td>
        <td id="LC2589">                            {</td>
      </tr>
      <tr>
        <td id="L2590" data-line-number="2590"></td>
        <td id="LC2590">                                <span>byte</span> <span>peekedToken</span>;</td>
      </tr>
      <tr>
        <td id="L2591" data-line-number="2591"></td>
        <td id="LC2591">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryPeekByte</span>(<span>out</span> <span>peekedToken</span>))</td>
      </tr>
      <tr>
        <td id="L2592" data-line-number="2592"></td>
        <td id="LC2592">                                { <span><span>//</span> temporarily cache next byte</span></td>
      </tr>
      <tr>
        <td id="L2593" data-line-number="2593"></td>
        <td id="LC2593">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2594" data-line-number="2594"></td>
        <td id="LC2594">                                }</td>
      </tr>
      <tr>
        <td id="L2595" data-line-number="2595"></td>
        <td id="LC2595">
</td>
      </tr>
      <tr>
        <td id="L2596" data-line-number="2596"></td>
        <td id="LC2596">                                <span>if</span> (<span>TdsEnums</span>.<span>SQLDATACLASSIFICATION</span> <span>==</span> <span>peekedToken</span>)</td>
      </tr>
      <tr>
        <td id="L2597" data-line-number="2597"></td>
        <td id="LC2597">                                {</td>
      </tr>
      <tr>
        <td id="L2598" data-line-number="2598"></td>
        <td id="LC2598">                                    <span>byte</span> <span>dataClassificationToken</span>;</td>
      </tr>
      <tr>
        <td id="L2599" data-line-number="2599"></td>
        <td id="LC2599">                                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>dataClassificationToken</span>))</td>
      </tr>
      <tr>
        <td id="L2600" data-line-number="2600"></td>
        <td id="LC2600">                                    {</td>
      </tr>
      <tr>
        <td id="L2601" data-line-number="2601"></td>
        <td id="LC2601">                                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2602" data-line-number="2602"></td>
        <td id="LC2602">                                    }</td>
      </tr>
      <tr>
        <td id="L2603" data-line-number="2603"></td>
        <td id="LC2603">                                    <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>SQLDATACLASSIFICATION</span> <span>==</span> <span>dataClassificationToken</span>);</td>
      </tr>
      <tr>
        <td id="L2604" data-line-number="2604"></td>
        <td id="LC2604">
</td>
      </tr>
      <tr>
        <td id="L2605" data-line-number="2605"></td>
        <td id="LC2605">                                    <span>SensitivityClassification</span> <span>sensitivityClassification</span>;</td>
      </tr>
      <tr>
        <td id="L2606" data-line-number="2606"></td>
        <td id="LC2606">                                    <span>if</span> (<span>!</span><span>TryProcessDataClassification</span>(<span>stateObj</span>, <span>out</span> <span>sensitivityClassification</span>))</td>
      </tr>
      <tr>
        <td id="L2607" data-line-number="2607"></td>
        <td id="LC2607">                                    {</td>
      </tr>
      <tr>
        <td id="L2608" data-line-number="2608"></td>
        <td id="LC2608">                                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2609" data-line-number="2609"></td>
        <td id="LC2609">                                    }</td>
      </tr>
      <tr>
        <td id="L2610" data-line-number="2610"></td>
        <td id="LC2610">                                    <span>if</span> (<span>!</span><span>dataStream</span>.<span>TrySetSensitivityClassification</span>(<span>sensitivityClassification</span>))</td>
      </tr>
      <tr>
        <td id="L2611" data-line-number="2611"></td>
        <td id="LC2611">                                    {</td>
      </tr>
      <tr>
        <td id="L2612" data-line-number="2612"></td>
        <td id="LC2612">                                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2613" data-line-number="2613"></td>
        <td id="LC2613">                                    }</td>
      </tr>
      <tr>
        <td id="L2614" data-line-number="2614"></td>
        <td id="LC2614">
</td>
      </tr>
      <tr>
        <td id="L2615" data-line-number="2615"></td>
        <td id="LC2615">                                    <span><span>//</span> update peekedToken</span></td>
      </tr>
      <tr>
        <td id="L2616" data-line-number="2616"></td>
        <td id="LC2616">                                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryPeekByte</span>(<span>out</span> <span>peekedToken</span>))</td>
      </tr>
      <tr>
        <td id="L2617" data-line-number="2617"></td>
        <td id="LC2617">                                    {</td>
      </tr>
      <tr>
        <td id="L2618" data-line-number="2618"></td>
        <td id="LC2618">                                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2619" data-line-number="2619"></td>
        <td id="LC2619">                                    }</td>
      </tr>
      <tr>
        <td id="L2620" data-line-number="2620"></td>
        <td id="LC2620">                                }</td>
      </tr>
      <tr>
        <td id="L2621" data-line-number="2621"></td>
        <td id="LC2621">
</td>
      </tr>
      <tr>
        <td id="L2622" data-line-number="2622"></td>
        <td id="LC2622">                                <span>if</span> (<span>!</span><span>dataStream</span>.<span>TrySetMetaData</span>(<span>stateObj</span>.<span>_cleanupMetaData</span>, (<span>TdsEnums</span>.<span>SQLTABNAME</span> <span>==</span> <span>peekedToken</span> <span>||</span> <span>TdsEnums</span>.<span>SQLCOLINFO</span> <span>==</span> <span>peekedToken</span>)))</td>
      </tr>
      <tr>
        <td id="L2623" data-line-number="2623"></td>
        <td id="LC2623">                                {</td>
      </tr>
      <tr>
        <td id="L2624" data-line-number="2624"></td>
        <td id="LC2624">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2625" data-line-number="2625"></td>
        <td id="LC2625">                                }</td>
      </tr>
      <tr>
        <td id="L2626" data-line-number="2626"></td>
        <td id="LC2626">                            }</td>
      </tr>
      <tr>
        <td id="L2627" data-line-number="2627"></td>
        <td id="LC2627">                            <span>else</span> <span>if</span> (<span>null</span> <span>!=</span> <span>bulkCopyHandler</span>)</td>
      </tr>
      <tr>
        <td id="L2628" data-line-number="2628"></td>
        <td id="LC2628">                            {</td>
      </tr>
      <tr>
        <td id="L2629" data-line-number="2629"></td>
        <td id="LC2629">                                <span>bulkCopyHandler</span>.<span>SetMetaData</span>(<span>stateObj</span>.<span>_cleanupMetaData</span>);</td>
      </tr>
      <tr>
        <td id="L2630" data-line-number="2630"></td>
        <td id="LC2630">                            }</td>
      </tr>
      <tr>
        <td id="L2631" data-line-number="2631"></td>
        <td id="LC2631">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2632" data-line-number="2632"></td>
        <td id="LC2632">                        }</td>
      </tr>
      <tr>
        <td id="L2633" data-line-number="2633"></td>
        <td id="LC2633">                    <span>case</span> <span>TdsEnums</span>.<span>SQLROW</span>:</td>
      </tr>
      <tr>
        <td id="L2634" data-line-number="2634"></td>
        <td id="LC2634">                    <span>case</span> <span>TdsEnums</span>.<span>SQLNBCROW</span>:</td>
      </tr>
      <tr>
        <td id="L2635" data-line-number="2635"></td>
        <td id="LC2635">                        {</td>
      </tr>
      <tr>
        <td id="L2636" data-line-number="2636"></td>
        <td id="LC2636">                            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_cleanupMetaData</span> <span>!=</span> <span>null</span>, <span><span>"</span>Reading a row, but the metadata is null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2637" data-line-number="2637"></td>
        <td id="LC2637">
</td>
      </tr>
      <tr>
        <td id="L2638" data-line-number="2638"></td>
        <td id="LC2638">                            <span>if</span> (<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLNBCROW</span>)</td>
      </tr>
      <tr>
        <td id="L2639" data-line-number="2639"></td>
        <td id="LC2639">                            {</td>
      </tr>
      <tr>
        <td id="L2640" data-line-number="2640"></td>
        <td id="LC2640">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryStartNewRow</span>(<span>isNullCompressed</span>: <span>true</span>, <span>nullBitmapColumnsCount</span>: <span>stateObj</span>.<span>_cleanupMetaData</span>.<span>Length</span>))</td>
      </tr>
      <tr>
        <td id="L2641" data-line-number="2641"></td>
        <td id="LC2641">                                {</td>
      </tr>
      <tr>
        <td id="L2642" data-line-number="2642"></td>
        <td id="LC2642">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2643" data-line-number="2643"></td>
        <td id="LC2643">                                }</td>
      </tr>
      <tr>
        <td id="L2644" data-line-number="2644"></td>
        <td id="LC2644">                            }</td>
      </tr>
      <tr>
        <td id="L2645" data-line-number="2645"></td>
        <td id="LC2645">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2646" data-line-number="2646"></td>
        <td id="LC2646">                            {</td>
      </tr>
      <tr>
        <td id="L2647" data-line-number="2647"></td>
        <td id="LC2647">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryStartNewRow</span>(<span>isNullCompressed</span>: <span>false</span>))</td>
      </tr>
      <tr>
        <td id="L2648" data-line-number="2648"></td>
        <td id="LC2648">                                {</td>
      </tr>
      <tr>
        <td id="L2649" data-line-number="2649"></td>
        <td id="LC2649">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2650" data-line-number="2650"></td>
        <td id="LC2650">                                }</td>
      </tr>
      <tr>
        <td id="L2651" data-line-number="2651"></td>
        <td id="LC2651">                            }</td>
      </tr>
      <tr>
        <td id="L2652" data-line-number="2652"></td>
        <td id="LC2652">
</td>
      </tr>
      <tr>
        <td id="L2653" data-line-number="2653"></td>
        <td id="LC2653">                            <span>if</span> (<span>null</span> <span>!=</span> <span>bulkCopyHandler</span>)</td>
      </tr>
      <tr>
        <td id="L2654" data-line-number="2654"></td>
        <td id="LC2654">                            {</td>
      </tr>
      <tr>
        <td id="L2655" data-line-number="2655"></td>
        <td id="LC2655">                                <span><span>//</span> TODO: Consider improving Bulk Copy performance by avoiding boxing.</span></td>
      </tr>
      <tr>
        <td id="L2656" data-line-number="2656"></td>
        <td id="LC2656">                                <span>if</span> (<span>!</span><span>TryProcessRow</span>(<span>stateObj</span>.<span>_cleanupMetaData</span>, <span>bulkCopyHandler</span>.<span>CreateRowBuffer</span>(), <span>bulkCopyHandler</span>.<span>CreateIndexMap</span>(), <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2657" data-line-number="2657"></td>
        <td id="LC2657">                                {</td>
      </tr>
      <tr>
        <td id="L2658" data-line-number="2658"></td>
        <td id="LC2658">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2659" data-line-number="2659"></td>
        <td id="LC2659">                                }</td>
      </tr>
      <tr>
        <td id="L2660" data-line-number="2660"></td>
        <td id="LC2660">                            }</td>
      </tr>
      <tr>
        <td id="L2661" data-line-number="2661"></td>
        <td id="LC2661">                            <span>else</span> <span>if</span> (<span>RunBehavior</span>.<span>ReturnImmediately</span> <span>!=</span> (<span>RunBehavior</span>.<span>ReturnImmediately</span> <span>&amp;</span> <span>runBehavior</span>))</td>
      </tr>
      <tr>
        <td id="L2662" data-line-number="2662"></td>
        <td id="LC2662">                            {</td>
      </tr>
      <tr>
        <td id="L2663" data-line-number="2663"></td>
        <td id="LC2663">                                <span>if</span> (<span>!</span><span>TrySkipRow</span>(<span>stateObj</span>.<span>_cleanupMetaData</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2664" data-line-number="2664"></td>
        <td id="LC2664">                                { <span><span>//</span> skip rows</span></td>
      </tr>
      <tr>
        <td id="L2665" data-line-number="2665"></td>
        <td id="LC2665">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2666" data-line-number="2666"></td>
        <td id="LC2666">                                }</td>
      </tr>
      <tr>
        <td id="L2667" data-line-number="2667"></td>
        <td id="LC2667">                            }</td>
      </tr>
      <tr>
        <td id="L2668" data-line-number="2668"></td>
        <td id="LC2668">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2669" data-line-number="2669"></td>
        <td id="LC2669">                            {</td>
      </tr>
      <tr>
        <td id="L2670" data-line-number="2670"></td>
        <td id="LC2670">                                <span>dataReady</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2671" data-line-number="2671"></td>
        <td id="LC2671">                            }</td>
      </tr>
      <tr>
        <td id="L2672" data-line-number="2672"></td>
        <td id="LC2672">
</td>
      </tr>
      <tr>
        <td id="L2673" data-line-number="2673"></td>
        <td id="LC2673">                            <span>if</span> (<span>_statistics</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2674" data-line-number="2674"></td>
        <td id="LC2674">                            {</td>
      </tr>
      <tr>
        <td id="L2675" data-line-number="2675"></td>
        <td id="LC2675">                                <span>_statistics</span>.<span>WaitForDoneAfterRow</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2676" data-line-number="2676"></td>
        <td id="LC2676">                            }</td>
      </tr>
      <tr>
        <td id="L2677" data-line-number="2677"></td>
        <td id="LC2677">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2678" data-line-number="2678"></td>
        <td id="LC2678">                        }</td>
      </tr>
      <tr>
        <td id="L2679" data-line-number="2679"></td>
        <td id="LC2679">                    <span>case</span> <span>TdsEnums</span>.<span>SQLRETURNSTATUS</span>:</td>
      </tr>
      <tr>
        <td id="L2680" data-line-number="2680"></td>
        <td id="LC2680">                        <span>int</span> <span>status</span>;</td>
      </tr>
      <tr>
        <td id="L2681" data-line-number="2681"></td>
        <td id="LC2681">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>status</span>))</td>
      </tr>
      <tr>
        <td id="L2682" data-line-number="2682"></td>
        <td id="LC2682">                        {</td>
      </tr>
      <tr>
        <td id="L2683" data-line-number="2683"></td>
        <td id="LC2683">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2684" data-line-number="2684"></td>
        <td id="LC2684">                        }</td>
      </tr>
      <tr>
        <td id="L2685" data-line-number="2685"></td>
        <td id="LC2685">                        <span>if</span> (<span>cmdHandler</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2686" data-line-number="2686"></td>
        <td id="LC2686">                        {</td>
      </tr>
      <tr>
        <td id="L2687" data-line-number="2687"></td>
        <td id="LC2687">                            <span>cmdHandler</span>.<span>OnReturnStatus</span>(<span>status</span>);</td>
      </tr>
      <tr>
        <td id="L2688" data-line-number="2688"></td>
        <td id="LC2688">                        }</td>
      </tr>
      <tr>
        <td id="L2689" data-line-number="2689"></td>
        <td id="LC2689">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2690" data-line-number="2690"></td>
        <td id="LC2690">                    <span>case</span> <span>TdsEnums</span>.<span>SQLRETURNVALUE</span>:</td>
      </tr>
      <tr>
        <td id="L2691" data-line-number="2691"></td>
        <td id="LC2691">                        {</td>
      </tr>
      <tr>
        <td id="L2692" data-line-number="2692"></td>
        <td id="LC2692">                            <span>SqlReturnValue</span> <span>returnValue</span>;</td>
      </tr>
      <tr>
        <td id="L2693" data-line-number="2693"></td>
        <td id="LC2693">                            <span>if</span> (<span>!</span><span>TryProcessReturnValue</span>(<span>tokenLength</span>, <span>stateObj</span>, <span>out</span> <span>returnValue</span>,</td>
      </tr>
      <tr>
        <td id="L2694" data-line-number="2694"></td>
        <td id="LC2694">                                                       <span>cmdHandler</span> <span>!=</span> <span>null</span> <span>?</span> <span>cmdHandler</span>.<span>ColumnEncryptionSetting</span> <span>:</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>UseConnectionSetting</span>))</td>
      </tr>
      <tr>
        <td id="L2695" data-line-number="2695"></td>
        <td id="LC2695">                            {</td>
      </tr>
      <tr>
        <td id="L2696" data-line-number="2696"></td>
        <td id="LC2696">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2697" data-line-number="2697"></td>
        <td id="LC2697">                            }</td>
      </tr>
      <tr>
        <td id="L2698" data-line-number="2698"></td>
        <td id="LC2698">                            <span>if</span> (<span>cmdHandler</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L2699" data-line-number="2699"></td>
        <td id="LC2699">                            {</td>
      </tr>
      <tr>
        <td id="L2700" data-line-number="2700"></td>
        <td id="LC2700">                                <span>cmdHandler</span>.<span>OnReturnValue</span>(<span>returnValue</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L2701" data-line-number="2701"></td>
        <td id="LC2701">                            }</td>
      </tr>
      <tr>
        <td id="L2702" data-line-number="2702"></td>
        <td id="LC2702">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2703" data-line-number="2703"></td>
        <td id="LC2703">                        }</td>
      </tr>
      <tr>
        <td id="L2704" data-line-number="2704"></td>
        <td id="LC2704">                    <span>case</span> <span>TdsEnums</span>.<span>SQLSSPI</span>:</td>
      </tr>
      <tr>
        <td id="L2705" data-line-number="2705"></td>
        <td id="LC2705">                        {</td>
      </tr>
      <tr>
        <td id="L2706" data-line-number="2706"></td>
        <td id="LC2706">                            <span><span>//</span> token length is length of SSPI data - call ProcessSSPI with it</span></td>
      </tr>
      <tr>
        <td id="L2707" data-line-number="2707"></td>
        <td id="LC2707">
</td>
      </tr>
      <tr>
        <td id="L2708" data-line-number="2708"></td>
        <td id="LC2708">                            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_syncOverAsync</span>, <span><span>"</span>ProcessSSPI does not support retry, do not attempt asynchronously<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2709" data-line-number="2709"></td>
        <td id="LC2709">                            <span>stateObj</span>.<span>_syncOverAsync</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2710" data-line-number="2710"></td>
        <td id="LC2710">
</td>
      </tr>
      <tr>
        <td id="L2711" data-line-number="2711"></td>
        <td id="LC2711">                            <span>ProcessSSPI</span>(<span>tokenLength</span>);</td>
      </tr>
      <tr>
        <td id="L2712" data-line-number="2712"></td>
        <td id="LC2712">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2713" data-line-number="2713"></td>
        <td id="LC2713">                        }</td>
      </tr>
      <tr>
        <td id="L2714" data-line-number="2714"></td>
        <td id="LC2714">                    <span>case</span> <span>TdsEnums</span>.<span>SQLTABNAME</span>:</td>
      </tr>
      <tr>
        <td id="L2715" data-line-number="2715"></td>
        <td id="LC2715">                        {</td>
      </tr>
      <tr>
        <td id="L2716" data-line-number="2716"></td>
        <td id="LC2716">                            <span>if</span> (<span>null</span> <span>!=</span> <span>dataStream</span>)</td>
      </tr>
      <tr>
        <td id="L2717" data-line-number="2717"></td>
        <td id="LC2717">                            {</td>
      </tr>
      <tr>
        <td id="L2718" data-line-number="2718"></td>
        <td id="LC2718">                                <span>MultiPartTableName</span>[] <span>tableNames</span>;</td>
      </tr>
      <tr>
        <td id="L2719" data-line-number="2719"></td>
        <td id="LC2719">                                <span>if</span> (<span>!</span><span>TryProcessTableName</span>(<span>tokenLength</span>, <span>stateObj</span>, <span>out</span> <span>tableNames</span>))</td>
      </tr>
      <tr>
        <td id="L2720" data-line-number="2720"></td>
        <td id="LC2720">                                {</td>
      </tr>
      <tr>
        <td id="L2721" data-line-number="2721"></td>
        <td id="LC2721">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2722" data-line-number="2722"></td>
        <td id="LC2722">                                }</td>
      </tr>
      <tr>
        <td id="L2723" data-line-number="2723"></td>
        <td id="LC2723">                                <span>dataStream</span>.<span>TableNames</span> <span>=</span> <span>tableNames</span>;</td>
      </tr>
      <tr>
        <td id="L2724" data-line-number="2724"></td>
        <td id="LC2724">                            }</td>
      </tr>
      <tr>
        <td id="L2725" data-line-number="2725"></td>
        <td id="LC2725">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2726" data-line-number="2726"></td>
        <td id="LC2726">                            {</td>
      </tr>
      <tr>
        <td id="L2727" data-line-number="2727"></td>
        <td id="LC2727">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>tokenLength</span>))</td>
      </tr>
      <tr>
        <td id="L2728" data-line-number="2728"></td>
        <td id="LC2728">                                {</td>
      </tr>
      <tr>
        <td id="L2729" data-line-number="2729"></td>
        <td id="LC2729">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2730" data-line-number="2730"></td>
        <td id="LC2730">                                }</td>
      </tr>
      <tr>
        <td id="L2731" data-line-number="2731"></td>
        <td id="LC2731">                            }</td>
      </tr>
      <tr>
        <td id="L2732" data-line-number="2732"></td>
        <td id="LC2732">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2733" data-line-number="2733"></td>
        <td id="LC2733">                        }</td>
      </tr>
      <tr>
        <td id="L2734" data-line-number="2734"></td>
        <td id="LC2734">                    <span>case</span> <span>TdsEnums</span>.<span>SQLRESCOLSRCS</span>:</td>
      </tr>
      <tr>
        <td id="L2735" data-line-number="2735"></td>
        <td id="LC2735">                        {</td>
      </tr>
      <tr>
        <td id="L2736" data-line-number="2736"></td>
        <td id="LC2736">                            <span>if</span> (<span>!</span><span>TryProcessResColSrcs</span>(<span>stateObj</span>, <span>tokenLength</span>))</td>
      </tr>
      <tr>
        <td id="L2737" data-line-number="2737"></td>
        <td id="LC2737">                            {</td>
      </tr>
      <tr>
        <td id="L2738" data-line-number="2738"></td>
        <td id="LC2738">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2739" data-line-number="2739"></td>
        <td id="LC2739">                            }</td>
      </tr>
      <tr>
        <td id="L2740" data-line-number="2740"></td>
        <td id="LC2740">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2741" data-line-number="2741"></td>
        <td id="LC2741">                        }</td>
      </tr>
      <tr>
        <td id="L2742" data-line-number="2742"></td>
        <td id="LC2742">
</td>
      </tr>
      <tr>
        <td id="L2743" data-line-number="2743"></td>
        <td id="LC2743">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L2744" data-line-number="2744"></td>
        <td id="LC2744">                        <span>Debug</span>.<span>Assert</span>(<span>false</span>, <span><span>"</span>Unhandled token:  <span>"</span></span> <span>+</span> <span>token</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L2745" data-line-number="2745"></td>
        <td id="LC2745">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2746" data-line-number="2746"></td>
        <td id="LC2746">                }</td>
      </tr>
      <tr>
        <td id="L2747" data-line-number="2747"></td>
        <td id="LC2747">
</td>
      </tr>
      <tr>
        <td id="L2748" data-line-number="2748"></td>
        <td id="LC2748">                <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_pendingData</span> <span>||</span> <span>!</span><span>dataReady</span>, <span><span>"</span>dataReady is set, but there is no pending data<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2749" data-line-number="2749"></td>
        <td id="LC2749">            }</td>
      </tr>
      <tr>
        <td id="L2750" data-line-number="2750"></td>
        <td id="LC2750">
</td>
      </tr>
      <tr>
        <td id="L2751" data-line-number="2751"></td>
        <td id="LC2751">            <span><span>//</span> Loop while data pending &amp; runbehavior not return immediately, OR</span></td>
      </tr>
      <tr>
        <td id="L2752" data-line-number="2752"></td>
        <td id="LC2752">            <span><span>//</span> if in attention case, loop while no more pending data &amp; attention has not yet been</span></td>
      </tr>
      <tr>
        <td id="L2753" data-line-number="2753"></td>
        <td id="LC2753">            <span><span>//</span> received.</span></td>
      </tr>
      <tr>
        <td id="L2754" data-line-number="2754"></td>
        <td id="LC2754">            <span>while</span> ((<span>stateObj</span>.<span>_pendingData</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L2755" data-line-number="2755"></td>
        <td id="LC2755">                    (<span>RunBehavior</span>.<span>ReturnImmediately</span> <span>!=</span> (<span>RunBehavior</span>.<span>ReturnImmediately</span> <span>&amp;</span> <span>runBehavior</span>))) <span>||</span></td>
      </tr>
      <tr>
        <td id="L2756" data-line-number="2756"></td>
        <td id="LC2756">                (<span>!</span><span>stateObj</span>.<span>_pendingData</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_attentionSent</span> <span>&amp;&amp;</span> <span>!</span><span>stateObj</span>.<span>_attentionReceived</span>));</td>
      </tr>
      <tr>
        <td id="L2757" data-line-number="2757"></td>
        <td id="LC2757">
</td>
      </tr>
      <tr>
        <td id="L2758" data-line-number="2758"></td>
        <td id="LC2758">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L2759" data-line-number="2759"></td>
        <td id="LC2759">            <span>if</span> ((<span>stateObj</span>.<span>_pendingData</span>) <span>&amp;&amp;</span> (<span>!</span><span>dataReady</span>))</td>
      </tr>
      <tr>
        <td id="L2760" data-line-number="2760"></td>
        <td id="LC2760">            {</td>
      </tr>
      <tr>
        <td id="L2761" data-line-number="2761"></td>
        <td id="LC2761">                <span>byte</span> <span>token</span>;</td>
      </tr>
      <tr>
        <td id="L2762" data-line-number="2762"></td>
        <td id="LC2762">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryPeekByte</span>(<span>out</span> <span>token</span>))</td>
      </tr>
      <tr>
        <td id="L2763" data-line-number="2763"></td>
        <td id="LC2763">                {</td>
      </tr>
      <tr>
        <td id="L2764" data-line-number="2764"></td>
        <td id="LC2764">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2765" data-line-number="2765"></td>
        <td id="LC2765">                }</td>
      </tr>
      <tr>
        <td id="L2766" data-line-number="2766"></td>
        <td id="LC2766">                <span>Debug</span>.<span>Assert</span>(<span>IsValidTdsToken</span>(<span>token</span>), <span><span>$"</span>DataReady is false, but next token is not valid: {<span>token</span>,<span>-</span><span>2</span>:<span>X2</span>}<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2767" data-line-number="2767"></td>
        <td id="LC2767">            }</td>
      </tr>
      <tr>
        <td id="L2768" data-line-number="2768"></td>
        <td id="LC2768">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L2769" data-line-number="2769"></td>
        <td id="LC2769">
</td>
      </tr>
      <tr>
        <td id="L2770" data-line-number="2770"></td>
        <td id="LC2770">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>_pendingData</span>)</td>
      </tr>
      <tr>
        <td id="L2771" data-line-number="2771"></td>
        <td id="LC2771">            {</td>
      </tr>
      <tr>
        <td id="L2772" data-line-number="2772"></td>
        <td id="LC2772">                <span>if</span> (<span>null</span> <span>!=</span> <span>CurrentTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L2773" data-line-number="2773"></td>
        <td id="LC2773">                {</td>
      </tr>
      <tr>
        <td id="L2774" data-line-number="2774"></td>
        <td id="LC2774">                    <span>CurrentTransaction</span>.<span>Activate</span>();</td>
      </tr>
      <tr>
        <td id="L2775" data-line-number="2775"></td>
        <td id="LC2775">                }</td>
      </tr>
      <tr>
        <td id="L2776" data-line-number="2776"></td>
        <td id="LC2776">            }</td>
      </tr>
      <tr>
        <td id="L2777" data-line-number="2777"></td>
        <td id="LC2777">
</td>
      </tr>
      <tr>
        <td id="L2778" data-line-number="2778"></td>
        <td id="LC2778">            <span><span>//</span> if we recieved an attention (but this thread didn't send it) then</span></td>
      </tr>
      <tr>
        <td id="L2779" data-line-number="2779"></td>
        <td id="LC2779">            <span><span>//</span> we throw an Operation Cancelled error</span></td>
      </tr>
      <tr>
        <td id="L2780" data-line-number="2780"></td>
        <td id="LC2780">            <span>if</span> (<span>stateObj</span>.<span>_attentionReceived</span>)</td>
      </tr>
      <tr>
        <td id="L2781" data-line-number="2781"></td>
        <td id="LC2781">            {</td>
      </tr>
      <tr>
        <td id="L2782" data-line-number="2782"></td>
        <td id="LC2782">                <span><span>//</span> Dev11 #344723: SqlClient stress hang System_Data!Tcp::ReadSync via a call to SqlDataReader::Close</span></td>
      </tr>
      <tr>
        <td id="L2783" data-line-number="2783"></td>
        <td id="LC2783">                <span><span>//</span> Spin until SendAttention has cleared _attentionSending, this prevents a race condition between receiving the attention ACK and setting _attentionSent</span></td>
      </tr>
      <tr>
        <td id="L2784" data-line-number="2784"></td>
        <td id="LC2784">                <span>SpinWait</span>.<span>SpinUntil</span>(() <span>=&gt;</span> <span>!</span><span>stateObj</span>.<span>_attentionSending</span>);</td>
      </tr>
      <tr>
        <td id="L2785" data-line-number="2785"></td>
        <td id="LC2785">
</td>
      </tr>
      <tr>
        <td id="L2786" data-line-number="2786"></td>
        <td id="LC2786">                <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_attentionSent</span>, <span><span>"</span>Attention ACK has been received without attention sent<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2787" data-line-number="2787"></td>
        <td id="LC2787">                <span>if</span> (<span>stateObj</span>.<span>_attentionSent</span>)</td>
      </tr>
      <tr>
        <td id="L2788" data-line-number="2788"></td>
        <td id="LC2788">                {</td>
      </tr>
      <tr>
        <td id="L2789" data-line-number="2789"></td>
        <td id="LC2789">                    <span><span>//</span> Reset attention state.</span></td>
      </tr>
      <tr>
        <td id="L2790" data-line-number="2790"></td>
        <td id="LC2790">                    <span>stateObj</span>.<span>_attentionSent</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2791" data-line-number="2791"></td>
        <td id="LC2791">                    <span>stateObj</span>.<span>_attentionReceived</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2792" data-line-number="2792"></td>
        <td id="LC2792">
</td>
      </tr>
      <tr>
        <td id="L2793" data-line-number="2793"></td>
        <td id="LC2793">                    <span>if</span> (<span>RunBehavior</span>.<span>Clean</span> <span>!=</span> (<span>RunBehavior</span>.<span>Clean</span> <span>&amp;</span> <span>runBehavior</span>) <span>&amp;&amp;</span> <span>!</span><span>stateObj</span>.<span>_internalTimeout</span>)</td>
      </tr>
      <tr>
        <td id="L2794" data-line-number="2794"></td>
        <td id="LC2794">                    {</td>
      </tr>
      <tr>
        <td id="L2795" data-line-number="2795"></td>
        <td id="LC2795">                        <span><span>//</span> Add attention error to collection - if not RunBehavior.Clean!</span></td>
      </tr>
      <tr>
        <td id="L2796" data-line-number="2796"></td>
        <td id="LC2796">                        <span>stateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>0</span>, <span>0</span>, <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>OperationCancelled</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L2797" data-line-number="2797"></td>
        <td id="LC2797">                    }</td>
      </tr>
      <tr>
        <td id="L2798" data-line-number="2798"></td>
        <td id="LC2798">                }</td>
      </tr>
      <tr>
        <td id="L2799" data-line-number="2799"></td>
        <td id="LC2799">            }</td>
      </tr>
      <tr>
        <td id="L2800" data-line-number="2800"></td>
        <td id="LC2800">
</td>
      </tr>
      <tr>
        <td id="L2801" data-line-number="2801"></td>
        <td id="LC2801">            <span>if</span> (<span>stateObj</span>.<span>HasErrorOrWarning</span>)</td>
      </tr>
      <tr>
        <td id="L2802" data-line-number="2802"></td>
        <td id="LC2802">            {</td>
      </tr>
      <tr>
        <td id="L2803" data-line-number="2803"></td>
        <td id="LC2803">                <span>ThrowExceptionAndWarning</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L2804" data-line-number="2804"></td>
        <td id="LC2804">            }</td>
      </tr>
      <tr>
        <td id="L2805" data-line-number="2805"></td>
        <td id="LC2805">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L2806" data-line-number="2806"></td>
        <td id="LC2806">        }</td>
      </tr>
      <tr>
        <td id="L2807" data-line-number="2807"></td>
        <td id="LC2807">
</td>
      </tr>
      <tr>
        <td id="L2808" data-line-number="2808"></td>
        <td id="LC2808">        <span>private</span> <span>bool</span> <span>TryProcessEnvChange</span>(<span>int</span> <span>tokenLength</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>SqlEnvChange</span>[] <span>sqlEnvChange</span>)</td>
      </tr>
      <tr>
        <td id="L2809" data-line-number="2809"></td>
        <td id="LC2809">        {</td>
      </tr>
      <tr>
        <td id="L2810" data-line-number="2810"></td>
        <td id="LC2810">            <span><span>//</span> There could be multiple environment change messages following this token.</span></td>
      </tr>
      <tr>
        <td id="L2811" data-line-number="2811"></td>
        <td id="LC2811">            <span>byte</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L2812" data-line-number="2812"></td>
        <td id="LC2812">            <span>int</span> <span>processedLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L2813" data-line-number="2813"></td>
        <td id="LC2813">            <span>int</span> <span>nvalues</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L2814" data-line-number="2814"></td>
        <td id="LC2814">            <span>SqlEnvChange</span>[] <span>envarray</span> <span>=</span> <span>new</span> <span>SqlEnvChange</span>[<span>3</span>];  <span><span>//</span> Why is this hardcoded to 3?</span></td>
      </tr>
      <tr>
        <td id="L2815" data-line-number="2815"></td>
        <td id="LC2815">
</td>
      </tr>
      <tr>
        <td id="L2816" data-line-number="2816"></td>
        <td id="LC2816">            <span>sqlEnvChange</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L2817" data-line-number="2817"></td>
        <td id="LC2817">
</td>
      </tr>
      <tr>
        <td id="L2818" data-line-number="2818"></td>
        <td id="LC2818">            <span>while</span> (<span>tokenLength</span> <span>&gt;</span> <span>processedLength</span>)</td>
      </tr>
      <tr>
        <td id="L2819" data-line-number="2819"></td>
        <td id="LC2819">            {</td>
      </tr>
      <tr>
        <td id="L2820" data-line-number="2820"></td>
        <td id="LC2820">
</td>
      </tr>
      <tr>
        <td id="L2821" data-line-number="2821"></td>
        <td id="LC2821">                <span>if</span> (<span>nvalues</span> <span>&gt;=</span> <span>envarray</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L2822" data-line-number="2822"></td>
        <td id="LC2822">                {</td>
      </tr>
      <tr>
        <td id="L2823" data-line-number="2823"></td>
        <td id="LC2823">                    <span><span>//</span> This is a rare path. Most of the time we will have 1 or 2 envchange data streams.</span></td>
      </tr>
      <tr>
        <td id="L2824" data-line-number="2824"></td>
        <td id="LC2824">                    <span>SqlEnvChange</span>[] <span>newenvarray</span> <span>=</span> <span>new</span> <span>SqlEnvChange</span>[<span>envarray</span>.<span>Length</span> <span>+</span> <span>3</span>];</td>
      </tr>
      <tr>
        <td id="L2825" data-line-number="2825"></td>
        <td id="LC2825">
</td>
      </tr>
      <tr>
        <td id="L2826" data-line-number="2826"></td>
        <td id="LC2826">                    <span>for</span> (<span>int</span> <span>ii</span> <span>=</span> <span>0</span>; <span>ii</span> <span>&lt;</span> <span>envarray</span>.<span>Length</span>; <span>ii</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L2827" data-line-number="2827"></td>
        <td id="LC2827">                        <span>newenvarray</span>[<span>ii</span>] <span>=</span> <span>envarray</span>[<span>ii</span>];</td>
      </tr>
      <tr>
        <td id="L2828" data-line-number="2828"></td>
        <td id="LC2828">
</td>
      </tr>
      <tr>
        <td id="L2829" data-line-number="2829"></td>
        <td id="LC2829">                    <span>envarray</span> <span>=</span> <span>newenvarray</span>;</td>
      </tr>
      <tr>
        <td id="L2830" data-line-number="2830"></td>
        <td id="LC2830">                }</td>
      </tr>
      <tr>
        <td id="L2831" data-line-number="2831"></td>
        <td id="LC2831">
</td>
      </tr>
      <tr>
        <td id="L2832" data-line-number="2832"></td>
        <td id="LC2832">                <span>SqlEnvChange</span> <span>env</span> <span>=</span> <span>new</span> <span>SqlEnvChange</span>();</td>
      </tr>
      <tr>
        <td id="L2833" data-line-number="2833"></td>
        <td id="LC2833">
</td>
      </tr>
      <tr>
        <td id="L2834" data-line-number="2834"></td>
        <td id="LC2834">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>env</span>.<span>type</span>))</td>
      </tr>
      <tr>
        <td id="L2835" data-line-number="2835"></td>
        <td id="LC2835">                {</td>
      </tr>
      <tr>
        <td id="L2836" data-line-number="2836"></td>
        <td id="LC2836">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2837" data-line-number="2837"></td>
        <td id="LC2837">                }</td>
      </tr>
      <tr>
        <td id="L2838" data-line-number="2838"></td>
        <td id="LC2838">
</td>
      </tr>
      <tr>
        <td id="L2839" data-line-number="2839"></td>
        <td id="LC2839">                <span>envarray</span>[<span>nvalues</span>] <span>=</span> <span>env</span>;</td>
      </tr>
      <tr>
        <td id="L2840" data-line-number="2840"></td>
        <td id="LC2840">                <span>nvalues</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L2841" data-line-number="2841"></td>
        <td id="LC2841">
</td>
      </tr>
      <tr>
        <td id="L2842" data-line-number="2842"></td>
        <td id="LC2842">                <span>switch</span> (<span>env</span>.<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L2843" data-line-number="2843"></td>
        <td id="LC2843">                {</td>
      </tr>
      <tr>
        <td id="L2844" data-line-number="2844"></td>
        <td id="LC2844">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_DATABASE</span>:</td>
      </tr>
      <tr>
        <td id="L2845" data-line-number="2845"></td>
        <td id="LC2845">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_LANG</span>:</td>
      </tr>
      <tr>
        <td id="L2846" data-line-number="2846"></td>
        <td id="LC2846">                        <span>if</span> (<span>!</span><span>TryReadTwoStringFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2847" data-line-number="2847"></td>
        <td id="LC2847">                        {</td>
      </tr>
      <tr>
        <td id="L2848" data-line-number="2848"></td>
        <td id="LC2848">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2849" data-line-number="2849"></td>
        <td id="LC2849">                        }</td>
      </tr>
      <tr>
        <td id="L2850" data-line-number="2850"></td>
        <td id="LC2850">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2851" data-line-number="2851"></td>
        <td id="LC2851">
</td>
      </tr>
      <tr>
        <td id="L2852" data-line-number="2852"></td>
        <td id="LC2852">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_CHARSET</span>:</td>
      </tr>
      <tr>
        <td id="L2853" data-line-number="2853"></td>
        <td id="LC2853">                        <span><span>//</span> we copied this behavior directly from luxor - see charset envchange</span></td>
      </tr>
      <tr>
        <td id="L2854" data-line-number="2854"></td>
        <td id="LC2854">                        <span><span>//</span> section from sqlctokn.c</span></td>
      </tr>
      <tr>
        <td id="L2855" data-line-number="2855"></td>
        <td id="LC2855">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>_isShiloh</span>, <span><span>"</span>Received ENV_CHARSET on non 7.0 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2856" data-line-number="2856"></td>
        <td id="LC2856">                        <span>if</span> (<span>!</span><span>TryReadTwoStringFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2857" data-line-number="2857"></td>
        <td id="LC2857">                        {</td>
      </tr>
      <tr>
        <td id="L2858" data-line-number="2858"></td>
        <td id="LC2858">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2859" data-line-number="2859"></td>
        <td id="LC2859">                        }</td>
      </tr>
      <tr>
        <td id="L2860" data-line-number="2860"></td>
        <td id="LC2860">                        <span>if</span> (<span>env</span>.<span>newValue</span> <span>==</span> <span>TdsEnums</span>.<span>DEFAULT_ENGLISH_CODE_PAGE_STRING</span>)</td>
      </tr>
      <tr>
        <td id="L2861" data-line-number="2861"></td>
        <td id="LC2861">                        {</td>
      </tr>
      <tr>
        <td id="L2862" data-line-number="2862"></td>
        <td id="LC2862">                            <span>_defaultCodePage</span> <span>=</span> <span>TdsEnums</span>.<span>DEFAULT_ENGLISH_CODE_PAGE_VALUE</span>;</td>
      </tr>
      <tr>
        <td id="L2863" data-line-number="2863"></td>
        <td id="LC2863">                            <span>_defaultEncoding</span> <span>=</span> <span>System</span>.<span>Text</span>.<span>Encoding</span>.<span>GetEncoding</span>(<span>_defaultCodePage</span>);</td>
      </tr>
      <tr>
        <td id="L2864" data-line-number="2864"></td>
        <td id="LC2864">                        }</td>
      </tr>
      <tr>
        <td id="L2865" data-line-number="2865"></td>
        <td id="LC2865">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L2866" data-line-number="2866"></td>
        <td id="LC2866">                        {</td>
      </tr>
      <tr>
        <td id="L2867" data-line-number="2867"></td>
        <td id="LC2867">                            <span>Debug</span>.<span>Assert</span>(<span>env</span>.<span>newValue</span>.<span>Length</span> <span>&gt;</span> <span>TdsEnums</span>.<span>CHARSET_CODE_PAGE_OFFSET</span>, <span><span>"</span>TdsParser.ProcessEnvChange(): charset value received with length &lt;=10<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2868" data-line-number="2868"></td>
        <td id="LC2868">
</td>
      </tr>
      <tr>
        <td id="L2869" data-line-number="2869"></td>
        <td id="LC2869">                            <span>string</span> <span>stringCodePage</span> <span>=</span> <span>env</span>.<span>newValue</span>.<span>Substring</span>(<span>TdsEnums</span>.<span>CHARSET_CODE_PAGE_OFFSET</span>);</td>
      </tr>
      <tr>
        <td id="L2870" data-line-number="2870"></td>
        <td id="LC2870">
</td>
      </tr>
      <tr>
        <td id="L2871" data-line-number="2871"></td>
        <td id="LC2871">                            <span>_defaultCodePage</span> <span>=</span> <span>Int32</span>.<span>Parse</span>(<span>stringCodePage</span>, <span>NumberStyles</span>.<span>Integer</span>, <span>CultureInfo</span>.<span>InvariantCulture</span>);</td>
      </tr>
      <tr>
        <td id="L2872" data-line-number="2872"></td>
        <td id="LC2872">                            <span>_defaultEncoding</span> <span>=</span> <span>System</span>.<span>Text</span>.<span>Encoding</span>.<span>GetEncoding</span>(<span>_defaultCodePage</span>);</td>
      </tr>
      <tr>
        <td id="L2873" data-line-number="2873"></td>
        <td id="LC2873">                        }</td>
      </tr>
      <tr>
        <td id="L2874" data-line-number="2874"></td>
        <td id="LC2874">
</td>
      </tr>
      <tr>
        <td id="L2875" data-line-number="2875"></td>
        <td id="LC2875">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2876" data-line-number="2876"></td>
        <td id="LC2876">
</td>
      </tr>
      <tr>
        <td id="L2877" data-line-number="2877"></td>
        <td id="LC2877">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_PACKETSIZE</span>:</td>
      </tr>
      <tr>
        <td id="L2878" data-line-number="2878"></td>
        <td id="LC2878">                        <span><span>//</span> take care of packet size right here</span></td>
      </tr>
      <tr>
        <td id="L2879" data-line-number="2879"></td>
        <td id="LC2879">                        <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_syncOverAsync</span>, <span><span>"</span>Should not attempt pends in a synchronous call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2880" data-line-number="2880"></td>
        <td id="LC2880">                        <span>if</span> (<span>!</span><span>TryReadTwoStringFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2881" data-line-number="2881"></td>
        <td id="LC2881">                        {</td>
      </tr>
      <tr>
        <td id="L2882" data-line-number="2882"></td>
        <td id="LC2882">                            <span><span>//</span> Changing packet size does not support retry, should not pend"</span></td>
      </tr>
      <tr>
        <td id="L2883" data-line-number="2883"></td>
        <td id="LC2883">                            <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>();</td>
      </tr>
      <tr>
        <td id="L2884" data-line-number="2884"></td>
        <td id="LC2884">                        }</td>
      </tr>
      <tr>
        <td id="L2885" data-line-number="2885"></td>
        <td id="LC2885">                        <span><span>//</span> Only set on physical state object - this should only occur on LoginAck prior</span></td>
      </tr>
      <tr>
        <td id="L2886" data-line-number="2886"></td>
        <td id="LC2886">                        <span><span>//</span> to MARS initialization!</span></td>
      </tr>
      <tr>
        <td id="L2887" data-line-number="2887"></td>
        <td id="LC2887">                        <span>Int32</span> <span>packetSize</span> <span>=</span> <span>Int32</span>.<span>Parse</span>(<span>env</span>.<span>newValue</span>, <span>NumberStyles</span>.<span>Integer</span>, <span>CultureInfo</span>.<span>InvariantCulture</span>);</td>
      </tr>
      <tr>
        <td id="L2888" data-line-number="2888"></td>
        <td id="LC2888">
</td>
      </tr>
      <tr>
        <td id="L2889" data-line-number="2889"></td>
        <td id="LC2889">                        <span>if</span> (<span>_physicalStateObj</span>.<span>SetPacketSize</span>(<span>packetSize</span>))</td>
      </tr>
      <tr>
        <td id="L2890" data-line-number="2890"></td>
        <td id="LC2890">                        {</td>
      </tr>
      <tr>
        <td id="L2891" data-line-number="2891"></td>
        <td id="LC2891">                            <span><span>//</span> If packet size changed, we need to release our SNIPackets since</span></td>
      </tr>
      <tr>
        <td id="L2892" data-line-number="2892"></td>
        <td id="LC2892">                            <span><span>//</span> those are tied to packet size of connection.</span></td>
      </tr>
      <tr>
        <td id="L2893" data-line-number="2893"></td>
        <td id="LC2893">                            <span>_physicalStateObj</span>.<span>ClearAllWritePackets</span>();</td>
      </tr>
      <tr>
        <td id="L2894" data-line-number="2894"></td>
        <td id="LC2894">
</td>
      </tr>
      <tr>
        <td id="L2895" data-line-number="2895"></td>
        <td id="LC2895">                            <span><span>//</span> Update SNI ConsumerInfo value to be resulting packet size</span></td>
      </tr>
      <tr>
        <td id="L2896" data-line-number="2896"></td>
        <td id="LC2896">                            <span>UInt32</span> <span>unsignedPacketSize</span> <span>=</span> (<span>UInt32</span>)<span>packetSize</span>;</td>
      </tr>
      <tr>
        <td id="L2897" data-line-number="2897"></td>
        <td id="LC2897">                            <span>UInt32</span> <span>result</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNISetInfo</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>SNINativeMethodWrapper</span>.<span>QTypes</span>.<span>SNI_QUERY_CONN_BUFSIZE</span>, <span>ref</span> <span>unsignedPacketSize</span>);</td>
      </tr>
      <tr>
        <td id="L2898" data-line-number="2898"></td>
        <td id="LC2898">
</td>
      </tr>
      <tr>
        <td id="L2899" data-line-number="2899"></td>
        <td id="LC2899">                            <span>Debug</span>.<span>Assert</span>(<span>result</span> <span>==</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>, <span><span>"</span>Unexpected failure state upon calling SNISetInfo<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2900" data-line-number="2900"></td>
        <td id="LC2900">                        }</td>
      </tr>
      <tr>
        <td id="L2901" data-line-number="2901"></td>
        <td id="LC2901">
</td>
      </tr>
      <tr>
        <td id="L2902" data-line-number="2902"></td>
        <td id="LC2902">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2903" data-line-number="2903"></td>
        <td id="LC2903">
</td>
      </tr>
      <tr>
        <td id="L2904" data-line-number="2904"></td>
        <td id="LC2904">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_LOCALEID</span>:</td>
      </tr>
      <tr>
        <td id="L2905" data-line-number="2905"></td>
        <td id="LC2905">                        <span><span>//</span> UNDONE: this LCID may be incorrect for OEM code pages on 7.0</span></td>
      </tr>
      <tr>
        <td id="L2906" data-line-number="2906"></td>
        <td id="LC2906">                        <span><span>//</span> need a way to get lcid from code page</span></td>
      </tr>
      <tr>
        <td id="L2907" data-line-number="2907"></td>
        <td id="LC2907">                        <span>if</span> (<span>!</span><span>TryReadTwoStringFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2908" data-line-number="2908"></td>
        <td id="LC2908">                        {</td>
      </tr>
      <tr>
        <td id="L2909" data-line-number="2909"></td>
        <td id="LC2909">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2910" data-line-number="2910"></td>
        <td id="LC2910">                        }</td>
      </tr>
      <tr>
        <td id="L2911" data-line-number="2911"></td>
        <td id="LC2911">                        <span>_defaultLCID</span> <span>=</span> <span>Int32</span>.<span>Parse</span>(<span>env</span>.<span>newValue</span>, <span>NumberStyles</span>.<span>Integer</span>, <span>CultureInfo</span>.<span>InvariantCulture</span>);</td>
      </tr>
      <tr>
        <td id="L2912" data-line-number="2912"></td>
        <td id="LC2912">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2913" data-line-number="2913"></td>
        <td id="LC2913">
</td>
      </tr>
      <tr>
        <td id="L2914" data-line-number="2914"></td>
        <td id="LC2914">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_COMPFLAGS</span>:</td>
      </tr>
      <tr>
        <td id="L2915" data-line-number="2915"></td>
        <td id="LC2915">                        <span>if</span> (<span>!</span><span>TryReadTwoStringFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L2916" data-line-number="2916"></td>
        <td id="LC2916">                        {</td>
      </tr>
      <tr>
        <td id="L2917" data-line-number="2917"></td>
        <td id="LC2917">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2918" data-line-number="2918"></td>
        <td id="LC2918">                        }</td>
      </tr>
      <tr>
        <td id="L2919" data-line-number="2919"></td>
        <td id="LC2919">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2920" data-line-number="2920"></td>
        <td id="LC2920">
</td>
      </tr>
      <tr>
        <td id="L2921" data-line-number="2921"></td>
        <td id="LC2921">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_COLLATION</span>:</td>
      </tr>
      <tr>
        <td id="L2922" data-line-number="2922"></td>
        <td id="LC2922">                        <span>Debug</span>.<span>Assert</span>(<span>env</span>.<span>newLength</span> <span>==</span> <span>5</span> <span>||</span> <span>env</span>.<span>newLength</span> <span>==</span> <span>0</span>, <span><span>"</span>Improper length in new collation!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2923" data-line-number="2923"></td>
        <td id="LC2923">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L2924" data-line-number="2924"></td>
        <td id="LC2924">                        {</td>
      </tr>
      <tr>
        <td id="L2925" data-line-number="2925"></td>
        <td id="LC2925">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2926" data-line-number="2926"></td>
        <td id="LC2926">                        }</td>
      </tr>
      <tr>
        <td id="L2927" data-line-number="2927"></td>
        <td id="LC2927">                        <span>env</span>.<span>newLength</span> <span>=</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L2928" data-line-number="2928"></td>
        <td id="LC2928">                        <span>if</span> (<span>env</span>.<span>newLength</span> <span>==</span> <span>5</span>)</td>
      </tr>
      <tr>
        <td id="L2929" data-line-number="2929"></td>
        <td id="LC2929">                        {</td>
      </tr>
      <tr>
        <td id="L2930" data-line-number="2930"></td>
        <td id="LC2930">                            <span>if</span> (<span>!</span><span>TryProcessCollation</span>(<span>stateObj</span>, <span>out</span> <span>env</span>.<span>newCollation</span>))</td>
      </tr>
      <tr>
        <td id="L2931" data-line-number="2931"></td>
        <td id="LC2931">                            {</td>
      </tr>
      <tr>
        <td id="L2932" data-line-number="2932"></td>
        <td id="LC2932">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2933" data-line-number="2933"></td>
        <td id="LC2933">                            }</td>
      </tr>
      <tr>
        <td id="L2934" data-line-number="2934"></td>
        <td id="LC2934">
</td>
      </tr>
      <tr>
        <td id="L2935" data-line-number="2935"></td>
        <td id="LC2935">                            <span><span>//</span> give the parser the new collation values in case parameters don't specify one          </span></td>
      </tr>
      <tr>
        <td id="L2936" data-line-number="2936"></td>
        <td id="LC2936">                            <span>_defaultCollation</span> <span>=</span> <span>env</span>.<span>newCollation</span>;</td>
      </tr>
      <tr>
        <td id="L2937" data-line-number="2937"></td>
        <td id="LC2937">                            <span>_defaultLCID</span> <span>=</span> <span>env</span>.<span>newCollation</span>.<span>LCID</span>;</td>
      </tr>
      <tr>
        <td id="L2938" data-line-number="2938"></td>
        <td id="LC2938">
</td>
      </tr>
      <tr>
        <td id="L2939" data-line-number="2939"></td>
        <td id="LC2939">                            <span>int</span> <span>newCodePage</span> <span>=</span> <span>GetCodePage</span>(<span>env</span>.<span>newCollation</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L2940" data-line-number="2940"></td>
        <td id="LC2940">
</td>
      </tr>
      <tr>
        <td id="L2941" data-line-number="2941"></td>
        <td id="LC2941">                            <span>if</span> ((<span>env</span>.<span>newCollation</span>.<span>info</span> <span>&amp;</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>) <span>==</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>)</td>
      </tr>
      <tr>
        <td id="L2942" data-line-number="2942"></td>
        <td id="LC2942">                            { <span><span>//</span> UTF8 collation</span></td>
      </tr>
      <tr>
        <td id="L2943" data-line-number="2943"></td>
        <td id="LC2943">                                <span>_defaultEncoding</span> <span>=</span> <span>Encoding</span>.<span>UTF8</span>;</td>
      </tr>
      <tr>
        <td id="L2944" data-line-number="2944"></td>
        <td id="LC2944">
</td>
      </tr>
      <tr>
        <td id="L2945" data-line-number="2945"></td>
        <td id="LC2945">                                <span>if</span> (<span>newCodePage</span> <span>!=</span> <span>_defaultCodePage</span>)</td>
      </tr>
      <tr>
        <td id="L2946" data-line-number="2946"></td>
        <td id="LC2946">                                {</td>
      </tr>
      <tr>
        <td id="L2947" data-line-number="2947"></td>
        <td id="LC2947">                                    <span>_defaultCodePage</span> <span>=</span> <span>newCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L2948" data-line-number="2948"></td>
        <td id="LC2948">                                }</td>
      </tr>
      <tr>
        <td id="L2949" data-line-number="2949"></td>
        <td id="LC2949">                            }</td>
      </tr>
      <tr>
        <td id="L2950" data-line-number="2950"></td>
        <td id="LC2950">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L2951" data-line-number="2951"></td>
        <td id="LC2951">                            {</td>
      </tr>
      <tr>
        <td id="L2952" data-line-number="2952"></td>
        <td id="LC2952">
</td>
      </tr>
      <tr>
        <td id="L2953" data-line-number="2953"></td>
        <td id="LC2953">                                <span>if</span> (<span>newCodePage</span> <span>!=</span> <span>_defaultCodePage</span>)</td>
      </tr>
      <tr>
        <td id="L2954" data-line-number="2954"></td>
        <td id="LC2954">                                {</td>
      </tr>
      <tr>
        <td id="L2955" data-line-number="2955"></td>
        <td id="LC2955">                                    <span>_defaultCodePage</span> <span>=</span> <span>newCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L2956" data-line-number="2956"></td>
        <td id="LC2956">                                    <span>_defaultEncoding</span> <span>=</span> <span>System</span>.<span>Text</span>.<span>Encoding</span>.<span>GetEncoding</span>(<span>_defaultCodePage</span>);</td>
      </tr>
      <tr>
        <td id="L2957" data-line-number="2957"></td>
        <td id="LC2957">                                }</td>
      </tr>
      <tr>
        <td id="L2958" data-line-number="2958"></td>
        <td id="LC2958">                            }</td>
      </tr>
      <tr>
        <td id="L2959" data-line-number="2959"></td>
        <td id="LC2959">                        }</td>
      </tr>
      <tr>
        <td id="L2960" data-line-number="2960"></td>
        <td id="LC2960">
</td>
      </tr>
      <tr>
        <td id="L2961" data-line-number="2961"></td>
        <td id="LC2961">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L2962" data-line-number="2962"></td>
        <td id="LC2962">                        {</td>
      </tr>
      <tr>
        <td id="L2963" data-line-number="2963"></td>
        <td id="LC2963">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2964" data-line-number="2964"></td>
        <td id="LC2964">                        }</td>
      </tr>
      <tr>
        <td id="L2965" data-line-number="2965"></td>
        <td id="LC2965">                        <span>env</span>.<span>oldLength</span> <span>=</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L2966" data-line-number="2966"></td>
        <td id="LC2966">                        <span>Debug</span>.<span>Assert</span>(<span>env</span>.<span>oldLength</span> <span>==</span> <span>5</span> <span>||</span> <span>env</span>.<span>oldLength</span> <span>==</span> <span>0</span>, <span><span>"</span>Improper length in old collation!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2967" data-line-number="2967"></td>
        <td id="LC2967">                        <span>if</span> (<span>env</span>.<span>oldLength</span> <span>==</span> <span>5</span>)</td>
      </tr>
      <tr>
        <td id="L2968" data-line-number="2968"></td>
        <td id="LC2968">                        {</td>
      </tr>
      <tr>
        <td id="L2969" data-line-number="2969"></td>
        <td id="LC2969">                            <span>if</span> (<span>!</span><span>TryProcessCollation</span>(<span>stateObj</span>, <span>out</span> <span>env</span>.<span>oldCollation</span>))</td>
      </tr>
      <tr>
        <td id="L2970" data-line-number="2970"></td>
        <td id="LC2970">                            {</td>
      </tr>
      <tr>
        <td id="L2971" data-line-number="2971"></td>
        <td id="LC2971">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2972" data-line-number="2972"></td>
        <td id="LC2972">                            }</td>
      </tr>
      <tr>
        <td id="L2973" data-line-number="2973"></td>
        <td id="LC2973">                        }</td>
      </tr>
      <tr>
        <td id="L2974" data-line-number="2974"></td>
        <td id="LC2974">
</td>
      </tr>
      <tr>
        <td id="L2975" data-line-number="2975"></td>
        <td id="LC2975">                        <span>env</span>.<span>length</span> <span>=</span> <span>3</span> <span>+</span> <span>env</span>.<span>newLength</span> <span>+</span> <span>env</span>.<span>oldLength</span>;</td>
      </tr>
      <tr>
        <td id="L2976" data-line-number="2976"></td>
        <td id="LC2976">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L2977" data-line-number="2977"></td>
        <td id="LC2977">
</td>
      </tr>
      <tr>
        <td id="L2978" data-line-number="2978"></td>
        <td id="LC2978">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_BEGINTRAN</span>:</td>
      </tr>
      <tr>
        <td id="L2979" data-line-number="2979"></td>
        <td id="LC2979">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_COMMITTRAN</span>:</td>
      </tr>
      <tr>
        <td id="L2980" data-line-number="2980"></td>
        <td id="LC2980">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_ROLLBACKTRAN</span>:</td>
      </tr>
      <tr>
        <td id="L2981" data-line-number="2981"></td>
        <td id="LC2981">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_ENLISTDTC</span>:</td>
      </tr>
      <tr>
        <td id="L2982" data-line-number="2982"></td>
        <td id="LC2982">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_DEFECTDTC</span>:</td>
      </tr>
      <tr>
        <td id="L2983" data-line-number="2983"></td>
        <td id="LC2983">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_TRANSACTIONENDED</span>:</td>
      </tr>
      <tr>
        <td id="L2984" data-line-number="2984"></td>
        <td id="LC2984">                        <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>Received new ENVCHANGE transaction/DTC token on pre 9.0 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2985" data-line-number="2985"></td>
        <td id="LC2985">
</td>
      </tr>
      <tr>
        <td id="L2986" data-line-number="2986"></td>
        <td id="LC2986">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L2987" data-line-number="2987"></td>
        <td id="LC2987">                        {</td>
      </tr>
      <tr>
        <td id="L2988" data-line-number="2988"></td>
        <td id="LC2988">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2989" data-line-number="2989"></td>
        <td id="LC2989">                        }</td>
      </tr>
      <tr>
        <td id="L2990" data-line-number="2990"></td>
        <td id="LC2990">                        <span>env</span>.<span>newLength</span> <span>=</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L2991" data-line-number="2991"></td>
        <td id="LC2991">                        <span>Debug</span>.<span>Assert</span>(<span>env</span>.<span>newLength</span> <span>==</span> <span>0</span> <span>||</span> <span>env</span>.<span>newLength</span> <span>==</span> <span>8</span>, <span><span>"</span>Improper length for new transaction id!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L2992" data-line-number="2992"></td>
        <td id="LC2992">
</td>
      </tr>
      <tr>
        <td id="L2993" data-line-number="2993"></td>
        <td id="LC2993">                        <span>if</span> (<span>env</span>.<span>newLength</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L2994" data-line-number="2994"></td>
        <td id="LC2994">                        {</td>
      </tr>
      <tr>
        <td id="L2995" data-line-number="2995"></td>
        <td id="LC2995">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt64</span>(<span>out</span> <span>env</span>.<span>newLongValue</span>))</td>
      </tr>
      <tr>
        <td id="L2996" data-line-number="2996"></td>
        <td id="LC2996">                            {</td>
      </tr>
      <tr>
        <td id="L2997" data-line-number="2997"></td>
        <td id="LC2997">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L2998" data-line-number="2998"></td>
        <td id="LC2998">                            }</td>
      </tr>
      <tr>
        <td id="L2999" data-line-number="2999"></td>
        <td id="LC2999">                            <span>Debug</span>.<span>Assert</span>(<span>env</span>.<span>newLongValue</span> <span>!=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>, <span><span>"</span>New transaction id is null?<span>"</span></span>); <span><span>//</span> the server guarantees that zero is an invalid transaction id.</span></td>
      </tr>
      <tr>
        <td id="L3000" data-line-number="3000"></td>
        <td id="LC3000">                        }</td>
      </tr>
      <tr>
        <td id="L3001" data-line-number="3001"></td>
        <td id="LC3001">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L3002" data-line-number="3002"></td>
        <td id="LC3002">                        {</td>
      </tr>
      <tr>
        <td id="L3003" data-line-number="3003"></td>
        <td id="LC3003">                            <span>env</span>.<span>newLongValue</span> <span>=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>; <span><span>//</span> the server guarantees that zero is an invalid transaction id.</span></td>
      </tr>
      <tr>
        <td id="L3004" data-line-number="3004"></td>
        <td id="LC3004">                        }</td>
      </tr>
      <tr>
        <td id="L3005" data-line-number="3005"></td>
        <td id="LC3005">
</td>
      </tr>
      <tr>
        <td id="L3006" data-line-number="3006"></td>
        <td id="LC3006">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L3007" data-line-number="3007"></td>
        <td id="LC3007">                        {</td>
      </tr>
      <tr>
        <td id="L3008" data-line-number="3008"></td>
        <td id="LC3008">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3009" data-line-number="3009"></td>
        <td id="LC3009">                        }</td>
      </tr>
      <tr>
        <td id="L3010" data-line-number="3010"></td>
        <td id="LC3010">                        <span>env</span>.<span>oldLength</span> <span>=</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L3011" data-line-number="3011"></td>
        <td id="LC3011">                        <span>Debug</span>.<span>Assert</span>(<span>env</span>.<span>oldLength</span> <span>==</span> <span>0</span> <span>||</span> <span>env</span>.<span>oldLength</span> <span>==</span> <span>8</span>, <span><span>"</span>Improper length for old transaction id!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3012" data-line-number="3012"></td>
        <td id="LC3012">
</td>
      </tr>
      <tr>
        <td id="L3013" data-line-number="3013"></td>
        <td id="LC3013">                        <span>if</span> (<span>env</span>.<span>oldLength</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L3014" data-line-number="3014"></td>
        <td id="LC3014">                        {</td>
      </tr>
      <tr>
        <td id="L3015" data-line-number="3015"></td>
        <td id="LC3015">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt64</span>(<span>out</span> <span>env</span>.<span>oldLongValue</span>))</td>
      </tr>
      <tr>
        <td id="L3016" data-line-number="3016"></td>
        <td id="LC3016">                            {</td>
      </tr>
      <tr>
        <td id="L3017" data-line-number="3017"></td>
        <td id="LC3017">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3018" data-line-number="3018"></td>
        <td id="LC3018">                            }</td>
      </tr>
      <tr>
        <td id="L3019" data-line-number="3019"></td>
        <td id="LC3019">                            <span>Debug</span>.<span>Assert</span>(<span>env</span>.<span>oldLongValue</span> <span>!=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>, <span><span>"</span>Old transaction id is null?<span>"</span></span>); <span><span>//</span> the server guarantees that zero is an invalid transaction id.</span></td>
      </tr>
      <tr>
        <td id="L3020" data-line-number="3020"></td>
        <td id="LC3020">                        }</td>
      </tr>
      <tr>
        <td id="L3021" data-line-number="3021"></td>
        <td id="LC3021">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L3022" data-line-number="3022"></td>
        <td id="LC3022">                        {</td>
      </tr>
      <tr>
        <td id="L3023" data-line-number="3023"></td>
        <td id="LC3023">                            <span>env</span>.<span>oldLongValue</span> <span>=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>; <span><span>//</span> the server guarantees that zero is an invalid transaction id.</span></td>
      </tr>
      <tr>
        <td id="L3024" data-line-number="3024"></td>
        <td id="LC3024">                        }</td>
      </tr>
      <tr>
        <td id="L3025" data-line-number="3025"></td>
        <td id="LC3025">
</td>
      </tr>
      <tr>
        <td id="L3026" data-line-number="3026"></td>
        <td id="LC3026">                        <span><span>//</span> env.length includes 1 byte type token</span></td>
      </tr>
      <tr>
        <td id="L3027" data-line-number="3027"></td>
        <td id="LC3027">                        <span>env</span>.<span>length</span> <span>=</span> <span>3</span> <span>+</span> <span>env</span>.<span>newLength</span> <span>+</span> <span>env</span>.<span>oldLength</span>;</td>
      </tr>
      <tr>
        <td id="L3028" data-line-number="3028"></td>
        <td id="LC3028">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3029" data-line-number="3029"></td>
        <td id="LC3029">
</td>
      </tr>
      <tr>
        <td id="L3030" data-line-number="3030"></td>
        <td id="LC3030">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_LOGSHIPNODE</span>:</td>
      </tr>
      <tr>
        <td id="L3031" data-line-number="3031"></td>
        <td id="LC3031">                        <span><span>//</span> env.newBinValue is secondary node, env.oldBinValue is witness node</span></td>
      </tr>
      <tr>
        <td id="L3032" data-line-number="3032"></td>
        <td id="LC3032">                        <span><span>//</span> comes before LoginAck so we can't assert this</span></td>
      </tr>
      <tr>
        <td id="L3033" data-line-number="3033"></td>
        <td id="LC3033">                        <span>if</span> (<span>!</span><span>TryReadTwoStringFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L3034" data-line-number="3034"></td>
        <td id="LC3034">                        {</td>
      </tr>
      <tr>
        <td id="L3035" data-line-number="3035"></td>
        <td id="LC3035">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3036" data-line-number="3036"></td>
        <td id="LC3036">                        }</td>
      </tr>
      <tr>
        <td id="L3037" data-line-number="3037"></td>
        <td id="LC3037">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3038" data-line-number="3038"></td>
        <td id="LC3038">
</td>
      </tr>
      <tr>
        <td id="L3039" data-line-number="3039"></td>
        <td id="LC3039">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_PROMOTETRANSACTION</span>:</td>
      </tr>
      <tr>
        <td id="L3040" data-line-number="3040"></td>
        <td id="LC3040">                        <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>Received new ENVCHANGE tokens on pre 9.0 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3041" data-line-number="3041"></td>
        <td id="LC3041">
</td>
      </tr>
      <tr>
        <td id="L3042" data-line-number="3042"></td>
        <td id="LC3042">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>env</span>.<span>newLength</span>))</td>
      </tr>
      <tr>
        <td id="L3043" data-line-number="3043"></td>
        <td id="LC3043">                        { <span><span>//</span> new value has 4 byte length</span></td>
      </tr>
      <tr>
        <td id="L3044" data-line-number="3044"></td>
        <td id="LC3044">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3045" data-line-number="3045"></td>
        <td id="LC3045">                        }</td>
      </tr>
      <tr>
        <td id="L3046" data-line-number="3046"></td>
        <td id="LC3046">                        <span>env</span>.<span>newBinValue</span> <span>=</span> <span>new</span> <span>byte</span>[<span>env</span>.<span>newLength</span>];</td>
      </tr>
      <tr>
        <td id="L3047" data-line-number="3047"></td>
        <td id="LC3047">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>env</span>.<span>newBinValue</span>, <span>0</span>, <span>env</span>.<span>newLength</span>))</td>
      </tr>
      <tr>
        <td id="L3048" data-line-number="3048"></td>
        <td id="LC3048">                        { <span><span>//</span> read new value with 4 byte length</span></td>
      </tr>
      <tr>
        <td id="L3049" data-line-number="3049"></td>
        <td id="LC3049">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3050" data-line-number="3050"></td>
        <td id="LC3050">                        }</td>
      </tr>
      <tr>
        <td id="L3051" data-line-number="3051"></td>
        <td id="LC3051">
</td>
      </tr>
      <tr>
        <td id="L3052" data-line-number="3052"></td>
        <td id="LC3052">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L3053" data-line-number="3053"></td>
        <td id="LC3053">                        {</td>
      </tr>
      <tr>
        <td id="L3054" data-line-number="3054"></td>
        <td id="LC3054">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3055" data-line-number="3055"></td>
        <td id="LC3055">                        }</td>
      </tr>
      <tr>
        <td id="L3056" data-line-number="3056"></td>
        <td id="LC3056">                        <span>env</span>.<span>oldLength</span> <span>=</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L3057" data-line-number="3057"></td>
        <td id="LC3057">                        <span>Debug</span>.<span>Assert</span>(<span>0</span> <span>==</span> <span>env</span>.<span>oldLength</span>, <span><span>"</span>old length should be zero<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3058" data-line-number="3058"></td>
        <td id="LC3058">
</td>
      </tr>
      <tr>
        <td id="L3059" data-line-number="3059"></td>
        <td id="LC3059">                        <span><span>//</span> env.length includes 1 byte for type token</span></td>
      </tr>
      <tr>
        <td id="L3060" data-line-number="3060"></td>
        <td id="LC3060">                        <span>env</span>.<span>length</span> <span>=</span> <span>5</span> <span>+</span> <span>env</span>.<span>newLength</span>;</td>
      </tr>
      <tr>
        <td id="L3061" data-line-number="3061"></td>
        <td id="LC3061">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3062" data-line-number="3062"></td>
        <td id="LC3062">
</td>
      </tr>
      <tr>
        <td id="L3063" data-line-number="3063"></td>
        <td id="LC3063">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_TRANSACTIONMANAGERADDRESS</span>:</td>
      </tr>
      <tr>
        <td id="L3064" data-line-number="3064"></td>
        <td id="LC3064">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_SPRESETCONNECTIONACK</span>:</td>
      </tr>
      <tr>
        <td id="L3065" data-line-number="3065"></td>
        <td id="LC3065">                        <span><span>//</span> TODO UNDONE BUGBUG - need to implement support for these env changes</span></td>
      </tr>
      <tr>
        <td id="L3066" data-line-number="3066"></td>
        <td id="LC3066">                        <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>Received new ENVCHANGE tokens on pre 9.0 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3067" data-line-number="3067"></td>
        <td id="LC3067">                        <span>if</span> (<span>!</span><span>TryReadTwoBinaryFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L3068" data-line-number="3068"></td>
        <td id="LC3068">                        {</td>
      </tr>
      <tr>
        <td id="L3069" data-line-number="3069"></td>
        <td id="LC3069">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3070" data-line-number="3070"></td>
        <td id="LC3070">                        }</td>
      </tr>
      <tr>
        <td id="L3071" data-line-number="3071"></td>
        <td id="LC3071">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3072" data-line-number="3072"></td>
        <td id="LC3072">
</td>
      </tr>
      <tr>
        <td id="L3073" data-line-number="3073"></td>
        <td id="LC3073">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_USERINSTANCE</span>:</td>
      </tr>
      <tr>
        <td id="L3074" data-line-number="3074"></td>
        <td id="LC3074">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>_isYukon</span>, <span><span>"</span>Received ENV_USERINSTANCE on non 9.0 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3075" data-line-number="3075"></td>
        <td id="LC3075">                        <span>if</span> (<span>!</span><span>TryReadTwoStringFields</span>(<span>env</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L3076" data-line-number="3076"></td>
        <td id="LC3076">                        {</td>
      </tr>
      <tr>
        <td id="L3077" data-line-number="3077"></td>
        <td id="LC3077">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3078" data-line-number="3078"></td>
        <td id="LC3078">                        }</td>
      </tr>
      <tr>
        <td id="L3079" data-line-number="3079"></td>
        <td id="LC3079">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3080" data-line-number="3080"></td>
        <td id="LC3080">
</td>
      </tr>
      <tr>
        <td id="L3081" data-line-number="3081"></td>
        <td id="LC3081">                    <span>case</span> <span>TdsEnums</span>.<span>ENV_ROUTING</span>:</td>
      </tr>
      <tr>
        <td id="L3082" data-line-number="3082"></td>
        <td id="LC3082">                        <span>ushort</span> <span>newLength</span>;</td>
      </tr>
      <tr>
        <td id="L3083" data-line-number="3083"></td>
        <td id="LC3083">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>newLength</span>))</td>
      </tr>
      <tr>
        <td id="L3084" data-line-number="3084"></td>
        <td id="LC3084">                        {</td>
      </tr>
      <tr>
        <td id="L3085" data-line-number="3085"></td>
        <td id="LC3085">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3086" data-line-number="3086"></td>
        <td id="LC3086">                        }</td>
      </tr>
      <tr>
        <td id="L3087" data-line-number="3087"></td>
        <td id="LC3087">                        <span>env</span>.<span>newLength</span> <span>=</span> <span>newLength</span>;</td>
      </tr>
      <tr>
        <td id="L3088" data-line-number="3088"></td>
        <td id="LC3088">                        <span>byte</span> <span>protocol</span>;</td>
      </tr>
      <tr>
        <td id="L3089" data-line-number="3089"></td>
        <td id="LC3089">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>protocol</span>))</td>
      </tr>
      <tr>
        <td id="L3090" data-line-number="3090"></td>
        <td id="LC3090">                        {</td>
      </tr>
      <tr>
        <td id="L3091" data-line-number="3091"></td>
        <td id="LC3091">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3092" data-line-number="3092"></td>
        <td id="LC3092">                        }</td>
      </tr>
      <tr>
        <td id="L3093" data-line-number="3093"></td>
        <td id="LC3093">                        <span>ushort</span> <span>port</span>;</td>
      </tr>
      <tr>
        <td id="L3094" data-line-number="3094"></td>
        <td id="LC3094">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>port</span>))</td>
      </tr>
      <tr>
        <td id="L3095" data-line-number="3095"></td>
        <td id="LC3095">                        {</td>
      </tr>
      <tr>
        <td id="L3096" data-line-number="3096"></td>
        <td id="LC3096">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3097" data-line-number="3097"></td>
        <td id="LC3097">                        }</td>
      </tr>
      <tr>
        <td id="L3098" data-line-number="3098"></td>
        <td id="LC3098">                        <span>UInt16</span> <span>serverLen</span>;</td>
      </tr>
      <tr>
        <td id="L3099" data-line-number="3099"></td>
        <td id="LC3099">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>serverLen</span>))</td>
      </tr>
      <tr>
        <td id="L3100" data-line-number="3100"></td>
        <td id="LC3100">                        {</td>
      </tr>
      <tr>
        <td id="L3101" data-line-number="3101"></td>
        <td id="LC3101">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3102" data-line-number="3102"></td>
        <td id="LC3102">                        }</td>
      </tr>
      <tr>
        <td id="L3103" data-line-number="3103"></td>
        <td id="LC3103">                        <span>string</span> <span>serverName</span>;</td>
      </tr>
      <tr>
        <td id="L3104" data-line-number="3104"></td>
        <td id="LC3104">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>serverLen</span>, <span>out</span> <span>serverName</span>))</td>
      </tr>
      <tr>
        <td id="L3105" data-line-number="3105"></td>
        <td id="LC3105">                        {</td>
      </tr>
      <tr>
        <td id="L3106" data-line-number="3106"></td>
        <td id="LC3106">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3107" data-line-number="3107"></td>
        <td id="LC3107">                        }</td>
      </tr>
      <tr>
        <td id="L3108" data-line-number="3108"></td>
        <td id="LC3108">                        <span>env</span>.<span>newRoutingInfo</span> <span>=</span> <span>new</span> <span>RoutingInfo</span>(<span>protocol</span>, <span>port</span>, <span>serverName</span>);</td>
      </tr>
      <tr>
        <td id="L3109" data-line-number="3109"></td>
        <td id="LC3109">                        <span>UInt16</span> <span>oldLength</span>;</td>
      </tr>
      <tr>
        <td id="L3110" data-line-number="3110"></td>
        <td id="LC3110">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>oldLength</span>))</td>
      </tr>
      <tr>
        <td id="L3111" data-line-number="3111"></td>
        <td id="LC3111">                        {</td>
      </tr>
      <tr>
        <td id="L3112" data-line-number="3112"></td>
        <td id="LC3112">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3113" data-line-number="3113"></td>
        <td id="LC3113">                        }</td>
      </tr>
      <tr>
        <td id="L3114" data-line-number="3114"></td>
        <td id="LC3114">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>oldLength</span>))</td>
      </tr>
      <tr>
        <td id="L3115" data-line-number="3115"></td>
        <td id="LC3115">                        {</td>
      </tr>
      <tr>
        <td id="L3116" data-line-number="3116"></td>
        <td id="LC3116">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3117" data-line-number="3117"></td>
        <td id="LC3117">                        }</td>
      </tr>
      <tr>
        <td id="L3118" data-line-number="3118"></td>
        <td id="LC3118">                        <span>env</span>.<span>length</span> <span>=</span> <span>env</span>.<span>newLength</span> <span>+</span> <span>oldLength</span> <span>+</span> <span>5</span>; <span><span>//</span> 5=2*sizeof(UInt16)+sizeof(byte) [token+newLength+oldLength]</span></td>
      </tr>
      <tr>
        <td id="L3119" data-line-number="3119"></td>
        <td id="LC3119">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3120" data-line-number="3120"></td>
        <td id="LC3120">
</td>
      </tr>
      <tr>
        <td id="L3121" data-line-number="3121"></td>
        <td id="LC3121">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L3122" data-line-number="3122"></td>
        <td id="LC3122">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown environment change token: <span>"</span></span> <span>+</span> <span>env</span>.<span>type</span>);</td>
      </tr>
      <tr>
        <td id="L3123" data-line-number="3123"></td>
        <td id="LC3123">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3124" data-line-number="3124"></td>
        <td id="LC3124">                }</td>
      </tr>
      <tr>
        <td id="L3125" data-line-number="3125"></td>
        <td id="LC3125">                <span>processedLength</span> <span>+=</span> <span>env</span>.<span>length</span>;</td>
      </tr>
      <tr>
        <td id="L3126" data-line-number="3126"></td>
        <td id="LC3126">            }</td>
      </tr>
      <tr>
        <td id="L3127" data-line-number="3127"></td>
        <td id="LC3127">
</td>
      </tr>
      <tr>
        <td id="L3128" data-line-number="3128"></td>
        <td id="LC3128">            <span>sqlEnvChange</span> <span>=</span> <span>envarray</span>;</td>
      </tr>
      <tr>
        <td id="L3129" data-line-number="3129"></td>
        <td id="LC3129">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3130" data-line-number="3130"></td>
        <td id="LC3130">        }</td>
      </tr>
      <tr>
        <td id="L3131" data-line-number="3131"></td>
        <td id="LC3131">
</td>
      </tr>
      <tr>
        <td id="L3132" data-line-number="3132"></td>
        <td id="LC3132">        <span>private</span> <span>bool</span> <span>TryReadTwoBinaryFields</span>(<span>SqlEnvChange</span> <span>env</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L3133" data-line-number="3133"></td>
        <td id="LC3133">        {</td>
      </tr>
      <tr>
        <td id="L3134" data-line-number="3134"></td>
        <td id="LC3134">            <span><span>//</span> Used by ProcessEnvChangeToken</span></td>
      </tr>
      <tr>
        <td id="L3135" data-line-number="3135"></td>
        <td id="LC3135">            <span>byte</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L3136" data-line-number="3136"></td>
        <td id="LC3136">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L3137" data-line-number="3137"></td>
        <td id="LC3137">            {</td>
      </tr>
      <tr>
        <td id="L3138" data-line-number="3138"></td>
        <td id="LC3138">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3139" data-line-number="3139"></td>
        <td id="LC3139">            }</td>
      </tr>
      <tr>
        <td id="L3140" data-line-number="3140"></td>
        <td id="LC3140">            <span>env</span>.<span>newLength</span> <span>=</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L3141" data-line-number="3141"></td>
        <td id="LC3141">            <span>env</span>.<span>newBinValue</span> <span>=</span> <span>new</span> <span>byte</span>[<span>env</span>.<span>newLength</span>];</td>
      </tr>
      <tr>
        <td id="L3142" data-line-number="3142"></td>
        <td id="LC3142">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>env</span>.<span>newBinValue</span>, <span>0</span>, <span>env</span>.<span>newLength</span>))</td>
      </tr>
      <tr>
        <td id="L3143" data-line-number="3143"></td>
        <td id="LC3143">            {</td>
      </tr>
      <tr>
        <td id="L3144" data-line-number="3144"></td>
        <td id="LC3144">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3145" data-line-number="3145"></td>
        <td id="LC3145">            }</td>
      </tr>
      <tr>
        <td id="L3146" data-line-number="3146"></td>
        <td id="LC3146">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L3147" data-line-number="3147"></td>
        <td id="LC3147">            {</td>
      </tr>
      <tr>
        <td id="L3148" data-line-number="3148"></td>
        <td id="LC3148">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3149" data-line-number="3149"></td>
        <td id="LC3149">            }</td>
      </tr>
      <tr>
        <td id="L3150" data-line-number="3150"></td>
        <td id="LC3150">            <span>env</span>.<span>oldLength</span> <span>=</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L3151" data-line-number="3151"></td>
        <td id="LC3151">            <span>env</span>.<span>oldBinValue</span> <span>=</span> <span>new</span> <span>byte</span>[<span>env</span>.<span>oldLength</span>];</td>
      </tr>
      <tr>
        <td id="L3152" data-line-number="3152"></td>
        <td id="LC3152">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>env</span>.<span>oldBinValue</span>, <span>0</span>, <span>env</span>.<span>oldLength</span>))</td>
      </tr>
      <tr>
        <td id="L3153" data-line-number="3153"></td>
        <td id="LC3153">            {</td>
      </tr>
      <tr>
        <td id="L3154" data-line-number="3154"></td>
        <td id="LC3154">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3155" data-line-number="3155"></td>
        <td id="LC3155">            }</td>
      </tr>
      <tr>
        <td id="L3156" data-line-number="3156"></td>
        <td id="LC3156">
</td>
      </tr>
      <tr>
        <td id="L3157" data-line-number="3157"></td>
        <td id="LC3157">            <span><span>//</span> env.length includes 1 byte type token</span></td>
      </tr>
      <tr>
        <td id="L3158" data-line-number="3158"></td>
        <td id="LC3158">            <span>env</span>.<span>length</span> <span>=</span> <span>3</span> <span>+</span> <span>env</span>.<span>newLength</span> <span>+</span> <span>env</span>.<span>oldLength</span>;</td>
      </tr>
      <tr>
        <td id="L3159" data-line-number="3159"></td>
        <td id="LC3159">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3160" data-line-number="3160"></td>
        <td id="LC3160">        }</td>
      </tr>
      <tr>
        <td id="L3161" data-line-number="3161"></td>
        <td id="LC3161">
</td>
      </tr>
      <tr>
        <td id="L3162" data-line-number="3162"></td>
        <td id="LC3162">        <span>private</span> <span>bool</span> <span>TryReadTwoStringFields</span>(<span>SqlEnvChange</span> <span>env</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L3163" data-line-number="3163"></td>
        <td id="LC3163">        {</td>
      </tr>
      <tr>
        <td id="L3164" data-line-number="3164"></td>
        <td id="LC3164">            <span><span>//</span> Used by ProcessEnvChangeToken</span></td>
      </tr>
      <tr>
        <td id="L3165" data-line-number="3165"></td>
        <td id="LC3165">            <span>byte</span> <span>newLength</span>, <span>oldLength</span>;</td>
      </tr>
      <tr>
        <td id="L3166" data-line-number="3166"></td>
        <td id="LC3166">            <span>string</span> <span>newValue</span>, <span>oldValue</span>;</td>
      </tr>
      <tr>
        <td id="L3167" data-line-number="3167"></td>
        <td id="LC3167">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>newLength</span>))</td>
      </tr>
      <tr>
        <td id="L3168" data-line-number="3168"></td>
        <td id="LC3168">            {</td>
      </tr>
      <tr>
        <td id="L3169" data-line-number="3169"></td>
        <td id="LC3169">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3170" data-line-number="3170"></td>
        <td id="LC3170">            }</td>
      </tr>
      <tr>
        <td id="L3171" data-line-number="3171"></td>
        <td id="LC3171">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>newLength</span>, <span>out</span> <span>newValue</span>))</td>
      </tr>
      <tr>
        <td id="L3172" data-line-number="3172"></td>
        <td id="LC3172">            {</td>
      </tr>
      <tr>
        <td id="L3173" data-line-number="3173"></td>
        <td id="LC3173">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3174" data-line-number="3174"></td>
        <td id="LC3174">            }</td>
      </tr>
      <tr>
        <td id="L3175" data-line-number="3175"></td>
        <td id="LC3175">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>oldLength</span>))</td>
      </tr>
      <tr>
        <td id="L3176" data-line-number="3176"></td>
        <td id="LC3176">            {</td>
      </tr>
      <tr>
        <td id="L3177" data-line-number="3177"></td>
        <td id="LC3177">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3178" data-line-number="3178"></td>
        <td id="LC3178">            }</td>
      </tr>
      <tr>
        <td id="L3179" data-line-number="3179"></td>
        <td id="LC3179">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>oldLength</span>, <span>out</span> <span>oldValue</span>))</td>
      </tr>
      <tr>
        <td id="L3180" data-line-number="3180"></td>
        <td id="LC3180">            {</td>
      </tr>
      <tr>
        <td id="L3181" data-line-number="3181"></td>
        <td id="LC3181">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3182" data-line-number="3182"></td>
        <td id="LC3182">            }</td>
      </tr>
      <tr>
        <td id="L3183" data-line-number="3183"></td>
        <td id="LC3183">
</td>
      </tr>
      <tr>
        <td id="L3184" data-line-number="3184"></td>
        <td id="LC3184">            <span>env</span>.<span>newLength</span> <span>=</span> <span>newLength</span>;</td>
      </tr>
      <tr>
        <td id="L3185" data-line-number="3185"></td>
        <td id="LC3185">            <span>env</span>.<span>newValue</span> <span>=</span> <span>newValue</span>;</td>
      </tr>
      <tr>
        <td id="L3186" data-line-number="3186"></td>
        <td id="LC3186">            <span>env</span>.<span>oldLength</span> <span>=</span> <span>oldLength</span>;</td>
      </tr>
      <tr>
        <td id="L3187" data-line-number="3187"></td>
        <td id="LC3187">            <span>env</span>.<span>oldValue</span> <span>=</span> <span>oldValue</span>;</td>
      </tr>
      <tr>
        <td id="L3188" data-line-number="3188"></td>
        <td id="LC3188">
</td>
      </tr>
      <tr>
        <td id="L3189" data-line-number="3189"></td>
        <td id="LC3189">            <span><span>//</span> env.length includes 1 byte type token</span></td>
      </tr>
      <tr>
        <td id="L3190" data-line-number="3190"></td>
        <td id="LC3190">            <span>env</span>.<span>length</span> <span>=</span> <span>3</span> <span>+</span> <span>env</span>.<span>newLength</span> <span>*</span> <span>2</span> <span>+</span> <span>env</span>.<span>oldLength</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L3191" data-line-number="3191"></td>
        <td id="LC3191">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3192" data-line-number="3192"></td>
        <td id="LC3192">        }</td>
      </tr>
      <tr>
        <td id="L3193" data-line-number="3193"></td>
        <td id="LC3193">
</td>
      </tr>
      <tr>
        <td id="L3194" data-line-number="3194"></td>
        <td id="LC3194">        <span>private</span> <span>bool</span> <span>TryProcessDone</span>(<span>SqlCommand</span> <span>cmd</span>, <span>SqlDataReader</span> <span>reader</span>, <span>ref</span> <span>RunBehavior</span> <span>run</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L3195" data-line-number="3195"></td>
        <td id="LC3195">        {</td>
      </tr>
      <tr>
        <td id="L3196" data-line-number="3196"></td>
        <td id="LC3196">            <span>ushort</span> <span>curCmd</span>;</td>
      </tr>
      <tr>
        <td id="L3197" data-line-number="3197"></td>
        <td id="LC3197">            <span>ushort</span> <span>status</span>;</td>
      </tr>
      <tr>
        <td id="L3198" data-line-number="3198"></td>
        <td id="LC3198">            <span>int</span> <span>count</span>;</td>
      </tr>
      <tr>
        <td id="L3199" data-line-number="3199"></td>
        <td id="LC3199">
</td>
      </tr>
      <tr>
        <td id="L3200" data-line-number="3200"></td>
        <td id="LC3200">            <span>if</span> (<span>LocalAppContextSwitches</span>.<span>MakeReadAsyncBlocking</span>)</td>
      </tr>
      <tr>
        <td id="L3201" data-line-number="3201"></td>
        <td id="LC3201">            {</td>
      </tr>
      <tr>
        <td id="L3202" data-line-number="3202"></td>
        <td id="LC3202">                <span><span>//</span> Can't retry TryProcessDone</span></td>
      </tr>
      <tr>
        <td id="L3203" data-line-number="3203"></td>
        <td id="LC3203">                <span>stateObj</span>.<span>_syncOverAsync</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3204" data-line-number="3204"></td>
        <td id="LC3204">            }</td>
      </tr>
      <tr>
        <td id="L3205" data-line-number="3205"></td>
        <td id="LC3205">
</td>
      </tr>
      <tr>
        <td id="L3206" data-line-number="3206"></td>
        <td id="LC3206">            <span><span>//</span> status</span></td>
      </tr>
      <tr>
        <td id="L3207" data-line-number="3207"></td>
        <td id="LC3207">            <span><span>//</span> command</span></td>
      </tr>
      <tr>
        <td id="L3208" data-line-number="3208"></td>
        <td id="LC3208">            <span><span>//</span> rowcount (valid only if DONE_COUNT bit is set)</span></td>
      </tr>
      <tr>
        <td id="L3209" data-line-number="3209"></td>
        <td id="LC3209">
</td>
      </tr>
      <tr>
        <td id="L3210" data-line-number="3210"></td>
        <td id="LC3210">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>status</span>))</td>
      </tr>
      <tr>
        <td id="L3211" data-line-number="3211"></td>
        <td id="LC3211">            {</td>
      </tr>
      <tr>
        <td id="L3212" data-line-number="3212"></td>
        <td id="LC3212">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3213" data-line-number="3213"></td>
        <td id="LC3213">            }</td>
      </tr>
      <tr>
        <td id="L3214" data-line-number="3214"></td>
        <td id="LC3214">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>curCmd</span>))</td>
      </tr>
      <tr>
        <td id="L3215" data-line-number="3215"></td>
        <td id="LC3215">            {</td>
      </tr>
      <tr>
        <td id="L3216" data-line-number="3216"></td>
        <td id="LC3216">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3217" data-line-number="3217"></td>
        <td id="LC3217">            }</td>
      </tr>
      <tr>
        <td id="L3218" data-line-number="3218"></td>
        <td id="LC3218">
</td>
      </tr>
      <tr>
        <td id="L3219" data-line-number="3219"></td>
        <td id="LC3219">            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L3220" data-line-number="3220"></td>
        <td id="LC3220">            {</td>
      </tr>
      <tr>
        <td id="L3221" data-line-number="3221"></td>
        <td id="LC3221">                <span>long</span> <span>longCount</span>;</td>
      </tr>
      <tr>
        <td id="L3222" data-line-number="3222"></td>
        <td id="LC3222">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt64</span>(<span>out</span> <span>longCount</span>))</td>
      </tr>
      <tr>
        <td id="L3223" data-line-number="3223"></td>
        <td id="LC3223">                {</td>
      </tr>
      <tr>
        <td id="L3224" data-line-number="3224"></td>
        <td id="LC3224">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3225" data-line-number="3225"></td>
        <td id="LC3225">                }</td>
      </tr>
      <tr>
        <td id="L3226" data-line-number="3226"></td>
        <td id="LC3226">                <span>count</span> <span>=</span> (<span>int</span>)<span>longCount</span>;</td>
      </tr>
      <tr>
        <td id="L3227" data-line-number="3227"></td>
        <td id="LC3227">            }</td>
      </tr>
      <tr>
        <td id="L3228" data-line-number="3228"></td>
        <td id="LC3228">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L3229" data-line-number="3229"></td>
        <td id="LC3229">            {</td>
      </tr>
      <tr>
        <td id="L3230" data-line-number="3230"></td>
        <td id="LC3230">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>count</span>))</td>
      </tr>
      <tr>
        <td id="L3231" data-line-number="3231"></td>
        <td id="LC3231">                {</td>
      </tr>
      <tr>
        <td id="L3232" data-line-number="3232"></td>
        <td id="LC3232">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3233" data-line-number="3233"></td>
        <td id="LC3233">                }</td>
      </tr>
      <tr>
        <td id="L3234" data-line-number="3234"></td>
        <td id="LC3234">                <span><span>//</span> If we haven't yet completed processing login token stream yet, we may be talking to a Yukon server</span></td>
      </tr>
      <tr>
        <td id="L3235" data-line-number="3235"></td>
        <td id="LC3235">                <span><span>//</span> In that case we still have to read another 4 bytes</span></td>
      </tr>
      <tr>
        <td id="L3236" data-line-number="3236"></td>
        <td id="LC3236">                <span><span>//</span> But don't try to read beyond the TDS stream in this case, because it generates errors if login failed.</span></td>
      </tr>
      <tr>
        <td id="L3237" data-line-number="3237"></td>
        <td id="LC3237">                <span>if</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span>)</td>
      </tr>
      <tr>
        <td id="L3238" data-line-number="3238"></td>
        <td id="LC3238">                {</td>
      </tr>
      <tr>
        <td id="L3239" data-line-number="3239"></td>
        <td id="LC3239">                    <span><span>//</span> Login incomplete, if we are reading from Yukon we need to read another int</span></td>
      </tr>
      <tr>
        <td id="L3240" data-line-number="3240"></td>
        <td id="LC3240">                    <span>if</span> (<span>stateObj</span>.<span>_inBytesRead</span> <span>&gt;</span> <span>stateObj</span>.<span>_inBytesUsed</span>)</td>
      </tr>
      <tr>
        <td id="L3241" data-line-number="3241"></td>
        <td id="LC3241">                    {</td>
      </tr>
      <tr>
        <td id="L3242" data-line-number="3242"></td>
        <td id="LC3242">                        <span>byte</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L3243" data-line-number="3243"></td>
        <td id="LC3243">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryPeekByte</span>(<span>out</span> <span>b</span>))</td>
      </tr>
      <tr>
        <td id="L3244" data-line-number="3244"></td>
        <td id="LC3244">                        {</td>
      </tr>
      <tr>
        <td id="L3245" data-line-number="3245"></td>
        <td id="LC3245">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3246" data-line-number="3246"></td>
        <td id="LC3246">                        }</td>
      </tr>
      <tr>
        <td id="L3247" data-line-number="3247"></td>
        <td id="LC3247">                        <span>if</span> (<span>b</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L3248" data-line-number="3248"></td>
        <td id="LC3248">                        {</td>
      </tr>
      <tr>
        <td id="L3249" data-line-number="3249"></td>
        <td id="LC3249">                            <span><span>//</span> This is an invalid token value</span></td>
      </tr>
      <tr>
        <td id="L3250" data-line-number="3250"></td>
        <td id="LC3250">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>count</span>))</td>
      </tr>
      <tr>
        <td id="L3251" data-line-number="3251"></td>
        <td id="LC3251">                            {</td>
      </tr>
      <tr>
        <td id="L3252" data-line-number="3252"></td>
        <td id="LC3252">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3253" data-line-number="3253"></td>
        <td id="LC3253">                            }</td>
      </tr>
      <tr>
        <td id="L3254" data-line-number="3254"></td>
        <td id="LC3254">                        }</td>
      </tr>
      <tr>
        <td id="L3255" data-line-number="3255"></td>
        <td id="LC3255">                    }</td>
      </tr>
      <tr>
        <td id="L3256" data-line-number="3256"></td>
        <td id="LC3256">                }</td>
      </tr>
      <tr>
        <td id="L3257" data-line-number="3257"></td>
        <td id="LC3257">            }</td>
      </tr>
      <tr>
        <td id="L3258" data-line-number="3258"></td>
        <td id="LC3258">
</td>
      </tr>
      <tr>
        <td id="L3259" data-line-number="3259"></td>
        <td id="LC3259">            <span><span>//</span> We get a done token with the attention bit set</span></td>
      </tr>
      <tr>
        <td id="L3260" data-line-number="3260"></td>
        <td id="LC3260">            <span>if</span> (<span>TdsEnums</span>.<span>DONE_ATTN</span> <span>==</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>DONE_ATTN</span>))</td>
      </tr>
      <tr>
        <td id="L3261" data-line-number="3261"></td>
        <td id="LC3261">            {</td>
      </tr>
      <tr>
        <td id="L3262" data-line-number="3262"></td>
        <td id="LC3262">                <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>DONE_MORE</span> <span>!=</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>DONE_MORE</span>), <span><span>"</span>Not expecting DONE_MORE when receiving DONE_ATTN<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3263" data-line-number="3263"></td>
        <td id="LC3263">                <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_attentionSent</span>, <span><span>"</span>Received attention done without sending one!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3264" data-line-number="3264"></td>
        <td id="LC3264">                <span>stateObj</span>.<span>_attentionReceived</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3265" data-line-number="3265"></td>
        <td id="LC3265">                <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_inBytesUsed</span> <span>==</span> <span>stateObj</span>.<span>_inBytesRead</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_inBytesPacket</span> <span>==</span> <span>0</span>, <span><span>"</span>DONE_ATTN received with more data left on wire<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3266" data-line-number="3266"></td>
        <td id="LC3266">            }</td>
      </tr>
      <tr>
        <td id="L3267" data-line-number="3267"></td>
        <td id="LC3267">            <span>if</span> ((<span>null</span> <span>!=</span> <span>cmd</span>) <span>&amp;&amp;</span> (<span>TdsEnums</span>.<span>DONE_COUNT</span> <span>==</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>DONE_COUNT</span>)))</td>
      </tr>
      <tr>
        <td id="L3268" data-line-number="3268"></td>
        <td id="LC3268">            {</td>
      </tr>
      <tr>
        <td id="L3269" data-line-number="3269"></td>
        <td id="LC3269">                <span>if</span> (<span>curCmd</span> <span>!=</span> <span>TdsEnums</span>.<span>SELECT</span>)</td>
      </tr>
      <tr>
        <td id="L3270" data-line-number="3270"></td>
        <td id="LC3270">                {</td>
      </tr>
      <tr>
        <td id="L3271" data-line-number="3271"></td>
        <td id="LC3271">                    <span>if</span> (<span>cmd</span>.<span>IsDescribeParameterEncryptionRPCCurrentlyInProgress</span>)</td>
      </tr>
      <tr>
        <td id="L3272" data-line-number="3272"></td>
        <td id="LC3272">                    {</td>
      </tr>
      <tr>
        <td id="L3273" data-line-number="3273"></td>
        <td id="LC3273">                        <span><span>//</span> The below line is used only for debug asserts and not exposed publicly or impacts functionality otherwise.</span></td>
      </tr>
      <tr>
        <td id="L3274" data-line-number="3274"></td>
        <td id="LC3274">                        <span>cmd</span>.<span>RowsAffectedByDescribeParameterEncryption</span> <span>=</span> <span>count</span>;</td>
      </tr>
      <tr>
        <td id="L3275" data-line-number="3275"></td>
        <td id="LC3275">                    }</td>
      </tr>
      <tr>
        <td id="L3276" data-line-number="3276"></td>
        <td id="LC3276">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L3277" data-line-number="3277"></td>
        <td id="LC3277">                    {</td>
      </tr>
      <tr>
        <td id="L3278" data-line-number="3278"></td>
        <td id="LC3278">                        <span>cmd</span>.<span>InternalRecordsAffected</span> <span>=</span> <span>count</span>;</td>
      </tr>
      <tr>
        <td id="L3279" data-line-number="3279"></td>
        <td id="LC3279">                    }</td>
      </tr>
      <tr>
        <td id="L3280" data-line-number="3280"></td>
        <td id="LC3280">                }</td>
      </tr>
      <tr>
        <td id="L3281" data-line-number="3281"></td>
        <td id="LC3281">                <span><span>//</span> Skip the bogus DONE counts sent by the server</span></td>
      </tr>
      <tr>
        <td id="L3282" data-line-number="3282"></td>
        <td id="LC3282">                <span>if</span> (<span>stateObj</span>.<span>_receivedColMetaData</span> <span>||</span> (<span>curCmd</span> <span>!=</span> <span>TdsEnums</span>.<span>SELECT</span>))</td>
      </tr>
      <tr>
        <td id="L3283" data-line-number="3283"></td>
        <td id="LC3283">                {</td>
      </tr>
      <tr>
        <td id="L3284" data-line-number="3284"></td>
        <td id="LC3284">                    <span>cmd</span>.<span>OnStatementCompleted</span>(<span>count</span>);</td>
      </tr>
      <tr>
        <td id="L3285" data-line-number="3285"></td>
        <td id="LC3285">                }</td>
      </tr>
      <tr>
        <td id="L3286" data-line-number="3286"></td>
        <td id="LC3286">            }</td>
      </tr>
      <tr>
        <td id="L3287" data-line-number="3287"></td>
        <td id="LC3287">
</td>
      </tr>
      <tr>
        <td id="L3288" data-line-number="3288"></td>
        <td id="LC3288">            <span>stateObj</span>.<span>_receivedColMetaData</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3289" data-line-number="3289"></td>
        <td id="LC3289">
</td>
      </tr>
      <tr>
        <td id="L3290" data-line-number="3290"></td>
        <td id="LC3290">            <span><span>//</span> Surface exception for DONE_ERROR in the case we did not receive an error token</span></td>
      </tr>
      <tr>
        <td id="L3291" data-line-number="3291"></td>
        <td id="LC3291">            <span><span>//</span> in the stream, but an error occurred.  In these cases, we throw a general server error.  The</span></td>
      </tr>
      <tr>
        <td id="L3292" data-line-number="3292"></td>
        <td id="LC3292">            <span><span>//</span> situations where this can occur are: an invalid buffer received from client, login error</span></td>
      </tr>
      <tr>
        <td id="L3293" data-line-number="3293"></td>
        <td id="LC3293">            <span><span>//</span> and the server refused our connection, and the case where we are trying to log in but</span></td>
      </tr>
      <tr>
        <td id="L3294" data-line-number="3294"></td>
        <td id="LC3294">            <span><span>//</span> the server has reached its max connection limit.  Bottom line, we need to throw general</span></td>
      </tr>
      <tr>
        <td id="L3295" data-line-number="3295"></td>
        <td id="LC3295">            <span><span>//</span> error in the cases where we did not receive a error token along with the DONE_ERROR.</span></td>
      </tr>
      <tr>
        <td id="L3296" data-line-number="3296"></td>
        <td id="LC3296">            <span>if</span> ((<span>TdsEnums</span>.<span>DONE_ERROR</span> <span>==</span> (<span>TdsEnums</span>.<span>DONE_ERROR</span> <span>&amp;</span> <span>status</span>)) <span>&amp;&amp;</span> <span>stateObj</span>.<span>ErrorCount</span> <span>==</span> <span>0</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L3297" data-line-number="3297"></td>
        <td id="LC3297">                  <span>stateObj</span>.<span>_errorTokenReceived</span> <span>==</span> <span>false</span> <span>&amp;&amp;</span> (<span>RunBehavior</span>.<span>Clean</span> <span>!=</span> (<span>RunBehavior</span>.<span>Clean</span> <span>&amp;</span> <span>run</span>)))</td>
      </tr>
      <tr>
        <td id="L3298" data-line-number="3298"></td>
        <td id="LC3298">            {</td>
      </tr>
      <tr>
        <td id="L3299" data-line-number="3299"></td>
        <td id="LC3299">                <span>stateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>0</span>, <span>0</span>, <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>SevereError</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L3300" data-line-number="3300"></td>
        <td id="LC3300">
</td>
      </tr>
      <tr>
        <td id="L3301" data-line-number="3301"></td>
        <td id="LC3301">                <span>if</span> (<span>null</span> <span>!=</span> <span>reader</span>)</td>
      </tr>
      <tr>
        <td id="L3302" data-line-number="3302"></td>
        <td id="LC3302">                { <span><span>//</span> SQL BU DT 269516</span></td>
      </tr>
      <tr>
        <td id="L3303" data-line-number="3303"></td>
        <td id="LC3303">                    <span>if</span> (<span>!</span><span>reader</span>.<span>IsInitialized</span>)</td>
      </tr>
      <tr>
        <td id="L3304" data-line-number="3304"></td>
        <td id="LC3304">                    {</td>
      </tr>
      <tr>
        <td id="L3305" data-line-number="3305"></td>
        <td id="LC3305">                        <span>run</span> <span>=</span> <span>RunBehavior</span>.<span>UntilDone</span>;</td>
      </tr>
      <tr>
        <td id="L3306" data-line-number="3306"></td>
        <td id="LC3306">                    }</td>
      </tr>
      <tr>
        <td id="L3307" data-line-number="3307"></td>
        <td id="LC3307">                }</td>
      </tr>
      <tr>
        <td id="L3308" data-line-number="3308"></td>
        <td id="LC3308">            }</td>
      </tr>
      <tr>
        <td id="L3309" data-line-number="3309"></td>
        <td id="LC3309">
</td>
      </tr>
      <tr>
        <td id="L3310" data-line-number="3310"></td>
        <td id="LC3310">            <span><span>//</span> Similar to above, only with a more severe error.  In this case, if we received</span></td>
      </tr>
      <tr>
        <td id="L3311" data-line-number="3311"></td>
        <td id="LC3311">            <span><span>//</span> the done_srverror, this exception will be added to the collection regardless.</span></td>
      </tr>
      <tr>
        <td id="L3312" data-line-number="3312"></td>
        <td id="LC3312">            <span><span>//</span> MDAC #93896.  Also, per Ashwin, the server will always break the connection in this case.</span></td>
      </tr>
      <tr>
        <td id="L3313" data-line-number="3313"></td>
        <td id="LC3313">            <span>if</span> ((<span>TdsEnums</span>.<span>DONE_SRVERROR</span> <span>==</span> (<span>TdsEnums</span>.<span>DONE_SRVERROR</span> <span>&amp;</span> <span>status</span>)) <span>&amp;&amp;</span> (<span>RunBehavior</span>.<span>Clean</span> <span>!=</span> (<span>RunBehavior</span>.<span>Clean</span> <span>&amp;</span> <span>run</span>)))</td>
      </tr>
      <tr>
        <td id="L3314" data-line-number="3314"></td>
        <td id="LC3314">            {</td>
      </tr>
      <tr>
        <td id="L3315" data-line-number="3315"></td>
        <td id="LC3315">                <span>stateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>0</span>, <span>0</span>, <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>SevereError</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L3316" data-line-number="3316"></td>
        <td id="LC3316">
</td>
      </tr>
      <tr>
        <td id="L3317" data-line-number="3317"></td>
        <td id="LC3317">                <span>if</span> (<span>null</span> <span>!=</span> <span>reader</span>)</td>
      </tr>
      <tr>
        <td id="L3318" data-line-number="3318"></td>
        <td id="LC3318">                { <span><span>//</span> SQL BU DT 269516</span></td>
      </tr>
      <tr>
        <td id="L3319" data-line-number="3319"></td>
        <td id="LC3319">                    <span>if</span> (<span>!</span><span>reader</span>.<span>IsInitialized</span>)</td>
      </tr>
      <tr>
        <td id="L3320" data-line-number="3320"></td>
        <td id="LC3320">                    {</td>
      </tr>
      <tr>
        <td id="L3321" data-line-number="3321"></td>
        <td id="LC3321">                        <span>run</span> <span>=</span> <span>RunBehavior</span>.<span>UntilDone</span>;</td>
      </tr>
      <tr>
        <td id="L3322" data-line-number="3322"></td>
        <td id="LC3322">                    }</td>
      </tr>
      <tr>
        <td id="L3323" data-line-number="3323"></td>
        <td id="LC3323">                }</td>
      </tr>
      <tr>
        <td id="L3324" data-line-number="3324"></td>
        <td id="LC3324">            }</td>
      </tr>
      <tr>
        <td id="L3325" data-line-number="3325"></td>
        <td id="LC3325">
</td>
      </tr>
      <tr>
        <td id="L3326" data-line-number="3326"></td>
        <td id="LC3326">            <span>ProcessSqlStatistics</span>(<span>curCmd</span>, <span>status</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L3327" data-line-number="3327"></td>
        <td id="LC3327">
</td>
      </tr>
      <tr>
        <td id="L3328" data-line-number="3328"></td>
        <td id="LC3328">            <span><span>//</span> stop if the DONE_MORE bit isn't set (see above for attention handling)</span></td>
      </tr>
      <tr>
        <td id="L3329" data-line-number="3329"></td>
        <td id="LC3329">            <span>if</span> (<span>TdsEnums</span>.<span>DONE_MORE</span> <span>!=</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>DONE_MORE</span>))</td>
      </tr>
      <tr>
        <td id="L3330" data-line-number="3330"></td>
        <td id="LC3330">            {</td>
      </tr>
      <tr>
        <td id="L3331" data-line-number="3331"></td>
        <td id="LC3331">                <span>stateObj</span>.<span>_errorTokenReceived</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3332" data-line-number="3332"></td>
        <td id="LC3332">                <span>if</span> (<span>stateObj</span>.<span>_inBytesUsed</span> <span>&gt;=</span> <span>stateObj</span>.<span>_inBytesRead</span>)</td>
      </tr>
      <tr>
        <td id="L3333" data-line-number="3333"></td>
        <td id="LC3333">                {</td>
      </tr>
      <tr>
        <td id="L3334" data-line-number="3334"></td>
        <td id="LC3334">                    <span>stateObj</span>.<span>_pendingData</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3335" data-line-number="3335"></td>
        <td id="LC3335">                }</td>
      </tr>
      <tr>
        <td id="L3336" data-line-number="3336"></td>
        <td id="LC3336">            }</td>
      </tr>
      <tr>
        <td id="L3337" data-line-number="3337"></td>
        <td id="LC3337">
</td>
      </tr>
      <tr>
        <td id="L3338" data-line-number="3338"></td>
        <td id="LC3338">            <span><span>//</span> _pendingData set by e.g. 'TdsExecuteSQLBatch'</span></td>
      </tr>
      <tr>
        <td id="L3339" data-line-number="3339"></td>
        <td id="LC3339">            <span><span>//</span> _hasOpenResult always set to true by 'WriteMarsHeader'</span></td>
      </tr>
      <tr>
        <td id="L3340" data-line-number="3340"></td>
        <td id="LC3340">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L3341" data-line-number="3341"></td>
        <td id="LC3341">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>_pendingData</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_hasOpenResult</span>)</td>
      </tr>
      <tr>
        <td id="L3342" data-line-number="3342"></td>
        <td id="LC3342">            {</td>
      </tr>
      <tr>
        <td id="L3343" data-line-number="3343"></td>
        <td id="LC3343">                <span><span>/*</span></span></td>
      </tr>
      <tr>
        <td id="L3344" data-line-number="3344"></td>
        <td id="LC3344"><span>                                Debug.Assert(!((sqlTransaction != null               &amp;&amp; _distributedTransaction != null) ||</span></td>
      </tr>
      <tr>
        <td id="L3345" data-line-number="3345"></td>
        <td id="LC3345"><span>                                               (_userStartedLocalTransaction != null &amp;&amp; _distributedTransaction != null))</span></td>
      </tr>
      <tr>
        <td id="L3346" data-line-number="3346"></td>
        <td id="LC3346"><span>                                              , "ProcessDone - have both distributed and local transactions not null!");</span></td>
      </tr>
      <tr>
        <td id="L3347" data-line-number="3347"></td>
        <td id="LC3347"><span>                <span>*/</span></span> <span><span>//</span> WebData 112722</span></td>
      </tr>
      <tr>
        <td id="L3348" data-line-number="3348"></td>
        <td id="LC3348">
</td>
      </tr>
      <tr>
        <td id="L3349" data-line-number="3349"></td>
        <td id="LC3349">                <span>stateObj</span>.<span>DecrementOpenResultCount</span>();</td>
      </tr>
      <tr>
        <td id="L3350" data-line-number="3350"></td>
        <td id="LC3350">            }</td>
      </tr>
      <tr>
        <td id="L3351" data-line-number="3351"></td>
        <td id="LC3351">
</td>
      </tr>
      <tr>
        <td id="L3352" data-line-number="3352"></td>
        <td id="LC3352">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3353" data-line-number="3353"></td>
        <td id="LC3353">        }</td>
      </tr>
      <tr>
        <td id="L3354" data-line-number="3354"></td>
        <td id="LC3354">
</td>
      </tr>
      <tr>
        <td id="L3355" data-line-number="3355"></td>
        <td id="LC3355">        <span>private</span> <span>void</span> <span>ProcessSqlStatistics</span>(<span>ushort</span> <span>curCmd</span>, <span>ushort</span> <span>status</span>, <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L3356" data-line-number="3356"></td>
        <td id="LC3356">        {</td>
      </tr>
      <tr>
        <td id="L3357" data-line-number="3357"></td>
        <td id="LC3357">            <span><span>//</span> SqlStatistics bookkeeping stuff</span></td>
      </tr>
      <tr>
        <td id="L3358" data-line-number="3358"></td>
        <td id="LC3358">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L3359" data-line-number="3359"></td>
        <td id="LC3359">            <span>if</span> (<span>null</span> <span>!=</span> <span>_statistics</span>)</td>
      </tr>
      <tr>
        <td id="L3360" data-line-number="3360"></td>
        <td id="LC3360">            {</td>
      </tr>
      <tr>
        <td id="L3361" data-line-number="3361"></td>
        <td id="LC3361">                <span><span>//</span> any done after row(s) counts as a resultset</span></td>
      </tr>
      <tr>
        <td id="L3362" data-line-number="3362"></td>
        <td id="LC3362">                <span>if</span> (<span>_statistics</span>.<span>WaitForDoneAfterRow</span>)</td>
      </tr>
      <tr>
        <td id="L3363" data-line-number="3363"></td>
        <td id="LC3363">                {</td>
      </tr>
      <tr>
        <td id="L3364" data-line-number="3364"></td>
        <td id="LC3364">                    <span>_statistics</span>.<span>SafeIncrement</span>(<span>ref</span> <span>_statistics</span>.<span>_sumResultSets</span>);</td>
      </tr>
      <tr>
        <td id="L3365" data-line-number="3365"></td>
        <td id="LC3365">                    <span>_statistics</span>.<span>WaitForDoneAfterRow</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3366" data-line-number="3366"></td>
        <td id="LC3366">                }</td>
      </tr>
      <tr>
        <td id="L3367" data-line-number="3367"></td>
        <td id="LC3367">
</td>
      </tr>
      <tr>
        <td id="L3368" data-line-number="3368"></td>
        <td id="LC3368">                <span><span>//</span> clear row count DONE_COUNT flag is not set</span></td>
      </tr>
      <tr>
        <td id="L3369" data-line-number="3369"></td>
        <td id="LC3369">                <span>if</span> (<span>!</span>(<span>TdsEnums</span>.<span>DONE_COUNT</span> <span>==</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>DONE_COUNT</span>)))</td>
      </tr>
      <tr>
        <td id="L3370" data-line-number="3370"></td>
        <td id="LC3370">                {</td>
      </tr>
      <tr>
        <td id="L3371" data-line-number="3371"></td>
        <td id="LC3371">                    <span>count</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L3372" data-line-number="3372"></td>
        <td id="LC3372">                }</td>
      </tr>
      <tr>
        <td id="L3373" data-line-number="3373"></td>
        <td id="LC3373">
</td>
      </tr>
      <tr>
        <td id="L3374" data-line-number="3374"></td>
        <td id="LC3374">                <span>switch</span> (<span>curCmd</span>)</td>
      </tr>
      <tr>
        <td id="L3375" data-line-number="3375"></td>
        <td id="LC3375">                {</td>
      </tr>
      <tr>
        <td id="L3376" data-line-number="3376"></td>
        <td id="LC3376">                    <span>case</span> <span>TdsEnums</span>.<span>INSERT</span>:</td>
      </tr>
      <tr>
        <td id="L3377" data-line-number="3377"></td>
        <td id="LC3377">                    <span>case</span> <span>TdsEnums</span>.<span>DELETE</span>:</td>
      </tr>
      <tr>
        <td id="L3378" data-line-number="3378"></td>
        <td id="LC3378">                    <span>case</span> <span>TdsEnums</span>.<span>UPDATE</span>:</td>
      </tr>
      <tr>
        <td id="L3379" data-line-number="3379"></td>
        <td id="LC3379">                    <span>case</span> <span>TdsEnums</span>.<span>MERGE</span>:</td>
      </tr>
      <tr>
        <td id="L3380" data-line-number="3380"></td>
        <td id="LC3380">                        <span>_statistics</span>.<span>SafeIncrement</span>(<span>ref</span> <span>_statistics</span>.<span>_iduCount</span>);</td>
      </tr>
      <tr>
        <td id="L3381" data-line-number="3381"></td>
        <td id="LC3381">                        <span>_statistics</span>.<span>SafeAdd</span>(<span>ref</span> <span>_statistics</span>.<span>_iduRows</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L3382" data-line-number="3382"></td>
        <td id="LC3382">                        <span>if</span> (<span>!</span><span>_statisticsIsInTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L3383" data-line-number="3383"></td>
        <td id="LC3383">                        {</td>
      </tr>
      <tr>
        <td id="L3384" data-line-number="3384"></td>
        <td id="LC3384">                            <span>_statistics</span>.<span>SafeIncrement</span>(<span>ref</span> <span>_statistics</span>.<span>_transactions</span>);</td>
      </tr>
      <tr>
        <td id="L3385" data-line-number="3385"></td>
        <td id="LC3385">                        }</td>
      </tr>
      <tr>
        <td id="L3386" data-line-number="3386"></td>
        <td id="LC3386">
</td>
      </tr>
      <tr>
        <td id="L3387" data-line-number="3387"></td>
        <td id="LC3387">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3388" data-line-number="3388"></td>
        <td id="LC3388">
</td>
      </tr>
      <tr>
        <td id="L3389" data-line-number="3389"></td>
        <td id="LC3389">                    <span>case</span> <span>TdsEnums</span>.<span>SELECT</span>:</td>
      </tr>
      <tr>
        <td id="L3390" data-line-number="3390"></td>
        <td id="LC3390">                        <span>_statistics</span>.<span>SafeIncrement</span>(<span>ref</span> <span>_statistics</span>.<span>_selectCount</span>);</td>
      </tr>
      <tr>
        <td id="L3391" data-line-number="3391"></td>
        <td id="LC3391">                        <span>_statistics</span>.<span>SafeAdd</span>(<span>ref</span> <span>_statistics</span>.<span>_selectRows</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L3392" data-line-number="3392"></td>
        <td id="LC3392">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3393" data-line-number="3393"></td>
        <td id="LC3393">
</td>
      </tr>
      <tr>
        <td id="L3394" data-line-number="3394"></td>
        <td id="LC3394">                    <span>case</span> <span>TdsEnums</span>.<span>BEGINXACT</span>:</td>
      </tr>
      <tr>
        <td id="L3395" data-line-number="3395"></td>
        <td id="LC3395">                        <span>if</span> (<span>!</span><span>_statisticsIsInTransaction</span>)</td>
      </tr>
      <tr>
        <td id="L3396" data-line-number="3396"></td>
        <td id="LC3396">                        {</td>
      </tr>
      <tr>
        <td id="L3397" data-line-number="3397"></td>
        <td id="LC3397">                            <span>_statistics</span>.<span>SafeIncrement</span>(<span>ref</span> <span>_statistics</span>.<span>_transactions</span>);</td>
      </tr>
      <tr>
        <td id="L3398" data-line-number="3398"></td>
        <td id="LC3398">                        }</td>
      </tr>
      <tr>
        <td id="L3399" data-line-number="3399"></td>
        <td id="LC3399">                        <span>_statisticsIsInTransaction</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3400" data-line-number="3400"></td>
        <td id="LC3400">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3401" data-line-number="3401"></td>
        <td id="LC3401">
</td>
      </tr>
      <tr>
        <td id="L3402" data-line-number="3402"></td>
        <td id="LC3402">                    <span>case</span> <span>TdsEnums</span>.<span>OPENCURSOR</span>:</td>
      </tr>
      <tr>
        <td id="L3403" data-line-number="3403"></td>
        <td id="LC3403">                        <span>_statistics</span>.<span>SafeIncrement</span>(<span>ref</span> <span>_statistics</span>.<span>_cursorOpens</span>);</td>
      </tr>
      <tr>
        <td id="L3404" data-line-number="3404"></td>
        <td id="LC3404">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3405" data-line-number="3405"></td>
        <td id="LC3405">
</td>
      </tr>
      <tr>
        <td id="L3406" data-line-number="3406"></td>
        <td id="LC3406">                    <span>case</span> <span>TdsEnums</span>.<span>ABORT</span>:</td>
      </tr>
      <tr>
        <td id="L3407" data-line-number="3407"></td>
        <td id="LC3407">                        <span>_statisticsIsInTransaction</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3408" data-line-number="3408"></td>
        <td id="LC3408">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3409" data-line-number="3409"></td>
        <td id="LC3409">
</td>
      </tr>
      <tr>
        <td id="L3410" data-line-number="3410"></td>
        <td id="LC3410">                    <span>case</span> <span>TdsEnums</span>.<span>ENDXACT</span>:</td>
      </tr>
      <tr>
        <td id="L3411" data-line-number="3411"></td>
        <td id="LC3411">                        <span>_statisticsIsInTransaction</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3412" data-line-number="3412"></td>
        <td id="LC3412">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3413" data-line-number="3413"></td>
        <td id="LC3413">                } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L3414" data-line-number="3414"></td>
        <td id="LC3414">            }</td>
      </tr>
      <tr>
        <td id="L3415" data-line-number="3415"></td>
        <td id="LC3415">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L3416" data-line-number="3416"></td>
        <td id="LC3416">            {</td>
      </tr>
      <tr>
        <td id="L3417" data-line-number="3417"></td>
        <td id="LC3417">                <span>switch</span> (<span>curCmd</span>)</td>
      </tr>
      <tr>
        <td id="L3418" data-line-number="3418"></td>
        <td id="LC3418">                {</td>
      </tr>
      <tr>
        <td id="L3419" data-line-number="3419"></td>
        <td id="LC3419">                    <span>case</span> <span>TdsEnums</span>.<span>BEGINXACT</span>:</td>
      </tr>
      <tr>
        <td id="L3420" data-line-number="3420"></td>
        <td id="LC3420">                        <span>_statisticsIsInTransaction</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3421" data-line-number="3421"></td>
        <td id="LC3421">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3422" data-line-number="3422"></td>
        <td id="LC3422">
</td>
      </tr>
      <tr>
        <td id="L3423" data-line-number="3423"></td>
        <td id="LC3423">                    <span>case</span> <span>TdsEnums</span>.<span>ABORT</span>:</td>
      </tr>
      <tr>
        <td id="L3424" data-line-number="3424"></td>
        <td id="LC3424">                    <span>case</span> <span>TdsEnums</span>.<span>ENDXACT</span>:</td>
      </tr>
      <tr>
        <td id="L3425" data-line-number="3425"></td>
        <td id="LC3425">                        <span>_statisticsIsInTransaction</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3426" data-line-number="3426"></td>
        <td id="LC3426">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3427" data-line-number="3427"></td>
        <td id="LC3427">                }</td>
      </tr>
      <tr>
        <td id="L3428" data-line-number="3428"></td>
        <td id="LC3428">            }</td>
      </tr>
      <tr>
        <td id="L3429" data-line-number="3429"></td>
        <td id="LC3429">        }</td>
      </tr>
      <tr>
        <td id="L3430" data-line-number="3430"></td>
        <td id="LC3430">
</td>
      </tr>
      <tr>
        <td id="L3431" data-line-number="3431"></td>
        <td id="LC3431">        <span>private</span> <span>bool</span> <span>TryProcessFeatureExtAck</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L3432" data-line-number="3432"></td>
        <td id="LC3432">        {</td>
      </tr>
      <tr>
        <td id="L3433" data-line-number="3433"></td>
        <td id="LC3433">            <span><span>//</span> read feature ID</span></td>
      </tr>
      <tr>
        <td id="L3434" data-line-number="3434"></td>
        <td id="LC3434">            <span>byte</span> <span>featureId</span>;</td>
      </tr>
      <tr>
        <td id="L3435" data-line-number="3435"></td>
        <td id="LC3435">            <span>do</span></td>
      </tr>
      <tr>
        <td id="L3436" data-line-number="3436"></td>
        <td id="LC3436">            {</td>
      </tr>
      <tr>
        <td id="L3437" data-line-number="3437"></td>
        <td id="LC3437">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>featureId</span>))</td>
      </tr>
      <tr>
        <td id="L3438" data-line-number="3438"></td>
        <td id="LC3438">                {</td>
      </tr>
      <tr>
        <td id="L3439" data-line-number="3439"></td>
        <td id="LC3439">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3440" data-line-number="3440"></td>
        <td id="LC3440">                }</td>
      </tr>
      <tr>
        <td id="L3441" data-line-number="3441"></td>
        <td id="LC3441">                <span>if</span> (<span>featureId</span> <span>!=</span> <span>TdsEnums</span>.<span>FEATUREEXT_TERMINATOR</span>)</td>
      </tr>
      <tr>
        <td id="L3442" data-line-number="3442"></td>
        <td id="LC3442">                {</td>
      </tr>
      <tr>
        <td id="L3443" data-line-number="3443"></td>
        <td id="LC3443">                    <span>UInt32</span> <span>dataLen</span>;</td>
      </tr>
      <tr>
        <td id="L3444" data-line-number="3444"></td>
        <td id="LC3444">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>dataLen</span>))</td>
      </tr>
      <tr>
        <td id="L3445" data-line-number="3445"></td>
        <td id="LC3445">                    {</td>
      </tr>
      <tr>
        <td id="L3446" data-line-number="3446"></td>
        <td id="LC3446">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3447" data-line-number="3447"></td>
        <td id="LC3447">                    }</td>
      </tr>
      <tr>
        <td id="L3448" data-line-number="3448"></td>
        <td id="LC3448">                    <span>byte</span>[] <span>data</span> <span>=</span> <span>new</span> <span>byte</span>[<span>dataLen</span>];</td>
      </tr>
      <tr>
        <td id="L3449" data-line-number="3449"></td>
        <td id="LC3449">                    <span>if</span> (<span>dataLen</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L3450" data-line-number="3450"></td>
        <td id="LC3450">                    {</td>
      </tr>
      <tr>
        <td id="L3451" data-line-number="3451"></td>
        <td id="LC3451">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>data</span>, <span>0</span>, <span>checked</span>((<span>int</span>)<span>dataLen</span>)))</td>
      </tr>
      <tr>
        <td id="L3452" data-line-number="3452"></td>
        <td id="LC3452">                        {</td>
      </tr>
      <tr>
        <td id="L3453" data-line-number="3453"></td>
        <td id="LC3453">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3454" data-line-number="3454"></td>
        <td id="LC3454">                        }</td>
      </tr>
      <tr>
        <td id="L3455" data-line-number="3455"></td>
        <td id="LC3455">                    }</td>
      </tr>
      <tr>
        <td id="L3456" data-line-number="3456"></td>
        <td id="LC3456">                    <span>_connHandler</span>.<span>OnFeatureExtAck</span>(<span>featureId</span>, <span>data</span>);</td>
      </tr>
      <tr>
        <td id="L3457" data-line-number="3457"></td>
        <td id="LC3457">                }</td>
      </tr>
      <tr>
        <td id="L3458" data-line-number="3458"></td>
        <td id="LC3458">            } <span>while</span> (<span>featureId</span> <span>!=</span> <span>TdsEnums</span>.<span>FEATUREEXT_TERMINATOR</span>);</td>
      </tr>
      <tr>
        <td id="L3459" data-line-number="3459"></td>
        <td id="LC3459">
</td>
      </tr>
      <tr>
        <td id="L3460" data-line-number="3460"></td>
        <td id="LC3460">            <span><span>//</span> Check if column encryption was on and feature wasn't acknowledged and we aren't going to be routed to another server.</span></td>
      </tr>
      <tr>
        <td id="L3461" data-line-number="3461"></td>
        <td id="LC3461">            <span>if</span> (<span>this</span>.<span>Connection</span>.<span>RoutingInfo</span> <span>==</span> <span>null</span></td>
      </tr>
      <tr>
        <td id="L3462" data-line-number="3462"></td>
        <td id="LC3462">                <span>&amp;&amp;</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>ColumnEncryptionSetting</span> <span>==</span> <span>SqlConnectionColumnEncryptionSetting</span>.<span>Enabled</span></td>
      </tr>
      <tr>
        <td id="L3463" data-line-number="3463"></td>
        <td id="LC3463">                <span>&amp;&amp;</span> <span>!</span><span>IsColumnEncryptionSupported</span>)</td>
      </tr>
      <tr>
        <td id="L3464" data-line-number="3464"></td>
        <td id="LC3464">            {</td>
      </tr>
      <tr>
        <td id="L3465" data-line-number="3465"></td>
        <td id="LC3465">                <span>throw</span> <span>SQL</span>.<span>TceNotSupported</span>();</td>
      </tr>
      <tr>
        <td id="L3466" data-line-number="3466"></td>
        <td id="LC3466">            }</td>
      </tr>
      <tr>
        <td id="L3467" data-line-number="3467"></td>
        <td id="LC3467">
</td>
      </tr>
      <tr>
        <td id="L3468" data-line-number="3468"></td>
        <td id="LC3468">            <span><span>//</span> Check if server does not support Enclave Computations and we aren't going to be routed to another server.</span></td>
      </tr>
      <tr>
        <td id="L3469" data-line-number="3469"></td>
        <td id="LC3469">            <span>if</span> (<span>Connection</span>.<span>RoutingInfo</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L3470" data-line-number="3470"></td>
        <td id="LC3470">            {</td>
      </tr>
      <tr>
        <td id="L3471" data-line-number="3471"></td>
        <td id="LC3471">                <span>SqlConnectionAttestationProtocol</span> <span>attestationProtocol</span> <span>=</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>AttestationProtocol</span>;</td>
      </tr>
      <tr>
        <td id="L3472" data-line-number="3472"></td>
        <td id="LC3472">
</td>
      </tr>
      <tr>
        <td id="L3473" data-line-number="3473"></td>
        <td id="LC3473">                <span>if</span> (<span>TceVersionSupported</span> <span>&lt;</span> <span>TdsEnums</span>.<span>MIN_TCE_VERSION_WITH_ENCLAVE_SUPPORT</span>)</td>
      </tr>
      <tr>
        <td id="L3474" data-line-number="3474"></td>
        <td id="LC3474">                {</td>
      </tr>
      <tr>
        <td id="L3475" data-line-number="3475"></td>
        <td id="LC3475">                    <span><span>//</span> Check if enclave attestation url was specified and server does not support enclave computations and we aren't going to be routed to another server.</span></td>
      </tr>
      <tr>
        <td id="L3476" data-line-number="3476"></td>
        <td id="LC3476">                    <span>if</span> (<span>!</span><span>string</span>.<span>IsNullOrWhiteSpace</span>(<span>_connHandler</span>.<span>ConnectionOptions</span>.<span>EnclaveAttestationUrl</span>) <span>&amp;&amp;</span> <span>SqlConnectionAttestationProtocol</span>.<span>NotSpecified</span> <span>!=</span> <span>attestationProtocol</span>)</td>
      </tr>
      <tr>
        <td id="L3477" data-line-number="3477"></td>
        <td id="LC3477">                    {</td>
      </tr>
      <tr>
        <td id="L3478" data-line-number="3478"></td>
        <td id="LC3478">                        <span>throw</span> <span>SQL</span>.<span>EnclaveComputationsNotSupported</span>();</td>
      </tr>
      <tr>
        <td id="L3479" data-line-number="3479"></td>
        <td id="LC3479">                    }</td>
      </tr>
      <tr>
        <td id="L3480" data-line-number="3480"></td>
        <td id="LC3480">                    <span>else</span> <span>if</span> (<span>!</span><span>string</span>.<span>IsNullOrWhiteSpace</span>(<span>_connHandler</span>.<span>ConnectionOptions</span>.<span>EnclaveAttestationUrl</span>))</td>
      </tr>
      <tr>
        <td id="L3481" data-line-number="3481"></td>
        <td id="LC3481">                    {</td>
      </tr>
      <tr>
        <td id="L3482" data-line-number="3482"></td>
        <td id="LC3482">                        <span>throw</span> <span>SQL</span>.<span>AttestationURLNotSupported</span>();</td>
      </tr>
      <tr>
        <td id="L3483" data-line-number="3483"></td>
        <td id="LC3483">                    }</td>
      </tr>
      <tr>
        <td id="L3484" data-line-number="3484"></td>
        <td id="LC3484">                    <span>else</span> <span>if</span> (<span>SqlConnectionAttestationProtocol</span>.<span>NotSpecified</span> <span>!=</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>AttestationProtocol</span>)</td>
      </tr>
      <tr>
        <td id="L3485" data-line-number="3485"></td>
        <td id="LC3485">                    {</td>
      </tr>
      <tr>
        <td id="L3486" data-line-number="3486"></td>
        <td id="LC3486">                        <span>throw</span> <span>SQL</span>.<span>AttestationProtocolNotSupported</span>();</td>
      </tr>
      <tr>
        <td id="L3487" data-line-number="3487"></td>
        <td id="LC3487">                    }</td>
      </tr>
      <tr>
        <td id="L3488" data-line-number="3488"></td>
        <td id="LC3488">                }</td>
      </tr>
      <tr>
        <td id="L3489" data-line-number="3489"></td>
        <td id="LC3489">                <span><span>//</span> Check if enclave attestation url was specified and server does not return an enclave type and we aren't going to be routed to another server.</span></td>
      </tr>
      <tr>
        <td id="L3490" data-line-number="3490"></td>
        <td id="LC3490">                <span>if</span> (<span>!</span><span>string</span>.<span>IsNullOrWhiteSpace</span>(<span>_connHandler</span>.<span>ConnectionOptions</span>.<span>EnclaveAttestationUrl</span>))</td>
      </tr>
      <tr>
        <td id="L3491" data-line-number="3491"></td>
        <td id="LC3491">                {</td>
      </tr>
      <tr>
        <td id="L3492" data-line-number="3492"></td>
        <td id="LC3492">                    <span>if</span> (<span>string</span>.<span>IsNullOrWhiteSpace</span>(<span>EnclaveType</span>))</td>
      </tr>
      <tr>
        <td id="L3493" data-line-number="3493"></td>
        <td id="LC3493">                    {</td>
      </tr>
      <tr>
        <td id="L3494" data-line-number="3494"></td>
        <td id="LC3494">                        <span>throw</span> <span>SQL</span>.<span>EnclaveTypeNotReturned</span>();</td>
      </tr>
      <tr>
        <td id="L3495" data-line-number="3495"></td>
        <td id="LC3495">                    }</td>
      </tr>
      <tr>
        <td id="L3496" data-line-number="3496"></td>
        <td id="LC3496">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L3497" data-line-number="3497"></td>
        <td id="LC3497">                    {</td>
      </tr>
      <tr>
        <td id="L3498" data-line-number="3498"></td>
        <td id="LC3498">                        <span><span>//</span> Check if the attestation protocol is specified and supports the enclave type.</span></td>
      </tr>
      <tr>
        <td id="L3499" data-line-number="3499"></td>
        <td id="LC3499">                        <span>if</span> (<span>SqlConnectionAttestationProtocol</span>.<span>NotSpecified</span> <span>!=</span> <span>attestationProtocol</span> <span>&amp;&amp;</span> <span>!</span><span>IsValidAttestationProtocol</span>(<span>attestationProtocol</span>, <span>EnclaveType</span>))</td>
      </tr>
      <tr>
        <td id="L3500" data-line-number="3500"></td>
        <td id="LC3500">                        {</td>
      </tr>
      <tr>
        <td id="L3501" data-line-number="3501"></td>
        <td id="LC3501">                            <span>throw</span> <span>SQL</span>.<span>AttestationProtocolNotSupportEnclaveType</span>(<span>ConvertAttestationProtocolToString</span>(<span>attestationProtocol</span>), <span>EnclaveType</span>);</td>
      </tr>
      <tr>
        <td id="L3502" data-line-number="3502"></td>
        <td id="LC3502">                        }</td>
      </tr>
      <tr>
        <td id="L3503" data-line-number="3503"></td>
        <td id="LC3503">                    }</td>
      </tr>
      <tr>
        <td id="L3504" data-line-number="3504"></td>
        <td id="LC3504">                }</td>
      </tr>
      <tr>
        <td id="L3505" data-line-number="3505"></td>
        <td id="LC3505">            }</td>
      </tr>
      <tr>
        <td id="L3506" data-line-number="3506"></td>
        <td id="LC3506">
</td>
      </tr>
      <tr>
        <td id="L3507" data-line-number="3507"></td>
        <td id="LC3507">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3508" data-line-number="3508"></td>
        <td id="LC3508">        }</td>
      </tr>
      <tr>
        <td id="L3509" data-line-number="3509"></td>
        <td id="LC3509">
</td>
      </tr>
      <tr>
        <td id="L3510" data-line-number="3510"></td>
        <td id="LC3510">        <span>private</span> <span>bool</span> <span>IsValidAttestationProtocol</span>(<span>SqlConnectionAttestationProtocol</span> <span>attestationProtocol</span>, <span>string</span> <span>enclaveType</span>)</td>
      </tr>
      <tr>
        <td id="L3511" data-line-number="3511"></td>
        <td id="LC3511">        {</td>
      </tr>
      <tr>
        <td id="L3512" data-line-number="3512"></td>
        <td id="LC3512">            <span>switch</span> (<span>enclaveType</span>.<span>ToUpper</span>())</td>
      </tr>
      <tr>
        <td id="L3513" data-line-number="3513"></td>
        <td id="LC3513">            {</td>
      </tr>
      <tr>
        <td id="L3514" data-line-number="3514"></td>
        <td id="LC3514">                <span>case</span> <span>TdsEnums</span>.<span>ENCLAVE_TYPE_VBS</span>:</td>
      </tr>
      <tr>
        <td id="L3515" data-line-number="3515"></td>
        <td id="LC3515">                    <span>if</span> (<span>attestationProtocol</span> <span>!=</span> <span>SqlConnectionAttestationProtocol</span>.<span>AAS</span></td>
      </tr>
      <tr>
        <td id="L3516" data-line-number="3516"></td>
        <td id="LC3516">#<span>if</span> <span>ENCLAVE_SIMULATOR</span></td>
      </tr>
      <tr>
        <td id="L3517" data-line-number="3517"></td>
        <td id="LC3517">                        <span>&amp;&amp;</span> <span>attestationProtocol</span> <span>!=</span> <span>SqlConnectionAttestationProtocol</span>.<span>SIM</span></td>
      </tr>
      <tr>
        <td id="L3518" data-line-number="3518"></td>
        <td id="LC3518">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L3519" data-line-number="3519"></td>
        <td id="LC3519">                        <span>&amp;&amp;</span> <span>attestationProtocol</span> <span>!=</span> <span>SqlConnectionAttestationProtocol</span>.<span>HGS</span>)</td>
      </tr>
      <tr>
        <td id="L3520" data-line-number="3520"></td>
        <td id="LC3520">                    {</td>
      </tr>
      <tr>
        <td id="L3521" data-line-number="3521"></td>
        <td id="LC3521">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3522" data-line-number="3522"></td>
        <td id="LC3522">                    }</td>
      </tr>
      <tr>
        <td id="L3523" data-line-number="3523"></td>
        <td id="LC3523">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3524" data-line-number="3524"></td>
        <td id="LC3524">
</td>
      </tr>
      <tr>
        <td id="L3525" data-line-number="3525"></td>
        <td id="LC3525">                <span>case</span> <span>TdsEnums</span>.<span>ENCLAVE_TYPE_SGX</span>:</td>
      </tr>
      <tr>
        <td id="L3526" data-line-number="3526"></td>
        <td id="LC3526">#<span>if</span> <span>ENCLAVE_SIMULATOR</span></td>
      </tr>
      <tr>
        <td id="L3527" data-line-number="3527"></td>
        <td id="LC3527">                    <span>if</span> (<span>attestationProtocol</span> <span>!=</span> <span>SqlConnectionAttestationProtocol</span>.<span>AAS</span></td>
      </tr>
      <tr>
        <td id="L3528" data-line-number="3528"></td>
        <td id="LC3528">                        <span>&amp;&amp;</span> <span>attestationProtocol</span> <span>!=</span> <span>SqlConnectionAttestationProtocol</span>.<span>SIM</span>)</td>
      </tr>
      <tr>
        <td id="L3529" data-line-number="3529"></td>
        <td id="LC3529">#<span>else</span></td>
      </tr>
      <tr>
        <td id="L3530" data-line-number="3530"></td>
        <td id="LC3530">                    <span>if</span> (<span>attestationProtocol</span> <span>!=</span> <span>SqlConnectionAttestationProtocol</span>.<span>AAS</span>)</td>
      </tr>
      <tr>
        <td id="L3531" data-line-number="3531"></td>
        <td id="LC3531">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L3532" data-line-number="3532"></td>
        <td id="LC3532">                    {</td>
      </tr>
      <tr>
        <td id="L3533" data-line-number="3533"></td>
        <td id="LC3533">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3534" data-line-number="3534"></td>
        <td id="LC3534">                    }</td>
      </tr>
      <tr>
        <td id="L3535" data-line-number="3535"></td>
        <td id="LC3535">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3536" data-line-number="3536"></td>
        <td id="LC3536">
</td>
      </tr>
      <tr>
        <td id="L3537" data-line-number="3537"></td>
        <td id="LC3537">#<span>if</span> <span>ENCLAVE_SIMULATOR</span></td>
      </tr>
      <tr>
        <td id="L3538" data-line-number="3538"></td>
        <td id="LC3538">                <span>case</span> <span>TdsEnums</span>.<span>ENCLAVE_TYPE_SIMULATOR</span>:</td>
      </tr>
      <tr>
        <td id="L3539" data-line-number="3539"></td>
        <td id="LC3539">                    <span>if</span> (<span>attestationProtocol</span> <span>!=</span> <span>SqlConnectionAttestationProtocol</span>.<span>SIM</span>)</td>
      </tr>
      <tr>
        <td id="L3540" data-line-number="3540"></td>
        <td id="LC3540">                    {</td>
      </tr>
      <tr>
        <td id="L3541" data-line-number="3541"></td>
        <td id="LC3541">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3542" data-line-number="3542"></td>
        <td id="LC3542">                    }</td>
      </tr>
      <tr>
        <td id="L3543" data-line-number="3543"></td>
        <td id="LC3543">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3544" data-line-number="3544"></td>
        <td id="LC3544">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L3545" data-line-number="3545"></td>
        <td id="LC3545">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L3546" data-line-number="3546"></td>
        <td id="LC3546">                    <span><span>//</span> if we reach here, the enclave type is not supported</span></td>
      </tr>
      <tr>
        <td id="L3547" data-line-number="3547"></td>
        <td id="LC3547">                    <span>throw</span> <span>SQL</span>.<span>EnclaveTypeNotSupported</span>(<span>enclaveType</span>);</td>
      </tr>
      <tr>
        <td id="L3548" data-line-number="3548"></td>
        <td id="LC3548">            }</td>
      </tr>
      <tr>
        <td id="L3549" data-line-number="3549"></td>
        <td id="LC3549">
</td>
      </tr>
      <tr>
        <td id="L3550" data-line-number="3550"></td>
        <td id="LC3550">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3551" data-line-number="3551"></td>
        <td id="LC3551">        }</td>
      </tr>
      <tr>
        <td id="L3552" data-line-number="3552"></td>
        <td id="LC3552">
</td>
      </tr>
      <tr>
        <td id="L3553" data-line-number="3553"></td>
        <td id="LC3553">        <span>private</span> <span>string</span> <span>ConvertAttestationProtocolToString</span>(<span>SqlConnectionAttestationProtocol</span> <span>attestationProtocol</span>)</td>
      </tr>
      <tr>
        <td id="L3554" data-line-number="3554"></td>
        <td id="LC3554">        {</td>
      </tr>
      <tr>
        <td id="L3555" data-line-number="3555"></td>
        <td id="LC3555">            <span>switch</span> (<span>attestationProtocol</span>)</td>
      </tr>
      <tr>
        <td id="L3556" data-line-number="3556"></td>
        <td id="LC3556">            {</td>
      </tr>
      <tr>
        <td id="L3557" data-line-number="3557"></td>
        <td id="LC3557">                <span>case</span> <span>SqlConnectionAttestationProtocol</span>.<span>AAS</span>:</td>
      </tr>
      <tr>
        <td id="L3558" data-line-number="3558"></td>
        <td id="LC3558">                    <span>return</span> <span><span>"</span>AAS<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L3559" data-line-number="3559"></td>
        <td id="LC3559">
</td>
      </tr>
      <tr>
        <td id="L3560" data-line-number="3560"></td>
        <td id="LC3560">                <span>case</span> <span>SqlConnectionAttestationProtocol</span>.<span>HGS</span>:</td>
      </tr>
      <tr>
        <td id="L3561" data-line-number="3561"></td>
        <td id="LC3561">                    <span>return</span> <span><span>"</span>HGS<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L3562" data-line-number="3562"></td>
        <td id="LC3562">
</td>
      </tr>
      <tr>
        <td id="L3563" data-line-number="3563"></td>
        <td id="LC3563">#<span>if</span> <span>ENCLAVE_SIMULATOR</span></td>
      </tr>
      <tr>
        <td id="L3564" data-line-number="3564"></td>
        <td id="LC3564">                <span>case</span> <span>SqlConnectionAttestationProtocol</span>.<span>SIM</span>:</td>
      </tr>
      <tr>
        <td id="L3565" data-line-number="3565"></td>
        <td id="LC3565">                    <span>return</span> <span><span>"</span>SIM<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L3566" data-line-number="3566"></td>
        <td id="LC3566">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L3567" data-line-number="3567"></td>
        <td id="LC3567">
</td>
      </tr>
      <tr>
        <td id="L3568" data-line-number="3568"></td>
        <td id="LC3568">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L3569" data-line-number="3569"></td>
        <td id="LC3569">                    <span>return</span> <span><span>"</span>NotSpecified<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L3570" data-line-number="3570"></td>
        <td id="LC3570">            }</td>
      </tr>
      <tr>
        <td id="L3571" data-line-number="3571"></td>
        <td id="LC3571">        }</td>
      </tr>
      <tr>
        <td id="L3572" data-line-number="3572"></td>
        <td id="LC3572">
</td>
      </tr>
      <tr>
        <td id="L3573" data-line-number="3573"></td>
        <td id="LC3573">        <span>private</span> <span>bool</span> <span>TryReadByteString</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>string</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L3574" data-line-number="3574"></td>
        <td id="LC3574">        {</td>
      </tr>
      <tr>
        <td id="L3575" data-line-number="3575"></td>
        <td id="LC3575">            <span>value</span> <span>=</span> <span>string</span>.<span>Empty</span>;</td>
      </tr>
      <tr>
        <td id="L3576" data-line-number="3576"></td>
        <td id="LC3576">
</td>
      </tr>
      <tr>
        <td id="L3577" data-line-number="3577"></td>
        <td id="LC3577">            <span>byte</span> <span>byteLen</span>;</td>
      </tr>
      <tr>
        <td id="L3578" data-line-number="3578"></td>
        <td id="LC3578">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLen</span>))</td>
      </tr>
      <tr>
        <td id="L3579" data-line-number="3579"></td>
        <td id="LC3579">            {</td>
      </tr>
      <tr>
        <td id="L3580" data-line-number="3580"></td>
        <td id="LC3580">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3581" data-line-number="3581"></td>
        <td id="LC3581">            }</td>
      </tr>
      <tr>
        <td id="L3582" data-line-number="3582"></td>
        <td id="LC3582">
</td>
      </tr>
      <tr>
        <td id="L3583" data-line-number="3583"></td>
        <td id="LC3583">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLen</span>, <span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L3584" data-line-number="3584"></td>
        <td id="LC3584">            {</td>
      </tr>
      <tr>
        <td id="L3585" data-line-number="3585"></td>
        <td id="LC3585">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3586" data-line-number="3586"></td>
        <td id="LC3586">            }</td>
      </tr>
      <tr>
        <td id="L3587" data-line-number="3587"></td>
        <td id="LC3587">
</td>
      </tr>
      <tr>
        <td id="L3588" data-line-number="3588"></td>
        <td id="LC3588">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3589" data-line-number="3589"></td>
        <td id="LC3589">        }</td>
      </tr>
      <tr>
        <td id="L3590" data-line-number="3590"></td>
        <td id="LC3590">
</td>
      </tr>
      <tr>
        <td id="L3591" data-line-number="3591"></td>
        <td id="LC3591">        <span>private</span> <span>bool</span> <span>TryReadSensitivityLabel</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>string</span> <span>label</span>, <span>out</span> <span>string</span> <span>id</span>)</td>
      </tr>
      <tr>
        <td id="L3592" data-line-number="3592"></td>
        <td id="LC3592">        {</td>
      </tr>
      <tr>
        <td id="L3593" data-line-number="3593"></td>
        <td id="LC3593">            <span>label</span> <span>=</span> <span>string</span>.<span>Empty</span>;</td>
      </tr>
      <tr>
        <td id="L3594" data-line-number="3594"></td>
        <td id="LC3594">            <span>id</span> <span>=</span> <span>string</span>.<span>Empty</span>;</td>
      </tr>
      <tr>
        <td id="L3595" data-line-number="3595"></td>
        <td id="LC3595">
</td>
      </tr>
      <tr>
        <td id="L3596" data-line-number="3596"></td>
        <td id="LC3596">            <span>if</span> (<span>!</span><span>TryReadByteString</span>(<span>stateObj</span>, <span>out</span> <span>label</span>))</td>
      </tr>
      <tr>
        <td id="L3597" data-line-number="3597"></td>
        <td id="LC3597">            {</td>
      </tr>
      <tr>
        <td id="L3598" data-line-number="3598"></td>
        <td id="LC3598">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3599" data-line-number="3599"></td>
        <td id="LC3599">            }</td>
      </tr>
      <tr>
        <td id="L3600" data-line-number="3600"></td>
        <td id="LC3600">
</td>
      </tr>
      <tr>
        <td id="L3601" data-line-number="3601"></td>
        <td id="LC3601">            <span>if</span> (<span>!</span><span>TryReadByteString</span>(<span>stateObj</span>, <span>out</span> <span>id</span>))</td>
      </tr>
      <tr>
        <td id="L3602" data-line-number="3602"></td>
        <td id="LC3602">            {</td>
      </tr>
      <tr>
        <td id="L3603" data-line-number="3603"></td>
        <td id="LC3603">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3604" data-line-number="3604"></td>
        <td id="LC3604">            }</td>
      </tr>
      <tr>
        <td id="L3605" data-line-number="3605"></td>
        <td id="LC3605">
</td>
      </tr>
      <tr>
        <td id="L3606" data-line-number="3606"></td>
        <td id="LC3606">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3607" data-line-number="3607"></td>
        <td id="LC3607">        }</td>
      </tr>
      <tr>
        <td id="L3608" data-line-number="3608"></td>
        <td id="LC3608">
</td>
      </tr>
      <tr>
        <td id="L3609" data-line-number="3609"></td>
        <td id="LC3609">        <span>private</span> <span>bool</span> <span>TryReadSensitivityInformationType</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>string</span> <span>informationType</span>, <span>out</span> <span>string</span> <span>id</span>)</td>
      </tr>
      <tr>
        <td id="L3610" data-line-number="3610"></td>
        <td id="LC3610">        {</td>
      </tr>
      <tr>
        <td id="L3611" data-line-number="3611"></td>
        <td id="LC3611">            <span>informationType</span> <span>=</span> <span>string</span>.<span>Empty</span>;</td>
      </tr>
      <tr>
        <td id="L3612" data-line-number="3612"></td>
        <td id="LC3612">            <span>id</span> <span>=</span> <span>string</span>.<span>Empty</span>;</td>
      </tr>
      <tr>
        <td id="L3613" data-line-number="3613"></td>
        <td id="LC3613">
</td>
      </tr>
      <tr>
        <td id="L3614" data-line-number="3614"></td>
        <td id="LC3614">            <span>if</span> (<span>!</span><span>TryReadByteString</span>(<span>stateObj</span>, <span>out</span> <span>informationType</span>))</td>
      </tr>
      <tr>
        <td id="L3615" data-line-number="3615"></td>
        <td id="LC3615">            {</td>
      </tr>
      <tr>
        <td id="L3616" data-line-number="3616"></td>
        <td id="LC3616">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3617" data-line-number="3617"></td>
        <td id="LC3617">            }</td>
      </tr>
      <tr>
        <td id="L3618" data-line-number="3618"></td>
        <td id="LC3618">
</td>
      </tr>
      <tr>
        <td id="L3619" data-line-number="3619"></td>
        <td id="LC3619">            <span>if</span> (<span>!</span><span>TryReadByteString</span>(<span>stateObj</span>, <span>out</span> <span>id</span>))</td>
      </tr>
      <tr>
        <td id="L3620" data-line-number="3620"></td>
        <td id="LC3620">            {</td>
      </tr>
      <tr>
        <td id="L3621" data-line-number="3621"></td>
        <td id="LC3621">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3622" data-line-number="3622"></td>
        <td id="LC3622">            }</td>
      </tr>
      <tr>
        <td id="L3623" data-line-number="3623"></td>
        <td id="LC3623">
</td>
      </tr>
      <tr>
        <td id="L3624" data-line-number="3624"></td>
        <td id="LC3624">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3625" data-line-number="3625"></td>
        <td id="LC3625">        }</td>
      </tr>
      <tr>
        <td id="L3626" data-line-number="3626"></td>
        <td id="LC3626">
</td>
      </tr>
      <tr>
        <td id="L3627" data-line-number="3627"></td>
        <td id="LC3627">        <span>private</span> <span>bool</span> <span>TryProcessDataClassification</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>SensitivityClassification</span> <span>sensitivityClassification</span>)</td>
      </tr>
      <tr>
        <td id="L3628" data-line-number="3628"></td>
        <td id="LC3628">        {</td>
      </tr>
      <tr>
        <td id="L3629" data-line-number="3629"></td>
        <td id="LC3629">            <span>if</span> (<span>this</span>.<span>DataClassificationVersion</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L3630" data-line-number="3630"></td>
        <td id="LC3630">            {</td>
      </tr>
      <tr>
        <td id="L3631" data-line-number="3631"></td>
        <td id="LC3631">                <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>DataClassificationNotExpected</span>);</td>
      </tr>
      <tr>
        <td id="L3632" data-line-number="3632"></td>
        <td id="LC3632">            }</td>
      </tr>
      <tr>
        <td id="L3633" data-line-number="3633"></td>
        <td id="LC3633">
</td>
      </tr>
      <tr>
        <td id="L3634" data-line-number="3634"></td>
        <td id="LC3634">            <span>sensitivityClassification</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L3635" data-line-number="3635"></td>
        <td id="LC3635">
</td>
      </tr>
      <tr>
        <td id="L3636" data-line-number="3636"></td>
        <td id="LC3636">            <span><span>//</span> get the labels</span></td>
      </tr>
      <tr>
        <td id="L3637" data-line-number="3637"></td>
        <td id="LC3637">            <span>UInt16</span> <span>numLabels</span>;</td>
      </tr>
      <tr>
        <td id="L3638" data-line-number="3638"></td>
        <td id="LC3638">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>numLabels</span>))</td>
      </tr>
      <tr>
        <td id="L3639" data-line-number="3639"></td>
        <td id="LC3639">            {</td>
      </tr>
      <tr>
        <td id="L3640" data-line-number="3640"></td>
        <td id="LC3640">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3641" data-line-number="3641"></td>
        <td id="LC3641">            }</td>
      </tr>
      <tr>
        <td id="L3642" data-line-number="3642"></td>
        <td id="LC3642">            <span>var</span> <span>labels</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>Label</span>&gt;(<span>numLabels</span>);</td>
      </tr>
      <tr>
        <td id="L3643" data-line-number="3643"></td>
        <td id="LC3643">            <span>for</span> (<span>UInt16</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>numLabels</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L3644" data-line-number="3644"></td>
        <td id="LC3644">            {</td>
      </tr>
      <tr>
        <td id="L3645" data-line-number="3645"></td>
        <td id="LC3645">                <span>string</span> <span>label</span>;</td>
      </tr>
      <tr>
        <td id="L3646" data-line-number="3646"></td>
        <td id="LC3646">                <span>string</span> <span>id</span>;</td>
      </tr>
      <tr>
        <td id="L3647" data-line-number="3647"></td>
        <td id="LC3647">                <span>if</span> (<span>!</span><span>TryReadSensitivityLabel</span>(<span>stateObj</span>, <span>out</span> <span>label</span>, <span>out</span> <span>id</span>))</td>
      </tr>
      <tr>
        <td id="L3648" data-line-number="3648"></td>
        <td id="LC3648">                {</td>
      </tr>
      <tr>
        <td id="L3649" data-line-number="3649"></td>
        <td id="LC3649">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3650" data-line-number="3650"></td>
        <td id="LC3650">                }</td>
      </tr>
      <tr>
        <td id="L3651" data-line-number="3651"></td>
        <td id="LC3651">                <span>labels</span>.<span>Add</span>(<span>new</span> <span>Label</span>(<span>label</span>, <span>id</span>));</td>
      </tr>
      <tr>
        <td id="L3652" data-line-number="3652"></td>
        <td id="LC3652">            }</td>
      </tr>
      <tr>
        <td id="L3653" data-line-number="3653"></td>
        <td id="LC3653">
</td>
      </tr>
      <tr>
        <td id="L3654" data-line-number="3654"></td>
        <td id="LC3654">            <span><span>//</span> get the information types</span></td>
      </tr>
      <tr>
        <td id="L3655" data-line-number="3655"></td>
        <td id="LC3655">            <span>UInt16</span> <span>numInformationTypes</span>;</td>
      </tr>
      <tr>
        <td id="L3656" data-line-number="3656"></td>
        <td id="LC3656">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>numInformationTypes</span>))</td>
      </tr>
      <tr>
        <td id="L3657" data-line-number="3657"></td>
        <td id="LC3657">            {</td>
      </tr>
      <tr>
        <td id="L3658" data-line-number="3658"></td>
        <td id="LC3658">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3659" data-line-number="3659"></td>
        <td id="LC3659">            }</td>
      </tr>
      <tr>
        <td id="L3660" data-line-number="3660"></td>
        <td id="LC3660">            <span>var</span> <span>informationTypes</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>InformationType</span>&gt;(<span>numInformationTypes</span>);</td>
      </tr>
      <tr>
        <td id="L3661" data-line-number="3661"></td>
        <td id="LC3661">            <span>for</span> (<span>UInt16</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>numInformationTypes</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L3662" data-line-number="3662"></td>
        <td id="LC3662">            {</td>
      </tr>
      <tr>
        <td id="L3663" data-line-number="3663"></td>
        <td id="LC3663">                <span>string</span> <span>informationType</span>;</td>
      </tr>
      <tr>
        <td id="L3664" data-line-number="3664"></td>
        <td id="LC3664">                <span>string</span> <span>id</span>;</td>
      </tr>
      <tr>
        <td id="L3665" data-line-number="3665"></td>
        <td id="LC3665">                <span>if</span> (<span>!</span><span>TryReadSensitivityInformationType</span>(<span>stateObj</span>, <span>out</span> <span>informationType</span>, <span>out</span> <span>id</span>))</td>
      </tr>
      <tr>
        <td id="L3666" data-line-number="3666"></td>
        <td id="LC3666">                {</td>
      </tr>
      <tr>
        <td id="L3667" data-line-number="3667"></td>
        <td id="LC3667">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3668" data-line-number="3668"></td>
        <td id="LC3668">                }</td>
      </tr>
      <tr>
        <td id="L3669" data-line-number="3669"></td>
        <td id="LC3669">                <span>informationTypes</span>.<span>Add</span>(<span>new</span> <span>InformationType</span>(<span>informationType</span>, <span>id</span>));</td>
      </tr>
      <tr>
        <td id="L3670" data-line-number="3670"></td>
        <td id="LC3670">            }</td>
      </tr>
      <tr>
        <td id="L3671" data-line-number="3671"></td>
        <td id="LC3671">
</td>
      </tr>
      <tr>
        <td id="L3672" data-line-number="3672"></td>
        <td id="LC3672">            <span><span>//</span> get the per column classification data (corresponds to order of output columns for query)</span></td>
      </tr>
      <tr>
        <td id="L3673" data-line-number="3673"></td>
        <td id="LC3673">            <span>UInt16</span> <span>numResultColumns</span>;</td>
      </tr>
      <tr>
        <td id="L3674" data-line-number="3674"></td>
        <td id="LC3674">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>numResultColumns</span>))</td>
      </tr>
      <tr>
        <td id="L3675" data-line-number="3675"></td>
        <td id="LC3675">            {</td>
      </tr>
      <tr>
        <td id="L3676" data-line-number="3676"></td>
        <td id="LC3676">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3677" data-line-number="3677"></td>
        <td id="LC3677">            }</td>
      </tr>
      <tr>
        <td id="L3678" data-line-number="3678"></td>
        <td id="LC3678">            <span>var</span> <span>columnSensitivities</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>ColumnSensitivity</span>&gt;(<span>numResultColumns</span>);</td>
      </tr>
      <tr>
        <td id="L3679" data-line-number="3679"></td>
        <td id="LC3679">            <span>for</span> (<span>UInt16</span> <span>columnNum</span> <span>=</span> <span>0</span>; <span>columnNum</span> <span>&lt;</span> <span>numResultColumns</span>; <span>columnNum</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L3680" data-line-number="3680"></td>
        <td id="LC3680">            {</td>
      </tr>
      <tr>
        <td id="L3681" data-line-number="3681"></td>
        <td id="LC3681">                <span><span>//</span> get sensitivity properties for all the different sources which were used in generating the column output</span></td>
      </tr>
      <tr>
        <td id="L3682" data-line-number="3682"></td>
        <td id="LC3682">                <span>UInt16</span> <span>numSources</span>;</td>
      </tr>
      <tr>
        <td id="L3683" data-line-number="3683"></td>
        <td id="LC3683">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>numSources</span>))</td>
      </tr>
      <tr>
        <td id="L3684" data-line-number="3684"></td>
        <td id="LC3684">                {</td>
      </tr>
      <tr>
        <td id="L3685" data-line-number="3685"></td>
        <td id="LC3685">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3686" data-line-number="3686"></td>
        <td id="LC3686">                }</td>
      </tr>
      <tr>
        <td id="L3687" data-line-number="3687"></td>
        <td id="LC3687">                <span>var</span> <span>sensitivityProperties</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>SensitivityProperty</span>&gt;(<span>numSources</span>);</td>
      </tr>
      <tr>
        <td id="L3688" data-line-number="3688"></td>
        <td id="LC3688">                <span>for</span> (<span>UInt16</span> <span>sourceNum</span> <span>=</span> <span>0</span>; <span>sourceNum</span> <span>&lt;</span> <span>numSources</span>; <span>sourceNum</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L3689" data-line-number="3689"></td>
        <td id="LC3689">                {</td>
      </tr>
      <tr>
        <td id="L3690" data-line-number="3690"></td>
        <td id="LC3690">                    <span><span>//</span> get the label index and then lookup label to use for source</span></td>
      </tr>
      <tr>
        <td id="L3691" data-line-number="3691"></td>
        <td id="LC3691">                    <span>UInt16</span> <span>labelIndex</span>;</td>
      </tr>
      <tr>
        <td id="L3692" data-line-number="3692"></td>
        <td id="LC3692">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>labelIndex</span>))</td>
      </tr>
      <tr>
        <td id="L3693" data-line-number="3693"></td>
        <td id="LC3693">                    {</td>
      </tr>
      <tr>
        <td id="L3694" data-line-number="3694"></td>
        <td id="LC3694">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3695" data-line-number="3695"></td>
        <td id="LC3695">                    }</td>
      </tr>
      <tr>
        <td id="L3696" data-line-number="3696"></td>
        <td id="LC3696">                    <span>Label</span> <span>label</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L3697" data-line-number="3697"></td>
        <td id="LC3697">                    <span>if</span> (<span>labelIndex</span> <span>!=</span> <span>UInt16</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L3698" data-line-number="3698"></td>
        <td id="LC3698">                    {</td>
      </tr>
      <tr>
        <td id="L3699" data-line-number="3699"></td>
        <td id="LC3699">                        <span>if</span> (<span>labelIndex</span> <span>&gt;=</span> <span>labels</span>.<span>Count</span>)</td>
      </tr>
      <tr>
        <td id="L3700" data-line-number="3700"></td>
        <td id="LC3700">                        {</td>
      </tr>
      <tr>
        <td id="L3701" data-line-number="3701"></td>
        <td id="LC3701">                            <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>DataClassificationInvalidLabelIndex</span>);</td>
      </tr>
      <tr>
        <td id="L3702" data-line-number="3702"></td>
        <td id="LC3702">                        }</td>
      </tr>
      <tr>
        <td id="L3703" data-line-number="3703"></td>
        <td id="LC3703">                        <span>label</span> <span>=</span> <span>labels</span>[<span>labelIndex</span>];</td>
      </tr>
      <tr>
        <td id="L3704" data-line-number="3704"></td>
        <td id="LC3704">                    }</td>
      </tr>
      <tr>
        <td id="L3705" data-line-number="3705"></td>
        <td id="LC3705">
</td>
      </tr>
      <tr>
        <td id="L3706" data-line-number="3706"></td>
        <td id="LC3706">                    <span><span>//</span> get the information type index and then lookup information type to use for source</span></td>
      </tr>
      <tr>
        <td id="L3707" data-line-number="3707"></td>
        <td id="LC3707">                    <span>UInt16</span> <span>informationTypeIndex</span>;</td>
      </tr>
      <tr>
        <td id="L3708" data-line-number="3708"></td>
        <td id="LC3708">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>informationTypeIndex</span>))</td>
      </tr>
      <tr>
        <td id="L3709" data-line-number="3709"></td>
        <td id="LC3709">                    {</td>
      </tr>
      <tr>
        <td id="L3710" data-line-number="3710"></td>
        <td id="LC3710">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3711" data-line-number="3711"></td>
        <td id="LC3711">                    }</td>
      </tr>
      <tr>
        <td id="L3712" data-line-number="3712"></td>
        <td id="LC3712">                    <span>InformationType</span> <span>informationType</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L3713" data-line-number="3713"></td>
        <td id="LC3713">                    <span>if</span> (<span>informationTypeIndex</span> <span>!=</span> <span>UInt16</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L3714" data-line-number="3714"></td>
        <td id="LC3714">                    {</td>
      </tr>
      <tr>
        <td id="L3715" data-line-number="3715"></td>
        <td id="LC3715">                        <span>if</span> (<span>informationTypeIndex</span> <span>&gt;=</span> <span>informationTypes</span>.<span>Count</span>)</td>
      </tr>
      <tr>
        <td id="L3716" data-line-number="3716"></td>
        <td id="LC3716">                        {</td>
      </tr>
      <tr>
        <td id="L3717" data-line-number="3717"></td>
        <td id="LC3717">                            <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>DataClassificationInvalidInformationTypeIndex</span>);</td>
      </tr>
      <tr>
        <td id="L3718" data-line-number="3718"></td>
        <td id="LC3718">                        }</td>
      </tr>
      <tr>
        <td id="L3719" data-line-number="3719"></td>
        <td id="LC3719">                        <span>informationType</span> <span>=</span> <span>informationTypes</span>[<span>informationTypeIndex</span>];</td>
      </tr>
      <tr>
        <td id="L3720" data-line-number="3720"></td>
        <td id="LC3720">                    }</td>
      </tr>
      <tr>
        <td id="L3721" data-line-number="3721"></td>
        <td id="LC3721">
</td>
      </tr>
      <tr>
        <td id="L3722" data-line-number="3722"></td>
        <td id="LC3722">                    <span><span>//</span> add sentivity properties for the source</span></td>
      </tr>
      <tr>
        <td id="L3723" data-line-number="3723"></td>
        <td id="LC3723">                    <span>sensitivityProperties</span>.<span>Add</span>(<span>new</span> <span>SensitivityProperty</span>(<span>label</span>, <span>informationType</span>));</td>
      </tr>
      <tr>
        <td id="L3724" data-line-number="3724"></td>
        <td id="LC3724">                }</td>
      </tr>
      <tr>
        <td id="L3725" data-line-number="3725"></td>
        <td id="LC3725">                <span>columnSensitivities</span>.<span>Add</span>(<span>new</span> <span>ColumnSensitivity</span>(<span>sensitivityProperties</span>));</td>
      </tr>
      <tr>
        <td id="L3726" data-line-number="3726"></td>
        <td id="LC3726">            }</td>
      </tr>
      <tr>
        <td id="L3727" data-line-number="3727"></td>
        <td id="LC3727">
</td>
      </tr>
      <tr>
        <td id="L3728" data-line-number="3728"></td>
        <td id="LC3728">            <span>sensitivityClassification</span> <span>=</span> <span>new</span> <span>SensitivityClassification</span>(<span>labels</span>, <span>informationTypes</span>, <span>columnSensitivities</span>);</td>
      </tr>
      <tr>
        <td id="L3729" data-line-number="3729"></td>
        <td id="LC3729">
</td>
      </tr>
      <tr>
        <td id="L3730" data-line-number="3730"></td>
        <td id="LC3730">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3731" data-line-number="3731"></td>
        <td id="LC3731">        }</td>
      </tr>
      <tr>
        <td id="L3732" data-line-number="3732"></td>
        <td id="LC3732">
</td>
      </tr>
      <tr>
        <td id="L3733" data-line-number="3733"></td>
        <td id="LC3733">        <span>private</span> <span>bool</span> <span>TryProcessResColSrcs</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>tokenLength</span>)</td>
      </tr>
      <tr>
        <td id="L3734" data-line-number="3734"></td>
        <td id="LC3734">        {</td>
      </tr>
      <tr>
        <td id="L3735" data-line-number="3735"></td>
        <td id="LC3735">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>tokenLength</span>))</td>
      </tr>
      <tr>
        <td id="L3736" data-line-number="3736"></td>
        <td id="LC3736">            {</td>
      </tr>
      <tr>
        <td id="L3737" data-line-number="3737"></td>
        <td id="LC3737">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3738" data-line-number="3738"></td>
        <td id="LC3738">            }</td>
      </tr>
      <tr>
        <td id="L3739" data-line-number="3739"></td>
        <td id="LC3739">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3740" data-line-number="3740"></td>
        <td id="LC3740">        }</td>
      </tr>
      <tr>
        <td id="L3741" data-line-number="3741"></td>
        <td id="LC3741">
</td>
      </tr>
      <tr>
        <td id="L3742" data-line-number="3742"></td>
        <td id="LC3742">        <span>private</span> <span>bool</span> <span>TryProcessSessionState</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>length</span>, <span>SessionData</span> <span>sdata</span>)</td>
      </tr>
      <tr>
        <td id="L3743" data-line-number="3743"></td>
        <td id="LC3743">        {</td>
      </tr>
      <tr>
        <td id="L3744" data-line-number="3744"></td>
        <td id="LC3744">            <span>if</span> (<span>length</span> <span>&lt;</span> <span>5</span>)</td>
      </tr>
      <tr>
        <td id="L3745" data-line-number="3745"></td>
        <td id="LC3745">            {</td>
      </tr>
      <tr>
        <td id="L3746" data-line-number="3746"></td>
        <td id="LC3746">                <span>throw</span> <span>SQL</span>.<span>ParsingErrorLength</span>(<span>ParsingErrorState</span>.<span>SessionStateLengthTooShort</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L3747" data-line-number="3747"></td>
        <td id="LC3747">            }</td>
      </tr>
      <tr>
        <td id="L3748" data-line-number="3748"></td>
        <td id="LC3748">            <span>UInt32</span> <span>seqNum</span>;</td>
      </tr>
      <tr>
        <td id="L3749" data-line-number="3749"></td>
        <td id="LC3749">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>seqNum</span>))</td>
      </tr>
      <tr>
        <td id="L3750" data-line-number="3750"></td>
        <td id="LC3750">            {</td>
      </tr>
      <tr>
        <td id="L3751" data-line-number="3751"></td>
        <td id="LC3751">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3752" data-line-number="3752"></td>
        <td id="LC3752">            }</td>
      </tr>
      <tr>
        <td id="L3753" data-line-number="3753"></td>
        <td id="LC3753">            <span>if</span> (<span>seqNum</span> <span>==</span> <span>UInt32</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L3754" data-line-number="3754"></td>
        <td id="LC3754">            {</td>
      </tr>
      <tr>
        <td id="L3755" data-line-number="3755"></td>
        <td id="LC3755">                <span>_connHandler</span>.<span>DoNotPoolThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L3756" data-line-number="3756"></td>
        <td id="LC3756">            }</td>
      </tr>
      <tr>
        <td id="L3757" data-line-number="3757"></td>
        <td id="LC3757">            <span>byte</span> <span>status</span>;</td>
      </tr>
      <tr>
        <td id="L3758" data-line-number="3758"></td>
        <td id="LC3758">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>status</span>))</td>
      </tr>
      <tr>
        <td id="L3759" data-line-number="3759"></td>
        <td id="LC3759">            {</td>
      </tr>
      <tr>
        <td id="L3760" data-line-number="3760"></td>
        <td id="LC3760">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3761" data-line-number="3761"></td>
        <td id="LC3761">            }</td>
      </tr>
      <tr>
        <td id="L3762" data-line-number="3762"></td>
        <td id="LC3762">            <span>if</span> (<span>status</span> <span>&gt;</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L3763" data-line-number="3763"></td>
        <td id="LC3763">            {</td>
      </tr>
      <tr>
        <td id="L3764" data-line-number="3764"></td>
        <td id="LC3764">                <span>throw</span> <span>SQL</span>.<span>ParsingErrorStatus</span>(<span>ParsingErrorState</span>.<span>SessionStateInvalidStatus</span>, <span>status</span>);</td>
      </tr>
      <tr>
        <td id="L3765" data-line-number="3765"></td>
        <td id="LC3765">            }</td>
      </tr>
      <tr>
        <td id="L3766" data-line-number="3766"></td>
        <td id="LC3766">            <span>bool</span> <span>recoverable</span> <span>=</span> <span>status</span> <span>!=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L3767" data-line-number="3767"></td>
        <td id="LC3767">            <span>length</span> <span>-=</span> <span>5</span>;</td>
      </tr>
      <tr>
        <td id="L3768" data-line-number="3768"></td>
        <td id="LC3768">            <span>while</span> (<span>length</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L3769" data-line-number="3769"></td>
        <td id="LC3769">            {</td>
      </tr>
      <tr>
        <td id="L3770" data-line-number="3770"></td>
        <td id="LC3770">                <span>byte</span> <span>stateId</span>;</td>
      </tr>
      <tr>
        <td id="L3771" data-line-number="3771"></td>
        <td id="LC3771">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>stateId</span>))</td>
      </tr>
      <tr>
        <td id="L3772" data-line-number="3772"></td>
        <td id="LC3772">                {</td>
      </tr>
      <tr>
        <td id="L3773" data-line-number="3773"></td>
        <td id="LC3773">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3774" data-line-number="3774"></td>
        <td id="LC3774">                }</td>
      </tr>
      <tr>
        <td id="L3775" data-line-number="3775"></td>
        <td id="LC3775">                <span>int</span> <span>stateLen</span>;</td>
      </tr>
      <tr>
        <td id="L3776" data-line-number="3776"></td>
        <td id="LC3776">                <span>byte</span> <span>stateLenByte</span>;</td>
      </tr>
      <tr>
        <td id="L3777" data-line-number="3777"></td>
        <td id="LC3777">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>stateLenByte</span>))</td>
      </tr>
      <tr>
        <td id="L3778" data-line-number="3778"></td>
        <td id="LC3778">                {</td>
      </tr>
      <tr>
        <td id="L3779" data-line-number="3779"></td>
        <td id="LC3779">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3780" data-line-number="3780"></td>
        <td id="LC3780">                }</td>
      </tr>
      <tr>
        <td id="L3781" data-line-number="3781"></td>
        <td id="LC3781">                <span>if</span> (<span>stateLenByte</span> <span>&lt;</span> <span>0xFF</span>)</td>
      </tr>
      <tr>
        <td id="L3782" data-line-number="3782"></td>
        <td id="LC3782">                {</td>
      </tr>
      <tr>
        <td id="L3783" data-line-number="3783"></td>
        <td id="LC3783">                    <span>stateLen</span> <span>=</span> <span>stateLenByte</span>;</td>
      </tr>
      <tr>
        <td id="L3784" data-line-number="3784"></td>
        <td id="LC3784">                }</td>
      </tr>
      <tr>
        <td id="L3785" data-line-number="3785"></td>
        <td id="LC3785">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L3786" data-line-number="3786"></td>
        <td id="LC3786">                {</td>
      </tr>
      <tr>
        <td id="L3787" data-line-number="3787"></td>
        <td id="LC3787">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>stateLen</span>))</td>
      </tr>
      <tr>
        <td id="L3788" data-line-number="3788"></td>
        <td id="LC3788">                    {</td>
      </tr>
      <tr>
        <td id="L3789" data-line-number="3789"></td>
        <td id="LC3789">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3790" data-line-number="3790"></td>
        <td id="LC3790">                    }</td>
      </tr>
      <tr>
        <td id="L3791" data-line-number="3791"></td>
        <td id="LC3791">                }</td>
      </tr>
      <tr>
        <td id="L3792" data-line-number="3792"></td>
        <td id="LC3792">                <span>byte</span>[] <span>buffer</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L3793" data-line-number="3793"></td>
        <td id="LC3793">                <span>lock</span> (<span>sdata</span>.<span>_delta</span>)</td>
      </tr>
      <tr>
        <td id="L3794" data-line-number="3794"></td>
        <td id="LC3794">                {</td>
      </tr>
      <tr>
        <td id="L3795" data-line-number="3795"></td>
        <td id="LC3795">                    <span>if</span> (<span>sdata</span>.<span>_delta</span>[<span>stateId</span>] <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L3796" data-line-number="3796"></td>
        <td id="LC3796">                    {</td>
      </tr>
      <tr>
        <td id="L3797" data-line-number="3797"></td>
        <td id="LC3797">                        <span>buffer</span> <span>=</span> <span>new</span> <span>byte</span>[<span>stateLen</span>];</td>
      </tr>
      <tr>
        <td id="L3798" data-line-number="3798"></td>
        <td id="LC3798">                        <span>sdata</span>.<span>_delta</span>[<span>stateId</span>] <span>=</span> <span>new</span> <span>SessionStateRecord</span> { <span>_version</span> <span>=</span> <span>seqNum</span>, <span>_dataLength</span> <span>=</span> <span>stateLen</span>, <span>_data</span> <span>=</span> <span>buffer</span>, <span>_recoverable</span> <span>=</span> <span>recoverable</span> };</td>
      </tr>
      <tr>
        <td id="L3799" data-line-number="3799"></td>
        <td id="LC3799">                        <span>sdata</span>.<span>_deltaDirty</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3800" data-line-number="3800"></td>
        <td id="LC3800">                        <span>if</span> (<span>!</span><span>recoverable</span>)</td>
      </tr>
      <tr>
        <td id="L3801" data-line-number="3801"></td>
        <td id="LC3801">                        {</td>
      </tr>
      <tr>
        <td id="L3802" data-line-number="3802"></td>
        <td id="LC3802">                            <span>checked</span></td>
      </tr>
      <tr>
        <td id="L3803" data-line-number="3803"></td>
        <td id="LC3803">                            { <span>sdata</span>.<span>_unrecoverableStatesCount</span><span>++</span>; }</td>
      </tr>
      <tr>
        <td id="L3804" data-line-number="3804"></td>
        <td id="LC3804">                        }</td>
      </tr>
      <tr>
        <td id="L3805" data-line-number="3805"></td>
        <td id="LC3805">                    }</td>
      </tr>
      <tr>
        <td id="L3806" data-line-number="3806"></td>
        <td id="LC3806">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L3807" data-line-number="3807"></td>
        <td id="LC3807">                    {</td>
      </tr>
      <tr>
        <td id="L3808" data-line-number="3808"></td>
        <td id="LC3808">                        <span>if</span> (<span>sdata</span>.<span>_delta</span>[<span>stateId</span>].<span>_version</span> <span>&lt;=</span> <span>seqNum</span>)</td>
      </tr>
      <tr>
        <td id="L3809" data-line-number="3809"></td>
        <td id="LC3809">                        {</td>
      </tr>
      <tr>
        <td id="L3810" data-line-number="3810"></td>
        <td id="LC3810">                            <span>SessionStateRecord</span> <span>sv</span> <span>=</span> <span>sdata</span>.<span>_delta</span>[<span>stateId</span>];</td>
      </tr>
      <tr>
        <td id="L3811" data-line-number="3811"></td>
        <td id="LC3811">                            <span>sv</span>.<span>_version</span> <span>=</span> <span>seqNum</span>;</td>
      </tr>
      <tr>
        <td id="L3812" data-line-number="3812"></td>
        <td id="LC3812">                            <span>sv</span>.<span>_dataLength</span> <span>=</span> <span>stateLen</span>;</td>
      </tr>
      <tr>
        <td id="L3813" data-line-number="3813"></td>
        <td id="LC3813">                            <span>if</span> (<span>sv</span>.<span>_recoverable</span> <span>!=</span> <span>recoverable</span>)</td>
      </tr>
      <tr>
        <td id="L3814" data-line-number="3814"></td>
        <td id="LC3814">                            {</td>
      </tr>
      <tr>
        <td id="L3815" data-line-number="3815"></td>
        <td id="LC3815">                                <span>if</span> (<span>recoverable</span>)</td>
      </tr>
      <tr>
        <td id="L3816" data-line-number="3816"></td>
        <td id="LC3816">                                {</td>
      </tr>
      <tr>
        <td id="L3817" data-line-number="3817"></td>
        <td id="LC3817">                                    <span>Debug</span>.<span>Assert</span>(<span>sdata</span>.<span>_unrecoverableStatesCount</span> <span>&gt;</span> <span>0</span>, <span><span>"</span>Unrecoverable states count &gt;0<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3818" data-line-number="3818"></td>
        <td id="LC3818">                                    <span>sdata</span>.<span>_unrecoverableStatesCount</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L3819" data-line-number="3819"></td>
        <td id="LC3819">                                }</td>
      </tr>
      <tr>
        <td id="L3820" data-line-number="3820"></td>
        <td id="LC3820">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L3821" data-line-number="3821"></td>
        <td id="LC3821">                                {</td>
      </tr>
      <tr>
        <td id="L3822" data-line-number="3822"></td>
        <td id="LC3822">                                    <span>checked</span></td>
      </tr>
      <tr>
        <td id="L3823" data-line-number="3823"></td>
        <td id="LC3823">                                    { <span>sdata</span>.<span>_unrecoverableStatesCount</span><span>++</span>; }</td>
      </tr>
      <tr>
        <td id="L3824" data-line-number="3824"></td>
        <td id="LC3824">                                }</td>
      </tr>
      <tr>
        <td id="L3825" data-line-number="3825"></td>
        <td id="LC3825">                                <span>sv</span>.<span>_recoverable</span> <span>=</span> <span>recoverable</span>;</td>
      </tr>
      <tr>
        <td id="L3826" data-line-number="3826"></td>
        <td id="LC3826">                            }</td>
      </tr>
      <tr>
        <td id="L3827" data-line-number="3827"></td>
        <td id="LC3827">                            <span>buffer</span> <span>=</span> <span>sv</span>.<span>_data</span>;</td>
      </tr>
      <tr>
        <td id="L3828" data-line-number="3828"></td>
        <td id="LC3828">                            <span>if</span> (<span>buffer</span>.<span>Length</span> <span>&lt;</span> <span>stateLen</span>)</td>
      </tr>
      <tr>
        <td id="L3829" data-line-number="3829"></td>
        <td id="LC3829">                            {</td>
      </tr>
      <tr>
        <td id="L3830" data-line-number="3830"></td>
        <td id="LC3830">                                <span>buffer</span> <span>=</span> <span>new</span> <span>byte</span>[<span>stateLen</span>];</td>
      </tr>
      <tr>
        <td id="L3831" data-line-number="3831"></td>
        <td id="LC3831">                                <span>sv</span>.<span>_data</span> <span>=</span> <span>buffer</span>;</td>
      </tr>
      <tr>
        <td id="L3832" data-line-number="3832"></td>
        <td id="LC3832">                            }</td>
      </tr>
      <tr>
        <td id="L3833" data-line-number="3833"></td>
        <td id="LC3833">                        }</td>
      </tr>
      <tr>
        <td id="L3834" data-line-number="3834"></td>
        <td id="LC3834">                    }</td>
      </tr>
      <tr>
        <td id="L3835" data-line-number="3835"></td>
        <td id="LC3835">                }</td>
      </tr>
      <tr>
        <td id="L3836" data-line-number="3836"></td>
        <td id="LC3836">                <span>if</span> (<span>buffer</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L3837" data-line-number="3837"></td>
        <td id="LC3837">                {</td>
      </tr>
      <tr>
        <td id="L3838" data-line-number="3838"></td>
        <td id="LC3838">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>buffer</span>, <span>0</span>, <span>stateLen</span>))</td>
      </tr>
      <tr>
        <td id="L3839" data-line-number="3839"></td>
        <td id="LC3839">                    {</td>
      </tr>
      <tr>
        <td id="L3840" data-line-number="3840"></td>
        <td id="LC3840">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3841" data-line-number="3841"></td>
        <td id="LC3841">                    }</td>
      </tr>
      <tr>
        <td id="L3842" data-line-number="3842"></td>
        <td id="LC3842">                }</td>
      </tr>
      <tr>
        <td id="L3843" data-line-number="3843"></td>
        <td id="LC3843">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L3844" data-line-number="3844"></td>
        <td id="LC3844">                {</td>
      </tr>
      <tr>
        <td id="L3845" data-line-number="3845"></td>
        <td id="LC3845">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>stateLen</span>))</td>
      </tr>
      <tr>
        <td id="L3846" data-line-number="3846"></td>
        <td id="LC3846">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3847" data-line-number="3847"></td>
        <td id="LC3847">                }</td>
      </tr>
      <tr>
        <td id="L3848" data-line-number="3848"></td>
        <td id="LC3848">
</td>
      </tr>
      <tr>
        <td id="L3849" data-line-number="3849"></td>
        <td id="LC3849">                <span>if</span> (<span>stateLenByte</span> <span>&lt;</span> <span>0xFF</span>)</td>
      </tr>
      <tr>
        <td id="L3850" data-line-number="3850"></td>
        <td id="LC3850">                {</td>
      </tr>
      <tr>
        <td id="L3851" data-line-number="3851"></td>
        <td id="LC3851">                    <span>length</span> <span>-=</span> <span>2</span> <span>+</span> <span>stateLen</span>;</td>
      </tr>
      <tr>
        <td id="L3852" data-line-number="3852"></td>
        <td id="LC3852">                }</td>
      </tr>
      <tr>
        <td id="L3853" data-line-number="3853"></td>
        <td id="LC3853">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L3854" data-line-number="3854"></td>
        <td id="LC3854">                {</td>
      </tr>
      <tr>
        <td id="L3855" data-line-number="3855"></td>
        <td id="LC3855">                    <span>length</span> <span>-=</span> <span>6</span> <span>+</span> <span>stateLen</span>;</td>
      </tr>
      <tr>
        <td id="L3856" data-line-number="3856"></td>
        <td id="LC3856">                }</td>
      </tr>
      <tr>
        <td id="L3857" data-line-number="3857"></td>
        <td id="LC3857">            }</td>
      </tr>
      <tr>
        <td id="L3858" data-line-number="3858"></td>
        <td id="LC3858">            <span>sdata</span>.<span>AssertUnrecoverableStateCountIsCorrect</span>();</td>
      </tr>
      <tr>
        <td id="L3859" data-line-number="3859"></td>
        <td id="LC3859">
</td>
      </tr>
      <tr>
        <td id="L3860" data-line-number="3860"></td>
        <td id="LC3860">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3861" data-line-number="3861"></td>
        <td id="LC3861">        }</td>
      </tr>
      <tr>
        <td id="L3862" data-line-number="3862"></td>
        <td id="LC3862">
</td>
      </tr>
      <tr>
        <td id="L3863" data-line-number="3863"></td>
        <td id="LC3863">        <span>private</span> <span>bool</span> <span>TryProcessLoginAck</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>SqlLoginAck</span> <span>sqlLoginAck</span>)</td>
      </tr>
      <tr>
        <td id="L3864" data-line-number="3864"></td>
        <td id="LC3864">        {</td>
      </tr>
      <tr>
        <td id="L3865" data-line-number="3865"></td>
        <td id="LC3865">            <span>SqlLoginAck</span> <span>a</span> <span>=</span> <span>new</span> <span>SqlLoginAck</span>();</td>
      </tr>
      <tr>
        <td id="L3866" data-line-number="3866"></td>
        <td id="LC3866">
</td>
      </tr>
      <tr>
        <td id="L3867" data-line-number="3867"></td>
        <td id="LC3867">            <span>sqlLoginAck</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L3868" data-line-number="3868"></td>
        <td id="LC3868">
</td>
      </tr>
      <tr>
        <td id="L3869" data-line-number="3869"></td>
        <td id="LC3869">            <span><span>//</span> read past interface type and version</span></td>
      </tr>
      <tr>
        <td id="L3870" data-line-number="3870"></td>
        <td id="LC3870">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>1</span>))</td>
      </tr>
      <tr>
        <td id="L3871" data-line-number="3871"></td>
        <td id="LC3871">            {</td>
      </tr>
      <tr>
        <td id="L3872" data-line-number="3872"></td>
        <td id="LC3872">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3873" data-line-number="3873"></td>
        <td id="LC3873">            }</td>
      </tr>
      <tr>
        <td id="L3874" data-line-number="3874"></td>
        <td id="LC3874">
</td>
      </tr>
      <tr>
        <td id="L3875" data-line-number="3875"></td>
        <td id="LC3875">            <span>byte</span>[] <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>TdsEnums</span>.<span>VERSION_SIZE</span>];</td>
      </tr>
      <tr>
        <td id="L3876" data-line-number="3876"></td>
        <td id="LC3876">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>b</span>, <span>0</span>, <span>b</span>.<span>Length</span>))</td>
      </tr>
      <tr>
        <td id="L3877" data-line-number="3877"></td>
        <td id="LC3877">            {</td>
      </tr>
      <tr>
        <td id="L3878" data-line-number="3878"></td>
        <td id="LC3878">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3879" data-line-number="3879"></td>
        <td id="LC3879">            }</td>
      </tr>
      <tr>
        <td id="L3880" data-line-number="3880"></td>
        <td id="LC3880">            <span>a</span>.<span>tdsVersion</span> <span>=</span> (<span>UInt32</span>)((((((<span>b</span>[<span>0</span>] <span>&lt;&lt;</span> <span>8</span>) <span>|</span> <span>b</span>[<span>1</span>]) <span>&lt;&lt;</span> <span>8</span>) <span>|</span> <span>b</span>[<span>2</span>]) <span>&lt;&lt;</span> <span>8</span>) <span>|</span> <span>b</span>[<span>3</span>]); <span><span>//</span> bytes are in motorola order (high byte first)</span></td>
      </tr>
      <tr>
        <td id="L3881" data-line-number="3881"></td>
        <td id="LC3881">            <span>UInt32</span> <span>majorMinor</span> <span>=</span> <span>a</span>.<span>tdsVersion</span> <span>&amp;</span> <span>0xff00ffff</span>;</td>
      </tr>
      <tr>
        <td id="L3882" data-line-number="3882"></td>
        <td id="LC3882">            <span>UInt32</span> <span>increment</span> <span>=</span> (<span>a</span>.<span>tdsVersion</span> <span>&gt;&gt;</span> <span>16</span>) <span>&amp;</span> <span>0xff</span>;</td>
      </tr>
      <tr>
        <td id="L3883" data-line-number="3883"></td>
        <td id="LC3883">
</td>
      </tr>
      <tr>
        <td id="L3884" data-line-number="3884"></td>
        <td id="LC3884">            <span><span>//</span> Server responds:</span></td>
      </tr>
      <tr>
        <td id="L3885" data-line-number="3885"></td>
        <td id="LC3885">            <span><span>//</span> 0x07000000 -&gt; Sphinx         // Notice server response format is different for bwd compat</span></td>
      </tr>
      <tr>
        <td id="L3886" data-line-number="3886"></td>
        <td id="LC3886">            <span><span>//</span> 0x07010000 -&gt; Shiloh RTM     // Notice server response format is different for bwd compat</span></td>
      </tr>
      <tr>
        <td id="L3887" data-line-number="3887"></td>
        <td id="LC3887">            <span><span>//</span> 0x71000001 -&gt; Shiloh SP1</span></td>
      </tr>
      <tr>
        <td id="L3888" data-line-number="3888"></td>
        <td id="LC3888">            <span><span>//</span> 0x72xx0002 -&gt; Yukon RTM</span></td>
      </tr>
      <tr>
        <td id="L3889" data-line-number="3889"></td>
        <td id="LC3889">            <span><span>//</span> information provided by S. Ashwin</span></td>
      </tr>
      <tr>
        <td id="L3890" data-line-number="3890"></td>
        <td id="LC3890">
</td>
      </tr>
      <tr>
        <td id="L3891" data-line-number="3891"></td>
        <td id="LC3891">            <span>switch</span> (<span>majorMinor</span>)</td>
      </tr>
      <tr>
        <td id="L3892" data-line-number="3892"></td>
        <td id="LC3892">            {</td>
      </tr>
      <tr>
        <td id="L3893" data-line-number="3893"></td>
        <td id="LC3893">                <span>case</span> <span>TdsEnums</span>.<span>SPHINXORSHILOH_MAJOR</span> <span>&lt;&lt;</span> <span>24</span> <span>|</span> <span>TdsEnums</span>.<span>DEFAULT_MINOR</span>:    <span><span>//</span> Sphinx &amp; Shiloh RTM</span></td>
      </tr>
      <tr>
        <td id="L3894" data-line-number="3894"></td>
        <td id="LC3894">                    <span><span>//</span> note that sphinx and shiloh_rtm can only be distinguished by the increment</span></td>
      </tr>
      <tr>
        <td id="L3895" data-line-number="3895"></td>
        <td id="LC3895">                    <span>switch</span> (<span>increment</span>)</td>
      </tr>
      <tr>
        <td id="L3896" data-line-number="3896"></td>
        <td id="LC3896">                    {</td>
      </tr>
      <tr>
        <td id="L3897" data-line-number="3897"></td>
        <td id="LC3897">                        <span>case</span> <span>TdsEnums</span>.<span>SHILOH_INCREMENT</span>:</td>
      </tr>
      <tr>
        <td id="L3898" data-line-number="3898"></td>
        <td id="LC3898">                            <span>_isShiloh</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3899" data-line-number="3899"></td>
        <td id="LC3899">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3900" data-line-number="3900"></td>
        <td id="LC3900">                        <span>case</span> <span>TdsEnums</span>.<span>SPHINX_INCREMENT</span>:</td>
      </tr>
      <tr>
        <td id="L3901" data-line-number="3901"></td>
        <td id="LC3901">                            <span><span>//</span> no flag will be set</span></td>
      </tr>
      <tr>
        <td id="L3902" data-line-number="3902"></td>
        <td id="LC3902">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3903" data-line-number="3903"></td>
        <td id="LC3903">                        <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L3904" data-line-number="3904"></td>
        <td id="LC3904">                            <span>throw</span> <span>SQL</span>.<span>InvalidTDSVersion</span>();</td>
      </tr>
      <tr>
        <td id="L3905" data-line-number="3905"></td>
        <td id="LC3905">                    }</td>
      </tr>
      <tr>
        <td id="L3906" data-line-number="3906"></td>
        <td id="LC3906">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3907" data-line-number="3907"></td>
        <td id="LC3907">                <span>case</span> <span>TdsEnums</span>.<span>SHILOHSP1_MAJOR</span> <span>&lt;&lt;</span> <span>24</span> <span>|</span> <span>TdsEnums</span>.<span>SHILOHSP1_MINOR</span>: <span><span>//</span> Shiloh SP1</span></td>
      </tr>
      <tr>
        <td id="L3908" data-line-number="3908"></td>
        <td id="LC3908">                    <span>if</span> (<span>increment</span> <span>!=</span> <span>TdsEnums</span>.<span>SHILOHSP1_INCREMENT</span>)</td>
      </tr>
      <tr>
        <td id="L3909" data-line-number="3909"></td>
        <td id="LC3909">                    { <span>throw</span> <span>SQL</span>.<span>InvalidTDSVersion</span>(); }</td>
      </tr>
      <tr>
        <td id="L3910" data-line-number="3910"></td>
        <td id="LC3910">                    <span>_isShilohSP1</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3911" data-line-number="3911"></td>
        <td id="LC3911">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3912" data-line-number="3912"></td>
        <td id="LC3912">                <span>case</span> <span>TdsEnums</span>.<span>YUKON_MAJOR</span> <span>&lt;&lt;</span> <span>24</span> <span>|</span> <span>TdsEnums</span>.<span>YUKON_RTM_MINOR</span>:     <span><span>//</span> Yukon</span></td>
      </tr>
      <tr>
        <td id="L3913" data-line-number="3913"></td>
        <td id="LC3913">                    <span>if</span> (<span>increment</span> <span>!=</span> <span>TdsEnums</span>.<span>YUKON_INCREMENT</span>)</td>
      </tr>
      <tr>
        <td id="L3914" data-line-number="3914"></td>
        <td id="LC3914">                    { <span>throw</span> <span>SQL</span>.<span>InvalidTDSVersion</span>(); }</td>
      </tr>
      <tr>
        <td id="L3915" data-line-number="3915"></td>
        <td id="LC3915">                    <span>_isYukon</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3916" data-line-number="3916"></td>
        <td id="LC3916">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3917" data-line-number="3917"></td>
        <td id="LC3917">                <span>case</span> <span>TdsEnums</span>.<span>KATMAI_MAJOR</span> <span>&lt;&lt;</span> <span>24</span> <span>|</span> <span>TdsEnums</span>.<span>KATMAI_MINOR</span>:</td>
      </tr>
      <tr>
        <td id="L3918" data-line-number="3918"></td>
        <td id="LC3918">                    <span>if</span> (<span>increment</span> <span>!=</span> <span>TdsEnums</span>.<span>KATMAI_INCREMENT</span>)</td>
      </tr>
      <tr>
        <td id="L3919" data-line-number="3919"></td>
        <td id="LC3919">                    { <span>throw</span> <span>SQL</span>.<span>InvalidTDSVersion</span>(); }</td>
      </tr>
      <tr>
        <td id="L3920" data-line-number="3920"></td>
        <td id="LC3920">                    <span>_isKatmai</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3921" data-line-number="3921"></td>
        <td id="LC3921">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3922" data-line-number="3922"></td>
        <td id="LC3922">                <span>case</span> <span>TdsEnums</span>.<span>DENALI_MAJOR</span> <span>&lt;&lt;</span> <span>24</span> <span>|</span> <span>TdsEnums</span>.<span>DENALI_MINOR</span>:</td>
      </tr>
      <tr>
        <td id="L3923" data-line-number="3923"></td>
        <td id="LC3923">                    <span>if</span> (<span>increment</span> <span>!=</span> <span>TdsEnums</span>.<span>DENALI_INCREMENT</span>)</td>
      </tr>
      <tr>
        <td id="L3924" data-line-number="3924"></td>
        <td id="LC3924">                    { <span>throw</span> <span>SQL</span>.<span>InvalidTDSVersion</span>(); }</td>
      </tr>
      <tr>
        <td id="L3925" data-line-number="3925"></td>
        <td id="LC3925">                    <span>_isDenali</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3926" data-line-number="3926"></td>
        <td id="LC3926">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L3927" data-line-number="3927"></td>
        <td id="LC3927">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L3928" data-line-number="3928"></td>
        <td id="LC3928">                    <span>throw</span> <span>SQL</span>.<span>InvalidTDSVersion</span>();</td>
      </tr>
      <tr>
        <td id="L3929" data-line-number="3929"></td>
        <td id="LC3929">            }</td>
      </tr>
      <tr>
        <td id="L3930" data-line-number="3930"></td>
        <td id="LC3930">
</td>
      </tr>
      <tr>
        <td id="L3931" data-line-number="3931"></td>
        <td id="LC3931">            <span>_isKatmai</span> <span>|=</span> <span>_isDenali</span>;</td>
      </tr>
      <tr>
        <td id="L3932" data-line-number="3932"></td>
        <td id="LC3932">            <span>_isYukon</span> <span>|=</span> <span>_isKatmai</span>;</td>
      </tr>
      <tr>
        <td id="L3933" data-line-number="3933"></td>
        <td id="LC3933">            <span>_isShilohSP1</span> <span>|=</span> <span>_isYukon</span>;            <span><span>//</span> includes all lower versions</span></td>
      </tr>
      <tr>
        <td id="L3934" data-line-number="3934"></td>
        <td id="LC3934">            <span>_isShiloh</span> <span>|=</span> <span>_isShilohSP1</span>;        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L3935" data-line-number="3935"></td>
        <td id="LC3935">
</td>
      </tr>
      <tr>
        <td id="L3936" data-line-number="3936"></td>
        <td id="LC3936">            <span>a</span>.<span>isVersion8</span> <span>=</span> <span>_isShiloh</span>;</td>
      </tr>
      <tr>
        <td id="L3937" data-line-number="3937"></td>
        <td id="LC3937">
</td>
      </tr>
      <tr>
        <td id="L3938" data-line-number="3938"></td>
        <td id="LC3938">            <span>stateObj</span>.<span>_outBytesUsed</span> <span>=</span> <span>stateObj</span>.<span>_outputHeaderLen</span>;</td>
      </tr>
      <tr>
        <td id="L3939" data-line-number="3939"></td>
        <td id="LC3939">            <span>byte</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L3940" data-line-number="3940"></td>
        <td id="LC3940">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>len</span>))</td>
      </tr>
      <tr>
        <td id="L3941" data-line-number="3941"></td>
        <td id="LC3941">            {</td>
      </tr>
      <tr>
        <td id="L3942" data-line-number="3942"></td>
        <td id="LC3942">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3943" data-line-number="3943"></td>
        <td id="LC3943">            }</td>
      </tr>
      <tr>
        <td id="L3944" data-line-number="3944"></td>
        <td id="LC3944">
</td>
      </tr>
      <tr>
        <td id="L3945" data-line-number="3945"></td>
        <td id="LC3945">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>len</span>, <span>out</span> <span>a</span>.<span>programName</span>))</td>
      </tr>
      <tr>
        <td id="L3946" data-line-number="3946"></td>
        <td id="LC3946">            {</td>
      </tr>
      <tr>
        <td id="L3947" data-line-number="3947"></td>
        <td id="LC3947">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3948" data-line-number="3948"></td>
        <td id="LC3948">            }</td>
      </tr>
      <tr>
        <td id="L3949" data-line-number="3949"></td>
        <td id="LC3949">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>a</span>.<span>majorVersion</span>))</td>
      </tr>
      <tr>
        <td id="L3950" data-line-number="3950"></td>
        <td id="LC3950">            {</td>
      </tr>
      <tr>
        <td id="L3951" data-line-number="3951"></td>
        <td id="LC3951">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3952" data-line-number="3952"></td>
        <td id="LC3952">            }</td>
      </tr>
      <tr>
        <td id="L3953" data-line-number="3953"></td>
        <td id="LC3953">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>a</span>.<span>minorVersion</span>))</td>
      </tr>
      <tr>
        <td id="L3954" data-line-number="3954"></td>
        <td id="LC3954">            {</td>
      </tr>
      <tr>
        <td id="L3955" data-line-number="3955"></td>
        <td id="LC3955">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3956" data-line-number="3956"></td>
        <td id="LC3956">            }</td>
      </tr>
      <tr>
        <td id="L3957" data-line-number="3957"></td>
        <td id="LC3957">            <span>byte</span> <span>buildNumHi</span>, <span>buildNumLo</span>;</td>
      </tr>
      <tr>
        <td id="L3958" data-line-number="3958"></td>
        <td id="LC3958">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>buildNumHi</span>))</td>
      </tr>
      <tr>
        <td id="L3959" data-line-number="3959"></td>
        <td id="LC3959">            {</td>
      </tr>
      <tr>
        <td id="L3960" data-line-number="3960"></td>
        <td id="LC3960">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3961" data-line-number="3961"></td>
        <td id="LC3961">            }</td>
      </tr>
      <tr>
        <td id="L3962" data-line-number="3962"></td>
        <td id="LC3962">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>buildNumLo</span>))</td>
      </tr>
      <tr>
        <td id="L3963" data-line-number="3963"></td>
        <td id="LC3963">            {</td>
      </tr>
      <tr>
        <td id="L3964" data-line-number="3964"></td>
        <td id="LC3964">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L3965" data-line-number="3965"></td>
        <td id="LC3965">            }</td>
      </tr>
      <tr>
        <td id="L3966" data-line-number="3966"></td>
        <td id="LC3966">
</td>
      </tr>
      <tr>
        <td id="L3967" data-line-number="3967"></td>
        <td id="LC3967">            <span>a</span>.<span>buildNum</span> <span>=</span> (<span>short</span>)((<span>buildNumHi</span> <span>&lt;&lt;</span> <span>8</span>) <span>+</span> <span>buildNumLo</span>);</td>
      </tr>
      <tr>
        <td id="L3968" data-line-number="3968"></td>
        <td id="LC3968">
</td>
      </tr>
      <tr>
        <td id="L3969" data-line-number="3969"></td>
        <td id="LC3969">            <span>Debug</span>.<span>Assert</span>(<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span>, <span><span>"</span>ProcessLoginAck called with state not TdsParserState.OpenNotLoggedIn<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L3970" data-line-number="3970"></td>
        <td id="LC3970">            <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>OpenLoggedIn</span>;</td>
      </tr>
      <tr>
        <td id="L3971" data-line-number="3971"></td>
        <td id="LC3971">
</td>
      </tr>
      <tr>
        <td id="L3972" data-line-number="3972"></td>
        <td id="LC3972">            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L3973" data-line-number="3973"></td>
        <td id="LC3973">            {</td>
      </tr>
      <tr>
        <td id="L3974" data-line-number="3974"></td>
        <td id="LC3974">                <span>if</span> (<span>_fMARS</span>)</td>
      </tr>
      <tr>
        <td id="L3975" data-line-number="3975"></td>
        <td id="LC3975">                {</td>
      </tr>
      <tr>
        <td id="L3976" data-line-number="3976"></td>
        <td id="LC3976">                    <span>_resetConnectionEvent</span> <span>=</span> <span>new</span> <span>AutoResetEvent</span>(<span>true</span>);</td>
      </tr>
      <tr>
        <td id="L3977" data-line-number="3977"></td>
        <td id="LC3977">                }</td>
      </tr>
      <tr>
        <td id="L3978" data-line-number="3978"></td>
        <td id="LC3978">            }</td>
      </tr>
      <tr>
        <td id="L3979" data-line-number="3979"></td>
        <td id="LC3979">
</td>
      </tr>
      <tr>
        <td id="L3980" data-line-number="3980"></td>
        <td id="LC3980">            <span><span>//</span> Fail if SSE UserInstance and we have not received this info.</span></td>
      </tr>
      <tr>
        <td id="L3981" data-line-number="3981"></td>
        <td id="LC3981">            <span>if</span> (<span>_connHandler</span>.<span>ConnectionOptions</span>.<span>UserInstance</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L3982" data-line-number="3982"></td>
        <td id="LC3982">                <span>ADP</span>.<span>IsEmpty</span>(<span>_connHandler</span>.<span>InstanceName</span>))</td>
      </tr>
      <tr>
        <td id="L3983" data-line-number="3983"></td>
        <td id="LC3983">            {</td>
      </tr>
      <tr>
        <td id="L3984" data-line-number="3984"></td>
        <td id="LC3984">                <span>stateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>0</span>, <span>0</span>, <span>TdsEnums</span>.<span>FATAL_ERROR_CLASS</span>, <span>Server</span>, <span>SQLMessage</span>.<span>UserInstanceFailure</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L3985" data-line-number="3985"></td>
        <td id="LC3985">                <span>ThrowExceptionAndWarning</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L3986" data-line-number="3986"></td>
        <td id="LC3986">            }</td>
      </tr>
      <tr>
        <td id="L3987" data-line-number="3987"></td>
        <td id="LC3987">
</td>
      </tr>
      <tr>
        <td id="L3988" data-line-number="3988"></td>
        <td id="LC3988">            <span>sqlLoginAck</span> <span>=</span> <span>a</span>;</td>
      </tr>
      <tr>
        <td id="L3989" data-line-number="3989"></td>
        <td id="LC3989">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L3990" data-line-number="3990"></td>
        <td id="LC3990">        }</td>
      </tr>
      <tr>
        <td id="L3991" data-line-number="3991"></td>
        <td id="LC3991">
</td>
      </tr>
      <tr>
        <td id="L3992" data-line-number="3992"></td>
        <td id="LC3992">        <span>private</span> <span>bool</span> <span>TryProcessFedAuthInfo</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>tokenLen</span>, <span>out</span> <span>SqlFedAuthInfo</span> <span>sqlFedAuthInfo</span>)</td>
      </tr>
      <tr>
        <td id="L3993" data-line-number="3993"></td>
        <td id="LC3993">        {</td>
      </tr>
      <tr>
        <td id="L3994" data-line-number="3994"></td>
        <td id="LC3994">            <span>sqlFedAuthInfo</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L3995" data-line-number="3995"></td>
        <td id="LC3995">            <span>SqlFedAuthInfo</span> <span>tempFedAuthInfo</span> <span>=</span> <span>new</span> <span>SqlFedAuthInfo</span>();</td>
      </tr>
      <tr>
        <td id="L3996" data-line-number="3996"></td>
        <td id="LC3996">
</td>
      </tr>
      <tr>
        <td id="L3997" data-line-number="3997"></td>
        <td id="LC3997">            <span><span>//</span> Skip reading token length, since it has already been read in caller</span></td>
      </tr>
      <tr>
        <td id="L3998" data-line-number="3998"></td>
        <td id="LC3998">
</td>
      </tr>
      <tr>
        <td id="L3999" data-line-number="3999"></td>
        <td id="LC3999">            <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L4000" data-line-number="4000"></td>
        <td id="LC4000">            {</td>
      </tr>
      <tr>
        <td id="L4001" data-line-number="4001"></td>
        <td id="LC4001">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo&gt; FEDAUTHINFO token stream length = {0}<span>\n</span><span>"</span></span>, <span>tokenLen</span>);</td>
      </tr>
      <tr>
        <td id="L4002" data-line-number="4002"></td>
        <td id="LC4002">            }</td>
      </tr>
      <tr>
        <td id="L4003" data-line-number="4003"></td>
        <td id="LC4003">
</td>
      </tr>
      <tr>
        <td id="L4004" data-line-number="4004"></td>
        <td id="LC4004">            <span>if</span> (<span>tokenLen</span> <span>&lt;</span> <span>sizeof</span>(<span>uint</span>))</td>
      </tr>
      <tr>
        <td id="L4005" data-line-number="4005"></td>
        <td id="LC4005">            {</td>
      </tr>
      <tr>
        <td id="L4006" data-line-number="4006"></td>
        <td id="LC4006">                <span><span>//</span> the token must at least contain a DWORD indicating the number of info IDs</span></td>
      </tr>
      <tr>
        <td id="L4007" data-line-number="4007"></td>
        <td id="LC4007">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; FEDAUTHINFO token stream length too short for CountOfInfoIDs.<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4008" data-line-number="4008"></td>
        <td id="LC4008">                <span>throw</span> <span>SQL</span>.<span>ParsingErrorLength</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoLengthTooShortForCountOfInfoIds</span>, <span>tokenLen</span>);</td>
      </tr>
      <tr>
        <td id="L4009" data-line-number="4009"></td>
        <td id="LC4009">            }</td>
      </tr>
      <tr>
        <td id="L4010" data-line-number="4010"></td>
        <td id="LC4010">
</td>
      </tr>
      <tr>
        <td id="L4011" data-line-number="4011"></td>
        <td id="LC4011">            <span><span>//</span> read how many FedAuthInfo options there are</span></td>
      </tr>
      <tr>
        <td id="L4012" data-line-number="4012"></td>
        <td id="LC4012">            <span>uint</span> <span>optionsCount</span>;</td>
      </tr>
      <tr>
        <td id="L4013" data-line-number="4013"></td>
        <td id="LC4013">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>optionsCount</span>))</td>
      </tr>
      <tr>
        <td id="L4014" data-line-number="4014"></td>
        <td id="LC4014">            {</td>
      </tr>
      <tr>
        <td id="L4015" data-line-number="4015"></td>
        <td id="LC4015">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; Failed to read CountOfInfoIDs in FEDAUTHINFO token stream.<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4016" data-line-number="4016"></td>
        <td id="LC4016">                <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoFailedToReadCountOfInfoIds</span>);</td>
      </tr>
      <tr>
        <td id="L4017" data-line-number="4017"></td>
        <td id="LC4017">            }</td>
      </tr>
      <tr>
        <td id="L4018" data-line-number="4018"></td>
        <td id="LC4018">            <span>tokenLen</span> <span>-=</span> <span>sizeof</span>(<span>uint</span>); <span><span>//</span> remaining length is shortened since we read optCount</span></td>
      </tr>
      <tr>
        <td id="L4019" data-line-number="4019"></td>
        <td id="LC4019">
</td>
      </tr>
      <tr>
        <td id="L4020" data-line-number="4020"></td>
        <td id="LC4020">            <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L4021" data-line-number="4021"></td>
        <td id="LC4021">            {</td>
      </tr>
      <tr>
        <td id="L4022" data-line-number="4022"></td>
        <td id="LC4022">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo&gt; CountOfInfoIDs = {0}<span>\n</span><span>"</span></span>, <span>optionsCount</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L4023" data-line-number="4023"></td>
        <td id="LC4023">            }</td>
      </tr>
      <tr>
        <td id="L4024" data-line-number="4024"></td>
        <td id="LC4024">
</td>
      </tr>
      <tr>
        <td id="L4025" data-line-number="4025"></td>
        <td id="LC4025">            <span>if</span> (<span>tokenLen</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4026" data-line-number="4026"></td>
        <td id="LC4026">            {</td>
      </tr>
      <tr>
        <td id="L4027" data-line-number="4027"></td>
        <td id="LC4027">                <span><span>//</span> read the rest of the token</span></td>
      </tr>
      <tr>
        <td id="L4028" data-line-number="4028"></td>
        <td id="LC4028">                <span>byte</span>[] <span>tokenData</span> <span>=</span> <span>new</span> <span>byte</span>[<span>tokenLen</span>];</td>
      </tr>
      <tr>
        <td id="L4029" data-line-number="4029"></td>
        <td id="LC4029">                <span>int</span> <span>totalRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L4030" data-line-number="4030"></td>
        <td id="LC4030">                <span>bool</span> <span>successfulRead</span> <span>=</span> <span>stateObj</span>.<span>TryReadByteArray</span>(<span>tokenData</span>, <span>0</span>, <span>tokenLen</span>, <span>out</span> <span>totalRead</span>);</td>
      </tr>
      <tr>
        <td id="L4031" data-line-number="4031"></td>
        <td id="LC4031">
</td>
      </tr>
      <tr>
        <td id="L4032" data-line-number="4032"></td>
        <td id="LC4032">                <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L4033" data-line-number="4033"></td>
        <td id="LC4033">                {</td>
      </tr>
      <tr>
        <td id="L4034" data-line-number="4034"></td>
        <td id="LC4034">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo&gt; Read rest of FEDAUTHINFO token stream: {0}<span>\n</span><span>"</span></span>, <span>BitConverter</span>.<span>ToString</span>(<span>tokenData</span>, <span>0</span>, <span>totalRead</span>));</td>
      </tr>
      <tr>
        <td id="L4035" data-line-number="4035"></td>
        <td id="LC4035">                }</td>
      </tr>
      <tr>
        <td id="L4036" data-line-number="4036"></td>
        <td id="LC4036">
</td>
      </tr>
      <tr>
        <td id="L4037" data-line-number="4037"></td>
        <td id="LC4037">                <span>if</span> (<span>!</span><span>successfulRead</span> <span>||</span> <span>totalRead</span> <span>!=</span> <span>tokenLen</span>)</td>
      </tr>
      <tr>
        <td id="L4038" data-line-number="4038"></td>
        <td id="LC4038">                {</td>
      </tr>
      <tr>
        <td id="L4039" data-line-number="4039"></td>
        <td id="LC4039">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; Failed to read FEDAUTHINFO token stream. Attempted to read {0} bytes, actually read {1}<span>\n</span><span>"</span></span>, <span>tokenLen</span>, <span>totalRead</span>);</td>
      </tr>
      <tr>
        <td id="L4040" data-line-number="4040"></td>
        <td id="LC4040">                    <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoFailedToReadTokenStream</span>);</td>
      </tr>
      <tr>
        <td id="L4041" data-line-number="4041"></td>
        <td id="LC4041">                }</td>
      </tr>
      <tr>
        <td id="L4042" data-line-number="4042"></td>
        <td id="LC4042">
</td>
      </tr>
      <tr>
        <td id="L4043" data-line-number="4043"></td>
        <td id="LC4043">                <span><span>//</span> each FedAuthInfoOpt is 9 bytes:</span></td>
      </tr>
      <tr>
        <td id="L4044" data-line-number="4044"></td>
        <td id="LC4044">                <span><span>//</span>    1 byte for FedAuthInfoID</span></td>
      </tr>
      <tr>
        <td id="L4045" data-line-number="4045"></td>
        <td id="LC4045">                <span><span>//</span>    4 bytes for FedAuthInfoDataLen</span></td>
      </tr>
      <tr>
        <td id="L4046" data-line-number="4046"></td>
        <td id="LC4046">                <span><span>//</span>    4 bytes for FedAuthInfoDataOffset</span></td>
      </tr>
      <tr>
        <td id="L4047" data-line-number="4047"></td>
        <td id="LC4047">                <span><span>//</span> So this is the index in tokenData for the i-th option</span></td>
      </tr>
      <tr>
        <td id="L4048" data-line-number="4048"></td>
        <td id="LC4048">                <span>const</span> <span>uint</span> <span>optionSize</span> <span>=</span> <span>9</span>;</td>
      </tr>
      <tr>
        <td id="L4049" data-line-number="4049"></td>
        <td id="LC4049">
</td>
      </tr>
      <tr>
        <td id="L4050" data-line-number="4050"></td>
        <td id="LC4050">                <span><span>//</span> the total number of bytes for all FedAuthInfoOpts together</span></td>
      </tr>
      <tr>
        <td id="L4051" data-line-number="4051"></td>
        <td id="LC4051">                <span>uint</span> <span>totalOptionsSize</span> <span>=</span> <span>checked</span>(<span>optionsCount</span> <span>*</span> <span>optionSize</span>);</td>
      </tr>
      <tr>
        <td id="L4052" data-line-number="4052"></td>
        <td id="LC4052">
</td>
      </tr>
      <tr>
        <td id="L4053" data-line-number="4053"></td>
        <td id="LC4053">                <span>for</span> (<span>uint</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>optionsCount</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L4054" data-line-number="4054"></td>
        <td id="LC4054">                {</td>
      </tr>
      <tr>
        <td id="L4055" data-line-number="4055"></td>
        <td id="LC4055">                    <span>uint</span> <span>currentOptionOffset</span> <span>=</span> <span>checked</span>(<span>i</span> <span>*</span> <span>optionSize</span>);</td>
      </tr>
      <tr>
        <td id="L4056" data-line-number="4056"></td>
        <td id="LC4056">
</td>
      </tr>
      <tr>
        <td id="L4057" data-line-number="4057"></td>
        <td id="LC4057">                    <span>byte</span> <span>id</span> <span>=</span> <span>tokenData</span>[<span>currentOptionOffset</span>];</td>
      </tr>
      <tr>
        <td id="L4058" data-line-number="4058"></td>
        <td id="LC4058">                    <span>uint</span> <span>dataLen</span> <span>=</span> <span>BitConverter</span>.<span>ToUInt32</span>(<span>tokenData</span>, <span>checked</span>((<span>int</span>)(<span>currentOptionOffset</span> <span>+</span> <span>1</span>)));</td>
      </tr>
      <tr>
        <td id="L4059" data-line-number="4059"></td>
        <td id="LC4059">                    <span>uint</span> <span>dataOffset</span> <span>=</span> <span>BitConverter</span>.<span>ToUInt32</span>(<span>tokenData</span>, <span>checked</span>((<span>int</span>)(<span>currentOptionOffset</span> <span>+</span> <span>5</span>)));</td>
      </tr>
      <tr>
        <td id="L4060" data-line-number="4060"></td>
        <td id="LC4060">
</td>
      </tr>
      <tr>
        <td id="L4061" data-line-number="4061"></td>
        <td id="LC4061">                    <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L4062" data-line-number="4062"></td>
        <td id="LC4062">                    {</td>
      </tr>
      <tr>
        <td id="L4063" data-line-number="4063"></td>
        <td id="LC4063">                        <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo&gt; FedAuthInfoOpt: ID={0}, DataLen={1}, Offset={2}<span>\n</span><span>"</span></span>, <span>id</span>, <span>dataLen</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>), <span>dataOffset</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L4064" data-line-number="4064"></td>
        <td id="LC4064">                    }</td>
      </tr>
      <tr>
        <td id="L4065" data-line-number="4065"></td>
        <td id="LC4065">
</td>
      </tr>
      <tr>
        <td id="L4066" data-line-number="4066"></td>
        <td id="LC4066">                    <span><span>//</span> offset is measured from optCount, so subtract to make offset measured</span></td>
      </tr>
      <tr>
        <td id="L4067" data-line-number="4067"></td>
        <td id="LC4067">                    <span><span>//</span> from the beginning of tokenData</span></td>
      </tr>
      <tr>
        <td id="L4068" data-line-number="4068"></td>
        <td id="LC4068">                    <span>checked</span></td>
      </tr>
      <tr>
        <td id="L4069" data-line-number="4069"></td>
        <td id="LC4069">                    {</td>
      </tr>
      <tr>
        <td id="L4070" data-line-number="4070"></td>
        <td id="LC4070">                        <span>dataOffset</span> <span>-=</span> <span>sizeof</span>(<span>uint</span>);</td>
      </tr>
      <tr>
        <td id="L4071" data-line-number="4071"></td>
        <td id="LC4071">                    }</td>
      </tr>
      <tr>
        <td id="L4072" data-line-number="4072"></td>
        <td id="LC4072">
</td>
      </tr>
      <tr>
        <td id="L4073" data-line-number="4073"></td>
        <td id="LC4073">                    <span><span>//</span> if dataOffset points to a region within FedAuthInfoOpt or after the end of the token, throw</span></td>
      </tr>
      <tr>
        <td id="L4074" data-line-number="4074"></td>
        <td id="LC4074">                    <span>if</span> (<span>dataOffset</span> <span>&lt;</span> <span>totalOptionsSize</span> <span>||</span> <span>dataOffset</span> <span>&gt;=</span> <span>tokenLen</span>)</td>
      </tr>
      <tr>
        <td id="L4075" data-line-number="4075"></td>
        <td id="LC4075">                    {</td>
      </tr>
      <tr>
        <td id="L4076" data-line-number="4076"></td>
        <td id="LC4076">                        <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; FedAuthInfoDataOffset points to an invalid location.<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4077" data-line-number="4077"></td>
        <td id="LC4077">                        <span>throw</span> <span>SQL</span>.<span>ParsingErrorOffset</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoInvalidOffset</span>, <span>unchecked</span>((<span>int</span>)<span>dataOffset</span>));</td>
      </tr>
      <tr>
        <td id="L4078" data-line-number="4078"></td>
        <td id="LC4078">                    }</td>
      </tr>
      <tr>
        <td id="L4079" data-line-number="4079"></td>
        <td id="LC4079">
</td>
      </tr>
      <tr>
        <td id="L4080" data-line-number="4080"></td>
        <td id="LC4080">                    <span><span>//</span> try to read data and throw if the arguments are bad, meaning the server sent us a bad token</span></td>
      </tr>
      <tr>
        <td id="L4081" data-line-number="4081"></td>
        <td id="LC4081">                    <span>string</span> <span>data</span>;</td>
      </tr>
      <tr>
        <td id="L4082" data-line-number="4082"></td>
        <td id="LC4082">                    <span>try</span></td>
      </tr>
      <tr>
        <td id="L4083" data-line-number="4083"></td>
        <td id="LC4083">                    {</td>
      </tr>
      <tr>
        <td id="L4084" data-line-number="4084"></td>
        <td id="LC4084">                        <span>data</span> <span>=</span> <span>System</span>.<span>Text</span>.<span>Encoding</span>.<span>Unicode</span>.<span>GetString</span>(<span>tokenData</span>, <span>checked</span>((<span>int</span>)<span>dataOffset</span>), <span>checked</span>((<span>int</span>)<span>dataLen</span>));</td>
      </tr>
      <tr>
        <td id="L4085" data-line-number="4085"></td>
        <td id="LC4085">                    }</td>
      </tr>
      <tr>
        <td id="L4086" data-line-number="4086"></td>
        <td id="LC4086">                    <span>catch</span> (<span>ArgumentOutOfRangeException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L4087" data-line-number="4087"></td>
        <td id="LC4087">                    {</td>
      </tr>
      <tr>
        <td id="L4088" data-line-number="4088"></td>
        <td id="LC4088">                        <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; Failed to read FedAuthInfoData.<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4089" data-line-number="4089"></td>
        <td id="LC4089">                        <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoFailedToReadData</span>, <span>e</span>);</td>
      </tr>
      <tr>
        <td id="L4090" data-line-number="4090"></td>
        <td id="LC4090">                    }</td>
      </tr>
      <tr>
        <td id="L4091" data-line-number="4091"></td>
        <td id="LC4091">                    <span>catch</span> (<span>ArgumentException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L4092" data-line-number="4092"></td>
        <td id="LC4092">                    {</td>
      </tr>
      <tr>
        <td id="L4093" data-line-number="4093"></td>
        <td id="LC4093">                        <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; FedAuthInfoData is not in unicode format.<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4094" data-line-number="4094"></td>
        <td id="LC4094">                        <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoDataNotUnicode</span>, <span>e</span>);</td>
      </tr>
      <tr>
        <td id="L4095" data-line-number="4095"></td>
        <td id="LC4095">                    }</td>
      </tr>
      <tr>
        <td id="L4096" data-line-number="4096"></td>
        <td id="LC4096">
</td>
      </tr>
      <tr>
        <td id="L4097" data-line-number="4097"></td>
        <td id="LC4097">                    <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L4098" data-line-number="4098"></td>
        <td id="LC4098">                    {</td>
      </tr>
      <tr>
        <td id="L4099" data-line-number="4099"></td>
        <td id="LC4099">                        <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo&gt; FedAuthInfoData: {0}<span>\n</span><span>"</span></span>, <span>data</span>);</td>
      </tr>
      <tr>
        <td id="L4100" data-line-number="4100"></td>
        <td id="LC4100">                    }</td>
      </tr>
      <tr>
        <td id="L4101" data-line-number="4101"></td>
        <td id="LC4101">
</td>
      </tr>
      <tr>
        <td id="L4102" data-line-number="4102"></td>
        <td id="LC4102">                    <span><span>//</span> store data in tempFedAuthInfo</span></td>
      </tr>
      <tr>
        <td id="L4103" data-line-number="4103"></td>
        <td id="LC4103">                    <span>switch</span> ((<span>TdsEnums</span>.<span>FedAuthInfoId</span>)<span>id</span>)</td>
      </tr>
      <tr>
        <td id="L4104" data-line-number="4104"></td>
        <td id="LC4104">                    {</td>
      </tr>
      <tr>
        <td id="L4105" data-line-number="4105"></td>
        <td id="LC4105">                        <span>case</span> <span>TdsEnums</span>.<span>FedAuthInfoId</span>.<span>Spn</span>:</td>
      </tr>
      <tr>
        <td id="L4106" data-line-number="4106"></td>
        <td id="LC4106">                            <span>tempFedAuthInfo</span>.<span>spn</span> <span>=</span> <span>data</span>;</td>
      </tr>
      <tr>
        <td id="L4107" data-line-number="4107"></td>
        <td id="LC4107">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4108" data-line-number="4108"></td>
        <td id="LC4108">                        <span>case</span> <span>TdsEnums</span>.<span>FedAuthInfoId</span>.<span>Stsurl</span>:</td>
      </tr>
      <tr>
        <td id="L4109" data-line-number="4109"></td>
        <td id="LC4109">                            <span>tempFedAuthInfo</span>.<span>stsurl</span> <span>=</span> <span>data</span>;</td>
      </tr>
      <tr>
        <td id="L4110" data-line-number="4110"></td>
        <td id="LC4110">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4111" data-line-number="4111"></td>
        <td id="LC4111">                        <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L4112" data-line-number="4112"></td>
        <td id="LC4112">                            <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L4113" data-line-number="4113"></td>
        <td id="LC4113">                            {</td>
      </tr>
      <tr>
        <td id="L4114" data-line-number="4114"></td>
        <td id="LC4114">                                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo&gt; Ignoring unknown federated authentication info option: {0}<span>\n</span><span>"</span></span>, <span>id</span>);</td>
      </tr>
      <tr>
        <td id="L4115" data-line-number="4115"></td>
        <td id="LC4115">                            }</td>
      </tr>
      <tr>
        <td id="L4116" data-line-number="4116"></td>
        <td id="LC4116">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4117" data-line-number="4117"></td>
        <td id="LC4117">                    }</td>
      </tr>
      <tr>
        <td id="L4118" data-line-number="4118"></td>
        <td id="LC4118">                }</td>
      </tr>
      <tr>
        <td id="L4119" data-line-number="4119"></td>
        <td id="LC4119">            }</td>
      </tr>
      <tr>
        <td id="L4120" data-line-number="4120"></td>
        <td id="LC4120">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4121" data-line-number="4121"></td>
        <td id="LC4121">            {</td>
      </tr>
      <tr>
        <td id="L4122" data-line-number="4122"></td>
        <td id="LC4122">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; FEDAUTHINFO token stream is not long enough to contain the data it claims to.<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4123" data-line-number="4123"></td>
        <td id="LC4123">                <span>throw</span> <span>SQL</span>.<span>ParsingErrorLength</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoLengthTooShortForData</span>, <span>tokenLen</span>);</td>
      </tr>
      <tr>
        <td id="L4124" data-line-number="4124"></td>
        <td id="LC4124">            }</td>
      </tr>
      <tr>
        <td id="L4125" data-line-number="4125"></td>
        <td id="LC4125">
</td>
      </tr>
      <tr>
        <td id="L4126" data-line-number="4126"></td>
        <td id="LC4126">            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo&gt; Processed FEDAUTHINFO token stream: {0}<span>\n</span><span>"</span></span>, <span>tempFedAuthInfo</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L4127" data-line-number="4127"></td>
        <td id="LC4127">
</td>
      </tr>
      <tr>
        <td id="L4128" data-line-number="4128"></td>
        <td id="LC4128">            <span>if</span> (<span>String</span>.<span>IsNullOrWhiteSpace</span>(<span>tempFedAuthInfo</span>.<span>stsurl</span>) <span>||</span> <span>String</span>.<span>IsNullOrWhiteSpace</span>(<span>tempFedAuthInfo</span>.<span>spn</span>))</td>
      </tr>
      <tr>
        <td id="L4129" data-line-number="4129"></td>
        <td id="LC4129">            {</td>
      </tr>
      <tr>
        <td id="L4130" data-line-number="4130"></td>
        <td id="LC4130">                <span><span>//</span> We should be receiving both stsurl and spn</span></td>
      </tr>
      <tr>
        <td id="L4131" data-line-number="4131"></td>
        <td id="LC4131">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessFedAuthInfo|ERR&gt; FEDAUTHINFO token stream does not contain both STSURL and SPN.<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4132" data-line-number="4132"></td>
        <td id="LC4132">                <span>throw</span> <span>SQL</span>.<span>ParsingError</span>(<span>ParsingErrorState</span>.<span>FedAuthInfoDoesNotContainStsurlAndSpn</span>);</td>
      </tr>
      <tr>
        <td id="L4133" data-line-number="4133"></td>
        <td id="LC4133">            }</td>
      </tr>
      <tr>
        <td id="L4134" data-line-number="4134"></td>
        <td id="LC4134">
</td>
      </tr>
      <tr>
        <td id="L4135" data-line-number="4135"></td>
        <td id="LC4135">            <span>sqlFedAuthInfo</span> <span>=</span> <span>tempFedAuthInfo</span>;</td>
      </tr>
      <tr>
        <td id="L4136" data-line-number="4136"></td>
        <td id="LC4136">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4137" data-line-number="4137"></td>
        <td id="LC4137">        }</td>
      </tr>
      <tr>
        <td id="L4138" data-line-number="4138"></td>
        <td id="LC4138">
</td>
      </tr>
      <tr>
        <td id="L4139" data-line-number="4139"></td>
        <td id="LC4139">        <span>internal</span> <span>bool</span> <span>TryProcessError</span>(<span>byte</span> <span>token</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>SqlError</span> <span>error</span>)</td>
      </tr>
      <tr>
        <td id="L4140" data-line-number="4140"></td>
        <td id="LC4140">        {</td>
      </tr>
      <tr>
        <td id="L4141" data-line-number="4141"></td>
        <td id="LC4141">            <span>ushort</span> <span>shortLen</span>;</td>
      </tr>
      <tr>
        <td id="L4142" data-line-number="4142"></td>
        <td id="LC4142">            <span>byte</span> <span>byteLen</span>;</td>
      </tr>
      <tr>
        <td id="L4143" data-line-number="4143"></td>
        <td id="LC4143">            <span>int</span> <span>number</span>;</td>
      </tr>
      <tr>
        <td id="L4144" data-line-number="4144"></td>
        <td id="LC4144">            <span>byte</span> <span>state</span>;</td>
      </tr>
      <tr>
        <td id="L4145" data-line-number="4145"></td>
        <td id="LC4145">            <span>byte</span> <span>errorClass</span>;</td>
      </tr>
      <tr>
        <td id="L4146" data-line-number="4146"></td>
        <td id="LC4146">
</td>
      </tr>
      <tr>
        <td id="L4147" data-line-number="4147"></td>
        <td id="LC4147">            <span>error</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4148" data-line-number="4148"></td>
        <td id="LC4148">
</td>
      </tr>
      <tr>
        <td id="L4149" data-line-number="4149"></td>
        <td id="LC4149">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>number</span>))</td>
      </tr>
      <tr>
        <td id="L4150" data-line-number="4150"></td>
        <td id="LC4150">            {</td>
      </tr>
      <tr>
        <td id="L4151" data-line-number="4151"></td>
        <td id="LC4151">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4152" data-line-number="4152"></td>
        <td id="LC4152">            }</td>
      </tr>
      <tr>
        <td id="L4153" data-line-number="4153"></td>
        <td id="LC4153">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>state</span>))</td>
      </tr>
      <tr>
        <td id="L4154" data-line-number="4154"></td>
        <td id="LC4154">            {</td>
      </tr>
      <tr>
        <td id="L4155" data-line-number="4155"></td>
        <td id="LC4155">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4156" data-line-number="4156"></td>
        <td id="LC4156">            }</td>
      </tr>
      <tr>
        <td id="L4157" data-line-number="4157"></td>
        <td id="LC4157">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>errorClass</span>))</td>
      </tr>
      <tr>
        <td id="L4158" data-line-number="4158"></td>
        <td id="LC4158">            {</td>
      </tr>
      <tr>
        <td id="L4159" data-line-number="4159"></td>
        <td id="LC4159">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4160" data-line-number="4160"></td>
        <td id="LC4160">            }</td>
      </tr>
      <tr>
        <td id="L4161" data-line-number="4161"></td>
        <td id="LC4161">
</td>
      </tr>
      <tr>
        <td id="L4162" data-line-number="4162"></td>
        <td id="LC4162">            <span>Debug</span>.<span>Assert</span>(((<span>errorClass</span> <span>&gt;=</span> <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>) <span>&amp;&amp;</span> <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLERROR</span>) <span>||</span></td>
      </tr>
      <tr>
        <td id="L4163" data-line-number="4163"></td>
        <td id="LC4163">                          ((<span>errorClass</span> <span>&lt;</span> <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>) <span>&amp;&amp;</span> <span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLINFO</span>), <span><span>"</span>class and token don't match!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4164" data-line-number="4164"></td>
        <td id="LC4164">
</td>
      </tr>
      <tr>
        <td id="L4165" data-line-number="4165"></td>
        <td id="LC4165">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortLen</span>))</td>
      </tr>
      <tr>
        <td id="L4166" data-line-number="4166"></td>
        <td id="LC4166">            {</td>
      </tr>
      <tr>
        <td id="L4167" data-line-number="4167"></td>
        <td id="LC4167">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4168" data-line-number="4168"></td>
        <td id="LC4168">            }</td>
      </tr>
      <tr>
        <td id="L4169" data-line-number="4169"></td>
        <td id="LC4169">            <span>string</span> <span>message</span>;</td>
      </tr>
      <tr>
        <td id="L4170" data-line-number="4170"></td>
        <td id="LC4170">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>shortLen</span>, <span>out</span> <span>message</span>))</td>
      </tr>
      <tr>
        <td id="L4171" data-line-number="4171"></td>
        <td id="LC4171">            {</td>
      </tr>
      <tr>
        <td id="L4172" data-line-number="4172"></td>
        <td id="LC4172">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4173" data-line-number="4173"></td>
        <td id="LC4173">            }</td>
      </tr>
      <tr>
        <td id="L4174" data-line-number="4174"></td>
        <td id="LC4174">
</td>
      </tr>
      <tr>
        <td id="L4175" data-line-number="4175"></td>
        <td id="LC4175">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLen</span>))</td>
      </tr>
      <tr>
        <td id="L4176" data-line-number="4176"></td>
        <td id="LC4176">            {</td>
      </tr>
      <tr>
        <td id="L4177" data-line-number="4177"></td>
        <td id="LC4177">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4178" data-line-number="4178"></td>
        <td id="LC4178">            }</td>
      </tr>
      <tr>
        <td id="L4179" data-line-number="4179"></td>
        <td id="LC4179">
</td>
      </tr>
      <tr>
        <td id="L4180" data-line-number="4180"></td>
        <td id="LC4180">            <span>string</span> <span>server</span>;</td>
      </tr>
      <tr>
        <td id="L4181" data-line-number="4181"></td>
        <td id="LC4181">
</td>
      </tr>
      <tr>
        <td id="L4182" data-line-number="4182"></td>
        <td id="LC4182">            <span><span>//</span> MDAC bug #49307 - server sometimes does not send over server field! In those cases</span></td>
      </tr>
      <tr>
        <td id="L4183" data-line-number="4183"></td>
        <td id="LC4183">            <span><span>//</span> we will use our locally cached value.</span></td>
      </tr>
      <tr>
        <td id="L4184" data-line-number="4184"></td>
        <td id="LC4184">            <span>if</span> (<span>byteLen</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4185" data-line-number="4185"></td>
        <td id="LC4185">            {</td>
      </tr>
      <tr>
        <td id="L4186" data-line-number="4186"></td>
        <td id="LC4186">                <span>server</span> <span>=</span> <span>_server</span>;</td>
      </tr>
      <tr>
        <td id="L4187" data-line-number="4187"></td>
        <td id="LC4187">            }</td>
      </tr>
      <tr>
        <td id="L4188" data-line-number="4188"></td>
        <td id="LC4188">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4189" data-line-number="4189"></td>
        <td id="LC4189">            {</td>
      </tr>
      <tr>
        <td id="L4190" data-line-number="4190"></td>
        <td id="LC4190">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLen</span>, <span>out</span> <span>server</span>))</td>
      </tr>
      <tr>
        <td id="L4191" data-line-number="4191"></td>
        <td id="LC4191">                {</td>
      </tr>
      <tr>
        <td id="L4192" data-line-number="4192"></td>
        <td id="LC4192">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4193" data-line-number="4193"></td>
        <td id="LC4193">                }</td>
      </tr>
      <tr>
        <td id="L4194" data-line-number="4194"></td>
        <td id="LC4194">            }</td>
      </tr>
      <tr>
        <td id="L4195" data-line-number="4195"></td>
        <td id="LC4195">
</td>
      </tr>
      <tr>
        <td id="L4196" data-line-number="4196"></td>
        <td id="LC4196">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLen</span>))</td>
      </tr>
      <tr>
        <td id="L4197" data-line-number="4197"></td>
        <td id="LC4197">            {</td>
      </tr>
      <tr>
        <td id="L4198" data-line-number="4198"></td>
        <td id="LC4198">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4199" data-line-number="4199"></td>
        <td id="LC4199">            }</td>
      </tr>
      <tr>
        <td id="L4200" data-line-number="4200"></td>
        <td id="LC4200">            <span>string</span> <span>procedure</span>;</td>
      </tr>
      <tr>
        <td id="L4201" data-line-number="4201"></td>
        <td id="LC4201">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLen</span>, <span>out</span> <span>procedure</span>))</td>
      </tr>
      <tr>
        <td id="L4202" data-line-number="4202"></td>
        <td id="LC4202">            {</td>
      </tr>
      <tr>
        <td id="L4203" data-line-number="4203"></td>
        <td id="LC4203">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4204" data-line-number="4204"></td>
        <td id="LC4204">            }</td>
      </tr>
      <tr>
        <td id="L4205" data-line-number="4205"></td>
        <td id="LC4205">
</td>
      </tr>
      <tr>
        <td id="L4206" data-line-number="4206"></td>
        <td id="LC4206">            <span>int</span> <span>line</span>;</td>
      </tr>
      <tr>
        <td id="L4207" data-line-number="4207"></td>
        <td id="LC4207">            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L4208" data-line-number="4208"></td>
        <td id="LC4208">            {</td>
      </tr>
      <tr>
        <td id="L4209" data-line-number="4209"></td>
        <td id="LC4209">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>line</span>))</td>
      </tr>
      <tr>
        <td id="L4210" data-line-number="4210"></td>
        <td id="LC4210">                {</td>
      </tr>
      <tr>
        <td id="L4211" data-line-number="4211"></td>
        <td id="LC4211">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4212" data-line-number="4212"></td>
        <td id="LC4212">                }</td>
      </tr>
      <tr>
        <td id="L4213" data-line-number="4213"></td>
        <td id="LC4213">            }</td>
      </tr>
      <tr>
        <td id="L4214" data-line-number="4214"></td>
        <td id="LC4214">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4215" data-line-number="4215"></td>
        <td id="LC4215">            {</td>
      </tr>
      <tr>
        <td id="L4216" data-line-number="4216"></td>
        <td id="LC4216">                <span>ushort</span> <span>shortLine</span>;</td>
      </tr>
      <tr>
        <td id="L4217" data-line-number="4217"></td>
        <td id="LC4217">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortLine</span>))</td>
      </tr>
      <tr>
        <td id="L4218" data-line-number="4218"></td>
        <td id="LC4218">                {</td>
      </tr>
      <tr>
        <td id="L4219" data-line-number="4219"></td>
        <td id="LC4219">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4220" data-line-number="4220"></td>
        <td id="LC4220">                }</td>
      </tr>
      <tr>
        <td id="L4221" data-line-number="4221"></td>
        <td id="LC4221">                <span>line</span> <span>=</span> <span>shortLine</span>;</td>
      </tr>
      <tr>
        <td id="L4222" data-line-number="4222"></td>
        <td id="LC4222">                <span><span>//</span> If we haven't yet completed processing login token stream yet, we may be talking to a Yukon server</span></td>
      </tr>
      <tr>
        <td id="L4223" data-line-number="4223"></td>
        <td id="LC4223">                <span><span>//</span> In that case we still have to read another 2 bytes</span></td>
      </tr>
      <tr>
        <td id="L4224" data-line-number="4224"></td>
        <td id="LC4224">                <span>if</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span>)</td>
      </tr>
      <tr>
        <td id="L4225" data-line-number="4225"></td>
        <td id="LC4225">                {</td>
      </tr>
      <tr>
        <td id="L4226" data-line-number="4226"></td>
        <td id="LC4226">                    <span><span>//</span> Login incomplete</span></td>
      </tr>
      <tr>
        <td id="L4227" data-line-number="4227"></td>
        <td id="LC4227">                    <span>byte</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L4228" data-line-number="4228"></td>
        <td id="LC4228">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryPeekByte</span>(<span>out</span> <span>b</span>))</td>
      </tr>
      <tr>
        <td id="L4229" data-line-number="4229"></td>
        <td id="LC4229">                    {</td>
      </tr>
      <tr>
        <td id="L4230" data-line-number="4230"></td>
        <td id="LC4230">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4231" data-line-number="4231"></td>
        <td id="LC4231">                    }</td>
      </tr>
      <tr>
        <td id="L4232" data-line-number="4232"></td>
        <td id="LC4232">                    <span>if</span> (<span>b</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4233" data-line-number="4233"></td>
        <td id="LC4233">                    {</td>
      </tr>
      <tr>
        <td id="L4234" data-line-number="4234"></td>
        <td id="LC4234">                        <span><span>//</span> This is an invalid token value</span></td>
      </tr>
      <tr>
        <td id="L4235" data-line-number="4235"></td>
        <td id="LC4235">                        <span>ushort</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L4236" data-line-number="4236"></td>
        <td id="LC4236">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L4237" data-line-number="4237"></td>
        <td id="LC4237">                        {</td>
      </tr>
      <tr>
        <td id="L4238" data-line-number="4238"></td>
        <td id="LC4238">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4239" data-line-number="4239"></td>
        <td id="LC4239">                        }</td>
      </tr>
      <tr>
        <td id="L4240" data-line-number="4240"></td>
        <td id="LC4240">                        <span>line</span> <span>=</span> (<span>line</span> <span>&lt;&lt;</span> <span>16</span>) <span>+</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L4241" data-line-number="4241"></td>
        <td id="LC4241">                    }</td>
      </tr>
      <tr>
        <td id="L4242" data-line-number="4242"></td>
        <td id="LC4242">                }</td>
      </tr>
      <tr>
        <td id="L4243" data-line-number="4243"></td>
        <td id="LC4243">            }</td>
      </tr>
      <tr>
        <td id="L4244" data-line-number="4244"></td>
        <td id="LC4244">
</td>
      </tr>
      <tr>
        <td id="L4245" data-line-number="4245"></td>
        <td id="LC4245">            <span>error</span> <span>=</span> <span>new</span> <span>SqlError</span>(<span>number</span>, <span>state</span>, <span>errorClass</span>, <span>_server</span>, <span>message</span>, <span>procedure</span>, <span>line</span>);</td>
      </tr>
      <tr>
        <td id="L4246" data-line-number="4246"></td>
        <td id="LC4246">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4247" data-line-number="4247"></td>
        <td id="LC4247">        }</td>
      </tr>
      <tr>
        <td id="L4248" data-line-number="4248"></td>
        <td id="LC4248">
</td>
      </tr>
      <tr>
        <td id="L4249" data-line-number="4249"></td>
        <td id="LC4249">
</td>
      </tr>
      <tr>
        <td id="L4250" data-line-number="4250"></td>
        <td id="LC4250">        <span>internal</span> <span>bool</span> <span>TryProcessReturnValue</span>(<span>int</span> <span>length</span>,</td>
      </tr>
      <tr>
        <td id="L4251" data-line-number="4251"></td>
        <td id="LC4251">                                            <span>TdsParserStateObject</span> <span>stateObj</span>,</td>
      </tr>
      <tr>
        <td id="L4252" data-line-number="4252"></td>
        <td id="LC4252">                                            <span>out</span> <span>SqlReturnValue</span> <span>returnValue</span>,</td>
      </tr>
      <tr>
        <td id="L4253" data-line-number="4253"></td>
        <td id="LC4253">                                            <span>SqlCommandColumnEncryptionSetting</span> <span>columnEncryptionSetting</span>)</td>
      </tr>
      <tr>
        <td id="L4254" data-line-number="4254"></td>
        <td id="LC4254">        {</td>
      </tr>
      <tr>
        <td id="L4255" data-line-number="4255"></td>
        <td id="LC4255">            <span>returnValue</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4256" data-line-number="4256"></td>
        <td id="LC4256">            <span>SqlReturnValue</span> <span>rec</span> <span>=</span> <span>new</span> <span>SqlReturnValue</span>();</td>
      </tr>
      <tr>
        <td id="L4257" data-line-number="4257"></td>
        <td id="LC4257">            <span>rec</span>.<span>length</span> <span>=</span> <span>length</span>;        <span><span>//</span> In Yukon this length is -1</span></td>
      </tr>
      <tr>
        <td id="L4258" data-line-number="4258"></td>
        <td id="LC4258">            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L4259" data-line-number="4259"></td>
        <td id="LC4259">            {</td>
      </tr>
      <tr>
        <td id="L4260" data-line-number="4260"></td>
        <td id="LC4260">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>rec</span>.<span>parmIndex</span>))</td>
      </tr>
      <tr>
        <td id="L4261" data-line-number="4261"></td>
        <td id="LC4261">                {</td>
      </tr>
      <tr>
        <td id="L4262" data-line-number="4262"></td>
        <td id="LC4262">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4263" data-line-number="4263"></td>
        <td id="LC4263">                }</td>
      </tr>
      <tr>
        <td id="L4264" data-line-number="4264"></td>
        <td id="LC4264">            }</td>
      </tr>
      <tr>
        <td id="L4265" data-line-number="4265"></td>
        <td id="LC4265">            <span>byte</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L4266" data-line-number="4266"></td>
        <td id="LC4266">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>len</span>))</td>
      </tr>
      <tr>
        <td id="L4267" data-line-number="4267"></td>
        <td id="LC4267">            { <span><span>//</span> Length of parameter name</span></td>
      </tr>
      <tr>
        <td id="L4268" data-line-number="4268"></td>
        <td id="LC4268">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4269" data-line-number="4269"></td>
        <td id="LC4269">            }</td>
      </tr>
      <tr>
        <td id="L4270" data-line-number="4270"></td>
        <td id="LC4270">
</td>
      </tr>
      <tr>
        <td id="L4271" data-line-number="4271"></td>
        <td id="LC4271">            <span>rec</span>.<span>parameter</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4272" data-line-number="4272"></td>
        <td id="LC4272">            <span>if</span> (<span>len</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4273" data-line-number="4273"></td>
        <td id="LC4273">            {</td>
      </tr>
      <tr>
        <td id="L4274" data-line-number="4274"></td>
        <td id="LC4274">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>len</span>, <span>out</span> <span>rec</span>.<span>parameter</span>))</td>
      </tr>
      <tr>
        <td id="L4275" data-line-number="4275"></td>
        <td id="LC4275">                {</td>
      </tr>
      <tr>
        <td id="L4276" data-line-number="4276"></td>
        <td id="LC4276">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4277" data-line-number="4277"></td>
        <td id="LC4277">                }</td>
      </tr>
      <tr>
        <td id="L4278" data-line-number="4278"></td>
        <td id="LC4278">            }</td>
      </tr>
      <tr>
        <td id="L4279" data-line-number="4279"></td>
        <td id="LC4279">
</td>
      </tr>
      <tr>
        <td id="L4280" data-line-number="4280"></td>
        <td id="LC4280">            <span><span>//</span> read status and ignore</span></td>
      </tr>
      <tr>
        <td id="L4281" data-line-number="4281"></td>
        <td id="LC4281">            <span>byte</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L4282" data-line-number="4282"></td>
        <td id="LC4282">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L4283" data-line-number="4283"></td>
        <td id="LC4283">            {</td>
      </tr>
      <tr>
        <td id="L4284" data-line-number="4284"></td>
        <td id="LC4284">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4285" data-line-number="4285"></td>
        <td id="LC4285">            }</td>
      </tr>
      <tr>
        <td id="L4286" data-line-number="4286"></td>
        <td id="LC4286">
</td>
      </tr>
      <tr>
        <td id="L4287" data-line-number="4287"></td>
        <td id="LC4287">            <span>UInt32</span> <span>userType</span>;</td>
      </tr>
      <tr>
        <td id="L4288" data-line-number="4288"></td>
        <td id="LC4288">
</td>
      </tr>
      <tr>
        <td id="L4289" data-line-number="4289"></td>
        <td id="LC4289">            <span><span>//</span> read user type - 4 bytes Yukon, 2 backwards</span></td>
      </tr>
      <tr>
        <td id="L4290" data-line-number="4290"></td>
        <td id="LC4290">            <span>if</span> (<span>IsYukonOrNewer</span>)</td>
      </tr>
      <tr>
        <td id="L4291" data-line-number="4291"></td>
        <td id="LC4291">            {</td>
      </tr>
      <tr>
        <td id="L4292" data-line-number="4292"></td>
        <td id="LC4292">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>userType</span>))</td>
      </tr>
      <tr>
        <td id="L4293" data-line-number="4293"></td>
        <td id="LC4293">                {</td>
      </tr>
      <tr>
        <td id="L4294" data-line-number="4294"></td>
        <td id="LC4294">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4295" data-line-number="4295"></td>
        <td id="LC4295">                }</td>
      </tr>
      <tr>
        <td id="L4296" data-line-number="4296"></td>
        <td id="LC4296">            }</td>
      </tr>
      <tr>
        <td id="L4297" data-line-number="4297"></td>
        <td id="LC4297">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4298" data-line-number="4298"></td>
        <td id="LC4298">            {</td>
      </tr>
      <tr>
        <td id="L4299" data-line-number="4299"></td>
        <td id="LC4299">                <span>ushort</span> <span>userTypeShort</span>;</td>
      </tr>
      <tr>
        <td id="L4300" data-line-number="4300"></td>
        <td id="LC4300">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>userTypeShort</span>))</td>
      </tr>
      <tr>
        <td id="L4301" data-line-number="4301"></td>
        <td id="LC4301">                {</td>
      </tr>
      <tr>
        <td id="L4302" data-line-number="4302"></td>
        <td id="LC4302">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4303" data-line-number="4303"></td>
        <td id="LC4303">                }</td>
      </tr>
      <tr>
        <td id="L4304" data-line-number="4304"></td>
        <td id="LC4304">                <span>userType</span> <span>=</span> <span>userTypeShort</span>;</td>
      </tr>
      <tr>
        <td id="L4305" data-line-number="4305"></td>
        <td id="LC4305">            }</td>
      </tr>
      <tr>
        <td id="L4306" data-line-number="4306"></td>
        <td id="LC4306">
</td>
      </tr>
      <tr>
        <td id="L4307" data-line-number="4307"></td>
        <td id="LC4307">            <span><span>//</span> Read off the flags.</span></td>
      </tr>
      <tr>
        <td id="L4308" data-line-number="4308"></td>
        <td id="LC4308">            <span><span>//</span> The first byte is ignored since it doesn't contain any interesting information.</span></td>
      </tr>
      <tr>
        <td id="L4309" data-line-number="4309"></td>
        <td id="LC4309">            <span>byte</span> <span>flags</span>;</td>
      </tr>
      <tr>
        <td id="L4310" data-line-number="4310"></td>
        <td id="LC4310">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>flags</span>))</td>
      </tr>
      <tr>
        <td id="L4311" data-line-number="4311"></td>
        <td id="LC4311">            {</td>
      </tr>
      <tr>
        <td id="L4312" data-line-number="4312"></td>
        <td id="LC4312">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4313" data-line-number="4313"></td>
        <td id="LC4313">            }</td>
      </tr>
      <tr>
        <td id="L4314" data-line-number="4314"></td>
        <td id="LC4314">
</td>
      </tr>
      <tr>
        <td id="L4315" data-line-number="4315"></td>
        <td id="LC4315">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>flags</span>))</td>
      </tr>
      <tr>
        <td id="L4316" data-line-number="4316"></td>
        <td id="LC4316">            {</td>
      </tr>
      <tr>
        <td id="L4317" data-line-number="4317"></td>
        <td id="LC4317">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4318" data-line-number="4318"></td>
        <td id="LC4318">            }</td>
      </tr>
      <tr>
        <td id="L4319" data-line-number="4319"></td>
        <td id="LC4319">
</td>
      </tr>
      <tr>
        <td id="L4320" data-line-number="4320"></td>
        <td id="LC4320">            <span><span>//</span> Check if the column is encrypted.</span></td>
      </tr>
      <tr>
        <td id="L4321" data-line-number="4321"></td>
        <td id="LC4321">            <span>if</span> (<span>_serverSupportsColumnEncryption</span>)</td>
      </tr>
      <tr>
        <td id="L4322" data-line-number="4322"></td>
        <td id="LC4322">            {</td>
      </tr>
      <tr>
        <td id="L4323" data-line-number="4323"></td>
        <td id="LC4323">                <span>rec</span>.<span>isEncrypted</span> <span>=</span> (<span>TdsEnums</span>.<span>IsEncrypted</span> <span>==</span> (<span>flags</span> <span>&amp;</span> <span>TdsEnums</span>.<span>IsEncrypted</span>));</td>
      </tr>
      <tr>
        <td id="L4324" data-line-number="4324"></td>
        <td id="LC4324">            }</td>
      </tr>
      <tr>
        <td id="L4325" data-line-number="4325"></td>
        <td id="LC4325">
</td>
      </tr>
      <tr>
        <td id="L4326" data-line-number="4326"></td>
        <td id="LC4326">            <span><span>//</span> read the type</span></td>
      </tr>
      <tr>
        <td id="L4327" data-line-number="4327"></td>
        <td id="LC4327">            <span>byte</span> <span>tdsType</span>;</td>
      </tr>
      <tr>
        <td id="L4328" data-line-number="4328"></td>
        <td id="LC4328">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>tdsType</span>))</td>
      </tr>
      <tr>
        <td id="L4329" data-line-number="4329"></td>
        <td id="LC4329">            {</td>
      </tr>
      <tr>
        <td id="L4330" data-line-number="4330"></td>
        <td id="LC4330">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4331" data-line-number="4331"></td>
        <td id="LC4331">            }</td>
      </tr>
      <tr>
        <td id="L4332" data-line-number="4332"></td>
        <td id="LC4332">
</td>
      </tr>
      <tr>
        <td id="L4333" data-line-number="4333"></td>
        <td id="LC4333">            <span><span>//</span> read the MaxLen</span></td>
      </tr>
      <tr>
        <td id="L4334" data-line-number="4334"></td>
        <td id="LC4334">            <span><span>//</span> For xml datatpyes, there is no tokenLength</span></td>
      </tr>
      <tr>
        <td id="L4335" data-line-number="4335"></td>
        <td id="LC4335">            <span>int</span> <span>tdsLen</span>;</td>
      </tr>
      <tr>
        <td id="L4336" data-line-number="4336"></td>
        <td id="LC4336">
</td>
      </tr>
      <tr>
        <td id="L4337" data-line-number="4337"></td>
        <td id="LC4337">            <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>)</td>
      </tr>
      <tr>
        <td id="L4338" data-line-number="4338"></td>
        <td id="LC4338">            {</td>
      </tr>
      <tr>
        <td id="L4339" data-line-number="4339"></td>
        <td id="LC4339">                <span>tdsLen</span> <span>=</span> <span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>;</td>
      </tr>
      <tr>
        <td id="L4340" data-line-number="4340"></td>
        <td id="LC4340">            }</td>
      </tr>
      <tr>
        <td id="L4341" data-line-number="4341"></td>
        <td id="LC4341">            <span>else</span> <span>if</span> (<span>IsVarTimeTds</span>(<span>tdsType</span>))</td>
      </tr>
      <tr>
        <td id="L4342" data-line-number="4342"></td>
        <td id="LC4342">                <span>tdsLen</span> <span>=</span> <span>0</span>;  <span><span>//</span> placeholder until we read the scale, just make sure it's not SQL_USHORTVARMAXLEN</span></td>
      </tr>
      <tr>
        <td id="L4343" data-line-number="4343"></td>
        <td id="LC4343">            <span>else</span> <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDATE</span>)</td>
      </tr>
      <tr>
        <td id="L4344" data-line-number="4344"></td>
        <td id="LC4344">            {</td>
      </tr>
      <tr>
        <td id="L4345" data-line-number="4345"></td>
        <td id="LC4345">                <span>tdsLen</span> <span>=</span> <span>3</span>;</td>
      </tr>
      <tr>
        <td id="L4346" data-line-number="4346"></td>
        <td id="LC4346">            }</td>
      </tr>
      <tr>
        <td id="L4347" data-line-number="4347"></td>
        <td id="LC4347">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4348" data-line-number="4348"></td>
        <td id="LC4348">            {</td>
      </tr>
      <tr>
        <td id="L4349" data-line-number="4349"></td>
        <td id="LC4349">                <span>if</span> (<span>!</span><span>TryGetTokenLength</span>(<span>tdsType</span>, <span>stateObj</span>, <span>out</span> <span>tdsLen</span>))</td>
      </tr>
      <tr>
        <td id="L4350" data-line-number="4350"></td>
        <td id="LC4350">                {</td>
      </tr>
      <tr>
        <td id="L4351" data-line-number="4351"></td>
        <td id="LC4351">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4352" data-line-number="4352"></td>
        <td id="LC4352">                }</td>
      </tr>
      <tr>
        <td id="L4353" data-line-number="4353"></td>
        <td id="LC4353">            }</td>
      </tr>
      <tr>
        <td id="L4354" data-line-number="4354"></td>
        <td id="LC4354">
</td>
      </tr>
      <tr>
        <td id="L4355" data-line-number="4355"></td>
        <td id="LC4355">            <span>rec</span>.<span>metaType</span> <span>=</span> <span>MetaType</span>.<span>GetSqlDataType</span>(<span>tdsType</span>, <span>userType</span>, <span>tdsLen</span>);</td>
      </tr>
      <tr>
        <td id="L4356" data-line-number="4356"></td>
        <td id="LC4356">            <span>rec</span>.<span>type</span> <span>=</span> <span>rec</span>.<span>metaType</span>.<span>SqlDbType</span>;</td>
      </tr>
      <tr>
        <td id="L4357" data-line-number="4357"></td>
        <td id="LC4357">
</td>
      </tr>
      <tr>
        <td id="L4358" data-line-number="4358"></td>
        <td id="LC4358">            <span><span>//</span> always use the nullable type for parameters if Shiloh or later</span></td>
      </tr>
      <tr>
        <td id="L4359" data-line-number="4359"></td>
        <td id="LC4359">            <span><span>//</span> Sphinx sometimes sends fixed length return values</span></td>
      </tr>
      <tr>
        <td id="L4360" data-line-number="4360"></td>
        <td id="LC4360">            <span>if</span> (<span>_isShiloh</span>)</td>
      </tr>
      <tr>
        <td id="L4361" data-line-number="4361"></td>
        <td id="LC4361">            {</td>
      </tr>
      <tr>
        <td id="L4362" data-line-number="4362"></td>
        <td id="LC4362">                <span>rec</span>.<span>tdsType</span> <span>=</span> <span>rec</span>.<span>metaType</span>.<span>NullableType</span>;</td>
      </tr>
      <tr>
        <td id="L4363" data-line-number="4363"></td>
        <td id="LC4363">                <span>rec</span>.<span>IsNullable</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4364" data-line-number="4364"></td>
        <td id="LC4364">                <span>if</span> (<span>tdsLen</span> <span>==</span> <span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>)</td>
      </tr>
      <tr>
        <td id="L4365" data-line-number="4365"></td>
        <td id="LC4365">                {</td>
      </tr>
      <tr>
        <td id="L4366" data-line-number="4366"></td>
        <td id="LC4366">                    <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>plp data from pre-Yukon server<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4367" data-line-number="4367"></td>
        <td id="LC4367">                    <span>rec</span>.<span>metaType</span> <span>=</span> <span>MetaType</span>.<span>GetMaxMetaTypeFromMetaType</span>(<span>rec</span>.<span>metaType</span>);</td>
      </tr>
      <tr>
        <td id="L4368" data-line-number="4368"></td>
        <td id="LC4368">                }</td>
      </tr>
      <tr>
        <td id="L4369" data-line-number="4369"></td>
        <td id="LC4369">            }</td>
      </tr>
      <tr>
        <td id="L4370" data-line-number="4370"></td>
        <td id="LC4370">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4371" data-line-number="4371"></td>
        <td id="LC4371">            {      <span><span>//</span> For sphinx, keep the fixed type if that is what is returned</span></td>
      </tr>
      <tr>
        <td id="L4372" data-line-number="4372"></td>
        <td id="LC4372">                <span>if</span> (<span>rec</span>.<span>metaType</span>.<span>NullableType</span> <span>==</span> <span>tdsType</span>)</td>
      </tr>
      <tr>
        <td id="L4373" data-line-number="4373"></td>
        <td id="LC4373">                    <span>rec</span>.<span>IsNullable</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4374" data-line-number="4374"></td>
        <td id="LC4374">
</td>
      </tr>
      <tr>
        <td id="L4375" data-line-number="4375"></td>
        <td id="LC4375">                <span>rec</span>.<span>tdsType</span> <span>=</span> (<span>byte</span>)<span>tdsType</span>;</td>
      </tr>
      <tr>
        <td id="L4376" data-line-number="4376"></td>
        <td id="LC4376">            }</td>
      </tr>
      <tr>
        <td id="L4377" data-line-number="4377"></td>
        <td id="LC4377">
</td>
      </tr>
      <tr>
        <td id="L4378" data-line-number="4378"></td>
        <td id="LC4378">            <span>if</span> (<span>rec</span>.<span>type</span> <span>==</span> <span>SqlDbType</span>.<span>Decimal</span>)</td>
      </tr>
      <tr>
        <td id="L4379" data-line-number="4379"></td>
        <td id="LC4379">            {</td>
      </tr>
      <tr>
        <td id="L4380" data-line-number="4380"></td>
        <td id="LC4380">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>rec</span>.<span>precision</span>))</td>
      </tr>
      <tr>
        <td id="L4381" data-line-number="4381"></td>
        <td id="LC4381">                {</td>
      </tr>
      <tr>
        <td id="L4382" data-line-number="4382"></td>
        <td id="LC4382">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4383" data-line-number="4383"></td>
        <td id="LC4383">                }</td>
      </tr>
      <tr>
        <td id="L4384" data-line-number="4384"></td>
        <td id="LC4384">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>rec</span>.<span>scale</span>))</td>
      </tr>
      <tr>
        <td id="L4385" data-line-number="4385"></td>
        <td id="LC4385">                {</td>
      </tr>
      <tr>
        <td id="L4386" data-line-number="4386"></td>
        <td id="LC4386">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4387" data-line-number="4387"></td>
        <td id="LC4387">                }</td>
      </tr>
      <tr>
        <td id="L4388" data-line-number="4388"></td>
        <td id="LC4388">            }</td>
      </tr>
      <tr>
        <td id="L4389" data-line-number="4389"></td>
        <td id="LC4389">
</td>
      </tr>
      <tr>
        <td id="L4390" data-line-number="4390"></td>
        <td id="LC4390">            <span>if</span> (<span>rec</span>.<span>metaType</span>.<span>IsVarTime</span>)</td>
      </tr>
      <tr>
        <td id="L4391" data-line-number="4391"></td>
        <td id="LC4391">            {</td>
      </tr>
      <tr>
        <td id="L4392" data-line-number="4392"></td>
        <td id="LC4392">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>rec</span>.<span>scale</span>))</td>
      </tr>
      <tr>
        <td id="L4393" data-line-number="4393"></td>
        <td id="LC4393">                {</td>
      </tr>
      <tr>
        <td id="L4394" data-line-number="4394"></td>
        <td id="LC4394">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4395" data-line-number="4395"></td>
        <td id="LC4395">                }</td>
      </tr>
      <tr>
        <td id="L4396" data-line-number="4396"></td>
        <td id="LC4396">            }</td>
      </tr>
      <tr>
        <td id="L4397" data-line-number="4397"></td>
        <td id="LC4397">
</td>
      </tr>
      <tr>
        <td id="L4398" data-line-number="4398"></td>
        <td id="LC4398">            <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLUDT</span>)</td>
      </tr>
      <tr>
        <td id="L4399" data-line-number="4399"></td>
        <td id="LC4399">            {</td>
      </tr>
      <tr>
        <td id="L4400" data-line-number="4400"></td>
        <td id="LC4400">                <span>if</span> (<span>!</span><span>TryProcessUDTMetaData</span>((<span>SqlMetaDataPriv</span>)<span>rec</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L4401" data-line-number="4401"></td>
        <td id="LC4401">                {</td>
      </tr>
      <tr>
        <td id="L4402" data-line-number="4402"></td>
        <td id="LC4402">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4403" data-line-number="4403"></td>
        <td id="LC4403">                }</td>
      </tr>
      <tr>
        <td id="L4404" data-line-number="4404"></td>
        <td id="LC4404">            }</td>
      </tr>
      <tr>
        <td id="L4405" data-line-number="4405"></td>
        <td id="LC4405">
</td>
      </tr>
      <tr>
        <td id="L4406" data-line-number="4406"></td>
        <td id="LC4406">            <span>if</span> (<span>rec</span>.<span>type</span> <span>==</span> <span>SqlDbType</span>.<span>Xml</span>)</td>
      </tr>
      <tr>
        <td id="L4407" data-line-number="4407"></td>
        <td id="LC4407">            {</td>
      </tr>
      <tr>
        <td id="L4408" data-line-number="4408"></td>
        <td id="LC4408">                <span><span>//</span> Read schema info</span></td>
      </tr>
      <tr>
        <td id="L4409" data-line-number="4409"></td>
        <td id="LC4409">                <span>byte</span> <span>schemapresent</span>;</td>
      </tr>
      <tr>
        <td id="L4410" data-line-number="4410"></td>
        <td id="LC4410">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>schemapresent</span>))</td>
      </tr>
      <tr>
        <td id="L4411" data-line-number="4411"></td>
        <td id="LC4411">                {</td>
      </tr>
      <tr>
        <td id="L4412" data-line-number="4412"></td>
        <td id="LC4412">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4413" data-line-number="4413"></td>
        <td id="LC4413">                }</td>
      </tr>
      <tr>
        <td id="L4414" data-line-number="4414"></td>
        <td id="LC4414">
</td>
      </tr>
      <tr>
        <td id="L4415" data-line-number="4415"></td>
        <td id="LC4415">                <span>if</span> ((<span>schemapresent</span> <span>&amp;</span> <span>1</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4416" data-line-number="4416"></td>
        <td id="LC4416">                {</td>
      </tr>
      <tr>
        <td id="L4417" data-line-number="4417"></td>
        <td id="LC4417">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>len</span>))</td>
      </tr>
      <tr>
        <td id="L4418" data-line-number="4418"></td>
        <td id="LC4418">                    {</td>
      </tr>
      <tr>
        <td id="L4419" data-line-number="4419"></td>
        <td id="LC4419">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4420" data-line-number="4420"></td>
        <td id="LC4420">                    }</td>
      </tr>
      <tr>
        <td id="L4421" data-line-number="4421"></td>
        <td id="LC4421">                    <span>if</span> (<span>rec</span>.<span>xmlSchemaCollection</span> <span>is</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L4422" data-line-number="4422"></td>
        <td id="LC4422">                    {</td>
      </tr>
      <tr>
        <td id="L4423" data-line-number="4423"></td>
        <td id="LC4423">                        <span>rec</span>.<span>xmlSchemaCollection</span> <span>=</span> <span>new</span> <span>SqlMetaDataXmlSchemaCollection</span>();</td>
      </tr>
      <tr>
        <td id="L4424" data-line-number="4424"></td>
        <td id="LC4424">                    }</td>
      </tr>
      <tr>
        <td id="L4425" data-line-number="4425"></td>
        <td id="LC4425">                    <span>if</span> (<span>len</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4426" data-line-number="4426"></td>
        <td id="LC4426">                    {</td>
      </tr>
      <tr>
        <td id="L4427" data-line-number="4427"></td>
        <td id="LC4427">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>len</span>, <span>out</span> <span>rec</span>.<span>xmlSchemaCollection</span>.<span>Database</span>))</td>
      </tr>
      <tr>
        <td id="L4428" data-line-number="4428"></td>
        <td id="LC4428">                        {</td>
      </tr>
      <tr>
        <td id="L4429" data-line-number="4429"></td>
        <td id="LC4429">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4430" data-line-number="4430"></td>
        <td id="LC4430">                        }</td>
      </tr>
      <tr>
        <td id="L4431" data-line-number="4431"></td>
        <td id="LC4431">                    }</td>
      </tr>
      <tr>
        <td id="L4432" data-line-number="4432"></td>
        <td id="LC4432">
</td>
      </tr>
      <tr>
        <td id="L4433" data-line-number="4433"></td>
        <td id="LC4433">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>len</span>))</td>
      </tr>
      <tr>
        <td id="L4434" data-line-number="4434"></td>
        <td id="LC4434">                    {</td>
      </tr>
      <tr>
        <td id="L4435" data-line-number="4435"></td>
        <td id="LC4435">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4436" data-line-number="4436"></td>
        <td id="LC4436">                    }</td>
      </tr>
      <tr>
        <td id="L4437" data-line-number="4437"></td>
        <td id="LC4437">                    <span>if</span> (<span>len</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4438" data-line-number="4438"></td>
        <td id="LC4438">                    {</td>
      </tr>
      <tr>
        <td id="L4439" data-line-number="4439"></td>
        <td id="LC4439">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>len</span>, <span>out</span> <span>rec</span>.<span>xmlSchemaCollection</span>.<span>OwningSchema</span>))</td>
      </tr>
      <tr>
        <td id="L4440" data-line-number="4440"></td>
        <td id="LC4440">                        {</td>
      </tr>
      <tr>
        <td id="L4441" data-line-number="4441"></td>
        <td id="LC4441">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4442" data-line-number="4442"></td>
        <td id="LC4442">                        }</td>
      </tr>
      <tr>
        <td id="L4443" data-line-number="4443"></td>
        <td id="LC4443">                    }</td>
      </tr>
      <tr>
        <td id="L4444" data-line-number="4444"></td>
        <td id="LC4444">
</td>
      </tr>
      <tr>
        <td id="L4445" data-line-number="4445"></td>
        <td id="LC4445">                    <span>short</span> <span>slen</span>;</td>
      </tr>
      <tr>
        <td id="L4446" data-line-number="4446"></td>
        <td id="LC4446">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt16</span>(<span>out</span> <span>slen</span>))</td>
      </tr>
      <tr>
        <td id="L4447" data-line-number="4447"></td>
        <td id="LC4447">                    {</td>
      </tr>
      <tr>
        <td id="L4448" data-line-number="4448"></td>
        <td id="LC4448">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4449" data-line-number="4449"></td>
        <td id="LC4449">                    }</td>
      </tr>
      <tr>
        <td id="L4450" data-line-number="4450"></td>
        <td id="LC4450">
</td>
      </tr>
      <tr>
        <td id="L4451" data-line-number="4451"></td>
        <td id="LC4451">                    <span>if</span> (<span>slen</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4452" data-line-number="4452"></td>
        <td id="LC4452">                    {</td>
      </tr>
      <tr>
        <td id="L4453" data-line-number="4453"></td>
        <td id="LC4453">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>slen</span>, <span>out</span> <span>rec</span>.<span>xmlSchemaCollection</span>.<span>Name</span>))</td>
      </tr>
      <tr>
        <td id="L4454" data-line-number="4454"></td>
        <td id="LC4454">                        {</td>
      </tr>
      <tr>
        <td id="L4455" data-line-number="4455"></td>
        <td id="LC4455">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4456" data-line-number="4456"></td>
        <td id="LC4456">                        }</td>
      </tr>
      <tr>
        <td id="L4457" data-line-number="4457"></td>
        <td id="LC4457">                    }</td>
      </tr>
      <tr>
        <td id="L4458" data-line-number="4458"></td>
        <td id="LC4458">
</td>
      </tr>
      <tr>
        <td id="L4459" data-line-number="4459"></td>
        <td id="LC4459">                }</td>
      </tr>
      <tr>
        <td id="L4460" data-line-number="4460"></td>
        <td id="LC4460">            }</td>
      </tr>
      <tr>
        <td id="L4461" data-line-number="4461"></td>
        <td id="LC4461">            <span>else</span> <span>if</span> (<span>_isShiloh</span> <span>&amp;&amp;</span> <span>rec</span>.<span>metaType</span>.<span>IsCharType</span>)</td>
      </tr>
      <tr>
        <td id="L4462" data-line-number="4462"></td>
        <td id="LC4462">            {</td>
      </tr>
      <tr>
        <td id="L4463" data-line-number="4463"></td>
        <td id="LC4463">                <span><span>//</span> read the collation for 8.x servers</span></td>
      </tr>
      <tr>
        <td id="L4464" data-line-number="4464"></td>
        <td id="LC4464">                <span>if</span> (<span>!</span><span>TryProcessCollation</span>(<span>stateObj</span>, <span>out</span> <span>rec</span>.<span>collation</span>))</td>
      </tr>
      <tr>
        <td id="L4465" data-line-number="4465"></td>
        <td id="LC4465">                {</td>
      </tr>
      <tr>
        <td id="L4466" data-line-number="4466"></td>
        <td id="LC4466">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4467" data-line-number="4467"></td>
        <td id="LC4467">                }</td>
      </tr>
      <tr>
        <td id="L4468" data-line-number="4468"></td>
        <td id="LC4468">
</td>
      </tr>
      <tr>
        <td id="L4469" data-line-number="4469"></td>
        <td id="LC4469">                <span>if</span> ((<span>rec</span>.<span>collation</span>.<span>info</span> <span>&amp;</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>) <span>==</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>)</td>
      </tr>
      <tr>
        <td id="L4470" data-line-number="4470"></td>
        <td id="LC4470">                { <span><span>//</span> UTF8 collation</span></td>
      </tr>
      <tr>
        <td id="L4471" data-line-number="4471"></td>
        <td id="LC4471">                    <span>rec</span>.<span>encoding</span> <span>=</span> <span>Encoding</span>.<span>UTF8</span>;</td>
      </tr>
      <tr>
        <td id="L4472" data-line-number="4472"></td>
        <td id="LC4472">                }</td>
      </tr>
      <tr>
        <td id="L4473" data-line-number="4473"></td>
        <td id="LC4473">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L4474" data-line-number="4474"></td>
        <td id="LC4474">                {</td>
      </tr>
      <tr>
        <td id="L4475" data-line-number="4475"></td>
        <td id="LC4475">                    <span>int</span> <span>codePage</span> <span>=</span> <span>GetCodePage</span>(<span>rec</span>.<span>collation</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L4476" data-line-number="4476"></td>
        <td id="LC4476">
</td>
      </tr>
      <tr>
        <td id="L4477" data-line-number="4477"></td>
        <td id="LC4477">                    <span><span>//</span> if the column lcid is the same as the default, use the default encoder</span></td>
      </tr>
      <tr>
        <td id="L4478" data-line-number="4478"></td>
        <td id="LC4478">                    <span>if</span> (<span>codePage</span> <span>==</span> <span>_defaultCodePage</span>)</td>
      </tr>
      <tr>
        <td id="L4479" data-line-number="4479"></td>
        <td id="LC4479">                    {</td>
      </tr>
      <tr>
        <td id="L4480" data-line-number="4480"></td>
        <td id="LC4480">                        <span>rec</span>.<span>codePage</span> <span>=</span> <span>_defaultCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L4481" data-line-number="4481"></td>
        <td id="LC4481">                        <span>rec</span>.<span>encoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L4482" data-line-number="4482"></td>
        <td id="LC4482">                    }</td>
      </tr>
      <tr>
        <td id="L4483" data-line-number="4483"></td>
        <td id="LC4483">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L4484" data-line-number="4484"></td>
        <td id="LC4484">                    {</td>
      </tr>
      <tr>
        <td id="L4485" data-line-number="4485"></td>
        <td id="LC4485">                        <span>rec</span>.<span>codePage</span> <span>=</span> <span>codePage</span>;</td>
      </tr>
      <tr>
        <td id="L4486" data-line-number="4486"></td>
        <td id="LC4486">                        <span>rec</span>.<span>encoding</span> <span>=</span> <span>System</span>.<span>Text</span>.<span>Encoding</span>.<span>GetEncoding</span>(<span>rec</span>.<span>codePage</span>);</td>
      </tr>
      <tr>
        <td id="L4487" data-line-number="4487"></td>
        <td id="LC4487">                    }</td>
      </tr>
      <tr>
        <td id="L4488" data-line-number="4488"></td>
        <td id="LC4488">                }</td>
      </tr>
      <tr>
        <td id="L4489" data-line-number="4489"></td>
        <td id="LC4489">            }</td>
      </tr>
      <tr>
        <td id="L4490" data-line-number="4490"></td>
        <td id="LC4490">
</td>
      </tr>
      <tr>
        <td id="L4491" data-line-number="4491"></td>
        <td id="LC4491">            <span><span>//</span> For encrypted parameters, read the unencrypted type and encryption information.</span></td>
      </tr>
      <tr>
        <td id="L4492" data-line-number="4492"></td>
        <td id="LC4492">            <span>if</span> (<span>_serverSupportsColumnEncryption</span> <span>&amp;&amp;</span> <span>rec</span>.<span>isEncrypted</span>)</td>
      </tr>
      <tr>
        <td id="L4493" data-line-number="4493"></td>
        <td id="LC4493">            {</td>
      </tr>
      <tr>
        <td id="L4494" data-line-number="4494"></td>
        <td id="LC4494">                <span>if</span> (<span>!</span><span>TryProcessTceCryptoMetadata</span>(<span>stateObj</span>, <span>rec</span>, <span>cipherTable</span>: <span>null</span>, <span>columnEncryptionSetting</span>: <span>columnEncryptionSetting</span>, <span>isReturnValue</span>: <span>true</span>))</td>
      </tr>
      <tr>
        <td id="L4495" data-line-number="4495"></td>
        <td id="LC4495">                {</td>
      </tr>
      <tr>
        <td id="L4496" data-line-number="4496"></td>
        <td id="LC4496">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4497" data-line-number="4497"></td>
        <td id="LC4497">                }</td>
      </tr>
      <tr>
        <td id="L4498" data-line-number="4498"></td>
        <td id="LC4498">            }</td>
      </tr>
      <tr>
        <td id="L4499" data-line-number="4499"></td>
        <td id="LC4499">
</td>
      </tr>
      <tr>
        <td id="L4500" data-line-number="4500"></td>
        <td id="LC4500">            <span><span>//</span> for now we coerce return values into a SQLVariant, not good...</span></td>
      </tr>
      <tr>
        <td id="L4501" data-line-number="4501"></td>
        <td id="LC4501">            <span>bool</span> <span>isNull</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4502" data-line-number="4502"></td>
        <td id="LC4502">            <span>ulong</span> <span>valLen</span>;</td>
      </tr>
      <tr>
        <td id="L4503" data-line-number="4503"></td>
        <td id="LC4503">            <span>if</span> (<span>!</span><span>TryProcessColumnHeaderNoNBC</span>(<span>rec</span>, <span>stateObj</span>, <span>out</span> <span>isNull</span>, <span>out</span> <span>valLen</span>))</td>
      </tr>
      <tr>
        <td id="L4504" data-line-number="4504"></td>
        <td id="LC4504">            {</td>
      </tr>
      <tr>
        <td id="L4505" data-line-number="4505"></td>
        <td id="LC4505">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4506" data-line-number="4506"></td>
        <td id="LC4506">            }</td>
      </tr>
      <tr>
        <td id="L4507" data-line-number="4507"></td>
        <td id="LC4507">
</td>
      </tr>
      <tr>
        <td id="L4508" data-line-number="4508"></td>
        <td id="LC4508">            <span><span>//</span> always read as sql types</span></td>
      </tr>
      <tr>
        <td id="L4509" data-line-number="4509"></td>
        <td id="LC4509">            <span>Debug</span>.<span>Assert</span>(<span>valLen</span> <span>&lt;</span> (<span>ulong</span>)(<span>Int32</span>.<span>MaxValue</span>), <span><span>"</span>ProcessReturnValue received data size &gt; 2Gb<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4510" data-line-number="4510"></td>
        <td id="LC4510">
</td>
      </tr>
      <tr>
        <td id="L4511" data-line-number="4511"></td>
        <td id="LC4511">            <span>int</span> <span>intlen</span> <span>=</span> <span>valLen</span> <span>&gt;</span> (<span>ulong</span>)(<span>Int32</span>.<span>MaxValue</span>) <span>?</span> <span>Int32</span>.<span>MaxValue</span> <span>:</span> (<span>int</span>)<span>valLen</span>;</td>
      </tr>
      <tr>
        <td id="L4512" data-line-number="4512"></td>
        <td id="LC4512">
</td>
      </tr>
      <tr>
        <td id="L4513" data-line-number="4513"></td>
        <td id="LC4513">            <span>if</span> (<span>rec</span>.<span>metaType</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L4514" data-line-number="4514"></td>
        <td id="LC4514">            {</td>
      </tr>
      <tr>
        <td id="L4515" data-line-number="4515"></td>
        <td id="LC4515">                <span>intlen</span> <span>=</span> <span>Int32</span>.<span>MaxValue</span>;    <span><span>//</span> If plp data, read it all</span></td>
      </tr>
      <tr>
        <td id="L4516" data-line-number="4516"></td>
        <td id="LC4516">            }</td>
      </tr>
      <tr>
        <td id="L4517" data-line-number="4517"></td>
        <td id="LC4517">
</td>
      </tr>
      <tr>
        <td id="L4518" data-line-number="4518"></td>
        <td id="LC4518">            <span>if</span> (<span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L4519" data-line-number="4519"></td>
        <td id="LC4519">            {</td>
      </tr>
      <tr>
        <td id="L4520" data-line-number="4520"></td>
        <td id="LC4520">                <span>GetNullSqlValue</span>(<span>rec</span>.<span>value</span>, <span>rec</span>, <span>SqlCommandColumnEncryptionSetting</span>.<span>Disabled</span>, <span>_connHandler</span>);</td>
      </tr>
      <tr>
        <td id="L4521" data-line-number="4521"></td>
        <td id="LC4521">            }</td>
      </tr>
      <tr>
        <td id="L4522" data-line-number="4522"></td>
        <td id="LC4522">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4523" data-line-number="4523"></td>
        <td id="LC4523">            {</td>
      </tr>
      <tr>
        <td id="L4524" data-line-number="4524"></td>
        <td id="LC4524">                <span><span>//</span> We should never do any decryption here, so pass disabled as the command encryption override.</span></td>
      </tr>
      <tr>
        <td id="L4525" data-line-number="4525"></td>
        <td id="LC4525">                <span><span>//</span> We only read the binary value and decryption will be performed by OnReturnValue().</span></td>
      </tr>
      <tr>
        <td id="L4526" data-line-number="4526"></td>
        <td id="LC4526">                <span>if</span> (<span>!</span><span>TryReadSqlValue</span>(<span>rec</span>.<span>value</span>, <span>rec</span>, <span>intlen</span>, <span>stateObj</span>, <span>SqlCommandColumnEncryptionSetting</span>.<span>Disabled</span>, <span>columnName</span>: <span>null</span> <span><span>/*</span>Not used<span>*/</span></span>))</td>
      </tr>
      <tr>
        <td id="L4527" data-line-number="4527"></td>
        <td id="LC4527">                {</td>
      </tr>
      <tr>
        <td id="L4528" data-line-number="4528"></td>
        <td id="LC4528">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4529" data-line-number="4529"></td>
        <td id="LC4529">                }</td>
      </tr>
      <tr>
        <td id="L4530" data-line-number="4530"></td>
        <td id="LC4530">            }</td>
      </tr>
      <tr>
        <td id="L4531" data-line-number="4531"></td>
        <td id="LC4531">
</td>
      </tr>
      <tr>
        <td id="L4532" data-line-number="4532"></td>
        <td id="LC4532">            <span>returnValue</span> <span>=</span> <span>rec</span>;</td>
      </tr>
      <tr>
        <td id="L4533" data-line-number="4533"></td>
        <td id="LC4533">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4534" data-line-number="4534"></td>
        <td id="LC4534">        }</td>
      </tr>
      <tr>
        <td id="L4535" data-line-number="4535"></td>
        <td id="LC4535">
</td>
      </tr>
      <tr>
        <td id="L4536" data-line-number="4536"></td>
        <td id="LC4536">        <span>internal</span> <span>bool</span> <span>TryProcessTceCryptoMetadata</span>(<span>TdsParserStateObject</span> <span>stateObj</span>,</td>
      </tr>
      <tr>
        <td id="L4537" data-line-number="4537"></td>
        <td id="LC4537">            <span>SqlMetaDataPriv</span> <span>col</span>,</td>
      </tr>
      <tr>
        <td id="L4538" data-line-number="4538"></td>
        <td id="LC4538">            <span>SqlTceCipherInfoTable</span>? <span>cipherTable</span>,</td>
      </tr>
      <tr>
        <td id="L4539" data-line-number="4539"></td>
        <td id="LC4539">            <span>SqlCommandColumnEncryptionSetting</span> <span>columnEncryptionSetting</span>,</td>
      </tr>
      <tr>
        <td id="L4540" data-line-number="4540"></td>
        <td id="LC4540">            <span>bool</span> <span>isReturnValue</span>)</td>
      </tr>
      <tr>
        <td id="L4541" data-line-number="4541"></td>
        <td id="LC4541">        {</td>
      </tr>
      <tr>
        <td id="L4542" data-line-number="4542"></td>
        <td id="LC4542">            <span>Debug</span>.<span>Assert</span>(<span>isReturnValue</span> <span>==</span> (<span>cipherTable</span> <span>==</span> <span>null</span>), <span><span>"</span>Ciphertable is not set iff this is a return value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4543" data-line-number="4543"></td>
        <td id="LC4543">
</td>
      </tr>
      <tr>
        <td id="L4544" data-line-number="4544"></td>
        <td id="LC4544">            <span><span>//</span> Read the ordinal into cipher table</span></td>
      </tr>
      <tr>
        <td id="L4545" data-line-number="4545"></td>
        <td id="LC4545">            <span>ushort</span> <span>index</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L4546" data-line-number="4546"></td>
        <td id="LC4546">            <span>UInt32</span> <span>userType</span>;</td>
      </tr>
      <tr>
        <td id="L4547" data-line-number="4547"></td>
        <td id="LC4547">
</td>
      </tr>
      <tr>
        <td id="L4548" data-line-number="4548"></td>
        <td id="LC4548">            <span><span>//</span> For return values there is not cipher table and no ordinal.</span></td>
      </tr>
      <tr>
        <td id="L4549" data-line-number="4549"></td>
        <td id="LC4549">            <span>if</span> (<span>cipherTable</span>.<span>HasValue</span>)</td>
      </tr>
      <tr>
        <td id="L4550" data-line-number="4550"></td>
        <td id="LC4550">            {</td>
      </tr>
      <tr>
        <td id="L4551" data-line-number="4551"></td>
        <td id="LC4551">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>index</span>))</td>
      </tr>
      <tr>
        <td id="L4552" data-line-number="4552"></td>
        <td id="LC4552">                {</td>
      </tr>
      <tr>
        <td id="L4553" data-line-number="4553"></td>
        <td id="LC4553">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4554" data-line-number="4554"></td>
        <td id="LC4554">                }</td>
      </tr>
      <tr>
        <td id="L4555" data-line-number="4555"></td>
        <td id="LC4555">
</td>
      </tr>
      <tr>
        <td id="L4556" data-line-number="4556"></td>
        <td id="LC4556">                <span><span>//</span> validate the index (ordinal passed)</span></td>
      </tr>
      <tr>
        <td id="L4557" data-line-number="4557"></td>
        <td id="LC4557">                <span>if</span> (<span>index</span> <span>&gt;=</span> <span>cipherTable</span>.<span>Value</span>.<span>Size</span>)</td>
      </tr>
      <tr>
        <td id="L4558" data-line-number="4558"></td>
        <td id="LC4558">                {</td>
      </tr>
      <tr>
        <td id="L4559" data-line-number="4559"></td>
        <td id="LC4559">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TryProcessTceCryptoMetadata|TCE&gt; Incorrect ordinal received %d, max tab size: %d<span>\n</span><span>"</span></span>, <span>index</span>, <span>cipherTable</span>.<span>Value</span>.<span>Size</span>);</td>
      </tr>
      <tr>
        <td id="L4560" data-line-number="4560"></td>
        <td id="LC4560">                    <span>throw</span> <span>SQL</span>.<span>ParsingErrorValue</span>(<span>ParsingErrorState</span>.<span>TceInvalidOrdinalIntoCipherInfoTable</span>, <span>index</span>);</td>
      </tr>
      <tr>
        <td id="L4561" data-line-number="4561"></td>
        <td id="LC4561">                }</td>
      </tr>
      <tr>
        <td id="L4562" data-line-number="4562"></td>
        <td id="LC4562">            }</td>
      </tr>
      <tr>
        <td id="L4563" data-line-number="4563"></td>
        <td id="LC4563">
</td>
      </tr>
      <tr>
        <td id="L4564" data-line-number="4564"></td>
        <td id="LC4564">            <span><span>//</span> Read the user type</span></td>
      </tr>
      <tr>
        <td id="L4565" data-line-number="4565"></td>
        <td id="LC4565">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>userType</span>))</td>
      </tr>
      <tr>
        <td id="L4566" data-line-number="4566"></td>
        <td id="LC4566">            {</td>
      </tr>
      <tr>
        <td id="L4567" data-line-number="4567"></td>
        <td id="LC4567">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4568" data-line-number="4568"></td>
        <td id="LC4568">            }</td>
      </tr>
      <tr>
        <td id="L4569" data-line-number="4569"></td>
        <td id="LC4569">
</td>
      </tr>
      <tr>
        <td id="L4570" data-line-number="4570"></td>
        <td id="LC4570">            <span><span>//</span> Read the base TypeInfo</span></td>
      </tr>
      <tr>
        <td id="L4571" data-line-number="4571"></td>
        <td id="LC4571">            <span>col</span>.<span>baseTI</span> <span>=</span> <span>new</span> <span>SqlMetaDataPriv</span>();</td>
      </tr>
      <tr>
        <td id="L4572" data-line-number="4572"></td>
        <td id="LC4572">            <span>if</span> (<span>!</span><span>TryProcessTypeInfo</span>(<span>stateObj</span>, <span>col</span>.<span>baseTI</span>, <span>userType</span>))</td>
      </tr>
      <tr>
        <td id="L4573" data-line-number="4573"></td>
        <td id="LC4573">            {</td>
      </tr>
      <tr>
        <td id="L4574" data-line-number="4574"></td>
        <td id="LC4574">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4575" data-line-number="4575"></td>
        <td id="LC4575">            }</td>
      </tr>
      <tr>
        <td id="L4576" data-line-number="4576"></td>
        <td id="LC4576">
</td>
      </tr>
      <tr>
        <td id="L4577" data-line-number="4577"></td>
        <td id="LC4577">            <span><span>//</span> Read the cipher algorithm Id</span></td>
      </tr>
      <tr>
        <td id="L4578" data-line-number="4578"></td>
        <td id="LC4578">            <span>byte</span> <span>cipherAlgorithmId</span>;</td>
      </tr>
      <tr>
        <td id="L4579" data-line-number="4579"></td>
        <td id="LC4579">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>cipherAlgorithmId</span>))</td>
      </tr>
      <tr>
        <td id="L4580" data-line-number="4580"></td>
        <td id="LC4580">            {</td>
      </tr>
      <tr>
        <td id="L4581" data-line-number="4581"></td>
        <td id="LC4581">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4582" data-line-number="4582"></td>
        <td id="LC4582">            }</td>
      </tr>
      <tr>
        <td id="L4583" data-line-number="4583"></td>
        <td id="LC4583">
</td>
      </tr>
      <tr>
        <td id="L4584" data-line-number="4584"></td>
        <td id="LC4584">            <span>string</span> <span>cipherAlgorithmName</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4585" data-line-number="4585"></td>
        <td id="LC4585">            <span>if</span> (<span>TdsEnums</span>.<span>CustomCipherAlgorithmId</span> <span>==</span> <span>cipherAlgorithmId</span>)</td>
      </tr>
      <tr>
        <td id="L4586" data-line-number="4586"></td>
        <td id="LC4586">            {</td>
      </tr>
      <tr>
        <td id="L4587" data-line-number="4587"></td>
        <td id="LC4587">                <span><span>//</span> Custom encryption algorithm, read the name</span></td>
      </tr>
      <tr>
        <td id="L4588" data-line-number="4588"></td>
        <td id="LC4588">                <span>byte</span> <span>nameSize</span>;</td>
      </tr>
      <tr>
        <td id="L4589" data-line-number="4589"></td>
        <td id="LC4589">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>nameSize</span>))</td>
      </tr>
      <tr>
        <td id="L4590" data-line-number="4590"></td>
        <td id="LC4590">                {</td>
      </tr>
      <tr>
        <td id="L4591" data-line-number="4591"></td>
        <td id="LC4591">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4592" data-line-number="4592"></td>
        <td id="LC4592">                }</td>
      </tr>
      <tr>
        <td id="L4593" data-line-number="4593"></td>
        <td id="LC4593">
</td>
      </tr>
      <tr>
        <td id="L4594" data-line-number="4594"></td>
        <td id="LC4594">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>nameSize</span>, <span>out</span> <span>cipherAlgorithmName</span>))</td>
      </tr>
      <tr>
        <td id="L4595" data-line-number="4595"></td>
        <td id="LC4595">                {</td>
      </tr>
      <tr>
        <td id="L4596" data-line-number="4596"></td>
        <td id="LC4596">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4597" data-line-number="4597"></td>
        <td id="LC4597">                }</td>
      </tr>
      <tr>
        <td id="L4598" data-line-number="4598"></td>
        <td id="LC4598">            }</td>
      </tr>
      <tr>
        <td id="L4599" data-line-number="4599"></td>
        <td id="LC4599">
</td>
      </tr>
      <tr>
        <td id="L4600" data-line-number="4600"></td>
        <td id="LC4600">            <span><span>//</span> Read Encryption Type.</span></td>
      </tr>
      <tr>
        <td id="L4601" data-line-number="4601"></td>
        <td id="LC4601">            <span>byte</span> <span>encryptionType</span>;</td>
      </tr>
      <tr>
        <td id="L4602" data-line-number="4602"></td>
        <td id="LC4602">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>encryptionType</span>))</td>
      </tr>
      <tr>
        <td id="L4603" data-line-number="4603"></td>
        <td id="LC4603">            {</td>
      </tr>
      <tr>
        <td id="L4604" data-line-number="4604"></td>
        <td id="LC4604">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4605" data-line-number="4605"></td>
        <td id="LC4605">            }</td>
      </tr>
      <tr>
        <td id="L4606" data-line-number="4606"></td>
        <td id="LC4606">
</td>
      </tr>
      <tr>
        <td id="L4607" data-line-number="4607"></td>
        <td id="LC4607">            <span><span>//</span> Read Normalization Rule Version.</span></td>
      </tr>
      <tr>
        <td id="L4608" data-line-number="4608"></td>
        <td id="LC4608">            <span>byte</span> <span>normalizationRuleVersion</span>;</td>
      </tr>
      <tr>
        <td id="L4609" data-line-number="4609"></td>
        <td id="LC4609">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>normalizationRuleVersion</span>))</td>
      </tr>
      <tr>
        <td id="L4610" data-line-number="4610"></td>
        <td id="LC4610">            {</td>
      </tr>
      <tr>
        <td id="L4611" data-line-number="4611"></td>
        <td id="LC4611">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4612" data-line-number="4612"></td>
        <td id="LC4612">            }</td>
      </tr>
      <tr>
        <td id="L4613" data-line-number="4613"></td>
        <td id="LC4613">
</td>
      </tr>
      <tr>
        <td id="L4614" data-line-number="4614"></td>
        <td id="LC4614">            <span>Debug</span>.<span>Assert</span>(<span>col</span>.<span>cipherMD</span> <span>==</span> <span>null</span>, <span><span>"</span>col.cipherMD should be null in TryProcessTceCryptoMetadata.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4615" data-line-number="4615"></td>
        <td id="LC4615">
</td>
      </tr>
      <tr>
        <td id="L4616" data-line-number="4616"></td>
        <td id="LC4616">            <span><span>//</span> Check if TCE is enable and if it is set the crypto MD for the column.</span></td>
      </tr>
      <tr>
        <td id="L4617" data-line-number="4617"></td>
        <td id="LC4617">            <span><span>//</span> TCE is enabled if the command is set to enabled or to resultset only and this is not a return value</span></td>
      </tr>
      <tr>
        <td id="L4618" data-line-number="4618"></td>
        <td id="LC4618">            <span><span>//</span> or if it is set to use connection setting and the connection has TCE enabled.</span></td>
      </tr>
      <tr>
        <td id="L4619" data-line-number="4619"></td>
        <td id="LC4619">            <span>if</span> ((<span>columnEncryptionSetting</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>Enabled</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L4620" data-line-number="4620"></td>
        <td id="LC4620">                (<span>columnEncryptionSetting</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>ResultSetOnly</span> <span>&amp;&amp;</span> <span>!</span><span>isReturnValue</span>)) <span>||</span></td>
      </tr>
      <tr>
        <td id="L4621" data-line-number="4621"></td>
        <td id="LC4621">                (<span>columnEncryptionSetting</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>UseConnectionSetting</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L4622" data-line-number="4622"></td>
        <td id="LC4622">                <span>_connHandler</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>_connHandler</span>.<span>ConnectionOptions</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L4623" data-line-number="4623"></td>
        <td id="LC4623">                <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>ColumnEncryptionSetting</span> <span>==</span> <span>SqlConnectionColumnEncryptionSetting</span>.<span>Enabled</span>))</td>
      </tr>
      <tr>
        <td id="L4624" data-line-number="4624"></td>
        <td id="LC4624">            {</td>
      </tr>
      <tr>
        <td id="L4625" data-line-number="4625"></td>
        <td id="LC4625">                <span>col</span>.<span>cipherMD</span> <span>=</span> <span>new</span> <span>SqlCipherMetadata</span>(<span>cipherTable</span>.<span>HasValue</span> <span>?</span> (<span>SqlTceCipherInfoEntry</span>?)<span>cipherTable</span>.<span>Value</span>[<span>index</span>] <span>:</span> <span>null</span>,</td>
      </tr>
      <tr>
        <td id="L4626" data-line-number="4626"></td>
        <td id="LC4626">                                                        <span>index</span>,</td>
      </tr>
      <tr>
        <td id="L4627" data-line-number="4627"></td>
        <td id="LC4627">                                                        <span>cipherAlgorithmId</span>: <span>cipherAlgorithmId</span>,</td>
      </tr>
      <tr>
        <td id="L4628" data-line-number="4628"></td>
        <td id="LC4628">                                                        <span>cipherAlgorithmName</span>: <span>cipherAlgorithmName</span>,</td>
      </tr>
      <tr>
        <td id="L4629" data-line-number="4629"></td>
        <td id="LC4629">                                                        <span>encryptionType</span>: <span>encryptionType</span>,</td>
      </tr>
      <tr>
        <td id="L4630" data-line-number="4630"></td>
        <td id="LC4630">                                                        <span>normalizationRuleVersion</span>: <span>normalizationRuleVersion</span>);</td>
      </tr>
      <tr>
        <td id="L4631" data-line-number="4631"></td>
        <td id="LC4631">            }</td>
      </tr>
      <tr>
        <td id="L4632" data-line-number="4632"></td>
        <td id="LC4632">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4633" data-line-number="4633"></td>
        <td id="LC4633">            {</td>
      </tr>
      <tr>
        <td id="L4634" data-line-number="4634"></td>
        <td id="LC4634">                <span><span>//</span> If TCE is disabled mark the MD as not encrypted.</span></td>
      </tr>
      <tr>
        <td id="L4635" data-line-number="4635"></td>
        <td id="LC4635">                <span>col</span>.<span>isEncrypted</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4636" data-line-number="4636"></td>
        <td id="LC4636">            }</td>
      </tr>
      <tr>
        <td id="L4637" data-line-number="4637"></td>
        <td id="LC4637">
</td>
      </tr>
      <tr>
        <td id="L4638" data-line-number="4638"></td>
        <td id="LC4638">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4639" data-line-number="4639"></td>
        <td id="LC4639">        }</td>
      </tr>
      <tr>
        <td id="L4640" data-line-number="4640"></td>
        <td id="LC4640">
</td>
      </tr>
      <tr>
        <td id="L4641" data-line-number="4641"></td>
        <td id="LC4641">        <span>internal</span> <span>bool</span> <span>TryProcessCollation</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>SqlCollation</span> <span>collation</span>)</td>
      </tr>
      <tr>
        <td id="L4642" data-line-number="4642"></td>
        <td id="LC4642">        {</td>
      </tr>
      <tr>
        <td id="L4643" data-line-number="4643"></td>
        <td id="LC4643">            <span>SqlCollation</span> <span>newCollation</span> <span>=</span> <span>new</span> <span>SqlCollation</span>();</td>
      </tr>
      <tr>
        <td id="L4644" data-line-number="4644"></td>
        <td id="LC4644">
</td>
      </tr>
      <tr>
        <td id="L4645" data-line-number="4645"></td>
        <td id="LC4645">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>newCollation</span>.<span>info</span>))</td>
      </tr>
      <tr>
        <td id="L4646" data-line-number="4646"></td>
        <td id="LC4646">            {</td>
      </tr>
      <tr>
        <td id="L4647" data-line-number="4647"></td>
        <td id="LC4647">                <span>collation</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4648" data-line-number="4648"></td>
        <td id="LC4648">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4649" data-line-number="4649"></td>
        <td id="LC4649">            }</td>
      </tr>
      <tr>
        <td id="L4650" data-line-number="4650"></td>
        <td id="LC4650">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>newCollation</span>.<span>sortId</span>))</td>
      </tr>
      <tr>
        <td id="L4651" data-line-number="4651"></td>
        <td id="LC4651">            {</td>
      </tr>
      <tr>
        <td id="L4652" data-line-number="4652"></td>
        <td id="LC4652">                <span>collation</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4653" data-line-number="4653"></td>
        <td id="LC4653">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4654" data-line-number="4654"></td>
        <td id="LC4654">            }</td>
      </tr>
      <tr>
        <td id="L4655" data-line-number="4655"></td>
        <td id="LC4655">
</td>
      </tr>
      <tr>
        <td id="L4656" data-line-number="4656"></td>
        <td id="LC4656">            <span>collation</span> <span>=</span> <span>newCollation</span>;</td>
      </tr>
      <tr>
        <td id="L4657" data-line-number="4657"></td>
        <td id="LC4657">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4658" data-line-number="4658"></td>
        <td id="LC4658">        }</td>
      </tr>
      <tr>
        <td id="L4659" data-line-number="4659"></td>
        <td id="LC4659">
</td>
      </tr>
      <tr>
        <td id="L4660" data-line-number="4660"></td>
        <td id="LC4660">        <span>private</span> <span>void</span> <span>WriteCollation</span>(<span>SqlCollation</span> <span>collation</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L4661" data-line-number="4661"></td>
        <td id="LC4661">        {</td>
      </tr>
      <tr>
        <td id="L4662" data-line-number="4662"></td>
        <td id="LC4662">            <span>if</span> (<span>collation</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L4663" data-line-number="4663"></td>
        <td id="LC4663">            {</td>
      </tr>
      <tr>
        <td id="L4664" data-line-number="4664"></td>
        <td id="LC4664">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L4665" data-line-number="4665"></td>
        <td id="LC4665">            }</td>
      </tr>
      <tr>
        <td id="L4666" data-line-number="4666"></td>
        <td id="LC4666">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4667" data-line-number="4667"></td>
        <td id="LC4667">            {</td>
      </tr>
      <tr>
        <td id="L4668" data-line-number="4668"></td>
        <td id="LC4668">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>sizeof</span>(<span>UInt32</span>) <span>+</span> <span>sizeof</span>(<span>byte</span>));</td>
      </tr>
      <tr>
        <td id="L4669" data-line-number="4669"></td>
        <td id="LC4669">                <span>WriteUnsignedInt</span>(<span>collation</span>.<span>info</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L4670" data-line-number="4670"></td>
        <td id="LC4670">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>collation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L4671" data-line-number="4671"></td>
        <td id="LC4671">            }</td>
      </tr>
      <tr>
        <td id="L4672" data-line-number="4672"></td>
        <td id="LC4672">
</td>
      </tr>
      <tr>
        <td id="L4673" data-line-number="4673"></td>
        <td id="LC4673">        }</td>
      </tr>
      <tr>
        <td id="L4674" data-line-number="4674"></td>
        <td id="LC4674">
</td>
      </tr>
      <tr>
        <td id="L4675" data-line-number="4675"></td>
        <td id="LC4675">        <span>internal</span> <span>int</span> <span>GetCodePage</span>(<span>SqlCollation</span> <span>collation</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L4676" data-line-number="4676"></td>
        <td id="LC4676">        {</td>
      </tr>
      <tr>
        <td id="L4677" data-line-number="4677"></td>
        <td id="LC4677">            <span>int</span> <span>codePage</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L4678" data-line-number="4678"></td>
        <td id="LC4678">
</td>
      </tr>
      <tr>
        <td id="L4679" data-line-number="4679"></td>
        <td id="LC4679">            <span>if</span> (<span>0</span> <span>!=</span> <span>collation</span>.<span>sortId</span>)</td>
      </tr>
      <tr>
        <td id="L4680" data-line-number="4680"></td>
        <td id="LC4680">            {</td>
      </tr>
      <tr>
        <td id="L4681" data-line-number="4681"></td>
        <td id="LC4681">                <span>codePage</span> <span>=</span> <span>TdsEnums</span>.<span>CODE_PAGE_FROM_SORT_ID</span>[<span>collation</span>.<span>sortId</span>];</td>
      </tr>
      <tr>
        <td id="L4682" data-line-number="4682"></td>
        <td id="LC4682">                <span>Debug</span>.<span>Assert</span>(<span>0</span> <span>!=</span> <span>codePage</span>, <span><span>"</span>GetCodePage accessed codepage array and produced 0!, sortID =<span>"</span></span> <span>+</span> ((<span>Byte</span>)(<span>collation</span>.<span>sortId</span>)).<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>));</td>
      </tr>
      <tr>
        <td id="L4683" data-line-number="4683"></td>
        <td id="LC4683">            }</td>
      </tr>
      <tr>
        <td id="L4684" data-line-number="4684"></td>
        <td id="LC4684">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4685" data-line-number="4685"></td>
        <td id="LC4685">            {</td>
      </tr>
      <tr>
        <td id="L4686" data-line-number="4686"></td>
        <td id="LC4686">                <span>int</span> <span>cultureId</span> <span>=</span> <span>collation</span>.<span>LCID</span>;</td>
      </tr>
      <tr>
        <td id="L4687" data-line-number="4687"></td>
        <td id="LC4687">                <span>bool</span> <span>success</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4688" data-line-number="4688"></td>
        <td id="LC4688">
</td>
      </tr>
      <tr>
        <td id="L4689" data-line-number="4689"></td>
        <td id="LC4689">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L4690" data-line-number="4690"></td>
        <td id="LC4690">                {</td>
      </tr>
      <tr>
        <td id="L4691" data-line-number="4691"></td>
        <td id="LC4691">                    <span>codePage</span> <span>=</span> <span>CultureInfo</span>.<span>GetCultureInfo</span>(<span>cultureId</span>).<span>TextInfo</span>.<span>ANSICodePage</span>;</td>
      </tr>
      <tr>
        <td id="L4692" data-line-number="4692"></td>
        <td id="LC4692">
</td>
      </tr>
      <tr>
        <td id="L4693" data-line-number="4693"></td>
        <td id="LC4693">                    <span><span>//</span> SqlHot 50001398: CodePage can be zero, but we should defer such errors until</span></td>
      </tr>
      <tr>
        <td id="L4694" data-line-number="4694"></td>
        <td id="LC4694">                    <span><span>//</span>  we actually MUST use the code page (i.e. don't error if no ANSI data is sent).</span></td>
      </tr>
      <tr>
        <td id="L4695" data-line-number="4695"></td>
        <td id="LC4695">                    <span>success</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4696" data-line-number="4696"></td>
        <td id="LC4696">                }</td>
      </tr>
      <tr>
        <td id="L4697" data-line-number="4697"></td>
        <td id="LC4697">                <span>catch</span> (<span>ArgumentException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L4698" data-line-number="4698"></td>
        <td id="LC4698">                {</td>
      </tr>
      <tr>
        <td id="L4699" data-line-number="4699"></td>
        <td id="LC4699">                    <span>ADP</span>.<span>TraceExceptionWithoutRethrow</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L4700" data-line-number="4700"></td>
        <td id="LC4700">                }</td>
      </tr>
      <tr>
        <td id="L4701" data-line-number="4701"></td>
        <td id="LC4701">
</td>
      </tr>
      <tr>
        <td id="L4702" data-line-number="4702"></td>
        <td id="LC4702">                <span><span>//</span> If we failed, it is quite possible this is because certain culture id's</span></td>
      </tr>
      <tr>
        <td id="L4703" data-line-number="4703"></td>
        <td id="LC4703">                <span><span>//</span> were removed in Win2k and beyond, however Sql Server still supports them.</span></td>
      </tr>
      <tr>
        <td id="L4704" data-line-number="4704"></td>
        <td id="LC4704">                <span><span>//</span> There is a workaround for the culture id's listed below, which is to mask</span></td>
      </tr>
      <tr>
        <td id="L4705" data-line-number="4705"></td>
        <td id="LC4705">                <span><span>//</span> off the sort id (the leading 1). If that fails, or we have a culture id</span></td>
      </tr>
      <tr>
        <td id="L4706" data-line-number="4706"></td>
        <td id="LC4706">                <span><span>//</span> other than the special cases below, we throw an error and throw away the</span></td>
      </tr>
      <tr>
        <td id="L4707" data-line-number="4707"></td>
        <td id="LC4707">                <span><span>//</span> rest of the results. For additional info, see MDAC 65963.</span></td>
      </tr>
      <tr>
        <td id="L4708" data-line-number="4708"></td>
        <td id="LC4708">
</td>
      </tr>
      <tr>
        <td id="L4709" data-line-number="4709"></td>
        <td id="LC4709">                <span><span>//</span> SqlHot 50001398: Sometimes GetCultureInfo will return CodePage 0 instead of throwing.</span></td>
      </tr>
      <tr>
        <td id="L4710" data-line-number="4710"></td>
        <td id="LC4710">                <span><span>//</span>  treat this as an error also, and switch into the special-case logic.</span></td>
      </tr>
      <tr>
        <td id="L4711" data-line-number="4711"></td>
        <td id="LC4711">                <span>if</span> (<span>!</span><span>success</span> <span>||</span> <span>codePage</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4712" data-line-number="4712"></td>
        <td id="LC4712">                {</td>
      </tr>
      <tr>
        <td id="L4713" data-line-number="4713"></td>
        <td id="LC4713">                    <span>CultureInfo</span> <span>ci</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4714" data-line-number="4714"></td>
        <td id="LC4714">                    <span>switch</span> (<span>cultureId</span>)</td>
      </tr>
      <tr>
        <td id="L4715" data-line-number="4715"></td>
        <td id="LC4715">                    {</td>
      </tr>
      <tr>
        <td id="L4716" data-line-number="4716"></td>
        <td id="LC4716">                        <span>case</span> <span>0x10404</span>: <span><span>//</span> zh-TW</span></td>
      </tr>
      <tr>
        <td id="L4717" data-line-number="4717"></td>
        <td id="LC4717">                        <span>case</span> <span>0x10804</span>: <span><span>//</span> zh-CN</span></td>
      </tr>
      <tr>
        <td id="L4718" data-line-number="4718"></td>
        <td id="LC4718">                        <span>case</span> <span>0x10c04</span>: <span><span>//</span> zh-HK</span></td>
      </tr>
      <tr>
        <td id="L4719" data-line-number="4719"></td>
        <td id="LC4719">                        <span>case</span> <span>0x11004</span>: <span><span>//</span> zh-SG</span></td>
      </tr>
      <tr>
        <td id="L4720" data-line-number="4720"></td>
        <td id="LC4720">                        <span>case</span> <span>0x11404</span>: <span><span>//</span> zh-MO</span></td>
      </tr>
      <tr>
        <td id="L4721" data-line-number="4721"></td>
        <td id="LC4721">                        <span>case</span> <span>0x10411</span>: <span><span>//</span> ja-JP</span></td>
      </tr>
      <tr>
        <td id="L4722" data-line-number="4722"></td>
        <td id="LC4722">                        <span>case</span> <span>0x10412</span>: <span><span>//</span> ko-KR</span></td>
      </tr>
      <tr>
        <td id="L4723" data-line-number="4723"></td>
        <td id="LC4723">                            <span><span>//</span> If one of the following special cases, mask out sortId and</span></td>
      </tr>
      <tr>
        <td id="L4724" data-line-number="4724"></td>
        <td id="LC4724">                            <span><span>//</span> retry.</span></td>
      </tr>
      <tr>
        <td id="L4725" data-line-number="4725"></td>
        <td id="LC4725">                            <span>cultureId</span> <span>=</span> <span>cultureId</span> <span>&amp;</span> <span>0x03fff</span>;</td>
      </tr>
      <tr>
        <td id="L4726" data-line-number="4726"></td>
        <td id="LC4726">
</td>
      </tr>
      <tr>
        <td id="L4727" data-line-number="4727"></td>
        <td id="LC4727">                            <span>try</span></td>
      </tr>
      <tr>
        <td id="L4728" data-line-number="4728"></td>
        <td id="LC4728">                            {</td>
      </tr>
      <tr>
        <td id="L4729" data-line-number="4729"></td>
        <td id="LC4729">                                <span>ci</span> <span>=</span> <span>new</span> <span>CultureInfo</span>(<span>cultureId</span>);</td>
      </tr>
      <tr>
        <td id="L4730" data-line-number="4730"></td>
        <td id="LC4730">                                <span>success</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4731" data-line-number="4731"></td>
        <td id="LC4731">                            }</td>
      </tr>
      <tr>
        <td id="L4732" data-line-number="4732"></td>
        <td id="LC4732">                            <span>catch</span> (<span>ArgumentException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L4733" data-line-number="4733"></td>
        <td id="LC4733">                            {</td>
      </tr>
      <tr>
        <td id="L4734" data-line-number="4734"></td>
        <td id="LC4734">                                <span>ADP</span>.<span>TraceExceptionWithoutRethrow</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L4735" data-line-number="4735"></td>
        <td id="LC4735">                            }</td>
      </tr>
      <tr>
        <td id="L4736" data-line-number="4736"></td>
        <td id="LC4736">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4737" data-line-number="4737"></td>
        <td id="LC4737">                        <span>case</span> <span>0x827</span>:     <span><span>//</span> Non-supported Lithuanian code page, map it to supported Lithuanian.</span></td>
      </tr>
      <tr>
        <td id="L4738" data-line-number="4738"></td>
        <td id="LC4738">                            <span>try</span></td>
      </tr>
      <tr>
        <td id="L4739" data-line-number="4739"></td>
        <td id="LC4739">                            {</td>
      </tr>
      <tr>
        <td id="L4740" data-line-number="4740"></td>
        <td id="LC4740">                                <span>ci</span> <span>=</span> <span>new</span> <span>CultureInfo</span>(<span>0x427</span>);</td>
      </tr>
      <tr>
        <td id="L4741" data-line-number="4741"></td>
        <td id="LC4741">                                <span>success</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L4742" data-line-number="4742"></td>
        <td id="LC4742">                            }</td>
      </tr>
      <tr>
        <td id="L4743" data-line-number="4743"></td>
        <td id="LC4743">                            <span>catch</span> (<span>ArgumentException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L4744" data-line-number="4744"></td>
        <td id="LC4744">                            {</td>
      </tr>
      <tr>
        <td id="L4745" data-line-number="4745"></td>
        <td id="LC4745">                                <span>ADP</span>.<span>TraceExceptionWithoutRethrow</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L4746" data-line-number="4746"></td>
        <td id="LC4746">                            }</td>
      </tr>
      <tr>
        <td id="L4747" data-line-number="4747"></td>
        <td id="LC4747">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4748" data-line-number="4748"></td>
        <td id="LC4748">                        <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L4749" data-line-number="4749"></td>
        <td id="LC4749">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4750" data-line-number="4750"></td>
        <td id="LC4750">                    }</td>
      </tr>
      <tr>
        <td id="L4751" data-line-number="4751"></td>
        <td id="LC4751">
</td>
      </tr>
      <tr>
        <td id="L4752" data-line-number="4752"></td>
        <td id="LC4752">                    <span><span>//</span> I don't believe we should still be in failure case, but just in case.</span></td>
      </tr>
      <tr>
        <td id="L4753" data-line-number="4753"></td>
        <td id="LC4753">                    <span>if</span> (<span>!</span><span>success</span>)</td>
      </tr>
      <tr>
        <td id="L4754" data-line-number="4754"></td>
        <td id="LC4754">                    {</td>
      </tr>
      <tr>
        <td id="L4755" data-line-number="4755"></td>
        <td id="LC4755">                        <span>ThrowUnsupportedCollationEncountered</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L4756" data-line-number="4756"></td>
        <td id="LC4756">                    }</td>
      </tr>
      <tr>
        <td id="L4757" data-line-number="4757"></td>
        <td id="LC4757">
</td>
      </tr>
      <tr>
        <td id="L4758" data-line-number="4758"></td>
        <td id="LC4758">                    <span>if</span> (<span>null</span> <span>!=</span> <span>ci</span>)</td>
      </tr>
      <tr>
        <td id="L4759" data-line-number="4759"></td>
        <td id="LC4759">                    {</td>
      </tr>
      <tr>
        <td id="L4760" data-line-number="4760"></td>
        <td id="LC4760">                        <span>codePage</span> <span>=</span> <span>ci</span>.<span>TextInfo</span>.<span>ANSICodePage</span>;</td>
      </tr>
      <tr>
        <td id="L4761" data-line-number="4761"></td>
        <td id="LC4761">                    }</td>
      </tr>
      <tr>
        <td id="L4762" data-line-number="4762"></td>
        <td id="LC4762">                }</td>
      </tr>
      <tr>
        <td id="L4763" data-line-number="4763"></td>
        <td id="LC4763">            }</td>
      </tr>
      <tr>
        <td id="L4764" data-line-number="4764"></td>
        <td id="LC4764">
</td>
      </tr>
      <tr>
        <td id="L4765" data-line-number="4765"></td>
        <td id="LC4765">            <span>return</span> <span>codePage</span>;</td>
      </tr>
      <tr>
        <td id="L4766" data-line-number="4766"></td>
        <td id="LC4766">        }</td>
      </tr>
      <tr>
        <td id="L4767" data-line-number="4767"></td>
        <td id="LC4767">
</td>
      </tr>
      <tr>
        <td id="L4768" data-line-number="4768"></td>
        <td id="LC4768">
</td>
      </tr>
      <tr>
        <td id="L4769" data-line-number="4769"></td>
        <td id="LC4769">        <span>internal</span> <span>void</span> <span>DrainData</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L4770" data-line-number="4770"></td>
        <td id="LC4770">        {</td>
      </tr>
      <tr>
        <td id="L4771" data-line-number="4771"></td>
        <td id="LC4771">            <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L4772" data-line-number="4772"></td>
        <td id="LC4772">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L4773" data-line-number="4773"></td>
        <td id="LC4773">            {</td>
      </tr>
      <tr>
        <td id="L4774" data-line-number="4774"></td>
        <td id="LC4774">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L4775" data-line-number="4775"></td>
        <td id="LC4775">                <span>TdsParser</span>.<span>ReliabilitySection</span> <span>tdsReliabilitySection</span> <span>=</span> <span>new</span> <span>TdsParser</span>.<span>ReliabilitySection</span>();</td>
      </tr>
      <tr>
        <td id="L4776" data-line-number="4776"></td>
        <td id="LC4776">
</td>
      </tr>
      <tr>
        <td id="L4777" data-line-number="4777"></td>
        <td id="LC4777">                <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L4778" data-line-number="4778"></td>
        <td id="LC4778">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L4779" data-line-number="4779"></td>
        <td id="LC4779">                {</td>
      </tr>
      <tr>
        <td id="L4780" data-line-number="4780"></td>
        <td id="LC4780">                    <span>tdsReliabilitySection</span>.<span>Start</span>();</td>
      </tr>
      <tr>
        <td id="L4781" data-line-number="4781"></td>
        <td id="LC4781">#<span>else</span></td>
      </tr>
      <tr>
        <td id="L4782" data-line-number="4782"></td>
        <td id="LC4782">                {</td>
      </tr>
      <tr>
        <td id="L4783" data-line-number="4783"></td>
        <td id="LC4783">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L4784" data-line-number="4784"></td>
        <td id="LC4784">                    <span>try</span></td>
      </tr>
      <tr>
        <td id="L4785" data-line-number="4785"></td>
        <td id="LC4785">                    {</td>
      </tr>
      <tr>
        <td id="L4786" data-line-number="4786"></td>
        <td id="LC4786">                        <span>SqlDataReader</span>.<span>SharedState</span> <span>sharedState</span> <span>=</span> <span>stateObj</span>.<span>_readerState</span>;</td>
      </tr>
      <tr>
        <td id="L4787" data-line-number="4787"></td>
        <td id="LC4787">                        <span>if</span> (<span>sharedState</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>sharedState</span>.<span>_dataReady</span>)</td>
      </tr>
      <tr>
        <td id="L4788" data-line-number="4788"></td>
        <td id="LC4788">                        {</td>
      </tr>
      <tr>
        <td id="L4789" data-line-number="4789"></td>
        <td id="LC4789">                            <span>var</span> <span>metadata</span> <span>=</span> <span>stateObj</span>.<span>_cleanupMetaData</span>;</td>
      </tr>
      <tr>
        <td id="L4790" data-line-number="4790"></td>
        <td id="LC4790">                            <span>if</span> (<span>stateObj</span>.<span>_partialHeaderBytesRead</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4791" data-line-number="4791"></td>
        <td id="LC4791">                            {</td>
      </tr>
      <tr>
        <td id="L4792" data-line-number="4792"></td>
        <td id="LC4792">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryProcessHeader</span>())</td>
      </tr>
      <tr>
        <td id="L4793" data-line-number="4793"></td>
        <td id="LC4793">                                {</td>
      </tr>
      <tr>
        <td id="L4794" data-line-number="4794"></td>
        <td id="LC4794">                                    <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>();</td>
      </tr>
      <tr>
        <td id="L4795" data-line-number="4795"></td>
        <td id="LC4795">                                }</td>
      </tr>
      <tr>
        <td id="L4796" data-line-number="4796"></td>
        <td id="LC4796">                            }</td>
      </tr>
      <tr>
        <td id="L4797" data-line-number="4797"></td>
        <td id="LC4797">                            <span>if</span> (<span>0</span> <span>==</span> <span>sharedState</span>.<span>_nextColumnHeaderToRead</span>)</td>
      </tr>
      <tr>
        <td id="L4798" data-line-number="4798"></td>
        <td id="LC4798">                            {</td>
      </tr>
      <tr>
        <td id="L4799" data-line-number="4799"></td>
        <td id="LC4799">                                <span><span>//</span> i. user called read but didn't fetch anything</span></td>
      </tr>
      <tr>
        <td id="L4800" data-line-number="4800"></td>
        <td id="LC4800">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>Parser</span>.<span>TrySkipRow</span>(<span>stateObj</span>.<span>_cleanupMetaData</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L4801" data-line-number="4801"></td>
        <td id="LC4801">                                {</td>
      </tr>
      <tr>
        <td id="L4802" data-line-number="4802"></td>
        <td id="LC4802">                                    <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>();</td>
      </tr>
      <tr>
        <td id="L4803" data-line-number="4803"></td>
        <td id="LC4803">                                }</td>
      </tr>
      <tr>
        <td id="L4804" data-line-number="4804"></td>
        <td id="LC4804">                            }</td>
      </tr>
      <tr>
        <td id="L4805" data-line-number="4805"></td>
        <td id="LC4805">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L4806" data-line-number="4806"></td>
        <td id="LC4806">                            {</td>
      </tr>
      <tr>
        <td id="L4807" data-line-number="4807"></td>
        <td id="LC4807">                                <span><span>//</span> iia.  if we still have bytes left from a partially read column, skip</span></td>
      </tr>
      <tr>
        <td id="L4808" data-line-number="4808"></td>
        <td id="LC4808">                                <span>if</span> (<span>sharedState</span>.<span>_nextColumnDataToRead</span> <span>&lt;</span> <span>sharedState</span>.<span>_nextColumnHeaderToRead</span>)</td>
      </tr>
      <tr>
        <td id="L4809" data-line-number="4809"></td>
        <td id="LC4809">                                {</td>
      </tr>
      <tr>
        <td id="L4810" data-line-number="4810"></td>
        <td id="LC4810">                                    <span>if</span> ((<span>sharedState</span>.<span>_nextColumnHeaderToRead</span> <span>&gt;</span> <span>0</span>) <span>&amp;&amp;</span> (<span>metadata</span>[<span>sharedState</span>.<span>_nextColumnHeaderToRead</span> <span>-</span> <span>1</span>].<span>metaType</span>.<span>IsPlp</span>))</td>
      </tr>
      <tr>
        <td id="L4811" data-line-number="4811"></td>
        <td id="LC4811">                                    {</td>
      </tr>
      <tr>
        <td id="L4812" data-line-number="4812"></td>
        <td id="LC4812">                                        <span>if</span> (<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4813" data-line-number="4813"></td>
        <td id="LC4813">                                        {</td>
      </tr>
      <tr>
        <td id="L4814" data-line-number="4814"></td>
        <td id="LC4814">                                            <span>ulong</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L4815" data-line-number="4815"></td>
        <td id="LC4815">                                            <span>if</span> (<span>!</span><span>TrySkipPlpValue</span>(<span>UInt64</span>.<span>MaxValue</span>, <span>stateObj</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L4816" data-line-number="4816"></td>
        <td id="LC4816">                                            {</td>
      </tr>
      <tr>
        <td id="L4817" data-line-number="4817"></td>
        <td id="LC4817">                                                <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>();</td>
      </tr>
      <tr>
        <td id="L4818" data-line-number="4818"></td>
        <td id="LC4818">                                            }</td>
      </tr>
      <tr>
        <td id="L4819" data-line-number="4819"></td>
        <td id="LC4819">                                        }</td>
      </tr>
      <tr>
        <td id="L4820" data-line-number="4820"></td>
        <td id="LC4820">                                    }</td>
      </tr>
      <tr>
        <td id="L4821" data-line-number="4821"></td>
        <td id="LC4821">
</td>
      </tr>
      <tr>
        <td id="L4822" data-line-number="4822"></td>
        <td id="LC4822">                                    <span>else</span> <span>if</span> (<span>0</span> <span>&lt;</span> <span>sharedState</span>.<span>_columnDataBytesRemaining</span>)</td>
      </tr>
      <tr>
        <td id="L4823" data-line-number="4823"></td>
        <td id="LC4823">                                    {</td>
      </tr>
      <tr>
        <td id="L4824" data-line-number="4824"></td>
        <td id="LC4824">                                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipLongBytes</span>(<span>sharedState</span>.<span>_columnDataBytesRemaining</span>))</td>
      </tr>
      <tr>
        <td id="L4825" data-line-number="4825"></td>
        <td id="LC4825">                                        {</td>
      </tr>
      <tr>
        <td id="L4826" data-line-number="4826"></td>
        <td id="LC4826">                                            <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>();</td>
      </tr>
      <tr>
        <td id="L4827" data-line-number="4827"></td>
        <td id="LC4827">                                        }</td>
      </tr>
      <tr>
        <td id="L4828" data-line-number="4828"></td>
        <td id="LC4828">                                    }</td>
      </tr>
      <tr>
        <td id="L4829" data-line-number="4829"></td>
        <td id="LC4829">
</td>
      </tr>
      <tr>
        <td id="L4830" data-line-number="4830"></td>
        <td id="LC4830">                                }</td>
      </tr>
      <tr>
        <td id="L4831" data-line-number="4831"></td>
        <td id="LC4831">
</td>
      </tr>
      <tr>
        <td id="L4832" data-line-number="4832"></td>
        <td id="LC4832">
</td>
      </tr>
      <tr>
        <td id="L4833" data-line-number="4833"></td>
        <td id="LC4833">                                <span><span>//</span> iib.</span></td>
      </tr>
      <tr>
        <td id="L4834" data-line-number="4834"></td>
        <td id="LC4834">                                <span><span>//</span> now read the remaining values off the wire for this row</span></td>
      </tr>
      <tr>
        <td id="L4835" data-line-number="4835"></td>
        <td id="LC4835">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>Parser</span>.<span>TrySkipRow</span>(<span>metadata</span>, <span>sharedState</span>.<span>_nextColumnHeaderToRead</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L4836" data-line-number="4836"></td>
        <td id="LC4836">                                {</td>
      </tr>
      <tr>
        <td id="L4837" data-line-number="4837"></td>
        <td id="LC4837">                                    <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>();</td>
      </tr>
      <tr>
        <td id="L4838" data-line-number="4838"></td>
        <td id="LC4838">                                }</td>
      </tr>
      <tr>
        <td id="L4839" data-line-number="4839"></td>
        <td id="LC4839">
</td>
      </tr>
      <tr>
        <td id="L4840" data-line-number="4840"></td>
        <td id="LC4840">                            }</td>
      </tr>
      <tr>
        <td id="L4841" data-line-number="4841"></td>
        <td id="LC4841">                        }</td>
      </tr>
      <tr>
        <td id="L4842" data-line-number="4842"></td>
        <td id="LC4842">                        <span>Run</span>(<span>RunBehavior</span>.<span>Clean</span>, <span>null</span>, <span>null</span>, <span>null</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L4843" data-line-number="4843"></td>
        <td id="LC4843">                    }</td>
      </tr>
      <tr>
        <td id="L4844" data-line-number="4844"></td>
        <td id="LC4844">                    <span>catch</span></td>
      </tr>
      <tr>
        <td id="L4845" data-line-number="4845"></td>
        <td id="LC4845">                    {</td>
      </tr>
      <tr>
        <td id="L4846" data-line-number="4846"></td>
        <td id="LC4846">                        <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L4847" data-line-number="4847"></td>
        <td id="LC4847">                        <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L4848" data-line-number="4848"></td>
        <td id="LC4848">                    }</td>
      </tr>
      <tr>
        <td id="L4849" data-line-number="4849"></td>
        <td id="LC4849">                }</td>
      </tr>
      <tr>
        <td id="L4850" data-line-number="4850"></td>
        <td id="LC4850">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L4851" data-line-number="4851"></td>
        <td id="LC4851">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L4852" data-line-number="4852"></td>
        <td id="LC4852">                {</td>
      </tr>
      <tr>
        <td id="L4853" data-line-number="4853"></td>
        <td id="LC4853">                    <span>tdsReliabilitySection</span>.<span>Stop</span>();</td>
      </tr>
      <tr>
        <td id="L4854" data-line-number="4854"></td>
        <td id="LC4854">                }</td>
      </tr>
      <tr>
        <td id="L4855" data-line-number="4855"></td>
        <td id="LC4855">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L4856" data-line-number="4856"></td>
        <td id="LC4856">            }</td>
      </tr>
      <tr>
        <td id="L4857" data-line-number="4857"></td>
        <td id="LC4857">            <span>catch</span> (<span>System</span>.<span>OutOfMemoryException</span>)</td>
      </tr>
      <tr>
        <td id="L4858" data-line-number="4858"></td>
        <td id="LC4858">            {</td>
      </tr>
      <tr>
        <td id="L4859" data-line-number="4859"></td>
        <td id="LC4859">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L4860" data-line-number="4860"></td>
        <td id="LC4860">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L4861" data-line-number="4861"></td>
        <td id="LC4861">            }</td>
      </tr>
      <tr>
        <td id="L4862" data-line-number="4862"></td>
        <td id="LC4862">            <span>catch</span> (<span>System</span>.<span>StackOverflowException</span>)</td>
      </tr>
      <tr>
        <td id="L4863" data-line-number="4863"></td>
        <td id="LC4863">            {</td>
      </tr>
      <tr>
        <td id="L4864" data-line-number="4864"></td>
        <td id="LC4864">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L4865" data-line-number="4865"></td>
        <td id="LC4865">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L4866" data-line-number="4866"></td>
        <td id="LC4866">            }</td>
      </tr>
      <tr>
        <td id="L4867" data-line-number="4867"></td>
        <td id="LC4867">            <span>catch</span> (<span>System</span>.<span>Threading</span>.<span>ThreadAbortException</span>)</td>
      </tr>
      <tr>
        <td id="L4868" data-line-number="4868"></td>
        <td id="LC4868">            {</td>
      </tr>
      <tr>
        <td id="L4869" data-line-number="4869"></td>
        <td id="LC4869">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L4870" data-line-number="4870"></td>
        <td id="LC4870">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L4871" data-line-number="4871"></td>
        <td id="LC4871">            }</td>
      </tr>
      <tr>
        <td id="L4872" data-line-number="4872"></td>
        <td id="LC4872">        }</td>
      </tr>
      <tr>
        <td id="L4873" data-line-number="4873"></td>
        <td id="LC4873">
</td>
      </tr>
      <tr>
        <td id="L4874" data-line-number="4874"></td>
        <td id="LC4874">
</td>
      </tr>
      <tr>
        <td id="L4875" data-line-number="4875"></td>
        <td id="LC4875">        <span>internal</span> <span>void</span> <span>ThrowUnsupportedCollationEncountered</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L4876" data-line-number="4876"></td>
        <td id="LC4876">        {</td>
      </tr>
      <tr>
        <td id="L4877" data-line-number="4877"></td>
        <td id="LC4877">            <span>stateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>0</span>, <span>0</span>, <span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>, <span>_server</span>, <span>SQLMessage</span>.<span>CultureIdError</span>(), <span><span>"</span><span>"</span></span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L4878" data-line-number="4878"></td>
        <td id="LC4878">
</td>
      </tr>
      <tr>
        <td id="L4879" data-line-number="4879"></td>
        <td id="LC4879">            <span>if</span> (<span>null</span> <span>!=</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L4880" data-line-number="4880"></td>
        <td id="LC4880">            {</td>
      </tr>
      <tr>
        <td id="L4881" data-line-number="4881"></td>
        <td id="LC4881">                <span>DrainData</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L4882" data-line-number="4882"></td>
        <td id="LC4882">
</td>
      </tr>
      <tr>
        <td id="L4883" data-line-number="4883"></td>
        <td id="LC4883">                <span>stateObj</span>.<span>_pendingData</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4884" data-line-number="4884"></td>
        <td id="LC4884">            }</td>
      </tr>
      <tr>
        <td id="L4885" data-line-number="4885"></td>
        <td id="LC4885">
</td>
      </tr>
      <tr>
        <td id="L4886" data-line-number="4886"></td>
        <td id="LC4886">            <span>ThrowExceptionAndWarning</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L4887" data-line-number="4887"></td>
        <td id="LC4887">        }</td>
      </tr>
      <tr>
        <td id="L4888" data-line-number="4888"></td>
        <td id="LC4888">
</td>
      </tr>
      <tr>
        <td id="L4889" data-line-number="4889"></td>
        <td id="LC4889">
</td>
      </tr>
      <tr>
        <td id="L4890" data-line-number="4890"></td>
        <td id="LC4890">
</td>
      </tr>
      <tr>
        <td id="L4891" data-line-number="4891"></td>
        <td id="LC4891">        <span>internal</span> <span>bool</span> <span>TryProcessAltMetaData</span>(<span>int</span> <span>cColumns</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>_SqlMetaDataSet</span> <span>metaData</span>)</td>
      </tr>
      <tr>
        <td id="L4892" data-line-number="4892"></td>
        <td id="LC4892">        {</td>
      </tr>
      <tr>
        <td id="L4893" data-line-number="4893"></td>
        <td id="LC4893">            <span>Debug</span>.<span>Assert</span>(<span>cColumns</span> <span>&gt;</span> <span>0</span>, <span><span>"</span>should have at least 1 column in altMetaData!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L4894" data-line-number="4894"></td>
        <td id="LC4894">
</td>
      </tr>
      <tr>
        <td id="L4895" data-line-number="4895"></td>
        <td id="LC4895">            <span>metaData</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L4896" data-line-number="4896"></td>
        <td id="LC4896">            <span>_SqlMetaDataSet</span> <span>altMetaDataSet</span> <span>=</span> <span>new</span> <span>_SqlMetaDataSet</span>(<span>cColumns</span>, <span>null</span>);</td>
      </tr>
      <tr>
        <td id="L4897" data-line-number="4897"></td>
        <td id="LC4897">            <span>int</span>[] <span>indexMap</span> <span>=</span> <span>new</span> <span>int</span>[<span>cColumns</span>];</td>
      </tr>
      <tr>
        <td id="L4898" data-line-number="4898"></td>
        <td id="LC4898">
</td>
      </tr>
      <tr>
        <td id="L4899" data-line-number="4899"></td>
        <td id="LC4899">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>altMetaDataSet</span>.<span>id</span>))</td>
      </tr>
      <tr>
        <td id="L4900" data-line-number="4900"></td>
        <td id="LC4900">            {</td>
      </tr>
      <tr>
        <td id="L4901" data-line-number="4901"></td>
        <td id="LC4901">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4902" data-line-number="4902"></td>
        <td id="LC4902">            }</td>
      </tr>
      <tr>
        <td id="L4903" data-line-number="4903"></td>
        <td id="LC4903">
</td>
      </tr>
      <tr>
        <td id="L4904" data-line-number="4904"></td>
        <td id="LC4904">            <span>byte</span> <span>byCols</span>;</td>
      </tr>
      <tr>
        <td id="L4905" data-line-number="4905"></td>
        <td id="LC4905">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byCols</span>))</td>
      </tr>
      <tr>
        <td id="L4906" data-line-number="4906"></td>
        <td id="LC4906">            {</td>
      </tr>
      <tr>
        <td id="L4907" data-line-number="4907"></td>
        <td id="LC4907">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4908" data-line-number="4908"></td>
        <td id="LC4908">            }</td>
      </tr>
      <tr>
        <td id="L4909" data-line-number="4909"></td>
        <td id="LC4909">
</td>
      </tr>
      <tr>
        <td id="L4910" data-line-number="4910"></td>
        <td id="LC4910">            <span>while</span> (<span>byCols</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L4911" data-line-number="4911"></td>
        <td id="LC4911">            {</td>
      </tr>
      <tr>
        <td id="L4912" data-line-number="4912"></td>
        <td id="LC4912">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>2</span>))</td>
      </tr>
      <tr>
        <td id="L4913" data-line-number="4913"></td>
        <td id="LC4913">                { <span><span>//</span> ignore ColNum ...</span></td>
      </tr>
      <tr>
        <td id="L4914" data-line-number="4914"></td>
        <td id="LC4914">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4915" data-line-number="4915"></td>
        <td id="LC4915">                }</td>
      </tr>
      <tr>
        <td id="L4916" data-line-number="4916"></td>
        <td id="LC4916">                <span>byCols</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L4917" data-line-number="4917"></td>
        <td id="LC4917">            }</td>
      </tr>
      <tr>
        <td id="L4918" data-line-number="4918"></td>
        <td id="LC4918">
</td>
      </tr>
      <tr>
        <td id="L4919" data-line-number="4919"></td>
        <td id="LC4919">            <span><span>//</span> pass 1, read the meta data off the wire</span></td>
      </tr>
      <tr>
        <td id="L4920" data-line-number="4920"></td>
        <td id="LC4920">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>cColumns</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L4921" data-line-number="4921"></td>
        <td id="LC4921">            {</td>
      </tr>
      <tr>
        <td id="L4922" data-line-number="4922"></td>
        <td id="LC4922">                <span><span>//</span> internal meta data class</span></td>
      </tr>
      <tr>
        <td id="L4923" data-line-number="4923"></td>
        <td id="LC4923">                <span>_SqlMetaData</span> <span>col</span> <span>=</span> <span>altMetaDataSet</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L4924" data-line-number="4924"></td>
        <td id="LC4924">
</td>
      </tr>
      <tr>
        <td id="L4925" data-line-number="4925"></td>
        <td id="LC4925">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>col</span>.<span>op</span>))</td>
      </tr>
      <tr>
        <td id="L4926" data-line-number="4926"></td>
        <td id="LC4926">                {</td>
      </tr>
      <tr>
        <td id="L4927" data-line-number="4927"></td>
        <td id="LC4927">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4928" data-line-number="4928"></td>
        <td id="LC4928">                }</td>
      </tr>
      <tr>
        <td id="L4929" data-line-number="4929"></td>
        <td id="LC4929">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>col</span>.<span>operand</span>))</td>
      </tr>
      <tr>
        <td id="L4930" data-line-number="4930"></td>
        <td id="LC4930">                {</td>
      </tr>
      <tr>
        <td id="L4931" data-line-number="4931"></td>
        <td id="LC4931">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4932" data-line-number="4932"></td>
        <td id="LC4932">                }</td>
      </tr>
      <tr>
        <td id="L4933" data-line-number="4933"></td>
        <td id="LC4933">
</td>
      </tr>
      <tr>
        <td id="L4934" data-line-number="4934"></td>
        <td id="LC4934">                <span><span>//</span> TCE is not applicable to AltMetadata.</span></td>
      </tr>
      <tr>
        <td id="L4935" data-line-number="4935"></td>
        <td id="LC4935">                <span>if</span> (<span>!</span><span>TryCommonProcessMetaData</span>(<span>stateObj</span>, <span>col</span>, <span>null</span>, <span>fColMD</span>: <span>false</span>, <span>columnEncryptionSetting</span>: <span>SqlCommandColumnEncryptionSetting</span>.<span>Disabled</span>))</td>
      </tr>
      <tr>
        <td id="L4936" data-line-number="4936"></td>
        <td id="LC4936">                {</td>
      </tr>
      <tr>
        <td id="L4937" data-line-number="4937"></td>
        <td id="LC4937">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L4938" data-line-number="4938"></td>
        <td id="LC4938">                }</td>
      </tr>
      <tr>
        <td id="L4939" data-line-number="4939"></td>
        <td id="LC4939">
</td>
      </tr>
      <tr>
        <td id="L4940" data-line-number="4940"></td>
        <td id="LC4940">                <span>if</span> (<span>ADP</span>.<span>IsEmpty</span>(<span>col</span>.<span>column</span>))</td>
      </tr>
      <tr>
        <td id="L4941" data-line-number="4941"></td>
        <td id="LC4941">                {</td>
      </tr>
      <tr>
        <td id="L4942" data-line-number="4942"></td>
        <td id="LC4942">                    <span><span>//</span> create column name from op</span></td>
      </tr>
      <tr>
        <td id="L4943" data-line-number="4943"></td>
        <td id="LC4943">                    <span>switch</span> (<span>col</span>.<span>op</span>)</td>
      </tr>
      <tr>
        <td id="L4944" data-line-number="4944"></td>
        <td id="LC4944">                    {</td>
      </tr>
      <tr>
        <td id="L4945" data-line-number="4945"></td>
        <td id="LC4945">                        <span>case</span> <span>TdsEnums</span>.<span>AOPAVG</span>:</td>
      </tr>
      <tr>
        <td id="L4946" data-line-number="4946"></td>
        <td id="LC4946">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>avg<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4947" data-line-number="4947"></td>
        <td id="LC4947">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4948" data-line-number="4948"></td>
        <td id="LC4948">
</td>
      </tr>
      <tr>
        <td id="L4949" data-line-number="4949"></td>
        <td id="LC4949">                        <span>case</span> <span>TdsEnums</span>.<span>AOPCNT</span>:</td>
      </tr>
      <tr>
        <td id="L4950" data-line-number="4950"></td>
        <td id="LC4950">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>cnt<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4951" data-line-number="4951"></td>
        <td id="LC4951">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4952" data-line-number="4952"></td>
        <td id="LC4952">
</td>
      </tr>
      <tr>
        <td id="L4953" data-line-number="4953"></td>
        <td id="LC4953">                        <span>case</span> <span>TdsEnums</span>.<span>AOPCNTB</span>:</td>
      </tr>
      <tr>
        <td id="L4954" data-line-number="4954"></td>
        <td id="LC4954">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>cntb<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4955" data-line-number="4955"></td>
        <td id="LC4955">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4956" data-line-number="4956"></td>
        <td id="LC4956">
</td>
      </tr>
      <tr>
        <td id="L4957" data-line-number="4957"></td>
        <td id="LC4957">                        <span>case</span> <span>TdsEnums</span>.<span>AOPMAX</span>:</td>
      </tr>
      <tr>
        <td id="L4958" data-line-number="4958"></td>
        <td id="LC4958">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>max<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4959" data-line-number="4959"></td>
        <td id="LC4959">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4960" data-line-number="4960"></td>
        <td id="LC4960">
</td>
      </tr>
      <tr>
        <td id="L4961" data-line-number="4961"></td>
        <td id="LC4961">                        <span>case</span> <span>TdsEnums</span>.<span>AOPMIN</span>:</td>
      </tr>
      <tr>
        <td id="L4962" data-line-number="4962"></td>
        <td id="LC4962">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>min<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4963" data-line-number="4963"></td>
        <td id="LC4963">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4964" data-line-number="4964"></td>
        <td id="LC4964">
</td>
      </tr>
      <tr>
        <td id="L4965" data-line-number="4965"></td>
        <td id="LC4965">                        <span>case</span> <span>TdsEnums</span>.<span>AOPSUM</span>:</td>
      </tr>
      <tr>
        <td id="L4966" data-line-number="4966"></td>
        <td id="LC4966">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>sum<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4967" data-line-number="4967"></td>
        <td id="LC4967">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4968" data-line-number="4968"></td>
        <td id="LC4968">
</td>
      </tr>
      <tr>
        <td id="L4969" data-line-number="4969"></td>
        <td id="LC4969">                        <span>case</span> <span>TdsEnums</span>.<span>AOPANY</span>:</td>
      </tr>
      <tr>
        <td id="L4970" data-line-number="4970"></td>
        <td id="LC4970">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>any<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4971" data-line-number="4971"></td>
        <td id="LC4971">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4972" data-line-number="4972"></td>
        <td id="LC4972">
</td>
      </tr>
      <tr>
        <td id="L4973" data-line-number="4973"></td>
        <td id="LC4973">                        <span>case</span> <span>TdsEnums</span>.<span>AOPNOOP</span>:</td>
      </tr>
      <tr>
        <td id="L4974" data-line-number="4974"></td>
        <td id="LC4974">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>noop<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4975" data-line-number="4975"></td>
        <td id="LC4975">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4976" data-line-number="4976"></td>
        <td id="LC4976">
</td>
      </tr>
      <tr>
        <td id="L4977" data-line-number="4977"></td>
        <td id="LC4977">                        <span>case</span> <span>TdsEnums</span>.<span>AOPSTDEV</span>:</td>
      </tr>
      <tr>
        <td id="L4978" data-line-number="4978"></td>
        <td id="LC4978">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>stdev<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4979" data-line-number="4979"></td>
        <td id="LC4979">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4980" data-line-number="4980"></td>
        <td id="LC4980">
</td>
      </tr>
      <tr>
        <td id="L4981" data-line-number="4981"></td>
        <td id="LC4981">                        <span>case</span> <span>TdsEnums</span>.<span>AOPSTDEVP</span>:</td>
      </tr>
      <tr>
        <td id="L4982" data-line-number="4982"></td>
        <td id="LC4982">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>stdevp<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4983" data-line-number="4983"></td>
        <td id="LC4983">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4984" data-line-number="4984"></td>
        <td id="LC4984">
</td>
      </tr>
      <tr>
        <td id="L4985" data-line-number="4985"></td>
        <td id="LC4985">                        <span>case</span> <span>TdsEnums</span>.<span>AOPVAR</span>:</td>
      </tr>
      <tr>
        <td id="L4986" data-line-number="4986"></td>
        <td id="LC4986">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>var<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4987" data-line-number="4987"></td>
        <td id="LC4987">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4988" data-line-number="4988"></td>
        <td id="LC4988">
</td>
      </tr>
      <tr>
        <td id="L4989" data-line-number="4989"></td>
        <td id="LC4989">                        <span>case</span> <span>TdsEnums</span>.<span>AOPVARP</span>:</td>
      </tr>
      <tr>
        <td id="L4990" data-line-number="4990"></td>
        <td id="LC4990">                            <span>col</span>.<span>column</span> <span>=</span> <span><span>"</span>varp<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L4991" data-line-number="4991"></td>
        <td id="LC4991">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L4992" data-line-number="4992"></td>
        <td id="LC4992">                    }</td>
      </tr>
      <tr>
        <td id="L4993" data-line-number="4993"></td>
        <td id="LC4993">                }</td>
      </tr>
      <tr>
        <td id="L4994" data-line-number="4994"></td>
        <td id="LC4994">                <span>indexMap</span>[<span>i</span>] <span>=</span> <span>i</span>;</td>
      </tr>
      <tr>
        <td id="L4995" data-line-number="4995"></td>
        <td id="LC4995">            }</td>
      </tr>
      <tr>
        <td id="L4996" data-line-number="4996"></td>
        <td id="LC4996">
</td>
      </tr>
      <tr>
        <td id="L4997" data-line-number="4997"></td>
        <td id="LC4997">            <span>altMetaDataSet</span>.<span>indexMap</span> <span>=</span> <span>indexMap</span>;</td>
      </tr>
      <tr>
        <td id="L4998" data-line-number="4998"></td>
        <td id="LC4998">            <span>altMetaDataSet</span>.<span>visibleColumns</span> <span>=</span> <span>cColumns</span>;</td>
      </tr>
      <tr>
        <td id="L4999" data-line-number="4999"></td>
        <td id="LC4999">
</td>
      </tr>
      <tr>
        <td id="L5000" data-line-number="5000"></td>
        <td id="LC5000">            <span>metaData</span> <span>=</span> <span>altMetaDataSet</span>;</td>
      </tr>
      <tr>
        <td id="L5001" data-line-number="5001"></td>
        <td id="LC5001">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5002" data-line-number="5002"></td>
        <td id="LC5002">        }</td>
      </tr>
      <tr>
        <td id="L5003" data-line-number="5003"></td>
        <td id="LC5003">
</td>
      </tr>
      <tr>
        <td id="L5004" data-line-number="5004"></td>
        <td id="LC5004">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5005" data-line-number="5005"></td>
        <td id="LC5005">        <span><span>///</span> &lt;<span><span>para</span></span>&gt; Parses the TDS message to read single CIPHER_INFO entry.&lt;/<span><span>para</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5006" data-line-number="5006"></td>
        <td id="LC5006">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5007" data-line-number="5007"></td>
        <td id="LC5007">        <span>internal</span> <span>bool</span> <span>TryReadCipherInfoEntry</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>SqlTceCipherInfoEntry</span> <span>entry</span>)</td>
      </tr>
      <tr>
        <td id="L5008" data-line-number="5008"></td>
        <td id="LC5008">        {</td>
      </tr>
      <tr>
        <td id="L5009" data-line-number="5009"></td>
        <td id="LC5009">            <span>byte</span> <span>cekValueCount</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5010" data-line-number="5010"></td>
        <td id="LC5010">            <span>entry</span> <span>=</span> <span>new</span> <span>SqlTceCipherInfoEntry</span>(<span>ordinal</span>: <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L5011" data-line-number="5011"></td>
        <td id="LC5011">
</td>
      </tr>
      <tr>
        <td id="L5012" data-line-number="5012"></td>
        <td id="LC5012">            <span><span>//</span> Read the DB ID</span></td>
      </tr>
      <tr>
        <td id="L5013" data-line-number="5013"></td>
        <td id="LC5013">            <span>int</span> <span>dbId</span>;</td>
      </tr>
      <tr>
        <td id="L5014" data-line-number="5014"></td>
        <td id="LC5014">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>dbId</span>))</td>
      </tr>
      <tr>
        <td id="L5015" data-line-number="5015"></td>
        <td id="LC5015">            {</td>
      </tr>
      <tr>
        <td id="L5016" data-line-number="5016"></td>
        <td id="LC5016">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5017" data-line-number="5017"></td>
        <td id="LC5017">            }</td>
      </tr>
      <tr>
        <td id="L5018" data-line-number="5018"></td>
        <td id="LC5018">
</td>
      </tr>
      <tr>
        <td id="L5019" data-line-number="5019"></td>
        <td id="LC5019">            <span><span>//</span> Read the keyID</span></td>
      </tr>
      <tr>
        <td id="L5020" data-line-number="5020"></td>
        <td id="LC5020">            <span>int</span> <span>keyId</span>;</td>
      </tr>
      <tr>
        <td id="L5021" data-line-number="5021"></td>
        <td id="LC5021">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>keyId</span>))</td>
      </tr>
      <tr>
        <td id="L5022" data-line-number="5022"></td>
        <td id="LC5022">            {</td>
      </tr>
      <tr>
        <td id="L5023" data-line-number="5023"></td>
        <td id="LC5023">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5024" data-line-number="5024"></td>
        <td id="LC5024">            }</td>
      </tr>
      <tr>
        <td id="L5025" data-line-number="5025"></td>
        <td id="LC5025">
</td>
      </tr>
      <tr>
        <td id="L5026" data-line-number="5026"></td>
        <td id="LC5026">            <span><span>//</span> Read the key version</span></td>
      </tr>
      <tr>
        <td id="L5027" data-line-number="5027"></td>
        <td id="LC5027">            <span>int</span> <span>keyVersion</span>;</td>
      </tr>
      <tr>
        <td id="L5028" data-line-number="5028"></td>
        <td id="LC5028">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>keyVersion</span>))</td>
      </tr>
      <tr>
        <td id="L5029" data-line-number="5029"></td>
        <td id="LC5029">            {</td>
      </tr>
      <tr>
        <td id="L5030" data-line-number="5030"></td>
        <td id="LC5030">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5031" data-line-number="5031"></td>
        <td id="LC5031">            }</td>
      </tr>
      <tr>
        <td id="L5032" data-line-number="5032"></td>
        <td id="LC5032">
</td>
      </tr>
      <tr>
        <td id="L5033" data-line-number="5033"></td>
        <td id="LC5033">            <span><span>//</span> Read the key MD Version</span></td>
      </tr>
      <tr>
        <td id="L5034" data-line-number="5034"></td>
        <td id="LC5034">            <span>byte</span>[] <span>keyMDVersion</span> <span>=</span> <span>new</span> <span>byte</span>[<span>8</span>];</td>
      </tr>
      <tr>
        <td id="L5035" data-line-number="5035"></td>
        <td id="LC5035">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>keyMDVersion</span>, <span>0</span>, <span>8</span>))</td>
      </tr>
      <tr>
        <td id="L5036" data-line-number="5036"></td>
        <td id="LC5036">            {</td>
      </tr>
      <tr>
        <td id="L5037" data-line-number="5037"></td>
        <td id="LC5037">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5038" data-line-number="5038"></td>
        <td id="LC5038">            }</td>
      </tr>
      <tr>
        <td id="L5039" data-line-number="5039"></td>
        <td id="LC5039">
</td>
      </tr>
      <tr>
        <td id="L5040" data-line-number="5040"></td>
        <td id="LC5040">            <span><span>//</span> Read the value count</span></td>
      </tr>
      <tr>
        <td id="L5041" data-line-number="5041"></td>
        <td id="LC5041">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>cekValueCount</span>))</td>
      </tr>
      <tr>
        <td id="L5042" data-line-number="5042"></td>
        <td id="LC5042">            {</td>
      </tr>
      <tr>
        <td id="L5043" data-line-number="5043"></td>
        <td id="LC5043">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5044" data-line-number="5044"></td>
        <td id="LC5044">            }</td>
      </tr>
      <tr>
        <td id="L5045" data-line-number="5045"></td>
        <td id="LC5045">
</td>
      </tr>
      <tr>
        <td id="L5046" data-line-number="5046"></td>
        <td id="LC5046">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>cekValueCount</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L5047" data-line-number="5047"></td>
        <td id="LC5047">            {</td>
      </tr>
      <tr>
        <td id="L5048" data-line-number="5048"></td>
        <td id="LC5048">                <span><span>//</span> Read individual CEK values</span></td>
      </tr>
      <tr>
        <td id="L5049" data-line-number="5049"></td>
        <td id="LC5049">                <span>byte</span>[] <span>encryptedCek</span>;</td>
      </tr>
      <tr>
        <td id="L5050" data-line-number="5050"></td>
        <td id="LC5050">                <span>string</span> <span>keyPath</span>;</td>
      </tr>
      <tr>
        <td id="L5051" data-line-number="5051"></td>
        <td id="LC5051">                <span>string</span> <span>keyStoreName</span>;</td>
      </tr>
      <tr>
        <td id="L5052" data-line-number="5052"></td>
        <td id="LC5052">                <span>byte</span> <span>algorithmLength</span>;</td>
      </tr>
      <tr>
        <td id="L5053" data-line-number="5053"></td>
        <td id="LC5053">                <span>string</span> <span>algorithmName</span>;</td>
      </tr>
      <tr>
        <td id="L5054" data-line-number="5054"></td>
        <td id="LC5054">                <span>ushort</span> <span>shortValue</span>;</td>
      </tr>
      <tr>
        <td id="L5055" data-line-number="5055"></td>
        <td id="LC5055">                <span>byte</span> <span>byteValue</span>;</td>
      </tr>
      <tr>
        <td id="L5056" data-line-number="5056"></td>
        <td id="LC5056">                <span>int</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L5057" data-line-number="5057"></td>
        <td id="LC5057">
</td>
      </tr>
      <tr>
        <td id="L5058" data-line-number="5058"></td>
        <td id="LC5058">                <span><span>//</span> Read the length of encrypted CEK</span></td>
      </tr>
      <tr>
        <td id="L5059" data-line-number="5059"></td>
        <td id="LC5059">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortValue</span>))</td>
      </tr>
      <tr>
        <td id="L5060" data-line-number="5060"></td>
        <td id="LC5060">                {</td>
      </tr>
      <tr>
        <td id="L5061" data-line-number="5061"></td>
        <td id="LC5061">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5062" data-line-number="5062"></td>
        <td id="LC5062">                }</td>
      </tr>
      <tr>
        <td id="L5063" data-line-number="5063"></td>
        <td id="LC5063">
</td>
      </tr>
      <tr>
        <td id="L5064" data-line-number="5064"></td>
        <td id="LC5064">                <span>length</span> <span>=</span> <span>shortValue</span>;</td>
      </tr>
      <tr>
        <td id="L5065" data-line-number="5065"></td>
        <td id="LC5065">                <span>encryptedCek</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L5066" data-line-number="5066"></td>
        <td id="LC5066">
</td>
      </tr>
      <tr>
        <td id="L5067" data-line-number="5067"></td>
        <td id="LC5067">                <span><span>//</span> Read the actual encrypted CEK</span></td>
      </tr>
      <tr>
        <td id="L5068" data-line-number="5068"></td>
        <td id="LC5068">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>encryptedCek</span>, <span>0</span>, <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L5069" data-line-number="5069"></td>
        <td id="LC5069">                {</td>
      </tr>
      <tr>
        <td id="L5070" data-line-number="5070"></td>
        <td id="LC5070">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5071" data-line-number="5071"></td>
        <td id="LC5071">                }</td>
      </tr>
      <tr>
        <td id="L5072" data-line-number="5072"></td>
        <td id="LC5072">
</td>
      </tr>
      <tr>
        <td id="L5073" data-line-number="5073"></td>
        <td id="LC5073">                <span><span>//</span> Read the length of key store name</span></td>
      </tr>
      <tr>
        <td id="L5074" data-line-number="5074"></td>
        <td id="LC5074">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteValue</span>))</td>
      </tr>
      <tr>
        <td id="L5075" data-line-number="5075"></td>
        <td id="LC5075">                {</td>
      </tr>
      <tr>
        <td id="L5076" data-line-number="5076"></td>
        <td id="LC5076">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5077" data-line-number="5077"></td>
        <td id="LC5077">                }</td>
      </tr>
      <tr>
        <td id="L5078" data-line-number="5078"></td>
        <td id="LC5078">
</td>
      </tr>
      <tr>
        <td id="L5079" data-line-number="5079"></td>
        <td id="LC5079">                <span>length</span> <span>=</span> <span>byteValue</span>;</td>
      </tr>
      <tr>
        <td id="L5080" data-line-number="5080"></td>
        <td id="LC5080">
</td>
      </tr>
      <tr>
        <td id="L5081" data-line-number="5081"></td>
        <td id="LC5081">                <span><span>//</span> And read the key store name now</span></td>
      </tr>
      <tr>
        <td id="L5082" data-line-number="5082"></td>
        <td id="LC5082">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>length</span>, <span>out</span> <span>keyStoreName</span>))</td>
      </tr>
      <tr>
        <td id="L5083" data-line-number="5083"></td>
        <td id="LC5083">                {</td>
      </tr>
      <tr>
        <td id="L5084" data-line-number="5084"></td>
        <td id="LC5084">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5085" data-line-number="5085"></td>
        <td id="LC5085">                }</td>
      </tr>
      <tr>
        <td id="L5086" data-line-number="5086"></td>
        <td id="LC5086">
</td>
      </tr>
      <tr>
        <td id="L5087" data-line-number="5087"></td>
        <td id="LC5087">                <span><span>//</span> Read the length of key Path</span></td>
      </tr>
      <tr>
        <td id="L5088" data-line-number="5088"></td>
        <td id="LC5088">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortValue</span>))</td>
      </tr>
      <tr>
        <td id="L5089" data-line-number="5089"></td>
        <td id="LC5089">                {</td>
      </tr>
      <tr>
        <td id="L5090" data-line-number="5090"></td>
        <td id="LC5090">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5091" data-line-number="5091"></td>
        <td id="LC5091">                }</td>
      </tr>
      <tr>
        <td id="L5092" data-line-number="5092"></td>
        <td id="LC5092">
</td>
      </tr>
      <tr>
        <td id="L5093" data-line-number="5093"></td>
        <td id="LC5093">                <span>length</span> <span>=</span> <span>shortValue</span>;</td>
      </tr>
      <tr>
        <td id="L5094" data-line-number="5094"></td>
        <td id="LC5094">
</td>
      </tr>
      <tr>
        <td id="L5095" data-line-number="5095"></td>
        <td id="LC5095">                <span><span>//</span> Read the key path string</span></td>
      </tr>
      <tr>
        <td id="L5096" data-line-number="5096"></td>
        <td id="LC5096">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>length</span>, <span>out</span> <span>keyPath</span>))</td>
      </tr>
      <tr>
        <td id="L5097" data-line-number="5097"></td>
        <td id="LC5097">                {</td>
      </tr>
      <tr>
        <td id="L5098" data-line-number="5098"></td>
        <td id="LC5098">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5099" data-line-number="5099"></td>
        <td id="LC5099">                }</td>
      </tr>
      <tr>
        <td id="L5100" data-line-number="5100"></td>
        <td id="LC5100">
</td>
      </tr>
      <tr>
        <td id="L5101" data-line-number="5101"></td>
        <td id="LC5101">                <span><span>//</span> Read the length of the string carrying the encryption algo</span></td>
      </tr>
      <tr>
        <td id="L5102" data-line-number="5102"></td>
        <td id="LC5102">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>algorithmLength</span>))</td>
      </tr>
      <tr>
        <td id="L5103" data-line-number="5103"></td>
        <td id="LC5103">                {</td>
      </tr>
      <tr>
        <td id="L5104" data-line-number="5104"></td>
        <td id="LC5104">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5105" data-line-number="5105"></td>
        <td id="LC5105">                }</td>
      </tr>
      <tr>
        <td id="L5106" data-line-number="5106"></td>
        <td id="LC5106">
</td>
      </tr>
      <tr>
        <td id="L5107" data-line-number="5107"></td>
        <td id="LC5107">                <span>length</span> <span>=</span> (<span>int</span>)<span>algorithmLength</span>;</td>
      </tr>
      <tr>
        <td id="L5108" data-line-number="5108"></td>
        <td id="LC5108">
</td>
      </tr>
      <tr>
        <td id="L5109" data-line-number="5109"></td>
        <td id="LC5109">                <span><span>//</span> Read the string carrying the encryption algo  (eg. RSA_PKCS_OAEP)</span></td>
      </tr>
      <tr>
        <td id="L5110" data-line-number="5110"></td>
        <td id="LC5110">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>length</span>, <span>out</span> <span>algorithmName</span>))</td>
      </tr>
      <tr>
        <td id="L5111" data-line-number="5111"></td>
        <td id="LC5111">                {</td>
      </tr>
      <tr>
        <td id="L5112" data-line-number="5112"></td>
        <td id="LC5112">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5113" data-line-number="5113"></td>
        <td id="LC5113">                }</td>
      </tr>
      <tr>
        <td id="L5114" data-line-number="5114"></td>
        <td id="LC5114">
</td>
      </tr>
      <tr>
        <td id="L5115" data-line-number="5115"></td>
        <td id="LC5115">                <span><span>//</span> Add this encrypted CEK blob to our list of encrypted values for the CEK</span></td>
      </tr>
      <tr>
        <td id="L5116" data-line-number="5116"></td>
        <td id="LC5116">                <span>entry</span>.<span>Add</span>(<span>encryptedCek</span>,</td>
      </tr>
      <tr>
        <td id="L5117" data-line-number="5117"></td>
        <td id="LC5117">                    <span>databaseId</span>: <span>dbId</span>,</td>
      </tr>
      <tr>
        <td id="L5118" data-line-number="5118"></td>
        <td id="LC5118">                    <span>cekId</span>: <span>keyId</span>,</td>
      </tr>
      <tr>
        <td id="L5119" data-line-number="5119"></td>
        <td id="LC5119">                    <span>cekVersion</span>: <span>keyVersion</span>,</td>
      </tr>
      <tr>
        <td id="L5120" data-line-number="5120"></td>
        <td id="LC5120">                    <span>cekMdVersion</span>: <span>keyMDVersion</span>,</td>
      </tr>
      <tr>
        <td id="L5121" data-line-number="5121"></td>
        <td id="LC5121">                    <span>keyPath</span>: <span>keyPath</span>,</td>
      </tr>
      <tr>
        <td id="L5122" data-line-number="5122"></td>
        <td id="LC5122">                    <span>keyStoreName</span>: <span>keyStoreName</span>,</td>
      </tr>
      <tr>
        <td id="L5123" data-line-number="5123"></td>
        <td id="LC5123">                    <span>algorithmName</span>: <span>algorithmName</span>);</td>
      </tr>
      <tr>
        <td id="L5124" data-line-number="5124"></td>
        <td id="LC5124">            }</td>
      </tr>
      <tr>
        <td id="L5125" data-line-number="5125"></td>
        <td id="LC5125">
</td>
      </tr>
      <tr>
        <td id="L5126" data-line-number="5126"></td>
        <td id="LC5126">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5127" data-line-number="5127"></td>
        <td id="LC5127">        }</td>
      </tr>
      <tr>
        <td id="L5128" data-line-number="5128"></td>
        <td id="LC5128">
</td>
      </tr>
      <tr>
        <td id="L5129" data-line-number="5129"></td>
        <td id="LC5129">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5130" data-line-number="5130"></td>
        <td id="LC5130">        <span><span>///</span> &lt;<span><span>para</span></span>&gt; Parses the TDS message to read a single CIPHER_INFO table.&lt;/<span><span>para</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5131" data-line-number="5131"></td>
        <td id="LC5131">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5132" data-line-number="5132"></td>
        <td id="LC5132">        <span>internal</span> <span>bool</span> <span>TryProcessCipherInfoTable</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>SqlTceCipherInfoTable</span>? <span>cipherTable</span>)</td>
      </tr>
      <tr>
        <td id="L5133" data-line-number="5133"></td>
        <td id="LC5133">        {</td>
      </tr>
      <tr>
        <td id="L5134" data-line-number="5134"></td>
        <td id="LC5134">            <span><span>//</span> Read count</span></td>
      </tr>
      <tr>
        <td id="L5135" data-line-number="5135"></td>
        <td id="LC5135">            <span>short</span> <span>tableSize</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5136" data-line-number="5136"></td>
        <td id="LC5136">            <span>cipherTable</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L5137" data-line-number="5137"></td>
        <td id="LC5137">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt16</span>(<span>out</span> <span>tableSize</span>))</td>
      </tr>
      <tr>
        <td id="L5138" data-line-number="5138"></td>
        <td id="LC5138">            {</td>
      </tr>
      <tr>
        <td id="L5139" data-line-number="5139"></td>
        <td id="LC5139">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5140" data-line-number="5140"></td>
        <td id="LC5140">            }</td>
      </tr>
      <tr>
        <td id="L5141" data-line-number="5141"></td>
        <td id="LC5141">
</td>
      </tr>
      <tr>
        <td id="L5142" data-line-number="5142"></td>
        <td id="LC5142">            <span>if</span> (<span>0</span> <span>!=</span> <span>tableSize</span>)</td>
      </tr>
      <tr>
        <td id="L5143" data-line-number="5143"></td>
        <td id="LC5143">            {</td>
      </tr>
      <tr>
        <td id="L5144" data-line-number="5144"></td>
        <td id="LC5144">                <span>SqlTceCipherInfoTable</span> <span>tempTable</span> <span>=</span> <span>new</span> <span>SqlTceCipherInfoTable</span>(<span>tableSize</span>);</td>
      </tr>
      <tr>
        <td id="L5145" data-line-number="5145"></td>
        <td id="LC5145">
</td>
      </tr>
      <tr>
        <td id="L5146" data-line-number="5146"></td>
        <td id="LC5146">                <span><span>//</span> Read individual entries</span></td>
      </tr>
      <tr>
        <td id="L5147" data-line-number="5147"></td>
        <td id="LC5147">                <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>tableSize</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L5148" data-line-number="5148"></td>
        <td id="LC5148">                {</td>
      </tr>
      <tr>
        <td id="L5149" data-line-number="5149"></td>
        <td id="LC5149">                    <span>SqlTceCipherInfoEntry</span> <span>entry</span>;</td>
      </tr>
      <tr>
        <td id="L5150" data-line-number="5150"></td>
        <td id="LC5150">                    <span>if</span> (<span>!</span><span>TryReadCipherInfoEntry</span>(<span>stateObj</span>, <span>out</span> <span>entry</span>))</td>
      </tr>
      <tr>
        <td id="L5151" data-line-number="5151"></td>
        <td id="LC5151">                    {</td>
      </tr>
      <tr>
        <td id="L5152" data-line-number="5152"></td>
        <td id="LC5152">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5153" data-line-number="5153"></td>
        <td id="LC5153">                    }</td>
      </tr>
      <tr>
        <td id="L5154" data-line-number="5154"></td>
        <td id="LC5154">
</td>
      </tr>
      <tr>
        <td id="L5155" data-line-number="5155"></td>
        <td id="LC5155">                    <span>tempTable</span>[<span>i</span>] <span>=</span> <span>entry</span>;</td>
      </tr>
      <tr>
        <td id="L5156" data-line-number="5156"></td>
        <td id="LC5156">                }</td>
      </tr>
      <tr>
        <td id="L5157" data-line-number="5157"></td>
        <td id="LC5157">
</td>
      </tr>
      <tr>
        <td id="L5158" data-line-number="5158"></td>
        <td id="LC5158">                <span>cipherTable</span> <span>=</span> <span>tempTable</span>;</td>
      </tr>
      <tr>
        <td id="L5159" data-line-number="5159"></td>
        <td id="LC5159">            }</td>
      </tr>
      <tr>
        <td id="L5160" data-line-number="5160"></td>
        <td id="LC5160">
</td>
      </tr>
      <tr>
        <td id="L5161" data-line-number="5161"></td>
        <td id="LC5161">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5162" data-line-number="5162"></td>
        <td id="LC5162">        }</td>
      </tr>
      <tr>
        <td id="L5163" data-line-number="5163"></td>
        <td id="LC5163">
</td>
      </tr>
      <tr>
        <td id="L5164" data-line-number="5164"></td>
        <td id="LC5164">        <span>internal</span> <span>bool</span> <span>TryProcessMetaData</span>(<span>int</span> <span>cColumns</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>_SqlMetaDataSet</span> <span>metaData</span>, <span>SqlCommandColumnEncryptionSetting</span> <span>columnEncryptionSetting</span>)</td>
      </tr>
      <tr>
        <td id="L5165" data-line-number="5165"></td>
        <td id="LC5165">        {</td>
      </tr>
      <tr>
        <td id="L5166" data-line-number="5166"></td>
        <td id="LC5166">            <span>Debug</span>.<span>Assert</span>(<span>cColumns</span> <span>&gt;</span> <span>0</span>, <span><span>"</span>should have at least 1 column in metadata!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5167" data-line-number="5167"></td>
        <td id="LC5167">
</td>
      </tr>
      <tr>
        <td id="L5168" data-line-number="5168"></td>
        <td id="LC5168">            <span><span>//</span> Read the cipher info table first</span></td>
      </tr>
      <tr>
        <td id="L5169" data-line-number="5169"></td>
        <td id="LC5169">            <span>SqlTceCipherInfoTable</span>? <span>cipherTable</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L5170" data-line-number="5170"></td>
        <td id="LC5170">            <span>if</span> (<span>_serverSupportsColumnEncryption</span>)</td>
      </tr>
      <tr>
        <td id="L5171" data-line-number="5171"></td>
        <td id="LC5171">            {</td>
      </tr>
      <tr>
        <td id="L5172" data-line-number="5172"></td>
        <td id="LC5172">                <span>if</span> (<span>!</span><span>TryProcessCipherInfoTable</span>(<span>stateObj</span>, <span>out</span> <span>cipherTable</span>))</td>
      </tr>
      <tr>
        <td id="L5173" data-line-number="5173"></td>
        <td id="LC5173">                {</td>
      </tr>
      <tr>
        <td id="L5174" data-line-number="5174"></td>
        <td id="LC5174">                    <span>metaData</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L5175" data-line-number="5175"></td>
        <td id="LC5175">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5176" data-line-number="5176"></td>
        <td id="LC5176">                }</td>
      </tr>
      <tr>
        <td id="L5177" data-line-number="5177"></td>
        <td id="LC5177">            }</td>
      </tr>
      <tr>
        <td id="L5178" data-line-number="5178"></td>
        <td id="LC5178">
</td>
      </tr>
      <tr>
        <td id="L5179" data-line-number="5179"></td>
        <td id="LC5179">            <span><span>//</span> Read the ColumnData fields</span></td>
      </tr>
      <tr>
        <td id="L5180" data-line-number="5180"></td>
        <td id="LC5180">            <span>_SqlMetaDataSet</span> <span>newMetaData</span> <span>=</span> <span>new</span> <span>_SqlMetaDataSet</span>(<span>cColumns</span>, <span>cipherTable</span>);</td>
      </tr>
      <tr>
        <td id="L5181" data-line-number="5181"></td>
        <td id="LC5181">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>cColumns</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L5182" data-line-number="5182"></td>
        <td id="LC5182">            {</td>
      </tr>
      <tr>
        <td id="L5183" data-line-number="5183"></td>
        <td id="LC5183">                <span>if</span> (<span>!</span><span>TryCommonProcessMetaData</span>(<span>stateObj</span>, <span>newMetaData</span>[<span>i</span>], <span>cipherTable</span>, <span>fColMD</span>: <span>true</span>, <span>columnEncryptionSetting</span>: <span>columnEncryptionSetting</span>))</td>
      </tr>
      <tr>
        <td id="L5184" data-line-number="5184"></td>
        <td id="LC5184">                {</td>
      </tr>
      <tr>
        <td id="L5185" data-line-number="5185"></td>
        <td id="LC5185">                    <span>metaData</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L5186" data-line-number="5186"></td>
        <td id="LC5186">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5187" data-line-number="5187"></td>
        <td id="LC5187">                }</td>
      </tr>
      <tr>
        <td id="L5188" data-line-number="5188"></td>
        <td id="LC5188">            }</td>
      </tr>
      <tr>
        <td id="L5189" data-line-number="5189"></td>
        <td id="LC5189">
</td>
      </tr>
      <tr>
        <td id="L5190" data-line-number="5190"></td>
        <td id="LC5190">            <span><span>//</span> DEVNOTE: cipherTable is discarded at this point since its no longer needed.</span></td>
      </tr>
      <tr>
        <td id="L5191" data-line-number="5191"></td>
        <td id="LC5191">            <span>metaData</span> <span>=</span> <span>newMetaData</span>;</td>
      </tr>
      <tr>
        <td id="L5192" data-line-number="5192"></td>
        <td id="LC5192">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5193" data-line-number="5193"></td>
        <td id="LC5193">        }</td>
      </tr>
      <tr>
        <td id="L5194" data-line-number="5194"></td>
        <td id="LC5194">
</td>
      </tr>
      <tr>
        <td id="L5195" data-line-number="5195"></td>
        <td id="LC5195">        <span>private</span> <span>bool</span> <span>IsVarTimeTds</span>(<span>byte</span> <span>tdsType</span>)</td>
      </tr>
      <tr>
        <td id="L5196" data-line-number="5196"></td>
        <td id="LC5196">        {</td>
      </tr>
      <tr>
        <td id="L5197" data-line-number="5197"></td>
        <td id="LC5197">            <span>return</span> <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLTIME</span> <span>||</span> <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDATETIME2</span> <span>||</span> <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>;</td>
      </tr>
      <tr>
        <td id="L5198" data-line-number="5198"></td>
        <td id="LC5198">        }</td>
      </tr>
      <tr>
        <td id="L5199" data-line-number="5199"></td>
        <td id="LC5199">
</td>
      </tr>
      <tr>
        <td id="L5200" data-line-number="5200"></td>
        <td id="LC5200">        <span>private</span> <span>bool</span> <span>TryProcessTypeInfo</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>SqlMetaDataPriv</span> <span>col</span>, <span>UInt32</span> <span>userType</span>)</td>
      </tr>
      <tr>
        <td id="L5201" data-line-number="5201"></td>
        <td id="LC5201">        {</td>
      </tr>
      <tr>
        <td id="L5202" data-line-number="5202"></td>
        <td id="LC5202">            <span>byte</span> <span>byteLen</span>;</td>
      </tr>
      <tr>
        <td id="L5203" data-line-number="5203"></td>
        <td id="LC5203">            <span>byte</span> <span>tdsType</span>;</td>
      </tr>
      <tr>
        <td id="L5204" data-line-number="5204"></td>
        <td id="LC5204">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>tdsType</span>))</td>
      </tr>
      <tr>
        <td id="L5205" data-line-number="5205"></td>
        <td id="LC5205">            {</td>
      </tr>
      <tr>
        <td id="L5206" data-line-number="5206"></td>
        <td id="LC5206">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5207" data-line-number="5207"></td>
        <td id="LC5207">            }</td>
      </tr>
      <tr>
        <td id="L5208" data-line-number="5208"></td>
        <td id="LC5208">
</td>
      </tr>
      <tr>
        <td id="L5209" data-line-number="5209"></td>
        <td id="LC5209">            <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>)</td>
      </tr>
      <tr>
        <td id="L5210" data-line-number="5210"></td>
        <td id="LC5210">                <span>col</span>.<span>length</span> <span>=</span> <span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>;  <span><span>//</span>Use the same length as other plp datatypes</span></td>
      </tr>
      <tr>
        <td id="L5211" data-line-number="5211"></td>
        <td id="LC5211">            <span>else</span> <span>if</span> (<span>IsVarTimeTds</span>(<span>tdsType</span>))</td>
      </tr>
      <tr>
        <td id="L5212" data-line-number="5212"></td>
        <td id="LC5212">                <span>col</span>.<span>length</span> <span>=</span> <span>0</span>;  <span><span>//</span> placeholder until we read the scale, just make sure it's not SQL_USHORTVARMAXLEN</span></td>
      </tr>
      <tr>
        <td id="L5213" data-line-number="5213"></td>
        <td id="LC5213">            <span>else</span> <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLDATE</span>)</td>
      </tr>
      <tr>
        <td id="L5214" data-line-number="5214"></td>
        <td id="LC5214">            {</td>
      </tr>
      <tr>
        <td id="L5215" data-line-number="5215"></td>
        <td id="LC5215">                <span>col</span>.<span>length</span> <span>=</span> <span>3</span>;</td>
      </tr>
      <tr>
        <td id="L5216" data-line-number="5216"></td>
        <td id="LC5216">            }</td>
      </tr>
      <tr>
        <td id="L5217" data-line-number="5217"></td>
        <td id="LC5217">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5218" data-line-number="5218"></td>
        <td id="LC5218">            {</td>
      </tr>
      <tr>
        <td id="L5219" data-line-number="5219"></td>
        <td id="LC5219">                <span>if</span> (<span>!</span><span>TryGetTokenLength</span>(<span>tdsType</span>, <span>stateObj</span>, <span>out</span> <span>col</span>.<span>length</span>))</td>
      </tr>
      <tr>
        <td id="L5220" data-line-number="5220"></td>
        <td id="LC5220">                {</td>
      </tr>
      <tr>
        <td id="L5221" data-line-number="5221"></td>
        <td id="LC5221">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5222" data-line-number="5222"></td>
        <td id="LC5222">                }</td>
      </tr>
      <tr>
        <td id="L5223" data-line-number="5223"></td>
        <td id="LC5223">            }</td>
      </tr>
      <tr>
        <td id="L5224" data-line-number="5224"></td>
        <td id="LC5224">
</td>
      </tr>
      <tr>
        <td id="L5225" data-line-number="5225"></td>
        <td id="LC5225">            <span>col</span>.<span>metaType</span> <span>=</span> <span>MetaType</span>.<span>GetSqlDataType</span>(<span>tdsType</span>, <span>userType</span>, <span>col</span>.<span>length</span>);</td>
      </tr>
      <tr>
        <td id="L5226" data-line-number="5226"></td>
        <td id="LC5226">            <span>col</span>.<span>type</span> <span>=</span> <span>col</span>.<span>metaType</span>.<span>SqlDbType</span>;</td>
      </tr>
      <tr>
        <td id="L5227" data-line-number="5227"></td>
        <td id="LC5227">
</td>
      </tr>
      <tr>
        <td id="L5228" data-line-number="5228"></td>
        <td id="LC5228">            <span><span>//</span> If sphinx, do not change to nullable type</span></td>
      </tr>
      <tr>
        <td id="L5229" data-line-number="5229"></td>
        <td id="LC5229">            <span>if</span> (<span>_isShiloh</span>)</td>
      </tr>
      <tr>
        <td id="L5230" data-line-number="5230"></td>
        <td id="LC5230">                <span>col</span>.<span>tdsType</span> <span>=</span> (<span>col</span>.<span>IsNullable</span> <span>?</span> <span>col</span>.<span>metaType</span>.<span>NullableType</span> <span>:</span> <span>col</span>.<span>metaType</span>.<span>TDSType</span>);</td>
      </tr>
      <tr>
        <td id="L5231" data-line-number="5231"></td>
        <td id="LC5231">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5232" data-line-number="5232"></td>
        <td id="LC5232">                <span>col</span>.<span>tdsType</span> <span>=</span> <span>tdsType</span>;</td>
      </tr>
      <tr>
        <td id="L5233" data-line-number="5233"></td>
        <td id="LC5233">
</td>
      </tr>
      <tr>
        <td id="L5234" data-line-number="5234"></td>
        <td id="LC5234">            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L5235" data-line-number="5235"></td>
        <td id="LC5235">            {</td>
      </tr>
      <tr>
        <td id="L5236" data-line-number="5236"></td>
        <td id="LC5236">                <span>if</span> (<span>TdsEnums</span>.<span>SQLUDT</span> <span>==</span> <span>tdsType</span>)</td>
      </tr>
      <tr>
        <td id="L5237" data-line-number="5237"></td>
        <td id="LC5237">                {</td>
      </tr>
      <tr>
        <td id="L5238" data-line-number="5238"></td>
        <td id="LC5238">                    <span>if</span> (<span>!</span><span>TryProcessUDTMetaData</span>((<span>SqlMetaDataPriv</span>)<span>col</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L5239" data-line-number="5239"></td>
        <td id="LC5239">                    {</td>
      </tr>
      <tr>
        <td id="L5240" data-line-number="5240"></td>
        <td id="LC5240">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5241" data-line-number="5241"></td>
        <td id="LC5241">                    }</td>
      </tr>
      <tr>
        <td id="L5242" data-line-number="5242"></td>
        <td id="LC5242">                }</td>
      </tr>
      <tr>
        <td id="L5243" data-line-number="5243"></td>
        <td id="LC5243">
</td>
      </tr>
      <tr>
        <td id="L5244" data-line-number="5244"></td>
        <td id="LC5244">                <span>if</span> (<span>col</span>.<span>length</span> <span>==</span> <span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>)</td>
      </tr>
      <tr>
        <td id="L5245" data-line-number="5245"></td>
        <td id="LC5245">                {</td>
      </tr>
      <tr>
        <td id="L5246" data-line-number="5246"></td>
        <td id="LC5246">                    <span>Debug</span>.<span>Assert</span>(<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L5247" data-line-number="5247"></td>
        <td id="LC5247">                                 <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L5248" data-line-number="5248"></td>
        <td id="LC5248">                                 <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L5249" data-line-number="5249"></td>
        <td id="LC5249">                                 <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L5250" data-line-number="5250"></td>
        <td id="LC5250">                                 <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLUDT</span>,</td>
      </tr>
      <tr>
        <td id="L5251" data-line-number="5251"></td>
        <td id="LC5251">                                 <span><span>"</span>Invalid streaming datatype<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5252" data-line-number="5252"></td>
        <td id="LC5252">                    <span>col</span>.<span>metaType</span> <span>=</span> <span>MetaType</span>.<span>GetMaxMetaTypeFromMetaType</span>(<span>col</span>.<span>metaType</span>);</td>
      </tr>
      <tr>
        <td id="L5253" data-line-number="5253"></td>
        <td id="LC5253">                    <span>Debug</span>.<span>Assert</span>(<span>col</span>.<span>metaType</span>.<span>IsLong</span>, <span><span>"</span>Max datatype not IsLong<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5254" data-line-number="5254"></td>
        <td id="LC5254">                    <span>col</span>.<span>length</span> <span>=</span> <span>Int32</span>.<span>MaxValue</span>;</td>
      </tr>
      <tr>
        <td id="L5255" data-line-number="5255"></td>
        <td id="LC5255">                    <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>)</td>
      </tr>
      <tr>
        <td id="L5256" data-line-number="5256"></td>
        <td id="LC5256">                    {</td>
      </tr>
      <tr>
        <td id="L5257" data-line-number="5257"></td>
        <td id="LC5257">                        <span>byte</span> <span>schemapresent</span>;</td>
      </tr>
      <tr>
        <td id="L5258" data-line-number="5258"></td>
        <td id="LC5258">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>schemapresent</span>))</td>
      </tr>
      <tr>
        <td id="L5259" data-line-number="5259"></td>
        <td id="LC5259">                        {</td>
      </tr>
      <tr>
        <td id="L5260" data-line-number="5260"></td>
        <td id="LC5260">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5261" data-line-number="5261"></td>
        <td id="LC5261">                        }</td>
      </tr>
      <tr>
        <td id="L5262" data-line-number="5262"></td>
        <td id="LC5262">
</td>
      </tr>
      <tr>
        <td id="L5263" data-line-number="5263"></td>
        <td id="LC5263">                        <span>if</span> ((<span>schemapresent</span> <span>&amp;</span> <span>1</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5264" data-line-number="5264"></td>
        <td id="LC5264">                        {</td>
      </tr>
      <tr>
        <td id="L5265" data-line-number="5265"></td>
        <td id="LC5265">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLen</span>))</td>
      </tr>
      <tr>
        <td id="L5266" data-line-number="5266"></td>
        <td id="LC5266">                            {</td>
      </tr>
      <tr>
        <td id="L5267" data-line-number="5267"></td>
        <td id="LC5267">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5268" data-line-number="5268"></td>
        <td id="LC5268">                            }</td>
      </tr>
      <tr>
        <td id="L5269" data-line-number="5269"></td>
        <td id="LC5269">                            <span>if</span> (<span>col</span>.<span>xmlSchemaCollection</span> <span>is</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L5270" data-line-number="5270"></td>
        <td id="LC5270">                            {</td>
      </tr>
      <tr>
        <td id="L5271" data-line-number="5271"></td>
        <td id="LC5271">                                <span>col</span>.<span>xmlSchemaCollection</span> <span>=</span> <span>new</span> <span>SqlMetaDataXmlSchemaCollection</span>();</td>
      </tr>
      <tr>
        <td id="L5272" data-line-number="5272"></td>
        <td id="LC5272">                            }</td>
      </tr>
      <tr>
        <td id="L5273" data-line-number="5273"></td>
        <td id="LC5273">                            <span>if</span> (<span>byteLen</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5274" data-line-number="5274"></td>
        <td id="LC5274">                            {</td>
      </tr>
      <tr>
        <td id="L5275" data-line-number="5275"></td>
        <td id="LC5275">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLen</span>, <span>out</span> <span>col</span>.<span>xmlSchemaCollection</span>.<span>Database</span>))</td>
      </tr>
      <tr>
        <td id="L5276" data-line-number="5276"></td>
        <td id="LC5276">                                {</td>
      </tr>
      <tr>
        <td id="L5277" data-line-number="5277"></td>
        <td id="LC5277">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5278" data-line-number="5278"></td>
        <td id="LC5278">                                }</td>
      </tr>
      <tr>
        <td id="L5279" data-line-number="5279"></td>
        <td id="LC5279">                            }</td>
      </tr>
      <tr>
        <td id="L5280" data-line-number="5280"></td>
        <td id="LC5280">
</td>
      </tr>
      <tr>
        <td id="L5281" data-line-number="5281"></td>
        <td id="LC5281">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLen</span>))</td>
      </tr>
      <tr>
        <td id="L5282" data-line-number="5282"></td>
        <td id="LC5282">                            {</td>
      </tr>
      <tr>
        <td id="L5283" data-line-number="5283"></td>
        <td id="LC5283">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5284" data-line-number="5284"></td>
        <td id="LC5284">                            }</td>
      </tr>
      <tr>
        <td id="L5285" data-line-number="5285"></td>
        <td id="LC5285">                            <span>if</span> (<span>byteLen</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5286" data-line-number="5286"></td>
        <td id="LC5286">                            {</td>
      </tr>
      <tr>
        <td id="L5287" data-line-number="5287"></td>
        <td id="LC5287">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLen</span>, <span>out</span> <span>col</span>.<span>xmlSchemaCollection</span>.<span>OwningSchema</span>))</td>
      </tr>
      <tr>
        <td id="L5288" data-line-number="5288"></td>
        <td id="LC5288">                                {</td>
      </tr>
      <tr>
        <td id="L5289" data-line-number="5289"></td>
        <td id="LC5289">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5290" data-line-number="5290"></td>
        <td id="LC5290">                                }</td>
      </tr>
      <tr>
        <td id="L5291" data-line-number="5291"></td>
        <td id="LC5291">                            }</td>
      </tr>
      <tr>
        <td id="L5292" data-line-number="5292"></td>
        <td id="LC5292">
</td>
      </tr>
      <tr>
        <td id="L5293" data-line-number="5293"></td>
        <td id="LC5293">                            <span>short</span> <span>shortLen</span>;</td>
      </tr>
      <tr>
        <td id="L5294" data-line-number="5294"></td>
        <td id="LC5294">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt16</span>(<span>out</span> <span>shortLen</span>))</td>
      </tr>
      <tr>
        <td id="L5295" data-line-number="5295"></td>
        <td id="LC5295">                            {</td>
      </tr>
      <tr>
        <td id="L5296" data-line-number="5296"></td>
        <td id="LC5296">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5297" data-line-number="5297"></td>
        <td id="LC5297">                            }</td>
      </tr>
      <tr>
        <td id="L5298" data-line-number="5298"></td>
        <td id="LC5298">                            <span>if</span> (<span>byteLen</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5299" data-line-number="5299"></td>
        <td id="LC5299">                            {</td>
      </tr>
      <tr>
        <td id="L5300" data-line-number="5300"></td>
        <td id="LC5300">                                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>shortLen</span>, <span>out</span> <span>col</span>.<span>xmlSchemaCollection</span>.<span>Name</span>))</td>
      </tr>
      <tr>
        <td id="L5301" data-line-number="5301"></td>
        <td id="LC5301">                                {</td>
      </tr>
      <tr>
        <td id="L5302" data-line-number="5302"></td>
        <td id="LC5302">                                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5303" data-line-number="5303"></td>
        <td id="LC5303">                                }</td>
      </tr>
      <tr>
        <td id="L5304" data-line-number="5304"></td>
        <td id="LC5304">                            }</td>
      </tr>
      <tr>
        <td id="L5305" data-line-number="5305"></td>
        <td id="LC5305">                        }</td>
      </tr>
      <tr>
        <td id="L5306" data-line-number="5306"></td>
        <td id="LC5306">                    }</td>
      </tr>
      <tr>
        <td id="L5307" data-line-number="5307"></td>
        <td id="LC5307">                }</td>
      </tr>
      <tr>
        <td id="L5308" data-line-number="5308"></td>
        <td id="LC5308">            }</td>
      </tr>
      <tr>
        <td id="L5309" data-line-number="5309"></td>
        <td id="LC5309">
</td>
      </tr>
      <tr>
        <td id="L5310" data-line-number="5310"></td>
        <td id="LC5310">            <span>if</span> (<span>col</span>.<span>type</span> <span>==</span> <span>SqlDbType</span>.<span>Decimal</span>)</td>
      </tr>
      <tr>
        <td id="L5311" data-line-number="5311"></td>
        <td id="LC5311">            {</td>
      </tr>
      <tr>
        <td id="L5312" data-line-number="5312"></td>
        <td id="LC5312">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>col</span>.<span>precision</span>))</td>
      </tr>
      <tr>
        <td id="L5313" data-line-number="5313"></td>
        <td id="LC5313">                {</td>
      </tr>
      <tr>
        <td id="L5314" data-line-number="5314"></td>
        <td id="LC5314">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5315" data-line-number="5315"></td>
        <td id="LC5315">                }</td>
      </tr>
      <tr>
        <td id="L5316" data-line-number="5316"></td>
        <td id="LC5316">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>col</span>.<span>scale</span>))</td>
      </tr>
      <tr>
        <td id="L5317" data-line-number="5317"></td>
        <td id="LC5317">                {</td>
      </tr>
      <tr>
        <td id="L5318" data-line-number="5318"></td>
        <td id="LC5318">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5319" data-line-number="5319"></td>
        <td id="LC5319">                }</td>
      </tr>
      <tr>
        <td id="L5320" data-line-number="5320"></td>
        <td id="LC5320">            }</td>
      </tr>
      <tr>
        <td id="L5321" data-line-number="5321"></td>
        <td id="LC5321">
</td>
      </tr>
      <tr>
        <td id="L5322" data-line-number="5322"></td>
        <td id="LC5322">            <span>if</span> (<span>col</span>.<span>metaType</span>.<span>IsVarTime</span>)</td>
      </tr>
      <tr>
        <td id="L5323" data-line-number="5323"></td>
        <td id="LC5323">            {</td>
      </tr>
      <tr>
        <td id="L5324" data-line-number="5324"></td>
        <td id="LC5324">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>col</span>.<span>scale</span>))</td>
      </tr>
      <tr>
        <td id="L5325" data-line-number="5325"></td>
        <td id="LC5325">                {</td>
      </tr>
      <tr>
        <td id="L5326" data-line-number="5326"></td>
        <td id="LC5326">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5327" data-line-number="5327"></td>
        <td id="LC5327">                }</td>
      </tr>
      <tr>
        <td id="L5328" data-line-number="5328"></td>
        <td id="LC5328">
</td>
      </tr>
      <tr>
        <td id="L5329" data-line-number="5329"></td>
        <td id="LC5329">                <span>Debug</span>.<span>Assert</span>(<span>0</span> <span>&lt;=</span> <span>col</span>.<span>scale</span> <span>&amp;&amp;</span> <span>col</span>.<span>scale</span> <span>&lt;=</span> <span>7</span>);</td>
      </tr>
      <tr>
        <td id="L5330" data-line-number="5330"></td>
        <td id="LC5330">
</td>
      </tr>
      <tr>
        <td id="L5331" data-line-number="5331"></td>
        <td id="LC5331">                <span><span>//</span> calculate actual column length here</span></td>
      </tr>
      <tr>
        <td id="L5332" data-line-number="5332"></td>
        <td id="LC5332">                <span><span>//</span> TODO: variable-length calculation needs to be encapsulated better</span></td>
      </tr>
      <tr>
        <td id="L5333" data-line-number="5333"></td>
        <td id="LC5333">                <span>switch</span> (<span>col</span>.<span>metaType</span>.<span>SqlDbType</span>)</td>
      </tr>
      <tr>
        <td id="L5334" data-line-number="5334"></td>
        <td id="LC5334">                {</td>
      </tr>
      <tr>
        <td id="L5335" data-line-number="5335"></td>
        <td id="LC5335">                    <span>case</span> <span>SqlDbType</span>.<span>Time</span>:</td>
      </tr>
      <tr>
        <td id="L5336" data-line-number="5336"></td>
        <td id="LC5336">                        <span>col</span>.<span>length</span> <span>=</span> <span>MetaType</span>.<span>GetTimeSizeFromScale</span>(<span>col</span>.<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L5337" data-line-number="5337"></td>
        <td id="LC5337">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L5338" data-line-number="5338"></td>
        <td id="LC5338">                    <span>case</span> <span>SqlDbType</span>.<span>DateTime2</span>:</td>
      </tr>
      <tr>
        <td id="L5339" data-line-number="5339"></td>
        <td id="LC5339">                        <span><span>//</span> Date in number of days (3 bytes) + time</span></td>
      </tr>
      <tr>
        <td id="L5340" data-line-number="5340"></td>
        <td id="LC5340">                        <span>col</span>.<span>length</span> <span>=</span> <span>3</span> <span>+</span> <span>MetaType</span>.<span>GetTimeSizeFromScale</span>(<span>col</span>.<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L5341" data-line-number="5341"></td>
        <td id="LC5341">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L5342" data-line-number="5342"></td>
        <td id="LC5342">                    <span>case</span> <span>SqlDbType</span>.<span>DateTimeOffset</span>:</td>
      </tr>
      <tr>
        <td id="L5343" data-line-number="5343"></td>
        <td id="LC5343">                        <span><span>//</span> Date in days (3 bytes) + offset in minutes (2 bytes) + time</span></td>
      </tr>
      <tr>
        <td id="L5344" data-line-number="5344"></td>
        <td id="LC5344">                        <span>col</span>.<span>length</span> <span>=</span> <span>5</span> <span>+</span> <span>MetaType</span>.<span>GetTimeSizeFromScale</span>(<span>col</span>.<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L5345" data-line-number="5345"></td>
        <td id="LC5345">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L5346" data-line-number="5346"></td>
        <td id="LC5346">
</td>
      </tr>
      <tr>
        <td id="L5347" data-line-number="5347"></td>
        <td id="LC5347">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L5348" data-line-number="5348"></td>
        <td id="LC5348">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown VariableTime type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5349" data-line-number="5349"></td>
        <td id="LC5349">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L5350" data-line-number="5350"></td>
        <td id="LC5350">                }</td>
      </tr>
      <tr>
        <td id="L5351" data-line-number="5351"></td>
        <td id="LC5351">            }</td>
      </tr>
      <tr>
        <td id="L5352" data-line-number="5352"></td>
        <td id="LC5352">
</td>
      </tr>
      <tr>
        <td id="L5353" data-line-number="5353"></td>
        <td id="LC5353">            <span><span>//</span> read the collation for 7.x servers</span></td>
      </tr>
      <tr>
        <td id="L5354" data-line-number="5354"></td>
        <td id="LC5354">            <span>if</span> (<span>_isShiloh</span> <span>&amp;&amp;</span> <span>col</span>.<span>metaType</span>.<span>IsCharType</span> <span>&amp;&amp;</span> (<span>tdsType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>))</td>
      </tr>
      <tr>
        <td id="L5355" data-line-number="5355"></td>
        <td id="LC5355">            {</td>
      </tr>
      <tr>
        <td id="L5356" data-line-number="5356"></td>
        <td id="LC5356">                <span>if</span> (<span>!</span><span>TryProcessCollation</span>(<span>stateObj</span>, <span>out</span> <span>col</span>.<span>collation</span>))</td>
      </tr>
      <tr>
        <td id="L5357" data-line-number="5357"></td>
        <td id="LC5357">                {</td>
      </tr>
      <tr>
        <td id="L5358" data-line-number="5358"></td>
        <td id="LC5358">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5359" data-line-number="5359"></td>
        <td id="LC5359">                }</td>
      </tr>
      <tr>
        <td id="L5360" data-line-number="5360"></td>
        <td id="LC5360">
</td>
      </tr>
      <tr>
        <td id="L5361" data-line-number="5361"></td>
        <td id="LC5361">                <span>if</span> ((<span>col</span>.<span>collation</span>.<span>info</span> <span>&amp;</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>) <span>==</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>)</td>
      </tr>
      <tr>
        <td id="L5362" data-line-number="5362"></td>
        <td id="LC5362">                { <span><span>//</span> UTF8 collation</span></td>
      </tr>
      <tr>
        <td id="L5363" data-line-number="5363"></td>
        <td id="LC5363">                    <span>col</span>.<span>encoding</span> <span>=</span> <span>Encoding</span>.<span>UTF8</span>;</td>
      </tr>
      <tr>
        <td id="L5364" data-line-number="5364"></td>
        <td id="LC5364">                }</td>
      </tr>
      <tr>
        <td id="L5365" data-line-number="5365"></td>
        <td id="LC5365">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L5366" data-line-number="5366"></td>
        <td id="LC5366">                {</td>
      </tr>
      <tr>
        <td id="L5367" data-line-number="5367"></td>
        <td id="LC5367">                    <span>int</span> <span>codePage</span> <span>=</span> <span>GetCodePage</span>(<span>col</span>.<span>collation</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L5368" data-line-number="5368"></td>
        <td id="LC5368">
</td>
      </tr>
      <tr>
        <td id="L5369" data-line-number="5369"></td>
        <td id="LC5369">                    <span>if</span> (<span>codePage</span> <span>==</span> <span>_defaultCodePage</span>)</td>
      </tr>
      <tr>
        <td id="L5370" data-line-number="5370"></td>
        <td id="LC5370">                    {</td>
      </tr>
      <tr>
        <td id="L5371" data-line-number="5371"></td>
        <td id="LC5371">                        <span>col</span>.<span>codePage</span> <span>=</span> <span>_defaultCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L5372" data-line-number="5372"></td>
        <td id="LC5372">                        <span>col</span>.<span>encoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L5373" data-line-number="5373"></td>
        <td id="LC5373">                    }</td>
      </tr>
      <tr>
        <td id="L5374" data-line-number="5374"></td>
        <td id="LC5374">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L5375" data-line-number="5375"></td>
        <td id="LC5375">                    {</td>
      </tr>
      <tr>
        <td id="L5376" data-line-number="5376"></td>
        <td id="LC5376">                        <span>col</span>.<span>codePage</span> <span>=</span> <span>codePage</span>;</td>
      </tr>
      <tr>
        <td id="L5377" data-line-number="5377"></td>
        <td id="LC5377">                        <span>col</span>.<span>encoding</span> <span>=</span> <span>System</span>.<span>Text</span>.<span>Encoding</span>.<span>GetEncoding</span>(<span>col</span>.<span>codePage</span>);</td>
      </tr>
      <tr>
        <td id="L5378" data-line-number="5378"></td>
        <td id="LC5378">                    }</td>
      </tr>
      <tr>
        <td id="L5379" data-line-number="5379"></td>
        <td id="LC5379">                }</td>
      </tr>
      <tr>
        <td id="L5380" data-line-number="5380"></td>
        <td id="LC5380">            }</td>
      </tr>
      <tr>
        <td id="L5381" data-line-number="5381"></td>
        <td id="LC5381">
</td>
      </tr>
      <tr>
        <td id="L5382" data-line-number="5382"></td>
        <td id="LC5382">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5383" data-line-number="5383"></td>
        <td id="LC5383">        }</td>
      </tr>
      <tr>
        <td id="L5384" data-line-number="5384"></td>
        <td id="LC5384">
</td>
      </tr>
      <tr>
        <td id="L5385" data-line-number="5385"></td>
        <td id="LC5385">        <span>private</span> <span>bool</span> <span>TryCommonProcessMetaData</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>_SqlMetaData</span> <span>col</span>, <span>SqlTceCipherInfoTable</span>? <span>cipherTable</span>, <span>bool</span> <span>fColMD</span>, <span>SqlCommandColumnEncryptionSetting</span> <span>columnEncryptionSetting</span>)</td>
      </tr>
      <tr>
        <td id="L5386" data-line-number="5386"></td>
        <td id="LC5386">        {</td>
      </tr>
      <tr>
        <td id="L5387" data-line-number="5387"></td>
        <td id="LC5387">            <span>byte</span> <span>byteLen</span>;</td>
      </tr>
      <tr>
        <td id="L5388" data-line-number="5388"></td>
        <td id="LC5388">            <span>UInt32</span> <span>userType</span>;</td>
      </tr>
      <tr>
        <td id="L5389" data-line-number="5389"></td>
        <td id="LC5389">
</td>
      </tr>
      <tr>
        <td id="L5390" data-line-number="5390"></td>
        <td id="LC5390">            <span><span>//</span> read user type - 4 bytes Yukon, 2 backwards</span></td>
      </tr>
      <tr>
        <td id="L5391" data-line-number="5391"></td>
        <td id="LC5391">            <span>if</span> (<span>IsYukonOrNewer</span>)</td>
      </tr>
      <tr>
        <td id="L5392" data-line-number="5392"></td>
        <td id="LC5392">            {</td>
      </tr>
      <tr>
        <td id="L5393" data-line-number="5393"></td>
        <td id="LC5393">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>userType</span>))</td>
      </tr>
      <tr>
        <td id="L5394" data-line-number="5394"></td>
        <td id="LC5394">                {</td>
      </tr>
      <tr>
        <td id="L5395" data-line-number="5395"></td>
        <td id="LC5395">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5396" data-line-number="5396"></td>
        <td id="LC5396">                }</td>
      </tr>
      <tr>
        <td id="L5397" data-line-number="5397"></td>
        <td id="LC5397">            }</td>
      </tr>
      <tr>
        <td id="L5398" data-line-number="5398"></td>
        <td id="LC5398">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5399" data-line-number="5399"></td>
        <td id="LC5399">            {</td>
      </tr>
      <tr>
        <td id="L5400" data-line-number="5400"></td>
        <td id="LC5400">                <span>ushort</span> <span>userTypeShort</span>;</td>
      </tr>
      <tr>
        <td id="L5401" data-line-number="5401"></td>
        <td id="LC5401">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>userTypeShort</span>))</td>
      </tr>
      <tr>
        <td id="L5402" data-line-number="5402"></td>
        <td id="LC5402">                {</td>
      </tr>
      <tr>
        <td id="L5403" data-line-number="5403"></td>
        <td id="LC5403">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5404" data-line-number="5404"></td>
        <td id="LC5404">                }</td>
      </tr>
      <tr>
        <td id="L5405" data-line-number="5405"></td>
        <td id="LC5405">                <span>userType</span> <span>=</span> <span>userTypeShort</span>;</td>
      </tr>
      <tr>
        <td id="L5406" data-line-number="5406"></td>
        <td id="LC5406">            }</td>
      </tr>
      <tr>
        <td id="L5407" data-line-number="5407"></td>
        <td id="LC5407">
</td>
      </tr>
      <tr>
        <td id="L5408" data-line-number="5408"></td>
        <td id="LC5408">            <span><span>//</span> read flags and set appropriate flags in structure</span></td>
      </tr>
      <tr>
        <td id="L5409" data-line-number="5409"></td>
        <td id="LC5409">            <span>byte</span> <span>flags</span>;</td>
      </tr>
      <tr>
        <td id="L5410" data-line-number="5410"></td>
        <td id="LC5410">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>flags</span>))</td>
      </tr>
      <tr>
        <td id="L5411" data-line-number="5411"></td>
        <td id="LC5411">            {</td>
      </tr>
      <tr>
        <td id="L5412" data-line-number="5412"></td>
        <td id="LC5412">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5413" data-line-number="5413"></td>
        <td id="LC5413">            }</td>
      </tr>
      <tr>
        <td id="L5414" data-line-number="5414"></td>
        <td id="LC5414">
</td>
      </tr>
      <tr>
        <td id="L5415" data-line-number="5415"></td>
        <td id="LC5415">            <span>col</span>.<span>Updatability</span> <span>=</span> (<span>byte</span>)((<span>flags</span> <span>&amp;</span> <span>TdsEnums</span>.<span>Updatability</span>) <span>&gt;&gt;</span> <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L5416" data-line-number="5416"></td>
        <td id="LC5416">            <span>col</span>.<span>IsNullable</span> <span>=</span> (<span>TdsEnums</span>.<span>Nullable</span> <span>==</span> (<span>flags</span> <span>&amp;</span> <span>TdsEnums</span>.<span>Nullable</span>));</td>
      </tr>
      <tr>
        <td id="L5417" data-line-number="5417"></td>
        <td id="LC5417">            <span>col</span>.<span>IsIdentity</span> <span>=</span> (<span>TdsEnums</span>.<span>Identity</span> <span>==</span> (<span>flags</span> <span>&amp;</span> <span>TdsEnums</span>.<span>Identity</span>));</td>
      </tr>
      <tr>
        <td id="L5418" data-line-number="5418"></td>
        <td id="LC5418">
</td>
      </tr>
      <tr>
        <td id="L5419" data-line-number="5419"></td>
        <td id="LC5419">            <span><span>//</span> read second byte of column metadata flags</span></td>
      </tr>
      <tr>
        <td id="L5420" data-line-number="5420"></td>
        <td id="LC5420">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>flags</span>))</td>
      </tr>
      <tr>
        <td id="L5421" data-line-number="5421"></td>
        <td id="LC5421">            {</td>
      </tr>
      <tr>
        <td id="L5422" data-line-number="5422"></td>
        <td id="LC5422">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5423" data-line-number="5423"></td>
        <td id="LC5423">            }</td>
      </tr>
      <tr>
        <td id="L5424" data-line-number="5424"></td>
        <td id="LC5424">
</td>
      </tr>
      <tr>
        <td id="L5425" data-line-number="5425"></td>
        <td id="LC5425">            <span>col</span>.<span>IsColumnSet</span> <span>=</span> (<span>TdsEnums</span>.<span>IsColumnSet</span> <span>==</span> (<span>flags</span> <span>&amp;</span> <span>TdsEnums</span>.<span>IsColumnSet</span>));</td>
      </tr>
      <tr>
        <td id="L5426" data-line-number="5426"></td>
        <td id="LC5426">            <span>if</span> (<span>fColMD</span> <span>&amp;&amp;</span> <span>_serverSupportsColumnEncryption</span>)</td>
      </tr>
      <tr>
        <td id="L5427" data-line-number="5427"></td>
        <td id="LC5427">            {</td>
      </tr>
      <tr>
        <td id="L5428" data-line-number="5428"></td>
        <td id="LC5428">                <span>col</span>.<span>isEncrypted</span> <span>=</span> (<span>TdsEnums</span>.<span>IsEncrypted</span> <span>==</span> (<span>flags</span> <span>&amp;</span> <span>TdsEnums</span>.<span>IsEncrypted</span>));</td>
      </tr>
      <tr>
        <td id="L5429" data-line-number="5429"></td>
        <td id="LC5429">            }</td>
      </tr>
      <tr>
        <td id="L5430" data-line-number="5430"></td>
        <td id="LC5430">
</td>
      </tr>
      <tr>
        <td id="L5431" data-line-number="5431"></td>
        <td id="LC5431">            <span><span>//</span> Read TypeInfo</span></td>
      </tr>
      <tr>
        <td id="L5432" data-line-number="5432"></td>
        <td id="LC5432">            <span>if</span> (<span>!</span><span>TryProcessTypeInfo</span>(<span>stateObj</span>, <span>col</span>, <span>userType</span>))</td>
      </tr>
      <tr>
        <td id="L5433" data-line-number="5433"></td>
        <td id="LC5433">            {</td>
      </tr>
      <tr>
        <td id="L5434" data-line-number="5434"></td>
        <td id="LC5434">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5435" data-line-number="5435"></td>
        <td id="LC5435">            }</td>
      </tr>
      <tr>
        <td id="L5436" data-line-number="5436"></td>
        <td id="LC5436">
</td>
      </tr>
      <tr>
        <td id="L5437" data-line-number="5437"></td>
        <td id="LC5437">            <span><span>//</span> Read tablename if present</span></td>
      </tr>
      <tr>
        <td id="L5438" data-line-number="5438"></td>
        <td id="LC5438">            <span>if</span> (<span>col</span>.<span>metaType</span>.<span>IsLong</span> <span>&amp;&amp;</span> <span>!</span><span>col</span>.<span>metaType</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L5439" data-line-number="5439"></td>
        <td id="LC5439">            {</td>
      </tr>
      <tr>
        <td id="L5440" data-line-number="5440"></td>
        <td id="LC5440">                <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L5441" data-line-number="5441"></td>
        <td id="LC5441">                {</td>
      </tr>
      <tr>
        <td id="L5442" data-line-number="5442"></td>
        <td id="LC5442">                    <span>int</span> <span>unusedLen</span> <span>=</span> <span>0xFFFF</span>;      <span><span>//</span>We ignore this value</span></td>
      </tr>
      <tr>
        <td id="L5443" data-line-number="5443"></td>
        <td id="LC5443">                    <span>if</span> (<span>!</span><span>TryProcessOneTable</span>(<span>stateObj</span>, <span>ref</span> <span>unusedLen</span>, <span>out</span> <span>col</span>.<span>multiPartTableName</span>))</td>
      </tr>
      <tr>
        <td id="L5444" data-line-number="5444"></td>
        <td id="LC5444">                    {</td>
      </tr>
      <tr>
        <td id="L5445" data-line-number="5445"></td>
        <td id="LC5445">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5446" data-line-number="5446"></td>
        <td id="LC5446">                    }</td>
      </tr>
      <tr>
        <td id="L5447" data-line-number="5447"></td>
        <td id="LC5447">                }</td>
      </tr>
      <tr>
        <td id="L5448" data-line-number="5448"></td>
        <td id="LC5448">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L5449" data-line-number="5449"></td>
        <td id="LC5449">                {</td>
      </tr>
      <tr>
        <td id="L5450" data-line-number="5450"></td>
        <td id="LC5450">                    <span>ushort</span> <span>shortLen</span>;</td>
      </tr>
      <tr>
        <td id="L5451" data-line-number="5451"></td>
        <td id="LC5451">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortLen</span>))</td>
      </tr>
      <tr>
        <td id="L5452" data-line-number="5452"></td>
        <td id="LC5452">                    {</td>
      </tr>
      <tr>
        <td id="L5453" data-line-number="5453"></td>
        <td id="LC5453">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5454" data-line-number="5454"></td>
        <td id="LC5454">                    }</td>
      </tr>
      <tr>
        <td id="L5455" data-line-number="5455"></td>
        <td id="LC5455">                    <span>string</span> <span>tableName</span>;</td>
      </tr>
      <tr>
        <td id="L5456" data-line-number="5456"></td>
        <td id="LC5456">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>shortLen</span>, <span>out</span> <span>tableName</span>))</td>
      </tr>
      <tr>
        <td id="L5457" data-line-number="5457"></td>
        <td id="LC5457">                    {</td>
      </tr>
      <tr>
        <td id="L5458" data-line-number="5458"></td>
        <td id="LC5458">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5459" data-line-number="5459"></td>
        <td id="LC5459">                    }</td>
      </tr>
      <tr>
        <td id="L5460" data-line-number="5460"></td>
        <td id="LC5460">                    <span><span>//</span> with Sql2000 this is returned as an unquoted mix of catalog.owner.table</span></td>
      </tr>
      <tr>
        <td id="L5461" data-line-number="5461"></td>
        <td id="LC5461">                    <span><span>//</span> all of which may contain "." and unable to parse correctly from the string alone</span></td>
      </tr>
      <tr>
        <td id="L5462" data-line-number="5462"></td>
        <td id="LC5462">                    <span><span>//</span> example "select * from pubs..[A.B.C.D.E]" AND only when * will contain a image/text/ntext column</span></td>
      </tr>
      <tr>
        <td id="L5463" data-line-number="5463"></td>
        <td id="LC5463">                    <span><span>//</span> by delay parsing from execute to SqlDataReader.GetSchemaTable to enable more scenarios</span></td>
      </tr>
      <tr>
        <td id="L5464" data-line-number="5464"></td>
        <td id="LC5464">                    <span>col</span>.<span>multiPartTableName</span> <span>=</span> <span>new</span> <span>MultiPartTableName</span>(<span>tableName</span>);</td>
      </tr>
      <tr>
        <td id="L5465" data-line-number="5465"></td>
        <td id="LC5465">                }</td>
      </tr>
      <tr>
        <td id="L5466" data-line-number="5466"></td>
        <td id="LC5466">            }</td>
      </tr>
      <tr>
        <td id="L5467" data-line-number="5467"></td>
        <td id="LC5467">
</td>
      </tr>
      <tr>
        <td id="L5468" data-line-number="5468"></td>
        <td id="LC5468">            <span><span>//</span> Read the TCE column cryptoinfo</span></td>
      </tr>
      <tr>
        <td id="L5469" data-line-number="5469"></td>
        <td id="LC5469">            <span>if</span> (<span>fColMD</span> <span>&amp;&amp;</span> <span>_serverSupportsColumnEncryption</span> <span>&amp;&amp;</span> <span>col</span>.<span>isEncrypted</span>)</td>
      </tr>
      <tr>
        <td id="L5470" data-line-number="5470"></td>
        <td id="LC5470">            {</td>
      </tr>
      <tr>
        <td id="L5471" data-line-number="5471"></td>
        <td id="LC5471">                <span><span>//</span> If the column is encrypted, we should have a valid cipherTable</span></td>
      </tr>
      <tr>
        <td id="L5472" data-line-number="5472"></td>
        <td id="LC5472">                <span>if</span> (<span>cipherTable</span>.<span>HasValue</span> <span>&amp;&amp;</span> <span>!</span><span>TryProcessTceCryptoMetadata</span>(<span>stateObj</span>, <span>col</span>, <span>cipherTable</span>.<span>Value</span>, <span>columnEncryptionSetting</span>, <span>isReturnValue</span>: <span>false</span>))</td>
      </tr>
      <tr>
        <td id="L5473" data-line-number="5473"></td>
        <td id="LC5473">                {</td>
      </tr>
      <tr>
        <td id="L5474" data-line-number="5474"></td>
        <td id="LC5474">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5475" data-line-number="5475"></td>
        <td id="LC5475">                }</td>
      </tr>
      <tr>
        <td id="L5476" data-line-number="5476"></td>
        <td id="LC5476">            }</td>
      </tr>
      <tr>
        <td id="L5477" data-line-number="5477"></td>
        <td id="LC5477">
</td>
      </tr>
      <tr>
        <td id="L5478" data-line-number="5478"></td>
        <td id="LC5478">            <span><span>//</span> Read the column name</span></td>
      </tr>
      <tr>
        <td id="L5479" data-line-number="5479"></td>
        <td id="LC5479">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLen</span>))</td>
      </tr>
      <tr>
        <td id="L5480" data-line-number="5480"></td>
        <td id="LC5480">            {</td>
      </tr>
      <tr>
        <td id="L5481" data-line-number="5481"></td>
        <td id="LC5481">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5482" data-line-number="5482"></td>
        <td id="LC5482">            }</td>
      </tr>
      <tr>
        <td id="L5483" data-line-number="5483"></td>
        <td id="LC5483">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLen</span>, <span>out</span> <span>col</span>.<span>column</span>))</td>
      </tr>
      <tr>
        <td id="L5484" data-line-number="5484"></td>
        <td id="LC5484">            {</td>
      </tr>
      <tr>
        <td id="L5485" data-line-number="5485"></td>
        <td id="LC5485">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5486" data-line-number="5486"></td>
        <td id="LC5486">            }</td>
      </tr>
      <tr>
        <td id="L5487" data-line-number="5487"></td>
        <td id="LC5487">
</td>
      </tr>
      <tr>
        <td id="L5488" data-line-number="5488"></td>
        <td id="LC5488">            <span><span>//</span> We get too many DONE COUNTs from the server, causing too meany StatementCompleted event firings.</span></td>
      </tr>
      <tr>
        <td id="L5489" data-line-number="5489"></td>
        <td id="LC5489">            <span><span>//</span> We only need to fire this event when we actually have a meta data stream with 0 or more rows.</span></td>
      </tr>
      <tr>
        <td id="L5490" data-line-number="5490"></td>
        <td id="LC5490">            <span>stateObj</span>.<span>_receivedColMetaData</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5491" data-line-number="5491"></td>
        <td id="LC5491">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5492" data-line-number="5492"></td>
        <td id="LC5492">        }</td>
      </tr>
      <tr>
        <td id="L5493" data-line-number="5493"></td>
        <td id="LC5493">
</td>
      </tr>
      <tr>
        <td id="L5494" data-line-number="5494"></td>
        <td id="LC5494">        <span>private</span> <span>bool</span> <span>TryProcessUDTMetaData</span>(<span>SqlMetaDataPriv</span> <span>metaData</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L5495" data-line-number="5495"></td>
        <td id="LC5495">        {</td>
      </tr>
      <tr>
        <td id="L5496" data-line-number="5496"></td>
        <td id="LC5496">            <span>ushort</span> <span>shortLength</span>;</td>
      </tr>
      <tr>
        <td id="L5497" data-line-number="5497"></td>
        <td id="LC5497">            <span>byte</span> <span>byteLength</span>;</td>
      </tr>
      <tr>
        <td id="L5498" data-line-number="5498"></td>
        <td id="LC5498">
</td>
      </tr>
      <tr>
        <td id="L5499" data-line-number="5499"></td>
        <td id="LC5499">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortLength</span>))</td>
      </tr>
      <tr>
        <td id="L5500" data-line-number="5500"></td>
        <td id="LC5500">            { <span><span>//</span> max byte size</span></td>
      </tr>
      <tr>
        <td id="L5501" data-line-number="5501"></td>
        <td id="LC5501">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5502" data-line-number="5502"></td>
        <td id="LC5502">            }</td>
      </tr>
      <tr>
        <td id="L5503" data-line-number="5503"></td>
        <td id="LC5503">            <span>metaData</span>.<span>length</span> <span>=</span> <span>shortLength</span>;</td>
      </tr>
      <tr>
        <td id="L5504" data-line-number="5504"></td>
        <td id="LC5504">
</td>
      </tr>
      <tr>
        <td id="L5505" data-line-number="5505"></td>
        <td id="LC5505">            <span><span>//</span> database name</span></td>
      </tr>
      <tr>
        <td id="L5506" data-line-number="5506"></td>
        <td id="LC5506">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L5507" data-line-number="5507"></td>
        <td id="LC5507">            {</td>
      </tr>
      <tr>
        <td id="L5508" data-line-number="5508"></td>
        <td id="LC5508">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5509" data-line-number="5509"></td>
        <td id="LC5509">            }</td>
      </tr>
      <tr>
        <td id="L5510" data-line-number="5510"></td>
        <td id="LC5510">            <span>if</span> (<span>metaData</span>.<span>udt</span> <span>is</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L5511" data-line-number="5511"></td>
        <td id="LC5511">            {</td>
      </tr>
      <tr>
        <td id="L5512" data-line-number="5512"></td>
        <td id="LC5512">                <span>metaData</span>.<span>udt</span> <span>=</span> <span>new</span> <span>SqlMetaDataUdt</span>();</td>
      </tr>
      <tr>
        <td id="L5513" data-line-number="5513"></td>
        <td id="LC5513">            }</td>
      </tr>
      <tr>
        <td id="L5514" data-line-number="5514"></td>
        <td id="LC5514">            <span>if</span> (<span>byteLength</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5515" data-line-number="5515"></td>
        <td id="LC5515">            {</td>
      </tr>
      <tr>
        <td id="L5516" data-line-number="5516"></td>
        <td id="LC5516">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLength</span>, <span>out</span> <span>metaData</span>.<span>udt</span>.<span>DatabaseName</span>))</td>
      </tr>
      <tr>
        <td id="L5517" data-line-number="5517"></td>
        <td id="LC5517">                {</td>
      </tr>
      <tr>
        <td id="L5518" data-line-number="5518"></td>
        <td id="LC5518">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5519" data-line-number="5519"></td>
        <td id="LC5519">                }</td>
      </tr>
      <tr>
        <td id="L5520" data-line-number="5520"></td>
        <td id="LC5520">            }</td>
      </tr>
      <tr>
        <td id="L5521" data-line-number="5521"></td>
        <td id="LC5521">
</td>
      </tr>
      <tr>
        <td id="L5522" data-line-number="5522"></td>
        <td id="LC5522">            <span><span>//</span> schema name</span></td>
      </tr>
      <tr>
        <td id="L5523" data-line-number="5523"></td>
        <td id="LC5523">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L5524" data-line-number="5524"></td>
        <td id="LC5524">            {</td>
      </tr>
      <tr>
        <td id="L5525" data-line-number="5525"></td>
        <td id="LC5525">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5526" data-line-number="5526"></td>
        <td id="LC5526">            }</td>
      </tr>
      <tr>
        <td id="L5527" data-line-number="5527"></td>
        <td id="LC5527">            <span>if</span> (<span>byteLength</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5528" data-line-number="5528"></td>
        <td id="LC5528">            {</td>
      </tr>
      <tr>
        <td id="L5529" data-line-number="5529"></td>
        <td id="LC5529">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLength</span>, <span>out</span> <span>metaData</span>.<span>udt</span>.<span>SchemaName</span>))</td>
      </tr>
      <tr>
        <td id="L5530" data-line-number="5530"></td>
        <td id="LC5530">                {</td>
      </tr>
      <tr>
        <td id="L5531" data-line-number="5531"></td>
        <td id="LC5531">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5532" data-line-number="5532"></td>
        <td id="LC5532">                }</td>
      </tr>
      <tr>
        <td id="L5533" data-line-number="5533"></td>
        <td id="LC5533">            }</td>
      </tr>
      <tr>
        <td id="L5534" data-line-number="5534"></td>
        <td id="LC5534">
</td>
      </tr>
      <tr>
        <td id="L5535" data-line-number="5535"></td>
        <td id="LC5535">            <span><span>//</span> type name</span></td>
      </tr>
      <tr>
        <td id="L5536" data-line-number="5536"></td>
        <td id="LC5536">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteLength</span>))</td>
      </tr>
      <tr>
        <td id="L5537" data-line-number="5537"></td>
        <td id="LC5537">            {</td>
      </tr>
      <tr>
        <td id="L5538" data-line-number="5538"></td>
        <td id="LC5538">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5539" data-line-number="5539"></td>
        <td id="LC5539">            }</td>
      </tr>
      <tr>
        <td id="L5540" data-line-number="5540"></td>
        <td id="LC5540">            <span>if</span> (<span>byteLength</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5541" data-line-number="5541"></td>
        <td id="LC5541">            {</td>
      </tr>
      <tr>
        <td id="L5542" data-line-number="5542"></td>
        <td id="LC5542">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>byteLength</span>, <span>out</span> <span>metaData</span>.<span>udt</span>.<span>TypeName</span>))</td>
      </tr>
      <tr>
        <td id="L5543" data-line-number="5543"></td>
        <td id="LC5543">                {</td>
      </tr>
      <tr>
        <td id="L5544" data-line-number="5544"></td>
        <td id="LC5544">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5545" data-line-number="5545"></td>
        <td id="LC5545">                }</td>
      </tr>
      <tr>
        <td id="L5546" data-line-number="5546"></td>
        <td id="LC5546">            }</td>
      </tr>
      <tr>
        <td id="L5547" data-line-number="5547"></td>
        <td id="LC5547">
</td>
      </tr>
      <tr>
        <td id="L5548" data-line-number="5548"></td>
        <td id="LC5548">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortLength</span>))</td>
      </tr>
      <tr>
        <td id="L5549" data-line-number="5549"></td>
        <td id="LC5549">            {</td>
      </tr>
      <tr>
        <td id="L5550" data-line-number="5550"></td>
        <td id="LC5550">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5551" data-line-number="5551"></td>
        <td id="LC5551">            }</td>
      </tr>
      <tr>
        <td id="L5552" data-line-number="5552"></td>
        <td id="LC5552">            <span>if</span> (<span>shortLength</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5553" data-line-number="5553"></td>
        <td id="LC5553">            {</td>
      </tr>
      <tr>
        <td id="L5554" data-line-number="5554"></td>
        <td id="LC5554">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>shortLength</span>, <span>out</span> <span>metaData</span>.<span>udt</span>.<span>AssemblyQualifiedName</span>))</td>
      </tr>
      <tr>
        <td id="L5555" data-line-number="5555"></td>
        <td id="LC5555">                {</td>
      </tr>
      <tr>
        <td id="L5556" data-line-number="5556"></td>
        <td id="LC5556">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5557" data-line-number="5557"></td>
        <td id="LC5557">                }</td>
      </tr>
      <tr>
        <td id="L5558" data-line-number="5558"></td>
        <td id="LC5558">            }</td>
      </tr>
      <tr>
        <td id="L5559" data-line-number="5559"></td>
        <td id="LC5559">
</td>
      </tr>
      <tr>
        <td id="L5560" data-line-number="5560"></td>
        <td id="LC5560">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5561" data-line-number="5561"></td>
        <td id="LC5561">        }</td>
      </tr>
      <tr>
        <td id="L5562" data-line-number="5562"></td>
        <td id="LC5562">
</td>
      </tr>
      <tr>
        <td id="L5563" data-line-number="5563"></td>
        <td id="LC5563">        <span>private</span> <span>void</span> <span>WriteUDTMetaData</span>(<span>object</span> <span>value</span>, <span>string</span> <span>database</span>, <span>string</span> <span>schema</span>, <span>string</span> <span>type</span>,</td>
      </tr>
      <tr>
        <td id="L5564" data-line-number="5564"></td>
        <td id="LC5564">                                        <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L5565" data-line-number="5565"></td>
        <td id="LC5565">        {</td>
      </tr>
      <tr>
        <td id="L5566" data-line-number="5566"></td>
        <td id="LC5566">            <span><span>//</span> database</span></td>
      </tr>
      <tr>
        <td id="L5567" data-line-number="5567"></td>
        <td id="LC5567">            <span>if</span> (<span>ADP</span>.<span>IsEmpty</span>(<span>database</span>))</td>
      </tr>
      <tr>
        <td id="L5568" data-line-number="5568"></td>
        <td id="LC5568">            {</td>
      </tr>
      <tr>
        <td id="L5569" data-line-number="5569"></td>
        <td id="LC5569">                <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L5570" data-line-number="5570"></td>
        <td id="LC5570">            }</td>
      </tr>
      <tr>
        <td id="L5571" data-line-number="5571"></td>
        <td id="LC5571">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5572" data-line-number="5572"></td>
        <td id="LC5572">            {</td>
      </tr>
      <tr>
        <td id="L5573" data-line-number="5573"></td>
        <td id="LC5573">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>database</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L5574" data-line-number="5574"></td>
        <td id="LC5574">                <span>WriteString</span>(<span>database</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L5575" data-line-number="5575"></td>
        <td id="LC5575">            }</td>
      </tr>
      <tr>
        <td id="L5576" data-line-number="5576"></td>
        <td id="LC5576">
</td>
      </tr>
      <tr>
        <td id="L5577" data-line-number="5577"></td>
        <td id="LC5577">            <span><span>//</span> schema</span></td>
      </tr>
      <tr>
        <td id="L5578" data-line-number="5578"></td>
        <td id="LC5578">            <span>if</span> (<span>ADP</span>.<span>IsEmpty</span>(<span>schema</span>))</td>
      </tr>
      <tr>
        <td id="L5579" data-line-number="5579"></td>
        <td id="LC5579">            {</td>
      </tr>
      <tr>
        <td id="L5580" data-line-number="5580"></td>
        <td id="LC5580">                <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L5581" data-line-number="5581"></td>
        <td id="LC5581">            }</td>
      </tr>
      <tr>
        <td id="L5582" data-line-number="5582"></td>
        <td id="LC5582">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5583" data-line-number="5583"></td>
        <td id="LC5583">            {</td>
      </tr>
      <tr>
        <td id="L5584" data-line-number="5584"></td>
        <td id="LC5584">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>schema</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L5585" data-line-number="5585"></td>
        <td id="LC5585">                <span>WriteString</span>(<span>schema</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L5586" data-line-number="5586"></td>
        <td id="LC5586">            }</td>
      </tr>
      <tr>
        <td id="L5587" data-line-number="5587"></td>
        <td id="LC5587">
</td>
      </tr>
      <tr>
        <td id="L5588" data-line-number="5588"></td>
        <td id="LC5588">            <span><span>//</span> type</span></td>
      </tr>
      <tr>
        <td id="L5589" data-line-number="5589"></td>
        <td id="LC5589">            <span>if</span> (<span>ADP</span>.<span>IsEmpty</span>(<span>type</span>))</td>
      </tr>
      <tr>
        <td id="L5590" data-line-number="5590"></td>
        <td id="LC5590">            {</td>
      </tr>
      <tr>
        <td id="L5591" data-line-number="5591"></td>
        <td id="LC5591">                <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L5592" data-line-number="5592"></td>
        <td id="LC5592">            }</td>
      </tr>
      <tr>
        <td id="L5593" data-line-number="5593"></td>
        <td id="LC5593">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5594" data-line-number="5594"></td>
        <td id="LC5594">            {</td>
      </tr>
      <tr>
        <td id="L5595" data-line-number="5595"></td>
        <td id="LC5595">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>type</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L5596" data-line-number="5596"></td>
        <td id="LC5596">                <span>WriteString</span>(<span>type</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L5597" data-line-number="5597"></td>
        <td id="LC5597">            }</td>
      </tr>
      <tr>
        <td id="L5598" data-line-number="5598"></td>
        <td id="LC5598">        }</td>
      </tr>
      <tr>
        <td id="L5599" data-line-number="5599"></td>
        <td id="LC5599">
</td>
      </tr>
      <tr>
        <td id="L5600" data-line-number="5600"></td>
        <td id="LC5600">        <span>internal</span> <span>bool</span> <span>TryProcessTableName</span>(<span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>MultiPartTableName</span>[] <span>multiPartTableNames</span>)</td>
      </tr>
      <tr>
        <td id="L5601" data-line-number="5601"></td>
        <td id="LC5601">        {</td>
      </tr>
      <tr>
        <td id="L5602" data-line-number="5602"></td>
        <td id="LC5602">            <span>int</span> <span>tablesAdded</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5603" data-line-number="5603"></td>
        <td id="LC5603">
</td>
      </tr>
      <tr>
        <td id="L5604" data-line-number="5604"></td>
        <td id="LC5604">            <span>MultiPartTableName</span>[] <span>tables</span> <span>=</span> <span>new</span> <span>MultiPartTableName</span>[<span>1</span>];</td>
      </tr>
      <tr>
        <td id="L5605" data-line-number="5605"></td>
        <td id="LC5605">            <span>MultiPartTableName</span> <span>mpt</span>;</td>
      </tr>
      <tr>
        <td id="L5606" data-line-number="5606"></td>
        <td id="LC5606">            <span>while</span> (<span>length</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5607" data-line-number="5607"></td>
        <td id="LC5607">            {</td>
      </tr>
      <tr>
        <td id="L5608" data-line-number="5608"></td>
        <td id="LC5608">                <span><span>//</span> UNDONE: BUG(?) SQL 8.003 returns two tables sometimes</span></td>
      </tr>
      <tr>
        <td id="L5609" data-line-number="5609"></td>
        <td id="LC5609">                <span><span>//</span> (select orderid from orders where orderid &lt; ?)</span></td>
      </tr>
      <tr>
        <td id="L5610" data-line-number="5610"></td>
        <td id="LC5610">                <span><span>//</span> need to investigate</span></td>
      </tr>
      <tr>
        <td id="L5611" data-line-number="5611"></td>
        <td id="LC5611">                <span>if</span> (<span>!</span><span>TryProcessOneTable</span>(<span>stateObj</span>, <span>ref</span> <span>length</span>, <span>out</span> <span>mpt</span>))</td>
      </tr>
      <tr>
        <td id="L5612" data-line-number="5612"></td>
        <td id="LC5612">                {</td>
      </tr>
      <tr>
        <td id="L5613" data-line-number="5613"></td>
        <td id="LC5613">                    <span>multiPartTableNames</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L5614" data-line-number="5614"></td>
        <td id="LC5614">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5615" data-line-number="5615"></td>
        <td id="LC5615">                }</td>
      </tr>
      <tr>
        <td id="L5616" data-line-number="5616"></td>
        <td id="LC5616">                <span>if</span> (<span>tablesAdded</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5617" data-line-number="5617"></td>
        <td id="LC5617">                {</td>
      </tr>
      <tr>
        <td id="L5618" data-line-number="5618"></td>
        <td id="LC5618">                    <span>tables</span>[<span>tablesAdded</span>] <span>=</span> <span>mpt</span>;</td>
      </tr>
      <tr>
        <td id="L5619" data-line-number="5619"></td>
        <td id="LC5619">                }</td>
      </tr>
      <tr>
        <td id="L5620" data-line-number="5620"></td>
        <td id="LC5620">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L5621" data-line-number="5621"></td>
        <td id="LC5621">                {</td>
      </tr>
      <tr>
        <td id="L5622" data-line-number="5622"></td>
        <td id="LC5622">                    <span>MultiPartTableName</span>[] <span>newTables</span> <span>=</span> <span>new</span> <span>MultiPartTableName</span>[<span>tables</span>.<span>Length</span> <span>+</span> <span>1</span>];</td>
      </tr>
      <tr>
        <td id="L5623" data-line-number="5623"></td>
        <td id="LC5623">                    <span>Array</span>.<span>Copy</span>(<span>tables</span>, <span>0</span>, <span>newTables</span>, <span>0</span>, <span>tables</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L5624" data-line-number="5624"></td>
        <td id="LC5624">                    <span>newTables</span>[<span>tables</span>.<span>Length</span>] <span>=</span> <span>mpt</span>;</td>
      </tr>
      <tr>
        <td id="L5625" data-line-number="5625"></td>
        <td id="LC5625">                    <span>tables</span> <span>=</span> <span>newTables</span>;</td>
      </tr>
      <tr>
        <td id="L5626" data-line-number="5626"></td>
        <td id="LC5626">                }</td>
      </tr>
      <tr>
        <td id="L5627" data-line-number="5627"></td>
        <td id="LC5627">
</td>
      </tr>
      <tr>
        <td id="L5628" data-line-number="5628"></td>
        <td id="LC5628">                <span>tablesAdded</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L5629" data-line-number="5629"></td>
        <td id="LC5629">            }</td>
      </tr>
      <tr>
        <td id="L5630" data-line-number="5630"></td>
        <td id="LC5630">
</td>
      </tr>
      <tr>
        <td id="L5631" data-line-number="5631"></td>
        <td id="LC5631">            <span>multiPartTableNames</span> <span>=</span> <span>tables</span>;</td>
      </tr>
      <tr>
        <td id="L5632" data-line-number="5632"></td>
        <td id="LC5632">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5633" data-line-number="5633"></td>
        <td id="LC5633">        }</td>
      </tr>
      <tr>
        <td id="L5634" data-line-number="5634"></td>
        <td id="LC5634">
</td>
      </tr>
      <tr>
        <td id="L5635" data-line-number="5635"></td>
        <td id="LC5635">        <span>private</span> <span>bool</span> <span>TryProcessOneTable</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>ref</span> <span>int</span> <span>length</span>, <span>out</span> <span>MultiPartTableName</span> <span>multiPartTableName</span>)</td>
      </tr>
      <tr>
        <td id="L5636" data-line-number="5636"></td>
        <td id="LC5636">        {</td>
      </tr>
      <tr>
        <td id="L5637" data-line-number="5637"></td>
        <td id="LC5637">            <span>ushort</span> <span>tableLen</span>;</td>
      </tr>
      <tr>
        <td id="L5638" data-line-number="5638"></td>
        <td id="LC5638">            <span>MultiPartTableName</span> <span>mpt</span>;</td>
      </tr>
      <tr>
        <td id="L5639" data-line-number="5639"></td>
        <td id="LC5639">            <span>string</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L5640" data-line-number="5640"></td>
        <td id="LC5640">
</td>
      </tr>
      <tr>
        <td id="L5641" data-line-number="5641"></td>
        <td id="LC5641">            <span>multiPartTableName</span> <span>=</span> <span>default</span>(<span>MultiPartTableName</span>);</td>
      </tr>
      <tr>
        <td id="L5642" data-line-number="5642"></td>
        <td id="LC5642">
</td>
      </tr>
      <tr>
        <td id="L5643" data-line-number="5643"></td>
        <td id="LC5643">            <span>if</span> (<span>_isShilohSP1</span>)</td>
      </tr>
      <tr>
        <td id="L5644" data-line-number="5644"></td>
        <td id="LC5644">            {</td>
      </tr>
      <tr>
        <td id="L5645" data-line-number="5645"></td>
        <td id="LC5645">
</td>
      </tr>
      <tr>
        <td id="L5646" data-line-number="5646"></td>
        <td id="LC5646">                <span>mpt</span> <span>=</span> <span>new</span> <span>MultiPartTableName</span>();</td>
      </tr>
      <tr>
        <td id="L5647" data-line-number="5647"></td>
        <td id="LC5647">                <span>byte</span> <span>nParts</span>;</td>
      </tr>
      <tr>
        <td id="L5648" data-line-number="5648"></td>
        <td id="LC5648">
</td>
      </tr>
      <tr>
        <td id="L5649" data-line-number="5649"></td>
        <td id="LC5649">                <span><span>//</span> Find out how many parts in the TDS stream</span></td>
      </tr>
      <tr>
        <td id="L5650" data-line-number="5650"></td>
        <td id="LC5650">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>nParts</span>))</td>
      </tr>
      <tr>
        <td id="L5651" data-line-number="5651"></td>
        <td id="LC5651">                {</td>
      </tr>
      <tr>
        <td id="L5652" data-line-number="5652"></td>
        <td id="LC5652">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5653" data-line-number="5653"></td>
        <td id="LC5653">                }</td>
      </tr>
      <tr>
        <td id="L5654" data-line-number="5654"></td>
        <td id="LC5654">                <span>length</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L5655" data-line-number="5655"></td>
        <td id="LC5655">                <span>if</span> (<span>nParts</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L5656" data-line-number="5656"></td>
        <td id="LC5656">                {</td>
      </tr>
      <tr>
        <td id="L5657" data-line-number="5657"></td>
        <td id="LC5657">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>tableLen</span>))</td>
      </tr>
      <tr>
        <td id="L5658" data-line-number="5658"></td>
        <td id="LC5658">                    {</td>
      </tr>
      <tr>
        <td id="L5659" data-line-number="5659"></td>
        <td id="LC5659">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5660" data-line-number="5660"></td>
        <td id="LC5660">                    }</td>
      </tr>
      <tr>
        <td id="L5661" data-line-number="5661"></td>
        <td id="LC5661">                    <span>length</span> <span>-=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L5662" data-line-number="5662"></td>
        <td id="LC5662">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>tableLen</span>, <span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L5663" data-line-number="5663"></td>
        <td id="LC5663">                    {</td>
      </tr>
      <tr>
        <td id="L5664" data-line-number="5664"></td>
        <td id="LC5664">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5665" data-line-number="5665"></td>
        <td id="LC5665">                    }</td>
      </tr>
      <tr>
        <td id="L5666" data-line-number="5666"></td>
        <td id="LC5666">                    <span>mpt</span>.<span>ServerName</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L5667" data-line-number="5667"></td>
        <td id="LC5667">                    <span>nParts</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L5668" data-line-number="5668"></td>
        <td id="LC5668">                    <span>length</span> <span>-=</span> (<span>tableLen</span> <span>*</span> <span>2</span>); <span><span>//</span> wide bytes</span></td>
      </tr>
      <tr>
        <td id="L5669" data-line-number="5669"></td>
        <td id="LC5669">                }</td>
      </tr>
      <tr>
        <td id="L5670" data-line-number="5670"></td>
        <td id="LC5670">                <span>if</span> (<span>nParts</span> <span>==</span> <span>3</span>)</td>
      </tr>
      <tr>
        <td id="L5671" data-line-number="5671"></td>
        <td id="LC5671">                {</td>
      </tr>
      <tr>
        <td id="L5672" data-line-number="5672"></td>
        <td id="LC5672">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>tableLen</span>))</td>
      </tr>
      <tr>
        <td id="L5673" data-line-number="5673"></td>
        <td id="LC5673">                    {</td>
      </tr>
      <tr>
        <td id="L5674" data-line-number="5674"></td>
        <td id="LC5674">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5675" data-line-number="5675"></td>
        <td id="LC5675">                    }</td>
      </tr>
      <tr>
        <td id="L5676" data-line-number="5676"></td>
        <td id="LC5676">                    <span>length</span> <span>-=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L5677" data-line-number="5677"></td>
        <td id="LC5677">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>tableLen</span>, <span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L5678" data-line-number="5678"></td>
        <td id="LC5678">                    {</td>
      </tr>
      <tr>
        <td id="L5679" data-line-number="5679"></td>
        <td id="LC5679">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5680" data-line-number="5680"></td>
        <td id="LC5680">                    }</td>
      </tr>
      <tr>
        <td id="L5681" data-line-number="5681"></td>
        <td id="LC5681">                    <span>mpt</span>.<span>CatalogName</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L5682" data-line-number="5682"></td>
        <td id="LC5682">                    <span>length</span> <span>-=</span> (<span>tableLen</span> <span>*</span> <span>2</span>); <span><span>//</span> wide bytes</span></td>
      </tr>
      <tr>
        <td id="L5683" data-line-number="5683"></td>
        <td id="LC5683">                    <span>nParts</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L5684" data-line-number="5684"></td>
        <td id="LC5684">                }</td>
      </tr>
      <tr>
        <td id="L5685" data-line-number="5685"></td>
        <td id="LC5685">                <span>if</span> (<span>nParts</span> <span>==</span> <span>2</span>)</td>
      </tr>
      <tr>
        <td id="L5686" data-line-number="5686"></td>
        <td id="LC5686">                {</td>
      </tr>
      <tr>
        <td id="L5687" data-line-number="5687"></td>
        <td id="LC5687">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>tableLen</span>))</td>
      </tr>
      <tr>
        <td id="L5688" data-line-number="5688"></td>
        <td id="LC5688">                    {</td>
      </tr>
      <tr>
        <td id="L5689" data-line-number="5689"></td>
        <td id="LC5689">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5690" data-line-number="5690"></td>
        <td id="LC5690">                    }</td>
      </tr>
      <tr>
        <td id="L5691" data-line-number="5691"></td>
        <td id="LC5691">                    <span>length</span> <span>-=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L5692" data-line-number="5692"></td>
        <td id="LC5692">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>tableLen</span>, <span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L5693" data-line-number="5693"></td>
        <td id="LC5693">                    {</td>
      </tr>
      <tr>
        <td id="L5694" data-line-number="5694"></td>
        <td id="LC5694">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5695" data-line-number="5695"></td>
        <td id="LC5695">                    }</td>
      </tr>
      <tr>
        <td id="L5696" data-line-number="5696"></td>
        <td id="LC5696">                    <span>mpt</span>.<span>SchemaName</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L5697" data-line-number="5697"></td>
        <td id="LC5697">                    <span>length</span> <span>-=</span> (<span>tableLen</span> <span>*</span> <span>2</span>); <span><span>//</span> wide bytes</span></td>
      </tr>
      <tr>
        <td id="L5698" data-line-number="5698"></td>
        <td id="LC5698">                    <span>nParts</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L5699" data-line-number="5699"></td>
        <td id="LC5699">                }</td>
      </tr>
      <tr>
        <td id="L5700" data-line-number="5700"></td>
        <td id="LC5700">                <span>if</span> (<span>nParts</span> <span>==</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L5701" data-line-number="5701"></td>
        <td id="LC5701">                {</td>
      </tr>
      <tr>
        <td id="L5702" data-line-number="5702"></td>
        <td id="LC5702">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>tableLen</span>))</td>
      </tr>
      <tr>
        <td id="L5703" data-line-number="5703"></td>
        <td id="LC5703">                    {</td>
      </tr>
      <tr>
        <td id="L5704" data-line-number="5704"></td>
        <td id="LC5704">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5705" data-line-number="5705"></td>
        <td id="LC5705">                    }</td>
      </tr>
      <tr>
        <td id="L5706" data-line-number="5706"></td>
        <td id="LC5706">                    <span>length</span> <span>-=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L5707" data-line-number="5707"></td>
        <td id="LC5707">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>tableLen</span>, <span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L5708" data-line-number="5708"></td>
        <td id="LC5708">                    {</td>
      </tr>
      <tr>
        <td id="L5709" data-line-number="5709"></td>
        <td id="LC5709">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5710" data-line-number="5710"></td>
        <td id="LC5710">                    }</td>
      </tr>
      <tr>
        <td id="L5711" data-line-number="5711"></td>
        <td id="LC5711">                    <span>mpt</span>.<span>TableName</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L5712" data-line-number="5712"></td>
        <td id="LC5712">                    <span>length</span> <span>-=</span> (<span>tableLen</span> <span>*</span> <span>2</span>); <span><span>//</span> wide bytes</span></td>
      </tr>
      <tr>
        <td id="L5713" data-line-number="5713"></td>
        <td id="LC5713">                    <span>nParts</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L5714" data-line-number="5714"></td>
        <td id="LC5714">                }</td>
      </tr>
      <tr>
        <td id="L5715" data-line-number="5715"></td>
        <td id="LC5715">                <span>Debug</span>.<span>Assert</span>(<span>nParts</span> <span>==</span> <span>0</span>, <span><span>"</span>ProcessTableName:Unidentified parts in the table name token stream!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5716" data-line-number="5716"></td>
        <td id="LC5716">
</td>
      </tr>
      <tr>
        <td id="L5717" data-line-number="5717"></td>
        <td id="LC5717">            }</td>
      </tr>
      <tr>
        <td id="L5718" data-line-number="5718"></td>
        <td id="LC5718">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5719" data-line-number="5719"></td>
        <td id="LC5719">            {</td>
      </tr>
      <tr>
        <td id="L5720" data-line-number="5720"></td>
        <td id="LC5720">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>tableLen</span>))</td>
      </tr>
      <tr>
        <td id="L5721" data-line-number="5721"></td>
        <td id="LC5721">                {</td>
      </tr>
      <tr>
        <td id="L5722" data-line-number="5722"></td>
        <td id="LC5722">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5723" data-line-number="5723"></td>
        <td id="LC5723">                }</td>
      </tr>
      <tr>
        <td id="L5724" data-line-number="5724"></td>
        <td id="LC5724">                <span>length</span> <span>-=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L5725" data-line-number="5725"></td>
        <td id="LC5725">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>tableLen</span>, <span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L5726" data-line-number="5726"></td>
        <td id="LC5726">                {</td>
      </tr>
      <tr>
        <td id="L5727" data-line-number="5727"></td>
        <td id="LC5727">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5728" data-line-number="5728"></td>
        <td id="LC5728">                }</td>
      </tr>
      <tr>
        <td id="L5729" data-line-number="5729"></td>
        <td id="LC5729">                <span>string</span> <span>tableName</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L5730" data-line-number="5730"></td>
        <td id="LC5730">                <span>length</span> <span>-=</span> (<span>tableLen</span> <span>*</span> <span>2</span>); <span><span>//</span> wide bytes</span></td>
      </tr>
      <tr>
        <td id="L5731" data-line-number="5731"></td>
        <td id="LC5731">                <span>mpt</span> <span>=</span> <span>new</span> <span>MultiPartTableName</span>(<span>MultipartIdentifier</span>.<span>ParseMultipartIdentifier</span>(<span>tableName</span>, <span><span>"</span>[<span>\"</span><span>"</span></span>, <span><span>"</span>]<span>\"</span><span>"</span></span>, <span>Strings</span>.<span>SQL_TDSParserTableName</span>, <span>false</span>));</td>
      </tr>
      <tr>
        <td id="L5732" data-line-number="5732"></td>
        <td id="LC5732">            }</td>
      </tr>
      <tr>
        <td id="L5733" data-line-number="5733"></td>
        <td id="LC5733">
</td>
      </tr>
      <tr>
        <td id="L5734" data-line-number="5734"></td>
        <td id="LC5734">            <span>multiPartTableName</span> <span>=</span> <span>mpt</span>;</td>
      </tr>
      <tr>
        <td id="L5735" data-line-number="5735"></td>
        <td id="LC5735">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5736" data-line-number="5736"></td>
        <td id="LC5736">        }</td>
      </tr>
      <tr>
        <td id="L5737" data-line-number="5737"></td>
        <td id="LC5737">
</td>
      </tr>
      <tr>
        <td id="L5738" data-line-number="5738"></td>
        <td id="LC5738">        <span><span>//</span> augments current metadata with table and key information</span></td>
      </tr>
      <tr>
        <td id="L5739" data-line-number="5739"></td>
        <td id="LC5739">        <span>private</span> <span>bool</span> <span>TryProcessColInfo</span>(<span>_SqlMetaDataSet</span> <span>columns</span>, <span>SqlDataReader</span> <span>reader</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>_SqlMetaDataSet</span> <span>metaData</span>)</td>
      </tr>
      <tr>
        <td id="L5740" data-line-number="5740"></td>
        <td id="LC5740">        {</td>
      </tr>
      <tr>
        <td id="L5741" data-line-number="5741"></td>
        <td id="LC5741">            <span>Debug</span>.<span>Assert</span>(<span>columns</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>columns</span>.<span>Length</span> <span>&gt;</span> <span>0</span>, <span><span>"</span>no metadata available!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5742" data-line-number="5742"></td>
        <td id="LC5742">
</td>
      </tr>
      <tr>
        <td id="L5743" data-line-number="5743"></td>
        <td id="LC5743">            <span>metaData</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L5744" data-line-number="5744"></td>
        <td id="LC5744">
</td>
      </tr>
      <tr>
        <td id="L5745" data-line-number="5745"></td>
        <td id="LC5745">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>columns</span>.<span>Length</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L5746" data-line-number="5746"></td>
        <td id="LC5746">            {</td>
      </tr>
      <tr>
        <td id="L5747" data-line-number="5747"></td>
        <td id="LC5747">                <span>_SqlMetaData</span> <span>col</span> <span>=</span> <span>columns</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L5748" data-line-number="5748"></td>
        <td id="LC5748">
</td>
      </tr>
      <tr>
        <td id="L5749" data-line-number="5749"></td>
        <td id="LC5749">                <span>byte</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L5750" data-line-number="5750"></td>
        <td id="LC5750">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L5751" data-line-number="5751"></td>
        <td id="LC5751">                { <span><span>//</span> colnum, ignore</span></td>
      </tr>
      <tr>
        <td id="L5752" data-line-number="5752"></td>
        <td id="LC5752">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5753" data-line-number="5753"></td>
        <td id="LC5753">                }</td>
      </tr>
      <tr>
        <td id="L5754" data-line-number="5754"></td>
        <td id="LC5754">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>col</span>.<span>tableNum</span>))</td>
      </tr>
      <tr>
        <td id="L5755" data-line-number="5755"></td>
        <td id="LC5755">                {</td>
      </tr>
      <tr>
        <td id="L5756" data-line-number="5756"></td>
        <td id="LC5756">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5757" data-line-number="5757"></td>
        <td id="LC5757">                }</td>
      </tr>
      <tr>
        <td id="L5758" data-line-number="5758"></td>
        <td id="LC5758">
</td>
      </tr>
      <tr>
        <td id="L5759" data-line-number="5759"></td>
        <td id="LC5759">                <span><span>//</span> interpret status</span></td>
      </tr>
      <tr>
        <td id="L5760" data-line-number="5760"></td>
        <td id="LC5760">                <span>byte</span> <span>status</span>;</td>
      </tr>
      <tr>
        <td id="L5761" data-line-number="5761"></td>
        <td id="LC5761">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>status</span>))</td>
      </tr>
      <tr>
        <td id="L5762" data-line-number="5762"></td>
        <td id="LC5762">                {</td>
      </tr>
      <tr>
        <td id="L5763" data-line-number="5763"></td>
        <td id="LC5763">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5764" data-line-number="5764"></td>
        <td id="LC5764">                }</td>
      </tr>
      <tr>
        <td id="L5765" data-line-number="5765"></td>
        <td id="LC5765">
</td>
      </tr>
      <tr>
        <td id="L5766" data-line-number="5766"></td>
        <td id="LC5766">                <span>col</span>.<span>IsDifferentName</span> <span>=</span> (<span>TdsEnums</span>.<span>SQLDifferentName</span> <span>==</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>SQLDifferentName</span>));</td>
      </tr>
      <tr>
        <td id="L5767" data-line-number="5767"></td>
        <td id="LC5767">                <span>col</span>.<span>IsExpression</span> <span>=</span> (<span>TdsEnums</span>.<span>SQLExpression</span> <span>==</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>SQLExpression</span>));</td>
      </tr>
      <tr>
        <td id="L5768" data-line-number="5768"></td>
        <td id="LC5768">                <span>col</span>.<span>IsKey</span> <span>=</span> (<span>TdsEnums</span>.<span>SQLKey</span> <span>==</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>SQLKey</span>));</td>
      </tr>
      <tr>
        <td id="L5769" data-line-number="5769"></td>
        <td id="LC5769">                <span>col</span>.<span>IsHidden</span> <span>=</span> (<span>TdsEnums</span>.<span>SQLHidden</span> <span>==</span> (<span>status</span> <span>&amp;</span> <span>TdsEnums</span>.<span>SQLHidden</span>));</td>
      </tr>
      <tr>
        <td id="L5770" data-line-number="5770"></td>
        <td id="LC5770">
</td>
      </tr>
      <tr>
        <td id="L5771" data-line-number="5771"></td>
        <td id="LC5771">                <span><span>//</span> read off the base table name if it is different than the select list column name</span></td>
      </tr>
      <tr>
        <td id="L5772" data-line-number="5772"></td>
        <td id="LC5772">                <span>if</span> (<span>col</span>.<span>IsDifferentName</span>)</td>
      </tr>
      <tr>
        <td id="L5773" data-line-number="5773"></td>
        <td id="LC5773">                {</td>
      </tr>
      <tr>
        <td id="L5774" data-line-number="5774"></td>
        <td id="LC5774">                    <span>byte</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L5775" data-line-number="5775"></td>
        <td id="LC5775">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>len</span>))</td>
      </tr>
      <tr>
        <td id="L5776" data-line-number="5776"></td>
        <td id="LC5776">                    {</td>
      </tr>
      <tr>
        <td id="L5777" data-line-number="5777"></td>
        <td id="LC5777">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5778" data-line-number="5778"></td>
        <td id="LC5778">                    }</td>
      </tr>
      <tr>
        <td id="L5779" data-line-number="5779"></td>
        <td id="LC5779">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>len</span>, <span>out</span> <span>col</span>.<span>baseColumn</span>))</td>
      </tr>
      <tr>
        <td id="L5780" data-line-number="5780"></td>
        <td id="LC5780">                    {</td>
      </tr>
      <tr>
        <td id="L5781" data-line-number="5781"></td>
        <td id="LC5781">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5782" data-line-number="5782"></td>
        <td id="LC5782">                    }</td>
      </tr>
      <tr>
        <td id="L5783" data-line-number="5783"></td>
        <td id="LC5783">                }</td>
      </tr>
      <tr>
        <td id="L5784" data-line-number="5784"></td>
        <td id="LC5784">
</td>
      </tr>
      <tr>
        <td id="L5785" data-line-number="5785"></td>
        <td id="LC5785">                <span><span>//</span> Fixup column name - only if result of a table - that is if it was not the result of</span></td>
      </tr>
      <tr>
        <td id="L5786" data-line-number="5786"></td>
        <td id="LC5786">                <span><span>//</span> an expression.</span></td>
      </tr>
      <tr>
        <td id="L5787" data-line-number="5787"></td>
        <td id="LC5787">                <span>if</span> ((<span>reader</span>.<span>TableNames</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (<span>col</span>.<span>tableNum</span> <span>&gt;</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L5788" data-line-number="5788"></td>
        <td id="LC5788">                {</td>
      </tr>
      <tr>
        <td id="L5789" data-line-number="5789"></td>
        <td id="LC5789">                    <span>Debug</span>.<span>Assert</span>(<span>reader</span>.<span>TableNames</span>.<span>Length</span> <span>&gt;=</span> <span>col</span>.<span>tableNum</span>, <span><span>"</span>invalid tableNames array!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5790" data-line-number="5790"></td>
        <td id="LC5790">                    <span>col</span>.<span>multiPartTableName</span> <span>=</span> <span>reader</span>.<span>TableNames</span>[<span>col</span>.<span>tableNum</span> <span>-</span> <span>1</span>];</td>
      </tr>
      <tr>
        <td id="L5791" data-line-number="5791"></td>
        <td id="LC5791">                }</td>
      </tr>
      <tr>
        <td id="L5792" data-line-number="5792"></td>
        <td id="LC5792">
</td>
      </tr>
      <tr>
        <td id="L5793" data-line-number="5793"></td>
        <td id="LC5793">                <span><span>//</span> MDAC 60109: expressions are readonly</span></td>
      </tr>
      <tr>
        <td id="L5794" data-line-number="5794"></td>
        <td id="LC5794">                <span>if</span> (<span>col</span>.<span>IsExpression</span>)</td>
      </tr>
      <tr>
        <td id="L5795" data-line-number="5795"></td>
        <td id="LC5795">                {</td>
      </tr>
      <tr>
        <td id="L5796" data-line-number="5796"></td>
        <td id="LC5796">                    <span>col</span>.<span>Updatability</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5797" data-line-number="5797"></td>
        <td id="LC5797">                }</td>
      </tr>
      <tr>
        <td id="L5798" data-line-number="5798"></td>
        <td id="LC5798">            }</td>
      </tr>
      <tr>
        <td id="L5799" data-line-number="5799"></td>
        <td id="LC5799">
</td>
      </tr>
      <tr>
        <td id="L5800" data-line-number="5800"></td>
        <td id="LC5800">            <span><span>//</span> set the metadata so that the stream knows some metadata info has changed</span></td>
      </tr>
      <tr>
        <td id="L5801" data-line-number="5801"></td>
        <td id="LC5801">            <span>metaData</span> <span>=</span> <span>columns</span>;</td>
      </tr>
      <tr>
        <td id="L5802" data-line-number="5802"></td>
        <td id="LC5802">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5803" data-line-number="5803"></td>
        <td id="LC5803">        }</td>
      </tr>
      <tr>
        <td id="L5804" data-line-number="5804"></td>
        <td id="LC5804">
</td>
      </tr>
      <tr>
        <td id="L5805" data-line-number="5805"></td>
        <td id="LC5805">        <span><span>//</span> takes care of any per data header information:</span></td>
      </tr>
      <tr>
        <td id="L5806" data-line-number="5806"></td>
        <td id="LC5806">        <span><span>//</span> for long columns, reads off textptrs, reads length, check nullability</span></td>
      </tr>
      <tr>
        <td id="L5807" data-line-number="5807"></td>
        <td id="LC5807">        <span><span>//</span> for other columns, reads length, checks nullability</span></td>
      </tr>
      <tr>
        <td id="L5808" data-line-number="5808"></td>
        <td id="LC5808">        <span><span>//</span> returns length and nullability</span></td>
      </tr>
      <tr>
        <td id="L5809" data-line-number="5809"></td>
        <td id="LC5809">        <span>internal</span> <span>bool</span> <span>TryProcessColumnHeader</span>(<span>SqlMetaDataPriv</span> <span>col</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>columnOrdinal</span>, <span>out</span> <span>bool</span> <span>isNull</span>, <span>out</span> <span>ulong</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L5810" data-line-number="5810"></td>
        <td id="LC5810">        {</td>
      </tr>
      <tr>
        <td id="L5811" data-line-number="5811"></td>
        <td id="LC5811">            <span><span>//</span> query NBC row information first</span></td>
      </tr>
      <tr>
        <td id="L5812" data-line-number="5812"></td>
        <td id="LC5812">            <span>if</span> (<span>stateObj</span>.<span>IsNullCompressionBitSet</span>(<span>columnOrdinal</span>))</td>
      </tr>
      <tr>
        <td id="L5813" data-line-number="5813"></td>
        <td id="LC5813">            {</td>
      </tr>
      <tr>
        <td id="L5814" data-line-number="5814"></td>
        <td id="LC5814">                <span>isNull</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5815" data-line-number="5815"></td>
        <td id="LC5815">                <span><span>//</span> column information is not present in TDS if null compression bit is set, return now</span></td>
      </tr>
      <tr>
        <td id="L5816" data-line-number="5816"></td>
        <td id="LC5816">                <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5817" data-line-number="5817"></td>
        <td id="LC5817">                <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5818" data-line-number="5818"></td>
        <td id="LC5818">            }</td>
      </tr>
      <tr>
        <td id="L5819" data-line-number="5819"></td>
        <td id="LC5819">
</td>
      </tr>
      <tr>
        <td id="L5820" data-line-number="5820"></td>
        <td id="LC5820">            <span>return</span> <span>TryProcessColumnHeaderNoNBC</span>(<span>col</span>, <span>stateObj</span>, <span>out</span> <span>isNull</span>, <span>out</span> <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L5821" data-line-number="5821"></td>
        <td id="LC5821">        }</td>
      </tr>
      <tr>
        <td id="L5822" data-line-number="5822"></td>
        <td id="LC5822">
</td>
      </tr>
      <tr>
        <td id="L5823" data-line-number="5823"></td>
        <td id="LC5823">        <span>private</span> <span>bool</span> <span>TryProcessColumnHeaderNoNBC</span>(<span>SqlMetaDataPriv</span> <span>col</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>bool</span> <span>isNull</span>, <span>out</span> <span>ulong</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L5824" data-line-number="5824"></td>
        <td id="LC5824">        {</td>
      </tr>
      <tr>
        <td id="L5825" data-line-number="5825"></td>
        <td id="LC5825">            <span>if</span> (<span>col</span>.<span>metaType</span>.<span>IsLong</span> <span>&amp;&amp;</span> <span>!</span><span>col</span>.<span>metaType</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L5826" data-line-number="5826"></td>
        <td id="LC5826">            {</td>
      </tr>
      <tr>
        <td id="L5827" data-line-number="5827"></td>
        <td id="LC5827">                <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L5828" data-line-number="5828"></td>
        <td id="LC5828">                <span><span>//</span> we don't care about TextPtrs, simply go after the data after it</span></td>
      </tr>
      <tr>
        <td id="L5829" data-line-number="5829"></td>
        <td id="LC5829">                <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L5830" data-line-number="5830"></td>
        <td id="LC5830">                <span>byte</span> <span>textPtrLen</span>;</td>
      </tr>
      <tr>
        <td id="L5831" data-line-number="5831"></td>
        <td id="LC5831">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>textPtrLen</span>))</td>
      </tr>
      <tr>
        <td id="L5832" data-line-number="5832"></td>
        <td id="LC5832">                {</td>
      </tr>
      <tr>
        <td id="L5833" data-line-number="5833"></td>
        <td id="LC5833">                    <span>isNull</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5834" data-line-number="5834"></td>
        <td id="LC5834">                    <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5835" data-line-number="5835"></td>
        <td id="LC5835">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5836" data-line-number="5836"></td>
        <td id="LC5836">                }</td>
      </tr>
      <tr>
        <td id="L5837" data-line-number="5837"></td>
        <td id="LC5837">
</td>
      </tr>
      <tr>
        <td id="L5838" data-line-number="5838"></td>
        <td id="LC5838">                <span>if</span> (<span>0</span> <span>!=</span> <span>textPtrLen</span>)</td>
      </tr>
      <tr>
        <td id="L5839" data-line-number="5839"></td>
        <td id="LC5839">                {</td>
      </tr>
      <tr>
        <td id="L5840" data-line-number="5840"></td>
        <td id="LC5840">                    <span><span>//</span> read past text pointer</span></td>
      </tr>
      <tr>
        <td id="L5841" data-line-number="5841"></td>
        <td id="LC5841">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>textPtrLen</span>))</td>
      </tr>
      <tr>
        <td id="L5842" data-line-number="5842"></td>
        <td id="LC5842">                    {</td>
      </tr>
      <tr>
        <td id="L5843" data-line-number="5843"></td>
        <td id="LC5843">                        <span>isNull</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5844" data-line-number="5844"></td>
        <td id="LC5844">                        <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5845" data-line-number="5845"></td>
        <td id="LC5845">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5846" data-line-number="5846"></td>
        <td id="LC5846">                    }</td>
      </tr>
      <tr>
        <td id="L5847" data-line-number="5847"></td>
        <td id="LC5847">
</td>
      </tr>
      <tr>
        <td id="L5848" data-line-number="5848"></td>
        <td id="LC5848">                    <span><span>//</span> read past timestamp</span></td>
      </tr>
      <tr>
        <td id="L5849" data-line-number="5849"></td>
        <td id="LC5849">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>TdsEnums</span>.<span>TEXT_TIME_STAMP_LEN</span>))</td>
      </tr>
      <tr>
        <td id="L5850" data-line-number="5850"></td>
        <td id="LC5850">                    {</td>
      </tr>
      <tr>
        <td id="L5851" data-line-number="5851"></td>
        <td id="LC5851">                        <span>isNull</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5852" data-line-number="5852"></td>
        <td id="LC5852">                        <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5853" data-line-number="5853"></td>
        <td id="LC5853">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5854" data-line-number="5854"></td>
        <td id="LC5854">                    }</td>
      </tr>
      <tr>
        <td id="L5855" data-line-number="5855"></td>
        <td id="LC5855">
</td>
      </tr>
      <tr>
        <td id="L5856" data-line-number="5856"></td>
        <td id="LC5856">                    <span>isNull</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5857" data-line-number="5857"></td>
        <td id="LC5857">                    <span>return</span> <span>TryGetDataLength</span>(<span>col</span>, <span>stateObj</span>, <span>out</span> <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L5858" data-line-number="5858"></td>
        <td id="LC5858">                }</td>
      </tr>
      <tr>
        <td id="L5859" data-line-number="5859"></td>
        <td id="LC5859">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L5860" data-line-number="5860"></td>
        <td id="LC5860">                {</td>
      </tr>
      <tr>
        <td id="L5861" data-line-number="5861"></td>
        <td id="LC5861">                    <span>isNull</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5862" data-line-number="5862"></td>
        <td id="LC5862">                    <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5863" data-line-number="5863"></td>
        <td id="LC5863">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5864" data-line-number="5864"></td>
        <td id="LC5864">
</td>
      </tr>
      <tr>
        <td id="L5865" data-line-number="5865"></td>
        <td id="LC5865">                }</td>
      </tr>
      <tr>
        <td id="L5866" data-line-number="5866"></td>
        <td id="LC5866">            }</td>
      </tr>
      <tr>
        <td id="L5867" data-line-number="5867"></td>
        <td id="LC5867">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L5868" data-line-number="5868"></td>
        <td id="LC5868">            {</td>
      </tr>
      <tr>
        <td id="L5869" data-line-number="5869"></td>
        <td id="LC5869">                <span><span>//</span> non-blob columns</span></td>
      </tr>
      <tr>
        <td id="L5870" data-line-number="5870"></td>
        <td id="LC5870">                <span>ulong</span> <span>longlen</span>;</td>
      </tr>
      <tr>
        <td id="L5871" data-line-number="5871"></td>
        <td id="LC5871">                <span>if</span> (<span>!</span><span>TryGetDataLength</span>(<span>col</span>, <span>stateObj</span>, <span>out</span> <span>longlen</span>))</td>
      </tr>
      <tr>
        <td id="L5872" data-line-number="5872"></td>
        <td id="LC5872">                {</td>
      </tr>
      <tr>
        <td id="L5873" data-line-number="5873"></td>
        <td id="LC5873">                    <span>isNull</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5874" data-line-number="5874"></td>
        <td id="LC5874">                    <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5875" data-line-number="5875"></td>
        <td id="LC5875">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5876" data-line-number="5876"></td>
        <td id="LC5876">                }</td>
      </tr>
      <tr>
        <td id="L5877" data-line-number="5877"></td>
        <td id="LC5877">                <span>isNull</span> <span>=</span> <span>IsNull</span>(<span>col</span>.<span>metaType</span>, <span>longlen</span>);</td>
      </tr>
      <tr>
        <td id="L5878" data-line-number="5878"></td>
        <td id="LC5878">                <span>length</span> <span>=</span> (<span>isNull</span> <span>?</span> <span>0</span> <span>:</span> <span>longlen</span>);</td>
      </tr>
      <tr>
        <td id="L5879" data-line-number="5879"></td>
        <td id="LC5879">                <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5880" data-line-number="5880"></td>
        <td id="LC5880">            }</td>
      </tr>
      <tr>
        <td id="L5881" data-line-number="5881"></td>
        <td id="LC5881">        }</td>
      </tr>
      <tr>
        <td id="L5882" data-line-number="5882"></td>
        <td id="LC5882">
</td>
      </tr>
      <tr>
        <td id="L5883" data-line-number="5883"></td>
        <td id="LC5883">        <span><span>//</span> assumes that the current position is at the start of an altrow!</span></td>
      </tr>
      <tr>
        <td id="L5884" data-line-number="5884"></td>
        <td id="LC5884">        <span>internal</span> <span>bool</span> <span>TryGetAltRowId</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>int</span> <span>id</span>)</td>
      </tr>
      <tr>
        <td id="L5885" data-line-number="5885"></td>
        <td id="LC5885">        {</td>
      </tr>
      <tr>
        <td id="L5886" data-line-number="5886"></td>
        <td id="LC5886">            <span>byte</span> <span>token</span>;</td>
      </tr>
      <tr>
        <td id="L5887" data-line-number="5887"></td>
        <td id="LC5887">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>token</span>))</td>
      </tr>
      <tr>
        <td id="L5888" data-line-number="5888"></td>
        <td id="LC5888">            { <span><span>//</span> skip over ALTROW token</span></td>
      </tr>
      <tr>
        <td id="L5889" data-line-number="5889"></td>
        <td id="LC5889">                <span>id</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5890" data-line-number="5890"></td>
        <td id="LC5890">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5891" data-line-number="5891"></td>
        <td id="LC5891">            }</td>
      </tr>
      <tr>
        <td id="L5892" data-line-number="5892"></td>
        <td id="LC5892">            <span>Debug</span>.<span>Assert</span>((<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLALTROW</span>), <span><span>"</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5893" data-line-number="5893"></td>
        <td id="LC5893">
</td>
      </tr>
      <tr>
        <td id="L5894" data-line-number="5894"></td>
        <td id="LC5894">            <span><span>//</span> Start a fresh row - disable NBC since Alt Rows are never compressed</span></td>
      </tr>
      <tr>
        <td id="L5895" data-line-number="5895"></td>
        <td id="LC5895">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryStartNewRow</span>(<span>isNullCompressed</span>: <span>false</span>))</td>
      </tr>
      <tr>
        <td id="L5896" data-line-number="5896"></td>
        <td id="LC5896">            {</td>
      </tr>
      <tr>
        <td id="L5897" data-line-number="5897"></td>
        <td id="LC5897">                <span>id</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5898" data-line-number="5898"></td>
        <td id="LC5898">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5899" data-line-number="5899"></td>
        <td id="LC5899">            }</td>
      </tr>
      <tr>
        <td id="L5900" data-line-number="5900"></td>
        <td id="LC5900">
</td>
      </tr>
      <tr>
        <td id="L5901" data-line-number="5901"></td>
        <td id="LC5901">            <span>ushort</span> <span>shortId</span>;</td>
      </tr>
      <tr>
        <td id="L5902" data-line-number="5902"></td>
        <td id="LC5902">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>shortId</span>))</td>
      </tr>
      <tr>
        <td id="L5903" data-line-number="5903"></td>
        <td id="LC5903">            {</td>
      </tr>
      <tr>
        <td id="L5904" data-line-number="5904"></td>
        <td id="LC5904">                <span>id</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L5905" data-line-number="5905"></td>
        <td id="LC5905">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5906" data-line-number="5906"></td>
        <td id="LC5906">            }</td>
      </tr>
      <tr>
        <td id="L5907" data-line-number="5907"></td>
        <td id="LC5907">
</td>
      </tr>
      <tr>
        <td id="L5908" data-line-number="5908"></td>
        <td id="LC5908">            <span>id</span> <span>=</span> <span>shortId</span>;</td>
      </tr>
      <tr>
        <td id="L5909" data-line-number="5909"></td>
        <td id="LC5909">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5910" data-line-number="5910"></td>
        <td id="LC5910">        }</td>
      </tr>
      <tr>
        <td id="L5911" data-line-number="5911"></td>
        <td id="LC5911">
</td>
      </tr>
      <tr>
        <td id="L5912" data-line-number="5912"></td>
        <td id="LC5912">        <span><span>//</span> Used internally by BulkCopy only</span></td>
      </tr>
      <tr>
        <td id="L5913" data-line-number="5913"></td>
        <td id="LC5913">        <span>private</span> <span>bool</span> <span>TryProcessRow</span>(<span>_SqlMetaDataSet</span> <span>columns</span>, <span>object</span>[] <span>buffer</span>, <span>int</span>[] <span>map</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L5914" data-line-number="5914"></td>
        <td id="LC5914">        {</td>
      </tr>
      <tr>
        <td id="L5915" data-line-number="5915"></td>
        <td id="LC5915">            <span>SqlBuffer</span> <span>data</span> <span>=</span> <span>new</span> <span>SqlBuffer</span>();</td>
      </tr>
      <tr>
        <td id="L5916" data-line-number="5916"></td>
        <td id="LC5916">
</td>
      </tr>
      <tr>
        <td id="L5917" data-line-number="5917"></td>
        <td id="LC5917">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>columns</span>.<span>Length</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L5918" data-line-number="5918"></td>
        <td id="LC5918">            {</td>
      </tr>
      <tr>
        <td id="L5919" data-line-number="5919"></td>
        <td id="LC5919">                <span>_SqlMetaData</span> <span>md</span> <span>=</span> <span>columns</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L5920" data-line-number="5920"></td>
        <td id="LC5920">                <span>Debug</span>.<span>Assert</span>(<span>md</span> <span>!=</span> <span>null</span>, <span><span>"</span>_SqlMetaData should not be null for column <span>"</span></span> <span>+</span> <span>i</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L5921" data-line-number="5921"></td>
        <td id="LC5921">
</td>
      </tr>
      <tr>
        <td id="L5922" data-line-number="5922"></td>
        <td id="LC5922">                <span>bool</span> <span>isNull</span>;</td>
      </tr>
      <tr>
        <td id="L5923" data-line-number="5923"></td>
        <td id="LC5923">                <span>ulong</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L5924" data-line-number="5924"></td>
        <td id="LC5924">                <span>if</span> (<span>!</span><span>TryProcessColumnHeader</span>(<span>md</span>, <span>stateObj</span>, <span>i</span>, <span>out</span> <span>isNull</span>, <span>out</span> <span>len</span>))</td>
      </tr>
      <tr>
        <td id="L5925" data-line-number="5925"></td>
        <td id="LC5925">                {</td>
      </tr>
      <tr>
        <td id="L5926" data-line-number="5926"></td>
        <td id="LC5926">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5927" data-line-number="5927"></td>
        <td id="LC5927">                }</td>
      </tr>
      <tr>
        <td id="L5928" data-line-number="5928"></td>
        <td id="LC5928">
</td>
      </tr>
      <tr>
        <td id="L5929" data-line-number="5929"></td>
        <td id="LC5929">                <span>if</span> (<span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L5930" data-line-number="5930"></td>
        <td id="LC5930">                {</td>
      </tr>
      <tr>
        <td id="L5931" data-line-number="5931"></td>
        <td id="LC5931">                    <span>GetNullSqlValue</span>(<span>data</span>, <span>md</span>, <span>SqlCommandColumnEncryptionSetting</span>.<span>Disabled</span> <span><span>/*</span>Column Encryption Disabled for Bulk Copy<span>*/</span></span>, <span>_connHandler</span>);</td>
      </tr>
      <tr>
        <td id="L5932" data-line-number="5932"></td>
        <td id="LC5932">                    <span>buffer</span>[<span>map</span>[<span>i</span>]] <span>=</span> <span>data</span>.<span>SqlValue</span>;</td>
      </tr>
      <tr>
        <td id="L5933" data-line-number="5933"></td>
        <td id="LC5933">                }</td>
      </tr>
      <tr>
        <td id="L5934" data-line-number="5934"></td>
        <td id="LC5934">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L5935" data-line-number="5935"></td>
        <td id="LC5935">                {</td>
      </tr>
      <tr>
        <td id="L5936" data-line-number="5936"></td>
        <td id="LC5936">                    <span><span>//</span> We only read up to 2Gb. Throw if data is larger. Very large data</span></td>
      </tr>
      <tr>
        <td id="L5937" data-line-number="5937"></td>
        <td id="LC5937">                    <span><span>//</span> should be read in chunks in sequential read mode</span></td>
      </tr>
      <tr>
        <td id="L5938" data-line-number="5938"></td>
        <td id="LC5938">                    <span><span>//</span> For Plp columns, we may have gotten only the length of the first chunk</span></td>
      </tr>
      <tr>
        <td id="L5939" data-line-number="5939"></td>
        <td id="LC5939">                    <span>if</span> (<span>!</span><span>TryReadSqlValue</span>(<span>data</span>, <span>md</span>, <span>md</span>.<span>metaType</span>.<span>IsPlp</span> <span>?</span> (<span>Int32</span>.<span>MaxValue</span>) <span>:</span> (<span>int</span>)<span>len</span>, <span>stateObj</span>,</td>
      </tr>
      <tr>
        <td id="L5940" data-line-number="5940"></td>
        <td id="LC5940">                                         <span>SqlCommandColumnEncryptionSetting</span>.<span>Disabled</span> <span><span>/*</span>Column Encryption Disabled for Bulk Copy<span>*/</span></span>,</td>
      </tr>
      <tr>
        <td id="L5941" data-line-number="5941"></td>
        <td id="LC5941">                                         <span>md</span>.<span>column</span>))</td>
      </tr>
      <tr>
        <td id="L5942" data-line-number="5942"></td>
        <td id="LC5942">                    {</td>
      </tr>
      <tr>
        <td id="L5943" data-line-number="5943"></td>
        <td id="LC5943">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5944" data-line-number="5944"></td>
        <td id="LC5944">                    }</td>
      </tr>
      <tr>
        <td id="L5945" data-line-number="5945"></td>
        <td id="LC5945">                    <span>buffer</span>[<span>map</span>[<span>i</span>]] <span>=</span> <span>data</span>.<span>SqlValue</span>;</td>
      </tr>
      <tr>
        <td id="L5946" data-line-number="5946"></td>
        <td id="LC5946">                    <span>if</span> (<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L5947" data-line-number="5947"></td>
        <td id="LC5947">                    {</td>
      </tr>
      <tr>
        <td id="L5948" data-line-number="5948"></td>
        <td id="LC5948">                        <span>throw</span> <span>new</span> <span>SqlTruncateException</span>(<span>StringsHelper</span>.<span>GetString</span>(<span>Strings</span>.<span>SqlMisc_TruncationMaxDataMessage</span>));</td>
      </tr>
      <tr>
        <td id="L5949" data-line-number="5949"></td>
        <td id="LC5949">                    }</td>
      </tr>
      <tr>
        <td id="L5950" data-line-number="5950"></td>
        <td id="LC5950">                }</td>
      </tr>
      <tr>
        <td id="L5951" data-line-number="5951"></td>
        <td id="LC5951">                <span>data</span>.<span>Clear</span>();</td>
      </tr>
      <tr>
        <td id="L5952" data-line-number="5952"></td>
        <td id="LC5952">            }</td>
      </tr>
      <tr>
        <td id="L5953" data-line-number="5953"></td>
        <td id="LC5953">
</td>
      </tr>
      <tr>
        <td id="L5954" data-line-number="5954"></td>
        <td id="LC5954">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5955" data-line-number="5955"></td>
        <td id="LC5955">        }</td>
      </tr>
      <tr>
        <td id="L5956" data-line-number="5956"></td>
        <td id="LC5956">
</td>
      </tr>
      <tr>
        <td id="L5957" data-line-number="5957"></td>
        <td id="LC5957">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5958" data-line-number="5958"></td>
        <td id="LC5958">        <span><span>///</span> Determines if a column value should be transparently decrypted (based on SqlCommand and Connection String settings).</span></td>
      </tr>
      <tr>
        <td id="L5959" data-line-number="5959"></td>
        <td id="LC5959">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5960" data-line-number="5960"></td>
        <td id="LC5960">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;true if the value should be transparently decrypted, false otherwise&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L5961" data-line-number="5961"></td>
        <td id="LC5961">        <span>internal</span> <span>static</span> <span>bool</span> <span>ShouldHonorTceForRead</span>(<span>SqlCommandColumnEncryptionSetting</span> <span>columnEncryptionSetting</span>,</td>
      </tr>
      <tr>
        <td id="L5962" data-line-number="5962"></td>
        <td id="LC5962">            <span>SqlInternalConnectionTds</span> <span>connection</span>)</td>
      </tr>
      <tr>
        <td id="L5963" data-line-number="5963"></td>
        <td id="LC5963">        {</td>
      </tr>
      <tr>
        <td id="L5964" data-line-number="5964"></td>
        <td id="LC5964">
</td>
      </tr>
      <tr>
        <td id="L5965" data-line-number="5965"></td>
        <td id="LC5965">            <span><span>//</span> Command leve setting trumps all</span></td>
      </tr>
      <tr>
        <td id="L5966" data-line-number="5966"></td>
        <td id="LC5966">            <span>switch</span> (<span>columnEncryptionSetting</span>)</td>
      </tr>
      <tr>
        <td id="L5967" data-line-number="5967"></td>
        <td id="LC5967">            {</td>
      </tr>
      <tr>
        <td id="L5968" data-line-number="5968"></td>
        <td id="LC5968">                <span>case</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>Disabled</span>:</td>
      </tr>
      <tr>
        <td id="L5969" data-line-number="5969"></td>
        <td id="LC5969">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L5970" data-line-number="5970"></td>
        <td id="LC5970">                <span>case</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>Enabled</span>:</td>
      </tr>
      <tr>
        <td id="L5971" data-line-number="5971"></td>
        <td id="LC5971">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5972" data-line-number="5972"></td>
        <td id="LC5972">                <span>case</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>ResultSetOnly</span>:</td>
      </tr>
      <tr>
        <td id="L5973" data-line-number="5973"></td>
        <td id="LC5973">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L5974" data-line-number="5974"></td>
        <td id="LC5974">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L5975" data-line-number="5975"></td>
        <td id="LC5975">                    <span><span>//</span> Check connection level setting!</span></td>
      </tr>
      <tr>
        <td id="L5976" data-line-number="5976"></td>
        <td id="LC5976">                    <span>Debug</span>.<span>Assert</span>(<span>SqlCommandColumnEncryptionSetting</span>.<span>UseConnectionSetting</span> <span>==</span> <span>columnEncryptionSetting</span>,</td>
      </tr>
      <tr>
        <td id="L5977" data-line-number="5977"></td>
        <td id="LC5977">                        <span><span>"</span>Unexpected value for command level override<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L5978" data-line-number="5978"></td>
        <td id="LC5978">                    <span>return</span> (<span>connection</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>connection</span>.<span>ConnectionOptions</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L5979" data-line-number="5979"></td>
        <td id="LC5979">                        <span>connection</span>.<span>ConnectionOptions</span>.<span>ColumnEncryptionSetting</span> <span>==</span> <span>SqlConnectionColumnEncryptionSetting</span>.<span>Enabled</span>);</td>
      </tr>
      <tr>
        <td id="L5980" data-line-number="5980"></td>
        <td id="LC5980">            }</td>
      </tr>
      <tr>
        <td id="L5981" data-line-number="5981"></td>
        <td id="LC5981">        }</td>
      </tr>
      <tr>
        <td id="L5982" data-line-number="5982"></td>
        <td id="LC5982">
</td>
      </tr>
      <tr>
        <td id="L5983" data-line-number="5983"></td>
        <td id="LC5983">        <span>internal</span> <span>static</span> <span>object</span> <span>GetNullSqlValue</span>(</td>
      </tr>
      <tr>
        <td id="L5984" data-line-number="5984"></td>
        <td id="LC5984">                <span>SqlBuffer</span> <span>nullVal</span>,</td>
      </tr>
      <tr>
        <td id="L5985" data-line-number="5985"></td>
        <td id="LC5985">                <span>SqlMetaDataPriv</span> <span>md</span>,</td>
      </tr>
      <tr>
        <td id="L5986" data-line-number="5986"></td>
        <td id="LC5986">                <span>SqlCommandColumnEncryptionSetting</span> <span>columnEncryptionSetting</span>,</td>
      </tr>
      <tr>
        <td id="L5987" data-line-number="5987"></td>
        <td id="LC5987">                <span>SqlInternalConnectionTds</span> <span>connection</span>)</td>
      </tr>
      <tr>
        <td id="L5988" data-line-number="5988"></td>
        <td id="LC5988">        {</td>
      </tr>
      <tr>
        <td id="L5989" data-line-number="5989"></td>
        <td id="LC5989">            <span>SqlDbType</span> <span>type</span> <span>=</span> <span>md</span>.<span>type</span>;</td>
      </tr>
      <tr>
        <td id="L5990" data-line-number="5990"></td>
        <td id="LC5990">
</td>
      </tr>
      <tr>
        <td id="L5991" data-line-number="5991"></td>
        <td id="LC5991">            <span>if</span> (<span>type</span> <span>==</span> <span>SqlDbType</span>.<span>VarBinary</span> <span>&amp;&amp;</span> <span><span>//</span> if its a varbinary</span></td>
      </tr>
      <tr>
        <td id="L5992" data-line-number="5992"></td>
        <td id="LC5992">                <span>md</span>.<span>isEncrypted</span> <span>&amp;&amp;</span><span><span>//</span> and encrypted</span></td>
      </tr>
      <tr>
        <td id="L5993" data-line-number="5993"></td>
        <td id="LC5993">                <span>ShouldHonorTceForRead</span>(<span>columnEncryptionSetting</span>, <span>connection</span>))</td>
      </tr>
      <tr>
        <td id="L5994" data-line-number="5994"></td>
        <td id="LC5994">            {</td>
      </tr>
      <tr>
        <td id="L5995" data-line-number="5995"></td>
        <td id="LC5995">                <span>type</span> <span>=</span> <span>md</span>.<span>baseTI</span>.<span>type</span>; <span><span>//</span> the use the actual (plaintext) type</span></td>
      </tr>
      <tr>
        <td id="L5996" data-line-number="5996"></td>
        <td id="LC5996">            }</td>
      </tr>
      <tr>
        <td id="L5997" data-line-number="5997"></td>
        <td id="LC5997">
</td>
      </tr>
      <tr>
        <td id="L5998" data-line-number="5998"></td>
        <td id="LC5998">            <span>switch</span> (<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L5999" data-line-number="5999"></td>
        <td id="LC5999">            {</td>
      </tr>
      <tr>
        <td id="L6000" data-line-number="6000"></td>
        <td id="LC6000">                <span>case</span> <span>SqlDbType</span>.<span>Real</span>:</td>
      </tr>
      <tr>
        <td id="L6001" data-line-number="6001"></td>
        <td id="LC6001">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Single</span>);</td>
      </tr>
      <tr>
        <td id="L6002" data-line-number="6002"></td>
        <td id="LC6002">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6003" data-line-number="6003"></td>
        <td id="LC6003">
</td>
      </tr>
      <tr>
        <td id="L6004" data-line-number="6004"></td>
        <td id="LC6004">                <span>case</span> <span>SqlDbType</span>.<span>Float</span>:</td>
      </tr>
      <tr>
        <td id="L6005" data-line-number="6005"></td>
        <td id="LC6005">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Double</span>);</td>
      </tr>
      <tr>
        <td id="L6006" data-line-number="6006"></td>
        <td id="LC6006">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6007" data-line-number="6007"></td>
        <td id="LC6007">
</td>
      </tr>
      <tr>
        <td id="L6008" data-line-number="6008"></td>
        <td id="LC6008">                <span>case</span> <span>SqlDbType</span>.<span>Udt</span>:</td>
      </tr>
      <tr>
        <td id="L6009" data-line-number="6009"></td>
        <td id="LC6009">                <span>case</span> <span>SqlDbType</span>.<span>Binary</span>:</td>
      </tr>
      <tr>
        <td id="L6010" data-line-number="6010"></td>
        <td id="LC6010">                <span>case</span> <span>SqlDbType</span>.<span>VarBinary</span>:</td>
      </tr>
      <tr>
        <td id="L6011" data-line-number="6011"></td>
        <td id="LC6011">                <span>case</span> <span>SqlDbType</span>.<span>Image</span>:</td>
      </tr>
      <tr>
        <td id="L6012" data-line-number="6012"></td>
        <td id="LC6012">                    <span>nullVal</span>.<span>SqlBinary</span> <span>=</span> <span>SqlBinary</span>.<span>Null</span>;</td>
      </tr>
      <tr>
        <td id="L6013" data-line-number="6013"></td>
        <td id="LC6013">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6014" data-line-number="6014"></td>
        <td id="LC6014">
</td>
      </tr>
      <tr>
        <td id="L6015" data-line-number="6015"></td>
        <td id="LC6015">                <span>case</span> <span>SqlDbType</span>.<span>UniqueIdentifier</span>:</td>
      </tr>
      <tr>
        <td id="L6016" data-line-number="6016"></td>
        <td id="LC6016">                    <span>nullVal</span>.<span>SqlGuid</span> <span>=</span> <span>SqlGuid</span>.<span>Null</span>;</td>
      </tr>
      <tr>
        <td id="L6017" data-line-number="6017"></td>
        <td id="LC6017">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6018" data-line-number="6018"></td>
        <td id="LC6018">
</td>
      </tr>
      <tr>
        <td id="L6019" data-line-number="6019"></td>
        <td id="LC6019">                <span>case</span> <span>SqlDbType</span>.<span>Bit</span>:</td>
      </tr>
      <tr>
        <td id="L6020" data-line-number="6020"></td>
        <td id="LC6020">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Boolean</span>);</td>
      </tr>
      <tr>
        <td id="L6021" data-line-number="6021"></td>
        <td id="LC6021">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6022" data-line-number="6022"></td>
        <td id="LC6022">
</td>
      </tr>
      <tr>
        <td id="L6023" data-line-number="6023"></td>
        <td id="LC6023">                <span>case</span> <span>SqlDbType</span>.<span>TinyInt</span>:</td>
      </tr>
      <tr>
        <td id="L6024" data-line-number="6024"></td>
        <td id="LC6024">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Byte</span>);</td>
      </tr>
      <tr>
        <td id="L6025" data-line-number="6025"></td>
        <td id="LC6025">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6026" data-line-number="6026"></td>
        <td id="LC6026">
</td>
      </tr>
      <tr>
        <td id="L6027" data-line-number="6027"></td>
        <td id="LC6027">                <span>case</span> <span>SqlDbType</span>.<span>SmallInt</span>:</td>
      </tr>
      <tr>
        <td id="L6028" data-line-number="6028"></td>
        <td id="LC6028">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Int16</span>);</td>
      </tr>
      <tr>
        <td id="L6029" data-line-number="6029"></td>
        <td id="LC6029">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6030" data-line-number="6030"></td>
        <td id="LC6030">
</td>
      </tr>
      <tr>
        <td id="L6031" data-line-number="6031"></td>
        <td id="LC6031">                <span>case</span> <span>SqlDbType</span>.<span>Int</span>:</td>
      </tr>
      <tr>
        <td id="L6032" data-line-number="6032"></td>
        <td id="LC6032">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Int32</span>);</td>
      </tr>
      <tr>
        <td id="L6033" data-line-number="6033"></td>
        <td id="LC6033">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6034" data-line-number="6034"></td>
        <td id="LC6034">
</td>
      </tr>
      <tr>
        <td id="L6035" data-line-number="6035"></td>
        <td id="LC6035">                <span>case</span> <span>SqlDbType</span>.<span>BigInt</span>:</td>
      </tr>
      <tr>
        <td id="L6036" data-line-number="6036"></td>
        <td id="LC6036">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Int64</span>);</td>
      </tr>
      <tr>
        <td id="L6037" data-line-number="6037"></td>
        <td id="LC6037">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6038" data-line-number="6038"></td>
        <td id="LC6038">
</td>
      </tr>
      <tr>
        <td id="L6039" data-line-number="6039"></td>
        <td id="LC6039">                <span>case</span> <span>SqlDbType</span>.<span>Char</span>:</td>
      </tr>
      <tr>
        <td id="L6040" data-line-number="6040"></td>
        <td id="LC6040">                <span>case</span> <span>SqlDbType</span>.<span>VarChar</span>:</td>
      </tr>
      <tr>
        <td id="L6041" data-line-number="6041"></td>
        <td id="LC6041">                <span>case</span> <span>SqlDbType</span>.<span>NChar</span>:</td>
      </tr>
      <tr>
        <td id="L6042" data-line-number="6042"></td>
        <td id="LC6042">                <span>case</span> <span>SqlDbType</span>.<span>NVarChar</span>:</td>
      </tr>
      <tr>
        <td id="L6043" data-line-number="6043"></td>
        <td id="LC6043">                <span>case</span> <span>SqlDbType</span>.<span>Text</span>:</td>
      </tr>
      <tr>
        <td id="L6044" data-line-number="6044"></td>
        <td id="LC6044">                <span>case</span> <span>SqlDbType</span>.<span>NText</span>:</td>
      </tr>
      <tr>
        <td id="L6045" data-line-number="6045"></td>
        <td id="LC6045">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>String</span>);</td>
      </tr>
      <tr>
        <td id="L6046" data-line-number="6046"></td>
        <td id="LC6046">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6047" data-line-number="6047"></td>
        <td id="LC6047">
</td>
      </tr>
      <tr>
        <td id="L6048" data-line-number="6048"></td>
        <td id="LC6048">                <span>case</span> <span>SqlDbType</span>.<span>Decimal</span>:</td>
      </tr>
      <tr>
        <td id="L6049" data-line-number="6049"></td>
        <td id="LC6049">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Decimal</span>);</td>
      </tr>
      <tr>
        <td id="L6050" data-line-number="6050"></td>
        <td id="LC6050">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6051" data-line-number="6051"></td>
        <td id="LC6051">
</td>
      </tr>
      <tr>
        <td id="L6052" data-line-number="6052"></td>
        <td id="LC6052">                <span>case</span> <span>SqlDbType</span>.<span>DateTime</span>:</td>
      </tr>
      <tr>
        <td id="L6053" data-line-number="6053"></td>
        <td id="LC6053">                <span>case</span> <span>SqlDbType</span>.<span>SmallDateTime</span>:</td>
      </tr>
      <tr>
        <td id="L6054" data-line-number="6054"></td>
        <td id="LC6054">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>DateTime</span>);</td>
      </tr>
      <tr>
        <td id="L6055" data-line-number="6055"></td>
        <td id="LC6055">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6056" data-line-number="6056"></td>
        <td id="LC6056">
</td>
      </tr>
      <tr>
        <td id="L6057" data-line-number="6057"></td>
        <td id="LC6057">                <span>case</span> <span>SqlDbType</span>.<span>Money</span>:</td>
      </tr>
      <tr>
        <td id="L6058" data-line-number="6058"></td>
        <td id="LC6058">                <span>case</span> <span>SqlDbType</span>.<span>SmallMoney</span>:</td>
      </tr>
      <tr>
        <td id="L6059" data-line-number="6059"></td>
        <td id="LC6059">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Money</span>);</td>
      </tr>
      <tr>
        <td id="L6060" data-line-number="6060"></td>
        <td id="LC6060">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6061" data-line-number="6061"></td>
        <td id="LC6061">
</td>
      </tr>
      <tr>
        <td id="L6062" data-line-number="6062"></td>
        <td id="LC6062">                <span>case</span> <span>SqlDbType</span>.<span>Variant</span>:</td>
      </tr>
      <tr>
        <td id="L6063" data-line-number="6063"></td>
        <td id="LC6063">                    <span><span>//</span> DBNull.Value will have to work here</span></td>
      </tr>
      <tr>
        <td id="L6064" data-line-number="6064"></td>
        <td id="LC6064">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Empty</span>);</td>
      </tr>
      <tr>
        <td id="L6065" data-line-number="6065"></td>
        <td id="LC6065">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6066" data-line-number="6066"></td>
        <td id="LC6066">
</td>
      </tr>
      <tr>
        <td id="L6067" data-line-number="6067"></td>
        <td id="LC6067">                <span>case</span> <span>SqlDbType</span>.<span>Xml</span>:</td>
      </tr>
      <tr>
        <td id="L6068" data-line-number="6068"></td>
        <td id="LC6068">                    <span>nullVal</span>.<span>SqlCachedBuffer</span> <span>=</span> <span>SqlCachedBuffer</span>.<span>Null</span>;</td>
      </tr>
      <tr>
        <td id="L6069" data-line-number="6069"></td>
        <td id="LC6069">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6070" data-line-number="6070"></td>
        <td id="LC6070">
</td>
      </tr>
      <tr>
        <td id="L6071" data-line-number="6071"></td>
        <td id="LC6071">                <span>case</span> <span>SqlDbType</span>.<span>Date</span>:</td>
      </tr>
      <tr>
        <td id="L6072" data-line-number="6072"></td>
        <td id="LC6072">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Date</span>);</td>
      </tr>
      <tr>
        <td id="L6073" data-line-number="6073"></td>
        <td id="LC6073">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6074" data-line-number="6074"></td>
        <td id="LC6074">
</td>
      </tr>
      <tr>
        <td id="L6075" data-line-number="6075"></td>
        <td id="LC6075">                <span>case</span> <span>SqlDbType</span>.<span>Time</span>:</td>
      </tr>
      <tr>
        <td id="L6076" data-line-number="6076"></td>
        <td id="LC6076">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>Time</span>);</td>
      </tr>
      <tr>
        <td id="L6077" data-line-number="6077"></td>
        <td id="LC6077">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6078" data-line-number="6078"></td>
        <td id="LC6078">
</td>
      </tr>
      <tr>
        <td id="L6079" data-line-number="6079"></td>
        <td id="LC6079">                <span>case</span> <span>SqlDbType</span>.<span>DateTime2</span>:</td>
      </tr>
      <tr>
        <td id="L6080" data-line-number="6080"></td>
        <td id="LC6080">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>DateTime2</span>);</td>
      </tr>
      <tr>
        <td id="L6081" data-line-number="6081"></td>
        <td id="LC6081">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6082" data-line-number="6082"></td>
        <td id="LC6082">
</td>
      </tr>
      <tr>
        <td id="L6083" data-line-number="6083"></td>
        <td id="LC6083">                <span>case</span> <span>SqlDbType</span>.<span>DateTimeOffset</span>:</td>
      </tr>
      <tr>
        <td id="L6084" data-line-number="6084"></td>
        <td id="LC6084">                    <span>nullVal</span>.<span>SetToNullOfType</span>(<span>SqlBuffer</span>.<span>StorageType</span>.<span>DateTimeOffset</span>);</td>
      </tr>
      <tr>
        <td id="L6085" data-line-number="6085"></td>
        <td id="LC6085">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6086" data-line-number="6086"></td>
        <td id="LC6086">
</td>
      </tr>
      <tr>
        <td id="L6087" data-line-number="6087"></td>
        <td id="LC6087">                <span>case</span> <span>SqlDbType</span>.<span>Timestamp</span>:</td>
      </tr>
      <tr>
        <td id="L6088" data-line-number="6088"></td>
        <td id="LC6088">                    <span><span>//</span> Dev10 Bug #479607 - this should have been the same as SqlDbType.Binary, but it's a rejected breaking change</span></td>
      </tr>
      <tr>
        <td id="L6089" data-line-number="6089"></td>
        <td id="LC6089">                    <span><span>//</span> Dev10 Bug #752790 - don't assert when it does happen</span></td>
      </tr>
      <tr>
        <td id="L6090" data-line-number="6090"></td>
        <td id="LC6090">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6091" data-line-number="6091"></td>
        <td id="LC6091">
</td>
      </tr>
      <tr>
        <td id="L6092" data-line-number="6092"></td>
        <td id="LC6092">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L6093" data-line-number="6093"></td>
        <td id="LC6093">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>unknown null sqlType!<span>"</span></span> <span>+</span> <span>md</span>.<span>type</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L6094" data-line-number="6094"></td>
        <td id="LC6094">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6095" data-line-number="6095"></td>
        <td id="LC6095">            }</td>
      </tr>
      <tr>
        <td id="L6096" data-line-number="6096"></td>
        <td id="LC6096">
</td>
      </tr>
      <tr>
        <td id="L6097" data-line-number="6097"></td>
        <td id="LC6097">            <span>return</span> <span>nullVal</span>;</td>
      </tr>
      <tr>
        <td id="L6098" data-line-number="6098"></td>
        <td id="LC6098">        }</td>
      </tr>
      <tr>
        <td id="L6099" data-line-number="6099"></td>
        <td id="LC6099">
</td>
      </tr>
      <tr>
        <td id="L6100" data-line-number="6100"></td>
        <td id="LC6100">        <span>internal</span> <span>bool</span> <span>TrySkipRow</span>(<span>_SqlMetaDataSet</span> <span>columns</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L6101" data-line-number="6101"></td>
        <td id="LC6101">        {</td>
      </tr>
      <tr>
        <td id="L6102" data-line-number="6102"></td>
        <td id="LC6102">            <span>return</span> <span>TrySkipRow</span>(<span>columns</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L6103" data-line-number="6103"></td>
        <td id="LC6103">        }</td>
      </tr>
      <tr>
        <td id="L6104" data-line-number="6104"></td>
        <td id="LC6104">
</td>
      </tr>
      <tr>
        <td id="L6105" data-line-number="6105"></td>
        <td id="LC6105">        <span>internal</span> <span>bool</span> <span>TrySkipRow</span>(<span>_SqlMetaDataSet</span> <span>columns</span>, <span>int</span> <span>startCol</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L6106" data-line-number="6106"></td>
        <td id="LC6106">        {</td>
      </tr>
      <tr>
        <td id="L6107" data-line-number="6107"></td>
        <td id="LC6107">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>startCol</span>; <span>i</span> <span>&lt;</span> <span>columns</span>.<span>Length</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L6108" data-line-number="6108"></td>
        <td id="LC6108">            {</td>
      </tr>
      <tr>
        <td id="L6109" data-line-number="6109"></td>
        <td id="LC6109">                <span>_SqlMetaData</span> <span>md</span> <span>=</span> <span>columns</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L6110" data-line-number="6110"></td>
        <td id="LC6110">
</td>
      </tr>
      <tr>
        <td id="L6111" data-line-number="6111"></td>
        <td id="LC6111">                <span>if</span> (<span>!</span><span>TrySkipValue</span>(<span>md</span>, <span>i</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L6112" data-line-number="6112"></td>
        <td id="LC6112">                {</td>
      </tr>
      <tr>
        <td id="L6113" data-line-number="6113"></td>
        <td id="LC6113">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6114" data-line-number="6114"></td>
        <td id="LC6114">                }</td>
      </tr>
      <tr>
        <td id="L6115" data-line-number="6115"></td>
        <td id="LC6115">            }</td>
      </tr>
      <tr>
        <td id="L6116" data-line-number="6116"></td>
        <td id="LC6116">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6117" data-line-number="6117"></td>
        <td id="LC6117">        }</td>
      </tr>
      <tr>
        <td id="L6118" data-line-number="6118"></td>
        <td id="LC6118">
</td>
      </tr>
      <tr>
        <td id="L6119" data-line-number="6119"></td>
        <td id="LC6119">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L6120" data-line-number="6120"></td>
        <td id="LC6120">        <span><span>///</span> This method skips bytes of a single column value from the media. It supports NBCROW and handles all types of values, including PLP and long</span></td>
      </tr>
      <tr>
        <td id="L6121" data-line-number="6121"></td>
        <td id="LC6121">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L6122" data-line-number="6122"></td>
        <td id="LC6122">        <span>internal</span> <span>bool</span> <span>TrySkipValue</span>(<span>SqlMetaDataPriv</span> <span>md</span>, <span>int</span> <span>columnOrdinal</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L6123" data-line-number="6123"></td>
        <td id="LC6123">        {</td>
      </tr>
      <tr>
        <td id="L6124" data-line-number="6124"></td>
        <td id="LC6124">            <span>if</span> (<span>stateObj</span>.<span>IsNullCompressionBitSet</span>(<span>columnOrdinal</span>))</td>
      </tr>
      <tr>
        <td id="L6125" data-line-number="6125"></td>
        <td id="LC6125">            {</td>
      </tr>
      <tr>
        <td id="L6126" data-line-number="6126"></td>
        <td id="LC6126">                <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6127" data-line-number="6127"></td>
        <td id="LC6127">            }</td>
      </tr>
      <tr>
        <td id="L6128" data-line-number="6128"></td>
        <td id="LC6128">
</td>
      </tr>
      <tr>
        <td id="L6129" data-line-number="6129"></td>
        <td id="LC6129">            <span>if</span> (<span>md</span>.<span>metaType</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L6130" data-line-number="6130"></td>
        <td id="LC6130">            {</td>
      </tr>
      <tr>
        <td id="L6131" data-line-number="6131"></td>
        <td id="LC6131">                <span>ulong</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L6132" data-line-number="6132"></td>
        <td id="LC6132">                <span>if</span> (<span>!</span><span>TrySkipPlpValue</span>(<span>UInt64</span>.<span>MaxValue</span>, <span>stateObj</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L6133" data-line-number="6133"></td>
        <td id="LC6133">                {</td>
      </tr>
      <tr>
        <td id="L6134" data-line-number="6134"></td>
        <td id="LC6134">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6135" data-line-number="6135"></td>
        <td id="LC6135">                }</td>
      </tr>
      <tr>
        <td id="L6136" data-line-number="6136"></td>
        <td id="LC6136">            }</td>
      </tr>
      <tr>
        <td id="L6137" data-line-number="6137"></td>
        <td id="LC6137">            <span>else</span> <span>if</span> (<span>md</span>.<span>metaType</span>.<span>IsLong</span>)</td>
      </tr>
      <tr>
        <td id="L6138" data-line-number="6138"></td>
        <td id="LC6138">            {</td>
      </tr>
      <tr>
        <td id="L6139" data-line-number="6139"></td>
        <td id="LC6139">
</td>
      </tr>
      <tr>
        <td id="L6140" data-line-number="6140"></td>
        <td id="LC6140">                <span>Debug</span>.<span>Assert</span>(<span>!</span><span>md</span>.<span>metaType</span>.<span>IsPlp</span>, <span><span>"</span>Plp types must be handled using SkipPlpValue<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6141" data-line-number="6141"></td>
        <td id="LC6141">
</td>
      </tr>
      <tr>
        <td id="L6142" data-line-number="6142"></td>
        <td id="LC6142">                <span>byte</span> <span>textPtrLen</span>;</td>
      </tr>
      <tr>
        <td id="L6143" data-line-number="6143"></td>
        <td id="LC6143">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>textPtrLen</span>))</td>
      </tr>
      <tr>
        <td id="L6144" data-line-number="6144"></td>
        <td id="LC6144">                {</td>
      </tr>
      <tr>
        <td id="L6145" data-line-number="6145"></td>
        <td id="LC6145">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6146" data-line-number="6146"></td>
        <td id="LC6146">                }</td>
      </tr>
      <tr>
        <td id="L6147" data-line-number="6147"></td>
        <td id="LC6147">
</td>
      </tr>
      <tr>
        <td id="L6148" data-line-number="6148"></td>
        <td id="LC6148">                <span>if</span> (<span>0</span> <span>!=</span> <span>textPtrLen</span>)</td>
      </tr>
      <tr>
        <td id="L6149" data-line-number="6149"></td>
        <td id="LC6149">                {</td>
      </tr>
      <tr>
        <td id="L6150" data-line-number="6150"></td>
        <td id="LC6150">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>textPtrLen</span> <span>+</span> <span>TdsEnums</span>.<span>TEXT_TIME_STAMP_LEN</span>))</td>
      </tr>
      <tr>
        <td id="L6151" data-line-number="6151"></td>
        <td id="LC6151">                    {</td>
      </tr>
      <tr>
        <td id="L6152" data-line-number="6152"></td>
        <td id="LC6152">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6153" data-line-number="6153"></td>
        <td id="LC6153">                    }</td>
      </tr>
      <tr>
        <td id="L6154" data-line-number="6154"></td>
        <td id="LC6154">
</td>
      </tr>
      <tr>
        <td id="L6155" data-line-number="6155"></td>
        <td id="LC6155">                    <span>int</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L6156" data-line-number="6156"></td>
        <td id="LC6156">                    <span>if</span> (<span>!</span><span>TryGetTokenLength</span>(<span>md</span>.<span>tdsType</span>, <span>stateObj</span>, <span>out</span> <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6157" data-line-number="6157"></td>
        <td id="LC6157">                    {</td>
      </tr>
      <tr>
        <td id="L6158" data-line-number="6158"></td>
        <td id="LC6158">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6159" data-line-number="6159"></td>
        <td id="LC6159">                    }</td>
      </tr>
      <tr>
        <td id="L6160" data-line-number="6160"></td>
        <td id="LC6160">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6161" data-line-number="6161"></td>
        <td id="LC6161">                    {</td>
      </tr>
      <tr>
        <td id="L6162" data-line-number="6162"></td>
        <td id="LC6162">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6163" data-line-number="6163"></td>
        <td id="LC6163">                    }</td>
      </tr>
      <tr>
        <td id="L6164" data-line-number="6164"></td>
        <td id="LC6164">                }</td>
      </tr>
      <tr>
        <td id="L6165" data-line-number="6165"></td>
        <td id="LC6165">            }</td>
      </tr>
      <tr>
        <td id="L6166" data-line-number="6166"></td>
        <td id="LC6166">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L6167" data-line-number="6167"></td>
        <td id="LC6167">            {</td>
      </tr>
      <tr>
        <td id="L6168" data-line-number="6168"></td>
        <td id="LC6168">                <span>int</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L6169" data-line-number="6169"></td>
        <td id="LC6169">                <span>if</span> (<span>!</span><span>TryGetTokenLength</span>(<span>md</span>.<span>tdsType</span>, <span>stateObj</span>, <span>out</span> <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6170" data-line-number="6170"></td>
        <td id="LC6170">                {</td>
      </tr>
      <tr>
        <td id="L6171" data-line-number="6171"></td>
        <td id="LC6171">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6172" data-line-number="6172"></td>
        <td id="LC6172">                }</td>
      </tr>
      <tr>
        <td id="L6173" data-line-number="6173"></td>
        <td id="LC6173">
</td>
      </tr>
      <tr>
        <td id="L6174" data-line-number="6174"></td>
        <td id="LC6174">                <span><span>//</span> if false, no value to skip - it's null</span></td>
      </tr>
      <tr>
        <td id="L6175" data-line-number="6175"></td>
        <td id="LC6175">                <span>if</span> (<span>!</span><span>IsNull</span>(<span>md</span>.<span>metaType</span>, (<span>ulong</span>)<span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6176" data-line-number="6176"></td>
        <td id="LC6176">                {</td>
      </tr>
      <tr>
        <td id="L6177" data-line-number="6177"></td>
        <td id="LC6177">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6178" data-line-number="6178"></td>
        <td id="LC6178">                    {</td>
      </tr>
      <tr>
        <td id="L6179" data-line-number="6179"></td>
        <td id="LC6179">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6180" data-line-number="6180"></td>
        <td id="LC6180">                    }</td>
      </tr>
      <tr>
        <td id="L6181" data-line-number="6181"></td>
        <td id="LC6181">                }</td>
      </tr>
      <tr>
        <td id="L6182" data-line-number="6182"></td>
        <td id="LC6182">            }</td>
      </tr>
      <tr>
        <td id="L6183" data-line-number="6183"></td>
        <td id="LC6183">
</td>
      </tr>
      <tr>
        <td id="L6184" data-line-number="6184"></td>
        <td id="LC6184">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6185" data-line-number="6185"></td>
        <td id="LC6185">        }</td>
      </tr>
      <tr>
        <td id="L6186" data-line-number="6186"></td>
        <td id="LC6186">
</td>
      </tr>
      <tr>
        <td id="L6187" data-line-number="6187"></td>
        <td id="LC6187">        <span>private</span> <span>bool</span> <span>IsNull</span>(<span>MetaType</span> <span>mt</span>, <span>ulong</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L6188" data-line-number="6188"></td>
        <td id="LC6188">        {</td>
      </tr>
      <tr>
        <td id="L6189" data-line-number="6189"></td>
        <td id="LC6189">            <span><span>//</span> null bin and char types have a length of -1 to represent null</span></td>
      </tr>
      <tr>
        <td id="L6190" data-line-number="6190"></td>
        <td id="LC6190">            <span>if</span> (<span>mt</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L6191" data-line-number="6191"></td>
        <td id="LC6191">            {</td>
      </tr>
      <tr>
        <td id="L6192" data-line-number="6192"></td>
        <td id="LC6192">                <span>return</span> (<span>TdsEnums</span>.<span>SQL_PLP_NULL</span> <span>==</span> <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L6193" data-line-number="6193"></td>
        <td id="LC6193">            }</td>
      </tr>
      <tr>
        <td id="L6194" data-line-number="6194"></td>
        <td id="LC6194">
</td>
      </tr>
      <tr>
        <td id="L6195" data-line-number="6195"></td>
        <td id="LC6195">            <span><span>//</span> HOTFIX #50000415: for image/text, 0xFFFF is the length, not representing null</span></td>
      </tr>
      <tr>
        <td id="L6196" data-line-number="6196"></td>
        <td id="LC6196">            <span>if</span> ((<span>TdsEnums</span>.<span>VARNULL</span> <span>==</span> <span>length</span>) <span>&amp;&amp;</span> <span>!</span><span>mt</span>.<span>IsLong</span>)</td>
      </tr>
      <tr>
        <td id="L6197" data-line-number="6197"></td>
        <td id="LC6197">            {</td>
      </tr>
      <tr>
        <td id="L6198" data-line-number="6198"></td>
        <td id="LC6198">                <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6199" data-line-number="6199"></td>
        <td id="LC6199">            }</td>
      </tr>
      <tr>
        <td id="L6200" data-line-number="6200"></td>
        <td id="LC6200">
</td>
      </tr>
      <tr>
        <td id="L6201" data-line-number="6201"></td>
        <td id="LC6201">            <span><span>//</span> other types have a length of 0 to represent null</span></td>
      </tr>
      <tr>
        <td id="L6202" data-line-number="6202"></td>
        <td id="LC6202">            <span><span>//</span> long and non-PLP types will always return false because these types are either char or binary</span></td>
      </tr>
      <tr>
        <td id="L6203" data-line-number="6203"></td>
        <td id="LC6203">            <span><span>//</span> this is expected since for long and non-plp types isnull is checked based on textptr field and not the length</span></td>
      </tr>
      <tr>
        <td id="L6204" data-line-number="6204"></td>
        <td id="LC6204">            <span>return</span> ((<span>TdsEnums</span>.<span>FIXEDNULL</span> <span>==</span> <span>length</span>) <span>&amp;&amp;</span> <span>!</span><span>mt</span>.<span>IsCharType</span> <span>&amp;&amp;</span> <span>!</span><span>mt</span>.<span>IsBinType</span>);</td>
      </tr>
      <tr>
        <td id="L6205" data-line-number="6205"></td>
        <td id="LC6205">        }</td>
      </tr>
      <tr>
        <td id="L6206" data-line-number="6206"></td>
        <td id="LC6206">
</td>
      </tr>
      <tr>
        <td id="L6207" data-line-number="6207"></td>
        <td id="LC6207">        <span>private</span> <span>bool</span> <span>TryReadSqlStringValue</span>(<span>SqlBuffer</span> <span>value</span>, <span>byte</span> <span>type</span>, <span>int</span> <span>length</span>, <span>Encoding</span> <span>encoding</span>, <span>bool</span> <span>isPlp</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L6208" data-line-number="6208"></td>
        <td id="LC6208">        {</td>
      </tr>
      <tr>
        <td id="L6209" data-line-number="6209"></td>
        <td id="LC6209">            <span>switch</span> (<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L6210" data-line-number="6210"></td>
        <td id="LC6210">            {</td>
      </tr>
      <tr>
        <td id="L6211" data-line-number="6211"></td>
        <td id="LC6211">                <span>case</span> <span>TdsEnums</span>.<span>SQLCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6212" data-line-number="6212"></td>
        <td id="LC6212">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6213" data-line-number="6213"></td>
        <td id="LC6213">                <span>case</span> <span>TdsEnums</span>.<span>SQLVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6214" data-line-number="6214"></td>
        <td id="LC6214">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6215" data-line-number="6215"></td>
        <td id="LC6215">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L6216" data-line-number="6216"></td>
        <td id="LC6216">                    <span><span>//</span> If bigvarchar(max), we only read the first chunk here,</span></td>
      </tr>
      <tr>
        <td id="L6217" data-line-number="6217"></td>
        <td id="LC6217">                    <span><span>//</span> expecting the caller to read the rest</span></td>
      </tr>
      <tr>
        <td id="L6218" data-line-number="6218"></td>
        <td id="LC6218">                    <span>if</span> (<span>encoding</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L6219" data-line-number="6219"></td>
        <td id="LC6219">                    {</td>
      </tr>
      <tr>
        <td id="L6220" data-line-number="6220"></td>
        <td id="LC6220">                        <span><span>//</span> if hitting 7.0 server, encoding will be null in metadata for columns or return values since</span></td>
      </tr>
      <tr>
        <td id="L6221" data-line-number="6221"></td>
        <td id="LC6221">                        <span><span>//</span> 7.0 has no support for multiple code pages in data - single code page support only</span></td>
      </tr>
      <tr>
        <td id="L6222" data-line-number="6222"></td>
        <td id="LC6222">                        <span>encoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L6223" data-line-number="6223"></td>
        <td id="LC6223">                    }</td>
      </tr>
      <tr>
        <td id="L6224" data-line-number="6224"></td>
        <td id="LC6224">                    <span>string</span> <span>stringValue</span>;</td>
      </tr>
      <tr>
        <td id="L6225" data-line-number="6225"></td>
        <td id="LC6225">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadStringWithEncoding</span>(<span>length</span>, <span>encoding</span>, <span>isPlp</span>, <span>out</span> <span>stringValue</span>))</td>
      </tr>
      <tr>
        <td id="L6226" data-line-number="6226"></td>
        <td id="LC6226">                    {</td>
      </tr>
      <tr>
        <td id="L6227" data-line-number="6227"></td>
        <td id="LC6227">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6228" data-line-number="6228"></td>
        <td id="LC6228">                    }</td>
      </tr>
      <tr>
        <td id="L6229" data-line-number="6229"></td>
        <td id="LC6229">                    <span>value</span>.<span>SetToString</span>(<span>stringValue</span>);</td>
      </tr>
      <tr>
        <td id="L6230" data-line-number="6230"></td>
        <td id="LC6230">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6231" data-line-number="6231"></td>
        <td id="LC6231">
</td>
      </tr>
      <tr>
        <td id="L6232" data-line-number="6232"></td>
        <td id="LC6232">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6233" data-line-number="6233"></td>
        <td id="LC6233">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6234" data-line-number="6234"></td>
        <td id="LC6234">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L6235" data-line-number="6235"></td>
        <td id="LC6235">                    {</td>
      </tr>
      <tr>
        <td id="L6236" data-line-number="6236"></td>
        <td id="LC6236">                        <span>String</span> <span>s</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L6237" data-line-number="6237"></td>
        <td id="LC6237">
</td>
      </tr>
      <tr>
        <td id="L6238" data-line-number="6238"></td>
        <td id="LC6238">                        <span>if</span> (<span>isPlp</span>)</td>
      </tr>
      <tr>
        <td id="L6239" data-line-number="6239"></td>
        <td id="LC6239">                        {</td>
      </tr>
      <tr>
        <td id="L6240" data-line-number="6240"></td>
        <td id="LC6240">                            <span>char</span>[] <span>cc</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L6241" data-line-number="6241"></td>
        <td id="LC6241">
</td>
      </tr>
      <tr>
        <td id="L6242" data-line-number="6242"></td>
        <td id="LC6242">                            <span>if</span> (<span>!</span><span>TryReadPlpUnicodeChars</span>(<span>ref</span> <span>cc</span>, <span>0</span>, <span>length</span> <span>&gt;&gt;</span> <span>1</span>, <span>stateObj</span>, <span>out</span> <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6243" data-line-number="6243"></td>
        <td id="LC6243">                            {</td>
      </tr>
      <tr>
        <td id="L6244" data-line-number="6244"></td>
        <td id="LC6244">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6245" data-line-number="6245"></td>
        <td id="LC6245">                            }</td>
      </tr>
      <tr>
        <td id="L6246" data-line-number="6246"></td>
        <td id="LC6246">                            <span>if</span> (<span>length</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L6247" data-line-number="6247"></td>
        <td id="LC6247">                            {</td>
      </tr>
      <tr>
        <td id="L6248" data-line-number="6248"></td>
        <td id="LC6248">                                <span>s</span> <span>=</span> <span>new</span> <span>String</span>(<span>cc</span>, <span>0</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L6249" data-line-number="6249"></td>
        <td id="LC6249">                            }</td>
      </tr>
      <tr>
        <td id="L6250" data-line-number="6250"></td>
        <td id="LC6250">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L6251" data-line-number="6251"></td>
        <td id="LC6251">                            {</td>
      </tr>
      <tr>
        <td id="L6252" data-line-number="6252"></td>
        <td id="LC6252">                                <span>s</span> <span>=</span> <span>ADP</span>.<span>StrEmpty</span>;</td>
      </tr>
      <tr>
        <td id="L6253" data-line-number="6253"></td>
        <td id="LC6253">                            }</td>
      </tr>
      <tr>
        <td id="L6254" data-line-number="6254"></td>
        <td id="LC6254">                        }</td>
      </tr>
      <tr>
        <td id="L6255" data-line-number="6255"></td>
        <td id="LC6255">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L6256" data-line-number="6256"></td>
        <td id="LC6256">                        {</td>
      </tr>
      <tr>
        <td id="L6257" data-line-number="6257"></td>
        <td id="LC6257">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadString</span>(<span>length</span> <span>&gt;&gt;</span> <span>1</span>, <span>out</span> <span>s</span>))</td>
      </tr>
      <tr>
        <td id="L6258" data-line-number="6258"></td>
        <td id="LC6258">                            {</td>
      </tr>
      <tr>
        <td id="L6259" data-line-number="6259"></td>
        <td id="LC6259">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6260" data-line-number="6260"></td>
        <td id="LC6260">                            }</td>
      </tr>
      <tr>
        <td id="L6261" data-line-number="6261"></td>
        <td id="LC6261">                        }</td>
      </tr>
      <tr>
        <td id="L6262" data-line-number="6262"></td>
        <td id="LC6262">
</td>
      </tr>
      <tr>
        <td id="L6263" data-line-number="6263"></td>
        <td id="LC6263">                        <span>value</span>.<span>SetToString</span>(<span>s</span>);</td>
      </tr>
      <tr>
        <td id="L6264" data-line-number="6264"></td>
        <td id="LC6264">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6265" data-line-number="6265"></td>
        <td id="LC6265">                    }</td>
      </tr>
      <tr>
        <td id="L6266" data-line-number="6266"></td>
        <td id="LC6266">
</td>
      </tr>
      <tr>
        <td id="L6267" data-line-number="6267"></td>
        <td id="LC6267">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L6268" data-line-number="6268"></td>
        <td id="LC6268">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown tds type for SqlString!<span>"</span></span> <span>+</span> <span>type</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L6269" data-line-number="6269"></td>
        <td id="LC6269">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6270" data-line-number="6270"></td>
        <td id="LC6270">            }</td>
      </tr>
      <tr>
        <td id="L6271" data-line-number="6271"></td>
        <td id="LC6271">
</td>
      </tr>
      <tr>
        <td id="L6272" data-line-number="6272"></td>
        <td id="LC6272">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6273" data-line-number="6273"></td>
        <td id="LC6273">        }</td>
      </tr>
      <tr>
        <td id="L6274" data-line-number="6274"></td>
        <td id="LC6274">
</td>
      </tr>
      <tr>
        <td id="L6275" data-line-number="6275"></td>
        <td id="LC6275">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L6276" data-line-number="6276"></td>
        <td id="LC6276">        <span><span>///</span> Deserializes the unencrypted bytes into a value based on the target type info.</span></td>
      </tr>
      <tr>
        <td id="L6277" data-line-number="6277"></td>
        <td id="LC6277">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L6278" data-line-number="6278"></td>
        <td id="LC6278">        <span>internal</span> <span>bool</span> <span>DeserializeUnencryptedValue</span>(<span>SqlBuffer</span> <span>value</span>, <span>byte</span>[] <span>unencryptedBytes</span>, <span>SqlMetaDataPriv</span> <span>md</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>byte</span> <span>normalizationVersion</span>)</td>
      </tr>
      <tr>
        <td id="L6279" data-line-number="6279"></td>
        <td id="LC6279">        {</td>
      </tr>
      <tr>
        <td id="L6280" data-line-number="6280"></td>
        <td id="LC6280">            <span>if</span> (<span>normalizationVersion</span> <span>!=</span> <span>0x01</span>)</td>
      </tr>
      <tr>
        <td id="L6281" data-line-number="6281"></td>
        <td id="LC6281">            {</td>
      </tr>
      <tr>
        <td id="L6282" data-line-number="6282"></td>
        <td id="LC6282">                <span>throw</span> <span>SQL</span>.<span>UnsupportedNormalizationVersion</span>(<span>normalizationVersion</span>);</td>
      </tr>
      <tr>
        <td id="L6283" data-line-number="6283"></td>
        <td id="LC6283">            }</td>
      </tr>
      <tr>
        <td id="L6284" data-line-number="6284"></td>
        <td id="LC6284">
</td>
      </tr>
      <tr>
        <td id="L6285" data-line-number="6285"></td>
        <td id="LC6285">            <span>byte</span> <span>tdsType</span> <span>=</span> <span>md</span>.<span>baseTI</span>.<span>tdsType</span>;</td>
      </tr>
      <tr>
        <td id="L6286" data-line-number="6286"></td>
        <td id="LC6286">            <span>int</span> <span>length</span> <span>=</span> <span>unencryptedBytes</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L6287" data-line-number="6287"></td>
        <td id="LC6287">
</td>
      </tr>
      <tr>
        <td id="L6288" data-line-number="6288"></td>
        <td id="LC6288">            <span><span>//</span> For normalized types, the length and scale of the actual type might be different than the value's.</span></td>
      </tr>
      <tr>
        <td id="L6289" data-line-number="6289"></td>
        <td id="LC6289">            <span>int</span> <span>denormalizedLength</span> <span>=</span> <span>md</span>.<span>baseTI</span>.<span>length</span>;</td>
      </tr>
      <tr>
        <td id="L6290" data-line-number="6290"></td>
        <td id="LC6290">            <span>byte</span> <span>denormalizedScale</span> <span>=</span> <span>md</span>.<span>baseTI</span>.<span>scale</span>;</td>
      </tr>
      <tr>
        <td id="L6291" data-line-number="6291"></td>
        <td id="LC6291">
</td>
      </tr>
      <tr>
        <td id="L6292" data-line-number="6292"></td>
        <td id="LC6292">            <span>Debug</span>.<span>Assert</span>(<span>false</span> <span>==</span> <span>md</span>.<span>baseTI</span>.<span>isEncrypted</span>, <span><span>"</span>Double encryption detected<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6293" data-line-number="6293"></td>
        <td id="LC6293">            <span>switch</span> (<span>tdsType</span>)</td>
      </tr>
      <tr>
        <td id="L6294" data-line-number="6294"></td>
        <td id="LC6294">            {</td>
      </tr>
      <tr>
        <td id="L6295" data-line-number="6295"></td>
        <td id="LC6295">                <span><span>//</span> We normalize to allow conversion across data types. All data types below are serialized into a BIGINT.</span></td>
      </tr>
      <tr>
        <td id="L6296" data-line-number="6296"></td>
        <td id="LC6296">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIT</span>:</td>
      </tr>
      <tr>
        <td id="L6297" data-line-number="6297"></td>
        <td id="LC6297">                <span>case</span> <span>TdsEnums</span>.<span>SQLBITN</span>:</td>
      </tr>
      <tr>
        <td id="L6298" data-line-number="6298"></td>
        <td id="LC6298">                <span>case</span> <span>TdsEnums</span>.<span>SQLINTN</span>:</td>
      </tr>
      <tr>
        <td id="L6299" data-line-number="6299"></td>
        <td id="LC6299">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT1</span>:</td>
      </tr>
      <tr>
        <td id="L6300" data-line-number="6300"></td>
        <td id="LC6300">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT2</span>:</td>
      </tr>
      <tr>
        <td id="L6301" data-line-number="6301"></td>
        <td id="LC6301">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT4</span>:</td>
      </tr>
      <tr>
        <td id="L6302" data-line-number="6302"></td>
        <td id="LC6302">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT8</span>:</td>
      </tr>
      <tr>
        <td id="L6303" data-line-number="6303"></td>
        <td id="LC6303">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for SqlInt64 type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6304" data-line-number="6304"></td>
        <td id="LC6304">                    <span>byte</span> <span>byteValue</span>;</td>
      </tr>
      <tr>
        <td id="L6305" data-line-number="6305"></td>
        <td id="LC6305">                    <span>long</span> <span>longValue</span>;</td>
      </tr>
      <tr>
        <td id="L6306" data-line-number="6306"></td>
        <td id="LC6306">
</td>
      </tr>
      <tr>
        <td id="L6307" data-line-number="6307"></td>
        <td id="LC6307">                    <span>if</span> (<span>unencryptedBytes</span>.<span>Length</span> <span>!=</span> <span>8</span>)</td>
      </tr>
      <tr>
        <td id="L6308" data-line-number="6308"></td>
        <td id="LC6308">                    {</td>
      </tr>
      <tr>
        <td id="L6309" data-line-number="6309"></td>
        <td id="LC6309">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6310" data-line-number="6310"></td>
        <td id="LC6310">                    }</td>
      </tr>
      <tr>
        <td id="L6311" data-line-number="6311"></td>
        <td id="LC6311">
</td>
      </tr>
      <tr>
        <td id="L6312" data-line-number="6312"></td>
        <td id="LC6312">                    <span>longValue</span> <span>=</span> <span>BitConverter</span>.<span>ToInt64</span>(<span>unencryptedBytes</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L6313" data-line-number="6313"></td>
        <td id="LC6313">
</td>
      </tr>
      <tr>
        <td id="L6314" data-line-number="6314"></td>
        <td id="LC6314">                    <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBIT</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L6315" data-line-number="6315"></td>
        <td id="LC6315">                        <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBITN</span>)</td>
      </tr>
      <tr>
        <td id="L6316" data-line-number="6316"></td>
        <td id="LC6316">                    {</td>
      </tr>
      <tr>
        <td id="L6317" data-line-number="6317"></td>
        <td id="LC6317">                        <span>value</span>.<span>Boolean</span> <span>=</span> (<span>longValue</span> <span>!=</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L6318" data-line-number="6318"></td>
        <td id="LC6318">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6319" data-line-number="6319"></td>
        <td id="LC6319">                    }</td>
      </tr>
      <tr>
        <td id="L6320" data-line-number="6320"></td>
        <td id="LC6320">
</td>
      </tr>
      <tr>
        <td id="L6321" data-line-number="6321"></td>
        <td id="LC6321">                    <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLINT1</span> <span>||</span> <span>denormalizedLength</span> <span>==</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L6322" data-line-number="6322"></td>
        <td id="LC6322">                        <span>value</span>.<span>Byte</span> <span>=</span> (<span>byte</span>)<span>longValue</span>;</td>
      </tr>
      <tr>
        <td id="L6323" data-line-number="6323"></td>
        <td id="LC6323">                    <span>else</span> <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLINT2</span> <span>||</span> <span>denormalizedLength</span> <span>==</span> <span>2</span>)</td>
      </tr>
      <tr>
        <td id="L6324" data-line-number="6324"></td>
        <td id="LC6324">                        <span>value</span>.<span>Int16</span> <span>=</span> (<span>Int16</span>)<span>longValue</span>;</td>
      </tr>
      <tr>
        <td id="L6325" data-line-number="6325"></td>
        <td id="LC6325">                    <span>else</span> <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLINT4</span> <span>||</span> <span>denormalizedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6326" data-line-number="6326"></td>
        <td id="LC6326">                        <span>value</span>.<span>Int32</span> <span>=</span> (<span>Int32</span>)<span>longValue</span>;</td>
      </tr>
      <tr>
        <td id="L6327" data-line-number="6327"></td>
        <td id="LC6327">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6328" data-line-number="6328"></td>
        <td id="LC6328">                        <span>value</span>.<span>Int64</span> <span>=</span> <span>longValue</span>;</td>
      </tr>
      <tr>
        <td id="L6329" data-line-number="6329"></td>
        <td id="LC6329">
</td>
      </tr>
      <tr>
        <td id="L6330" data-line-number="6330"></td>
        <td id="LC6330">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6331" data-line-number="6331"></td>
        <td id="LC6331">
</td>
      </tr>
      <tr>
        <td id="L6332" data-line-number="6332"></td>
        <td id="LC6332">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLTN</span>:</td>
      </tr>
      <tr>
        <td id="L6333" data-line-number="6333"></td>
        <td id="LC6333">                    <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6334" data-line-number="6334"></td>
        <td id="LC6334">                    {</td>
      </tr>
      <tr>
        <td id="L6335" data-line-number="6335"></td>
        <td id="LC6335">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLFLT4</span>;</td>
      </tr>
      <tr>
        <td id="L6336" data-line-number="6336"></td>
        <td id="LC6336">                    }</td>
      </tr>
      <tr>
        <td id="L6337" data-line-number="6337"></td>
        <td id="LC6337">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6338" data-line-number="6338"></td>
        <td id="LC6338">                    {</td>
      </tr>
      <tr>
        <td id="L6339" data-line-number="6339"></td>
        <td id="LC6339">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLFLT8</span>;</td>
      </tr>
      <tr>
        <td id="L6340" data-line-number="6340"></td>
        <td id="LC6340">                    }</td>
      </tr>
      <tr>
        <td id="L6341" data-line-number="6341"></td>
        <td id="LC6341">
</td>
      </tr>
      <tr>
        <td id="L6342" data-line-number="6342"></td>
        <td id="LC6342">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT4</span>:</td>
      </tr>
      <tr>
        <td id="L6343" data-line-number="6343"></td>
        <td id="LC6343">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>4</span>, <span><span>"</span>invalid length for SqlSingle type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6344" data-line-number="6344"></td>
        <td id="LC6344">                    <span>float</span> <span>singleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6345" data-line-number="6345"></td>
        <td id="LC6345">                    <span>if</span> (<span>unencryptedBytes</span>.<span>Length</span> <span>!=</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6346" data-line-number="6346"></td>
        <td id="LC6346">                    {</td>
      </tr>
      <tr>
        <td id="L6347" data-line-number="6347"></td>
        <td id="LC6347">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6348" data-line-number="6348"></td>
        <td id="LC6348">                    }</td>
      </tr>
      <tr>
        <td id="L6349" data-line-number="6349"></td>
        <td id="LC6349">
</td>
      </tr>
      <tr>
        <td id="L6350" data-line-number="6350"></td>
        <td id="LC6350">                    <span>singleValue</span> <span>=</span> <span>BitConverter</span>.<span>ToSingle</span>(<span>unencryptedBytes</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L6351" data-line-number="6351"></td>
        <td id="LC6351">                    <span>value</span>.<span>Single</span> <span>=</span> <span>singleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6352" data-line-number="6352"></td>
        <td id="LC6352">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6353" data-line-number="6353"></td>
        <td id="LC6353">
</td>
      </tr>
      <tr>
        <td id="L6354" data-line-number="6354"></td>
        <td id="LC6354">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT8</span>:</td>
      </tr>
      <tr>
        <td id="L6355" data-line-number="6355"></td>
        <td id="LC6355">                    <span>double</span> <span>doubleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6356" data-line-number="6356"></td>
        <td id="LC6356">                    <span>if</span> (<span>unencryptedBytes</span>.<span>Length</span> <span>!=</span> <span>8</span>)</td>
      </tr>
      <tr>
        <td id="L6357" data-line-number="6357"></td>
        <td id="LC6357">                    {</td>
      </tr>
      <tr>
        <td id="L6358" data-line-number="6358"></td>
        <td id="LC6358">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6359" data-line-number="6359"></td>
        <td id="LC6359">                    }</td>
      </tr>
      <tr>
        <td id="L6360" data-line-number="6360"></td>
        <td id="LC6360">
</td>
      </tr>
      <tr>
        <td id="L6361" data-line-number="6361"></td>
        <td id="LC6361">                    <span>doubleValue</span> <span>=</span> <span>BitConverter</span>.<span>ToDouble</span>(<span>unencryptedBytes</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L6362" data-line-number="6362"></td>
        <td id="LC6362">                    <span>value</span>.<span>Double</span> <span>=</span> <span>doubleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6363" data-line-number="6363"></td>
        <td id="LC6363">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6364" data-line-number="6364"></td>
        <td id="LC6364">
</td>
      </tr>
      <tr>
        <td id="L6365" data-line-number="6365"></td>
        <td id="LC6365">                <span><span>//</span> We normalize to allow conversion across data types. SMALLMONEY is serialized into a MONEY.</span></td>
      </tr>
      <tr>
        <td id="L6366" data-line-number="6366"></td>
        <td id="LC6366">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEYN</span>:</td>
      </tr>
      <tr>
        <td id="L6367" data-line-number="6367"></td>
        <td id="LC6367">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY4</span>:</td>
      </tr>
      <tr>
        <td id="L6368" data-line-number="6368"></td>
        <td id="LC6368">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY</span>:</td>
      </tr>
      <tr>
        <td id="L6369" data-line-number="6369"></td>
        <td id="LC6369">                    {</td>
      </tr>
      <tr>
        <td id="L6370" data-line-number="6370"></td>
        <td id="LC6370">                        <span>int</span> <span>mid</span>;</td>
      </tr>
      <tr>
        <td id="L6371" data-line-number="6371"></td>
        <td id="LC6371">                        <span>uint</span> <span>lo</span>;</td>
      </tr>
      <tr>
        <td id="L6372" data-line-number="6372"></td>
        <td id="LC6372">
</td>
      </tr>
      <tr>
        <td id="L6373" data-line-number="6373"></td>
        <td id="LC6373">                        <span>if</span> (<span>unencryptedBytes</span>.<span>Length</span> <span>!=</span> <span>8</span>)</td>
      </tr>
      <tr>
        <td id="L6374" data-line-number="6374"></td>
        <td id="LC6374">                        {</td>
      </tr>
      <tr>
        <td id="L6375" data-line-number="6375"></td>
        <td id="LC6375">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6376" data-line-number="6376"></td>
        <td id="LC6376">                        }</td>
      </tr>
      <tr>
        <td id="L6377" data-line-number="6377"></td>
        <td id="LC6377">
</td>
      </tr>
      <tr>
        <td id="L6378" data-line-number="6378"></td>
        <td id="LC6378">                        <span>mid</span> <span>=</span> <span>BitConverter</span>.<span>ToInt32</span>(<span>unencryptedBytes</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L6379" data-line-number="6379"></td>
        <td id="LC6379">                        <span>lo</span> <span>=</span> <span>BitConverter</span>.<span>ToUInt32</span>(<span>unencryptedBytes</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L6380" data-line-number="6380"></td>
        <td id="LC6380">
</td>
      </tr>
      <tr>
        <td id="L6381" data-line-number="6381"></td>
        <td id="LC6381">                        <span>long</span> <span>l</span> <span>=</span> (((<span>long</span>)<span>mid</span>) <span>&lt;&lt;</span> <span>0x20</span>) <span>+</span> ((<span>long</span>)<span>lo</span>);</td>
      </tr>
      <tr>
        <td id="L6382" data-line-number="6382"></td>
        <td id="LC6382">                        <span>value</span>.<span>SetToMoney</span>(<span>l</span>);</td>
      </tr>
      <tr>
        <td id="L6383" data-line-number="6383"></td>
        <td id="LC6383">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6384" data-line-number="6384"></td>
        <td id="LC6384">                    }</td>
      </tr>
      <tr>
        <td id="L6385" data-line-number="6385"></td>
        <td id="LC6385">
</td>
      </tr>
      <tr>
        <td id="L6386" data-line-number="6386"></td>
        <td id="LC6386">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMN</span>:</td>
      </tr>
      <tr>
        <td id="L6387" data-line-number="6387"></td>
        <td id="LC6387">                    <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6388" data-line-number="6388"></td>
        <td id="LC6388">                    {</td>
      </tr>
      <tr>
        <td id="L6389" data-line-number="6389"></td>
        <td id="LC6389">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIM4</span>;</td>
      </tr>
      <tr>
        <td id="L6390" data-line-number="6390"></td>
        <td id="LC6390">                    }</td>
      </tr>
      <tr>
        <td id="L6391" data-line-number="6391"></td>
        <td id="LC6391">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6392" data-line-number="6392"></td>
        <td id="LC6392">                    {</td>
      </tr>
      <tr>
        <td id="L6393" data-line-number="6393"></td>
        <td id="LC6393">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME</span>;</td>
      </tr>
      <tr>
        <td id="L6394" data-line-number="6394"></td>
        <td id="LC6394">                    }</td>
      </tr>
      <tr>
        <td id="L6395" data-line-number="6395"></td>
        <td id="LC6395">
</td>
      </tr>
      <tr>
        <td id="L6396" data-line-number="6396"></td>
        <td id="LC6396">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIM4</span>:</td>
      </tr>
      <tr>
        <td id="L6397" data-line-number="6397"></td>
        <td id="LC6397">                    <span>ushort</span> <span>daypartShort</span>, <span>timepartShort</span>;</td>
      </tr>
      <tr>
        <td id="L6398" data-line-number="6398"></td>
        <td id="LC6398">                    <span>if</span> (<span>unencryptedBytes</span>.<span>Length</span> <span>!=</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6399" data-line-number="6399"></td>
        <td id="LC6399">                    {</td>
      </tr>
      <tr>
        <td id="L6400" data-line-number="6400"></td>
        <td id="LC6400">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6401" data-line-number="6401"></td>
        <td id="LC6401">                    }</td>
      </tr>
      <tr>
        <td id="L6402" data-line-number="6402"></td>
        <td id="LC6402">
</td>
      </tr>
      <tr>
        <td id="L6403" data-line-number="6403"></td>
        <td id="LC6403">                    <span>daypartShort</span> <span>=</span> (<span>UInt16</span>)((<span>unencryptedBytes</span>[<span>1</span>] <span>&lt;&lt;</span> <span>8</span>) <span>+</span> <span>unencryptedBytes</span>[<span>0</span>]);</td>
      </tr>
      <tr>
        <td id="L6404" data-line-number="6404"></td>
        <td id="LC6404">                    <span>timepartShort</span> <span>=</span> (<span>UInt16</span>)((<span>unencryptedBytes</span>[<span>3</span>] <span>&lt;&lt;</span> <span>8</span>) <span>+</span> <span>unencryptedBytes</span>[<span>2</span>]);</td>
      </tr>
      <tr>
        <td id="L6405" data-line-number="6405"></td>
        <td id="LC6405">                    <span>value</span>.<span>SetToDateTime</span>(<span>daypartShort</span>, <span>timepartShort</span> <span>*</span> <span>SqlDateTime</span>.<span>SQLTicksPerMinute</span>);</td>
      </tr>
      <tr>
        <td id="L6406" data-line-number="6406"></td>
        <td id="LC6406">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6407" data-line-number="6407"></td>
        <td id="LC6407">
</td>
      </tr>
      <tr>
        <td id="L6408" data-line-number="6408"></td>
        <td id="LC6408">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME</span>:</td>
      </tr>
      <tr>
        <td id="L6409" data-line-number="6409"></td>
        <td id="LC6409">                    <span>int</span> <span>daypart</span>;</td>
      </tr>
      <tr>
        <td id="L6410" data-line-number="6410"></td>
        <td id="LC6410">                    <span>uint</span> <span>timepart</span>;</td>
      </tr>
      <tr>
        <td id="L6411" data-line-number="6411"></td>
        <td id="LC6411">                    <span>if</span> (<span>unencryptedBytes</span>.<span>Length</span> <span>!=</span> <span>8</span>)</td>
      </tr>
      <tr>
        <td id="L6412" data-line-number="6412"></td>
        <td id="LC6412">                    {</td>
      </tr>
      <tr>
        <td id="L6413" data-line-number="6413"></td>
        <td id="LC6413">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6414" data-line-number="6414"></td>
        <td id="LC6414">                    }</td>
      </tr>
      <tr>
        <td id="L6415" data-line-number="6415"></td>
        <td id="LC6415">
</td>
      </tr>
      <tr>
        <td id="L6416" data-line-number="6416"></td>
        <td id="LC6416">                    <span>daypart</span> <span>=</span> <span>BitConverter</span>.<span>ToInt32</span>(<span>unencryptedBytes</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L6417" data-line-number="6417"></td>
        <td id="LC6417">                    <span>timepart</span> <span>=</span> <span>BitConverter</span>.<span>ToUInt32</span>(<span>unencryptedBytes</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L6418" data-line-number="6418"></td>
        <td id="LC6418">                    <span>value</span>.<span>SetToDateTime</span>(<span>daypart</span>, (<span>int</span>)<span>timepart</span>);</td>
      </tr>
      <tr>
        <td id="L6419" data-line-number="6419"></td>
        <td id="LC6419">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6420" data-line-number="6420"></td>
        <td id="LC6420">
</td>
      </tr>
      <tr>
        <td id="L6421" data-line-number="6421"></td>
        <td id="LC6421">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L6422" data-line-number="6422"></td>
        <td id="LC6422">                    {</td>
      </tr>
      <tr>
        <td id="L6423" data-line-number="6423"></td>
        <td id="LC6423">                        <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>16</span>, <span><span>"</span>invalid length for SqlGuid type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6424" data-line-number="6424"></td>
        <td id="LC6424">                        <span>value</span>.<span>SqlGuid</span> <span>=</span> <span>SqlTypeWorkarounds</span>.<span>SqlGuidCtor</span>(<span>unencryptedBytes</span>, <span>true</span>);   <span><span>//</span> doesn't copy the byte array</span></td>
      </tr>
      <tr>
        <td id="L6425" data-line-number="6425"></td>
        <td id="LC6425">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6426" data-line-number="6426"></td>
        <td id="LC6426">                    }</td>
      </tr>
      <tr>
        <td id="L6427" data-line-number="6427"></td>
        <td id="LC6427">
</td>
      </tr>
      <tr>
        <td id="L6428" data-line-number="6428"></td>
        <td id="LC6428">                <span>case</span> <span>TdsEnums</span>.<span>SQLBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6429" data-line-number="6429"></td>
        <td id="LC6429">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6430" data-line-number="6430"></td>
        <td id="LC6430">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6431" data-line-number="6431"></td>
        <td id="LC6431">                <span>case</span> <span>TdsEnums</span>.<span>SQLVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6432" data-line-number="6432"></td>
        <td id="LC6432">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L6433" data-line-number="6433"></td>
        <td id="LC6433">                    {</td>
      </tr>
      <tr>
        <td id="L6434" data-line-number="6434"></td>
        <td id="LC6434">                        <span><span>//</span> Note: Better not come here with plp data!!</span></td>
      </tr>
      <tr>
        <td id="L6435" data-line-number="6435"></td>
        <td id="LC6435">                        <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>&lt;=</span> <span>TdsEnums</span>.<span>MAXSIZE</span>, <span><span>"</span>Plp data decryption attempted<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6436" data-line-number="6436"></td>
        <td id="LC6436">
</td>
      </tr>
      <tr>
        <td id="L6437" data-line-number="6437"></td>
        <td id="LC6437">                        <span><span>//</span> If this is a fixed length type, pad with zeros to get to the fixed length size.</span></td>
      </tr>
      <tr>
        <td id="L6438" data-line-number="6438"></td>
        <td id="LC6438">                        <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBINARY</span> <span>||</span> <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>)</td>
      </tr>
      <tr>
        <td id="L6439" data-line-number="6439"></td>
        <td id="LC6439">                        {</td>
      </tr>
      <tr>
        <td id="L6440" data-line-number="6440"></td>
        <td id="LC6440">                            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>md</span>.<span>baseTI</span>.<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L6441" data-line-number="6441"></td>
        <td id="LC6441">                            <span>Buffer</span>.<span>BlockCopy</span>(<span>unencryptedBytes</span>, <span>0</span>, <span>bytes</span>, <span>0</span>, <span>unencryptedBytes</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L6442" data-line-number="6442"></td>
        <td id="LC6442">                            <span>unencryptedBytes</span> <span>=</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L6443" data-line-number="6443"></td>
        <td id="LC6443">                        }</td>
      </tr>
      <tr>
        <td id="L6444" data-line-number="6444"></td>
        <td id="LC6444">
</td>
      </tr>
      <tr>
        <td id="L6445" data-line-number="6445"></td>
        <td id="LC6445">                        <span>value</span>.<span>SqlBinary</span> <span>=</span> <span>SqlTypeWorkarounds</span>.<span>SqlBinaryCtor</span>(<span>unencryptedBytes</span>, <span>true</span>);   <span><span>//</span> doesn't copy the byte array</span></td>
      </tr>
      <tr>
        <td id="L6446" data-line-number="6446"></td>
        <td id="LC6446">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6447" data-line-number="6447"></td>
        <td id="LC6447">                    }</td>
      </tr>
      <tr>
        <td id="L6448" data-line-number="6448"></td>
        <td id="LC6448">
</td>
      </tr>
      <tr>
        <td id="L6449" data-line-number="6449"></td>
        <td id="LC6449">                <span>case</span> <span>TdsEnums</span>.<span>SQLDECIMALN</span>:</td>
      </tr>
      <tr>
        <td id="L6450" data-line-number="6450"></td>
        <td id="LC6450">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L6451" data-line-number="6451"></td>
        <td id="LC6451">                    <span><span>//</span> Check the sign from the first byte.</span></td>
      </tr>
      <tr>
        <td id="L6452" data-line-number="6452"></td>
        <td id="LC6452">                    <span>int</span> <span>index</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L6453" data-line-number="6453"></td>
        <td id="LC6453">                    <span>byteValue</span> <span>=</span> <span>unencryptedBytes</span>[<span>index</span><span>++</span>];</td>
      </tr>
      <tr>
        <td id="L6454" data-line-number="6454"></td>
        <td id="LC6454">                    <span>bool</span> <span>fPositive</span> <span>=</span> (<span>1</span> <span>==</span> <span>byteValue</span>);</td>
      </tr>
      <tr>
        <td id="L6455" data-line-number="6455"></td>
        <td id="LC6455">
</td>
      </tr>
      <tr>
        <td id="L6456" data-line-number="6456"></td>
        <td id="LC6456">                    <span><span>//</span> Now read the 4 next integers which contain the actual value.</span></td>
      </tr>
      <tr>
        <td id="L6457" data-line-number="6457"></td>
        <td id="LC6457">                    <span>length</span> <span>=</span> <span>checked</span>((<span>int</span>)<span>length</span> <span>-</span> <span>1</span>);</td>
      </tr>
      <tr>
        <td id="L6458" data-line-number="6458"></td>
        <td id="LC6458">                    <span>int</span>[] <span>bits</span> <span>=</span> <span>new</span> <span>int</span>[<span>4</span>];</td>
      </tr>
      <tr>
        <td id="L6459" data-line-number="6459"></td>
        <td id="LC6459">                    <span>int</span> <span>decLength</span> <span>=</span> <span>length</span> <span>&gt;&gt;</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L6460" data-line-number="6460"></td>
        <td id="LC6460">                    <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>decLength</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L6461" data-line-number="6461"></td>
        <td id="LC6461">                    {</td>
      </tr>
      <tr>
        <td id="L6462" data-line-number="6462"></td>
        <td id="LC6462">                        <span><span>//</span> up to 16 bytes of data following the sign byte</span></td>
      </tr>
      <tr>
        <td id="L6463" data-line-number="6463"></td>
        <td id="LC6463">                        <span>bits</span>[<span>i</span>] <span>=</span> <span>BitConverter</span>.<span>ToInt32</span>(<span>unencryptedBytes</span>, <span>index</span>);</td>
      </tr>
      <tr>
        <td id="L6464" data-line-number="6464"></td>
        <td id="LC6464">                        <span>index</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L6465" data-line-number="6465"></td>
        <td id="LC6465">                    }</td>
      </tr>
      <tr>
        <td id="L6466" data-line-number="6466"></td>
        <td id="LC6466">                    <span>value</span>.<span>SetToDecimal</span>(<span>md</span>.<span>baseTI</span>.<span>precision</span>, <span>md</span>.<span>baseTI</span>.<span>scale</span>, <span>fPositive</span>, <span>bits</span>);</td>
      </tr>
      <tr>
        <td id="L6467" data-line-number="6467"></td>
        <td id="LC6467">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6468" data-line-number="6468"></td>
        <td id="LC6468">
</td>
      </tr>
      <tr>
        <td id="L6469" data-line-number="6469"></td>
        <td id="LC6469">                <span>case</span> <span>TdsEnums</span>.<span>SQLCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6470" data-line-number="6470"></td>
        <td id="LC6470">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6471" data-line-number="6471"></td>
        <td id="LC6471">                <span>case</span> <span>TdsEnums</span>.<span>SQLVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6472" data-line-number="6472"></td>
        <td id="LC6472">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6473" data-line-number="6473"></td>
        <td id="LC6473">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L6474" data-line-number="6474"></td>
        <td id="LC6474">                    {</td>
      </tr>
      <tr>
        <td id="L6475" data-line-number="6475"></td>
        <td id="LC6475">                        <span>System</span>.<span>Text</span>.<span>Encoding</span> <span>encoding</span> <span>=</span> <span>md</span>.<span>baseTI</span>.<span>encoding</span>;</td>
      </tr>
      <tr>
        <td id="L6476" data-line-number="6476"></td>
        <td id="LC6476">
</td>
      </tr>
      <tr>
        <td id="L6477" data-line-number="6477"></td>
        <td id="LC6477">                        <span>if</span> (<span>null</span> <span>==</span> <span>encoding</span>)</td>
      </tr>
      <tr>
        <td id="L6478" data-line-number="6478"></td>
        <td id="LC6478">                        {</td>
      </tr>
      <tr>
        <td id="L6479" data-line-number="6479"></td>
        <td id="LC6479">                            <span>encoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L6480" data-line-number="6480"></td>
        <td id="LC6480">                        }</td>
      </tr>
      <tr>
        <td id="L6481" data-line-number="6481"></td>
        <td id="LC6481">
</td>
      </tr>
      <tr>
        <td id="L6482" data-line-number="6482"></td>
        <td id="LC6482">                        <span>if</span> (<span>null</span> <span>==</span> <span>encoding</span>)</td>
      </tr>
      <tr>
        <td id="L6483" data-line-number="6483"></td>
        <td id="LC6483">                        {</td>
      </tr>
      <tr>
        <td id="L6484" data-line-number="6484"></td>
        <td id="LC6484">                            <span>ThrowUnsupportedCollationEncountered</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L6485" data-line-number="6485"></td>
        <td id="LC6485">                        }</td>
      </tr>
      <tr>
        <td id="L6486" data-line-number="6486"></td>
        <td id="LC6486">
</td>
      </tr>
      <tr>
        <td id="L6487" data-line-number="6487"></td>
        <td id="LC6487">                        <span>string</span> <span>strValue</span> <span>=</span> <span>encoding</span>.<span>GetString</span>(<span>unencryptedBytes</span>, <span>0</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L6488" data-line-number="6488"></td>
        <td id="LC6488">
</td>
      </tr>
      <tr>
        <td id="L6489" data-line-number="6489"></td>
        <td id="LC6489">                        <span><span>//</span> If this is a fixed length type, pad with spaces to get to the fixed length size.</span></td>
      </tr>
      <tr>
        <td id="L6490" data-line-number="6490"></td>
        <td id="LC6490">                        <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLCHAR</span> <span>||</span> <span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>)</td>
      </tr>
      <tr>
        <td id="L6491" data-line-number="6491"></td>
        <td id="LC6491">                        {</td>
      </tr>
      <tr>
        <td id="L6492" data-line-number="6492"></td>
        <td id="LC6492">                            <span>strValue</span> <span>=</span> <span>strValue</span>.<span>PadRight</span>(<span>md</span>.<span>baseTI</span>.<span>length</span>);</td>
      </tr>
      <tr>
        <td id="L6493" data-line-number="6493"></td>
        <td id="LC6493">                        }</td>
      </tr>
      <tr>
        <td id="L6494" data-line-number="6494"></td>
        <td id="LC6494">
</td>
      </tr>
      <tr>
        <td id="L6495" data-line-number="6495"></td>
        <td id="LC6495">                        <span>value</span>.<span>SetToString</span>(<span>strValue</span>);</td>
      </tr>
      <tr>
        <td id="L6496" data-line-number="6496"></td>
        <td id="LC6496">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6497" data-line-number="6497"></td>
        <td id="LC6497">                    }</td>
      </tr>
      <tr>
        <td id="L6498" data-line-number="6498"></td>
        <td id="LC6498">
</td>
      </tr>
      <tr>
        <td id="L6499" data-line-number="6499"></td>
        <td id="LC6499">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6500" data-line-number="6500"></td>
        <td id="LC6500">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6501" data-line-number="6501"></td>
        <td id="LC6501">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L6502" data-line-number="6502"></td>
        <td id="LC6502">                    {</td>
      </tr>
      <tr>
        <td id="L6503" data-line-number="6503"></td>
        <td id="LC6503">                        <span>string</span> <span>strValue</span> <span>=</span> <span>System</span>.<span>Text</span>.<span>Encoding</span>.<span>Unicode</span>.<span>GetString</span>(<span>unencryptedBytes</span>, <span>0</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L6504" data-line-number="6504"></td>
        <td id="LC6504">
</td>
      </tr>
      <tr>
        <td id="L6505" data-line-number="6505"></td>
        <td id="LC6505">                        <span><span>//</span> If this is a fixed length type, pad with spaces to get to the fixed length size.</span></td>
      </tr>
      <tr>
        <td id="L6506" data-line-number="6506"></td>
        <td id="LC6506">                        <span>if</span> (<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>)</td>
      </tr>
      <tr>
        <td id="L6507" data-line-number="6507"></td>
        <td id="LC6507">                        {</td>
      </tr>
      <tr>
        <td id="L6508" data-line-number="6508"></td>
        <td id="LC6508">                            <span>strValue</span> <span>=</span> <span>strValue</span>.<span>PadRight</span>(<span>md</span>.<span>baseTI</span>.<span>length</span> <span>/</span> <span>ADP</span>.<span>CharSize</span>);</td>
      </tr>
      <tr>
        <td id="L6509" data-line-number="6509"></td>
        <td id="LC6509">                        }</td>
      </tr>
      <tr>
        <td id="L6510" data-line-number="6510"></td>
        <td id="LC6510">
</td>
      </tr>
      <tr>
        <td id="L6511" data-line-number="6511"></td>
        <td id="LC6511">                        <span>value</span>.<span>SetToString</span>(<span>strValue</span>);</td>
      </tr>
      <tr>
        <td id="L6512" data-line-number="6512"></td>
        <td id="LC6512">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6513" data-line-number="6513"></td>
        <td id="LC6513">                    }</td>
      </tr>
      <tr>
        <td id="L6514" data-line-number="6514"></td>
        <td id="LC6514">
</td>
      </tr>
      <tr>
        <td id="L6515" data-line-number="6515"></td>
        <td id="LC6515">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATE</span>:</td>
      </tr>
      <tr>
        <td id="L6516" data-line-number="6516"></td>
        <td id="LC6516">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>3</span>, <span><span>"</span>invalid length for date type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6517" data-line-number="6517"></td>
        <td id="LC6517">                    <span>value</span>.<span>SetToDate</span>(<span>unencryptedBytes</span>);</td>
      </tr>
      <tr>
        <td id="L6518" data-line-number="6518"></td>
        <td id="LC6518">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6519" data-line-number="6519"></td>
        <td id="LC6519">
</td>
      </tr>
      <tr>
        <td id="L6520" data-line-number="6520"></td>
        <td id="LC6520">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L6521" data-line-number="6521"></td>
        <td id="LC6521">                    <span><span>//</span> We normalize to maximum precision to allow conversion across different precisions.</span></td>
      </tr>
      <tr>
        <td id="L6522" data-line-number="6522"></td>
        <td id="LC6522">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>5</span>, <span><span>"</span>invalid length for time type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6523" data-line-number="6523"></td>
        <td id="LC6523">                    <span>value</span>.<span>SetToTime</span>(<span>unencryptedBytes</span>, <span>length</span>, <span>TdsEnums</span>.<span>MAX_TIME_SCALE</span>, <span>denormalizedScale</span>);</td>
      </tr>
      <tr>
        <td id="L6524" data-line-number="6524"></td>
        <td id="LC6524">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6525" data-line-number="6525"></td>
        <td id="LC6525">
</td>
      </tr>
      <tr>
        <td id="L6526" data-line-number="6526"></td>
        <td id="LC6526">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME2</span>:</td>
      </tr>
      <tr>
        <td id="L6527" data-line-number="6527"></td>
        <td id="LC6527">                    <span><span>//</span> We normalize to maximum precision to allow conversion across different precisions.</span></td>
      </tr>
      <tr>
        <td id="L6528" data-line-number="6528"></td>
        <td id="LC6528">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for datetime2 type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6529" data-line-number="6529"></td>
        <td id="LC6529">                    <span>value</span>.<span>SetToDateTime2</span>(<span>unencryptedBytes</span>, <span>length</span>, <span>TdsEnums</span>.<span>MAX_TIME_SCALE</span>, <span>denormalizedScale</span>);</td>
      </tr>
      <tr>
        <td id="L6530" data-line-number="6530"></td>
        <td id="LC6530">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6531" data-line-number="6531"></td>
        <td id="LC6531">
</td>
      </tr>
      <tr>
        <td id="L6532" data-line-number="6532"></td>
        <td id="LC6532">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L6533" data-line-number="6533"></td>
        <td id="LC6533">                    <span><span>//</span> We normalize to maximum precision to allow conversion across different precisions.</span></td>
      </tr>
      <tr>
        <td id="L6534" data-line-number="6534"></td>
        <td id="LC6534">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>10</span>, <span><span>"</span>invalid length for datetimeoffset type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6535" data-line-number="6535"></td>
        <td id="LC6535">                    <span>value</span>.<span>SetToDateTimeOffset</span>(<span>unencryptedBytes</span>, <span>length</span>, <span>TdsEnums</span>.<span>MAX_TIME_SCALE</span>, <span>denormalizedScale</span>);</td>
      </tr>
      <tr>
        <td id="L6536" data-line-number="6536"></td>
        <td id="LC6536">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6537" data-line-number="6537"></td>
        <td id="LC6537">
</td>
      </tr>
      <tr>
        <td id="L6538" data-line-number="6538"></td>
        <td id="LC6538">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L6539" data-line-number="6539"></td>
        <td id="LC6539">                    <span>MetaType</span> <span>metaType</span> <span>=</span> <span>md</span>.<span>baseTI</span>.<span>metaType</span>;</td>
      </tr>
      <tr>
        <td id="L6540" data-line-number="6540"></td>
        <td id="LC6540">
</td>
      </tr>
      <tr>
        <td id="L6541" data-line-number="6541"></td>
        <td id="LC6541">                    <span><span>//</span> If we don't have a metatype already, construct one to get the proper type name.</span></td>
      </tr>
      <tr>
        <td id="L6542" data-line-number="6542"></td>
        <td id="LC6542">                    <span>if</span> (<span>metaType</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L6543" data-line-number="6543"></td>
        <td id="LC6543">                    {</td>
      </tr>
      <tr>
        <td id="L6544" data-line-number="6544"></td>
        <td id="LC6544">                        <span>metaType</span> <span>=</span> <span>MetaType</span>.<span>GetSqlDataType</span>(<span>tdsType</span>, <span>userType</span>: <span>0</span>, <span>length</span>: <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L6545" data-line-number="6545"></td>
        <td id="LC6545">                    }</td>
      </tr>
      <tr>
        <td id="L6546" data-line-number="6546"></td>
        <td id="LC6546">
</td>
      </tr>
      <tr>
        <td id="L6547" data-line-number="6547"></td>
        <td id="LC6547">                    <span>throw</span> <span>SQL</span>.<span>UnsupportedDatatypeEncryption</span>(<span>metaType</span>.<span>TypeName</span>);</td>
      </tr>
      <tr>
        <td id="L6548" data-line-number="6548"></td>
        <td id="LC6548">            }</td>
      </tr>
      <tr>
        <td id="L6549" data-line-number="6549"></td>
        <td id="LC6549">
</td>
      </tr>
      <tr>
        <td id="L6550" data-line-number="6550"></td>
        <td id="LC6550">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6551" data-line-number="6551"></td>
        <td id="LC6551">        }</td>
      </tr>
      <tr>
        <td id="L6552" data-line-number="6552"></td>
        <td id="LC6552">
</td>
      </tr>
      <tr>
        <td id="L6553" data-line-number="6553"></td>
        <td id="LC6553">        <span>internal</span> <span>bool</span> <span>TryReadSqlValue</span>(<span>SqlBuffer</span> <span>value</span>,</td>
      </tr>
      <tr>
        <td id="L6554" data-line-number="6554"></td>
        <td id="LC6554">                                      <span>SqlMetaDataPriv</span> <span>md</span>,</td>
      </tr>
      <tr>
        <td id="L6555" data-line-number="6555"></td>
        <td id="LC6555">                                      <span>int</span> <span>length</span>,</td>
      </tr>
      <tr>
        <td id="L6556" data-line-number="6556"></td>
        <td id="LC6556">                                      <span>TdsParserStateObject</span> <span>stateObj</span>,</td>
      </tr>
      <tr>
        <td id="L6557" data-line-number="6557"></td>
        <td id="LC6557">                                      <span>SqlCommandColumnEncryptionSetting</span> <span>columnEncryptionOverride</span>,</td>
      </tr>
      <tr>
        <td id="L6558" data-line-number="6558"></td>
        <td id="LC6558">                                      <span>string</span> <span>columnName</span>)</td>
      </tr>
      <tr>
        <td id="L6559" data-line-number="6559"></td>
        <td id="LC6559">        {</td>
      </tr>
      <tr>
        <td id="L6560" data-line-number="6560"></td>
        <td id="LC6560">            <span>bool</span> <span>isPlp</span> <span>=</span> <span>md</span>.<span>metaType</span>.<span>IsPlp</span>;</td>
      </tr>
      <tr>
        <td id="L6561" data-line-number="6561"></td>
        <td id="LC6561">            <span>byte</span> <span>tdsType</span> <span>=</span> <span>md</span>.<span>tdsType</span>;</td>
      </tr>
      <tr>
        <td id="L6562" data-line-number="6562"></td>
        <td id="LC6562">
</td>
      </tr>
      <tr>
        <td id="L6563" data-line-number="6563"></td>
        <td id="LC6563">            <span>Debug</span>.<span>Assert</span>(<span>isPlp</span> <span>||</span> <span>!</span><span>IsNull</span>(<span>md</span>.<span>metaType</span>, (<span>ulong</span>)<span>length</span>), <span><span>"</span>null value should not get here!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6564" data-line-number="6564"></td>
        <td id="LC6564">            <span>if</span> (<span>isPlp</span>)</td>
      </tr>
      <tr>
        <td id="L6565" data-line-number="6565"></td>
        <td id="LC6565">            {</td>
      </tr>
      <tr>
        <td id="L6566" data-line-number="6566"></td>
        <td id="LC6566">                <span><span>//</span> We must read the column value completely, no matter what length is passed in</span></td>
      </tr>
      <tr>
        <td id="L6567" data-line-number="6567"></td>
        <td id="LC6567">                <span>length</span> <span>=</span> <span>Int32</span>.<span>MaxValue</span>;</td>
      </tr>
      <tr>
        <td id="L6568" data-line-number="6568"></td>
        <td id="LC6568">            }</td>
      </tr>
      <tr>
        <td id="L6569" data-line-number="6569"></td>
        <td id="LC6569">
</td>
      </tr>
      <tr>
        <td id="L6570" data-line-number="6570"></td>
        <td id="LC6570">            <span><span>//</span>DEVNOTE: When modifying the following routines (for deserialization) please pay attention to</span></td>
      </tr>
      <tr>
        <td id="L6571" data-line-number="6571"></td>
        <td id="LC6571">            <span><span>//</span> deserialization code in DecryptWithKey () method and modify it accordingly.</span></td>
      </tr>
      <tr>
        <td id="L6572" data-line-number="6572"></td>
        <td id="LC6572">            <span>switch</span> (<span>tdsType</span>)</td>
      </tr>
      <tr>
        <td id="L6573" data-line-number="6573"></td>
        <td id="LC6573">            {</td>
      </tr>
      <tr>
        <td id="L6574" data-line-number="6574"></td>
        <td id="LC6574">                <span>case</span> <span>TdsEnums</span>.<span>SQLDECIMALN</span>:</td>
      </tr>
      <tr>
        <td id="L6575" data-line-number="6575"></td>
        <td id="LC6575">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L6576" data-line-number="6576"></td>
        <td id="LC6576">                    <span>if</span> (<span>!</span><span>TryReadSqlDecimal</span>(<span>value</span>, <span>length</span>, <span>md</span>.<span>precision</span>, <span>md</span>.<span>scale</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L6577" data-line-number="6577"></td>
        <td id="LC6577">                    {</td>
      </tr>
      <tr>
        <td id="L6578" data-line-number="6578"></td>
        <td id="LC6578">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6579" data-line-number="6579"></td>
        <td id="LC6579">                    }</td>
      </tr>
      <tr>
        <td id="L6580" data-line-number="6580"></td>
        <td id="LC6580">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6581" data-line-number="6581"></td>
        <td id="LC6581">
</td>
      </tr>
      <tr>
        <td id="L6582" data-line-number="6582"></td>
        <td id="LC6582">                <span>case</span> <span>TdsEnums</span>.<span>SQLUDT</span>:</td>
      </tr>
      <tr>
        <td id="L6583" data-line-number="6583"></td>
        <td id="LC6583">                <span>case</span> <span>TdsEnums</span>.<span>SQLBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6584" data-line-number="6584"></td>
        <td id="LC6584">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6585" data-line-number="6585"></td>
        <td id="LC6585">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6586" data-line-number="6586"></td>
        <td id="LC6586">                <span>case</span> <span>TdsEnums</span>.<span>SQLVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6587" data-line-number="6587"></td>
        <td id="LC6587">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L6588" data-line-number="6588"></td>
        <td id="LC6588">                    <span>byte</span>[] <span>b</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L6589" data-line-number="6589"></td>
        <td id="LC6589">
</td>
      </tr>
      <tr>
        <td id="L6590" data-line-number="6590"></td>
        <td id="LC6590">                    <span><span>//</span> If varbinary(max), we only read the first chunk here, expecting the caller to read the rest</span></td>
      </tr>
      <tr>
        <td id="L6591" data-line-number="6591"></td>
        <td id="LC6591">                    <span>if</span> (<span>isPlp</span>)</td>
      </tr>
      <tr>
        <td id="L6592" data-line-number="6592"></td>
        <td id="LC6592">                    {</td>
      </tr>
      <tr>
        <td id="L6593" data-line-number="6593"></td>
        <td id="LC6593">                        <span><span>//</span> If we are given -1 for length, then we read the entire value,</span></td>
      </tr>
      <tr>
        <td id="L6594" data-line-number="6594"></td>
        <td id="LC6594">                        <span><span>//</span> otherwise only the requested amount, usually first chunk.</span></td>
      </tr>
      <tr>
        <td id="L6595" data-line-number="6595"></td>
        <td id="LC6595">                        <span>int</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L6596" data-line-number="6596"></td>
        <td id="LC6596">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadPlpBytes</span>(<span>ref</span> <span>b</span>, <span>0</span>, <span>length</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L6597" data-line-number="6597"></td>
        <td id="LC6597">                        {</td>
      </tr>
      <tr>
        <td id="L6598" data-line-number="6598"></td>
        <td id="LC6598">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6599" data-line-number="6599"></td>
        <td id="LC6599">                        }</td>
      </tr>
      <tr>
        <td id="L6600" data-line-number="6600"></td>
        <td id="LC6600">                    }</td>
      </tr>
      <tr>
        <td id="L6601" data-line-number="6601"></td>
        <td id="LC6601">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6602" data-line-number="6602"></td>
        <td id="LC6602">                    {</td>
      </tr>
      <tr>
        <td id="L6603" data-line-number="6603"></td>
        <td id="LC6603">                        <span><span>//</span>Debug.Assert(length &gt; 0 &amp;&amp; length &lt; (long)(Int32.MaxValue), "Bad length for column");</span></td>
      </tr>
      <tr>
        <td id="L6604" data-line-number="6604"></td>
        <td id="LC6604">                        <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L6605" data-line-number="6605"></td>
        <td id="LC6605">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>b</span>, <span>0</span>, <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6606" data-line-number="6606"></td>
        <td id="LC6606">                        {</td>
      </tr>
      <tr>
        <td id="L6607" data-line-number="6607"></td>
        <td id="LC6607">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6608" data-line-number="6608"></td>
        <td id="LC6608">                        }</td>
      </tr>
      <tr>
        <td id="L6609" data-line-number="6609"></td>
        <td id="LC6609">                    }</td>
      </tr>
      <tr>
        <td id="L6610" data-line-number="6610"></td>
        <td id="LC6610">
</td>
      </tr>
      <tr>
        <td id="L6611" data-line-number="6611"></td>
        <td id="LC6611">                    <span>if</span> (<span>md</span>.<span>isEncrypted</span></td>
      </tr>
      <tr>
        <td id="L6612" data-line-number="6612"></td>
        <td id="LC6612">                        <span>&amp;&amp;</span> ((<span>columnEncryptionOverride</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>Enabled</span></td>
      </tr>
      <tr>
        <td id="L6613" data-line-number="6613"></td>
        <td id="LC6613">                            <span>||</span> <span>columnEncryptionOverride</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>ResultSetOnly</span>)</td>
      </tr>
      <tr>
        <td id="L6614" data-line-number="6614"></td>
        <td id="LC6614">                            <span>||</span> (<span>columnEncryptionOverride</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>UseConnectionSetting</span></td>
      </tr>
      <tr>
        <td id="L6615" data-line-number="6615"></td>
        <td id="LC6615">                                <span>&amp;&amp;</span> <span>_connHandler</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>_connHandler</span>.<span>ConnectionOptions</span> <span>!=</span> <span>null</span></td>
      </tr>
      <tr>
        <td id="L6616" data-line-number="6616"></td>
        <td id="LC6616">                                <span>&amp;&amp;</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>ColumnEncryptionSetting</span> <span>==</span> <span>SqlConnectionColumnEncryptionSetting</span>.<span>Enabled</span>)))</td>
      </tr>
      <tr>
        <td id="L6617" data-line-number="6617"></td>
        <td id="LC6617">                    {</td>
      </tr>
      <tr>
        <td id="L6618" data-line-number="6618"></td>
        <td id="LC6618">                        <span>try</span></td>
      </tr>
      <tr>
        <td id="L6619" data-line-number="6619"></td>
        <td id="LC6619">                        {</td>
      </tr>
      <tr>
        <td id="L6620" data-line-number="6620"></td>
        <td id="LC6620">                            <span><span>//</span> CipherInfo is present, decrypt and read</span></td>
      </tr>
      <tr>
        <td id="L6621" data-line-number="6621"></td>
        <td id="LC6621">                            <span>byte</span>[] <span>unencryptedBytes</span> <span>=</span> <span>SqlSecurityUtility</span>.<span>DecryptWithKey</span>(<span>b</span>, <span>md</span>.<span>cipherMD</span>, <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>DataSource</span>);</td>
      </tr>
      <tr>
        <td id="L6622" data-line-number="6622"></td>
        <td id="LC6622">
</td>
      </tr>
      <tr>
        <td id="L6623" data-line-number="6623"></td>
        <td id="LC6623">                            <span>if</span> (<span>unencryptedBytes</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L6624" data-line-number="6624"></td>
        <td id="LC6624">                            {</td>
      </tr>
      <tr>
        <td id="L6625" data-line-number="6625"></td>
        <td id="LC6625">                                <span>DeserializeUnencryptedValue</span>(<span>value</span>, <span>unencryptedBytes</span>, <span>md</span>, <span>stateObj</span>, <span>md</span>.<span>NormalizationRuleVersion</span>);</td>
      </tr>
      <tr>
        <td id="L6626" data-line-number="6626"></td>
        <td id="LC6626">                            }</td>
      </tr>
      <tr>
        <td id="L6627" data-line-number="6627"></td>
        <td id="LC6627">                        }</td>
      </tr>
      <tr>
        <td id="L6628" data-line-number="6628"></td>
        <td id="LC6628">                        <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L6629" data-line-number="6629"></td>
        <td id="LC6629">                        {</td>
      </tr>
      <tr>
        <td id="L6630" data-line-number="6630"></td>
        <td id="LC6630">                            <span>throw</span> <span>SQL</span>.<span>ColumnDecryptionFailed</span>(<span>columnName</span>, <span>null</span>, <span>e</span>);</td>
      </tr>
      <tr>
        <td id="L6631" data-line-number="6631"></td>
        <td id="LC6631">                        }</td>
      </tr>
      <tr>
        <td id="L6632" data-line-number="6632"></td>
        <td id="LC6632">                    }</td>
      </tr>
      <tr>
        <td id="L6633" data-line-number="6633"></td>
        <td id="LC6633">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6634" data-line-number="6634"></td>
        <td id="LC6634">                    {</td>
      </tr>
      <tr>
        <td id="L6635" data-line-number="6635"></td>
        <td id="LC6635">                        <span>value</span>.<span>SqlBinary</span> <span>=</span> <span>SqlTypeWorkarounds</span>.<span>SqlBinaryCtor</span>(<span>b</span>, <span>true</span>);   <span><span>//</span> doesn't copy the byte array</span></td>
      </tr>
      <tr>
        <td id="L6636" data-line-number="6636"></td>
        <td id="LC6636">                    }</td>
      </tr>
      <tr>
        <td id="L6637" data-line-number="6637"></td>
        <td id="LC6637">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6638" data-line-number="6638"></td>
        <td id="LC6638">
</td>
      </tr>
      <tr>
        <td id="L6639" data-line-number="6639"></td>
        <td id="LC6639">                <span>case</span> <span>TdsEnums</span>.<span>SQLCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6640" data-line-number="6640"></td>
        <td id="LC6640">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6641" data-line-number="6641"></td>
        <td id="LC6641">                <span>case</span> <span>TdsEnums</span>.<span>SQLVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6642" data-line-number="6642"></td>
        <td id="LC6642">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6643" data-line-number="6643"></td>
        <td id="LC6643">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L6644" data-line-number="6644"></td>
        <td id="LC6644">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6645" data-line-number="6645"></td>
        <td id="LC6645">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L6646" data-line-number="6646"></td>
        <td id="LC6646">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L6647" data-line-number="6647"></td>
        <td id="LC6647">                    <span>if</span> (<span>!</span><span>TryReadSqlStringValue</span>(<span>value</span>, <span>tdsType</span>, <span>length</span>, <span>md</span>.<span>encoding</span>, <span>isPlp</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L6648" data-line-number="6648"></td>
        <td id="LC6648">                    {</td>
      </tr>
      <tr>
        <td id="L6649" data-line-number="6649"></td>
        <td id="LC6649">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6650" data-line-number="6650"></td>
        <td id="LC6650">                    }</td>
      </tr>
      <tr>
        <td id="L6651" data-line-number="6651"></td>
        <td id="LC6651">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6652" data-line-number="6652"></td>
        <td id="LC6652">
</td>
      </tr>
      <tr>
        <td id="L6653" data-line-number="6653"></td>
        <td id="LC6653">                <span>case</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>:</td>
      </tr>
      <tr>
        <td id="L6654" data-line-number="6654"></td>
        <td id="LC6654">                    <span><span>//</span> We store SqlCachedBuffer here, so that we can return either SqlBinary, SqlString or SqlXmlReader.</span></td>
      </tr>
      <tr>
        <td id="L6655" data-line-number="6655"></td>
        <td id="LC6655">                    <span>SqlCachedBuffer</span> <span>sqlBuf</span>;</td>
      </tr>
      <tr>
        <td id="L6656" data-line-number="6656"></td>
        <td id="LC6656">                    <span>if</span> (<span>!</span><span>SqlCachedBuffer</span>.<span>TryCreate</span>(<span>md</span>, <span>this</span>, <span>stateObj</span>, <span>out</span> <span>sqlBuf</span>))</td>
      </tr>
      <tr>
        <td id="L6657" data-line-number="6657"></td>
        <td id="LC6657">                    {</td>
      </tr>
      <tr>
        <td id="L6658" data-line-number="6658"></td>
        <td id="LC6658">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6659" data-line-number="6659"></td>
        <td id="LC6659">                    }</td>
      </tr>
      <tr>
        <td id="L6660" data-line-number="6660"></td>
        <td id="LC6660">
</td>
      </tr>
      <tr>
        <td id="L6661" data-line-number="6661"></td>
        <td id="LC6661">                    <span>value</span>.<span>SqlCachedBuffer</span> <span>=</span> <span>sqlBuf</span>;</td>
      </tr>
      <tr>
        <td id="L6662" data-line-number="6662"></td>
        <td id="LC6662">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6663" data-line-number="6663"></td>
        <td id="LC6663">
</td>
      </tr>
      <tr>
        <td id="L6664" data-line-number="6664"></td>
        <td id="LC6664">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATE</span>:</td>
      </tr>
      <tr>
        <td id="L6665" data-line-number="6665"></td>
        <td id="LC6665">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L6666" data-line-number="6666"></td>
        <td id="LC6666">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME2</span>:</td>
      </tr>
      <tr>
        <td id="L6667" data-line-number="6667"></td>
        <td id="LC6667">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L6668" data-line-number="6668"></td>
        <td id="LC6668">                    <span>if</span> (<span>!</span><span>TryReadSqlDateTime</span>(<span>value</span>, <span>tdsType</span>, <span>length</span>, <span>md</span>.<span>scale</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L6669" data-line-number="6669"></td>
        <td id="LC6669">                    {</td>
      </tr>
      <tr>
        <td id="L6670" data-line-number="6670"></td>
        <td id="LC6670">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6671" data-line-number="6671"></td>
        <td id="LC6671">                    }</td>
      </tr>
      <tr>
        <td id="L6672" data-line-number="6672"></td>
        <td id="LC6672">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6673" data-line-number="6673"></td>
        <td id="LC6673">
</td>
      </tr>
      <tr>
        <td id="L6674" data-line-number="6674"></td>
        <td id="LC6674">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L6675" data-line-number="6675"></td>
        <td id="LC6675">                    <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isPlp</span>, <span><span>"</span>ReadSqlValue calling ReadSqlValueInternal with plp data<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6676" data-line-number="6676"></td>
        <td id="LC6676">                    <span>if</span> (<span>!</span><span>TryReadSqlValueInternal</span>(<span>value</span>, <span>tdsType</span>, <span>length</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L6677" data-line-number="6677"></td>
        <td id="LC6677">                    {</td>
      </tr>
      <tr>
        <td id="L6678" data-line-number="6678"></td>
        <td id="LC6678">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6679" data-line-number="6679"></td>
        <td id="LC6679">                    }</td>
      </tr>
      <tr>
        <td id="L6680" data-line-number="6680"></td>
        <td id="LC6680">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6681" data-line-number="6681"></td>
        <td id="LC6681">            }</td>
      </tr>
      <tr>
        <td id="L6682" data-line-number="6682"></td>
        <td id="LC6682">
</td>
      </tr>
      <tr>
        <td id="L6683" data-line-number="6683"></td>
        <td id="LC6683">            <span>Debug</span>.<span>Assert</span>((<span>stateObj</span>.<span>_longlen</span> <span>==</span> <span>0</span>) <span>&amp;&amp;</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>), <span><span>"</span>ReadSqlValue did not read plp field completely, longlen =<span>"</span></span> <span>+</span> <span>stateObj</span>.<span>_longlen</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>) <span>+</span> <span><span>"</span>,longlenleft=<span>"</span></span> <span>+</span> <span>stateObj</span>.<span>_longlenleft</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>));</td>
      </tr>
      <tr>
        <td id="L6684" data-line-number="6684"></td>
        <td id="LC6684">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6685" data-line-number="6685"></td>
        <td id="LC6685">        }</td>
      </tr>
      <tr>
        <td id="L6686" data-line-number="6686"></td>
        <td id="LC6686">
</td>
      </tr>
      <tr>
        <td id="L6687" data-line-number="6687"></td>
        <td id="LC6687">        <span>private</span> <span>bool</span> <span>TryReadSqlDateTime</span>(<span>SqlBuffer</span> <span>value</span>, <span>byte</span> <span>tdsType</span>, <span>int</span> <span>length</span>, <span>byte</span> <span>scale</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L6688" data-line-number="6688"></td>
        <td id="LC6688">        {</td>
      </tr>
      <tr>
        <td id="L6689" data-line-number="6689"></td>
        <td id="LC6689">            <span>byte</span>[] <span>datetimeBuffer</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L6690" data-line-number="6690"></td>
        <td id="LC6690">
</td>
      </tr>
      <tr>
        <td id="L6691" data-line-number="6691"></td>
        <td id="LC6691">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>datetimeBuffer</span>, <span>0</span>, <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6692" data-line-number="6692"></td>
        <td id="LC6692">            {</td>
      </tr>
      <tr>
        <td id="L6693" data-line-number="6693"></td>
        <td id="LC6693">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6694" data-line-number="6694"></td>
        <td id="LC6694">            }</td>
      </tr>
      <tr>
        <td id="L6695" data-line-number="6695"></td>
        <td id="LC6695">
</td>
      </tr>
      <tr>
        <td id="L6696" data-line-number="6696"></td>
        <td id="LC6696">            <span>switch</span> (<span>tdsType</span>)</td>
      </tr>
      <tr>
        <td id="L6697" data-line-number="6697"></td>
        <td id="LC6697">            {</td>
      </tr>
      <tr>
        <td id="L6698" data-line-number="6698"></td>
        <td id="LC6698">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATE</span>:</td>
      </tr>
      <tr>
        <td id="L6699" data-line-number="6699"></td>
        <td id="LC6699">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>3</span>, <span><span>"</span>invalid length for date type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6700" data-line-number="6700"></td>
        <td id="LC6700">                    <span>value</span>.<span>SetToDate</span>(<span>datetimeBuffer</span>);</td>
      </tr>
      <tr>
        <td id="L6701" data-line-number="6701"></td>
        <td id="LC6701">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6702" data-line-number="6702"></td>
        <td id="LC6702">
</td>
      </tr>
      <tr>
        <td id="L6703" data-line-number="6703"></td>
        <td id="LC6703">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L6704" data-line-number="6704"></td>
        <td id="LC6704">                    <span>Debug</span>.<span>Assert</span>(<span>3</span> <span>&lt;=</span> <span>length</span> <span>&amp;&amp;</span> <span>length</span> <span>&lt;=</span> <span>5</span>, <span><span>"</span>invalid length for time type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6705" data-line-number="6705"></td>
        <td id="LC6705">                    <span>value</span>.<span>SetToTime</span>(<span>datetimeBuffer</span>, <span>length</span>, <span>scale</span>, <span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L6706" data-line-number="6706"></td>
        <td id="LC6706">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6707" data-line-number="6707"></td>
        <td id="LC6707">
</td>
      </tr>
      <tr>
        <td id="L6708" data-line-number="6708"></td>
        <td id="LC6708">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME2</span>:</td>
      </tr>
      <tr>
        <td id="L6709" data-line-number="6709"></td>
        <td id="LC6709">                    <span>Debug</span>.<span>Assert</span>(<span>6</span> <span>&lt;=</span> <span>length</span> <span>&amp;&amp;</span> <span>length</span> <span>&lt;=</span> <span>8</span>, <span><span>"</span>invalid length for datetime2 type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6710" data-line-number="6710"></td>
        <td id="LC6710">                    <span>value</span>.<span>SetToDateTime2</span>(<span>datetimeBuffer</span>, <span>length</span>, <span>scale</span>, <span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L6711" data-line-number="6711"></td>
        <td id="LC6711">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6712" data-line-number="6712"></td>
        <td id="LC6712">
</td>
      </tr>
      <tr>
        <td id="L6713" data-line-number="6713"></td>
        <td id="LC6713">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L6714" data-line-number="6714"></td>
        <td id="LC6714">                    <span>Debug</span>.<span>Assert</span>(<span>8</span> <span>&lt;=</span> <span>length</span> <span>&amp;&amp;</span> <span>length</span> <span>&lt;=</span> <span>10</span>, <span><span>"</span>invalid length for datetimeoffset type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6715" data-line-number="6715"></td>
        <td id="LC6715">                    <span>value</span>.<span>SetToDateTimeOffset</span>(<span>datetimeBuffer</span>, <span>length</span>, <span>scale</span>, <span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L6716" data-line-number="6716"></td>
        <td id="LC6716">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6717" data-line-number="6717"></td>
        <td id="LC6717">
</td>
      </tr>
      <tr>
        <td id="L6718" data-line-number="6718"></td>
        <td id="LC6718">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L6719" data-line-number="6719"></td>
        <td id="LC6719">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>ReadSqlDateTime is called with the wrong tdsType<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6720" data-line-number="6720"></td>
        <td id="LC6720">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6721" data-line-number="6721"></td>
        <td id="LC6721">            }</td>
      </tr>
      <tr>
        <td id="L6722" data-line-number="6722"></td>
        <td id="LC6722">
</td>
      </tr>
      <tr>
        <td id="L6723" data-line-number="6723"></td>
        <td id="LC6723">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6724" data-line-number="6724"></td>
        <td id="LC6724">        }</td>
      </tr>
      <tr>
        <td id="L6725" data-line-number="6725"></td>
        <td id="LC6725">
</td>
      </tr>
      <tr>
        <td id="L6726" data-line-number="6726"></td>
        <td id="LC6726">        <span>internal</span> <span>bool</span> <span>TryReadSqlValueInternal</span>(<span>SqlBuffer</span> <span>value</span>, <span>byte</span> <span>tdsType</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L6727" data-line-number="6727"></td>
        <td id="LC6727">        {</td>
      </tr>
      <tr>
        <td id="L6728" data-line-number="6728"></td>
        <td id="LC6728">            <span>switch</span> (<span>tdsType</span>)</td>
      </tr>
      <tr>
        <td id="L6729" data-line-number="6729"></td>
        <td id="LC6729">            {</td>
      </tr>
      <tr>
        <td id="L6730" data-line-number="6730"></td>
        <td id="LC6730">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIT</span>:</td>
      </tr>
      <tr>
        <td id="L6731" data-line-number="6731"></td>
        <td id="LC6731">                <span>case</span> <span>TdsEnums</span>.<span>SQLBITN</span>:</td>
      </tr>
      <tr>
        <td id="L6732" data-line-number="6732"></td>
        <td id="LC6732">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>1</span>, <span><span>"</span>invalid length for SqlBoolean type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6733" data-line-number="6733"></td>
        <td id="LC6733">                    <span>byte</span> <span>byteValue</span>;</td>
      </tr>
      <tr>
        <td id="L6734" data-line-number="6734"></td>
        <td id="LC6734">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteValue</span>))</td>
      </tr>
      <tr>
        <td id="L6735" data-line-number="6735"></td>
        <td id="LC6735">                    {</td>
      </tr>
      <tr>
        <td id="L6736" data-line-number="6736"></td>
        <td id="LC6736">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6737" data-line-number="6737"></td>
        <td id="LC6737">                    }</td>
      </tr>
      <tr>
        <td id="L6738" data-line-number="6738"></td>
        <td id="LC6738">                    <span>value</span>.<span>Boolean</span> <span>=</span> (<span>byteValue</span> <span>!=</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L6739" data-line-number="6739"></td>
        <td id="LC6739">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6740" data-line-number="6740"></td>
        <td id="LC6740">
</td>
      </tr>
      <tr>
        <td id="L6741" data-line-number="6741"></td>
        <td id="LC6741">                <span>case</span> <span>TdsEnums</span>.<span>SQLINTN</span>:</td>
      </tr>
      <tr>
        <td id="L6742" data-line-number="6742"></td>
        <td id="LC6742">                    <span>if</span> (<span>length</span> <span>==</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L6743" data-line-number="6743"></td>
        <td id="LC6743">                    {</td>
      </tr>
      <tr>
        <td id="L6744" data-line-number="6744"></td>
        <td id="LC6744">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLINT1</span>;</td>
      </tr>
      <tr>
        <td id="L6745" data-line-number="6745"></td>
        <td id="LC6745">                    }</td>
      </tr>
      <tr>
        <td id="L6746" data-line-number="6746"></td>
        <td id="LC6746">                    <span>else</span> <span>if</span> (<span>length</span> <span>==</span> <span>2</span>)</td>
      </tr>
      <tr>
        <td id="L6747" data-line-number="6747"></td>
        <td id="LC6747">                    {</td>
      </tr>
      <tr>
        <td id="L6748" data-line-number="6748"></td>
        <td id="LC6748">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLINT2</span>;</td>
      </tr>
      <tr>
        <td id="L6749" data-line-number="6749"></td>
        <td id="LC6749">                    }</td>
      </tr>
      <tr>
        <td id="L6750" data-line-number="6750"></td>
        <td id="LC6750">                    <span>else</span> <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6751" data-line-number="6751"></td>
        <td id="LC6751">                    {</td>
      </tr>
      <tr>
        <td id="L6752" data-line-number="6752"></td>
        <td id="LC6752">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLINT4</span>;</td>
      </tr>
      <tr>
        <td id="L6753" data-line-number="6753"></td>
        <td id="LC6753">                    }</td>
      </tr>
      <tr>
        <td id="L6754" data-line-number="6754"></td>
        <td id="LC6754">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6755" data-line-number="6755"></td>
        <td id="LC6755">                    {</td>
      </tr>
      <tr>
        <td id="L6756" data-line-number="6756"></td>
        <td id="LC6756">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLINT8</span>;</td>
      </tr>
      <tr>
        <td id="L6757" data-line-number="6757"></td>
        <td id="LC6757">                    }</td>
      </tr>
      <tr>
        <td id="L6758" data-line-number="6758"></td>
        <td id="LC6758">
</td>
      </tr>
      <tr>
        <td id="L6759" data-line-number="6759"></td>
        <td id="LC6759">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT1</span>:</td>
      </tr>
      <tr>
        <td id="L6760" data-line-number="6760"></td>
        <td id="LC6760">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>1</span>, <span><span>"</span>invalid length for SqlByte type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6761" data-line-number="6761"></td>
        <td id="LC6761">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteValue</span>))</td>
      </tr>
      <tr>
        <td id="L6762" data-line-number="6762"></td>
        <td id="LC6762">                    {</td>
      </tr>
      <tr>
        <td id="L6763" data-line-number="6763"></td>
        <td id="LC6763">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6764" data-line-number="6764"></td>
        <td id="LC6764">                    }</td>
      </tr>
      <tr>
        <td id="L6765" data-line-number="6765"></td>
        <td id="LC6765">                    <span>value</span>.<span>Byte</span> <span>=</span> <span>byteValue</span>;</td>
      </tr>
      <tr>
        <td id="L6766" data-line-number="6766"></td>
        <td id="LC6766">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6767" data-line-number="6767"></td>
        <td id="LC6767">
</td>
      </tr>
      <tr>
        <td id="L6768" data-line-number="6768"></td>
        <td id="LC6768">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT2</span>:</td>
      </tr>
      <tr>
        <td id="L6769" data-line-number="6769"></td>
        <td id="LC6769">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>2</span>, <span><span>"</span>invalid length for SqlInt16 type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6770" data-line-number="6770"></td>
        <td id="LC6770">                    <span>short</span> <span>shortValue</span>;</td>
      </tr>
      <tr>
        <td id="L6771" data-line-number="6771"></td>
        <td id="LC6771">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt16</span>(<span>out</span> <span>shortValue</span>))</td>
      </tr>
      <tr>
        <td id="L6772" data-line-number="6772"></td>
        <td id="LC6772">                    {</td>
      </tr>
      <tr>
        <td id="L6773" data-line-number="6773"></td>
        <td id="LC6773">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6774" data-line-number="6774"></td>
        <td id="LC6774">                    }</td>
      </tr>
      <tr>
        <td id="L6775" data-line-number="6775"></td>
        <td id="LC6775">                    <span>value</span>.<span>Int16</span> <span>=</span> <span>shortValue</span>;</td>
      </tr>
      <tr>
        <td id="L6776" data-line-number="6776"></td>
        <td id="LC6776">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6777" data-line-number="6777"></td>
        <td id="LC6777">
</td>
      </tr>
      <tr>
        <td id="L6778" data-line-number="6778"></td>
        <td id="LC6778">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT4</span>:</td>
      </tr>
      <tr>
        <td id="L6779" data-line-number="6779"></td>
        <td id="LC6779">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>4</span>, <span><span>"</span>invalid length for SqlInt32 type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6780" data-line-number="6780"></td>
        <td id="LC6780">                    <span>int</span> <span>intValue</span>;</td>
      </tr>
      <tr>
        <td id="L6781" data-line-number="6781"></td>
        <td id="LC6781">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>intValue</span>))</td>
      </tr>
      <tr>
        <td id="L6782" data-line-number="6782"></td>
        <td id="LC6782">                    {</td>
      </tr>
      <tr>
        <td id="L6783" data-line-number="6783"></td>
        <td id="LC6783">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6784" data-line-number="6784"></td>
        <td id="LC6784">                    }</td>
      </tr>
      <tr>
        <td id="L6785" data-line-number="6785"></td>
        <td id="LC6785">                    <span>value</span>.<span>Int32</span> <span>=</span> <span>intValue</span>;</td>
      </tr>
      <tr>
        <td id="L6786" data-line-number="6786"></td>
        <td id="LC6786">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6787" data-line-number="6787"></td>
        <td id="LC6787">
</td>
      </tr>
      <tr>
        <td id="L6788" data-line-number="6788"></td>
        <td id="LC6788">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT8</span>:</td>
      </tr>
      <tr>
        <td id="L6789" data-line-number="6789"></td>
        <td id="LC6789">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for SqlInt64 type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6790" data-line-number="6790"></td>
        <td id="LC6790">                    <span>long</span> <span>longValue</span>;</td>
      </tr>
      <tr>
        <td id="L6791" data-line-number="6791"></td>
        <td id="LC6791">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt64</span>(<span>out</span> <span>longValue</span>))</td>
      </tr>
      <tr>
        <td id="L6792" data-line-number="6792"></td>
        <td id="LC6792">                    {</td>
      </tr>
      <tr>
        <td id="L6793" data-line-number="6793"></td>
        <td id="LC6793">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6794" data-line-number="6794"></td>
        <td id="LC6794">                    }</td>
      </tr>
      <tr>
        <td id="L6795" data-line-number="6795"></td>
        <td id="LC6795">                    <span>value</span>.<span>Int64</span> <span>=</span> <span>longValue</span>;</td>
      </tr>
      <tr>
        <td id="L6796" data-line-number="6796"></td>
        <td id="LC6796">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6797" data-line-number="6797"></td>
        <td id="LC6797">
</td>
      </tr>
      <tr>
        <td id="L6798" data-line-number="6798"></td>
        <td id="LC6798">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLTN</span>:</td>
      </tr>
      <tr>
        <td id="L6799" data-line-number="6799"></td>
        <td id="LC6799">                    <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6800" data-line-number="6800"></td>
        <td id="LC6800">                    {</td>
      </tr>
      <tr>
        <td id="L6801" data-line-number="6801"></td>
        <td id="LC6801">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLFLT4</span>;</td>
      </tr>
      <tr>
        <td id="L6802" data-line-number="6802"></td>
        <td id="LC6802">                    }</td>
      </tr>
      <tr>
        <td id="L6803" data-line-number="6803"></td>
        <td id="LC6803">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6804" data-line-number="6804"></td>
        <td id="LC6804">                    {</td>
      </tr>
      <tr>
        <td id="L6805" data-line-number="6805"></td>
        <td id="LC6805">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLFLT8</span>;</td>
      </tr>
      <tr>
        <td id="L6806" data-line-number="6806"></td>
        <td id="LC6806">                    }</td>
      </tr>
      <tr>
        <td id="L6807" data-line-number="6807"></td>
        <td id="LC6807">
</td>
      </tr>
      <tr>
        <td id="L6808" data-line-number="6808"></td>
        <td id="LC6808">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT4</span>:</td>
      </tr>
      <tr>
        <td id="L6809" data-line-number="6809"></td>
        <td id="LC6809">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>4</span>, <span><span>"</span>invalid length for SqlSingle type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6810" data-line-number="6810"></td>
        <td id="LC6810">                    <span>float</span> <span>singleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6811" data-line-number="6811"></td>
        <td id="LC6811">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadSingle</span>(<span>out</span> <span>singleValue</span>))</td>
      </tr>
      <tr>
        <td id="L6812" data-line-number="6812"></td>
        <td id="LC6812">                    {</td>
      </tr>
      <tr>
        <td id="L6813" data-line-number="6813"></td>
        <td id="LC6813">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6814" data-line-number="6814"></td>
        <td id="LC6814">                    }</td>
      </tr>
      <tr>
        <td id="L6815" data-line-number="6815"></td>
        <td id="LC6815">                    <span>value</span>.<span>Single</span> <span>=</span> <span>singleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6816" data-line-number="6816"></td>
        <td id="LC6816">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6817" data-line-number="6817"></td>
        <td id="LC6817">
</td>
      </tr>
      <tr>
        <td id="L6818" data-line-number="6818"></td>
        <td id="LC6818">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT8</span>:</td>
      </tr>
      <tr>
        <td id="L6819" data-line-number="6819"></td>
        <td id="LC6819">                    <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for SqlDouble type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6820" data-line-number="6820"></td>
        <td id="LC6820">                    <span>double</span> <span>doubleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6821" data-line-number="6821"></td>
        <td id="LC6821">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadDouble</span>(<span>out</span> <span>doubleValue</span>))</td>
      </tr>
      <tr>
        <td id="L6822" data-line-number="6822"></td>
        <td id="LC6822">                    {</td>
      </tr>
      <tr>
        <td id="L6823" data-line-number="6823"></td>
        <td id="LC6823">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6824" data-line-number="6824"></td>
        <td id="LC6824">                    }</td>
      </tr>
      <tr>
        <td id="L6825" data-line-number="6825"></td>
        <td id="LC6825">                    <span>value</span>.<span>Double</span> <span>=</span> <span>doubleValue</span>;</td>
      </tr>
      <tr>
        <td id="L6826" data-line-number="6826"></td>
        <td id="LC6826">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6827" data-line-number="6827"></td>
        <td id="LC6827">
</td>
      </tr>
      <tr>
        <td id="L6828" data-line-number="6828"></td>
        <td id="LC6828">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEYN</span>:</td>
      </tr>
      <tr>
        <td id="L6829" data-line-number="6829"></td>
        <td id="LC6829">                    <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6830" data-line-number="6830"></td>
        <td id="LC6830">                    {</td>
      </tr>
      <tr>
        <td id="L6831" data-line-number="6831"></td>
        <td id="LC6831">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY4</span>;</td>
      </tr>
      <tr>
        <td id="L6832" data-line-number="6832"></td>
        <td id="LC6832">                    }</td>
      </tr>
      <tr>
        <td id="L6833" data-line-number="6833"></td>
        <td id="LC6833">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6834" data-line-number="6834"></td>
        <td id="LC6834">                    {</td>
      </tr>
      <tr>
        <td id="L6835" data-line-number="6835"></td>
        <td id="LC6835">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY</span>;</td>
      </tr>
      <tr>
        <td id="L6836" data-line-number="6836"></td>
        <td id="LC6836">                    }</td>
      </tr>
      <tr>
        <td id="L6837" data-line-number="6837"></td>
        <td id="LC6837">
</td>
      </tr>
      <tr>
        <td id="L6838" data-line-number="6838"></td>
        <td id="LC6838">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY</span>:</td>
      </tr>
      <tr>
        <td id="L6839" data-line-number="6839"></td>
        <td id="LC6839">                    {</td>
      </tr>
      <tr>
        <td id="L6840" data-line-number="6840"></td>
        <td id="LC6840">                        <span>int</span> <span>mid</span>;</td>
      </tr>
      <tr>
        <td id="L6841" data-line-number="6841"></td>
        <td id="LC6841">                        <span>uint</span> <span>lo</span>;</td>
      </tr>
      <tr>
        <td id="L6842" data-line-number="6842"></td>
        <td id="LC6842">
</td>
      </tr>
      <tr>
        <td id="L6843" data-line-number="6843"></td>
        <td id="LC6843">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>mid</span>))</td>
      </tr>
      <tr>
        <td id="L6844" data-line-number="6844"></td>
        <td id="LC6844">                        {</td>
      </tr>
      <tr>
        <td id="L6845" data-line-number="6845"></td>
        <td id="LC6845">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6846" data-line-number="6846"></td>
        <td id="LC6846">                        }</td>
      </tr>
      <tr>
        <td id="L6847" data-line-number="6847"></td>
        <td id="LC6847">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>lo</span>))</td>
      </tr>
      <tr>
        <td id="L6848" data-line-number="6848"></td>
        <td id="LC6848">                        {</td>
      </tr>
      <tr>
        <td id="L6849" data-line-number="6849"></td>
        <td id="LC6849">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6850" data-line-number="6850"></td>
        <td id="LC6850">                        }</td>
      </tr>
      <tr>
        <td id="L6851" data-line-number="6851"></td>
        <td id="LC6851">
</td>
      </tr>
      <tr>
        <td id="L6852" data-line-number="6852"></td>
        <td id="LC6852">                        <span>long</span> <span>l</span> <span>=</span> (((<span>long</span>)<span>mid</span>) <span>&lt;&lt;</span> <span>0x20</span>) <span>+</span> ((<span>long</span>)<span>lo</span>);</td>
      </tr>
      <tr>
        <td id="L6853" data-line-number="6853"></td>
        <td id="LC6853">
</td>
      </tr>
      <tr>
        <td id="L6854" data-line-number="6854"></td>
        <td id="LC6854">                        <span>value</span>.<span>SetToMoney</span>(<span>l</span>);</td>
      </tr>
      <tr>
        <td id="L6855" data-line-number="6855"></td>
        <td id="LC6855">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6856" data-line-number="6856"></td>
        <td id="LC6856">                    }</td>
      </tr>
      <tr>
        <td id="L6857" data-line-number="6857"></td>
        <td id="LC6857">
</td>
      </tr>
      <tr>
        <td id="L6858" data-line-number="6858"></td>
        <td id="LC6858">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY4</span>:</td>
      </tr>
      <tr>
        <td id="L6859" data-line-number="6859"></td>
        <td id="LC6859">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>intValue</span>))</td>
      </tr>
      <tr>
        <td id="L6860" data-line-number="6860"></td>
        <td id="LC6860">                    {</td>
      </tr>
      <tr>
        <td id="L6861" data-line-number="6861"></td>
        <td id="LC6861">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6862" data-line-number="6862"></td>
        <td id="LC6862">                    }</td>
      </tr>
      <tr>
        <td id="L6863" data-line-number="6863"></td>
        <td id="LC6863">                    <span>value</span>.<span>SetToMoney</span>(<span>intValue</span>);</td>
      </tr>
      <tr>
        <td id="L6864" data-line-number="6864"></td>
        <td id="LC6864">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6865" data-line-number="6865"></td>
        <td id="LC6865">
</td>
      </tr>
      <tr>
        <td id="L6866" data-line-number="6866"></td>
        <td id="LC6866">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMN</span>:</td>
      </tr>
      <tr>
        <td id="L6867" data-line-number="6867"></td>
        <td id="LC6867">                    <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L6868" data-line-number="6868"></td>
        <td id="LC6868">                    {</td>
      </tr>
      <tr>
        <td id="L6869" data-line-number="6869"></td>
        <td id="LC6869">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIM4</span>;</td>
      </tr>
      <tr>
        <td id="L6870" data-line-number="6870"></td>
        <td id="LC6870">                    }</td>
      </tr>
      <tr>
        <td id="L6871" data-line-number="6871"></td>
        <td id="LC6871">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L6872" data-line-number="6872"></td>
        <td id="LC6872">                    {</td>
      </tr>
      <tr>
        <td id="L6873" data-line-number="6873"></td>
        <td id="LC6873">                        <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME</span>;</td>
      </tr>
      <tr>
        <td id="L6874" data-line-number="6874"></td>
        <td id="LC6874">                    }</td>
      </tr>
      <tr>
        <td id="L6875" data-line-number="6875"></td>
        <td id="LC6875">
</td>
      </tr>
      <tr>
        <td id="L6876" data-line-number="6876"></td>
        <td id="LC6876">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIM4</span>:</td>
      </tr>
      <tr>
        <td id="L6877" data-line-number="6877"></td>
        <td id="LC6877">                    <span>ushort</span> <span>daypartShort</span>, <span>timepartShort</span>;</td>
      </tr>
      <tr>
        <td id="L6878" data-line-number="6878"></td>
        <td id="LC6878">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>daypartShort</span>))</td>
      </tr>
      <tr>
        <td id="L6879" data-line-number="6879"></td>
        <td id="LC6879">                    {</td>
      </tr>
      <tr>
        <td id="L6880" data-line-number="6880"></td>
        <td id="LC6880">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6881" data-line-number="6881"></td>
        <td id="LC6881">                    }</td>
      </tr>
      <tr>
        <td id="L6882" data-line-number="6882"></td>
        <td id="LC6882">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>timepartShort</span>))</td>
      </tr>
      <tr>
        <td id="L6883" data-line-number="6883"></td>
        <td id="LC6883">                    {</td>
      </tr>
      <tr>
        <td id="L6884" data-line-number="6884"></td>
        <td id="LC6884">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6885" data-line-number="6885"></td>
        <td id="LC6885">                    }</td>
      </tr>
      <tr>
        <td id="L6886" data-line-number="6886"></td>
        <td id="LC6886">                    <span>value</span>.<span>SetToDateTime</span>(<span>daypartShort</span>, <span>timepartShort</span> <span>*</span> <span>SqlDateTime</span>.<span>SQLTicksPerMinute</span>);</td>
      </tr>
      <tr>
        <td id="L6887" data-line-number="6887"></td>
        <td id="LC6887">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6888" data-line-number="6888"></td>
        <td id="LC6888">
</td>
      </tr>
      <tr>
        <td id="L6889" data-line-number="6889"></td>
        <td id="LC6889">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME</span>:</td>
      </tr>
      <tr>
        <td id="L6890" data-line-number="6890"></td>
        <td id="LC6890">                    <span>int</span> <span>daypart</span>;</td>
      </tr>
      <tr>
        <td id="L6891" data-line-number="6891"></td>
        <td id="LC6891">                    <span>uint</span> <span>timepart</span>;</td>
      </tr>
      <tr>
        <td id="L6892" data-line-number="6892"></td>
        <td id="LC6892">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>daypart</span>))</td>
      </tr>
      <tr>
        <td id="L6893" data-line-number="6893"></td>
        <td id="LC6893">                    {</td>
      </tr>
      <tr>
        <td id="L6894" data-line-number="6894"></td>
        <td id="LC6894">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6895" data-line-number="6895"></td>
        <td id="LC6895">                    }</td>
      </tr>
      <tr>
        <td id="L6896" data-line-number="6896"></td>
        <td id="LC6896">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt32</span>(<span>out</span> <span>timepart</span>))</td>
      </tr>
      <tr>
        <td id="L6897" data-line-number="6897"></td>
        <td id="LC6897">                    {</td>
      </tr>
      <tr>
        <td id="L6898" data-line-number="6898"></td>
        <td id="LC6898">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6899" data-line-number="6899"></td>
        <td id="LC6899">                    }</td>
      </tr>
      <tr>
        <td id="L6900" data-line-number="6900"></td>
        <td id="LC6900">                    <span>value</span>.<span>SetToDateTime</span>(<span>daypart</span>, (<span>int</span>)<span>timepart</span>);</td>
      </tr>
      <tr>
        <td id="L6901" data-line-number="6901"></td>
        <td id="LC6901">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6902" data-line-number="6902"></td>
        <td id="LC6902">
</td>
      </tr>
      <tr>
        <td id="L6903" data-line-number="6903"></td>
        <td id="LC6903">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L6904" data-line-number="6904"></td>
        <td id="LC6904">                    {</td>
      </tr>
      <tr>
        <td id="L6905" data-line-number="6905"></td>
        <td id="LC6905">                        <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>16</span>, <span><span>"</span>invalid length for SqlGuid type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6906" data-line-number="6906"></td>
        <td id="LC6906">
</td>
      </tr>
      <tr>
        <td id="L6907" data-line-number="6907"></td>
        <td id="LC6907">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L6908" data-line-number="6908"></td>
        <td id="LC6908">
</td>
      </tr>
      <tr>
        <td id="L6909" data-line-number="6909"></td>
        <td id="LC6909">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>b</span>, <span>0</span>, <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6910" data-line-number="6910"></td>
        <td id="LC6910">                        {</td>
      </tr>
      <tr>
        <td id="L6911" data-line-number="6911"></td>
        <td id="LC6911">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6912" data-line-number="6912"></td>
        <td id="LC6912">                        }</td>
      </tr>
      <tr>
        <td id="L6913" data-line-number="6913"></td>
        <td id="LC6913">                        <span>value</span>.<span>SqlGuid</span> <span>=</span> <span>SqlTypeWorkarounds</span>.<span>SqlGuidCtor</span>(<span>b</span>, <span>true</span>);   <span><span>//</span> doesn't copy the byte array</span></td>
      </tr>
      <tr>
        <td id="L6914" data-line-number="6914"></td>
        <td id="LC6914">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6915" data-line-number="6915"></td>
        <td id="LC6915">                    }</td>
      </tr>
      <tr>
        <td id="L6916" data-line-number="6916"></td>
        <td id="LC6916">
</td>
      </tr>
      <tr>
        <td id="L6917" data-line-number="6917"></td>
        <td id="LC6917">                <span>case</span> <span>TdsEnums</span>.<span>SQLBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6918" data-line-number="6918"></td>
        <td id="LC6918">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6919" data-line-number="6919"></td>
        <td id="LC6919">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6920" data-line-number="6920"></td>
        <td id="LC6920">                <span>case</span> <span>TdsEnums</span>.<span>SQLVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L6921" data-line-number="6921"></td>
        <td id="LC6921">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L6922" data-line-number="6922"></td>
        <td id="LC6922">                    {</td>
      </tr>
      <tr>
        <td id="L6923" data-line-number="6923"></td>
        <td id="LC6923">                        <span><span>//</span> Note: Better not come here with plp data!!</span></td>
      </tr>
      <tr>
        <td id="L6924" data-line-number="6924"></td>
        <td id="LC6924">                        <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>&lt;=</span> <span>TdsEnums</span>.<span>MAXSIZE</span>);</td>
      </tr>
      <tr>
        <td id="L6925" data-line-number="6925"></td>
        <td id="LC6925">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L6926" data-line-number="6926"></td>
        <td id="LC6926">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByteArray</span>(<span>b</span>, <span>0</span>, <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L6927" data-line-number="6927"></td>
        <td id="LC6927">                        {</td>
      </tr>
      <tr>
        <td id="L6928" data-line-number="6928"></td>
        <td id="LC6928">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6929" data-line-number="6929"></td>
        <td id="LC6929">                        }</td>
      </tr>
      <tr>
        <td id="L6930" data-line-number="6930"></td>
        <td id="LC6930">                        <span>value</span>.<span>SqlBinary</span> <span>=</span> <span>SqlTypeWorkarounds</span>.<span>SqlBinaryCtor</span>(<span>b</span>, <span>true</span>);   <span><span>//</span> doesn't copy the byte array</span></td>
      </tr>
      <tr>
        <td id="L6931" data-line-number="6931"></td>
        <td id="LC6931">
</td>
      </tr>
      <tr>
        <td id="L6932" data-line-number="6932"></td>
        <td id="LC6932">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6933" data-line-number="6933"></td>
        <td id="LC6933">                    }</td>
      </tr>
      <tr>
        <td id="L6934" data-line-number="6934"></td>
        <td id="LC6934">
</td>
      </tr>
      <tr>
        <td id="L6935" data-line-number="6935"></td>
        <td id="LC6935">                <span>case</span> <span>TdsEnums</span>.<span>SQLVARIANT</span>:</td>
      </tr>
      <tr>
        <td id="L6936" data-line-number="6936"></td>
        <td id="LC6936">                    <span>if</span> (<span>!</span><span>TryReadSqlVariant</span>(<span>value</span>, <span>length</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L6937" data-line-number="6937"></td>
        <td id="LC6937">                    {</td>
      </tr>
      <tr>
        <td id="L6938" data-line-number="6938"></td>
        <td id="LC6938">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6939" data-line-number="6939"></td>
        <td id="LC6939">                    }</td>
      </tr>
      <tr>
        <td id="L6940" data-line-number="6940"></td>
        <td id="LC6940">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6941" data-line-number="6941"></td>
        <td id="LC6941">
</td>
      </tr>
      <tr>
        <td id="L6942" data-line-number="6942"></td>
        <td id="LC6942">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L6943" data-line-number="6943"></td>
        <td id="LC6943">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown SqlType!<span>"</span></span> <span>+</span> <span>tdsType</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L6944" data-line-number="6944"></td>
        <td id="LC6944">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L6945" data-line-number="6945"></td>
        <td id="LC6945">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L6946" data-line-number="6946"></td>
        <td id="LC6946">
</td>
      </tr>
      <tr>
        <td id="L6947" data-line-number="6947"></td>
        <td id="LC6947">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L6948" data-line-number="6948"></td>
        <td id="LC6948">        }</td>
      </tr>
      <tr>
        <td id="L6949" data-line-number="6949"></td>
        <td id="LC6949">
</td>
      </tr>
      <tr>
        <td id="L6950" data-line-number="6950"></td>
        <td id="LC6950">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L6951" data-line-number="6951"></td>
        <td id="LC6951">        <span><span>//</span> Read in a SQLVariant</span></td>
      </tr>
      <tr>
        <td id="L6952" data-line-number="6952"></td>
        <td id="LC6952">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L6953" data-line-number="6953"></td>
        <td id="LC6953">        <span><span>//</span> SQLVariant looks like:</span></td>
      </tr>
      <tr>
        <td id="L6954" data-line-number="6954"></td>
        <td id="LC6954">        <span><span>//</span> struct</span></td>
      </tr>
      <tr>
        <td id="L6955" data-line-number="6955"></td>
        <td id="LC6955">        <span><span>//</span> {</span></td>
      </tr>
      <tr>
        <td id="L6956" data-line-number="6956"></td>
        <td id="LC6956">        <span><span>//</span>      BYTE TypeTag</span></td>
      </tr>
      <tr>
        <td id="L6957" data-line-number="6957"></td>
        <td id="LC6957">        <span><span>//</span>      BYTE cbPropBytes</span></td>
      </tr>
      <tr>
        <td id="L6958" data-line-number="6958"></td>
        <td id="LC6958">        <span><span>//</span>      BYTE[] Properties</span></td>
      </tr>
      <tr>
        <td id="L6959" data-line-number="6959"></td>
        <td id="LC6959">        <span><span>//</span>      BYTE[] DataVal</span></td>
      </tr>
      <tr>
        <td id="L6960" data-line-number="6960"></td>
        <td id="LC6960">        <span><span>//</span> }</span></td>
      </tr>
      <tr>
        <td id="L6961" data-line-number="6961"></td>
        <td id="LC6961">        <span>internal</span> <span>bool</span> <span>TryReadSqlVariant</span>(<span>SqlBuffer</span> <span>value</span>, <span>int</span> <span>lenTotal</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L6962" data-line-number="6962"></td>
        <td id="LC6962">        {</td>
      </tr>
      <tr>
        <td id="L6963" data-line-number="6963"></td>
        <td id="LC6963">            <span>Debug</span>.<span>Assert</span>(<span>_isShiloh</span> <span>==</span> <span>true</span>, <span><span>"</span>Shouldn't be dealing with sql_variaint in pre-SQL2000 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6964" data-line-number="6964"></td>
        <td id="LC6964">            <span><span>//</span> get the SQLVariant type</span></td>
      </tr>
      <tr>
        <td id="L6965" data-line-number="6965"></td>
        <td id="LC6965">            <span>byte</span> <span>type</span>;</td>
      </tr>
      <tr>
        <td id="L6966" data-line-number="6966"></td>
        <td id="LC6966">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>type</span>))</td>
      </tr>
      <tr>
        <td id="L6967" data-line-number="6967"></td>
        <td id="LC6967">            {</td>
      </tr>
      <tr>
        <td id="L6968" data-line-number="6968"></td>
        <td id="LC6968">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6969" data-line-number="6969"></td>
        <td id="LC6969">            }</td>
      </tr>
      <tr>
        <td id="L6970" data-line-number="6970"></td>
        <td id="LC6970">            <span>ushort</span> <span>lenMax</span> <span>=</span> <span>0</span>; <span><span>//</span> maximum lenData of value inside variant</span></td>
      </tr>
      <tr>
        <td id="L6971" data-line-number="6971"></td>
        <td id="LC6971">
</td>
      </tr>
      <tr>
        <td id="L6972" data-line-number="6972"></td>
        <td id="LC6972">            <span><span>//</span> read cbPropBytes</span></td>
      </tr>
      <tr>
        <td id="L6973" data-line-number="6973"></td>
        <td id="LC6973">            <span>byte</span> <span>cbPropsActual</span>;</td>
      </tr>
      <tr>
        <td id="L6974" data-line-number="6974"></td>
        <td id="LC6974">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>cbPropsActual</span>))</td>
      </tr>
      <tr>
        <td id="L6975" data-line-number="6975"></td>
        <td id="LC6975">            {</td>
      </tr>
      <tr>
        <td id="L6976" data-line-number="6976"></td>
        <td id="LC6976">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L6977" data-line-number="6977"></td>
        <td id="LC6977">            }</td>
      </tr>
      <tr>
        <td id="L6978" data-line-number="6978"></td>
        <td id="LC6978">            <span>MetaType</span> <span>mt</span> <span>=</span> <span>MetaType</span>.<span>GetSqlDataType</span>(<span>type</span>, <span>0</span> <span><span>/*</span>no user datatype<span>*/</span></span>, <span>0</span> <span><span>/*</span> no lenData, non-nullable type <span>*/</span></span>);</td>
      </tr>
      <tr>
        <td id="L6979" data-line-number="6979"></td>
        <td id="LC6979">            <span>byte</span> <span>cbPropsExpected</span> <span>=</span> <span>mt</span>.<span>PropBytes</span>;</td>
      </tr>
      <tr>
        <td id="L6980" data-line-number="6980"></td>
        <td id="LC6980">
</td>
      </tr>
      <tr>
        <td id="L6981" data-line-number="6981"></td>
        <td id="LC6981">            <span>int</span> <span>lenConsumed</span> <span>=</span> <span>TdsEnums</span>.<span>SQLVARIANT_SIZE</span> <span>+</span> <span>cbPropsActual</span>; <span><span>//</span> type, count of propBytes, and actual propBytes</span></td>
      </tr>
      <tr>
        <td id="L6982" data-line-number="6982"></td>
        <td id="LC6982">            <span>int</span> <span>lenData</span> <span>=</span> <span>lenTotal</span> <span>-</span> <span>lenConsumed</span>; <span><span>//</span> length of actual data</span></td>
      </tr>
      <tr>
        <td id="L6983" data-line-number="6983"></td>
        <td id="LC6983">
</td>
      </tr>
      <tr>
        <td id="L6984" data-line-number="6984"></td>
        <td id="LC6984">            <span><span>//</span> read known properties and skip unknown properties</span></td>
      </tr>
      <tr>
        <td id="L6985" data-line-number="6985"></td>
        <td id="LC6985">            <span>Debug</span>.<span>Assert</span>(<span>cbPropsActual</span> <span>&gt;=</span> <span>cbPropsExpected</span>, <span><span>"</span>cbPropsActual is less that cbPropsExpected!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L6986" data-line-number="6986"></td>
        <td id="LC6986">
</td>
      </tr>
      <tr>
        <td id="L6987" data-line-number="6987"></td>
        <td id="LC6987">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L6988" data-line-number="6988"></td>
        <td id="LC6988">            <span><span>//</span> now read the value</span></td>
      </tr>
      <tr>
        <td id="L6989" data-line-number="6989"></td>
        <td id="LC6989">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L6990" data-line-number="6990"></td>
        <td id="LC6990">            <span>switch</span> (<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L6991" data-line-number="6991"></td>
        <td id="LC6991">            {</td>
      </tr>
      <tr>
        <td id="L6992" data-line-number="6992"></td>
        <td id="LC6992">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIT</span>:</td>
      </tr>
      <tr>
        <td id="L6993" data-line-number="6993"></td>
        <td id="LC6993">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT1</span>:</td>
      </tr>
      <tr>
        <td id="L6994" data-line-number="6994"></td>
        <td id="LC6994">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT2</span>:</td>
      </tr>
      <tr>
        <td id="L6995" data-line-number="6995"></td>
        <td id="LC6995">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT4</span>:</td>
      </tr>
      <tr>
        <td id="L6996" data-line-number="6996"></td>
        <td id="LC6996">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT8</span>:</td>
      </tr>
      <tr>
        <td id="L6997" data-line-number="6997"></td>
        <td id="LC6997">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT4</span>:</td>
      </tr>
      <tr>
        <td id="L6998" data-line-number="6998"></td>
        <td id="LC6998">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT8</span>:</td>
      </tr>
      <tr>
        <td id="L6999" data-line-number="6999"></td>
        <td id="LC6999">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY</span>:</td>
      </tr>
      <tr>
        <td id="L7000" data-line-number="7000"></td>
        <td id="LC7000">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY4</span>:</td>
      </tr>
      <tr>
        <td id="L7001" data-line-number="7001"></td>
        <td id="LC7001">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME</span>:</td>
      </tr>
      <tr>
        <td id="L7002" data-line-number="7002"></td>
        <td id="LC7002">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIM4</span>:</td>
      </tr>
      <tr>
        <td id="L7003" data-line-number="7003"></td>
        <td id="LC7003">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L7004" data-line-number="7004"></td>
        <td id="LC7004">                    <span>if</span> (<span>!</span><span>TryReadSqlValueInternal</span>(<span>value</span>, <span>type</span>, <span>lenData</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L7005" data-line-number="7005"></td>
        <td id="LC7005">                    {</td>
      </tr>
      <tr>
        <td id="L7006" data-line-number="7006"></td>
        <td id="LC7006">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7007" data-line-number="7007"></td>
        <td id="LC7007">                    }</td>
      </tr>
      <tr>
        <td id="L7008" data-line-number="7008"></td>
        <td id="LC7008">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7009" data-line-number="7009"></td>
        <td id="LC7009">
</td>
      </tr>
      <tr>
        <td id="L7010" data-line-number="7010"></td>
        <td id="LC7010">                <span>case</span> <span>TdsEnums</span>.<span>SQLDECIMALN</span>:</td>
      </tr>
      <tr>
        <td id="L7011" data-line-number="7011"></td>
        <td id="LC7011">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L7012" data-line-number="7012"></td>
        <td id="LC7012">                    {</td>
      </tr>
      <tr>
        <td id="L7013" data-line-number="7013"></td>
        <td id="LC7013">                        <span>Debug</span>.<span>Assert</span>(<span>cbPropsExpected</span> <span>==</span> <span>2</span>, <span><span>"</span>SqlVariant: invalid PropBytes for decimal/numeric type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7014" data-line-number="7014"></td>
        <td id="LC7014">
</td>
      </tr>
      <tr>
        <td id="L7015" data-line-number="7015"></td>
        <td id="LC7015">                        <span>byte</span> <span>precision</span>;</td>
      </tr>
      <tr>
        <td id="L7016" data-line-number="7016"></td>
        <td id="LC7016">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>precision</span>))</td>
      </tr>
      <tr>
        <td id="L7017" data-line-number="7017"></td>
        <td id="LC7017">                        {</td>
      </tr>
      <tr>
        <td id="L7018" data-line-number="7018"></td>
        <td id="LC7018">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7019" data-line-number="7019"></td>
        <td id="LC7019">                        }</td>
      </tr>
      <tr>
        <td id="L7020" data-line-number="7020"></td>
        <td id="LC7020">                        <span>byte</span> <span>scale</span>;</td>
      </tr>
      <tr>
        <td id="L7021" data-line-number="7021"></td>
        <td id="LC7021">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>scale</span>))</td>
      </tr>
      <tr>
        <td id="L7022" data-line-number="7022"></td>
        <td id="LC7022">                        {</td>
      </tr>
      <tr>
        <td id="L7023" data-line-number="7023"></td>
        <td id="LC7023">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7024" data-line-number="7024"></td>
        <td id="LC7024">                        }</td>
      </tr>
      <tr>
        <td id="L7025" data-line-number="7025"></td>
        <td id="LC7025">
</td>
      </tr>
      <tr>
        <td id="L7026" data-line-number="7026"></td>
        <td id="LC7026">                        <span><span>//</span> skip over unknown properties</span></td>
      </tr>
      <tr>
        <td id="L7027" data-line-number="7027"></td>
        <td id="LC7027">                        <span>if</span> (<span>cbPropsActual</span> <span>&gt;</span> <span>cbPropsExpected</span>)</td>
      </tr>
      <tr>
        <td id="L7028" data-line-number="7028"></td>
        <td id="LC7028">                        {</td>
      </tr>
      <tr>
        <td id="L7029" data-line-number="7029"></td>
        <td id="LC7029">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>cbPropsActual</span> <span>-</span> <span>cbPropsExpected</span>))</td>
      </tr>
      <tr>
        <td id="L7030" data-line-number="7030"></td>
        <td id="LC7030">                            {</td>
      </tr>
      <tr>
        <td id="L7031" data-line-number="7031"></td>
        <td id="LC7031">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7032" data-line-number="7032"></td>
        <td id="LC7032">                            }</td>
      </tr>
      <tr>
        <td id="L7033" data-line-number="7033"></td>
        <td id="LC7033">                        }</td>
      </tr>
      <tr>
        <td id="L7034" data-line-number="7034"></td>
        <td id="LC7034">
</td>
      </tr>
      <tr>
        <td id="L7035" data-line-number="7035"></td>
        <td id="LC7035">                        <span>if</span> (<span>!</span><span>TryReadSqlDecimal</span>(<span>value</span>, <span>TdsEnums</span>.<span>MAX_NUMERIC_LEN</span>, <span>precision</span>, <span>scale</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L7036" data-line-number="7036"></td>
        <td id="LC7036">                        {</td>
      </tr>
      <tr>
        <td id="L7037" data-line-number="7037"></td>
        <td id="LC7037">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7038" data-line-number="7038"></td>
        <td id="LC7038">                        }</td>
      </tr>
      <tr>
        <td id="L7039" data-line-number="7039"></td>
        <td id="LC7039">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7040" data-line-number="7040"></td>
        <td id="LC7040">                    }</td>
      </tr>
      <tr>
        <td id="L7041" data-line-number="7041"></td>
        <td id="LC7041">
</td>
      </tr>
      <tr>
        <td id="L7042" data-line-number="7042"></td>
        <td id="LC7042">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L7043" data-line-number="7043"></td>
        <td id="LC7043">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L7044" data-line-number="7044"></td>
        <td id="LC7044">                    <span><span>//</span>Debug.Assert(TdsEnums.VARNULL == lenData, "SqlVariant: data length for Binary indicates null?");</span></td>
      </tr>
      <tr>
        <td id="L7045" data-line-number="7045"></td>
        <td id="LC7045">                    <span>Debug</span>.<span>Assert</span>(<span>cbPropsExpected</span> <span>==</span> <span>2</span>, <span><span>"</span>SqlVariant: invalid PropBytes for binary type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7046" data-line-number="7046"></td>
        <td id="LC7046">
</td>
      </tr>
      <tr>
        <td id="L7047" data-line-number="7047"></td>
        <td id="LC7047">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>lenMax</span>))</td>
      </tr>
      <tr>
        <td id="L7048" data-line-number="7048"></td>
        <td id="LC7048">                    {</td>
      </tr>
      <tr>
        <td id="L7049" data-line-number="7049"></td>
        <td id="LC7049">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7050" data-line-number="7050"></td>
        <td id="LC7050">                    }</td>
      </tr>
      <tr>
        <td id="L7051" data-line-number="7051"></td>
        <td id="LC7051">                    <span>Debug</span>.<span>Assert</span>(<span>lenMax</span> <span>!=</span> <span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>, <span><span>"</span>bigvarbinary(max) in a sqlvariant<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7052" data-line-number="7052"></td>
        <td id="LC7052">
</td>
      </tr>
      <tr>
        <td id="L7053" data-line-number="7053"></td>
        <td id="LC7053">                    <span><span>//</span> skip over unknown properties</span></td>
      </tr>
      <tr>
        <td id="L7054" data-line-number="7054"></td>
        <td id="LC7054">                    <span>if</span> (<span>cbPropsActual</span> <span>&gt;</span> <span>cbPropsExpected</span>)</td>
      </tr>
      <tr>
        <td id="L7055" data-line-number="7055"></td>
        <td id="LC7055">                    {</td>
      </tr>
      <tr>
        <td id="L7056" data-line-number="7056"></td>
        <td id="LC7056">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>cbPropsActual</span> <span>-</span> <span>cbPropsExpected</span>))</td>
      </tr>
      <tr>
        <td id="L7057" data-line-number="7057"></td>
        <td id="LC7057">                        {</td>
      </tr>
      <tr>
        <td id="L7058" data-line-number="7058"></td>
        <td id="LC7058">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7059" data-line-number="7059"></td>
        <td id="LC7059">                        }</td>
      </tr>
      <tr>
        <td id="L7060" data-line-number="7060"></td>
        <td id="LC7060">                    }</td>
      </tr>
      <tr>
        <td id="L7061" data-line-number="7061"></td>
        <td id="LC7061">
</td>
      </tr>
      <tr>
        <td id="L7062" data-line-number="7062"></td>
        <td id="LC7062">                    <span>goto</span> <span>case</span> <span>TdsEnums</span>.<span>SQLBIT</span>;</td>
      </tr>
      <tr>
        <td id="L7063" data-line-number="7063"></td>
        <td id="LC7063">
</td>
      </tr>
      <tr>
        <td id="L7064" data-line-number="7064"></td>
        <td id="LC7064">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7065" data-line-number="7065"></td>
        <td id="LC7065">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7066" data-line-number="7066"></td>
        <td id="LC7066">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7067" data-line-number="7067"></td>
        <td id="LC7067">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7068" data-line-number="7068"></td>
        <td id="LC7068">                    {</td>
      </tr>
      <tr>
        <td id="L7069" data-line-number="7069"></td>
        <td id="LC7069">                        <span>Debug</span>.<span>Assert</span>(<span>cbPropsExpected</span> <span>==</span> <span>7</span>, <span><span>"</span>SqlVariant: invalid PropBytes for character type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7070" data-line-number="7070"></td>
        <td id="LC7070">
</td>
      </tr>
      <tr>
        <td id="L7071" data-line-number="7071"></td>
        <td id="LC7071">                        <span>SqlCollation</span> <span>collation</span>;</td>
      </tr>
      <tr>
        <td id="L7072" data-line-number="7072"></td>
        <td id="LC7072">                        <span>if</span> (<span>!</span><span>TryProcessCollation</span>(<span>stateObj</span>, <span>out</span> <span>collation</span>))</td>
      </tr>
      <tr>
        <td id="L7073" data-line-number="7073"></td>
        <td id="LC7073">                        {</td>
      </tr>
      <tr>
        <td id="L7074" data-line-number="7074"></td>
        <td id="LC7074">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7075" data-line-number="7075"></td>
        <td id="LC7075">                        }</td>
      </tr>
      <tr>
        <td id="L7076" data-line-number="7076"></td>
        <td id="LC7076">
</td>
      </tr>
      <tr>
        <td id="L7077" data-line-number="7077"></td>
        <td id="LC7077">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>lenMax</span>))</td>
      </tr>
      <tr>
        <td id="L7078" data-line-number="7078"></td>
        <td id="LC7078">                        {</td>
      </tr>
      <tr>
        <td id="L7079" data-line-number="7079"></td>
        <td id="LC7079">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7080" data-line-number="7080"></td>
        <td id="LC7080">                        }</td>
      </tr>
      <tr>
        <td id="L7081" data-line-number="7081"></td>
        <td id="LC7081">                        <span>Debug</span>.<span>Assert</span>(<span>lenMax</span> <span>!=</span> <span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>, <span><span>"</span>bigvarchar(max) or nvarchar(max) in a sqlvariant<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7082" data-line-number="7082"></td>
        <td id="LC7082">
</td>
      </tr>
      <tr>
        <td id="L7083" data-line-number="7083"></td>
        <td id="LC7083">                        <span><span>//</span> skip over unknown properties</span></td>
      </tr>
      <tr>
        <td id="L7084" data-line-number="7084"></td>
        <td id="LC7084">                        <span>if</span> (<span>cbPropsActual</span> <span>&gt;</span> <span>cbPropsExpected</span>)</td>
      </tr>
      <tr>
        <td id="L7085" data-line-number="7085"></td>
        <td id="LC7085">                        {</td>
      </tr>
      <tr>
        <td id="L7086" data-line-number="7086"></td>
        <td id="LC7086">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>cbPropsActual</span> <span>-</span> <span>cbPropsExpected</span>))</td>
      </tr>
      <tr>
        <td id="L7087" data-line-number="7087"></td>
        <td id="LC7087">                            {</td>
      </tr>
      <tr>
        <td id="L7088" data-line-number="7088"></td>
        <td id="LC7088">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7089" data-line-number="7089"></td>
        <td id="LC7089">                            }</td>
      </tr>
      <tr>
        <td id="L7090" data-line-number="7090"></td>
        <td id="LC7090">                        }</td>
      </tr>
      <tr>
        <td id="L7091" data-line-number="7091"></td>
        <td id="LC7091">
</td>
      </tr>
      <tr>
        <td id="L7092" data-line-number="7092"></td>
        <td id="LC7092">                        <span>Encoding</span> <span>encoding</span> <span>=</span> <span>Encoding</span>.<span>GetEncoding</span>(<span>GetCodePage</span>(<span>collation</span>, <span>stateObj</span>));</td>
      </tr>
      <tr>
        <td id="L7093" data-line-number="7093"></td>
        <td id="LC7093">                        <span>if</span> (<span>!</span><span>TryReadSqlStringValue</span>(<span>value</span>, <span>type</span>, <span>lenData</span>, <span>encoding</span>, <span>false</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L7094" data-line-number="7094"></td>
        <td id="LC7094">                        {</td>
      </tr>
      <tr>
        <td id="L7095" data-line-number="7095"></td>
        <td id="LC7095">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7096" data-line-number="7096"></td>
        <td id="LC7096">                        }</td>
      </tr>
      <tr>
        <td id="L7097" data-line-number="7097"></td>
        <td id="LC7097">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7098" data-line-number="7098"></td>
        <td id="LC7098">                    }</td>
      </tr>
      <tr>
        <td id="L7099" data-line-number="7099"></td>
        <td id="LC7099">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATE</span>:</td>
      </tr>
      <tr>
        <td id="L7100" data-line-number="7100"></td>
        <td id="LC7100">                    <span>if</span> (<span>!</span><span>TryReadSqlDateTime</span>(<span>value</span>, <span>type</span>, <span>lenData</span>, <span>0</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L7101" data-line-number="7101"></td>
        <td id="LC7101">                    {</td>
      </tr>
      <tr>
        <td id="L7102" data-line-number="7102"></td>
        <td id="LC7102">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7103" data-line-number="7103"></td>
        <td id="LC7103">                    }</td>
      </tr>
      <tr>
        <td id="L7104" data-line-number="7104"></td>
        <td id="LC7104">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7105" data-line-number="7105"></td>
        <td id="LC7105">
</td>
      </tr>
      <tr>
        <td id="L7106" data-line-number="7106"></td>
        <td id="LC7106">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L7107" data-line-number="7107"></td>
        <td id="LC7107">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME2</span>:</td>
      </tr>
      <tr>
        <td id="L7108" data-line-number="7108"></td>
        <td id="LC7108">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L7109" data-line-number="7109"></td>
        <td id="LC7109">                    {</td>
      </tr>
      <tr>
        <td id="L7110" data-line-number="7110"></td>
        <td id="LC7110">                        <span>Debug</span>.<span>Assert</span>(<span>cbPropsExpected</span> <span>==</span> <span>1</span>, <span><span>"</span>SqlVariant: invalid PropBytes for time/datetime2/datetimeoffset type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7111" data-line-number="7111"></td>
        <td id="LC7111">
</td>
      </tr>
      <tr>
        <td id="L7112" data-line-number="7112"></td>
        <td id="LC7112">                        <span>byte</span> <span>scale</span>;</td>
      </tr>
      <tr>
        <td id="L7113" data-line-number="7113"></td>
        <td id="LC7113">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>scale</span>))</td>
      </tr>
      <tr>
        <td id="L7114" data-line-number="7114"></td>
        <td id="LC7114">                        {</td>
      </tr>
      <tr>
        <td id="L7115" data-line-number="7115"></td>
        <td id="LC7115">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7116" data-line-number="7116"></td>
        <td id="LC7116">                        }</td>
      </tr>
      <tr>
        <td id="L7117" data-line-number="7117"></td>
        <td id="LC7117">
</td>
      </tr>
      <tr>
        <td id="L7118" data-line-number="7118"></td>
        <td id="LC7118">                        <span><span>//</span> skip over unknown properties</span></td>
      </tr>
      <tr>
        <td id="L7119" data-line-number="7119"></td>
        <td id="LC7119">                        <span>if</span> (<span>cbPropsActual</span> <span>&gt;</span> <span>cbPropsExpected</span>)</td>
      </tr>
      <tr>
        <td id="L7120" data-line-number="7120"></td>
        <td id="LC7120">                        {</td>
      </tr>
      <tr>
        <td id="L7121" data-line-number="7121"></td>
        <td id="LC7121">                            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>cbPropsActual</span> <span>-</span> <span>cbPropsExpected</span>))</td>
      </tr>
      <tr>
        <td id="L7122" data-line-number="7122"></td>
        <td id="LC7122">                            {</td>
      </tr>
      <tr>
        <td id="L7123" data-line-number="7123"></td>
        <td id="LC7123">                                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7124" data-line-number="7124"></td>
        <td id="LC7124">                            }</td>
      </tr>
      <tr>
        <td id="L7125" data-line-number="7125"></td>
        <td id="LC7125">                        }</td>
      </tr>
      <tr>
        <td id="L7126" data-line-number="7126"></td>
        <td id="LC7126">
</td>
      </tr>
      <tr>
        <td id="L7127" data-line-number="7127"></td>
        <td id="LC7127">                        <span>if</span> (<span>!</span><span>TryReadSqlDateTime</span>(<span>value</span>, <span>type</span>, <span>lenData</span>, <span>scale</span>, <span>stateObj</span>))</td>
      </tr>
      <tr>
        <td id="L7128" data-line-number="7128"></td>
        <td id="LC7128">                        {</td>
      </tr>
      <tr>
        <td id="L7129" data-line-number="7129"></td>
        <td id="LC7129">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7130" data-line-number="7130"></td>
        <td id="LC7130">                        }</td>
      </tr>
      <tr>
        <td id="L7131" data-line-number="7131"></td>
        <td id="LC7131">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7132" data-line-number="7132"></td>
        <td id="LC7132">                    }</td>
      </tr>
      <tr>
        <td id="L7133" data-line-number="7133"></td>
        <td id="LC7133">
</td>
      </tr>
      <tr>
        <td id="L7134" data-line-number="7134"></td>
        <td id="LC7134">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L7135" data-line-number="7135"></td>
        <td id="LC7135">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown tds type in SqlVariant!<span>"</span></span> <span>+</span> <span>type</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L7136" data-line-number="7136"></td>
        <td id="LC7136">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7137" data-line-number="7137"></td>
        <td id="LC7137">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L7138" data-line-number="7138"></td>
        <td id="LC7138">
</td>
      </tr>
      <tr>
        <td id="L7139" data-line-number="7139"></td>
        <td id="LC7139">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L7140" data-line-number="7140"></td>
        <td id="LC7140">        }</td>
      </tr>
      <tr>
        <td id="L7141" data-line-number="7141"></td>
        <td id="LC7141">
</td>
      </tr>
      <tr>
        <td id="L7142" data-line-number="7142"></td>
        <td id="LC7142">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L7143" data-line-number="7143"></td>
        <td id="LC7143">        <span><span>//</span> Translates a com+ object -&gt; SqlVariant</span></td>
      </tr>
      <tr>
        <td id="L7144" data-line-number="7144"></td>
        <td id="LC7144">        <span><span>//</span> when the type is ambiguous, we always convert to the bigger type</span></td>
      </tr>
      <tr>
        <td id="L7145" data-line-number="7145"></td>
        <td id="LC7145">        <span><span>//</span> note that we also write out the maxlen and actuallen members (4 bytes each)</span></td>
      </tr>
      <tr>
        <td id="L7146" data-line-number="7146"></td>
        <td id="LC7146">        <span><span>//</span> in addition to the SQLVariant structure</span></td>
      </tr>
      <tr>
        <td id="L7147" data-line-number="7147"></td>
        <td id="LC7147">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L7148" data-line-number="7148"></td>
        <td id="LC7148">        <span>internal</span> <span>Task</span> <span>WriteSqlVariantValue</span>(<span>object</span> <span>value</span>, <span>int</span> <span>length</span>, <span>int</span> <span>offset</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>canAccumulate</span> <span>=</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L7149" data-line-number="7149"></td>
        <td id="LC7149">        {</td>
      </tr>
      <tr>
        <td id="L7150" data-line-number="7150"></td>
        <td id="LC7150">            <span>Debug</span>.<span>Assert</span>(<span>_isShiloh</span> <span>==</span> <span>true</span>, <span><span>"</span>Shouldn't be dealing with sql_variant in pre-SQL2000 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7151" data-line-number="7151"></td>
        <td id="LC7151">
</td>
      </tr>
      <tr>
        <td id="L7152" data-line-number="7152"></td>
        <td id="LC7152">            <span><span>//</span> handle null values</span></td>
      </tr>
      <tr>
        <td id="L7153" data-line-number="7153"></td>
        <td id="LC7153">            <span>if</span> (<span>ADP</span>.<span>IsNull</span>(<span>value</span>))</td>
      </tr>
      <tr>
        <td id="L7154" data-line-number="7154"></td>
        <td id="LC7154">            {</td>
      </tr>
      <tr>
        <td id="L7155" data-line-number="7155"></td>
        <td id="LC7155">                <span>WriteInt</span>(<span>TdsEnums</span>.<span>FIXEDNULL</span>, <span>stateObj</span>); <span><span>//</span>maxlen</span></td>
      </tr>
      <tr>
        <td id="L7156" data-line-number="7156"></td>
        <td id="LC7156">                <span>WriteInt</span>(<span>TdsEnums</span>.<span>FIXEDNULL</span>, <span>stateObj</span>); <span><span>//</span>actuallen</span></td>
      </tr>
      <tr>
        <td id="L7157" data-line-number="7157"></td>
        <td id="LC7157">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L7158" data-line-number="7158"></td>
        <td id="LC7158">            }</td>
      </tr>
      <tr>
        <td id="L7159" data-line-number="7159"></td>
        <td id="LC7159">
</td>
      </tr>
      <tr>
        <td id="L7160" data-line-number="7160"></td>
        <td id="LC7160">            <span>MetaType</span> <span>mt</span> <span>=</span> <span>MetaType</span>.<span>GetMetaTypeFromValue</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7161" data-line-number="7161"></td>
        <td id="LC7161">
</td>
      </tr>
      <tr>
        <td id="L7162" data-line-number="7162"></td>
        <td id="LC7162">            <span><span>//</span> Special case data type correction for SqlMoney inside a SqlVariant.</span></td>
      </tr>
      <tr>
        <td id="L7163" data-line-number="7163"></td>
        <td id="LC7163">            <span>if</span> ((<span>TdsEnums</span>.<span>SQLNUMERICN</span> <span>==</span> <span>mt</span>.<span>TDSType</span>) <span>&amp;&amp;</span> (<span>8</span> <span>==</span> <span>length</span>))</td>
      </tr>
      <tr>
        <td id="L7164" data-line-number="7164"></td>
        <td id="LC7164">            {</td>
      </tr>
      <tr>
        <td id="L7165" data-line-number="7165"></td>
        <td id="LC7165">                <span><span>//</span> The caller will coerce all SqlTypes to native CLR types, which means SqlMoney will</span></td>
      </tr>
      <tr>
        <td id="L7166" data-line-number="7166"></td>
        <td id="LC7166">                <span><span>//</span> coerce to decimal/SQLNUMERICN (via SqlMoney.Value call).  In the case where the original</span></td>
      </tr>
      <tr>
        <td id="L7167" data-line-number="7167"></td>
        <td id="LC7167">                <span><span>//</span> value was SqlMoney the caller will also pass in the metadata length for the SqlMoney type</span></td>
      </tr>
      <tr>
        <td id="L7168" data-line-number="7168"></td>
        <td id="LC7168">                <span><span>//</span> which is 8 bytes.  To honor the intent of the caller here we coerce this special case</span></td>
      </tr>
      <tr>
        <td id="L7169" data-line-number="7169"></td>
        <td id="LC7169">                <span><span>//</span> input back to SqlMoney from decimal/SQLNUMERICN.</span></td>
      </tr>
      <tr>
        <td id="L7170" data-line-number="7170"></td>
        <td id="LC7170">                <span>mt</span> <span>=</span> <span>MetaType</span>.<span>GetMetaTypeFromValue</span>(<span>new</span> <span>SqlMoney</span>((<span>decimal</span>)<span>value</span>));</td>
      </tr>
      <tr>
        <td id="L7171" data-line-number="7171"></td>
        <td id="LC7171">            }</td>
      </tr>
      <tr>
        <td id="L7172" data-line-number="7172"></td>
        <td id="LC7172">
</td>
      </tr>
      <tr>
        <td id="L7173" data-line-number="7173"></td>
        <td id="LC7173">            <span>if</span> (<span>mt</span>.<span>IsAnsiType</span>)</td>
      </tr>
      <tr>
        <td id="L7174" data-line-number="7174"></td>
        <td id="LC7174">            {</td>
      </tr>
      <tr>
        <td id="L7175" data-line-number="7175"></td>
        <td id="LC7175">                <span>length</span> <span>=</span> <span>GetEncodingCharLength</span>((<span>string</span>)<span>value</span>, <span>length</span>, <span>0</span>, <span>_defaultEncoding</span>);</td>
      </tr>
      <tr>
        <td id="L7176" data-line-number="7176"></td>
        <td id="LC7176">            }</td>
      </tr>
      <tr>
        <td id="L7177" data-line-number="7177"></td>
        <td id="LC7177">
</td>
      </tr>
      <tr>
        <td id="L7178" data-line-number="7178"></td>
        <td id="LC7178">            <span><span>//</span> max and actual len are equal to</span></td>
      </tr>
      <tr>
        <td id="L7179" data-line-number="7179"></td>
        <td id="LC7179">            <span><span>//</span> SQLVARIANTSIZE {type (1 byte) + cbPropBytes (1 byte)} + cbPropBytes + length (actual length of data in bytes)</span></td>
      </tr>
      <tr>
        <td id="L7180" data-line-number="7180"></td>
        <td id="LC7180">            <span>WriteInt</span>(<span>TdsEnums</span>.<span>SQLVARIANT_SIZE</span> <span>+</span> <span>mt</span>.<span>PropBytes</span> <span>+</span> <span>length</span>, <span>stateObj</span>); <span><span>//</span> maxLen</span></td>
      </tr>
      <tr>
        <td id="L7181" data-line-number="7181"></td>
        <td id="LC7181">            <span>WriteInt</span>(<span>TdsEnums</span>.<span>SQLVARIANT_SIZE</span> <span>+</span> <span>mt</span>.<span>PropBytes</span> <span>+</span> <span>length</span>, <span>stateObj</span>); <span><span>//</span> actualLen</span></td>
      </tr>
      <tr>
        <td id="L7182" data-line-number="7182"></td>
        <td id="LC7182">
</td>
      </tr>
      <tr>
        <td id="L7183" data-line-number="7183"></td>
        <td id="LC7183">            <span><span>//</span> write the SQLVariant header (type and cbPropBytes)</span></td>
      </tr>
      <tr>
        <td id="L7184" data-line-number="7184"></td>
        <td id="LC7184">            <span>stateObj</span>.<span>WriteByte</span>(<span>mt</span>.<span>TDSType</span>);</td>
      </tr>
      <tr>
        <td id="L7185" data-line-number="7185"></td>
        <td id="LC7185">            <span>stateObj</span>.<span>WriteByte</span>(<span>mt</span>.<span>PropBytes</span>);</td>
      </tr>
      <tr>
        <td id="L7186" data-line-number="7186"></td>
        <td id="LC7186">
</td>
      </tr>
      <tr>
        <td id="L7187" data-line-number="7187"></td>
        <td id="LC7187">            <span><span>//</span> now write the actual PropBytes and data</span></td>
      </tr>
      <tr>
        <td id="L7188" data-line-number="7188"></td>
        <td id="LC7188">            <span>switch</span> (<span>mt</span>.<span>TDSType</span>)</td>
      </tr>
      <tr>
        <td id="L7189" data-line-number="7189"></td>
        <td id="LC7189">            {</td>
      </tr>
      <tr>
        <td id="L7190" data-line-number="7190"></td>
        <td id="LC7190">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT4</span>:</td>
      </tr>
      <tr>
        <td id="L7191" data-line-number="7191"></td>
        <td id="LC7191">                    <span>WriteFloat</span>((<span>Single</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7192" data-line-number="7192"></td>
        <td id="LC7192">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7193" data-line-number="7193"></td>
        <td id="LC7193">
</td>
      </tr>
      <tr>
        <td id="L7194" data-line-number="7194"></td>
        <td id="LC7194">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT8</span>:</td>
      </tr>
      <tr>
        <td id="L7195" data-line-number="7195"></td>
        <td id="LC7195">                    <span>WriteDouble</span>((<span>Double</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7196" data-line-number="7196"></td>
        <td id="LC7196">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7197" data-line-number="7197"></td>
        <td id="LC7197">
</td>
      </tr>
      <tr>
        <td id="L7198" data-line-number="7198"></td>
        <td id="LC7198">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT8</span>:</td>
      </tr>
      <tr>
        <td id="L7199" data-line-number="7199"></td>
        <td id="LC7199">                    <span>WriteLong</span>((<span>Int64</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7200" data-line-number="7200"></td>
        <td id="LC7200">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7201" data-line-number="7201"></td>
        <td id="LC7201">
</td>
      </tr>
      <tr>
        <td id="L7202" data-line-number="7202"></td>
        <td id="LC7202">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT4</span>:</td>
      </tr>
      <tr>
        <td id="L7203" data-line-number="7203"></td>
        <td id="LC7203">                    <span>WriteInt</span>((<span>Int32</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7204" data-line-number="7204"></td>
        <td id="LC7204">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7205" data-line-number="7205"></td>
        <td id="LC7205">
</td>
      </tr>
      <tr>
        <td id="L7206" data-line-number="7206"></td>
        <td id="LC7206">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT2</span>:</td>
      </tr>
      <tr>
        <td id="L7207" data-line-number="7207"></td>
        <td id="LC7207">                    <span>WriteShort</span>((<span>Int16</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7208" data-line-number="7208"></td>
        <td id="LC7208">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7209" data-line-number="7209"></td>
        <td id="LC7209">
</td>
      </tr>
      <tr>
        <td id="L7210" data-line-number="7210"></td>
        <td id="LC7210">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT1</span>:</td>
      </tr>
      <tr>
        <td id="L7211" data-line-number="7211"></td>
        <td id="LC7211">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7212" data-line-number="7212"></td>
        <td id="LC7212">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7213" data-line-number="7213"></td>
        <td id="LC7213">
</td>
      </tr>
      <tr>
        <td id="L7214" data-line-number="7214"></td>
        <td id="LC7214">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIT</span>:</td>
      </tr>
      <tr>
        <td id="L7215" data-line-number="7215"></td>
        <td id="LC7215">                    <span>if</span> ((<span>bool</span>)<span>value</span> <span>==</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L7216" data-line-number="7216"></td>
        <td id="LC7216">                        <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>);</td>
      </tr>
      <tr>
        <td id="L7217" data-line-number="7217"></td>
        <td id="LC7217">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L7218" data-line-number="7218"></td>
        <td id="LC7218">                        <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L7219" data-line-number="7219"></td>
        <td id="LC7219">
</td>
      </tr>
      <tr>
        <td id="L7220" data-line-number="7220"></td>
        <td id="LC7220">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7221" data-line-number="7221"></td>
        <td id="LC7221">
</td>
      </tr>
      <tr>
        <td id="L7222" data-line-number="7222"></td>
        <td id="LC7222">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L7223" data-line-number="7223"></td>
        <td id="LC7223">                    {</td>
      </tr>
      <tr>
        <td id="L7224" data-line-number="7224"></td>
        <td id="LC7224">                        <span>byte</span>[] <span>b</span> <span>=</span> (<span>byte</span>[])<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7225" data-line-number="7225"></td>
        <td id="LC7225">
</td>
      </tr>
      <tr>
        <td id="L7226" data-line-number="7226"></td>
        <td id="LC7226">                        <span>WriteShort</span>(<span>length</span>, <span>stateObj</span>); <span><span>//</span> propbytes: varlen</span></td>
      </tr>
      <tr>
        <td id="L7227" data-line-number="7227"></td>
        <td id="LC7227">                        <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>(<span>b</span>, <span>length</span>, <span>offset</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7228" data-line-number="7228"></td>
        <td id="LC7228">                    }</td>
      </tr>
      <tr>
        <td id="L7229" data-line-number="7229"></td>
        <td id="LC7229">
</td>
      </tr>
      <tr>
        <td id="L7230" data-line-number="7230"></td>
        <td id="LC7230">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7231" data-line-number="7231"></td>
        <td id="LC7231">                    {</td>
      </tr>
      <tr>
        <td id="L7232" data-line-number="7232"></td>
        <td id="LC7232">                        <span>string</span> <span>s</span> <span>=</span> (<span>string</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7233" data-line-number="7233"></td>
        <td id="LC7233">
</td>
      </tr>
      <tr>
        <td id="L7234" data-line-number="7234"></td>
        <td id="LC7234">                        <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> propbytes: collation.Info</span></td>
      </tr>
      <tr>
        <td id="L7235" data-line-number="7235"></td>
        <td id="LC7235">                        <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>); <span><span>//</span> propbytes: collation.SortId</span></td>
      </tr>
      <tr>
        <td id="L7236" data-line-number="7236"></td>
        <td id="LC7236">                        <span>WriteShort</span>(<span>length</span>, <span>stateObj</span>); <span><span>//</span> propbyte: varlen</span></td>
      </tr>
      <tr>
        <td id="L7237" data-line-number="7237"></td>
        <td id="LC7237">                        <span>return</span> <span>WriteEncodingChar</span>(<span>s</span>, <span>_defaultEncoding</span>, <span>stateObj</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7238" data-line-number="7238"></td>
        <td id="LC7238">                    }</td>
      </tr>
      <tr>
        <td id="L7239" data-line-number="7239"></td>
        <td id="LC7239">
</td>
      </tr>
      <tr>
        <td id="L7240" data-line-number="7240"></td>
        <td id="LC7240">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L7241" data-line-number="7241"></td>
        <td id="LC7241">                    {</td>
      </tr>
      <tr>
        <td id="L7242" data-line-number="7242"></td>
        <td id="LC7242">                        <span>System</span>.<span>Guid</span> <span>guid</span> <span>=</span> (<span>System</span>.<span>Guid</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7243" data-line-number="7243"></td>
        <td id="LC7243">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>guid</span>.<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L7244" data-line-number="7244"></td>
        <td id="LC7244">
</td>
      </tr>
      <tr>
        <td id="L7245" data-line-number="7245"></td>
        <td id="LC7245">                        <span>Debug</span>.<span>Assert</span>((<span>length</span> <span>==</span> <span>b</span>.<span>Length</span>) <span>&amp;&amp;</span> (<span>length</span> <span>==</span> <span>16</span>), <span><span>"</span>Invalid length for guid type in com+ object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7246" data-line-number="7246"></td>
        <td id="LC7246">                        <span>stateObj</span>.<span>WriteByteArray</span>(<span>b</span>, <span>length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L7247" data-line-number="7247"></td>
        <td id="LC7247">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7248" data-line-number="7248"></td>
        <td id="LC7248">                    }</td>
      </tr>
      <tr>
        <td id="L7249" data-line-number="7249"></td>
        <td id="LC7249">
</td>
      </tr>
      <tr>
        <td id="L7250" data-line-number="7250"></td>
        <td id="LC7250">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7251" data-line-number="7251"></td>
        <td id="LC7251">                    {</td>
      </tr>
      <tr>
        <td id="L7252" data-line-number="7252"></td>
        <td id="LC7252">                        <span>string</span> <span>s</span> <span>=</span> (<span>string</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7253" data-line-number="7253"></td>
        <td id="LC7253">
</td>
      </tr>
      <tr>
        <td id="L7254" data-line-number="7254"></td>
        <td id="LC7254">                        <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> propbytes: collation.Info</span></td>
      </tr>
      <tr>
        <td id="L7255" data-line-number="7255"></td>
        <td id="LC7255">                        <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>); <span><span>//</span> propbytes: collation.SortId</span></td>
      </tr>
      <tr>
        <td id="L7256" data-line-number="7256"></td>
        <td id="LC7256">                        <span>WriteShort</span>(<span>length</span>, <span>stateObj</span>); <span><span>//</span> propbyte: varlen</span></td>
      </tr>
      <tr>
        <td id="L7257" data-line-number="7257"></td>
        <td id="LC7257">
</td>
      </tr>
      <tr>
        <td id="L7258" data-line-number="7258"></td>
        <td id="LC7258">                        <span><span>//</span> string takes cchar, not cbyte so convert</span></td>
      </tr>
      <tr>
        <td id="L7259" data-line-number="7259"></td>
        <td id="LC7259">                        <span>length</span> <span>&gt;&gt;=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L7260" data-line-number="7260"></td>
        <td id="LC7260">                        <span>return</span> <span>WriteString</span>(<span>s</span>, <span>length</span>, <span>offset</span>, <span>stateObj</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7261" data-line-number="7261"></td>
        <td id="LC7261">                    }</td>
      </tr>
      <tr>
        <td id="L7262" data-line-number="7262"></td>
        <td id="LC7262">
</td>
      </tr>
      <tr>
        <td id="L7263" data-line-number="7263"></td>
        <td id="LC7263">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME</span>:</td>
      </tr>
      <tr>
        <td id="L7264" data-line-number="7264"></td>
        <td id="LC7264">                    {</td>
      </tr>
      <tr>
        <td id="L7265" data-line-number="7265"></td>
        <td id="LC7265">                        <span>TdsDateTime</span> <span>dt</span> <span>=</span> <span>MetaType</span>.<span>FromDateTime</span>((<span>DateTime</span>)<span>value</span>, <span>8</span>);</td>
      </tr>
      <tr>
        <td id="L7266" data-line-number="7266"></td>
        <td id="LC7266">
</td>
      </tr>
      <tr>
        <td id="L7267" data-line-number="7267"></td>
        <td id="LC7267">                        <span>WriteInt</span>(<span>dt</span>.<span>days</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7268" data-line-number="7268"></td>
        <td id="LC7268">                        <span>WriteInt</span>(<span>dt</span>.<span>time</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7269" data-line-number="7269"></td>
        <td id="LC7269">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7270" data-line-number="7270"></td>
        <td id="LC7270">                    }</td>
      </tr>
      <tr>
        <td id="L7271" data-line-number="7271"></td>
        <td id="LC7271">
</td>
      </tr>
      <tr>
        <td id="L7272" data-line-number="7272"></td>
        <td id="LC7272">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY</span>:</td>
      </tr>
      <tr>
        <td id="L7273" data-line-number="7273"></td>
        <td id="LC7273">                    {</td>
      </tr>
      <tr>
        <td id="L7274" data-line-number="7274"></td>
        <td id="LC7274">                        <span>WriteCurrency</span>((<span>Decimal</span>)<span>value</span>, <span>8</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7275" data-line-number="7275"></td>
        <td id="LC7275">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7276" data-line-number="7276"></td>
        <td id="LC7276">                    }</td>
      </tr>
      <tr>
        <td id="L7277" data-line-number="7277"></td>
        <td id="LC7277">
</td>
      </tr>
      <tr>
        <td id="L7278" data-line-number="7278"></td>
        <td id="LC7278">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L7279" data-line-number="7279"></td>
        <td id="LC7279">                    {</td>
      </tr>
      <tr>
        <td id="L7280" data-line-number="7280"></td>
        <td id="LC7280">                        <span>stateObj</span>.<span>WriteByte</span>(<span>mt</span>.<span>Precision</span>); <span><span>//</span>propbytes: precision</span></td>
      </tr>
      <tr>
        <td id="L7281" data-line-number="7281"></td>
        <td id="LC7281">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>Decimal</span>.<span>GetBits</span>((<span>Decimal</span>)<span>value</span>)[<span>3</span>] <span>&amp;</span> <span>0x00ff0000</span>) <span>&gt;&gt;</span> <span>0x10</span>)); <span><span>//</span> propbytes: scale</span></td>
      </tr>
      <tr>
        <td id="L7282" data-line-number="7282"></td>
        <td id="LC7282">                        <span>WriteDecimal</span>((<span>Decimal</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7283" data-line-number="7283"></td>
        <td id="LC7283">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7284" data-line-number="7284"></td>
        <td id="LC7284">                    }</td>
      </tr>
      <tr>
        <td id="L7285" data-line-number="7285"></td>
        <td id="LC7285">
</td>
      </tr>
      <tr>
        <td id="L7286" data-line-number="7286"></td>
        <td id="LC7286">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L7287" data-line-number="7287"></td>
        <td id="LC7287">                    <span>stateObj</span>.<span>WriteByte</span>(<span>mt</span>.<span>Scale</span>); <span><span>//</span>propbytes: scale</span></td>
      </tr>
      <tr>
        <td id="L7288" data-line-number="7288"></td>
        <td id="LC7288">                    <span>WriteTime</span>((<span>TimeSpan</span>)<span>value</span>, <span>mt</span>.<span>Scale</span>, <span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7289" data-line-number="7289"></td>
        <td id="LC7289">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7290" data-line-number="7290"></td>
        <td id="LC7290">
</td>
      </tr>
      <tr>
        <td id="L7291" data-line-number="7291"></td>
        <td id="LC7291">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L7292" data-line-number="7292"></td>
        <td id="LC7292">                    <span>stateObj</span>.<span>WriteByte</span>(<span>mt</span>.<span>Scale</span>); <span><span>//</span>propbytes: scale</span></td>
      </tr>
      <tr>
        <td id="L7293" data-line-number="7293"></td>
        <td id="LC7293">                    <span>WriteDateTimeOffset</span>((<span>DateTimeOffset</span>)<span>value</span>, <span>mt</span>.<span>Scale</span>, <span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7294" data-line-number="7294"></td>
        <td id="LC7294">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7295" data-line-number="7295"></td>
        <td id="LC7295">
</td>
      </tr>
      <tr>
        <td id="L7296" data-line-number="7296"></td>
        <td id="LC7296">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L7297" data-line-number="7297"></td>
        <td id="LC7297">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>unknown tds type for sqlvariant!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7298" data-line-number="7298"></td>
        <td id="LC7298">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7299" data-line-number="7299"></td>
        <td id="LC7299">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L7300" data-line-number="7300"></td>
        <td id="LC7300">            <span><span>//</span> return point for accumulated writes, note: non-accumulated writes returned from their case statements</span></td>
      </tr>
      <tr>
        <td id="L7301" data-line-number="7301"></td>
        <td id="LC7301">            <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L7302" data-line-number="7302"></td>
        <td id="LC7302">        }</td>
      </tr>
      <tr>
        <td id="L7303" data-line-number="7303"></td>
        <td id="LC7303">
</td>
      </tr>
      <tr>
        <td id="L7304" data-line-number="7304"></td>
        <td id="LC7304">        <span><span>//</span> todo: since we now know the difference between SqlWriteVariantValue and SqlWriteRowDataVariant we should consider</span></td>
      </tr>
      <tr>
        <td id="L7305" data-line-number="7305"></td>
        <td id="LC7305">        <span><span>//</span> combining these tow methods.</span></td>
      </tr>
      <tr>
        <td id="L7306" data-line-number="7306"></td>
        <td id="LC7306">
</td>
      </tr>
      <tr>
        <td id="L7307" data-line-number="7307"></td>
        <td id="LC7307">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L7308" data-line-number="7308"></td>
        <td id="LC7308">        <span><span>//</span> Translates a com+ object -&gt; SqlVariant</span></td>
      </tr>
      <tr>
        <td id="L7309" data-line-number="7309"></td>
        <td id="LC7309">        <span><span>//</span> when the type is ambiguous, we always convert to the bigger type</span></td>
      </tr>
      <tr>
        <td id="L7310" data-line-number="7310"></td>
        <td id="LC7310">        <span><span>//</span> note that we also write out the maxlen and actuallen members (4 bytes each)</span></td>
      </tr>
      <tr>
        <td id="L7311" data-line-number="7311"></td>
        <td id="LC7311">        <span><span>//</span> in addition to the SQLVariant structure</span></td>
      </tr>
      <tr>
        <td id="L7312" data-line-number="7312"></td>
        <td id="LC7312">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L7313" data-line-number="7313"></td>
        <td id="LC7313">        <span><span>//</span> Devnote: DataRows are preceeded by Metadata. The Metadata includes the MaxLen value.</span></td>
      </tr>
      <tr>
        <td id="L7314" data-line-number="7314"></td>
        <td id="LC7314">        <span><span>//</span> Therefore the sql_variant value must not include the MaxLength. This is the major difference</span></td>
      </tr>
      <tr>
        <td id="L7315" data-line-number="7315"></td>
        <td id="LC7315">        <span><span>//</span> between this method and WriteSqlVariantValue above.</span></td>
      </tr>
      <tr>
        <td id="L7316" data-line-number="7316"></td>
        <td id="LC7316">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L7317" data-line-number="7317"></td>
        <td id="LC7317">        <span>internal</span> <span>Task</span> <span>WriteSqlVariantDataRowValue</span>(<span>object</span> <span>value</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>canAccumulate</span> <span>=</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L7318" data-line-number="7318"></td>
        <td id="LC7318">        {</td>
      </tr>
      <tr>
        <td id="L7319" data-line-number="7319"></td>
        <td id="LC7319">            <span>Debug</span>.<span>Assert</span>(<span>_isShiloh</span> <span>==</span> <span>true</span>, <span><span>"</span>Shouldn't be dealing with sql_variant in pre-SQL2000 server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7320" data-line-number="7320"></td>
        <td id="LC7320">
</td>
      </tr>
      <tr>
        <td id="L7321" data-line-number="7321"></td>
        <td id="LC7321">            <span><span>//</span> handle null values</span></td>
      </tr>
      <tr>
        <td id="L7322" data-line-number="7322"></td>
        <td id="LC7322">            <span>if</span> ((<span>null</span> <span>==</span> <span>value</span>) <span>||</span> (<span>DBNull</span>.<span>Value</span> <span>==</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L7323" data-line-number="7323"></td>
        <td id="LC7323">            {</td>
      </tr>
      <tr>
        <td id="L7324" data-line-number="7324"></td>
        <td id="LC7324">                <span>WriteInt</span>(<span>TdsEnums</span>.<span>FIXEDNULL</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7325" data-line-number="7325"></td>
        <td id="LC7325">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L7326" data-line-number="7326"></td>
        <td id="LC7326">            }</td>
      </tr>
      <tr>
        <td id="L7327" data-line-number="7327"></td>
        <td id="LC7327">
</td>
      </tr>
      <tr>
        <td id="L7328" data-line-number="7328"></td>
        <td id="LC7328">            <span>MetaType</span> <span>metatype</span> <span>=</span> <span>MetaType</span>.<span>GetMetaTypeFromValue</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7329" data-line-number="7329"></td>
        <td id="LC7329">            <span>int</span> <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7330" data-line-number="7330"></td>
        <td id="LC7330">
</td>
      </tr>
      <tr>
        <td id="L7331" data-line-number="7331"></td>
        <td id="LC7331">            <span>if</span> (<span>metatype</span>.<span>IsAnsiType</span>)</td>
      </tr>
      <tr>
        <td id="L7332" data-line-number="7332"></td>
        <td id="LC7332">            {</td>
      </tr>
      <tr>
        <td id="L7333" data-line-number="7333"></td>
        <td id="LC7333">                <span>length</span> <span>=</span> <span>GetEncodingCharLength</span>((<span>string</span>)<span>value</span>, <span>length</span>, <span>0</span>, <span>_defaultEncoding</span>);</td>
      </tr>
      <tr>
        <td id="L7334" data-line-number="7334"></td>
        <td id="LC7334">            }</td>
      </tr>
      <tr>
        <td id="L7335" data-line-number="7335"></td>
        <td id="LC7335">
</td>
      </tr>
      <tr>
        <td id="L7336" data-line-number="7336"></td>
        <td id="LC7336">            <span>switch</span> (<span>metatype</span>.<span>TDSType</span>)</td>
      </tr>
      <tr>
        <td id="L7337" data-line-number="7337"></td>
        <td id="LC7337">            {</td>
      </tr>
      <tr>
        <td id="L7338" data-line-number="7338"></td>
        <td id="LC7338">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT4</span>:</td>
      </tr>
      <tr>
        <td id="L7339" data-line-number="7339"></td>
        <td id="LC7339">                    <span>WriteSqlVariantHeader</span>(<span>6</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7340" data-line-number="7340"></td>
        <td id="LC7340">                    <span>WriteFloat</span>((<span>Single</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7341" data-line-number="7341"></td>
        <td id="LC7341">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7342" data-line-number="7342"></td>
        <td id="LC7342">
</td>
      </tr>
      <tr>
        <td id="L7343" data-line-number="7343"></td>
        <td id="LC7343">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLT8</span>:</td>
      </tr>
      <tr>
        <td id="L7344" data-line-number="7344"></td>
        <td id="LC7344">                    <span>WriteSqlVariantHeader</span>(<span>10</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7345" data-line-number="7345"></td>
        <td id="LC7345">                    <span>WriteDouble</span>((<span>Double</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7346" data-line-number="7346"></td>
        <td id="LC7346">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7347" data-line-number="7347"></td>
        <td id="LC7347">
</td>
      </tr>
      <tr>
        <td id="L7348" data-line-number="7348"></td>
        <td id="LC7348">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT8</span>:</td>
      </tr>
      <tr>
        <td id="L7349" data-line-number="7349"></td>
        <td id="LC7349">                    <span>WriteSqlVariantHeader</span>(<span>10</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7350" data-line-number="7350"></td>
        <td id="LC7350">                    <span>WriteLong</span>((<span>Int64</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7351" data-line-number="7351"></td>
        <td id="LC7351">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7352" data-line-number="7352"></td>
        <td id="LC7352">
</td>
      </tr>
      <tr>
        <td id="L7353" data-line-number="7353"></td>
        <td id="LC7353">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT4</span>:</td>
      </tr>
      <tr>
        <td id="L7354" data-line-number="7354"></td>
        <td id="LC7354">                    <span>WriteSqlVariantHeader</span>(<span>6</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7355" data-line-number="7355"></td>
        <td id="LC7355">                    <span>WriteInt</span>((<span>Int32</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7356" data-line-number="7356"></td>
        <td id="LC7356">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7357" data-line-number="7357"></td>
        <td id="LC7357">
</td>
      </tr>
      <tr>
        <td id="L7358" data-line-number="7358"></td>
        <td id="LC7358">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT2</span>:</td>
      </tr>
      <tr>
        <td id="L7359" data-line-number="7359"></td>
        <td id="LC7359">                    <span>WriteSqlVariantHeader</span>(<span>4</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7360" data-line-number="7360"></td>
        <td id="LC7360">                    <span>WriteShort</span>((<span>Int16</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7361" data-line-number="7361"></td>
        <td id="LC7361">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7362" data-line-number="7362"></td>
        <td id="LC7362">
</td>
      </tr>
      <tr>
        <td id="L7363" data-line-number="7363"></td>
        <td id="LC7363">                <span>case</span> <span>TdsEnums</span>.<span>SQLINT1</span>:</td>
      </tr>
      <tr>
        <td id="L7364" data-line-number="7364"></td>
        <td id="LC7364">                    <span>WriteSqlVariantHeader</span>(<span>3</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7365" data-line-number="7365"></td>
        <td id="LC7365">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7366" data-line-number="7366"></td>
        <td id="LC7366">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7367" data-line-number="7367"></td>
        <td id="LC7367">
</td>
      </tr>
      <tr>
        <td id="L7368" data-line-number="7368"></td>
        <td id="LC7368">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIT</span>:</td>
      </tr>
      <tr>
        <td id="L7369" data-line-number="7369"></td>
        <td id="LC7369">                    <span>WriteSqlVariantHeader</span>(<span>3</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7370" data-line-number="7370"></td>
        <td id="LC7370">                    <span>if</span> ((<span>bool</span>)<span>value</span> <span>==</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L7371" data-line-number="7371"></td>
        <td id="LC7371">                        <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>);</td>
      </tr>
      <tr>
        <td id="L7372" data-line-number="7372"></td>
        <td id="LC7372">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L7373" data-line-number="7373"></td>
        <td id="LC7373">                        <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L7374" data-line-number="7374"></td>
        <td id="LC7374">
</td>
      </tr>
      <tr>
        <td id="L7375" data-line-number="7375"></td>
        <td id="LC7375">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7376" data-line-number="7376"></td>
        <td id="LC7376">
</td>
      </tr>
      <tr>
        <td id="L7377" data-line-number="7377"></td>
        <td id="LC7377">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L7378" data-line-number="7378"></td>
        <td id="LC7378">                    {</td>
      </tr>
      <tr>
        <td id="L7379" data-line-number="7379"></td>
        <td id="LC7379">                        <span>byte</span>[] <span>b</span> <span>=</span> (<span>byte</span>[])<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7380" data-line-number="7380"></td>
        <td id="LC7380">
</td>
      </tr>
      <tr>
        <td id="L7381" data-line-number="7381"></td>
        <td id="LC7381">                        <span>length</span> <span>=</span> <span>b</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L7382" data-line-number="7382"></td>
        <td id="LC7382">                        <span>WriteSqlVariantHeader</span>(<span>4</span> <span>+</span> <span>length</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7383" data-line-number="7383"></td>
        <td id="LC7383">                        <span>WriteShort</span>(<span>length</span>, <span>stateObj</span>); <span><span>//</span> propbytes: varlen</span></td>
      </tr>
      <tr>
        <td id="L7384" data-line-number="7384"></td>
        <td id="LC7384">                        <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>(<span>b</span>, <span>length</span>, <span>0</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7385" data-line-number="7385"></td>
        <td id="LC7385">                    }</td>
      </tr>
      <tr>
        <td id="L7386" data-line-number="7386"></td>
        <td id="LC7386">
</td>
      </tr>
      <tr>
        <td id="L7387" data-line-number="7387"></td>
        <td id="LC7387">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7388" data-line-number="7388"></td>
        <td id="LC7388">                    {</td>
      </tr>
      <tr>
        <td id="L7389" data-line-number="7389"></td>
        <td id="LC7389">                        <span>string</span> <span>s</span> <span>=</span> (<span>string</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7390" data-line-number="7390"></td>
        <td id="LC7390">
</td>
      </tr>
      <tr>
        <td id="L7391" data-line-number="7391"></td>
        <td id="LC7391">                        <span>length</span> <span>=</span> <span>s</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L7392" data-line-number="7392"></td>
        <td id="LC7392">                        <span>WriteSqlVariantHeader</span>(<span>9</span> <span>+</span> <span>length</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7393" data-line-number="7393"></td>
        <td id="LC7393">                        <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> propbytes: collation.Info</span></td>
      </tr>
      <tr>
        <td id="L7394" data-line-number="7394"></td>
        <td id="LC7394">                        <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>); <span><span>//</span> propbytes: collation.SortId</span></td>
      </tr>
      <tr>
        <td id="L7395" data-line-number="7395"></td>
        <td id="LC7395">                        <span>WriteShort</span>(<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7396" data-line-number="7396"></td>
        <td id="LC7396">                        <span>return</span> <span>WriteEncodingChar</span>(<span>s</span>, <span>_defaultEncoding</span>, <span>stateObj</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7397" data-line-number="7397"></td>
        <td id="LC7397">                    }</td>
      </tr>
      <tr>
        <td id="L7398" data-line-number="7398"></td>
        <td id="LC7398">
</td>
      </tr>
      <tr>
        <td id="L7399" data-line-number="7399"></td>
        <td id="LC7399">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L7400" data-line-number="7400"></td>
        <td id="LC7400">                    {</td>
      </tr>
      <tr>
        <td id="L7401" data-line-number="7401"></td>
        <td id="LC7401">                        <span>System</span>.<span>Guid</span> <span>guid</span> <span>=</span> (<span>System</span>.<span>Guid</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7402" data-line-number="7402"></td>
        <td id="LC7402">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>guid</span>.<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L7403" data-line-number="7403"></td>
        <td id="LC7403">
</td>
      </tr>
      <tr>
        <td id="L7404" data-line-number="7404"></td>
        <td id="LC7404">                        <span>length</span> <span>=</span> <span>b</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L7405" data-line-number="7405"></td>
        <td id="LC7405">                        <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>16</span>, <span><span>"</span>Invalid length for guid type in com+ object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7406" data-line-number="7406"></td>
        <td id="LC7406">                        <span>WriteSqlVariantHeader</span>(<span>18</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7407" data-line-number="7407"></td>
        <td id="LC7407">                        <span>stateObj</span>.<span>WriteByteArray</span>(<span>b</span>, <span>length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L7408" data-line-number="7408"></td>
        <td id="LC7408">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7409" data-line-number="7409"></td>
        <td id="LC7409">                    }</td>
      </tr>
      <tr>
        <td id="L7410" data-line-number="7410"></td>
        <td id="LC7410">
</td>
      </tr>
      <tr>
        <td id="L7411" data-line-number="7411"></td>
        <td id="LC7411">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L7412" data-line-number="7412"></td>
        <td id="LC7412">                    {</td>
      </tr>
      <tr>
        <td id="L7413" data-line-number="7413"></td>
        <td id="LC7413">                        <span>string</span> <span>s</span> <span>=</span> (<span>string</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7414" data-line-number="7414"></td>
        <td id="LC7414">
</td>
      </tr>
      <tr>
        <td id="L7415" data-line-number="7415"></td>
        <td id="LC7415">                        <span>length</span> <span>=</span> <span>s</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L7416" data-line-number="7416"></td>
        <td id="LC7416">                        <span>WriteSqlVariantHeader</span>(<span>9</span> <span>+</span> <span>length</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7417" data-line-number="7417"></td>
        <td id="LC7417">                        <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> propbytes: collation.Info</span></td>
      </tr>
      <tr>
        <td id="L7418" data-line-number="7418"></td>
        <td id="LC7418">                        <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>); <span><span>//</span> propbytes: collation.SortId</span></td>
      </tr>
      <tr>
        <td id="L7419" data-line-number="7419"></td>
        <td id="LC7419">                        <span>WriteShort</span>(<span>length</span>, <span>stateObj</span>); <span><span>//</span> propbyte: varlen</span></td>
      </tr>
      <tr>
        <td id="L7420" data-line-number="7420"></td>
        <td id="LC7420">
</td>
      </tr>
      <tr>
        <td id="L7421" data-line-number="7421"></td>
        <td id="LC7421">                        <span><span>//</span> string takes cchar, not cbyte so convert</span></td>
      </tr>
      <tr>
        <td id="L7422" data-line-number="7422"></td>
        <td id="LC7422">                        <span>length</span> <span>&gt;&gt;=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L7423" data-line-number="7423"></td>
        <td id="LC7423">                        <span>return</span> <span>WriteString</span>(<span>s</span>, <span>length</span>, <span>0</span>, <span>stateObj</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7424" data-line-number="7424"></td>
        <td id="LC7424">                    }</td>
      </tr>
      <tr>
        <td id="L7425" data-line-number="7425"></td>
        <td id="LC7425">
</td>
      </tr>
      <tr>
        <td id="L7426" data-line-number="7426"></td>
        <td id="LC7426">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME</span>:</td>
      </tr>
      <tr>
        <td id="L7427" data-line-number="7427"></td>
        <td id="LC7427">                    {</td>
      </tr>
      <tr>
        <td id="L7428" data-line-number="7428"></td>
        <td id="LC7428">                        <span>TdsDateTime</span> <span>dt</span> <span>=</span> <span>MetaType</span>.<span>FromDateTime</span>((<span>DateTime</span>)<span>value</span>, <span>8</span>);</td>
      </tr>
      <tr>
        <td id="L7429" data-line-number="7429"></td>
        <td id="LC7429">
</td>
      </tr>
      <tr>
        <td id="L7430" data-line-number="7430"></td>
        <td id="LC7430">                        <span>WriteSqlVariantHeader</span>(<span>10</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7431" data-line-number="7431"></td>
        <td id="LC7431">                        <span>WriteInt</span>(<span>dt</span>.<span>days</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7432" data-line-number="7432"></td>
        <td id="LC7432">                        <span>WriteInt</span>(<span>dt</span>.<span>time</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7433" data-line-number="7433"></td>
        <td id="LC7433">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7434" data-line-number="7434"></td>
        <td id="LC7434">                    }</td>
      </tr>
      <tr>
        <td id="L7435" data-line-number="7435"></td>
        <td id="LC7435">
</td>
      </tr>
      <tr>
        <td id="L7436" data-line-number="7436"></td>
        <td id="LC7436">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEY</span>:</td>
      </tr>
      <tr>
        <td id="L7437" data-line-number="7437"></td>
        <td id="LC7437">                    {</td>
      </tr>
      <tr>
        <td id="L7438" data-line-number="7438"></td>
        <td id="LC7438">                        <span>WriteSqlVariantHeader</span>(<span>10</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7439" data-line-number="7439"></td>
        <td id="LC7439">                        <span>WriteCurrency</span>((<span>Decimal</span>)<span>value</span>, <span>8</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7440" data-line-number="7440"></td>
        <td id="LC7440">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7441" data-line-number="7441"></td>
        <td id="LC7441">                    }</td>
      </tr>
      <tr>
        <td id="L7442" data-line-number="7442"></td>
        <td id="LC7442">
</td>
      </tr>
      <tr>
        <td id="L7443" data-line-number="7443"></td>
        <td id="LC7443">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L7444" data-line-number="7444"></td>
        <td id="LC7444">                    {</td>
      </tr>
      <tr>
        <td id="L7445" data-line-number="7445"></td>
        <td id="LC7445">                        <span>WriteSqlVariantHeader</span>(<span>21</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7446" data-line-number="7446"></td>
        <td id="LC7446">                        <span>stateObj</span>.<span>WriteByte</span>(<span>metatype</span>.<span>Precision</span>); <span><span>//</span>propbytes: precision</span></td>
      </tr>
      <tr>
        <td id="L7447" data-line-number="7447"></td>
        <td id="LC7447">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>Decimal</span>.<span>GetBits</span>((<span>Decimal</span>)<span>value</span>)[<span>3</span>] <span>&amp;</span> <span>0x00ff0000</span>) <span>&gt;&gt;</span> <span>0x10</span>)); <span><span>//</span> propbytes: scale</span></td>
      </tr>
      <tr>
        <td id="L7448" data-line-number="7448"></td>
        <td id="LC7448">                        <span>WriteDecimal</span>((<span>Decimal</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7449" data-line-number="7449"></td>
        <td id="LC7449">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7450" data-line-number="7450"></td>
        <td id="LC7450">                    }</td>
      </tr>
      <tr>
        <td id="L7451" data-line-number="7451"></td>
        <td id="LC7451">
</td>
      </tr>
      <tr>
        <td id="L7452" data-line-number="7452"></td>
        <td id="LC7452">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L7453" data-line-number="7453"></td>
        <td id="LC7453">                    <span>WriteSqlVariantHeader</span>(<span>8</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7454" data-line-number="7454"></td>
        <td id="LC7454">                    <span>stateObj</span>.<span>WriteByte</span>(<span>metatype</span>.<span>Scale</span>); <span><span>//</span>propbytes: scale</span></td>
      </tr>
      <tr>
        <td id="L7455" data-line-number="7455"></td>
        <td id="LC7455">                    <span>WriteTime</span>((<span>TimeSpan</span>)<span>value</span>, <span>metatype</span>.<span>Scale</span>, <span>5</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7456" data-line-number="7456"></td>
        <td id="LC7456">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7457" data-line-number="7457"></td>
        <td id="LC7457">
</td>
      </tr>
      <tr>
        <td id="L7458" data-line-number="7458"></td>
        <td id="LC7458">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L7459" data-line-number="7459"></td>
        <td id="LC7459">                    <span>WriteSqlVariantHeader</span>(<span>13</span>, <span>metatype</span>.<span>TDSType</span>, <span>metatype</span>.<span>PropBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7460" data-line-number="7460"></td>
        <td id="LC7460">                    <span>stateObj</span>.<span>WriteByte</span>(<span>metatype</span>.<span>Scale</span>); <span><span>//</span>propbytes: scale</span></td>
      </tr>
      <tr>
        <td id="L7461" data-line-number="7461"></td>
        <td id="LC7461">                    <span>WriteDateTimeOffset</span>((<span>DateTimeOffset</span>)<span>value</span>, <span>metatype</span>.<span>Scale</span>, <span>10</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7462" data-line-number="7462"></td>
        <td id="LC7462">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7463" data-line-number="7463"></td>
        <td id="LC7463">
</td>
      </tr>
      <tr>
        <td id="L7464" data-line-number="7464"></td>
        <td id="LC7464">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L7465" data-line-number="7465"></td>
        <td id="LC7465">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>unknown tds type for sqlvariant!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7466" data-line-number="7466"></td>
        <td id="LC7466">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L7467" data-line-number="7467"></td>
        <td id="LC7467">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L7468" data-line-number="7468"></td>
        <td id="LC7468">            <span><span>//</span> return point for accumualated writes, note: non-accumulated writes returned from their case statements</span></td>
      </tr>
      <tr>
        <td id="L7469" data-line-number="7469"></td>
        <td id="LC7469">            <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L7470" data-line-number="7470"></td>
        <td id="LC7470">        }</td>
      </tr>
      <tr>
        <td id="L7471" data-line-number="7471"></td>
        <td id="LC7471">
</td>
      </tr>
      <tr>
        <td id="L7472" data-line-number="7472"></td>
        <td id="LC7472">        <span>internal</span> <span>void</span> <span>WriteSqlVariantHeader</span>(<span>int</span> <span>length</span>, <span>byte</span> <span>tdstype</span>, <span>byte</span> <span>propbytes</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7473" data-line-number="7473"></td>
        <td id="LC7473">        {</td>
      </tr>
      <tr>
        <td id="L7474" data-line-number="7474"></td>
        <td id="LC7474">            <span>WriteInt</span>(<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7475" data-line-number="7475"></td>
        <td id="LC7475">            <span>stateObj</span>.<span>WriteByte</span>(<span>tdstype</span>);</td>
      </tr>
      <tr>
        <td id="L7476" data-line-number="7476"></td>
        <td id="LC7476">            <span>stateObj</span>.<span>WriteByte</span>(<span>propbytes</span>);</td>
      </tr>
      <tr>
        <td id="L7477" data-line-number="7477"></td>
        <td id="LC7477">        }</td>
      </tr>
      <tr>
        <td id="L7478" data-line-number="7478"></td>
        <td id="LC7478">
</td>
      </tr>
      <tr>
        <td id="L7479" data-line-number="7479"></td>
        <td id="LC7479">        <span>internal</span> <span>void</span> <span>WriteSqlVariantDateTime2</span>(<span>DateTime</span> <span>value</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7480" data-line-number="7480"></td>
        <td id="LC7480">        {</td>
      </tr>
      <tr>
        <td id="L7481" data-line-number="7481"></td>
        <td id="LC7481">            <span>SmiMetaData</span> <span>dateTime2MetaData</span> <span>=</span> <span>SmiMetaData</span>.<span>DefaultDateTime2</span>;</td>
      </tr>
      <tr>
        <td id="L7482" data-line-number="7482"></td>
        <td id="LC7482">            <span><span>//</span> NOTE: 3 bytes added here to support additional header information for variant - internal type, scale prop, scale</span></td>
      </tr>
      <tr>
        <td id="L7483" data-line-number="7483"></td>
        <td id="LC7483">            <span>WriteSqlVariantHeader</span>((<span>int</span>)(<span>dateTime2MetaData</span>.<span>MaxLength</span> <span>+</span> <span>3</span>), <span>TdsEnums</span>.<span>SQLDATETIME2</span>, <span>1</span> <span><span>/*</span> one scale prop <span>*/</span></span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7484" data-line-number="7484"></td>
        <td id="LC7484">            <span>stateObj</span>.<span>WriteByte</span>(<span>dateTime2MetaData</span>.<span>Scale</span>); <span><span>//</span>scale property</span></td>
      </tr>
      <tr>
        <td id="L7485" data-line-number="7485"></td>
        <td id="LC7485">            <span>WriteDateTime2</span>(<span>value</span>, <span>dateTime2MetaData</span>.<span>Scale</span>, (<span>int</span>)(<span>dateTime2MetaData</span>.<span>MaxLength</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7486" data-line-number="7486"></td>
        <td id="LC7486">        }</td>
      </tr>
      <tr>
        <td id="L7487" data-line-number="7487"></td>
        <td id="LC7487">
</td>
      </tr>
      <tr>
        <td id="L7488" data-line-number="7488"></td>
        <td id="LC7488">        <span>internal</span> <span>void</span> <span>WriteSqlVariantDate</span>(<span>DateTime</span> <span>value</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7489" data-line-number="7489"></td>
        <td id="LC7489">        {</td>
      </tr>
      <tr>
        <td id="L7490" data-line-number="7490"></td>
        <td id="LC7490">            <span>SmiMetaData</span> <span>dateMetaData</span> <span>=</span> <span>SmiMetaData</span>.<span>DefaultDate</span>;</td>
      </tr>
      <tr>
        <td id="L7491" data-line-number="7491"></td>
        <td id="LC7491">            <span><span>//</span> NOTE: 2 bytes added here to support additional header information for variant - internal type, scale prop (ignoring scale here)</span></td>
      </tr>
      <tr>
        <td id="L7492" data-line-number="7492"></td>
        <td id="LC7492">            <span>WriteSqlVariantHeader</span>((<span>int</span>)(<span>dateMetaData</span>.<span>MaxLength</span> <span>+</span> <span>2</span>), <span>TdsEnums</span>.<span>SQLDATE</span>, <span>0</span> <span><span>/*</span> one scale prop <span>*/</span></span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7493" data-line-number="7493"></td>
        <td id="LC7493">            <span>WriteDate</span>(<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7494" data-line-number="7494"></td>
        <td id="LC7494">        }</td>
      </tr>
      <tr>
        <td id="L7495" data-line-number="7495"></td>
        <td id="LC7495">
</td>
      </tr>
      <tr>
        <td id="L7496" data-line-number="7496"></td>
        <td id="LC7496">        <span>private</span> <span>byte</span>[] <span>SerializeSqlMoney</span>(<span>SqlMoney</span> <span>value</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7497" data-line-number="7497"></td>
        <td id="LC7497">        {</td>
      </tr>
      <tr>
        <td id="L7498" data-line-number="7498"></td>
        <td id="LC7498">            <span>return</span> <span>SerializeCurrency</span>(<span>value</span>.<span>Value</span>, <span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7499" data-line-number="7499"></td>
        <td id="LC7499">        }</td>
      </tr>
      <tr>
        <td id="L7500" data-line-number="7500"></td>
        <td id="LC7500">
</td>
      </tr>
      <tr>
        <td id="L7501" data-line-number="7501"></td>
        <td id="LC7501">        <span>private</span> <span>void</span> <span>WriteSqlMoney</span>(<span>SqlMoney</span> <span>value</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7502" data-line-number="7502"></td>
        <td id="LC7502">        {</td>
      </tr>
      <tr>
        <td id="L7503" data-line-number="7503"></td>
        <td id="LC7503">            <span><span>//</span> UNDONE: can I use SqlMoney.ToInt64()?</span></td>
      </tr>
      <tr>
        <td id="L7504" data-line-number="7504"></td>
        <td id="LC7504">            <span>int</span>[] <span>bits</span> <span>=</span> <span>Decimal</span>.<span>GetBits</span>(<span>value</span>.<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L7505" data-line-number="7505"></td>
        <td id="LC7505">
</td>
      </tr>
      <tr>
        <td id="L7506" data-line-number="7506"></td>
        <td id="LC7506">            <span><span>//</span> this decimal should be scaled by 10000 (regardless of what the incoming decimal was scaled by)</span></td>
      </tr>
      <tr>
        <td id="L7507" data-line-number="7507"></td>
        <td id="LC7507">            <span>bool</span> <span>isNeg</span> <span>=</span> (<span>0</span> <span>!=</span> (<span>bits</span>[<span>3</span>] <span>&amp;</span> <span>unchecked</span>((<span>int</span>)<span>0x80000000</span>)));</td>
      </tr>
      <tr>
        <td id="L7508" data-line-number="7508"></td>
        <td id="LC7508">            <span>long</span> <span>l</span> <span>=</span> ((<span>long</span>)(<span>uint</span>)<span>bits</span>[<span>1</span>]) <span>&lt;&lt;</span> <span>0x20</span> <span>|</span> (<span>uint</span>)<span>bits</span>[<span>0</span>];</td>
      </tr>
      <tr>
        <td id="L7509" data-line-number="7509"></td>
        <td id="LC7509">
</td>
      </tr>
      <tr>
        <td id="L7510" data-line-number="7510"></td>
        <td id="LC7510">            <span>if</span> (<span>isNeg</span>)</td>
      </tr>
      <tr>
        <td id="L7511" data-line-number="7511"></td>
        <td id="LC7511">                <span>l</span> <span>=</span> <span>-</span><span>l</span>;</td>
      </tr>
      <tr>
        <td id="L7512" data-line-number="7512"></td>
        <td id="LC7512">
</td>
      </tr>
      <tr>
        <td id="L7513" data-line-number="7513"></td>
        <td id="LC7513">            <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L7514" data-line-number="7514"></td>
        <td id="LC7514">            {</td>
      </tr>
      <tr>
        <td id="L7515" data-line-number="7515"></td>
        <td id="LC7515">                <span>Decimal</span> <span>decimalValue</span> <span>=</span> <span>value</span>.<span>Value</span>;</td>
      </tr>
      <tr>
        <td id="L7516" data-line-number="7516"></td>
        <td id="LC7516">
</td>
      </tr>
      <tr>
        <td id="L7517" data-line-number="7517"></td>
        <td id="LC7517">                <span><span>//</span> validate the value can be represented as a small money</span></td>
      </tr>
      <tr>
        <td id="L7518" data-line-number="7518"></td>
        <td id="LC7518">                <span>if</span> (<span>decimalValue</span> <span>&lt;</span> <span>TdsEnums</span>.<span>SQL_SMALL_MONEY_MIN</span> <span>||</span> <span>decimalValue</span> <span>&gt;</span> <span>TdsEnums</span>.<span>SQL_SMALL_MONEY_MAX</span>)</td>
      </tr>
      <tr>
        <td id="L7519" data-line-number="7519"></td>
        <td id="LC7519">                {</td>
      </tr>
      <tr>
        <td id="L7520" data-line-number="7520"></td>
        <td id="LC7520">                    <span>throw</span> <span>SQL</span>.<span>MoneyOverflow</span>(<span>decimalValue</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L7521" data-line-number="7521"></td>
        <td id="LC7521">                }</td>
      </tr>
      <tr>
        <td id="L7522" data-line-number="7522"></td>
        <td id="LC7522">
</td>
      </tr>
      <tr>
        <td id="L7523" data-line-number="7523"></td>
        <td id="LC7523">                <span>WriteInt</span>((<span>int</span>)<span>l</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7524" data-line-number="7524"></td>
        <td id="LC7524">            }</td>
      </tr>
      <tr>
        <td id="L7525" data-line-number="7525"></td>
        <td id="LC7525">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7526" data-line-number="7526"></td>
        <td id="LC7526">            {</td>
      </tr>
      <tr>
        <td id="L7527" data-line-number="7527"></td>
        <td id="LC7527">                <span>WriteInt</span>((<span>int</span>)(<span>l</span> <span>&gt;&gt;</span> <span>0x20</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7528" data-line-number="7528"></td>
        <td id="LC7528">                <span>WriteInt</span>((<span>int</span>)<span>l</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7529" data-line-number="7529"></td>
        <td id="LC7529">            }</td>
      </tr>
      <tr>
        <td id="L7530" data-line-number="7530"></td>
        <td id="LC7530">        }</td>
      </tr>
      <tr>
        <td id="L7531" data-line-number="7531"></td>
        <td id="LC7531">
</td>
      </tr>
      <tr>
        <td id="L7532" data-line-number="7532"></td>
        <td id="LC7532">        <span>private</span> <span>byte</span>[] <span>SerializeCurrency</span>(<span>Decimal</span> <span>value</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7533" data-line-number="7533"></td>
        <td id="LC7533">        {</td>
      </tr>
      <tr>
        <td id="L7534" data-line-number="7534"></td>
        <td id="LC7534">            <span>SqlMoney</span> <span>m</span> <span>=</span> <span>new</span> <span>SqlMoney</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7535" data-line-number="7535"></td>
        <td id="LC7535">            <span>int</span>[] <span>bits</span> <span>=</span> <span>Decimal</span>.<span>GetBits</span>(<span>m</span>.<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L7536" data-line-number="7536"></td>
        <td id="LC7536">
</td>
      </tr>
      <tr>
        <td id="L7537" data-line-number="7537"></td>
        <td id="LC7537">            <span><span>//</span> this decimal should be scaled by 10000 (regardless of what the incoming decimal was scaled by)</span></td>
      </tr>
      <tr>
        <td id="L7538" data-line-number="7538"></td>
        <td id="LC7538">            <span>bool</span> <span>isNeg</span> <span>=</span> (<span>0</span> <span>!=</span> (<span>bits</span>[<span>3</span>] <span>&amp;</span> <span>unchecked</span>((<span>int</span>)<span>0x80000000</span>)));</td>
      </tr>
      <tr>
        <td id="L7539" data-line-number="7539"></td>
        <td id="LC7539">            <span>long</span> <span>l</span> <span>=</span> ((<span>long</span>)(<span>uint</span>)<span>bits</span>[<span>1</span>]) <span>&lt;&lt;</span> <span>0x20</span> <span>|</span> (<span>uint</span>)<span>bits</span>[<span>0</span>];</td>
      </tr>
      <tr>
        <td id="L7540" data-line-number="7540"></td>
        <td id="LC7540">
</td>
      </tr>
      <tr>
        <td id="L7541" data-line-number="7541"></td>
        <td id="LC7541">            <span>if</span> (<span>isNeg</span>)</td>
      </tr>
      <tr>
        <td id="L7542" data-line-number="7542"></td>
        <td id="LC7542">                <span>l</span> <span>=</span> <span>-</span><span>l</span>;</td>
      </tr>
      <tr>
        <td id="L7543" data-line-number="7543"></td>
        <td id="LC7543">
</td>
      </tr>
      <tr>
        <td id="L7544" data-line-number="7544"></td>
        <td id="LC7544">            <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L7545" data-line-number="7545"></td>
        <td id="LC7545">            {</td>
      </tr>
      <tr>
        <td id="L7546" data-line-number="7546"></td>
        <td id="LC7546">                <span><span>//</span> validate the value can be represented as a small money</span></td>
      </tr>
      <tr>
        <td id="L7547" data-line-number="7547"></td>
        <td id="LC7547">                <span>if</span> (<span>value</span> <span>&lt;</span> <span>TdsEnums</span>.<span>SQL_SMALL_MONEY_MIN</span> <span>||</span> <span>value</span> <span>&gt;</span> <span>TdsEnums</span>.<span>SQL_SMALL_MONEY_MAX</span>)</td>
      </tr>
      <tr>
        <td id="L7548" data-line-number="7548"></td>
        <td id="LC7548">                {</td>
      </tr>
      <tr>
        <td id="L7549" data-line-number="7549"></td>
        <td id="LC7549">                    <span>throw</span> <span>SQL</span>.<span>MoneyOverflow</span>(<span>value</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L7550" data-line-number="7550"></td>
        <td id="LC7550">                }</td>
      </tr>
      <tr>
        <td id="L7551" data-line-number="7551"></td>
        <td id="LC7551">
</td>
      </tr>
      <tr>
        <td id="L7552" data-line-number="7552"></td>
        <td id="LC7552">                <span><span>//</span> We normalize to allow conversion across data types. SMALLMONEY is serialized into a MONEY.</span></td>
      </tr>
      <tr>
        <td id="L7553" data-line-number="7553"></td>
        <td id="LC7553">                <span>length</span> <span>=</span> <span>8</span>;</td>
      </tr>
      <tr>
        <td id="L7554" data-line-number="7554"></td>
        <td id="LC7554">            }</td>
      </tr>
      <tr>
        <td id="L7555" data-line-number="7555"></td>
        <td id="LC7555">
</td>
      </tr>
      <tr>
        <td id="L7556" data-line-number="7556"></td>
        <td id="LC7556">            <span>Debug</span>.<span>Assert</span>(<span>8</span> <span>==</span> <span>length</span>, <span><span>"</span>invalid length in SerializeCurrency<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7557" data-line-number="7557"></td>
        <td id="LC7557">            <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bLongBytes</span>)</td>
      </tr>
      <tr>
        <td id="L7558" data-line-number="7558"></td>
        <td id="LC7558">            {</td>
      </tr>
      <tr>
        <td id="L7559" data-line-number="7559"></td>
        <td id="LC7559">                <span>stateObj</span>.<span>_bLongBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>8</span>];</td>
      </tr>
      <tr>
        <td id="L7560" data-line-number="7560"></td>
        <td id="LC7560">            }</td>
      </tr>
      <tr>
        <td id="L7561" data-line-number="7561"></td>
        <td id="LC7561">
</td>
      </tr>
      <tr>
        <td id="L7562" data-line-number="7562"></td>
        <td id="LC7562">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>stateObj</span>.<span>_bLongBytes</span>;</td>
      </tr>
      <tr>
        <td id="L7563" data-line-number="7563"></td>
        <td id="LC7563">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7564" data-line-number="7564"></td>
        <td id="LC7564">
</td>
      </tr>
      <tr>
        <td id="L7565" data-line-number="7565"></td>
        <td id="LC7565">            <span>byte</span>[] <span>bytesPart</span> <span>=</span> <span>SerializeInt</span>((<span>int</span>)(<span>l</span> <span>&gt;&gt;</span> <span>0x20</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7566" data-line-number="7566"></td>
        <td id="LC7566">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7567" data-line-number="7567"></td>
        <td id="LC7567">            <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L7568" data-line-number="7568"></td>
        <td id="LC7568">
</td>
      </tr>
      <tr>
        <td id="L7569" data-line-number="7569"></td>
        <td id="LC7569">            <span>bytesPart</span> <span>=</span> <span>SerializeInt</span>((<span>int</span>)<span>l</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7570" data-line-number="7570"></td>
        <td id="LC7570">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7571" data-line-number="7571"></td>
        <td id="LC7571">
</td>
      </tr>
      <tr>
        <td id="L7572" data-line-number="7572"></td>
        <td id="LC7572">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L7573" data-line-number="7573"></td>
        <td id="LC7573">        }</td>
      </tr>
      <tr>
        <td id="L7574" data-line-number="7574"></td>
        <td id="LC7574">
</td>
      </tr>
      <tr>
        <td id="L7575" data-line-number="7575"></td>
        <td id="LC7575">        <span>private</span> <span>void</span> <span>WriteCurrency</span>(<span>Decimal</span> <span>value</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7576" data-line-number="7576"></td>
        <td id="LC7576">        {</td>
      </tr>
      <tr>
        <td id="L7577" data-line-number="7577"></td>
        <td id="LC7577">            <span>SqlMoney</span> <span>m</span> <span>=</span> <span>new</span> <span>SqlMoney</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7578" data-line-number="7578"></td>
        <td id="LC7578">            <span>int</span>[] <span>bits</span> <span>=</span> <span>Decimal</span>.<span>GetBits</span>(<span>m</span>.<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L7579" data-line-number="7579"></td>
        <td id="LC7579">
</td>
      </tr>
      <tr>
        <td id="L7580" data-line-number="7580"></td>
        <td id="LC7580">            <span><span>//</span> this decimal should be scaled by 10000 (regardless of what the incoming decimal was scaled by)</span></td>
      </tr>
      <tr>
        <td id="L7581" data-line-number="7581"></td>
        <td id="LC7581">            <span>bool</span> <span>isNeg</span> <span>=</span> (<span>0</span> <span>!=</span> (<span>bits</span>[<span>3</span>] <span>&amp;</span> <span>unchecked</span>((<span>int</span>)<span>0x80000000</span>)));</td>
      </tr>
      <tr>
        <td id="L7582" data-line-number="7582"></td>
        <td id="LC7582">            <span>long</span> <span>l</span> <span>=</span> ((<span>long</span>)(<span>uint</span>)<span>bits</span>[<span>1</span>]) <span>&lt;&lt;</span> <span>0x20</span> <span>|</span> (<span>uint</span>)<span>bits</span>[<span>0</span>];</td>
      </tr>
      <tr>
        <td id="L7583" data-line-number="7583"></td>
        <td id="LC7583">
</td>
      </tr>
      <tr>
        <td id="L7584" data-line-number="7584"></td>
        <td id="LC7584">            <span>if</span> (<span>isNeg</span>)</td>
      </tr>
      <tr>
        <td id="L7585" data-line-number="7585"></td>
        <td id="LC7585">                <span>l</span> <span>=</span> <span>-</span><span>l</span>;</td>
      </tr>
      <tr>
        <td id="L7586" data-line-number="7586"></td>
        <td id="LC7586">
</td>
      </tr>
      <tr>
        <td id="L7587" data-line-number="7587"></td>
        <td id="LC7587">            <span>if</span> (<span>length</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L7588" data-line-number="7588"></td>
        <td id="LC7588">            {</td>
      </tr>
      <tr>
        <td id="L7589" data-line-number="7589"></td>
        <td id="LC7589">                <span><span>//</span> validate the value can be represented as a small money</span></td>
      </tr>
      <tr>
        <td id="L7590" data-line-number="7590"></td>
        <td id="LC7590">                <span>if</span> (<span>value</span> <span>&lt;</span> <span>TdsEnums</span>.<span>SQL_SMALL_MONEY_MIN</span> <span>||</span> <span>value</span> <span>&gt;</span> <span>TdsEnums</span>.<span>SQL_SMALL_MONEY_MAX</span>)</td>
      </tr>
      <tr>
        <td id="L7591" data-line-number="7591"></td>
        <td id="LC7591">                {</td>
      </tr>
      <tr>
        <td id="L7592" data-line-number="7592"></td>
        <td id="LC7592">                    <span>throw</span> <span>SQL</span>.<span>MoneyOverflow</span>(<span>value</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L7593" data-line-number="7593"></td>
        <td id="LC7593">                }</td>
      </tr>
      <tr>
        <td id="L7594" data-line-number="7594"></td>
        <td id="LC7594">
</td>
      </tr>
      <tr>
        <td id="L7595" data-line-number="7595"></td>
        <td id="LC7595">                <span>WriteInt</span>((<span>int</span>)<span>l</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7596" data-line-number="7596"></td>
        <td id="LC7596">            }</td>
      </tr>
      <tr>
        <td id="L7597" data-line-number="7597"></td>
        <td id="LC7597">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7598" data-line-number="7598"></td>
        <td id="LC7598">            {</td>
      </tr>
      <tr>
        <td id="L7599" data-line-number="7599"></td>
        <td id="LC7599">                <span>WriteInt</span>((<span>int</span>)(<span>l</span> <span>&gt;&gt;</span> <span>0x20</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7600" data-line-number="7600"></td>
        <td id="LC7600">                <span>WriteInt</span>((<span>int</span>)<span>l</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7601" data-line-number="7601"></td>
        <td id="LC7601">            }</td>
      </tr>
      <tr>
        <td id="L7602" data-line-number="7602"></td>
        <td id="LC7602">        }</td>
      </tr>
      <tr>
        <td id="L7603" data-line-number="7603"></td>
        <td id="LC7603">
</td>
      </tr>
      <tr>
        <td id="L7604" data-line-number="7604"></td>
        <td id="LC7604">        <span>private</span> <span>byte</span>[] <span>SerializeDate</span>(<span>DateTime</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L7605" data-line-number="7605"></td>
        <td id="LC7605">        {</td>
      </tr>
      <tr>
        <td id="L7606" data-line-number="7606"></td>
        <td id="LC7606">            <span>long</span> <span>days</span> <span>=</span> <span>value</span>.<span>Subtract</span>(<span>DateTime</span>.<span>MinValue</span>).<span>Days</span>;</td>
      </tr>
      <tr>
        <td id="L7607" data-line-number="7607"></td>
        <td id="LC7607">            <span>return</span> <span>SerializePartialLong</span>(<span>days</span>, <span>3</span>);</td>
      </tr>
      <tr>
        <td id="L7608" data-line-number="7608"></td>
        <td id="LC7608">        }</td>
      </tr>
      <tr>
        <td id="L7609" data-line-number="7609"></td>
        <td id="LC7609">
</td>
      </tr>
      <tr>
        <td id="L7610" data-line-number="7610"></td>
        <td id="LC7610">        <span>private</span> <span>void</span> <span>WriteDate</span>(<span>DateTime</span> <span>value</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7611" data-line-number="7611"></td>
        <td id="LC7611">        {</td>
      </tr>
      <tr>
        <td id="L7612" data-line-number="7612"></td>
        <td id="LC7612">            <span>long</span> <span>days</span> <span>=</span> <span>value</span>.<span>Subtract</span>(<span>DateTime</span>.<span>MinValue</span>).<span>Days</span>;</td>
      </tr>
      <tr>
        <td id="L7613" data-line-number="7613"></td>
        <td id="LC7613">            <span>WritePartialLong</span>(<span>days</span>, <span>3</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7614" data-line-number="7614"></td>
        <td id="LC7614">        }</td>
      </tr>
      <tr>
        <td id="L7615" data-line-number="7615"></td>
        <td id="LC7615">
</td>
      </tr>
      <tr>
        <td id="L7616" data-line-number="7616"></td>
        <td id="LC7616">        <span>private</span> <span>byte</span>[] <span>SerializeTime</span>(<span>TimeSpan</span> <span>value</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L7617" data-line-number="7617"></td>
        <td id="LC7617">        {</td>
      </tr>
      <tr>
        <td id="L7618" data-line-number="7618"></td>
        <td id="LC7618">            <span>if</span> (<span>0</span> <span>&gt;</span> <span>value</span>.<span>Ticks</span> <span>||</span> <span>value</span>.<span>Ticks</span> <span>&gt;=</span> <span>TimeSpan</span>.<span>TicksPerDay</span>)</td>
      </tr>
      <tr>
        <td id="L7619" data-line-number="7619"></td>
        <td id="LC7619">            {</td>
      </tr>
      <tr>
        <td id="L7620" data-line-number="7620"></td>
        <td id="LC7620">                <span>throw</span> <span>SQL</span>.<span>TimeOverflow</span>(<span>value</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L7621" data-line-number="7621"></td>
        <td id="LC7621">            }</td>
      </tr>
      <tr>
        <td id="L7622" data-line-number="7622"></td>
        <td id="LC7622">
</td>
      </tr>
      <tr>
        <td id="L7623" data-line-number="7623"></td>
        <td id="LC7623">            <span>long</span> <span>time</span> <span>=</span> <span>value</span>.<span>Ticks</span> <span>/</span> <span>TdsEnums</span>.<span>TICKS_FROM_SCALE</span>[<span>scale</span>];</td>
      </tr>
      <tr>
        <td id="L7624" data-line-number="7624"></td>
        <td id="LC7624">
</td>
      </tr>
      <tr>
        <td id="L7625" data-line-number="7625"></td>
        <td id="LC7625">            <span><span>//</span> We normalize to maximum precision to allow conversion across different precisions.</span></td>
      </tr>
      <tr>
        <td id="L7626" data-line-number="7626"></td>
        <td id="LC7626">            <span>time</span> <span>=</span> <span>time</span> <span>*</span> <span>TdsEnums</span>.<span>TICKS_FROM_SCALE</span>[<span>scale</span>];</td>
      </tr>
      <tr>
        <td id="L7627" data-line-number="7627"></td>
        <td id="LC7627">            <span>length</span> <span>=</span> <span>TdsEnums</span>.<span>MAX_TIME_LENGTH</span>;</td>
      </tr>
      <tr>
        <td id="L7628" data-line-number="7628"></td>
        <td id="LC7628">
</td>
      </tr>
      <tr>
        <td id="L7629" data-line-number="7629"></td>
        <td id="LC7629">            <span>return</span> <span>SerializePartialLong</span>(<span>time</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L7630" data-line-number="7630"></td>
        <td id="LC7630">        }</td>
      </tr>
      <tr>
        <td id="L7631" data-line-number="7631"></td>
        <td id="LC7631">
</td>
      </tr>
      <tr>
        <td id="L7632" data-line-number="7632"></td>
        <td id="LC7632">        <span>private</span> <span>void</span> <span>WriteTime</span>(<span>TimeSpan</span> <span>value</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7633" data-line-number="7633"></td>
        <td id="LC7633">        {</td>
      </tr>
      <tr>
        <td id="L7634" data-line-number="7634"></td>
        <td id="LC7634">            <span>if</span> (<span>0</span> <span>&gt;</span> <span>value</span>.<span>Ticks</span> <span>||</span> <span>value</span>.<span>Ticks</span> <span>&gt;=</span> <span>TimeSpan</span>.<span>TicksPerDay</span>)</td>
      </tr>
      <tr>
        <td id="L7635" data-line-number="7635"></td>
        <td id="LC7635">            {</td>
      </tr>
      <tr>
        <td id="L7636" data-line-number="7636"></td>
        <td id="LC7636">                <span>throw</span> <span>SQL</span>.<span>TimeOverflow</span>(<span>value</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L7637" data-line-number="7637"></td>
        <td id="LC7637">            }</td>
      </tr>
      <tr>
        <td id="L7638" data-line-number="7638"></td>
        <td id="LC7638">            <span>long</span> <span>time</span> <span>=</span> <span>value</span>.<span>Ticks</span> <span>/</span> <span>TdsEnums</span>.<span>TICKS_FROM_SCALE</span>[<span>scale</span>];</td>
      </tr>
      <tr>
        <td id="L7639" data-line-number="7639"></td>
        <td id="LC7639">            <span>WritePartialLong</span>(<span>time</span>, <span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7640" data-line-number="7640"></td>
        <td id="LC7640">        }</td>
      </tr>
      <tr>
        <td id="L7641" data-line-number="7641"></td>
        <td id="LC7641">
</td>
      </tr>
      <tr>
        <td id="L7642" data-line-number="7642"></td>
        <td id="LC7642">        <span>private</span> <span>byte</span>[] <span>SerializeDateTime2</span>(<span>DateTime</span> <span>value</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L7643" data-line-number="7643"></td>
        <td id="LC7643">        {</td>
      </tr>
      <tr>
        <td id="L7644" data-line-number="7644"></td>
        <td id="LC7644">            <span>long</span> <span>time</span> <span>=</span> <span>value</span>.<span>TimeOfDay</span>.<span>Ticks</span> <span>/</span> <span>TdsEnums</span>.<span>TICKS_FROM_SCALE</span>[<span>scale</span>]; <span><span>//</span> DateTime.TimeOfDay always returns a valid TimeSpan for Time</span></td>
      </tr>
      <tr>
        <td id="L7645" data-line-number="7645"></td>
        <td id="LC7645">
</td>
      </tr>
      <tr>
        <td id="L7646" data-line-number="7646"></td>
        <td id="LC7646">            <span><span>//</span> We normalize to maximum precision to allow conversion across different precisions.</span></td>
      </tr>
      <tr>
        <td id="L7647" data-line-number="7647"></td>
        <td id="LC7647">            <span>time</span> <span>=</span> <span>time</span> <span>*</span> <span>TdsEnums</span>.<span>TICKS_FROM_SCALE</span>[<span>scale</span>];</td>
      </tr>
      <tr>
        <td id="L7648" data-line-number="7648"></td>
        <td id="LC7648">            <span>length</span> <span>=</span> <span>TdsEnums</span>.<span>MAX_DATETIME2_LENGTH</span>;</td>
      </tr>
      <tr>
        <td id="L7649" data-line-number="7649"></td>
        <td id="LC7649">
</td>
      </tr>
      <tr>
        <td id="L7650" data-line-number="7650"></td>
        <td id="LC7650">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L7651" data-line-number="7651"></td>
        <td id="LC7651">            <span>byte</span>[] <span>bytesPart</span>;</td>
      </tr>
      <tr>
        <td id="L7652" data-line-number="7652"></td>
        <td id="LC7652">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7653" data-line-number="7653"></td>
        <td id="LC7653">
</td>
      </tr>
      <tr>
        <td id="L7654" data-line-number="7654"></td>
        <td id="LC7654">            <span>bytesPart</span> <span>=</span> <span>SerializePartialLong</span>(<span>time</span>, <span>length</span> <span>-</span> <span>3</span>);</td>
      </tr>
      <tr>
        <td id="L7655" data-line-number="7655"></td>
        <td id="LC7655">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>length</span> <span>-</span> <span>3</span>);</td>
      </tr>
      <tr>
        <td id="L7656" data-line-number="7656"></td>
        <td id="LC7656">            <span>current</span> <span>+=</span> <span>length</span> <span>-</span> <span>3</span>;</td>
      </tr>
      <tr>
        <td id="L7657" data-line-number="7657"></td>
        <td id="LC7657">
</td>
      </tr>
      <tr>
        <td id="L7658" data-line-number="7658"></td>
        <td id="LC7658">            <span>bytesPart</span> <span>=</span> <span>SerializeDate</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7659" data-line-number="7659"></td>
        <td id="LC7659">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>3</span>);</td>
      </tr>
      <tr>
        <td id="L7660" data-line-number="7660"></td>
        <td id="LC7660">
</td>
      </tr>
      <tr>
        <td id="L7661" data-line-number="7661"></td>
        <td id="LC7661">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L7662" data-line-number="7662"></td>
        <td id="LC7662">        }</td>
      </tr>
      <tr>
        <td id="L7663" data-line-number="7663"></td>
        <td id="LC7663">
</td>
      </tr>
      <tr>
        <td id="L7664" data-line-number="7664"></td>
        <td id="LC7664">        <span>private</span> <span>void</span> <span>WriteDateTime2</span>(<span>DateTime</span> <span>value</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7665" data-line-number="7665"></td>
        <td id="LC7665">        {</td>
      </tr>
      <tr>
        <td id="L7666" data-line-number="7666"></td>
        <td id="LC7666">            <span>long</span> <span>time</span> <span>=</span> <span>value</span>.<span>TimeOfDay</span>.<span>Ticks</span> <span>/</span> <span>TdsEnums</span>.<span>TICKS_FROM_SCALE</span>[<span>scale</span>]; <span><span>//</span> DateTime.TimeOfDay always returns a valid TimeSpan for Time</span></td>
      </tr>
      <tr>
        <td id="L7667" data-line-number="7667"></td>
        <td id="LC7667">            <span>WritePartialLong</span>(<span>time</span>, <span>length</span> <span>-</span> <span>3</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7668" data-line-number="7668"></td>
        <td id="LC7668">            <span>WriteDate</span>(<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7669" data-line-number="7669"></td>
        <td id="LC7669">        }</td>
      </tr>
      <tr>
        <td id="L7670" data-line-number="7670"></td>
        <td id="LC7670">
</td>
      </tr>
      <tr>
        <td id="L7671" data-line-number="7671"></td>
        <td id="LC7671">        <span>private</span> <span>byte</span>[] <span>SerializeDateTimeOffset</span>(<span>DateTimeOffset</span> <span>value</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L7672" data-line-number="7672"></td>
        <td id="LC7672">        {</td>
      </tr>
      <tr>
        <td id="L7673" data-line-number="7673"></td>
        <td id="LC7673">            <span>byte</span>[] <span>bytesPart</span>;</td>
      </tr>
      <tr>
        <td id="L7674" data-line-number="7674"></td>
        <td id="LC7674">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7675" data-line-number="7675"></td>
        <td id="LC7675">
</td>
      </tr>
      <tr>
        <td id="L7676" data-line-number="7676"></td>
        <td id="LC7676">            <span>bytesPart</span> <span>=</span> <span>SerializeDateTime2</span>(<span>value</span>.<span>UtcDateTime</span>, <span>scale</span>, <span>length</span> <span>-</span> <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L7677" data-line-number="7677"></td>
        <td id="LC7677">
</td>
      </tr>
      <tr>
        <td id="L7678" data-line-number="7678"></td>
        <td id="LC7678">            <span><span>//</span> We need to allocate the array after we have received the length of the serialized value</span></td>
      </tr>
      <tr>
        <td id="L7679" data-line-number="7679"></td>
        <td id="LC7679">            <span><span>//</span> since it might be higher due to normalization.</span></td>
      </tr>
      <tr>
        <td id="L7680" data-line-number="7680"></td>
        <td id="LC7680">            <span>length</span> <span>=</span> <span>bytesPart</span>.<span>Length</span> <span>+</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L7681" data-line-number="7681"></td>
        <td id="LC7681">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>length</span>];</td>
      </tr>
      <tr>
        <td id="L7682" data-line-number="7682"></td>
        <td id="LC7682">
</td>
      </tr>
      <tr>
        <td id="L7683" data-line-number="7683"></td>
        <td id="LC7683">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>length</span> <span>-</span> <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L7684" data-line-number="7684"></td>
        <td id="LC7684">            <span>current</span> <span>+=</span> <span>length</span> <span>-</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L7685" data-line-number="7685"></td>
        <td id="LC7685">
</td>
      </tr>
      <tr>
        <td id="L7686" data-line-number="7686"></td>
        <td id="LC7686">            <span>Int16</span> <span>offset</span> <span>=</span> (<span>Int16</span>)<span>value</span>.<span>Offset</span>.<span>TotalMinutes</span>;</td>
      </tr>
      <tr>
        <td id="L7687" data-line-number="7687"></td>
        <td id="LC7687">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)(<span>offset</span> <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L7688" data-line-number="7688"></td>
        <td id="LC7688">            <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> (<span>byte</span>)((<span>offset</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>);</td>
      </tr>
      <tr>
        <td id="L7689" data-line-number="7689"></td>
        <td id="LC7689">
</td>
      </tr>
      <tr>
        <td id="L7690" data-line-number="7690"></td>
        <td id="LC7690">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L7691" data-line-number="7691"></td>
        <td id="LC7691">        }</td>
      </tr>
      <tr>
        <td id="L7692" data-line-number="7692"></td>
        <td id="LC7692">
</td>
      </tr>
      <tr>
        <td id="L7693" data-line-number="7693"></td>
        <td id="LC7693">        <span>private</span> <span>void</span> <span>WriteDateTimeOffset</span>(<span>DateTimeOffset</span> <span>value</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7694" data-line-number="7694"></td>
        <td id="LC7694">        {</td>
      </tr>
      <tr>
        <td id="L7695" data-line-number="7695"></td>
        <td id="LC7695">            <span>WriteDateTime2</span>(<span>value</span>.<span>UtcDateTime</span>, <span>scale</span>, <span>length</span> <span>-</span> <span>2</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7696" data-line-number="7696"></td>
        <td id="LC7696">            <span>Int16</span> <span>offset</span> <span>=</span> (<span>Int16</span>)<span>value</span>.<span>Offset</span>.<span>TotalMinutes</span>;</td>
      </tr>
      <tr>
        <td id="L7697" data-line-number="7697"></td>
        <td id="LC7697">            <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>offset</span> <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L7698" data-line-number="7698"></td>
        <td id="LC7698">            <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)((<span>offset</span> <span>&gt;&gt;</span> <span>8</span>) <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L7699" data-line-number="7699"></td>
        <td id="LC7699">        }</td>
      </tr>
      <tr>
        <td id="L7700" data-line-number="7700"></td>
        <td id="LC7700">
</td>
      </tr>
      <tr>
        <td id="L7701" data-line-number="7701"></td>
        <td id="LC7701">        <span>private</span> <span>bool</span> <span>TryReadSqlDecimal</span>(<span>SqlBuffer</span> <span>value</span>, <span>int</span> <span>length</span>, <span>byte</span> <span>precision</span>, <span>byte</span> <span>scale</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7702" data-line-number="7702"></td>
        <td id="LC7702">        {</td>
      </tr>
      <tr>
        <td id="L7703" data-line-number="7703"></td>
        <td id="LC7703">            <span>byte</span> <span>byteValue</span>;</td>
      </tr>
      <tr>
        <td id="L7704" data-line-number="7704"></td>
        <td id="LC7704">            <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>byteValue</span>))</td>
      </tr>
      <tr>
        <td id="L7705" data-line-number="7705"></td>
        <td id="LC7705">            {</td>
      </tr>
      <tr>
        <td id="L7706" data-line-number="7706"></td>
        <td id="LC7706">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7707" data-line-number="7707"></td>
        <td id="LC7707">            }</td>
      </tr>
      <tr>
        <td id="L7708" data-line-number="7708"></td>
        <td id="LC7708">            <span>bool</span> <span>fPositive</span> <span>=</span> (<span>1</span> <span>==</span> <span>byteValue</span>);</td>
      </tr>
      <tr>
        <td id="L7709" data-line-number="7709"></td>
        <td id="LC7709">
</td>
      </tr>
      <tr>
        <td id="L7710" data-line-number="7710"></td>
        <td id="LC7710">            <span>length</span> <span>=</span> <span>checked</span>((<span>int</span>)<span>length</span> <span>-</span> <span>1</span>);</td>
      </tr>
      <tr>
        <td id="L7711" data-line-number="7711"></td>
        <td id="LC7711">
</td>
      </tr>
      <tr>
        <td id="L7712" data-line-number="7712"></td>
        <td id="LC7712">            <span>int</span>[] <span>bits</span>;</td>
      </tr>
      <tr>
        <td id="L7713" data-line-number="7713"></td>
        <td id="LC7713">            <span>if</span> (<span>!</span><span>TryReadDecimalBits</span>(<span>length</span>, <span>stateObj</span>, <span>out</span> <span>bits</span>))</td>
      </tr>
      <tr>
        <td id="L7714" data-line-number="7714"></td>
        <td id="LC7714">            {</td>
      </tr>
      <tr>
        <td id="L7715" data-line-number="7715"></td>
        <td id="LC7715">                <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7716" data-line-number="7716"></td>
        <td id="LC7716">            }</td>
      </tr>
      <tr>
        <td id="L7717" data-line-number="7717"></td>
        <td id="LC7717">
</td>
      </tr>
      <tr>
        <td id="L7718" data-line-number="7718"></td>
        <td id="LC7718">            <span>value</span>.<span>SetToDecimal</span>(<span>precision</span>, <span>scale</span>, <span>fPositive</span>, <span>bits</span>);</td>
      </tr>
      <tr>
        <td id="L7719" data-line-number="7719"></td>
        <td id="LC7719">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L7720" data-line-number="7720"></td>
        <td id="LC7720">        }</td>
      </tr>
      <tr>
        <td id="L7721" data-line-number="7721"></td>
        <td id="LC7721">
</td>
      </tr>
      <tr>
        <td id="L7722" data-line-number="7722"></td>
        <td id="LC7722">        <span><span>//</span> @devnote: length should be size of decimal without the sign</span></td>
      </tr>
      <tr>
        <td id="L7723" data-line-number="7723"></td>
        <td id="LC7723">        <span><span>//</span> @devnote: sign should have already been read off the wire</span></td>
      </tr>
      <tr>
        <td id="L7724" data-line-number="7724"></td>
        <td id="LC7724">        <span>private</span> <span>bool</span> <span>TryReadDecimalBits</span>(<span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>int</span>[] <span>bits</span>)</td>
      </tr>
      <tr>
        <td id="L7725" data-line-number="7725"></td>
        <td id="LC7725">        {</td>
      </tr>
      <tr>
        <td id="L7726" data-line-number="7726"></td>
        <td id="LC7726">            <span>bits</span> <span>=</span> <span>stateObj</span>.<span>_decimalBits</span>; <span><span>//</span> used alloc'd array if we have one already</span></td>
      </tr>
      <tr>
        <td id="L7727" data-line-number="7727"></td>
        <td id="LC7727">            <span>int</span> <span>i</span>;</td>
      </tr>
      <tr>
        <td id="L7728" data-line-number="7728"></td>
        <td id="LC7728">
</td>
      </tr>
      <tr>
        <td id="L7729" data-line-number="7729"></td>
        <td id="LC7729">            <span>if</span> (<span>null</span> <span>==</span> <span>bits</span>)</td>
      </tr>
      <tr>
        <td id="L7730" data-line-number="7730"></td>
        <td id="LC7730">                <span>bits</span> <span>=</span> <span>new</span> <span>int</span>[<span>4</span>];</td>
      </tr>
      <tr>
        <td id="L7731" data-line-number="7731"></td>
        <td id="LC7731">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7732" data-line-number="7732"></td>
        <td id="LC7732">            {</td>
      </tr>
      <tr>
        <td id="L7733" data-line-number="7733"></td>
        <td id="LC7733">                <span>for</span> (<span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>bits</span>.<span>Length</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L7734" data-line-number="7734"></td>
        <td id="LC7734">                    <span>bits</span>[<span>i</span>] <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7735" data-line-number="7735"></td>
        <td id="LC7735">            }</td>
      </tr>
      <tr>
        <td id="L7736" data-line-number="7736"></td>
        <td id="LC7736">
</td>
      </tr>
      <tr>
        <td id="L7737" data-line-number="7737"></td>
        <td id="LC7737">            <span>Debug</span>.<span>Assert</span>((<span>length</span> <span>&gt;</span> <span>0</span>) <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L7738" data-line-number="7738"></td>
        <td id="LC7738">                         (<span>length</span> <span>&lt;=</span> <span>TdsEnums</span>.<span>MAX_NUMERIC_LEN</span> <span>-</span> <span>1</span>) <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L7739" data-line-number="7739"></td>
        <td id="LC7739">                         (<span>length</span> <span>%</span> <span>4</span> <span>==</span> <span>0</span>), <span><span>"</span>decimal should have 4, 8, 12, or 16 bytes of data<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7740" data-line-number="7740"></td>
        <td id="LC7740">
</td>
      </tr>
      <tr>
        <td id="L7741" data-line-number="7741"></td>
        <td id="LC7741">            <span>int</span> <span>decLength</span> <span>=</span> <span>length</span> <span>&gt;&gt;</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L7742" data-line-number="7742"></td>
        <td id="LC7742">
</td>
      </tr>
      <tr>
        <td id="L7743" data-line-number="7743"></td>
        <td id="LC7743">            <span>for</span> (<span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>decLength</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L7744" data-line-number="7744"></td>
        <td id="LC7744">            {</td>
      </tr>
      <tr>
        <td id="L7745" data-line-number="7745"></td>
        <td id="LC7745">                <span><span>//</span> up to 16 bytes of data following the sign byte</span></td>
      </tr>
      <tr>
        <td id="L7746" data-line-number="7746"></td>
        <td id="LC7746">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>bits</span>[<span>i</span>]))</td>
      </tr>
      <tr>
        <td id="L7747" data-line-number="7747"></td>
        <td id="LC7747">                {</td>
      </tr>
      <tr>
        <td id="L7748" data-line-number="7748"></td>
        <td id="LC7748">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L7749" data-line-number="7749"></td>
        <td id="LC7749">                }</td>
      </tr>
      <tr>
        <td id="L7750" data-line-number="7750"></td>
        <td id="LC7750">            }</td>
      </tr>
      <tr>
        <td id="L7751" data-line-number="7751"></td>
        <td id="LC7751">
</td>
      </tr>
      <tr>
        <td id="L7752" data-line-number="7752"></td>
        <td id="LC7752">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L7753" data-line-number="7753"></td>
        <td id="LC7753">        }</td>
      </tr>
      <tr>
        <td id="L7754" data-line-number="7754"></td>
        <td id="LC7754">
</td>
      </tr>
      <tr>
        <td id="L7755" data-line-number="7755"></td>
        <td id="LC7755">        <span>static</span> <span>internal</span> <span>SqlDecimal</span> <span>AdjustSqlDecimalScale</span>(<span>SqlDecimal</span> <span>d</span>, <span>int</span> <span>newScale</span>)</td>
      </tr>
      <tr>
        <td id="L7756" data-line-number="7756"></td>
        <td id="LC7756">        {</td>
      </tr>
      <tr>
        <td id="L7757" data-line-number="7757"></td>
        <td id="LC7757">            <span>if</span> (<span>d</span>.<span>Scale</span> <span>!=</span> <span>newScale</span>)</td>
      </tr>
      <tr>
        <td id="L7758" data-line-number="7758"></td>
        <td id="LC7758">            {</td>
      </tr>
      <tr>
        <td id="L7759" data-line-number="7759"></td>
        <td id="LC7759">                <span>return</span> <span>SqlDecimal</span>.<span>AdjustScale</span>(<span>d</span>, <span>newScale</span> <span>-</span> <span>d</span>.<span>Scale</span>, <span>false</span> <span><span>/*</span> Don't round, truncate.  MDAC 69229 <span>*/</span></span>);</td>
      </tr>
      <tr>
        <td id="L7760" data-line-number="7760"></td>
        <td id="LC7760">            }</td>
      </tr>
      <tr>
        <td id="L7761" data-line-number="7761"></td>
        <td id="LC7761">
</td>
      </tr>
      <tr>
        <td id="L7762" data-line-number="7762"></td>
        <td id="LC7762">            <span>return</span> <span>d</span>;</td>
      </tr>
      <tr>
        <td id="L7763" data-line-number="7763"></td>
        <td id="LC7763">        }</td>
      </tr>
      <tr>
        <td id="L7764" data-line-number="7764"></td>
        <td id="LC7764">
</td>
      </tr>
      <tr>
        <td id="L7765" data-line-number="7765"></td>
        <td id="LC7765">        <span>static</span> <span>internal</span> <span>decimal</span> <span>AdjustDecimalScale</span>(<span>decimal</span> <span>value</span>, <span>int</span> <span>newScale</span>)</td>
      </tr>
      <tr>
        <td id="L7766" data-line-number="7766"></td>
        <td id="LC7766">        {</td>
      </tr>
      <tr>
        <td id="L7767" data-line-number="7767"></td>
        <td id="LC7767">            <span>int</span> <span>oldScale</span> <span>=</span> (<span>Decimal</span>.<span>GetBits</span>(<span>value</span>)[<span>3</span>] <span>&amp;</span> <span>0x00ff0000</span>) <span>&gt;&gt;</span> <span>0x10</span>;</td>
      </tr>
      <tr>
        <td id="L7768" data-line-number="7768"></td>
        <td id="LC7768">
</td>
      </tr>
      <tr>
        <td id="L7769" data-line-number="7769"></td>
        <td id="LC7769">            <span>if</span> (<span>newScale</span> <span>!=</span> <span>oldScale</span>)</td>
      </tr>
      <tr>
        <td id="L7770" data-line-number="7770"></td>
        <td id="LC7770">            {</td>
      </tr>
      <tr>
        <td id="L7771" data-line-number="7771"></td>
        <td id="LC7771">                <span>SqlDecimal</span> <span>num</span> <span>=</span> <span>new</span> <span>SqlDecimal</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7772" data-line-number="7772"></td>
        <td id="LC7772">
</td>
      </tr>
      <tr>
        <td id="L7773" data-line-number="7773"></td>
        <td id="LC7773">                <span>num</span> <span>=</span> <span>SqlDecimal</span>.<span>AdjustScale</span>(<span>num</span>, <span>newScale</span> <span>-</span> <span>oldScale</span>, <span>false</span> <span><span>/*</span> Don't round, truncate.  MDAC 69229 <span>*/</span></span>);</td>
      </tr>
      <tr>
        <td id="L7774" data-line-number="7774"></td>
        <td id="LC7774">                <span>return</span> <span>num</span>.<span>Value</span>;</td>
      </tr>
      <tr>
        <td id="L7775" data-line-number="7775"></td>
        <td id="LC7775">            }</td>
      </tr>
      <tr>
        <td id="L7776" data-line-number="7776"></td>
        <td id="LC7776">
</td>
      </tr>
      <tr>
        <td id="L7777" data-line-number="7777"></td>
        <td id="LC7777">            <span>return</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L7778" data-line-number="7778"></td>
        <td id="LC7778">        }</td>
      </tr>
      <tr>
        <td id="L7779" data-line-number="7779"></td>
        <td id="LC7779">
</td>
      </tr>
      <tr>
        <td id="L7780" data-line-number="7780"></td>
        <td id="LC7780">        <span>internal</span> <span>byte</span>[] <span>SerializeSqlDecimal</span>(<span>SqlDecimal</span> <span>d</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7781" data-line-number="7781"></td>
        <td id="LC7781">        {</td>
      </tr>
      <tr>
        <td id="L7782" data-line-number="7782"></td>
        <td id="LC7782">            <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bDecimalBytes</span>)</td>
      </tr>
      <tr>
        <td id="L7783" data-line-number="7783"></td>
        <td id="LC7783">            {</td>
      </tr>
      <tr>
        <td id="L7784" data-line-number="7784"></td>
        <td id="LC7784">                <span>stateObj</span>.<span>_bDecimalBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>17</span>];</td>
      </tr>
      <tr>
        <td id="L7785" data-line-number="7785"></td>
        <td id="LC7785">            }</td>
      </tr>
      <tr>
        <td id="L7786" data-line-number="7786"></td>
        <td id="LC7786">
</td>
      </tr>
      <tr>
        <td id="L7787" data-line-number="7787"></td>
        <td id="LC7787">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>stateObj</span>.<span>_bDecimalBytes</span>;</td>
      </tr>
      <tr>
        <td id="L7788" data-line-number="7788"></td>
        <td id="LC7788">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7789" data-line-number="7789"></td>
        <td id="LC7789">
</td>
      </tr>
      <tr>
        <td id="L7790" data-line-number="7790"></td>
        <td id="LC7790">            <span><span>//</span> sign</span></td>
      </tr>
      <tr>
        <td id="L7791" data-line-number="7791"></td>
        <td id="LC7791">            <span>if</span> (<span>d</span>.<span>IsPositive</span>)</td>
      </tr>
      <tr>
        <td id="L7792" data-line-number="7792"></td>
        <td id="LC7792">                <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L7793" data-line-number="7793"></td>
        <td id="LC7793">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7794" data-line-number="7794"></td>
        <td id="LC7794">                <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7795" data-line-number="7795"></td>
        <td id="LC7795">
</td>
      </tr>
      <tr>
        <td id="L7796" data-line-number="7796"></td>
        <td id="LC7796">            <span>uint</span> <span>data1</span>, <span>data2</span>, <span>data3</span>, <span>data4</span>;</td>
      </tr>
      <tr>
        <td id="L7797" data-line-number="7797"></td>
        <td id="LC7797">            <span>SqlTypeWorkarounds</span>.<span>SqlDecimalExtractData</span>(<span>d</span>, <span>out</span> <span>data1</span>, <span>out</span> <span>data2</span>, <span>out</span> <span>data3</span>, <span>out</span> <span>data4</span>);</td>
      </tr>
      <tr>
        <td id="L7798" data-line-number="7798"></td>
        <td id="LC7798">            <span>byte</span>[] <span>bytesPart</span> <span>=</span> <span>SerializeUnsignedInt</span>(<span>data1</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7799" data-line-number="7799"></td>
        <td id="LC7799">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7800" data-line-number="7800"></td>
        <td id="LC7800">            <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L7801" data-line-number="7801"></td>
        <td id="LC7801">            <span>bytesPart</span> <span>=</span> <span>SerializeUnsignedInt</span>(<span>data2</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7802" data-line-number="7802"></td>
        <td id="LC7802">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7803" data-line-number="7803"></td>
        <td id="LC7803">            <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L7804" data-line-number="7804"></td>
        <td id="LC7804">            <span>bytesPart</span> <span>=</span> <span>SerializeUnsignedInt</span>(<span>data3</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7805" data-line-number="7805"></td>
        <td id="LC7805">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7806" data-line-number="7806"></td>
        <td id="LC7806">            <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L7807" data-line-number="7807"></td>
        <td id="LC7807">            <span>bytesPart</span> <span>=</span> <span>SerializeUnsignedInt</span>(<span>data4</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7808" data-line-number="7808"></td>
        <td id="LC7808">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7809" data-line-number="7809"></td>
        <td id="LC7809">
</td>
      </tr>
      <tr>
        <td id="L7810" data-line-number="7810"></td>
        <td id="LC7810">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L7811" data-line-number="7811"></td>
        <td id="LC7811">        }</td>
      </tr>
      <tr>
        <td id="L7812" data-line-number="7812"></td>
        <td id="LC7812">
</td>
      </tr>
      <tr>
        <td id="L7813" data-line-number="7813"></td>
        <td id="LC7813">        <span>internal</span> <span>void</span> <span>WriteSqlDecimal</span>(<span>SqlDecimal</span> <span>d</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7814" data-line-number="7814"></td>
        <td id="LC7814">        {</td>
      </tr>
      <tr>
        <td id="L7815" data-line-number="7815"></td>
        <td id="LC7815">            <span><span>//</span> sign</span></td>
      </tr>
      <tr>
        <td id="L7816" data-line-number="7816"></td>
        <td id="LC7816">            <span>if</span> (<span>d</span>.<span>IsPositive</span>)</td>
      </tr>
      <tr>
        <td id="L7817" data-line-number="7817"></td>
        <td id="LC7817">                <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>);</td>
      </tr>
      <tr>
        <td id="L7818" data-line-number="7818"></td>
        <td id="LC7818">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7819" data-line-number="7819"></td>
        <td id="LC7819">                <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L7820" data-line-number="7820"></td>
        <td id="LC7820">
</td>
      </tr>
      <tr>
        <td id="L7821" data-line-number="7821"></td>
        <td id="LC7821">            <span>uint</span> <span>data1</span>, <span>data2</span>, <span>data3</span>, <span>data4</span>;</td>
      </tr>
      <tr>
        <td id="L7822" data-line-number="7822"></td>
        <td id="LC7822">            <span>SqlTypeWorkarounds</span>.<span>SqlDecimalExtractData</span>(<span>d</span>, <span>out</span> <span>data1</span>, <span>out</span> <span>data2</span>, <span>out</span> <span>data3</span>, <span>out</span> <span>data4</span>);</td>
      </tr>
      <tr>
        <td id="L7823" data-line-number="7823"></td>
        <td id="LC7823">            <span>WriteUnsignedInt</span>(<span>data1</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7824" data-line-number="7824"></td>
        <td id="LC7824">            <span>WriteUnsignedInt</span>(<span>data2</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7825" data-line-number="7825"></td>
        <td id="LC7825">            <span>WriteUnsignedInt</span>(<span>data3</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7826" data-line-number="7826"></td>
        <td id="LC7826">            <span>WriteUnsignedInt</span>(<span>data4</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7827" data-line-number="7827"></td>
        <td id="LC7827">        }</td>
      </tr>
      <tr>
        <td id="L7828" data-line-number="7828"></td>
        <td id="LC7828">
</td>
      </tr>
      <tr>
        <td id="L7829" data-line-number="7829"></td>
        <td id="LC7829">        <span>private</span> <span>byte</span>[] <span>SerializeDecimal</span>(<span>decimal</span> <span>value</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7830" data-line-number="7830"></td>
        <td id="LC7830">        {</td>
      </tr>
      <tr>
        <td id="L7831" data-line-number="7831"></td>
        <td id="LC7831">            <span>int</span>[] <span>decimalBits</span> <span>=</span> <span>Decimal</span>.<span>GetBits</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7832" data-line-number="7832"></td>
        <td id="LC7832">            <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bDecimalBytes</span>)</td>
      </tr>
      <tr>
        <td id="L7833" data-line-number="7833"></td>
        <td id="LC7833">            {</td>
      </tr>
      <tr>
        <td id="L7834" data-line-number="7834"></td>
        <td id="LC7834">                <span>stateObj</span>.<span>_bDecimalBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>17</span>];</td>
      </tr>
      <tr>
        <td id="L7835" data-line-number="7835"></td>
        <td id="LC7835">            }</td>
      </tr>
      <tr>
        <td id="L7836" data-line-number="7836"></td>
        <td id="LC7836">
</td>
      </tr>
      <tr>
        <td id="L7837" data-line-number="7837"></td>
        <td id="LC7837">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>stateObj</span>.<span>_bDecimalBytes</span>;</td>
      </tr>
      <tr>
        <td id="L7838" data-line-number="7838"></td>
        <td id="LC7838">            <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7839" data-line-number="7839"></td>
        <td id="LC7839">
</td>
      </tr>
      <tr>
        <td id="L7840" data-line-number="7840"></td>
        <td id="LC7840">            <span><span>/*</span></span></td>
      </tr>
      <tr>
        <td id="L7841" data-line-number="7841"></td>
        <td id="LC7841"><span>             Returns a binary representation of a Decimal. The return value is an integer</span></td>
      </tr>
      <tr>
        <td id="L7842" data-line-number="7842"></td>
        <td id="LC7842"><span>             array with four elements. Elements 0, 1, and 2 contain the low, middle, and</span></td>
      </tr>
      <tr>
        <td id="L7843" data-line-number="7843"></td>
        <td id="LC7843"><span>             high 32 bits of the 96-bit integer part of the Decimal. Element 3 contains</span></td>
      </tr>
      <tr>
        <td id="L7844" data-line-number="7844"></td>
        <td id="LC7844"><span>             the scale factor and sign of the Decimal: bits 0-15 (the lower word) are</span></td>
      </tr>
      <tr>
        <td id="L7845" data-line-number="7845"></td>
        <td id="LC7845"><span>             unused; bits 16-23 contain a value between 0 and 28, indicating the power of</span></td>
      </tr>
      <tr>
        <td id="L7846" data-line-number="7846"></td>
        <td id="LC7846"><span>             10 to divide the 96-bit integer part by to produce the Decimal value; bits 24-</span></td>
      </tr>
      <tr>
        <td id="L7847" data-line-number="7847"></td>
        <td id="LC7847"><span>             30 are unused; and finally bit 31 indicates the sign of the Decimal value, 0</span></td>
      </tr>
      <tr>
        <td id="L7848" data-line-number="7848"></td>
        <td id="LC7848"><span>             meaning positive and 1 meaning negative.</span></td>
      </tr>
      <tr>
        <td id="L7849" data-line-number="7849"></td>
        <td id="LC7849"><span></span></td>
      </tr>
      <tr>
        <td id="L7850" data-line-number="7850"></td>
        <td id="LC7850"><span>             SQLDECIMAL/SQLNUMERIC has a byte stream of:</span></td>
      </tr>
      <tr>
        <td id="L7851" data-line-number="7851"></td>
        <td id="LC7851"><span>             struct {</span></td>
      </tr>
      <tr>
        <td id="L7852" data-line-number="7852"></td>
        <td id="LC7852"><span>                 BYTE sign; // 1 if positive, 0 if negative</span></td>
      </tr>
      <tr>
        <td id="L7853" data-line-number="7853"></td>
        <td id="LC7853"><span>                 BYTE data[];</span></td>
      </tr>
      <tr>
        <td id="L7854" data-line-number="7854"></td>
        <td id="LC7854"><span>             }</span></td>
      </tr>
      <tr>
        <td id="L7855" data-line-number="7855"></td>
        <td id="LC7855"><span></span></td>
      </tr>
      <tr>
        <td id="L7856" data-line-number="7856"></td>
        <td id="LC7856"><span>             For TDS 7.0 and above, there are always 17 bytes of data</span></td>
      </tr>
      <tr>
        <td id="L7857" data-line-number="7857"></td>
        <td id="LC7857"><span>            <span>*/</span></span></td>
      </tr>
      <tr>
        <td id="L7858" data-line-number="7858"></td>
        <td id="LC7858">
</td>
      </tr>
      <tr>
        <td id="L7859" data-line-number="7859"></td>
        <td id="LC7859">            <span><span>//</span> write the sign (note that COM and SQL are opposite)</span></td>
      </tr>
      <tr>
        <td id="L7860" data-line-number="7860"></td>
        <td id="LC7860">            <span>if</span> (<span>0x80000000</span> <span>==</span> (<span>decimalBits</span>[<span>3</span>] <span>&amp;</span> <span>0x80000000</span>))</td>
      </tr>
      <tr>
        <td id="L7861" data-line-number="7861"></td>
        <td id="LC7861">                <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L7862" data-line-number="7862"></td>
        <td id="LC7862">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7863" data-line-number="7863"></td>
        <td id="LC7863">                <span>bytes</span>[<span>current</span><span>++</span>] <span>=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L7864" data-line-number="7864"></td>
        <td id="LC7864">
</td>
      </tr>
      <tr>
        <td id="L7865" data-line-number="7865"></td>
        <td id="LC7865">            <span>byte</span>[] <span>bytesPart</span> <span>=</span> <span>SerializeInt</span>(<span>decimalBits</span>[<span>0</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7866" data-line-number="7866"></td>
        <td id="LC7866">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7867" data-line-number="7867"></td>
        <td id="LC7867">            <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L7868" data-line-number="7868"></td>
        <td id="LC7868">            <span>bytesPart</span> <span>=</span> <span>SerializeInt</span>(<span>decimalBits</span>[<span>1</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7869" data-line-number="7869"></td>
        <td id="LC7869">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7870" data-line-number="7870"></td>
        <td id="LC7870">            <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L7871" data-line-number="7871"></td>
        <td id="LC7871">            <span>bytesPart</span> <span>=</span> <span>SerializeInt</span>(<span>decimalBits</span>[<span>2</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7872" data-line-number="7872"></td>
        <td id="LC7872">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7873" data-line-number="7873"></td>
        <td id="LC7873">            <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L7874" data-line-number="7874"></td>
        <td id="LC7874">            <span>bytesPart</span> <span>=</span> <span>SerializeInt</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7875" data-line-number="7875"></td>
        <td id="LC7875">            <span>Buffer</span>.<span>BlockCopy</span>(<span>bytesPart</span>, <span>0</span>, <span>bytes</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L7876" data-line-number="7876"></td>
        <td id="LC7876">
</td>
      </tr>
      <tr>
        <td id="L7877" data-line-number="7877"></td>
        <td id="LC7877">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L7878" data-line-number="7878"></td>
        <td id="LC7878">        }</td>
      </tr>
      <tr>
        <td id="L7879" data-line-number="7879"></td>
        <td id="LC7879">
</td>
      </tr>
      <tr>
        <td id="L7880" data-line-number="7880"></td>
        <td id="LC7880">        <span>private</span> <span>void</span> <span>WriteDecimal</span>(<span>decimal</span> <span>value</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7881" data-line-number="7881"></td>
        <td id="LC7881">        {</td>
      </tr>
      <tr>
        <td id="L7882" data-line-number="7882"></td>
        <td id="LC7882">            <span>stateObj</span>.<span>_decimalBits</span> <span>=</span> <span>Decimal</span>.<span>GetBits</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L7883" data-line-number="7883"></td>
        <td id="LC7883">            <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>!=</span> <span>stateObj</span>.<span>_decimalBits</span>, <span><span>"</span>decimalBits should be filled in at TdsExecuteRPC time<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L7884" data-line-number="7884"></td>
        <td id="LC7884">
</td>
      </tr>
      <tr>
        <td id="L7885" data-line-number="7885"></td>
        <td id="LC7885">            <span><span>/*</span></span></td>
      </tr>
      <tr>
        <td id="L7886" data-line-number="7886"></td>
        <td id="LC7886"><span>             Returns a binary representation of a Decimal. The return value is an integer</span></td>
      </tr>
      <tr>
        <td id="L7887" data-line-number="7887"></td>
        <td id="LC7887"><span>             array with four elements. Elements 0, 1, and 2 contain the low, middle, and</span></td>
      </tr>
      <tr>
        <td id="L7888" data-line-number="7888"></td>
        <td id="LC7888"><span>             high 32 bits of the 96-bit integer part of the Decimal. Element 3 contains</span></td>
      </tr>
      <tr>
        <td id="L7889" data-line-number="7889"></td>
        <td id="LC7889"><span>             the scale factor and sign of the Decimal: bits 0-15 (the lower word) are</span></td>
      </tr>
      <tr>
        <td id="L7890" data-line-number="7890"></td>
        <td id="LC7890"><span>             unused; bits 16-23 contain a value between 0 and 28, indicating the power of</span></td>
      </tr>
      <tr>
        <td id="L7891" data-line-number="7891"></td>
        <td id="LC7891"><span>             10 to divide the 96-bit integer part by to produce the Decimal value; bits 24-</span></td>
      </tr>
      <tr>
        <td id="L7892" data-line-number="7892"></td>
        <td id="LC7892"><span>             30 are unused; and finally bit 31 indicates the sign of the Decimal value, 0</span></td>
      </tr>
      <tr>
        <td id="L7893" data-line-number="7893"></td>
        <td id="LC7893"><span>             meaning positive and 1 meaning negative.</span></td>
      </tr>
      <tr>
        <td id="L7894" data-line-number="7894"></td>
        <td id="LC7894"><span></span></td>
      </tr>
      <tr>
        <td id="L7895" data-line-number="7895"></td>
        <td id="LC7895"><span>             SQLDECIMAL/SQLNUMERIC has a byte stream of:</span></td>
      </tr>
      <tr>
        <td id="L7896" data-line-number="7896"></td>
        <td id="LC7896"><span>             struct {</span></td>
      </tr>
      <tr>
        <td id="L7897" data-line-number="7897"></td>
        <td id="LC7897"><span>                 BYTE sign; // 1 if positive, 0 if negative</span></td>
      </tr>
      <tr>
        <td id="L7898" data-line-number="7898"></td>
        <td id="LC7898"><span>                 BYTE data[];</span></td>
      </tr>
      <tr>
        <td id="L7899" data-line-number="7899"></td>
        <td id="LC7899"><span>             }</span></td>
      </tr>
      <tr>
        <td id="L7900" data-line-number="7900"></td>
        <td id="LC7900"><span></span></td>
      </tr>
      <tr>
        <td id="L7901" data-line-number="7901"></td>
        <td id="LC7901"><span>             For TDS 7.0 and above, there are always 17 bytes of data</span></td>
      </tr>
      <tr>
        <td id="L7902" data-line-number="7902"></td>
        <td id="LC7902"><span>            <span>*/</span></span></td>
      </tr>
      <tr>
        <td id="L7903" data-line-number="7903"></td>
        <td id="LC7903">
</td>
      </tr>
      <tr>
        <td id="L7904" data-line-number="7904"></td>
        <td id="LC7904">            <span><span>//</span> write the sign (note that COM and SQL are opposite)</span></td>
      </tr>
      <tr>
        <td id="L7905" data-line-number="7905"></td>
        <td id="LC7905">            <span>if</span> (<span>0x80000000</span> <span>==</span> (<span>stateObj</span>.<span>_decimalBits</span>[<span>3</span>] <span>&amp;</span> <span>0x80000000</span>))</td>
      </tr>
      <tr>
        <td id="L7906" data-line-number="7906"></td>
        <td id="LC7906">                <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L7907" data-line-number="7907"></td>
        <td id="LC7907">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7908" data-line-number="7908"></td>
        <td id="LC7908">                <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>);</td>
      </tr>
      <tr>
        <td id="L7909" data-line-number="7909"></td>
        <td id="LC7909">
</td>
      </tr>
      <tr>
        <td id="L7910" data-line-number="7910"></td>
        <td id="LC7910">            <span>WriteInt</span>(<span>stateObj</span>.<span>_decimalBits</span>[<span>0</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7911" data-line-number="7911"></td>
        <td id="LC7911">            <span>WriteInt</span>(<span>stateObj</span>.<span>_decimalBits</span>[<span>1</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7912" data-line-number="7912"></td>
        <td id="LC7912">            <span>WriteInt</span>(<span>stateObj</span>.<span>_decimalBits</span>[<span>2</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7913" data-line-number="7913"></td>
        <td id="LC7913">            <span>WriteInt</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7914" data-line-number="7914"></td>
        <td id="LC7914">        }</td>
      </tr>
      <tr>
        <td id="L7915" data-line-number="7915"></td>
        <td id="LC7915">
</td>
      </tr>
      <tr>
        <td id="L7916" data-line-number="7916"></td>
        <td id="LC7916">        <span>private</span> <span>void</span> <span>WriteIdentifier</span>(<span>string</span> <span>s</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7917" data-line-number="7917"></td>
        <td id="LC7917">        {</td>
      </tr>
      <tr>
        <td id="L7918" data-line-number="7918"></td>
        <td id="LC7918">            <span>if</span> (<span>null</span> <span>!=</span> <span>s</span>)</td>
      </tr>
      <tr>
        <td id="L7919" data-line-number="7919"></td>
        <td id="LC7919">            {</td>
      </tr>
      <tr>
        <td id="L7920" data-line-number="7920"></td>
        <td id="LC7920">                <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>s</span>.<span>Length</span>));</td>
      </tr>
      <tr>
        <td id="L7921" data-line-number="7921"></td>
        <td id="LC7921">                <span>WriteString</span>(<span>s</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7922" data-line-number="7922"></td>
        <td id="LC7922">            }</td>
      </tr>
      <tr>
        <td id="L7923" data-line-number="7923"></td>
        <td id="LC7923">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7924" data-line-number="7924"></td>
        <td id="LC7924">            {</td>
      </tr>
      <tr>
        <td id="L7925" data-line-number="7925"></td>
        <td id="LC7925">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L7926" data-line-number="7926"></td>
        <td id="LC7926">            }</td>
      </tr>
      <tr>
        <td id="L7927" data-line-number="7927"></td>
        <td id="LC7927">        }</td>
      </tr>
      <tr>
        <td id="L7928" data-line-number="7928"></td>
        <td id="LC7928">
</td>
      </tr>
      <tr>
        <td id="L7929" data-line-number="7929"></td>
        <td id="LC7929">        <span>private</span> <span>void</span> <span>WriteIdentifierWithShortLength</span>(<span>string</span> <span>s</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L7930" data-line-number="7930"></td>
        <td id="LC7930">        {</td>
      </tr>
      <tr>
        <td id="L7931" data-line-number="7931"></td>
        <td id="LC7931">            <span>if</span> (<span>null</span> <span>!=</span> <span>s</span>)</td>
      </tr>
      <tr>
        <td id="L7932" data-line-number="7932"></td>
        <td id="LC7932">            {</td>
      </tr>
      <tr>
        <td id="L7933" data-line-number="7933"></td>
        <td id="LC7933">                <span>WriteShort</span>(<span>checked</span>((<span>short</span>)<span>s</span>.<span>Length</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7934" data-line-number="7934"></td>
        <td id="LC7934">                <span>WriteString</span>(<span>s</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7935" data-line-number="7935"></td>
        <td id="LC7935">            }</td>
      </tr>
      <tr>
        <td id="L7936" data-line-number="7936"></td>
        <td id="LC7936">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7937" data-line-number="7937"></td>
        <td id="LC7937">            {</td>
      </tr>
      <tr>
        <td id="L7938" data-line-number="7938"></td>
        <td id="LC7938">                <span>WriteShort</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L7939" data-line-number="7939"></td>
        <td id="LC7939">            }</td>
      </tr>
      <tr>
        <td id="L7940" data-line-number="7940"></td>
        <td id="LC7940">        }</td>
      </tr>
      <tr>
        <td id="L7941" data-line-number="7941"></td>
        <td id="LC7941">
</td>
      </tr>
      <tr>
        <td id="L7942" data-line-number="7942"></td>
        <td id="LC7942">        <span>private</span> <span>Task</span> <span>WriteString</span>(<span>string</span> <span>s</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>canAccumulate</span> <span>=</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L7943" data-line-number="7943"></td>
        <td id="LC7943">        {</td>
      </tr>
      <tr>
        <td id="L7944" data-line-number="7944"></td>
        <td id="LC7944">            <span>return</span> <span>WriteString</span>(<span>s</span>, <span>s</span>.<span>Length</span>, <span>0</span>, <span>stateObj</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7945" data-line-number="7945"></td>
        <td id="LC7945">        }</td>
      </tr>
      <tr>
        <td id="L7946" data-line-number="7946"></td>
        <td id="LC7946">
</td>
      </tr>
      <tr>
        <td id="L7947" data-line-number="7947"></td>
        <td id="LC7947">        <span>internal</span> <span>byte</span>[] <span>SerializeCharArray</span>(<span>char</span>[] <span>carr</span>, <span>int</span> <span>length</span>, <span>int</span> <span>offset</span>)</td>
      </tr>
      <tr>
        <td id="L7948" data-line-number="7948"></td>
        <td id="LC7948">        {</td>
      </tr>
      <tr>
        <td id="L7949" data-line-number="7949"></td>
        <td id="LC7949">            <span>int</span> <span>cBytes</span> <span>=</span> <span>ADP</span>.<span>CharSize</span> <span>*</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L7950" data-line-number="7950"></td>
        <td id="LC7950">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>cBytes</span>];</td>
      </tr>
      <tr>
        <td id="L7951" data-line-number="7951"></td>
        <td id="LC7951">
</td>
      </tr>
      <tr>
        <td id="L7952" data-line-number="7952"></td>
        <td id="LC7952">            <span>CopyCharsToBytes</span>(<span>carr</span>, <span>offset</span>, <span>bytes</span>, <span>0</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L7953" data-line-number="7953"></td>
        <td id="LC7953">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L7954" data-line-number="7954"></td>
        <td id="LC7954">        }</td>
      </tr>
      <tr>
        <td id="L7955" data-line-number="7955"></td>
        <td id="LC7955">
</td>
      </tr>
      <tr>
        <td id="L7956" data-line-number="7956"></td>
        <td id="LC7956">        <span>internal</span> <span>Task</span> <span>WriteCharArray</span>(<span>char</span>[] <span>carr</span>, <span>int</span> <span>length</span>, <span>int</span> <span>offset</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>canAccumulate</span> <span>=</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L7957" data-line-number="7957"></td>
        <td id="LC7957">        {</td>
      </tr>
      <tr>
        <td id="L7958" data-line-number="7958"></td>
        <td id="LC7958">            <span>int</span> <span>cBytes</span> <span>=</span> <span>ADP</span>.<span>CharSize</span> <span>*</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L7959" data-line-number="7959"></td>
        <td id="LC7959">
</td>
      </tr>
      <tr>
        <td id="L7960" data-line-number="7960"></td>
        <td id="LC7960">            <span><span>//</span> Perf shortcut: If it fits, write directly to the outBuff</span></td>
      </tr>
      <tr>
        <td id="L7961" data-line-number="7961"></td>
        <td id="LC7961">            <span>if</span> (<span>cBytes</span> <span>&lt;</span> (<span>stateObj</span>.<span>_outBuff</span>.<span>Length</span> <span>-</span> <span>stateObj</span>.<span>_outBytesUsed</span>))</td>
      </tr>
      <tr>
        <td id="L7962" data-line-number="7962"></td>
        <td id="LC7962">            {</td>
      </tr>
      <tr>
        <td id="L7963" data-line-number="7963"></td>
        <td id="LC7963">                <span>CopyCharsToBytes</span>(<span>carr</span>, <span>offset</span>, <span>stateObj</span>.<span>_outBuff</span>, <span>stateObj</span>.<span>_outBytesUsed</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L7964" data-line-number="7964"></td>
        <td id="LC7964">                <span>stateObj</span>.<span>_outBytesUsed</span> <span>+=</span> <span>cBytes</span>;</td>
      </tr>
      <tr>
        <td id="L7965" data-line-number="7965"></td>
        <td id="LC7965">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L7966" data-line-number="7966"></td>
        <td id="LC7966">            }</td>
      </tr>
      <tr>
        <td id="L7967" data-line-number="7967"></td>
        <td id="LC7967">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L7968" data-line-number="7968"></td>
        <td id="LC7968">            {</td>
      </tr>
      <tr>
        <td id="L7969" data-line-number="7969"></td>
        <td id="LC7969">                <span>if</span> (<span>stateObj</span>.<span>_bTmp</span> <span>==</span> <span>null</span> <span>||</span> <span>stateObj</span>.<span>_bTmp</span>.<span>Length</span> <span>&lt;</span> <span>cBytes</span>)</td>
      </tr>
      <tr>
        <td id="L7970" data-line-number="7970"></td>
        <td id="LC7970">                {</td>
      </tr>
      <tr>
        <td id="L7971" data-line-number="7971"></td>
        <td id="LC7971">                    <span>stateObj</span>.<span>_bTmp</span> <span>=</span> <span>new</span> <span>byte</span>[<span>cBytes</span>];</td>
      </tr>
      <tr>
        <td id="L7972" data-line-number="7972"></td>
        <td id="LC7972">                }</td>
      </tr>
      <tr>
        <td id="L7973" data-line-number="7973"></td>
        <td id="LC7973">
</td>
      </tr>
      <tr>
        <td id="L7974" data-line-number="7974"></td>
        <td id="LC7974">                <span>CopyCharsToBytes</span>(<span>carr</span>, <span>offset</span>, <span>stateObj</span>.<span>_bTmp</span>, <span>0</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L7975" data-line-number="7975"></td>
        <td id="LC7975">                <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>(<span>stateObj</span>.<span>_bTmp</span>, <span>cBytes</span>, <span>0</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L7976" data-line-number="7976"></td>
        <td id="LC7976">            }</td>
      </tr>
      <tr>
        <td id="L7977" data-line-number="7977"></td>
        <td id="LC7977">        }</td>
      </tr>
      <tr>
        <td id="L7978" data-line-number="7978"></td>
        <td id="LC7978">
</td>
      </tr>
      <tr>
        <td id="L7979" data-line-number="7979"></td>
        <td id="LC7979">        <span>internal</span> <span>byte</span>[] <span>SerializeString</span>(<span>string</span> <span>s</span>, <span>int</span> <span>length</span>, <span>int</span> <span>offset</span>)</td>
      </tr>
      <tr>
        <td id="L7980" data-line-number="7980"></td>
        <td id="LC7980">        {</td>
      </tr>
      <tr>
        <td id="L7981" data-line-number="7981"></td>
        <td id="LC7981">            <span>int</span> <span>cBytes</span> <span>=</span> <span>ADP</span>.<span>CharSize</span> <span>*</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L7982" data-line-number="7982"></td>
        <td id="LC7982">            <span>byte</span>[] <span>bytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>cBytes</span>];</td>
      </tr>
      <tr>
        <td id="L7983" data-line-number="7983"></td>
        <td id="LC7983">
</td>
      </tr>
      <tr>
        <td id="L7984" data-line-number="7984"></td>
        <td id="LC7984">            <span>CopyStringToBytes</span>(<span>s</span>, <span>offset</span>, <span>bytes</span>, <span>0</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L7985" data-line-number="7985"></td>
        <td id="LC7985">            <span>return</span> <span>bytes</span>;</td>
      </tr>
      <tr>
        <td id="L7986" data-line-number="7986"></td>
        <td id="LC7986">        }</td>
      </tr>
      <tr>
        <td id="L7987" data-line-number="7987"></td>
        <td id="LC7987">
</td>
      </tr>
      <tr>
        <td id="L7988" data-line-number="7988"></td>
        <td id="LC7988">        <span>internal</span> <span>Task</span> <span>WriteString</span>(<span>string</span> <span>s</span>, <span>int</span> <span>length</span>, <span>int</span> <span>offset</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>canAccumulate</span> <span>=</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L7989" data-line-number="7989"></td>
        <td id="LC7989">        {</td>
      </tr>
      <tr>
        <td id="L7990" data-line-number="7990"></td>
        <td id="LC7990">            <span>int</span> <span>cBytes</span> <span>=</span> <span>ADP</span>.<span>CharSize</span> <span>*</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L7991" data-line-number="7991"></td>
        <td id="LC7991">
</td>
      </tr>
      <tr>
        <td id="L7992" data-line-number="7992"></td>
        <td id="LC7992">            <span><span>//</span> Perf shortcut: If it fits, write directly to the outBuff</span></td>
      </tr>
      <tr>
        <td id="L7993" data-line-number="7993"></td>
        <td id="LC7993">            <span>if</span> (<span>cBytes</span> <span>&lt;</span> (<span>stateObj</span>.<span>_outBuff</span>.<span>Length</span> <span>-</span> <span>stateObj</span>.<span>_outBytesUsed</span>))</td>
      </tr>
      <tr>
        <td id="L7994" data-line-number="7994"></td>
        <td id="LC7994">            {</td>
      </tr>
      <tr>
        <td id="L7995" data-line-number="7995"></td>
        <td id="LC7995">                <span>CopyStringToBytes</span>(<span>s</span>, <span>offset</span>, <span>stateObj</span>.<span>_outBuff</span>, <span>stateObj</span>.<span>_outBytesUsed</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L7996" data-line-number="7996"></td>
        <td id="LC7996">                <span>stateObj</span>.<span>_outBytesUsed</span> <span>+=</span> <span>cBytes</span>;</td>
      </tr>
      <tr>
        <td id="L7997" data-line-number="7997"></td>
        <td id="LC7997">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L7998" data-line-number="7998"></td>
        <td id="LC7998">            }</td>
      </tr>
      <tr>
        <td id="L7999" data-line-number="7999"></td>
        <td id="LC7999">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8000" data-line-number="8000"></td>
        <td id="LC8000">            {</td>
      </tr>
      <tr>
        <td id="L8001" data-line-number="8001"></td>
        <td id="LC8001">                <span>if</span> (<span>stateObj</span>.<span>_bTmp</span> <span>==</span> <span>null</span> <span>||</span> <span>stateObj</span>.<span>_bTmp</span>.<span>Length</span> <span>&lt;</span> <span>cBytes</span>)</td>
      </tr>
      <tr>
        <td id="L8002" data-line-number="8002"></td>
        <td id="LC8002">                {</td>
      </tr>
      <tr>
        <td id="L8003" data-line-number="8003"></td>
        <td id="LC8003">                    <span>stateObj</span>.<span>_bTmp</span> <span>=</span> <span>new</span> <span>byte</span>[<span>cBytes</span>];</td>
      </tr>
      <tr>
        <td id="L8004" data-line-number="8004"></td>
        <td id="LC8004">                }</td>
      </tr>
      <tr>
        <td id="L8005" data-line-number="8005"></td>
        <td id="LC8005">
</td>
      </tr>
      <tr>
        <td id="L8006" data-line-number="8006"></td>
        <td id="LC8006">                <span>CopyStringToBytes</span>(<span>s</span>, <span>offset</span>, <span>stateObj</span>.<span>_bTmp</span>, <span>0</span>, <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L8007" data-line-number="8007"></td>
        <td id="LC8007">                <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>(<span>stateObj</span>.<span>_bTmp</span>, <span>cBytes</span>, <span>0</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L8008" data-line-number="8008"></td>
        <td id="LC8008">            }</td>
      </tr>
      <tr>
        <td id="L8009" data-line-number="8009"></td>
        <td id="LC8009">        }</td>
      </tr>
      <tr>
        <td id="L8010" data-line-number="8010"></td>
        <td id="LC8010">
</td>
      </tr>
      <tr>
        <td id="L8011" data-line-number="8011"></td>
        <td id="LC8011">
</td>
      </tr>
      <tr>
        <td id="L8012" data-line-number="8012"></td>
        <td id="LC8012">        <span>private</span> <span>unsafe</span> <span>static</span> <span>void</span> <span>CopyCharsToBytes</span>(<span>char</span>[] <span>source</span>, <span>int</span> <span>sourceOffset</span>, <span>byte</span>[] <span>dest</span>, <span>int</span> <span>destOffset</span>, <span>int</span> <span>charLength</span>)</td>
      </tr>
      <tr>
        <td id="L8013" data-line-number="8013"></td>
        <td id="LC8013">        {</td>
      </tr>
      <tr>
        <td id="L8014" data-line-number="8014"></td>
        <td id="LC8014">            <span>Buffer</span>.<span>BlockCopy</span>(<span>source</span>, <span>sourceOffset</span>, <span>dest</span>, <span>destOffset</span>, <span>charLength</span> <span>*</span> <span>ADP</span>.<span>CharSize</span>);</td>
      </tr>
      <tr>
        <td id="L8015" data-line-number="8015"></td>
        <td id="LC8015">        }</td>
      </tr>
      <tr>
        <td id="L8016" data-line-number="8016"></td>
        <td id="LC8016">
</td>
      </tr>
      <tr>
        <td id="L8017" data-line-number="8017"></td>
        <td id="LC8017">        <span>private</span> <span>unsafe</span> <span>static</span> <span>void</span> <span>CopyStringToBytes</span>(<span>string</span> <span>source</span>, <span>int</span> <span>sourceOffset</span>, <span>byte</span>[] <span>dest</span>, <span>int</span> <span>destOffset</span>, <span>int</span> <span>charLength</span>)</td>
      </tr>
      <tr>
        <td id="L8018" data-line-number="8018"></td>
        <td id="LC8018">        {</td>
      </tr>
      <tr>
        <td id="L8019" data-line-number="8019"></td>
        <td id="LC8019">            <span>Encoding</span>.<span>Unicode</span>.<span>GetBytes</span>(<span>source</span>, <span>sourceOffset</span>, <span>charLength</span>, <span>dest</span>, <span>destOffset</span>);</td>
      </tr>
      <tr>
        <td id="L8020" data-line-number="8020"></td>
        <td id="LC8020">        }</td>
      </tr>
      <tr>
        <td id="L8021" data-line-number="8021"></td>
        <td id="LC8021">
</td>
      </tr>
      <tr>
        <td id="L8022" data-line-number="8022"></td>
        <td id="LC8022">        <span>private</span> <span>Task</span> <span>WriteEncodingChar</span>(<span>string</span> <span>s</span>, <span>Encoding</span> <span>encoding</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>canAccumulate</span> <span>=</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L8023" data-line-number="8023"></td>
        <td id="LC8023">        {</td>
      </tr>
      <tr>
        <td id="L8024" data-line-number="8024"></td>
        <td id="LC8024">            <span>return</span> <span>WriteEncodingChar</span>(<span>s</span>, <span>s</span>.<span>Length</span>, <span>0</span>, <span>encoding</span>, <span>stateObj</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L8025" data-line-number="8025"></td>
        <td id="LC8025">        }</td>
      </tr>
      <tr>
        <td id="L8026" data-line-number="8026"></td>
        <td id="LC8026">
</td>
      </tr>
      <tr>
        <td id="L8027" data-line-number="8027"></td>
        <td id="LC8027">        <span>private</span> <span>byte</span>[] <span>SerializeEncodingChar</span>(<span>string</span> <span>s</span>, <span>int</span> <span>numChars</span>, <span>int</span> <span>offset</span>, <span>Encoding</span> <span>encoding</span>)</td>
      </tr>
      <tr>
        <td id="L8028" data-line-number="8028"></td>
        <td id="LC8028">        {</td>
      </tr>
      <tr>
        <td id="L8029" data-line-number="8029"></td>
        <td id="LC8029">            <span>char</span>[] <span>charData</span>;</td>
      </tr>
      <tr>
        <td id="L8030" data-line-number="8030"></td>
        <td id="LC8030">            <span>byte</span>[] <span>byteData</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L8031" data-line-number="8031"></td>
        <td id="LC8031">
</td>
      </tr>
      <tr>
        <td id="L8032" data-line-number="8032"></td>
        <td id="LC8032">            <span><span>//</span> if hitting 7.0 server, encoding will be null in metadata for columns or return values since</span></td>
      </tr>
      <tr>
        <td id="L8033" data-line-number="8033"></td>
        <td id="LC8033">            <span><span>//</span> 7.0 has no support for multiple code pages in data - single code page support only</span></td>
      </tr>
      <tr>
        <td id="L8034" data-line-number="8034"></td>
        <td id="LC8034">            <span>if</span> (<span>encoding</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8035" data-line-number="8035"></td>
        <td id="LC8035">                <span>encoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L8036" data-line-number="8036"></td>
        <td id="LC8036">
</td>
      </tr>
      <tr>
        <td id="L8037" data-line-number="8037"></td>
        <td id="LC8037">            <span>charData</span> <span>=</span> <span>s</span>.<span>ToCharArray</span>(<span>offset</span>, <span>numChars</span>);</td>
      </tr>
      <tr>
        <td id="L8038" data-line-number="8038"></td>
        <td id="LC8038">
</td>
      </tr>
      <tr>
        <td id="L8039" data-line-number="8039"></td>
        <td id="LC8039">            <span>byteData</span> <span>=</span> <span>new</span> <span>byte</span>[<span>encoding</span>.<span>GetByteCount</span>(<span>charData</span>, <span>0</span>, <span>charData</span>.<span>Length</span>)];</td>
      </tr>
      <tr>
        <td id="L8040" data-line-number="8040"></td>
        <td id="LC8040">            <span>encoding</span>.<span>GetBytes</span>(<span>charData</span>, <span>0</span>, <span>charData</span>.<span>Length</span>, <span>byteData</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8041" data-line-number="8041"></td>
        <td id="LC8041">
</td>
      </tr>
      <tr>
        <td id="L8042" data-line-number="8042"></td>
        <td id="LC8042">            <span>return</span> <span>byteData</span>;</td>
      </tr>
      <tr>
        <td id="L8043" data-line-number="8043"></td>
        <td id="LC8043">        }</td>
      </tr>
      <tr>
        <td id="L8044" data-line-number="8044"></td>
        <td id="LC8044">
</td>
      </tr>
      <tr>
        <td id="L8045" data-line-number="8045"></td>
        <td id="LC8045">        <span>private</span> <span>Task</span> <span>WriteEncodingChar</span>(<span>string</span> <span>s</span>, <span>int</span> <span>numChars</span>, <span>int</span> <span>offset</span>, <span>Encoding</span> <span>encoding</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>canAccumulate</span> <span>=</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L8046" data-line-number="8046"></td>
        <td id="LC8046">        {</td>
      </tr>
      <tr>
        <td id="L8047" data-line-number="8047"></td>
        <td id="LC8047">            <span>char</span>[] <span>charData</span>;</td>
      </tr>
      <tr>
        <td id="L8048" data-line-number="8048"></td>
        <td id="LC8048">            <span>byte</span>[] <span>byteData</span>;</td>
      </tr>
      <tr>
        <td id="L8049" data-line-number="8049"></td>
        <td id="LC8049">
</td>
      </tr>
      <tr>
        <td id="L8050" data-line-number="8050"></td>
        <td id="LC8050">            <span><span>//</span> if hitting 7.0 server, encoding will be null in metadata for columns or return values since</span></td>
      </tr>
      <tr>
        <td id="L8051" data-line-number="8051"></td>
        <td id="LC8051">            <span><span>//</span> 7.0 has no support for multiple code pages in data - single code page support only</span></td>
      </tr>
      <tr>
        <td id="L8052" data-line-number="8052"></td>
        <td id="LC8052">            <span>if</span> (<span>encoding</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8053" data-line-number="8053"></td>
        <td id="LC8053">                <span>encoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L8054" data-line-number="8054"></td>
        <td id="LC8054">
</td>
      </tr>
      <tr>
        <td id="L8055" data-line-number="8055"></td>
        <td id="LC8055">            <span>charData</span> <span>=</span> <span>s</span>.<span>ToCharArray</span>(<span>offset</span>, <span>numChars</span>);</td>
      </tr>
      <tr>
        <td id="L8056" data-line-number="8056"></td>
        <td id="LC8056">
</td>
      </tr>
      <tr>
        <td id="L8057" data-line-number="8057"></td>
        <td id="LC8057">            <span><span>//</span> Optimization: if the entire string fits in the current buffer, then copy it directly</span></td>
      </tr>
      <tr>
        <td id="L8058" data-line-number="8058"></td>
        <td id="LC8058">            <span>int</span> <span>bytesLeft</span> <span>=</span> <span>stateObj</span>.<span>_outBuff</span>.<span>Length</span> <span>-</span> <span>stateObj</span>.<span>_outBytesUsed</span>;</td>
      </tr>
      <tr>
        <td id="L8059" data-line-number="8059"></td>
        <td id="LC8059">            <span>if</span> ((<span>numChars</span> <span>&lt;=</span> <span>bytesLeft</span>) <span>&amp;&amp;</span> (<span>encoding</span>.<span>GetMaxByteCount</span>(<span>charData</span>.<span>Length</span>) <span>&lt;=</span> <span>bytesLeft</span>))</td>
      </tr>
      <tr>
        <td id="L8060" data-line-number="8060"></td>
        <td id="LC8060">            {</td>
      </tr>
      <tr>
        <td id="L8061" data-line-number="8061"></td>
        <td id="LC8061">                <span>int</span> <span>bytesWritten</span> <span>=</span> <span>encoding</span>.<span>GetBytes</span>(<span>charData</span>, <span>0</span>, <span>charData</span>.<span>Length</span>, <span>stateObj</span>.<span>_outBuff</span>, <span>stateObj</span>.<span>_outBytesUsed</span>);</td>
      </tr>
      <tr>
        <td id="L8062" data-line-number="8062"></td>
        <td id="LC8062">                <span>stateObj</span>.<span>_outBytesUsed</span> <span>+=</span> <span>bytesWritten</span>;</td>
      </tr>
      <tr>
        <td id="L8063" data-line-number="8063"></td>
        <td id="LC8063">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L8064" data-line-number="8064"></td>
        <td id="LC8064">            }</td>
      </tr>
      <tr>
        <td id="L8065" data-line-number="8065"></td>
        <td id="LC8065">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8066" data-line-number="8066"></td>
        <td id="LC8066">            {</td>
      </tr>
      <tr>
        <td id="L8067" data-line-number="8067"></td>
        <td id="LC8067">                <span>byteData</span> <span>=</span> <span>encoding</span>.<span>GetBytes</span>(<span>charData</span>, <span>0</span>, <span>numChars</span>);</td>
      </tr>
      <tr>
        <td id="L8068" data-line-number="8068"></td>
        <td id="LC8068">                <span>Debug</span>.<span>Assert</span>(<span>byteData</span> <span>!=</span> <span>null</span>, <span><span>"</span>no data from encoding<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8069" data-line-number="8069"></td>
        <td id="LC8069">                <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>(<span>byteData</span>, <span>byteData</span>.<span>Length</span>, <span>0</span>, <span>canAccumulate</span>);</td>
      </tr>
      <tr>
        <td id="L8070" data-line-number="8070"></td>
        <td id="LC8070">            }</td>
      </tr>
      <tr>
        <td id="L8071" data-line-number="8071"></td>
        <td id="LC8071">        }</td>
      </tr>
      <tr>
        <td id="L8072" data-line-number="8072"></td>
        <td id="LC8072">
</td>
      </tr>
      <tr>
        <td id="L8073" data-line-number="8073"></td>
        <td id="LC8073">        <span>internal</span> <span>int</span> <span>GetEncodingCharLength</span>(<span>string</span> <span>value</span>, <span>int</span> <span>numChars</span>, <span>int</span> <span>charOffset</span>, <span>Encoding</span> <span>encoding</span>)</td>
      </tr>
      <tr>
        <td id="L8074" data-line-number="8074"></td>
        <td id="LC8074">        {</td>
      </tr>
      <tr>
        <td id="L8075" data-line-number="8075"></td>
        <td id="LC8075">            <span><span>//</span> UNDONE: (PERF) this is an expensive way to get the length.  Also, aren't we</span></td>
      </tr>
      <tr>
        <td id="L8076" data-line-number="8076"></td>
        <td id="LC8076">            <span><span>//</span> UNDONE: (PERF) going through these steps twice when we write out a value?</span></td>
      </tr>
      <tr>
        <td id="L8077" data-line-number="8077"></td>
        <td id="LC8077">            <span>if</span> (<span>value</span> <span>==</span> <span>null</span> <span>||</span> <span>value</span> <span>==</span> <span>ADP</span>.<span>StrEmpty</span>)</td>
      </tr>
      <tr>
        <td id="L8078" data-line-number="8078"></td>
        <td id="LC8078">            {</td>
      </tr>
      <tr>
        <td id="L8079" data-line-number="8079"></td>
        <td id="LC8079">                <span>return</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8080" data-line-number="8080"></td>
        <td id="LC8080">            }</td>
      </tr>
      <tr>
        <td id="L8081" data-line-number="8081"></td>
        <td id="LC8081">
</td>
      </tr>
      <tr>
        <td id="L8082" data-line-number="8082"></td>
        <td id="LC8082">            <span><span>//</span> if hitting 7.0 server, encoding will be null in metadata for columns or return values since</span></td>
      </tr>
      <tr>
        <td id="L8083" data-line-number="8083"></td>
        <td id="LC8083">            <span><span>//</span> 7.0 has no support for multiple code pages in data - single code page support only</span></td>
      </tr>
      <tr>
        <td id="L8084" data-line-number="8084"></td>
        <td id="LC8084">            <span>if</span> (<span>encoding</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8085" data-line-number="8085"></td>
        <td id="LC8085">            {</td>
      </tr>
      <tr>
        <td id="L8086" data-line-number="8086"></td>
        <td id="LC8086">                <span>if</span> (<span>null</span> <span>==</span> <span>_defaultEncoding</span>)</td>
      </tr>
      <tr>
        <td id="L8087" data-line-number="8087"></td>
        <td id="LC8087">                {</td>
      </tr>
      <tr>
        <td id="L8088" data-line-number="8088"></td>
        <td id="LC8088">                    <span>ThrowUnsupportedCollationEncountered</span>(<span>null</span>);</td>
      </tr>
      <tr>
        <td id="L8089" data-line-number="8089"></td>
        <td id="LC8089">                }</td>
      </tr>
      <tr>
        <td id="L8090" data-line-number="8090"></td>
        <td id="LC8090">
</td>
      </tr>
      <tr>
        <td id="L8091" data-line-number="8091"></td>
        <td id="LC8091">                <span>encoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L8092" data-line-number="8092"></td>
        <td id="LC8092">            }</td>
      </tr>
      <tr>
        <td id="L8093" data-line-number="8093"></td>
        <td id="LC8093">
</td>
      </tr>
      <tr>
        <td id="L8094" data-line-number="8094"></td>
        <td id="LC8094">            <span>char</span>[] <span>charData</span> <span>=</span> <span>value</span>.<span>ToCharArray</span>(<span>charOffset</span>, <span>numChars</span>);</td>
      </tr>
      <tr>
        <td id="L8095" data-line-number="8095"></td>
        <td id="LC8095">
</td>
      </tr>
      <tr>
        <td id="L8096" data-line-number="8096"></td>
        <td id="LC8096">            <span>return</span> <span>encoding</span>.<span>GetByteCount</span>(<span>charData</span>, <span>0</span>, <span>numChars</span>);</td>
      </tr>
      <tr>
        <td id="L8097" data-line-number="8097"></td>
        <td id="LC8097">        }</td>
      </tr>
      <tr>
        <td id="L8098" data-line-number="8098"></td>
        <td id="LC8098">
</td>
      </tr>
      <tr>
        <td id="L8099" data-line-number="8099"></td>
        <td id="LC8099">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L8100" data-line-number="8100"></td>
        <td id="LC8100">        <span><span>//</span> Returns the data stream length of the data identified by tds type or SqlMetaData returns</span></td>
      </tr>
      <tr>
        <td id="L8101" data-line-number="8101"></td>
        <td id="LC8101">        <span><span>//</span> Returns either the total size or the size of the first chunk for partially length prefixed types.</span></td>
      </tr>
      <tr>
        <td id="L8102" data-line-number="8102"></td>
        <td id="LC8102">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L8103" data-line-number="8103"></td>
        <td id="LC8103">        <span>internal</span> <span>bool</span> <span>TryGetDataLength</span>(<span>SqlMetaDataPriv</span> <span>colmeta</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>ulong</span> <span>length</span>)</td>
      </tr>
      <tr>
        <td id="L8104" data-line-number="8104"></td>
        <td id="LC8104">        {</td>
      </tr>
      <tr>
        <td id="L8105" data-line-number="8105"></td>
        <td id="LC8105">            <span><span>//</span> Handle Yukon specific tokens</span></td>
      </tr>
      <tr>
        <td id="L8106" data-line-number="8106"></td>
        <td id="LC8106">            <span>if</span> (<span>_isYukon</span> <span>&amp;&amp;</span> <span>colmeta</span>.<span>metaType</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L8107" data-line-number="8107"></td>
        <td id="LC8107">            {</td>
      </tr>
      <tr>
        <td id="L8108" data-line-number="8108"></td>
        <td id="LC8108">                <span>Debug</span>.<span>Assert</span>(<span>colmeta</span>.<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L8109" data-line-number="8109"></td>
        <td id="LC8109">                             <span>colmeta</span>.<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L8110" data-line-number="8110"></td>
        <td id="LC8110">                             <span>colmeta</span>.<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L8111" data-line-number="8111"></td>
        <td id="LC8111">                             <span>colmeta</span>.<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L8112" data-line-number="8112"></td>
        <td id="LC8112">                             <span><span>//</span> Large UDTs is WinFS-only</span></td>
      </tr>
      <tr>
        <td id="L8113" data-line-number="8113"></td>
        <td id="LC8113">                             <span>colmeta</span>.<span>tdsType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLUDT</span>,</td>
      </tr>
      <tr>
        <td id="L8114" data-line-number="8114"></td>
        <td id="LC8114">                             <span><span>"</span>GetDataLength:Invalid streaming datatype<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8115" data-line-number="8115"></td>
        <td id="LC8115">                <span>return</span> <span>stateObj</span>.<span>TryReadPlpLength</span>(<span>true</span>, <span>out</span> <span>length</span>);</td>
      </tr>
      <tr>
        <td id="L8116" data-line-number="8116"></td>
        <td id="LC8116">            }</td>
      </tr>
      <tr>
        <td id="L8117" data-line-number="8117"></td>
        <td id="LC8117">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8118" data-line-number="8118"></td>
        <td id="LC8118">            {</td>
      </tr>
      <tr>
        <td id="L8119" data-line-number="8119"></td>
        <td id="LC8119">                <span>int</span> <span>intLength</span>;</td>
      </tr>
      <tr>
        <td id="L8120" data-line-number="8120"></td>
        <td id="LC8120">                <span>if</span> (<span>!</span><span>TryGetTokenLength</span>(<span>colmeta</span>.<span>tdsType</span>, <span>stateObj</span>, <span>out</span> <span>intLength</span>))</td>
      </tr>
      <tr>
        <td id="L8121" data-line-number="8121"></td>
        <td id="LC8121">                {</td>
      </tr>
      <tr>
        <td id="L8122" data-line-number="8122"></td>
        <td id="LC8122">                    <span>length</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8123" data-line-number="8123"></td>
        <td id="LC8123">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L8124" data-line-number="8124"></td>
        <td id="LC8124">                }</td>
      </tr>
      <tr>
        <td id="L8125" data-line-number="8125"></td>
        <td id="LC8125">                <span>length</span> <span>=</span> (<span>ulong</span>)<span>intLength</span>;</td>
      </tr>
      <tr>
        <td id="L8126" data-line-number="8126"></td>
        <td id="LC8126">                <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8127" data-line-number="8127"></td>
        <td id="LC8127">            }</td>
      </tr>
      <tr>
        <td id="L8128" data-line-number="8128"></td>
        <td id="LC8128">        }</td>
      </tr>
      <tr>
        <td id="L8129" data-line-number="8129"></td>
        <td id="LC8129">
</td>
      </tr>
      <tr>
        <td id="L8130" data-line-number="8130"></td>
        <td id="LC8130">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L8131" data-line-number="8131"></td>
        <td id="LC8131">        <span><span>//</span> returns the token length of the token or tds type</span></td>
      </tr>
      <tr>
        <td id="L8132" data-line-number="8132"></td>
        <td id="LC8132">        <span><span>//</span> Returns -1 for partially length prefixed (plp) types for metadata info.</span></td>
      </tr>
      <tr>
        <td id="L8133" data-line-number="8133"></td>
        <td id="LC8133">        <span><span>//</span> DOES NOT handle plp data streams correctly!!!</span></td>
      </tr>
      <tr>
        <td id="L8134" data-line-number="8134"></td>
        <td id="LC8134">        <span><span>//</span> Plp data streams length information should be obtained from GetDataLength</span></td>
      </tr>
      <tr>
        <td id="L8135" data-line-number="8135"></td>
        <td id="LC8135">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L8136" data-line-number="8136"></td>
        <td id="LC8136">        <span>internal</span> <span>bool</span> <span>TryGetTokenLength</span>(<span>byte</span> <span>token</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>int</span> <span>tokenLength</span>)</td>
      </tr>
      <tr>
        <td id="L8137" data-line-number="8137"></td>
        <td id="LC8137">        {</td>
      </tr>
      <tr>
        <td id="L8138" data-line-number="8138"></td>
        <td id="LC8138">            <span>Debug</span>.<span>Assert</span>(<span>token</span> <span>!=</span> <span>0</span>, <span><span>"</span>0 length token!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8139" data-line-number="8139"></td>
        <td id="LC8139">
</td>
      </tr>
      <tr>
        <td id="L8140" data-line-number="8140"></td>
        <td id="LC8140">            <span>switch</span> (<span>token</span>)</td>
      </tr>
      <tr>
        <td id="L8141" data-line-number="8141"></td>
        <td id="LC8141">            { <span><span>//</span> rules about SQLLenMask no longer apply to new tokens (as of 7.4)</span></td>
      </tr>
      <tr>
        <td id="L8142" data-line-number="8142"></td>
        <td id="LC8142">                <span>case</span> <span>TdsEnums</span>.<span>SQLFEATUREEXTACK</span>:</td>
      </tr>
      <tr>
        <td id="L8143" data-line-number="8143"></td>
        <td id="LC8143">                    <span>tokenLength</span> <span>=</span> <span>-</span><span>1</span>;</td>
      </tr>
      <tr>
        <td id="L8144" data-line-number="8144"></td>
        <td id="LC8144">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8145" data-line-number="8145"></td>
        <td id="LC8145">                <span>case</span> <span>TdsEnums</span>.<span>SQLSESSIONSTATE</span>:</td>
      </tr>
      <tr>
        <td id="L8146" data-line-number="8146"></td>
        <td id="LC8146">                <span>case</span> <span>TdsEnums</span>.<span>SQLFEDAUTHINFO</span>:</td>
      </tr>
      <tr>
        <td id="L8147" data-line-number="8147"></td>
        <td id="LC8147">                    <span>return</span> <span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>tokenLength</span>);</td>
      </tr>
      <tr>
        <td id="L8148" data-line-number="8148"></td>
        <td id="LC8148">            }</td>
      </tr>
      <tr>
        <td id="L8149" data-line-number="8149"></td>
        <td id="LC8149">
</td>
      </tr>
      <tr>
        <td id="L8150" data-line-number="8150"></td>
        <td id="LC8150">            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L8151" data-line-number="8151"></td>
        <td id="LC8151">            {     <span><span>//</span> Handle Yukon specific exceptions</span></td>
      </tr>
      <tr>
        <td id="L8152" data-line-number="8152"></td>
        <td id="LC8152">                <span>if</span> (<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLUDT</span>)</td>
      </tr>
      <tr>
        <td id="L8153" data-line-number="8153"></td>
        <td id="LC8153">                { <span><span>//</span> special case for UDTs</span></td>
      </tr>
      <tr>
        <td id="L8154" data-line-number="8154"></td>
        <td id="LC8154">                    <span>tokenLength</span> <span>=</span> <span>-</span><span>1</span>; <span><span>//</span> Should we return -1 or not call GetTokenLength for UDTs?</span></td>
      </tr>
      <tr>
        <td id="L8155" data-line-number="8155"></td>
        <td id="LC8155">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8156" data-line-number="8156"></td>
        <td id="LC8156">                }</td>
      </tr>
      <tr>
        <td id="L8157" data-line-number="8157"></td>
        <td id="LC8157">                <span>else</span> <span>if</span> (<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLRETURNVALUE</span>)</td>
      </tr>
      <tr>
        <td id="L8158" data-line-number="8158"></td>
        <td id="LC8158">                {</td>
      </tr>
      <tr>
        <td id="L8159" data-line-number="8159"></td>
        <td id="LC8159">                    <span>tokenLength</span> <span>=</span> <span>-</span><span>1</span>; <span><span>//</span> In Yukon, the RETURNVALUE token stream no longer has length</span></td>
      </tr>
      <tr>
        <td id="L8160" data-line-number="8160"></td>
        <td id="LC8160">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8161" data-line-number="8161"></td>
        <td id="LC8161">                }</td>
      </tr>
      <tr>
        <td id="L8162" data-line-number="8162"></td>
        <td id="LC8162">                <span>else</span> <span>if</span> (<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>)</td>
      </tr>
      <tr>
        <td id="L8163" data-line-number="8163"></td>
        <td id="LC8163">                {</td>
      </tr>
      <tr>
        <td id="L8164" data-line-number="8164"></td>
        <td id="LC8164">                    <span>ushort</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L8165" data-line-number="8165"></td>
        <td id="LC8165">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L8166" data-line-number="8166"></td>
        <td id="LC8166">                    {</td>
      </tr>
      <tr>
        <td id="L8167" data-line-number="8167"></td>
        <td id="LC8167">                        <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8168" data-line-number="8168"></td>
        <td id="LC8168">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L8169" data-line-number="8169"></td>
        <td id="LC8169">                    }</td>
      </tr>
      <tr>
        <td id="L8170" data-line-number="8170"></td>
        <td id="LC8170">                    <span>tokenLength</span> <span>=</span> (<span>int</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L8171" data-line-number="8171"></td>
        <td id="LC8171">                    <span>Debug</span>.<span>Assert</span>(<span>tokenLength</span> <span>==</span> <span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>, <span><span>"</span>Invalid token stream for xml datatype<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8172" data-line-number="8172"></td>
        <td id="LC8172">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8173" data-line-number="8173"></td>
        <td id="LC8173">                }</td>
      </tr>
      <tr>
        <td id="L8174" data-line-number="8174"></td>
        <td id="LC8174">            }</td>
      </tr>
      <tr>
        <td id="L8175" data-line-number="8175"></td>
        <td id="LC8175">
</td>
      </tr>
      <tr>
        <td id="L8176" data-line-number="8176"></td>
        <td id="LC8176">            <span>switch</span> (<span>token</span> <span>&amp;</span> <span>TdsEnums</span>.<span>SQLLenMask</span>)</td>
      </tr>
      <tr>
        <td id="L8177" data-line-number="8177"></td>
        <td id="LC8177">            {</td>
      </tr>
      <tr>
        <td id="L8178" data-line-number="8178"></td>
        <td id="LC8178">                <span>case</span> <span>TdsEnums</span>.<span>SQLFixedLen</span>:</td>
      </tr>
      <tr>
        <td id="L8179" data-line-number="8179"></td>
        <td id="LC8179">                    <span>tokenLength</span> <span>=</span> ((<span>0x01</span> <span>&lt;&lt;</span> ((<span>token</span> <span>&amp;</span> <span>0x0c</span>) <span>&gt;&gt;</span> <span>2</span>))) <span>&amp;</span> <span>0xff</span>;</td>
      </tr>
      <tr>
        <td id="L8180" data-line-number="8180"></td>
        <td id="LC8180">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8181" data-line-number="8181"></td>
        <td id="LC8181">                <span>case</span> <span>TdsEnums</span>.<span>SQLZeroLen</span>:</td>
      </tr>
      <tr>
        <td id="L8182" data-line-number="8182"></td>
        <td id="LC8182">                    <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8183" data-line-number="8183"></td>
        <td id="LC8183">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8184" data-line-number="8184"></td>
        <td id="LC8184">                <span>case</span> <span>TdsEnums</span>.<span>SQLVarLen</span>:</td>
      </tr>
      <tr>
        <td id="L8185" data-line-number="8185"></td>
        <td id="LC8185">                <span>case</span> <span>TdsEnums</span>.<span>SQLVarCnt</span>:</td>
      </tr>
      <tr>
        <td id="L8186" data-line-number="8186"></td>
        <td id="LC8186">                    <span>if</span> (<span>0</span> <span>!=</span> (<span>token</span> <span>&amp;</span> <span>0x80</span>))</td>
      </tr>
      <tr>
        <td id="L8187" data-line-number="8187"></td>
        <td id="LC8187">                    {</td>
      </tr>
      <tr>
        <td id="L8188" data-line-number="8188"></td>
        <td id="LC8188">                        <span>ushort</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L8189" data-line-number="8189"></td>
        <td id="LC8189">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadUInt16</span>(<span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L8190" data-line-number="8190"></td>
        <td id="LC8190">                        {</td>
      </tr>
      <tr>
        <td id="L8191" data-line-number="8191"></td>
        <td id="LC8191">                            <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8192" data-line-number="8192"></td>
        <td id="LC8192">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L8193" data-line-number="8193"></td>
        <td id="LC8193">                        }</td>
      </tr>
      <tr>
        <td id="L8194" data-line-number="8194"></td>
        <td id="LC8194">                        <span>tokenLength</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L8195" data-line-number="8195"></td>
        <td id="LC8195">                        <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8196" data-line-number="8196"></td>
        <td id="LC8196">                    }</td>
      </tr>
      <tr>
        <td id="L8197" data-line-number="8197"></td>
        <td id="LC8197">                    <span>else</span> <span>if</span> (<span>0</span> <span>==</span> (<span>token</span> <span>&amp;</span> <span>0x0c</span>))</td>
      </tr>
      <tr>
        <td id="L8198" data-line-number="8198"></td>
        <td id="LC8198">                    {</td>
      </tr>
      <tr>
        <td id="L8199" data-line-number="8199"></td>
        <td id="LC8199">                        <span><span>//</span> UNDONE: This should be uint</span></td>
      </tr>
      <tr>
        <td id="L8200" data-line-number="8200"></td>
        <td id="LC8200">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadInt32</span>(<span>out</span> <span>tokenLength</span>))</td>
      </tr>
      <tr>
        <td id="L8201" data-line-number="8201"></td>
        <td id="LC8201">                        {</td>
      </tr>
      <tr>
        <td id="L8202" data-line-number="8202"></td>
        <td id="LC8202">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L8203" data-line-number="8203"></td>
        <td id="LC8203">                        }</td>
      </tr>
      <tr>
        <td id="L8204" data-line-number="8204"></td>
        <td id="LC8204">                        <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8205" data-line-number="8205"></td>
        <td id="LC8205">                    }</td>
      </tr>
      <tr>
        <td id="L8206" data-line-number="8206"></td>
        <td id="LC8206">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L8207" data-line-number="8207"></td>
        <td id="LC8207">                    {</td>
      </tr>
      <tr>
        <td id="L8208" data-line-number="8208"></td>
        <td id="LC8208">                        <span>byte</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L8209" data-line-number="8209"></td>
        <td id="LC8209">                        <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L8210" data-line-number="8210"></td>
        <td id="LC8210">                        {</td>
      </tr>
      <tr>
        <td id="L8211" data-line-number="8211"></td>
        <td id="LC8211">                            <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8212" data-line-number="8212"></td>
        <td id="LC8212">                            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L8213" data-line-number="8213"></td>
        <td id="LC8213">                        }</td>
      </tr>
      <tr>
        <td id="L8214" data-line-number="8214"></td>
        <td id="LC8214">                        <span>tokenLength</span> <span>=</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L8215" data-line-number="8215"></td>
        <td id="LC8215">                        <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8216" data-line-number="8216"></td>
        <td id="LC8216">                    }</td>
      </tr>
      <tr>
        <td id="L8217" data-line-number="8217"></td>
        <td id="LC8217">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L8218" data-line-number="8218"></td>
        <td id="LC8218">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown token length!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8219" data-line-number="8219"></td>
        <td id="LC8219">                    <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8220" data-line-number="8220"></td>
        <td id="LC8220">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8221" data-line-number="8221"></td>
        <td id="LC8221">            }</td>
      </tr>
      <tr>
        <td id="L8222" data-line-number="8222"></td>
        <td id="LC8222">        }</td>
      </tr>
      <tr>
        <td id="L8223" data-line-number="8223"></td>
        <td id="LC8223">
</td>
      </tr>
      <tr>
        <td id="L8224" data-line-number="8224"></td>
        <td id="LC8224">        <span>private</span> <span>void</span> <span>ProcessAttention</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L8225" data-line-number="8225"></td>
        <td id="LC8225">        {</td>
      </tr>
      <tr>
        <td id="L8226" data-line-number="8226"></td>
        <td id="LC8226">            <span>if</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Closed</span> <span>||</span> <span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Broken</span>)</td>
      </tr>
      <tr>
        <td id="L8227" data-line-number="8227"></td>
        <td id="LC8227">            {</td>
      </tr>
      <tr>
        <td id="L8228" data-line-number="8228"></td>
        <td id="LC8228">                <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L8229" data-line-number="8229"></td>
        <td id="LC8229">            }</td>
      </tr>
      <tr>
        <td id="L8230" data-line-number="8230"></td>
        <td id="LC8230">            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_attentionSent</span>, <span><span>"</span>invalid attempt to ProcessAttention, attentionSent == false!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8231" data-line-number="8231"></td>
        <td id="LC8231">
</td>
      </tr>
      <tr>
        <td id="L8232" data-line-number="8232"></td>
        <td id="LC8232">            <span><span>//</span> Attention processing scenarios:</span></td>
      </tr>
      <tr>
        <td id="L8233" data-line-number="8233"></td>
        <td id="LC8233">            <span><span>//</span> 1) EOM packet with header ST_AACK bit plus DONE with status DONE_ATTN</span></td>
      </tr>
      <tr>
        <td id="L8234" data-line-number="8234"></td>
        <td id="LC8234">            <span><span>//</span> 2) Packet without ST_AACK header bit but has DONE with status DONE_ATTN</span></td>
      </tr>
      <tr>
        <td id="L8235" data-line-number="8235"></td>
        <td id="LC8235">            <span><span>//</span> 3) Secondary timeout occurs while reading, break connection</span></td>
      </tr>
      <tr>
        <td id="L8236" data-line-number="8236"></td>
        <td id="LC8236">
</td>
      </tr>
      <tr>
        <td id="L8237" data-line-number="8237"></td>
        <td id="LC8237">            <span><span>//</span> Since errors can occur and we need to cancel prior to throwing those errors, we</span></td>
      </tr>
      <tr>
        <td id="L8238" data-line-number="8238"></td>
        <td id="LC8238">            <span><span>//</span> cache away error state and then process TDS for the attention.  We restore those</span></td>
      </tr>
      <tr>
        <td id="L8239" data-line-number="8239"></td>
        <td id="LC8239">            <span><span>//</span> errors after processing.</span></td>
      </tr>
      <tr>
        <td id="L8240" data-line-number="8240"></td>
        <td id="LC8240">            <span>stateObj</span>.<span>StoreErrorAndWarningForAttention</span>();</td>
      </tr>
      <tr>
        <td id="L8241" data-line-number="8241"></td>
        <td id="LC8241">
</td>
      </tr>
      <tr>
        <td id="L8242" data-line-number="8242"></td>
        <td id="LC8242">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L8243" data-line-number="8243"></td>
        <td id="LC8243">            {</td>
      </tr>
      <tr>
        <td id="L8244" data-line-number="8244"></td>
        <td id="LC8244">                <span><span>//</span> Call run loop to process looking for attention ack.</span></td>
      </tr>
      <tr>
        <td id="L8245" data-line-number="8245"></td>
        <td id="LC8245">                <span>Run</span>(<span>RunBehavior</span>.<span>Attention</span>, <span>null</span>, <span>null</span>, <span>null</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8246" data-line-number="8246"></td>
        <td id="LC8246">            }</td>
      </tr>
      <tr>
        <td id="L8247" data-line-number="8247"></td>
        <td id="LC8247">            <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L8248" data-line-number="8248"></td>
        <td id="LC8248">            {</td>
      </tr>
      <tr>
        <td id="L8249" data-line-number="8249"></td>
        <td id="LC8249">                <span><span>//</span> UNDONE - should not be catching all exceptions!!!</span></td>
      </tr>
      <tr>
        <td id="L8250" data-line-number="8250"></td>
        <td id="LC8250">                <span>if</span> (<span>!</span><span>ADP</span>.<span>IsCatchableExceptionType</span>(<span>e</span>))</td>
      </tr>
      <tr>
        <td id="L8251" data-line-number="8251"></td>
        <td id="LC8251">                {</td>
      </tr>
      <tr>
        <td id="L8252" data-line-number="8252"></td>
        <td id="LC8252">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L8253" data-line-number="8253"></td>
        <td id="LC8253">                }</td>
      </tr>
      <tr>
        <td id="L8254" data-line-number="8254"></td>
        <td id="LC8254">
</td>
      </tr>
      <tr>
        <td id="L8255" data-line-number="8255"></td>
        <td id="LC8255">                <span><span>//</span> If an exception occurs - break the connection.</span></td>
      </tr>
      <tr>
        <td id="L8256" data-line-number="8256"></td>
        <td id="LC8256">                <span><span>//</span> Attention error will not be thrown in this case by Run(), but other failures may.</span></td>
      </tr>
      <tr>
        <td id="L8257" data-line-number="8257"></td>
        <td id="LC8257">                <span>ADP</span>.<span>TraceExceptionWithoutRethrow</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L8258" data-line-number="8258"></td>
        <td id="LC8258">                <span>_state</span> <span>=</span> <span>TdsParserState</span>.<span>Broken</span>;</td>
      </tr>
      <tr>
        <td id="L8259" data-line-number="8259"></td>
        <td id="LC8259">                <span>_connHandler</span>.<span>BreakConnection</span>();</td>
      </tr>
      <tr>
        <td id="L8260" data-line-number="8260"></td>
        <td id="LC8260">
</td>
      </tr>
      <tr>
        <td id="L8261" data-line-number="8261"></td>
        <td id="LC8261">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L8262" data-line-number="8262"></td>
        <td id="LC8262">            }</td>
      </tr>
      <tr>
        <td id="L8263" data-line-number="8263"></td>
        <td id="LC8263">
</td>
      </tr>
      <tr>
        <td id="L8264" data-line-number="8264"></td>
        <td id="LC8264">            <span>stateObj</span>.<span>RestoreErrorAndWarningAfterAttention</span>();</td>
      </tr>
      <tr>
        <td id="L8265" data-line-number="8265"></td>
        <td id="LC8265">
</td>
      </tr>
      <tr>
        <td id="L8266" data-line-number="8266"></td>
        <td id="LC8266">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>stateObj</span>.<span>_attentionSent</span>, <span><span>"</span>Invalid attentionSent state at end of ProcessAttention<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8267" data-line-number="8267"></td>
        <td id="LC8267">        }</td>
      </tr>
      <tr>
        <td id="L8268" data-line-number="8268"></td>
        <td id="LC8268">
</td>
      </tr>
      <tr>
        <td id="L8269" data-line-number="8269"></td>
        <td id="LC8269">        <span>static</span> <span>private</span> <span>int</span> <span>StateValueLength</span>(<span>int</span> <span>dataLen</span>)</td>
      </tr>
      <tr>
        <td id="L8270" data-line-number="8270"></td>
        <td id="LC8270">        {</td>
      </tr>
      <tr>
        <td id="L8271" data-line-number="8271"></td>
        <td id="LC8271">            <span>return</span> <span>dataLen</span> <span>&lt;</span> <span>0xFF</span> <span>?</span> (<span>dataLen</span> <span>+</span> <span>1</span>) <span>:</span> (<span>dataLen</span> <span>+</span> <span>5</span>);</td>
      </tr>
      <tr>
        <td id="L8272" data-line-number="8272"></td>
        <td id="LC8272">        }</td>
      </tr>
      <tr>
        <td id="L8273" data-line-number="8273"></td>
        <td id="LC8273">
</td>
      </tr>
      <tr>
        <td id="L8274" data-line-number="8274"></td>
        <td id="LC8274">        <span>internal</span> <span>int</span> <span>WriteSessionRecoveryFeatureRequest</span>(<span>SessionData</span> <span>reconnectData</span>, <span>bool</span> <span>write</span> <span><span>/*</span> if false just calculates the length <span>*/</span></span>)</td>
      </tr>
      <tr>
        <td id="L8275" data-line-number="8275"></td>
        <td id="LC8275">        {</td>
      </tr>
      <tr>
        <td id="L8276" data-line-number="8276"></td>
        <td id="LC8276">            <span>int</span> <span>len</span> <span>=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L8277" data-line-number="8277"></td>
        <td id="LC8277">            <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8278" data-line-number="8278"></td>
        <td id="LC8278">            {</td>
      </tr>
      <tr>
        <td id="L8279" data-line-number="8279"></td>
        <td id="LC8279">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FEATUREEXT_SRECOVERY</span>);</td>
      </tr>
      <tr>
        <td id="L8280" data-line-number="8280"></td>
        <td id="LC8280">            }</td>
      </tr>
      <tr>
        <td id="L8281" data-line-number="8281"></td>
        <td id="LC8281">            <span>if</span> (<span>reconnectData</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8282" data-line-number="8282"></td>
        <td id="LC8282">            {</td>
      </tr>
      <tr>
        <td id="L8283" data-line-number="8283"></td>
        <td id="LC8283">                <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8284" data-line-number="8284"></td>
        <td id="LC8284">                {</td>
      </tr>
      <tr>
        <td id="L8285" data-line-number="8285"></td>
        <td id="LC8285">                    <span>WriteInt</span>(<span>0</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8286" data-line-number="8286"></td>
        <td id="LC8286">                }</td>
      </tr>
      <tr>
        <td id="L8287" data-line-number="8287"></td>
        <td id="LC8287">                <span>len</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L8288" data-line-number="8288"></td>
        <td id="LC8288">            }</td>
      </tr>
      <tr>
        <td id="L8289" data-line-number="8289"></td>
        <td id="LC8289">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8290" data-line-number="8290"></td>
        <td id="LC8290">            {</td>
      </tr>
      <tr>
        <td id="L8291" data-line-number="8291"></td>
        <td id="LC8291">                <span>Debug</span>.<span>Assert</span>(<span>reconnectData</span>.<span>_unrecoverableStatesCount</span> <span>==</span> <span>0</span>, <span><span>"</span>Unrecoverable state count should be 0<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8292" data-line-number="8292"></td>
        <td id="LC8292">                <span>int</span> <span>initialLength</span> <span>=</span> <span>0</span>; <span><span>//</span> sizeof(DWORD) - length itself</span></td>
      </tr>
      <tr>
        <td id="L8293" data-line-number="8293"></td>
        <td id="LC8293">                <span>initialLength</span> <span>+=</span> <span>1</span> <span>+</span> <span>2</span> <span>*</span> <span>TdsParserStaticMethods</span>.<span>NullAwareStringLength</span>(<span>reconnectData</span>.<span>_initialDatabase</span>);</td>
      </tr>
      <tr>
        <td id="L8294" data-line-number="8294"></td>
        <td id="LC8294">                <span>initialLength</span> <span>+=</span> <span>1</span> <span>+</span> <span>2</span> <span>*</span> <span>TdsParserStaticMethods</span>.<span>NullAwareStringLength</span>(<span>reconnectData</span>.<span>_initialLanguage</span>);</td>
      </tr>
      <tr>
        <td id="L8295" data-line-number="8295"></td>
        <td id="LC8295">                <span>initialLength</span> <span>+=</span> (<span>reconnectData</span>.<span>_initialCollation</span> <span>==</span> <span>null</span>) <span>?</span> <span>1</span> <span>:</span> <span>6</span>;</td>
      </tr>
      <tr>
        <td id="L8296" data-line-number="8296"></td>
        <td id="LC8296">                <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>SessionData</span>.<span>_maxNumberOfSessionStates</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L8297" data-line-number="8297"></td>
        <td id="LC8297">                {</td>
      </tr>
      <tr>
        <td id="L8298" data-line-number="8298"></td>
        <td id="LC8298">                    <span>if</span> (<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>] <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8299" data-line-number="8299"></td>
        <td id="LC8299">                    {</td>
      </tr>
      <tr>
        <td id="L8300" data-line-number="8300"></td>
        <td id="LC8300">                        <span>initialLength</span> <span>+=</span> <span>1</span> <span><span>/*</span> StateId<span>*/</span></span> <span>+</span> <span>StateValueLength</span>(<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>].<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L8301" data-line-number="8301"></td>
        <td id="LC8301">                    }</td>
      </tr>
      <tr>
        <td id="L8302" data-line-number="8302"></td>
        <td id="LC8302">                }</td>
      </tr>
      <tr>
        <td id="L8303" data-line-number="8303"></td>
        <td id="LC8303">                <span>int</span> <span>currentLength</span> <span>=</span> <span>0</span>; <span><span>//</span> sizeof(DWORD) - length itself</span></td>
      </tr>
      <tr>
        <td id="L8304" data-line-number="8304"></td>
        <td id="LC8304">                <span>currentLength</span> <span>+=</span> <span>1</span> <span>+</span> <span>2</span> <span>*</span> (<span>reconnectData</span>.<span>_initialDatabase</span> <span>==</span> <span>reconnectData</span>.<span>_database</span> <span>?</span> <span>0</span> <span>:</span> <span>TdsParserStaticMethods</span>.<span>NullAwareStringLength</span>(<span>reconnectData</span>.<span>_database</span>));</td>
      </tr>
      <tr>
        <td id="L8305" data-line-number="8305"></td>
        <td id="LC8305">                <span>currentLength</span> <span>+=</span> <span>1</span> <span>+</span> <span>2</span> <span>*</span> (<span>reconnectData</span>.<span>_initialLanguage</span> <span>==</span> <span>reconnectData</span>.<span>_language</span> <span>?</span> <span>0</span> <span>:</span> <span>TdsParserStaticMethods</span>.<span>NullAwareStringLength</span>(<span>reconnectData</span>.<span>_language</span>));</td>
      </tr>
      <tr>
        <td id="L8306" data-line-number="8306"></td>
        <td id="LC8306">                <span>currentLength</span> <span>+=</span> (<span>reconnectData</span>.<span>_collation</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>!</span><span>SqlCollation</span>.<span>AreSame</span>(<span>reconnectData</span>.<span>_collation</span>, <span>reconnectData</span>.<span>_initialCollation</span>)) <span>?</span> <span>6</span> <span>:</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L8307" data-line-number="8307"></td>
        <td id="LC8307">                <span>bool</span>[] <span>writeState</span> <span>=</span> <span>new</span> <span>bool</span>[<span>SessionData</span>.<span>_maxNumberOfSessionStates</span>];</td>
      </tr>
      <tr>
        <td id="L8308" data-line-number="8308"></td>
        <td id="LC8308">                <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>SessionData</span>.<span>_maxNumberOfSessionStates</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L8309" data-line-number="8309"></td>
        <td id="LC8309">                {</td>
      </tr>
      <tr>
        <td id="L8310" data-line-number="8310"></td>
        <td id="LC8310">                    <span>if</span> (<span>reconnectData</span>.<span>_delta</span>[<span>i</span>] <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8311" data-line-number="8311"></td>
        <td id="LC8311">                    {</td>
      </tr>
      <tr>
        <td id="L8312" data-line-number="8312"></td>
        <td id="LC8312">                        <span>Debug</span>.<span>Assert</span>(<span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_recoverable</span>, <span><span>"</span>State should be recoverable<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8313" data-line-number="8313"></td>
        <td id="LC8313">                        <span>writeState</span>[<span>i</span>] <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8314" data-line-number="8314"></td>
        <td id="LC8314">                        <span>if</span> (<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>] <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>reconnectData</span>.<span>_initialState</span>[<span>i</span>].<span>Length</span> <span>==</span> <span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_dataLength</span>)</td>
      </tr>
      <tr>
        <td id="L8315" data-line-number="8315"></td>
        <td id="LC8315">                        {</td>
      </tr>
      <tr>
        <td id="L8316" data-line-number="8316"></td>
        <td id="LC8316">                            <span>writeState</span>[<span>i</span>] <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L8317" data-line-number="8317"></td>
        <td id="LC8317">                            <span>for</span> (<span>int</span> <span>j</span> <span>=</span> <span>0</span>; <span>j</span> <span>&lt;</span> <span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_dataLength</span>; <span>j</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L8318" data-line-number="8318"></td>
        <td id="LC8318">                            {</td>
      </tr>
      <tr>
        <td id="L8319" data-line-number="8319"></td>
        <td id="LC8319">                                <span>if</span> (<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>][<span>j</span>] <span>!=</span> <span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_data</span>[<span>j</span>])</td>
      </tr>
      <tr>
        <td id="L8320" data-line-number="8320"></td>
        <td id="LC8320">                                {</td>
      </tr>
      <tr>
        <td id="L8321" data-line-number="8321"></td>
        <td id="LC8321">                                    <span>writeState</span>[<span>i</span>] <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L8322" data-line-number="8322"></td>
        <td id="LC8322">                                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8323" data-line-number="8323"></td>
        <td id="LC8323">                                }</td>
      </tr>
      <tr>
        <td id="L8324" data-line-number="8324"></td>
        <td id="LC8324">                            }</td>
      </tr>
      <tr>
        <td id="L8325" data-line-number="8325"></td>
        <td id="LC8325">                        }</td>
      </tr>
      <tr>
        <td id="L8326" data-line-number="8326"></td>
        <td id="LC8326">                        <span>if</span> (<span>writeState</span>[<span>i</span>])</td>
      </tr>
      <tr>
        <td id="L8327" data-line-number="8327"></td>
        <td id="LC8327">                        {</td>
      </tr>
      <tr>
        <td id="L8328" data-line-number="8328"></td>
        <td id="LC8328">                            <span>currentLength</span> <span>+=</span> <span>1</span> <span><span>/*</span> StateId<span>*/</span></span> <span>+</span> <span>StateValueLength</span>(<span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_dataLength</span>);</td>
      </tr>
      <tr>
        <td id="L8329" data-line-number="8329"></td>
        <td id="LC8329">                        }</td>
      </tr>
      <tr>
        <td id="L8330" data-line-number="8330"></td>
        <td id="LC8330">                    }</td>
      </tr>
      <tr>
        <td id="L8331" data-line-number="8331"></td>
        <td id="LC8331">                }</td>
      </tr>
      <tr>
        <td id="L8332" data-line-number="8332"></td>
        <td id="LC8332">                <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8333" data-line-number="8333"></td>
        <td id="LC8333">                {</td>
      </tr>
      <tr>
        <td id="L8334" data-line-number="8334"></td>
        <td id="LC8334">                    <span>WriteInt</span>(<span>8</span> <span>+</span> <span>initialLength</span> <span>+</span> <span>currentLength</span>, <span>_physicalStateObj</span>); <span><span>//</span> length of data w/o total length (initil+current+2*sizeof(DWORD))</span></td>
      </tr>
      <tr>
        <td id="L8335" data-line-number="8335"></td>
        <td id="LC8335">                    <span>WriteInt</span>(<span>initialLength</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8336" data-line-number="8336"></td>
        <td id="LC8336">                    <span>WriteIdentifier</span>(<span>reconnectData</span>.<span>_initialDatabase</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8337" data-line-number="8337"></td>
        <td id="LC8337">                    <span>WriteCollation</span>(<span>reconnectData</span>.<span>_initialCollation</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8338" data-line-number="8338"></td>
        <td id="LC8338">                    <span>WriteIdentifier</span>(<span>reconnectData</span>.<span>_initialLanguage</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8339" data-line-number="8339"></td>
        <td id="LC8339">                    <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>SessionData</span>.<span>_maxNumberOfSessionStates</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L8340" data-line-number="8340"></td>
        <td id="LC8340">                    {</td>
      </tr>
      <tr>
        <td id="L8341" data-line-number="8341"></td>
        <td id="LC8341">                        <span>if</span> (<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>] <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8342" data-line-number="8342"></td>
        <td id="LC8342">                        {</td>
      </tr>
      <tr>
        <td id="L8343" data-line-number="8343"></td>
        <td id="LC8343">                            <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>i</span>);</td>
      </tr>
      <tr>
        <td id="L8344" data-line-number="8344"></td>
        <td id="LC8344">                            <span>if</span> (<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>].<span>Length</span> <span>&lt;</span> <span>0xFF</span>)</td>
      </tr>
      <tr>
        <td id="L8345" data-line-number="8345"></td>
        <td id="LC8345">                            {</td>
      </tr>
      <tr>
        <td id="L8346" data-line-number="8346"></td>
        <td id="LC8346">                                <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>].<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L8347" data-line-number="8347"></td>
        <td id="LC8347">                            }</td>
      </tr>
      <tr>
        <td id="L8348" data-line-number="8348"></td>
        <td id="LC8348">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8349" data-line-number="8349"></td>
        <td id="LC8349">                            {</td>
      </tr>
      <tr>
        <td id="L8350" data-line-number="8350"></td>
        <td id="LC8350">                                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>0xFF</span>);</td>
      </tr>
      <tr>
        <td id="L8351" data-line-number="8351"></td>
        <td id="LC8351">                                <span>WriteInt</span>(<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>].<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8352" data-line-number="8352"></td>
        <td id="LC8352">                            }</td>
      </tr>
      <tr>
        <td id="L8353" data-line-number="8353"></td>
        <td id="LC8353">                            <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>reconnectData</span>.<span>_initialState</span>[<span>i</span>], <span>reconnectData</span>.<span>_initialState</span>[<span>i</span>].<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8354" data-line-number="8354"></td>
        <td id="LC8354">                        }</td>
      </tr>
      <tr>
        <td id="L8355" data-line-number="8355"></td>
        <td id="LC8355">                    }</td>
      </tr>
      <tr>
        <td id="L8356" data-line-number="8356"></td>
        <td id="LC8356">                    <span>WriteInt</span>(<span>currentLength</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8357" data-line-number="8357"></td>
        <td id="LC8357">                    <span>WriteIdentifier</span>(<span>reconnectData</span>.<span>_database</span> <span>!=</span> <span>reconnectData</span>.<span>_initialDatabase</span> <span>?</span> <span>reconnectData</span>.<span>_database</span> <span>:</span> <span>null</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8358" data-line-number="8358"></td>
        <td id="LC8358">                    <span>WriteCollation</span>(<span>SqlCollation</span>.<span>AreSame</span>(<span>reconnectData</span>.<span>_initialCollation</span>, <span>reconnectData</span>.<span>_collation</span>) <span>?</span> <span>null</span> <span>:</span> <span>reconnectData</span>.<span>_collation</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8359" data-line-number="8359"></td>
        <td id="LC8359">                    <span>WriteIdentifier</span>(<span>reconnectData</span>.<span>_language</span> <span>!=</span> <span>reconnectData</span>.<span>_initialLanguage</span> <span>?</span> <span>reconnectData</span>.<span>_language</span> <span>:</span> <span>null</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8360" data-line-number="8360"></td>
        <td id="LC8360">                    <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>SessionData</span>.<span>_maxNumberOfSessionStates</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L8361" data-line-number="8361"></td>
        <td id="LC8361">                    {</td>
      </tr>
      <tr>
        <td id="L8362" data-line-number="8362"></td>
        <td id="LC8362">                        <span>if</span> (<span>writeState</span>[<span>i</span>])</td>
      </tr>
      <tr>
        <td id="L8363" data-line-number="8363"></td>
        <td id="LC8363">                        {</td>
      </tr>
      <tr>
        <td id="L8364" data-line-number="8364"></td>
        <td id="LC8364">                            <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>i</span>);</td>
      </tr>
      <tr>
        <td id="L8365" data-line-number="8365"></td>
        <td id="LC8365">                            <span>if</span> (<span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_dataLength</span> <span>&lt;</span> <span>0xFF</span>)</td>
      </tr>
      <tr>
        <td id="L8366" data-line-number="8366"></td>
        <td id="LC8366">                            {</td>
      </tr>
      <tr>
        <td id="L8367" data-line-number="8367"></td>
        <td id="LC8367">                                <span>_physicalStateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_dataLength</span>);</td>
      </tr>
      <tr>
        <td id="L8368" data-line-number="8368"></td>
        <td id="LC8368">                            }</td>
      </tr>
      <tr>
        <td id="L8369" data-line-number="8369"></td>
        <td id="LC8369">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8370" data-line-number="8370"></td>
        <td id="LC8370">                            {</td>
      </tr>
      <tr>
        <td id="L8371" data-line-number="8371"></td>
        <td id="LC8371">                                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>0xFF</span>);</td>
      </tr>
      <tr>
        <td id="L8372" data-line-number="8372"></td>
        <td id="LC8372">                                <span>WriteInt</span>(<span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_dataLength</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8373" data-line-number="8373"></td>
        <td id="LC8373">                            }</td>
      </tr>
      <tr>
        <td id="L8374" data-line-number="8374"></td>
        <td id="LC8374">                            <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_data</span>, <span>reconnectData</span>.<span>_delta</span>[<span>i</span>].<span>_dataLength</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8375" data-line-number="8375"></td>
        <td id="LC8375">                        }</td>
      </tr>
      <tr>
        <td id="L8376" data-line-number="8376"></td>
        <td id="LC8376">                    }</td>
      </tr>
      <tr>
        <td id="L8377" data-line-number="8377"></td>
        <td id="LC8377">                }</td>
      </tr>
      <tr>
        <td id="L8378" data-line-number="8378"></td>
        <td id="LC8378">                <span>len</span> <span>+=</span> <span>initialLength</span> <span>+</span> <span>currentLength</span> <span>+</span> <span>12</span> <span><span>/*</span> length fields (initial, current, total) <span>*/</span></span>;</td>
      </tr>
      <tr>
        <td id="L8379" data-line-number="8379"></td>
        <td id="LC8379">            }</td>
      </tr>
      <tr>
        <td id="L8380" data-line-number="8380"></td>
        <td id="LC8380">            <span>return</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L8381" data-line-number="8381"></td>
        <td id="LC8381">        }</td>
      </tr>
      <tr>
        <td id="L8382" data-line-number="8382"></td>
        <td id="LC8382">
</td>
      </tr>
      <tr>
        <td id="L8383" data-line-number="8383"></td>
        <td id="LC8383">        <span>internal</span> <span>int</span> <span>WriteFedAuthFeatureRequest</span>(<span>FederatedAuthenticationFeatureExtensionData</span> <span>fedAuthFeatureData</span>,</td>
      </tr>
      <tr>
        <td id="L8384" data-line-number="8384"></td>
        <td id="LC8384">                                                <span>bool</span> <span>write</span> <span><span>/*</span> if false just calculates the length <span>*/</span></span>)</td>
      </tr>
      <tr>
        <td id="L8385" data-line-number="8385"></td>
        <td id="LC8385">        {</td>
      </tr>
      <tr>
        <td id="L8386" data-line-number="8386"></td>
        <td id="LC8386">            <span>Debug</span>.<span>Assert</span>(<span>fedAuthFeatureData</span>.<span>libraryType</span> <span>==</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>MSAL</span> <span>||</span> <span>fedAuthFeatureData</span>.<span>libraryType</span> <span>==</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>SecurityToken</span>,</td>
      </tr>
      <tr>
        <td id="L8387" data-line-number="8387"></td>
        <td id="LC8387">                <span><span>"</span>only fed auth library type MSAL and Security Token are supported in writing feature request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8388" data-line-number="8388"></td>
        <td id="LC8388">
</td>
      </tr>
      <tr>
        <td id="L8389" data-line-number="8389"></td>
        <td id="LC8389">            <span>int</span> <span>dataLen</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8390" data-line-number="8390"></td>
        <td id="LC8390">            <span>int</span> <span>totalLen</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8391" data-line-number="8391"></td>
        <td id="LC8391">
</td>
      </tr>
      <tr>
        <td id="L8392" data-line-number="8392"></td>
        <td id="LC8392">            <span><span>//</span> set dataLen and totalLen</span></td>
      </tr>
      <tr>
        <td id="L8393" data-line-number="8393"></td>
        <td id="LC8393">            <span>switch</span> (<span>fedAuthFeatureData</span>.<span>libraryType</span>)</td>
      </tr>
      <tr>
        <td id="L8394" data-line-number="8394"></td>
        <td id="LC8394">            {</td>
      </tr>
      <tr>
        <td id="L8395" data-line-number="8395"></td>
        <td id="LC8395">                <span>case</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>MSAL</span>:</td>
      </tr>
      <tr>
        <td id="L8396" data-line-number="8396"></td>
        <td id="LC8396">                    <span>dataLen</span> <span>=</span> <span>2</span>;  <span><span>//</span> length of feature data = 1 byte for library and echo + 1 byte for workflow</span></td>
      </tr>
      <tr>
        <td id="L8397" data-line-number="8397"></td>
        <td id="LC8397">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8398" data-line-number="8398"></td>
        <td id="LC8398">                <span>case</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>SecurityToken</span>:</td>
      </tr>
      <tr>
        <td id="L8399" data-line-number="8399"></td>
        <td id="LC8399">                    <span>Debug</span>.<span>Assert</span>(<span>fedAuthFeatureData</span>.<span>accessToken</span> <span>!=</span> <span>null</span>, <span><span>"</span>AccessToken should not be null.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8400" data-line-number="8400"></td>
        <td id="LC8400">                    <span>dataLen</span> <span>=</span> <span>1</span> <span>+</span> <span>sizeof</span>(<span>int</span>) <span>+</span> <span>fedAuthFeatureData</span>.<span>accessToken</span>.<span>Length</span>; <span><span>//</span> length of feature data = 1 byte for library and echo, security token length and sizeof(int) for token lengh itself</span></td>
      </tr>
      <tr>
        <td id="L8401" data-line-number="8401"></td>
        <td id="LC8401">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8402" data-line-number="8402"></td>
        <td id="LC8402">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L8403" data-line-number="8403"></td>
        <td id="LC8403">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unrecognized library type for fedauth feature extension request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8404" data-line-number="8404"></td>
        <td id="LC8404">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8405" data-line-number="8405"></td>
        <td id="LC8405">            }</td>
      </tr>
      <tr>
        <td id="L8406" data-line-number="8406"></td>
        <td id="LC8406">
</td>
      </tr>
      <tr>
        <td id="L8407" data-line-number="8407"></td>
        <td id="LC8407">            <span>totalLen</span> <span>=</span> <span>dataLen</span> <span>+</span> <span>5</span>; <span><span>//</span> length of feature id (1 byte), data length field (4 bytes), and feature data (dataLen)</span></td>
      </tr>
      <tr>
        <td id="L8408" data-line-number="8408"></td>
        <td id="LC8408">
</td>
      </tr>
      <tr>
        <td id="L8409" data-line-number="8409"></td>
        <td id="LC8409">            <span><span>//</span> write feature id</span></td>
      </tr>
      <tr>
        <td id="L8410" data-line-number="8410"></td>
        <td id="LC8410">            <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8411" data-line-number="8411"></td>
        <td id="LC8411">            {</td>
      </tr>
      <tr>
        <td id="L8412" data-line-number="8412"></td>
        <td id="LC8412">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FEATUREEXT_FEDAUTH</span>);</td>
      </tr>
      <tr>
        <td id="L8413" data-line-number="8413"></td>
        <td id="LC8413">
</td>
      </tr>
      <tr>
        <td id="L8414" data-line-number="8414"></td>
        <td id="LC8414">                <span><span>//</span> set options</span></td>
      </tr>
      <tr>
        <td id="L8415" data-line-number="8415"></td>
        <td id="LC8415">                <span>byte</span> <span>options</span> <span>=</span> <span>0x00</span>;</td>
      </tr>
      <tr>
        <td id="L8416" data-line-number="8416"></td>
        <td id="LC8416">
</td>
      </tr>
      <tr>
        <td id="L8417" data-line-number="8417"></td>
        <td id="LC8417">                <span><span>//</span> set upper 7 bits of options to indicate fed auth library type</span></td>
      </tr>
      <tr>
        <td id="L8418" data-line-number="8418"></td>
        <td id="LC8418">                <span>switch</span> (<span>fedAuthFeatureData</span>.<span>libraryType</span>)</td>
      </tr>
      <tr>
        <td id="L8419" data-line-number="8419"></td>
        <td id="LC8419">                {</td>
      </tr>
      <tr>
        <td id="L8420" data-line-number="8420"></td>
        <td id="LC8420">                    <span>case</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>MSAL</span>:</td>
      </tr>
      <tr>
        <td id="L8421" data-line-number="8421"></td>
        <td id="LC8421">                        <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span>.<span>_federatedAuthenticationInfoRequested</span> <span>==</span> <span>true</span>, <span><span>"</span>_federatedAuthenticationInfoRequested field should be true<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8422" data-line-number="8422"></td>
        <td id="LC8422">                        <span>options</span> <span>|=</span> <span>TdsEnums</span>.<span>FEDAUTHLIB_MSAL</span> <span>&lt;&lt;</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L8423" data-line-number="8423"></td>
        <td id="LC8423">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8424" data-line-number="8424"></td>
        <td id="LC8424">                    <span>case</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>SecurityToken</span>:</td>
      </tr>
      <tr>
        <td id="L8425" data-line-number="8425"></td>
        <td id="LC8425">                        <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span>.<span>_federatedAuthenticationRequested</span> <span>==</span> <span>true</span>, <span><span>"</span>_federatedAuthenticationRequested field should be true<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8426" data-line-number="8426"></td>
        <td id="LC8426">                        <span>options</span> <span>|=</span> <span>TdsEnums</span>.<span>FEDAUTHLIB_SECURITYTOKEN</span> <span>&lt;&lt;</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L8427" data-line-number="8427"></td>
        <td id="LC8427">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8428" data-line-number="8428"></td>
        <td id="LC8428">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L8429" data-line-number="8429"></td>
        <td id="LC8429">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unrecognized FedAuthLibrary type for feature extension request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8430" data-line-number="8430"></td>
        <td id="LC8430">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8431" data-line-number="8431"></td>
        <td id="LC8431">                }</td>
      </tr>
      <tr>
        <td id="L8432" data-line-number="8432"></td>
        <td id="LC8432">
</td>
      </tr>
      <tr>
        <td id="L8433" data-line-number="8433"></td>
        <td id="LC8433">                <span>options</span> <span>|=</span> (<span>byte</span>)(<span>fedAuthFeatureData</span>.<span>fedAuthRequiredPreLoginResponse</span> <span>==</span> <span>true</span> <span>?</span> <span>0x01</span> <span>:</span> <span>0x00</span>);</td>
      </tr>
      <tr>
        <td id="L8434" data-line-number="8434"></td>
        <td id="LC8434">
</td>
      </tr>
      <tr>
        <td id="L8435" data-line-number="8435"></td>
        <td id="LC8435">                <span><span>//</span> write dataLen and options</span></td>
      </tr>
      <tr>
        <td id="L8436" data-line-number="8436"></td>
        <td id="LC8436">                <span>WriteInt</span>(<span>dataLen</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8437" data-line-number="8437"></td>
        <td id="LC8437">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>options</span>);</td>
      </tr>
      <tr>
        <td id="L8438" data-line-number="8438"></td>
        <td id="LC8438">
</td>
      </tr>
      <tr>
        <td id="L8439" data-line-number="8439"></td>
        <td id="LC8439">                <span><span>//</span> write workflow for FedAuthLibrary.MSAL</span></td>
      </tr>
      <tr>
        <td id="L8440" data-line-number="8440"></td>
        <td id="LC8440">                <span><span>//</span> write accessToken for FedAuthLibrary.SecurityToken</span></td>
      </tr>
      <tr>
        <td id="L8441" data-line-number="8441"></td>
        <td id="LC8441">                <span>switch</span> (<span>fedAuthFeatureData</span>.<span>libraryType</span>)</td>
      </tr>
      <tr>
        <td id="L8442" data-line-number="8442"></td>
        <td id="LC8442">                {</td>
      </tr>
      <tr>
        <td id="L8443" data-line-number="8443"></td>
        <td id="LC8443">                    <span>case</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>MSAL</span>:</td>
      </tr>
      <tr>
        <td id="L8444" data-line-number="8444"></td>
        <td id="LC8444">                        <span>byte</span> <span>workflow</span> <span>=</span> <span>0x00</span>;</td>
      </tr>
      <tr>
        <td id="L8445" data-line-number="8445"></td>
        <td id="LC8445">                        <span>switch</span> (<span>fedAuthFeatureData</span>.<span>authentication</span>)</td>
      </tr>
      <tr>
        <td id="L8446" data-line-number="8446"></td>
        <td id="LC8446">                        {</td>
      </tr>
      <tr>
        <td id="L8447" data-line-number="8447"></td>
        <td id="LC8447">                            <span>case</span> <span>SqlAuthenticationMethod</span>.<span>ActiveDirectoryPassword</span>:</td>
      </tr>
      <tr>
        <td id="L8448" data-line-number="8448"></td>
        <td id="LC8448">                                <span>workflow</span> <span>=</span> <span>TdsEnums</span>.<span>MSALWORKFLOW_ACTIVEDIRECTORYPASSWORD</span>;</td>
      </tr>
      <tr>
        <td id="L8449" data-line-number="8449"></td>
        <td id="LC8449">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8450" data-line-number="8450"></td>
        <td id="LC8450">                            <span>case</span> <span>SqlAuthenticationMethod</span>.<span>ActiveDirectoryIntegrated</span>:</td>
      </tr>
      <tr>
        <td id="L8451" data-line-number="8451"></td>
        <td id="LC8451">                                <span>workflow</span> <span>=</span> <span>TdsEnums</span>.<span>MSALWORKFLOW_ACTIVEDIRECTORYINTEGRATED</span>;</td>
      </tr>
      <tr>
        <td id="L8452" data-line-number="8452"></td>
        <td id="LC8452">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8453" data-line-number="8453"></td>
        <td id="LC8453">                            <span>case</span> <span>SqlAuthenticationMethod</span>.<span>ActiveDirectoryInteractive</span>:</td>
      </tr>
      <tr>
        <td id="L8454" data-line-number="8454"></td>
        <td id="LC8454">                                <span>workflow</span> <span>=</span> <span>TdsEnums</span>.<span>MSALWORKFLOW_ACTIVEDIRECTORYINTERACTIVE</span>;</td>
      </tr>
      <tr>
        <td id="L8455" data-line-number="8455"></td>
        <td id="LC8455">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8456" data-line-number="8456"></td>
        <td id="LC8456">                            <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L8457" data-line-number="8457"></td>
        <td id="LC8457">                                <span>Debug</span>.<span>Assert</span>(<span>false</span>, <span><span>"</span>Unrecognized Authentication type for fedauth MSAL request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8458" data-line-number="8458"></td>
        <td id="LC8458">                                <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8459" data-line-number="8459"></td>
        <td id="LC8459">                        }</td>
      </tr>
      <tr>
        <td id="L8460" data-line-number="8460"></td>
        <td id="LC8460">
</td>
      </tr>
      <tr>
        <td id="L8461" data-line-number="8461"></td>
        <td id="LC8461">                        <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>workflow</span>);</td>
      </tr>
      <tr>
        <td id="L8462" data-line-number="8462"></td>
        <td id="LC8462">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8463" data-line-number="8463"></td>
        <td id="LC8463">                    <span>case</span> <span>TdsEnums</span>.<span>FedAuthLibrary</span>.<span>SecurityToken</span>:</td>
      </tr>
      <tr>
        <td id="L8464" data-line-number="8464"></td>
        <td id="LC8464">                        <span>WriteInt</span>(<span>fedAuthFeatureData</span>.<span>accessToken</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8465" data-line-number="8465"></td>
        <td id="LC8465">                        <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>fedAuthFeatureData</span>.<span>accessToken</span>, <span>fedAuthFeatureData</span>.<span>accessToken</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8466" data-line-number="8466"></td>
        <td id="LC8466">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8467" data-line-number="8467"></td>
        <td id="LC8467">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L8468" data-line-number="8468"></td>
        <td id="LC8468">                        <span>Debug</span>.<span>Assert</span>(<span>false</span>, <span><span>"</span>Unrecognized FedAuthLibrary type for feature extension request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8469" data-line-number="8469"></td>
        <td id="LC8469">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L8470" data-line-number="8470"></td>
        <td id="LC8470">                }</td>
      </tr>
      <tr>
        <td id="L8471" data-line-number="8471"></td>
        <td id="LC8471">            }</td>
      </tr>
      <tr>
        <td id="L8472" data-line-number="8472"></td>
        <td id="LC8472">            <span>return</span> <span>totalLen</span>;</td>
      </tr>
      <tr>
        <td id="L8473" data-line-number="8473"></td>
        <td id="LC8473">        }</td>
      </tr>
      <tr>
        <td id="L8474" data-line-number="8474"></td>
        <td id="LC8474">
</td>
      </tr>
      <tr>
        <td id="L8475" data-line-number="8475"></td>
        <td id="LC8475">        <span>internal</span> <span>int</span> <span>WriteDataClassificationFeatureRequest</span>(<span>bool</span> <span>write</span> <span><span>/*</span> if false just calculates the length <span>*/</span></span>)</td>
      </tr>
      <tr>
        <td id="L8476" data-line-number="8476"></td>
        <td id="LC8476">        {</td>
      </tr>
      <tr>
        <td id="L8477" data-line-number="8477"></td>
        <td id="LC8477">            <span>int</span> <span>len</span> <span>=</span> <span>6</span>; <span><span>//</span> 1byte = featureID, 4bytes = featureData length, 1 bytes = Version</span></td>
      </tr>
      <tr>
        <td id="L8478" data-line-number="8478"></td>
        <td id="LC8478">
</td>
      </tr>
      <tr>
        <td id="L8479" data-line-number="8479"></td>
        <td id="LC8479">            <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8480" data-line-number="8480"></td>
        <td id="LC8480">            {</td>
      </tr>
      <tr>
        <td id="L8481" data-line-number="8481"></td>
        <td id="LC8481">                <span><span>//</span> Write Feature ID, legth of the version# field and Sensitivity Classification Version#</span></td>
      </tr>
      <tr>
        <td id="L8482" data-line-number="8482"></td>
        <td id="LC8482">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FEATUREEXT_DATACLASSIFICATION</span>);</td>
      </tr>
      <tr>
        <td id="L8483" data-line-number="8483"></td>
        <td id="LC8483">                <span>WriteInt</span>(<span>1</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8484" data-line-number="8484"></td>
        <td id="LC8484">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>MAX_SUPPORTED_DATA_CLASSIFICATION_VERSION</span>);</td>
      </tr>
      <tr>
        <td id="L8485" data-line-number="8485"></td>
        <td id="LC8485">            }</td>
      </tr>
      <tr>
        <td id="L8486" data-line-number="8486"></td>
        <td id="LC8486">
</td>
      </tr>
      <tr>
        <td id="L8487" data-line-number="8487"></td>
        <td id="LC8487">            <span>return</span> <span>len</span>; <span><span>//</span> size of data written</span></td>
      </tr>
      <tr>
        <td id="L8488" data-line-number="8488"></td>
        <td id="LC8488">        }</td>
      </tr>
      <tr>
        <td id="L8489" data-line-number="8489"></td>
        <td id="LC8489">
</td>
      </tr>
      <tr>
        <td id="L8490" data-line-number="8490"></td>
        <td id="LC8490">        <span>internal</span> <span>int</span> <span>WriteTceFeatureRequest</span>(<span>bool</span> <span>write</span> <span><span>/*</span> if false just calculates the length <span>*/</span></span>)</td>
      </tr>
      <tr>
        <td id="L8491" data-line-number="8491"></td>
        <td id="LC8491">        {</td>
      </tr>
      <tr>
        <td id="L8492" data-line-number="8492"></td>
        <td id="LC8492">            <span>int</span> <span>len</span> <span>=</span> <span>6</span>; <span><span>//</span> (1byte = featureID, 4bytes = featureData length, 1 bytes = Version</span></td>
      </tr>
      <tr>
        <td id="L8493" data-line-number="8493"></td>
        <td id="LC8493">
</td>
      </tr>
      <tr>
        <td id="L8494" data-line-number="8494"></td>
        <td id="LC8494">            <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8495" data-line-number="8495"></td>
        <td id="LC8495">            {</td>
      </tr>
      <tr>
        <td id="L8496" data-line-number="8496"></td>
        <td id="LC8496">                <span><span>//</span> Write Feature ID, legth of the version# field and TCE Version#</span></td>
      </tr>
      <tr>
        <td id="L8497" data-line-number="8497"></td>
        <td id="LC8497">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FEATUREEXT_TCE</span>);</td>
      </tr>
      <tr>
        <td id="L8498" data-line-number="8498"></td>
        <td id="LC8498">                <span>WriteInt</span>(<span>1</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8499" data-line-number="8499"></td>
        <td id="LC8499">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>MAX_SUPPORTED_TCE_VERSION</span>);</td>
      </tr>
      <tr>
        <td id="L8500" data-line-number="8500"></td>
        <td id="LC8500">            }</td>
      </tr>
      <tr>
        <td id="L8501" data-line-number="8501"></td>
        <td id="LC8501">
</td>
      </tr>
      <tr>
        <td id="L8502" data-line-number="8502"></td>
        <td id="LC8502">            <span>return</span> <span>len</span>; <span><span>//</span> size of data written</span></td>
      </tr>
      <tr>
        <td id="L8503" data-line-number="8503"></td>
        <td id="LC8503">        }</td>
      </tr>
      <tr>
        <td id="L8504" data-line-number="8504"></td>
        <td id="LC8504">
</td>
      </tr>
      <tr>
        <td id="L8505" data-line-number="8505"></td>
        <td id="LC8505">        <span>internal</span> <span>int</span> <span>WriteGlobalTransactionsFeatureRequest</span>(<span>bool</span> <span>write</span> <span><span>/*</span> if false just calculates the length <span>*/</span></span>)</td>
      </tr>
      <tr>
        <td id="L8506" data-line-number="8506"></td>
        <td id="LC8506">        {</td>
      </tr>
      <tr>
        <td id="L8507" data-line-number="8507"></td>
        <td id="LC8507">            <span>int</span> <span>len</span> <span>=</span> <span>5</span>; <span><span>//</span> 1byte = featureID, 4bytes = featureData length</span></td>
      </tr>
      <tr>
        <td id="L8508" data-line-number="8508"></td>
        <td id="LC8508">
</td>
      </tr>
      <tr>
        <td id="L8509" data-line-number="8509"></td>
        <td id="LC8509">            <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8510" data-line-number="8510"></td>
        <td id="LC8510">            {</td>
      </tr>
      <tr>
        <td id="L8511" data-line-number="8511"></td>
        <td id="LC8511">                <span><span>//</span> Write Feature ID</span></td>
      </tr>
      <tr>
        <td id="L8512" data-line-number="8512"></td>
        <td id="LC8512">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FEATUREEXT_GLOBALTRANSACTIONS</span>);</td>
      </tr>
      <tr>
        <td id="L8513" data-line-number="8513"></td>
        <td id="LC8513">                <span>WriteInt</span>(<span>0</span>, <span>_physicalStateObj</span>); <span><span>//</span> we don't send any data</span></td>
      </tr>
      <tr>
        <td id="L8514" data-line-number="8514"></td>
        <td id="LC8514">            }</td>
      </tr>
      <tr>
        <td id="L8515" data-line-number="8515"></td>
        <td id="LC8515">
</td>
      </tr>
      <tr>
        <td id="L8516" data-line-number="8516"></td>
        <td id="LC8516">            <span>return</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L8517" data-line-number="8517"></td>
        <td id="LC8517">        }</td>
      </tr>
      <tr>
        <td id="L8518" data-line-number="8518"></td>
        <td id="LC8518">
</td>
      </tr>
      <tr>
        <td id="L8519" data-line-number="8519"></td>
        <td id="LC8519">        <span>internal</span> <span>int</span> <span>WriteAzureSQLSupportFeatureRequest</span>(<span>bool</span> <span>write</span> <span><span>/*</span> if false just calculates the length <span>*/</span></span>)</td>
      </tr>
      <tr>
        <td id="L8520" data-line-number="8520"></td>
        <td id="LC8520">        {</td>
      </tr>
      <tr>
        <td id="L8521" data-line-number="8521"></td>
        <td id="LC8521">            <span>int</span> <span>len</span> <span>=</span> <span>6</span>; <span><span>//</span> 1byte = featureID, 4bytes = featureData length, 1 bytes = featureData</span></td>
      </tr>
      <tr>
        <td id="L8522" data-line-number="8522"></td>
        <td id="LC8522">
</td>
      </tr>
      <tr>
        <td id="L8523" data-line-number="8523"></td>
        <td id="LC8523">            <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8524" data-line-number="8524"></td>
        <td id="LC8524">            {</td>
      </tr>
      <tr>
        <td id="L8525" data-line-number="8525"></td>
        <td id="LC8525">                <span><span>//</span> Write Feature ID</span></td>
      </tr>
      <tr>
        <td id="L8526" data-line-number="8526"></td>
        <td id="LC8526">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FEATUREEXT_AZURESQLSUPPORT</span>);</td>
      </tr>
      <tr>
        <td id="L8527" data-line-number="8527"></td>
        <td id="LC8527">
</td>
      </tr>
      <tr>
        <td id="L8528" data-line-number="8528"></td>
        <td id="LC8528">                <span><span>//</span> Feature Data length</span></td>
      </tr>
      <tr>
        <td id="L8529" data-line-number="8529"></td>
        <td id="LC8529">                <span>WriteInt</span>(<span>s_FeatureExtDataAzureSQLSupportFeatureRequest</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8530" data-line-number="8530"></td>
        <td id="LC8530">
</td>
      </tr>
      <tr>
        <td id="L8531" data-line-number="8531"></td>
        <td id="LC8531">                <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>s_FeatureExtDataAzureSQLSupportFeatureRequest</span>, <span>s_FeatureExtDataAzureSQLSupportFeatureRequest</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8532" data-line-number="8532"></td>
        <td id="LC8532">            }</td>
      </tr>
      <tr>
        <td id="L8533" data-line-number="8533"></td>
        <td id="LC8533">
</td>
      </tr>
      <tr>
        <td id="L8534" data-line-number="8534"></td>
        <td id="LC8534">            <span>return</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L8535" data-line-number="8535"></td>
        <td id="LC8535">        }</td>
      </tr>
      <tr>
        <td id="L8536" data-line-number="8536"></td>
        <td id="LC8536">
</td>
      </tr>
      <tr>
        <td id="L8537" data-line-number="8537"></td>
        <td id="LC8537">        <span>internal</span> <span>int</span> <span>WriteUTF8SupportFeatureRequest</span>(<span>bool</span> <span>write</span> <span><span>/*</span> if false just calculates the length <span>*/</span></span>)</td>
      </tr>
      <tr>
        <td id="L8538" data-line-number="8538"></td>
        <td id="LC8538">        {</td>
      </tr>
      <tr>
        <td id="L8539" data-line-number="8539"></td>
        <td id="LC8539">            <span>int</span> <span>len</span> <span>=</span> <span>5</span>; <span><span>//</span> 1byte = featureID, 4bytes = featureData length</span></td>
      </tr>
      <tr>
        <td id="L8540" data-line-number="8540"></td>
        <td id="LC8540">
</td>
      </tr>
      <tr>
        <td id="L8541" data-line-number="8541"></td>
        <td id="LC8541">            <span>if</span> (<span>write</span>)</td>
      </tr>
      <tr>
        <td id="L8542" data-line-number="8542"></td>
        <td id="LC8542">            {</td>
      </tr>
      <tr>
        <td id="L8543" data-line-number="8543"></td>
        <td id="LC8543">                <span><span>//</span> Write Feature ID</span></td>
      </tr>
      <tr>
        <td id="L8544" data-line-number="8544"></td>
        <td id="LC8544">                <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FEATUREEXT_UTF8SUPPORT</span>);</td>
      </tr>
      <tr>
        <td id="L8545" data-line-number="8545"></td>
        <td id="LC8545">                <span>WriteInt</span>(<span>0</span>, <span>_physicalStateObj</span>); <span><span>//</span> we don't send any data</span></td>
      </tr>
      <tr>
        <td id="L8546" data-line-number="8546"></td>
        <td id="LC8546">            }</td>
      </tr>
      <tr>
        <td id="L8547" data-line-number="8547"></td>
        <td id="LC8547">
</td>
      </tr>
      <tr>
        <td id="L8548" data-line-number="8548"></td>
        <td id="LC8548">            <span>return</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L8549" data-line-number="8549"></td>
        <td id="LC8549">        }</td>
      </tr>
      <tr>
        <td id="L8550" data-line-number="8550"></td>
        <td id="LC8550">
</td>
      </tr>
      <tr>
        <td id="L8551" data-line-number="8551"></td>
        <td id="LC8551">        <span>internal</span> <span>void</span> <span>TdsLogin</span>(<span>SqlLogin</span> <span>rec</span>,</td>
      </tr>
      <tr>
        <td id="L8552" data-line-number="8552"></td>
        <td id="LC8552">                               <span>TdsEnums</span>.<span>FeatureExtension</span> <span>requestedFeatures</span>,</td>
      </tr>
      <tr>
        <td id="L8553" data-line-number="8553"></td>
        <td id="LC8553">                               <span>SessionData</span> <span>recoverySessionData</span>,</td>
      </tr>
      <tr>
        <td id="L8554" data-line-number="8554"></td>
        <td id="LC8554">                               <span>FederatedAuthenticationFeatureExtensionData</span>? <span>fedAuthFeatureExtensionData</span>,</td>
      </tr>
      <tr>
        <td id="L8555" data-line-number="8555"></td>
        <td id="LC8555">                               <span>SqlClientOriginalNetworkAddressInfo</span> <span>originalNetworkAddressInfo</span>)</td>
      </tr>
      <tr>
        <td id="L8556" data-line-number="8556"></td>
        <td id="LC8556">        {</td>
      </tr>
      <tr>
        <td id="L8557" data-line-number="8557"></td>
        <td id="LC8557">            <span>_physicalStateObj</span>.<span>SetTimeoutSeconds</span>(<span>rec</span>.<span>timeout</span>);</td>
      </tr>
      <tr>
        <td id="L8558" data-line-number="8558"></td>
        <td id="LC8558">
</td>
      </tr>
      <tr>
        <td id="L8559" data-line-number="8559"></td>
        <td id="LC8559">            <span>Debug</span>.<span>Assert</span>(<span>recoverySessionData</span> <span>==</span> <span>null</span> <span>||</span> (<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>SessionRecovery</span>) <span>!=</span> <span>0</span>, <span><span>"</span>Recovery session data without session recovery feature request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8560" data-line-number="8560"></td>
        <td id="LC8560">            <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>MAXLEN_HOSTNAME</span> <span>&gt;=</span> <span>rec</span>.<span>hostName</span>.<span>Length</span>, <span><span>"</span>_workstationId.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8561" data-line-number="8561"></td>
        <td id="LC8561">
</td>
      </tr>
      <tr>
        <td id="L8562" data-line-number="8562"></td>
        <td id="LC8562">            <span>Debug</span>.<span>Assert</span>(<span>!</span>(<span>rec</span>.<span>useSSPI</span> <span>&amp;&amp;</span> <span>_connHandler</span>.<span>_fedAuthRequired</span>), <span><span>"</span>Cannot use SSPI when server has responded 0x01 for FedAuthRequired PreLogin Option.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8563" data-line-number="8563"></td>
        <td id="LC8563">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>rec</span>.<span>useSSPI</span> <span>||</span> (<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>FedAuth</span>) <span>==</span> <span>0</span>, <span><span>"</span>Cannot use both SSPI and FedAuth<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8564" data-line-number="8564"></td>
        <td id="LC8564">            <span>Debug</span>.<span>Assert</span>(<span>fedAuthFeatureExtensionData</span> <span>==</span> <span>null</span> <span>||</span> (<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>FedAuth</span>) <span>!=</span> <span>0</span>, <span><span>"</span>fedAuthFeatureExtensionData provided without fed auth feature request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8565" data-line-number="8565"></td>
        <td id="LC8565">            <span>Debug</span>.<span>Assert</span>(<span>fedAuthFeatureExtensionData</span> <span>!=</span> <span>null</span> <span>||</span> (<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>FedAuth</span>) <span>==</span> <span>0</span>, <span><span>"</span>Fed Auth feature requested without specifying fedAuthFeatureExtensionData.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8566" data-line-number="8566"></td>
        <td id="LC8566">
</td>
      </tr>
      <tr>
        <td id="L8567" data-line-number="8567"></td>
        <td id="LC8567">            <span>Debug</span>.<span>Assert</span>(<span>rec</span>.<span>userName</span> <span>==</span> <span>null</span> <span>||</span> (<span>rec</span>.<span>userName</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>TdsEnums</span>.<span>MAXLEN_USERNAME</span> <span>&gt;=</span> <span>rec</span>.<span>userName</span>.<span>Length</span>), <span><span>"</span>_userID.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8568" data-line-number="8568"></td>
        <td id="LC8568">            <span>Debug</span>.<span>Assert</span>(<span>rec</span>.<span>credential</span> <span>==</span> <span>null</span> <span>||</span> (<span>rec</span>.<span>credential</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>TdsEnums</span>.<span>MAXLEN_USERNAME</span> <span>&gt;=</span> <span>rec</span>.<span>credential</span>.<span>UserId</span>.<span>Length</span>), <span><span>"</span>_credential.UserId.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8569" data-line-number="8569"></td>
        <td id="LC8569">
</td>
      </tr>
      <tr>
        <td id="L8570" data-line-number="8570"></td>
        <td id="LC8570">            <span>Debug</span>.<span>Assert</span>(<span>rec</span>.<span>password</span> <span>==</span> <span>null</span> <span>||</span> (<span>rec</span>.<span>password</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>TdsEnums</span>.<span>MAXLEN_PASSWORD</span> <span>&gt;=</span> <span>rec</span>.<span>password</span>.<span>Length</span>), <span><span>"</span>_password.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8571" data-line-number="8571"></td>
        <td id="LC8571">            <span>Debug</span>.<span>Assert</span>(<span>rec</span>.<span>credential</span> <span>==</span> <span>null</span> <span>||</span> (<span>rec</span>.<span>credential</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>TdsEnums</span>.<span>MAXLEN_PASSWORD</span> <span>&gt;=</span> <span>rec</span>.<span>credential</span>.<span>Password</span>.<span>Length</span>), <span><span>"</span>_credential.Password.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8572" data-line-number="8572"></td>
        <td id="LC8572">
</td>
      </tr>
      <tr>
        <td id="L8573" data-line-number="8573"></td>
        <td id="LC8573">            <span>Debug</span>.<span>Assert</span>(<span>rec</span>.<span>credential</span> <span>!=</span> <span>null</span> <span>||</span> <span>rec</span>.<span>userName</span> <span>!=</span> <span>null</span> <span>||</span> <span>rec</span>.<span>password</span> <span>!=</span> <span>null</span>, <span><span>"</span>cannot mix the new secure password system and the connection string based password<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8574" data-line-number="8574"></td>
        <td id="LC8574">            <span>Debug</span>.<span>Assert</span>(<span>rec</span>.<span>newSecurePassword</span> <span>!=</span> <span>null</span> <span>||</span> <span>rec</span>.<span>newPassword</span> <span>!=</span> <span>null</span>, <span><span>"</span>cannot have both new secure change password and string based change password<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8575" data-line-number="8575"></td>
        <td id="LC8575">            <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>MAXLEN_APPNAME</span> <span>&gt;=</span> <span>rec</span>.<span>applicationName</span>.<span>Length</span>, <span><span>"</span>_applicationName.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8576" data-line-number="8576"></td>
        <td id="LC8576">            <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>MAXLEN_SERVERNAME</span> <span>&gt;=</span> <span>rec</span>.<span>serverName</span>.<span>Length</span>, <span><span>"</span>_dataSource.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8577" data-line-number="8577"></td>
        <td id="LC8577">            <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>MAXLEN_LANGUAGE</span> <span>&gt;=</span> <span>rec</span>.<span>language</span>.<span>Length</span>, <span><span>"</span>_currentLanguage .Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8578" data-line-number="8578"></td>
        <td id="LC8578">            <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>MAXLEN_DATABASE</span> <span>&gt;=</span> <span>rec</span>.<span>database</span>.<span>Length</span>, <span><span>"</span>_initialCatalog.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8579" data-line-number="8579"></td>
        <td id="LC8579">            <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>MAXLEN_ATTACHDBFILE</span> <span>&gt;=</span> <span>rec</span>.<span>attachDBFilename</span>.<span>Length</span>, <span><span>"</span>_attachDBFileName.Length exceeds the max length for this value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8580" data-line-number="8580"></td>
        <td id="LC8580">
</td>
      </tr>
      <tr>
        <td id="L8581" data-line-number="8581"></td>
        <td id="LC8581">            <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span> <span>!=</span> <span>null</span>, <span><span>"</span>SqlConnectionInternalTds handler can not be null at this point.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8582" data-line-number="8582"></td>
        <td id="LC8582">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>EndPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>LoginBegin</span>);</td>
      </tr>
      <tr>
        <td id="L8583" data-line-number="8583"></td>
        <td id="LC8583">            <span>_connHandler</span>.<span>TimeoutErrorInternal</span>.<span>SetAndBeginPhase</span>(<span>SqlConnectionTimeoutErrorPhase</span>.<span>ProcessConnectionAuth</span>);</td>
      </tr>
      <tr>
        <td id="L8584" data-line-number="8584"></td>
        <td id="LC8584">
</td>
      </tr>
      <tr>
        <td id="L8585" data-line-number="8585"></td>
        <td id="LC8585">            <span><span>//</span> Add CTAIP Provider</span></td>
      </tr>
      <tr>
        <td id="L8586" data-line-number="8586"></td>
        <td id="LC8586">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L8587" data-line-number="8587"></td>
        <td id="LC8587">            <span>if</span> (<span>originalNetworkAddressInfo</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8588" data-line-number="8588"></td>
        <td id="LC8588">            {</td>
      </tr>
      <tr>
        <td id="L8589" data-line-number="8589"></td>
        <td id="LC8589">                <span>SNINativeMethodWrapper</span>.<span>CTAIPProviderInfo</span> <span>cauthInfo</span> <span>=</span> <span>new</span> <span>SNINativeMethodWrapper</span>.<span>CTAIPProviderInfo</span>();</td>
      </tr>
      <tr>
        <td id="L8590" data-line-number="8590"></td>
        <td id="LC8590">                <span>cauthInfo</span>.<span>originalNetworkAddress</span> <span>=</span> <span>originalNetworkAddressInfo</span>.<span>Address</span>.<span>GetAddressBytes</span>();</td>
      </tr>
      <tr>
        <td id="L8591" data-line-number="8591"></td>
        <td id="LC8591">                <span>cauthInfo</span>.<span>fromDataSecurityProxy</span> <span>=</span> <span>originalNetworkAddressInfo</span>.<span>IsFromDataSecurityProxy</span>;</td>
      </tr>
      <tr>
        <td id="L8592" data-line-number="8592"></td>
        <td id="LC8592">
</td>
      </tr>
      <tr>
        <td id="L8593" data-line-number="8593"></td>
        <td id="LC8593">                <span>UInt32</span> <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNIAddProvider</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>SNINativeMethodWrapper</span>.<span>ProviderEnum</span>.<span>CTAIP_PROV</span>, <span>cauthInfo</span>);</td>
      </tr>
      <tr>
        <td id="L8594" data-line-number="8594"></td>
        <td id="LC8594">                <span>if</span> (<span>error</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L8595" data-line-number="8595"></td>
        <td id="LC8595">                {</td>
      </tr>
      <tr>
        <td id="L8596" data-line-number="8596"></td>
        <td id="LC8596">                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L8597" data-line-number="8597"></td>
        <td id="LC8597">                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8598" data-line-number="8598"></td>
        <td id="LC8598">                }</td>
      </tr>
      <tr>
        <td id="L8599" data-line-number="8599"></td>
        <td id="LC8599">
</td>
      </tr>
      <tr>
        <td id="L8600" data-line-number="8600"></td>
        <td id="LC8600">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L8601" data-line-number="8601"></td>
        <td id="LC8601">                { } <span><span>//</span> EmptyTry/Finally to avoid FXCop violation</span></td>
      </tr>
      <tr>
        <td id="L8602" data-line-number="8602"></td>
        <td id="LC8602">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L8603" data-line-number="8603"></td>
        <td id="LC8603">                {</td>
      </tr>
      <tr>
        <td id="L8604" data-line-number="8604"></td>
        <td id="LC8604">                    <span>_physicalStateObj</span>.<span>ClearAllWritePackets</span>();</td>
      </tr>
      <tr>
        <td id="L8605" data-line-number="8605"></td>
        <td id="LC8605">                }</td>
      </tr>
      <tr>
        <td id="L8606" data-line-number="8606"></td>
        <td id="LC8606">            }</td>
      </tr>
      <tr>
        <td id="L8607" data-line-number="8607"></td>
        <td id="LC8607">
</td>
      </tr>
      <tr>
        <td id="L8608" data-line-number="8608"></td>
        <td id="LC8608">            <span><span>//</span> get the password up front to use in sspi logic below</span></td>
      </tr>
      <tr>
        <td id="L8609" data-line-number="8609"></td>
        <td id="LC8609">            <span>byte</span>[] <span>encryptedPassword</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L8610" data-line-number="8610"></td>
        <td id="LC8610">            <span>byte</span>[] <span>encryptedChangePassword</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L8611" data-line-number="8611"></td>
        <td id="LC8611">            <span>int</span> <span>encryptedPasswordLengthInBytes</span>;</td>
      </tr>
      <tr>
        <td id="L8612" data-line-number="8612"></td>
        <td id="LC8612">            <span>int</span> <span>encryptedChangePasswordLengthInBytes</span>;</td>
      </tr>
      <tr>
        <td id="L8613" data-line-number="8613"></td>
        <td id="LC8613">            <span>bool</span> <span>useFeatureExt</span> <span>=</span> (<span>requestedFeatures</span> <span>!=</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>None</span>);</td>
      </tr>
      <tr>
        <td id="L8614" data-line-number="8614"></td>
        <td id="LC8614">
</td>
      </tr>
      <tr>
        <td id="L8615" data-line-number="8615"></td>
        <td id="LC8615">            <span>string</span> <span>userName</span>;</td>
      </tr>
      <tr>
        <td id="L8616" data-line-number="8616"></td>
        <td id="LC8616">
</td>
      </tr>
      <tr>
        <td id="L8617" data-line-number="8617"></td>
        <td id="LC8617">            <span>if</span> (<span>rec</span>.<span>credential</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8618" data-line-number="8618"></td>
        <td id="LC8618">            {</td>
      </tr>
      <tr>
        <td id="L8619" data-line-number="8619"></td>
        <td id="LC8619">                <span>userName</span> <span>=</span> <span>rec</span>.<span>credential</span>.<span>UserId</span>;</td>
      </tr>
      <tr>
        <td id="L8620" data-line-number="8620"></td>
        <td id="LC8620">                <span>encryptedPasswordLengthInBytes</span> <span>=</span> <span>rec</span>.<span>credential</span>.<span>Password</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8621" data-line-number="8621"></td>
        <td id="LC8621">            }</td>
      </tr>
      <tr>
        <td id="L8622" data-line-number="8622"></td>
        <td id="LC8622">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8623" data-line-number="8623"></td>
        <td id="LC8623">            {</td>
      </tr>
      <tr>
        <td id="L8624" data-line-number="8624"></td>
        <td id="LC8624">                <span>userName</span> <span>=</span> <span>rec</span>.<span>userName</span>;</td>
      </tr>
      <tr>
        <td id="L8625" data-line-number="8625"></td>
        <td id="LC8625">                <span>encryptedPassword</span> <span>=</span> <span>TdsParserStaticMethods</span>.<span>EncryptPassword</span>(<span>rec</span>.<span>password</span>);</td>
      </tr>
      <tr>
        <td id="L8626" data-line-number="8626"></td>
        <td id="LC8626">                <span>encryptedPasswordLengthInBytes</span> <span>=</span> <span>encryptedPassword</span>.<span>Length</span>;  <span><span>//</span> password in clear text is already encrypted and its length is in byte</span></td>
      </tr>
      <tr>
        <td id="L8627" data-line-number="8627"></td>
        <td id="LC8627">            }</td>
      </tr>
      <tr>
        <td id="L8628" data-line-number="8628"></td>
        <td id="LC8628">
</td>
      </tr>
      <tr>
        <td id="L8629" data-line-number="8629"></td>
        <td id="LC8629">            <span>if</span> (<span>rec</span>.<span>newSecurePassword</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8630" data-line-number="8630"></td>
        <td id="LC8630">            {</td>
      </tr>
      <tr>
        <td id="L8631" data-line-number="8631"></td>
        <td id="LC8631">                <span>encryptedChangePasswordLengthInBytes</span> <span>=</span> <span>rec</span>.<span>newSecurePassword</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8632" data-line-number="8632"></td>
        <td id="LC8632">            }</td>
      </tr>
      <tr>
        <td id="L8633" data-line-number="8633"></td>
        <td id="LC8633">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8634" data-line-number="8634"></td>
        <td id="LC8634">            {</td>
      </tr>
      <tr>
        <td id="L8635" data-line-number="8635"></td>
        <td id="LC8635">                <span>encryptedChangePassword</span> <span>=</span> <span>TdsParserStaticMethods</span>.<span>EncryptPassword</span>(<span>rec</span>.<span>newPassword</span>);</td>
      </tr>
      <tr>
        <td id="L8636" data-line-number="8636"></td>
        <td id="LC8636">                <span>encryptedChangePasswordLengthInBytes</span> <span>=</span> <span>encryptedChangePassword</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L8637" data-line-number="8637"></td>
        <td id="LC8637">            }</td>
      </tr>
      <tr>
        <td id="L8638" data-line-number="8638"></td>
        <td id="LC8638">
</td>
      </tr>
      <tr>
        <td id="L8639" data-line-number="8639"></td>
        <td id="LC8639">
</td>
      </tr>
      <tr>
        <td id="L8640" data-line-number="8640"></td>
        <td id="LC8640">            <span><span>//</span> set the message type</span></td>
      </tr>
      <tr>
        <td id="L8641" data-line-number="8641"></td>
        <td id="LC8641">            <span>_physicalStateObj</span>.<span>_outputMessageType</span> <span>=</span> <span>TdsEnums</span>.<span>MT_LOGIN7</span>;</td>
      </tr>
      <tr>
        <td id="L8642" data-line-number="8642"></td>
        <td id="LC8642">
</td>
      </tr>
      <tr>
        <td id="L8643" data-line-number="8643"></td>
        <td id="LC8643">            <span><span>//</span> length in bytes</span></td>
      </tr>
      <tr>
        <td id="L8644" data-line-number="8644"></td>
        <td id="LC8644">            <span>int</span> <span>length</span> <span>=</span> <span>TdsEnums</span>.<span>YUKON_LOG_REC_FIXED_LEN</span>;</td>
      </tr>
      <tr>
        <td id="L8645" data-line-number="8645"></td>
        <td id="LC8645">
</td>
      </tr>
      <tr>
        <td id="L8646" data-line-number="8646"></td>
        <td id="LC8646">            <span>string</span> <span>clientInterfaceName</span> <span>=</span> <span>TdsEnums</span>.<span>SQL_PROVIDER_NAME</span>;</td>
      </tr>
      <tr>
        <td id="L8647" data-line-number="8647"></td>
        <td id="LC8647">            <span>Debug</span>.<span>Assert</span>(<span>TdsEnums</span>.<span>MAXLEN_CLIENTINTERFACE</span> <span>&gt;=</span> <span>clientInterfaceName</span>.<span>Length</span>, <span><span>"</span>cchCltIntName can specify at most 128 unicode characters. See Tds spec<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8648" data-line-number="8648"></td>
        <td id="LC8648">
</td>
      </tr>
      <tr>
        <td id="L8649" data-line-number="8649"></td>
        <td id="LC8649">            <span><span>//</span> add up variable-len portions (multiply by 2 for byte len of char strings)</span></td>
      </tr>
      <tr>
        <td id="L8650" data-line-number="8650"></td>
        <td id="LC8650">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L8651" data-line-number="8651"></td>
        <td id="LC8651">            <span>checked</span></td>
      </tr>
      <tr>
        <td id="L8652" data-line-number="8652"></td>
        <td id="LC8652">            {</td>
      </tr>
      <tr>
        <td id="L8653" data-line-number="8653"></td>
        <td id="LC8653">                <span>length</span> <span>+=</span> (<span>rec</span>.<span>hostName</span>.<span>Length</span> <span>+</span> <span>rec</span>.<span>applicationName</span>.<span>Length</span> <span>+</span></td>
      </tr>
      <tr>
        <td id="L8654" data-line-number="8654"></td>
        <td id="LC8654">                            <span>rec</span>.<span>serverName</span>.<span>Length</span> <span>+</span> <span>clientInterfaceName</span>.<span>Length</span> <span>+</span></td>
      </tr>
      <tr>
        <td id="L8655" data-line-number="8655"></td>
        <td id="LC8655">                            <span>rec</span>.<span>language</span>.<span>Length</span> <span>+</span> <span>rec</span>.<span>database</span>.<span>Length</span> <span>+</span></td>
      </tr>
      <tr>
        <td id="L8656" data-line-number="8656"></td>
        <td id="LC8656">                            <span>rec</span>.<span>attachDBFilename</span>.<span>Length</span>) <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8657" data-line-number="8657"></td>
        <td id="LC8657">                <span>if</span> (<span>useFeatureExt</span>)</td>
      </tr>
      <tr>
        <td id="L8658" data-line-number="8658"></td>
        <td id="LC8658">                {</td>
      </tr>
      <tr>
        <td id="L8659" data-line-number="8659"></td>
        <td id="LC8659">                    <span>length</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L8660" data-line-number="8660"></td>
        <td id="LC8660">                }</td>
      </tr>
      <tr>
        <td id="L8661" data-line-number="8661"></td>
        <td id="LC8661">            }</td>
      </tr>
      <tr>
        <td id="L8662" data-line-number="8662"></td>
        <td id="LC8662">
</td>
      </tr>
      <tr>
        <td id="L8663" data-line-number="8663"></td>
        <td id="LC8663">            <span><span>//</span> allocate memory for SSPI variables</span></td>
      </tr>
      <tr>
        <td id="L8664" data-line-number="8664"></td>
        <td id="LC8664">            <span>byte</span>[] <span>outSSPIBuff</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L8665" data-line-number="8665"></td>
        <td id="LC8665">            <span>UInt32</span> <span>outSSPILength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8666" data-line-number="8666"></td>
        <td id="LC8666">
</td>
      </tr>
      <tr>
        <td id="L8667" data-line-number="8667"></td>
        <td id="LC8667">            <span><span>//</span> only add lengths of password and username if not using SSPI or requesting federated authentication info</span></td>
      </tr>
      <tr>
        <td id="L8668" data-line-number="8668"></td>
        <td id="LC8668">            <span>if</span> (<span>!</span><span>rec</span>.<span>useSSPI</span> <span>&amp;&amp;</span> <span>!</span>(<span>_connHandler</span>.<span>_federatedAuthenticationInfoRequested</span> <span>||</span> <span>_connHandler</span>.<span>_federatedAuthenticationRequested</span>))</td>
      </tr>
      <tr>
        <td id="L8669" data-line-number="8669"></td>
        <td id="LC8669">            {</td>
      </tr>
      <tr>
        <td id="L8670" data-line-number="8670"></td>
        <td id="LC8670">                <span>checked</span></td>
      </tr>
      <tr>
        <td id="L8671" data-line-number="8671"></td>
        <td id="LC8671">                {</td>
      </tr>
      <tr>
        <td id="L8672" data-line-number="8672"></td>
        <td id="LC8672">                    <span>length</span> <span>+=</span> (<span>userName</span>.<span>Length</span> <span>*</span> <span>2</span>) <span>+</span> <span>encryptedPasswordLengthInBytes</span></td>
      </tr>
      <tr>
        <td id="L8673" data-line-number="8673"></td>
        <td id="LC8673">                    <span>+</span> <span>encryptedChangePasswordLengthInBytes</span>;</td>
      </tr>
      <tr>
        <td id="L8674" data-line-number="8674"></td>
        <td id="LC8674">                }</td>
      </tr>
      <tr>
        <td id="L8675" data-line-number="8675"></td>
        <td id="LC8675">            }</td>
      </tr>
      <tr>
        <td id="L8676" data-line-number="8676"></td>
        <td id="LC8676">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L8677" data-line-number="8677"></td>
        <td id="LC8677">            {</td>
      </tr>
      <tr>
        <td id="L8678" data-line-number="8678"></td>
        <td id="LC8678">                <span>if</span> (<span>rec</span>.<span>useSSPI</span>)</td>
      </tr>
      <tr>
        <td id="L8679" data-line-number="8679"></td>
        <td id="LC8679">                {</td>
      </tr>
      <tr>
        <td id="L8680" data-line-number="8680"></td>
        <td id="LC8680">                    <span><span>//</span> now allocate proper length of buffer, and set length</span></td>
      </tr>
      <tr>
        <td id="L8681" data-line-number="8681"></td>
        <td id="LC8681">                    <span>outSSPIBuff</span> <span>=</span> <span>new</span> <span>byte</span>[<span>s_maxSSPILength</span>];</td>
      </tr>
      <tr>
        <td id="L8682" data-line-number="8682"></td>
        <td id="LC8682">                    <span>outSSPILength</span> <span>=</span> <span>s_maxSSPILength</span>;</td>
      </tr>
      <tr>
        <td id="L8683" data-line-number="8683"></td>
        <td id="LC8683">
</td>
      </tr>
      <tr>
        <td id="L8684" data-line-number="8684"></td>
        <td id="LC8684">                    <span><span>//</span> Call helper function for SSPI data and actual length.</span></td>
      </tr>
      <tr>
        <td id="L8685" data-line-number="8685"></td>
        <td id="LC8685">                    <span><span>//</span> Since we don't have SSPI data from the server, send null for the</span></td>
      </tr>
      <tr>
        <td id="L8686" data-line-number="8686"></td>
        <td id="LC8686">                    <span><span>//</span> byte[] buffer and 0 for the int length.</span></td>
      </tr>
      <tr>
        <td id="L8687" data-line-number="8687"></td>
        <td id="LC8687">                    <span>Debug</span>.<span>Assert</span>(<span>SniContext</span>.<span>Snix_Login</span> <span>==</span> <span>_physicalStateObj</span>.<span>SniContext</span>, <span><span>$"</span>Unexpected SniContext. Expecting Snix_Login, actual value is '{<span>_physicalStateObj</span>.<span>SniContext</span>}'<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8688" data-line-number="8688"></td>
        <td id="LC8688">                    <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_LoginSspi</span>;</td>
      </tr>
      <tr>
        <td id="L8689" data-line-number="8689"></td>
        <td id="LC8689">                    <span>SSPIData</span>(<span>null</span>, <span>0</span>, <span>outSSPIBuff</span>, <span>ref</span> <span>outSSPILength</span>);</td>
      </tr>
      <tr>
        <td id="L8690" data-line-number="8690"></td>
        <td id="LC8690">                    <span>if</span> (<span>outSSPILength</span> <span>&gt;</span> <span>Int32</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L8691" data-line-number="8691"></td>
        <td id="LC8691">                    {</td>
      </tr>
      <tr>
        <td id="L8692" data-line-number="8692"></td>
        <td id="LC8692">                        <span>throw</span> <span>SQL</span>.<span>InvalidSSPIPacketSize</span>();  <span><span>//</span> SqlBu 332503</span></td>
      </tr>
      <tr>
        <td id="L8693" data-line-number="8693"></td>
        <td id="LC8693">                    }</td>
      </tr>
      <tr>
        <td id="L8694" data-line-number="8694"></td>
        <td id="LC8694">                    <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Login</span>;</td>
      </tr>
      <tr>
        <td id="L8695" data-line-number="8695"></td>
        <td id="LC8695">
</td>
      </tr>
      <tr>
        <td id="L8696" data-line-number="8696"></td>
        <td id="LC8696">                    <span>checked</span></td>
      </tr>
      <tr>
        <td id="L8697" data-line-number="8697"></td>
        <td id="LC8697">                    {</td>
      </tr>
      <tr>
        <td id="L8698" data-line-number="8698"></td>
        <td id="LC8698">                        <span>length</span> <span>+=</span> (<span>Int32</span>)<span>outSSPILength</span>;</td>
      </tr>
      <tr>
        <td id="L8699" data-line-number="8699"></td>
        <td id="LC8699">                    }</td>
      </tr>
      <tr>
        <td id="L8700" data-line-number="8700"></td>
        <td id="LC8700">                }</td>
      </tr>
      <tr>
        <td id="L8701" data-line-number="8701"></td>
        <td id="LC8701">            }</td>
      </tr>
      <tr>
        <td id="L8702" data-line-number="8702"></td>
        <td id="LC8702">
</td>
      </tr>
      <tr>
        <td id="L8703" data-line-number="8703"></td>
        <td id="LC8703">            <span>int</span> <span>feOffset</span> <span>=</span> <span>length</span>;</td>
      </tr>
      <tr>
        <td id="L8704" data-line-number="8704"></td>
        <td id="LC8704">
</td>
      </tr>
      <tr>
        <td id="L8705" data-line-number="8705"></td>
        <td id="LC8705">            <span>if</span> (<span>useFeatureExt</span>)</td>
      </tr>
      <tr>
        <td id="L8706" data-line-number="8706"></td>
        <td id="LC8706">            {</td>
      </tr>
      <tr>
        <td id="L8707" data-line-number="8707"></td>
        <td id="LC8707">                <span>checked</span></td>
      </tr>
      <tr>
        <td id="L8708" data-line-number="8708"></td>
        <td id="LC8708">                {</td>
      </tr>
      <tr>
        <td id="L8709" data-line-number="8709"></td>
        <td id="LC8709">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>SessionRecovery</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8710" data-line-number="8710"></td>
        <td id="LC8710">                    {</td>
      </tr>
      <tr>
        <td id="L8711" data-line-number="8711"></td>
        <td id="LC8711">                        <span>length</span> <span>+=</span> <span>WriteSessionRecoveryFeatureRequest</span>(<span>recoverySessionData</span>, <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L8712" data-line-number="8712"></td>
        <td id="LC8712">                    };</td>
      </tr>
      <tr>
        <td id="L8713" data-line-number="8713"></td>
        <td id="LC8713">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>FedAuth</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8714" data-line-number="8714"></td>
        <td id="LC8714">                    {</td>
      </tr>
      <tr>
        <td id="L8715" data-line-number="8715"></td>
        <td id="LC8715">                        <span>Debug</span>.<span>Assert</span>(<span>fedAuthFeatureExtensionData</span> <span>!=</span> <span>null</span>, <span><span>"</span>fedAuthFeatureExtensionData should not null.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8716" data-line-number="8716"></td>
        <td id="LC8716">                        <span>length</span> <span>+=</span> <span>WriteFedAuthFeatureRequest</span>(<span>fedAuthFeatureExtensionData</span>.<span>Value</span>, <span>write</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L8717" data-line-number="8717"></td>
        <td id="LC8717">                    }</td>
      </tr>
      <tr>
        <td id="L8718" data-line-number="8718"></td>
        <td id="LC8718">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>Tce</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8719" data-line-number="8719"></td>
        <td id="LC8719">                    {</td>
      </tr>
      <tr>
        <td id="L8720" data-line-number="8720"></td>
        <td id="LC8720">                        <span>length</span> <span>+=</span> <span>WriteTceFeatureRequest</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L8721" data-line-number="8721"></td>
        <td id="LC8721">                    }</td>
      </tr>
      <tr>
        <td id="L8722" data-line-number="8722"></td>
        <td id="LC8722">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>GlobalTransactions</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8723" data-line-number="8723"></td>
        <td id="LC8723">                    {</td>
      </tr>
      <tr>
        <td id="L8724" data-line-number="8724"></td>
        <td id="LC8724">                        <span>length</span> <span>+=</span> <span>WriteGlobalTransactionsFeatureRequest</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L8725" data-line-number="8725"></td>
        <td id="LC8725">                    }</td>
      </tr>
      <tr>
        <td id="L8726" data-line-number="8726"></td>
        <td id="LC8726">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>AzureSQLSupport</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8727" data-line-number="8727"></td>
        <td id="LC8727">                    {</td>
      </tr>
      <tr>
        <td id="L8728" data-line-number="8728"></td>
        <td id="LC8728">                        <span>length</span> <span>+=</span> <span>WriteAzureSQLSupportFeatureRequest</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L8729" data-line-number="8729"></td>
        <td id="LC8729">                    }</td>
      </tr>
      <tr>
        <td id="L8730" data-line-number="8730"></td>
        <td id="LC8730">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>DataClassification</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8731" data-line-number="8731"></td>
        <td id="LC8731">                    {</td>
      </tr>
      <tr>
        <td id="L8732" data-line-number="8732"></td>
        <td id="LC8732">                        <span>length</span> <span>+=</span> <span>WriteDataClassificationFeatureRequest</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L8733" data-line-number="8733"></td>
        <td id="LC8733">                    }</td>
      </tr>
      <tr>
        <td id="L8734" data-line-number="8734"></td>
        <td id="LC8734">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>UTF8Support</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8735" data-line-number="8735"></td>
        <td id="LC8735">                    {</td>
      </tr>
      <tr>
        <td id="L8736" data-line-number="8736"></td>
        <td id="LC8736">                        <span>length</span> <span>+=</span> <span>WriteUTF8SupportFeatureRequest</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L8737" data-line-number="8737"></td>
        <td id="LC8737">                    }</td>
      </tr>
      <tr>
        <td id="L8738" data-line-number="8738"></td>
        <td id="LC8738">                    <span>length</span><span>++</span>; <span><span>//</span> for terminator</span></td>
      </tr>
      <tr>
        <td id="L8739" data-line-number="8739"></td>
        <td id="LC8739">                }</td>
      </tr>
      <tr>
        <td id="L8740" data-line-number="8740"></td>
        <td id="LC8740">            }</td>
      </tr>
      <tr>
        <td id="L8741" data-line-number="8741"></td>
        <td id="LC8741">
</td>
      </tr>
      <tr>
        <td id="L8742" data-line-number="8742"></td>
        <td id="LC8742">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L8743" data-line-number="8743"></td>
        <td id="LC8743">            {</td>
      </tr>
      <tr>
        <td id="L8744" data-line-number="8744"></td>
        <td id="LC8744">                <span>WriteInt</span>(<span>length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8745" data-line-number="8745"></td>
        <td id="LC8745">                <span>if</span> (<span>recoverySessionData</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8746" data-line-number="8746"></td>
        <td id="LC8746">                {</td>
      </tr>
      <tr>
        <td id="L8747" data-line-number="8747"></td>
        <td id="LC8747">                    <span>WriteInt</span>((<span>TdsEnums</span>.<span>DENALI_MAJOR</span> <span>&lt;&lt;</span> <span>24</span>) <span>|</span> (<span>TdsEnums</span>.<span>DENALI_INCREMENT</span> <span>&lt;&lt;</span> <span>16</span>) <span>|</span> <span>TdsEnums</span>.<span>DENALI_MINOR</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8748" data-line-number="8748"></td>
        <td id="LC8748">                }</td>
      </tr>
      <tr>
        <td id="L8749" data-line-number="8749"></td>
        <td id="LC8749">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L8750" data-line-number="8750"></td>
        <td id="LC8750">                {</td>
      </tr>
      <tr>
        <td id="L8751" data-line-number="8751"></td>
        <td id="LC8751">                    <span>WriteUnsignedInt</span>(<span>recoverySessionData</span>.<span>_tdsVersion</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8752" data-line-number="8752"></td>
        <td id="LC8752">                }</td>
      </tr>
      <tr>
        <td id="L8753" data-line-number="8753"></td>
        <td id="LC8753">                <span>WriteInt</span>(<span>rec</span>.<span>packetSize</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8754" data-line-number="8754"></td>
        <td id="LC8754">                <span>WriteInt</span>(<span>TdsEnums</span>.<span>CLIENT_PROG_VER</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8755" data-line-number="8755"></td>
        <td id="LC8755">                <span>WriteInt</span>(<span>TdsParserStaticMethods</span>.<span>GetCurrentProcessIdForTdsLoginOnly</span>(), <span>_physicalStateObj</span>); <span><span>//</span>MDAC 84718</span></td>
      </tr>
      <tr>
        <td id="L8756" data-line-number="8756"></td>
        <td id="LC8756">                <span>WriteInt</span>(<span>0</span>, <span>_physicalStateObj</span>); <span><span>//</span> connectionID is unused</span></td>
      </tr>
      <tr>
        <td id="L8757" data-line-number="8757"></td>
        <td id="LC8757">
</td>
      </tr>
      <tr>
        <td id="L8758" data-line-number="8758"></td>
        <td id="LC8758">                <span><span>//</span> Log7Flags (DWORD)</span></td>
      </tr>
      <tr>
        <td id="L8759" data-line-number="8759"></td>
        <td id="LC8759">                <span>int</span> <span>log7Flags</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L8760" data-line-number="8760"></td>
        <td id="LC8760">
</td>
      </tr>
      <tr>
        <td id="L8761" data-line-number="8761"></td>
        <td id="LC8761">                <span><span>/*</span></span></td>
      </tr>
      <tr>
        <td id="L8762" data-line-number="8762"></td>
        <td id="LC8762"><span>                 Current snapshot from TDS spec with the offsets added:</span></td>
      </tr>
      <tr>
        <td id="L8763" data-line-number="8763"></td>
        <td id="LC8763"><span>                    0) fByteOrder:1,                // byte order of numeric data types on client</span></td>
      </tr>
      <tr>
        <td id="L8764" data-line-number="8764"></td>
        <td id="LC8764"><span>                    1) fCharSet:1,                  // character set on client</span></td>
      </tr>
      <tr>
        <td id="L8765" data-line-number="8765"></td>
        <td id="LC8765"><span>                    2) fFloat:2,                    // Type of floating point on client</span></td>
      </tr>
      <tr>
        <td id="L8766" data-line-number="8766"></td>
        <td id="LC8766"><span>                    4) fDumpLoad:1,                 // Dump/Load and BCP enable</span></td>
      </tr>
      <tr>
        <td id="L8767" data-line-number="8767"></td>
        <td id="LC8767"><span>                    5) fUseDb:1,                    // USE notification</span></td>
      </tr>
      <tr>
        <td id="L8768" data-line-number="8768"></td>
        <td id="LC8768"><span>                    6) fDatabase:1,                 // Initial database fatal flag</span></td>
      </tr>
      <tr>
        <td id="L8769" data-line-number="8769"></td>
        <td id="LC8769"><span>                    7) fSetLang:1,                  // SET LANGUAGE notification</span></td>
      </tr>
      <tr>
        <td id="L8770" data-line-number="8770"></td>
        <td id="LC8770"><span>                    8) fLanguage:1,                 // Initial language fatal flag</span></td>
      </tr>
      <tr>
        <td id="L8771" data-line-number="8771"></td>
        <td id="LC8771"><span>                    9) fODBC:1,                     // Set if client is ODBC driver</span></td>
      </tr>
      <tr>
        <td id="L8772" data-line-number="8772"></td>
        <td id="LC8772"><span>                   10) fTranBoundary:1,             // Transaction boundary notification</span></td>
      </tr>
      <tr>
        <td id="L8773" data-line-number="8773"></td>
        <td id="LC8773"><span>                   11) fDelegatedSec:1,             // Security with delegation is available</span></td>
      </tr>
      <tr>
        <td id="L8774" data-line-number="8774"></td>
        <td id="LC8774"><span>                   12) fUserType:3,                 // Type of user</span></td>
      </tr>
      <tr>
        <td id="L8775" data-line-number="8775"></td>
        <td id="LC8775"><span>                   15) fIntegratedSecurity:1,       // Set if client is using integrated security</span></td>
      </tr>
      <tr>
        <td id="L8776" data-line-number="8776"></td>
        <td id="LC8776"><span>                   16) fSQLType:4,                  // Type of SQL sent from client</span></td>
      </tr>
      <tr>
        <td id="L8777" data-line-number="8777"></td>
        <td id="LC8777"><span>                   20) fOLEDB:1,                    // Set if client is OLEDB driver</span></td>
      </tr>
      <tr>
        <td id="L8778" data-line-number="8778"></td>
        <td id="LC8778"><span>                   21) fSpare1:3,                   // first bit used for read-only intent, rest unused</span></td>
      </tr>
      <tr>
        <td id="L8779" data-line-number="8779"></td>
        <td id="LC8779"><span>                   24) fResetPassword:1,            // set if client wants to reset password</span></td>
      </tr>
      <tr>
        <td id="L8780" data-line-number="8780"></td>
        <td id="LC8780"><span>                   25) fNoNBCAndSparse:1,           // set if client does not support NBC and Sparse column</span></td>
      </tr>
      <tr>
        <td id="L8781" data-line-number="8781"></td>
        <td id="LC8781"><span>                   26) fUserInstance:1,             // This connection wants to connect to a SQL "user instance"</span></td>
      </tr>
      <tr>
        <td id="L8782" data-line-number="8782"></td>
        <td id="LC8782"><span>                   27) fUnknownCollationHandling:1, // This connection can handle unknown collation correctly.</span></td>
      </tr>
      <tr>
        <td id="L8783" data-line-number="8783"></td>
        <td id="LC8783"><span>                   28) fExtension:1                 // Extensions are used</span></td>
      </tr>
      <tr>
        <td id="L8784" data-line-number="8784"></td>
        <td id="LC8784"><span>                   32 - total</span></td>
      </tr>
      <tr>
        <td id="L8785" data-line-number="8785"></td>
        <td id="LC8785"><span>                <span>*/</span></span></td>
      </tr>
      <tr>
        <td id="L8786" data-line-number="8786"></td>
        <td id="LC8786">
</td>
      </tr>
      <tr>
        <td id="L8787" data-line-number="8787"></td>
        <td id="LC8787">                <span><span>//</span> first byte</span></td>
      </tr>
      <tr>
        <td id="L8788" data-line-number="8788"></td>
        <td id="LC8788">                <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>USE_DB_ON</span> <span>&lt;&lt;</span> <span>5</span>;</td>
      </tr>
      <tr>
        <td id="L8789" data-line-number="8789"></td>
        <td id="LC8789">                <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>INIT_DB_FATAL</span> <span>&lt;&lt;</span> <span>6</span>;</td>
      </tr>
      <tr>
        <td id="L8790" data-line-number="8790"></td>
        <td id="LC8790">                <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>SET_LANG_ON</span> <span>&lt;&lt;</span> <span>7</span>;</td>
      </tr>
      <tr>
        <td id="L8791" data-line-number="8791"></td>
        <td id="LC8791">
</td>
      </tr>
      <tr>
        <td id="L8792" data-line-number="8792"></td>
        <td id="LC8792">                <span><span>//</span> second byte</span></td>
      </tr>
      <tr>
        <td id="L8793" data-line-number="8793"></td>
        <td id="LC8793">                <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>INIT_LANG_FATAL</span> <span>&lt;&lt;</span> <span>8</span>;</td>
      </tr>
      <tr>
        <td id="L8794" data-line-number="8794"></td>
        <td id="LC8794">                <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>ODBC_ON</span> <span>&lt;&lt;</span> <span>9</span>;</td>
      </tr>
      <tr>
        <td id="L8795" data-line-number="8795"></td>
        <td id="LC8795">                <span>if</span> (<span>rec</span>.<span>useReplication</span>)</td>
      </tr>
      <tr>
        <td id="L8796" data-line-number="8796"></td>
        <td id="LC8796">                {</td>
      </tr>
      <tr>
        <td id="L8797" data-line-number="8797"></td>
        <td id="LC8797">                    <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>REPL_ON</span> <span>&lt;&lt;</span> <span>12</span>;</td>
      </tr>
      <tr>
        <td id="L8798" data-line-number="8798"></td>
        <td id="LC8798">                }</td>
      </tr>
      <tr>
        <td id="L8799" data-line-number="8799"></td>
        <td id="LC8799">                <span>if</span> (<span>rec</span>.<span>useSSPI</span>)</td>
      </tr>
      <tr>
        <td id="L8800" data-line-number="8800"></td>
        <td id="LC8800">                {</td>
      </tr>
      <tr>
        <td id="L8801" data-line-number="8801"></td>
        <td id="LC8801">                    <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>SSPI_ON</span> <span>&lt;&lt;</span> <span>15</span>;</td>
      </tr>
      <tr>
        <td id="L8802" data-line-number="8802"></td>
        <td id="LC8802">                }</td>
      </tr>
      <tr>
        <td id="L8803" data-line-number="8803"></td>
        <td id="LC8803">
</td>
      </tr>
      <tr>
        <td id="L8804" data-line-number="8804"></td>
        <td id="LC8804">                <span><span>//</span> third byte</span></td>
      </tr>
      <tr>
        <td id="L8805" data-line-number="8805"></td>
        <td id="LC8805">                <span>if</span> (<span>rec</span>.<span>readOnlyIntent</span>)</td>
      </tr>
      <tr>
        <td id="L8806" data-line-number="8806"></td>
        <td id="LC8806">                {</td>
      </tr>
      <tr>
        <td id="L8807" data-line-number="8807"></td>
        <td id="LC8807">                    <span>log7Flags</span> <span>|=</span> <span>TdsEnums</span>.<span>READONLY_INTENT_ON</span> <span>&lt;&lt;</span> <span>21</span>; <span><span>//</span> read-only intent flag is a first bit of fSpare1</span></td>
      </tr>
      <tr>
        <td id="L8808" data-line-number="8808"></td>
        <td id="LC8808">                }</td>
      </tr>
      <tr>
        <td id="L8809" data-line-number="8809"></td>
        <td id="LC8809">
</td>
      </tr>
      <tr>
        <td id="L8810" data-line-number="8810"></td>
        <td id="LC8810">                <span><span>//</span> 4th one</span></td>
      </tr>
      <tr>
        <td id="L8811" data-line-number="8811"></td>
        <td id="LC8811">                <span>if</span> (<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>rec</span>.<span>newPassword</span>) <span>||</span> (<span>rec</span>.<span>newSecurePassword</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>rec</span>.<span>newSecurePassword</span>.<span>Length</span> <span>!=</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L8812" data-line-number="8812"></td>
        <td id="LC8812">                {</td>
      </tr>
      <tr>
        <td id="L8813" data-line-number="8813"></td>
        <td id="LC8813">                    <span>log7Flags</span> <span>|=</span> <span>1</span> <span>&lt;&lt;</span> <span>24</span>;</td>
      </tr>
      <tr>
        <td id="L8814" data-line-number="8814"></td>
        <td id="LC8814">                }</td>
      </tr>
      <tr>
        <td id="L8815" data-line-number="8815"></td>
        <td id="LC8815">                <span>if</span> (<span>rec</span>.<span>userInstance</span>)</td>
      </tr>
      <tr>
        <td id="L8816" data-line-number="8816"></td>
        <td id="LC8816">                {</td>
      </tr>
      <tr>
        <td id="L8817" data-line-number="8817"></td>
        <td id="LC8817">                    <span>log7Flags</span> <span>|=</span> <span>1</span> <span>&lt;&lt;</span> <span>26</span>;</td>
      </tr>
      <tr>
        <td id="L8818" data-line-number="8818"></td>
        <td id="LC8818">                }</td>
      </tr>
      <tr>
        <td id="L8819" data-line-number="8819"></td>
        <td id="LC8819">
</td>
      </tr>
      <tr>
        <td id="L8820" data-line-number="8820"></td>
        <td id="LC8820">                <span>if</span> (<span>useFeatureExt</span>)</td>
      </tr>
      <tr>
        <td id="L8821" data-line-number="8821"></td>
        <td id="LC8821">                {</td>
      </tr>
      <tr>
        <td id="L8822" data-line-number="8822"></td>
        <td id="LC8822">                    <span>log7Flags</span> <span>|=</span> <span>1</span> <span>&lt;&lt;</span> <span>28</span>;</td>
      </tr>
      <tr>
        <td id="L8823" data-line-number="8823"></td>
        <td id="LC8823">                }</td>
      </tr>
      <tr>
        <td id="L8824" data-line-number="8824"></td>
        <td id="LC8824">
</td>
      </tr>
      <tr>
        <td id="L8825" data-line-number="8825"></td>
        <td id="LC8825">                <span>WriteInt</span>(<span>log7Flags</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8826" data-line-number="8826"></td>
        <td id="LC8826">                <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L8827" data-line-number="8827"></td>
        <td id="LC8827">                {</td>
      </tr>
      <tr>
        <td id="L8828" data-line-number="8828"></td>
        <td id="LC8828">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TdsLogin|ADV&gt; %d#, TDS Login7 flags = %d:<span>\n</span><span>"</span></span>, <span>ObjectID</span>, <span>log7Flags</span>);</td>
      </tr>
      <tr>
        <td id="L8829" data-line-number="8829"></td>
        <td id="LC8829">                }</td>
      </tr>
      <tr>
        <td id="L8830" data-line-number="8830"></td>
        <td id="LC8830">
</td>
      </tr>
      <tr>
        <td id="L8831" data-line-number="8831"></td>
        <td id="LC8831">                <span>WriteInt</span>(<span>0</span>, <span>_physicalStateObj</span>);  <span><span>//</span> ClientTimeZone is not used</span></td>
      </tr>
      <tr>
        <td id="L8832" data-line-number="8832"></td>
        <td id="LC8832">                <span>WriteInt</span>(<span>0</span>, <span>_physicalStateObj</span>);  <span><span>//</span> LCID is unused by server</span></td>
      </tr>
      <tr>
        <td id="L8833" data-line-number="8833"></td>
        <td id="LC8833">
</td>
      </tr>
      <tr>
        <td id="L8834" data-line-number="8834"></td>
        <td id="LC8834">                <span><span>//</span> Start writing offset and length of variable length portions</span></td>
      </tr>
      <tr>
        <td id="L8835" data-line-number="8835"></td>
        <td id="LC8835">                <span>int</span> <span>offset</span> <span>=</span> <span>TdsEnums</span>.<span>YUKON_LOG_REC_FIXED_LEN</span>;</td>
      </tr>
      <tr>
        <td id="L8836" data-line-number="8836"></td>
        <td id="LC8836">
</td>
      </tr>
      <tr>
        <td id="L8837" data-line-number="8837"></td>
        <td id="LC8837">                <span><span>//</span> write offset/length pairs</span></td>
      </tr>
      <tr>
        <td id="L8838" data-line-number="8838"></td>
        <td id="LC8838">
</td>
      </tr>
      <tr>
        <td id="L8839" data-line-number="8839"></td>
        <td id="LC8839">                <span><span>//</span> note that you must always set ibHostName since it indicaters the beginning of the variable length section of the login record</span></td>
      </tr>
      <tr>
        <td id="L8840" data-line-number="8840"></td>
        <td id="LC8840">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> host name offset</span></td>
      </tr>
      <tr>
        <td id="L8841" data-line-number="8841"></td>
        <td id="LC8841">                <span>WriteShort</span>(<span>rec</span>.<span>hostName</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8842" data-line-number="8842"></td>
        <td id="LC8842">                <span>offset</span> <span>+=</span> <span>rec</span>.<span>hostName</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8843" data-line-number="8843"></td>
        <td id="LC8843">
</td>
      </tr>
      <tr>
        <td id="L8844" data-line-number="8844"></td>
        <td id="LC8844">                <span><span>//</span> Only send user/password over if not fSSPI or fed auth MSAL...  If both user/password and SSPI are in login</span></td>
      </tr>
      <tr>
        <td id="L8845" data-line-number="8845"></td>
        <td id="LC8845">                <span><span>//</span> rec, only SSPI is used.  Confirmed same bahavior as in luxor.</span></td>
      </tr>
      <tr>
        <td id="L8846" data-line-number="8846"></td>
        <td id="LC8846">                <span>if</span> (<span>!</span><span>rec</span>.<span>useSSPI</span> <span>&amp;&amp;</span> <span>!</span>(<span>_connHandler</span>.<span>_federatedAuthenticationInfoRequested</span> <span>||</span> <span>_connHandler</span>.<span>_federatedAuthenticationRequested</span>))</td>
      </tr>
      <tr>
        <td id="L8847" data-line-number="8847"></td>
        <td id="LC8847">                {</td>
      </tr>
      <tr>
        <td id="L8848" data-line-number="8848"></td>
        <td id="LC8848">                    <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>);  <span><span>//</span> userName offset</span></td>
      </tr>
      <tr>
        <td id="L8849" data-line-number="8849"></td>
        <td id="LC8849">                    <span>WriteShort</span>(<span>userName</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8850" data-line-number="8850"></td>
        <td id="LC8850">                    <span>offset</span> <span>+=</span> <span>userName</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8851" data-line-number="8851"></td>
        <td id="LC8851">
</td>
      </tr>
      <tr>
        <td id="L8852" data-line-number="8852"></td>
        <td id="LC8852">                    <span><span>//</span> the encrypted password is a byte array - so length computations different than strings</span></td>
      </tr>
      <tr>
        <td id="L8853" data-line-number="8853"></td>
        <td id="LC8853">                    <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> password offset</span></td>
      </tr>
      <tr>
        <td id="L8854" data-line-number="8854"></td>
        <td id="LC8854">                    <span>WriteShort</span>(<span>encryptedPasswordLengthInBytes</span> <span>/</span> <span>2</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8855" data-line-number="8855"></td>
        <td id="LC8855">                    <span>offset</span> <span>+=</span> <span>encryptedPasswordLengthInBytes</span>;</td>
      </tr>
      <tr>
        <td id="L8856" data-line-number="8856"></td>
        <td id="LC8856">                }</td>
      </tr>
      <tr>
        <td id="L8857" data-line-number="8857"></td>
        <td id="LC8857">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L8858" data-line-number="8858"></td>
        <td id="LC8858">                {</td>
      </tr>
      <tr>
        <td id="L8859" data-line-number="8859"></td>
        <td id="LC8859">                    <span><span>//</span> case where user/password data is not used, send over zeros</span></td>
      </tr>
      <tr>
        <td id="L8860" data-line-number="8860"></td>
        <td id="LC8860">                    <span>WriteShort</span>(<span>0</span>, <span>_physicalStateObj</span>);  <span><span>//</span> userName offset</span></td>
      </tr>
      <tr>
        <td id="L8861" data-line-number="8861"></td>
        <td id="LC8861">                    <span>WriteShort</span>(<span>0</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8862" data-line-number="8862"></td>
        <td id="LC8862">                    <span>WriteShort</span>(<span>0</span>, <span>_physicalStateObj</span>);  <span><span>//</span> password offset</span></td>
      </tr>
      <tr>
        <td id="L8863" data-line-number="8863"></td>
        <td id="LC8863">                    <span>WriteShort</span>(<span>0</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8864" data-line-number="8864"></td>
        <td id="LC8864">                }</td>
      </tr>
      <tr>
        <td id="L8865" data-line-number="8865"></td>
        <td id="LC8865">
</td>
      </tr>
      <tr>
        <td id="L8866" data-line-number="8866"></td>
        <td id="LC8866">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> app name offset</span></td>
      </tr>
      <tr>
        <td id="L8867" data-line-number="8867"></td>
        <td id="LC8867">                <span>WriteShort</span>(<span>rec</span>.<span>applicationName</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8868" data-line-number="8868"></td>
        <td id="LC8868">                <span>offset</span> <span>+=</span> <span>rec</span>.<span>applicationName</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8869" data-line-number="8869"></td>
        <td id="LC8869">
</td>
      </tr>
      <tr>
        <td id="L8870" data-line-number="8870"></td>
        <td id="LC8870">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> server name offset</span></td>
      </tr>
      <tr>
        <td id="L8871" data-line-number="8871"></td>
        <td id="LC8871">                <span>WriteShort</span>(<span>rec</span>.<span>serverName</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8872" data-line-number="8872"></td>
        <td id="LC8872">                <span>offset</span> <span>+=</span> <span>rec</span>.<span>serverName</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8873" data-line-number="8873"></td>
        <td id="LC8873">
</td>
      </tr>
      <tr>
        <td id="L8874" data-line-number="8874"></td>
        <td id="LC8874">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8875" data-line-number="8875"></td>
        <td id="LC8875">                <span>if</span> (<span>useFeatureExt</span>)</td>
      </tr>
      <tr>
        <td id="L8876" data-line-number="8876"></td>
        <td id="LC8876">                {</td>
      </tr>
      <tr>
        <td id="L8877" data-line-number="8877"></td>
        <td id="LC8877">                    <span>WriteShort</span>(<span>4</span>, <span>_physicalStateObj</span>); <span><span>//</span> length of ibFeatgureExtLong (which is a DWORD)</span></td>
      </tr>
      <tr>
        <td id="L8878" data-line-number="8878"></td>
        <td id="LC8878">                    <span>offset</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L8879" data-line-number="8879"></td>
        <td id="LC8879">                }</td>
      </tr>
      <tr>
        <td id="L8880" data-line-number="8880"></td>
        <td id="LC8880">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L8881" data-line-number="8881"></td>
        <td id="LC8881">                {</td>
      </tr>
      <tr>
        <td id="L8882" data-line-number="8882"></td>
        <td id="LC8882">                    <span>WriteShort</span>(<span>0</span>, <span>_physicalStateObj</span>); <span><span>//</span> unused (was remote password ?)</span></td>
      </tr>
      <tr>
        <td id="L8883" data-line-number="8883"></td>
        <td id="LC8883">                }</td>
      </tr>
      <tr>
        <td id="L8884" data-line-number="8884"></td>
        <td id="LC8884">
</td>
      </tr>
      <tr>
        <td id="L8885" data-line-number="8885"></td>
        <td id="LC8885">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> client interface name offset</span></td>
      </tr>
      <tr>
        <td id="L8886" data-line-number="8886"></td>
        <td id="LC8886">                <span>WriteShort</span>(<span>clientInterfaceName</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8887" data-line-number="8887"></td>
        <td id="LC8887">                <span>offset</span> <span>+=</span> <span>clientInterfaceName</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8888" data-line-number="8888"></td>
        <td id="LC8888">
</td>
      </tr>
      <tr>
        <td id="L8889" data-line-number="8889"></td>
        <td id="LC8889">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> language name offset</span></td>
      </tr>
      <tr>
        <td id="L8890" data-line-number="8890"></td>
        <td id="LC8890">                <span>WriteShort</span>(<span>rec</span>.<span>language</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8891" data-line-number="8891"></td>
        <td id="LC8891">                <span>offset</span> <span>+=</span> <span>rec</span>.<span>language</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8892" data-line-number="8892"></td>
        <td id="LC8892">
</td>
      </tr>
      <tr>
        <td id="L8893" data-line-number="8893"></td>
        <td id="LC8893">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> database name offset</span></td>
      </tr>
      <tr>
        <td id="L8894" data-line-number="8894"></td>
        <td id="LC8894">                <span>WriteShort</span>(<span>rec</span>.<span>database</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8895" data-line-number="8895"></td>
        <td id="LC8895">                <span>offset</span> <span>+=</span> <span>rec</span>.<span>database</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8896" data-line-number="8896"></td>
        <td id="LC8896">
</td>
      </tr>
      <tr>
        <td id="L8897" data-line-number="8897"></td>
        <td id="LC8897">                <span><span>//</span> UNDONE: NIC address</span></td>
      </tr>
      <tr>
        <td id="L8898" data-line-number="8898"></td>
        <td id="LC8898">                <span><span>//</span> previously we declared the array and simply sent it over - byte[] of 0's</span></td>
      </tr>
      <tr>
        <td id="L8899" data-line-number="8899"></td>
        <td id="LC8899">                <span>if</span> (<span>null</span> <span>==</span> <span>s_nicAddress</span>)</td>
      </tr>
      <tr>
        <td id="L8900" data-line-number="8900"></td>
        <td id="LC8900">                    <span>s_nicAddress</span> <span>=</span> <span>TdsParserStaticMethods</span>.<span>GetNetworkPhysicalAddressForTdsLoginOnly</span>();</td>
      </tr>
      <tr>
        <td id="L8901" data-line-number="8901"></td>
        <td id="LC8901">
</td>
      </tr>
      <tr>
        <td id="L8902" data-line-number="8902"></td>
        <td id="LC8902">                <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>s_nicAddress</span>, <span>s_nicAddress</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8903" data-line-number="8903"></td>
        <td id="LC8903">
</td>
      </tr>
      <tr>
        <td id="L8904" data-line-number="8904"></td>
        <td id="LC8904">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> ibSSPI offset</span></td>
      </tr>
      <tr>
        <td id="L8905" data-line-number="8905"></td>
        <td id="LC8905">                <span>if</span> (<span>rec</span>.<span>useSSPI</span>)</td>
      </tr>
      <tr>
        <td id="L8906" data-line-number="8906"></td>
        <td id="LC8906">                {</td>
      </tr>
      <tr>
        <td id="L8907" data-line-number="8907"></td>
        <td id="LC8907">                    <span>WriteShort</span>((<span>int</span>)<span>outSSPILength</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8908" data-line-number="8908"></td>
        <td id="LC8908">                    <span>offset</span> <span>+=</span> (<span>int</span>)<span>outSSPILength</span>;</td>
      </tr>
      <tr>
        <td id="L8909" data-line-number="8909"></td>
        <td id="LC8909">                }</td>
      </tr>
      <tr>
        <td id="L8910" data-line-number="8910"></td>
        <td id="LC8910">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L8911" data-line-number="8911"></td>
        <td id="LC8911">                {</td>
      </tr>
      <tr>
        <td id="L8912" data-line-number="8912"></td>
        <td id="LC8912">                    <span>WriteShort</span>(<span>0</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8913" data-line-number="8913"></td>
        <td id="LC8913">                }</td>
      </tr>
      <tr>
        <td id="L8914" data-line-number="8914"></td>
        <td id="LC8914">
</td>
      </tr>
      <tr>
        <td id="L8915" data-line-number="8915"></td>
        <td id="LC8915">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> DB filename offset</span></td>
      </tr>
      <tr>
        <td id="L8916" data-line-number="8916"></td>
        <td id="LC8916">                <span>WriteShort</span>(<span>rec</span>.<span>attachDBFilename</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8917" data-line-number="8917"></td>
        <td id="LC8917">                <span>offset</span> <span>+=</span> <span>rec</span>.<span>attachDBFilename</span>.<span>Length</span> <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L8918" data-line-number="8918"></td>
        <td id="LC8918">
</td>
      </tr>
      <tr>
        <td id="L8919" data-line-number="8919"></td>
        <td id="LC8919">                <span>WriteShort</span>(<span>offset</span>, <span>_physicalStateObj</span>); <span><span>//</span> reset password offset</span></td>
      </tr>
      <tr>
        <td id="L8920" data-line-number="8920"></td>
        <td id="LC8920">                <span>WriteShort</span>(<span>encryptedChangePasswordLengthInBytes</span> <span>/</span> <span>2</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8921" data-line-number="8921"></td>
        <td id="LC8921">
</td>
      </tr>
      <tr>
        <td id="L8922" data-line-number="8922"></td>
        <td id="LC8922">                <span>WriteInt</span>(<span>0</span>, <span>_physicalStateObj</span>);        <span><span>//</span> reserved for chSSPI</span></td>
      </tr>
      <tr>
        <td id="L8923" data-line-number="8923"></td>
        <td id="LC8923">
</td>
      </tr>
      <tr>
        <td id="L8924" data-line-number="8924"></td>
        <td id="LC8924">                <span><span>//</span> write variable length portion</span></td>
      </tr>
      <tr>
        <td id="L8925" data-line-number="8925"></td>
        <td id="LC8925">                <span>WriteString</span>(<span>rec</span>.<span>hostName</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8926" data-line-number="8926"></td>
        <td id="LC8926">
</td>
      </tr>
      <tr>
        <td id="L8927" data-line-number="8927"></td>
        <td id="LC8927">                <span><span>//</span> if we are using SSPI or fed auth MSAL, do not send over username/password, since we will use SSPI instead</span></td>
      </tr>
      <tr>
        <td id="L8928" data-line-number="8928"></td>
        <td id="LC8928">                <span><span>//</span> same behavior as Luxor</span></td>
      </tr>
      <tr>
        <td id="L8929" data-line-number="8929"></td>
        <td id="LC8929">                <span>if</span> (<span>!</span><span>rec</span>.<span>useSSPI</span> <span>&amp;&amp;</span> <span>!</span>(<span>_connHandler</span>.<span>_federatedAuthenticationInfoRequested</span> <span>||</span> <span>_connHandler</span>.<span>_federatedAuthenticationRequested</span>))</td>
      </tr>
      <tr>
        <td id="L8930" data-line-number="8930"></td>
        <td id="LC8930">                {</td>
      </tr>
      <tr>
        <td id="L8931" data-line-number="8931"></td>
        <td id="LC8931">                    <span>WriteString</span>(<span>userName</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8932" data-line-number="8932"></td>
        <td id="LC8932">
</td>
      </tr>
      <tr>
        <td id="L8933" data-line-number="8933"></td>
        <td id="LC8933">                    <span><span>//</span> Cache offset in packet for tracing.</span></td>
      </tr>
      <tr>
        <td id="L8934" data-line-number="8934"></td>
        <td id="LC8934">                    <span>_physicalStateObj</span>.<span>_tracePasswordOffset</span> <span>=</span> <span>_physicalStateObj</span>.<span>_outBytesUsed</span>;</td>
      </tr>
      <tr>
        <td id="L8935" data-line-number="8935"></td>
        <td id="LC8935">                    <span>_physicalStateObj</span>.<span>_tracePasswordLength</span> <span>=</span> <span>encryptedPasswordLengthInBytes</span>;</td>
      </tr>
      <tr>
        <td id="L8936" data-line-number="8936"></td>
        <td id="LC8936">
</td>
      </tr>
      <tr>
        <td id="L8937" data-line-number="8937"></td>
        <td id="LC8937">                    <span>if</span> (<span>rec</span>.<span>credential</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8938" data-line-number="8938"></td>
        <td id="LC8938">                    {</td>
      </tr>
      <tr>
        <td id="L8939" data-line-number="8939"></td>
        <td id="LC8939">                        <span>_physicalStateObj</span>.<span>WriteSecureString</span>(<span>rec</span>.<span>credential</span>.<span>Password</span>);</td>
      </tr>
      <tr>
        <td id="L8940" data-line-number="8940"></td>
        <td id="LC8940">                    }</td>
      </tr>
      <tr>
        <td id="L8941" data-line-number="8941"></td>
        <td id="LC8941">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L8942" data-line-number="8942"></td>
        <td id="LC8942">                    {</td>
      </tr>
      <tr>
        <td id="L8943" data-line-number="8943"></td>
        <td id="LC8943">                        <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>encryptedPassword</span>, <span>encryptedPasswordLengthInBytes</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8944" data-line-number="8944"></td>
        <td id="LC8944">                    }</td>
      </tr>
      <tr>
        <td id="L8945" data-line-number="8945"></td>
        <td id="LC8945">                }</td>
      </tr>
      <tr>
        <td id="L8946" data-line-number="8946"></td>
        <td id="LC8946">
</td>
      </tr>
      <tr>
        <td id="L8947" data-line-number="8947"></td>
        <td id="LC8947">                <span>WriteString</span>(<span>rec</span>.<span>applicationName</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8948" data-line-number="8948"></td>
        <td id="LC8948">                <span>WriteString</span>(<span>rec</span>.<span>serverName</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8949" data-line-number="8949"></td>
        <td id="LC8949">
</td>
      </tr>
      <tr>
        <td id="L8950" data-line-number="8950"></td>
        <td id="LC8950">                <span><span>//</span> write ibFeatureExtLong</span></td>
      </tr>
      <tr>
        <td id="L8951" data-line-number="8951"></td>
        <td id="LC8951">                <span>if</span> (<span>useFeatureExt</span>)</td>
      </tr>
      <tr>
        <td id="L8952" data-line-number="8952"></td>
        <td id="LC8952">                {</td>
      </tr>
      <tr>
        <td id="L8953" data-line-number="8953"></td>
        <td id="LC8953">                    <span>WriteInt</span>(<span>feOffset</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8954" data-line-number="8954"></td>
        <td id="LC8954">                }</td>
      </tr>
      <tr>
        <td id="L8955" data-line-number="8955"></td>
        <td id="LC8955">
</td>
      </tr>
      <tr>
        <td id="L8956" data-line-number="8956"></td>
        <td id="LC8956">                <span>WriteString</span>(<span>clientInterfaceName</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8957" data-line-number="8957"></td>
        <td id="LC8957">                <span>WriteString</span>(<span>rec</span>.<span>language</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8958" data-line-number="8958"></td>
        <td id="LC8958">                <span>WriteString</span>(<span>rec</span>.<span>database</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8959" data-line-number="8959"></td>
        <td id="LC8959">
</td>
      </tr>
      <tr>
        <td id="L8960" data-line-number="8960"></td>
        <td id="LC8960">                <span><span>//</span> send over SSPI data if we are using SSPI</span></td>
      </tr>
      <tr>
        <td id="L8961" data-line-number="8961"></td>
        <td id="LC8961">                <span>if</span> (<span>rec</span>.<span>useSSPI</span>)</td>
      </tr>
      <tr>
        <td id="L8962" data-line-number="8962"></td>
        <td id="LC8962">                    <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>outSSPIBuff</span>, (<span>int</span>)<span>outSSPILength</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8963" data-line-number="8963"></td>
        <td id="LC8963">
</td>
      </tr>
      <tr>
        <td id="L8964" data-line-number="8964"></td>
        <td id="LC8964">                <span>WriteString</span>(<span>rec</span>.<span>attachDBFilename</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L8965" data-line-number="8965"></td>
        <td id="LC8965">                <span>if</span> (<span>!</span><span>rec</span>.<span>useSSPI</span> <span>&amp;&amp;</span> <span>!</span>(<span>_connHandler</span>.<span>_federatedAuthenticationInfoRequested</span> <span>||</span> <span>_connHandler</span>.<span>_federatedAuthenticationRequested</span>))</td>
      </tr>
      <tr>
        <td id="L8966" data-line-number="8966"></td>
        <td id="LC8966">                {</td>
      </tr>
      <tr>
        <td id="L8967" data-line-number="8967"></td>
        <td id="LC8967">                    <span><span>//</span> Cache offset in packet for tracing.</span></td>
      </tr>
      <tr>
        <td id="L8968" data-line-number="8968"></td>
        <td id="LC8968">                    <span>_physicalStateObj</span>.<span>_traceChangePasswordOffset</span> <span>=</span> <span>_physicalStateObj</span>.<span>_outBytesUsed</span>;</td>
      </tr>
      <tr>
        <td id="L8969" data-line-number="8969"></td>
        <td id="LC8969">                    <span>_physicalStateObj</span>.<span>_traceChangePasswordLength</span> <span>=</span> <span>encryptedChangePasswordLengthInBytes</span>;</td>
      </tr>
      <tr>
        <td id="L8970" data-line-number="8970"></td>
        <td id="LC8970">                    <span>if</span> (<span>rec</span>.<span>newSecurePassword</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L8971" data-line-number="8971"></td>
        <td id="LC8971">                    {</td>
      </tr>
      <tr>
        <td id="L8972" data-line-number="8972"></td>
        <td id="LC8972">                        <span>_physicalStateObj</span>.<span>WriteSecureString</span>(<span>rec</span>.<span>newSecurePassword</span>);</td>
      </tr>
      <tr>
        <td id="L8973" data-line-number="8973"></td>
        <td id="LC8973">                    }</td>
      </tr>
      <tr>
        <td id="L8974" data-line-number="8974"></td>
        <td id="LC8974">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L8975" data-line-number="8975"></td>
        <td id="LC8975">                    {</td>
      </tr>
      <tr>
        <td id="L8976" data-line-number="8976"></td>
        <td id="LC8976">                        <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>encryptedChangePassword</span>, <span>encryptedChangePasswordLengthInBytes</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L8977" data-line-number="8977"></td>
        <td id="LC8977">                    }</td>
      </tr>
      <tr>
        <td id="L8978" data-line-number="8978"></td>
        <td id="LC8978">                }</td>
      </tr>
      <tr>
        <td id="L8979" data-line-number="8979"></td>
        <td id="LC8979">
</td>
      </tr>
      <tr>
        <td id="L8980" data-line-number="8980"></td>
        <td id="LC8980">                <span>if</span> (<span>useFeatureExt</span>)</td>
      </tr>
      <tr>
        <td id="L8981" data-line-number="8981"></td>
        <td id="LC8981">                {</td>
      </tr>
      <tr>
        <td id="L8982" data-line-number="8982"></td>
        <td id="LC8982">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>SessionRecovery</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8983" data-line-number="8983"></td>
        <td id="LC8983">                    {</td>
      </tr>
      <tr>
        <td id="L8984" data-line-number="8984"></td>
        <td id="LC8984">                        <span>WriteSessionRecoveryFeatureRequest</span>(<span>recoverySessionData</span>, <span>true</span>);</td>
      </tr>
      <tr>
        <td id="L8985" data-line-number="8985"></td>
        <td id="LC8985">                    };</td>
      </tr>
      <tr>
        <td id="L8986" data-line-number="8986"></td>
        <td id="LC8986">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>FedAuth</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8987" data-line-number="8987"></td>
        <td id="LC8987">                    {</td>
      </tr>
      <tr>
        <td id="L8988" data-line-number="8988"></td>
        <td id="LC8988">                        <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TdsLogin|SEC&gt; Sending federated authentication feature request<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8989" data-line-number="8989"></td>
        <td id="LC8989">                        <span>Debug</span>.<span>Assert</span>(<span>fedAuthFeatureExtensionData</span> <span>!=</span> <span>null</span>, <span><span>"</span>fedAuthFeatureExtensionData should not null.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L8990" data-line-number="8990"></td>
        <td id="LC8990">                        <span>WriteFedAuthFeatureRequest</span>(<span>fedAuthFeatureExtensionData</span>.<span>Value</span>, <span>write</span>: <span>true</span>);</td>
      </tr>
      <tr>
        <td id="L8991" data-line-number="8991"></td>
        <td id="LC8991">                    };</td>
      </tr>
      <tr>
        <td id="L8992" data-line-number="8992"></td>
        <td id="LC8992">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>Tce</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8993" data-line-number="8993"></td>
        <td id="LC8993">                    {</td>
      </tr>
      <tr>
        <td id="L8994" data-line-number="8994"></td>
        <td id="LC8994">                        <span>WriteTceFeatureRequest</span>(<span>true</span>);</td>
      </tr>
      <tr>
        <td id="L8995" data-line-number="8995"></td>
        <td id="LC8995">                    };</td>
      </tr>
      <tr>
        <td id="L8996" data-line-number="8996"></td>
        <td id="LC8996">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>GlobalTransactions</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L8997" data-line-number="8997"></td>
        <td id="LC8997">                    {</td>
      </tr>
      <tr>
        <td id="L8998" data-line-number="8998"></td>
        <td id="LC8998">                        <span>WriteGlobalTransactionsFeatureRequest</span>(<span>true</span>);</td>
      </tr>
      <tr>
        <td id="L8999" data-line-number="8999"></td>
        <td id="LC8999">                    };</td>
      </tr>
      <tr>
        <td id="L9000" data-line-number="9000"></td>
        <td id="LC9000">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>AzureSQLSupport</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L9001" data-line-number="9001"></td>
        <td id="LC9001">                    {</td>
      </tr>
      <tr>
        <td id="L9002" data-line-number="9002"></td>
        <td id="LC9002">                        <span>WriteAzureSQLSupportFeatureRequest</span>(<span>true</span>);</td>
      </tr>
      <tr>
        <td id="L9003" data-line-number="9003"></td>
        <td id="LC9003">                    }</td>
      </tr>
      <tr>
        <td id="L9004" data-line-number="9004"></td>
        <td id="LC9004">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>DataClassification</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L9005" data-line-number="9005"></td>
        <td id="LC9005">                    {</td>
      </tr>
      <tr>
        <td id="L9006" data-line-number="9006"></td>
        <td id="LC9006">                        <span>WriteDataClassificationFeatureRequest</span>(<span>true</span>);</td>
      </tr>
      <tr>
        <td id="L9007" data-line-number="9007"></td>
        <td id="LC9007">                    }</td>
      </tr>
      <tr>
        <td id="L9008" data-line-number="9008"></td>
        <td id="LC9008">                    <span>if</span> ((<span>requestedFeatures</span> <span>&amp;</span> <span>TdsEnums</span>.<span>FeatureExtension</span>.<span>UTF8Support</span>) <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L9009" data-line-number="9009"></td>
        <td id="LC9009">                    {</td>
      </tr>
      <tr>
        <td id="L9010" data-line-number="9010"></td>
        <td id="LC9010">                        <span>WriteUTF8SupportFeatureRequest</span>(<span>true</span>);</td>
      </tr>
      <tr>
        <td id="L9011" data-line-number="9011"></td>
        <td id="LC9011">                    }</td>
      </tr>
      <tr>
        <td id="L9012" data-line-number="9012"></td>
        <td id="LC9012">                    <span>_physicalStateObj</span>.<span>WriteByte</span>(<span>0xFF</span>); <span><span>//</span> terminator</span></td>
      </tr>
      <tr>
        <td id="L9013" data-line-number="9013"></td>
        <td id="LC9013">                }</td>
      </tr>
      <tr>
        <td id="L9014" data-line-number="9014"></td>
        <td id="LC9014">            } <span><span>//</span> try</span></td>
      </tr>
      <tr>
        <td id="L9015" data-line-number="9015"></td>
        <td id="LC9015">            <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L9016" data-line-number="9016"></td>
        <td id="LC9016">            {</td>
      </tr>
      <tr>
        <td id="L9017" data-line-number="9017"></td>
        <td id="LC9017">                <span><span>//</span> UNDONE - should not be catching all exceptions!!!</span></td>
      </tr>
      <tr>
        <td id="L9018" data-line-number="9018"></td>
        <td id="LC9018">                <span>if</span> (<span>ADP</span>.<span>IsCatchableExceptionType</span>(<span>e</span>))</td>
      </tr>
      <tr>
        <td id="L9019" data-line-number="9019"></td>
        <td id="LC9019">                {</td>
      </tr>
      <tr>
        <td id="L9020" data-line-number="9020"></td>
        <td id="LC9020">                    <span><span>//</span> be sure to wipe out our buffer if we started sending stuff</span></td>
      </tr>
      <tr>
        <td id="L9021" data-line-number="9021"></td>
        <td id="LC9021">                    <span>_physicalStateObj</span>.<span>ResetPacketCounters</span>();</td>
      </tr>
      <tr>
        <td id="L9022" data-line-number="9022"></td>
        <td id="LC9022">                    <span>_physicalStateObj</span>.<span>ResetBuffer</span>();</td>
      </tr>
      <tr>
        <td id="L9023" data-line-number="9023"></td>
        <td id="LC9023">                }</td>
      </tr>
      <tr>
        <td id="L9024" data-line-number="9024"></td>
        <td id="LC9024">
</td>
      </tr>
      <tr>
        <td id="L9025" data-line-number="9025"></td>
        <td id="LC9025">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L9026" data-line-number="9026"></td>
        <td id="LC9026">            }</td>
      </tr>
      <tr>
        <td id="L9027" data-line-number="9027"></td>
        <td id="LC9027">
</td>
      </tr>
      <tr>
        <td id="L9028" data-line-number="9028"></td>
        <td id="LC9028">            <span>_physicalStateObj</span>.<span>WritePacket</span>(<span>TdsEnums</span>.<span>HARDFLUSH</span>);</td>
      </tr>
      <tr>
        <td id="L9029" data-line-number="9029"></td>
        <td id="LC9029">            <span>_physicalStateObj</span>.<span>ResetSecurePasswordsInfomation</span>();     <span><span>//</span> Password information is needed only from Login process; done with writing login packet and should clear information</span></td>
      </tr>
      <tr>
        <td id="L9030" data-line-number="9030"></td>
        <td id="LC9030">            <span>_physicalStateObj</span>.<span>_pendingData</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9031" data-line-number="9031"></td>
        <td id="LC9031">            <span>_physicalStateObj</span>.<span>_messageStatus</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9032" data-line-number="9032"></td>
        <td id="LC9032">
</td>
      </tr>
      <tr>
        <td id="L9033" data-line-number="9033"></td>
        <td id="LC9033">            <span><span>//</span> Remvove CTAIP Provider after login record is sent.</span></td>
      </tr>
      <tr>
        <td id="L9034" data-line-number="9034"></td>
        <td id="LC9034">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L9035" data-line-number="9035"></td>
        <td id="LC9035">            <span>if</span> (<span>originalNetworkAddressInfo</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L9036" data-line-number="9036"></td>
        <td id="LC9036">            {</td>
      </tr>
      <tr>
        <td id="L9037" data-line-number="9037"></td>
        <td id="LC9037">                <span>UInt32</span> <span>error</span> <span>=</span> <span>SNINativeMethodWrapper</span>.<span>SNIRemoveProvider</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>SNINativeMethodWrapper</span>.<span>ProviderEnum</span>.<span>CTAIP_PROV</span>);</td>
      </tr>
      <tr>
        <td id="L9038" data-line-number="9038"></td>
        <td id="LC9038">                <span>if</span> (<span>error</span> <span>!=</span> <span>TdsEnums</span>.<span>SNI_SUCCESS</span>)</td>
      </tr>
      <tr>
        <td id="L9039" data-line-number="9039"></td>
        <td id="LC9039">                {</td>
      </tr>
      <tr>
        <td id="L9040" data-line-number="9040"></td>
        <td id="LC9040">                    <span>_physicalStateObj</span>.<span>AddError</span>(<span>ProcessSNIError</span>(<span>_physicalStateObj</span>));</td>
      </tr>
      <tr>
        <td id="L9041" data-line-number="9041"></td>
        <td id="LC9041">                    <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9042" data-line-number="9042"></td>
        <td id="LC9042">                }</td>
      </tr>
      <tr>
        <td id="L9043" data-line-number="9043"></td>
        <td id="LC9043">
</td>
      </tr>
      <tr>
        <td id="L9044" data-line-number="9044"></td>
        <td id="LC9044">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L9045" data-line-number="9045"></td>
        <td id="LC9045">                { } <span><span>//</span> EmptyTry/Finally to avoid FXCop violation</span></td>
      </tr>
      <tr>
        <td id="L9046" data-line-number="9046"></td>
        <td id="LC9046">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L9047" data-line-number="9047"></td>
        <td id="LC9047">                {</td>
      </tr>
      <tr>
        <td id="L9048" data-line-number="9048"></td>
        <td id="LC9048">                    <span>_physicalStateObj</span>.<span>ClearAllWritePackets</span>();</td>
      </tr>
      <tr>
        <td id="L9049" data-line-number="9049"></td>
        <td id="LC9049">                }</td>
      </tr>
      <tr>
        <td id="L9050" data-line-number="9050"></td>
        <td id="LC9050">            }</td>
      </tr>
      <tr>
        <td id="L9051" data-line-number="9051"></td>
        <td id="LC9051">        }<span><span>//</span> tdsLogin</span></td>
      </tr>
      <tr>
        <td id="L9052" data-line-number="9052"></td>
        <td id="LC9052">
</td>
      </tr>
      <tr>
        <td id="L9053" data-line-number="9053"></td>
        <td id="LC9053">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L9054" data-line-number="9054"></td>
        <td id="LC9054">        <span><span>///</span> Send the access token to the server.</span></td>
      </tr>
      <tr>
        <td id="L9055" data-line-number="9055"></td>
        <td id="LC9055">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L9056" data-line-number="9056"></td>
        <td id="LC9056">        <span><span>///</span> &lt;<span><span>param</span></span> <span><span>name</span></span>=<span><span>"</span>fedAuthToken<span>"</span></span>&gt;Type encapuslating a Federated Authentication access token.&lt;/<span><span>param</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L9057" data-line-number="9057"></td>
        <td id="LC9057">        <span>internal</span> <span>void</span> <span>SendFedAuthToken</span>(<span>SqlFedAuthToken</span> <span>fedAuthToken</span>)</td>
      </tr>
      <tr>
        <td id="L9058" data-line-number="9058"></td>
        <td id="LC9058">        {</td>
      </tr>
      <tr>
        <td id="L9059" data-line-number="9059"></td>
        <td id="LC9059">            <span>Debug</span>.<span>Assert</span>(<span>fedAuthToken</span> <span>!=</span> <span>null</span>, <span><span>"</span>fedAuthToken cannot be null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9060" data-line-number="9060"></td>
        <td id="LC9060">            <span>Debug</span>.<span>Assert</span>(<span>fedAuthToken</span>.<span>accessToken</span> <span>!=</span> <span>null</span>, <span><span>"</span>fedAuthToken.accessToken cannot be null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9061" data-line-number="9061"></td>
        <td id="LC9061">
</td>
      </tr>
      <tr>
        <td id="L9062" data-line-number="9062"></td>
        <td id="LC9062">            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.SendFedAuthToken|SEC&gt; Sending federated authentication token<span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9063" data-line-number="9063"></td>
        <td id="LC9063">
</td>
      </tr>
      <tr>
        <td id="L9064" data-line-number="9064"></td>
        <td id="LC9064">            <span>_physicalStateObj</span>.<span>_outputMessageType</span> <span>=</span> <span>TdsEnums</span>.<span>MT_FEDAUTH</span>;</td>
      </tr>
      <tr>
        <td id="L9065" data-line-number="9065"></td>
        <td id="LC9065">
</td>
      </tr>
      <tr>
        <td id="L9066" data-line-number="9066"></td>
        <td id="LC9066">            <span>byte</span>[] <span>accessToken</span> <span>=</span> <span>fedAuthToken</span>.<span>accessToken</span>;</td>
      </tr>
      <tr>
        <td id="L9067" data-line-number="9067"></td>
        <td id="LC9067">
</td>
      </tr>
      <tr>
        <td id="L9068" data-line-number="9068"></td>
        <td id="LC9068">            <span><span>//</span> Send total length (length of token plus 4 bytes for the token length field)</span></td>
      </tr>
      <tr>
        <td id="L9069" data-line-number="9069"></td>
        <td id="LC9069">            <span><span>//</span> If we were sending a nonce, this would include that length as well</span></td>
      </tr>
      <tr>
        <td id="L9070" data-line-number="9070"></td>
        <td id="LC9070">            <span>WriteUnsignedInt</span>((<span>uint</span>)<span>accessToken</span>.<span>Length</span> <span>+</span> <span>sizeof</span>(<span>uint</span>), <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9071" data-line-number="9071"></td>
        <td id="LC9071">
</td>
      </tr>
      <tr>
        <td id="L9072" data-line-number="9072"></td>
        <td id="LC9072">            <span><span>//</span> Send length of token</span></td>
      </tr>
      <tr>
        <td id="L9073" data-line-number="9073"></td>
        <td id="LC9073">            <span>WriteUnsignedInt</span>((<span>uint</span>)<span>accessToken</span>.<span>Length</span>, <span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9074" data-line-number="9074"></td>
        <td id="LC9074">
</td>
      </tr>
      <tr>
        <td id="L9075" data-line-number="9075"></td>
        <td id="LC9075">            <span><span>//</span> Send federated authentication access token</span></td>
      </tr>
      <tr>
        <td id="L9076" data-line-number="9076"></td>
        <td id="LC9076">            <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>accessToken</span>, <span>accessToken</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L9077" data-line-number="9077"></td>
        <td id="LC9077">
</td>
      </tr>
      <tr>
        <td id="L9078" data-line-number="9078"></td>
        <td id="LC9078">            <span>_physicalStateObj</span>.<span>WritePacket</span>(<span>TdsEnums</span>.<span>HARDFLUSH</span>);</td>
      </tr>
      <tr>
        <td id="L9079" data-line-number="9079"></td>
        <td id="LC9079">            <span>_physicalStateObj</span>.<span>_pendingData</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9080" data-line-number="9080"></td>
        <td id="LC9080">            <span>_physicalStateObj</span>.<span>_messageStatus</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9081" data-line-number="9081"></td>
        <td id="LC9081">
</td>
      </tr>
      <tr>
        <td id="L9082" data-line-number="9082"></td>
        <td id="LC9082">            <span>_connHandler</span>.<span>_federatedAuthenticationRequested</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9083" data-line-number="9083"></td>
        <td id="LC9083">        }</td>
      </tr>
      <tr>
        <td id="L9084" data-line-number="9084"></td>
        <td id="LC9084">
</td>
      </tr>
      <tr>
        <td id="L9085" data-line-number="9085"></td>
        <td id="LC9085">        <span>private</span> <span>void</span> <span>SSPIData</span>(<span>byte</span>[] <span>receivedBuff</span>, <span>UInt32</span> <span>receivedLength</span>, <span>byte</span>[] <span>sendBuff</span>, <span>ref</span> <span>UInt32</span> <span>sendLength</span>)</td>
      </tr>
      <tr>
        <td id="L9086" data-line-number="9086"></td>
        <td id="LC9086">        {</td>
      </tr>
      <tr>
        <td id="L9087" data-line-number="9087"></td>
        <td id="LC9087">            <span>SNISSPIData</span>(<span>receivedBuff</span>, <span>receivedLength</span>, <span>sendBuff</span>, <span>ref</span> <span>sendLength</span>);</td>
      </tr>
      <tr>
        <td id="L9088" data-line-number="9088"></td>
        <td id="LC9088">        }</td>
      </tr>
      <tr>
        <td id="L9089" data-line-number="9089"></td>
        <td id="LC9089">
</td>
      </tr>
      <tr>
        <td id="L9090" data-line-number="9090"></td>
        <td id="LC9090">        <span>private</span> <span>void</span> <span>SNISSPIData</span>(<span>byte</span>[] <span>receivedBuff</span>, <span>UInt32</span> <span>receivedLength</span>, <span>byte</span>[] <span>sendBuff</span>, <span>ref</span> <span>UInt32</span> <span>sendLength</span>)</td>
      </tr>
      <tr>
        <td id="L9091" data-line-number="9091"></td>
        <td id="LC9091">        {</td>
      </tr>
      <tr>
        <td id="L9092" data-line-number="9092"></td>
        <td id="LC9092">            <span>if</span> (<span>receivedBuff</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L9093" data-line-number="9093"></td>
        <td id="LC9093">            {</td>
      </tr>
      <tr>
        <td id="L9094" data-line-number="9094"></td>
        <td id="LC9094">                <span><span>//</span> we do not have SSPI data coming from server, so send over 0's for pointer and length</span></td>
      </tr>
      <tr>
        <td id="L9095" data-line-number="9095"></td>
        <td id="LC9095">                <span>receivedLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9096" data-line-number="9096"></td>
        <td id="LC9096">            }</td>
      </tr>
      <tr>
        <td id="L9097" data-line-number="9097"></td>
        <td id="LC9097">            <span><span>//</span> we need to respond to the server's message with SSPI data</span></td>
      </tr>
      <tr>
        <td id="L9098" data-line-number="9098"></td>
        <td id="LC9098">            <span>if</span> (<span>0</span> <span>!=</span> <span>SNINativeMethodWrapper</span>.<span>SNISecGenClientContext</span>(<span>_physicalStateObj</span>.<span>Handle</span>, <span>receivedBuff</span>, <span>receivedLength</span>, <span>sendBuff</span>, <span>ref</span> <span>sendLength</span>, <span>_sniSpnBuffer</span>))</td>
      </tr>
      <tr>
        <td id="L9099" data-line-number="9099"></td>
        <td id="LC9099">            {</td>
      </tr>
      <tr>
        <td id="L9100" data-line-number="9100"></td>
        <td id="LC9100">                <span>SSPIError</span>(<span>SQLMessage</span>.<span>SSPIGenerateError</span>(), <span>TdsEnums</span>.<span>GEN_CLIENT_CONTEXT</span>);</td>
      </tr>
      <tr>
        <td id="L9101" data-line-number="9101"></td>
        <td id="LC9101">            }</td>
      </tr>
      <tr>
        <td id="L9102" data-line-number="9102"></td>
        <td id="LC9102">        }</td>
      </tr>
      <tr>
        <td id="L9103" data-line-number="9103"></td>
        <td id="LC9103">
</td>
      </tr>
      <tr>
        <td id="L9104" data-line-number="9104"></td>
        <td id="LC9104">
</td>
      </tr>
      <tr>
        <td id="L9105" data-line-number="9105"></td>
        <td id="LC9105">        <span>private</span> <span>void</span> <span>ProcessSSPI</span>(<span>int</span> <span>receivedLength</span>)</td>
      </tr>
      <tr>
        <td id="L9106" data-line-number="9106"></td>
        <td id="LC9106">        {</td>
      </tr>
      <tr>
        <td id="L9107" data-line-number="9107"></td>
        <td id="LC9107">            <span>SniContext</span> <span>outerContext</span> <span>=</span> <span>_physicalStateObj</span>.<span>SniContext</span>;</td>
      </tr>
      <tr>
        <td id="L9108" data-line-number="9108"></td>
        <td id="LC9108">            <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_ProcessSspi</span>;</td>
      </tr>
      <tr>
        <td id="L9109" data-line-number="9109"></td>
        <td id="LC9109">            <span><span>//</span> allocate received buffer based on length from SSPI message</span></td>
      </tr>
      <tr>
        <td id="L9110" data-line-number="9110"></td>
        <td id="LC9110">            <span>byte</span>[] <span>receivedBuff</span> <span>=</span> <span>new</span> <span>byte</span>[<span>receivedLength</span>];</td>
      </tr>
      <tr>
        <td id="L9111" data-line-number="9111"></td>
        <td id="LC9111">
</td>
      </tr>
      <tr>
        <td id="L9112" data-line-number="9112"></td>
        <td id="LC9112">            <span><span>//</span> read SSPI data received from server</span></td>
      </tr>
      <tr>
        <td id="L9113" data-line-number="9113"></td>
        <td id="LC9113">            <span>Debug</span>.<span>Assert</span>(<span>_physicalStateObj</span>.<span>_syncOverAsync</span>, <span><span>"</span>Should not attempt pends in a synchronous call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9114" data-line-number="9114"></td>
        <td id="LC9114">            <span>bool</span> <span>result</span> <span>=</span> <span>_physicalStateObj</span>.<span>TryReadByteArray</span>(<span>receivedBuff</span>, <span>0</span>, <span>receivedLength</span>);</td>
      </tr>
      <tr>
        <td id="L9115" data-line-number="9115"></td>
        <td id="LC9115">            <span>if</span> (<span>!</span><span>result</span>)</td>
      </tr>
      <tr>
        <td id="L9116" data-line-number="9116"></td>
        <td id="LC9116">            { <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>(); }</td>
      </tr>
      <tr>
        <td id="L9117" data-line-number="9117"></td>
        <td id="LC9117">
</td>
      </tr>
      <tr>
        <td id="L9118" data-line-number="9118"></td>
        <td id="LC9118">            <span><span>//</span> allocate send buffer and initialize length</span></td>
      </tr>
      <tr>
        <td id="L9119" data-line-number="9119"></td>
        <td id="LC9119">            <span>byte</span>[] <span>sendBuff</span> <span>=</span> <span>new</span> <span>byte</span>[<span>s_maxSSPILength</span>];</td>
      </tr>
      <tr>
        <td id="L9120" data-line-number="9120"></td>
        <td id="LC9120">            <span>UInt32</span> <span>sendLength</span> <span>=</span> <span>s_maxSSPILength</span>;</td>
      </tr>
      <tr>
        <td id="L9121" data-line-number="9121"></td>
        <td id="LC9121">
</td>
      </tr>
      <tr>
        <td id="L9122" data-line-number="9122"></td>
        <td id="LC9122">            <span><span>//</span> make call for SSPI data</span></td>
      </tr>
      <tr>
        <td id="L9123" data-line-number="9123"></td>
        <td id="LC9123">            <span>SSPIData</span>(<span>receivedBuff</span>, (<span>UInt32</span>)<span>receivedLength</span>, <span>sendBuff</span>, <span>ref</span> <span>sendLength</span>);</td>
      </tr>
      <tr>
        <td id="L9124" data-line-number="9124"></td>
        <td id="LC9124">
</td>
      </tr>
      <tr>
        <td id="L9125" data-line-number="9125"></td>
        <td id="LC9125">            <span><span>//</span> DO NOT SEND LENGTH - TDS DOC INCORRECT!  JUST SEND SSPI DATA!</span></td>
      </tr>
      <tr>
        <td id="L9126" data-line-number="9126"></td>
        <td id="LC9126">            <span>_physicalStateObj</span>.<span>WriteByteArray</span>(<span>sendBuff</span>, (<span>int</span>)<span>sendLength</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L9127" data-line-number="9127"></td>
        <td id="LC9127">
</td>
      </tr>
      <tr>
        <td id="L9128" data-line-number="9128"></td>
        <td id="LC9128">            <span><span>//</span> set message type so server knows its a SSPI response</span></td>
      </tr>
      <tr>
        <td id="L9129" data-line-number="9129"></td>
        <td id="LC9129">            <span>_physicalStateObj</span>.<span>_outputMessageType</span> <span>=</span> <span>TdsEnums</span>.<span>MT_SSPI</span>;</td>
      </tr>
      <tr>
        <td id="L9130" data-line-number="9130"></td>
        <td id="LC9130">
</td>
      </tr>
      <tr>
        <td id="L9131" data-line-number="9131"></td>
        <td id="LC9131">            <span><span>//</span> send to server</span></td>
      </tr>
      <tr>
        <td id="L9132" data-line-number="9132"></td>
        <td id="LC9132">            <span>_physicalStateObj</span>.<span>WritePacket</span>(<span>TdsEnums</span>.<span>HARDFLUSH</span>);</td>
      </tr>
      <tr>
        <td id="L9133" data-line-number="9133"></td>
        <td id="LC9133">            <span>_physicalStateObj</span>.<span>SniContext</span> <span>=</span> <span>outerContext</span>;</td>
      </tr>
      <tr>
        <td id="L9134" data-line-number="9134"></td>
        <td id="LC9134">        }</td>
      </tr>
      <tr>
        <td id="L9135" data-line-number="9135"></td>
        <td id="LC9135">
</td>
      </tr>
      <tr>
        <td id="L9136" data-line-number="9136"></td>
        <td id="LC9136">        <span>private</span> <span>void</span> <span>SSPIError</span>(<span>string</span> <span>error</span>, <span>string</span> <span>procedure</span>)</td>
      </tr>
      <tr>
        <td id="L9137" data-line-number="9137"></td>
        <td id="LC9137">        {</td>
      </tr>
      <tr>
        <td id="L9138" data-line-number="9138"></td>
        <td id="LC9138">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>procedure</span>), <span><span>"</span>TdsParser.SSPIError called with an empty or null procedure string<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9139" data-line-number="9139"></td>
        <td id="LC9139">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>error</span>), <span><span>"</span>TdsParser.SSPIError called with an empty or null error string<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9140" data-line-number="9140"></td>
        <td id="LC9140">
</td>
      </tr>
      <tr>
        <td id="L9141" data-line-number="9141"></td>
        <td id="LC9141">            <span>_physicalStateObj</span>.<span>AddError</span>(<span>new</span> <span>SqlError</span>(<span>0</span>, (<span>byte</span>)<span>0x00</span>, (<span>byte</span>)<span>TdsEnums</span>.<span>MIN_ERROR_CLASS</span>, <span>_server</span>, <span>error</span>, <span>procedure</span>, <span>0</span>));</td>
      </tr>
      <tr>
        <td id="L9142" data-line-number="9142"></td>
        <td id="LC9142">            <span>ThrowExceptionAndWarning</span>(<span>_physicalStateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9143" data-line-number="9143"></td>
        <td id="LC9143">        }</td>
      </tr>
      <tr>
        <td id="L9144" data-line-number="9144"></td>
        <td id="LC9144">
</td>
      </tr>
      <tr>
        <td id="L9145" data-line-number="9145"></td>
        <td id="LC9145">        <span>private</span> <span>void</span> <span>LoadSSPILibrary</span>()</td>
      </tr>
      <tr>
        <td id="L9146" data-line-number="9146"></td>
        <td id="LC9146">        {</td>
      </tr>
      <tr>
        <td id="L9147" data-line-number="9147"></td>
        <td id="LC9147">            <span><span>//</span> Outer check so we don't acquire lock once once it's loaded.</span></td>
      </tr>
      <tr>
        <td id="L9148" data-line-number="9148"></td>
        <td id="LC9148">            <span>if</span> (<span>!</span><span>s_fSSPILoaded</span>)</td>
      </tr>
      <tr>
        <td id="L9149" data-line-number="9149"></td>
        <td id="LC9149">            {</td>
      </tr>
      <tr>
        <td id="L9150" data-line-number="9150"></td>
        <td id="LC9150">                <span>lock</span> (<span>s_tdsParserLock</span>)</td>
      </tr>
      <tr>
        <td id="L9151" data-line-number="9151"></td>
        <td id="LC9151">                {</td>
      </tr>
      <tr>
        <td id="L9152" data-line-number="9152"></td>
        <td id="LC9152">                    <span><span>//</span> re-check inside lock</span></td>
      </tr>
      <tr>
        <td id="L9153" data-line-number="9153"></td>
        <td id="LC9153">                    <span>if</span> (<span>!</span><span>s_fSSPILoaded</span>)</td>
      </tr>
      <tr>
        <td id="L9154" data-line-number="9154"></td>
        <td id="LC9154">                    {</td>
      </tr>
      <tr>
        <td id="L9155" data-line-number="9155"></td>
        <td id="LC9155">                        <span><span>//</span> use local for ref param to defer setting s_maxSSPILength until we know the call succeeded.</span></td>
      </tr>
      <tr>
        <td id="L9156" data-line-number="9156"></td>
        <td id="LC9156">                        <span>UInt32</span> <span>maxLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9157" data-line-number="9157"></td>
        <td id="LC9157">                        <span>if</span> (<span>0</span> <span>!=</span> <span>SNINativeMethodWrapper</span>.<span>SNISecInitPackage</span>(<span>ref</span> <span>maxLength</span>))</td>
      </tr>
      <tr>
        <td id="L9158" data-line-number="9158"></td>
        <td id="LC9158">                            <span>SSPIError</span>(<span>SQLMessage</span>.<span>SSPIInitializeError</span>(), <span>TdsEnums</span>.<span>INIT_SSPI_PACKAGE</span>);</td>
      </tr>
      <tr>
        <td id="L9159" data-line-number="9159"></td>
        <td id="LC9159">
</td>
      </tr>
      <tr>
        <td id="L9160" data-line-number="9160"></td>
        <td id="LC9160">                        <span>s_maxSSPILength</span> <span>=</span> <span>maxLength</span>;</td>
      </tr>
      <tr>
        <td id="L9161" data-line-number="9161"></td>
        <td id="LC9161">                        <span>s_fSSPILoaded</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9162" data-line-number="9162"></td>
        <td id="LC9162">
</td>
      </tr>
      <tr>
        <td id="L9163" data-line-number="9163"></td>
        <td id="LC9163">                    }</td>
      </tr>
      <tr>
        <td id="L9164" data-line-number="9164"></td>
        <td id="LC9164">                }</td>
      </tr>
      <tr>
        <td id="L9165" data-line-number="9165"></td>
        <td id="LC9165">            }</td>
      </tr>
      <tr>
        <td id="L9166" data-line-number="9166"></td>
        <td id="LC9166">
</td>
      </tr>
      <tr>
        <td id="L9167" data-line-number="9167"></td>
        <td id="LC9167">            <span>if</span> (<span>s_maxSSPILength</span> <span>&gt;</span> <span>Int32</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L9168" data-line-number="9168"></td>
        <td id="LC9168">            {</td>
      </tr>
      <tr>
        <td id="L9169" data-line-number="9169"></td>
        <td id="LC9169">                <span>throw</span> <span>SQL</span>.<span>InvalidSSPIPacketSize</span>();   <span><span>//</span> SqlBu 332503</span></td>
      </tr>
      <tr>
        <td id="L9170" data-line-number="9170"></td>
        <td id="LC9170">            }</td>
      </tr>
      <tr>
        <td id="L9171" data-line-number="9171"></td>
        <td id="LC9171">        }</td>
      </tr>
      <tr>
        <td id="L9172" data-line-number="9172"></td>
        <td id="LC9172">
</td>
      </tr>
      <tr>
        <td id="L9173" data-line-number="9173"></td>
        <td id="LC9173">        <span>internal</span> <span>byte</span>[] <span>GetDTCAddress</span>(<span>int</span> <span>timeout</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L9174" data-line-number="9174"></td>
        <td id="LC9174">        {</td>
      </tr>
      <tr>
        <td id="L9175" data-line-number="9175"></td>
        <td id="LC9175">            <span><span>//</span> If this fails, the server will return a server error - Sameet Agarwal confirmed.</span></td>
      </tr>
      <tr>
        <td id="L9176" data-line-number="9176"></td>
        <td id="LC9176">            <span><span>//</span> Success: DTCAddress returned.  Failure: SqlError returned.</span></td>
      </tr>
      <tr>
        <td id="L9177" data-line-number="9177"></td>
        <td id="LC9177">
</td>
      </tr>
      <tr>
        <td id="L9178" data-line-number="9178"></td>
        <td id="LC9178">            <span>byte</span>[] <span>dtcAddr</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9179" data-line-number="9179"></td>
        <td id="LC9179">
</td>
      </tr>
      <tr>
        <td id="L9180" data-line-number="9180"></td>
        <td id="LC9180">            <span>using</span> (<span>SqlDataReader</span> <span>dtcReader</span> <span>=</span> <span>TdsExecuteTransactionManagerRequest</span>(</td>
      </tr>
      <tr>
        <td id="L9181" data-line-number="9181"></td>
        <td id="LC9181">                                                        <span>null</span>,</td>
      </tr>
      <tr>
        <td id="L9182" data-line-number="9182"></td>
        <td id="LC9182">                                                        <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>GetDTCAddress</span>,</td>
      </tr>
      <tr>
        <td id="L9183" data-line-number="9183"></td>
        <td id="LC9183">                                                        <span>null</span>,</td>
      </tr>
      <tr>
        <td id="L9184" data-line-number="9184"></td>
        <td id="LC9184">                                                        <span>TdsEnums</span>.<span>TransactionManagerIsolationLevel</span>.<span>Unspecified</span>,</td>
      </tr>
      <tr>
        <td id="L9185" data-line-number="9185"></td>
        <td id="LC9185">                                                        <span>timeout</span>, <span>null</span>, <span>stateObj</span>, <span>true</span>))</td>
      </tr>
      <tr>
        <td id="L9186" data-line-number="9186"></td>
        <td id="LC9186">            {</td>
      </tr>
      <tr>
        <td id="L9187" data-line-number="9187"></td>
        <td id="LC9187">
</td>
      </tr>
      <tr>
        <td id="L9188" data-line-number="9188"></td>
        <td id="LC9188">                <span>Debug</span>.<span>Assert</span>(<span>SniContext</span>.<span>Snix_Read</span> <span>==</span> <span>stateObj</span>.<span>SniContext</span>, <span><span>$"</span>The SniContext should be Snix_Read but it actually is {<span>stateObj</span>.<span>SniContext</span>}<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9189" data-line-number="9189"></td>
        <td id="LC9189">                <span>if</span> (<span>null</span> <span>!=</span> <span>dtcReader</span> <span>&amp;&amp;</span> <span>dtcReader</span>.<span>Read</span>())</td>
      </tr>
      <tr>
        <td id="L9190" data-line-number="9190"></td>
        <td id="LC9190">                {</td>
      </tr>
      <tr>
        <td id="L9191" data-line-number="9191"></td>
        <td id="LC9191">                    <span>Debug</span>.<span>Assert</span>(<span>dtcReader</span>.<span>GetName</span>(<span>0</span>) <span>==</span> <span><span>"</span>TM Address<span>"</span></span>, <span><span>"</span>TdsParser: GetDTCAddress did not return 'TM Address'<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9192" data-line-number="9192"></td>
        <td id="LC9192">
</td>
      </tr>
      <tr>
        <td id="L9193" data-line-number="9193"></td>
        <td id="LC9193">                    <span><span>//</span> DTCAddress is of variable size, and does not have a maximum.  So we call GetBytes</span></td>
      </tr>
      <tr>
        <td id="L9194" data-line-number="9194"></td>
        <td id="LC9194">                    <span><span>//</span> to get the length of the dtcAddress, then allocate a byte array of that length,</span></td>
      </tr>
      <tr>
        <td id="L9195" data-line-number="9195"></td>
        <td id="LC9195">                    <span><span>//</span> then call GetBytes again on that byte[] with the length</span></td>
      </tr>
      <tr>
        <td id="L9196" data-line-number="9196"></td>
        <td id="LC9196">                    <span>long</span> <span>dtcLength</span> <span>=</span> <span>dtcReader</span>.<span>GetBytes</span>(<span>0</span>, <span>0</span>, <span>null</span>, <span>0</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L9197" data-line-number="9197"></td>
        <td id="LC9197">
</td>
      </tr>
      <tr>
        <td id="L9198" data-line-number="9198"></td>
        <td id="LC9198">                    <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L9199" data-line-number="9199"></td>
        <td id="LC9199">                    <span>if</span> (<span>dtcLength</span> <span>&lt;=</span> <span>Int32</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L9200" data-line-number="9200"></td>
        <td id="LC9200">                    {</td>
      </tr>
      <tr>
        <td id="L9201" data-line-number="9201"></td>
        <td id="LC9201">                        <span>int</span> <span>cb</span> <span>=</span> (<span>int</span>)<span>dtcLength</span>;</td>
      </tr>
      <tr>
        <td id="L9202" data-line-number="9202"></td>
        <td id="LC9202">
</td>
      </tr>
      <tr>
        <td id="L9203" data-line-number="9203"></td>
        <td id="LC9203">                        <span>dtcAddr</span> <span>=</span> <span>new</span> <span>byte</span>[<span>cb</span>];</td>
      </tr>
      <tr>
        <td id="L9204" data-line-number="9204"></td>
        <td id="LC9204">                        <span>dtcReader</span>.<span>GetBytes</span>(<span>0</span>, <span>0</span>, <span>dtcAddr</span>, <span>0</span>, <span>cb</span>);</td>
      </tr>
      <tr>
        <td id="L9205" data-line-number="9205"></td>
        <td id="LC9205">                    }</td>
      </tr>
      <tr>
        <td id="L9206" data-line-number="9206"></td>
        <td id="LC9206">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L9207" data-line-number="9207"></td>
        <td id="LC9207">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L9208" data-line-number="9208"></td>
        <td id="LC9208">                    {</td>
      </tr>
      <tr>
        <td id="L9209" data-line-number="9209"></td>
        <td id="LC9209">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>unexpected length (&gt; Int32.MaxValue) returned from dtcReader.GetBytes<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9210" data-line-number="9210"></td>
        <td id="LC9210">                        <span><span>//</span> if we hit this case we'll just return a null address so that the user</span></td>
      </tr>
      <tr>
        <td id="L9211" data-line-number="9211"></td>
        <td id="LC9211">                        <span><span>//</span> will get a transcaction enlistment error in the upper layers</span></td>
      </tr>
      <tr>
        <td id="L9212" data-line-number="9212"></td>
        <td id="LC9212">                    }</td>
      </tr>
      <tr>
        <td id="L9213" data-line-number="9213"></td>
        <td id="LC9213">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L9214" data-line-number="9214"></td>
        <td id="LC9214">                }</td>
      </tr>
      <tr>
        <td id="L9215" data-line-number="9215"></td>
        <td id="LC9215">            }</td>
      </tr>
      <tr>
        <td id="L9216" data-line-number="9216"></td>
        <td id="LC9216">            <span>return</span> <span>dtcAddr</span>;</td>
      </tr>
      <tr>
        <td id="L9217" data-line-number="9217"></td>
        <td id="LC9217">        }</td>
      </tr>
      <tr>
        <td id="L9218" data-line-number="9218"></td>
        <td id="LC9218">
</td>
      </tr>
      <tr>
        <td id="L9219" data-line-number="9219"></td>
        <td id="LC9219">        <span><span>//</span> Propagate the dtc cookie to the server, enlisting the connection.</span></td>
      </tr>
      <tr>
        <td id="L9220" data-line-number="9220"></td>
        <td id="LC9220">        <span>internal</span> <span>void</span> <span>PropagateDistributedTransaction</span>(<span>byte</span>[] <span>buffer</span>, <span>int</span> <span>timeout</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L9221" data-line-number="9221"></td>
        <td id="LC9221">        {</td>
      </tr>
      <tr>
        <td id="L9222" data-line-number="9222"></td>
        <td id="LC9222">            <span><span>//</span> if this fails, the server will return a server error - Sameet Agarwal confirmed</span></td>
      </tr>
      <tr>
        <td id="L9223" data-line-number="9223"></td>
        <td id="LC9223">            <span><span>//</span> Success: server will return done token.  Failure: SqlError returned.</span></td>
      </tr>
      <tr>
        <td id="L9224" data-line-number="9224"></td>
        <td id="LC9224">
</td>
      </tr>
      <tr>
        <td id="L9225" data-line-number="9225"></td>
        <td id="LC9225">            <span>TdsExecuteTransactionManagerRequest</span>(<span>buffer</span>,</td>
      </tr>
      <tr>
        <td id="L9226" data-line-number="9226"></td>
        <td id="LC9226">                <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Propagate</span>, <span>null</span>,</td>
      </tr>
      <tr>
        <td id="L9227" data-line-number="9227"></td>
        <td id="LC9227">                <span>TdsEnums</span>.<span>TransactionManagerIsolationLevel</span>.<span>Unspecified</span>, <span>timeout</span>, <span>null</span>, <span>stateObj</span>, <span>true</span>);</td>
      </tr>
      <tr>
        <td id="L9228" data-line-number="9228"></td>
        <td id="LC9228">        }</td>
      </tr>
      <tr>
        <td id="L9229" data-line-number="9229"></td>
        <td id="LC9229">
</td>
      </tr>
      <tr>
        <td id="L9230" data-line-number="9230"></td>
        <td id="LC9230">        <span>internal</span> <span>SqlDataReader</span> <span>TdsExecuteTransactionManagerRequest</span>(</td>
      </tr>
      <tr>
        <td id="L9231" data-line-number="9231"></td>
        <td id="LC9231">                    <span>byte</span>[] <span>buffer</span>,</td>
      </tr>
      <tr>
        <td id="L9232" data-line-number="9232"></td>
        <td id="LC9232">                    <span>TdsEnums</span>.<span>TransactionManagerRequestType</span> <span>request</span>,</td>
      </tr>
      <tr>
        <td id="L9233" data-line-number="9233"></td>
        <td id="LC9233">                    <span>string</span> <span>transactionName</span>,</td>
      </tr>
      <tr>
        <td id="L9234" data-line-number="9234"></td>
        <td id="LC9234">                    <span>TdsEnums</span>.<span>TransactionManagerIsolationLevel</span> <span>isoLevel</span>,</td>
      </tr>
      <tr>
        <td id="L9235" data-line-number="9235"></td>
        <td id="LC9235">                    <span>int</span> <span>timeout</span>,</td>
      </tr>
      <tr>
        <td id="L9236" data-line-number="9236"></td>
        <td id="LC9236">                    <span>SqlInternalTransaction</span> <span>transaction</span>,</td>
      </tr>
      <tr>
        <td id="L9237" data-line-number="9237"></td>
        <td id="LC9237">                    <span>TdsParserStateObject</span> <span>stateObj</span>,</td>
      </tr>
      <tr>
        <td id="L9238" data-line-number="9238"></td>
        <td id="LC9238">                    <span>bool</span> <span>isDelegateControlRequest</span>)</td>
      </tr>
      <tr>
        <td id="L9239" data-line-number="9239"></td>
        <td id="LC9239">        {</td>
      </tr>
      <tr>
        <td id="L9240" data-line-number="9240"></td>
        <td id="LC9240">
</td>
      </tr>
      <tr>
        <td id="L9241" data-line-number="9241"></td>
        <td id="LC9241">            <span>Debug</span>.<span>Assert</span>(<span>this</span> <span>==</span> <span>stateObj</span>.<span>Parser</span>, <span><span>"</span>different parsers<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9242" data-line-number="9242"></td>
        <td id="LC9242">
</td>
      </tr>
      <tr>
        <td id="L9243" data-line-number="9243"></td>
        <td id="LC9243">            <span>if</span> (<span>TdsParserState</span>.<span>Broken</span> <span>==</span> <span>State</span> <span>||</span> <span>TdsParserState</span>.<span>Closed</span> <span>==</span> <span>State</span>)</td>
      </tr>
      <tr>
        <td id="L9244" data-line-number="9244"></td>
        <td id="LC9244">            {</td>
      </tr>
      <tr>
        <td id="L9245" data-line-number="9245"></td>
        <td id="LC9245">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9246" data-line-number="9246"></td>
        <td id="LC9246">            }</td>
      </tr>
      <tr>
        <td id="L9247" data-line-number="9247"></td>
        <td id="LC9247">
</td>
      </tr>
      <tr>
        <td id="L9248" data-line-number="9248"></td>
        <td id="LC9248">            <span><span>//</span> SQLBUDT #20010853 - Promote, Commit and Rollback requests for</span></td>
      </tr>
      <tr>
        <td id="L9249" data-line-number="9249"></td>
        <td id="LC9249">            <span><span>//</span> delegated transactions often happen while there is an open result</span></td>
      </tr>
      <tr>
        <td id="L9250" data-line-number="9250"></td>
        <td id="LC9250">            <span><span>//</span> set, so we need to handle them by using a different MARS session,</span></td>
      </tr>
      <tr>
        <td id="L9251" data-line-number="9251"></td>
        <td id="LC9251">            <span><span>//</span> otherwise we'll write on the physical state objects while someone</span></td>
      </tr>
      <tr>
        <td id="L9252" data-line-number="9252"></td>
        <td id="LC9252">            <span><span>//</span> else is using it.  When we don't have MARS enabled, we need to</span></td>
      </tr>
      <tr>
        <td id="L9253" data-line-number="9253"></td>
        <td id="LC9253">            <span><span>//</span> lock the physical state object to syncronize it's use at least</span></td>
      </tr>
      <tr>
        <td id="L9254" data-line-number="9254"></td>
        <td id="LC9254">            <span><span>//</span> until we increment the open results count.  Once it's been</span></td>
      </tr>
      <tr>
        <td id="L9255" data-line-number="9255"></td>
        <td id="LC9255">            <span><span>//</span> incremented the delegated transaction requests will fail, so they</span></td>
      </tr>
      <tr>
        <td id="L9256" data-line-number="9256"></td>
        <td id="LC9256">            <span><span>//</span> won't stomp on anything.</span></td>
      </tr>
      <tr>
        <td id="L9257" data-line-number="9257"></td>
        <td id="LC9257">
</td>
      </tr>
      <tr>
        <td id="L9258" data-line-number="9258"></td>
        <td id="LC9258">
</td>
      </tr>
      <tr>
        <td id="L9259" data-line-number="9259"></td>
        <td id="LC9259">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>||</span> <span>_connHandler</span>.<span>_parserLock</span>.<span>ThreadMayHaveLock</span>(), <span><span>"</span>Thread claims to have parser lock, but lock is not taken<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9260" data-line-number="9260"></td>
        <td id="LC9260">            <span>bool</span> <span>callerHasConnectionLock</span> <span>=</span> <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span>;   <span><span>//</span> If the thread already claims to have the parser lock, then we will let the caller handle releasing it</span></td>
      </tr>
      <tr>
        <td id="L9261" data-line-number="9261"></td>
        <td id="LC9261">            <span>if</span> (<span>!</span><span>callerHasConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L9262" data-line-number="9262"></td>
        <td id="LC9262">            {</td>
      </tr>
      <tr>
        <td id="L9263" data-line-number="9263"></td>
        <td id="LC9263">                <span>_connHandler</span>.<span>_parserLock</span>.<span>Wait</span>(<span>canReleaseFromAnyThread</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L9264" data-line-number="9264"></td>
        <td id="LC9264">                <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9265" data-line-number="9265"></td>
        <td id="LC9265">            }</td>
      </tr>
      <tr>
        <td id="L9266" data-line-number="9266"></td>
        <td id="LC9266">            <span><span>//</span> Capture _asyncWrite (after taking lock) to restore it afterwards</span></td>
      </tr>
      <tr>
        <td id="L9267" data-line-number="9267"></td>
        <td id="LC9267">            <span>bool</span> <span>hadAsyncWrites</span> <span>=</span> <span>_asyncWrite</span>;</td>
      </tr>
      <tr>
        <td id="L9268" data-line-number="9268"></td>
        <td id="LC9268">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L9269" data-line-number="9269"></td>
        <td id="LC9269">            {</td>
      </tr>
      <tr>
        <td id="L9270" data-line-number="9270"></td>
        <td id="LC9270">                <span><span>//</span> Temprarily disable async writes</span></td>
      </tr>
      <tr>
        <td id="L9271" data-line-number="9271"></td>
        <td id="LC9271">                <span>_asyncWrite</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9272" data-line-number="9272"></td>
        <td id="LC9272">
</td>
      </tr>
      <tr>
        <td id="L9273" data-line-number="9273"></td>
        <td id="LC9273">                <span><span>//</span> This validation step MUST be done after locking the connection to guarantee we don't</span></td>
      </tr>
      <tr>
        <td id="L9274" data-line-number="9274"></td>
        <td id="LC9274">                <span><span>//</span>  accidentally execute after the transaction has completed on a different thread.</span></td>
      </tr>
      <tr>
        <td id="L9275" data-line-number="9275"></td>
        <td id="LC9275">                <span>if</span> (<span>!</span><span>isDelegateControlRequest</span>)</td>
      </tr>
      <tr>
        <td id="L9276" data-line-number="9276"></td>
        <td id="LC9276">                {</td>
      </tr>
      <tr>
        <td id="L9277" data-line-number="9277"></td>
        <td id="LC9277">                    <span>_connHandler</span>.<span>CheckEnlistedTransactionBinding</span>();</td>
      </tr>
      <tr>
        <td id="L9278" data-line-number="9278"></td>
        <td id="LC9278">                }</td>
      </tr>
      <tr>
        <td id="L9279" data-line-number="9279"></td>
        <td id="LC9279">
</td>
      </tr>
      <tr>
        <td id="L9280" data-line-number="9280"></td>
        <td id="LC9280">                <span>stateObj</span>.<span>_outputMessageType</span> <span>=</span> <span>TdsEnums</span>.<span>MT_TRANS</span>;       <span><span>//</span> set message type</span></td>
      </tr>
      <tr>
        <td id="L9281" data-line-number="9281"></td>
        <td id="LC9281">                <span>stateObj</span>.<span>SetTimeoutSeconds</span>(<span>timeout</span>);</td>
      </tr>
      <tr>
        <td id="L9282" data-line-number="9282"></td>
        <td id="LC9282">
</td>
      </tr>
      <tr>
        <td id="L9283" data-line-number="9283"></td>
        <td id="LC9283">                <span>stateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Execute</span>;</td>
      </tr>
      <tr>
        <td id="L9284" data-line-number="9284"></td>
        <td id="LC9284">
</td>
      </tr>
      <tr>
        <td id="L9285" data-line-number="9285"></td>
        <td id="LC9285">                <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L9286" data-line-number="9286"></td>
        <td id="LC9286">                {</td>
      </tr>
      <tr>
        <td id="L9287" data-line-number="9287"></td>
        <td id="LC9287">                    <span>const</span> <span>int</span> <span>marsHeaderSize</span> <span>=</span> <span>18</span>; <span><span>//</span> 4 + 2 + 8 + 4</span></td>
      </tr>
      <tr>
        <td id="L9288" data-line-number="9288"></td>
        <td id="LC9288">                    <span>const</span> <span>int</span> <span>totalHeaderLength</span> <span>=</span> <span>22</span>; <span><span>//</span> 4 + 4 + 2 + 8 + 4</span></td>
      </tr>
      <tr>
        <td id="L9289" data-line-number="9289"></td>
        <td id="LC9289">                    <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_outBytesUsed</span> <span>==</span> <span>stateObj</span>.<span>_outputHeaderLen</span>, <span><span>"</span>Output bytes written before total header length<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9290" data-line-number="9290"></td>
        <td id="LC9290">                    <span><span>//</span> Write total header length</span></td>
      </tr>
      <tr>
        <td id="L9291" data-line-number="9291"></td>
        <td id="LC9291">                    <span>WriteInt</span>(<span>totalHeaderLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9292" data-line-number="9292"></td>
        <td id="LC9292">                    <span><span>//</span> Write mars header length</span></td>
      </tr>
      <tr>
        <td id="L9293" data-line-number="9293"></td>
        <td id="LC9293">                    <span>WriteInt</span>(<span>marsHeaderSize</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9294" data-line-number="9294"></td>
        <td id="LC9294">                    <span>WriteMarsHeaderData</span>(<span>stateObj</span>, <span>_currentTransaction</span>);</td>
      </tr>
      <tr>
        <td id="L9295" data-line-number="9295"></td>
        <td id="LC9295">                }</td>
      </tr>
      <tr>
        <td id="L9296" data-line-number="9296"></td>
        <td id="LC9296">
</td>
      </tr>
      <tr>
        <td id="L9297" data-line-number="9297"></td>
        <td id="LC9297">                <span>WriteShort</span>((<span>short</span>)<span>request</span>, <span>stateObj</span>); <span><span>//</span> write TransactionManager Request type</span></td>
      </tr>
      <tr>
        <td id="L9298" data-line-number="9298"></td>
        <td id="LC9298">
</td>
      </tr>
      <tr>
        <td id="L9299" data-line-number="9299"></td>
        <td id="LC9299">                <span>bool</span> <span>returnReader</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9300" data-line-number="9300"></td>
        <td id="LC9300">
</td>
      </tr>
      <tr>
        <td id="L9301" data-line-number="9301"></td>
        <td id="LC9301">                <span>switch</span> (<span>request</span>)</td>
      </tr>
      <tr>
        <td id="L9302" data-line-number="9302"></td>
        <td id="LC9302">                {</td>
      </tr>
      <tr>
        <td id="L9303" data-line-number="9303"></td>
        <td id="LC9303">                    <span>case</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>GetDTCAddress</span>:</td>
      </tr>
      <tr>
        <td id="L9304" data-line-number="9304"></td>
        <td id="LC9304">                        <span>WriteShort</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9305" data-line-number="9305"></td>
        <td id="LC9305">
</td>
      </tr>
      <tr>
        <td id="L9306" data-line-number="9306"></td>
        <td id="LC9306">                        <span>returnReader</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9307" data-line-number="9307"></td>
        <td id="LC9307">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9308" data-line-number="9308"></td>
        <td id="LC9308">                    <span>case</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Propagate</span>:</td>
      </tr>
      <tr>
        <td id="L9309" data-line-number="9309"></td>
        <td id="LC9309">                        <span>if</span> (<span>null</span> <span>!=</span> <span>buffer</span>)</td>
      </tr>
      <tr>
        <td id="L9310" data-line-number="9310"></td>
        <td id="LC9310">                        {</td>
      </tr>
      <tr>
        <td id="L9311" data-line-number="9311"></td>
        <td id="LC9311">                            <span>WriteShort</span>(<span>buffer</span>.<span>Length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9312" data-line-number="9312"></td>
        <td id="LC9312">                            <span>stateObj</span>.<span>WriteByteArray</span>(<span>buffer</span>, <span>buffer</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L9313" data-line-number="9313"></td>
        <td id="LC9313">                        }</td>
      </tr>
      <tr>
        <td id="L9314" data-line-number="9314"></td>
        <td id="LC9314">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L9315" data-line-number="9315"></td>
        <td id="LC9315">                        {</td>
      </tr>
      <tr>
        <td id="L9316" data-line-number="9316"></td>
        <td id="LC9316">                            <span>WriteShort</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9317" data-line-number="9317"></td>
        <td id="LC9317">                        }</td>
      </tr>
      <tr>
        <td id="L9318" data-line-number="9318"></td>
        <td id="LC9318">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9319" data-line-number="9319"></td>
        <td id="LC9319">                    <span>case</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Begin</span>:</td>
      </tr>
      <tr>
        <td id="L9320" data-line-number="9320"></td>
        <td id="LC9320">                        <span>Debug</span>.<span>Assert</span>(<span>IsYukonOrNewer</span>, <span><span>"</span>Should not be calling TdsExecuteTransactionManagerRequest on pre-Yukon clients for BeginTransaction!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9321" data-line-number="9321"></td>
        <td id="LC9321">                        <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>!=</span> <span>transaction</span>, <span><span>"</span>Should have specified an internalTransaction when doing a BeginTransaction request!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9322" data-line-number="9322"></td>
        <td id="LC9322">
</td>
      </tr>
      <tr>
        <td id="L9323" data-line-number="9323"></td>
        <td id="LC9323">                        <span><span>//</span> Only assign the passed in transaction if it is not equal to the current transaction.</span></td>
      </tr>
      <tr>
        <td id="L9324" data-line-number="9324"></td>
        <td id="LC9324">                        <span><span>//</span> And, if it is not equal, the current actually should be null.  Anything else</span></td>
      </tr>
      <tr>
        <td id="L9325" data-line-number="9325"></td>
        <td id="LC9325">                        <span><span>//</span> is a unexpected state.  The concern here is mainly for the mixed use of</span></td>
      </tr>
      <tr>
        <td id="L9326" data-line-number="9326"></td>
        <td id="LC9326">                        <span><span>//</span> T-SQL and API transactions.  See SQL BU DT 345300 for full details and repro.</span></td>
      </tr>
      <tr>
        <td id="L9327" data-line-number="9327"></td>
        <td id="LC9327">
</td>
      </tr>
      <tr>
        <td id="L9328" data-line-number="9328"></td>
        <td id="LC9328">                        <span><span>//</span> Expected states:</span></td>
      </tr>
      <tr>
        <td id="L9329" data-line-number="9329"></td>
        <td id="LC9329">                        <span><span>//</span> 1) _pendingTransaction = null, _currentTransaction = null, non null transaction</span></td>
      </tr>
      <tr>
        <td id="L9330" data-line-number="9330"></td>
        <td id="LC9330">                        <span><span>//</span> passed in on BeginTransaction API call.</span></td>
      </tr>
      <tr>
        <td id="L9331" data-line-number="9331"></td>
        <td id="LC9331">                        <span><span>//</span> 2) _currentTransaction != null, _pendingTransaction = null, non null transaction</span></td>
      </tr>
      <tr>
        <td id="L9332" data-line-number="9332"></td>
        <td id="LC9332">                        <span><span>//</span> passed in but equivalent to _currentTransaction.</span></td>
      </tr>
      <tr>
        <td id="L9333" data-line-number="9333"></td>
        <td id="LC9333">
</td>
      </tr>
      <tr>
        <td id="L9334" data-line-number="9334"></td>
        <td id="LC9334">                        <span><span>//</span> #1 will occur on standard BeginTransactionAPI call.  #2 should only occur if</span></td>
      </tr>
      <tr>
        <td id="L9335" data-line-number="9335"></td>
        <td id="LC9335">                        <span><span>//</span> t-sql transaction started followed by a call to SqlConnection.BeginTransaction.</span></td>
      </tr>
      <tr>
        <td id="L9336" data-line-number="9336"></td>
        <td id="LC9336">                        <span><span>//</span> Any other state is unknown.</span></td>
      </tr>
      <tr>
        <td id="L9337" data-line-number="9337"></td>
        <td id="LC9337">                        <span>if</span> (<span>_currentTransaction</span> <span>!=</span> <span>transaction</span>)</td>
      </tr>
      <tr>
        <td id="L9338" data-line-number="9338"></td>
        <td id="LC9338">                        {</td>
      </tr>
      <tr>
        <td id="L9339" data-line-number="9339"></td>
        <td id="LC9339">                            <span>Debug</span>.<span>Assert</span>(<span>_currentTransaction</span> <span>==</span> <span>null</span> <span>||</span> <span>true</span> <span>==</span> <span>_fResetConnection</span>, <span><span>"</span>We should not have a current Tx at this point<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9340" data-line-number="9340"></td>
        <td id="LC9340">                            <span>PendingTransaction</span> <span>=</span> <span>transaction</span>;</td>
      </tr>
      <tr>
        <td id="L9341" data-line-number="9341"></td>
        <td id="LC9341">                        }</td>
      </tr>
      <tr>
        <td id="L9342" data-line-number="9342"></td>
        <td id="LC9342">
</td>
      </tr>
      <tr>
        <td id="L9343" data-line-number="9343"></td>
        <td id="LC9343">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>isoLevel</span>);</td>
      </tr>
      <tr>
        <td id="L9344" data-line-number="9344"></td>
        <td id="LC9344">
</td>
      </tr>
      <tr>
        <td id="L9345" data-line-number="9345"></td>
        <td id="LC9345">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>transactionName</span>.<span>Length</span> <span>*</span> <span>2</span>)); <span><span>//</span> Write number of bytes (unicode string).</span></td>
      </tr>
      <tr>
        <td id="L9346" data-line-number="9346"></td>
        <td id="LC9346">                        <span>WriteString</span>(<span>transactionName</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9347" data-line-number="9347"></td>
        <td id="LC9347">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9348" data-line-number="9348"></td>
        <td id="LC9348">                    <span>case</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Promote</span>:</td>
      </tr>
      <tr>
        <td id="L9349" data-line-number="9349"></td>
        <td id="LC9349">                        <span>Debug</span>.<span>Assert</span>(<span>IsYukonOrNewer</span>, <span><span>"</span>Should not be calling TdsExecuteTransactionManagerRequest on pre-Yukon clients for PromoteTransaction!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9350" data-line-number="9350"></td>
        <td id="LC9350">                        <span><span>//</span> No payload - except current transaction in header</span></td>
      </tr>
      <tr>
        <td id="L9351" data-line-number="9351"></td>
        <td id="LC9351">                        <span><span>//</span> Promote returns a DTC cookie.  However, the transaction cookie we use for the</span></td>
      </tr>
      <tr>
        <td id="L9352" data-line-number="9352"></td>
        <td id="LC9352">                        <span><span>//</span> connection does not change after a promote.</span></td>
      </tr>
      <tr>
        <td id="L9353" data-line-number="9353"></td>
        <td id="LC9353">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9354" data-line-number="9354"></td>
        <td id="LC9354">                    <span>case</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Commit</span>:</td>
      </tr>
      <tr>
        <td id="L9355" data-line-number="9355"></td>
        <td id="LC9355">                        <span>Debug</span>.<span>Assert</span>(<span>IsYukonOrNewer</span>, <span><span>"</span>Should not be calling TdsExecuteTransactionManagerRequest on pre-Yukon clients for CommitTransaction!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9356" data-line-number="9356"></td>
        <td id="LC9356">
</td>
      </tr>
      <tr>
        <td id="L9357" data-line-number="9357"></td>
        <td id="LC9357">                        <span>Debug</span>.<span>Assert</span>(<span>transactionName</span>.<span>Length</span> <span>==</span> <span>0</span>, <span><span>"</span>Should not have a transaction name on Commit<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9358" data-line-number="9358"></td>
        <td id="LC9358">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>0</span>); <span><span>//</span> No xact name</span></td>
      </tr>
      <tr>
        <td id="L9359" data-line-number="9359"></td>
        <td id="LC9359">
</td>
      </tr>
      <tr>
        <td id="L9360" data-line-number="9360"></td>
        <td id="LC9360">                        <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);  <span><span>//</span> No flags</span></td>
      </tr>
      <tr>
        <td id="L9361" data-line-number="9361"></td>
        <td id="LC9361">
</td>
      </tr>
      <tr>
        <td id="L9362" data-line-number="9362"></td>
        <td id="LC9362">                        <span>Debug</span>.<span>Assert</span>(<span>isoLevel</span> <span>==</span> <span>TdsEnums</span>.<span>TransactionManagerIsolationLevel</span>.<span>Unspecified</span>, <span><span>"</span>Should not have isolation level other than unspecified on Commit!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9363" data-line-number="9363"></td>
        <td id="LC9363">                        <span><span>//</span> WriteByte((byte) 0, stateObj); // IsolationLevel</span></td>
      </tr>
      <tr>
        <td id="L9364" data-line-number="9364"></td>
        <td id="LC9364">                        <span><span>//</span> WriteByte((byte) 0, stateObj); // No begin xact name</span></td>
      </tr>
      <tr>
        <td id="L9365" data-line-number="9365"></td>
        <td id="LC9365">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9366" data-line-number="9366"></td>
        <td id="LC9366">                    <span>case</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Rollback</span>:</td>
      </tr>
      <tr>
        <td id="L9367" data-line-number="9367"></td>
        <td id="LC9367">                        <span>Debug</span>.<span>Assert</span>(<span>IsYukonOrNewer</span>, <span><span>"</span>Should not be calling TdsExecuteTransactionManagerRequest on pre-Yukon clients for RollbackTransaction!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9368" data-line-number="9368"></td>
        <td id="LC9368">
</td>
      </tr>
      <tr>
        <td id="L9369" data-line-number="9369"></td>
        <td id="LC9369">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>transactionName</span>.<span>Length</span> <span>*</span> <span>2</span>)); <span><span>//</span> Write number of bytes (unicode string).</span></td>
      </tr>
      <tr>
        <td id="L9370" data-line-number="9370"></td>
        <td id="LC9370">                        <span>WriteString</span>(<span>transactionName</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9371" data-line-number="9371"></td>
        <td id="LC9371">
</td>
      </tr>
      <tr>
        <td id="L9372" data-line-number="9372"></td>
        <td id="LC9372">                        <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);  <span><span>//</span> No flags</span></td>
      </tr>
      <tr>
        <td id="L9373" data-line-number="9373"></td>
        <td id="LC9373">
</td>
      </tr>
      <tr>
        <td id="L9374" data-line-number="9374"></td>
        <td id="LC9374">                        <span>Debug</span>.<span>Assert</span>(<span>isoLevel</span> <span>==</span> <span>TdsEnums</span>.<span>TransactionManagerIsolationLevel</span>.<span>Unspecified</span>, <span><span>"</span>Should not have isolation level other than unspecified on Commit!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9375" data-line-number="9375"></td>
        <td id="LC9375">                        <span><span>//</span> WriteByte((byte) 0, stateObj); // IsolationLevel</span></td>
      </tr>
      <tr>
        <td id="L9376" data-line-number="9376"></td>
        <td id="LC9376">                        <span><span>//</span> WriteByte((byte) 0, stateObj); // No begin xact name</span></td>
      </tr>
      <tr>
        <td id="L9377" data-line-number="9377"></td>
        <td id="LC9377">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9378" data-line-number="9378"></td>
        <td id="LC9378">                    <span>case</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Save</span>:</td>
      </tr>
      <tr>
        <td id="L9379" data-line-number="9379"></td>
        <td id="LC9379">                        <span>Debug</span>.<span>Assert</span>(<span>IsYukonOrNewer</span>, <span><span>"</span>Should not be calling TdsExecuteTransactionManagerRequest on pre-Yukon clients for SaveTransaction!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9380" data-line-number="9380"></td>
        <td id="LC9380">
</td>
      </tr>
      <tr>
        <td id="L9381" data-line-number="9381"></td>
        <td id="LC9381">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>transactionName</span>.<span>Length</span> <span>*</span> <span>2</span>)); <span><span>//</span> Write number of bytes (unicode string).</span></td>
      </tr>
      <tr>
        <td id="L9382" data-line-number="9382"></td>
        <td id="LC9382">                        <span>WriteString</span>(<span>transactionName</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9383" data-line-number="9383"></td>
        <td id="LC9383">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9384" data-line-number="9384"></td>
        <td id="LC9384">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L9385" data-line-number="9385"></td>
        <td id="LC9385">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unexpected TransactionManagerRequest<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9386" data-line-number="9386"></td>
        <td id="LC9386">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L9387" data-line-number="9387"></td>
        <td id="LC9387">                }</td>
      </tr>
      <tr>
        <td id="L9388" data-line-number="9388"></td>
        <td id="LC9388">
</td>
      </tr>
      <tr>
        <td id="L9389" data-line-number="9389"></td>
        <td id="LC9389">                <span>Task</span> <span>writeTask</span> <span>=</span> <span>stateObj</span>.<span>WritePacket</span>(<span>TdsEnums</span>.<span>HARDFLUSH</span>);</td>
      </tr>
      <tr>
        <td id="L9390" data-line-number="9390"></td>
        <td id="LC9390">                <span>Debug</span>.<span>Assert</span>(<span>writeTask</span> <span>==</span> <span>null</span>, <span><span>"</span>Writes should not pend when writing sync<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9391" data-line-number="9391"></td>
        <td id="LC9391">                <span>stateObj</span>.<span>_pendingData</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9392" data-line-number="9392"></td>
        <td id="LC9392">                <span>stateObj</span>.<span>_messageStatus</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9393" data-line-number="9393"></td>
        <td id="LC9393">
</td>
      </tr>
      <tr>
        <td id="L9394" data-line-number="9394"></td>
        <td id="LC9394">                <span>SqlDataReader</span> <span>dtcReader</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9395" data-line-number="9395"></td>
        <td id="LC9395">                <span>stateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Read</span>;</td>
      </tr>
      <tr>
        <td id="L9396" data-line-number="9396"></td>
        <td id="LC9396">                <span>if</span> (<span>returnReader</span>)</td>
      </tr>
      <tr>
        <td id="L9397" data-line-number="9397"></td>
        <td id="LC9397">                {</td>
      </tr>
      <tr>
        <td id="L9398" data-line-number="9398"></td>
        <td id="LC9398">                    <span>dtcReader</span> <span>=</span> <span>new</span> <span>SqlDataReader</span>(<span>null</span>, <span>CommandBehavior</span>.<span>Default</span>);</td>
      </tr>
      <tr>
        <td id="L9399" data-line-number="9399"></td>
        <td id="LC9399">                    <span>Debug</span>.<span>Assert</span>(<span>this</span> <span>==</span> <span>stateObj</span>.<span>Parser</span>, <span><span>"</span>different parser<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9400" data-line-number="9400"></td>
        <td id="LC9400">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L9401" data-line-number="9401"></td>
        <td id="LC9401">                    <span><span>//</span> Remove the current owner of stateObj - otherwise we will hit asserts</span></td>
      </tr>
      <tr>
        <td id="L9402" data-line-number="9402"></td>
        <td id="LC9402">                    <span>stateObj</span>.<span>Owner</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9403" data-line-number="9403"></td>
        <td id="LC9403">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L9404" data-line-number="9404"></td>
        <td id="LC9404">                    <span>dtcReader</span>.<span>Bind</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9405" data-line-number="9405"></td>
        <td id="LC9405">
</td>
      </tr>
      <tr>
        <td id="L9406" data-line-number="9406"></td>
        <td id="LC9406">                    <span><span>//</span> force consumption of metadata</span></td>
      </tr>
      <tr>
        <td id="L9407" data-line-number="9407"></td>
        <td id="LC9407">                    <span>_SqlMetaDataSet</span> <span>metaData</span> <span>=</span> <span>dtcReader</span>.<span>MetaData</span>;</td>
      </tr>
      <tr>
        <td id="L9408" data-line-number="9408"></td>
        <td id="LC9408">                }</td>
      </tr>
      <tr>
        <td id="L9409" data-line-number="9409"></td>
        <td id="LC9409">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L9410" data-line-number="9410"></td>
        <td id="LC9410">                {</td>
      </tr>
      <tr>
        <td id="L9411" data-line-number="9411"></td>
        <td id="LC9411">                    <span>Run</span>(<span>RunBehavior</span>.<span>UntilDone</span>, <span>null</span>, <span>null</span>, <span>null</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9412" data-line-number="9412"></td>
        <td id="LC9412">                }</td>
      </tr>
      <tr>
        <td id="L9413" data-line-number="9413"></td>
        <td id="LC9413">
</td>
      </tr>
      <tr>
        <td id="L9414" data-line-number="9414"></td>
        <td id="LC9414">                <span><span>//</span> If the retained ID is no longer valid (because we are enlisting in null or a new transaction) then it should be cleared</span></td>
      </tr>
      <tr>
        <td id="L9415" data-line-number="9415"></td>
        <td id="LC9415">                <span>if</span> (((<span>request</span> <span>==</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Begin</span>) <span>||</span> (<span>request</span> <span>==</span> <span>TdsEnums</span>.<span>TransactionManagerRequestType</span>.<span>Propagate</span>)) <span>&amp;&amp;</span> ((<span>transaction</span> <span>==</span> <span>null</span>) <span>||</span> (<span>transaction</span>.<span>TransactionId</span> <span>!=</span> <span>_retainedTransactionId</span>)))</td>
      </tr>
      <tr>
        <td id="L9416" data-line-number="9416"></td>
        <td id="LC9416">                {</td>
      </tr>
      <tr>
        <td id="L9417" data-line-number="9417"></td>
        <td id="LC9417">                    <span>_retainedTransactionId</span> <span>=</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span>;</td>
      </tr>
      <tr>
        <td id="L9418" data-line-number="9418"></td>
        <td id="LC9418">                }</td>
      </tr>
      <tr>
        <td id="L9419" data-line-number="9419"></td>
        <td id="LC9419">
</td>
      </tr>
      <tr>
        <td id="L9420" data-line-number="9420"></td>
        <td id="LC9420">                <span>return</span> <span>dtcReader</span>;</td>
      </tr>
      <tr>
        <td id="L9421" data-line-number="9421"></td>
        <td id="LC9421">            }</td>
      </tr>
      <tr>
        <td id="L9422" data-line-number="9422"></td>
        <td id="LC9422">            <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L9423" data-line-number="9423"></td>
        <td id="LC9423">            {</td>
      </tr>
      <tr>
        <td id="L9424" data-line-number="9424"></td>
        <td id="LC9424">                <span><span>//</span> UNDONE - should not be catching all exceptions!!!</span></td>
      </tr>
      <tr>
        <td id="L9425" data-line-number="9425"></td>
        <td id="LC9425">                <span>if</span> (<span>!</span><span>ADP</span>.<span>IsCatchableExceptionType</span>(<span>e</span>))</td>
      </tr>
      <tr>
        <td id="L9426" data-line-number="9426"></td>
        <td id="LC9426">                {</td>
      </tr>
      <tr>
        <td id="L9427" data-line-number="9427"></td>
        <td id="LC9427">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L9428" data-line-number="9428"></td>
        <td id="LC9428">                }</td>
      </tr>
      <tr>
        <td id="L9429" data-line-number="9429"></td>
        <td id="LC9429">
</td>
      </tr>
      <tr>
        <td id="L9430" data-line-number="9430"></td>
        <td id="LC9430">                <span>FailureCleanup</span>(<span>stateObj</span>, <span>e</span>);</td>
      </tr>
      <tr>
        <td id="L9431" data-line-number="9431"></td>
        <td id="LC9431">
</td>
      </tr>
      <tr>
        <td id="L9432" data-line-number="9432"></td>
        <td id="LC9432">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L9433" data-line-number="9433"></td>
        <td id="LC9433">            }</td>
      </tr>
      <tr>
        <td id="L9434" data-line-number="9434"></td>
        <td id="LC9434">            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L9435" data-line-number="9435"></td>
        <td id="LC9435">            {</td>
      </tr>
      <tr>
        <td id="L9436" data-line-number="9436"></td>
        <td id="LC9436">                <span><span>//</span> SQLHotfix 50000518</span></td>
      </tr>
      <tr>
        <td id="L9437" data-line-number="9437"></td>
        <td id="LC9437">                <span><span>//</span> make sure we don't leave temporary fields set when leaving this function</span></td>
      </tr>
      <tr>
        <td id="L9438" data-line-number="9438"></td>
        <td id="LC9438">                <span>_pendingTransaction</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9439" data-line-number="9439"></td>
        <td id="LC9439">
</td>
      </tr>
      <tr>
        <td id="L9440" data-line-number="9440"></td>
        <td id="LC9440">                <span>_asyncWrite</span> <span>=</span> <span>hadAsyncWrites</span>;</td>
      </tr>
      <tr>
        <td id="L9441" data-line-number="9441"></td>
        <td id="LC9441">
</td>
      </tr>
      <tr>
        <td id="L9442" data-line-number="9442"></td>
        <td id="LC9442">                <span>if</span> (<span>!</span><span>callerHasConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L9443" data-line-number="9443"></td>
        <td id="LC9443">                {</td>
      </tr>
      <tr>
        <td id="L9444" data-line-number="9444"></td>
        <td id="LC9444">                    <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9445" data-line-number="9445"></td>
        <td id="LC9445">                    <span>_connHandler</span>.<span>_parserLock</span>.<span>Release</span>();</td>
      </tr>
      <tr>
        <td id="L9446" data-line-number="9446"></td>
        <td id="LC9446">                }</td>
      </tr>
      <tr>
        <td id="L9447" data-line-number="9447"></td>
        <td id="LC9447">            }</td>
      </tr>
      <tr>
        <td id="L9448" data-line-number="9448"></td>
        <td id="LC9448">        }</td>
      </tr>
      <tr>
        <td id="L9449" data-line-number="9449"></td>
        <td id="LC9449">
</td>
      </tr>
      <tr>
        <td id="L9450" data-line-number="9450"></td>
        <td id="LC9450">        <span>internal</span> <span>void</span> <span>FailureCleanup</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L9451" data-line-number="9451"></td>
        <td id="LC9451">        {</td>
      </tr>
      <tr>
        <td id="L9452" data-line-number="9452"></td>
        <td id="LC9452">            <span>int</span> <span>old_outputPacketNumber</span> <span>=</span> <span>stateObj</span>.<span>_outputPacketNumber</span>;</td>
      </tr>
      <tr>
        <td id="L9453" data-line-number="9453"></td>
        <td id="LC9453">
</td>
      </tr>
      <tr>
        <td id="L9454" data-line-number="9454"></td>
        <td id="LC9454">            <span>if</span> (<span>Bid</span>.<span>TraceOn</span>)</td>
      </tr>
      <tr>
        <td id="L9455" data-line-number="9455"></td>
        <td id="LC9455">            {</td>
      </tr>
      <tr>
        <td id="L9456" data-line-number="9456"></td>
        <td id="LC9456">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.FailureCleanup|ERR&gt; Exception caught on ExecuteXXX: '%ls' <span>\n</span><span>"</span></span>, <span>e</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L9457" data-line-number="9457"></td>
        <td id="LC9457">            }</td>
      </tr>
      <tr>
        <td id="L9458" data-line-number="9458"></td>
        <td id="LC9458">
</td>
      </tr>
      <tr>
        <td id="L9459" data-line-number="9459"></td>
        <td id="LC9459">            <span>if</span> (<span>stateObj</span>.<span>HasOpenResult</span>)</td>
      </tr>
      <tr>
        <td id="L9460" data-line-number="9460"></td>
        <td id="LC9460">            { <span><span>//</span> SQL BU DT 383773 - need to decrement openResultCount if operation failed.</span></td>
      </tr>
      <tr>
        <td id="L9461" data-line-number="9461"></td>
        <td id="LC9461">                <span>stateObj</span>.<span>DecrementOpenResultCount</span>();</td>
      </tr>
      <tr>
        <td id="L9462" data-line-number="9462"></td>
        <td id="LC9462">            }</td>
      </tr>
      <tr>
        <td id="L9463" data-line-number="9463"></td>
        <td id="LC9463">
</td>
      </tr>
      <tr>
        <td id="L9464" data-line-number="9464"></td>
        <td id="LC9464">            <span><span>//</span> be sure to wipe out our buffer if we started sending stuff</span></td>
      </tr>
      <tr>
        <td id="L9465" data-line-number="9465"></td>
        <td id="LC9465">            <span>stateObj</span>.<span>ResetBuffer</span>();</td>
      </tr>
      <tr>
        <td id="L9466" data-line-number="9466"></td>
        <td id="LC9466">            <span>stateObj</span>.<span>ResetPacketCounters</span>();</td>
      </tr>
      <tr>
        <td id="L9467" data-line-number="9467"></td>
        <td id="LC9467">
</td>
      </tr>
      <tr>
        <td id="L9468" data-line-number="9468"></td>
        <td id="LC9468">            <span>if</span> (<span>old_outputPacketNumber</span> <span>!=</span> <span>1</span> <span>&amp;&amp;</span> <span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>OpenLoggedIn</span>)</td>
      </tr>
      <tr>
        <td id="L9469" data-line-number="9469"></td>
        <td id="LC9469">            {</td>
      </tr>
      <tr>
        <td id="L9470" data-line-number="9470"></td>
        <td id="LC9470">                <span>Debug</span>.<span>Assert</span>(<span>_connHandler</span>.<span>_parserLock</span>.<span>ThreadMayHaveLock</span>(), <span><span>"</span>Should not be calling into FailureCleanup without first taking the parser lock<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9471" data-line-number="9471"></td>
        <td id="LC9471">
</td>
      </tr>
      <tr>
        <td id="L9472" data-line-number="9472"></td>
        <td id="LC9472">                <span>bool</span> <span>originalThreadHasParserLock</span> <span>=</span> <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span>;</td>
      </tr>
      <tr>
        <td id="L9473" data-line-number="9473"></td>
        <td id="LC9473">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L9474" data-line-number="9474"></td>
        <td id="LC9474">                {</td>
      </tr>
      <tr>
        <td id="L9475" data-line-number="9475"></td>
        <td id="LC9475">                    <span><span>//</span> Dev11 Bug 385286 : ExecuteNonQueryAsync hangs when trying to write a parameter which generates ArgumentException and while handling that exception the server disconnects the connection</span></td>
      </tr>
      <tr>
        <td id="L9476" data-line-number="9476"></td>
        <td id="LC9476">                    <span><span>//</span> Need to set this to true such that if we have an error sending\processing the attention, we won't deadlock ourselves</span></td>
      </tr>
      <tr>
        <td id="L9477" data-line-number="9477"></td>
        <td id="LC9477">                    <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9478" data-line-number="9478"></td>
        <td id="LC9478">
</td>
      </tr>
      <tr>
        <td id="L9479" data-line-number="9479"></td>
        <td id="LC9479">                    <span><span>//</span> If _outputPacketNumber prior to ResetBuffer was not equal to 1, a packet was already</span></td>
      </tr>
      <tr>
        <td id="L9480" data-line-number="9480"></td>
        <td id="LC9480">                    <span><span>//</span> sent to the server and so we need to send an attention and process the attention ack.</span></td>
      </tr>
      <tr>
        <td id="L9481" data-line-number="9481"></td>
        <td id="LC9481">                    <span>stateObj</span>.<span>SendAttention</span>();</td>
      </tr>
      <tr>
        <td id="L9482" data-line-number="9482"></td>
        <td id="LC9482">                    <span>ProcessAttention</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9483" data-line-number="9483"></td>
        <td id="LC9483">                }</td>
      </tr>
      <tr>
        <td id="L9484" data-line-number="9484"></td>
        <td id="LC9484">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L9485" data-line-number="9485"></td>
        <td id="LC9485">                {</td>
      </tr>
      <tr>
        <td id="L9486" data-line-number="9486"></td>
        <td id="LC9486">                    <span><span>//</span> Reset the ThreadHasParserLock value incase our caller expects it to be set\not set</span></td>
      </tr>
      <tr>
        <td id="L9487" data-line-number="9487"></td>
        <td id="LC9487">                    <span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>=</span> <span>originalThreadHasParserLock</span>;</td>
      </tr>
      <tr>
        <td id="L9488" data-line-number="9488"></td>
        <td id="LC9488">                }</td>
      </tr>
      <tr>
        <td id="L9489" data-line-number="9489"></td>
        <td id="LC9489">            }</td>
      </tr>
      <tr>
        <td id="L9490" data-line-number="9490"></td>
        <td id="LC9490">
</td>
      </tr>
      <tr>
        <td id="L9491" data-line-number="9491"></td>
        <td id="LC9491">            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.FailureCleanup|ERR&gt; Exception rethrown. <span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9492" data-line-number="9492"></td>
        <td id="LC9492">        }</td>
      </tr>
      <tr>
        <td id="L9493" data-line-number="9493"></td>
        <td id="LC9493">
</td>
      </tr>
      <tr>
        <td id="L9494" data-line-number="9494"></td>
        <td id="LC9494">        <span>internal</span> <span>Task</span> <span>TdsExecuteSQLBatch</span>(<span>string</span> <span>text</span>, <span>int</span> <span>timeout</span>, <span>SqlNotificationRequest</span> <span>notificationRequest</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>sync</span>, <span>bool</span> <span>callerHasConnectionLock</span> <span>=</span> <span>false</span>, <span>byte</span>[] <span>enclavePackage</span> <span>=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L9495" data-line-number="9495"></td>
        <td id="LC9495">        {</td>
      </tr>
      <tr>
        <td id="L9496" data-line-number="9496"></td>
        <td id="LC9496">            <span>if</span> (<span>TdsParserState</span>.<span>Broken</span> <span>==</span> <span>State</span> <span>||</span> <span>TdsParserState</span>.<span>Closed</span> <span>==</span> <span>State</span>)</td>
      </tr>
      <tr>
        <td id="L9497" data-line-number="9497"></td>
        <td id="LC9497">            {</td>
      </tr>
      <tr>
        <td id="L9498" data-line-number="9498"></td>
        <td id="LC9498">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9499" data-line-number="9499"></td>
        <td id="LC9499">            }</td>
      </tr>
      <tr>
        <td id="L9500" data-line-number="9500"></td>
        <td id="LC9500">
</td>
      </tr>
      <tr>
        <td id="L9501" data-line-number="9501"></td>
        <td id="LC9501">            <span>if</span> (<span>stateObj</span>.<span>BcpLock</span>)</td>
      </tr>
      <tr>
        <td id="L9502" data-line-number="9502"></td>
        <td id="LC9502">            {</td>
      </tr>
      <tr>
        <td id="L9503" data-line-number="9503"></td>
        <td id="LC9503">                <span>throw</span> <span>SQL</span>.<span>ConnectionLockedForBcpEvent</span>();</td>
      </tr>
      <tr>
        <td id="L9504" data-line-number="9504"></td>
        <td id="LC9504">            }</td>
      </tr>
      <tr>
        <td id="L9505" data-line-number="9505"></td>
        <td id="LC9505">
</td>
      </tr>
      <tr>
        <td id="L9506" data-line-number="9506"></td>
        <td id="LC9506">            <span><span>//</span> SQLBUDT #20010853 - Promote, Commit and Rollback requests for</span></td>
      </tr>
      <tr>
        <td id="L9507" data-line-number="9507"></td>
        <td id="LC9507">            <span><span>//</span> delegated transactions often happen while there is an open result</span></td>
      </tr>
      <tr>
        <td id="L9508" data-line-number="9508"></td>
        <td id="LC9508">            <span><span>//</span> set, so we need to handle them by using a different MARS session,</span></td>
      </tr>
      <tr>
        <td id="L9509" data-line-number="9509"></td>
        <td id="LC9509">            <span><span>//</span> otherwise we'll write on the physical state objects while someone</span></td>
      </tr>
      <tr>
        <td id="L9510" data-line-number="9510"></td>
        <td id="LC9510">            <span><span>//</span> else is using it.  When we don't have MARS enabled, we need to</span></td>
      </tr>
      <tr>
        <td id="L9511" data-line-number="9511"></td>
        <td id="LC9511">            <span><span>//</span> lock the physical state object to syncronize it's use at least</span></td>
      </tr>
      <tr>
        <td id="L9512" data-line-number="9512"></td>
        <td id="LC9512">            <span><span>//</span> until we increment the open results count.  Once it's been</span></td>
      </tr>
      <tr>
        <td id="L9513" data-line-number="9513"></td>
        <td id="LC9513">            <span><span>//</span> incremented the delegated transaction requests will fail, so they</span></td>
      </tr>
      <tr>
        <td id="L9514" data-line-number="9514"></td>
        <td id="LC9514">            <span><span>//</span> won't stomp on anything.</span></td>
      </tr>
      <tr>
        <td id="L9515" data-line-number="9515"></td>
        <td id="LC9515">
</td>
      </tr>
      <tr>
        <td id="L9516" data-line-number="9516"></td>
        <td id="LC9516">            <span><span>//</span> Only need to take the lock if neither the thread nor the caller claims to already have it</span></td>
      </tr>
      <tr>
        <td id="L9517" data-line-number="9517"></td>
        <td id="LC9517">            <span>bool</span> <span>needToTakeParserLock</span> <span>=</span> (<span>!</span><span>callerHasConnectionLock</span>) <span>&amp;&amp;</span> (<span>!</span><span>_connHandler</span>.<span>ThreadHasParserLockForClose</span>);</td>
      </tr>
      <tr>
        <td id="L9518" data-line-number="9518"></td>
        <td id="LC9518">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>_connHandler</span>.<span>ThreadHasParserLockForClose</span> <span>||</span> <span>sync</span>, <span><span>"</span>Thread shouldn't claim to have the parser lock if we are doing async writes<span>"</span></span>);     <span><span>//</span> Since we have the possibility of pending with async writes, make sure the thread doesn't claim to already have the lock</span></td>
      </tr>
      <tr>
        <td id="L9519" data-line-number="9519"></td>
        <td id="LC9519">            <span>Debug</span>.<span>Assert</span>(<span>needToTakeParserLock</span> <span>||</span> <span>_connHandler</span>.<span>_parserLock</span>.<span>ThreadMayHaveLock</span>(), <span><span>"</span>Thread or caller claims to have connection lock, but lock is not taken<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9520" data-line-number="9520"></td>
        <td id="LC9520">
</td>
      </tr>
      <tr>
        <td id="L9521" data-line-number="9521"></td>
        <td id="LC9521">            <span>bool</span> <span>releaseConnectionLock</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9522" data-line-number="9522"></td>
        <td id="LC9522">            <span>if</span> (<span>needToTakeParserLock</span>)</td>
      </tr>
      <tr>
        <td id="L9523" data-line-number="9523"></td>
        <td id="LC9523">            {</td>
      </tr>
      <tr>
        <td id="L9524" data-line-number="9524"></td>
        <td id="LC9524">                <span>_connHandler</span>.<span>_parserLock</span>.<span>Wait</span>(<span>canReleaseFromAnyThread</span>: <span>!</span><span>sync</span>);</td>
      </tr>
      <tr>
        <td id="L9525" data-line-number="9525"></td>
        <td id="LC9525">                <span>releaseConnectionLock</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9526" data-line-number="9526"></td>
        <td id="LC9526">            }</td>
      </tr>
      <tr>
        <td id="L9527" data-line-number="9527"></td>
        <td id="LC9527">
</td>
      </tr>
      <tr>
        <td id="L9528" data-line-number="9528"></td>
        <td id="LC9528">            <span><span>//</span> Switch the writing mode</span></td>
      </tr>
      <tr>
        <td id="L9529" data-line-number="9529"></td>
        <td id="LC9529">            <span><span>//</span> NOTE: We are not turning off async writes when we complete since SqlBulkCopy uses this method and expects _asyncWrite to not change</span></td>
      </tr>
      <tr>
        <td id="L9530" data-line-number="9530"></td>
        <td id="LC9530">            <span>_asyncWrite</span> <span>=</span> <span>!</span><span>sync</span>;</td>
      </tr>
      <tr>
        <td id="L9531" data-line-number="9531"></td>
        <td id="LC9531">
</td>
      </tr>
      <tr>
        <td id="L9532" data-line-number="9532"></td>
        <td id="LC9532">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L9533" data-line-number="9533"></td>
        <td id="LC9533">            {</td>
      </tr>
      <tr>
        <td id="L9534" data-line-number="9534"></td>
        <td id="LC9534">                <span><span>//</span> Check that the connection is still alive</span></td>
      </tr>
      <tr>
        <td id="L9535" data-line-number="9535"></td>
        <td id="LC9535">                <span>if</span> ((<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Closed</span>) <span>||</span> (<span>_state</span> <span>==</span> <span>TdsParserState</span>.<span>Broken</span>))</td>
      </tr>
      <tr>
        <td id="L9536" data-line-number="9536"></td>
        <td id="LC9536">                {</td>
      </tr>
      <tr>
        <td id="L9537" data-line-number="9537"></td>
        <td id="LC9537">                    <span>throw</span> <span>ADP</span>.<span>ClosedConnectionError</span>();</td>
      </tr>
      <tr>
        <td id="L9538" data-line-number="9538"></td>
        <td id="LC9538">                }</td>
      </tr>
      <tr>
        <td id="L9539" data-line-number="9539"></td>
        <td id="LC9539">
</td>
      </tr>
      <tr>
        <td id="L9540" data-line-number="9540"></td>
        <td id="LC9540">                <span><span>//</span> This validation step MUST be done after locking the connection to guarantee we don't</span></td>
      </tr>
      <tr>
        <td id="L9541" data-line-number="9541"></td>
        <td id="LC9541">                <span><span>//</span>  accidentally execute after the transaction has completed on a different thread.</span></td>
      </tr>
      <tr>
        <td id="L9542" data-line-number="9542"></td>
        <td id="LC9542">                <span>_connHandler</span>.<span>CheckEnlistedTransactionBinding</span>();</td>
      </tr>
      <tr>
        <td id="L9543" data-line-number="9543"></td>
        <td id="LC9543">
</td>
      </tr>
      <tr>
        <td id="L9544" data-line-number="9544"></td>
        <td id="LC9544">                <span>stateObj</span>.<span>SetTimeoutSeconds</span>(<span>timeout</span>);</td>
      </tr>
      <tr>
        <td id="L9545" data-line-number="9545"></td>
        <td id="LC9545">                <span>if</span> ((<span>!</span><span>_fMARS</span>) <span>&amp;&amp;</span> (<span>_physicalStateObj</span>.<span>HasOpenResult</span>))</td>
      </tr>
      <tr>
        <td id="L9546" data-line-number="9546"></td>
        <td id="LC9546">                {</td>
      </tr>
      <tr>
        <td id="L9547" data-line-number="9547"></td>
        <td id="LC9547">                    <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TdsExecuteSQLBatch|ERR&gt; Potential multi-threaded misuse of connection, non-MARs connection with an open result %d#<span>\n</span><span>"</span></span>, <span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L9548" data-line-number="9548"></td>
        <td id="LC9548">                }</td>
      </tr>
      <tr>
        <td id="L9549" data-line-number="9549"></td>
        <td id="LC9549">                <span>stateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Execute</span>;</td>
      </tr>
      <tr>
        <td id="L9550" data-line-number="9550"></td>
        <td id="LC9550">
</td>
      </tr>
      <tr>
        <td id="L9551" data-line-number="9551"></td>
        <td id="LC9551">                <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L9552" data-line-number="9552"></td>
        <td id="LC9552">                {</td>
      </tr>
      <tr>
        <td id="L9553" data-line-number="9553"></td>
        <td id="LC9553">
</td>
      </tr>
      <tr>
        <td id="L9554" data-line-number="9554"></td>
        <td id="LC9554">                    <span>WriteRPCBatchHeaders</span>(<span>stateObj</span>, <span>notificationRequest</span>);</td>
      </tr>
      <tr>
        <td id="L9555" data-line-number="9555"></td>
        <td id="LC9555">                }</td>
      </tr>
      <tr>
        <td id="L9556" data-line-number="9556"></td>
        <td id="LC9556">
</td>
      </tr>
      <tr>
        <td id="L9557" data-line-number="9557"></td>
        <td id="LC9557">                <span>stateObj</span>.<span>_outputMessageType</span> <span>=</span> <span>TdsEnums</span>.<span>MT_SQL</span>;</td>
      </tr>
      <tr>
        <td id="L9558" data-line-number="9558"></td>
        <td id="LC9558">
</td>
      </tr>
      <tr>
        <td id="L9559" data-line-number="9559"></td>
        <td id="LC9559">                <span>WriteEnclaveInfo</span>(<span>stateObj</span>, <span>enclavePackage</span>);</td>
      </tr>
      <tr>
        <td id="L9560" data-line-number="9560"></td>
        <td id="LC9560">
</td>
      </tr>
      <tr>
        <td id="L9561" data-line-number="9561"></td>
        <td id="LC9561">                <span>WriteString</span>(<span>text</span>, <span>text</span>.<span>Length</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9562" data-line-number="9562"></td>
        <td id="LC9562">
</td>
      </tr>
      <tr>
        <td id="L9563" data-line-number="9563"></td>
        <td id="LC9563">                <span>Task</span> <span>executeTask</span> <span>=</span> <span>stateObj</span>.<span>ExecuteFlush</span>();</td>
      </tr>
      <tr>
        <td id="L9564" data-line-number="9564"></td>
        <td id="LC9564">                <span>if</span> (<span>executeTask</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L9565" data-line-number="9565"></td>
        <td id="LC9565">                {</td>
      </tr>
      <tr>
        <td id="L9566" data-line-number="9566"></td>
        <td id="LC9566">                    <span>stateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Read</span>;</td>
      </tr>
      <tr>
        <td id="L9567" data-line-number="9567"></td>
        <td id="LC9567">                }</td>
      </tr>
      <tr>
        <td id="L9568" data-line-number="9568"></td>
        <td id="LC9568">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L9569" data-line-number="9569"></td>
        <td id="LC9569">                {</td>
      </tr>
      <tr>
        <td id="L9570" data-line-number="9570"></td>
        <td id="LC9570">                    <span>Debug</span>.<span>Assert</span>(<span>!</span><span>sync</span>, <span><span>"</span>Should not have gotten a Task when writing in sync mode<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9571" data-line-number="9571"></td>
        <td id="LC9571">
</td>
      </tr>
      <tr>
        <td id="L9572" data-line-number="9572"></td>
        <td id="LC9572">                    <span><span>//</span> Need to wait for flush - continuation will unlock the connection</span></td>
      </tr>
      <tr>
        <td id="L9573" data-line-number="9573"></td>
        <td id="LC9573">                    <span>bool</span> <span>taskReleaseConnectionLock</span> <span>=</span> <span>releaseConnectionLock</span>;</td>
      </tr>
      <tr>
        <td id="L9574" data-line-number="9574"></td>
        <td id="LC9574">                    <span>releaseConnectionLock</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9575" data-line-number="9575"></td>
        <td id="LC9575">                    <span>return</span> <span>executeTask</span>.<span>ContinueWith</span>(<span>t</span> <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="L9576" data-line-number="9576"></td>
        <td id="LC9576">                    {</td>
      </tr>
      <tr>
        <td id="L9577" data-line-number="9577"></td>
        <td id="LC9577">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>t</span>.<span>IsCanceled</span>, <span><span>"</span>Task should not be canceled<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9578" data-line-number="9578"></td>
        <td id="LC9578">                        <span>try</span></td>
      </tr>
      <tr>
        <td id="L9579" data-line-number="9579"></td>
        <td id="LC9579">                        {</td>
      </tr>
      <tr>
        <td id="L9580" data-line-number="9580"></td>
        <td id="LC9580">                            <span>if</span> (<span>t</span>.<span>IsFaulted</span>)</td>
      </tr>
      <tr>
        <td id="L9581" data-line-number="9581"></td>
        <td id="LC9581">                            {</td>
      </tr>
      <tr>
        <td id="L9582" data-line-number="9582"></td>
        <td id="LC9582">                                <span>FailureCleanup</span>(<span>stateObj</span>, <span>t</span>.<span>Exception</span>.<span>InnerException</span>);</td>
      </tr>
      <tr>
        <td id="L9583" data-line-number="9583"></td>
        <td id="LC9583">                                <span>throw</span> <span>t</span>.<span>Exception</span>.<span>InnerException</span>;</td>
      </tr>
      <tr>
        <td id="L9584" data-line-number="9584"></td>
        <td id="LC9584">                            }</td>
      </tr>
      <tr>
        <td id="L9585" data-line-number="9585"></td>
        <td id="LC9585">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L9586" data-line-number="9586"></td>
        <td id="LC9586">                            {</td>
      </tr>
      <tr>
        <td id="L9587" data-line-number="9587"></td>
        <td id="LC9587">                                <span>stateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Read</span>;</td>
      </tr>
      <tr>
        <td id="L9588" data-line-number="9588"></td>
        <td id="LC9588">                            }</td>
      </tr>
      <tr>
        <td id="L9589" data-line-number="9589"></td>
        <td id="LC9589">                        }</td>
      </tr>
      <tr>
        <td id="L9590" data-line-number="9590"></td>
        <td id="LC9590">                        <span>finally</span></td>
      </tr>
      <tr>
        <td id="L9591" data-line-number="9591"></td>
        <td id="LC9591">                        {</td>
      </tr>
      <tr>
        <td id="L9592" data-line-number="9592"></td>
        <td id="LC9592">                            <span>if</span> (<span>taskReleaseConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L9593" data-line-number="9593"></td>
        <td id="LC9593">                            {</td>
      </tr>
      <tr>
        <td id="L9594" data-line-number="9594"></td>
        <td id="LC9594">                                <span>_connHandler</span>.<span>_parserLock</span>.<span>Release</span>();</td>
      </tr>
      <tr>
        <td id="L9595" data-line-number="9595"></td>
        <td id="LC9595">                            }</td>
      </tr>
      <tr>
        <td id="L9596" data-line-number="9596"></td>
        <td id="LC9596">                        }</td>
      </tr>
      <tr>
        <td id="L9597" data-line-number="9597"></td>
        <td id="LC9597">                    }, <span>TaskScheduler</span>.<span>Default</span>);</td>
      </tr>
      <tr>
        <td id="L9598" data-line-number="9598"></td>
        <td id="LC9598">                }</td>
      </tr>
      <tr>
        <td id="L9599" data-line-number="9599"></td>
        <td id="LC9599">
</td>
      </tr>
      <tr>
        <td id="L9600" data-line-number="9600"></td>
        <td id="LC9600">                <span><span>//</span> Finished sync</span></td>
      </tr>
      <tr>
        <td id="L9601" data-line-number="9601"></td>
        <td id="LC9601">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9602" data-line-number="9602"></td>
        <td id="LC9602">            }</td>
      </tr>
      <tr>
        <td id="L9603" data-line-number="9603"></td>
        <td id="LC9603">            <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L9604" data-line-number="9604"></td>
        <td id="LC9604">            {</td>
      </tr>
      <tr>
        <td id="L9605" data-line-number="9605"></td>
        <td id="LC9605">                <span><span>//</span>Debug.Assert(_state == TdsParserState.Broken, "Caught exception in TdsExecuteSQLBatch but connection was not broken!");</span></td>
      </tr>
      <tr>
        <td id="L9606" data-line-number="9606"></td>
        <td id="LC9606">                <span><span>//</span> UNDONE - should not be catching all exceptions!!!</span></td>
      </tr>
      <tr>
        <td id="L9607" data-line-number="9607"></td>
        <td id="LC9607">                <span>if</span> (<span>!</span><span>ADP</span>.<span>IsCatchableExceptionType</span>(<span>e</span>))</td>
      </tr>
      <tr>
        <td id="L9608" data-line-number="9608"></td>
        <td id="LC9608">                {</td>
      </tr>
      <tr>
        <td id="L9609" data-line-number="9609"></td>
        <td id="LC9609">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L9610" data-line-number="9610"></td>
        <td id="LC9610">                }</td>
      </tr>
      <tr>
        <td id="L9611" data-line-number="9611"></td>
        <td id="LC9611">
</td>
      </tr>
      <tr>
        <td id="L9612" data-line-number="9612"></td>
        <td id="LC9612">                <span>FailureCleanup</span>(<span>stateObj</span>, <span>e</span>);</td>
      </tr>
      <tr>
        <td id="L9613" data-line-number="9613"></td>
        <td id="LC9613">
</td>
      </tr>
      <tr>
        <td id="L9614" data-line-number="9614"></td>
        <td id="LC9614">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L9615" data-line-number="9615"></td>
        <td id="LC9615">            }</td>
      </tr>
      <tr>
        <td id="L9616" data-line-number="9616"></td>
        <td id="LC9616">            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L9617" data-line-number="9617"></td>
        <td id="LC9617">            {</td>
      </tr>
      <tr>
        <td id="L9618" data-line-number="9618"></td>
        <td id="LC9618">                <span>if</span> (<span>releaseConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L9619" data-line-number="9619"></td>
        <td id="LC9619">                {</td>
      </tr>
      <tr>
        <td id="L9620" data-line-number="9620"></td>
        <td id="LC9620">                    <span>_connHandler</span>.<span>_parserLock</span>.<span>Release</span>();</td>
      </tr>
      <tr>
        <td id="L9621" data-line-number="9621"></td>
        <td id="LC9621">                }</td>
      </tr>
      <tr>
        <td id="L9622" data-line-number="9622"></td>
        <td id="LC9622">            }</td>
      </tr>
      <tr>
        <td id="L9623" data-line-number="9623"></td>
        <td id="LC9623">        }</td>
      </tr>
      <tr>
        <td id="L9624" data-line-number="9624"></td>
        <td id="LC9624">
</td>
      </tr>
      <tr>
        <td id="L9625" data-line-number="9625"></td>
        <td id="LC9625">        <span>internal</span> <span>Task</span> <span>TdsExecuteRPC</span>(<span>SqlCommand</span> <span>cmd</span>, <span>_SqlRPC</span>[] <span>rpcArray</span>, <span>int</span> <span>timeout</span>, <span>bool</span> <span>inSchema</span>, <span>SqlNotificationRequest</span> <span>notificationRequest</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>isCommandProc</span>, <span>bool</span> <span>sync</span> <span>=</span> <span>true</span>,</td>
      </tr>
      <tr>
        <td id="L9626" data-line-number="9626"></td>
        <td id="LC9626">            <span>TaskCompletionSource</span><span>&lt;</span><span>object</span><span>&gt;</span> <span>completion</span> <span>=</span> <span>null</span>, <span>int</span> <span>startRpc</span> <span>=</span> <span>0</span>, <span>int</span> <span>startParam</span> <span>=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L9627" data-line-number="9627"></td>
        <td id="LC9627">        {</td>
      </tr>
      <tr>
        <td id="L9628" data-line-number="9628"></td>
        <td id="LC9628">            <span>bool</span> <span>firstCall</span> <span>=</span> (<span>completion</span> <span>==</span> <span>null</span>);</td>
      </tr>
      <tr>
        <td id="L9629" data-line-number="9629"></td>
        <td id="LC9629">            <span>bool</span> <span>releaseConnectionLock</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9630" data-line-number="9630"></td>
        <td id="LC9630">
</td>
      </tr>
      <tr>
        <td id="L9631" data-line-number="9631"></td>
        <td id="LC9631">            <span>Debug</span>.<span>Assert</span>(<span>cmd</span> <span>!=</span> <span>null</span>, <span><span>@"</span>cmd cannot be null inside TdsExecuteRPC<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9632" data-line-number="9632"></td>
        <td id="LC9632">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>firstCall</span> <span>||</span> <span>startRpc</span> <span>==</span> <span>0</span>, <span><span>"</span>startRpc is not 0 on first call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9633" data-line-number="9633"></td>
        <td id="LC9633">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>firstCall</span> <span>||</span> <span>startParam</span> <span>==</span> <span>0</span>, <span><span>"</span>startParam is not 0 on first call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9634" data-line-number="9634"></td>
        <td id="LC9634">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>firstCall</span> <span>||</span> <span>!</span><span>_connHandler</span>.<span>ThreadHasParserLockForClose</span>, <span><span>"</span>Thread should not already have connection lock<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9635" data-line-number="9635"></td>
        <td id="LC9635">            <span>Debug</span>.<span>Assert</span>(<span>firstCall</span> <span>||</span> <span>_connHandler</span>.<span>_parserLock</span>.<span>ThreadMayHaveLock</span>(), <span><span>"</span>Connection lock not taken after the first call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9636" data-line-number="9636"></td>
        <td id="LC9636">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L9637" data-line-number="9637"></td>
        <td id="LC9637">            {</td>
      </tr>
      <tr>
        <td id="L9638" data-line-number="9638"></td>
        <td id="LC9638">                <span>_SqlRPC</span> <span>rpcext</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9639" data-line-number="9639"></td>
        <td id="LC9639">                <span>int</span> <span>tempLen</span>;</td>
      </tr>
      <tr>
        <td id="L9640" data-line-number="9640"></td>
        <td id="LC9640">
</td>
      </tr>
      <tr>
        <td id="L9641" data-line-number="9641"></td>
        <td id="LC9641">                <span><span>//</span> SQLBUDT #20010853 - Promote, Commit and Rollback requests for</span></td>
      </tr>
      <tr>
        <td id="L9642" data-line-number="9642"></td>
        <td id="LC9642">                <span><span>//</span> delegated transactions often happen while there is an open result</span></td>
      </tr>
      <tr>
        <td id="L9643" data-line-number="9643"></td>
        <td id="LC9643">                <span><span>//</span> set, so we need to handle them by using a different MARS session,</span></td>
      </tr>
      <tr>
        <td id="L9644" data-line-number="9644"></td>
        <td id="LC9644">                <span><span>//</span> otherwise we'll write on the physical state objects while someone</span></td>
      </tr>
      <tr>
        <td id="L9645" data-line-number="9645"></td>
        <td id="LC9645">                <span><span>//</span> else is using it.  When we don't have MARS enabled, we need to</span></td>
      </tr>
      <tr>
        <td id="L9646" data-line-number="9646"></td>
        <td id="LC9646">                <span><span>//</span> lock the physical state object to syncronize it's use at least</span></td>
      </tr>
      <tr>
        <td id="L9647" data-line-number="9647"></td>
        <td id="LC9647">                <span><span>//</span> until we increment the open results count.  Once it's been</span></td>
      </tr>
      <tr>
        <td id="L9648" data-line-number="9648"></td>
        <td id="LC9648">                <span><span>//</span> incremented the delegated transaction requests will fail, so they</span></td>
      </tr>
      <tr>
        <td id="L9649" data-line-number="9649"></td>
        <td id="LC9649">                <span><span>//</span> won't stomp on anything.</span></td>
      </tr>
      <tr>
        <td id="L9650" data-line-number="9650"></td>
        <td id="LC9650">
</td>
      </tr>
      <tr>
        <td id="L9651" data-line-number="9651"></td>
        <td id="LC9651">
</td>
      </tr>
      <tr>
        <td id="L9652" data-line-number="9652"></td>
        <td id="LC9652">                <span>if</span> (<span>firstCall</span>)</td>
      </tr>
      <tr>
        <td id="L9653" data-line-number="9653"></td>
        <td id="LC9653">                {</td>
      </tr>
      <tr>
        <td id="L9654" data-line-number="9654"></td>
        <td id="LC9654">                    <span>_connHandler</span>.<span>_parserLock</span>.<span>Wait</span>(<span>canReleaseFromAnyThread</span>: <span>!</span><span>sync</span>);</td>
      </tr>
      <tr>
        <td id="L9655" data-line-number="9655"></td>
        <td id="LC9655">                    <span>releaseConnectionLock</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9656" data-line-number="9656"></td>
        <td id="LC9656">                }</td>
      </tr>
      <tr>
        <td id="L9657" data-line-number="9657"></td>
        <td id="LC9657">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L9658" data-line-number="9658"></td>
        <td id="LC9658">                {</td>
      </tr>
      <tr>
        <td id="L9659" data-line-number="9659"></td>
        <td id="LC9659">                    <span><span>//</span> Ensure that connection is alive</span></td>
      </tr>
      <tr>
        <td id="L9660" data-line-number="9660"></td>
        <td id="LC9660">                    <span>if</span> ((<span>TdsParserState</span>.<span>Broken</span> <span>==</span> <span>State</span>) <span>||</span> (<span>TdsParserState</span>.<span>Closed</span> <span>==</span> <span>State</span>))</td>
      </tr>
      <tr>
        <td id="L9661" data-line-number="9661"></td>
        <td id="LC9661">                    {</td>
      </tr>
      <tr>
        <td id="L9662" data-line-number="9662"></td>
        <td id="LC9662">                        <span>throw</span> <span>ADP</span>.<span>ClosedConnectionError</span>();</td>
      </tr>
      <tr>
        <td id="L9663" data-line-number="9663"></td>
        <td id="LC9663">                    }</td>
      </tr>
      <tr>
        <td id="L9664" data-line-number="9664"></td>
        <td id="LC9664">
</td>
      </tr>
      <tr>
        <td id="L9665" data-line-number="9665"></td>
        <td id="LC9665">                    <span><span>//</span> This validation step MUST be done after locking the connection to guarantee we don't</span></td>
      </tr>
      <tr>
        <td id="L9666" data-line-number="9666"></td>
        <td id="LC9666">                    <span><span>//</span>  accidentally execute after the transaction has completed on a different thread.</span></td>
      </tr>
      <tr>
        <td id="L9667" data-line-number="9667"></td>
        <td id="LC9667">                    <span>if</span> (<span>firstCall</span>)</td>
      </tr>
      <tr>
        <td id="L9668" data-line-number="9668"></td>
        <td id="LC9668">                    {</td>
      </tr>
      <tr>
        <td id="L9669" data-line-number="9669"></td>
        <td id="LC9669">                        <span>_asyncWrite</span> <span>=</span> <span>!</span><span>sync</span>;</td>
      </tr>
      <tr>
        <td id="L9670" data-line-number="9670"></td>
        <td id="LC9670">
</td>
      </tr>
      <tr>
        <td id="L9671" data-line-number="9671"></td>
        <td id="LC9671">                        <span>_connHandler</span>.<span>CheckEnlistedTransactionBinding</span>();</td>
      </tr>
      <tr>
        <td id="L9672" data-line-number="9672"></td>
        <td id="LC9672">
</td>
      </tr>
      <tr>
        <td id="L9673" data-line-number="9673"></td>
        <td id="LC9673">                        <span>stateObj</span>.<span>SetTimeoutSeconds</span>(<span>timeout</span>);</td>
      </tr>
      <tr>
        <td id="L9674" data-line-number="9674"></td>
        <td id="LC9674">                        <span>if</span> ((<span>!</span><span>_fMARS</span>) <span>&amp;&amp;</span> (<span>_physicalStateObj</span>.<span>HasOpenResult</span>))</td>
      </tr>
      <tr>
        <td id="L9675" data-line-number="9675"></td>
        <td id="LC9675">                        {</td>
      </tr>
      <tr>
        <td id="L9676" data-line-number="9676"></td>
        <td id="LC9676">                            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.TdsExecuteRPC|ERR&gt; Potential multi-threaded misuse of connection, non-MARs connection with an open result %d#<span>\n</span><span>"</span></span>, <span>ObjectID</span>);</td>
      </tr>
      <tr>
        <td id="L9677" data-line-number="9677"></td>
        <td id="LC9677">                        }</td>
      </tr>
      <tr>
        <td id="L9678" data-line-number="9678"></td>
        <td id="LC9678">                        <span>stateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Execute</span>;</td>
      </tr>
      <tr>
        <td id="L9679" data-line-number="9679"></td>
        <td id="LC9679">
</td>
      </tr>
      <tr>
        <td id="L9680" data-line-number="9680"></td>
        <td id="LC9680">                        <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L9681" data-line-number="9681"></td>
        <td id="LC9681">                        {</td>
      </tr>
      <tr>
        <td id="L9682" data-line-number="9682"></td>
        <td id="LC9682">
</td>
      </tr>
      <tr>
        <td id="L9683" data-line-number="9683"></td>
        <td id="LC9683">                            <span>WriteRPCBatchHeaders</span>(<span>stateObj</span>, <span>notificationRequest</span>);</td>
      </tr>
      <tr>
        <td id="L9684" data-line-number="9684"></td>
        <td id="LC9684">                        }</td>
      </tr>
      <tr>
        <td id="L9685" data-line-number="9685"></td>
        <td id="LC9685">
</td>
      </tr>
      <tr>
        <td id="L9686" data-line-number="9686"></td>
        <td id="LC9686">                        <span>stateObj</span>.<span>_outputMessageType</span> <span>=</span> <span>TdsEnums</span>.<span>MT_RPC</span>;</td>
      </tr>
      <tr>
        <td id="L9687" data-line-number="9687"></td>
        <td id="LC9687">                    }</td>
      </tr>
      <tr>
        <td id="L9688" data-line-number="9688"></td>
        <td id="LC9688">
</td>
      </tr>
      <tr>
        <td id="L9689" data-line-number="9689"></td>
        <td id="LC9689">                    <span>for</span> (<span>int</span> <span>ii</span> <span>=</span> <span>startRpc</span>; <span>ii</span> <span>&lt;</span> <span>rpcArray</span>.<span>Length</span>; <span>ii</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L9690" data-line-number="9690"></td>
        <td id="LC9690">                    {</td>
      </tr>
      <tr>
        <td id="L9691" data-line-number="9691"></td>
        <td id="LC9691">                        <span>rpcext</span> <span>=</span> <span>rpcArray</span>[<span>ii</span>];</td>
      </tr>
      <tr>
        <td id="L9692" data-line-number="9692"></td>
        <td id="LC9692">
</td>
      </tr>
      <tr>
        <td id="L9693" data-line-number="9693"></td>
        <td id="LC9693">                        <span>if</span> (<span>startParam</span> <span>==</span> <span>0</span> <span>||</span> <span>ii</span> <span>&gt;</span> <span>startRpc</span>)</td>
      </tr>
      <tr>
        <td id="L9694" data-line-number="9694"></td>
        <td id="LC9694">                        {</td>
      </tr>
      <tr>
        <td id="L9695" data-line-number="9695"></td>
        <td id="LC9695">                            <span>if</span> (<span>rpcext</span>.<span>ProcID</span> <span>!=</span> <span>0</span> <span>&amp;&amp;</span> <span>_isShiloh</span>)</td>
      </tr>
      <tr>
        <td id="L9696" data-line-number="9696"></td>
        <td id="LC9696">                            {</td>
      </tr>
      <tr>
        <td id="L9697" data-line-number="9697"></td>
        <td id="LC9697">                                <span><span>//</span> Perf optimization for Shiloh and later,</span></td>
      </tr>
      <tr>
        <td id="L9698" data-line-number="9698"></td>
        <td id="LC9698">                                <span>Debug</span>.<span>Assert</span>(<span>rpcext</span>.<span>ProcID</span> <span>&lt;</span> <span>255</span>, <span><span>"</span>rpcExec:ProcID can't be larger than 255<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9699" data-line-number="9699"></td>
        <td id="LC9699">                                <span>WriteShort</span>(<span>0xffff</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9700" data-line-number="9700"></td>
        <td id="LC9700">                                <span>WriteShort</span>((<span>short</span>)(<span>rpcext</span>.<span>ProcID</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9701" data-line-number="9701"></td>
        <td id="LC9701">                            }</td>
      </tr>
      <tr>
        <td id="L9702" data-line-number="9702"></td>
        <td id="LC9702">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L9703" data-line-number="9703"></td>
        <td id="LC9703">                            {</td>
      </tr>
      <tr>
        <td id="L9704" data-line-number="9704"></td>
        <td id="LC9704">                                <span>Debug</span>.<span>Assert</span>(<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>rpcext</span>.<span>rpcName</span>), <span><span>"</span>must have an RPC name<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9705" data-line-number="9705"></td>
        <td id="LC9705">                                <span>tempLen</span> <span>=</span> <span>rpcext</span>.<span>rpcName</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L9706" data-line-number="9706"></td>
        <td id="LC9706">                                <span>WriteShort</span>(<span>tempLen</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9707" data-line-number="9707"></td>
        <td id="LC9707">                                <span>WriteString</span>(<span>rpcext</span>.<span>rpcName</span>, <span>tempLen</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9708" data-line-number="9708"></td>
        <td id="LC9708">                            }</td>
      </tr>
      <tr>
        <td id="L9709" data-line-number="9709"></td>
        <td id="LC9709">
</td>
      </tr>
      <tr>
        <td id="L9710" data-line-number="9710"></td>
        <td id="LC9710">                            <span><span>//</span> Options</span></td>
      </tr>
      <tr>
        <td id="L9711" data-line-number="9711"></td>
        <td id="LC9711">                            <span>WriteShort</span>((<span>short</span>)<span>rpcext</span>.<span>options</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9712" data-line-number="9712"></td>
        <td id="LC9712">                        }</td>
      </tr>
      <tr>
        <td id="L9713" data-line-number="9713"></td>
        <td id="LC9713">
</td>
      </tr>
      <tr>
        <td id="L9714" data-line-number="9714"></td>
        <td id="LC9714">                        <span>byte</span>[] <span>enclavePackage</span> <span>=</span> <span>cmd</span>.<span>enclavePackage</span> <span>!=</span> <span>null</span> <span>?</span> <span>cmd</span>.<span>enclavePackage</span>.<span>EnclavePackageBytes</span> <span>:</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9715" data-line-number="9715"></td>
        <td id="LC9715">                        <span>WriteEnclaveInfo</span>(<span>stateObj</span>, <span>enclavePackage</span>);</td>
      </tr>
      <tr>
        <td id="L9716" data-line-number="9716"></td>
        <td id="LC9716">
</td>
      </tr>
      <tr>
        <td id="L9717" data-line-number="9717"></td>
        <td id="LC9717">                        <span><span>//</span> Stream out parameters</span></td>
      </tr>
      <tr>
        <td id="L9718" data-line-number="9718"></td>
        <td id="LC9718">                        <span>SqlParameter</span>[] <span>parameters</span> <span>=</span> <span>rpcext</span>.<span>parameters</span>;</td>
      </tr>
      <tr>
        <td id="L9719" data-line-number="9719"></td>
        <td id="LC9719">
</td>
      </tr>
      <tr>
        <td id="L9720" data-line-number="9720"></td>
        <td id="LC9720">                        <span>for</span> (<span>int</span> <span>i</span> <span>=</span> (<span>ii</span> <span>==</span> <span>startRpc</span>) <span>?</span> <span>startParam</span> <span>:</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>parameters</span>.<span>Length</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L9721" data-line-number="9721"></td>
        <td id="LC9721">                        {</td>
      </tr>
      <tr>
        <td id="L9722" data-line-number="9722"></td>
        <td id="LC9722">                            <span><span>//</span>                Debug.WriteLine("i:  " + i.ToString(CultureInfo.InvariantCulture));</span></td>
      </tr>
      <tr>
        <td id="L9723" data-line-number="9723"></td>
        <td id="LC9723">                            <span><span>//</span> parameters can be unnamed</span></td>
      </tr>
      <tr>
        <td id="L9724" data-line-number="9724"></td>
        <td id="LC9724">                            <span>SqlParameter</span> <span>param</span> <span>=</span> <span>parameters</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L9725" data-line-number="9725"></td>
        <td id="LC9725">                            <span><span>//</span> Since we are reusing the parameters array, we cannot rely on length to indicate no of parameters.</span></td>
      </tr>
      <tr>
        <td id="L9726" data-line-number="9726"></td>
        <td id="LC9726">                            <span>if</span> (<span>param</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L9727" data-line-number="9727"></td>
        <td id="LC9727">                                <span>break</span>;      <span><span>//</span> End of parameters for this execute</span></td>
      </tr>
      <tr>
        <td id="L9728" data-line-number="9728"></td>
        <td id="LC9728">
</td>
      </tr>
      <tr>
        <td id="L9729" data-line-number="9729"></td>
        <td id="LC9729">                            <span><span>//</span> Throw an exception if ForceColumnEncryption is set on a parameter and the ColumnEncryption is not enabled on SqlConnection or SqlCommand</span></td>
      </tr>
      <tr>
        <td id="L9730" data-line-number="9730"></td>
        <td id="LC9730">                            <span>if</span> (<span>param</span>.<span>ForceColumnEncryption</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L9731" data-line-number="9731"></td>
        <td id="LC9731">                                <span>!</span>(<span>cmd</span>.<span>ColumnEncryptionSetting</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>Enabled</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L9732" data-line-number="9732"></td>
        <td id="LC9732">                                (<span>cmd</span>.<span>ColumnEncryptionSetting</span> <span>==</span> <span>SqlCommandColumnEncryptionSetting</span>.<span>UseConnectionSetting</span> <span>&amp;&amp;</span> <span>cmd</span>.<span>Connection</span>.<span>IsColumnEncryptionSettingEnabled</span>)))</td>
      </tr>
      <tr>
        <td id="L9733" data-line-number="9733"></td>
        <td id="LC9733">                            {</td>
      </tr>
      <tr>
        <td id="L9734" data-line-number="9734"></td>
        <td id="LC9734">                                <span>throw</span> <span>SQL</span>.<span>ParamInvalidForceColumnEncryptionSetting</span>(<span>param</span>.<span>ParameterName</span>, <span>rpcext</span>.<span>GetCommandTextOrRpcName</span>());</td>
      </tr>
      <tr>
        <td id="L9735" data-line-number="9735"></td>
        <td id="LC9735">                            }</td>
      </tr>
      <tr>
        <td id="L9736" data-line-number="9736"></td>
        <td id="LC9736">
</td>
      </tr>
      <tr>
        <td id="L9737" data-line-number="9737"></td>
        <td id="LC9737">                            <span><span>//</span> Check if the applications wants to force column encryption to avoid sending sensitive data to server</span></td>
      </tr>
      <tr>
        <td id="L9738" data-line-number="9738"></td>
        <td id="LC9738">                            <span>if</span> (<span>param</span>.<span>ForceColumnEncryption</span> <span>&amp;&amp;</span> <span>param</span>.<span>CipherMetadata</span> <span>==</span> <span>null</span></td>
      </tr>
      <tr>
        <td id="L9739" data-line-number="9739"></td>
        <td id="LC9739">                                <span>&amp;&amp;</span> (<span>param</span>.<span>Direction</span> <span>==</span> <span>ParameterDirection</span>.<span>Input</span> <span>||</span> <span>param</span>.<span>Direction</span> <span>==</span> <span>ParameterDirection</span>.<span>InputOutput</span>))</td>
      </tr>
      <tr>
        <td id="L9740" data-line-number="9740"></td>
        <td id="LC9740">                            {</td>
      </tr>
      <tr>
        <td id="L9741" data-line-number="9741"></td>
        <td id="LC9741">                                <span><span>//</span> Application wants a parameter to be encrypted before sending it to server, however server doesnt think this parameter needs encryption.</span></td>
      </tr>
      <tr>
        <td id="L9742" data-line-number="9742"></td>
        <td id="LC9742">                                <span>throw</span> <span>SQL</span>.<span>ParamUnExpectedEncryptionMetadata</span>(<span>param</span>.<span>ParameterName</span>, <span>rpcext</span>.<span>GetCommandTextOrRpcName</span>());</td>
      </tr>
      <tr>
        <td id="L9743" data-line-number="9743"></td>
        <td id="LC9743">                            }</td>
      </tr>
      <tr>
        <td id="L9744" data-line-number="9744"></td>
        <td id="LC9744">
</td>
      </tr>
      <tr>
        <td id="L9745" data-line-number="9745"></td>
        <td id="LC9745">                            <span><span>//</span> Validate parameters are not variable length without size and with null value.  MDAC 66522</span></td>
      </tr>
      <tr>
        <td id="L9746" data-line-number="9746"></td>
        <td id="LC9746">                            <span>param</span>.<span>Validate</span>(<span>i</span>, <span>isCommandProc</span>);</td>
      </tr>
      <tr>
        <td id="L9747" data-line-number="9747"></td>
        <td id="LC9747">
</td>
      </tr>
      <tr>
        <td id="L9748" data-line-number="9748"></td>
        <td id="LC9748">                            <span><span>//</span> type (parameter record stores the MetaType class which is a helper that encapsulates all the type information we need here)</span></td>
      </tr>
      <tr>
        <td id="L9749" data-line-number="9749"></td>
        <td id="LC9749">                            <span>MetaType</span> <span>mt</span> <span>=</span> <span>param</span>.<span>InternalMetaType</span>;</td>
      </tr>
      <tr>
        <td id="L9750" data-line-number="9750"></td>
        <td id="LC9750">
</td>
      </tr>
      <tr>
        <td id="L9751" data-line-number="9751"></td>
        <td id="LC9751">                            <span>if</span> (<span>mt</span>.<span>IsNewKatmaiType</span>)</td>
      </tr>
      <tr>
        <td id="L9752" data-line-number="9752"></td>
        <td id="LC9752">                            {</td>
      </tr>
      <tr>
        <td id="L9753" data-line-number="9753"></td>
        <td id="LC9753">                                <span>WriteSmiParameter</span>(<span>param</span>, <span>i</span>, <span>0</span> <span>!=</span> (<span>rpcext</span>.<span>paramoptions</span>[<span>i</span>] <span>&amp;</span> <span>TdsEnums</span>.<span>RPC_PARAM_DEFAULT</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9754" data-line-number="9754"></td>
        <td id="LC9754">                                <span>continue</span>;</td>
      </tr>
      <tr>
        <td id="L9755" data-line-number="9755"></td>
        <td id="LC9755">                            }</td>
      </tr>
      <tr>
        <td id="L9756" data-line-number="9756"></td>
        <td id="LC9756">
</td>
      </tr>
      <tr>
        <td id="L9757" data-line-number="9757"></td>
        <td id="LC9757">                            <span>if</span> ((<span>!</span><span>_isShiloh</span> <span>&amp;&amp;</span> <span>!</span><span>mt</span>.<span>Is70Supported</span>) <span>||</span></td>
      </tr>
      <tr>
        <td id="L9758" data-line-number="9758"></td>
        <td id="LC9758">                                (<span>!</span><span>_isYukon</span> <span>&amp;&amp;</span> <span>!</span><span>mt</span>.<span>Is80Supported</span>) <span>||</span></td>
      </tr>
      <tr>
        <td id="L9759" data-line-number="9759"></td>
        <td id="LC9759">                                (<span>!</span><span>_isKatmai</span> <span>&amp;&amp;</span> <span>!</span><span>mt</span>.<span>Is90Supported</span>))</td>
      </tr>
      <tr>
        <td id="L9760" data-line-number="9760"></td>
        <td id="LC9760">                            {</td>
      </tr>
      <tr>
        <td id="L9761" data-line-number="9761"></td>
        <td id="LC9761">                                <span>throw</span> <span>ADP</span>.<span>VersionDoesNotSupportDataType</span>(<span>mt</span>.<span>TypeName</span>);</td>
      </tr>
      <tr>
        <td id="L9762" data-line-number="9762"></td>
        <td id="LC9762">                            }</td>
      </tr>
      <tr>
        <td id="L9763" data-line-number="9763"></td>
        <td id="LC9763">                            <span>object</span> <span>value</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9764" data-line-number="9764"></td>
        <td id="LC9764">                            <span>bool</span> <span>isNull</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L9765" data-line-number="9765"></td>
        <td id="LC9765">                            <span>bool</span> <span>isSqlVal</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9766" data-line-number="9766"></td>
        <td id="LC9766">                            <span>bool</span> <span>isDataFeed</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9767" data-line-number="9767"></td>
        <td id="LC9767">                            <span><span>//</span> if we have an output param, set the value to null so we do not send it across to the server</span></td>
      </tr>
      <tr>
        <td id="L9768" data-line-number="9768"></td>
        <td id="LC9768">                            <span>if</span> (<span>param</span>.<span>Direction</span> <span>==</span> <span>ParameterDirection</span>.<span>Output</span>)</td>
      </tr>
      <tr>
        <td id="L9769" data-line-number="9769"></td>
        <td id="LC9769">                            {</td>
      </tr>
      <tr>
        <td id="L9770" data-line-number="9770"></td>
        <td id="LC9770">                                <span>isSqlVal</span> <span>=</span> <span>param</span>.<span>ParamaterIsSqlType</span>;  <span><span>//</span> We have to forward the TYPE info, we need to know what type we are returning.  Once we null the paramater we will no longer be able to distinguish what type were seeing.</span></td>
      </tr>
      <tr>
        <td id="L9771" data-line-number="9771"></td>
        <td id="LC9771">                                <span>param</span>.<span>Value</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9772" data-line-number="9772"></td>
        <td id="LC9772">                                <span>param</span>.<span>ParamaterIsSqlType</span> <span>=</span> <span>isSqlVal</span>;</td>
      </tr>
      <tr>
        <td id="L9773" data-line-number="9773"></td>
        <td id="LC9773">                            }</td>
      </tr>
      <tr>
        <td id="L9774" data-line-number="9774"></td>
        <td id="LC9774">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L9775" data-line-number="9775"></td>
        <td id="LC9775">                            {</td>
      </tr>
      <tr>
        <td id="L9776" data-line-number="9776"></td>
        <td id="LC9776">                                <span>value</span> <span>=</span> <span>param</span>.<span>GetCoercedValue</span>();</td>
      </tr>
      <tr>
        <td id="L9777" data-line-number="9777"></td>
        <td id="LC9777">                                <span>isNull</span> <span>=</span> <span>param</span>.<span>IsNull</span>;</td>
      </tr>
      <tr>
        <td id="L9778" data-line-number="9778"></td>
        <td id="LC9778">                                <span>if</span> (<span>!</span><span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L9779" data-line-number="9779"></td>
        <td id="LC9779">                                {</td>
      </tr>
      <tr>
        <td id="L9780" data-line-number="9780"></td>
        <td id="LC9780">                                    <span>isSqlVal</span> <span>=</span> <span>param</span>.<span>CoercedValueIsSqlType</span>;</td>
      </tr>
      <tr>
        <td id="L9781" data-line-number="9781"></td>
        <td id="LC9781">                                    <span>isDataFeed</span> <span>=</span> <span>param</span>.<span>CoercedValueIsDataFeed</span>;</td>
      </tr>
      <tr>
        <td id="L9782" data-line-number="9782"></td>
        <td id="LC9782">                                }</td>
      </tr>
      <tr>
        <td id="L9783" data-line-number="9783"></td>
        <td id="LC9783">                            }</td>
      </tr>
      <tr>
        <td id="L9784" data-line-number="9784"></td>
        <td id="LC9784">
</td>
      </tr>
      <tr>
        <td id="L9785" data-line-number="9785"></td>
        <td id="LC9785">                            <span>WriteParameterName</span>(<span>param</span>.<span>ParameterNameFixed</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9786" data-line-number="9786"></td>
        <td id="LC9786">
</td>
      </tr>
      <tr>
        <td id="L9787" data-line-number="9787"></td>
        <td id="LC9787">                            <span><span>//</span> Write parameter status</span></td>
      </tr>
      <tr>
        <td id="L9788" data-line-number="9788"></td>
        <td id="LC9788">                            <span>stateObj</span>.<span>WriteByte</span>(<span>rpcext</span>.<span>paramoptions</span>[<span>i</span>]);</td>
      </tr>
      <tr>
        <td id="L9789" data-line-number="9789"></td>
        <td id="LC9789">
</td>
      </tr>
      <tr>
        <td id="L9790" data-line-number="9790"></td>
        <td id="LC9790">                            <span><span>//</span> MaxLen field is only written out for non-fixed length data types</span></td>
      </tr>
      <tr>
        <td id="L9791" data-line-number="9791"></td>
        <td id="LC9791">                            <span><span>//</span> use the greater of the two sizes for maxLen</span></td>
      </tr>
      <tr>
        <td id="L9792" data-line-number="9792"></td>
        <td id="LC9792">                            <span>int</span> <span>actualSize</span>;</td>
      </tr>
      <tr>
        <td id="L9793" data-line-number="9793"></td>
        <td id="LC9793">                            <span>int</span> <span>size</span> <span>=</span> <span>mt</span>.<span>IsSizeInCharacters</span> <span>?</span> <span>param</span>.<span>GetParameterSize</span>() <span>*</span> <span>2</span> <span>:</span> <span>param</span>.<span>GetParameterSize</span>();</td>
      </tr>
      <tr>
        <td id="L9794" data-line-number="9794"></td>
        <td id="LC9794">
</td>
      </tr>
      <tr>
        <td id="L9795" data-line-number="9795"></td>
        <td id="LC9795">                            <span><span>//</span>for UDTs, we calculate the length later when we get the bytes. This is a really expensive operation</span></td>
      </tr>
      <tr>
        <td id="L9796" data-line-number="9796"></td>
        <td id="LC9796">                            <span>if</span> (<span>mt</span>.<span>TDSType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLUDT</span>)</td>
      </tr>
      <tr>
        <td id="L9797" data-line-number="9797"></td>
        <td id="LC9797">                                <span><span>//</span> getting the actualSize is expensive, cache here and use below</span></td>
      </tr>
      <tr>
        <td id="L9798" data-line-number="9798"></td>
        <td id="LC9798">                                <span>actualSize</span> <span>=</span> <span>param</span>.<span>GetActualSize</span>();</td>
      </tr>
      <tr>
        <td id="L9799" data-line-number="9799"></td>
        <td id="LC9799">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L9800" data-line-number="9800"></td>
        <td id="LC9800">                                <span>actualSize</span> <span>=</span> <span>0</span>; <span><span>//</span>get this later</span></td>
      </tr>
      <tr>
        <td id="L9801" data-line-number="9801"></td>
        <td id="LC9801">
</td>
      </tr>
      <tr>
        <td id="L9802" data-line-number="9802"></td>
        <td id="LC9802">                            <span>byte</span> <span>precision</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9803" data-line-number="9803"></td>
        <td id="LC9803">                            <span>byte</span> <span>scale</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9804" data-line-number="9804"></td>
        <td id="LC9804">
</td>
      </tr>
      <tr>
        <td id="L9805" data-line-number="9805"></td>
        <td id="LC9805">                            <span><span>//</span> scale and precision are only relevant for numeric and decimal types</span></td>
      </tr>
      <tr>
        <td id="L9806" data-line-number="9806"></td>
        <td id="LC9806">                            <span><span>//</span> adjust the actual value scale and precision to match the user specified</span></td>
      </tr>
      <tr>
        <td id="L9807" data-line-number="9807"></td>
        <td id="LC9807">                            <span>if</span> (<span>mt</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>Decimal</span>)</td>
      </tr>
      <tr>
        <td id="L9808" data-line-number="9808"></td>
        <td id="LC9808">                            {</td>
      </tr>
      <tr>
        <td id="L9809" data-line-number="9809"></td>
        <td id="LC9809">                                <span>precision</span> <span>=</span> <span>param</span>.<span>GetActualPrecision</span>();</td>
      </tr>
      <tr>
        <td id="L9810" data-line-number="9810"></td>
        <td id="LC9810">                                <span>scale</span> <span>=</span> <span>param</span>.<span>GetActualScale</span>();</td>
      </tr>
      <tr>
        <td id="L9811" data-line-number="9811"></td>
        <td id="LC9811">
</td>
      </tr>
      <tr>
        <td id="L9812" data-line-number="9812"></td>
        <td id="LC9812">                                <span>if</span> (<span>precision</span> <span>&gt;</span> <span>TdsEnums</span>.<span>MAX_NUMERIC_PRECISION</span>)</td>
      </tr>
      <tr>
        <td id="L9813" data-line-number="9813"></td>
        <td id="LC9813">                                {</td>
      </tr>
      <tr>
        <td id="L9814" data-line-number="9814"></td>
        <td id="LC9814">                                    <span>throw</span> <span>SQL</span>.<span>PrecisionValueOutOfRange</span>(<span>precision</span>);</td>
      </tr>
      <tr>
        <td id="L9815" data-line-number="9815"></td>
        <td id="LC9815">                                }</td>
      </tr>
      <tr>
        <td id="L9816" data-line-number="9816"></td>
        <td id="LC9816">
</td>
      </tr>
      <tr>
        <td id="L9817" data-line-number="9817"></td>
        <td id="LC9817">                                <span><span>//</span> bug 49512, make sure the value matches the scale the user enters</span></td>
      </tr>
      <tr>
        <td id="L9818" data-line-number="9818"></td>
        <td id="LC9818">                                <span>if</span> (<span>!</span><span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L9819" data-line-number="9819"></td>
        <td id="LC9819">                                {</td>
      </tr>
      <tr>
        <td id="L9820" data-line-number="9820"></td>
        <td id="LC9820">                                    <span>if</span> (<span>isSqlVal</span>)</td>
      </tr>
      <tr>
        <td id="L9821" data-line-number="9821"></td>
        <td id="LC9821">                                    {</td>
      </tr>
      <tr>
        <td id="L9822" data-line-number="9822"></td>
        <td id="LC9822">                                        <span>value</span> <span>=</span> <span>AdjustSqlDecimalScale</span>((<span>SqlDecimal</span>)<span>value</span>, <span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L9823" data-line-number="9823"></td>
        <td id="LC9823">
</td>
      </tr>
      <tr>
        <td id="L9824" data-line-number="9824"></td>
        <td id="LC9824">                                        <span><span>//</span> If Precision is specified, verify value precision vs param precision</span></td>
      </tr>
      <tr>
        <td id="L9825" data-line-number="9825"></td>
        <td id="LC9825">                                        <span>if</span> (<span>precision</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L9826" data-line-number="9826"></td>
        <td id="LC9826">                                        {</td>
      </tr>
      <tr>
        <td id="L9827" data-line-number="9827"></td>
        <td id="LC9827">                                            <span>if</span> (<span>precision</span> <span>&lt;</span> ((<span>SqlDecimal</span>)<span>value</span>).<span>Precision</span>)</td>
      </tr>
      <tr>
        <td id="L9828" data-line-number="9828"></td>
        <td id="LC9828">                                            {</td>
      </tr>
      <tr>
        <td id="L9829" data-line-number="9829"></td>
        <td id="LC9829">                                                <span>throw</span> <span>ADP</span>.<span>ParameterValueOutOfRange</span>((<span>SqlDecimal</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L9830" data-line-number="9830"></td>
        <td id="LC9830">                                            }</td>
      </tr>
      <tr>
        <td id="L9831" data-line-number="9831"></td>
        <td id="LC9831">                                        }</td>
      </tr>
      <tr>
        <td id="L9832" data-line-number="9832"></td>
        <td id="LC9832">                                    }</td>
      </tr>
      <tr>
        <td id="L9833" data-line-number="9833"></td>
        <td id="LC9833">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L9834" data-line-number="9834"></td>
        <td id="LC9834">                                    {</td>
      </tr>
      <tr>
        <td id="L9835" data-line-number="9835"></td>
        <td id="LC9835">                                        <span>value</span> <span>=</span> <span>AdjustDecimalScale</span>((<span>Decimal</span>)<span>value</span>, <span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L9836" data-line-number="9836"></td>
        <td id="LC9836">
</td>
      </tr>
      <tr>
        <td id="L9837" data-line-number="9837"></td>
        <td id="LC9837">                                        <span>SqlDecimal</span> <span>sqlValue</span> <span>=</span> <span>new</span> <span>SqlDecimal</span>((<span>Decimal</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L9838" data-line-number="9838"></td>
        <td id="LC9838">
</td>
      </tr>
      <tr>
        <td id="L9839" data-line-number="9839"></td>
        <td id="LC9839">                                        <span><span>//</span> If Precision is specified, verify value precision vs param precision</span></td>
      </tr>
      <tr>
        <td id="L9840" data-line-number="9840"></td>
        <td id="LC9840">                                        <span>if</span> (<span>precision</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L9841" data-line-number="9841"></td>
        <td id="LC9841">                                        {</td>
      </tr>
      <tr>
        <td id="L9842" data-line-number="9842"></td>
        <td id="LC9842">                                            <span>if</span> (<span>precision</span> <span>&lt;</span> <span>sqlValue</span>.<span>Precision</span>)</td>
      </tr>
      <tr>
        <td id="L9843" data-line-number="9843"></td>
        <td id="LC9843">                                            {</td>
      </tr>
      <tr>
        <td id="L9844" data-line-number="9844"></td>
        <td id="LC9844">                                                <span>throw</span> <span>ADP</span>.<span>ParameterValueOutOfRange</span>((<span>Decimal</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L9845" data-line-number="9845"></td>
        <td id="LC9845">                                            }</td>
      </tr>
      <tr>
        <td id="L9846" data-line-number="9846"></td>
        <td id="LC9846">                                        }</td>
      </tr>
      <tr>
        <td id="L9847" data-line-number="9847"></td>
        <td id="LC9847">                                    }</td>
      </tr>
      <tr>
        <td id="L9848" data-line-number="9848"></td>
        <td id="LC9848">                                }</td>
      </tr>
      <tr>
        <td id="L9849" data-line-number="9849"></td>
        <td id="LC9849">                            }</td>
      </tr>
      <tr>
        <td id="L9850" data-line-number="9850"></td>
        <td id="LC9850">
</td>
      </tr>
      <tr>
        <td id="L9851" data-line-number="9851"></td>
        <td id="LC9851">                            <span>bool</span> <span>isParameterEncrypted</span> <span>=</span> <span>0</span> <span>!=</span> (<span>rpcext</span>.<span>paramoptions</span>[<span>i</span>] <span>&amp;</span> <span>TdsEnums</span>.<span>RPC_PARAM_ENCRYPTED</span>);</td>
      </tr>
      <tr>
        <td id="L9852" data-line-number="9852"></td>
        <td id="LC9852">
</td>
      </tr>
      <tr>
        <td id="L9853" data-line-number="9853"></td>
        <td id="LC9853">                            <span><span>//</span> Additional information we need to send over wire to the server when writing encrypted parameters.</span></td>
      </tr>
      <tr>
        <td id="L9854" data-line-number="9854"></td>
        <td id="LC9854">                            <span>SqlColumnEncryptionInputParameterInfo</span> <span>encryptedParameterInfoToWrite</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9855" data-line-number="9855"></td>
        <td id="LC9855">
</td>
      </tr>
      <tr>
        <td id="L9856" data-line-number="9856"></td>
        <td id="LC9856">                            <span><span>//</span> If the parameter is encrypted, we need to encrypt the value.</span></td>
      </tr>
      <tr>
        <td id="L9857" data-line-number="9857"></td>
        <td id="LC9857">                            <span>if</span> (<span>isParameterEncrypted</span>)</td>
      </tr>
      <tr>
        <td id="L9858" data-line-number="9858"></td>
        <td id="LC9858">                            {</td>
      </tr>
      <tr>
        <td id="L9859" data-line-number="9859"></td>
        <td id="LC9859">                                <span>Debug</span>.<span>Assert</span>(<span>mt</span>.<span>TDSType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLVARIANT</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L9860" data-line-number="9860"></td>
        <td id="LC9860">                                    <span>mt</span>.<span>TDSType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLUDT</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L9861" data-line-number="9861"></td>
        <td id="LC9861">                                    <span>mt</span>.<span>TDSType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L9862" data-line-number="9862"></td>
        <td id="LC9862">                                    <span>mt</span>.<span>TDSType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLIMAGE</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L9863" data-line-number="9863"></td>
        <td id="LC9863">                                    <span>mt</span>.<span>TDSType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLTEXT</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L9864" data-line-number="9864"></td>
        <td id="LC9864">                                    <span>mt</span>.<span>TDSType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>, <span><span>"</span>Type unsupported for encryption<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9865" data-line-number="9865"></td>
        <td id="LC9865">
</td>
      </tr>
      <tr>
        <td id="L9866" data-line-number="9866"></td>
        <td id="LC9866">                                <span>byte</span>[] <span>serializedValue</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9867" data-line-number="9867"></td>
        <td id="LC9867">                                <span>byte</span>[] <span>encryptedValue</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9868" data-line-number="9868"></td>
        <td id="LC9868">
</td>
      </tr>
      <tr>
        <td id="L9869" data-line-number="9869"></td>
        <td id="LC9869">                                <span>if</span> (<span>!</span><span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L9870" data-line-number="9870"></td>
        <td id="LC9870">                                {</td>
      </tr>
      <tr>
        <td id="L9871" data-line-number="9871"></td>
        <td id="LC9871">                                    <span>try</span></td>
      </tr>
      <tr>
        <td id="L9872" data-line-number="9872"></td>
        <td id="LC9872">                                    {</td>
      </tr>
      <tr>
        <td id="L9873" data-line-number="9873"></td>
        <td id="LC9873">                                        <span>if</span> (<span>isSqlVal</span>)</td>
      </tr>
      <tr>
        <td id="L9874" data-line-number="9874"></td>
        <td id="LC9874">                                        {</td>
      </tr>
      <tr>
        <td id="L9875" data-line-number="9875"></td>
        <td id="LC9875">                                            <span>serializedValue</span> <span>=</span> <span>SerializeUnencryptedSqlValue</span>(<span>value</span>, <span>mt</span>, <span>actualSize</span>, <span>param</span>.<span>Offset</span>, <span>param</span>.<span>NormalizationRuleVersion</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9876" data-line-number="9876"></td>
        <td id="LC9876">                                        }</td>
      </tr>
      <tr>
        <td id="L9877" data-line-number="9877"></td>
        <td id="LC9877">                                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L9878" data-line-number="9878"></td>
        <td id="LC9878">                                        {</td>
      </tr>
      <tr>
        <td id="L9879" data-line-number="9879"></td>
        <td id="LC9879">                                            <span><span>//</span> for codePageEncoded types, WriteValue simply expects the number of characters</span></td>
      </tr>
      <tr>
        <td id="L9880" data-line-number="9880"></td>
        <td id="LC9880">                                            <span><span>//</span> For plp types, we also need the encoded byte size</span></td>
      </tr>
      <tr>
        <td id="L9881" data-line-number="9881"></td>
        <td id="LC9881">                                            <span>serializedValue</span> <span>=</span> <span>SerializeUnencryptedValue</span>(<span>value</span>, <span>mt</span>, <span>param</span>.<span>GetActualScale</span>(), <span>actualSize</span>, <span>param</span>.<span>Offset</span>, <span>isDataFeed</span>, <span>param</span>.<span>NormalizationRuleVersion</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9882" data-line-number="9882"></td>
        <td id="LC9882">                                        }</td>
      </tr>
      <tr>
        <td id="L9883" data-line-number="9883"></td>
        <td id="LC9883">
</td>
      </tr>
      <tr>
        <td id="L9884" data-line-number="9884"></td>
        <td id="LC9884">                                        <span>Debug</span>.<span>Assert</span>(<span>serializedValue</span> <span>!=</span> <span>null</span>, <span><span>"</span>serializedValue should not be null in TdsExecuteRPC.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9885" data-line-number="9885"></td>
        <td id="LC9885">                                        <span>encryptedValue</span> <span>=</span> <span>SqlSecurityUtility</span>.<span>EncryptWithKey</span>(<span>serializedValue</span>, <span>param</span>.<span>CipherMetadata</span>, <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>DataSource</span>);</td>
      </tr>
      <tr>
        <td id="L9886" data-line-number="9886"></td>
        <td id="LC9886">                                    }</td>
      </tr>
      <tr>
        <td id="L9887" data-line-number="9887"></td>
        <td id="LC9887">                                    <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L9888" data-line-number="9888"></td>
        <td id="LC9888">                                    {</td>
      </tr>
      <tr>
        <td id="L9889" data-line-number="9889"></td>
        <td id="LC9889">                                        <span>throw</span> <span>SQL</span>.<span>ParamEncryptionFailed</span>(<span>param</span>.<span>ParameterName</span>, <span>null</span>, <span>e</span>);</td>
      </tr>
      <tr>
        <td id="L9890" data-line-number="9890"></td>
        <td id="LC9890">                                    }</td>
      </tr>
      <tr>
        <td id="L9891" data-line-number="9891"></td>
        <td id="LC9891">
</td>
      </tr>
      <tr>
        <td id="L9892" data-line-number="9892"></td>
        <td id="LC9892">                                    <span>Debug</span>.<span>Assert</span>(<span>encryptedValue</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>encryptedValue</span>.<span>Length</span> <span>&gt;</span> <span>0</span>,</td>
      </tr>
      <tr>
        <td id="L9893" data-line-number="9893"></td>
        <td id="LC9893">                                        <span><span>"</span>encryptedValue should not be null or empty in TdsExecuteRPC.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9894" data-line-number="9894"></td>
        <td id="LC9894">                                }</td>
      </tr>
      <tr>
        <td id="L9895" data-line-number="9895"></td>
        <td id="LC9895">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L9896" data-line-number="9896"></td>
        <td id="LC9896">                                {</td>
      </tr>
      <tr>
        <td id="L9897" data-line-number="9897"></td>
        <td id="LC9897">                                    <span>encryptedValue</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L9898" data-line-number="9898"></td>
        <td id="LC9898">                                }</td>
      </tr>
      <tr>
        <td id="L9899" data-line-number="9899"></td>
        <td id="LC9899">
</td>
      </tr>
      <tr>
        <td id="L9900" data-line-number="9900"></td>
        <td id="LC9900">                                <span><span>//</span> Change the datatype to varbinary(max).</span></td>
      </tr>
      <tr>
        <td id="L9901" data-line-number="9901"></td>
        <td id="LC9901">                                <span><span>//</span> Since we don't know the size of the encrypted parameter on the server side, always set to (max).</span></td>
      </tr>
      <tr>
        <td id="L9902" data-line-number="9902"></td>
        <td id="LC9902">                                <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L9903" data-line-number="9903"></td>
        <td id="LC9903">                                <span>mt</span> <span>=</span> <span>MetaType</span>.<span>MetaMaxVarBinary</span>;</td>
      </tr>
      <tr>
        <td id="L9904" data-line-number="9904"></td>
        <td id="LC9904">                                <span>size</span> <span>=</span> <span>-</span><span>1</span>;</td>
      </tr>
      <tr>
        <td id="L9905" data-line-number="9905"></td>
        <td id="LC9905">                                <span>actualSize</span> <span>=</span> (<span>encryptedValue</span> <span>==</span> <span>null</span>) <span>?</span> <span>0</span> <span>:</span> <span>encryptedValue</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L9906" data-line-number="9906"></td>
        <td id="LC9906">
</td>
      </tr>
      <tr>
        <td id="L9907" data-line-number="9907"></td>
        <td id="LC9907">                                <span>encryptedParameterInfoToWrite</span> <span>=</span> <span>new</span> <span>SqlColumnEncryptionInputParameterInfo</span>(<span>param</span>.<span>GetMetadataForTypeInfo</span>(),</td>
      </tr>
      <tr>
        <td id="L9908" data-line-number="9908"></td>
        <td id="LC9908">                                                                                                          <span>param</span>.<span>CipherMetadata</span>);</td>
      </tr>
      <tr>
        <td id="L9909" data-line-number="9909"></td>
        <td id="LC9909">
</td>
      </tr>
      <tr>
        <td id="L9910" data-line-number="9910"></td>
        <td id="LC9910">                                <span><span>//</span> Set the value to the encrypted value and mark isSqlVal as false for VARBINARY encrypted value.</span></td>
      </tr>
      <tr>
        <td id="L9911" data-line-number="9911"></td>
        <td id="LC9911">                                <span>value</span> <span>=</span> <span>encryptedValue</span>;</td>
      </tr>
      <tr>
        <td id="L9912" data-line-number="9912"></td>
        <td id="LC9912">                                <span>isSqlVal</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L9913" data-line-number="9913"></td>
        <td id="LC9913">                            }</td>
      </tr>
      <tr>
        <td id="L9914" data-line-number="9914"></td>
        <td id="LC9914">
</td>
      </tr>
      <tr>
        <td id="L9915" data-line-number="9915"></td>
        <td id="LC9915">                            <span>Debug</span>.<span>Assert</span>(<span>isParameterEncrypted</span> <span>==</span> (<span>encryptedParameterInfoToWrite</span> <span>!=</span> <span>null</span>),</td>
      </tr>
      <tr>
        <td id="L9916" data-line-number="9916"></td>
        <td id="LC9916">                                              <span><span>"</span>encryptedParameterInfoToWrite can be not null if and only if isParameterEncrypted is true.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9917" data-line-number="9917"></td>
        <td id="LC9917">
</td>
      </tr>
      <tr>
        <td id="L9918" data-line-number="9918"></td>
        <td id="LC9918">                            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isSqlVal</span> <span>||</span> <span>!</span><span>isParameterEncrypted</span>, <span><span>"</span>isParameterEncrypted can be true only if isSqlVal is false.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9919" data-line-number="9919"></td>
        <td id="LC9919">
</td>
      </tr>
      <tr>
        <td id="L9920" data-line-number="9920"></td>
        <td id="LC9920">                            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L9921" data-line-number="9921"></td>
        <td id="LC9921">                            <span><span>//</span> fixup the types by using the NullableType property of the MetaType class</span></td>
      </tr>
      <tr>
        <td id="L9922" data-line-number="9922"></td>
        <td id="LC9922">                            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L9923" data-line-number="9923"></td>
        <td id="LC9923">                            <span><span>//</span> following rules should be followed based on feedback from the M-SQL team</span></td>
      </tr>
      <tr>
        <td id="L9924" data-line-number="9924"></td>
        <td id="LC9924">                            <span><span>//</span> 1) always use the BIG* types (ex: instead of SQLCHAR use SQLBIGCHAR)</span></td>
      </tr>
      <tr>
        <td id="L9925" data-line-number="9925"></td>
        <td id="LC9925">                            <span><span>//</span> 2) always use nullable types (ex: instead of SQLINT use SQLINTN)</span></td>
      </tr>
      <tr>
        <td id="L9926" data-line-number="9926"></td>
        <td id="LC9926">                            <span><span>//</span> 3) DECIMALN should always be sent as NUMERICN</span></td>
      </tr>
      <tr>
        <td id="L9927" data-line-number="9927"></td>
        <td id="LC9927">                            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L9928" data-line-number="9928"></td>
        <td id="LC9928">                            <span>stateObj</span>.<span>WriteByte</span>(<span>mt</span>.<span>NullableType</span>);</td>
      </tr>
      <tr>
        <td id="L9929" data-line-number="9929"></td>
        <td id="LC9929">
</td>
      </tr>
      <tr>
        <td id="L9930" data-line-number="9930"></td>
        <td id="LC9930">                            <span><span>//</span> handle variants here: the SQLVariant writing routine will write the maxlen and actual len columns</span></td>
      </tr>
      <tr>
        <td id="L9931" data-line-number="9931"></td>
        <td id="LC9931">                            <span>if</span> (<span>mt</span>.<span>TDSType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLVARIANT</span>)</td>
      </tr>
      <tr>
        <td id="L9932" data-line-number="9932"></td>
        <td id="LC9932">                            {</td>
      </tr>
      <tr>
        <td id="L9933" data-line-number="9933"></td>
        <td id="LC9933">                                <span><span>//</span> devnote: Do we ever hit this codepath? Yes, when a null value is being writen out via a sql variant</span></td>
      </tr>
      <tr>
        <td id="L9934" data-line-number="9934"></td>
        <td id="LC9934">                                <span><span>//</span> param.GetActualSize is not used</span></td>
      </tr>
      <tr>
        <td id="L9935" data-line-number="9935"></td>
        <td id="LC9935">                                <span>WriteSqlVariantValue</span>(<span>isSqlVal</span> <span>?</span> <span>MetaType</span>.<span>GetComValueFromSqlVariant</span>(<span>value</span>) <span>:</span> <span>value</span>, <span>param</span>.<span>GetActualSize</span>(), <span>param</span>.<span>Offset</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9936" data-line-number="9936"></td>
        <td id="LC9936">                                <span>continue</span>;</td>
      </tr>
      <tr>
        <td id="L9937" data-line-number="9937"></td>
        <td id="LC9937">                            }</td>
      </tr>
      <tr>
        <td id="L9938" data-line-number="9938"></td>
        <td id="LC9938">
</td>
      </tr>
      <tr>
        <td id="L9939" data-line-number="9939"></td>
        <td id="LC9939">                            <span>int</span> <span>codePageByteSize</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9940" data-line-number="9940"></td>
        <td id="LC9940">                            <span>int</span> <span>maxsize</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L9941" data-line-number="9941"></td>
        <td id="LC9941">
</td>
      </tr>
      <tr>
        <td id="L9942" data-line-number="9942"></td>
        <td id="LC9942">                            <span>if</span> (<span>mt</span>.<span>IsAnsiType</span>)</td>
      </tr>
      <tr>
        <td id="L9943" data-line-number="9943"></td>
        <td id="LC9943">                            {</td>
      </tr>
      <tr>
        <td id="L9944" data-line-number="9944"></td>
        <td id="LC9944">                                <span><span>//</span> Avoid the following code block if ANSI but unfilled LazyMat blob</span></td>
      </tr>
      <tr>
        <td id="L9945" data-line-number="9945"></td>
        <td id="LC9945">                                <span>if</span> ((<span>!</span><span>isNull</span>) <span>&amp;&amp;</span> (<span>!</span><span>isDataFeed</span>))</td>
      </tr>
      <tr>
        <td id="L9946" data-line-number="9946"></td>
        <td id="LC9946">                                {</td>
      </tr>
      <tr>
        <td id="L9947" data-line-number="9947"></td>
        <td id="LC9947">                                    <span>string</span> <span>s</span>;</td>
      </tr>
      <tr>
        <td id="L9948" data-line-number="9948"></td>
        <td id="LC9948">
</td>
      </tr>
      <tr>
        <td id="L9949" data-line-number="9949"></td>
        <td id="LC9949">                                    <span>if</span> (<span>isSqlVal</span>)</td>
      </tr>
      <tr>
        <td id="L9950" data-line-number="9950"></td>
        <td id="LC9950">                                    {</td>
      </tr>
      <tr>
        <td id="L9951" data-line-number="9951"></td>
        <td id="LC9951">                                        <span>if</span> (<span>value</span> <span>is</span> <span>SqlString</span>)</td>
      </tr>
      <tr>
        <td id="L9952" data-line-number="9952"></td>
        <td id="LC9952">                                        {</td>
      </tr>
      <tr>
        <td id="L9953" data-line-number="9953"></td>
        <td id="LC9953">                                            <span>s</span> <span>=</span> ((<span>SqlString</span>)<span>value</span>).<span>Value</span>;</td>
      </tr>
      <tr>
        <td id="L9954" data-line-number="9954"></td>
        <td id="LC9954">                                        }</td>
      </tr>
      <tr>
        <td id="L9955" data-line-number="9955"></td>
        <td id="LC9955">                                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L9956" data-line-number="9956"></td>
        <td id="LC9956">                                        {</td>
      </tr>
      <tr>
        <td id="L9957" data-line-number="9957"></td>
        <td id="LC9957">                                            <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>, <span><span>"</span>Unknown value for Ansi datatype<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L9958" data-line-number="9958"></td>
        <td id="LC9958">                                            <span>s</span> <span>=</span> <span>new</span> <span>String</span>(((<span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)<span>value</span>).<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L9959" data-line-number="9959"></td>
        <td id="LC9959">                                        }</td>
      </tr>
      <tr>
        <td id="L9960" data-line-number="9960"></td>
        <td id="LC9960">                                    }</td>
      </tr>
      <tr>
        <td id="L9961" data-line-number="9961"></td>
        <td id="LC9961">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L9962" data-line-number="9962"></td>
        <td id="LC9962">                                    {</td>
      </tr>
      <tr>
        <td id="L9963" data-line-number="9963"></td>
        <td id="LC9963">                                        <span>s</span> <span>=</span> (<span>string</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L9964" data-line-number="9964"></td>
        <td id="LC9964">                                    }</td>
      </tr>
      <tr>
        <td id="L9965" data-line-number="9965"></td>
        <td id="LC9965">
</td>
      </tr>
      <tr>
        <td id="L9966" data-line-number="9966"></td>
        <td id="LC9966">                                    <span>codePageByteSize</span> <span>=</span> <span>GetEncodingCharLength</span>(<span>s</span>, <span>actualSize</span>, <span>param</span>.<span>Offset</span>, <span>_defaultEncoding</span>);</td>
      </tr>
      <tr>
        <td id="L9967" data-line-number="9967"></td>
        <td id="LC9967">                                }</td>
      </tr>
      <tr>
        <td id="L9968" data-line-number="9968"></td>
        <td id="LC9968">
</td>
      </tr>
      <tr>
        <td id="L9969" data-line-number="9969"></td>
        <td id="LC9969">                                <span>if</span> (<span>mt</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L9970" data-line-number="9970"></td>
        <td id="LC9970">                                {</td>
      </tr>
      <tr>
        <td id="L9971" data-line-number="9971"></td>
        <td id="LC9971">                                    <span>WriteShort</span>(<span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9972" data-line-number="9972"></td>
        <td id="LC9972">                                }</td>
      </tr>
      <tr>
        <td id="L9973" data-line-number="9973"></td>
        <td id="LC9973">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L9974" data-line-number="9974"></td>
        <td id="LC9974">                                {</td>
      </tr>
      <tr>
        <td id="L9975" data-line-number="9975"></td>
        <td id="LC9975">                                    <span>maxsize</span> <span>=</span> (<span>size</span> <span>&gt;</span> <span>codePageByteSize</span>) <span>?</span> <span>size</span> <span>:</span> <span>codePageByteSize</span>;</td>
      </tr>
      <tr>
        <td id="L9976" data-line-number="9976"></td>
        <td id="LC9976">                                    <span>if</span> (<span>maxsize</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L9977" data-line-number="9977"></td>
        <td id="LC9977">                                    {</td>
      </tr>
      <tr>
        <td id="L9978" data-line-number="9978"></td>
        <td id="LC9978">                                        <span><span>//</span> Yukon doesn't like 0 as MaxSize. Change it to 2 for unicode types (SQL9 - 682322)</span></td>
      </tr>
      <tr>
        <td id="L9979" data-line-number="9979"></td>
        <td id="LC9979">                                        <span>if</span> (<span>mt</span>.<span>IsNCharType</span>)</td>
      </tr>
      <tr>
        <td id="L9980" data-line-number="9980"></td>
        <td id="LC9980">                                            <span>maxsize</span> <span>=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L9981" data-line-number="9981"></td>
        <td id="LC9981">                                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L9982" data-line-number="9982"></td>
        <td id="LC9982">                                            <span>maxsize</span> <span>=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L9983" data-line-number="9983"></td>
        <td id="LC9983">                                    }</td>
      </tr>
      <tr>
        <td id="L9984" data-line-number="9984"></td>
        <td id="LC9984">
</td>
      </tr>
      <tr>
        <td id="L9985" data-line-number="9985"></td>
        <td id="LC9985">                                    <span>WriteParameterVarLen</span>(<span>mt</span>, <span>maxsize</span>, <span>false</span><span><span>/*</span>IsNull<span>*/</span></span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L9986" data-line-number="9986"></td>
        <td id="LC9986">                                }</td>
      </tr>
      <tr>
        <td id="L9987" data-line-number="9987"></td>
        <td id="LC9987">                            }</td>
      </tr>
      <tr>
        <td id="L9988" data-line-number="9988"></td>
        <td id="LC9988">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L9989" data-line-number="9989"></td>
        <td id="LC9989">                            {</td>
      </tr>
      <tr>
        <td id="L9990" data-line-number="9990"></td>
        <td id="LC9990">                                <span><span>//</span> If type timestamp - treat as fixed type and always send over timestamp length, which is 8.</span></td>
      </tr>
      <tr>
        <td id="L9991" data-line-number="9991"></td>
        <td id="LC9991">                                <span><span>//</span> For fixed types, we either send null or fixed length for type length.  We want to match that</span></td>
      </tr>
      <tr>
        <td id="L9992" data-line-number="9992"></td>
        <td id="LC9992">                                <span><span>//</span> behavior for timestamps.  However, in the case of null, we still must send 8 because if we</span></td>
      </tr>
      <tr>
        <td id="L9993" data-line-number="9993"></td>
        <td id="LC9993">                                <span><span>//</span> send null we will not receive a output val.  You can send null for fixed types and still</span></td>
      </tr>
      <tr>
        <td id="L9994" data-line-number="9994"></td>
        <td id="LC9994">                                <span><span>//</span> receive a output value, but not for variable types.  So, always send 8 for timestamp because</span></td>
      </tr>
      <tr>
        <td id="L9995" data-line-number="9995"></td>
        <td id="LC9995">                                <span><span>//</span> while the user sees it as a fixed type, we are actually representing it as a bigbinary which</span></td>
      </tr>
      <tr>
        <td id="L9996" data-line-number="9996"></td>
        <td id="LC9996">                                <span><span>//</span> is variable.</span></td>
      </tr>
      <tr>
        <td id="L9997" data-line-number="9997"></td>
        <td id="LC9997">                                <span>if</span> (<span>mt</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>Timestamp</span>)</td>
      </tr>
      <tr>
        <td id="L9998" data-line-number="9998"></td>
        <td id="LC9998">                                {</td>
      </tr>
      <tr>
        <td id="L9999" data-line-number="9999"></td>
        <td id="LC9999">                                    <span>WriteParameterVarLen</span>(<span>mt</span>, <span>TdsEnums</span>.<span>TEXT_TIME_STAMP_LEN</span>, <span>false</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10000" data-line-number="10000"></td>
        <td id="LC10000">                                }</td>
      </tr>
      <tr>
        <td id="L10001" data-line-number="10001"></td>
        <td id="LC10001">                                <span>else</span> <span>if</span> (<span>mt</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>Udt</span>)</td>
      </tr>
      <tr>
        <td id="L10002" data-line-number="10002"></td>
        <td id="LC10002">                                {</td>
      </tr>
      <tr>
        <td id="L10003" data-line-number="10003"></td>
        <td id="LC10003">                                    <span>byte</span>[] <span>udtVal</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10004" data-line-number="10004"></td>
        <td id="LC10004">                                    <span>Format</span> <span>format</span> <span>=</span> <span>Format</span>.<span>Native</span>;</td>
      </tr>
      <tr>
        <td id="L10005" data-line-number="10005"></td>
        <td id="LC10005">
</td>
      </tr>
      <tr>
        <td id="L10006" data-line-number="10006"></td>
        <td id="LC10006">                                    <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>Invalid DataType UDT for non-Yukon or later server!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10007" data-line-number="10007"></td>
        <td id="LC10007">
</td>
      </tr>
      <tr>
        <td id="L10008" data-line-number="10008"></td>
        <td id="LC10008">                                    <span>if</span> (<span>!</span><span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L10009" data-line-number="10009"></td>
        <td id="LC10009">                                    {</td>
      </tr>
      <tr>
        <td id="L10010" data-line-number="10010"></td>
        <td id="LC10010">                                        <span><span>//</span> When writing UDT parameter values to the TDS stream, allow sending byte[] or SqlBytes</span></td>
      </tr>
      <tr>
        <td id="L10011" data-line-number="10011"></td>
        <td id="LC10011">                                        <span><span>//</span> directly to the server and not rejected as invalid. This allows users to handle</span></td>
      </tr>
      <tr>
        <td id="L10012" data-line-number="10012"></td>
        <td id="LC10012">                                        <span><span>//</span> serialization and deserialization logic without having to have SqlClient be aware of</span></td>
      </tr>
      <tr>
        <td id="L10013" data-line-number="10013"></td>
        <td id="LC10013">                                        <span><span>//</span> the types and without using inefficient text representations.</span></td>
      </tr>
      <tr>
        <td id="L10014" data-line-number="10014"></td>
        <td id="LC10014">                                        <span>if</span> (<span>value</span> <span>is</span> <span>byte</span>[] <span>rawBytes</span>)</td>
      </tr>
      <tr>
        <td id="L10015" data-line-number="10015"></td>
        <td id="LC10015">                                        {</td>
      </tr>
      <tr>
        <td id="L10016" data-line-number="10016"></td>
        <td id="LC10016">                                            <span>udtVal</span> <span>=</span> <span>rawBytes</span>;</td>
      </tr>
      <tr>
        <td id="L10017" data-line-number="10017"></td>
        <td id="LC10017">                                        }</td>
      </tr>
      <tr>
        <td id="L10018" data-line-number="10018"></td>
        <td id="LC10018">                                        <span>else</span> <span>if</span> (<span>value</span> <span>is</span> <span>SqlBytes</span> <span>sqlBytes</span>)</td>
      </tr>
      <tr>
        <td id="L10019" data-line-number="10019"></td>
        <td id="LC10019">                                        {</td>
      </tr>
      <tr>
        <td id="L10020" data-line-number="10020"></td>
        <td id="LC10020">                                            <span>switch</span> (<span>sqlBytes</span>.<span>Storage</span>)</td>
      </tr>
      <tr>
        <td id="L10021" data-line-number="10021"></td>
        <td id="LC10021">                                            {</td>
      </tr>
      <tr>
        <td id="L10022" data-line-number="10022"></td>
        <td id="LC10022">                                                <span>case</span> <span>StorageState</span>.<span>Buffer</span>:</td>
      </tr>
      <tr>
        <td id="L10023" data-line-number="10023"></td>
        <td id="LC10023">                                                    <span><span>//</span> use the buffer directly, the only way to create it is with the correctly sized byte array</span></td>
      </tr>
      <tr>
        <td id="L10024" data-line-number="10024"></td>
        <td id="LC10024">                                                    <span>udtVal</span> <span>=</span> <span>sqlBytes</span>.<span>Buffer</span>;</td>
      </tr>
      <tr>
        <td id="L10025" data-line-number="10025"></td>
        <td id="LC10025">                                                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10026" data-line-number="10026"></td>
        <td id="LC10026">                                                <span>case</span> <span>StorageState</span>.<span>Stream</span>:</td>
      </tr>
      <tr>
        <td id="L10027" data-line-number="10027"></td>
        <td id="LC10027">                                                <span>case</span> <span>StorageState</span>.<span>UnmanagedBuffer</span>:</td>
      </tr>
      <tr>
        <td id="L10028" data-line-number="10028"></td>
        <td id="LC10028">                                                    <span><span>//</span> allocate a new byte array to store the data</span></td>
      </tr>
      <tr>
        <td id="L10029" data-line-number="10029"></td>
        <td id="LC10029">                                                    <span>udtVal</span> <span>=</span> <span>sqlBytes</span>.<span>Value</span>;</td>
      </tr>
      <tr>
        <td id="L10030" data-line-number="10030"></td>
        <td id="LC10030">                                                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10031" data-line-number="10031"></td>
        <td id="LC10031">                                            }</td>
      </tr>
      <tr>
        <td id="L10032" data-line-number="10032"></td>
        <td id="LC10032">                                        }</td>
      </tr>
      <tr>
        <td id="L10033" data-line-number="10033"></td>
        <td id="LC10033">                                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L10034" data-line-number="10034"></td>
        <td id="LC10034">                                        {</td>
      </tr>
      <tr>
        <td id="L10035" data-line-number="10035"></td>
        <td id="LC10035">                                            <span>udtVal</span> <span>=</span> <span>_connHandler</span>.<span>Connection</span>.<span>GetBytes</span>(<span>value</span>, <span>out</span> <span>format</span>, <span>out</span> <span>maxsize</span>);</td>
      </tr>
      <tr>
        <td id="L10036" data-line-number="10036"></td>
        <td id="LC10036">                                        }</td>
      </tr>
      <tr>
        <td id="L10037" data-line-number="10037"></td>
        <td id="LC10037">
</td>
      </tr>
      <tr>
        <td id="L10038" data-line-number="10038"></td>
        <td id="LC10038">                                        <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>!=</span> <span>udtVal</span>, <span><span>"</span>GetBytes returned null instance. Make sure that it always returns non-null value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10039" data-line-number="10039"></td>
        <td id="LC10039">                                        <span>size</span> <span>=</span> <span>udtVal</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L10040" data-line-number="10040"></td>
        <td id="LC10040">
</td>
      </tr>
      <tr>
        <td id="L10041" data-line-number="10041"></td>
        <td id="LC10041">                                        <span><span>//</span>it may be legitimate, but we dont support it yet</span></td>
      </tr>
      <tr>
        <td id="L10042" data-line-number="10042"></td>
        <td id="LC10042">                                        <span>if</span> (<span>size</span> <span>&lt;</span> <span>0</span> <span>||</span> (<span>size</span> <span>&gt;=</span> <span>UInt16</span>.<span>MaxValue</span> <span>&amp;&amp;</span> <span>maxsize</span> <span>!=</span> <span>-</span><span>1</span>))</td>
      </tr>
      <tr>
        <td id="L10043" data-line-number="10043"></td>
        <td id="LC10043">                                            <span>throw</span> <span>new</span> <span>IndexOutOfRangeException</span>();</td>
      </tr>
      <tr>
        <td id="L10044" data-line-number="10044"></td>
        <td id="LC10044">                                    }</td>
      </tr>
      <tr>
        <td id="L10045" data-line-number="10045"></td>
        <td id="LC10045">
</td>
      </tr>
      <tr>
        <td id="L10046" data-line-number="10046"></td>
        <td id="LC10046">                                    <span><span>//</span>if this is NULL value, write special null value</span></td>
      </tr>
      <tr>
        <td id="L10047" data-line-number="10047"></td>
        <td id="LC10047">                                    <span>byte</span>[] <span>lenBytes</span> <span>=</span> <span>BitConverter</span>.<span>GetBytes</span>((<span>Int64</span>)<span>size</span>);</td>
      </tr>
      <tr>
        <td id="L10048" data-line-number="10048"></td>
        <td id="LC10048">
</td>
      </tr>
      <tr>
        <td id="L10049" data-line-number="10049"></td>
        <td id="LC10049">                                    <span>if</span> (<span>ADP</span>.<span>IsEmpty</span>(<span>param</span>.<span>UdtTypeName</span>))</td>
      </tr>
      <tr>
        <td id="L10050" data-line-number="10050"></td>
        <td id="LC10050">                                        <span>throw</span> <span>SQL</span>.<span>MustSetUdtTypeNameForUdtParams</span>();</td>
      </tr>
      <tr>
        <td id="L10051" data-line-number="10051"></td>
        <td id="LC10051">
</td>
      </tr>
      <tr>
        <td id="L10052" data-line-number="10052"></td>
        <td id="LC10052">                                    <span><span>//</span> Split the input name. TypeName is returned as single 3 part name during DeriveParameters.</span></td>
      </tr>
      <tr>
        <td id="L10053" data-line-number="10053"></td>
        <td id="LC10053">                                    <span><span>//</span> NOTE: ParseUdtTypeName throws if format is incorrect</span></td>
      </tr>
      <tr>
        <td id="L10054" data-line-number="10054"></td>
        <td id="LC10054">                                    <span>String</span>[] <span>names</span> <span>=</span> <span>SqlParameter</span>.<span>ParseTypeName</span>(<span>param</span>.<span>UdtTypeName</span>, <span>true</span> <span><span>/*</span> is UdtTypeName <span>*/</span></span>);</td>
      </tr>
      <tr>
        <td id="L10055" data-line-number="10055"></td>
        <td id="LC10055">                                    <span>if</span> (<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>names</span>[<span>0</span>]) <span>&amp;&amp;</span> <span>TdsEnums</span>.<span>MAX_SERVERNAME</span> <span>&lt;</span> <span>names</span>[<span>0</span>].<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L10056" data-line-number="10056"></td>
        <td id="LC10056">                                    {</td>
      </tr>
      <tr>
        <td id="L10057" data-line-number="10057"></td>
        <td id="LC10057">                                        <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span><span>"</span>names<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10058" data-line-number="10058"></td>
        <td id="LC10058">                                    }</td>
      </tr>
      <tr>
        <td id="L10059" data-line-number="10059"></td>
        <td id="LC10059">                                    <span>if</span> (<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>names</span>[<span>1</span>]) <span>&amp;&amp;</span> <span>TdsEnums</span>.<span>MAX_SERVERNAME</span> <span>&lt;</span> <span>names</span>[<span>names</span>.<span>Length</span> <span>-</span> <span>2</span>].<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L10060" data-line-number="10060"></td>
        <td id="LC10060">                                    {</td>
      </tr>
      <tr>
        <td id="L10061" data-line-number="10061"></td>
        <td id="LC10061">                                        <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span><span>"</span>names<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10062" data-line-number="10062"></td>
        <td id="LC10062">                                    }</td>
      </tr>
      <tr>
        <td id="L10063" data-line-number="10063"></td>
        <td id="LC10063">                                    <span>if</span> (<span>TdsEnums</span>.<span>MAX_SERVERNAME</span> <span>&lt;</span> <span>names</span>[<span>2</span>].<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L10064" data-line-number="10064"></td>
        <td id="LC10064">                                    {</td>
      </tr>
      <tr>
        <td id="L10065" data-line-number="10065"></td>
        <td id="LC10065">                                        <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span><span>"</span>names<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10066" data-line-number="10066"></td>
        <td id="LC10066">                                    }</td>
      </tr>
      <tr>
        <td id="L10067" data-line-number="10067"></td>
        <td id="LC10067">
</td>
      </tr>
      <tr>
        <td id="L10068" data-line-number="10068"></td>
        <td id="LC10068">                                    <span>WriteUDTMetaData</span>(<span>value</span>, <span>names</span>[<span>0</span>], <span>names</span>[<span>1</span>], <span>names</span>[<span>2</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10069" data-line-number="10069"></td>
        <td id="LC10069">
</td>
      </tr>
      <tr>
        <td id="L10070" data-line-number="10070"></td>
        <td id="LC10070">                                    <span><span>//</span> UNDONE - re-org to use code below to write value!</span></td>
      </tr>
      <tr>
        <td id="L10071" data-line-number="10071"></td>
        <td id="LC10071">                                    <span>if</span> (<span>!</span><span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L10072" data-line-number="10072"></td>
        <td id="LC10072">                                    {</td>
      </tr>
      <tr>
        <td id="L10073" data-line-number="10073"></td>
        <td id="LC10073">                                        <span>WriteUnsignedLong</span>((<span>ulong</span>)<span>udtVal</span>.<span>Length</span>, <span>stateObj</span>); <span><span>//</span> PLP length</span></td>
      </tr>
      <tr>
        <td id="L10074" data-line-number="10074"></td>
        <td id="LC10074">                                        <span>if</span> (<span>udtVal</span>.<span>Length</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L10075" data-line-number="10075"></td>
        <td id="LC10075">                                        { <span><span>//</span> Only write chunk length if its value is greater than 0</span></td>
      </tr>
      <tr>
        <td id="L10076" data-line-number="10076"></td>
        <td id="LC10076">                                            <span>WriteInt</span>(<span>udtVal</span>.<span>Length</span>, <span>stateObj</span>);                  <span><span>//</span> Chunk length</span></td>
      </tr>
      <tr>
        <td id="L10077" data-line-number="10077"></td>
        <td id="LC10077">                                            <span>stateObj</span>.<span>WriteByteArray</span>(<span>udtVal</span>, <span>udtVal</span>.<span>Length</span>, <span>0</span>); <span><span>//</span> Value</span></td>
      </tr>
      <tr>
        <td id="L10078" data-line-number="10078"></td>
        <td id="LC10078">                                        }</td>
      </tr>
      <tr>
        <td id="L10079" data-line-number="10079"></td>
        <td id="LC10079">                                        <span>WriteInt</span>(<span>0</span>, <span>stateObj</span>);                              <span><span>//</span> Terminator</span></td>
      </tr>
      <tr>
        <td id="L10080" data-line-number="10080"></td>
        <td id="LC10080">                                    }</td>
      </tr>
      <tr>
        <td id="L10081" data-line-number="10081"></td>
        <td id="LC10081">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10082" data-line-number="10082"></td>
        <td id="LC10082">                                    {</td>
      </tr>
      <tr>
        <td id="L10083" data-line-number="10083"></td>
        <td id="LC10083">                                        <span>WriteUnsignedLong</span>(<span>TdsEnums</span>.<span>SQL_PLP_NULL</span>, <span>stateObj</span>); <span><span>//</span> PLP Null.</span></td>
      </tr>
      <tr>
        <td id="L10084" data-line-number="10084"></td>
        <td id="LC10084">                                    }</td>
      </tr>
      <tr>
        <td id="L10085" data-line-number="10085"></td>
        <td id="LC10085">                                    <span>continue</span>; <span><span>//</span> End of UDT - continue to next parameter.</span></td>
      </tr>
      <tr>
        <td id="L10086" data-line-number="10086"></td>
        <td id="LC10086">                                              <span><span>//</span> UNDONE - need to re-org not to continue at a later point in time.</span></td>
      </tr>
      <tr>
        <td id="L10087" data-line-number="10087"></td>
        <td id="LC10087">                                }</td>
      </tr>
      <tr>
        <td id="L10088" data-line-number="10088"></td>
        <td id="LC10088">                                <span>else</span> <span>if</span> (<span>mt</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L10089" data-line-number="10089"></td>
        <td id="LC10089">                                {</td>
      </tr>
      <tr>
        <td id="L10090" data-line-number="10090"></td>
        <td id="LC10090">                                    <span>if</span> (<span>mt</span>.<span>SqlDbType</span> <span>!=</span> <span>SqlDbType</span>.<span>Xml</span>)</td>
      </tr>
      <tr>
        <td id="L10091" data-line-number="10091"></td>
        <td id="LC10091">                                        <span>WriteShort</span>(<span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10092" data-line-number="10092"></td>
        <td id="LC10092">                                }</td>
      </tr>
      <tr>
        <td id="L10093" data-line-number="10093"></td>
        <td id="LC10093">                                <span>else</span> <span>if</span> ((<span>!</span><span>mt</span>.<span>IsVarTime</span>) <span>&amp;&amp;</span> (<span>mt</span>.<span>SqlDbType</span> <span>!=</span> <span>SqlDbType</span>.<span>Date</span>))</td>
      </tr>
      <tr>
        <td id="L10094" data-line-number="10094"></td>
        <td id="LC10094">                                {   <span><span>//</span> Time, Date, DateTime2, DateTimeoffset do not have the size written out</span></td>
      </tr>
      <tr>
        <td id="L10095" data-line-number="10095"></td>
        <td id="LC10095">                                    <span>maxsize</span> <span>=</span> (<span>size</span> <span>&gt;</span> <span>actualSize</span>) <span>?</span> <span>size</span> <span>:</span> <span>actualSize</span>;</td>
      </tr>
      <tr>
        <td id="L10096" data-line-number="10096"></td>
        <td id="LC10096">                                    <span>if</span> (<span>maxsize</span> <span>==</span> <span>0</span> <span>&amp;&amp;</span> <span>IsYukonOrNewer</span>)</td>
      </tr>
      <tr>
        <td id="L10097" data-line-number="10097"></td>
        <td id="LC10097">                                    {</td>
      </tr>
      <tr>
        <td id="L10098" data-line-number="10098"></td>
        <td id="LC10098">                                        <span><span>//</span> Yukon doesn't like 0 as MaxSize. Change it to 2 for unicode types (SQL9 - 682322)</span></td>
      </tr>
      <tr>
        <td id="L10099" data-line-number="10099"></td>
        <td id="LC10099">                                        <span>if</span> (<span>mt</span>.<span>IsNCharType</span>)</td>
      </tr>
      <tr>
        <td id="L10100" data-line-number="10100"></td>
        <td id="LC10100">                                            <span>maxsize</span> <span>=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L10101" data-line-number="10101"></td>
        <td id="LC10101">                                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L10102" data-line-number="10102"></td>
        <td id="LC10102">                                            <span>maxsize</span> <span>=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L10103" data-line-number="10103"></td>
        <td id="LC10103">                                    }</td>
      </tr>
      <tr>
        <td id="L10104" data-line-number="10104"></td>
        <td id="LC10104">
</td>
      </tr>
      <tr>
        <td id="L10105" data-line-number="10105"></td>
        <td id="LC10105">                                    <span>WriteParameterVarLen</span>(<span>mt</span>, <span>maxsize</span>, <span>false</span><span><span>/*</span>IsNull<span>*/</span></span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10106" data-line-number="10106"></td>
        <td id="LC10106">                                }</td>
      </tr>
      <tr>
        <td id="L10107" data-line-number="10107"></td>
        <td id="LC10107">                            }</td>
      </tr>
      <tr>
        <td id="L10108" data-line-number="10108"></td>
        <td id="LC10108">
</td>
      </tr>
      <tr>
        <td id="L10109" data-line-number="10109"></td>
        <td id="LC10109">                            <span><span>//</span> scale and precision are only relevant for numeric and decimal types</span></td>
      </tr>
      <tr>
        <td id="L10110" data-line-number="10110"></td>
        <td id="LC10110">                            <span>if</span> (<span>mt</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>Decimal</span>)</td>
      </tr>
      <tr>
        <td id="L10111" data-line-number="10111"></td>
        <td id="LC10111">                            {</td>
      </tr>
      <tr>
        <td id="L10112" data-line-number="10112"></td>
        <td id="LC10112">                                <span>if</span> (<span>0</span> <span>==</span> <span>precision</span>)</td>
      </tr>
      <tr>
        <td id="L10113" data-line-number="10113"></td>
        <td id="LC10113">                                {</td>
      </tr>
      <tr>
        <td id="L10114" data-line-number="10114"></td>
        <td id="LC10114">                                    <span>if</span> (<span>_isShiloh</span>)</td>
      </tr>
      <tr>
        <td id="L10115" data-line-number="10115"></td>
        <td id="LC10115">                                        <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>DEFAULT_NUMERIC_PRECISION</span>);</td>
      </tr>
      <tr>
        <td id="L10116" data-line-number="10116"></td>
        <td id="LC10116">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10117" data-line-number="10117"></td>
        <td id="LC10117">                                        <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SPHINX_DEFAULT_NUMERIC_PRECISION</span>);</td>
      </tr>
      <tr>
        <td id="L10118" data-line-number="10118"></td>
        <td id="LC10118">                                }</td>
      </tr>
      <tr>
        <td id="L10119" data-line-number="10119"></td>
        <td id="LC10119">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L10120" data-line-number="10120"></td>
        <td id="LC10120">                                    <span>stateObj</span>.<span>WriteByte</span>(<span>precision</span>);</td>
      </tr>
      <tr>
        <td id="L10121" data-line-number="10121"></td>
        <td id="LC10121">
</td>
      </tr>
      <tr>
        <td id="L10122" data-line-number="10122"></td>
        <td id="LC10122">                                <span>stateObj</span>.<span>WriteByte</span>(<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L10123" data-line-number="10123"></td>
        <td id="LC10123">                            }</td>
      </tr>
      <tr>
        <td id="L10124" data-line-number="10124"></td>
        <td id="LC10124">                            <span>else</span> <span>if</span> (<span>mt</span>.<span>IsVarTime</span>)</td>
      </tr>
      <tr>
        <td id="L10125" data-line-number="10125"></td>
        <td id="LC10125">                            {</td>
      </tr>
      <tr>
        <td id="L10126" data-line-number="10126"></td>
        <td id="LC10126">                                <span>stateObj</span>.<span>WriteByte</span>(<span>param</span>.<span>GetActualScale</span>());</td>
      </tr>
      <tr>
        <td id="L10127" data-line-number="10127"></td>
        <td id="LC10127">                            }</td>
      </tr>
      <tr>
        <td id="L10128" data-line-number="10128"></td>
        <td id="LC10128">
</td>
      </tr>
      <tr>
        <td id="L10129" data-line-number="10129"></td>
        <td id="LC10129">                            <span><span>//</span> write out collation or xml metadata</span></td>
      </tr>
      <tr>
        <td id="L10130" data-line-number="10130"></td>
        <td id="LC10130">
</td>
      </tr>
      <tr>
        <td id="L10131" data-line-number="10131"></td>
        <td id="LC10131">                            <span>if</span> (<span>_isYukon</span> <span>&amp;&amp;</span> (<span>mt</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>Xml</span>))</td>
      </tr>
      <tr>
        <td id="L10132" data-line-number="10132"></td>
        <td id="LC10132">                            {</td>
      </tr>
      <tr>
        <td id="L10133" data-line-number="10133"></td>
        <td id="LC10133">                                <span>if</span> (((<span>param</span>.<span>XmlSchemaCollectionDatabase</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (<span>param</span>.<span>XmlSchemaCollectionDatabase</span> <span>!=</span> <span>ADP</span>.<span>StrEmpty</span>)) <span>||</span></td>
      </tr>
      <tr>
        <td id="L10134" data-line-number="10134"></td>
        <td id="LC10134">                                    ((<span>param</span>.<span>XmlSchemaCollectionOwningSchema</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (<span>param</span>.<span>XmlSchemaCollectionOwningSchema</span> <span>!=</span> <span>ADP</span>.<span>StrEmpty</span>)) <span>||</span></td>
      </tr>
      <tr>
        <td id="L10135" data-line-number="10135"></td>
        <td id="LC10135">                                    ((<span>param</span>.<span>XmlSchemaCollectionName</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (<span>param</span>.<span>XmlSchemaCollectionName</span> <span>!=</span> <span>ADP</span>.<span>StrEmpty</span>)))</td>
      </tr>
      <tr>
        <td id="L10136" data-line-number="10136"></td>
        <td id="LC10136">                                {</td>
      </tr>
      <tr>
        <td id="L10137" data-line-number="10137"></td>
        <td id="LC10137">                                    <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>);   <span><span>//</span>Schema present flag</span></td>
      </tr>
      <tr>
        <td id="L10138" data-line-number="10138"></td>
        <td id="LC10138">
</td>
      </tr>
      <tr>
        <td id="L10139" data-line-number="10139"></td>
        <td id="LC10139">                                    <span>if</span> ((<span>param</span>.<span>XmlSchemaCollectionDatabase</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (<span>param</span>.<span>XmlSchemaCollectionDatabase</span> <span>!=</span> <span>ADP</span>.<span>StrEmpty</span>))</td>
      </tr>
      <tr>
        <td id="L10140" data-line-number="10140"></td>
        <td id="LC10140">                                    {</td>
      </tr>
      <tr>
        <td id="L10141" data-line-number="10141"></td>
        <td id="LC10141">                                        <span>tempLen</span> <span>=</span> (<span>param</span>.<span>XmlSchemaCollectionDatabase</span>).<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L10142" data-line-number="10142"></td>
        <td id="LC10142">                                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>tempLen</span>));</td>
      </tr>
      <tr>
        <td id="L10143" data-line-number="10143"></td>
        <td id="LC10143">                                        <span>WriteString</span>(<span>param</span>.<span>XmlSchemaCollectionDatabase</span>, <span>tempLen</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10144" data-line-number="10144"></td>
        <td id="LC10144">                                    }</td>
      </tr>
      <tr>
        <td id="L10145" data-line-number="10145"></td>
        <td id="LC10145">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10146" data-line-number="10146"></td>
        <td id="LC10146">                                    {</td>
      </tr>
      <tr>
        <td id="L10147" data-line-number="10147"></td>
        <td id="LC10147">                                        <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);       <span><span>//</span> No dbname</span></td>
      </tr>
      <tr>
        <td id="L10148" data-line-number="10148"></td>
        <td id="LC10148">                                    }</td>
      </tr>
      <tr>
        <td id="L10149" data-line-number="10149"></td>
        <td id="LC10149">
</td>
      </tr>
      <tr>
        <td id="L10150" data-line-number="10150"></td>
        <td id="LC10150">                                    <span>if</span> ((<span>param</span>.<span>XmlSchemaCollectionOwningSchema</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (<span>param</span>.<span>XmlSchemaCollectionOwningSchema</span> <span>!=</span> <span>ADP</span>.<span>StrEmpty</span>))</td>
      </tr>
      <tr>
        <td id="L10151" data-line-number="10151"></td>
        <td id="LC10151">                                    {</td>
      </tr>
      <tr>
        <td id="L10152" data-line-number="10152"></td>
        <td id="LC10152">                                        <span>tempLen</span> <span>=</span> (<span>param</span>.<span>XmlSchemaCollectionOwningSchema</span>).<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L10153" data-line-number="10153"></td>
        <td id="LC10153">                                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>tempLen</span>));</td>
      </tr>
      <tr>
        <td id="L10154" data-line-number="10154"></td>
        <td id="LC10154">                                        <span>WriteString</span>(<span>param</span>.<span>XmlSchemaCollectionOwningSchema</span>, <span>tempLen</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10155" data-line-number="10155"></td>
        <td id="LC10155">                                    }</td>
      </tr>
      <tr>
        <td id="L10156" data-line-number="10156"></td>
        <td id="LC10156">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10157" data-line-number="10157"></td>
        <td id="LC10157">                                    {</td>
      </tr>
      <tr>
        <td id="L10158" data-line-number="10158"></td>
        <td id="LC10158">                                        <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);      <span><span>//</span> no xml schema name</span></td>
      </tr>
      <tr>
        <td id="L10159" data-line-number="10159"></td>
        <td id="LC10159">                                    }</td>
      </tr>
      <tr>
        <td id="L10160" data-line-number="10160"></td>
        <td id="LC10160">                                    <span>if</span> ((<span>param</span>.<span>XmlSchemaCollectionName</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (<span>param</span>.<span>XmlSchemaCollectionName</span> <span>!=</span> <span>ADP</span>.<span>StrEmpty</span>))</td>
      </tr>
      <tr>
        <td id="L10161" data-line-number="10161"></td>
        <td id="LC10161">                                    {</td>
      </tr>
      <tr>
        <td id="L10162" data-line-number="10162"></td>
        <td id="LC10162">                                        <span>tempLen</span> <span>=</span> (<span>param</span>.<span>XmlSchemaCollectionName</span>).<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L10163" data-line-number="10163"></td>
        <td id="LC10163">                                        <span>WriteShort</span>((<span>short</span>)(<span>tempLen</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10164" data-line-number="10164"></td>
        <td id="LC10164">                                        <span>WriteString</span>(<span>param</span>.<span>XmlSchemaCollectionName</span>, <span>tempLen</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10165" data-line-number="10165"></td>
        <td id="LC10165">                                    }</td>
      </tr>
      <tr>
        <td id="L10166" data-line-number="10166"></td>
        <td id="LC10166">                                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10167" data-line-number="10167"></td>
        <td id="LC10167">                                    {</td>
      </tr>
      <tr>
        <td id="L10168" data-line-number="10168"></td>
        <td id="LC10168">                                        <span>WriteShort</span>(<span>0</span>, <span>stateObj</span>);       <span><span>//</span> No xml schema collection name</span></td>
      </tr>
      <tr>
        <td id="L10169" data-line-number="10169"></td>
        <td id="LC10169">                                    }</td>
      </tr>
      <tr>
        <td id="L10170" data-line-number="10170"></td>
        <td id="LC10170">
</td>
      </tr>
      <tr>
        <td id="L10171" data-line-number="10171"></td>
        <td id="LC10171">                                }</td>
      </tr>
      <tr>
        <td id="L10172" data-line-number="10172"></td>
        <td id="LC10172">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L10173" data-line-number="10173"></td>
        <td id="LC10173">                                {</td>
      </tr>
      <tr>
        <td id="L10174" data-line-number="10174"></td>
        <td id="LC10174">                                    <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);       <span><span>//</span> No schema</span></td>
      </tr>
      <tr>
        <td id="L10175" data-line-number="10175"></td>
        <td id="LC10175">                                }</td>
      </tr>
      <tr>
        <td id="L10176" data-line-number="10176"></td>
        <td id="LC10176">                            }</td>
      </tr>
      <tr>
        <td id="L10177" data-line-number="10177"></td>
        <td id="LC10177">                            <span>else</span> <span>if</span> (<span>_isShiloh</span> <span>&amp;&amp;</span> <span>mt</span>.<span>IsCharType</span>)</td>
      </tr>
      <tr>
        <td id="L10178" data-line-number="10178"></td>
        <td id="LC10178">                            {</td>
      </tr>
      <tr>
        <td id="L10179" data-line-number="10179"></td>
        <td id="LC10179">                                <span><span>//</span> if it is not supplied, simply write out our default collation, otherwise, write out the one attached to the parameter</span></td>
      </tr>
      <tr>
        <td id="L10180" data-line-number="10180"></td>
        <td id="LC10180">                                <span>SqlCollation</span> <span>outCollation</span> <span>=</span> (<span>param</span>.<span>Collation</span> <span>!=</span> <span>null</span>) <span>?</span> <span>param</span>.<span>Collation</span> <span>:</span> <span>_defaultCollation</span>;</td>
      </tr>
      <tr>
        <td id="L10181" data-line-number="10181"></td>
        <td id="LC10181">                                <span>Debug</span>.<span>Assert</span>(<span>_defaultCollation</span> <span>!=</span> <span>null</span>, <span><span>"</span>_defaultCollation is null!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10182" data-line-number="10182"></td>
        <td id="LC10182">
</td>
      </tr>
      <tr>
        <td id="L10183" data-line-number="10183"></td>
        <td id="LC10183">                                <span>WriteUnsignedInt</span>(<span>outCollation</span>.<span>info</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10184" data-line-number="10184"></td>
        <td id="LC10184">                                <span>stateObj</span>.<span>WriteByte</span>(<span>outCollation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L10185" data-line-number="10185"></td>
        <td id="LC10185">                            }</td>
      </tr>
      <tr>
        <td id="L10186" data-line-number="10186"></td>
        <td id="LC10186">
</td>
      </tr>
      <tr>
        <td id="L10187" data-line-number="10187"></td>
        <td id="LC10187">                            <span>if</span> (<span>0</span> <span>==</span> <span>codePageByteSize</span>)</td>
      </tr>
      <tr>
        <td id="L10188" data-line-number="10188"></td>
        <td id="LC10188">                                <span>WriteParameterVarLen</span>(<span>mt</span>, <span>actualSize</span>, <span>isNull</span>, <span>stateObj</span>, <span>isDataFeed</span>);</td>
      </tr>
      <tr>
        <td id="L10189" data-line-number="10189"></td>
        <td id="LC10189">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L10190" data-line-number="10190"></td>
        <td id="LC10190">                                <span>WriteParameterVarLen</span>(<span>mt</span>, <span>codePageByteSize</span>, <span>isNull</span>, <span>stateObj</span>, <span>isDataFeed</span>);</td>
      </tr>
      <tr>
        <td id="L10191" data-line-number="10191"></td>
        <td id="LC10191">
</td>
      </tr>
      <tr>
        <td id="L10192" data-line-number="10192"></td>
        <td id="LC10192">                            <span>Task</span> <span>writeParamTask</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10193" data-line-number="10193"></td>
        <td id="LC10193">                            <span><span>//</span> write the value now</span></td>
      </tr>
      <tr>
        <td id="L10194" data-line-number="10194"></td>
        <td id="LC10194">                            <span>if</span> (<span>!</span><span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L10195" data-line-number="10195"></td>
        <td id="LC10195">                            {</td>
      </tr>
      <tr>
        <td id="L10196" data-line-number="10196"></td>
        <td id="LC10196">                                <span>if</span> (<span>isSqlVal</span>)</td>
      </tr>
      <tr>
        <td id="L10197" data-line-number="10197"></td>
        <td id="LC10197">                                {</td>
      </tr>
      <tr>
        <td id="L10198" data-line-number="10198"></td>
        <td id="LC10198">                                    <span>writeParamTask</span> <span>=</span> <span>WriteSqlValue</span>(<span>value</span>, <span>mt</span>, <span>actualSize</span>, <span>codePageByteSize</span>, <span>param</span>.<span>Offset</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10199" data-line-number="10199"></td>
        <td id="LC10199">                                }</td>
      </tr>
      <tr>
        <td id="L10200" data-line-number="10200"></td>
        <td id="LC10200">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L10201" data-line-number="10201"></td>
        <td id="LC10201">                                {</td>
      </tr>
      <tr>
        <td id="L10202" data-line-number="10202"></td>
        <td id="LC10202">                                    <span><span>//</span> for codePageEncoded types, WriteValue simply expects the number of characters</span></td>
      </tr>
      <tr>
        <td id="L10203" data-line-number="10203"></td>
        <td id="LC10203">                                    <span><span>//</span> For plp types, we also need the encoded byte size</span></td>
      </tr>
      <tr>
        <td id="L10204" data-line-number="10204"></td>
        <td id="LC10204">                                    <span>writeParamTask</span> <span>=</span> <span>WriteValue</span>(<span>value</span>, <span>mt</span>, <span>isParameterEncrypted</span> <span>?</span> (<span>byte</span>)<span>0</span> <span>:</span> <span>param</span>.<span>GetActualScale</span>(), <span>actualSize</span>, <span>codePageByteSize</span>, <span>isParameterEncrypted</span> <span>?</span> <span>0</span> <span>:</span> <span>param</span>.<span>Offset</span>, <span>stateObj</span>, <span>isParameterEncrypted</span> <span>?</span> <span>0</span> <span>:</span> <span>param</span>.<span>Size</span>, <span>isDataFeed</span>);</td>
      </tr>
      <tr>
        <td id="L10205" data-line-number="10205"></td>
        <td id="LC10205">                                }</td>
      </tr>
      <tr>
        <td id="L10206" data-line-number="10206"></td>
        <td id="LC10206">                            }</td>
      </tr>
      <tr>
        <td id="L10207" data-line-number="10207"></td>
        <td id="LC10207">
</td>
      </tr>
      <tr>
        <td id="L10208" data-line-number="10208"></td>
        <td id="LC10208">                            <span><span>//</span> Send encryption metadata for encrypted parameters.</span></td>
      </tr>
      <tr>
        <td id="L10209" data-line-number="10209"></td>
        <td id="LC10209">                            <span>if</span> (<span>isParameterEncrypted</span>)</td>
      </tr>
      <tr>
        <td id="L10210" data-line-number="10210"></td>
        <td id="LC10210">                            {</td>
      </tr>
      <tr>
        <td id="L10211" data-line-number="10211"></td>
        <td id="LC10211">                                <span>writeParamTask</span> <span>=</span> <span>WriteEncryptionMetadata</span>(<span>writeParamTask</span>, <span>encryptedParameterInfoToWrite</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10212" data-line-number="10212"></td>
        <td id="LC10212">                            }</td>
      </tr>
      <tr>
        <td id="L10213" data-line-number="10213"></td>
        <td id="LC10213">
</td>
      </tr>
      <tr>
        <td id="L10214" data-line-number="10214"></td>
        <td id="LC10214">                            <span>if</span> (<span>!</span><span>sync</span>)</td>
      </tr>
      <tr>
        <td id="L10215" data-line-number="10215"></td>
        <td id="LC10215">                            {</td>
      </tr>
      <tr>
        <td id="L10216" data-line-number="10216"></td>
        <td id="LC10216">                                <span>if</span> (<span>writeParamTask</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10217" data-line-number="10217"></td>
        <td id="LC10217">                                {</td>
      </tr>
      <tr>
        <td id="L10218" data-line-number="10218"></td>
        <td id="LC10218">                                    <span>writeParamTask</span> <span>=</span> <span>stateObj</span>.<span>WaitForAccumulatedWrites</span>();</td>
      </tr>
      <tr>
        <td id="L10219" data-line-number="10219"></td>
        <td id="LC10219">                                }</td>
      </tr>
      <tr>
        <td id="L10220" data-line-number="10220"></td>
        <td id="LC10220">
</td>
      </tr>
      <tr>
        <td id="L10221" data-line-number="10221"></td>
        <td id="LC10221">                                <span>if</span> (<span>writeParamTask</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10222" data-line-number="10222"></td>
        <td id="LC10222">                                {</td>
      </tr>
      <tr>
        <td id="L10223" data-line-number="10223"></td>
        <td id="LC10223">                                    <span>Task</span> <span>task</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10224" data-line-number="10224"></td>
        <td id="LC10224">                                    <span>if</span> (<span>completion</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10225" data-line-number="10225"></td>
        <td id="LC10225">                                    {</td>
      </tr>
      <tr>
        <td id="L10226" data-line-number="10226"></td>
        <td id="LC10226">                                        <span>completion</span> <span>=</span> <span>new</span> <span>TaskCompletionSource</span>&lt;<span>object</span>&gt;();</td>
      </tr>
      <tr>
        <td id="L10227" data-line-number="10227"></td>
        <td id="LC10227">                                        <span>task</span> <span>=</span> <span>completion</span>.<span>Task</span>;</td>
      </tr>
      <tr>
        <td id="L10228" data-line-number="10228"></td>
        <td id="LC10228">                                    }</td>
      </tr>
      <tr>
        <td id="L10229" data-line-number="10229"></td>
        <td id="LC10229">
</td>
      </tr>
      <tr>
        <td id="L10230" data-line-number="10230"></td>
        <td id="LC10230">                                    <span>AsyncHelper</span>.<span>ContinueTask</span>(<span>writeParamTask</span>, <span>completion</span>,</td>
      </tr>
      <tr>
        <td id="L10231" data-line-number="10231"></td>
        <td id="LC10231">                                        () <span>=&gt;</span> <span>TdsExecuteRPC</span>(<span>cmd</span>, <span>rpcArray</span>, <span>timeout</span>, <span>inSchema</span>, <span>notificationRequest</span>, <span>stateObj</span>, <span>isCommandProc</span>, <span>sync</span>, <span>completion</span>,</td>
      </tr>
      <tr>
        <td id="L10232" data-line-number="10232"></td>
        <td id="LC10232">                                                              <span>startRpc</span>: <span>ii</span>, <span>startParam</span>: <span>i</span> <span>+</span> <span>1</span>),</td>
      </tr>
      <tr>
        <td id="L10233" data-line-number="10233"></td>
        <td id="LC10233">                                        <span>connectionToDoom</span>: <span>_connHandler</span>,</td>
      </tr>
      <tr>
        <td id="L10234" data-line-number="10234"></td>
        <td id="LC10234">                                        <span>onFailure</span>: <span>exc</span> <span>=&gt;</span> <span>TdsExecuteRPC_OnFailure</span>(<span>exc</span>, <span>stateObj</span>));</td>
      </tr>
      <tr>
        <td id="L10235" data-line-number="10235"></td>
        <td id="LC10235">
</td>
      </tr>
      <tr>
        <td id="L10236" data-line-number="10236"></td>
        <td id="LC10236">                                    <span><span>//</span> Take care of releasing the locks</span></td>
      </tr>
      <tr>
        <td id="L10237" data-line-number="10237"></td>
        <td id="LC10237">                                    <span>if</span> (<span>releaseConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L10238" data-line-number="10238"></td>
        <td id="LC10238">                                    {</td>
      </tr>
      <tr>
        <td id="L10239" data-line-number="10239"></td>
        <td id="LC10239">                                        <span>task</span>.<span>ContinueWith</span>(<span>_</span> <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="L10240" data-line-number="10240"></td>
        <td id="LC10240">                                        {</td>
      </tr>
      <tr>
        <td id="L10241" data-line-number="10241"></td>
        <td id="LC10241">                                            <span>_connHandler</span>.<span>_parserLock</span>.<span>Release</span>();</td>
      </tr>
      <tr>
        <td id="L10242" data-line-number="10242"></td>
        <td id="LC10242">                                        }, <span>TaskScheduler</span>.<span>Default</span>);</td>
      </tr>
      <tr>
        <td id="L10243" data-line-number="10243"></td>
        <td id="LC10243">                                        <span>releaseConnectionLock</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L10244" data-line-number="10244"></td>
        <td id="LC10244">                                    }</td>
      </tr>
      <tr>
        <td id="L10245" data-line-number="10245"></td>
        <td id="LC10245">
</td>
      </tr>
      <tr>
        <td id="L10246" data-line-number="10246"></td>
        <td id="LC10246">                                    <span>return</span> <span>task</span>;</td>
      </tr>
      <tr>
        <td id="L10247" data-line-number="10247"></td>
        <td id="LC10247">                                }</td>
      </tr>
      <tr>
        <td id="L10248" data-line-number="10248"></td>
        <td id="LC10248">                            }</td>
      </tr>
      <tr>
        <td id="L10249" data-line-number="10249"></td>
        <td id="LC10249">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10250" data-line-number="10250"></td>
        <td id="LC10250">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L10251" data-line-number="10251"></td>
        <td id="LC10251">                            {</td>
      </tr>
      <tr>
        <td id="L10252" data-line-number="10252"></td>
        <td id="LC10252">                                <span>Debug</span>.<span>Assert</span>(<span>writeParamTask</span> <span>==</span> <span>null</span>, <span><span>"</span>Should not have a task when executing sync<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10253" data-line-number="10253"></td>
        <td id="LC10253">                            }</td>
      </tr>
      <tr>
        <td id="L10254" data-line-number="10254"></td>
        <td id="LC10254">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L10255" data-line-number="10255"></td>
        <td id="LC10255">                        } <span><span>//</span> parameter for loop</span></td>
      </tr>
      <tr>
        <td id="L10256" data-line-number="10256"></td>
        <td id="LC10256">
</td>
      </tr>
      <tr>
        <td id="L10257" data-line-number="10257"></td>
        <td id="LC10257">                        <span><span>//</span> If this is not the last RPC we are sending, add the batch flag</span></td>
      </tr>
      <tr>
        <td id="L10258" data-line-number="10258"></td>
        <td id="LC10258">                        <span>if</span> (<span>ii</span> <span>&lt;</span> (<span>rpcArray</span>.<span>Length</span> <span>-</span> <span>1</span>))</td>
      </tr>
      <tr>
        <td id="L10259" data-line-number="10259"></td>
        <td id="LC10259">                        {</td>
      </tr>
      <tr>
        <td id="L10260" data-line-number="10260"></td>
        <td id="LC10260">                            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L10261" data-line-number="10261"></td>
        <td id="LC10261">                            {</td>
      </tr>
      <tr>
        <td id="L10262" data-line-number="10262"></td>
        <td id="LC10262">                                <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>YUKON_RPCBATCHFLAG</span>);</td>
      </tr>
      <tr>
        <td id="L10263" data-line-number="10263"></td>
        <td id="LC10263">
</td>
      </tr>
      <tr>
        <td id="L10264" data-line-number="10264"></td>
        <td id="LC10264">                            }</td>
      </tr>
      <tr>
        <td id="L10265" data-line-number="10265"></td>
        <td id="LC10265">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L10266" data-line-number="10266"></td>
        <td id="LC10266">                            {</td>
      </tr>
      <tr>
        <td id="L10267" data-line-number="10267"></td>
        <td id="LC10267">                                <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SHILOH_RPCBATCHFLAG</span>);</td>
      </tr>
      <tr>
        <td id="L10268" data-line-number="10268"></td>
        <td id="LC10268">                            }</td>
      </tr>
      <tr>
        <td id="L10269" data-line-number="10269"></td>
        <td id="LC10269">                        }</td>
      </tr>
      <tr>
        <td id="L10270" data-line-number="10270"></td>
        <td id="LC10270">                    } <span><span>//</span> rpc for loop</span></td>
      </tr>
      <tr>
        <td id="L10271" data-line-number="10271"></td>
        <td id="LC10271">
</td>
      </tr>
      <tr>
        <td id="L10272" data-line-number="10272"></td>
        <td id="LC10272">                    <span>Task</span> <span>execFlushTask</span> <span>=</span> <span>stateObj</span>.<span>ExecuteFlush</span>();</td>
      </tr>
      <tr>
        <td id="L10273" data-line-number="10273"></td>
        <td id="LC10273">                    <span>Debug</span>.<span>Assert</span>(<span>!</span><span>sync</span> <span>||</span> <span>execFlushTask</span> <span>==</span> <span>null</span>, <span><span>"</span>Should not get a task when executing sync<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10274" data-line-number="10274"></td>
        <td id="LC10274">                    <span>if</span> (<span>execFlushTask</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10275" data-line-number="10275"></td>
        <td id="LC10275">                    {</td>
      </tr>
      <tr>
        <td id="L10276" data-line-number="10276"></td>
        <td id="LC10276">                        <span>Task</span> <span>task</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10277" data-line-number="10277"></td>
        <td id="LC10277">
</td>
      </tr>
      <tr>
        <td id="L10278" data-line-number="10278"></td>
        <td id="LC10278">                        <span>if</span> (<span>completion</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10279" data-line-number="10279"></td>
        <td id="LC10279">                        {</td>
      </tr>
      <tr>
        <td id="L10280" data-line-number="10280"></td>
        <td id="LC10280">                            <span>completion</span> <span>=</span> <span>new</span> <span>TaskCompletionSource</span>&lt;<span>object</span>&gt;();</td>
      </tr>
      <tr>
        <td id="L10281" data-line-number="10281"></td>
        <td id="LC10281">                            <span>task</span> <span>=</span> <span>completion</span>.<span>Task</span>;</td>
      </tr>
      <tr>
        <td id="L10282" data-line-number="10282"></td>
        <td id="LC10282">                        }</td>
      </tr>
      <tr>
        <td id="L10283" data-line-number="10283"></td>
        <td id="LC10283">
</td>
      </tr>
      <tr>
        <td id="L10284" data-line-number="10284"></td>
        <td id="LC10284">                        <span>bool</span> <span>taskReleaseConnectionLock</span> <span>=</span> <span>releaseConnectionLock</span>;</td>
      </tr>
      <tr>
        <td id="L10285" data-line-number="10285"></td>
        <td id="LC10285">                        <span>execFlushTask</span>.<span>ContinueWith</span>(<span>tsk</span> <span>=&gt;</span> <span>ExecuteFlushTaskCallback</span>(<span>tsk</span>, <span>stateObj</span>, <span>completion</span>, <span>taskReleaseConnectionLock</span>), <span>TaskScheduler</span>.<span>Default</span>);</td>
      </tr>
      <tr>
        <td id="L10286" data-line-number="10286"></td>
        <td id="LC10286">
</td>
      </tr>
      <tr>
        <td id="L10287" data-line-number="10287"></td>
        <td id="LC10287">                        <span><span>//</span> ExecuteFlushTaskCallback will take care of the locks for us</span></td>
      </tr>
      <tr>
        <td id="L10288" data-line-number="10288"></td>
        <td id="LC10288">                        <span>releaseConnectionLock</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L10289" data-line-number="10289"></td>
        <td id="LC10289">
</td>
      </tr>
      <tr>
        <td id="L10290" data-line-number="10290"></td>
        <td id="LC10290">                        <span>return</span> <span>task</span>;</td>
      </tr>
      <tr>
        <td id="L10291" data-line-number="10291"></td>
        <td id="LC10291">                    }</td>
      </tr>
      <tr>
        <td id="L10292" data-line-number="10292"></td>
        <td id="LC10292">                }</td>
      </tr>
      <tr>
        <td id="L10293" data-line-number="10293"></td>
        <td id="LC10293">                <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L10294" data-line-number="10294"></td>
        <td id="LC10294">                {</td>
      </tr>
      <tr>
        <td id="L10295" data-line-number="10295"></td>
        <td id="LC10295">                    <span><span>//</span> UNDONE - should not be catching all exceptions!!!</span></td>
      </tr>
      <tr>
        <td id="L10296" data-line-number="10296"></td>
        <td id="LC10296">                    <span>if</span> (<span>!</span><span>ADP</span>.<span>IsCatchableExceptionType</span>(<span>e</span>))</td>
      </tr>
      <tr>
        <td id="L10297" data-line-number="10297"></td>
        <td id="LC10297">                    {</td>
      </tr>
      <tr>
        <td id="L10298" data-line-number="10298"></td>
        <td id="LC10298">                        <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10299" data-line-number="10299"></td>
        <td id="LC10299">                    }</td>
      </tr>
      <tr>
        <td id="L10300" data-line-number="10300"></td>
        <td id="LC10300">
</td>
      </tr>
      <tr>
        <td id="L10301" data-line-number="10301"></td>
        <td id="LC10301">                    <span>FailureCleanup</span>(<span>stateObj</span>, <span>e</span>);</td>
      </tr>
      <tr>
        <td id="L10302" data-line-number="10302"></td>
        <td id="LC10302">
</td>
      </tr>
      <tr>
        <td id="L10303" data-line-number="10303"></td>
        <td id="LC10303">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10304" data-line-number="10304"></td>
        <td id="LC10304">                }</td>
      </tr>
      <tr>
        <td id="L10305" data-line-number="10305"></td>
        <td id="LC10305">                <span>FinalizeExecuteRPC</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10306" data-line-number="10306"></td>
        <td id="LC10306">                <span>if</span> (<span>completion</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10307" data-line-number="10307"></td>
        <td id="LC10307">                {</td>
      </tr>
      <tr>
        <td id="L10308" data-line-number="10308"></td>
        <td id="LC10308">                    <span>completion</span>.<span>SetResult</span>(<span>null</span>);</td>
      </tr>
      <tr>
        <td id="L10309" data-line-number="10309"></td>
        <td id="LC10309">                }</td>
      </tr>
      <tr>
        <td id="L10310" data-line-number="10310"></td>
        <td id="LC10310">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10311" data-line-number="10311"></td>
        <td id="LC10311">            }</td>
      </tr>
      <tr>
        <td id="L10312" data-line-number="10312"></td>
        <td id="LC10312">            <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L10313" data-line-number="10313"></td>
        <td id="LC10313">            {</td>
      </tr>
      <tr>
        <td id="L10314" data-line-number="10314"></td>
        <td id="LC10314">                <span>FinalizeExecuteRPC</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10315" data-line-number="10315"></td>
        <td id="LC10315">                <span>if</span> (<span>completion</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10316" data-line-number="10316"></td>
        <td id="LC10316">                {</td>
      </tr>
      <tr>
        <td id="L10317" data-line-number="10317"></td>
        <td id="LC10317">                    <span>completion</span>.<span>SetException</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L10318" data-line-number="10318"></td>
        <td id="LC10318">                    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10319" data-line-number="10319"></td>
        <td id="LC10319">                }</td>
      </tr>
      <tr>
        <td id="L10320" data-line-number="10320"></td>
        <td id="LC10320">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L10321" data-line-number="10321"></td>
        <td id="LC10321">                {</td>
      </tr>
      <tr>
        <td id="L10322" data-line-number="10322"></td>
        <td id="LC10322">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10323" data-line-number="10323"></td>
        <td id="LC10323">                }</td>
      </tr>
      <tr>
        <td id="L10324" data-line-number="10324"></td>
        <td id="LC10324">            }</td>
      </tr>
      <tr>
        <td id="L10325" data-line-number="10325"></td>
        <td id="LC10325">            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L10326" data-line-number="10326"></td>
        <td id="LC10326">            {</td>
      </tr>
      <tr>
        <td id="L10327" data-line-number="10327"></td>
        <td id="LC10327">                <span>Debug</span>.<span>Assert</span>(<span>firstCall</span> <span>||</span> <span>!</span><span>releaseConnectionLock</span>, <span><span>"</span>Shouldn't be releasing locks synchronously after the first call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10328" data-line-number="10328"></td>
        <td id="LC10328">                <span>if</span> (<span>releaseConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L10329" data-line-number="10329"></td>
        <td id="LC10329">                {</td>
      </tr>
      <tr>
        <td id="L10330" data-line-number="10330"></td>
        <td id="LC10330">                    <span>_connHandler</span>.<span>_parserLock</span>.<span>Release</span>();</td>
      </tr>
      <tr>
        <td id="L10331" data-line-number="10331"></td>
        <td id="LC10331">                }</td>
      </tr>
      <tr>
        <td id="L10332" data-line-number="10332"></td>
        <td id="LC10332">            }</td>
      </tr>
      <tr>
        <td id="L10333" data-line-number="10333"></td>
        <td id="LC10333">        }</td>
      </tr>
      <tr>
        <td id="L10334" data-line-number="10334"></td>
        <td id="LC10334">
</td>
      </tr>
      <tr>
        <td id="L10335" data-line-number="10335"></td>
        <td id="LC10335">        <span>private</span> <span>void</span> <span>WriteEnclaveInfo</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>byte</span>[] <span>enclavePackage</span>)</td>
      </tr>
      <tr>
        <td id="L10336" data-line-number="10336"></td>
        <td id="LC10336">        {</td>
      </tr>
      <tr>
        <td id="L10337" data-line-number="10337"></td>
        <td id="LC10337">            <span><span>//</span>If the server supports enclave computations, write enclave info.</span></td>
      </tr>
      <tr>
        <td id="L10338" data-line-number="10338"></td>
        <td id="LC10338">            <span>if</span> (<span>TceVersionSupported</span> <span>&gt;=</span> <span>TdsEnums</span>.<span>MIN_TCE_VERSION_WITH_ENCLAVE_SUPPORT</span>)</td>
      </tr>
      <tr>
        <td id="L10339" data-line-number="10339"></td>
        <td id="LC10339">            {</td>
      </tr>
      <tr>
        <td id="L10340" data-line-number="10340"></td>
        <td id="LC10340">                <span>if</span> (<span>enclavePackage</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10341" data-line-number="10341"></td>
        <td id="LC10341">                {</td>
      </tr>
      <tr>
        <td id="L10342" data-line-number="10342"></td>
        <td id="LC10342">                    <span><span>//</span>EnclavePackage Length</span></td>
      </tr>
      <tr>
        <td id="L10343" data-line-number="10343"></td>
        <td id="LC10343">                    <span>WriteShort</span>((<span>short</span>)<span>enclavePackage</span>.<span>Length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10344" data-line-number="10344"></td>
        <td id="LC10344">                    <span>stateObj</span>.<span>WriteByteArray</span>(<span>enclavePackage</span>, <span>enclavePackage</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L10345" data-line-number="10345"></td>
        <td id="LC10345">                }</td>
      </tr>
      <tr>
        <td id="L10346" data-line-number="10346"></td>
        <td id="LC10346">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L10347" data-line-number="10347"></td>
        <td id="LC10347">                {</td>
      </tr>
      <tr>
        <td id="L10348" data-line-number="10348"></td>
        <td id="LC10348">                    <span><span>//</span>EnclavePackage Length</span></td>
      </tr>
      <tr>
        <td id="L10349" data-line-number="10349"></td>
        <td id="LC10349">                    <span>WriteShort</span>((<span>short</span>)<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10350" data-line-number="10350"></td>
        <td id="LC10350">                }</td>
      </tr>
      <tr>
        <td id="L10351" data-line-number="10351"></td>
        <td id="LC10351">            }</td>
      </tr>
      <tr>
        <td id="L10352" data-line-number="10352"></td>
        <td id="LC10352">        }</td>
      </tr>
      <tr>
        <td id="L10353" data-line-number="10353"></td>
        <td id="LC10353">
</td>
      </tr>
      <tr>
        <td id="L10354" data-line-number="10354"></td>
        <td id="LC10354">        <span>private</span> <span>void</span> <span>FinalizeExecuteRPC</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10355" data-line-number="10355"></td>
        <td id="LC10355">        {</td>
      </tr>
      <tr>
        <td id="L10356" data-line-number="10356"></td>
        <td id="LC10356">            <span>stateObj</span>.<span>SniContext</span> <span>=</span> <span>SniContext</span>.<span>Snix_Read</span>;</td>
      </tr>
      <tr>
        <td id="L10357" data-line-number="10357"></td>
        <td id="LC10357">            <span>_asyncWrite</span> <span>=</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L10358" data-line-number="10358"></td>
        <td id="LC10358">        }</td>
      </tr>
      <tr>
        <td id="L10359" data-line-number="10359"></td>
        <td id="LC10359">
</td>
      </tr>
      <tr>
        <td id="L10360" data-line-number="10360"></td>
        <td id="LC10360">        <span>private</span> <span>void</span> <span>TdsExecuteRPC_OnFailure</span>(<span>Exception</span> <span>exc</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10361" data-line-number="10361"></td>
        <td id="LC10361">        {</td>
      </tr>
      <tr>
        <td id="L10362" data-line-number="10362"></td>
        <td id="LC10362">            <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L10363" data-line-number="10363"></td>
        <td id="LC10363">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L10364" data-line-number="10364"></td>
        <td id="LC10364">            {</td>
      </tr>
      <tr>
        <td id="L10365" data-line-number="10365"></td>
        <td id="LC10365">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10366" data-line-number="10366"></td>
        <td id="LC10366">                <span>TdsParser</span>.<span>ReliabilitySection</span> <span>tdsReliabilitySection</span> <span>=</span> <span>new</span> <span>TdsParser</span>.<span>ReliabilitySection</span>();</td>
      </tr>
      <tr>
        <td id="L10367" data-line-number="10367"></td>
        <td id="LC10367">
</td>
      </tr>
      <tr>
        <td id="L10368" data-line-number="10368"></td>
        <td id="LC10368">                <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L10369" data-line-number="10369"></td>
        <td id="LC10369">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L10370" data-line-number="10370"></td>
        <td id="LC10370">                {</td>
      </tr>
      <tr>
        <td id="L10371" data-line-number="10371"></td>
        <td id="LC10371">                    <span>tdsReliabilitySection</span>.<span>Start</span>();</td>
      </tr>
      <tr>
        <td id="L10372" data-line-number="10372"></td>
        <td id="LC10372">#<span>else</span></td>
      </tr>
      <tr>
        <td id="L10373" data-line-number="10373"></td>
        <td id="LC10373">                {</td>
      </tr>
      <tr>
        <td id="L10374" data-line-number="10374"></td>
        <td id="LC10374">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10375" data-line-number="10375"></td>
        <td id="LC10375">                    <span>FailureCleanup</span>(<span>stateObj</span>, <span>exc</span>);</td>
      </tr>
      <tr>
        <td id="L10376" data-line-number="10376"></td>
        <td id="LC10376">                }</td>
      </tr>
      <tr>
        <td id="L10377" data-line-number="10377"></td>
        <td id="LC10377">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10378" data-line-number="10378"></td>
        <td id="LC10378">                <span>finally</span></td>
      </tr>
      <tr>
        <td id="L10379" data-line-number="10379"></td>
        <td id="LC10379">                {</td>
      </tr>
      <tr>
        <td id="L10380" data-line-number="10380"></td>
        <td id="LC10380">                    <span>tdsReliabilitySection</span>.<span>Stop</span>();</td>
      </tr>
      <tr>
        <td id="L10381" data-line-number="10381"></td>
        <td id="LC10381">                }</td>
      </tr>
      <tr>
        <td id="L10382" data-line-number="10382"></td>
        <td id="LC10382">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10383" data-line-number="10383"></td>
        <td id="LC10383">            }</td>
      </tr>
      <tr>
        <td id="L10384" data-line-number="10384"></td>
        <td id="LC10384">            <span>catch</span> (<span>System</span>.<span>OutOfMemoryException</span>)</td>
      </tr>
      <tr>
        <td id="L10385" data-line-number="10385"></td>
        <td id="LC10385">            {</td>
      </tr>
      <tr>
        <td id="L10386" data-line-number="10386"></td>
        <td id="LC10386">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L10387" data-line-number="10387"></td>
        <td id="LC10387">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10388" data-line-number="10388"></td>
        <td id="LC10388">            }</td>
      </tr>
      <tr>
        <td id="L10389" data-line-number="10389"></td>
        <td id="LC10389">            <span>catch</span> (<span>System</span>.<span>StackOverflowException</span>)</td>
      </tr>
      <tr>
        <td id="L10390" data-line-number="10390"></td>
        <td id="LC10390">            {</td>
      </tr>
      <tr>
        <td id="L10391" data-line-number="10391"></td>
        <td id="LC10391">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L10392" data-line-number="10392"></td>
        <td id="LC10392">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10393" data-line-number="10393"></td>
        <td id="LC10393">            }</td>
      </tr>
      <tr>
        <td id="L10394" data-line-number="10394"></td>
        <td id="LC10394">            <span>catch</span> (<span>System</span>.<span>Threading</span>.<span>ThreadAbortException</span>)</td>
      </tr>
      <tr>
        <td id="L10395" data-line-number="10395"></td>
        <td id="LC10395">            {</td>
      </tr>
      <tr>
        <td id="L10396" data-line-number="10396"></td>
        <td id="LC10396">                <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L10397" data-line-number="10397"></td>
        <td id="LC10397">                <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10398" data-line-number="10398"></td>
        <td id="LC10398">            }</td>
      </tr>
      <tr>
        <td id="L10399" data-line-number="10399"></td>
        <td id="LC10399">        }</td>
      </tr>
      <tr>
        <td id="L10400" data-line-number="10400"></td>
        <td id="LC10400">
</td>
      </tr>
      <tr>
        <td id="L10401" data-line-number="10401"></td>
        <td id="LC10401">        <span>private</span> <span>void</span> <span>ExecuteFlushTaskCallback</span>(<span>Task</span> <span>tsk</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>TaskCompletionSource</span>&lt;<span>object</span>&gt; <span>completion</span>, <span>bool</span> <span>releaseConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L10402" data-line-number="10402"></td>
        <td id="LC10402">        {</td>
      </tr>
      <tr>
        <td id="L10403" data-line-number="10403"></td>
        <td id="LC10403">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L10404" data-line-number="10404"></td>
        <td id="LC10404">            {</td>
      </tr>
      <tr>
        <td id="L10405" data-line-number="10405"></td>
        <td id="LC10405">                <span>FinalizeExecuteRPC</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10406" data-line-number="10406"></td>
        <td id="LC10406">                <span>if</span> (<span>tsk</span>.<span>Exception</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L10407" data-line-number="10407"></td>
        <td id="LC10407">                {</td>
      </tr>
      <tr>
        <td id="L10408" data-line-number="10408"></td>
        <td id="LC10408">                    <span>Exception</span> <span>exc</span> <span>=</span> <span>tsk</span>.<span>Exception</span>.<span>InnerException</span>;</td>
      </tr>
      <tr>
        <td id="L10409" data-line-number="10409"></td>
        <td id="LC10409">                    <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L10410" data-line-number="10410"></td>
        <td id="LC10410">                    <span>try</span></td>
      </tr>
      <tr>
        <td id="L10411" data-line-number="10411"></td>
        <td id="LC10411">                    {</td>
      </tr>
      <tr>
        <td id="L10412" data-line-number="10412"></td>
        <td id="LC10412">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10413" data-line-number="10413"></td>
        <td id="LC10413">                        <span>TdsParser</span>.<span>ReliabilitySection</span> <span>tdsReliabilitySection</span> <span>=</span> <span>new</span> <span>TdsParser</span>.<span>ReliabilitySection</span>();</td>
      </tr>
      <tr>
        <td id="L10414" data-line-number="10414"></td>
        <td id="LC10414">
</td>
      </tr>
      <tr>
        <td id="L10415" data-line-number="10415"></td>
        <td id="LC10415">                        <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L10416" data-line-number="10416"></td>
        <td id="LC10416">                        <span>try</span></td>
      </tr>
      <tr>
        <td id="L10417" data-line-number="10417"></td>
        <td id="LC10417">                        {</td>
      </tr>
      <tr>
        <td id="L10418" data-line-number="10418"></td>
        <td id="LC10418">                            <span>tdsReliabilitySection</span>.<span>Start</span>();</td>
      </tr>
      <tr>
        <td id="L10419" data-line-number="10419"></td>
        <td id="LC10419">#<span>else</span></td>
      </tr>
      <tr>
        <td id="L10420" data-line-number="10420"></td>
        <td id="LC10420">                        {</td>
      </tr>
      <tr>
        <td id="L10421" data-line-number="10421"></td>
        <td id="LC10421">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10422" data-line-number="10422"></td>
        <td id="LC10422">                            <span>FailureCleanup</span>(<span>stateObj</span>, <span>tsk</span>.<span>Exception</span>);</td>
      </tr>
      <tr>
        <td id="L10423" data-line-number="10423"></td>
        <td id="LC10423">                        }</td>
      </tr>
      <tr>
        <td id="L10424" data-line-number="10424"></td>
        <td id="LC10424">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10425" data-line-number="10425"></td>
        <td id="LC10425">                        <span>finally</span></td>
      </tr>
      <tr>
        <td id="L10426" data-line-number="10426"></td>
        <td id="LC10426">                        {</td>
      </tr>
      <tr>
        <td id="L10427" data-line-number="10427"></td>
        <td id="LC10427">                            <span>tdsReliabilitySection</span>.<span>Stop</span>();</td>
      </tr>
      <tr>
        <td id="L10428" data-line-number="10428"></td>
        <td id="LC10428">                        }</td>
      </tr>
      <tr>
        <td id="L10429" data-line-number="10429"></td>
        <td id="LC10429">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L10430" data-line-number="10430"></td>
        <td id="LC10430">                    }</td>
      </tr>
      <tr>
        <td id="L10431" data-line-number="10431"></td>
        <td id="LC10431">                    <span>catch</span> (<span>System</span>.<span>OutOfMemoryException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L10432" data-line-number="10432"></td>
        <td id="LC10432">                    {</td>
      </tr>
      <tr>
        <td id="L10433" data-line-number="10433"></td>
        <td id="LC10433">                        <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L10434" data-line-number="10434"></td>
        <td id="LC10434">                        <span>completion</span>.<span>SetException</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L10435" data-line-number="10435"></td>
        <td id="LC10435">                        <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10436" data-line-number="10436"></td>
        <td id="LC10436">                    }</td>
      </tr>
      <tr>
        <td id="L10437" data-line-number="10437"></td>
        <td id="LC10437">                    <span>catch</span> (<span>System</span>.<span>StackOverflowException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L10438" data-line-number="10438"></td>
        <td id="LC10438">                    {</td>
      </tr>
      <tr>
        <td id="L10439" data-line-number="10439"></td>
        <td id="LC10439">                        <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L10440" data-line-number="10440"></td>
        <td id="LC10440">                        <span>completion</span>.<span>SetException</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L10441" data-line-number="10441"></td>
        <td id="LC10441">                        <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10442" data-line-number="10442"></td>
        <td id="LC10442">                    }</td>
      </tr>
      <tr>
        <td id="L10443" data-line-number="10443"></td>
        <td id="LC10443">                    <span>catch</span> (<span>System</span>.<span>Threading</span>.<span>ThreadAbortException</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L10444" data-line-number="10444"></td>
        <td id="LC10444">                    {</td>
      </tr>
      <tr>
        <td id="L10445" data-line-number="10445"></td>
        <td id="LC10445">                        <span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L10446" data-line-number="10446"></td>
        <td id="LC10446">                        <span>completion</span>.<span>SetException</span>(<span>e</span>);</td>
      </tr>
      <tr>
        <td id="L10447" data-line-number="10447"></td>
        <td id="LC10447">                        <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L10448" data-line-number="10448"></td>
        <td id="LC10448">                    }</td>
      </tr>
      <tr>
        <td id="L10449" data-line-number="10449"></td>
        <td id="LC10449">                    <span>catch</span> (<span>Exception</span> <span>e</span>)</td>
      </tr>
      <tr>
        <td id="L10450" data-line-number="10450"></td>
        <td id="LC10450">                    {</td>
      </tr>
      <tr>
        <td id="L10451" data-line-number="10451"></td>
        <td id="LC10451">                        <span>exc</span> <span>=</span> <span>e</span>;</td>
      </tr>
      <tr>
        <td id="L10452" data-line-number="10452"></td>
        <td id="LC10452">                    }</td>
      </tr>
      <tr>
        <td id="L10453" data-line-number="10453"></td>
        <td id="LC10453">                    <span>completion</span>.<span>SetException</span>(<span>exc</span>);</td>
      </tr>
      <tr>
        <td id="L10454" data-line-number="10454"></td>
        <td id="LC10454">                }</td>
      </tr>
      <tr>
        <td id="L10455" data-line-number="10455"></td>
        <td id="LC10455">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L10456" data-line-number="10456"></td>
        <td id="LC10456">                {</td>
      </tr>
      <tr>
        <td id="L10457" data-line-number="10457"></td>
        <td id="LC10457">                    <span>completion</span>.<span>SetResult</span>(<span>null</span>);</td>
      </tr>
      <tr>
        <td id="L10458" data-line-number="10458"></td>
        <td id="LC10458">                }</td>
      </tr>
      <tr>
        <td id="L10459" data-line-number="10459"></td>
        <td id="LC10459">            }</td>
      </tr>
      <tr>
        <td id="L10460" data-line-number="10460"></td>
        <td id="LC10460">            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L10461" data-line-number="10461"></td>
        <td id="LC10461">            {</td>
      </tr>
      <tr>
        <td id="L10462" data-line-number="10462"></td>
        <td id="LC10462">                <span>if</span> (<span>releaseConnectionLock</span>)</td>
      </tr>
      <tr>
        <td id="L10463" data-line-number="10463"></td>
        <td id="LC10463">                {</td>
      </tr>
      <tr>
        <td id="L10464" data-line-number="10464"></td>
        <td id="LC10464">                    <span>_connHandler</span>.<span>_parserLock</span>.<span>Release</span>();</td>
      </tr>
      <tr>
        <td id="L10465" data-line-number="10465"></td>
        <td id="LC10465">                }</td>
      </tr>
      <tr>
        <td id="L10466" data-line-number="10466"></td>
        <td id="LC10466">            }</td>
      </tr>
      <tr>
        <td id="L10467" data-line-number="10467"></td>
        <td id="LC10467">        }</td>
      </tr>
      <tr>
        <td id="L10468" data-line-number="10468"></td>
        <td id="LC10468">
</td>
      </tr>
      <tr>
        <td id="L10469" data-line-number="10469"></td>
        <td id="LC10469">
</td>
      </tr>
      <tr>
        <td id="L10470" data-line-number="10470"></td>
        <td id="LC10470">        <span>private</span> <span>void</span> <span>WriteParameterName</span>(<span>string</span> <span>parameterName</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10471" data-line-number="10471"></td>
        <td id="LC10471">        {</td>
      </tr>
      <tr>
        <td id="L10472" data-line-number="10472"></td>
        <td id="LC10472">            <span><span>//</span> paramLen</span></td>
      </tr>
      <tr>
        <td id="L10473" data-line-number="10473"></td>
        <td id="LC10473">            <span><span>//</span> paramName</span></td>
      </tr>
      <tr>
        <td id="L10474" data-line-number="10474"></td>
        <td id="LC10474">            <span>if</span> (<span>!</span><span>ADP</span>.<span>IsEmpty</span>(<span>parameterName</span>))</td>
      </tr>
      <tr>
        <td id="L10475" data-line-number="10475"></td>
        <td id="LC10475">            {</td>
      </tr>
      <tr>
        <td id="L10476" data-line-number="10476"></td>
        <td id="LC10476">                <span>Debug</span>.<span>Assert</span>(<span>parameterName</span>.<span>Length</span> <span>&lt;=</span> <span>0xff</span>, <span><span>"</span>parameter name can only be 255 bytes, shouldn't get to TdsParser!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10477" data-line-number="10477"></td>
        <td id="LC10477">                <span>int</span> <span>tempLen</span> <span>=</span> <span>parameterName</span>.<span>Length</span> <span>&amp;</span> <span>0xff</span>;</td>
      </tr>
      <tr>
        <td id="L10478" data-line-number="10478"></td>
        <td id="LC10478">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>tempLen</span>);</td>
      </tr>
      <tr>
        <td id="L10479" data-line-number="10479"></td>
        <td id="LC10479">                <span>WriteString</span>(<span>parameterName</span>, <span>tempLen</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10480" data-line-number="10480"></td>
        <td id="LC10480">            }</td>
      </tr>
      <tr>
        <td id="L10481" data-line-number="10481"></td>
        <td id="LC10481">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L10482" data-line-number="10482"></td>
        <td id="LC10482">            {</td>
      </tr>
      <tr>
        <td id="L10483" data-line-number="10483"></td>
        <td id="LC10483">                <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L10484" data-line-number="10484"></td>
        <td id="LC10484">            }</td>
      </tr>
      <tr>
        <td id="L10485" data-line-number="10485"></td>
        <td id="LC10485">        }</td>
      </tr>
      <tr>
        <td id="L10486" data-line-number="10486"></td>
        <td id="LC10486">
</td>
      </tr>
      <tr>
        <td id="L10487" data-line-number="10487"></td>
        <td id="LC10487">        <span>private</span> <span>static</span> <span>readonly</span> <span>IEnumerable</span>&lt;<span>SqlDataRecord</span>&gt; <span>__tvpEmptyValue</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>SqlDataRecord</span>&gt;().<span>AsReadOnly</span>();</td>
      </tr>
      <tr>
        <td id="L10488" data-line-number="10488"></td>
        <td id="LC10488">        <span>private</span> <span>void</span> <span>WriteSmiParameter</span>(<span>SqlParameter</span> <span>param</span>, <span>int</span> <span>paramIndex</span>, <span>bool</span> <span>sendDefault</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10489" data-line-number="10489"></td>
        <td id="LC10489">        {</td>
      </tr>
      <tr>
        <td id="L10490" data-line-number="10490"></td>
        <td id="LC10490">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10491" data-line-number="10491"></td>
        <td id="LC10491">            <span><span>//</span> Determine Metadata</span></td>
      </tr>
      <tr>
        <td id="L10492" data-line-number="10492"></td>
        <td id="LC10492">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10493" data-line-number="10493"></td>
        <td id="LC10493">            <span>ParameterPeekAheadValue</span> <span>peekAhead</span>;</td>
      </tr>
      <tr>
        <td id="L10494" data-line-number="10494"></td>
        <td id="LC10494">            <span>SmiParameterMetaData</span> <span>metaData</span> <span>=</span> <span>param</span>.<span>MetaDataForSmi</span>(<span>out</span> <span>peekAhead</span>);</td>
      </tr>
      <tr>
        <td id="L10495" data-line-number="10495"></td>
        <td id="LC10495">
</td>
      </tr>
      <tr>
        <td id="L10496" data-line-number="10496"></td>
        <td id="LC10496">            <span>if</span> (<span>!</span><span>_isKatmai</span>)</td>
      </tr>
      <tr>
        <td id="L10497" data-line-number="10497"></td>
        <td id="LC10497">            {</td>
      </tr>
      <tr>
        <td id="L10498" data-line-number="10498"></td>
        <td id="LC10498">                <span>MetaType</span> <span>mt</span> <span>=</span> <span>MetaType</span>.<span>GetMetaTypeFromSqlDbType</span>(<span>metaData</span>.<span>SqlDbType</span>, <span>metaData</span>.<span>IsMultiValued</span>);</td>
      </tr>
      <tr>
        <td id="L10499" data-line-number="10499"></td>
        <td id="LC10499">                <span>throw</span> <span>ADP</span>.<span>VersionDoesNotSupportDataType</span>(<span>mt</span>.<span>TypeName</span>);</td>
      </tr>
      <tr>
        <td id="L10500" data-line-number="10500"></td>
        <td id="LC10500">            }</td>
      </tr>
      <tr>
        <td id="L10501" data-line-number="10501"></td>
        <td id="LC10501">
</td>
      </tr>
      <tr>
        <td id="L10502" data-line-number="10502"></td>
        <td id="LC10502">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10503" data-line-number="10503"></td>
        <td id="LC10503">            <span><span>//</span>  Determine value to send</span></td>
      </tr>
      <tr>
        <td id="L10504" data-line-number="10504"></td>
        <td id="LC10504">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10505" data-line-number="10505"></td>
        <td id="LC10505">            <span>object</span> <span>value</span>;</td>
      </tr>
      <tr>
        <td id="L10506" data-line-number="10506"></td>
        <td id="LC10506">            <span>ExtendedClrTypeCode</span> <span>typeCode</span>;</td>
      </tr>
      <tr>
        <td id="L10507" data-line-number="10507"></td>
        <td id="LC10507">
</td>
      </tr>
      <tr>
        <td id="L10508" data-line-number="10508"></td>
        <td id="LC10508">            <span><span>//</span> if we have an output or default param, set the value to null so we do not send it across to the server</span></td>
      </tr>
      <tr>
        <td id="L10509" data-line-number="10509"></td>
        <td id="LC10509">            <span>if</span> (<span>sendDefault</span>)</td>
      </tr>
      <tr>
        <td id="L10510" data-line-number="10510"></td>
        <td id="LC10510">            {</td>
      </tr>
      <tr>
        <td id="L10511" data-line-number="10511"></td>
        <td id="LC10511">                <span><span>//</span> Value for TVP default is empty list, not NULL</span></td>
      </tr>
      <tr>
        <td id="L10512" data-line-number="10512"></td>
        <td id="LC10512">                <span>if</span> (<span>SqlDbType</span>.<span>Structured</span> <span>==</span> <span>metaData</span>.<span>SqlDbType</span> <span>&amp;&amp;</span> <span>metaData</span>.<span>IsMultiValued</span>)</td>
      </tr>
      <tr>
        <td id="L10513" data-line-number="10513"></td>
        <td id="LC10513">                {</td>
      </tr>
      <tr>
        <td id="L10514" data-line-number="10514"></td>
        <td id="LC10514">                    <span>value</span> <span>=</span> <span>__tvpEmptyValue</span>;</td>
      </tr>
      <tr>
        <td id="L10515" data-line-number="10515"></td>
        <td id="LC10515">                    <span>typeCode</span> <span>=</span> <span>ExtendedClrTypeCode</span>.<span>IEnumerableOfSqlDataRecord</span>;</td>
      </tr>
      <tr>
        <td id="L10516" data-line-number="10516"></td>
        <td id="LC10516">                }</td>
      </tr>
      <tr>
        <td id="L10517" data-line-number="10517"></td>
        <td id="LC10517">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L10518" data-line-number="10518"></td>
        <td id="LC10518">                {</td>
      </tr>
      <tr>
        <td id="L10519" data-line-number="10519"></td>
        <td id="LC10519">                    <span><span>//</span> Need to send null value for default</span></td>
      </tr>
      <tr>
        <td id="L10520" data-line-number="10520"></td>
        <td id="LC10520">                    <span>value</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10521" data-line-number="10521"></td>
        <td id="LC10521">                    <span>typeCode</span> <span>=</span> <span>ExtendedClrTypeCode</span>.<span>DBNull</span>;</td>
      </tr>
      <tr>
        <td id="L10522" data-line-number="10522"></td>
        <td id="LC10522">                }</td>
      </tr>
      <tr>
        <td id="L10523" data-line-number="10523"></td>
        <td id="LC10523">            }</td>
      </tr>
      <tr>
        <td id="L10524" data-line-number="10524"></td>
        <td id="LC10524">            <span>else</span> <span>if</span> (<span>param</span>.<span>Direction</span> <span>==</span> <span>ParameterDirection</span>.<span>Output</span>)</td>
      </tr>
      <tr>
        <td id="L10525" data-line-number="10525"></td>
        <td id="LC10525">            {</td>
      </tr>
      <tr>
        <td id="L10526" data-line-number="10526"></td>
        <td id="LC10526">                <span>bool</span> <span>isCLRType</span> <span>=</span> <span>param</span>.<span>ParamaterIsSqlType</span>;  <span><span>//</span> We have to forward the TYPE info, we need to know what type we are returning.  Once we null the paramater we will no longer be able to distinguish what type were seeing.</span></td>
      </tr>
      <tr>
        <td id="L10527" data-line-number="10527"></td>
        <td id="LC10527">                <span>param</span>.<span>Value</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10528" data-line-number="10528"></td>
        <td id="LC10528">                <span>value</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L10529" data-line-number="10529"></td>
        <td id="LC10529">                <span>typeCode</span> <span>=</span> <span>ExtendedClrTypeCode</span>.<span>DBNull</span>;</td>
      </tr>
      <tr>
        <td id="L10530" data-line-number="10530"></td>
        <td id="LC10530">                <span>param</span>.<span>ParamaterIsSqlType</span> <span>=</span> <span>isCLRType</span>;</td>
      </tr>
      <tr>
        <td id="L10531" data-line-number="10531"></td>
        <td id="LC10531">            }</td>
      </tr>
      <tr>
        <td id="L10532" data-line-number="10532"></td>
        <td id="LC10532">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L10533" data-line-number="10533"></td>
        <td id="LC10533">            {</td>
      </tr>
      <tr>
        <td id="L10534" data-line-number="10534"></td>
        <td id="LC10534">                <span>value</span> <span>=</span> <span>param</span>.<span>GetCoercedValue</span>();</td>
      </tr>
      <tr>
        <td id="L10535" data-line-number="10535"></td>
        <td id="LC10535">                <span>typeCode</span> <span>=</span> <span>MetaDataUtilsSmi</span>.<span>DetermineExtendedTypeCodeForUseWithSqlDbType</span>(</td>
      </tr>
      <tr>
        <td id="L10536" data-line-number="10536"></td>
        <td id="LC10536">                                                    <span>metaData</span>.<span>SqlDbType</span>, <span>metaData</span>.<span>IsMultiValued</span>, <span>value</span>, <span>null</span>, <span>SmiContextFactory</span>.<span>KatmaiVersion</span>);</td>
      </tr>
      <tr>
        <td id="L10537" data-line-number="10537"></td>
        <td id="LC10537">            }</td>
      </tr>
      <tr>
        <td id="L10538" data-line-number="10538"></td>
        <td id="LC10538">
</td>
      </tr>
      <tr>
        <td id="L10539" data-line-number="10539"></td>
        <td id="LC10539">            <span>if</span> (<span>Bid</span>.<span>AdvancedOn</span>)</td>
      </tr>
      <tr>
        <td id="L10540" data-line-number="10540"></td>
        <td id="LC10540">            {</td>
      </tr>
      <tr>
        <td id="L10541" data-line-number="10541"></td>
        <td id="LC10541">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.WriteSmiParameter|ADV&gt; %d#, Sending parameter '%ls', default flag=%d, metadata:<span>\n</span><span>"</span></span>, <span>ObjectID</span>, <span>param</span>.<span>ParameterName</span>, <span>sendDefault</span> <span>?</span> <span>1</span> <span>:</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L10542" data-line-number="10542"></td>
        <td id="LC10542">                <span>Bid</span>.<span>PutStr</span>(<span>metaData</span>.<span>TraceString</span>(<span>3</span>));</td>
      </tr>
      <tr>
        <td id="L10543" data-line-number="10543"></td>
        <td id="LC10543">                <span>Bid</span>.<span>Trace</span>(<span><span>"</span><span>\n</span><span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10544" data-line-number="10544"></td>
        <td id="LC10544">            }</td>
      </tr>
      <tr>
        <td id="L10545" data-line-number="10545"></td>
        <td id="LC10545">
</td>
      </tr>
      <tr>
        <td id="L10546" data-line-number="10546"></td>
        <td id="LC10546">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10547" data-line-number="10547"></td>
        <td id="LC10547">            <span><span>//</span> Write parameter metadata</span></td>
      </tr>
      <tr>
        <td id="L10548" data-line-number="10548"></td>
        <td id="LC10548">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10549" data-line-number="10549"></td>
        <td id="LC10549">            <span>WriteSmiParameterMetaData</span>(<span>metaData</span>, <span>sendDefault</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10550" data-line-number="10550"></td>
        <td id="LC10550">
</td>
      </tr>
      <tr>
        <td id="L10551" data-line-number="10551"></td>
        <td id="LC10551">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10552" data-line-number="10552"></td>
        <td id="LC10552">            <span><span>//</span> Now write the value</span></td>
      </tr>
      <tr>
        <td id="L10553" data-line-number="10553"></td>
        <td id="LC10553">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10554" data-line-number="10554"></td>
        <td id="LC10554">            <span>TdsParameterSetter</span> <span>paramSetter</span> <span>=</span> <span>new</span> <span>TdsParameterSetter</span>(<span>stateObj</span>, <span>metaData</span>);</td>
      </tr>
      <tr>
        <td id="L10555" data-line-number="10555"></td>
        <td id="LC10555">            <span>ValueUtilsSmi</span>.<span>SetCompatibleValueV200</span>(</td>
      </tr>
      <tr>
        <td id="L10556" data-line-number="10556"></td>
        <td id="LC10556">                                        <span>new</span> <span>SmiEventSink_Default</span>(),  <span><span>//</span> TDS Errors/events dealt with at lower level for now, just need an object for processing</span></td>
      </tr>
      <tr>
        <td id="L10557" data-line-number="10557"></td>
        <td id="LC10557">                                        <span>paramSetter</span>,</td>
      </tr>
      <tr>
        <td id="L10558" data-line-number="10558"></td>
        <td id="LC10558">                                        <span>0</span>,          <span><span>//</span> ordinal.  TdsParameterSetter only handles one parameter at a time</span></td>
      </tr>
      <tr>
        <td id="L10559" data-line-number="10559"></td>
        <td id="LC10559">                                        <span>metaData</span>,</td>
      </tr>
      <tr>
        <td id="L10560" data-line-number="10560"></td>
        <td id="LC10560">                                        <span>value</span>,</td>
      </tr>
      <tr>
        <td id="L10561" data-line-number="10561"></td>
        <td id="LC10561">                                        <span>typeCode</span>,</td>
      </tr>
      <tr>
        <td id="L10562" data-line-number="10562"></td>
        <td id="LC10562">                                        <span>param</span>.<span>Offset</span>,</td>
      </tr>
      <tr>
        <td id="L10563" data-line-number="10563"></td>
        <td id="LC10563">                                        <span>0</span> <span>&lt;</span> <span>param</span>.<span>Size</span> <span>?</span> <span>param</span>.<span>Size</span> <span>:</span> <span>-</span><span>1</span>,</td>
      </tr>
      <tr>
        <td id="L10564" data-line-number="10564"></td>
        <td id="LC10564">                                        <span>peekAhead</span>);</td>
      </tr>
      <tr>
        <td id="L10565" data-line-number="10565"></td>
        <td id="LC10565">        }</td>
      </tr>
      <tr>
        <td id="L10566" data-line-number="10566"></td>
        <td id="LC10566">
</td>
      </tr>
      <tr>
        <td id="L10567" data-line-number="10567"></td>
        <td id="LC10567">        <span><span>//</span> Writes metadata portion of parameter stream from an SmiParameterMetaData object.</span></td>
      </tr>
      <tr>
        <td id="L10568" data-line-number="10568"></td>
        <td id="LC10568">        <span>private</span> <span>void</span> <span>WriteSmiParameterMetaData</span>(<span>SmiParameterMetaData</span> <span>metaData</span>, <span>bool</span> <span>sendDefault</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10569" data-line-number="10569"></td>
        <td id="LC10569">        {</td>
      </tr>
      <tr>
        <td id="L10570" data-line-number="10570"></td>
        <td id="LC10570">            <span><span>//</span> Determine status</span></td>
      </tr>
      <tr>
        <td id="L10571" data-line-number="10571"></td>
        <td id="LC10571">            <span>byte</span> <span>status</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L10572" data-line-number="10572"></td>
        <td id="LC10572">            <span>if</span> (<span>ParameterDirection</span>.<span>Output</span> <span>==</span> <span>metaData</span>.<span>Direction</span> <span>||</span> <span>ParameterDirection</span>.<span>InputOutput</span> <span>==</span> <span>metaData</span>.<span>Direction</span>)</td>
      </tr>
      <tr>
        <td id="L10573" data-line-number="10573"></td>
        <td id="LC10573">            {</td>
      </tr>
      <tr>
        <td id="L10574" data-line-number="10574"></td>
        <td id="LC10574">                <span>status</span> <span>|=</span> <span>TdsEnums</span>.<span>RPC_PARAM_BYREF</span>;</td>
      </tr>
      <tr>
        <td id="L10575" data-line-number="10575"></td>
        <td id="LC10575">            }</td>
      </tr>
      <tr>
        <td id="L10576" data-line-number="10576"></td>
        <td id="LC10576">
</td>
      </tr>
      <tr>
        <td id="L10577" data-line-number="10577"></td>
        <td id="LC10577">            <span>if</span> (<span>sendDefault</span>)</td>
      </tr>
      <tr>
        <td id="L10578" data-line-number="10578"></td>
        <td id="LC10578">            {</td>
      </tr>
      <tr>
        <td id="L10579" data-line-number="10579"></td>
        <td id="LC10579">                <span>status</span> <span>|=</span> <span>TdsEnums</span>.<span>RPC_PARAM_DEFAULT</span>;</td>
      </tr>
      <tr>
        <td id="L10580" data-line-number="10580"></td>
        <td id="LC10580">            }</td>
      </tr>
      <tr>
        <td id="L10581" data-line-number="10581"></td>
        <td id="LC10581">
</td>
      </tr>
      <tr>
        <td id="L10582" data-line-number="10582"></td>
        <td id="LC10582">            <span><span>//</span> Write everything out</span></td>
      </tr>
      <tr>
        <td id="L10583" data-line-number="10583"></td>
        <td id="LC10583">            <span>WriteParameterName</span>(<span>metaData</span>.<span>Name</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10584" data-line-number="10584"></td>
        <td id="LC10584">            <span>stateObj</span>.<span>WriteByte</span>(<span>status</span>);</td>
      </tr>
      <tr>
        <td id="L10585" data-line-number="10585"></td>
        <td id="LC10585">            <span>WriteSmiTypeInfo</span>(<span>metaData</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10586" data-line-number="10586"></td>
        <td id="LC10586">        }</td>
      </tr>
      <tr>
        <td id="L10587" data-line-number="10587"></td>
        <td id="LC10587">
</td>
      </tr>
      <tr>
        <td id="L10588" data-line-number="10588"></td>
        <td id="LC10588">        <span><span>//</span> Write a TypeInfo stream</span></td>
      </tr>
      <tr>
        <td id="L10589" data-line-number="10589"></td>
        <td id="LC10589">        <span><span>//</span> Devnote: we remap the legacy types (text, ntext, and image) to SQLBIGVARCHAR,  SQLNVARCHAR, and SQLBIGVARBINARY</span></td>
      </tr>
      <tr>
        <td id="L10590" data-line-number="10590"></td>
        <td id="LC10590">        <span>private</span> <span>void</span> <span>WriteSmiTypeInfo</span>(<span>SmiExtendedMetaData</span> <span>metaData</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10591" data-line-number="10591"></td>
        <td id="LC10591">        {</td>
      </tr>
      <tr>
        <td id="L10592" data-line-number="10592"></td>
        <td id="LC10592">            <span>switch</span> (<span>metaData</span>.<span>SqlDbType</span>)</td>
      </tr>
      <tr>
        <td id="L10593" data-line-number="10593"></td>
        <td id="LC10593">            {</td>
      </tr>
      <tr>
        <td id="L10594" data-line-number="10594"></td>
        <td id="LC10594">                <span>case</span> <span>SqlDbType</span>.<span>BigInt</span>:</td>
      </tr>
      <tr>
        <td id="L10595" data-line-number="10595"></td>
        <td id="LC10595">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLINTN</span>);</td>
      </tr>
      <tr>
        <td id="L10596" data-line-number="10596"></td>
        <td id="LC10596">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10597" data-line-number="10597"></td>
        <td id="LC10597">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10598" data-line-number="10598"></td>
        <td id="LC10598">                <span>case</span> <span>SqlDbType</span>.<span>Binary</span>:</td>
      </tr>
      <tr>
        <td id="L10599" data-line-number="10599"></td>
        <td id="LC10599">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGBINARY</span>);</td>
      </tr>
      <tr>
        <td id="L10600" data-line-number="10600"></td>
        <td id="LC10600">                    <span>WriteUnsignedShort</span>(<span>checked</span>((<span>ushort</span>)<span>metaData</span>.<span>MaxLength</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10601" data-line-number="10601"></td>
        <td id="LC10601">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10602" data-line-number="10602"></td>
        <td id="LC10602">                <span>case</span> <span>SqlDbType</span>.<span>Bit</span>:</td>
      </tr>
      <tr>
        <td id="L10603" data-line-number="10603"></td>
        <td id="LC10603">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBITN</span>);</td>
      </tr>
      <tr>
        <td id="L10604" data-line-number="10604"></td>
        <td id="LC10604">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10605" data-line-number="10605"></td>
        <td id="LC10605">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10606" data-line-number="10606"></td>
        <td id="LC10606">                <span>case</span> <span>SqlDbType</span>.<span>Char</span>:</td>
      </tr>
      <tr>
        <td id="L10607" data-line-number="10607"></td>
        <td id="LC10607">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGCHAR</span>);</td>
      </tr>
      <tr>
        <td id="L10608" data-line-number="10608"></td>
        <td id="LC10608">                    <span>WriteUnsignedShort</span>(<span>checked</span>((<span>ushort</span>)(<span>metaData</span>.<span>MaxLength</span>)), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10609" data-line-number="10609"></td>
        <td id="LC10609">                    <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> TODO: Use metadata's collation??</span></td>
      </tr>
      <tr>
        <td id="L10610" data-line-number="10610"></td>
        <td id="LC10610">                    <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L10611" data-line-number="10611"></td>
        <td id="LC10611">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10612" data-line-number="10612"></td>
        <td id="LC10612">                <span>case</span> <span>SqlDbType</span>.<span>DateTime</span>:</td>
      </tr>
      <tr>
        <td id="L10613" data-line-number="10613"></td>
        <td id="LC10613">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLDATETIMN</span>);</td>
      </tr>
      <tr>
        <td id="L10614" data-line-number="10614"></td>
        <td id="LC10614">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10615" data-line-number="10615"></td>
        <td id="LC10615">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10616" data-line-number="10616"></td>
        <td id="LC10616">                <span>case</span> <span>SqlDbType</span>.<span>Decimal</span>:</td>
      </tr>
      <tr>
        <td id="L10617" data-line-number="10617"></td>
        <td id="LC10617">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLNUMERICN</span>);</td>
      </tr>
      <tr>
        <td id="L10618" data-line-number="10618"></td>
        <td id="LC10618">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>MetaType</span>.<span>MetaDecimal</span>.<span>FixedLength</span>));   <span><span>//</span> SmiMetaData's length and actual wire format's length are different</span></td>
      </tr>
      <tr>
        <td id="L10619" data-line-number="10619"></td>
        <td id="LC10619">                    <span>stateObj</span>.<span>WriteByte</span>(<span>0</span> <span>==</span> <span>metaData</span>.<span>Precision</span> <span>?</span> (<span>byte</span>)<span>1</span> <span>:</span> <span>metaData</span>.<span>Precision</span>);</td>
      </tr>
      <tr>
        <td id="L10620" data-line-number="10620"></td>
        <td id="LC10620">                    <span>stateObj</span>.<span>WriteByte</span>(<span>metaData</span>.<span>Scale</span>);</td>
      </tr>
      <tr>
        <td id="L10621" data-line-number="10621"></td>
        <td id="LC10621">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10622" data-line-number="10622"></td>
        <td id="LC10622">                <span>case</span> <span>SqlDbType</span>.<span>Float</span>:</td>
      </tr>
      <tr>
        <td id="L10623" data-line-number="10623"></td>
        <td id="LC10623">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLFLTN</span>);</td>
      </tr>
      <tr>
        <td id="L10624" data-line-number="10624"></td>
        <td id="LC10624">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10625" data-line-number="10625"></td>
        <td id="LC10625">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10626" data-line-number="10626"></td>
        <td id="LC10626">                <span>case</span> <span>SqlDbType</span>.<span>Image</span>:</td>
      </tr>
      <tr>
        <td id="L10627" data-line-number="10627"></td>
        <td id="LC10627">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>);</td>
      </tr>
      <tr>
        <td id="L10628" data-line-number="10628"></td>
        <td id="LC10628">                    <span>WriteUnsignedShort</span>(<span>unchecked</span>((<span>ushort</span>)<span>SmiMetaData</span>.<span>UnlimitedMaxLengthIndicator</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10629" data-line-number="10629"></td>
        <td id="LC10629">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10630" data-line-number="10630"></td>
        <td id="LC10630">                <span>case</span> <span>SqlDbType</span>.<span>Int</span>:</td>
      </tr>
      <tr>
        <td id="L10631" data-line-number="10631"></td>
        <td id="LC10631">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLINTN</span>);</td>
      </tr>
      <tr>
        <td id="L10632" data-line-number="10632"></td>
        <td id="LC10632">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10633" data-line-number="10633"></td>
        <td id="LC10633">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10634" data-line-number="10634"></td>
        <td id="LC10634">                <span>case</span> <span>SqlDbType</span>.<span>Money</span>:</td>
      </tr>
      <tr>
        <td id="L10635" data-line-number="10635"></td>
        <td id="LC10635">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLMONEYN</span>);</td>
      </tr>
      <tr>
        <td id="L10636" data-line-number="10636"></td>
        <td id="LC10636">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10637" data-line-number="10637"></td>
        <td id="LC10637">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10638" data-line-number="10638"></td>
        <td id="LC10638">                <span>case</span> <span>SqlDbType</span>.<span>NChar</span>:</td>
      </tr>
      <tr>
        <td id="L10639" data-line-number="10639"></td>
        <td id="LC10639">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLNCHAR</span>);</td>
      </tr>
      <tr>
        <td id="L10640" data-line-number="10640"></td>
        <td id="LC10640">                    <span>WriteUnsignedShort</span>(<span>checked</span>((<span>ushort</span>)(<span>metaData</span>.<span>MaxLength</span> <span>*</span> <span>2</span>)), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10641" data-line-number="10641"></td>
        <td id="LC10641">                    <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> TODO: Use metadata's collation??</span></td>
      </tr>
      <tr>
        <td id="L10642" data-line-number="10642"></td>
        <td id="LC10642">                    <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L10643" data-line-number="10643"></td>
        <td id="LC10643">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10644" data-line-number="10644"></td>
        <td id="LC10644">                <span>case</span> <span>SqlDbType</span>.<span>NText</span>:</td>
      </tr>
      <tr>
        <td id="L10645" data-line-number="10645"></td>
        <td id="LC10645">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLNVARCHAR</span>);</td>
      </tr>
      <tr>
        <td id="L10646" data-line-number="10646"></td>
        <td id="LC10646">                    <span>WriteUnsignedShort</span>(<span>unchecked</span>((<span>ushort</span>)<span>SmiMetaData</span>.<span>UnlimitedMaxLengthIndicator</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10647" data-line-number="10647"></td>
        <td id="LC10647">                    <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> TODO: Use metadata's collation??</span></td>
      </tr>
      <tr>
        <td id="L10648" data-line-number="10648"></td>
        <td id="LC10648">                    <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L10649" data-line-number="10649"></td>
        <td id="LC10649">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10650" data-line-number="10650"></td>
        <td id="LC10650">                <span>case</span> <span>SqlDbType</span>.<span>NVarChar</span>:</td>
      </tr>
      <tr>
        <td id="L10651" data-line-number="10651"></td>
        <td id="LC10651">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLNVARCHAR</span>);</td>
      </tr>
      <tr>
        <td id="L10652" data-line-number="10652"></td>
        <td id="LC10652">                    <span>if</span> (<span>SmiMetaData</span>.<span>UnlimitedMaxLengthIndicator</span> <span>==</span> <span>metaData</span>.<span>MaxLength</span>)</td>
      </tr>
      <tr>
        <td id="L10653" data-line-number="10653"></td>
        <td id="LC10653">                    {</td>
      </tr>
      <tr>
        <td id="L10654" data-line-number="10654"></td>
        <td id="LC10654">                        <span>WriteUnsignedShort</span>(<span>unchecked</span>((<span>ushort</span>)<span>SmiMetaData</span>.<span>UnlimitedMaxLengthIndicator</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10655" data-line-number="10655"></td>
        <td id="LC10655">                    }</td>
      </tr>
      <tr>
        <td id="L10656" data-line-number="10656"></td>
        <td id="LC10656">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10657" data-line-number="10657"></td>
        <td id="LC10657">                    {</td>
      </tr>
      <tr>
        <td id="L10658" data-line-number="10658"></td>
        <td id="LC10658">                        <span>WriteUnsignedShort</span>(<span>checked</span>((<span>ushort</span>)(<span>metaData</span>.<span>MaxLength</span> <span>*</span> <span>2</span>)), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10659" data-line-number="10659"></td>
        <td id="LC10659">                    }</td>
      </tr>
      <tr>
        <td id="L10660" data-line-number="10660"></td>
        <td id="LC10660">                    <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> TODO: Use metadata's collation??</span></td>
      </tr>
      <tr>
        <td id="L10661" data-line-number="10661"></td>
        <td id="LC10661">                    <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L10662" data-line-number="10662"></td>
        <td id="LC10662">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10663" data-line-number="10663"></td>
        <td id="LC10663">                <span>case</span> <span>SqlDbType</span>.<span>Real</span>:</td>
      </tr>
      <tr>
        <td id="L10664" data-line-number="10664"></td>
        <td id="LC10664">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLFLTN</span>);</td>
      </tr>
      <tr>
        <td id="L10665" data-line-number="10665"></td>
        <td id="LC10665">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10666" data-line-number="10666"></td>
        <td id="LC10666">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10667" data-line-number="10667"></td>
        <td id="LC10667">                <span>case</span> <span>SqlDbType</span>.<span>UniqueIdentifier</span>:</td>
      </tr>
      <tr>
        <td id="L10668" data-line-number="10668"></td>
        <td id="LC10668">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLUNIQUEID</span>);</td>
      </tr>
      <tr>
        <td id="L10669" data-line-number="10669"></td>
        <td id="LC10669">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10670" data-line-number="10670"></td>
        <td id="LC10670">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10671" data-line-number="10671"></td>
        <td id="LC10671">                <span>case</span> <span>SqlDbType</span>.<span>SmallDateTime</span>:</td>
      </tr>
      <tr>
        <td id="L10672" data-line-number="10672"></td>
        <td id="LC10672">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLDATETIMN</span>);</td>
      </tr>
      <tr>
        <td id="L10673" data-line-number="10673"></td>
        <td id="LC10673">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10674" data-line-number="10674"></td>
        <td id="LC10674">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10675" data-line-number="10675"></td>
        <td id="LC10675">                <span>case</span> <span>SqlDbType</span>.<span>SmallInt</span>:</td>
      </tr>
      <tr>
        <td id="L10676" data-line-number="10676"></td>
        <td id="LC10676">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLINTN</span>);</td>
      </tr>
      <tr>
        <td id="L10677" data-line-number="10677"></td>
        <td id="LC10677">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10678" data-line-number="10678"></td>
        <td id="LC10678">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10679" data-line-number="10679"></td>
        <td id="LC10679">                <span>case</span> <span>SqlDbType</span>.<span>SmallMoney</span>:</td>
      </tr>
      <tr>
        <td id="L10680" data-line-number="10680"></td>
        <td id="LC10680">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLMONEYN</span>);</td>
      </tr>
      <tr>
        <td id="L10681" data-line-number="10681"></td>
        <td id="LC10681">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10682" data-line-number="10682"></td>
        <td id="LC10682">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10683" data-line-number="10683"></td>
        <td id="LC10683">                <span>case</span> <span>SqlDbType</span>.<span>Text</span>:</td>
      </tr>
      <tr>
        <td id="L10684" data-line-number="10684"></td>
        <td id="LC10684">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>);</td>
      </tr>
      <tr>
        <td id="L10685" data-line-number="10685"></td>
        <td id="LC10685">                    <span>WriteUnsignedShort</span>(<span>unchecked</span>((<span>ushort</span>)<span>SmiMetaData</span>.<span>UnlimitedMaxLengthIndicator</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10686" data-line-number="10686"></td>
        <td id="LC10686">                    <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> TODO: Use metadata's collation??</span></td>
      </tr>
      <tr>
        <td id="L10687" data-line-number="10687"></td>
        <td id="LC10687">                    <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L10688" data-line-number="10688"></td>
        <td id="LC10688">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10689" data-line-number="10689"></td>
        <td id="LC10689">                <span>case</span> <span>SqlDbType</span>.<span>Timestamp</span>:</td>
      </tr>
      <tr>
        <td id="L10690" data-line-number="10690"></td>
        <td id="LC10690">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGBINARY</span>);</td>
      </tr>
      <tr>
        <td id="L10691" data-line-number="10691"></td>
        <td id="LC10691">                    <span>WriteShort</span>(<span>checked</span>((<span>int</span>)<span>metaData</span>.<span>MaxLength</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10692" data-line-number="10692"></td>
        <td id="LC10692">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10693" data-line-number="10693"></td>
        <td id="LC10693">                <span>case</span> <span>SqlDbType</span>.<span>TinyInt</span>:</td>
      </tr>
      <tr>
        <td id="L10694" data-line-number="10694"></td>
        <td id="LC10694">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLINTN</span>);</td>
      </tr>
      <tr>
        <td id="L10695" data-line-number="10695"></td>
        <td id="LC10695">                    <span>stateObj</span>.<span>WriteByte</span>(<span>checked</span>((<span>byte</span>)<span>metaData</span>.<span>MaxLength</span>));</td>
      </tr>
      <tr>
        <td id="L10696" data-line-number="10696"></td>
        <td id="LC10696">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10697" data-line-number="10697"></td>
        <td id="LC10697">                <span>case</span> <span>SqlDbType</span>.<span>VarBinary</span>:</td>
      </tr>
      <tr>
        <td id="L10698" data-line-number="10698"></td>
        <td id="LC10698">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>);</td>
      </tr>
      <tr>
        <td id="L10699" data-line-number="10699"></td>
        <td id="LC10699">                    <span>WriteUnsignedShort</span>(<span>unchecked</span>((<span>ushort</span>)<span>metaData</span>.<span>MaxLength</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10700" data-line-number="10700"></td>
        <td id="LC10700">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10701" data-line-number="10701"></td>
        <td id="LC10701">                <span>case</span> <span>SqlDbType</span>.<span>VarChar</span>:</td>
      </tr>
      <tr>
        <td id="L10702" data-line-number="10702"></td>
        <td id="LC10702">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>);</td>
      </tr>
      <tr>
        <td id="L10703" data-line-number="10703"></td>
        <td id="LC10703">                    <span>WriteUnsignedShort</span>(<span>unchecked</span>((<span>ushort</span>)<span>metaData</span>.<span>MaxLength</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10704" data-line-number="10704"></td>
        <td id="LC10704">                    <span>WriteUnsignedInt</span>(<span>_defaultCollation</span>.<span>info</span>, <span>stateObj</span>); <span><span>//</span> TODO: Use metadata's collation??</span></td>
      </tr>
      <tr>
        <td id="L10705" data-line-number="10705"></td>
        <td id="LC10705">                    <span>stateObj</span>.<span>WriteByte</span>(<span>_defaultCollation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L10706" data-line-number="10706"></td>
        <td id="LC10706">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10707" data-line-number="10707"></td>
        <td id="LC10707">                <span>case</span> <span>SqlDbType</span>.<span>Variant</span>:</td>
      </tr>
      <tr>
        <td id="L10708" data-line-number="10708"></td>
        <td id="LC10708">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLVARIANT</span>);</td>
      </tr>
      <tr>
        <td id="L10709" data-line-number="10709"></td>
        <td id="LC10709">                    <span>WriteInt</span>(<span>checked</span>((<span>int</span>)<span>metaData</span>.<span>MaxLength</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10710" data-line-number="10710"></td>
        <td id="LC10710">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10711" data-line-number="10711"></td>
        <td id="LC10711">                <span>case</span> <span>SqlDbType</span>.<span>Xml</span>:</td>
      </tr>
      <tr>
        <td id="L10712" data-line-number="10712"></td>
        <td id="LC10712">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLXMLTYPE</span>);</td>
      </tr>
      <tr>
        <td id="L10713" data-line-number="10713"></td>
        <td id="LC10713">                    <span><span>//</span> Is there a schema</span></td>
      </tr>
      <tr>
        <td id="L10714" data-line-number="10714"></td>
        <td id="LC10714">                    <span>if</span> (<span>ADP</span>.<span>IsEmpty</span>(<span>metaData</span>.<span>TypeSpecificNamePart1</span>) <span>&amp;&amp;</span> <span>ADP</span>.<span>IsEmpty</span>(<span>metaData</span>.<span>TypeSpecificNamePart2</span>) <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L10715" data-line-number="10715"></td>
        <td id="LC10715">                            <span>ADP</span>.<span>IsEmpty</span>(<span>metaData</span>.<span>TypeSpecificNamePart3</span>))</td>
      </tr>
      <tr>
        <td id="L10716" data-line-number="10716"></td>
        <td id="LC10716">                    {</td>
      </tr>
      <tr>
        <td id="L10717" data-line-number="10717"></td>
        <td id="LC10717">                        <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);  <span><span>//</span> schema not present</span></td>
      </tr>
      <tr>
        <td id="L10718" data-line-number="10718"></td>
        <td id="LC10718">                    }</td>
      </tr>
      <tr>
        <td id="L10719" data-line-number="10719"></td>
        <td id="LC10719">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10720" data-line-number="10720"></td>
        <td id="LC10720">                    {</td>
      </tr>
      <tr>
        <td id="L10721" data-line-number="10721"></td>
        <td id="LC10721">                        <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>); <span><span>//</span> schema present</span></td>
      </tr>
      <tr>
        <td id="L10722" data-line-number="10722"></td>
        <td id="LC10722">                        <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart1</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10723" data-line-number="10723"></td>
        <td id="LC10723">                        <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart2</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10724" data-line-number="10724"></td>
        <td id="LC10724">                        <span>WriteIdentifierWithShortLength</span>(<span>metaData</span>.<span>TypeSpecificNamePart3</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10725" data-line-number="10725"></td>
        <td id="LC10725">                    }</td>
      </tr>
      <tr>
        <td id="L10726" data-line-number="10726"></td>
        <td id="LC10726">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10727" data-line-number="10727"></td>
        <td id="LC10727">                <span>case</span> <span>SqlDbType</span>.<span>Udt</span>:</td>
      </tr>
      <tr>
        <td id="L10728" data-line-number="10728"></td>
        <td id="LC10728">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLUDT</span>);</td>
      </tr>
      <tr>
        <td id="L10729" data-line-number="10729"></td>
        <td id="LC10729">                    <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart1</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10730" data-line-number="10730"></td>
        <td id="LC10730">                    <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart2</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10731" data-line-number="10731"></td>
        <td id="LC10731">                    <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart3</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10732" data-line-number="10732"></td>
        <td id="LC10732">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10733" data-line-number="10733"></td>
        <td id="LC10733">                <span>case</span> <span>SqlDbType</span>.<span>Structured</span>:</td>
      </tr>
      <tr>
        <td id="L10734" data-line-number="10734"></td>
        <td id="LC10734">                    <span>if</span> (<span>metaData</span>.<span>IsMultiValued</span>)</td>
      </tr>
      <tr>
        <td id="L10735" data-line-number="10735"></td>
        <td id="LC10735">                    {</td>
      </tr>
      <tr>
        <td id="L10736" data-line-number="10736"></td>
        <td id="LC10736">                        <span>WriteTvpTypeInfo</span>(<span>metaData</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10737" data-line-number="10737"></td>
        <td id="LC10737">                    }</td>
      </tr>
      <tr>
        <td id="L10738" data-line-number="10738"></td>
        <td id="LC10738">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L10739" data-line-number="10739"></td>
        <td id="LC10739">                    {</td>
      </tr>
      <tr>
        <td id="L10740" data-line-number="10740"></td>
        <td id="LC10740">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>SUDTs not yet supported.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10741" data-line-number="10741"></td>
        <td id="LC10741">                    }</td>
      </tr>
      <tr>
        <td id="L10742" data-line-number="10742"></td>
        <td id="LC10742">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10743" data-line-number="10743"></td>
        <td id="LC10743">                <span>case</span> <span>SqlDbType</span>.<span>Date</span>:</td>
      </tr>
      <tr>
        <td id="L10744" data-line-number="10744"></td>
        <td id="LC10744">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLDATE</span>);</td>
      </tr>
      <tr>
        <td id="L10745" data-line-number="10745"></td>
        <td id="LC10745">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10746" data-line-number="10746"></td>
        <td id="LC10746">                <span>case</span> <span>SqlDbType</span>.<span>Time</span>:</td>
      </tr>
      <tr>
        <td id="L10747" data-line-number="10747"></td>
        <td id="LC10747">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLTIME</span>);</td>
      </tr>
      <tr>
        <td id="L10748" data-line-number="10748"></td>
        <td id="LC10748">                    <span>stateObj</span>.<span>WriteByte</span>(<span>metaData</span>.<span>Scale</span>);</td>
      </tr>
      <tr>
        <td id="L10749" data-line-number="10749"></td>
        <td id="LC10749">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10750" data-line-number="10750"></td>
        <td id="LC10750">                <span>case</span> <span>SqlDbType</span>.<span>DateTime2</span>:</td>
      </tr>
      <tr>
        <td id="L10751" data-line-number="10751"></td>
        <td id="LC10751">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLDATETIME2</span>);</td>
      </tr>
      <tr>
        <td id="L10752" data-line-number="10752"></td>
        <td id="LC10752">                    <span>stateObj</span>.<span>WriteByte</span>(<span>metaData</span>.<span>Scale</span>);</td>
      </tr>
      <tr>
        <td id="L10753" data-line-number="10753"></td>
        <td id="LC10753">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10754" data-line-number="10754"></td>
        <td id="LC10754">                <span>case</span> <span>SqlDbType</span>.<span>DateTimeOffset</span>:</td>
      </tr>
      <tr>
        <td id="L10755" data-line-number="10755"></td>
        <td id="LC10755">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>);</td>
      </tr>
      <tr>
        <td id="L10756" data-line-number="10756"></td>
        <td id="LC10756">                    <span>stateObj</span>.<span>WriteByte</span>(<span>metaData</span>.<span>Scale</span>);</td>
      </tr>
      <tr>
        <td id="L10757" data-line-number="10757"></td>
        <td id="LC10757">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10758" data-line-number="10758"></td>
        <td id="LC10758">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L10759" data-line-number="10759"></td>
        <td id="LC10759">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown SqlDbType should have been caught earlier!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L10760" data-line-number="10760"></td>
        <td id="LC10760">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L10761" data-line-number="10761"></td>
        <td id="LC10761">            }</td>
      </tr>
      <tr>
        <td id="L10762" data-line-number="10762"></td>
        <td id="LC10762">        }</td>
      </tr>
      <tr>
        <td id="L10763" data-line-number="10763"></td>
        <td id="LC10763">
</td>
      </tr>
      <tr>
        <td id="L10764" data-line-number="10764"></td>
        <td id="LC10764">        <span>private</span> <span>void</span> <span>WriteTvpTypeInfo</span>(<span>SmiExtendedMetaData</span> <span>metaData</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10765" data-line-number="10765"></td>
        <td id="LC10765">        {</td>
      </tr>
      <tr>
        <td id="L10766" data-line-number="10766"></td>
        <td id="LC10766">            <span>Debug</span>.<span>Assert</span>(<span>SqlDbType</span>.<span>Structured</span> <span>==</span> <span>metaData</span>.<span>SqlDbType</span> <span>&amp;&amp;</span> <span>metaData</span>.<span>IsMultiValued</span>,</td>
      </tr>
      <tr>
        <td id="L10767" data-line-number="10767"></td>
        <td id="LC10767">                        <span><span>"</span>Invalid metadata for TVPs. Type=<span>"</span></span> <span>+</span> <span>metaData</span>.<span>SqlDbType</span>);</td>
      </tr>
      <tr>
        <td id="L10768" data-line-number="10768"></td>
        <td id="LC10768">            <span><span>//</span> Type token</span></td>
      </tr>
      <tr>
        <td id="L10769" data-line-number="10769"></td>
        <td id="LC10769">            <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>TdsEnums</span>.<span>SQLTABLE</span>);</td>
      </tr>
      <tr>
        <td id="L10770" data-line-number="10770"></td>
        <td id="LC10770">
</td>
      </tr>
      <tr>
        <td id="L10771" data-line-number="10771"></td>
        <td id="LC10771">            <span><span>//</span> 3-part name (DB, Schema, TypeName)</span></td>
      </tr>
      <tr>
        <td id="L10772" data-line-number="10772"></td>
        <td id="LC10772">            <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart1</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10773" data-line-number="10773"></td>
        <td id="LC10773">            <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart2</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10774" data-line-number="10774"></td>
        <td id="LC10774">            <span>WriteIdentifier</span>(<span>metaData</span>.<span>TypeSpecificNamePart3</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10775" data-line-number="10775"></td>
        <td id="LC10775">
</td>
      </tr>
      <tr>
        <td id="L10776" data-line-number="10776"></td>
        <td id="LC10776">            <span><span>//</span> TVP_COLMETADATA</span></td>
      </tr>
      <tr>
        <td id="L10777" data-line-number="10777"></td>
        <td id="LC10777">            <span>if</span> (<span>0</span> <span>==</span> <span>metaData</span>.<span>FieldMetaData</span>.<span>Count</span>)</td>
      </tr>
      <tr>
        <td id="L10778" data-line-number="10778"></td>
        <td id="LC10778">            {</td>
      </tr>
      <tr>
        <td id="L10779" data-line-number="10779"></td>
        <td id="LC10779">                <span>WriteUnsignedShort</span>((<span>ushort</span>)<span>TdsEnums</span>.<span>TVP_NOMETADATA_TOKEN</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10780" data-line-number="10780"></td>
        <td id="LC10780">            }</td>
      </tr>
      <tr>
        <td id="L10781" data-line-number="10781"></td>
        <td id="LC10781">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L10782" data-line-number="10782"></td>
        <td id="LC10782">            {</td>
      </tr>
      <tr>
        <td id="L10783" data-line-number="10783"></td>
        <td id="LC10783">                <span><span>//</span> COUNT of columns</span></td>
      </tr>
      <tr>
        <td id="L10784" data-line-number="10784"></td>
        <td id="LC10784">                <span>WriteUnsignedShort</span>(<span>checked</span>((<span>ushort</span>)<span>metaData</span>.<span>FieldMetaData</span>.<span>Count</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10785" data-line-number="10785"></td>
        <td id="LC10785">
</td>
      </tr>
      <tr>
        <td id="L10786" data-line-number="10786"></td>
        <td id="LC10786">                <span><span>//</span> TvpColumnMetaData for each column (look for defaults in this loop</span></td>
      </tr>
      <tr>
        <td id="L10787" data-line-number="10787"></td>
        <td id="LC10787">                <span>SmiDefaultFieldsProperty</span> <span>defaults</span> <span>=</span> (<span>SmiDefaultFieldsProperty</span>)<span>metaData</span>.<span>ExtendedProperties</span>[<span>SmiPropertySelector</span>.<span>DefaultFields</span>];</td>
      </tr>
      <tr>
        <td id="L10788" data-line-number="10788"></td>
        <td id="LC10788">                <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>metaData</span>.<span>FieldMetaData</span>.<span>Count</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L10789" data-line-number="10789"></td>
        <td id="LC10789">                {</td>
      </tr>
      <tr>
        <td id="L10790" data-line-number="10790"></td>
        <td id="LC10790">                    <span>WriteTvpColumnMetaData</span>(<span>metaData</span>.<span>FieldMetaData</span>[<span>i</span>], <span>defaults</span>[<span>i</span>], <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10791" data-line-number="10791"></td>
        <td id="LC10791">                }</td>
      </tr>
      <tr>
        <td id="L10792" data-line-number="10792"></td>
        <td id="LC10792">
</td>
      </tr>
      <tr>
        <td id="L10793" data-line-number="10793"></td>
        <td id="LC10793">                <span><span>//</span> optional OrderUnique metadata</span></td>
      </tr>
      <tr>
        <td id="L10794" data-line-number="10794"></td>
        <td id="LC10794">                <span>WriteTvpOrderUnique</span>(<span>metaData</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10795" data-line-number="10795"></td>
        <td id="LC10795">
</td>
      </tr>
      <tr>
        <td id="L10796" data-line-number="10796"></td>
        <td id="LC10796">            }</td>
      </tr>
      <tr>
        <td id="L10797" data-line-number="10797"></td>
        <td id="LC10797">
</td>
      </tr>
      <tr>
        <td id="L10798" data-line-number="10798"></td>
        <td id="LC10798">            <span><span>//</span> END of optional metadata</span></td>
      </tr>
      <tr>
        <td id="L10799" data-line-number="10799"></td>
        <td id="LC10799">            <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>TVP_END_TOKEN</span>);</td>
      </tr>
      <tr>
        <td id="L10800" data-line-number="10800"></td>
        <td id="LC10800">        }</td>
      </tr>
      <tr>
        <td id="L10801" data-line-number="10801"></td>
        <td id="LC10801">
</td>
      </tr>
      <tr>
        <td id="L10802" data-line-number="10802"></td>
        <td id="LC10802">        <span><span>//</span> Write a single TvpColumnMetaData stream to the server</span></td>
      </tr>
      <tr>
        <td id="L10803" data-line-number="10803"></td>
        <td id="LC10803">        <span>private</span> <span>void</span> <span>WriteTvpColumnMetaData</span>(<span>SmiExtendedMetaData</span> <span>md</span>, <span>bool</span> <span>isDefault</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10804" data-line-number="10804"></td>
        <td id="LC10804">        {</td>
      </tr>
      <tr>
        <td id="L10805" data-line-number="10805"></td>
        <td id="LC10805">            <span><span>//</span> User Type</span></td>
      </tr>
      <tr>
        <td id="L10806" data-line-number="10806"></td>
        <td id="LC10806">            <span>if</span> (<span>SqlDbType</span>.<span>Timestamp</span> <span>==</span> <span>md</span>.<span>SqlDbType</span>)</td>
      </tr>
      <tr>
        <td id="L10807" data-line-number="10807"></td>
        <td id="LC10807">            {</td>
      </tr>
      <tr>
        <td id="L10808" data-line-number="10808"></td>
        <td id="LC10808">                <span>WriteUnsignedInt</span>(<span>TdsEnums</span>.<span>SQLTIMESTAMP</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10809" data-line-number="10809"></td>
        <td id="LC10809">            }</td>
      </tr>
      <tr>
        <td id="L10810" data-line-number="10810"></td>
        <td id="LC10810">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L10811" data-line-number="10811"></td>
        <td id="LC10811">            {</td>
      </tr>
      <tr>
        <td id="L10812" data-line-number="10812"></td>
        <td id="LC10812">                <span>WriteUnsignedInt</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10813" data-line-number="10813"></td>
        <td id="LC10813">            }</td>
      </tr>
      <tr>
        <td id="L10814" data-line-number="10814"></td>
        <td id="LC10814">
</td>
      </tr>
      <tr>
        <td id="L10815" data-line-number="10815"></td>
        <td id="LC10815">            <span><span>//</span> Flags</span></td>
      </tr>
      <tr>
        <td id="L10816" data-line-number="10816"></td>
        <td id="LC10816">            <span>ushort</span> <span>status</span> <span>=</span> <span>TdsEnums</span>.<span>Nullable</span>;</td>
      </tr>
      <tr>
        <td id="L10817" data-line-number="10817"></td>
        <td id="LC10817">            <span>if</span> (<span>isDefault</span>)</td>
      </tr>
      <tr>
        <td id="L10818" data-line-number="10818"></td>
        <td id="LC10818">            {</td>
      </tr>
      <tr>
        <td id="L10819" data-line-number="10819"></td>
        <td id="LC10819">                <span>status</span> <span>|=</span> <span>TdsEnums</span>.<span>TVP_DEFAULT_COLUMN</span>;</td>
      </tr>
      <tr>
        <td id="L10820" data-line-number="10820"></td>
        <td id="LC10820">            }</td>
      </tr>
      <tr>
        <td id="L10821" data-line-number="10821"></td>
        <td id="LC10821">            <span>WriteUnsignedShort</span>(<span>status</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10822" data-line-number="10822"></td>
        <td id="LC10822">
</td>
      </tr>
      <tr>
        <td id="L10823" data-line-number="10823"></td>
        <td id="LC10823">            <span><span>//</span> Type info</span></td>
      </tr>
      <tr>
        <td id="L10824" data-line-number="10824"></td>
        <td id="LC10824">            <span>WriteSmiTypeInfo</span>(<span>md</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10825" data-line-number="10825"></td>
        <td id="LC10825">
</td>
      </tr>
      <tr>
        <td id="L10826" data-line-number="10826"></td>
        <td id="LC10826">            <span><span>//</span> Column name</span></td>
      </tr>
      <tr>
        <td id="L10827" data-line-number="10827"></td>
        <td id="LC10827">            <span><span>//</span> per spec, "ColName is never sent to server or client for TVP, it is required within a TVP to be zero length."</span></td>
      </tr>
      <tr>
        <td id="L10828" data-line-number="10828"></td>
        <td id="LC10828">            <span>WriteIdentifier</span>(<span>null</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10829" data-line-number="10829"></td>
        <td id="LC10829">        }</td>
      </tr>
      <tr>
        <td id="L10830" data-line-number="10830"></td>
        <td id="LC10830">
</td>
      </tr>
      <tr>
        <td id="L10831" data-line-number="10831"></td>
        <td id="LC10831">        <span><span>//</span> temporary-results structure used only by WriteTvpOrderUnique</span></td>
      </tr>
      <tr>
        <td id="L10832" data-line-number="10832"></td>
        <td id="LC10832">        <span><span>//</span>  use class to avoid List&lt;T&gt;'s per-struct-instantiated memory costs.</span></td>
      </tr>
      <tr>
        <td id="L10833" data-line-number="10833"></td>
        <td id="LC10833">        <span>private</span> <span>class</span> <span>TdsOrderUnique</span></td>
      </tr>
      <tr>
        <td id="L10834" data-line-number="10834"></td>
        <td id="LC10834">        {</td>
      </tr>
      <tr>
        <td id="L10835" data-line-number="10835"></td>
        <td id="LC10835">            <span>internal</span> <span>short</span> <span>ColumnOrdinal</span>;</td>
      </tr>
      <tr>
        <td id="L10836" data-line-number="10836"></td>
        <td id="LC10836">            <span>internal</span> <span>byte</span> <span>Flags</span>;</td>
      </tr>
      <tr>
        <td id="L10837" data-line-number="10837"></td>
        <td id="LC10837">
</td>
      </tr>
      <tr>
        <td id="L10838" data-line-number="10838"></td>
        <td id="LC10838">            <span>internal</span> <span>TdsOrderUnique</span>(<span>short</span> <span>ordinal</span>, <span>byte</span> <span>flags</span>)</td>
      </tr>
      <tr>
        <td id="L10839" data-line-number="10839"></td>
        <td id="LC10839">            {</td>
      </tr>
      <tr>
        <td id="L10840" data-line-number="10840"></td>
        <td id="LC10840">                <span>ColumnOrdinal</span> <span>=</span> <span>ordinal</span>;</td>
      </tr>
      <tr>
        <td id="L10841" data-line-number="10841"></td>
        <td id="LC10841">                <span>Flags</span> <span>=</span> <span>flags</span>;</td>
      </tr>
      <tr>
        <td id="L10842" data-line-number="10842"></td>
        <td id="LC10842">            }</td>
      </tr>
      <tr>
        <td id="L10843" data-line-number="10843"></td>
        <td id="LC10843">        }</td>
      </tr>
      <tr>
        <td id="L10844" data-line-number="10844"></td>
        <td id="LC10844">
</td>
      </tr>
      <tr>
        <td id="L10845" data-line-number="10845"></td>
        <td id="LC10845">        <span>private</span> <span>void</span> <span>WriteTvpOrderUnique</span>(<span>SmiExtendedMetaData</span> <span>metaData</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10846" data-line-number="10846"></td>
        <td id="LC10846">        {</td>
      </tr>
      <tr>
        <td id="L10847" data-line-number="10847"></td>
        <td id="LC10847">            <span><span>//</span> TVP_ORDER_UNIQUE token (uniqueness and sort order)</span></td>
      </tr>
      <tr>
        <td id="L10848" data-line-number="10848"></td>
        <td id="LC10848">
</td>
      </tr>
      <tr>
        <td id="L10849" data-line-number="10849"></td>
        <td id="LC10849">            <span><span>//</span> Merge order and unique keys into a single token stream</span></td>
      </tr>
      <tr>
        <td id="L10850" data-line-number="10850"></td>
        <td id="LC10850">
</td>
      </tr>
      <tr>
        <td id="L10851" data-line-number="10851"></td>
        <td id="LC10851">            <span>SmiOrderProperty</span> <span>orderProperty</span> <span>=</span> (<span>SmiOrderProperty</span>)<span>metaData</span>.<span>ExtendedProperties</span>[<span>SmiPropertySelector</span>.<span>SortOrder</span>];</td>
      </tr>
      <tr>
        <td id="L10852" data-line-number="10852"></td>
        <td id="LC10852">            <span>SmiUniqueKeyProperty</span> <span>uniqueKeyProperty</span> <span>=</span> (<span>SmiUniqueKeyProperty</span>)<span>metaData</span>.<span>ExtendedProperties</span>[<span>SmiPropertySelector</span>.<span>UniqueKey</span>];</td>
      </tr>
      <tr>
        <td id="L10853" data-line-number="10853"></td>
        <td id="LC10853">
</td>
      </tr>
      <tr>
        <td id="L10854" data-line-number="10854"></td>
        <td id="LC10854">            <span><span>//</span> Build list from</span></td>
      </tr>
      <tr>
        <td id="L10855" data-line-number="10855"></td>
        <td id="LC10855">            <span>List</span>&lt;<span>TdsOrderUnique</span>&gt; <span>columnList</span> <span>=</span> <span>new</span> <span>List</span>&lt;<span>TdsOrderUnique</span>&gt;(<span>metaData</span>.<span>FieldMetaData</span>.<span>Count</span>);</td>
      </tr>
      <tr>
        <td id="L10856" data-line-number="10856"></td>
        <td id="LC10856">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>metaData</span>.<span>FieldMetaData</span>.<span>Count</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L10857" data-line-number="10857"></td>
        <td id="LC10857">            {</td>
      </tr>
      <tr>
        <td id="L10858" data-line-number="10858"></td>
        <td id="LC10858">
</td>
      </tr>
      <tr>
        <td id="L10859" data-line-number="10859"></td>
        <td id="LC10859">                <span><span>//</span> Add appropriate SortOrder flag</span></td>
      </tr>
      <tr>
        <td id="L10860" data-line-number="10860"></td>
        <td id="LC10860">                <span>byte</span> <span>flags</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L10861" data-line-number="10861"></td>
        <td id="LC10861">                <span>SmiOrderProperty</span>.<span>SmiColumnOrder</span> <span>columnOrder</span> <span>=</span> <span>orderProperty</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L10862" data-line-number="10862"></td>
        <td id="LC10862">                <span>if</span> (<span>SortOrder</span>.<span>Ascending</span> <span>==</span> <span>columnOrder</span>.<span>Order</span>)</td>
      </tr>
      <tr>
        <td id="L10863" data-line-number="10863"></td>
        <td id="LC10863">                {</td>
      </tr>
      <tr>
        <td id="L10864" data-line-number="10864"></td>
        <td id="LC10864">                    <span>flags</span> <span>=</span> <span>TdsEnums</span>.<span>TVP_ORDERASC_FLAG</span>;</td>
      </tr>
      <tr>
        <td id="L10865" data-line-number="10865"></td>
        <td id="LC10865">                }</td>
      </tr>
      <tr>
        <td id="L10866" data-line-number="10866"></td>
        <td id="LC10866">                <span>else</span> <span>if</span> (<span>SortOrder</span>.<span>Descending</span> <span>==</span> <span>columnOrder</span>.<span>Order</span>)</td>
      </tr>
      <tr>
        <td id="L10867" data-line-number="10867"></td>
        <td id="LC10867">                {</td>
      </tr>
      <tr>
        <td id="L10868" data-line-number="10868"></td>
        <td id="LC10868">                    <span>flags</span> <span>=</span> <span>TdsEnums</span>.<span>TVP_ORDERDESC_FLAG</span>;</td>
      </tr>
      <tr>
        <td id="L10869" data-line-number="10869"></td>
        <td id="LC10869">                }</td>
      </tr>
      <tr>
        <td id="L10870" data-line-number="10870"></td>
        <td id="LC10870">
</td>
      </tr>
      <tr>
        <td id="L10871" data-line-number="10871"></td>
        <td id="LC10871">                <span><span>//</span> Add unique key flage if appropriate</span></td>
      </tr>
      <tr>
        <td id="L10872" data-line-number="10872"></td>
        <td id="LC10872">                <span>if</span> (<span>uniqueKeyProperty</span>[<span>i</span>])</td>
      </tr>
      <tr>
        <td id="L10873" data-line-number="10873"></td>
        <td id="LC10873">                {</td>
      </tr>
      <tr>
        <td id="L10874" data-line-number="10874"></td>
        <td id="LC10874">                    <span>flags</span> <span>|=</span> <span>TdsEnums</span>.<span>TVP_UNIQUE_FLAG</span>;</td>
      </tr>
      <tr>
        <td id="L10875" data-line-number="10875"></td>
        <td id="LC10875">                }</td>
      </tr>
      <tr>
        <td id="L10876" data-line-number="10876"></td>
        <td id="LC10876">
</td>
      </tr>
      <tr>
        <td id="L10877" data-line-number="10877"></td>
        <td id="LC10877">                <span><span>//</span> Remember this column if any flags were set</span></td>
      </tr>
      <tr>
        <td id="L10878" data-line-number="10878"></td>
        <td id="LC10878">                <span>if</span> (<span>0</span> <span>!=</span> <span>flags</span>)</td>
      </tr>
      <tr>
        <td id="L10879" data-line-number="10879"></td>
        <td id="LC10879">                {</td>
      </tr>
      <tr>
        <td id="L10880" data-line-number="10880"></td>
        <td id="LC10880">                    <span>columnList</span>.<span>Add</span>(<span>new</span> <span>TdsOrderUnique</span>(<span>checked</span>((<span>short</span>)(<span>i</span> <span>+</span> <span>1</span>)), <span>flags</span>));</td>
      </tr>
      <tr>
        <td id="L10881" data-line-number="10881"></td>
        <td id="LC10881">                }</td>
      </tr>
      <tr>
        <td id="L10882" data-line-number="10882"></td>
        <td id="LC10882">            }</td>
      </tr>
      <tr>
        <td id="L10883" data-line-number="10883"></td>
        <td id="LC10883">
</td>
      </tr>
      <tr>
        <td id="L10884" data-line-number="10884"></td>
        <td id="LC10884">            <span><span>//</span> Write flagged columns to wire...</span></td>
      </tr>
      <tr>
        <td id="L10885" data-line-number="10885"></td>
        <td id="LC10885">            <span>if</span> (<span>0</span> <span>&lt;</span> <span>columnList</span>.<span>Count</span>)</td>
      </tr>
      <tr>
        <td id="L10886" data-line-number="10886"></td>
        <td id="LC10886">            {</td>
      </tr>
      <tr>
        <td id="L10887" data-line-number="10887"></td>
        <td id="LC10887">                <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>TVP_ORDER_UNIQUE_TOKEN</span>);</td>
      </tr>
      <tr>
        <td id="L10888" data-line-number="10888"></td>
        <td id="LC10888">                <span>WriteShort</span>(<span>columnList</span>.<span>Count</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10889" data-line-number="10889"></td>
        <td id="LC10889">                <span>foreach</span> (<span>TdsOrderUnique</span> <span>column</span> <span>in</span> <span>columnList</span>)</td>
      </tr>
      <tr>
        <td id="L10890" data-line-number="10890"></td>
        <td id="LC10890">                {</td>
      </tr>
      <tr>
        <td id="L10891" data-line-number="10891"></td>
        <td id="LC10891">                    <span>WriteShort</span>(<span>column</span>.<span>ColumnOrdinal</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10892" data-line-number="10892"></td>
        <td id="LC10892">                    <span>stateObj</span>.<span>WriteByte</span>(<span>column</span>.<span>Flags</span>);</td>
      </tr>
      <tr>
        <td id="L10893" data-line-number="10893"></td>
        <td id="LC10893">                }</td>
      </tr>
      <tr>
        <td id="L10894" data-line-number="10894"></td>
        <td id="LC10894">            }</td>
      </tr>
      <tr>
        <td id="L10895" data-line-number="10895"></td>
        <td id="LC10895">        }</td>
      </tr>
      <tr>
        <td id="L10896" data-line-number="10896"></td>
        <td id="LC10896">
</td>
      </tr>
      <tr>
        <td id="L10897" data-line-number="10897"></td>
        <td id="LC10897">        <span>internal</span> <span>Task</span> <span>WriteBulkCopyDone</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10898" data-line-number="10898"></td>
        <td id="LC10898">        {</td>
      </tr>
      <tr>
        <td id="L10899" data-line-number="10899"></td>
        <td id="LC10899">            <span><span>//</span> Write DONE packet</span></td>
      </tr>
      <tr>
        <td id="L10900" data-line-number="10900"></td>
        <td id="LC10900">            <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L10901" data-line-number="10901"></td>
        <td id="LC10901">            <span>if</span> (<span>!</span>(<span>State</span> <span>==</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span> <span>||</span> <span>State</span> <span>==</span> <span>TdsParserState</span>.<span>OpenLoggedIn</span>))</td>
      </tr>
      <tr>
        <td id="L10902" data-line-number="10902"></td>
        <td id="LC10902">            {</td>
      </tr>
      <tr>
        <td id="L10903" data-line-number="10903"></td>
        <td id="LC10903">                <span>throw</span> <span>ADP</span>.<span>ClosedConnectionError</span>();</td>
      </tr>
      <tr>
        <td id="L10904" data-line-number="10904"></td>
        <td id="LC10904">            }</td>
      </tr>
      <tr>
        <td id="L10905" data-line-number="10905"></td>
        <td id="LC10905">            <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLDONE</span>);</td>
      </tr>
      <tr>
        <td id="L10906" data-line-number="10906"></td>
        <td id="LC10906">            <span>WriteShort</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10907" data-line-number="10907"></td>
        <td id="LC10907">            <span>WriteShort</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10908" data-line-number="10908"></td>
        <td id="LC10908">            <span>WriteInt</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10909" data-line-number="10909"></td>
        <td id="LC10909">
</td>
      </tr>
      <tr>
        <td id="L10910" data-line-number="10910"></td>
        <td id="LC10910">            <span>stateObj</span>.<span>_pendingData</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L10911" data-line-number="10911"></td>
        <td id="LC10911">            <span>stateObj</span>.<span>_messageStatus</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L10912" data-line-number="10912"></td>
        <td id="LC10912">            <span>return</span> <span>stateObj</span>.<span>WritePacket</span>(<span>TdsEnums</span>.<span>HARDFLUSH</span>);</td>
      </tr>
      <tr>
        <td id="L10913" data-line-number="10913"></td>
        <td id="LC10913">        }</td>
      </tr>
      <tr>
        <td id="L10914" data-line-number="10914"></td>
        <td id="LC10914">
</td>
      </tr>
      <tr>
        <td id="L10915" data-line-number="10915"></td>
        <td id="LC10915">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10916" data-line-number="10916"></td>
        <td id="LC10916">        <span><span>///</span> Loads the column encryptions keys into cache. This will read the master key info,</span></td>
      </tr>
      <tr>
        <td id="L10917" data-line-number="10917"></td>
        <td id="LC10917">        <span><span>///</span> decrypt the CEK and keep it ready for encryption.</span></td>
      </tr>
      <tr>
        <td id="L10918" data-line-number="10918"></td>
        <td id="LC10918">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10919" data-line-number="10919"></td>
        <td id="LC10919">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10920" data-line-number="10920"></td>
        <td id="LC10920">        <span>internal</span> <span>void</span> <span>LoadColumnEncryptionKeys</span>(<span>_SqlMetaDataSet</span> <span>metadataCollection</span>, <span>string</span> <span>serverName</span>)</td>
      </tr>
      <tr>
        <td id="L10921" data-line-number="10921"></td>
        <td id="LC10921">        {</td>
      </tr>
      <tr>
        <td id="L10922" data-line-number="10922"></td>
        <td id="LC10922">            <span>if</span> (<span>_serverSupportsColumnEncryption</span> <span>&amp;&amp;</span> <span>ShouldEncryptValuesForBulkCopy</span>())</td>
      </tr>
      <tr>
        <td id="L10923" data-line-number="10923"></td>
        <td id="LC10923">            {</td>
      </tr>
      <tr>
        <td id="L10924" data-line-number="10924"></td>
        <td id="LC10924">                <span>for</span> (<span>int</span> <span>col</span> <span>=</span> <span>0</span>; <span>col</span> <span>&lt;</span> <span>metadataCollection</span>.<span>Length</span>; <span>col</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L10925" data-line-number="10925"></td>
        <td id="LC10925">                {</td>
      </tr>
      <tr>
        <td id="L10926" data-line-number="10926"></td>
        <td id="LC10926">                    <span>if</span> (<span>null</span> <span>!=</span> <span>metadataCollection</span>[<span>col</span>])</td>
      </tr>
      <tr>
        <td id="L10927" data-line-number="10927"></td>
        <td id="LC10927">                    {</td>
      </tr>
      <tr>
        <td id="L10928" data-line-number="10928"></td>
        <td id="LC10928">                        <span>_SqlMetaData</span> <span>md</span> <span>=</span> <span>metadataCollection</span>[<span>col</span>];</td>
      </tr>
      <tr>
        <td id="L10929" data-line-number="10929"></td>
        <td id="LC10929">                        <span>if</span> (<span>md</span>.<span>isEncrypted</span>)</td>
      </tr>
      <tr>
        <td id="L10930" data-line-number="10930"></td>
        <td id="LC10930">                        {</td>
      </tr>
      <tr>
        <td id="L10931" data-line-number="10931"></td>
        <td id="LC10931">                            <span>SqlSecurityUtility</span>.<span>DecryptSymmetricKey</span>(<span>md</span>.<span>cipherMD</span>, <span>serverName</span>);</td>
      </tr>
      <tr>
        <td id="L10932" data-line-number="10932"></td>
        <td id="LC10932">                        }</td>
      </tr>
      <tr>
        <td id="L10933" data-line-number="10933"></td>
        <td id="LC10933">                    }</td>
      </tr>
      <tr>
        <td id="L10934" data-line-number="10934"></td>
        <td id="LC10934">                }</td>
      </tr>
      <tr>
        <td id="L10935" data-line-number="10935"></td>
        <td id="LC10935">            }</td>
      </tr>
      <tr>
        <td id="L10936" data-line-number="10936"></td>
        <td id="LC10936">        }</td>
      </tr>
      <tr>
        <td id="L10937" data-line-number="10937"></td>
        <td id="LC10937">
</td>
      </tr>
      <tr>
        <td id="L10938" data-line-number="10938"></td>
        <td id="LC10938">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10939" data-line-number="10939"></td>
        <td id="LC10939">        <span><span>///</span> Writes a single entry of CEK Table into TDS Stream (for bulk copy).</span></td>
      </tr>
      <tr>
        <td id="L10940" data-line-number="10940"></td>
        <td id="LC10940">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10941" data-line-number="10941"></td>
        <td id="LC10941">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10942" data-line-number="10942"></td>
        <td id="LC10942">        <span>internal</span> <span>void</span> <span>WriteEncryptionEntries</span>(<span>ref</span> <span>SqlTceCipherInfoTable</span> <span>cekTable</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10943" data-line-number="10943"></td>
        <td id="LC10943">        {</td>
      </tr>
      <tr>
        <td id="L10944" data-line-number="10944"></td>
        <td id="LC10944">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>cekTable</span>.<span>Size</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L10945" data-line-number="10945"></td>
        <td id="LC10945">            {</td>
      </tr>
      <tr>
        <td id="L10946" data-line-number="10946"></td>
        <td id="LC10946">                <span><span>//</span> Write Db ID</span></td>
      </tr>
      <tr>
        <td id="L10947" data-line-number="10947"></td>
        <td id="LC10947">                <span>WriteInt</span>(<span>cekTable</span>[<span>i</span>].<span>DatabaseId</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10948" data-line-number="10948"></td>
        <td id="LC10948">
</td>
      </tr>
      <tr>
        <td id="L10949" data-line-number="10949"></td>
        <td id="LC10949">                <span><span>//</span> Write Key ID</span></td>
      </tr>
      <tr>
        <td id="L10950" data-line-number="10950"></td>
        <td id="LC10950">                <span>WriteInt</span>(<span>cekTable</span>[<span>i</span>].<span>CekId</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10951" data-line-number="10951"></td>
        <td id="LC10951">
</td>
      </tr>
      <tr>
        <td id="L10952" data-line-number="10952"></td>
        <td id="LC10952">                <span><span>//</span> Write Key Version</span></td>
      </tr>
      <tr>
        <td id="L10953" data-line-number="10953"></td>
        <td id="LC10953">                <span>WriteInt</span>(<span>cekTable</span>[<span>i</span>].<span>CekVersion</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10954" data-line-number="10954"></td>
        <td id="LC10954">
</td>
      </tr>
      <tr>
        <td id="L10955" data-line-number="10955"></td>
        <td id="LC10955">                <span><span>//</span> Write 8 bytes of key MD Version</span></td>
      </tr>
      <tr>
        <td id="L10956" data-line-number="10956"></td>
        <td id="LC10956">                <span>Debug</span>.<span>Assert</span>(<span>8</span> <span>==</span> <span>cekTable</span>[<span>i</span>].<span>CekMdVersion</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L10957" data-line-number="10957"></td>
        <td id="LC10957">                <span>stateObj</span>.<span>WriteByteArray</span>(<span>cekTable</span>[<span>i</span>].<span>CekMdVersion</span>, <span>8</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L10958" data-line-number="10958"></td>
        <td id="LC10958">
</td>
      </tr>
      <tr>
        <td id="L10959" data-line-number="10959"></td>
        <td id="LC10959">                <span><span>//</span> We don't really need to send the keys</span></td>
      </tr>
      <tr>
        <td id="L10960" data-line-number="10960"></td>
        <td id="LC10960">                <span>stateObj</span>.<span>WriteByte</span>(<span>0x00</span>);</td>
      </tr>
      <tr>
        <td id="L10961" data-line-number="10961"></td>
        <td id="LC10961">            }</td>
      </tr>
      <tr>
        <td id="L10962" data-line-number="10962"></td>
        <td id="LC10962">        }</td>
      </tr>
      <tr>
        <td id="L10963" data-line-number="10963"></td>
        <td id="LC10963">
</td>
      </tr>
      <tr>
        <td id="L10964" data-line-number="10964"></td>
        <td id="LC10964">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10965" data-line-number="10965"></td>
        <td id="LC10965">        <span><span>///</span> Writes a CEK Table (as part of  COLMETADATA token) for bulk copy.</span></td>
      </tr>
      <tr>
        <td id="L10966" data-line-number="10966"></td>
        <td id="LC10966">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10967" data-line-number="10967"></td>
        <td id="LC10967">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10968" data-line-number="10968"></td>
        <td id="LC10968">        <span>internal</span> <span>void</span> <span>WriteCekTable</span>(<span>_SqlMetaDataSet</span> <span>metadataCollection</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10969" data-line-number="10969"></td>
        <td id="LC10969">        {</td>
      </tr>
      <tr>
        <td id="L10970" data-line-number="10970"></td>
        <td id="LC10970">            <span>if</span> (<span>!</span><span>_serverSupportsColumnEncryption</span>)</td>
      </tr>
      <tr>
        <td id="L10971" data-line-number="10971"></td>
        <td id="LC10971">            {</td>
      </tr>
      <tr>
        <td id="L10972" data-line-number="10972"></td>
        <td id="LC10972">                <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L10973" data-line-number="10973"></td>
        <td id="LC10973">            }</td>
      </tr>
      <tr>
        <td id="L10974" data-line-number="10974"></td>
        <td id="LC10974">
</td>
      </tr>
      <tr>
        <td id="L10975" data-line-number="10975"></td>
        <td id="LC10975">            <span><span>//</span> If no cek table is present, send a count of 0 for table size</span></td>
      </tr>
      <tr>
        <td id="L10976" data-line-number="10976"></td>
        <td id="LC10976">            <span><span>//</span>     Note- Cek table (with 0 entries) will be present if TCE</span></td>
      </tr>
      <tr>
        <td id="L10977" data-line-number="10977"></td>
        <td id="LC10977">            <span><span>//</span>     was enabled and server supports it!</span></td>
      </tr>
      <tr>
        <td id="L10978" data-line-number="10978"></td>
        <td id="LC10978">            <span><span>//</span> OR if encryption was disabled in connection options</span></td>
      </tr>
      <tr>
        <td id="L10979" data-line-number="10979"></td>
        <td id="LC10979">            <span>if</span> (<span>!</span><span>metadataCollection</span>.<span>cekTable</span>.<span>HasValue</span> <span>||</span></td>
      </tr>
      <tr>
        <td id="L10980" data-line-number="10980"></td>
        <td id="LC10980">                <span>!</span><span>ShouldEncryptValuesForBulkCopy</span>())</td>
      </tr>
      <tr>
        <td id="L10981" data-line-number="10981"></td>
        <td id="LC10981">            {</td>
      </tr>
      <tr>
        <td id="L10982" data-line-number="10982"></td>
        <td id="LC10982">                <span>WriteShort</span>(<span>0x00</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10983" data-line-number="10983"></td>
        <td id="LC10983">                <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L10984" data-line-number="10984"></td>
        <td id="LC10984">            }</td>
      </tr>
      <tr>
        <td id="L10985" data-line-number="10985"></td>
        <td id="LC10985">
</td>
      </tr>
      <tr>
        <td id="L10986" data-line-number="10986"></td>
        <td id="LC10986">            <span>SqlTceCipherInfoTable</span> <span>cekTable</span> <span>=</span> <span>metadataCollection</span>.<span>cekTable</span>.<span>Value</span>;</td>
      </tr>
      <tr>
        <td id="L10987" data-line-number="10987"></td>
        <td id="LC10987">            <span>ushort</span> <span>count</span> <span>=</span> (<span>ushort</span>)<span>cekTable</span>.<span>Size</span>;</td>
      </tr>
      <tr>
        <td id="L10988" data-line-number="10988"></td>
        <td id="LC10988">
</td>
      </tr>
      <tr>
        <td id="L10989" data-line-number="10989"></td>
        <td id="LC10989">            <span>WriteShort</span>(<span>count</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10990" data-line-number="10990"></td>
        <td id="LC10990">
</td>
      </tr>
      <tr>
        <td id="L10991" data-line-number="10991"></td>
        <td id="LC10991">            <span>WriteEncryptionEntries</span>(<span>ref</span> <span>cekTable</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L10992" data-line-number="10992"></td>
        <td id="LC10992">        }</td>
      </tr>
      <tr>
        <td id="L10993" data-line-number="10993"></td>
        <td id="LC10993">
</td>
      </tr>
      <tr>
        <td id="L10994" data-line-number="10994"></td>
        <td id="LC10994">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10995" data-line-number="10995"></td>
        <td id="LC10995">        <span><span>///</span> Writes the UserType and TYPE_INFO values for CryptoMetadata (for bulk copy).</span></td>
      </tr>
      <tr>
        <td id="L10996" data-line-number="10996"></td>
        <td id="LC10996">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10997" data-line-number="10997"></td>
        <td id="LC10997">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L10998" data-line-number="10998"></td>
        <td id="LC10998">        <span>internal</span> <span>void</span> <span>WriteTceUserTypeAndTypeInfo</span>(<span>SqlMetaDataPriv</span> <span>mdPriv</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L10999" data-line-number="10999"></td>
        <td id="LC10999">        {</td>
      </tr>
      <tr>
        <td id="L11000" data-line-number="11000"></td>
        <td id="LC11000">            <span><span>//</span> Write the UserType (4 byte value)</span></td>
      </tr>
      <tr>
        <td id="L11001" data-line-number="11001"></td>
        <td id="LC11001">            <span>WriteInt</span>(<span>0x0</span>, <span>stateObj</span>); <span><span>//</span> TODO: fix this- timestamp columns have 0x50 value here</span></td>
      </tr>
      <tr>
        <td id="L11002" data-line-number="11002"></td>
        <td id="LC11002">
</td>
      </tr>
      <tr>
        <td id="L11003" data-line-number="11003"></td>
        <td id="LC11003">            <span>Debug</span>.<span>Assert</span>(<span>SqlDbType</span>.<span>Xml</span> <span>!=</span> <span>mdPriv</span>.<span>type</span>);</td>
      </tr>
      <tr>
        <td id="L11004" data-line-number="11004"></td>
        <td id="LC11004">            <span>Debug</span>.<span>Assert</span>(<span>SqlDbType</span>.<span>Udt</span> <span>!=</span> <span>mdPriv</span>.<span>type</span>);</td>
      </tr>
      <tr>
        <td id="L11005" data-line-number="11005"></td>
        <td id="LC11005">
</td>
      </tr>
      <tr>
        <td id="L11006" data-line-number="11006"></td>
        <td id="LC11006">            <span>stateObj</span>.<span>WriteByte</span>(<span>mdPriv</span>.<span>tdsType</span>);</td>
      </tr>
      <tr>
        <td id="L11007" data-line-number="11007"></td>
        <td id="LC11007">
</td>
      </tr>
      <tr>
        <td id="L11008" data-line-number="11008"></td>
        <td id="LC11008">            <span>switch</span> (<span>mdPriv</span>.<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L11009" data-line-number="11009"></td>
        <td id="LC11009">            {</td>
      </tr>
      <tr>
        <td id="L11010" data-line-number="11010"></td>
        <td id="LC11010">                <span>case</span> <span>SqlDbType</span>.<span>Decimal</span>:</td>
      </tr>
      <tr>
        <td id="L11011" data-line-number="11011"></td>
        <td id="LC11011">                    <span>WriteTokenLength</span>(<span>mdPriv</span>.<span>tdsType</span>, <span>mdPriv</span>.<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11012" data-line-number="11012"></td>
        <td id="LC11012">                    <span>stateObj</span>.<span>WriteByte</span>(<span>mdPriv</span>.<span>precision</span>);</td>
      </tr>
      <tr>
        <td id="L11013" data-line-number="11013"></td>
        <td id="LC11013">                    <span>stateObj</span>.<span>WriteByte</span>(<span>mdPriv</span>.<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L11014" data-line-number="11014"></td>
        <td id="LC11014">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11015" data-line-number="11015"></td>
        <td id="LC11015">                <span>case</span> <span>SqlDbType</span>.<span>Date</span>:</td>
      </tr>
      <tr>
        <td id="L11016" data-line-number="11016"></td>
        <td id="LC11016">                    <span><span>//</span> Nothing more to write!</span></td>
      </tr>
      <tr>
        <td id="L11017" data-line-number="11017"></td>
        <td id="LC11017">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11018" data-line-number="11018"></td>
        <td id="LC11018">                <span>case</span> <span>SqlDbType</span>.<span>Time</span>:</td>
      </tr>
      <tr>
        <td id="L11019" data-line-number="11019"></td>
        <td id="LC11019">                <span>case</span> <span>SqlDbType</span>.<span>DateTime2</span>:</td>
      </tr>
      <tr>
        <td id="L11020" data-line-number="11020"></td>
        <td id="LC11020">                <span>case</span> <span>SqlDbType</span>.<span>DateTimeOffset</span>:</td>
      </tr>
      <tr>
        <td id="L11021" data-line-number="11021"></td>
        <td id="LC11021">                    <span>stateObj</span>.<span>WriteByte</span>(<span>mdPriv</span>.<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L11022" data-line-number="11022"></td>
        <td id="LC11022">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11023" data-line-number="11023"></td>
        <td id="LC11023">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L11024" data-line-number="11024"></td>
        <td id="LC11024">                    <span>WriteTokenLength</span>(<span>mdPriv</span>.<span>tdsType</span>, <span>mdPriv</span>.<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11025" data-line-number="11025"></td>
        <td id="LC11025">                    <span>if</span> (<span>mdPriv</span>.<span>metaType</span>.<span>IsCharType</span> <span>&amp;&amp;</span> <span>_isShiloh</span>)</td>
      </tr>
      <tr>
        <td id="L11026" data-line-number="11026"></td>
        <td id="LC11026">                    {</td>
      </tr>
      <tr>
        <td id="L11027" data-line-number="11027"></td>
        <td id="LC11027">                        <span>WriteUnsignedInt</span>(<span>mdPriv</span>.<span>collation</span>.<span>info</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11028" data-line-number="11028"></td>
        <td id="LC11028">                        <span>stateObj</span>.<span>WriteByte</span>(<span>mdPriv</span>.<span>collation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L11029" data-line-number="11029"></td>
        <td id="LC11029">                    }</td>
      </tr>
      <tr>
        <td id="L11030" data-line-number="11030"></td>
        <td id="LC11030">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11031" data-line-number="11031"></td>
        <td id="LC11031">            }</td>
      </tr>
      <tr>
        <td id="L11032" data-line-number="11032"></td>
        <td id="LC11032">        }</td>
      </tr>
      <tr>
        <td id="L11033" data-line-number="11033"></td>
        <td id="LC11033">
</td>
      </tr>
      <tr>
        <td id="L11034" data-line-number="11034"></td>
        <td id="LC11034">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11035" data-line-number="11035"></td>
        <td id="LC11035">        <span><span>///</span> Writes the crypto metadata (as part of COLMETADATA token) for encrypted columns.</span></td>
      </tr>
      <tr>
        <td id="L11036" data-line-number="11036"></td>
        <td id="LC11036">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11037" data-line-number="11037"></td>
        <td id="LC11037">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11038" data-line-number="11038"></td>
        <td id="LC11038">        <span>internal</span> <span>void</span> <span>WriteCryptoMetadata</span>(<span>_SqlMetaData</span> <span>md</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L11039" data-line-number="11039"></td>
        <td id="LC11039">        {</td>
      </tr>
      <tr>
        <td id="L11040" data-line-number="11040"></td>
        <td id="LC11040">            <span>if</span> (<span>!</span><span>_serverSupportsColumnEncryption</span> <span>||</span> <span><span>//</span> TCE Feature supported</span></td>
      </tr>
      <tr>
        <td id="L11041" data-line-number="11041"></td>
        <td id="LC11041">                <span>!</span><span>md</span>.<span>isEncrypted</span> <span>||</span> <span><span>//</span> Column is not encrypted</span></td>
      </tr>
      <tr>
        <td id="L11042" data-line-number="11042"></td>
        <td id="LC11042">                <span>!</span><span>ShouldEncryptValuesForBulkCopy</span>())</td>
      </tr>
      <tr>
        <td id="L11043" data-line-number="11043"></td>
        <td id="LC11043">            { <span><span>//</span> TCE disabled on connection string</span></td>
      </tr>
      <tr>
        <td id="L11044" data-line-number="11044"></td>
        <td id="LC11044">                <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L11045" data-line-number="11045"></td>
        <td id="LC11045">            }</td>
      </tr>
      <tr>
        <td id="L11046" data-line-number="11046"></td>
        <td id="LC11046">
</td>
      </tr>
      <tr>
        <td id="L11047" data-line-number="11047"></td>
        <td id="LC11047">            <span><span>//</span> Write the ordinal</span></td>
      </tr>
      <tr>
        <td id="L11048" data-line-number="11048"></td>
        <td id="LC11048">            <span>WriteShort</span>(<span>md</span>.<span>cipherMD</span>.<span>CekTableOrdinal</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11049" data-line-number="11049"></td>
        <td id="LC11049">
</td>
      </tr>
      <tr>
        <td id="L11050" data-line-number="11050"></td>
        <td id="LC11050">            <span><span>//</span> Write UserType and TYPEINFO</span></td>
      </tr>
      <tr>
        <td id="L11051" data-line-number="11051"></td>
        <td id="LC11051">            <span>WriteTceUserTypeAndTypeInfo</span>(<span>md</span>.<span>baseTI</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11052" data-line-number="11052"></td>
        <td id="LC11052">
</td>
      </tr>
      <tr>
        <td id="L11053" data-line-number="11053"></td>
        <td id="LC11053">            <span><span>//</span> Write Encryption Algo</span></td>
      </tr>
      <tr>
        <td id="L11054" data-line-number="11054"></td>
        <td id="LC11054">            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>cipherMD</span>.<span>CipherAlgorithmId</span>);</td>
      </tr>
      <tr>
        <td id="L11055" data-line-number="11055"></td>
        <td id="LC11055">
</td>
      </tr>
      <tr>
        <td id="L11056" data-line-number="11056"></td>
        <td id="LC11056">            <span>if</span> (<span>TdsEnums</span>.<span>CustomCipherAlgorithmId</span> <span>==</span> <span>md</span>.<span>cipherMD</span>.<span>CipherAlgorithmId</span>)</td>
      </tr>
      <tr>
        <td id="L11057" data-line-number="11057"></td>
        <td id="LC11057">            {</td>
      </tr>
      <tr>
        <td id="L11058" data-line-number="11058"></td>
        <td id="LC11058">                <span><span>//</span> Write the algorithm name</span></td>
      </tr>
      <tr>
        <td id="L11059" data-line-number="11059"></td>
        <td id="LC11059">                <span>Debug</span>.<span>Assert</span>(<span>md</span>.<span>cipherMD</span>.<span>CipherAlgorithmName</span>.<span>Length</span> <span>&lt;</span> <span>256</span>);</td>
      </tr>
      <tr>
        <td id="L11060" data-line-number="11060"></td>
        <td id="LC11060">                <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>md</span>.<span>cipherMD</span>.<span>CipherAlgorithmName</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L11061" data-line-number="11061"></td>
        <td id="LC11061">                <span>WriteString</span>(<span>md</span>.<span>cipherMD</span>.<span>CipherAlgorithmName</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11062" data-line-number="11062"></td>
        <td id="LC11062">            }</td>
      </tr>
      <tr>
        <td id="L11063" data-line-number="11063"></td>
        <td id="LC11063">
</td>
      </tr>
      <tr>
        <td id="L11064" data-line-number="11064"></td>
        <td id="LC11064">            <span><span>//</span> Write Encryption Algo Type</span></td>
      </tr>
      <tr>
        <td id="L11065" data-line-number="11065"></td>
        <td id="LC11065">            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>cipherMD</span>.<span>EncryptionType</span>);</td>
      </tr>
      <tr>
        <td id="L11066" data-line-number="11066"></td>
        <td id="LC11066">
</td>
      </tr>
      <tr>
        <td id="L11067" data-line-number="11067"></td>
        <td id="LC11067">            <span><span>//</span> Write Normalization Version</span></td>
      </tr>
      <tr>
        <td id="L11068" data-line-number="11068"></td>
        <td id="LC11068">            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>cipherMD</span>.<span>NormalizationRuleVersion</span>);</td>
      </tr>
      <tr>
        <td id="L11069" data-line-number="11069"></td>
        <td id="LC11069">        }</td>
      </tr>
      <tr>
        <td id="L11070" data-line-number="11070"></td>
        <td id="LC11070">
</td>
      </tr>
      <tr>
        <td id="L11071" data-line-number="11071"></td>
        <td id="LC11071">        <span>internal</span> <span>void</span> <span>WriteBulkCopyMetaData</span>(<span>_SqlMetaDataSet</span> <span>metadataCollection</span>, <span>int</span> <span>count</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L11072" data-line-number="11072"></td>
        <td id="LC11072">        {</td>
      </tr>
      <tr>
        <td id="L11073" data-line-number="11073"></td>
        <td id="LC11073">            <span>if</span> (<span>!</span>(<span>State</span> <span>==</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span> <span>||</span> <span>State</span> <span>==</span> <span>TdsParserState</span>.<span>OpenLoggedIn</span>))</td>
      </tr>
      <tr>
        <td id="L11074" data-line-number="11074"></td>
        <td id="LC11074">            {</td>
      </tr>
      <tr>
        <td id="L11075" data-line-number="11075"></td>
        <td id="LC11075">                <span>throw</span> <span>ADP</span>.<span>ClosedConnectionError</span>();</td>
      </tr>
      <tr>
        <td id="L11076" data-line-number="11076"></td>
        <td id="LC11076">            }</td>
      </tr>
      <tr>
        <td id="L11077" data-line-number="11077"></td>
        <td id="LC11077">
</td>
      </tr>
      <tr>
        <td id="L11078" data-line-number="11078"></td>
        <td id="LC11078">            <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLCOLMETADATA</span>);</td>
      </tr>
      <tr>
        <td id="L11079" data-line-number="11079"></td>
        <td id="LC11079">            <span>WriteShort</span>(<span>count</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11080" data-line-number="11080"></td>
        <td id="LC11080">
</td>
      </tr>
      <tr>
        <td id="L11081" data-line-number="11081"></td>
        <td id="LC11081">            <span><span>//</span> Write CEK table - 0 count</span></td>
      </tr>
      <tr>
        <td id="L11082" data-line-number="11082"></td>
        <td id="LC11082">            <span>WriteCekTable</span>(<span>metadataCollection</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11083" data-line-number="11083"></td>
        <td id="LC11083">
</td>
      </tr>
      <tr>
        <td id="L11084" data-line-number="11084"></td>
        <td id="LC11084">            <span>for</span> (<span>int</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>metadataCollection</span>.<span>Length</span>; <span>i</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L11085" data-line-number="11085"></td>
        <td id="LC11085">            {</td>
      </tr>
      <tr>
        <td id="L11086" data-line-number="11086"></td>
        <td id="LC11086">                <span>if</span> (<span>metadataCollection</span>[<span>i</span>] <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L11087" data-line-number="11087"></td>
        <td id="LC11087">                {</td>
      </tr>
      <tr>
        <td id="L11088" data-line-number="11088"></td>
        <td id="LC11088">                    <span>_SqlMetaData</span> <span>md</span> <span>=</span> <span>metadataCollection</span>[<span>i</span>];</td>
      </tr>
      <tr>
        <td id="L11089" data-line-number="11089"></td>
        <td id="LC11089">
</td>
      </tr>
      <tr>
        <td id="L11090" data-line-number="11090"></td>
        <td id="LC11090">                    <span><span>//</span> read user type - 4 bytes Yukon, 2 backwards</span></td>
      </tr>
      <tr>
        <td id="L11091" data-line-number="11091"></td>
        <td id="LC11091">                    <span>if</span> (<span>IsYukonOrNewer</span>)</td>
      </tr>
      <tr>
        <td id="L11092" data-line-number="11092"></td>
        <td id="LC11092">                    {</td>
      </tr>
      <tr>
        <td id="L11093" data-line-number="11093"></td>
        <td id="LC11093">                        <span>WriteInt</span>(<span>0x0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11094" data-line-number="11094"></td>
        <td id="LC11094">                    }</td>
      </tr>
      <tr>
        <td id="L11095" data-line-number="11095"></td>
        <td id="LC11095">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11096" data-line-number="11096"></td>
        <td id="LC11096">                    {</td>
      </tr>
      <tr>
        <td id="L11097" data-line-number="11097"></td>
        <td id="LC11097">                        <span>WriteShort</span>(<span>0x0000</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11098" data-line-number="11098"></td>
        <td id="LC11098">                    }</td>
      </tr>
      <tr>
        <td id="L11099" data-line-number="11099"></td>
        <td id="LC11099">
</td>
      </tr>
      <tr>
        <td id="L11100" data-line-number="11100"></td>
        <td id="LC11100">                    <span><span>//</span> Write the flags</span></td>
      </tr>
      <tr>
        <td id="L11101" data-line-number="11101"></td>
        <td id="LC11101">                    <span>UInt16</span> <span>flags</span>;</td>
      </tr>
      <tr>
        <td id="L11102" data-line-number="11102"></td>
        <td id="LC11102">                    <span>flags</span> <span>=</span> (<span>UInt16</span>)(<span>md</span>.<span>Updatability</span> <span>&lt;&lt;</span> <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L11103" data-line-number="11103"></td>
        <td id="LC11103">                    <span>flags</span> <span>|=</span> (<span>UInt16</span>)(<span>md</span>.<span>IsNullable</span> <span>?</span> (<span>UInt16</span>)<span>TdsEnums</span>.<span>Nullable</span> <span>:</span> (<span>UInt16</span>)<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11104" data-line-number="11104"></td>
        <td id="LC11104">                    <span>flags</span> <span>|=</span> (<span>UInt16</span>)(<span>md</span>.<span>IsIdentity</span> <span>?</span> (<span>UInt16</span>)<span>TdsEnums</span>.<span>Identity</span> <span>:</span> (<span>UInt16</span>)<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11105" data-line-number="11105"></td>
        <td id="LC11105">
</td>
      </tr>
      <tr>
        <td id="L11106" data-line-number="11106"></td>
        <td id="LC11106">                    <span><span>//</span> Write the next byte of flags</span></td>
      </tr>
      <tr>
        <td id="L11107" data-line-number="11107"></td>
        <td id="LC11107">                    <span>if</span> (<span>_serverSupportsColumnEncryption</span>)</td>
      </tr>
      <tr>
        <td id="L11108" data-line-number="11108"></td>
        <td id="LC11108">                    { <span><span>//</span> TCE Supported</span></td>
      </tr>
      <tr>
        <td id="L11109" data-line-number="11109"></td>
        <td id="LC11109">                        <span>if</span> (<span>ShouldEncryptValuesForBulkCopy</span>())</td>
      </tr>
      <tr>
        <td id="L11110" data-line-number="11110"></td>
        <td id="LC11110">                        { <span><span>//</span> TCE enabled on connection options</span></td>
      </tr>
      <tr>
        <td id="L11111" data-line-number="11111"></td>
        <td id="LC11111">                            <span>flags</span> <span>|=</span> (<span>UInt16</span>)(<span>md</span>.<span>isEncrypted</span> <span>?</span> (<span>UInt16</span>)(<span>TdsEnums</span>.<span>IsEncrypted</span> <span>&lt;&lt;</span> <span>8</span>) <span>:</span> (<span>UInt16</span>)<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11112" data-line-number="11112"></td>
        <td id="LC11112">                        }</td>
      </tr>
      <tr>
        <td id="L11113" data-line-number="11113"></td>
        <td id="LC11113">                    }</td>
      </tr>
      <tr>
        <td id="L11114" data-line-number="11114"></td>
        <td id="LC11114">
</td>
      </tr>
      <tr>
        <td id="L11115" data-line-number="11115"></td>
        <td id="LC11115">                    <span>WriteShort</span>(<span>flags</span>, <span>stateObj</span>);<span><span>//</span> write the flags</span></td>
      </tr>
      <tr>
        <td id="L11116" data-line-number="11116"></td>
        <td id="LC11116">
</td>
      </tr>
      <tr>
        <td id="L11117" data-line-number="11117"></td>
        <td id="LC11117">                    <span><span>//</span> todo:</span></td>
      </tr>
      <tr>
        <td id="L11118" data-line-number="11118"></td>
        <td id="LC11118">                    <span><span>//</span> for xml WriteTokenLength results in a no-op</span></td>
      </tr>
      <tr>
        <td id="L11119" data-line-number="11119"></td>
        <td id="LC11119">                    <span><span>//</span> discuss ...</span></td>
      </tr>
      <tr>
        <td id="L11120" data-line-number="11120"></td>
        <td id="LC11120">                    <span><span>//</span> xml datatype does not have token length in its metadata. So it should be a noop.</span></td>
      </tr>
      <tr>
        <td id="L11121" data-line-number="11121"></td>
        <td id="LC11121">
</td>
      </tr>
      <tr>
        <td id="L11122" data-line-number="11122"></td>
        <td id="LC11122">                    <span>switch</span> (<span>md</span>.<span>type</span>)</td>
      </tr>
      <tr>
        <td id="L11123" data-line-number="11123"></td>
        <td id="LC11123">                    {</td>
      </tr>
      <tr>
        <td id="L11124" data-line-number="11124"></td>
        <td id="LC11124">                        <span>case</span> <span>SqlDbType</span>.<span>Decimal</span>:</td>
      </tr>
      <tr>
        <td id="L11125" data-line-number="11125"></td>
        <td id="LC11125">                            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>tdsType</span>);</td>
      </tr>
      <tr>
        <td id="L11126" data-line-number="11126"></td>
        <td id="LC11126">                            <span>WriteTokenLength</span>(<span>md</span>.<span>tdsType</span>, <span>md</span>.<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11127" data-line-number="11127"></td>
        <td id="LC11127">                            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>precision</span>);</td>
      </tr>
      <tr>
        <td id="L11128" data-line-number="11128"></td>
        <td id="LC11128">                            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L11129" data-line-number="11129"></td>
        <td id="LC11129">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11130" data-line-number="11130"></td>
        <td id="LC11130">                        <span>case</span> <span>SqlDbType</span>.<span>Xml</span>:</td>
      </tr>
      <tr>
        <td id="L11131" data-line-number="11131"></td>
        <td id="LC11131">                            <span><span>//</span> TODO: This doesn't look right. Needs fixing.</span></td>
      </tr>
      <tr>
        <td id="L11132" data-line-number="11132"></td>
        <td id="LC11132">                            <span>stateObj</span>.<span>WriteByteArray</span>(<span>s_xmlMetadataSubstituteSequence</span>, <span>s_xmlMetadataSubstituteSequence</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11133" data-line-number="11133"></td>
        <td id="LC11133">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11134" data-line-number="11134"></td>
        <td id="LC11134">                        <span>case</span> <span>SqlDbType</span>.<span>Udt</span>:</td>
      </tr>
      <tr>
        <td id="L11135" data-line-number="11135"></td>
        <td id="LC11135">                            <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>);</td>
      </tr>
      <tr>
        <td id="L11136" data-line-number="11136"></td>
        <td id="LC11136">                            <span>WriteTokenLength</span>(<span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>, <span>md</span>.<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11137" data-line-number="11137"></td>
        <td id="LC11137">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11138" data-line-number="11138"></td>
        <td id="LC11138">                        <span>case</span> <span>SqlDbType</span>.<span>Date</span>:</td>
      </tr>
      <tr>
        <td id="L11139" data-line-number="11139"></td>
        <td id="LC11139">                            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>tdsType</span>);</td>
      </tr>
      <tr>
        <td id="L11140" data-line-number="11140"></td>
        <td id="LC11140">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11141" data-line-number="11141"></td>
        <td id="LC11141">                        <span>case</span> <span>SqlDbType</span>.<span>Time</span>:</td>
      </tr>
      <tr>
        <td id="L11142" data-line-number="11142"></td>
        <td id="LC11142">                        <span>case</span> <span>SqlDbType</span>.<span>DateTime2</span>:</td>
      </tr>
      <tr>
        <td id="L11143" data-line-number="11143"></td>
        <td id="LC11143">                        <span>case</span> <span>SqlDbType</span>.<span>DateTimeOffset</span>:</td>
      </tr>
      <tr>
        <td id="L11144" data-line-number="11144"></td>
        <td id="LC11144">                            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>tdsType</span>);</td>
      </tr>
      <tr>
        <td id="L11145" data-line-number="11145"></td>
        <td id="LC11145">                            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L11146" data-line-number="11146"></td>
        <td id="LC11146">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11147" data-line-number="11147"></td>
        <td id="LC11147">                        <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L11148" data-line-number="11148"></td>
        <td id="LC11148">                            <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>tdsType</span>);</td>
      </tr>
      <tr>
        <td id="L11149" data-line-number="11149"></td>
        <td id="LC11149">                            <span>WriteTokenLength</span>(<span>md</span>.<span>tdsType</span>, <span>md</span>.<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11150" data-line-number="11150"></td>
        <td id="LC11150">                            <span>if</span> (<span>md</span>.<span>metaType</span>.<span>IsCharType</span> <span>&amp;&amp;</span> <span>_isShiloh</span>)</td>
      </tr>
      <tr>
        <td id="L11151" data-line-number="11151"></td>
        <td id="LC11151">                            {</td>
      </tr>
      <tr>
        <td id="L11152" data-line-number="11152"></td>
        <td id="LC11152">                                <span>WriteUnsignedInt</span>(<span>md</span>.<span>collation</span>.<span>info</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11153" data-line-number="11153"></td>
        <td id="LC11153">                                <span>stateObj</span>.<span>WriteByte</span>(<span>md</span>.<span>collation</span>.<span>sortId</span>);</td>
      </tr>
      <tr>
        <td id="L11154" data-line-number="11154"></td>
        <td id="LC11154">                            }</td>
      </tr>
      <tr>
        <td id="L11155" data-line-number="11155"></td>
        <td id="LC11155">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11156" data-line-number="11156"></td>
        <td id="LC11156">                    }</td>
      </tr>
      <tr>
        <td id="L11157" data-line-number="11157"></td>
        <td id="LC11157">
</td>
      </tr>
      <tr>
        <td id="L11158" data-line-number="11158"></td>
        <td id="LC11158">                    <span>if</span> (<span>md</span>.<span>metaType</span>.<span>IsLong</span> <span>&amp;&amp;</span> <span>!</span><span>md</span>.<span>metaType</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L11159" data-line-number="11159"></td>
        <td id="LC11159">                    {</td>
      </tr>
      <tr>
        <td id="L11160" data-line-number="11160"></td>
        <td id="LC11160">                        <span>WriteShort</span>(<span>md</span>.<span>tableName</span>.<span>Length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11161" data-line-number="11161"></td>
        <td id="LC11161">                        <span>WriteString</span>(<span>md</span>.<span>tableName</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11162" data-line-number="11162"></td>
        <td id="LC11162">                    }</td>
      </tr>
      <tr>
        <td id="L11163" data-line-number="11163"></td>
        <td id="LC11163">
</td>
      </tr>
      <tr>
        <td id="L11164" data-line-number="11164"></td>
        <td id="LC11164">                    <span>WriteCryptoMetadata</span>(<span>md</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11165" data-line-number="11165"></td>
        <td id="LC11165">
</td>
      </tr>
      <tr>
        <td id="L11166" data-line-number="11166"></td>
        <td id="LC11166">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>md</span>.<span>column</span>.<span>Length</span>);</td>
      </tr>
      <tr>
        <td id="L11167" data-line-number="11167"></td>
        <td id="LC11167">                    <span>WriteString</span>(<span>md</span>.<span>column</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11168" data-line-number="11168"></td>
        <td id="LC11168">                }</td>
      </tr>
      <tr>
        <td id="L11169" data-line-number="11169"></td>
        <td id="LC11169">            } <span><span>//</span> end for loop</span></td>
      </tr>
      <tr>
        <td id="L11170" data-line-number="11170"></td>
        <td id="LC11170">        }</td>
      </tr>
      <tr>
        <td id="L11171" data-line-number="11171"></td>
        <td id="LC11171">
</td>
      </tr>
      <tr>
        <td id="L11172" data-line-number="11172"></td>
        <td id="LC11172">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11173" data-line-number="11173"></td>
        <td id="LC11173">        <span><span>///</span> Determines if a column value should be encrypted when using BulkCopy (based on connectionstring setting).</span></td>
      </tr>
      <tr>
        <td id="L11174" data-line-number="11174"></td>
        <td id="LC11174">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11175" data-line-number="11175"></td>
        <td id="LC11175">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11176" data-line-number="11176"></td>
        <td id="LC11176">        <span>internal</span> <span>bool</span> <span>ShouldEncryptValuesForBulkCopy</span>()</td>
      </tr>
      <tr>
        <td id="L11177" data-line-number="11177"></td>
        <td id="LC11177">        {</td>
      </tr>
      <tr>
        <td id="L11178" data-line-number="11178"></td>
        <td id="LC11178">            <span>if</span> (<span>null</span> <span>!=</span> <span>_connHandler</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L11179" data-line-number="11179"></td>
        <td id="LC11179">                <span>null</span> <span>!=</span> <span>_connHandler</span>.<span>ConnectionOptions</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L11180" data-line-number="11180"></td>
        <td id="LC11180">                <span>SqlConnectionColumnEncryptionSetting</span>.<span>Enabled</span> <span>==</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>ColumnEncryptionSetting</span>)</td>
      </tr>
      <tr>
        <td id="L11181" data-line-number="11181"></td>
        <td id="LC11181">            {</td>
      </tr>
      <tr>
        <td id="L11182" data-line-number="11182"></td>
        <td id="LC11182">                <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L11183" data-line-number="11183"></td>
        <td id="LC11183">            }</td>
      </tr>
      <tr>
        <td id="L11184" data-line-number="11184"></td>
        <td id="LC11184">
</td>
      </tr>
      <tr>
        <td id="L11185" data-line-number="11185"></td>
        <td id="LC11185">            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L11186" data-line-number="11186"></td>
        <td id="LC11186">        }</td>
      </tr>
      <tr>
        <td id="L11187" data-line-number="11187"></td>
        <td id="LC11187">
</td>
      </tr>
      <tr>
        <td id="L11188" data-line-number="11188"></td>
        <td id="LC11188">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11189" data-line-number="11189"></td>
        <td id="LC11189">        <span><span>///</span> Encrypts a column value (for SqlBulkCopy)</span></td>
      </tr>
      <tr>
        <td id="L11190" data-line-number="11190"></td>
        <td id="LC11190">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11191" data-line-number="11191"></td>
        <td id="LC11191">        <span><span>///</span> &lt;<span><span>returns</span></span>&gt;&lt;/<span><span>returns</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L11192" data-line-number="11192"></td>
        <td id="LC11192">        <span>internal</span> <span>object</span> <span>EncryptColumnValue</span>(<span>object</span> <span>value</span>, <span>SqlMetaDataPriv</span> <span>metadata</span>, <span>string</span> <span>column</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>isDataFeed</span>, <span>bool</span> <span>isSqlType</span>)</td>
      </tr>
      <tr>
        <td id="L11193" data-line-number="11193"></td>
        <td id="LC11193">        {</td>
      </tr>
      <tr>
        <td id="L11194" data-line-number="11194"></td>
        <td id="LC11194">            <span>Debug</span>.<span>Assert</span>(<span>_serverSupportsColumnEncryption</span>, <span><span>"</span>Server doesn't support encryption, yet we received encryption metadata<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11195" data-line-number="11195"></td>
        <td id="LC11195">            <span>Debug</span>.<span>Assert</span>(<span>ShouldEncryptValuesForBulkCopy</span>(), <span><span>"</span>Encryption attempted when not requested<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11196" data-line-number="11196"></td>
        <td id="LC11196">
</td>
      </tr>
      <tr>
        <td id="L11197" data-line-number="11197"></td>
        <td id="LC11197">            <span>if</span> (<span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L11198" data-line-number="11198"></td>
        <td id="LC11198">            { <span><span>//</span> can't encrypt a stream column</span></td>
      </tr>
      <tr>
        <td id="L11199" data-line-number="11199"></td>
        <td id="LC11199">                <span>SQL</span>.<span>StreamNotSupportOnEncryptedColumn</span>(<span>column</span>);</td>
      </tr>
      <tr>
        <td id="L11200" data-line-number="11200"></td>
        <td id="LC11200">            }</td>
      </tr>
      <tr>
        <td id="L11201" data-line-number="11201"></td>
        <td id="LC11201">
</td>
      </tr>
      <tr>
        <td id="L11202" data-line-number="11202"></td>
        <td id="LC11202">            <span>int</span> <span>actualLengthInBytes</span>;</td>
      </tr>
      <tr>
        <td id="L11203" data-line-number="11203"></td>
        <td id="LC11203">            <span>switch</span> (<span>metadata</span>.<span>baseTI</span>.<span>metaType</span>.<span>NullableType</span>)</td>
      </tr>
      <tr>
        <td id="L11204" data-line-number="11204"></td>
        <td id="LC11204">            {</td>
      </tr>
      <tr>
        <td id="L11205" data-line-number="11205"></td>
        <td id="LC11205">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L11206" data-line-number="11206"></td>
        <td id="LC11206">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L11207" data-line-number="11207"></td>
        <td id="LC11207">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L11208" data-line-number="11208"></td>
        <td id="LC11208">                    <span><span>//</span> For some datatypes, engine does truncation before storing the value. (For example, when</span></td>
      </tr>
      <tr>
        <td id="L11209" data-line-number="11209"></td>
        <td id="LC11209">                    <span><span>//</span> trying to insert a varbinary(7000) into a varbinary(3000) column). Since we encrypt the</span></td>
      </tr>
      <tr>
        <td id="L11210" data-line-number="11210"></td>
        <td id="LC11210">                    <span><span>//</span> column values, engine has no way to tell the size of the plaintext datatype. Therefore,</span></td>
      </tr>
      <tr>
        <td id="L11211" data-line-number="11211"></td>
        <td id="LC11211">                    <span><span>//</span> we truncate the values based on target column sizes here before encrypting them. This</span></td>
      </tr>
      <tr>
        <td id="L11212" data-line-number="11212"></td>
        <td id="LC11212">                    <span><span>//</span> truncation is only needed if we exceed the max column length or if the target column is</span></td>
      </tr>
      <tr>
        <td id="L11213" data-line-number="11213"></td>
        <td id="LC11213">                    <span><span>//</span> not a blob type (eg. varbinary(max)). The actual work of truncating the column happens</span></td>
      </tr>
      <tr>
        <td id="L11214" data-line-number="11214"></td>
        <td id="LC11214">                    <span><span>//</span> when we normalize and serialize the data buffers. The serialization routine expects us</span></td>
      </tr>
      <tr>
        <td id="L11215" data-line-number="11215"></td>
        <td id="LC11215">                    <span><span>//</span> to report the size of data to be copied out (for serialization). If we underreport the</span></td>
      </tr>
      <tr>
        <td id="L11216" data-line-number="11216"></td>
        <td id="LC11216">                    <span><span>//</span> size, truncation will happen for us!</span></td>
      </tr>
      <tr>
        <td id="L11217" data-line-number="11217"></td>
        <td id="LC11217">                    <span>actualLengthInBytes</span> <span>=</span> (<span>isSqlType</span>) <span>?</span> ((<span>SqlBinary</span>)<span>value</span>).<span>Length</span> <span>:</span> ((<span>byte</span>[])<span>value</span>).<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L11218" data-line-number="11218"></td>
        <td id="LC11218">                    <span>if</span> (<span>metadata</span>.<span>baseTI</span>.<span>length</span> <span>&gt;</span> <span>0</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L11219" data-line-number="11219"></td>
        <td id="LC11219">                        <span>actualLengthInBytes</span> <span>&gt;</span> <span>metadata</span>.<span>baseTI</span>.<span>length</span>)</td>
      </tr>
      <tr>
        <td id="L11220" data-line-number="11220"></td>
        <td id="LC11220">                    { <span><span>//</span> see comments agove</span></td>
      </tr>
      <tr>
        <td id="L11221" data-line-number="11221"></td>
        <td id="LC11221">                        <span>actualLengthInBytes</span> <span>=</span> <span>metadata</span>.<span>baseTI</span>.<span>length</span>;</td>
      </tr>
      <tr>
        <td id="L11222" data-line-number="11222"></td>
        <td id="LC11222">                    }</td>
      </tr>
      <tr>
        <td id="L11223" data-line-number="11223"></td>
        <td id="LC11223">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11224" data-line-number="11224"></td>
        <td id="LC11224">
</td>
      </tr>
      <tr>
        <td id="L11225" data-line-number="11225"></td>
        <td id="LC11225">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L11226" data-line-number="11226"></td>
        <td id="LC11226">                    <span>actualLengthInBytes</span> <span>=</span> <span>GUID_SIZE</span>;   <span><span>//</span> that's a constant for guid</span></td>
      </tr>
      <tr>
        <td id="L11227" data-line-number="11227"></td>
        <td id="LC11227">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11228" data-line-number="11228"></td>
        <td id="LC11228">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11229" data-line-number="11229"></td>
        <td id="LC11229">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11230" data-line-number="11230"></td>
        <td id="LC11230">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L11231" data-line-number="11231"></td>
        <td id="LC11231">                    <span>if</span> (<span>null</span> <span>==</span> <span>_defaultEncoding</span>)</td>
      </tr>
      <tr>
        <td id="L11232" data-line-number="11232"></td>
        <td id="LC11232">                    {</td>
      </tr>
      <tr>
        <td id="L11233" data-line-number="11233"></td>
        <td id="LC11233">                        <span>ThrowUnsupportedCollationEncountered</span>(<span>null</span>); <span><span>//</span> stateObject only when reading</span></td>
      </tr>
      <tr>
        <td id="L11234" data-line-number="11234"></td>
        <td id="LC11234">                    }</td>
      </tr>
      <tr>
        <td id="L11235" data-line-number="11235"></td>
        <td id="LC11235">
</td>
      </tr>
      <tr>
        <td id="L11236" data-line-number="11236"></td>
        <td id="LC11236">                    <span>string</span> <span>stringValue</span> <span>=</span> (<span>isSqlType</span>) <span>?</span> ((<span>SqlString</span>)<span>value</span>).<span>Value</span> <span>:</span> (<span>string</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L11237" data-line-number="11237"></td>
        <td id="LC11237">                    <span>actualLengthInBytes</span> <span>=</span> <span>_defaultEncoding</span>.<span>GetByteCount</span>(<span>stringValue</span>);</td>
      </tr>
      <tr>
        <td id="L11238" data-line-number="11238"></td>
        <td id="LC11238">
</td>
      </tr>
      <tr>
        <td id="L11239" data-line-number="11239"></td>
        <td id="LC11239">                    <span><span>//</span> If the string length is &gt; max length, then use the max length (see comments above)</span></td>
      </tr>
      <tr>
        <td id="L11240" data-line-number="11240"></td>
        <td id="LC11240">                    <span>if</span> (<span>metadata</span>.<span>baseTI</span>.<span>length</span> <span>&gt;</span> <span>0</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L11241" data-line-number="11241"></td>
        <td id="LC11241">                        <span>actualLengthInBytes</span> <span>&gt;</span> <span>metadata</span>.<span>baseTI</span>.<span>length</span>)</td>
      </tr>
      <tr>
        <td id="L11242" data-line-number="11242"></td>
        <td id="LC11242">                    {</td>
      </tr>
      <tr>
        <td id="L11243" data-line-number="11243"></td>
        <td id="LC11243">                        <span>actualLengthInBytes</span> <span>=</span> <span>metadata</span>.<span>baseTI</span>.<span>length</span>; <span><span>//</span> this ensure truncation!</span></td>
      </tr>
      <tr>
        <td id="L11244" data-line-number="11244"></td>
        <td id="LC11244">                    }</td>
      </tr>
      <tr>
        <td id="L11245" data-line-number="11245"></td>
        <td id="LC11245">
</td>
      </tr>
      <tr>
        <td id="L11246" data-line-number="11246"></td>
        <td id="LC11246">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11247" data-line-number="11247"></td>
        <td id="LC11247">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11248" data-line-number="11248"></td>
        <td id="LC11248">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11249" data-line-number="11249"></td>
        <td id="LC11249">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L11250" data-line-number="11250"></td>
        <td id="LC11250">                    <span>actualLengthInBytes</span> <span>=</span> ((<span>isSqlType</span>) <span>?</span> ((<span>SqlString</span>)<span>value</span>).<span>Value</span>.<span>Length</span> <span>:</span> ((<span>string</span>)<span>value</span>).<span>Length</span>) <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L11251" data-line-number="11251"></td>
        <td id="LC11251">
</td>
      </tr>
      <tr>
        <td id="L11252" data-line-number="11252"></td>
        <td id="LC11252">                    <span>if</span> (<span>metadata</span>.<span>baseTI</span>.<span>length</span> <span>&gt;</span> <span>0</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L11253" data-line-number="11253"></td>
        <td id="LC11253">                        <span>actualLengthInBytes</span> <span>&gt;</span> <span>metadata</span>.<span>baseTI</span>.<span>length</span>)</td>
      </tr>
      <tr>
        <td id="L11254" data-line-number="11254"></td>
        <td id="LC11254">                    { <span><span>//</span> see comments above</span></td>
      </tr>
      <tr>
        <td id="L11255" data-line-number="11255"></td>
        <td id="LC11255">                        <span>actualLengthInBytes</span> <span>=</span> <span>metadata</span>.<span>baseTI</span>.<span>length</span>;</td>
      </tr>
      <tr>
        <td id="L11256" data-line-number="11256"></td>
        <td id="LC11256">                    }</td>
      </tr>
      <tr>
        <td id="L11257" data-line-number="11257"></td>
        <td id="LC11257">
</td>
      </tr>
      <tr>
        <td id="L11258" data-line-number="11258"></td>
        <td id="LC11258">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11259" data-line-number="11259"></td>
        <td id="LC11259">
</td>
      </tr>
      <tr>
        <td id="L11260" data-line-number="11260"></td>
        <td id="LC11260">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L11261" data-line-number="11261"></td>
        <td id="LC11261">                    <span>actualLengthInBytes</span> <span>=</span> <span>metadata</span>.<span>baseTI</span>.<span>length</span>;</td>
      </tr>
      <tr>
        <td id="L11262" data-line-number="11262"></td>
        <td id="LC11262">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11263" data-line-number="11263"></td>
        <td id="LC11263">            }</td>
      </tr>
      <tr>
        <td id="L11264" data-line-number="11264"></td>
        <td id="LC11264">
</td>
      </tr>
      <tr>
        <td id="L11265" data-line-number="11265"></td>
        <td id="LC11265">            <span>byte</span>[] <span>serializedValue</span>;</td>
      </tr>
      <tr>
        <td id="L11266" data-line-number="11266"></td>
        <td id="LC11266">            <span>if</span> (<span>isSqlType</span>)</td>
      </tr>
      <tr>
        <td id="L11267" data-line-number="11267"></td>
        <td id="LC11267">            {</td>
      </tr>
      <tr>
        <td id="L11268" data-line-number="11268"></td>
        <td id="LC11268">                <span><span>//</span> SqlType</span></td>
      </tr>
      <tr>
        <td id="L11269" data-line-number="11269"></td>
        <td id="LC11269">                <span>serializedValue</span> <span>=</span> <span>SerializeUnencryptedSqlValue</span>(<span>value</span>,</td>
      </tr>
      <tr>
        <td id="L11270" data-line-number="11270"></td>
        <td id="LC11270">                                            <span>metadata</span>.<span>baseTI</span>.<span>metaType</span>,</td>
      </tr>
      <tr>
        <td id="L11271" data-line-number="11271"></td>
        <td id="LC11271">                                            <span>actualLengthInBytes</span>,</td>
      </tr>
      <tr>
        <td id="L11272" data-line-number="11272"></td>
        <td id="LC11272">                                            <span>offset</span>: <span>0</span>,</td>
      </tr>
      <tr>
        <td id="L11273" data-line-number="11273"></td>
        <td id="LC11273">                                            <span>normalizationVersion</span>: <span>metadata</span>.<span>cipherMD</span>.<span>NormalizationRuleVersion</span>,</td>
      </tr>
      <tr>
        <td id="L11274" data-line-number="11274"></td>
        <td id="LC11274">                                            <span>stateObj</span>: <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11275" data-line-number="11275"></td>
        <td id="LC11275">            }</td>
      </tr>
      <tr>
        <td id="L11276" data-line-number="11276"></td>
        <td id="LC11276">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L11277" data-line-number="11277"></td>
        <td id="LC11277">            {</td>
      </tr>
      <tr>
        <td id="L11278" data-line-number="11278"></td>
        <td id="LC11278">                <span>serializedValue</span> <span>=</span> <span>SerializeUnencryptedValue</span>(<span>value</span>,</td>
      </tr>
      <tr>
        <td id="L11279" data-line-number="11279"></td>
        <td id="LC11279">                                            <span>metadata</span>.<span>baseTI</span>.<span>metaType</span>,</td>
      </tr>
      <tr>
        <td id="L11280" data-line-number="11280"></td>
        <td id="LC11280">                                            <span>metadata</span>.<span>baseTI</span>.<span>scale</span>,</td>
      </tr>
      <tr>
        <td id="L11281" data-line-number="11281"></td>
        <td id="LC11281">                                            <span>actualLengthInBytes</span>,</td>
      </tr>
      <tr>
        <td id="L11282" data-line-number="11282"></td>
        <td id="LC11282">                                            <span>offset</span>: <span>0</span>,</td>
      </tr>
      <tr>
        <td id="L11283" data-line-number="11283"></td>
        <td id="LC11283">                                            <span>isDataFeed</span>: <span>isDataFeed</span>,</td>
      </tr>
      <tr>
        <td id="L11284" data-line-number="11284"></td>
        <td id="LC11284">                                            <span>normalizationVersion</span>: <span>metadata</span>.<span>cipherMD</span>.<span>NormalizationRuleVersion</span>,</td>
      </tr>
      <tr>
        <td id="L11285" data-line-number="11285"></td>
        <td id="LC11285">                                            <span>stateObj</span>: <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11286" data-line-number="11286"></td>
        <td id="LC11286">            }</td>
      </tr>
      <tr>
        <td id="L11287" data-line-number="11287"></td>
        <td id="LC11287">
</td>
      </tr>
      <tr>
        <td id="L11288" data-line-number="11288"></td>
        <td id="LC11288">            <span>Debug</span>.<span>Assert</span>(<span>serializedValue</span> <span>!=</span> <span>null</span>, <span><span>"</span>serializedValue should not be null in TdsExecuteRPC.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11289" data-line-number="11289"></td>
        <td id="LC11289">            <span>return</span> <span>SqlSecurityUtility</span>.<span>EncryptWithKey</span>(</td>
      </tr>
      <tr>
        <td id="L11290" data-line-number="11290"></td>
        <td id="LC11290">                    <span>serializedValue</span>,</td>
      </tr>
      <tr>
        <td id="L11291" data-line-number="11291"></td>
        <td id="LC11291">                    <span>metadata</span>.<span>cipherMD</span>,</td>
      </tr>
      <tr>
        <td id="L11292" data-line-number="11292"></td>
        <td id="LC11292">                    <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>DataSource</span>);</td>
      </tr>
      <tr>
        <td id="L11293" data-line-number="11293"></td>
        <td id="LC11293">        }</td>
      </tr>
      <tr>
        <td id="L11294" data-line-number="11294"></td>
        <td id="LC11294">
</td>
      </tr>
      <tr>
        <td id="L11295" data-line-number="11295"></td>
        <td id="LC11295">        <span>internal</span> <span>Task</span> <span>WriteBulkCopyValue</span>(<span>object</span> <span>value</span>, <span>SqlMetaDataPriv</span> <span>metadata</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>isSqlType</span>, <span>bool</span> <span>isDataFeed</span>, <span>bool</span> <span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L11296" data-line-number="11296"></td>
        <td id="LC11296">        {</td>
      </tr>
      <tr>
        <td id="L11297" data-line-number="11297"></td>
        <td id="LC11297">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isSqlType</span> <span>||</span> <span>value</span> <span>is</span> <span>INullable</span>, <span><span>"</span>isSqlType is true, but value can not be type cast to an INullable<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11298" data-line-number="11298"></td>
        <td id="LC11298">            <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isDataFeed</span> <span>^</span> <span>value</span> <span>is</span> <span>DataFeed</span>, <span><span>"</span>Incorrect value for isDataFeed<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11299" data-line-number="11299"></td>
        <td id="LC11299">
</td>
      </tr>
      <tr>
        <td id="L11300" data-line-number="11300"></td>
        <td id="LC11300">            <span>Encoding</span> <span>saveEncoding</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L11301" data-line-number="11301"></td>
        <td id="LC11301">            <span>SqlCollation</span> <span>saveCollation</span> <span>=</span> <span>_defaultCollation</span>;</td>
      </tr>
      <tr>
        <td id="L11302" data-line-number="11302"></td>
        <td id="LC11302">            <span>int</span> <span>saveCodePage</span> <span>=</span> <span>_defaultCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L11303" data-line-number="11303"></td>
        <td id="LC11303">            <span>int</span> <span>saveLCID</span> <span>=</span> <span>_defaultLCID</span>;</td>
      </tr>
      <tr>
        <td id="L11304" data-line-number="11304"></td>
        <td id="LC11304">            <span>Task</span> <span>resultTask</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L11305" data-line-number="11305"></td>
        <td id="LC11305">            <span>Task</span> <span>internalWriteTask</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L11306" data-line-number="11306"></td>
        <td id="LC11306">
</td>
      </tr>
      <tr>
        <td id="L11307" data-line-number="11307"></td>
        <td id="LC11307">            <span>if</span> (<span>!</span>(<span>State</span> <span>==</span> <span>TdsParserState</span>.<span>OpenNotLoggedIn</span> <span>||</span> <span>State</span> <span>==</span> <span>TdsParserState</span>.<span>OpenLoggedIn</span>))</td>
      </tr>
      <tr>
        <td id="L11308" data-line-number="11308"></td>
        <td id="LC11308">            {</td>
      </tr>
      <tr>
        <td id="L11309" data-line-number="11309"></td>
        <td id="LC11309">                <span>throw</span> <span>ADP</span>.<span>ClosedConnectionError</span>();</td>
      </tr>
      <tr>
        <td id="L11310" data-line-number="11310"></td>
        <td id="LC11310">            }</td>
      </tr>
      <tr>
        <td id="L11311" data-line-number="11311"></td>
        <td id="LC11311">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L11312" data-line-number="11312"></td>
        <td id="LC11312">            {</td>
      </tr>
      <tr>
        <td id="L11313" data-line-number="11313"></td>
        <td id="LC11313">                <span>if</span> (<span>metadata</span>.<span>encoding</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L11314" data-line-number="11314"></td>
        <td id="LC11314">                {</td>
      </tr>
      <tr>
        <td id="L11315" data-line-number="11315"></td>
        <td id="LC11315">                    <span>_defaultEncoding</span> <span>=</span> <span>metadata</span>.<span>encoding</span>;</td>
      </tr>
      <tr>
        <td id="L11316" data-line-number="11316"></td>
        <td id="LC11316">                }</td>
      </tr>
      <tr>
        <td id="L11317" data-line-number="11317"></td>
        <td id="LC11317">                <span>if</span> (<span>metadata</span>.<span>collation</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L11318" data-line-number="11318"></td>
        <td id="LC11318">                {</td>
      </tr>
      <tr>
        <td id="L11319" data-line-number="11319"></td>
        <td id="LC11319">                    <span><span>//</span> Replace encoding if it is UTF8</span></td>
      </tr>
      <tr>
        <td id="L11320" data-line-number="11320"></td>
        <td id="LC11320">                    <span>if</span> ((<span>metadata</span>.<span>collation</span>.<span>info</span> <span>&amp;</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>) <span>==</span> <span>TdsEnums</span>.<span>UTF8_IN_TDSCOLLATION</span>)</td>
      </tr>
      <tr>
        <td id="L11321" data-line-number="11321"></td>
        <td id="LC11321">                    {</td>
      </tr>
      <tr>
        <td id="L11322" data-line-number="11322"></td>
        <td id="LC11322">                        <span>_defaultEncoding</span> <span>=</span> <span>Encoding</span>.<span>UTF8</span>;</td>
      </tr>
      <tr>
        <td id="L11323" data-line-number="11323"></td>
        <td id="LC11323">                    }</td>
      </tr>
      <tr>
        <td id="L11324" data-line-number="11324"></td>
        <td id="LC11324">
</td>
      </tr>
      <tr>
        <td id="L11325" data-line-number="11325"></td>
        <td id="LC11325">                    <span>_defaultCollation</span> <span>=</span> <span>metadata</span>.<span>collation</span>;</td>
      </tr>
      <tr>
        <td id="L11326" data-line-number="11326"></td>
        <td id="LC11326">                    <span>_defaultLCID</span> <span>=</span> <span>_defaultCollation</span>.<span>LCID</span>;</td>
      </tr>
      <tr>
        <td id="L11327" data-line-number="11327"></td>
        <td id="LC11327">                }</td>
      </tr>
      <tr>
        <td id="L11328" data-line-number="11328"></td>
        <td id="LC11328">                <span>_defaultCodePage</span> <span>=</span> <span>metadata</span>.<span>codePage</span>;</td>
      </tr>
      <tr>
        <td id="L11329" data-line-number="11329"></td>
        <td id="LC11329">
</td>
      </tr>
      <tr>
        <td id="L11330" data-line-number="11330"></td>
        <td id="LC11330">                <span>MetaType</span> <span>metatype</span> <span>=</span> <span>metadata</span>.<span>metaType</span>;</td>
      </tr>
      <tr>
        <td id="L11331" data-line-number="11331"></td>
        <td id="LC11331">                <span>int</span> <span>ccb</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L11332" data-line-number="11332"></td>
        <td id="LC11332">                <span>int</span> <span>ccbStringBytes</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L11333" data-line-number="11333"></td>
        <td id="LC11333">
</td>
      </tr>
      <tr>
        <td id="L11334" data-line-number="11334"></td>
        <td id="LC11334">                <span>if</span> (<span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L11335" data-line-number="11335"></td>
        <td id="LC11335">                {</td>
      </tr>
      <tr>
        <td id="L11336" data-line-number="11336"></td>
        <td id="LC11336">                    <span><span>//</span> For UDT, remember we treat as binary even though it is a PLP</span></td>
      </tr>
      <tr>
        <td id="L11337" data-line-number="11337"></td>
        <td id="LC11337">                    <span>if</span> (<span>metatype</span>.<span>IsPlp</span> <span>&amp;&amp;</span> (<span>metatype</span>.<span>NullableType</span> <span>!=</span> <span>TdsEnums</span>.<span>SQLUDT</span> <span>||</span> <span>metatype</span>.<span>IsLong</span>))</td>
      </tr>
      <tr>
        <td id="L11338" data-line-number="11338"></td>
        <td id="LC11338">                    {</td>
      </tr>
      <tr>
        <td id="L11339" data-line-number="11339"></td>
        <td id="LC11339">                        <span>WriteLong</span>(<span>unchecked</span>((<span>long</span>)<span>TdsEnums</span>.<span>SQL_PLP_NULL</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11340" data-line-number="11340"></td>
        <td id="LC11340">                    }</td>
      </tr>
      <tr>
        <td id="L11341" data-line-number="11341"></td>
        <td id="LC11341">                    <span>else</span> <span>if</span> (<span>!</span><span>metatype</span>.<span>IsFixed</span> <span>&amp;&amp;</span> <span>!</span><span>metatype</span>.<span>IsLong</span> <span>&amp;&amp;</span> <span>!</span><span>metatype</span>.<span>IsVarTime</span>)</td>
      </tr>
      <tr>
        <td id="L11342" data-line-number="11342"></td>
        <td id="LC11342">                    {</td>
      </tr>
      <tr>
        <td id="L11343" data-line-number="11343"></td>
        <td id="LC11343">                        <span>WriteShort</span>(<span>TdsEnums</span>.<span>VARNULL</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11344" data-line-number="11344"></td>
        <td id="LC11344">                    }</td>
      </tr>
      <tr>
        <td id="L11345" data-line-number="11345"></td>
        <td id="LC11345">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11346" data-line-number="11346"></td>
        <td id="LC11346">                    {</td>
      </tr>
      <tr>
        <td id="L11347" data-line-number="11347"></td>
        <td id="LC11347">                        <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FIXEDNULL</span>);</td>
      </tr>
      <tr>
        <td id="L11348" data-line-number="11348"></td>
        <td id="LC11348">                    }</td>
      </tr>
      <tr>
        <td id="L11349" data-line-number="11349"></td>
        <td id="LC11349">                    <span>return</span> <span>resultTask</span>;</td>
      </tr>
      <tr>
        <td id="L11350" data-line-number="11350"></td>
        <td id="LC11350">                }</td>
      </tr>
      <tr>
        <td id="L11351" data-line-number="11351"></td>
        <td id="LC11351">
</td>
      </tr>
      <tr>
        <td id="L11352" data-line-number="11352"></td>
        <td id="LC11352">                <span>if</span> (<span>!</span><span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L11353" data-line-number="11353"></td>
        <td id="LC11353">                {</td>
      </tr>
      <tr>
        <td id="L11354" data-line-number="11354"></td>
        <td id="LC11354">                    <span>switch</span> (<span>metatype</span>.<span>NullableType</span>)</td>
      </tr>
      <tr>
        <td id="L11355" data-line-number="11355"></td>
        <td id="LC11355">                    {</td>
      </tr>
      <tr>
        <td id="L11356" data-line-number="11356"></td>
        <td id="LC11356">                        <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L11357" data-line-number="11357"></td>
        <td id="LC11357">                        <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L11358" data-line-number="11358"></td>
        <td id="LC11358">                        <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L11359" data-line-number="11359"></td>
        <td id="LC11359">                        <span>case</span> <span>TdsEnums</span>.<span>SQLUDT</span>:</td>
      </tr>
      <tr>
        <td id="L11360" data-line-number="11360"></td>
        <td id="LC11360">                            <span>ccb</span> <span>=</span> (<span>isSqlType</span>) <span>?</span> ((<span>SqlBinary</span>)<span>value</span>).<span>Length</span> <span>:</span> ((<span>byte</span>[])<span>value</span>).<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L11361" data-line-number="11361"></td>
        <td id="LC11361">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11362" data-line-number="11362"></td>
        <td id="LC11362">                        <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L11363" data-line-number="11363"></td>
        <td id="LC11363">                            <span>ccb</span> <span>=</span> <span>GUID_SIZE</span>;   <span><span>//</span> that's a constant for guid</span></td>
      </tr>
      <tr>
        <td id="L11364" data-line-number="11364"></td>
        <td id="LC11364">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11365" data-line-number="11365"></td>
        <td id="LC11365">                        <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11366" data-line-number="11366"></td>
        <td id="LC11366">                        <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11367" data-line-number="11367"></td>
        <td id="LC11367">                        <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L11368" data-line-number="11368"></td>
        <td id="LC11368">                            <span>if</span> (<span>null</span> <span>==</span> <span>_defaultEncoding</span>)</td>
      </tr>
      <tr>
        <td id="L11369" data-line-number="11369"></td>
        <td id="LC11369">                            {</td>
      </tr>
      <tr>
        <td id="L11370" data-line-number="11370"></td>
        <td id="LC11370">                                <span>ThrowUnsupportedCollationEncountered</span>(<span>null</span>); <span><span>//</span> stateObject only when reading</span></td>
      </tr>
      <tr>
        <td id="L11371" data-line-number="11371"></td>
        <td id="LC11371">                            }</td>
      </tr>
      <tr>
        <td id="L11372" data-line-number="11372"></td>
        <td id="LC11372">
</td>
      </tr>
      <tr>
        <td id="L11373" data-line-number="11373"></td>
        <td id="LC11373">                            <span>string</span> <span>stringValue</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L11374" data-line-number="11374"></td>
        <td id="LC11374">                            <span>if</span> (<span>isSqlType</span>)</td>
      </tr>
      <tr>
        <td id="L11375" data-line-number="11375"></td>
        <td id="LC11375">                            {</td>
      </tr>
      <tr>
        <td id="L11376" data-line-number="11376"></td>
        <td id="LC11376">                                <span>stringValue</span> <span>=</span> ((<span>SqlString</span>)<span>value</span>).<span>Value</span>;</td>
      </tr>
      <tr>
        <td id="L11377" data-line-number="11377"></td>
        <td id="LC11377">                            }</td>
      </tr>
      <tr>
        <td id="L11378" data-line-number="11378"></td>
        <td id="LC11378">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L11379" data-line-number="11379"></td>
        <td id="LC11379">                            {</td>
      </tr>
      <tr>
        <td id="L11380" data-line-number="11380"></td>
        <td id="LC11380">                                <span>stringValue</span> <span>=</span> (<span>string</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L11381" data-line-number="11381"></td>
        <td id="LC11381">                            }</td>
      </tr>
      <tr>
        <td id="L11382" data-line-number="11382"></td>
        <td id="LC11382">
</td>
      </tr>
      <tr>
        <td id="L11383" data-line-number="11383"></td>
        <td id="LC11383">                            <span>ccb</span> <span>=</span> <span>stringValue</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L11384" data-line-number="11384"></td>
        <td id="LC11384">                            <span>ccbStringBytes</span> <span>=</span> <span>_defaultEncoding</span>.<span>GetByteCount</span>(<span>stringValue</span>);</td>
      </tr>
      <tr>
        <td id="L11385" data-line-number="11385"></td>
        <td id="LC11385">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11386" data-line-number="11386"></td>
        <td id="LC11386">                        <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11387" data-line-number="11387"></td>
        <td id="LC11387">                        <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11388" data-line-number="11388"></td>
        <td id="LC11388">                        <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L11389" data-line-number="11389"></td>
        <td id="LC11389">                            <span>ccb</span> <span>=</span> ((<span>isSqlType</span>) <span>?</span> ((<span>SqlString</span>)<span>value</span>).<span>Value</span>.<span>Length</span> <span>:</span> ((<span>string</span>)<span>value</span>).<span>Length</span>) <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L11390" data-line-number="11390"></td>
        <td id="LC11390">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11391" data-line-number="11391"></td>
        <td id="LC11391">                        <span>case</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>:</td>
      </tr>
      <tr>
        <td id="L11392" data-line-number="11392"></td>
        <td id="LC11392">                            <span><span>//</span> Value here could be string or XmlReader</span></td>
      </tr>
      <tr>
        <td id="L11393" data-line-number="11393"></td>
        <td id="LC11393">                            <span>if</span> (<span>value</span> <span>is</span> <span>XmlReader</span>)</td>
      </tr>
      <tr>
        <td id="L11394" data-line-number="11394"></td>
        <td id="LC11394">                            {</td>
      </tr>
      <tr>
        <td id="L11395" data-line-number="11395"></td>
        <td id="LC11395">                                <span>value</span> <span>=</span> <span>MetaType</span>.<span>GetStringFromXml</span>((<span>XmlReader</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L11396" data-line-number="11396"></td>
        <td id="LC11396">                            }</td>
      </tr>
      <tr>
        <td id="L11397" data-line-number="11397"></td>
        <td id="LC11397">                            <span>ccb</span> <span>=</span> ((<span>isSqlType</span>) <span>?</span> ((<span>SqlString</span>)<span>value</span>).<span>Value</span>.<span>Length</span> <span>:</span> ((<span>string</span>)<span>value</span>).<span>Length</span>) <span>*</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L11398" data-line-number="11398"></td>
        <td id="LC11398">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11399" data-line-number="11399"></td>
        <td id="LC11399">
</td>
      </tr>
      <tr>
        <td id="L11400" data-line-number="11400"></td>
        <td id="LC11400">                        <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L11401" data-line-number="11401"></td>
        <td id="LC11401">                            <span>ccb</span> <span>=</span> <span>metadata</span>.<span>length</span>;</td>
      </tr>
      <tr>
        <td id="L11402" data-line-number="11402"></td>
        <td id="LC11402">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11403" data-line-number="11403"></td>
        <td id="LC11403">                    }</td>
      </tr>
      <tr>
        <td id="L11404" data-line-number="11404"></td>
        <td id="LC11404">                }</td>
      </tr>
      <tr>
        <td id="L11405" data-line-number="11405"></td>
        <td id="LC11405">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L11406" data-line-number="11406"></td>
        <td id="LC11406">                {</td>
      </tr>
      <tr>
        <td id="L11407" data-line-number="11407"></td>
        <td id="LC11407">                    <span>Debug</span>.<span>Assert</span>(<span>metatype</span>.<span>IsLong</span> <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L11408" data-line-number="11408"></td>
        <td id="LC11408">                        ((<span>metatype</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>VarBinary</span> <span>&amp;&amp;</span> <span>value</span> <span>is</span> <span>StreamDataFeed</span>) <span>||</span></td>
      </tr>
      <tr>
        <td id="L11409" data-line-number="11409"></td>
        <td id="LC11409">                         ((<span>metatype</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>VarChar</span> <span>||</span> <span>metatype</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>NVarChar</span>) <span>&amp;&amp;</span> <span>value</span> <span>is</span> <span>TextDataFeed</span>) <span>||</span></td>
      </tr>
      <tr>
        <td id="L11410" data-line-number="11410"></td>
        <td id="LC11410">                         (<span>metatype</span>.<span>SqlDbType</span> <span>==</span> <span>SqlDbType</span>.<span>Xml</span> <span>&amp;&amp;</span> <span>value</span> <span>is</span> <span>XmlDataFeed</span>)),</td>
      </tr>
      <tr>
        <td id="L11411" data-line-number="11411"></td>
        <td id="LC11411">                   <span><span>"</span>Stream data feed should only be assigned to VarBinary(max), Text data feed should only be assigned to [N]VarChar(max), Xml data feed should only be assigned to XML(max)<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11412" data-line-number="11412"></td>
        <td id="LC11412">                }</td>
      </tr>
      <tr>
        <td id="L11413" data-line-number="11413"></td>
        <td id="LC11413">
</td>
      </tr>
      <tr>
        <td id="L11414" data-line-number="11414"></td>
        <td id="LC11414">
</td>
      </tr>
      <tr>
        <td id="L11415" data-line-number="11415"></td>
        <td id="LC11415">                <span><span>//</span> Expected the text length in data stream for bulk copy of text, ntext, or image data.</span></td>
      </tr>
      <tr>
        <td id="L11416" data-line-number="11416"></td>
        <td id="LC11416">                <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L11417" data-line-number="11417"></td>
        <td id="LC11417">                <span>if</span> (<span>metatype</span>.<span>IsLong</span>)</td>
      </tr>
      <tr>
        <td id="L11418" data-line-number="11418"></td>
        <td id="LC11418">                {</td>
      </tr>
      <tr>
        <td id="L11419" data-line-number="11419"></td>
        <td id="LC11419">                    <span>switch</span> (<span>metatype</span>.<span>SqlDbType</span>)</td>
      </tr>
      <tr>
        <td id="L11420" data-line-number="11420"></td>
        <td id="LC11420">                    {</td>
      </tr>
      <tr>
        <td id="L11421" data-line-number="11421"></td>
        <td id="LC11421">                        <span>case</span> <span>SqlDbType</span>.<span>Text</span>:</td>
      </tr>
      <tr>
        <td id="L11422" data-line-number="11422"></td>
        <td id="LC11422">                        <span>case</span> <span>SqlDbType</span>.<span>NText</span>:</td>
      </tr>
      <tr>
        <td id="L11423" data-line-number="11423"></td>
        <td id="LC11423">                        <span>case</span> <span>SqlDbType</span>.<span>Image</span>:</td>
      </tr>
      <tr>
        <td id="L11424" data-line-number="11424"></td>
        <td id="LC11424">                            <span>stateObj</span>.<span>WriteByteArray</span>(<span>s_longDataHeader</span>, <span>s_longDataHeader</span>.<span>Length</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11425" data-line-number="11425"></td>
        <td id="LC11425">                            <span>WriteTokenLength</span>(<span>metadata</span>.<span>tdsType</span>, <span>ccbStringBytes</span> <span>==</span> <span>0</span> <span>?</span> <span>ccb</span> <span>:</span> <span>ccbStringBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11426" data-line-number="11426"></td>
        <td id="LC11426">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11427" data-line-number="11427"></td>
        <td id="LC11427">
</td>
      </tr>
      <tr>
        <td id="L11428" data-line-number="11428"></td>
        <td id="LC11428">                        <span>case</span> <span>SqlDbType</span>.<span>VarChar</span>:</td>
      </tr>
      <tr>
        <td id="L11429" data-line-number="11429"></td>
        <td id="LC11429">                        <span>case</span> <span>SqlDbType</span>.<span>NVarChar</span>:</td>
      </tr>
      <tr>
        <td id="L11430" data-line-number="11430"></td>
        <td id="LC11430">                        <span>case</span> <span>SqlDbType</span>.<span>VarBinary</span>:</td>
      </tr>
      <tr>
        <td id="L11431" data-line-number="11431"></td>
        <td id="LC11431">                        <span>case</span> <span>SqlDbType</span>.<span>Xml</span>:</td>
      </tr>
      <tr>
        <td id="L11432" data-line-number="11432"></td>
        <td id="LC11432">                        <span>case</span> <span>SqlDbType</span>.<span>Udt</span>:</td>
      </tr>
      <tr>
        <td id="L11433" data-line-number="11433"></td>
        <td id="LC11433">                            <span><span>//</span> plp data</span></td>
      </tr>
      <tr>
        <td id="L11434" data-line-number="11434"></td>
        <td id="LC11434">                            <span>WriteUnsignedLong</span>(<span>TdsEnums</span>.<span>SQL_PLP_UNKNOWNLEN</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11435" data-line-number="11435"></td>
        <td id="LC11435">                            <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11436" data-line-number="11436"></td>
        <td id="LC11436">                    }</td>
      </tr>
      <tr>
        <td id="L11437" data-line-number="11437"></td>
        <td id="LC11437">                }</td>
      </tr>
      <tr>
        <td id="L11438" data-line-number="11438"></td>
        <td id="LC11438">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L11439" data-line-number="11439"></td>
        <td id="LC11439">                {</td>
      </tr>
      <tr>
        <td id="L11440" data-line-number="11440"></td>
        <td id="LC11440">                    <span>WriteTokenLength</span>(<span>metadata</span>.<span>tdsType</span>, <span>ccbStringBytes</span> <span>==</span> <span>0</span> <span>?</span> <span>ccb</span> <span>:</span> <span>ccbStringBytes</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11441" data-line-number="11441"></td>
        <td id="LC11441">                }</td>
      </tr>
      <tr>
        <td id="L11442" data-line-number="11442"></td>
        <td id="LC11442">
</td>
      </tr>
      <tr>
        <td id="L11443" data-line-number="11443"></td>
        <td id="LC11443">                <span>if</span> (<span>isSqlType</span>)</td>
      </tr>
      <tr>
        <td id="L11444" data-line-number="11444"></td>
        <td id="LC11444">                {</td>
      </tr>
      <tr>
        <td id="L11445" data-line-number="11445"></td>
        <td id="LC11445">                    <span>internalWriteTask</span> <span>=</span> <span>WriteSqlValue</span>(<span>value</span>, <span>metatype</span>, <span>ccb</span>, <span>ccbStringBytes</span>, <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11446" data-line-number="11446"></td>
        <td id="LC11446">                }</td>
      </tr>
      <tr>
        <td id="L11447" data-line-number="11447"></td>
        <td id="LC11447">                <span>else</span> <span>if</span> (<span>metatype</span>.<span>SqlDbType</span> <span>!=</span> <span>SqlDbType</span>.<span>Udt</span> <span>||</span> <span>metatype</span>.<span>IsLong</span>)</td>
      </tr>
      <tr>
        <td id="L11448" data-line-number="11448"></td>
        <td id="LC11448">                {</td>
      </tr>
      <tr>
        <td id="L11449" data-line-number="11449"></td>
        <td id="LC11449">                    <span>internalWriteTask</span> <span>=</span> <span>WriteValue</span>(<span>value</span>, <span>metatype</span>, <span>metadata</span>.<span>scale</span>, <span>ccb</span>, <span>ccbStringBytes</span>, <span>0</span>, <span>stateObj</span>, <span>metadata</span>.<span>length</span>, <span>isDataFeed</span>);</td>
      </tr>
      <tr>
        <td id="L11450" data-line-number="11450"></td>
        <td id="LC11450">                    <span>if</span> ((<span>internalWriteTask</span> <span>==</span> <span>null</span>) <span>&amp;&amp;</span> (<span>_asyncWrite</span>))</td>
      </tr>
      <tr>
        <td id="L11451" data-line-number="11451"></td>
        <td id="LC11451">                    {</td>
      </tr>
      <tr>
        <td id="L11452" data-line-number="11452"></td>
        <td id="LC11452">                        <span>internalWriteTask</span> <span>=</span> <span>stateObj</span>.<span>WaitForAccumulatedWrites</span>();</td>
      </tr>
      <tr>
        <td id="L11453" data-line-number="11453"></td>
        <td id="LC11453">                    }</td>
      </tr>
      <tr>
        <td id="L11454" data-line-number="11454"></td>
        <td id="LC11454">                    <span>Debug</span>.<span>Assert</span>(<span>_asyncWrite</span> <span>||</span> <span>stateObj</span>.<span>WaitForAccumulatedWrites</span>() <span>==</span> <span>null</span>, <span><span>"</span>Should not have accumulated writes when writing sync<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11455" data-line-number="11455"></td>
        <td id="LC11455">                }</td>
      </tr>
      <tr>
        <td id="L11456" data-line-number="11456"></td>
        <td id="LC11456">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L11457" data-line-number="11457"></td>
        <td id="LC11457">                {</td>
      </tr>
      <tr>
        <td id="L11458" data-line-number="11458"></td>
        <td id="LC11458">                    <span>WriteShort</span>(<span>ccb</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11459" data-line-number="11459"></td>
        <td id="LC11459">                    <span>internalWriteTask</span> <span>=</span> <span>stateObj</span>.<span>WriteByteArray</span>((<span>byte</span>[])<span>value</span>, <span>ccb</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11460" data-line-number="11460"></td>
        <td id="LC11460">                }</td>
      </tr>
      <tr>
        <td id="L11461" data-line-number="11461"></td>
        <td id="LC11461">
</td>
      </tr>
      <tr>
        <td id="L11462" data-line-number="11462"></td>
        <td id="LC11462">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L11463" data-line-number="11463"></td>
        <td id="LC11463">                <span><span>//</span>In DEBUG mode, when SetAlwaysTaskOnWrite is true, we create a task. Allows us to verify async execution paths.</span></td>
      </tr>
      <tr>
        <td id="L11464" data-line-number="11464"></td>
        <td id="LC11464">                <span>if</span> (<span>_asyncWrite</span> <span>&amp;&amp;</span> <span>internalWriteTask</span> <span>==</span> <span>null</span> <span>&amp;&amp;</span> <span>SqlBulkCopy</span>.<span>SetAlwaysTaskOnWrite</span> <span>==</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L11465" data-line-number="11465"></td>
        <td id="LC11465">                {</td>
      </tr>
      <tr>
        <td id="L11466" data-line-number="11466"></td>
        <td id="LC11466">                    <span>internalWriteTask</span> <span>=</span> <span>Task</span>.<span>FromResult</span>&lt;<span>object</span>&gt;(<span>null</span>);</td>
      </tr>
      <tr>
        <td id="L11467" data-line-number="11467"></td>
        <td id="LC11467">                }</td>
      </tr>
      <tr>
        <td id="L11468" data-line-number="11468"></td>
        <td id="LC11468">#<span>endif</span></td>
      </tr>
      <tr>
        <td id="L11469" data-line-number="11469"></td>
        <td id="LC11469">                <span>if</span> (<span>internalWriteTask</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L11470" data-line-number="11470"></td>
        <td id="LC11470">                { <span><span>//</span>i.e. the write was async.</span></td>
      </tr>
      <tr>
        <td id="L11471" data-line-number="11471"></td>
        <td id="LC11471">                    <span>resultTask</span> <span>=</span> <span>WriteBulkCopyValueSetupContinuation</span>(<span>internalWriteTask</span>, <span>saveEncoding</span>, <span>saveCollation</span>, <span>saveCodePage</span>, <span>saveLCID</span>);</td>
      </tr>
      <tr>
        <td id="L11472" data-line-number="11472"></td>
        <td id="LC11472">                }</td>
      </tr>
      <tr>
        <td id="L11473" data-line-number="11473"></td>
        <td id="LC11473">            }</td>
      </tr>
      <tr>
        <td id="L11474" data-line-number="11474"></td>
        <td id="LC11474">            <span>finally</span></td>
      </tr>
      <tr>
        <td id="L11475" data-line-number="11475"></td>
        <td id="LC11475">            {</td>
      </tr>
      <tr>
        <td id="L11476" data-line-number="11476"></td>
        <td id="LC11476">                <span>if</span> (<span>internalWriteTask</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L11477" data-line-number="11477"></td>
        <td id="LC11477">                {</td>
      </tr>
      <tr>
        <td id="L11478" data-line-number="11478"></td>
        <td id="LC11478">                    <span>_defaultEncoding</span> <span>=</span> <span>saveEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L11479" data-line-number="11479"></td>
        <td id="LC11479">                    <span>_defaultCollation</span> <span>=</span> <span>saveCollation</span>;</td>
      </tr>
      <tr>
        <td id="L11480" data-line-number="11480"></td>
        <td id="LC11480">                    <span>_defaultCodePage</span> <span>=</span> <span>saveCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L11481" data-line-number="11481"></td>
        <td id="LC11481">                    <span>_defaultLCID</span> <span>=</span> <span>saveLCID</span>;</td>
      </tr>
      <tr>
        <td id="L11482" data-line-number="11482"></td>
        <td id="LC11482">                }</td>
      </tr>
      <tr>
        <td id="L11483" data-line-number="11483"></td>
        <td id="LC11483">            }</td>
      </tr>
      <tr>
        <td id="L11484" data-line-number="11484"></td>
        <td id="LC11484">            <span>return</span> <span>resultTask</span>;</td>
      </tr>
      <tr>
        <td id="L11485" data-line-number="11485"></td>
        <td id="LC11485">        }</td>
      </tr>
      <tr>
        <td id="L11486" data-line-number="11486"></td>
        <td id="LC11486">
</td>
      </tr>
      <tr>
        <td id="L11487" data-line-number="11487"></td>
        <td id="LC11487">        <span><span>//</span> This is in its own method to avoid always allocating the lambda in WriteBulkCopyValue</span></td>
      </tr>
      <tr>
        <td id="L11488" data-line-number="11488"></td>
        <td id="LC11488">        <span>private</span> <span>Task</span> <span>WriteBulkCopyValueSetupContinuation</span>(<span>Task</span> <span>internalWriteTask</span>, <span>Encoding</span> <span>saveEncoding</span>, <span>SqlCollation</span> <span>saveCollation</span>, <span>int</span> <span>saveCodePage</span>, <span>int</span> <span>saveLCID</span>)</td>
      </tr>
      <tr>
        <td id="L11489" data-line-number="11489"></td>
        <td id="LC11489">        {</td>
      </tr>
      <tr>
        <td id="L11490" data-line-number="11490"></td>
        <td id="LC11490">            <span>return</span> <span>internalWriteTask</span>.<span>ContinueWith</span>&lt;<span>Task</span>&gt;(<span>t</span> <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="L11491" data-line-number="11491"></td>
        <td id="LC11491">            {</td>
      </tr>
      <tr>
        <td id="L11492" data-line-number="11492"></td>
        <td id="LC11492">                <span>_defaultEncoding</span> <span>=</span> <span>saveEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L11493" data-line-number="11493"></td>
        <td id="LC11493">                <span>_defaultCollation</span> <span>=</span> <span>saveCollation</span>;</td>
      </tr>
      <tr>
        <td id="L11494" data-line-number="11494"></td>
        <td id="LC11494">                <span>_defaultCodePage</span> <span>=</span> <span>saveCodePage</span>;</td>
      </tr>
      <tr>
        <td id="L11495" data-line-number="11495"></td>
        <td id="LC11495">                <span>_defaultLCID</span> <span>=</span> <span>saveLCID</span>;</td>
      </tr>
      <tr>
        <td id="L11496" data-line-number="11496"></td>
        <td id="LC11496">                <span>return</span> <span>t</span>;</td>
      </tr>
      <tr>
        <td id="L11497" data-line-number="11497"></td>
        <td id="LC11497">            }, <span>TaskScheduler</span>.<span>Default</span>).<span>Unwrap</span>();</td>
      </tr>
      <tr>
        <td id="L11498" data-line-number="11498"></td>
        <td id="LC11498">        }</td>
      </tr>
      <tr>
        <td id="L11499" data-line-number="11499"></td>
        <td id="LC11499">
</td>
      </tr>
      <tr>
        <td id="L11500" data-line-number="11500"></td>
        <td id="LC11500">        <span><span>//</span> Write mars header data, not including the mars header length</span></td>
      </tr>
      <tr>
        <td id="L11501" data-line-number="11501"></td>
        <td id="LC11501">        <span>private</span> <span>void</span> <span>WriteMarsHeaderData</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>SqlInternalTransaction</span> <span>transaction</span>)</td>
      </tr>
      <tr>
        <td id="L11502" data-line-number="11502"></td>
        <td id="LC11502">        {</td>
      </tr>
      <tr>
        <td id="L11503" data-line-number="11503"></td>
        <td id="LC11503">            <span><span>//</span> Function to send over additional payload header data for Yukon and beyond only.</span></td>
      </tr>
      <tr>
        <td id="L11504" data-line-number="11504"></td>
        <td id="LC11504">            <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>WriteMarsHeaderData called on a non-Yukon server<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11505" data-line-number="11505"></td>
        <td id="LC11505">
</td>
      </tr>
      <tr>
        <td id="L11506" data-line-number="11506"></td>
        <td id="LC11506">            <span><span>//</span> These are not necessary - can have local started in distributed.</span></td>
      </tr>
      <tr>
        <td id="L11507" data-line-number="11507"></td>
        <td id="LC11507">            <span><span>//</span> Debug.Assert(!(null != sqlTransaction &amp;&amp; null != distributedTransaction), "Error to have local (api started) and distributed transaction at the same time!");</span></td>
      </tr>
      <tr>
        <td id="L11508" data-line-number="11508"></td>
        <td id="LC11508">            <span><span>//</span> Debug.Assert(!(null != _userStartedLocalTransaction &amp;&amp; null != distributedTransaction), "Error to have local (started outside of the api) and distributed transaction at the same time!");</span></td>
      </tr>
      <tr>
        <td id="L11509" data-line-number="11509"></td>
        <td id="LC11509">
</td>
      </tr>
      <tr>
        <td id="L11510" data-line-number="11510"></td>
        <td id="LC11510">            <span><span>//</span> We may need to update the mars header length if mars header is changed in the future</span></td>
      </tr>
      <tr>
        <td id="L11511" data-line-number="11511"></td>
        <td id="LC11511">
</td>
      </tr>
      <tr>
        <td id="L11512" data-line-number="11512"></td>
        <td id="LC11512">            <span>WriteShort</span>(<span>TdsEnums</span>.<span>HEADERTYPE_MARS</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11513" data-line-number="11513"></td>
        <td id="LC11513">
</td>
      </tr>
      <tr>
        <td id="L11514" data-line-number="11514"></td>
        <td id="LC11514">            <span>if</span> (<span>null</span> <span>!=</span> <span>transaction</span> <span>&amp;&amp;</span> <span>SqlInternalTransaction</span>.<span>NullTransactionId</span> <span>!=</span> <span>transaction</span>.<span>TransactionId</span>)</td>
      </tr>
      <tr>
        <td id="L11515" data-line-number="11515"></td>
        <td id="LC11515">            {</td>
      </tr>
      <tr>
        <td id="L11516" data-line-number="11516"></td>
        <td id="LC11516">                <span>WriteLong</span>(<span>transaction</span>.<span>TransactionId</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11517" data-line-number="11517"></td>
        <td id="LC11517">                <span>WriteInt</span>(<span>stateObj</span>.<span>IncrementAndObtainOpenResultCount</span>(<span>transaction</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11518" data-line-number="11518"></td>
        <td id="LC11518">            }</td>
      </tr>
      <tr>
        <td id="L11519" data-line-number="11519"></td>
        <td id="LC11519">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L11520" data-line-number="11520"></td>
        <td id="LC11520">            {</td>
      </tr>
      <tr>
        <td id="L11521" data-line-number="11521"></td>
        <td id="LC11521">                <span><span>//</span> If no transaction, send over retained transaction descriptor (empty if none retained)</span></td>
      </tr>
      <tr>
        <td id="L11522" data-line-number="11522"></td>
        <td id="LC11522">                <span><span>//</span>  and always 1 for result count.</span></td>
      </tr>
      <tr>
        <td id="L11523" data-line-number="11523"></td>
        <td id="LC11523">                <span>WriteLong</span>(<span>_retainedTransactionId</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11524" data-line-number="11524"></td>
        <td id="LC11524">                <span>WriteInt</span>(<span>stateObj</span>.<span>IncrementAndObtainOpenResultCount</span>(<span>null</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11525" data-line-number="11525"></td>
        <td id="LC11525">            }</td>
      </tr>
      <tr>
        <td id="L11526" data-line-number="11526"></td>
        <td id="LC11526">        }</td>
      </tr>
      <tr>
        <td id="L11527" data-line-number="11527"></td>
        <td id="LC11527">
</td>
      </tr>
      <tr>
        <td id="L11528" data-line-number="11528"></td>
        <td id="LC11528">        <span>private</span> <span>int</span> <span>GetNotificationHeaderSize</span>(<span>SqlNotificationRequest</span> <span>notificationRequest</span>)</td>
      </tr>
      <tr>
        <td id="L11529" data-line-number="11529"></td>
        <td id="LC11529">        {</td>
      </tr>
      <tr>
        <td id="L11530" data-line-number="11530"></td>
        <td id="LC11530">            <span>if</span> (<span>null</span> <span>!=</span> <span>notificationRequest</span>)</td>
      </tr>
      <tr>
        <td id="L11531" data-line-number="11531"></td>
        <td id="LC11531">            {</td>
      </tr>
      <tr>
        <td id="L11532" data-line-number="11532"></td>
        <td id="LC11532">                <span>string</span> <span>callbackId</span> <span>=</span> <span>notificationRequest</span>.<span>UserData</span>;</td>
      </tr>
      <tr>
        <td id="L11533" data-line-number="11533"></td>
        <td id="LC11533">                <span>string</span> <span>service</span> <span>=</span> <span>notificationRequest</span>.<span>Options</span>;</td>
      </tr>
      <tr>
        <td id="L11534" data-line-number="11534"></td>
        <td id="LC11534">                <span>int</span> <span>timeout</span> <span>=</span> <span>notificationRequest</span>.<span>Timeout</span>;</td>
      </tr>
      <tr>
        <td id="L11535" data-line-number="11535"></td>
        <td id="LC11535">
</td>
      </tr>
      <tr>
        <td id="L11536" data-line-number="11536"></td>
        <td id="LC11536">                <span>if</span> (<span>null</span> <span>==</span> <span>callbackId</span>)</td>
      </tr>
      <tr>
        <td id="L11537" data-line-number="11537"></td>
        <td id="LC11537">                {</td>
      </tr>
      <tr>
        <td id="L11538" data-line-number="11538"></td>
        <td id="LC11538">                    <span>throw</span> <span>ADP</span>.<span>ArgumentNull</span>(<span><span>"</span>CallbackId<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11539" data-line-number="11539"></td>
        <td id="LC11539">                }</td>
      </tr>
      <tr>
        <td id="L11540" data-line-number="11540"></td>
        <td id="LC11540">                <span>else</span> <span>if</span> (<span>UInt16</span>.<span>MaxValue</span> <span>&lt;</span> <span>callbackId</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L11541" data-line-number="11541"></td>
        <td id="LC11541">                {</td>
      </tr>
      <tr>
        <td id="L11542" data-line-number="11542"></td>
        <td id="LC11542">                    <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span><span>"</span>CallbackId<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11543" data-line-number="11543"></td>
        <td id="LC11543">                }</td>
      </tr>
      <tr>
        <td id="L11544" data-line-number="11544"></td>
        <td id="LC11544">
</td>
      </tr>
      <tr>
        <td id="L11545" data-line-number="11545"></td>
        <td id="LC11545">                <span>if</span> (<span>null</span> <span>==</span> <span>service</span>)</td>
      </tr>
      <tr>
        <td id="L11546" data-line-number="11546"></td>
        <td id="LC11546">                {</td>
      </tr>
      <tr>
        <td id="L11547" data-line-number="11547"></td>
        <td id="LC11547">                    <span>throw</span> <span>ADP</span>.<span>ArgumentNull</span>(<span><span>"</span>Service<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11548" data-line-number="11548"></td>
        <td id="LC11548">                }</td>
      </tr>
      <tr>
        <td id="L11549" data-line-number="11549"></td>
        <td id="LC11549">                <span>else</span> <span>if</span> (<span>UInt16</span>.<span>MaxValue</span> <span>&lt;</span> <span>service</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L11550" data-line-number="11550"></td>
        <td id="LC11550">                {</td>
      </tr>
      <tr>
        <td id="L11551" data-line-number="11551"></td>
        <td id="LC11551">                    <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span><span>"</span>Service<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11552" data-line-number="11552"></td>
        <td id="LC11552">                }</td>
      </tr>
      <tr>
        <td id="L11553" data-line-number="11553"></td>
        <td id="LC11553">
</td>
      </tr>
      <tr>
        <td id="L11554" data-line-number="11554"></td>
        <td id="LC11554">                <span>if</span> (<span>-</span><span>1</span> <span>&gt;</span> <span>timeout</span>)</td>
      </tr>
      <tr>
        <td id="L11555" data-line-number="11555"></td>
        <td id="LC11555">                {</td>
      </tr>
      <tr>
        <td id="L11556" data-line-number="11556"></td>
        <td id="LC11556">                    <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span><span>"</span>Timeout<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11557" data-line-number="11557"></td>
        <td id="LC11557">                }</td>
      </tr>
      <tr>
        <td id="L11558" data-line-number="11558"></td>
        <td id="LC11558">
</td>
      </tr>
      <tr>
        <td id="L11559" data-line-number="11559"></td>
        <td id="LC11559">                <span><span>//</span> Header Length (uint) (included in size) (already written to output buffer)</span></td>
      </tr>
      <tr>
        <td id="L11560" data-line-number="11560"></td>
        <td id="LC11560">                <span><span>//</span> Header Type (ushort)</span></td>
      </tr>
      <tr>
        <td id="L11561" data-line-number="11561"></td>
        <td id="LC11561">                <span><span>//</span> NotifyID Length (ushort)</span></td>
      </tr>
      <tr>
        <td id="L11562" data-line-number="11562"></td>
        <td id="LC11562">                <span><span>//</span> NotifyID UnicodeStream (unicode text)</span></td>
      </tr>
      <tr>
        <td id="L11563" data-line-number="11563"></td>
        <td id="LC11563">                <span><span>//</span> SSBDeployment Length (ushort)</span></td>
      </tr>
      <tr>
        <td id="L11564" data-line-number="11564"></td>
        <td id="LC11564">                <span><span>//</span> SSBDeployment UnicodeStream (unicode text)</span></td>
      </tr>
      <tr>
        <td id="L11565" data-line-number="11565"></td>
        <td id="LC11565">                <span><span>//</span> Timeout (uint) -- optional</span></td>
      </tr>
      <tr>
        <td id="L11566" data-line-number="11566"></td>
        <td id="LC11566">                <span><span>//</span> WEBDATA 102263: Don't send timeout value if it is 0</span></td>
      </tr>
      <tr>
        <td id="L11567" data-line-number="11567"></td>
        <td id="LC11567">
</td>
      </tr>
      <tr>
        <td id="L11568" data-line-number="11568"></td>
        <td id="LC11568">                <span>int</span> <span>headerLength</span> <span>=</span> <span>4</span> <span>+</span> <span>2</span> <span>+</span> <span>2</span> <span>+</span> (<span>callbackId</span>.<span>Length</span> <span>*</span> <span>2</span>) <span>+</span> <span>2</span> <span>+</span> (<span>service</span>.<span>Length</span> <span>*</span> <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L11569" data-line-number="11569"></td>
        <td id="LC11569">                <span>if</span> (<span>timeout</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L11570" data-line-number="11570"></td>
        <td id="LC11570">                    <span>headerLength</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L11571" data-line-number="11571"></td>
        <td id="LC11571">                <span>return</span> <span>headerLength</span>;</td>
      </tr>
      <tr>
        <td id="L11572" data-line-number="11572"></td>
        <td id="LC11572">            }</td>
      </tr>
      <tr>
        <td id="L11573" data-line-number="11573"></td>
        <td id="LC11573">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L11574" data-line-number="11574"></td>
        <td id="LC11574">            {</td>
      </tr>
      <tr>
        <td id="L11575" data-line-number="11575"></td>
        <td id="LC11575">                <span>return</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L11576" data-line-number="11576"></td>
        <td id="LC11576">            }</td>
      </tr>
      <tr>
        <td id="L11577" data-line-number="11577"></td>
        <td id="LC11577">        }</td>
      </tr>
      <tr>
        <td id="L11578" data-line-number="11578"></td>
        <td id="LC11578">
</td>
      </tr>
      <tr>
        <td id="L11579" data-line-number="11579"></td>
        <td id="LC11579">        <span><span>//</span> Write query notificaiton header data, not including the notificaiton header length</span></td>
      </tr>
      <tr>
        <td id="L11580" data-line-number="11580"></td>
        <td id="LC11580">        <span>private</span> <span>void</span> <span>WriteQueryNotificationHeaderData</span>(<span>SqlNotificationRequest</span> <span>notificationRequest</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L11581" data-line-number="11581"></td>
        <td id="LC11581">        {</td>
      </tr>
      <tr>
        <td id="L11582" data-line-number="11582"></td>
        <td id="LC11582">            <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>WriteQueryNotificationHeaderData called on a non-Yukon server<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11583" data-line-number="11583"></td>
        <td id="LC11583">
</td>
      </tr>
      <tr>
        <td id="L11584" data-line-number="11584"></td>
        <td id="LC11584">            <span><span>//</span> We may need to update the notification header length if the header is changed in the future</span></td>
      </tr>
      <tr>
        <td id="L11585" data-line-number="11585"></td>
        <td id="LC11585">
</td>
      </tr>
      <tr>
        <td id="L11586" data-line-number="11586"></td>
        <td id="LC11586">            <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>!=</span> <span>notificationRequest</span>, <span><span>"</span>notificaitonRequest is null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11587" data-line-number="11587"></td>
        <td id="LC11587">
</td>
      </tr>
      <tr>
        <td id="L11588" data-line-number="11588"></td>
        <td id="LC11588">            <span>string</span> <span>callbackId</span> <span>=</span> <span>notificationRequest</span>.<span>UserData</span>;</td>
      </tr>
      <tr>
        <td id="L11589" data-line-number="11589"></td>
        <td id="LC11589">            <span>string</span> <span>service</span> <span>=</span> <span>notificationRequest</span>.<span>Options</span>;</td>
      </tr>
      <tr>
        <td id="L11590" data-line-number="11590"></td>
        <td id="LC11590">            <span>int</span> <span>timeout</span> <span>=</span> <span>notificationRequest</span>.<span>Timeout</span>;</td>
      </tr>
      <tr>
        <td id="L11591" data-line-number="11591"></td>
        <td id="LC11591">
</td>
      </tr>
      <tr>
        <td id="L11592" data-line-number="11592"></td>
        <td id="LC11592">            <span><span>//</span> we did verification in GetNotificationHeaderSize, so just assert here.</span></td>
      </tr>
      <tr>
        <td id="L11593" data-line-number="11593"></td>
        <td id="LC11593">            <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>!=</span> <span>callbackId</span>, <span><span>"</span>CallbackId is null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11594" data-line-number="11594"></td>
        <td id="LC11594">            <span>Debug</span>.<span>Assert</span>(<span>UInt16</span>.<span>MaxValue</span> <span>&gt;=</span> <span>callbackId</span>.<span>Length</span>, <span><span>"</span>CallbackId length is out of range<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11595" data-line-number="11595"></td>
        <td id="LC11595">            <span>Debug</span>.<span>Assert</span>(<span>null</span> <span>!=</span> <span>service</span>, <span><span>"</span>Service is null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11596" data-line-number="11596"></td>
        <td id="LC11596">            <span>Debug</span>.<span>Assert</span>(<span>UInt16</span>.<span>MaxValue</span> <span>&gt;=</span> <span>service</span>.<span>Length</span>, <span><span>"</span>Service length is out of range<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11597" data-line-number="11597"></td>
        <td id="LC11597">            <span>Debug</span>.<span>Assert</span>(<span>-</span><span>1</span> <span>&lt;=</span> <span>timeout</span>, <span><span>"</span>Timeout<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11598" data-line-number="11598"></td>
        <td id="LC11598">
</td>
      </tr>
      <tr>
        <td id="L11599" data-line-number="11599"></td>
        <td id="LC11599">
</td>
      </tr>
      <tr>
        <td id="L11600" data-line-number="11600"></td>
        <td id="LC11600">            <span>Bid</span>.<span>NotificationsTrace</span>(<span><span>"</span>&lt;sc.TdsParser.WriteQueryNotificationHeader|DEP&gt; NotificationRequest: userData: '%ls', options: '%ls', timeout: '%d'<span>\n</span><span>"</span></span>, <span>notificationRequest</span>.<span>UserData</span>, <span>notificationRequest</span>.<span>Options</span>, <span>notificationRequest</span>.<span>Timeout</span>);</td>
      </tr>
      <tr>
        <td id="L11601" data-line-number="11601"></td>
        <td id="LC11601">
</td>
      </tr>
      <tr>
        <td id="L11602" data-line-number="11602"></td>
        <td id="LC11602">            <span>WriteShort</span>(<span>TdsEnums</span>.<span>HEADERTYPE_QNOTIFICATION</span>, <span>stateObj</span>);      <span><span>//</span> Query notifications Type</span></td>
      </tr>
      <tr>
        <td id="L11603" data-line-number="11603"></td>
        <td id="LC11603">
</td>
      </tr>
      <tr>
        <td id="L11604" data-line-number="11604"></td>
        <td id="LC11604">            <span>WriteShort</span>(<span>callbackId</span>.<span>Length</span> <span>*</span> <span>2</span>, <span>stateObj</span>); <span><span>//</span> Length in bytes</span></td>
      </tr>
      <tr>
        <td id="L11605" data-line-number="11605"></td>
        <td id="LC11605">            <span>WriteString</span>(<span>callbackId</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11606" data-line-number="11606"></td>
        <td id="LC11606">
</td>
      </tr>
      <tr>
        <td id="L11607" data-line-number="11607"></td>
        <td id="LC11607">            <span>WriteShort</span>(<span>service</span>.<span>Length</span> <span>*</span> <span>2</span>, <span>stateObj</span>); <span><span>//</span> Length in bytes</span></td>
      </tr>
      <tr>
        <td id="L11608" data-line-number="11608"></td>
        <td id="LC11608">            <span>WriteString</span>(<span>service</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11609" data-line-number="11609"></td>
        <td id="LC11609">            <span>if</span> (<span>timeout</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L11610" data-line-number="11610"></td>
        <td id="LC11610">                <span>WriteInt</span>(<span>timeout</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11611" data-line-number="11611"></td>
        <td id="LC11611">        }</td>
      </tr>
      <tr>
        <td id="L11612" data-line-number="11612"></td>
        <td id="LC11612">
</td>
      </tr>
      <tr>
        <td id="L11613" data-line-number="11613"></td>
        <td id="LC11613">        <span><span>//</span> Write the trace header data, not including the trace header length</span></td>
      </tr>
      <tr>
        <td id="L11614" data-line-number="11614"></td>
        <td id="LC11614">        <span>private</span> <span>void</span> <span>WriteTraceHeaderData</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L11615" data-line-number="11615"></td>
        <td id="LC11615">        {</td>
      </tr>
      <tr>
        <td id="L11616" data-line-number="11616"></td>
        <td id="LC11616">            <span>Debug</span>.<span>Assert</span>(<span>this</span>.<span>IncludeTraceHeader</span>, <span><span>"</span>WriteTraceHeaderData can only be called on a Denali or higher version server and bid trace with the control bit are on<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11617" data-line-number="11617"></td>
        <td id="LC11617">
</td>
      </tr>
      <tr>
        <td id="L11618" data-line-number="11618"></td>
        <td id="LC11618">            <span><span>//</span> We may need to update the trace header length if trace header is changed in the future</span></td>
      </tr>
      <tr>
        <td id="L11619" data-line-number="11619"></td>
        <td id="LC11619">
</td>
      </tr>
      <tr>
        <td id="L11620" data-line-number="11620"></td>
        <td id="LC11620">            <span>ActivityCorrelator</span>.<span>ActivityId</span> <span>actId</span> <span>=</span> <span>ActivityCorrelator</span>.<span>Current</span>;</td>
      </tr>
      <tr>
        <td id="L11621" data-line-number="11621"></td>
        <td id="LC11621">
</td>
      </tr>
      <tr>
        <td id="L11622" data-line-number="11622"></td>
        <td id="LC11622">            <span>WriteShort</span>(<span>TdsEnums</span>.<span>HEADERTYPE_TRACE</span>, <span>stateObj</span>);      <span><span>//</span> Trace Header Type</span></td>
      </tr>
      <tr>
        <td id="L11623" data-line-number="11623"></td>
        <td id="LC11623">
</td>
      </tr>
      <tr>
        <td id="L11624" data-line-number="11624"></td>
        <td id="LC11624">            <span>stateObj</span>.<span>WriteByteArray</span>(<span>actId</span>.<span>Id</span>.<span>ToByteArray</span>(), <span>GUID_SIZE</span>, <span>0</span>); <span><span>//</span> Id (Guid)</span></td>
      </tr>
      <tr>
        <td id="L11625" data-line-number="11625"></td>
        <td id="LC11625">            <span>WriteUnsignedInt</span>(<span>actId</span>.<span>Sequence</span>, <span>stateObj</span>); <span><span>//</span> sequence number</span></td>
      </tr>
      <tr>
        <td id="L11626" data-line-number="11626"></td>
        <td id="LC11626">
</td>
      </tr>
      <tr>
        <td id="L11627" data-line-number="11627"></td>
        <td id="LC11627">            <span>Bid</span>.<span>Trace</span>(<span><span>"</span>&lt;sc.TdsParser.WriteTraceHeaderData|INFO&gt; ActivityID %ls<span>\n</span><span>"</span></span>, <span>actId</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L11628" data-line-number="11628"></td>
        <td id="LC11628">        }</td>
      </tr>
      <tr>
        <td id="L11629" data-line-number="11629"></td>
        <td id="LC11629">
</td>
      </tr>
      <tr>
        <td id="L11630" data-line-number="11630"></td>
        <td id="LC11630">        <span>private</span> <span>void</span> <span>WriteRPCBatchHeaders</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>SqlNotificationRequest</span> <span>notificationRequest</span>)</td>
      </tr>
      <tr>
        <td id="L11631" data-line-number="11631"></td>
        <td id="LC11631">        {</td>
      </tr>
      <tr>
        <td id="L11632" data-line-number="11632"></td>
        <td id="LC11632">            <span>Debug</span>.<span>Assert</span>(<span>_isYukon</span>, <span><span>"</span>WriteRPCBatchHeaders can only be called on Yukon or higher version servers<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11633" data-line-number="11633"></td>
        <td id="LC11633">
</td>
      </tr>
      <tr>
        <td id="L11634" data-line-number="11634"></td>
        <td id="LC11634">            <span><span>/*</span> Header:</span></td>
      </tr>
      <tr>
        <td id="L11635" data-line-number="11635"></td>
        <td id="LC11635"><span>               TotalLength  - DWORD  - including all headers and lengths, including itself</span></td>
      </tr>
      <tr>
        <td id="L11636" data-line-number="11636"></td>
        <td id="LC11636"><span>               Each Data Session:</span></td>
      </tr>
      <tr>
        <td id="L11637" data-line-number="11637"></td>
        <td id="LC11637"><span>               {</span></td>
      </tr>
      <tr>
        <td id="L11638" data-line-number="11638"></td>
        <td id="LC11638"><span>                     HeaderLength - DWORD  - including all header length fields, including itself</span></td>
      </tr>
      <tr>
        <td id="L11639" data-line-number="11639"></td>
        <td id="LC11639"><span>                     HeaderType   - USHORT</span></td>
      </tr>
      <tr>
        <td id="L11640" data-line-number="11640"></td>
        <td id="LC11640"><span>                     HeaderData</span></td>
      </tr>
      <tr>
        <td id="L11641" data-line-number="11641"></td>
        <td id="LC11641"><span>               }</span></td>
      </tr>
      <tr>
        <td id="L11642" data-line-number="11642"></td>
        <td id="LC11642"><span>            <span>*/</span></span></td>
      </tr>
      <tr>
        <td id="L11643" data-line-number="11643"></td>
        <td id="LC11643">
</td>
      </tr>
      <tr>
        <td id="L11644" data-line-number="11644"></td>
        <td id="LC11644">            <span>int</span> <span>notificationHeaderSize</span> <span>=</span> <span>GetNotificationHeaderSize</span>(<span>notificationRequest</span>);</td>
      </tr>
      <tr>
        <td id="L11645" data-line-number="11645"></td>
        <td id="LC11645">
</td>
      </tr>
      <tr>
        <td id="L11646" data-line-number="11646"></td>
        <td id="LC11646">            <span>const</span> <span>int</span> <span>marsHeaderSize</span> <span>=</span> <span>18</span>; <span><span>//</span> 4 + 2 + 8 + 4</span></td>
      </tr>
      <tr>
        <td id="L11647" data-line-number="11647"></td>
        <td id="LC11647">
</td>
      </tr>
      <tr>
        <td id="L11648" data-line-number="11648"></td>
        <td id="LC11648">            <span><span>//</span> Header Length (DWORD)</span></td>
      </tr>
      <tr>
        <td id="L11649" data-line-number="11649"></td>
        <td id="LC11649">            <span><span>//</span> Header Type (ushort)</span></td>
      </tr>
      <tr>
        <td id="L11650" data-line-number="11650"></td>
        <td id="LC11650">            <span><span>//</span> Trace Data Guid</span></td>
      </tr>
      <tr>
        <td id="L11651" data-line-number="11651"></td>
        <td id="LC11651">            <span><span>//</span> Trace Data Sequence Number (uint)</span></td>
      </tr>
      <tr>
        <td id="L11652" data-line-number="11652"></td>
        <td id="LC11652">            <span>const</span> <span>int</span> <span>traceHeaderSize</span> <span>=</span> <span>26</span>;  <span><span>//</span> 4 + 2 + GUID_SIZE + sizeof(UInt32);</span></td>
      </tr>
      <tr>
        <td id="L11653" data-line-number="11653"></td>
        <td id="LC11653">
</td>
      </tr>
      <tr>
        <td id="L11654" data-line-number="11654"></td>
        <td id="LC11654">            <span><span>//</span> TotalLength  - DWORD  - including all headers and lengths, including itself</span></td>
      </tr>
      <tr>
        <td id="L11655" data-line-number="11655"></td>
        <td id="LC11655">            <span>int</span> <span>totalHeaderLength</span> <span>=</span> <span>this</span>.<span>IncludeTraceHeader</span> <span>?</span> (<span>4</span> <span>+</span> <span>marsHeaderSize</span> <span>+</span> <span>notificationHeaderSize</span> <span>+</span> <span>traceHeaderSize</span>) <span>:</span> (<span>4</span> <span>+</span> <span>marsHeaderSize</span> <span>+</span> <span>notificationHeaderSize</span>);</td>
      </tr>
      <tr>
        <td id="L11656" data-line-number="11656"></td>
        <td id="LC11656">            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_outBytesUsed</span> <span>==</span> <span>stateObj</span>.<span>_outputHeaderLen</span>, <span><span>"</span>Output bytes written before total header length<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11657" data-line-number="11657"></td>
        <td id="LC11657">            <span><span>//</span> Write total header length</span></td>
      </tr>
      <tr>
        <td id="L11658" data-line-number="11658"></td>
        <td id="LC11658">            <span>WriteInt</span>(<span>totalHeaderLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11659" data-line-number="11659"></td>
        <td id="LC11659">
</td>
      </tr>
      <tr>
        <td id="L11660" data-line-number="11660"></td>
        <td id="LC11660">            <span><span>//</span> Write Mars header length</span></td>
      </tr>
      <tr>
        <td id="L11661" data-line-number="11661"></td>
        <td id="LC11661">            <span>WriteInt</span>(<span>marsHeaderSize</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11662" data-line-number="11662"></td>
        <td id="LC11662">            <span><span>//</span> Write Mars header data</span></td>
      </tr>
      <tr>
        <td id="L11663" data-line-number="11663"></td>
        <td id="LC11663">            <span>WriteMarsHeaderData</span>(<span>stateObj</span>, <span>CurrentTransaction</span>);</td>
      </tr>
      <tr>
        <td id="L11664" data-line-number="11664"></td>
        <td id="LC11664">
</td>
      </tr>
      <tr>
        <td id="L11665" data-line-number="11665"></td>
        <td id="LC11665">            <span>if</span> (<span>0</span> <span>!=</span> <span>notificationHeaderSize</span>)</td>
      </tr>
      <tr>
        <td id="L11666" data-line-number="11666"></td>
        <td id="LC11666">            {</td>
      </tr>
      <tr>
        <td id="L11667" data-line-number="11667"></td>
        <td id="LC11667">                <span><span>//</span> Write Notification header length</span></td>
      </tr>
      <tr>
        <td id="L11668" data-line-number="11668"></td>
        <td id="LC11668">                <span>WriteInt</span>(<span>notificationHeaderSize</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11669" data-line-number="11669"></td>
        <td id="LC11669">                <span><span>//</span> Write notificaiton header data</span></td>
      </tr>
      <tr>
        <td id="L11670" data-line-number="11670"></td>
        <td id="LC11670">                <span>WriteQueryNotificationHeaderData</span>(<span>notificationRequest</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11671" data-line-number="11671"></td>
        <td id="LC11671">            }</td>
      </tr>
      <tr>
        <td id="L11672" data-line-number="11672"></td>
        <td id="LC11672">
</td>
      </tr>
      <tr>
        <td id="L11673" data-line-number="11673"></td>
        <td id="LC11673">            <span>if</span> (<span>IncludeTraceHeader</span>)</td>
      </tr>
      <tr>
        <td id="L11674" data-line-number="11674"></td>
        <td id="LC11674">            {</td>
      </tr>
      <tr>
        <td id="L11675" data-line-number="11675"></td>
        <td id="LC11675">
</td>
      </tr>
      <tr>
        <td id="L11676" data-line-number="11676"></td>
        <td id="LC11676">                <span><span>//</span> Write trace header length</span></td>
      </tr>
      <tr>
        <td id="L11677" data-line-number="11677"></td>
        <td id="LC11677">                <span>WriteInt</span>(<span>traceHeaderSize</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11678" data-line-number="11678"></td>
        <td id="LC11678">                <span><span>//</span> Write trace header data</span></td>
      </tr>
      <tr>
        <td id="L11679" data-line-number="11679"></td>
        <td id="LC11679">                <span>WriteTraceHeaderData</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11680" data-line-number="11680"></td>
        <td id="LC11680">            }</td>
      </tr>
      <tr>
        <td id="L11681" data-line-number="11681"></td>
        <td id="LC11681">        }</td>
      </tr>
      <tr>
        <td id="L11682" data-line-number="11682"></td>
        <td id="LC11682">
</td>
      </tr>
      <tr>
        <td id="L11683" data-line-number="11683"></td>
        <td id="LC11683">
</td>
      </tr>
      <tr>
        <td id="L11684" data-line-number="11684"></td>
        <td id="LC11684">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L11685" data-line-number="11685"></td>
        <td id="LC11685">        <span><span>//</span> Reverse function of GetTokenLength</span></td>
      </tr>
      <tr>
        <td id="L11686" data-line-number="11686"></td>
        <td id="LC11686">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L11687" data-line-number="11687"></td>
        <td id="LC11687">        <span>private</span> <span>void</span> <span>WriteTokenLength</span>(<span>byte</span> <span>token</span>, <span>int</span> <span>length</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L11688" data-line-number="11688"></td>
        <td id="LC11688">        {</td>
      </tr>
      <tr>
        <td id="L11689" data-line-number="11689"></td>
        <td id="LC11689">            <span>int</span> <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L11690" data-line-number="11690"></td>
        <td id="LC11690">
</td>
      </tr>
      <tr>
        <td id="L11691" data-line-number="11691"></td>
        <td id="LC11691">            <span>Debug</span>.<span>Assert</span>(<span>token</span> <span>!=</span> <span>0</span>, <span><span>"</span>0 length token!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11692" data-line-number="11692"></td>
        <td id="LC11692">
</td>
      </tr>
      <tr>
        <td id="L11693" data-line-number="11693"></td>
        <td id="LC11693">            <span><span>//</span> For Plp fields, this should only be used when writing to metadata header.</span></td>
      </tr>
      <tr>
        <td id="L11694" data-line-number="11694"></td>
        <td id="LC11694">            <span><span>//</span> For actual data length, WriteDataLength should be used.</span></td>
      </tr>
      <tr>
        <td id="L11695" data-line-number="11695"></td>
        <td id="LC11695">            <span><span>//</span> For Xml fields, there is no token length field. For MAX fields it is 0xffff.</span></td>
      </tr>
      <tr>
        <td id="L11696" data-line-number="11696"></td>
        <td id="LC11696">            <span>if</span> (<span>_isYukon</span>)</td>
      </tr>
      <tr>
        <td id="L11697" data-line-number="11697"></td>
        <td id="LC11697">            {     <span><span>//</span> Handle Yukon specific exceptions</span></td>
      </tr>
      <tr>
        <td id="L11698" data-line-number="11698"></td>
        <td id="LC11698">                <span>if</span> (<span>TdsEnums</span>.<span>SQLUDT</span> <span>==</span> <span>token</span>)</td>
      </tr>
      <tr>
        <td id="L11699" data-line-number="11699"></td>
        <td id="LC11699">                {</td>
      </tr>
      <tr>
        <td id="L11700" data-line-number="11700"></td>
        <td id="LC11700">                    <span>tokenLength</span> <span>=</span> <span>8</span>;</td>
      </tr>
      <tr>
        <td id="L11701" data-line-number="11701"></td>
        <td id="LC11701">                }</td>
      </tr>
      <tr>
        <td id="L11702" data-line-number="11702"></td>
        <td id="LC11702">                <span>else</span> <span>if</span> (<span>token</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>)</td>
      </tr>
      <tr>
        <td id="L11703" data-line-number="11703"></td>
        <td id="LC11703">                {</td>
      </tr>
      <tr>
        <td id="L11704" data-line-number="11704"></td>
        <td id="LC11704">                    <span>tokenLength</span> <span>=</span> <span>8</span>;</td>
      </tr>
      <tr>
        <td id="L11705" data-line-number="11705"></td>
        <td id="LC11705">                }</td>
      </tr>
      <tr>
        <td id="L11706" data-line-number="11706"></td>
        <td id="LC11706">            }</td>
      </tr>
      <tr>
        <td id="L11707" data-line-number="11707"></td>
        <td id="LC11707">
</td>
      </tr>
      <tr>
        <td id="L11708" data-line-number="11708"></td>
        <td id="LC11708">            <span>if</span> (<span>tokenLength</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L11709" data-line-number="11709"></td>
        <td id="LC11709">            {</td>
      </tr>
      <tr>
        <td id="L11710" data-line-number="11710"></td>
        <td id="LC11710">                <span>switch</span> (<span>token</span> <span>&amp;</span> <span>TdsEnums</span>.<span>SQLLenMask</span>)</td>
      </tr>
      <tr>
        <td id="L11711" data-line-number="11711"></td>
        <td id="LC11711">                {</td>
      </tr>
      <tr>
        <td id="L11712" data-line-number="11712"></td>
        <td id="LC11712">                    <span>case</span> <span>TdsEnums</span>.<span>SQLFixedLen</span>:</td>
      </tr>
      <tr>
        <td id="L11713" data-line-number="11713"></td>
        <td id="LC11713">                        <span>Debug</span>.<span>Assert</span>(<span>length</span> <span>==</span> <span>0x01</span> <span>&lt;&lt;</span> ((<span>token</span> <span>&amp;</span> <span>0x0c</span>) <span>&gt;&gt;</span> <span>2</span>), <span><span>"</span>length does not match encoded length in token<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11714" data-line-number="11714"></td>
        <td id="LC11714">                        <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L11715" data-line-number="11715"></td>
        <td id="LC11715">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11716" data-line-number="11716"></td>
        <td id="LC11716">
</td>
      </tr>
      <tr>
        <td id="L11717" data-line-number="11717"></td>
        <td id="LC11717">                    <span>case</span> <span>TdsEnums</span>.<span>SQLZeroLen</span>:</td>
      </tr>
      <tr>
        <td id="L11718" data-line-number="11718"></td>
        <td id="LC11718">                        <span>tokenLength</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L11719" data-line-number="11719"></td>
        <td id="LC11719">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11720" data-line-number="11720"></td>
        <td id="LC11720">
</td>
      </tr>
      <tr>
        <td id="L11721" data-line-number="11721"></td>
        <td id="LC11721">                    <span>case</span> <span>TdsEnums</span>.<span>SQLVarLen</span>:</td>
      </tr>
      <tr>
        <td id="L11722" data-line-number="11722"></td>
        <td id="LC11722">                    <span>case</span> <span>TdsEnums</span>.<span>SQLVarCnt</span>:</td>
      </tr>
      <tr>
        <td id="L11723" data-line-number="11723"></td>
        <td id="LC11723">                        <span>if</span> (<span>0</span> <span>!=</span> (<span>token</span> <span>&amp;</span> <span>0x80</span>))</td>
      </tr>
      <tr>
        <td id="L11724" data-line-number="11724"></td>
        <td id="LC11724">                            <span>tokenLength</span> <span>=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L11725" data-line-number="11725"></td>
        <td id="LC11725">                        <span>else</span> <span>if</span> (<span>0</span> <span>==</span> (<span>token</span> <span>&amp;</span> <span>0x0c</span>))</td>
      </tr>
      <tr>
        <td id="L11726" data-line-number="11726"></td>
        <td id="LC11726">
</td>
      </tr>
      <tr>
        <td id="L11727" data-line-number="11727"></td>
        <td id="LC11727">                            <span><span>//</span> UNDONE: This should be uint</span></td>
      </tr>
      <tr>
        <td id="L11728" data-line-number="11728"></td>
        <td id="LC11728">                            <span>tokenLength</span> <span>=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L11729" data-line-number="11729"></td>
        <td id="LC11729">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L11730" data-line-number="11730"></td>
        <td id="LC11730">                            <span>tokenLength</span> <span>=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L11731" data-line-number="11731"></td>
        <td id="LC11731">
</td>
      </tr>
      <tr>
        <td id="L11732" data-line-number="11732"></td>
        <td id="LC11732">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11733" data-line-number="11733"></td>
        <td id="LC11733">
</td>
      </tr>
      <tr>
        <td id="L11734" data-line-number="11734"></td>
        <td id="LC11734">                    <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L11735" data-line-number="11735"></td>
        <td id="LC11735">                        <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown token length!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11736" data-line-number="11736"></td>
        <td id="LC11736">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11737" data-line-number="11737"></td>
        <td id="LC11737">                }</td>
      </tr>
      <tr>
        <td id="L11738" data-line-number="11738"></td>
        <td id="LC11738">
</td>
      </tr>
      <tr>
        <td id="L11739" data-line-number="11739"></td>
        <td id="LC11739">                <span>switch</span> (<span>tokenLength</span>)</td>
      </tr>
      <tr>
        <td id="L11740" data-line-number="11740"></td>
        <td id="LC11740">                {</td>
      </tr>
      <tr>
        <td id="L11741" data-line-number="11741"></td>
        <td id="LC11741">                    <span>case</span> <span>1</span>:</td>
      </tr>
      <tr>
        <td id="L11742" data-line-number="11742"></td>
        <td id="LC11742">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>length</span>);</td>
      </tr>
      <tr>
        <td id="L11743" data-line-number="11743"></td>
        <td id="LC11743">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11744" data-line-number="11744"></td>
        <td id="LC11744">
</td>
      </tr>
      <tr>
        <td id="L11745" data-line-number="11745"></td>
        <td id="LC11745">                    <span>case</span> <span>2</span>:</td>
      </tr>
      <tr>
        <td id="L11746" data-line-number="11746"></td>
        <td id="LC11746">                        <span>WriteShort</span>(<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11747" data-line-number="11747"></td>
        <td id="LC11747">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11748" data-line-number="11748"></td>
        <td id="LC11748">
</td>
      </tr>
      <tr>
        <td id="L11749" data-line-number="11749"></td>
        <td id="LC11749">                    <span>case</span> <span>4</span>:</td>
      </tr>
      <tr>
        <td id="L11750" data-line-number="11750"></td>
        <td id="LC11750">                        <span>WriteInt</span>(<span>length</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11751" data-line-number="11751"></td>
        <td id="LC11751">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11752" data-line-number="11752"></td>
        <td id="LC11752">
</td>
      </tr>
      <tr>
        <td id="L11753" data-line-number="11753"></td>
        <td id="LC11753">                    <span>case</span> <span>8</span>:</td>
      </tr>
      <tr>
        <td id="L11754" data-line-number="11754"></td>
        <td id="LC11754">                        <span><span>//</span> In the metadata case we write 0xffff for partial length prefixed types.</span></td>
      </tr>
      <tr>
        <td id="L11755" data-line-number="11755"></td>
        <td id="LC11755">                        <span><span>//</span>  For actual data length preceding data, WriteDataLength should be used.</span></td>
      </tr>
      <tr>
        <td id="L11756" data-line-number="11756"></td>
        <td id="LC11756">                        <span>WriteShort</span>(<span>TdsEnums</span>.<span>SQL_USHORTVARMAXLEN</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11757" data-line-number="11757"></td>
        <td id="LC11757">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11758" data-line-number="11758"></td>
        <td id="LC11758">                } <span><span>//</span> end switch</span></td>
      </tr>
      <tr>
        <td id="L11759" data-line-number="11759"></td>
        <td id="LC11759">            }</td>
      </tr>
      <tr>
        <td id="L11760" data-line-number="11760"></td>
        <td id="LC11760">        }</td>
      </tr>
      <tr>
        <td id="L11761" data-line-number="11761"></td>
        <td id="LC11761">
</td>
      </tr>
      <tr>
        <td id="L11762" data-line-number="11762"></td>
        <td id="LC11762">        <span><span>//</span> Returns true if BOM byte mark is needed for an XML value</span></td>
      </tr>
      <tr>
        <td id="L11763" data-line-number="11763"></td>
        <td id="LC11763">        <span>private</span> <span>bool</span> <span>IsBOMNeeded</span>(<span>MetaType</span> <span>type</span>, <span>object</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L11764" data-line-number="11764"></td>
        <td id="LC11764">        {</td>
      </tr>
      <tr>
        <td id="L11765" data-line-number="11765"></td>
        <td id="LC11765">            <span>if</span> (<span>type</span>.<span>NullableType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>)</td>
      </tr>
      <tr>
        <td id="L11766" data-line-number="11766"></td>
        <td id="LC11766">            {</td>
      </tr>
      <tr>
        <td id="L11767" data-line-number="11767"></td>
        <td id="LC11767">                <span>Type</span> <span>currentType</span> <span>=</span> <span>value</span>.<span>GetType</span>();</td>
      </tr>
      <tr>
        <td id="L11768" data-line-number="11768"></td>
        <td id="LC11768">
</td>
      </tr>
      <tr>
        <td id="L11769" data-line-number="11769"></td>
        <td id="LC11769">                <span>if</span> (<span>currentType</span> <span>==</span> <span>typeof</span>(<span>SqlString</span>))</td>
      </tr>
      <tr>
        <td id="L11770" data-line-number="11770"></td>
        <td id="LC11770">                {</td>
      </tr>
      <tr>
        <td id="L11771" data-line-number="11771"></td>
        <td id="LC11771">                    <span>if</span> (<span>!</span>((<span>SqlString</span>)<span>value</span>).<span>IsNull</span> <span>&amp;&amp;</span> ((((<span>SqlString</span>)<span>value</span>).<span>Value</span>).<span>Length</span> <span>&gt;</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L11772" data-line-number="11772"></td>
        <td id="LC11772">                    {</td>
      </tr>
      <tr>
        <td id="L11773" data-line-number="11773"></td>
        <td id="LC11773">                        <span>if</span> ((((<span>SqlString</span>)<span>value</span>).<span>Value</span>[<span>0</span>] <span>&amp;</span> <span>0xff</span>) <span>!=</span> <span>0xff</span>)</td>
      </tr>
      <tr>
        <td id="L11774" data-line-number="11774"></td>
        <td id="LC11774">                            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L11775" data-line-number="11775"></td>
        <td id="LC11775">                    }</td>
      </tr>
      <tr>
        <td id="L11776" data-line-number="11776"></td>
        <td id="LC11776">                }</td>
      </tr>
      <tr>
        <td id="L11777" data-line-number="11777"></td>
        <td id="LC11777">                <span>else</span> <span>if</span> ((<span>currentType</span> <span>==</span> <span>typeof</span>(<span>String</span>)) <span>&amp;&amp;</span> (((<span>String</span>)<span>value</span>).<span>Length</span> <span>&gt;</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L11778" data-line-number="11778"></td>
        <td id="LC11778">                {</td>
      </tr>
      <tr>
        <td id="L11779" data-line-number="11779"></td>
        <td id="LC11779">                    <span>if</span> ((<span>value</span> <span>!=</span> <span>null</span>) <span>&amp;&amp;</span> (((<span>String</span>)<span>value</span>)[<span>0</span>] <span>&amp;</span> <span>0xff</span>) <span>!=</span> <span>0xff</span>)</td>
      </tr>
      <tr>
        <td id="L11780" data-line-number="11780"></td>
        <td id="LC11780">                        <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L11781" data-line-number="11781"></td>
        <td id="LC11781">                }</td>
      </tr>
      <tr>
        <td id="L11782" data-line-number="11782"></td>
        <td id="LC11782">                <span>else</span> <span>if</span> (<span>currentType</span> <span>==</span> <span>typeof</span>(<span>SqlXml</span>))</td>
      </tr>
      <tr>
        <td id="L11783" data-line-number="11783"></td>
        <td id="LC11783">                {</td>
      </tr>
      <tr>
        <td id="L11784" data-line-number="11784"></td>
        <td id="LC11784">                    <span>if</span> (<span>!</span>((<span>SqlXml</span>)<span>value</span>).<span>IsNull</span>)</td>
      </tr>
      <tr>
        <td id="L11785" data-line-number="11785"></td>
        <td id="LC11785">                        <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L11786" data-line-number="11786"></td>
        <td id="LC11786">                }</td>
      </tr>
      <tr>
        <td id="L11787" data-line-number="11787"></td>
        <td id="LC11787">                <span>else</span> <span>if</span> (<span>currentType</span> <span>==</span> <span>typeof</span>(<span>XmlDataFeed</span>))</td>
      </tr>
      <tr>
        <td id="L11788" data-line-number="11788"></td>
        <td id="LC11788">                {</td>
      </tr>
      <tr>
        <td id="L11789" data-line-number="11789"></td>
        <td id="LC11789">                    <span>return</span> <span>true</span>;             <span><span>//</span> Values will eventually converted to unicode string here</span></td>
      </tr>
      <tr>
        <td id="L11790" data-line-number="11790"></td>
        <td id="LC11790">                }</td>
      </tr>
      <tr>
        <td id="L11791" data-line-number="11791"></td>
        <td id="LC11791">            }</td>
      </tr>
      <tr>
        <td id="L11792" data-line-number="11792"></td>
        <td id="LC11792">            <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L11793" data-line-number="11793"></td>
        <td id="LC11793">        }</td>
      </tr>
      <tr>
        <td id="L11794" data-line-number="11794"></td>
        <td id="LC11794">
</td>
      </tr>
      <tr>
        <td id="L11795" data-line-number="11795"></td>
        <td id="LC11795">        <span>private</span> <span>Task</span> <span>GetTerminationTask</span>(<span>Task</span> <span>unterminatedWriteTask</span>, <span>object</span> <span>value</span>, <span>MetaType</span> <span>type</span>, <span>int</span> <span>actualLength</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L11796" data-line-number="11796"></td>
        <td id="LC11796">        {</td>
      </tr>
      <tr>
        <td id="L11797" data-line-number="11797"></td>
        <td id="LC11797">            <span>if</span> (<span>type</span>.<span>IsPlp</span> <span>&amp;&amp;</span> ((<span>actualLength</span> <span>&gt;</span> <span>0</span>) <span>||</span> <span>isDataFeed</span>))</td>
      </tr>
      <tr>
        <td id="L11798" data-line-number="11798"></td>
        <td id="LC11798">            {</td>
      </tr>
      <tr>
        <td id="L11799" data-line-number="11799"></td>
        <td id="LC11799">                <span>if</span> (<span>unterminatedWriteTask</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L11800" data-line-number="11800"></td>
        <td id="LC11800">                {</td>
      </tr>
      <tr>
        <td id="L11801" data-line-number="11801"></td>
        <td id="LC11801">                    <span>WriteInt</span>(<span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11802" data-line-number="11802"></td>
        <td id="LC11802">                    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L11803" data-line-number="11803"></td>
        <td id="LC11803">                }</td>
      </tr>
      <tr>
        <td id="L11804" data-line-number="11804"></td>
        <td id="LC11804">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L11805" data-line-number="11805"></td>
        <td id="LC11805">                {</td>
      </tr>
      <tr>
        <td id="L11806" data-line-number="11806"></td>
        <td id="LC11806">                    <span>return</span> <span>AsyncHelper</span>.<span>CreateContinuationTask</span>&lt;<span>int</span>, <span>TdsParserStateObject</span>&gt;(<span>unterminatedWriteTask</span>,</td>
      </tr>
      <tr>
        <td id="L11807" data-line-number="11807"></td>
        <td id="LC11807">                        <span>WriteInt</span>, <span>0</span>, <span>stateObj</span>,</td>
      </tr>
      <tr>
        <td id="L11808" data-line-number="11808"></td>
        <td id="LC11808">                        <span>connectionToDoom</span>: <span>_connHandler</span>);</td>
      </tr>
      <tr>
        <td id="L11809" data-line-number="11809"></td>
        <td id="LC11809">                }</td>
      </tr>
      <tr>
        <td id="L11810" data-line-number="11810"></td>
        <td id="LC11810">            }</td>
      </tr>
      <tr>
        <td id="L11811" data-line-number="11811"></td>
        <td id="LC11811">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L11812" data-line-number="11812"></td>
        <td id="LC11812">            {</td>
      </tr>
      <tr>
        <td id="L11813" data-line-number="11813"></td>
        <td id="LC11813">                <span>return</span> <span>unterminatedWriteTask</span>;</td>
      </tr>
      <tr>
        <td id="L11814" data-line-number="11814"></td>
        <td id="LC11814">            }</td>
      </tr>
      <tr>
        <td id="L11815" data-line-number="11815"></td>
        <td id="LC11815">        }</td>
      </tr>
      <tr>
        <td id="L11816" data-line-number="11816"></td>
        <td id="LC11816">
</td>
      </tr>
      <tr>
        <td id="L11817" data-line-number="11817"></td>
        <td id="LC11817">
</td>
      </tr>
      <tr>
        <td id="L11818" data-line-number="11818"></td>
        <td id="LC11818">        <span>private</span> <span>Task</span> <span>WriteSqlValue</span>(<span>object</span> <span>value</span>, <span>MetaType</span> <span>type</span>, <span>int</span> <span>actualLength</span>, <span>int</span> <span>codePageByteSize</span>, <span>int</span> <span>offset</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L11819" data-line-number="11819"></td>
        <td id="LC11819">        {</td>
      </tr>
      <tr>
        <td id="L11820" data-line-number="11820"></td>
        <td id="LC11820">            <span>return</span> <span>GetTerminationTask</span>(</td>
      </tr>
      <tr>
        <td id="L11821" data-line-number="11821"></td>
        <td id="LC11821">                <span>WriteUnterminatedSqlValue</span>(<span>value</span>, <span>type</span>, <span>actualLength</span>, <span>codePageByteSize</span>, <span>offset</span>, <span>stateObj</span>),</td>
      </tr>
      <tr>
        <td id="L11822" data-line-number="11822"></td>
        <td id="LC11822">                <span>value</span>, <span>type</span>, <span>actualLength</span>, <span>stateObj</span>, <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L11823" data-line-number="11823"></td>
        <td id="LC11823">        }</td>
      </tr>
      <tr>
        <td id="L11824" data-line-number="11824"></td>
        <td id="LC11824">
</td>
      </tr>
      <tr>
        <td id="L11825" data-line-number="11825"></td>
        <td id="LC11825">        <span><span>//</span> For MAX types, this method can only write everything in one big chunk. If multiple</span></td>
      </tr>
      <tr>
        <td id="L11826" data-line-number="11826"></td>
        <td id="LC11826">        <span><span>//</span> chunk writes needed, please use WritePlpBytes/WritePlpChars</span></td>
      </tr>
      <tr>
        <td id="L11827" data-line-number="11827"></td>
        <td id="LC11827">        <span>private</span> <span>Task</span> <span>WriteUnterminatedSqlValue</span>(<span>object</span> <span>value</span>, <span>MetaType</span> <span>type</span>, <span>int</span> <span>actualLength</span>, <span>int</span> <span>codePageByteSize</span>, <span>int</span> <span>offset</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L11828" data-line-number="11828"></td>
        <td id="LC11828">        {</td>
      </tr>
      <tr>
        <td id="L11829" data-line-number="11829"></td>
        <td id="LC11829">            <span>Debug</span>.<span>Assert</span>(((<span>type</span>.<span>NullableType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>) <span>||</span></td>
      </tr>
      <tr>
        <td id="L11830" data-line-number="11830"></td>
        <td id="LC11830">                   (<span>value</span> <span>is</span> <span>INullable</span> <span>&amp;&amp;</span> <span>!</span>((<span>INullable</span>)<span>value</span>).<span>IsNull</span>)),</td>
      </tr>
      <tr>
        <td id="L11831" data-line-number="11831"></td>
        <td id="LC11831">                   <span><span>"</span>unexpected null SqlType!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11832" data-line-number="11832"></td>
        <td id="LC11832">
</td>
      </tr>
      <tr>
        <td id="L11833" data-line-number="11833"></td>
        <td id="LC11833">            <span><span>//</span> parameters are always sent over as BIG or N types</span></td>
      </tr>
      <tr>
        <td id="L11834" data-line-number="11834"></td>
        <td id="LC11834">            <span>switch</span> (<span>type</span>.<span>NullableType</span>)</td>
      </tr>
      <tr>
        <td id="L11835" data-line-number="11835"></td>
        <td id="LC11835">            {</td>
      </tr>
      <tr>
        <td id="L11836" data-line-number="11836"></td>
        <td id="LC11836">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLTN</span>:</td>
      </tr>
      <tr>
        <td id="L11837" data-line-number="11837"></td>
        <td id="LC11837">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L11838" data-line-number="11838"></td>
        <td id="LC11838">                        <span>WriteFloat</span>(((<span>SqlSingle</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11839" data-line-number="11839"></td>
        <td id="LC11839">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11840" data-line-number="11840"></td>
        <td id="LC11840">                    {</td>
      </tr>
      <tr>
        <td id="L11841" data-line-number="11841"></td>
        <td id="LC11841">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>Invalid length for SqlDouble type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11842" data-line-number="11842"></td>
        <td id="LC11842">                        <span>WriteDouble</span>(((<span>SqlDouble</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11843" data-line-number="11843"></td>
        <td id="LC11843">                    }</td>
      </tr>
      <tr>
        <td id="L11844" data-line-number="11844"></td>
        <td id="LC11844">
</td>
      </tr>
      <tr>
        <td id="L11845" data-line-number="11845"></td>
        <td id="LC11845">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11846" data-line-number="11846"></td>
        <td id="LC11846">
</td>
      </tr>
      <tr>
        <td id="L11847" data-line-number="11847"></td>
        <td id="LC11847">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L11848" data-line-number="11848"></td>
        <td id="LC11848">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L11849" data-line-number="11849"></td>
        <td id="LC11849">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L11850" data-line-number="11850"></td>
        <td id="LC11850">                    {</td>
      </tr>
      <tr>
        <td id="L11851" data-line-number="11851"></td>
        <td id="LC11851">                        <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L11852" data-line-number="11852"></td>
        <td id="LC11852">                        {</td>
      </tr>
      <tr>
        <td id="L11853" data-line-number="11853"></td>
        <td id="LC11853">                            <span>WriteInt</span>(<span>actualLength</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L11854" data-line-number="11854"></td>
        <td id="LC11854">                        }</td>
      </tr>
      <tr>
        <td id="L11855" data-line-number="11855"></td>
        <td id="LC11855">
</td>
      </tr>
      <tr>
        <td id="L11856" data-line-number="11856"></td>
        <td id="LC11856">                        <span>if</span> (<span>value</span> <span>is</span> <span>SqlBinary</span>)</td>
      </tr>
      <tr>
        <td id="L11857" data-line-number="11857"></td>
        <td id="LC11857">                        {</td>
      </tr>
      <tr>
        <td id="L11858" data-line-number="11858"></td>
        <td id="LC11858">                            <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>(((<span>SqlBinary</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L11859" data-line-number="11859"></td>
        <td id="LC11859">                        }</td>
      </tr>
      <tr>
        <td id="L11860" data-line-number="11860"></td>
        <td id="LC11860">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L11861" data-line-number="11861"></td>
        <td id="LC11861">                        {</td>
      </tr>
      <tr>
        <td id="L11862" data-line-number="11862"></td>
        <td id="LC11862">                            <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>SqlBytes</span>);</td>
      </tr>
      <tr>
        <td id="L11863" data-line-number="11863"></td>
        <td id="LC11863">                            <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>(((<span>SqlBytes</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L11864" data-line-number="11864"></td>
        <td id="LC11864">                        }</td>
      </tr>
      <tr>
        <td id="L11865" data-line-number="11865"></td>
        <td id="LC11865">                    }</td>
      </tr>
      <tr>
        <td id="L11866" data-line-number="11866"></td>
        <td id="LC11866">
</td>
      </tr>
      <tr>
        <td id="L11867" data-line-number="11867"></td>
        <td id="LC11867">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L11868" data-line-number="11868"></td>
        <td id="LC11868">                    {</td>
      </tr>
      <tr>
        <td id="L11869" data-line-number="11869"></td>
        <td id="LC11869">                        <span>byte</span>[] <span>b</span> <span>=</span> ((<span>SqlGuid</span>)<span>value</span>).<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L11870" data-line-number="11870"></td>
        <td id="LC11870">
</td>
      </tr>
      <tr>
        <td id="L11871" data-line-number="11871"></td>
        <td id="LC11871">                        <span>Debug</span>.<span>Assert</span>((<span>actualLength</span> <span>==</span> <span>b</span>.<span>Length</span>) <span>&amp;&amp;</span> (<span>actualLength</span> <span>==</span> <span>16</span>), <span><span>"</span>Invalid length for guid type in com+ object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11872" data-line-number="11872"></td>
        <td id="LC11872">                        <span>stateObj</span>.<span>WriteByteArray</span>(<span>b</span>, <span>actualLength</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11873" data-line-number="11873"></td>
        <td id="LC11873">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11874" data-line-number="11874"></td>
        <td id="LC11874">                    }</td>
      </tr>
      <tr>
        <td id="L11875" data-line-number="11875"></td>
        <td id="LC11875">
</td>
      </tr>
      <tr>
        <td id="L11876" data-line-number="11876"></td>
        <td id="LC11876">                <span>case</span> <span>TdsEnums</span>.<span>SQLBITN</span>:</td>
      </tr>
      <tr>
        <td id="L11877" data-line-number="11877"></td>
        <td id="LC11877">                    {</td>
      </tr>
      <tr>
        <td id="L11878" data-line-number="11878"></td>
        <td id="LC11878">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>, <span><span>"</span>Invalid length for SqlBoolean type<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11879" data-line-number="11879"></td>
        <td id="LC11879">                        <span>if</span> (((<span>SqlBoolean</span>)<span>value</span>).<span>Value</span> <span>==</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L11880" data-line-number="11880"></td>
        <td id="LC11880">                            <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>);</td>
      </tr>
      <tr>
        <td id="L11881" data-line-number="11881"></td>
        <td id="LC11881">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L11882" data-line-number="11882"></td>
        <td id="LC11882">                            <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L11883" data-line-number="11883"></td>
        <td id="LC11883">
</td>
      </tr>
      <tr>
        <td id="L11884" data-line-number="11884"></td>
        <td id="LC11884">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11885" data-line-number="11885"></td>
        <td id="LC11885">                    }</td>
      </tr>
      <tr>
        <td id="L11886" data-line-number="11886"></td>
        <td id="LC11886">
</td>
      </tr>
      <tr>
        <td id="L11887" data-line-number="11887"></td>
        <td id="LC11887">                <span>case</span> <span>TdsEnums</span>.<span>SQLINTN</span>:</td>
      </tr>
      <tr>
        <td id="L11888" data-line-number="11888"></td>
        <td id="LC11888">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L11889" data-line-number="11889"></td>
        <td id="LC11889">                        <span>stateObj</span>.<span>WriteByte</span>(((<span>SqlByte</span>)<span>value</span>).<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L11890" data-line-number="11890"></td>
        <td id="LC11890">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11891" data-line-number="11891"></td>
        <td id="LC11891">                        <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>2</span>)</td>
      </tr>
      <tr>
        <td id="L11892" data-line-number="11892"></td>
        <td id="LC11892">                        <span>WriteShort</span>(((<span>SqlInt16</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11893" data-line-number="11893"></td>
        <td id="LC11893">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11894" data-line-number="11894"></td>
        <td id="LC11894">                            <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L11895" data-line-number="11895"></td>
        <td id="LC11895">                        <span>WriteInt</span>(((<span>SqlInt32</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11896" data-line-number="11896"></td>
        <td id="LC11896">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11897" data-line-number="11897"></td>
        <td id="LC11897">                    {</td>
      </tr>
      <tr>
        <td id="L11898" data-line-number="11898"></td>
        <td id="LC11898">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for SqlIntN type:  <span>"</span></span> <span>+</span> <span>type</span>.<span>FixedLength</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L11899" data-line-number="11899"></td>
        <td id="LC11899">                        <span>WriteLong</span>(((<span>SqlInt64</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11900" data-line-number="11900"></td>
        <td id="LC11900">                    }</td>
      </tr>
      <tr>
        <td id="L11901" data-line-number="11901"></td>
        <td id="LC11901">
</td>
      </tr>
      <tr>
        <td id="L11902" data-line-number="11902"></td>
        <td id="LC11902">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11903" data-line-number="11903"></td>
        <td id="LC11903">
</td>
      </tr>
      <tr>
        <td id="L11904" data-line-number="11904"></td>
        <td id="LC11904">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11905" data-line-number="11905"></td>
        <td id="LC11905">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11906" data-line-number="11906"></td>
        <td id="LC11906">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L11907" data-line-number="11907"></td>
        <td id="LC11907">                    <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L11908" data-line-number="11908"></td>
        <td id="LC11908">                    {</td>
      </tr>
      <tr>
        <td id="L11909" data-line-number="11909"></td>
        <td id="LC11909">                        <span>WriteInt</span>(<span>codePageByteSize</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L11910" data-line-number="11910"></td>
        <td id="LC11910">                    }</td>
      </tr>
      <tr>
        <td id="L11911" data-line-number="11911"></td>
        <td id="LC11911">                    <span>if</span> (<span>value</span> <span>is</span> <span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)</td>
      </tr>
      <tr>
        <td id="L11912" data-line-number="11912"></td>
        <td id="LC11912">                    {</td>
      </tr>
      <tr>
        <td id="L11913" data-line-number="11913"></td>
        <td id="LC11913">                        <span>String</span> <span>sch</span> <span>=</span> <span>new</span> <span>String</span>(((<span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)<span>value</span>).<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L11914" data-line-number="11914"></td>
        <td id="LC11914">
</td>
      </tr>
      <tr>
        <td id="L11915" data-line-number="11915"></td>
        <td id="LC11915">                        <span>return</span> <span>WriteEncodingChar</span>(<span>sch</span>, <span>actualLength</span>, <span>offset</span>, <span>_defaultEncoding</span>, <span>stateObj</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L11916" data-line-number="11916"></td>
        <td id="LC11916">                    }</td>
      </tr>
      <tr>
        <td id="L11917" data-line-number="11917"></td>
        <td id="LC11917">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11918" data-line-number="11918"></td>
        <td id="LC11918">                    {</td>
      </tr>
      <tr>
        <td id="L11919" data-line-number="11919"></td>
        <td id="LC11919">                        <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>SqlString</span>);</td>
      </tr>
      <tr>
        <td id="L11920" data-line-number="11920"></td>
        <td id="LC11920">                        <span>return</span> <span>WriteEncodingChar</span>(((<span>SqlString</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>, <span>_defaultEncoding</span>, <span>stateObj</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L11921" data-line-number="11921"></td>
        <td id="LC11921">                    }</td>
      </tr>
      <tr>
        <td id="L11922" data-line-number="11922"></td>
        <td id="LC11922">
</td>
      </tr>
      <tr>
        <td id="L11923" data-line-number="11923"></td>
        <td id="LC11923">
</td>
      </tr>
      <tr>
        <td id="L11924" data-line-number="11924"></td>
        <td id="LC11924">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11925" data-line-number="11925"></td>
        <td id="LC11925">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L11926" data-line-number="11926"></td>
        <td id="LC11926">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L11927" data-line-number="11927"></td>
        <td id="LC11927">                <span>case</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>:</td>
      </tr>
      <tr>
        <td id="L11928" data-line-number="11928"></td>
        <td id="LC11928">
</td>
      </tr>
      <tr>
        <td id="L11929" data-line-number="11929"></td>
        <td id="LC11929">                    <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L11930" data-line-number="11930"></td>
        <td id="LC11930">                    {</td>
      </tr>
      <tr>
        <td id="L11931" data-line-number="11931"></td>
        <td id="LC11931">                        <span>if</span> (<span>IsBOMNeeded</span>(<span>type</span>, <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L11932" data-line-number="11932"></td>
        <td id="LC11932">                        {</td>
      </tr>
      <tr>
        <td id="L11933" data-line-number="11933"></td>
        <td id="LC11933">                            <span>WriteInt</span>(<span>actualLength</span> <span>+</span> <span>2</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L11934" data-line-number="11934"></td>
        <td id="LC11934">                            <span>WriteShort</span>(<span>TdsEnums</span>.<span>XMLUNICODEBOM</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11935" data-line-number="11935"></td>
        <td id="LC11935">                        }</td>
      </tr>
      <tr>
        <td id="L11936" data-line-number="11936"></td>
        <td id="LC11936">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L11937" data-line-number="11937"></td>
        <td id="LC11937">                        {</td>
      </tr>
      <tr>
        <td id="L11938" data-line-number="11938"></td>
        <td id="LC11938">                            <span>WriteInt</span>(<span>actualLength</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L11939" data-line-number="11939"></td>
        <td id="LC11939">                        }</td>
      </tr>
      <tr>
        <td id="L11940" data-line-number="11940"></td>
        <td id="LC11940">                    }</td>
      </tr>
      <tr>
        <td id="L11941" data-line-number="11941"></td>
        <td id="LC11941">
</td>
      </tr>
      <tr>
        <td id="L11942" data-line-number="11942"></td>
        <td id="LC11942">                    <span><span>//</span> convert to cchars instead of cbytes</span></td>
      </tr>
      <tr>
        <td id="L11943" data-line-number="11943"></td>
        <td id="LC11943">                    <span><span>//</span> Xml type is already converted to string through GetCoercedValue</span></td>
      </tr>
      <tr>
        <td id="L11944" data-line-number="11944"></td>
        <td id="LC11944">                    <span>if</span> (<span>actualLength</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L11945" data-line-number="11945"></td>
        <td id="LC11945">                        <span>actualLength</span> <span>&gt;&gt;=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L11946" data-line-number="11946"></td>
        <td id="LC11946">
</td>
      </tr>
      <tr>
        <td id="L11947" data-line-number="11947"></td>
        <td id="LC11947">                    <span>if</span> (<span>value</span> <span>is</span> <span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)</td>
      </tr>
      <tr>
        <td id="L11948" data-line-number="11948"></td>
        <td id="LC11948">                    {</td>
      </tr>
      <tr>
        <td id="L11949" data-line-number="11949"></td>
        <td id="LC11949">                        <span>return</span> <span>WriteCharArray</span>(((<span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>, <span>stateObj</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L11950" data-line-number="11950"></td>
        <td id="LC11950">                    }</td>
      </tr>
      <tr>
        <td id="L11951" data-line-number="11951"></td>
        <td id="LC11951">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11952" data-line-number="11952"></td>
        <td id="LC11952">                    {</td>
      </tr>
      <tr>
        <td id="L11953" data-line-number="11953"></td>
        <td id="LC11953">                        <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>SqlString</span>);</td>
      </tr>
      <tr>
        <td id="L11954" data-line-number="11954"></td>
        <td id="LC11954">                        <span>return</span> <span>WriteString</span>(((<span>SqlString</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>, <span>stateObj</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L11955" data-line-number="11955"></td>
        <td id="LC11955">                    }</td>
      </tr>
      <tr>
        <td id="L11956" data-line-number="11956"></td>
        <td id="LC11956">
</td>
      </tr>
      <tr>
        <td id="L11957" data-line-number="11957"></td>
        <td id="LC11957">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L11958" data-line-number="11958"></td>
        <td id="LC11958">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>&lt;=</span> <span>17</span>, <span><span>"</span>Decimal length cannot be greater than 17 bytes<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11959" data-line-number="11959"></td>
        <td id="LC11959">                    <span>WriteSqlDecimal</span>((<span>SqlDecimal</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11960" data-line-number="11960"></td>
        <td id="LC11960">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11961" data-line-number="11961"></td>
        <td id="LC11961">
</td>
      </tr>
      <tr>
        <td id="L11962" data-line-number="11962"></td>
        <td id="LC11962">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMN</span>:</td>
      </tr>
      <tr>
        <td id="L11963" data-line-number="11963"></td>
        <td id="LC11963">                    <span>SqlDateTime</span> <span>dt</span> <span>=</span> (<span>SqlDateTime</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L11964" data-line-number="11964"></td>
        <td id="LC11964">
</td>
      </tr>
      <tr>
        <td id="L11965" data-line-number="11965"></td>
        <td id="LC11965">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L11966" data-line-number="11966"></td>
        <td id="LC11966">                    {</td>
      </tr>
      <tr>
        <td id="L11967" data-line-number="11967"></td>
        <td id="LC11967">                        <span>if</span> (<span>0</span> <span>&gt;</span> <span>dt</span>.<span>DayTicks</span> <span>||</span> <span>dt</span>.<span>DayTicks</span> <span>&gt;</span> <span>UInt16</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L11968" data-line-number="11968"></td>
        <td id="LC11968">                            <span>throw</span> <span>SQL</span>.<span>SmallDateTimeOverflow</span>(<span>dt</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L11969" data-line-number="11969"></td>
        <td id="LC11969">
</td>
      </tr>
      <tr>
        <td id="L11970" data-line-number="11970"></td>
        <td id="LC11970">                        <span>WriteShort</span>(<span>dt</span>.<span>DayTicks</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11971" data-line-number="11971"></td>
        <td id="LC11971">                        <span>WriteShort</span>(<span>dt</span>.<span>TimeTicks</span> <span>/</span> <span>SqlDateTime</span>.<span>SQLTicksPerMinute</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11972" data-line-number="11972"></td>
        <td id="LC11972">                    }</td>
      </tr>
      <tr>
        <td id="L11973" data-line-number="11973"></td>
        <td id="LC11973">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L11974" data-line-number="11974"></td>
        <td id="LC11974">                    {</td>
      </tr>
      <tr>
        <td id="L11975" data-line-number="11975"></td>
        <td id="LC11975">                        <span>WriteInt</span>(<span>dt</span>.<span>DayTicks</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11976" data-line-number="11976"></td>
        <td id="LC11976">                        <span>WriteInt</span>(<span>dt</span>.<span>TimeTicks</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11977" data-line-number="11977"></td>
        <td id="LC11977">                    }</td>
      </tr>
      <tr>
        <td id="L11978" data-line-number="11978"></td>
        <td id="LC11978">
</td>
      </tr>
      <tr>
        <td id="L11979" data-line-number="11979"></td>
        <td id="LC11979">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11980" data-line-number="11980"></td>
        <td id="LC11980">
</td>
      </tr>
      <tr>
        <td id="L11981" data-line-number="11981"></td>
        <td id="LC11981">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEYN</span>:</td>
      </tr>
      <tr>
        <td id="L11982" data-line-number="11982"></td>
        <td id="LC11982">                    {</td>
      </tr>
      <tr>
        <td id="L11983" data-line-number="11983"></td>
        <td id="LC11983">                        <span>WriteSqlMoney</span>((<span>SqlMoney</span>)<span>value</span>, <span>type</span>.<span>FixedLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L11984" data-line-number="11984"></td>
        <td id="LC11984">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11985" data-line-number="11985"></td>
        <td id="LC11985">                    }</td>
      </tr>
      <tr>
        <td id="L11986" data-line-number="11986"></td>
        <td id="LC11986">
</td>
      </tr>
      <tr>
        <td id="L11987" data-line-number="11987"></td>
        <td id="LC11987">                <span>case</span> <span>TdsEnums</span>.<span>SQLUDT</span>:</td>
      </tr>
      <tr>
        <td id="L11988" data-line-number="11988"></td>
        <td id="LC11988">                    <span>Debug</span>.<span>Assert</span>(<span>false</span>, <span><span>"</span>Called WriteSqlValue on UDT param.Should have already been handled<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L11989" data-line-number="11989"></td>
        <td id="LC11989">                    <span>throw</span> <span>SQL</span>.<span>UDTUnexpectedResult</span>(<span>value</span>.<span>GetType</span>().<span>AssemblyQualifiedName</span>);</td>
      </tr>
      <tr>
        <td id="L11990" data-line-number="11990"></td>
        <td id="LC11990">
</td>
      </tr>
      <tr>
        <td id="L11991" data-line-number="11991"></td>
        <td id="LC11991">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L11992" data-line-number="11992"></td>
        <td id="LC11992">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown TdsType!<span>"</span></span> <span>+</span> <span>type</span>.<span>NullableType</span>.<span>ToString</span>(<span><span>"</span>x2<span>"</span></span>, (<span>IFormatProvider</span>)<span>null</span>));</td>
      </tr>
      <tr>
        <td id="L11993" data-line-number="11993"></td>
        <td id="LC11993">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L11994" data-line-number="11994"></td>
        <td id="LC11994">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L11995" data-line-number="11995"></td>
        <td id="LC11995">            <span><span>//</span> return point for accumualated writes, note: non-accumulated writes returned from their case statements</span></td>
      </tr>
      <tr>
        <td id="L11996" data-line-number="11996"></td>
        <td id="LC11996">            <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L11997" data-line-number="11997"></td>
        <td id="LC11997">        }</td>
      </tr>
      <tr>
        <td id="L11998" data-line-number="11998"></td>
        <td id="LC11998">
</td>
      </tr>
      <tr>
        <td id="L11999" data-line-number="11999"></td>
        <td id="LC11999">        <span>private</span> <span>class</span> <span>TdsOutputStream</span> : <span>Stream</span></td>
      </tr>
      <tr>
        <td id="L12000" data-line-number="12000"></td>
        <td id="LC12000">        {</td>
      </tr>
      <tr>
        <td id="L12001" data-line-number="12001"></td>
        <td id="LC12001">            <span>TdsParser</span> <span>_parser</span>;</td>
      </tr>
      <tr>
        <td id="L12002" data-line-number="12002"></td>
        <td id="LC12002">            <span>TdsParserStateObject</span> <span>_stateObj</span>;</td>
      </tr>
      <tr>
        <td id="L12003" data-line-number="12003"></td>
        <td id="LC12003">            <span>byte</span>[] <span>_preambleToStrip</span>;</td>
      </tr>
      <tr>
        <td id="L12004" data-line-number="12004"></td>
        <td id="LC12004">
</td>
      </tr>
      <tr>
        <td id="L12005" data-line-number="12005"></td>
        <td id="LC12005">            <span>public</span> <span>TdsOutputStream</span>(<span>TdsParser</span> <span>parser</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>byte</span>[] <span>preambleToStrip</span>)</td>
      </tr>
      <tr>
        <td id="L12006" data-line-number="12006"></td>
        <td id="LC12006">            {</td>
      </tr>
      <tr>
        <td id="L12007" data-line-number="12007"></td>
        <td id="LC12007">                <span>_parser</span> <span>=</span> <span>parser</span>;</td>
      </tr>
      <tr>
        <td id="L12008" data-line-number="12008"></td>
        <td id="LC12008">                <span>_stateObj</span> <span>=</span> <span>stateObj</span>;</td>
      </tr>
      <tr>
        <td id="L12009" data-line-number="12009"></td>
        <td id="LC12009">                <span>_preambleToStrip</span> <span>=</span> <span>preambleToStrip</span>;</td>
      </tr>
      <tr>
        <td id="L12010" data-line-number="12010"></td>
        <td id="LC12010">            }</td>
      </tr>
      <tr>
        <td id="L12011" data-line-number="12011"></td>
        <td id="LC12011">
</td>
      </tr>
      <tr>
        <td id="L12012" data-line-number="12012"></td>
        <td id="LC12012">            <span>public</span> <span>override</span> <span>bool</span> <span>CanRead</span></td>
      </tr>
      <tr>
        <td id="L12013" data-line-number="12013"></td>
        <td id="LC12013">            {</td>
      </tr>
      <tr>
        <td id="L12014" data-line-number="12014"></td>
        <td id="LC12014">                <span>get</span> { <span>return</span> <span>false</span>; }</td>
      </tr>
      <tr>
        <td id="L12015" data-line-number="12015"></td>
        <td id="LC12015">            }</td>
      </tr>
      <tr>
        <td id="L12016" data-line-number="12016"></td>
        <td id="LC12016">
</td>
      </tr>
      <tr>
        <td id="L12017" data-line-number="12017"></td>
        <td id="LC12017">            <span>public</span> <span>override</span> <span>bool</span> <span>CanSeek</span></td>
      </tr>
      <tr>
        <td id="L12018" data-line-number="12018"></td>
        <td id="LC12018">            {</td>
      </tr>
      <tr>
        <td id="L12019" data-line-number="12019"></td>
        <td id="LC12019">                <span>get</span> { <span>return</span> <span>false</span>; }</td>
      </tr>
      <tr>
        <td id="L12020" data-line-number="12020"></td>
        <td id="LC12020">            }</td>
      </tr>
      <tr>
        <td id="L12021" data-line-number="12021"></td>
        <td id="LC12021">
</td>
      </tr>
      <tr>
        <td id="L12022" data-line-number="12022"></td>
        <td id="LC12022">            <span>public</span> <span>override</span> <span>bool</span> <span>CanWrite</span></td>
      </tr>
      <tr>
        <td id="L12023" data-line-number="12023"></td>
        <td id="LC12023">            {</td>
      </tr>
      <tr>
        <td id="L12024" data-line-number="12024"></td>
        <td id="LC12024">                <span>get</span> { <span>return</span> <span>true</span>; }</td>
      </tr>
      <tr>
        <td id="L12025" data-line-number="12025"></td>
        <td id="LC12025">            }</td>
      </tr>
      <tr>
        <td id="L12026" data-line-number="12026"></td>
        <td id="LC12026">
</td>
      </tr>
      <tr>
        <td id="L12027" data-line-number="12027"></td>
        <td id="LC12027">            <span>public</span> <span>override</span> <span>void</span> <span>Flush</span>()</td>
      </tr>
      <tr>
        <td id="L12028" data-line-number="12028"></td>
        <td id="LC12028">            {</td>
      </tr>
      <tr>
        <td id="L12029" data-line-number="12029"></td>
        <td id="LC12029">                <span><span>//</span> NOOP</span></td>
      </tr>
      <tr>
        <td id="L12030" data-line-number="12030"></td>
        <td id="LC12030">            }</td>
      </tr>
      <tr>
        <td id="L12031" data-line-number="12031"></td>
        <td id="LC12031">
</td>
      </tr>
      <tr>
        <td id="L12032" data-line-number="12032"></td>
        <td id="LC12032">            <span>public</span> <span>override</span> <span>long</span> <span>Length</span></td>
      </tr>
      <tr>
        <td id="L12033" data-line-number="12033"></td>
        <td id="LC12033">            {</td>
      </tr>
      <tr>
        <td id="L12034" data-line-number="12034"></td>
        <td id="LC12034">                <span>get</span> { <span>throw</span> <span>new</span> <span>NotSupportedException</span>(); }</td>
      </tr>
      <tr>
        <td id="L12035" data-line-number="12035"></td>
        <td id="LC12035">            }</td>
      </tr>
      <tr>
        <td id="L12036" data-line-number="12036"></td>
        <td id="LC12036">
</td>
      </tr>
      <tr>
        <td id="L12037" data-line-number="12037"></td>
        <td id="LC12037">            <span>public</span> <span>override</span> <span>long</span> <span>Position</span></td>
      </tr>
      <tr>
        <td id="L12038" data-line-number="12038"></td>
        <td id="LC12038">            {</td>
      </tr>
      <tr>
        <td id="L12039" data-line-number="12039"></td>
        <td id="LC12039">                <span>get</span></td>
      </tr>
      <tr>
        <td id="L12040" data-line-number="12040"></td>
        <td id="LC12040">                {</td>
      </tr>
      <tr>
        <td id="L12041" data-line-number="12041"></td>
        <td id="LC12041">                    <span>throw</span> <span>new</span> <span>NotSupportedException</span>();</td>
      </tr>
      <tr>
        <td id="L12042" data-line-number="12042"></td>
        <td id="LC12042">                }</td>
      </tr>
      <tr>
        <td id="L12043" data-line-number="12043"></td>
        <td id="LC12043">                <span>set</span></td>
      </tr>
      <tr>
        <td id="L12044" data-line-number="12044"></td>
        <td id="LC12044">                {</td>
      </tr>
      <tr>
        <td id="L12045" data-line-number="12045"></td>
        <td id="LC12045">                    <span>throw</span> <span>new</span> <span>NotSupportedException</span>();</td>
      </tr>
      <tr>
        <td id="L12046" data-line-number="12046"></td>
        <td id="LC12046">                }</td>
      </tr>
      <tr>
        <td id="L12047" data-line-number="12047"></td>
        <td id="LC12047">            }</td>
      </tr>
      <tr>
        <td id="L12048" data-line-number="12048"></td>
        <td id="LC12048">
</td>
      </tr>
      <tr>
        <td id="L12049" data-line-number="12049"></td>
        <td id="LC12049">            <span>public</span> <span>override</span> <span>int</span> <span>Read</span>(<span>byte</span>[] <span>buffer</span>, <span>int</span> <span>offset</span>, <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L12050" data-line-number="12050"></td>
        <td id="LC12050">            {</td>
      </tr>
      <tr>
        <td id="L12051" data-line-number="12051"></td>
        <td id="LC12051">                <span>throw</span> <span>new</span> <span>NotSupportedException</span>();</td>
      </tr>
      <tr>
        <td id="L12052" data-line-number="12052"></td>
        <td id="LC12052">            }</td>
      </tr>
      <tr>
        <td id="L12053" data-line-number="12053"></td>
        <td id="LC12053">
</td>
      </tr>
      <tr>
        <td id="L12054" data-line-number="12054"></td>
        <td id="LC12054">            <span>public</span> <span>override</span> <span>long</span> <span>Seek</span>(<span>long</span> <span>offset</span>, <span>SeekOrigin</span> <span>origin</span>)</td>
      </tr>
      <tr>
        <td id="L12055" data-line-number="12055"></td>
        <td id="LC12055">            {</td>
      </tr>
      <tr>
        <td id="L12056" data-line-number="12056"></td>
        <td id="LC12056">                <span>throw</span> <span>new</span> <span>NotSupportedException</span>();</td>
      </tr>
      <tr>
        <td id="L12057" data-line-number="12057"></td>
        <td id="LC12057">            }</td>
      </tr>
      <tr>
        <td id="L12058" data-line-number="12058"></td>
        <td id="LC12058">
</td>
      </tr>
      <tr>
        <td id="L12059" data-line-number="12059"></td>
        <td id="LC12059">            <span>public</span> <span>override</span> <span>void</span> <span>SetLength</span>(<span>long</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L12060" data-line-number="12060"></td>
        <td id="LC12060">            {</td>
      </tr>
      <tr>
        <td id="L12061" data-line-number="12061"></td>
        <td id="LC12061">                <span>throw</span> <span>new</span> <span>NotSupportedException</span>();</td>
      </tr>
      <tr>
        <td id="L12062" data-line-number="12062"></td>
        <td id="LC12062">            }</td>
      </tr>
      <tr>
        <td id="L12063" data-line-number="12063"></td>
        <td id="LC12063">
</td>
      </tr>
      <tr>
        <td id="L12064" data-line-number="12064"></td>
        <td id="LC12064">            <span>private</span> <span>void</span> <span>StripPreamble</span>(<span>byte</span>[] <span>buffer</span>, <span>ref</span> <span>int</span> <span>offset</span>, <span>ref</span> <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L12065" data-line-number="12065"></td>
        <td id="LC12065">            {</td>
      </tr>
      <tr>
        <td id="L12066" data-line-number="12066"></td>
        <td id="LC12066">                <span>if</span> (<span>_preambleToStrip</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> <span>count</span> <span>&gt;=</span> <span>_preambleToStrip</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L12067" data-line-number="12067"></td>
        <td id="LC12067">                {</td>
      </tr>
      <tr>
        <td id="L12068" data-line-number="12068"></td>
        <td id="LC12068">
</td>
      </tr>
      <tr>
        <td id="L12069" data-line-number="12069"></td>
        <td id="LC12069">                    <span>for</span> (<span>int</span> <span>idx</span> <span>=</span> <span>0</span>; <span>idx</span> <span>&lt;</span> <span>_preambleToStrip</span>.<span>Length</span>; <span>idx</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L12070" data-line-number="12070"></td>
        <td id="LC12070">                    {</td>
      </tr>
      <tr>
        <td id="L12071" data-line-number="12071"></td>
        <td id="LC12071">                        <span>if</span> (<span>_preambleToStrip</span>[<span>idx</span>] <span>!=</span> <span>buffer</span>[<span>idx</span>])</td>
      </tr>
      <tr>
        <td id="L12072" data-line-number="12072"></td>
        <td id="LC12072">                        {</td>
      </tr>
      <tr>
        <td id="L12073" data-line-number="12073"></td>
        <td id="LC12073">                            <span>_preambleToStrip</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12074" data-line-number="12074"></td>
        <td id="LC12074">                            <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L12075" data-line-number="12075"></td>
        <td id="LC12075">                        }</td>
      </tr>
      <tr>
        <td id="L12076" data-line-number="12076"></td>
        <td id="LC12076">                    }</td>
      </tr>
      <tr>
        <td id="L12077" data-line-number="12077"></td>
        <td id="LC12077">
</td>
      </tr>
      <tr>
        <td id="L12078" data-line-number="12078"></td>
        <td id="LC12078">                    <span>offset</span> <span>+=</span> <span>_preambleToStrip</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L12079" data-line-number="12079"></td>
        <td id="LC12079">                    <span>count</span> <span>-=</span> <span>_preambleToStrip</span>.<span>Length</span>;</td>
      </tr>
      <tr>
        <td id="L12080" data-line-number="12080"></td>
        <td id="LC12080">                }</td>
      </tr>
      <tr>
        <td id="L12081" data-line-number="12081"></td>
        <td id="LC12081">                <span>_preambleToStrip</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12082" data-line-number="12082"></td>
        <td id="LC12082">            }</td>
      </tr>
      <tr>
        <td id="L12083" data-line-number="12083"></td>
        <td id="LC12083">
</td>
      </tr>
      <tr>
        <td id="L12084" data-line-number="12084"></td>
        <td id="LC12084">            <span>public</span> <span>override</span> <span>void</span> <span>Write</span>(<span>byte</span>[] <span>buffer</span>, <span>int</span> <span>offset</span>, <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L12085" data-line-number="12085"></td>
        <td id="LC12085">            {</td>
      </tr>
      <tr>
        <td id="L12086" data-line-number="12086"></td>
        <td id="LC12086">                <span>Debug</span>.<span>Assert</span>(<span>!</span><span>_parser</span>.<span>_asyncWrite</span>);</td>
      </tr>
      <tr>
        <td id="L12087" data-line-number="12087"></td>
        <td id="LC12087">                <span>ValidateWriteParameters</span>(<span>buffer</span>, <span>offset</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12088" data-line-number="12088"></td>
        <td id="LC12088">
</td>
      </tr>
      <tr>
        <td id="L12089" data-line-number="12089"></td>
        <td id="LC12089">                <span>StripPreamble</span>(<span>buffer</span>, <span>ref</span> <span>offset</span>, <span>ref</span> <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12090" data-line-number="12090"></td>
        <td id="LC12090">
</td>
      </tr>
      <tr>
        <td id="L12091" data-line-number="12091"></td>
        <td id="LC12091">                <span>if</span> (<span>count</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12092" data-line-number="12092"></td>
        <td id="LC12092">                {</td>
      </tr>
      <tr>
        <td id="L12093" data-line-number="12093"></td>
        <td id="LC12093">                    <span>_parser</span>.<span>WriteInt</span>(<span>count</span>, <span>_stateObj</span>); <span><span>//</span> write length of chunk</span></td>
      </tr>
      <tr>
        <td id="L12094" data-line-number="12094"></td>
        <td id="LC12094">                    <span>_stateObj</span>.<span>WriteByteArray</span>(<span>buffer</span>, <span>count</span>, <span>offset</span>);</td>
      </tr>
      <tr>
        <td id="L12095" data-line-number="12095"></td>
        <td id="LC12095">                }</td>
      </tr>
      <tr>
        <td id="L12096" data-line-number="12096"></td>
        <td id="LC12096">            }</td>
      </tr>
      <tr>
        <td id="L12097" data-line-number="12097"></td>
        <td id="LC12097">
</td>
      </tr>
      <tr>
        <td id="L12098" data-line-number="12098"></td>
        <td id="LC12098">            <span>public</span> <span>override</span> <span>Task</span> <span>WriteAsync</span>(<span>byte</span>[] <span>buffer</span>, <span>int</span> <span>offset</span>, <span>int</span> <span>count</span>, <span>CancellationToken</span> <span>cancellationToken</span>)</td>
      </tr>
      <tr>
        <td id="L12099" data-line-number="12099"></td>
        <td id="LC12099">            {</td>
      </tr>
      <tr>
        <td id="L12100" data-line-number="12100"></td>
        <td id="LC12100">                <span>Debug</span>.<span>Assert</span>(<span>_parser</span>.<span>_asyncWrite</span>);</td>
      </tr>
      <tr>
        <td id="L12101" data-line-number="12101"></td>
        <td id="LC12101">                <span>ValidateWriteParameters</span>(<span>buffer</span>, <span>offset</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12102" data-line-number="12102"></td>
        <td id="LC12102">
</td>
      </tr>
      <tr>
        <td id="L12103" data-line-number="12103"></td>
        <td id="LC12103">                <span>StripPreamble</span>(<span>buffer</span>, <span>ref</span> <span>offset</span>, <span>ref</span> <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12104" data-line-number="12104"></td>
        <td id="LC12104">
</td>
      </tr>
      <tr>
        <td id="L12105" data-line-number="12105"></td>
        <td id="LC12105">                <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L12106" data-line-number="12106"></td>
        <td id="LC12106">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L12107" data-line-number="12107"></td>
        <td id="LC12107">                {</td>
      </tr>
      <tr>
        <td id="L12108" data-line-number="12108"></td>
        <td id="LC12108">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L12109" data-line-number="12109"></td>
        <td id="LC12109">                    <span>TdsParser</span>.<span>ReliabilitySection</span> <span>tdsReliabilitySection</span> <span>=</span> <span>new</span> <span>TdsParser</span>.<span>ReliabilitySection</span>();</td>
      </tr>
      <tr>
        <td id="L12110" data-line-number="12110"></td>
        <td id="LC12110">
</td>
      </tr>
      <tr>
        <td id="L12111" data-line-number="12111"></td>
        <td id="LC12111">                    <span>RuntimeHelpers</span>.<span>PrepareConstrainedRegions</span>();</td>
      </tr>
      <tr>
        <td id="L12112" data-line-number="12112"></td>
        <td id="LC12112">                    <span>try</span></td>
      </tr>
      <tr>
        <td id="L12113" data-line-number="12113"></td>
        <td id="LC12113">                    {</td>
      </tr>
      <tr>
        <td id="L12114" data-line-number="12114"></td>
        <td id="LC12114">                        <span>tdsReliabilitySection</span>.<span>Start</span>();</td>
      </tr>
      <tr>
        <td id="L12115" data-line-number="12115"></td>
        <td id="LC12115">#<span>else</span></td>
      </tr>
      <tr>
        <td id="L12116" data-line-number="12116"></td>
        <td id="LC12116">                    {</td>
      </tr>
      <tr>
        <td id="L12117" data-line-number="12117"></td>
        <td id="LC12117">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L12118" data-line-number="12118"></td>
        <td id="LC12118">                        <span>Task</span> <span>task</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12119" data-line-number="12119"></td>
        <td id="LC12119">                        <span>if</span> (<span>count</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12120" data-line-number="12120"></td>
        <td id="LC12120">                        {</td>
      </tr>
      <tr>
        <td id="L12121" data-line-number="12121"></td>
        <td id="LC12121">                            <span>_parser</span>.<span>WriteInt</span>(<span>count</span>, <span>_stateObj</span>); <span><span>//</span> write length of chunk</span></td>
      </tr>
      <tr>
        <td id="L12122" data-line-number="12122"></td>
        <td id="LC12122">                            <span>task</span> <span>=</span> <span>_stateObj</span>.<span>WriteByteArray</span>(<span>buffer</span>, <span>count</span>, <span>offset</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12123" data-line-number="12123"></td>
        <td id="LC12123">                        }</td>
      </tr>
      <tr>
        <td id="L12124" data-line-number="12124"></td>
        <td id="LC12124">                        <span>if</span> (<span>task</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L12125" data-line-number="12125"></td>
        <td id="LC12125">                        {</td>
      </tr>
      <tr>
        <td id="L12126" data-line-number="12126"></td>
        <td id="LC12126">                            <span>return</span> <span>CompletedTask</span>;</td>
      </tr>
      <tr>
        <td id="L12127" data-line-number="12127"></td>
        <td id="LC12127">                        }</td>
      </tr>
      <tr>
        <td id="L12128" data-line-number="12128"></td>
        <td id="LC12128">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12129" data-line-number="12129"></td>
        <td id="LC12129">                        {</td>
      </tr>
      <tr>
        <td id="L12130" data-line-number="12130"></td>
        <td id="LC12130">                            <span>return</span> <span>task</span>;</td>
      </tr>
      <tr>
        <td id="L12131" data-line-number="12131"></td>
        <td id="LC12131">                        }</td>
      </tr>
      <tr>
        <td id="L12132" data-line-number="12132"></td>
        <td id="LC12132">                    }</td>
      </tr>
      <tr>
        <td id="L12133" data-line-number="12133"></td>
        <td id="LC12133">#<span>if</span> <span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L12134" data-line-number="12134"></td>
        <td id="LC12134">                    <span>finally</span></td>
      </tr>
      <tr>
        <td id="L12135" data-line-number="12135"></td>
        <td id="LC12135">                    {</td>
      </tr>
      <tr>
        <td id="L12136" data-line-number="12136"></td>
        <td id="LC12136">                        <span>tdsReliabilitySection</span>.<span>Stop</span>();</td>
      </tr>
      <tr>
        <td id="L12137" data-line-number="12137"></td>
        <td id="LC12137">                    }</td>
      </tr>
      <tr>
        <td id="L12138" data-line-number="12138"></td>
        <td id="LC12138">#<span>endif</span> <span><span>//</span>DEBUG</span></td>
      </tr>
      <tr>
        <td id="L12139" data-line-number="12139"></td>
        <td id="LC12139">                }</td>
      </tr>
      <tr>
        <td id="L12140" data-line-number="12140"></td>
        <td id="LC12140">                <span>catch</span> (<span>System</span>.<span>OutOfMemoryException</span>)</td>
      </tr>
      <tr>
        <td id="L12141" data-line-number="12141"></td>
        <td id="LC12141">                {</td>
      </tr>
      <tr>
        <td id="L12142" data-line-number="12142"></td>
        <td id="LC12142">                    <span>_parser</span>.<span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L12143" data-line-number="12143"></td>
        <td id="LC12143">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L12144" data-line-number="12144"></td>
        <td id="LC12144">                }</td>
      </tr>
      <tr>
        <td id="L12145" data-line-number="12145"></td>
        <td id="LC12145">                <span>catch</span> (<span>System</span>.<span>StackOverflowException</span>)</td>
      </tr>
      <tr>
        <td id="L12146" data-line-number="12146"></td>
        <td id="LC12146">                {</td>
      </tr>
      <tr>
        <td id="L12147" data-line-number="12147"></td>
        <td id="LC12147">                    <span>_parser</span>.<span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L12148" data-line-number="12148"></td>
        <td id="LC12148">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L12149" data-line-number="12149"></td>
        <td id="LC12149">                }</td>
      </tr>
      <tr>
        <td id="L12150" data-line-number="12150"></td>
        <td id="LC12150">                <span>catch</span> (<span>System</span>.<span>Threading</span>.<span>ThreadAbortException</span>)</td>
      </tr>
      <tr>
        <td id="L12151" data-line-number="12151"></td>
        <td id="LC12151">                {</td>
      </tr>
      <tr>
        <td id="L12152" data-line-number="12152"></td>
        <td id="LC12152">                    <span>_parser</span>.<span>_connHandler</span>.<span>DoomThisConnection</span>();</td>
      </tr>
      <tr>
        <td id="L12153" data-line-number="12153"></td>
        <td id="LC12153">                    <span>throw</span>;</td>
      </tr>
      <tr>
        <td id="L12154" data-line-number="12154"></td>
        <td id="LC12154">                }</td>
      </tr>
      <tr>
        <td id="L12155" data-line-number="12155"></td>
        <td id="LC12155">            }</td>
      </tr>
      <tr>
        <td id="L12156" data-line-number="12156"></td>
        <td id="LC12156">
</td>
      </tr>
      <tr>
        <td id="L12157" data-line-number="12157"></td>
        <td id="LC12157">            <span>internal</span> <span>static</span> <span>void</span> <span>ValidateWriteParameters</span>(<span>byte</span>[] <span>buffer</span>, <span>int</span> <span>offset</span>, <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L12158" data-line-number="12158"></td>
        <td id="LC12158">            {</td>
      </tr>
      <tr>
        <td id="L12159" data-line-number="12159"></td>
        <td id="LC12159">                <span>if</span> (<span>buffer</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L12160" data-line-number="12160"></td>
        <td id="LC12160">                {</td>
      </tr>
      <tr>
        <td id="L12161" data-line-number="12161"></td>
        <td id="LC12161">                    <span>throw</span> <span>ADP</span>.<span>ArgumentNull</span>(<span>ADP</span>.<span>ParameterBuffer</span>);</td>
      </tr>
      <tr>
        <td id="L12162" data-line-number="12162"></td>
        <td id="LC12162">                }</td>
      </tr>
      <tr>
        <td id="L12163" data-line-number="12163"></td>
        <td id="LC12163">                <span>if</span> (<span>offset</span> <span>&lt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12164" data-line-number="12164"></td>
        <td id="LC12164">                {</td>
      </tr>
      <tr>
        <td id="L12165" data-line-number="12165"></td>
        <td id="LC12165">                    <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span>ADP</span>.<span>ParameterOffset</span>);</td>
      </tr>
      <tr>
        <td id="L12166" data-line-number="12166"></td>
        <td id="LC12166">                }</td>
      </tr>
      <tr>
        <td id="L12167" data-line-number="12167"></td>
        <td id="LC12167">                <span>if</span> (<span>count</span> <span>&lt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12168" data-line-number="12168"></td>
        <td id="LC12168">                {</td>
      </tr>
      <tr>
        <td id="L12169" data-line-number="12169"></td>
        <td id="LC12169">                    <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span>ADP</span>.<span>ParameterCount</span>);</td>
      </tr>
      <tr>
        <td id="L12170" data-line-number="12170"></td>
        <td id="LC12170">                }</td>
      </tr>
      <tr>
        <td id="L12171" data-line-number="12171"></td>
        <td id="LC12171">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L12172" data-line-number="12172"></td>
        <td id="LC12172">                {</td>
      </tr>
      <tr>
        <td id="L12173" data-line-number="12173"></td>
        <td id="LC12173">                    <span>if</span> (<span>checked</span>(<span>offset</span> <span>+</span> <span>count</span>) <span>&gt;</span> <span>buffer</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L12174" data-line-number="12174"></td>
        <td id="LC12174">                    {</td>
      </tr>
      <tr>
        <td id="L12175" data-line-number="12175"></td>
        <td id="LC12175">                        <span>throw</span> <span>ExceptionBuilder</span>.<span>InvalidOffsetLength</span>();</td>
      </tr>
      <tr>
        <td id="L12176" data-line-number="12176"></td>
        <td id="LC12176">                    }</td>
      </tr>
      <tr>
        <td id="L12177" data-line-number="12177"></td>
        <td id="LC12177">                }</td>
      </tr>
      <tr>
        <td id="L12178" data-line-number="12178"></td>
        <td id="LC12178">                <span>catch</span> (<span>OverflowException</span>)</td>
      </tr>
      <tr>
        <td id="L12179" data-line-number="12179"></td>
        <td id="LC12179">                {</td>
      </tr>
      <tr>
        <td id="L12180" data-line-number="12180"></td>
        <td id="LC12180">                    <span><span>//</span> If we've overflowed when adding offset and count, then they never would have fit into buffer anyway</span></td>
      </tr>
      <tr>
        <td id="L12181" data-line-number="12181"></td>
        <td id="LC12181">                    <span>throw</span> <span>ExceptionBuilder</span>.<span>InvalidOffsetLength</span>();</td>
      </tr>
      <tr>
        <td id="L12182" data-line-number="12182"></td>
        <td id="LC12182">                }</td>
      </tr>
      <tr>
        <td id="L12183" data-line-number="12183"></td>
        <td id="LC12183">            }</td>
      </tr>
      <tr>
        <td id="L12184" data-line-number="12184"></td>
        <td id="LC12184">
</td>
      </tr>
      <tr>
        <td id="L12185" data-line-number="12185"></td>
        <td id="LC12185">        }</td>
      </tr>
      <tr>
        <td id="L12186" data-line-number="12186"></td>
        <td id="LC12186">
</td>
      </tr>
      <tr>
        <td id="L12187" data-line-number="12187"></td>
        <td id="LC12187">        <span>private</span> <span>class</span> <span>ConstrainedTextWriter</span> : <span>TextWriter</span></td>
      </tr>
      <tr>
        <td id="L12188" data-line-number="12188"></td>
        <td id="LC12188">        {</td>
      </tr>
      <tr>
        <td id="L12189" data-line-number="12189"></td>
        <td id="LC12189">            <span>TextWriter</span> <span>_next</span>;</td>
      </tr>
      <tr>
        <td id="L12190" data-line-number="12190"></td>
        <td id="LC12190">            <span>int</span> <span>_size</span>;</td>
      </tr>
      <tr>
        <td id="L12191" data-line-number="12191"></td>
        <td id="LC12191">            <span>int</span> <span>_written</span>;</td>
      </tr>
      <tr>
        <td id="L12192" data-line-number="12192"></td>
        <td id="LC12192">
</td>
      </tr>
      <tr>
        <td id="L12193" data-line-number="12193"></td>
        <td id="LC12193">            <span>public</span> <span>ConstrainedTextWriter</span>(<span>TextWriter</span> <span>next</span>, <span>int</span> <span>size</span>)</td>
      </tr>
      <tr>
        <td id="L12194" data-line-number="12194"></td>
        <td id="LC12194">            {</td>
      </tr>
      <tr>
        <td id="L12195" data-line-number="12195"></td>
        <td id="LC12195">                <span>_next</span> <span>=</span> <span>next</span>;</td>
      </tr>
      <tr>
        <td id="L12196" data-line-number="12196"></td>
        <td id="LC12196">                <span>_size</span> <span>=</span> <span>size</span>;</td>
      </tr>
      <tr>
        <td id="L12197" data-line-number="12197"></td>
        <td id="LC12197">                <span>_written</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L12198" data-line-number="12198"></td>
        <td id="LC12198">
</td>
      </tr>
      <tr>
        <td id="L12199" data-line-number="12199"></td>
        <td id="LC12199">                <span>if</span> (<span>_size</span> <span>&lt;</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L12200" data-line-number="12200"></td>
        <td id="LC12200">                {</td>
      </tr>
      <tr>
        <td id="L12201" data-line-number="12201"></td>
        <td id="LC12201">                    <span>_size</span> <span>=</span> <span>int</span>.<span>MaxValue</span>;</td>
      </tr>
      <tr>
        <td id="L12202" data-line-number="12202"></td>
        <td id="LC12202">                }</td>
      </tr>
      <tr>
        <td id="L12203" data-line-number="12203"></td>
        <td id="LC12203">            }</td>
      </tr>
      <tr>
        <td id="L12204" data-line-number="12204"></td>
        <td id="LC12204">
</td>
      </tr>
      <tr>
        <td id="L12205" data-line-number="12205"></td>
        <td id="LC12205">            <span>public</span> <span>bool</span> <span>IsComplete</span></td>
      </tr>
      <tr>
        <td id="L12206" data-line-number="12206"></td>
        <td id="LC12206">            {</td>
      </tr>
      <tr>
        <td id="L12207" data-line-number="12207"></td>
        <td id="LC12207">                <span>get</span></td>
      </tr>
      <tr>
        <td id="L12208" data-line-number="12208"></td>
        <td id="LC12208">                {</td>
      </tr>
      <tr>
        <td id="L12209" data-line-number="12209"></td>
        <td id="LC12209">                    <span>return</span> <span>_size</span> <span>&gt;</span> <span>0</span> <span>&amp;&amp;</span> <span>_written</span> <span>&gt;=</span> <span>_size</span>;</td>
      </tr>
      <tr>
        <td id="L12210" data-line-number="12210"></td>
        <td id="LC12210">                }</td>
      </tr>
      <tr>
        <td id="L12211" data-line-number="12211"></td>
        <td id="LC12211">            }</td>
      </tr>
      <tr>
        <td id="L12212" data-line-number="12212"></td>
        <td id="LC12212">
</td>
      </tr>
      <tr>
        <td id="L12213" data-line-number="12213"></td>
        <td id="LC12213">            <span>public</span> <span>override</span> <span>Encoding</span> <span>Encoding</span></td>
      </tr>
      <tr>
        <td id="L12214" data-line-number="12214"></td>
        <td id="LC12214">            {</td>
      </tr>
      <tr>
        <td id="L12215" data-line-number="12215"></td>
        <td id="LC12215">                <span>get</span> { <span>return</span> <span>_next</span>.<span>Encoding</span>; }</td>
      </tr>
      <tr>
        <td id="L12216" data-line-number="12216"></td>
        <td id="LC12216">            }</td>
      </tr>
      <tr>
        <td id="L12217" data-line-number="12217"></td>
        <td id="LC12217">
</td>
      </tr>
      <tr>
        <td id="L12218" data-line-number="12218"></td>
        <td id="LC12218">            <span>public</span> <span>override</span> <span>void</span> <span>Flush</span>()</td>
      </tr>
      <tr>
        <td id="L12219" data-line-number="12219"></td>
        <td id="LC12219">            {</td>
      </tr>
      <tr>
        <td id="L12220" data-line-number="12220"></td>
        <td id="LC12220">                <span>_next</span>.<span>Flush</span>();</td>
      </tr>
      <tr>
        <td id="L12221" data-line-number="12221"></td>
        <td id="LC12221">            }</td>
      </tr>
      <tr>
        <td id="L12222" data-line-number="12222"></td>
        <td id="LC12222">
</td>
      </tr>
      <tr>
        <td id="L12223" data-line-number="12223"></td>
        <td id="LC12223">            <span>public</span> <span>override</span> <span>Task</span> <span>FlushAsync</span>()</td>
      </tr>
      <tr>
        <td id="L12224" data-line-number="12224"></td>
        <td id="LC12224">            {</td>
      </tr>
      <tr>
        <td id="L12225" data-line-number="12225"></td>
        <td id="LC12225">                <span>return</span> <span>_next</span>.<span>FlushAsync</span>();</td>
      </tr>
      <tr>
        <td id="L12226" data-line-number="12226"></td>
        <td id="LC12226">            }</td>
      </tr>
      <tr>
        <td id="L12227" data-line-number="12227"></td>
        <td id="LC12227">
</td>
      </tr>
      <tr>
        <td id="L12228" data-line-number="12228"></td>
        <td id="LC12228">            <span>public</span> <span>override</span> <span>void</span> <span>Write</span>(<span>char</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L12229" data-line-number="12229"></td>
        <td id="LC12229">            {</td>
      </tr>
      <tr>
        <td id="L12230" data-line-number="12230"></td>
        <td id="LC12230">                <span>if</span> (<span>_written</span> <span>&lt;</span> <span>_size</span>)</td>
      </tr>
      <tr>
        <td id="L12231" data-line-number="12231"></td>
        <td id="LC12231">                {</td>
      </tr>
      <tr>
        <td id="L12232" data-line-number="12232"></td>
        <td id="LC12232">                    <span>_next</span>.<span>Write</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L12233" data-line-number="12233"></td>
        <td id="LC12233">                    <span>_written</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L12234" data-line-number="12234"></td>
        <td id="LC12234">                }</td>
      </tr>
      <tr>
        <td id="L12235" data-line-number="12235"></td>
        <td id="LC12235">                <span>Debug</span>.<span>Assert</span>(<span>_size</span> <span>&lt;</span> <span>0</span> <span>||</span> <span>_written</span> <span>&lt;=</span> <span>_size</span>, <span><span>$"</span>Length of data written exceeds specified length.  Written: {<span>_written</span>}, specified: {<span>_size</span>}<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12236" data-line-number="12236"></td>
        <td id="LC12236">            }</td>
      </tr>
      <tr>
        <td id="L12237" data-line-number="12237"></td>
        <td id="LC12237">
</td>
      </tr>
      <tr>
        <td id="L12238" data-line-number="12238"></td>
        <td id="LC12238">            <span>public</span> <span>override</span> <span>void</span> <span>Write</span>(<span>char</span>[] <span>buffer</span>, <span>int</span> <span>index</span>, <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L12239" data-line-number="12239"></td>
        <td id="LC12239">            {</td>
      </tr>
      <tr>
        <td id="L12240" data-line-number="12240"></td>
        <td id="LC12240">
</td>
      </tr>
      <tr>
        <td id="L12241" data-line-number="12241"></td>
        <td id="LC12241">                <span>ValidateWriteParameters</span>(<span>buffer</span>, <span>index</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12242" data-line-number="12242"></td>
        <td id="LC12242">
</td>
      </tr>
      <tr>
        <td id="L12243" data-line-number="12243"></td>
        <td id="LC12243">                <span>Debug</span>.<span>Assert</span>(<span>_size</span> <span>&gt;=</span> <span>_written</span>);</td>
      </tr>
      <tr>
        <td id="L12244" data-line-number="12244"></td>
        <td id="LC12244">                <span>count</span> <span>=</span> <span>Math</span>.<span>Min</span>(<span>_size</span> <span>-</span> <span>_written</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12245" data-line-number="12245"></td>
        <td id="LC12245">                <span>if</span> (<span>count</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12246" data-line-number="12246"></td>
        <td id="LC12246">                {</td>
      </tr>
      <tr>
        <td id="L12247" data-line-number="12247"></td>
        <td id="LC12247">                    <span>_next</span>.<span>Write</span>(<span>buffer</span>, <span>index</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12248" data-line-number="12248"></td>
        <td id="LC12248">                }</td>
      </tr>
      <tr>
        <td id="L12249" data-line-number="12249"></td>
        <td id="LC12249">                <span>_written</span> <span>+=</span> <span>count</span>;</td>
      </tr>
      <tr>
        <td id="L12250" data-line-number="12250"></td>
        <td id="LC12250">            }</td>
      </tr>
      <tr>
        <td id="L12251" data-line-number="12251"></td>
        <td id="LC12251">
</td>
      </tr>
      <tr>
        <td id="L12252" data-line-number="12252"></td>
        <td id="LC12252">            <span>public</span> <span>override</span> <span>Task</span> <span>WriteAsync</span>(<span>char</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L12253" data-line-number="12253"></td>
        <td id="LC12253">            {</td>
      </tr>
      <tr>
        <td id="L12254" data-line-number="12254"></td>
        <td id="LC12254">
</td>
      </tr>
      <tr>
        <td id="L12255" data-line-number="12255"></td>
        <td id="LC12255">                <span>if</span> (<span>_written</span> <span>&lt;</span> <span>_size</span>)</td>
      </tr>
      <tr>
        <td id="L12256" data-line-number="12256"></td>
        <td id="LC12256">                {</td>
      </tr>
      <tr>
        <td id="L12257" data-line-number="12257"></td>
        <td id="LC12257">                    <span>_written</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L12258" data-line-number="12258"></td>
        <td id="LC12258">                    <span>return</span> <span>_next</span>.<span>WriteAsync</span>(<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L12259" data-line-number="12259"></td>
        <td id="LC12259">                }</td>
      </tr>
      <tr>
        <td id="L12260" data-line-number="12260"></td>
        <td id="LC12260">
</td>
      </tr>
      <tr>
        <td id="L12261" data-line-number="12261"></td>
        <td id="LC12261">                <span>return</span> <span>CompletedTask</span>;</td>
      </tr>
      <tr>
        <td id="L12262" data-line-number="12262"></td>
        <td id="LC12262">            }</td>
      </tr>
      <tr>
        <td id="L12263" data-line-number="12263"></td>
        <td id="LC12263">
</td>
      </tr>
      <tr>
        <td id="L12264" data-line-number="12264"></td>
        <td id="LC12264">            <span>public</span> <span>override</span> <span>Task</span> <span>WriteAsync</span>(<span>char</span>[] <span>buffer</span>, <span>int</span> <span>index</span>, <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L12265" data-line-number="12265"></td>
        <td id="LC12265">            {</td>
      </tr>
      <tr>
        <td id="L12266" data-line-number="12266"></td>
        <td id="LC12266">
</td>
      </tr>
      <tr>
        <td id="L12267" data-line-number="12267"></td>
        <td id="LC12267">                <span>ValidateWriteParameters</span>(<span>buffer</span>, <span>index</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12268" data-line-number="12268"></td>
        <td id="LC12268">
</td>
      </tr>
      <tr>
        <td id="L12269" data-line-number="12269"></td>
        <td id="LC12269">                <span>Debug</span>.<span>Assert</span>(<span>_size</span> <span>&gt;=</span> <span>_written</span>);</td>
      </tr>
      <tr>
        <td id="L12270" data-line-number="12270"></td>
        <td id="LC12270">                <span>count</span> <span>=</span> <span>Math</span>.<span>Min</span>(<span>_size</span> <span>-</span> <span>_written</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12271" data-line-number="12271"></td>
        <td id="LC12271">                <span>if</span> (<span>count</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12272" data-line-number="12272"></td>
        <td id="LC12272">                {</td>
      </tr>
      <tr>
        <td id="L12273" data-line-number="12273"></td>
        <td id="LC12273">                    <span>_written</span> <span>+=</span> <span>count</span>;</td>
      </tr>
      <tr>
        <td id="L12274" data-line-number="12274"></td>
        <td id="LC12274">                    <span>return</span> <span>_next</span>.<span>WriteAsync</span>(<span>buffer</span>, <span>index</span>, <span>count</span>);</td>
      </tr>
      <tr>
        <td id="L12275" data-line-number="12275"></td>
        <td id="LC12275">                }</td>
      </tr>
      <tr>
        <td id="L12276" data-line-number="12276"></td>
        <td id="LC12276">
</td>
      </tr>
      <tr>
        <td id="L12277" data-line-number="12277"></td>
        <td id="LC12277">                <span>return</span> <span>CompletedTask</span>;</td>
      </tr>
      <tr>
        <td id="L12278" data-line-number="12278"></td>
        <td id="LC12278">            }</td>
      </tr>
      <tr>
        <td id="L12279" data-line-number="12279"></td>
        <td id="LC12279">
</td>
      </tr>
      <tr>
        <td id="L12280" data-line-number="12280"></td>
        <td id="LC12280">            <span>public</span> <span>override</span> <span>Task</span> <span>WriteAsync</span>(<span>string</span> <span>value</span>)</td>
      </tr>
      <tr>
        <td id="L12281" data-line-number="12281"></td>
        <td id="LC12281">            {</td>
      </tr>
      <tr>
        <td id="L12282" data-line-number="12282"></td>
        <td id="LC12282">                <span>return</span> <span>WriteAsync</span>(<span>value</span>.<span>ToCharArray</span>());</td>
      </tr>
      <tr>
        <td id="L12283" data-line-number="12283"></td>
        <td id="LC12283">            }</td>
      </tr>
      <tr>
        <td id="L12284" data-line-number="12284"></td>
        <td id="LC12284">
</td>
      </tr>
      <tr>
        <td id="L12285" data-line-number="12285"></td>
        <td id="LC12285">            <span>internal</span> <span>static</span> <span>void</span> <span>ValidateWriteParameters</span>(<span>char</span>[] <span>buffer</span>, <span>int</span> <span>offset</span>, <span>int</span> <span>count</span>)</td>
      </tr>
      <tr>
        <td id="L12286" data-line-number="12286"></td>
        <td id="LC12286">            {</td>
      </tr>
      <tr>
        <td id="L12287" data-line-number="12287"></td>
        <td id="LC12287">                <span>if</span> (<span>buffer</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L12288" data-line-number="12288"></td>
        <td id="LC12288">                {</td>
      </tr>
      <tr>
        <td id="L12289" data-line-number="12289"></td>
        <td id="LC12289">                    <span>throw</span> <span>ADP</span>.<span>ArgumentNull</span>(<span>ADP</span>.<span>ParameterBuffer</span>);</td>
      </tr>
      <tr>
        <td id="L12290" data-line-number="12290"></td>
        <td id="LC12290">                }</td>
      </tr>
      <tr>
        <td id="L12291" data-line-number="12291"></td>
        <td id="LC12291">                <span>if</span> (<span>offset</span> <span>&lt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12292" data-line-number="12292"></td>
        <td id="LC12292">                {</td>
      </tr>
      <tr>
        <td id="L12293" data-line-number="12293"></td>
        <td id="LC12293">                    <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span>ADP</span>.<span>ParameterOffset</span>);</td>
      </tr>
      <tr>
        <td id="L12294" data-line-number="12294"></td>
        <td id="LC12294">                }</td>
      </tr>
      <tr>
        <td id="L12295" data-line-number="12295"></td>
        <td id="LC12295">                <span>if</span> (<span>count</span> <span>&lt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12296" data-line-number="12296"></td>
        <td id="LC12296">                {</td>
      </tr>
      <tr>
        <td id="L12297" data-line-number="12297"></td>
        <td id="LC12297">                    <span>throw</span> <span>ADP</span>.<span>ArgumentOutOfRange</span>(<span>ADP</span>.<span>ParameterCount</span>);</td>
      </tr>
      <tr>
        <td id="L12298" data-line-number="12298"></td>
        <td id="LC12298">                }</td>
      </tr>
      <tr>
        <td id="L12299" data-line-number="12299"></td>
        <td id="LC12299">                <span>try</span></td>
      </tr>
      <tr>
        <td id="L12300" data-line-number="12300"></td>
        <td id="LC12300">                {</td>
      </tr>
      <tr>
        <td id="L12301" data-line-number="12301"></td>
        <td id="LC12301">                    <span>if</span> (<span>checked</span>(<span>offset</span> <span>+</span> <span>count</span>) <span>&gt;</span> <span>buffer</span>.<span>Length</span>)</td>
      </tr>
      <tr>
        <td id="L12302" data-line-number="12302"></td>
        <td id="LC12302">                    {</td>
      </tr>
      <tr>
        <td id="L12303" data-line-number="12303"></td>
        <td id="LC12303">                        <span>throw</span> <span>ExceptionBuilder</span>.<span>InvalidOffsetLength</span>();</td>
      </tr>
      <tr>
        <td id="L12304" data-line-number="12304"></td>
        <td id="LC12304">                    }</td>
      </tr>
      <tr>
        <td id="L12305" data-line-number="12305"></td>
        <td id="LC12305">                }</td>
      </tr>
      <tr>
        <td id="L12306" data-line-number="12306"></td>
        <td id="LC12306">                <span>catch</span> (<span>OverflowException</span>)</td>
      </tr>
      <tr>
        <td id="L12307" data-line-number="12307"></td>
        <td id="LC12307">                {</td>
      </tr>
      <tr>
        <td id="L12308" data-line-number="12308"></td>
        <td id="LC12308">                    <span><span>//</span> If we've overflowed when adding offset and count, then they never would have fit into buffer anyway</span></td>
      </tr>
      <tr>
        <td id="L12309" data-line-number="12309"></td>
        <td id="LC12309">                    <span>throw</span> <span>ExceptionBuilder</span>.<span>InvalidOffsetLength</span>();</td>
      </tr>
      <tr>
        <td id="L12310" data-line-number="12310"></td>
        <td id="LC12310">                }</td>
      </tr>
      <tr>
        <td id="L12311" data-line-number="12311"></td>
        <td id="LC12311">            }</td>
      </tr>
      <tr>
        <td id="L12312" data-line-number="12312"></td>
        <td id="LC12312">
</td>
      </tr>
      <tr>
        <td id="L12313" data-line-number="12313"></td>
        <td id="LC12313">        }</td>
      </tr>
      <tr>
        <td id="L12314" data-line-number="12314"></td>
        <td id="LC12314">
</td>
      </tr>
      <tr>
        <td id="L12315" data-line-number="12315"></td>
        <td id="LC12315">        <span>private</span> <span>async</span> <span>Task</span> <span>WriteXmlFeed</span>(<span>XmlDataFeed</span> <span>feed</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>needBom</span>, <span>Encoding</span> <span>encoding</span>, <span>int</span> <span>size</span>)</td>
      </tr>
      <tr>
        <td id="L12316" data-line-number="12316"></td>
        <td id="LC12316">        {</td>
      </tr>
      <tr>
        <td id="L12317" data-line-number="12317"></td>
        <td id="LC12317">            <span>byte</span>[] <span>preambleToSkip</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12318" data-line-number="12318"></td>
        <td id="LC12318">            <span>if</span> (<span>!</span><span>needBom</span>)</td>
      </tr>
      <tr>
        <td id="L12319" data-line-number="12319"></td>
        <td id="LC12319">            {</td>
      </tr>
      <tr>
        <td id="L12320" data-line-number="12320"></td>
        <td id="LC12320">                <span>preambleToSkip</span> <span>=</span> <span>encoding</span>.<span>GetPreamble</span>();</td>
      </tr>
      <tr>
        <td id="L12321" data-line-number="12321"></td>
        <td id="LC12321">            }</td>
      </tr>
      <tr>
        <td id="L12322" data-line-number="12322"></td>
        <td id="LC12322">            <span>ConstrainedTextWriter</span> <span>writer</span> <span>=</span> <span>new</span> <span>ConstrainedTextWriter</span>(<span>new</span> <span>StreamWriter</span>(<span>new</span> <span>TdsOutputStream</span>(<span>this</span>, <span>stateObj</span>, <span>preambleToSkip</span>), <span>encoding</span>), <span>size</span>);</td>
      </tr>
      <tr>
        <td id="L12323" data-line-number="12323"></td>
        <td id="LC12323">
</td>
      </tr>
      <tr>
        <td id="L12324" data-line-number="12324"></td>
        <td id="LC12324">            <span>XmlWriterSettings</span> <span>writerSettings</span> <span>=</span> <span>new</span> <span>XmlWriterSettings</span>();</td>
      </tr>
      <tr>
        <td id="L12325" data-line-number="12325"></td>
        <td id="LC12325">            <span>writerSettings</span>.<span>CloseOutput</span> <span>=</span> <span>false</span>;    <span><span>//</span> don't close the memory stream</span></td>
      </tr>
      <tr>
        <td id="L12326" data-line-number="12326"></td>
        <td id="LC12326">            <span>writerSettings</span>.<span>ConformanceLevel</span> <span>=</span> <span>ConformanceLevel</span>.<span>Fragment</span>;</td>
      </tr>
      <tr>
        <td id="L12327" data-line-number="12327"></td>
        <td id="LC12327">            <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12328" data-line-number="12328"></td>
        <td id="LC12328">            {</td>
      </tr>
      <tr>
        <td id="L12329" data-line-number="12329"></td>
        <td id="LC12329">                <span>writerSettings</span>.<span>Async</span> <span>=</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L12330" data-line-number="12330"></td>
        <td id="LC12330">            }</td>
      </tr>
      <tr>
        <td id="L12331" data-line-number="12331"></td>
        <td id="LC12331">            <span>XmlWriter</span> <span>ww</span> <span>=</span> <span>XmlWriter</span>.<span>Create</span>(<span>writer</span>, <span>writerSettings</span>);</td>
      </tr>
      <tr>
        <td id="L12332" data-line-number="12332"></td>
        <td id="LC12332">
</td>
      </tr>
      <tr>
        <td id="L12333" data-line-number="12333"></td>
        <td id="LC12333">            <span>if</span> (<span>feed</span>.<span>_source</span>.<span>ReadState</span> <span>==</span> <span>ReadState</span>.<span>Initial</span>)</td>
      </tr>
      <tr>
        <td id="L12334" data-line-number="12334"></td>
        <td id="LC12334">            {</td>
      </tr>
      <tr>
        <td id="L12335" data-line-number="12335"></td>
        <td id="LC12335">                <span>feed</span>.<span>_source</span>.<span>Read</span>();</td>
      </tr>
      <tr>
        <td id="L12336" data-line-number="12336"></td>
        <td id="LC12336">            }</td>
      </tr>
      <tr>
        <td id="L12337" data-line-number="12337"></td>
        <td id="LC12337">
</td>
      </tr>
      <tr>
        <td id="L12338" data-line-number="12338"></td>
        <td id="LC12338">            <span>while</span> (<span>!</span><span>feed</span>.<span>_source</span>.<span>EOF</span> <span>&amp;&amp;</span> <span>!</span><span>writer</span>.<span>IsComplete</span>)</td>
      </tr>
      <tr>
        <td id="L12339" data-line-number="12339"></td>
        <td id="LC12339">            {</td>
      </tr>
      <tr>
        <td id="L12340" data-line-number="12340"></td>
        <td id="LC12340">
</td>
      </tr>
      <tr>
        <td id="L12341" data-line-number="12341"></td>
        <td id="LC12341">                <span><span>//</span> We are copying nodes from a reader to a writer.  This will cause the</span></td>
      </tr>
      <tr>
        <td id="L12342" data-line-number="12342"></td>
        <td id="LC12342">                <span><span>//</span> XmlDeclaration to be emitted despite ConformanceLevel.Fragment above.</span></td>
      </tr>
      <tr>
        <td id="L12343" data-line-number="12343"></td>
        <td id="LC12343">                <span><span>//</span> Therefore, we filter out the XmlDeclaration while copying.</span></td>
      </tr>
      <tr>
        <td id="L12344" data-line-number="12344"></td>
        <td id="LC12344">                <span>if</span> (<span>feed</span>.<span>_source</span>.<span>NodeType</span> <span>==</span> <span>XmlNodeType</span>.<span>XmlDeclaration</span>)</td>
      </tr>
      <tr>
        <td id="L12345" data-line-number="12345"></td>
        <td id="LC12345">                {</td>
      </tr>
      <tr>
        <td id="L12346" data-line-number="12346"></td>
        <td id="LC12346">                    <span>feed</span>.<span>_source</span>.<span>Read</span>();</td>
      </tr>
      <tr>
        <td id="L12347" data-line-number="12347"></td>
        <td id="LC12347">                    <span>continue</span>;</td>
      </tr>
      <tr>
        <td id="L12348" data-line-number="12348"></td>
        <td id="LC12348">                }</td>
      </tr>
      <tr>
        <td id="L12349" data-line-number="12349"></td>
        <td id="LC12349">
</td>
      </tr>
      <tr>
        <td id="L12350" data-line-number="12350"></td>
        <td id="LC12350">                <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12351" data-line-number="12351"></td>
        <td id="LC12351">                {</td>
      </tr>
      <tr>
        <td id="L12352" data-line-number="12352"></td>
        <td id="LC12352">                    <span>await</span> <span>ww</span>.<span>WriteNodeAsync</span>(<span>feed</span>.<span>_source</span>, <span>true</span>).<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12353" data-line-number="12353"></td>
        <td id="LC12353">                }</td>
      </tr>
      <tr>
        <td id="L12354" data-line-number="12354"></td>
        <td id="LC12354">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L12355" data-line-number="12355"></td>
        <td id="LC12355">                {</td>
      </tr>
      <tr>
        <td id="L12356" data-line-number="12356"></td>
        <td id="LC12356">                    <span>ww</span>.<span>WriteNode</span>(<span>feed</span>.<span>_source</span>, <span>true</span>);</td>
      </tr>
      <tr>
        <td id="L12357" data-line-number="12357"></td>
        <td id="LC12357">                }</td>
      </tr>
      <tr>
        <td id="L12358" data-line-number="12358"></td>
        <td id="LC12358">            }</td>
      </tr>
      <tr>
        <td id="L12359" data-line-number="12359"></td>
        <td id="LC12359">
</td>
      </tr>
      <tr>
        <td id="L12360" data-line-number="12360"></td>
        <td id="LC12360">            <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12361" data-line-number="12361"></td>
        <td id="LC12361">            {</td>
      </tr>
      <tr>
        <td id="L12362" data-line-number="12362"></td>
        <td id="LC12362">                <span>await</span> <span>ww</span>.<span>FlushAsync</span>().<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12363" data-line-number="12363"></td>
        <td id="LC12363">            }</td>
      </tr>
      <tr>
        <td id="L12364" data-line-number="12364"></td>
        <td id="LC12364">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L12365" data-line-number="12365"></td>
        <td id="LC12365">            {</td>
      </tr>
      <tr>
        <td id="L12366" data-line-number="12366"></td>
        <td id="LC12366">                <span>ww</span>.<span>Flush</span>();</td>
      </tr>
      <tr>
        <td id="L12367" data-line-number="12367"></td>
        <td id="LC12367">            }</td>
      </tr>
      <tr>
        <td id="L12368" data-line-number="12368"></td>
        <td id="LC12368">        }</td>
      </tr>
      <tr>
        <td id="L12369" data-line-number="12369"></td>
        <td id="LC12369">
</td>
      </tr>
      <tr>
        <td id="L12370" data-line-number="12370"></td>
        <td id="LC12370">        <span>private</span> <span>async</span> <span>Task</span> <span>WriteTextFeed</span>(<span>TextDataFeed</span> <span>feed</span>, <span>Encoding</span> <span>encoding</span>, <span>bool</span> <span>needBom</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>size</span>)</td>
      </tr>
      <tr>
        <td id="L12371" data-line-number="12371"></td>
        <td id="LC12371">        {</td>
      </tr>
      <tr>
        <td id="L12372" data-line-number="12372"></td>
        <td id="LC12372">            <span>Debug</span>.<span>Assert</span>(<span>encoding</span> <span>==</span> <span>null</span> <span>||</span> <span>!</span><span>needBom</span>);</td>
      </tr>
      <tr>
        <td id="L12373" data-line-number="12373"></td>
        <td id="LC12373">            <span>char</span>[] <span>inBuff</span> <span>=</span> <span>new</span> <span>char</span>[<span>constTextBufferSize</span>];</td>
      </tr>
      <tr>
        <td id="L12374" data-line-number="12374"></td>
        <td id="LC12374">
</td>
      </tr>
      <tr>
        <td id="L12375" data-line-number="12375"></td>
        <td id="LC12375">            <span>encoding</span> <span>=</span> <span>encoding</span> <span>??</span> <span>new</span> <span>UnicodeEncoding</span>(<span>false</span>, <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12376" data-line-number="12376"></td>
        <td id="LC12376">            <span>ConstrainedTextWriter</span> <span>writer</span> <span>=</span> <span>new</span> <span>ConstrainedTextWriter</span>(<span>new</span> <span>StreamWriter</span>(<span>new</span> <span>TdsOutputStream</span>(<span>this</span>, <span>stateObj</span>, <span>null</span>), <span>encoding</span>), <span>size</span>);</td>
      </tr>
      <tr>
        <td id="L12377" data-line-number="12377"></td>
        <td id="LC12377">
</td>
      </tr>
      <tr>
        <td id="L12378" data-line-number="12378"></td>
        <td id="LC12378">            <span>if</span> (<span>needBom</span>)</td>
      </tr>
      <tr>
        <td id="L12379" data-line-number="12379"></td>
        <td id="LC12379">            {</td>
      </tr>
      <tr>
        <td id="L12380" data-line-number="12380"></td>
        <td id="LC12380">                <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12381" data-line-number="12381"></td>
        <td id="LC12381">                {</td>
      </tr>
      <tr>
        <td id="L12382" data-line-number="12382"></td>
        <td id="LC12382">                    <span>await</span> <span>writer</span>.<span>WriteAsync</span>((<span>char</span>)<span>TdsEnums</span>.<span>XMLUNICODEBOM</span>).<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12383" data-line-number="12383"></td>
        <td id="LC12383">                }</td>
      </tr>
      <tr>
        <td id="L12384" data-line-number="12384"></td>
        <td id="LC12384">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L12385" data-line-number="12385"></td>
        <td id="LC12385">                {</td>
      </tr>
      <tr>
        <td id="L12386" data-line-number="12386"></td>
        <td id="LC12386">                    <span>writer</span>.<span>Write</span>((<span>char</span>)<span>TdsEnums</span>.<span>XMLUNICODEBOM</span>);</td>
      </tr>
      <tr>
        <td id="L12387" data-line-number="12387"></td>
        <td id="LC12387">                }</td>
      </tr>
      <tr>
        <td id="L12388" data-line-number="12388"></td>
        <td id="LC12388">            }</td>
      </tr>
      <tr>
        <td id="L12389" data-line-number="12389"></td>
        <td id="LC12389">
</td>
      </tr>
      <tr>
        <td id="L12390" data-line-number="12390"></td>
        <td id="LC12390">            <span>int</span> <span>nWritten</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L12391" data-line-number="12391"></td>
        <td id="LC12391">            <span>do</span></td>
      </tr>
      <tr>
        <td id="L12392" data-line-number="12392"></td>
        <td id="LC12392">            {</td>
      </tr>
      <tr>
        <td id="L12393" data-line-number="12393"></td>
        <td id="LC12393">                <span>int</span> <span>nRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L12394" data-line-number="12394"></td>
        <td id="LC12394">
</td>
      </tr>
      <tr>
        <td id="L12395" data-line-number="12395"></td>
        <td id="LC12395">                <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12396" data-line-number="12396"></td>
        <td id="LC12396">                {</td>
      </tr>
      <tr>
        <td id="L12397" data-line-number="12397"></td>
        <td id="LC12397">                    <span>nRead</span> <span>=</span> <span>await</span> <span>feed</span>.<span>_source</span>.<span>ReadBlockAsync</span>(<span>inBuff</span>, <span>0</span>, <span>constTextBufferSize</span>).<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12398" data-line-number="12398"></td>
        <td id="LC12398">                }</td>
      </tr>
      <tr>
        <td id="L12399" data-line-number="12399"></td>
        <td id="LC12399">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L12400" data-line-number="12400"></td>
        <td id="LC12400">                {</td>
      </tr>
      <tr>
        <td id="L12401" data-line-number="12401"></td>
        <td id="LC12401">                    <span>nRead</span> <span>=</span> <span>feed</span>.<span>_source</span>.<span>ReadBlock</span>(<span>inBuff</span>, <span>0</span>, <span>constTextBufferSize</span>);</td>
      </tr>
      <tr>
        <td id="L12402" data-line-number="12402"></td>
        <td id="LC12402">                }</td>
      </tr>
      <tr>
        <td id="L12403" data-line-number="12403"></td>
        <td id="LC12403">
</td>
      </tr>
      <tr>
        <td id="L12404" data-line-number="12404"></td>
        <td id="LC12404">                <span>if</span> (<span>nRead</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12405" data-line-number="12405"></td>
        <td id="LC12405">                {</td>
      </tr>
      <tr>
        <td id="L12406" data-line-number="12406"></td>
        <td id="LC12406">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12407" data-line-number="12407"></td>
        <td id="LC12407">                }</td>
      </tr>
      <tr>
        <td id="L12408" data-line-number="12408"></td>
        <td id="LC12408">
</td>
      </tr>
      <tr>
        <td id="L12409" data-line-number="12409"></td>
        <td id="LC12409">                <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12410" data-line-number="12410"></td>
        <td id="LC12410">                {</td>
      </tr>
      <tr>
        <td id="L12411" data-line-number="12411"></td>
        <td id="LC12411">                    <span>await</span> <span>writer</span>.<span>WriteAsync</span>(<span>inBuff</span>, <span>0</span>, <span>nRead</span>).<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12412" data-line-number="12412"></td>
        <td id="LC12412">                }</td>
      </tr>
      <tr>
        <td id="L12413" data-line-number="12413"></td>
        <td id="LC12413">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L12414" data-line-number="12414"></td>
        <td id="LC12414">                {</td>
      </tr>
      <tr>
        <td id="L12415" data-line-number="12415"></td>
        <td id="LC12415">                    <span>writer</span>.<span>Write</span>(<span>inBuff</span>, <span>0</span>, <span>nRead</span>);</td>
      </tr>
      <tr>
        <td id="L12416" data-line-number="12416"></td>
        <td id="LC12416">                }</td>
      </tr>
      <tr>
        <td id="L12417" data-line-number="12417"></td>
        <td id="LC12417">
</td>
      </tr>
      <tr>
        <td id="L12418" data-line-number="12418"></td>
        <td id="LC12418">                <span>nWritten</span> <span>+=</span> <span>nRead</span>;</td>
      </tr>
      <tr>
        <td id="L12419" data-line-number="12419"></td>
        <td id="LC12419">            } <span>while</span> (<span>!</span><span>writer</span>.<span>IsComplete</span>);</td>
      </tr>
      <tr>
        <td id="L12420" data-line-number="12420"></td>
        <td id="LC12420">
</td>
      </tr>
      <tr>
        <td id="L12421" data-line-number="12421"></td>
        <td id="LC12421">            <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12422" data-line-number="12422"></td>
        <td id="LC12422">            {</td>
      </tr>
      <tr>
        <td id="L12423" data-line-number="12423"></td>
        <td id="LC12423">                <span>await</span> <span>writer</span>.<span>FlushAsync</span>().<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12424" data-line-number="12424"></td>
        <td id="LC12424">            }</td>
      </tr>
      <tr>
        <td id="L12425" data-line-number="12425"></td>
        <td id="LC12425">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L12426" data-line-number="12426"></td>
        <td id="LC12426">            {</td>
      </tr>
      <tr>
        <td id="L12427" data-line-number="12427"></td>
        <td id="LC12427">                <span>writer</span>.<span>Flush</span>();</td>
      </tr>
      <tr>
        <td id="L12428" data-line-number="12428"></td>
        <td id="LC12428">            }</td>
      </tr>
      <tr>
        <td id="L12429" data-line-number="12429"></td>
        <td id="LC12429">        }</td>
      </tr>
      <tr>
        <td id="L12430" data-line-number="12430"></td>
        <td id="LC12430">
</td>
      </tr>
      <tr>
        <td id="L12431" data-line-number="12431"></td>
        <td id="LC12431">        <span>private</span> <span>async</span> <span>Task</span> <span>WriteStreamFeed</span>(<span>StreamDataFeed</span> <span>feed</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>len</span>)</td>
      </tr>
      <tr>
        <td id="L12432" data-line-number="12432"></td>
        <td id="LC12432">        {</td>
      </tr>
      <tr>
        <td id="L12433" data-line-number="12433"></td>
        <td id="LC12433">            <span>TdsOutputStream</span> <span>output</span> <span>=</span> <span>new</span> <span>TdsOutputStream</span>(<span>this</span>, <span>stateObj</span>, <span>null</span>);</td>
      </tr>
      <tr>
        <td id="L12434" data-line-number="12434"></td>
        <td id="LC12434">            <span>byte</span>[] <span>buff</span> <span>=</span> <span>new</span> <span>byte</span>[<span>constBinBufferSize</span>];</td>
      </tr>
      <tr>
        <td id="L12435" data-line-number="12435"></td>
        <td id="LC12435">            <span>int</span> <span>nWritten</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L12436" data-line-number="12436"></td>
        <td id="LC12436">            <span>do</span></td>
      </tr>
      <tr>
        <td id="L12437" data-line-number="12437"></td>
        <td id="LC12437">            {</td>
      </tr>
      <tr>
        <td id="L12438" data-line-number="12438"></td>
        <td id="LC12438">                <span>int</span> <span>nRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L12439" data-line-number="12439"></td>
        <td id="LC12439">                <span>int</span> <span>readSize</span> <span>=</span> <span>constBinBufferSize</span>;</td>
      </tr>
      <tr>
        <td id="L12440" data-line-number="12440"></td>
        <td id="LC12440">                <span>if</span> (<span>len</span> <span>&gt;</span> <span>0</span> <span>&amp;&amp;</span> <span>nWritten</span> <span>+</span> <span>readSize</span> <span>&gt;</span> <span>len</span>)</td>
      </tr>
      <tr>
        <td id="L12441" data-line-number="12441"></td>
        <td id="LC12441">                {</td>
      </tr>
      <tr>
        <td id="L12442" data-line-number="12442"></td>
        <td id="LC12442">                    <span>readSize</span> <span>=</span> <span>len</span> <span>-</span> <span>nWritten</span>;</td>
      </tr>
      <tr>
        <td id="L12443" data-line-number="12443"></td>
        <td id="LC12443">                }</td>
      </tr>
      <tr>
        <td id="L12444" data-line-number="12444"></td>
        <td id="LC12444">
</td>
      </tr>
      <tr>
        <td id="L12445" data-line-number="12445"></td>
        <td id="LC12445">                <span>Debug</span>.<span>Assert</span>(<span>readSize</span> <span>&gt;=</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L12446" data-line-number="12446"></td>
        <td id="LC12446">
</td>
      </tr>
      <tr>
        <td id="L12447" data-line-number="12447"></td>
        <td id="LC12447">                <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12448" data-line-number="12448"></td>
        <td id="LC12448">                {</td>
      </tr>
      <tr>
        <td id="L12449" data-line-number="12449"></td>
        <td id="LC12449">                    <span>nRead</span> <span>=</span> <span>await</span> <span>feed</span>.<span>_source</span>.<span>ReadAsync</span>(<span>buff</span>, <span>0</span>, <span>readSize</span>).<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12450" data-line-number="12450"></td>
        <td id="LC12450">                }</td>
      </tr>
      <tr>
        <td id="L12451" data-line-number="12451"></td>
        <td id="LC12451">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L12452" data-line-number="12452"></td>
        <td id="LC12452">                {</td>
      </tr>
      <tr>
        <td id="L12453" data-line-number="12453"></td>
        <td id="LC12453">                    <span>nRead</span> <span>=</span> <span>feed</span>.<span>_source</span>.<span>Read</span>(<span>buff</span>, <span>0</span>, <span>readSize</span>);</td>
      </tr>
      <tr>
        <td id="L12454" data-line-number="12454"></td>
        <td id="LC12454">                }</td>
      </tr>
      <tr>
        <td id="L12455" data-line-number="12455"></td>
        <td id="LC12455">
</td>
      </tr>
      <tr>
        <td id="L12456" data-line-number="12456"></td>
        <td id="LC12456">                <span>if</span> (<span>nRead</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L12457" data-line-number="12457"></td>
        <td id="LC12457">                {</td>
      </tr>
      <tr>
        <td id="L12458" data-line-number="12458"></td>
        <td id="LC12458">                    <span>return</span>;</td>
      </tr>
      <tr>
        <td id="L12459" data-line-number="12459"></td>
        <td id="LC12459">                }</td>
      </tr>
      <tr>
        <td id="L12460" data-line-number="12460"></td>
        <td id="LC12460">
</td>
      </tr>
      <tr>
        <td id="L12461" data-line-number="12461"></td>
        <td id="LC12461">                <span>if</span> (<span>_asyncWrite</span>)</td>
      </tr>
      <tr>
        <td id="L12462" data-line-number="12462"></td>
        <td id="LC12462">                {</td>
      </tr>
      <tr>
        <td id="L12463" data-line-number="12463"></td>
        <td id="LC12463">                    <span>await</span> <span>output</span>.<span>WriteAsync</span>(<span>buff</span>, <span>0</span>, <span>nRead</span>).<span>ConfigureAwait</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12464" data-line-number="12464"></td>
        <td id="LC12464">                }</td>
      </tr>
      <tr>
        <td id="L12465" data-line-number="12465"></td>
        <td id="LC12465">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L12466" data-line-number="12466"></td>
        <td id="LC12466">                {</td>
      </tr>
      <tr>
        <td id="L12467" data-line-number="12467"></td>
        <td id="LC12467">                    <span>output</span>.<span>Write</span>(<span>buff</span>, <span>0</span>, <span>nRead</span>);</td>
      </tr>
      <tr>
        <td id="L12468" data-line-number="12468"></td>
        <td id="LC12468">                }</td>
      </tr>
      <tr>
        <td id="L12469" data-line-number="12469"></td>
        <td id="LC12469">
</td>
      </tr>
      <tr>
        <td id="L12470" data-line-number="12470"></td>
        <td id="LC12470">                <span>nWritten</span> <span>+=</span> <span>nRead</span>;</td>
      </tr>
      <tr>
        <td id="L12471" data-line-number="12471"></td>
        <td id="LC12471">            } <span>while</span> (<span>len</span> <span>&lt;=</span> <span>0</span> <span>||</span> <span>nWritten</span> <span>&lt;</span> <span>len</span>);</td>
      </tr>
      <tr>
        <td id="L12472" data-line-number="12472"></td>
        <td id="LC12472">        }</td>
      </tr>
      <tr>
        <td id="L12473" data-line-number="12473"></td>
        <td id="LC12473">
</td>
      </tr>
      <tr>
        <td id="L12474" data-line-number="12474"></td>
        <td id="LC12474">        <span>private</span> <span>Task</span> <span>NullIfCompletedWriteTask</span>(<span>Task</span> <span>task</span>)</td>
      </tr>
      <tr>
        <td id="L12475" data-line-number="12475"></td>
        <td id="LC12475">        {</td>
      </tr>
      <tr>
        <td id="L12476" data-line-number="12476"></td>
        <td id="LC12476">            <span>if</span> (<span>task</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L12477" data-line-number="12477"></td>
        <td id="LC12477">            {</td>
      </tr>
      <tr>
        <td id="L12478" data-line-number="12478"></td>
        <td id="LC12478">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12479" data-line-number="12479"></td>
        <td id="LC12479">            }</td>
      </tr>
      <tr>
        <td id="L12480" data-line-number="12480"></td>
        <td id="LC12480">            <span>switch</span> (<span>task</span>.<span>Status</span>)</td>
      </tr>
      <tr>
        <td id="L12481" data-line-number="12481"></td>
        <td id="LC12481">            {</td>
      </tr>
      <tr>
        <td id="L12482" data-line-number="12482"></td>
        <td id="LC12482">                <span>case</span> <span>TaskStatus</span>.<span>RanToCompletion</span>:</td>
      </tr>
      <tr>
        <td id="L12483" data-line-number="12483"></td>
        <td id="LC12483">                    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12484" data-line-number="12484"></td>
        <td id="LC12484">                <span>case</span> <span>TaskStatus</span>.<span>Faulted</span>:</td>
      </tr>
      <tr>
        <td id="L12485" data-line-number="12485"></td>
        <td id="LC12485">                    <span>throw</span> <span>task</span>.<span>Exception</span>.<span>InnerException</span>;</td>
      </tr>
      <tr>
        <td id="L12486" data-line-number="12486"></td>
        <td id="LC12486">                <span>case</span> <span>TaskStatus</span>.<span>Canceled</span>:</td>
      </tr>
      <tr>
        <td id="L12487" data-line-number="12487"></td>
        <td id="LC12487">                    <span>throw</span> <span>SQL</span>.<span>OperationCancelled</span>();</td>
      </tr>
      <tr>
        <td id="L12488" data-line-number="12488"></td>
        <td id="LC12488">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L12489" data-line-number="12489"></td>
        <td id="LC12489">                    <span>return</span> <span>task</span>;</td>
      </tr>
      <tr>
        <td id="L12490" data-line-number="12490"></td>
        <td id="LC12490">            }</td>
      </tr>
      <tr>
        <td id="L12491" data-line-number="12491"></td>
        <td id="LC12491">        }</td>
      </tr>
      <tr>
        <td id="L12492" data-line-number="12492"></td>
        <td id="LC12492">
</td>
      </tr>
      <tr>
        <td id="L12493" data-line-number="12493"></td>
        <td id="LC12493">        <span>private</span> <span>Task</span> <span>WriteValue</span>(<span>object</span> <span>value</span>, <span>MetaType</span> <span>type</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>actualLength</span>, <span>int</span> <span>encodingByteSize</span>, <span>int</span> <span>offset</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>paramSize</span>, <span>bool</span> <span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L12494" data-line-number="12494"></td>
        <td id="LC12494">        {</td>
      </tr>
      <tr>
        <td id="L12495" data-line-number="12495"></td>
        <td id="LC12495">            <span>return</span> <span>GetTerminationTask</span>(<span>WriteUnterminatedValue</span>(<span>value</span>, <span>type</span>, <span>scale</span>, <span>actualLength</span>, <span>encodingByteSize</span>, <span>offset</span>, <span>stateObj</span>, <span>paramSize</span>, <span>isDataFeed</span>),</td>
      </tr>
      <tr>
        <td id="L12496" data-line-number="12496"></td>
        <td id="LC12496">                <span>value</span>, <span>type</span>, <span>actualLength</span>, <span>stateObj</span>, <span>isDataFeed</span>);</td>
      </tr>
      <tr>
        <td id="L12497" data-line-number="12497"></td>
        <td id="LC12497">        }</td>
      </tr>
      <tr>
        <td id="L12498" data-line-number="12498"></td>
        <td id="LC12498">
</td>
      </tr>
      <tr>
        <td id="L12499" data-line-number="12499"></td>
        <td id="LC12499">        <span><span>//</span> For MAX types, this method can only write everything in one big chunk. If multiple</span></td>
      </tr>
      <tr>
        <td id="L12500" data-line-number="12500"></td>
        <td id="LC12500">        <span><span>//</span> chunk writes needed, please use WritePlpBytes/WritePlpChars</span></td>
      </tr>
      <tr>
        <td id="L12501" data-line-number="12501"></td>
        <td id="LC12501">        <span>private</span> <span>Task</span> <span>WriteUnterminatedValue</span>(<span>object</span> <span>value</span>, <span>MetaType</span> <span>type</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>actualLength</span>, <span>int</span> <span>encodingByteSize</span>, <span>int</span> <span>offset</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>int</span> <span>paramSize</span>, <span>bool</span> <span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L12502" data-line-number="12502"></td>
        <td id="LC12502">        {</td>
      </tr>
      <tr>
        <td id="L12503" data-line-number="12503"></td>
        <td id="LC12503">            <span>Debug</span>.<span>Assert</span>((<span>null</span> <span>!=</span> <span>value</span>) <span>&amp;&amp;</span> (<span>DBNull</span>.<span>Value</span> <span>!=</span> <span>value</span>), <span><span>"</span>unexpected missing or empty object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12504" data-line-number="12504"></td>
        <td id="LC12504">
</td>
      </tr>
      <tr>
        <td id="L12505" data-line-number="12505"></td>
        <td id="LC12505">            <span><span>//</span> parameters are always sent over as BIG or N types</span></td>
      </tr>
      <tr>
        <td id="L12506" data-line-number="12506"></td>
        <td id="LC12506">            <span>switch</span> (<span>type</span>.<span>NullableType</span>)</td>
      </tr>
      <tr>
        <td id="L12507" data-line-number="12507"></td>
        <td id="LC12507">            {</td>
      </tr>
      <tr>
        <td id="L12508" data-line-number="12508"></td>
        <td id="LC12508">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLTN</span>:</td>
      </tr>
      <tr>
        <td id="L12509" data-line-number="12509"></td>
        <td id="LC12509">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L12510" data-line-number="12510"></td>
        <td id="LC12510">                        <span>WriteFloat</span>((<span>Single</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12511" data-line-number="12511"></td>
        <td id="LC12511">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L12512" data-line-number="12512"></td>
        <td id="LC12512">                    {</td>
      </tr>
      <tr>
        <td id="L12513" data-line-number="12513"></td>
        <td id="LC12513">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>Invalid length for SqlDouble type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12514" data-line-number="12514"></td>
        <td id="LC12514">                        <span>WriteDouble</span>((<span>Double</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12515" data-line-number="12515"></td>
        <td id="LC12515">                    }</td>
      </tr>
      <tr>
        <td id="L12516" data-line-number="12516"></td>
        <td id="LC12516">
</td>
      </tr>
      <tr>
        <td id="L12517" data-line-number="12517"></td>
        <td id="LC12517">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12518" data-line-number="12518"></td>
        <td id="LC12518">
</td>
      </tr>
      <tr>
        <td id="L12519" data-line-number="12519"></td>
        <td id="LC12519">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L12520" data-line-number="12520"></td>
        <td id="LC12520">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L12521" data-line-number="12521"></td>
        <td id="LC12521">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L12522" data-line-number="12522"></td>
        <td id="LC12522">                <span>case</span> <span>TdsEnums</span>.<span>SQLUDT</span>:</td>
      </tr>
      <tr>
        <td id="L12523" data-line-number="12523"></td>
        <td id="LC12523">                    {</td>
      </tr>
      <tr>
        <td id="L12524" data-line-number="12524"></td>
        <td id="LC12524">                        <span><span>//</span> An array should be in the object</span></td>
      </tr>
      <tr>
        <td id="L12525" data-line-number="12525"></td>
        <td id="LC12525">                        <span>Debug</span>.<span>Assert</span>(<span>isDataFeed</span> <span>||</span> <span>value</span> <span>is</span> <span>byte</span>[], <span><span>"</span>Value should be an array of bytes<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12526" data-line-number="12526"></td>
        <td id="LC12526">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isDataFeed</span> <span>||</span> <span>value</span> <span>is</span> <span>StreamDataFeed</span>, <span><span>"</span>Value should be a stream<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12527" data-line-number="12527"></td>
        <td id="LC12527">
</td>
      </tr>
      <tr>
        <td id="L12528" data-line-number="12528"></td>
        <td id="LC12528">                        <span>if</span> (<span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L12529" data-line-number="12529"></td>
        <td id="LC12529">                        {</td>
      </tr>
      <tr>
        <td id="L12530" data-line-number="12530"></td>
        <td id="LC12530">                            <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>IsPlp</span>, <span><span>"</span>Stream assigned to non-PLP was not converted!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12531" data-line-number="12531"></td>
        <td id="LC12531">                            <span>return</span> <span>NullIfCompletedWriteTask</span>(<span>WriteStreamFeed</span>((<span>StreamDataFeed</span>)<span>value</span>, <span>stateObj</span>, <span>paramSize</span>));</td>
      </tr>
      <tr>
        <td id="L12532" data-line-number="12532"></td>
        <td id="LC12532">                        }</td>
      </tr>
      <tr>
        <td id="L12533" data-line-number="12533"></td>
        <td id="LC12533">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12534" data-line-number="12534"></td>
        <td id="LC12534">                        {</td>
      </tr>
      <tr>
        <td id="L12535" data-line-number="12535"></td>
        <td id="LC12535">                            <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L12536" data-line-number="12536"></td>
        <td id="LC12536">                            {</td>
      </tr>
      <tr>
        <td id="L12537" data-line-number="12537"></td>
        <td id="LC12537">                                <span>WriteInt</span>(<span>actualLength</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L12538" data-line-number="12538"></td>
        <td id="LC12538">                            }</td>
      </tr>
      <tr>
        <td id="L12539" data-line-number="12539"></td>
        <td id="LC12539">
</td>
      </tr>
      <tr>
        <td id="L12540" data-line-number="12540"></td>
        <td id="LC12540">                            <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>((<span>byte</span>[])<span>value</span>, <span>actualLength</span>, <span>offset</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12541" data-line-number="12541"></td>
        <td id="LC12541">                        }</td>
      </tr>
      <tr>
        <td id="L12542" data-line-number="12542"></td>
        <td id="LC12542">                    }</td>
      </tr>
      <tr>
        <td id="L12543" data-line-number="12543"></td>
        <td id="LC12543">
</td>
      </tr>
      <tr>
        <td id="L12544" data-line-number="12544"></td>
        <td id="LC12544">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L12545" data-line-number="12545"></td>
        <td id="LC12545">                    {</td>
      </tr>
      <tr>
        <td id="L12546" data-line-number="12546"></td>
        <td id="LC12546">                        <span>System</span>.<span>Guid</span> <span>guid</span> <span>=</span> (<span>System</span>.<span>Guid</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L12547" data-line-number="12547"></td>
        <td id="LC12547">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>guid</span>.<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L12548" data-line-number="12548"></td>
        <td id="LC12548">
</td>
      </tr>
      <tr>
        <td id="L12549" data-line-number="12549"></td>
        <td id="LC12549">                        <span>Debug</span>.<span>Assert</span>((<span>actualLength</span> <span>==</span> <span>b</span>.<span>Length</span>) <span>&amp;&amp;</span> (<span>actualLength</span> <span>==</span> <span>16</span>), <span><span>"</span>Invalid length for guid type in com+ object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12550" data-line-number="12550"></td>
        <td id="LC12550">                        <span>stateObj</span>.<span>WriteByteArray</span>(<span>b</span>, <span>actualLength</span>, <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L12551" data-line-number="12551"></td>
        <td id="LC12551">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12552" data-line-number="12552"></td>
        <td id="LC12552">                    }</td>
      </tr>
      <tr>
        <td id="L12553" data-line-number="12553"></td>
        <td id="LC12553">
</td>
      </tr>
      <tr>
        <td id="L12554" data-line-number="12554"></td>
        <td id="LC12554">                <span>case</span> <span>TdsEnums</span>.<span>SQLBITN</span>:</td>
      </tr>
      <tr>
        <td id="L12555" data-line-number="12555"></td>
        <td id="LC12555">                    {</td>
      </tr>
      <tr>
        <td id="L12556" data-line-number="12556"></td>
        <td id="LC12556">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>, <span><span>"</span>Invalid length for SqlBoolean type<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12557" data-line-number="12557"></td>
        <td id="LC12557">                        <span>if</span> ((<span>bool</span>)<span>value</span> <span>==</span> <span>true</span>)</td>
      </tr>
      <tr>
        <td id="L12558" data-line-number="12558"></td>
        <td id="LC12558">                            <span>stateObj</span>.<span>WriteByte</span>(<span>1</span>);</td>
      </tr>
      <tr>
        <td id="L12559" data-line-number="12559"></td>
        <td id="LC12559">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12560" data-line-number="12560"></td>
        <td id="LC12560">                            <span>stateObj</span>.<span>WriteByte</span>(<span>0</span>);</td>
      </tr>
      <tr>
        <td id="L12561" data-line-number="12561"></td>
        <td id="LC12561">
</td>
      </tr>
      <tr>
        <td id="L12562" data-line-number="12562"></td>
        <td id="LC12562">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12563" data-line-number="12563"></td>
        <td id="LC12563">                    }</td>
      </tr>
      <tr>
        <td id="L12564" data-line-number="12564"></td>
        <td id="LC12564">
</td>
      </tr>
      <tr>
        <td id="L12565" data-line-number="12565"></td>
        <td id="LC12565">                <span>case</span> <span>TdsEnums</span>.<span>SQLINTN</span>:</td>
      </tr>
      <tr>
        <td id="L12566" data-line-number="12566"></td>
        <td id="LC12566">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L12567" data-line-number="12567"></td>
        <td id="LC12567">                        <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L12568" data-line-number="12568"></td>
        <td id="LC12568">                    <span>else</span> <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>2</span>)</td>
      </tr>
      <tr>
        <td id="L12569" data-line-number="12569"></td>
        <td id="LC12569">                        <span>WriteShort</span>((<span>Int16</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12570" data-line-number="12570"></td>
        <td id="LC12570">                    <span>else</span> <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L12571" data-line-number="12571"></td>
        <td id="LC12571">                        <span>WriteInt</span>((<span>Int32</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12572" data-line-number="12572"></td>
        <td id="LC12572">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L12573" data-line-number="12573"></td>
        <td id="LC12573">                    {</td>
      </tr>
      <tr>
        <td id="L12574" data-line-number="12574"></td>
        <td id="LC12574">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for SqlIntN type:  <span>"</span></span> <span>+</span> <span>type</span>.<span>FixedLength</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L12575" data-line-number="12575"></td>
        <td id="LC12575">                        <span>WriteLong</span>((<span>Int64</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12576" data-line-number="12576"></td>
        <td id="LC12576">                    }</td>
      </tr>
      <tr>
        <td id="L12577" data-line-number="12577"></td>
        <td id="LC12577">
</td>
      </tr>
      <tr>
        <td id="L12578" data-line-number="12578"></td>
        <td id="LC12578">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12579" data-line-number="12579"></td>
        <td id="LC12579">
</td>
      </tr>
      <tr>
        <td id="L12580" data-line-number="12580"></td>
        <td id="LC12580">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12581" data-line-number="12581"></td>
        <td id="LC12581">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12582" data-line-number="12582"></td>
        <td id="LC12582">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L12583" data-line-number="12583"></td>
        <td id="LC12583">                    {</td>
      </tr>
      <tr>
        <td id="L12584" data-line-number="12584"></td>
        <td id="LC12584">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isDataFeed</span> <span>||</span> (<span>value</span> <span>is</span> <span>TextDataFeed</span> <span>||</span> <span>value</span> <span>is</span> <span>XmlDataFeed</span>), <span><span>"</span>Value must be a TextReader or XmlReader<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12585" data-line-number="12585"></td>
        <td id="LC12585">                        <span>Debug</span>.<span>Assert</span>(<span>isDataFeed</span> <span>||</span> (<span>value</span> <span>is</span> <span>string</span> <span>||</span> <span>value</span> <span>is</span> <span>byte</span>[]), <span><span>"</span>Value is a byte array or string<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12586" data-line-number="12586"></td>
        <td id="LC12586">
</td>
      </tr>
      <tr>
        <td id="L12587" data-line-number="12587"></td>
        <td id="LC12587">                        <span>if</span> (<span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L12588" data-line-number="12588"></td>
        <td id="LC12588">                        {</td>
      </tr>
      <tr>
        <td id="L12589" data-line-number="12589"></td>
        <td id="LC12589">                            <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>IsPlp</span>, <span><span>"</span>Stream assigned to non-PLP was not converted!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12590" data-line-number="12590"></td>
        <td id="LC12590">                            <span>TextDataFeed</span> <span>tdf</span> <span>=</span> <span>value</span> <span>as</span> <span>TextDataFeed</span>;</td>
      </tr>
      <tr>
        <td id="L12591" data-line-number="12591"></td>
        <td id="LC12591">                            <span>if</span> (<span>tdf</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L12592" data-line-number="12592"></td>
        <td id="LC12592">                            {</td>
      </tr>
      <tr>
        <td id="L12593" data-line-number="12593"></td>
        <td id="LC12593">                                <span>return</span> <span>NullIfCompletedWriteTask</span>(<span>WriteXmlFeed</span>((<span>XmlDataFeed</span>)<span>value</span>, <span>stateObj</span>, <span>needBom</span>: <span>true</span>, <span>encoding</span>: <span>_defaultEncoding</span>, <span>size</span>: <span>paramSize</span>));</td>
      </tr>
      <tr>
        <td id="L12594" data-line-number="12594"></td>
        <td id="LC12594">                            }</td>
      </tr>
      <tr>
        <td id="L12595" data-line-number="12595"></td>
        <td id="LC12595">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L12596" data-line-number="12596"></td>
        <td id="LC12596">                            {</td>
      </tr>
      <tr>
        <td id="L12597" data-line-number="12597"></td>
        <td id="LC12597">                                <span>return</span> <span>NullIfCompletedWriteTask</span>(<span>WriteTextFeed</span>(<span>tdf</span>, <span>_defaultEncoding</span>, <span>false</span>, <span>stateObj</span>, <span>paramSize</span>));</td>
      </tr>
      <tr>
        <td id="L12598" data-line-number="12598"></td>
        <td id="LC12598">                            }</td>
      </tr>
      <tr>
        <td id="L12599" data-line-number="12599"></td>
        <td id="LC12599">                        }</td>
      </tr>
      <tr>
        <td id="L12600" data-line-number="12600"></td>
        <td id="LC12600">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12601" data-line-number="12601"></td>
        <td id="LC12601">                        {</td>
      </tr>
      <tr>
        <td id="L12602" data-line-number="12602"></td>
        <td id="LC12602">                            <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L12603" data-line-number="12603"></td>
        <td id="LC12603">                            {</td>
      </tr>
      <tr>
        <td id="L12604" data-line-number="12604"></td>
        <td id="LC12604">                                <span>WriteInt</span>(<span>encodingByteSize</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L12605" data-line-number="12605"></td>
        <td id="LC12605">                            }</td>
      </tr>
      <tr>
        <td id="L12606" data-line-number="12606"></td>
        <td id="LC12606">                            <span>if</span> (<span>value</span> <span>is</span> <span>byte</span>[])</td>
      </tr>
      <tr>
        <td id="L12607" data-line-number="12607"></td>
        <td id="LC12607">                            { <span><span>//</span> If LazyMat non-filled blob, send cookie rather than value</span></td>
      </tr>
      <tr>
        <td id="L12608" data-line-number="12608"></td>
        <td id="LC12608">                                <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>((<span>byte</span>[])<span>value</span>, <span>actualLength</span>, <span>0</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12609" data-line-number="12609"></td>
        <td id="LC12609">                            }</td>
      </tr>
      <tr>
        <td id="L12610" data-line-number="12610"></td>
        <td id="LC12610">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L12611" data-line-number="12611"></td>
        <td id="LC12611">                            {</td>
      </tr>
      <tr>
        <td id="L12612" data-line-number="12612"></td>
        <td id="LC12612">                                <span>return</span> <span>WriteEncodingChar</span>((<span>string</span>)<span>value</span>, <span>actualLength</span>, <span>offset</span>, <span>_defaultEncoding</span>, <span>stateObj</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12613" data-line-number="12613"></td>
        <td id="LC12613">                            }</td>
      </tr>
      <tr>
        <td id="L12614" data-line-number="12614"></td>
        <td id="LC12614">                        }</td>
      </tr>
      <tr>
        <td id="L12615" data-line-number="12615"></td>
        <td id="LC12615">                    }</td>
      </tr>
      <tr>
        <td id="L12616" data-line-number="12616"></td>
        <td id="LC12616">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12617" data-line-number="12617"></td>
        <td id="LC12617">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12618" data-line-number="12618"></td>
        <td id="LC12618">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L12619" data-line-number="12619"></td>
        <td id="LC12619">                <span>case</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>:</td>
      </tr>
      <tr>
        <td id="L12620" data-line-number="12620"></td>
        <td id="LC12620">                    {</td>
      </tr>
      <tr>
        <td id="L12621" data-line-number="12621"></td>
        <td id="LC12621">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isDataFeed</span> <span>||</span> (<span>value</span> <span>is</span> <span>TextDataFeed</span> <span>||</span> <span>value</span> <span>is</span> <span>XmlDataFeed</span>), <span><span>"</span>Value must be a TextReader or XmlReader<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12622" data-line-number="12622"></td>
        <td id="LC12622">                        <span>Debug</span>.<span>Assert</span>(<span>isDataFeed</span> <span>||</span> (<span>value</span> <span>is</span> <span>string</span> <span>||</span> <span>value</span> <span>is</span> <span>byte</span>[]), <span><span>"</span>Value is a byte array or string<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12623" data-line-number="12623"></td>
        <td id="LC12623">
</td>
      </tr>
      <tr>
        <td id="L12624" data-line-number="12624"></td>
        <td id="LC12624">                        <span>if</span> (<span>isDataFeed</span>)</td>
      </tr>
      <tr>
        <td id="L12625" data-line-number="12625"></td>
        <td id="LC12625">                        {</td>
      </tr>
      <tr>
        <td id="L12626" data-line-number="12626"></td>
        <td id="LC12626">                            <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>IsPlp</span>, <span><span>"</span>Stream assigned to non-PLP was not converted!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12627" data-line-number="12627"></td>
        <td id="LC12627">                            <span>TextDataFeed</span> <span>tdf</span> <span>=</span> <span>value</span> <span>as</span> <span>TextDataFeed</span>;</td>
      </tr>
      <tr>
        <td id="L12628" data-line-number="12628"></td>
        <td id="LC12628">                            <span>if</span> (<span>tdf</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L12629" data-line-number="12629"></td>
        <td id="LC12629">                            {</td>
      </tr>
      <tr>
        <td id="L12630" data-line-number="12630"></td>
        <td id="LC12630">                                <span>return</span> <span>NullIfCompletedWriteTask</span>(<span>WriteXmlFeed</span>((<span>XmlDataFeed</span>)<span>value</span>, <span>stateObj</span>, <span>IsBOMNeeded</span>(<span>type</span>, <span>value</span>), <span>Encoding</span>.<span>Unicode</span>, <span>paramSize</span>));</td>
      </tr>
      <tr>
        <td id="L12631" data-line-number="12631"></td>
        <td id="LC12631">                            }</td>
      </tr>
      <tr>
        <td id="L12632" data-line-number="12632"></td>
        <td id="LC12632">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L12633" data-line-number="12633"></td>
        <td id="LC12633">                            {</td>
      </tr>
      <tr>
        <td id="L12634" data-line-number="12634"></td>
        <td id="LC12634">                                <span>return</span> <span>NullIfCompletedWriteTask</span>(<span>WriteTextFeed</span>(<span>tdf</span>, <span>null</span>, <span>IsBOMNeeded</span>(<span>type</span>, <span>value</span>), <span>stateObj</span>, <span>paramSize</span>));</td>
      </tr>
      <tr>
        <td id="L12635" data-line-number="12635"></td>
        <td id="LC12635">                            }</td>
      </tr>
      <tr>
        <td id="L12636" data-line-number="12636"></td>
        <td id="LC12636">                        }</td>
      </tr>
      <tr>
        <td id="L12637" data-line-number="12637"></td>
        <td id="LC12637">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12638" data-line-number="12638"></td>
        <td id="LC12638">                        {</td>
      </tr>
      <tr>
        <td id="L12639" data-line-number="12639"></td>
        <td id="LC12639">                            <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L12640" data-line-number="12640"></td>
        <td id="LC12640">                            {</td>
      </tr>
      <tr>
        <td id="L12641" data-line-number="12641"></td>
        <td id="LC12641">                                <span>if</span> (<span>IsBOMNeeded</span>(<span>type</span>, <span>value</span>))</td>
      </tr>
      <tr>
        <td id="L12642" data-line-number="12642"></td>
        <td id="LC12642">                                {</td>
      </tr>
      <tr>
        <td id="L12643" data-line-number="12643"></td>
        <td id="LC12643">                                    <span>WriteInt</span>(<span>actualLength</span> <span>+</span> <span>2</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L12644" data-line-number="12644"></td>
        <td id="LC12644">                                    <span>WriteShort</span>(<span>TdsEnums</span>.<span>XMLUNICODEBOM</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12645" data-line-number="12645"></td>
        <td id="LC12645">                                }</td>
      </tr>
      <tr>
        <td id="L12646" data-line-number="12646"></td>
        <td id="LC12646">                                <span>else</span></td>
      </tr>
      <tr>
        <td id="L12647" data-line-number="12647"></td>
        <td id="LC12647">                                {</td>
      </tr>
      <tr>
        <td id="L12648" data-line-number="12648"></td>
        <td id="LC12648">                                    <span>WriteInt</span>(<span>actualLength</span>, <span>stateObj</span>);               <span><span>//</span> chunk length</span></td>
      </tr>
      <tr>
        <td id="L12649" data-line-number="12649"></td>
        <td id="LC12649">                                }</td>
      </tr>
      <tr>
        <td id="L12650" data-line-number="12650"></td>
        <td id="LC12650">                            }</td>
      </tr>
      <tr>
        <td id="L12651" data-line-number="12651"></td>
        <td id="LC12651">                            <span>if</span> (<span>value</span> <span>is</span> <span>byte</span>[])</td>
      </tr>
      <tr>
        <td id="L12652" data-line-number="12652"></td>
        <td id="LC12652">                            { <span><span>//</span> If LazyMat non-filled blob, send cookie rather than value</span></td>
      </tr>
      <tr>
        <td id="L12653" data-line-number="12653"></td>
        <td id="LC12653">                                <span>return</span> <span>stateObj</span>.<span>WriteByteArray</span>((<span>byte</span>[])<span>value</span>, <span>actualLength</span>, <span>0</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12654" data-line-number="12654"></td>
        <td id="LC12654">                            }</td>
      </tr>
      <tr>
        <td id="L12655" data-line-number="12655"></td>
        <td id="LC12655">                            <span>else</span></td>
      </tr>
      <tr>
        <td id="L12656" data-line-number="12656"></td>
        <td id="LC12656">                            {</td>
      </tr>
      <tr>
        <td id="L12657" data-line-number="12657"></td>
        <td id="LC12657">                                <span><span>//</span> convert to cchars instead of cbytes</span></td>
      </tr>
      <tr>
        <td id="L12658" data-line-number="12658"></td>
        <td id="LC12658">                                <span>actualLength</span> <span>&gt;&gt;=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L12659" data-line-number="12659"></td>
        <td id="LC12659">                                <span>return</span> <span>WriteString</span>((<span>string</span>)<span>value</span>, <span>actualLength</span>, <span>offset</span>, <span>stateObj</span>, <span>canAccumulate</span>: <span>false</span>);</td>
      </tr>
      <tr>
        <td id="L12660" data-line-number="12660"></td>
        <td id="LC12660">                            }</td>
      </tr>
      <tr>
        <td id="L12661" data-line-number="12661"></td>
        <td id="LC12661">                        }</td>
      </tr>
      <tr>
        <td id="L12662" data-line-number="12662"></td>
        <td id="LC12662">                    }</td>
      </tr>
      <tr>
        <td id="L12663" data-line-number="12663"></td>
        <td id="LC12663">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L12664" data-line-number="12664"></td>
        <td id="LC12664">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>&lt;=</span> <span>17</span>, <span><span>"</span>Decimal length cannot be greater than 17 bytes<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12665" data-line-number="12665"></td>
        <td id="LC12665">                    <span>WriteDecimal</span>((<span>Decimal</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12666" data-line-number="12666"></td>
        <td id="LC12666">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12667" data-line-number="12667"></td>
        <td id="LC12667">
</td>
      </tr>
      <tr>
        <td id="L12668" data-line-number="12668"></td>
        <td id="LC12668">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMN</span>:</td>
      </tr>
      <tr>
        <td id="L12669" data-line-number="12669"></td>
        <td id="LC12669">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>&lt;=</span> <span>0xff</span>, <span><span>"</span>Invalid Fixed Length<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12670" data-line-number="12670"></td>
        <td id="LC12670">
</td>
      </tr>
      <tr>
        <td id="L12671" data-line-number="12671"></td>
        <td id="LC12671">                    <span>TdsDateTime</span> <span>dt</span> <span>=</span> <span>MetaType</span>.<span>FromDateTime</span>((<span>DateTime</span>)<span>value</span>, (<span>byte</span>)<span>type</span>.<span>FixedLength</span>);</td>
      </tr>
      <tr>
        <td id="L12672" data-line-number="12672"></td>
        <td id="LC12672">
</td>
      </tr>
      <tr>
        <td id="L12673" data-line-number="12673"></td>
        <td id="LC12673">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L12674" data-line-number="12674"></td>
        <td id="LC12674">                    {</td>
      </tr>
      <tr>
        <td id="L12675" data-line-number="12675"></td>
        <td id="LC12675">                        <span>if</span> (<span>0</span> <span>&gt;</span> <span>dt</span>.<span>days</span> <span>||</span> <span>dt</span>.<span>days</span> <span>&gt;</span> <span>UInt16</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L12676" data-line-number="12676"></td>
        <td id="LC12676">                            <span>throw</span> <span>SQL</span>.<span>SmallDateTimeOverflow</span>(<span>MetaType</span>.<span>ToDateTime</span>(<span>dt</span>.<span>days</span>, <span>dt</span>.<span>time</span>, <span>4</span>).<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L12677" data-line-number="12677"></td>
        <td id="LC12677">
</td>
      </tr>
      <tr>
        <td id="L12678" data-line-number="12678"></td>
        <td id="LC12678">                        <span>WriteShort</span>(<span>dt</span>.<span>days</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12679" data-line-number="12679"></td>
        <td id="LC12679">                        <span>WriteShort</span>(<span>dt</span>.<span>time</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12680" data-line-number="12680"></td>
        <td id="LC12680">                    }</td>
      </tr>
      <tr>
        <td id="L12681" data-line-number="12681"></td>
        <td id="LC12681">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L12682" data-line-number="12682"></td>
        <td id="LC12682">                    {</td>
      </tr>
      <tr>
        <td id="L12683" data-line-number="12683"></td>
        <td id="LC12683">                        <span>WriteInt</span>(<span>dt</span>.<span>days</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12684" data-line-number="12684"></td>
        <td id="LC12684">                        <span>WriteInt</span>(<span>dt</span>.<span>time</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12685" data-line-number="12685"></td>
        <td id="LC12685">                    }</td>
      </tr>
      <tr>
        <td id="L12686" data-line-number="12686"></td>
        <td id="LC12686">
</td>
      </tr>
      <tr>
        <td id="L12687" data-line-number="12687"></td>
        <td id="LC12687">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12688" data-line-number="12688"></td>
        <td id="LC12688">
</td>
      </tr>
      <tr>
        <td id="L12689" data-line-number="12689"></td>
        <td id="LC12689">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEYN</span>:</td>
      </tr>
      <tr>
        <td id="L12690" data-line-number="12690"></td>
        <td id="LC12690">                    {</td>
      </tr>
      <tr>
        <td id="L12691" data-line-number="12691"></td>
        <td id="LC12691">                        <span>WriteCurrency</span>((<span>Decimal</span>)<span>value</span>, <span>type</span>.<span>FixedLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12692" data-line-number="12692"></td>
        <td id="LC12692">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12693" data-line-number="12693"></td>
        <td id="LC12693">                    }</td>
      </tr>
      <tr>
        <td id="L12694" data-line-number="12694"></td>
        <td id="LC12694">
</td>
      </tr>
      <tr>
        <td id="L12695" data-line-number="12695"></td>
        <td id="LC12695">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATE</span>:</td>
      </tr>
      <tr>
        <td id="L12696" data-line-number="12696"></td>
        <td id="LC12696">                    {</td>
      </tr>
      <tr>
        <td id="L12697" data-line-number="12697"></td>
        <td id="LC12697">                        <span>WriteDate</span>((<span>DateTime</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12698" data-line-number="12698"></td>
        <td id="LC12698">                        <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12699" data-line-number="12699"></td>
        <td id="LC12699">                    }</td>
      </tr>
      <tr>
        <td id="L12700" data-line-number="12700"></td>
        <td id="LC12700">
</td>
      </tr>
      <tr>
        <td id="L12701" data-line-number="12701"></td>
        <td id="LC12701">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L12702" data-line-number="12702"></td>
        <td id="LC12702">                    <span>if</span> (<span>scale</span> <span>&gt;</span> <span>TdsEnums</span>.<span>DEFAULT_VARTIME_SCALE</span>)</td>
      </tr>
      <tr>
        <td id="L12703" data-line-number="12703"></td>
        <td id="LC12703">                    {</td>
      </tr>
      <tr>
        <td id="L12704" data-line-number="12704"></td>
        <td id="LC12704">                        <span>throw</span> <span>SQL</span>.<span>TimeScaleValueOutOfRange</span>(<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L12705" data-line-number="12705"></td>
        <td id="LC12705">                    }</td>
      </tr>
      <tr>
        <td id="L12706" data-line-number="12706"></td>
        <td id="LC12706">                    <span>WriteTime</span>((<span>TimeSpan</span>)<span>value</span>, <span>scale</span>, <span>actualLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12707" data-line-number="12707"></td>
        <td id="LC12707">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12708" data-line-number="12708"></td>
        <td id="LC12708">
</td>
      </tr>
      <tr>
        <td id="L12709" data-line-number="12709"></td>
        <td id="LC12709">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME2</span>:</td>
      </tr>
      <tr>
        <td id="L12710" data-line-number="12710"></td>
        <td id="LC12710">                    <span>if</span> (<span>scale</span> <span>&gt;</span> <span>TdsEnums</span>.<span>DEFAULT_VARTIME_SCALE</span>)</td>
      </tr>
      <tr>
        <td id="L12711" data-line-number="12711"></td>
        <td id="LC12711">                    {</td>
      </tr>
      <tr>
        <td id="L12712" data-line-number="12712"></td>
        <td id="LC12712">                        <span>throw</span> <span>SQL</span>.<span>TimeScaleValueOutOfRange</span>(<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L12713" data-line-number="12713"></td>
        <td id="LC12713">                    }</td>
      </tr>
      <tr>
        <td id="L12714" data-line-number="12714"></td>
        <td id="LC12714">                    <span>WriteDateTime2</span>((<span>DateTime</span>)<span>value</span>, <span>scale</span>, <span>actualLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12715" data-line-number="12715"></td>
        <td id="LC12715">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12716" data-line-number="12716"></td>
        <td id="LC12716">
</td>
      </tr>
      <tr>
        <td id="L12717" data-line-number="12717"></td>
        <td id="LC12717">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L12718" data-line-number="12718"></td>
        <td id="LC12718">                    <span>WriteDateTimeOffset</span>((<span>DateTimeOffset</span>)<span>value</span>, <span>scale</span>, <span>actualLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12719" data-line-number="12719"></td>
        <td id="LC12719">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12720" data-line-number="12720"></td>
        <td id="LC12720">
</td>
      </tr>
      <tr>
        <td id="L12721" data-line-number="12721"></td>
        <td id="LC12721">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L12722" data-line-number="12722"></td>
        <td id="LC12722">                    <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Unknown TdsType!<span>"</span></span> <span>+</span> <span>type</span>.<span>NullableType</span>.<span>ToString</span>(<span><span>"</span>x2<span>"</span></span>, (<span>IFormatProvider</span>)<span>null</span>));</td>
      </tr>
      <tr>
        <td id="L12723" data-line-number="12723"></td>
        <td id="LC12723">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L12724" data-line-number="12724"></td>
        <td id="LC12724">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L12725" data-line-number="12725"></td>
        <td id="LC12725">            <span><span>//</span> return point for accumualated writes, note: non-accumulated writes returned from their case statements</span></td>
      </tr>
      <tr>
        <td id="L12726" data-line-number="12726"></td>
        <td id="LC12726">            <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12727" data-line-number="12727"></td>
        <td id="LC12727">            <span><span>//</span> Debug.WriteLine("value:  " + value.ToString(CultureInfo.InvariantCulture));</span></td>
      </tr>
      <tr>
        <td id="L12728" data-line-number="12728"></td>
        <td id="LC12728">        }</td>
      </tr>
      <tr>
        <td id="L12729" data-line-number="12729"></td>
        <td id="LC12729">
</td>
      </tr>
      <tr>
        <td id="L12730" data-line-number="12730"></td>
        <td id="LC12730">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L12731" data-line-number="12731"></td>
        <td id="LC12731">        <span><span>///</span> Write parameter encryption metadata and returns a task if necessary.</span></td>
      </tr>
      <tr>
        <td id="L12732" data-line-number="12732"></td>
        <td id="LC12732">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L12733" data-line-number="12733"></td>
        <td id="LC12733">        <span>private</span> <span>Task</span> <span>WriteEncryptionMetadata</span>(<span>Task</span> <span>terminatedWriteTask</span>, <span>SqlColumnEncryptionInputParameterInfo</span> <span>columnEncryptionParameterInfo</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L12734" data-line-number="12734"></td>
        <td id="LC12734">        {</td>
      </tr>
      <tr>
        <td id="L12735" data-line-number="12735"></td>
        <td id="LC12735">            <span>Debug</span>.<span>Assert</span>(<span>columnEncryptionParameterInfo</span> <span>!=</span> <span>null</span>, <span><span>@"</span>columnEncryptionParameterInfo cannot be null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12736" data-line-number="12736"></td>
        <td id="LC12736">            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span> <span>!=</span> <span>null</span>, <span><span>@"</span>stateObj cannot be null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12737" data-line-number="12737"></td>
        <td id="LC12737">
</td>
      </tr>
      <tr>
        <td id="L12738" data-line-number="12738"></td>
        <td id="LC12738">            <span><span>//</span> If there is not task already, simply write the encryption metadata synchronously.</span></td>
      </tr>
      <tr>
        <td id="L12739" data-line-number="12739"></td>
        <td id="LC12739">            <span>if</span> (<span>terminatedWriteTask</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L12740" data-line-number="12740"></td>
        <td id="LC12740">            {</td>
      </tr>
      <tr>
        <td id="L12741" data-line-number="12741"></td>
        <td id="LC12741">                <span>WriteEncryptionMetadata</span>(<span>columnEncryptionParameterInfo</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12742" data-line-number="12742"></td>
        <td id="LC12742">                <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L12743" data-line-number="12743"></td>
        <td id="LC12743">            }</td>
      </tr>
      <tr>
        <td id="L12744" data-line-number="12744"></td>
        <td id="LC12744">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L12745" data-line-number="12745"></td>
        <td id="LC12745">            {</td>
      </tr>
      <tr>
        <td id="L12746" data-line-number="12746"></td>
        <td id="LC12746">                <span><span>//</span> Otherwise, create a continuation task to write the encryption metadata after the previous write completes.</span></td>
      </tr>
      <tr>
        <td id="L12747" data-line-number="12747"></td>
        <td id="LC12747">                <span>return</span> <span>AsyncHelper</span>.<span>CreateContinuationTask</span>&lt;<span>SqlColumnEncryptionInputParameterInfo</span>, <span>TdsParserStateObject</span>&gt;(<span>terminatedWriteTask</span>,</td>
      </tr>
      <tr>
        <td id="L12748" data-line-number="12748"></td>
        <td id="LC12748">                    <span>WriteEncryptionMetadata</span>, <span>columnEncryptionParameterInfo</span>, <span>stateObj</span>,</td>
      </tr>
      <tr>
        <td id="L12749" data-line-number="12749"></td>
        <td id="LC12749">                    <span>connectionToDoom</span>: <span>_connHandler</span>);</td>
      </tr>
      <tr>
        <td id="L12750" data-line-number="12750"></td>
        <td id="LC12750">            }</td>
      </tr>
      <tr>
        <td id="L12751" data-line-number="12751"></td>
        <td id="LC12751">        }</td>
      </tr>
      <tr>
        <td id="L12752" data-line-number="12752"></td>
        <td id="LC12752">
</td>
      </tr>
      <tr>
        <td id="L12753" data-line-number="12753"></td>
        <td id="LC12753">        <span><span>///</span> &lt;<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L12754" data-line-number="12754"></td>
        <td id="LC12754">        <span><span>///</span> Write parameter encryption metadata.</span></td>
      </tr>
      <tr>
        <td id="L12755" data-line-number="12755"></td>
        <td id="LC12755">        <span><span>///</span> &lt;/<span><span>summary</span></span>&gt;</span></td>
      </tr>
      <tr>
        <td id="L12756" data-line-number="12756"></td>
        <td id="LC12756">        <span>private</span> <span>void</span> <span>WriteEncryptionMetadata</span>(<span>SqlColumnEncryptionInputParameterInfo</span> <span>columnEncryptionParameterInfo</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L12757" data-line-number="12757"></td>
        <td id="LC12757">        {</td>
      </tr>
      <tr>
        <td id="L12758" data-line-number="12758"></td>
        <td id="LC12758">            <span>Debug</span>.<span>Assert</span>(<span>columnEncryptionParameterInfo</span> <span>!=</span> <span>null</span>, <span><span>@"</span>columnEncryptionParameterInfo cannot be null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12759" data-line-number="12759"></td>
        <td id="LC12759">            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span> <span>!=</span> <span>null</span>, <span><span>@"</span>stateObj cannot be null<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12760" data-line-number="12760"></td>
        <td id="LC12760">
</td>
      </tr>
      <tr>
        <td id="L12761" data-line-number="12761"></td>
        <td id="LC12761">            <span><span>//</span> Write the TypeInfo.</span></td>
      </tr>
      <tr>
        <td id="L12762" data-line-number="12762"></td>
        <td id="LC12762">            <span>WriteSmiTypeInfo</span>(<span>columnEncryptionParameterInfo</span>.<span>ParameterMetadata</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12763" data-line-number="12763"></td>
        <td id="LC12763">
</td>
      </tr>
      <tr>
        <td id="L12764" data-line-number="12764"></td>
        <td id="LC12764">            <span><span>//</span> Write the serialized array in columnEncryptionParameterInfo.</span></td>
      </tr>
      <tr>
        <td id="L12765" data-line-number="12765"></td>
        <td id="LC12765">            <span>stateObj</span>.<span>WriteByteArray</span>(<span>columnEncryptionParameterInfo</span>.<span>SerializedWireFormat</span>,</td>
      </tr>
      <tr>
        <td id="L12766" data-line-number="12766"></td>
        <td id="LC12766">                                    <span>columnEncryptionParameterInfo</span>.<span>SerializedWireFormat</span>.<span>Length</span>,</td>
      </tr>
      <tr>
        <td id="L12767" data-line-number="12767"></td>
        <td id="LC12767">                                    <span>offsetBuffer</span>: <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L12768" data-line-number="12768"></td>
        <td id="LC12768">        }</td>
      </tr>
      <tr>
        <td id="L12769" data-line-number="12769"></td>
        <td id="LC12769">
</td>
      </tr>
      <tr>
        <td id="L12770" data-line-number="12770"></td>
        <td id="LC12770">        <span><span>//</span> For MAX types, this method can only write everything in one big chunk. If multiple</span></td>
      </tr>
      <tr>
        <td id="L12771" data-line-number="12771"></td>
        <td id="LC12771">        <span><span>//</span> chunk writes needed, please use WritePlpBytes/WritePlpChars</span></td>
      </tr>
      <tr>
        <td id="L12772" data-line-number="12772"></td>
        <td id="LC12772">        <span>private</span> <span>byte</span>[] <span>SerializeUnencryptedValue</span>(<span>object</span> <span>value</span>, <span>MetaType</span> <span>type</span>, <span>byte</span> <span>scale</span>, <span>int</span> <span>actualLength</span>, <span>int</span> <span>offset</span>, <span>bool</span> <span>isDataFeed</span>, <span>byte</span> <span>normalizationVersion</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L12773" data-line-number="12773"></td>
        <td id="LC12773">        {</td>
      </tr>
      <tr>
        <td id="L12774" data-line-number="12774"></td>
        <td id="LC12774">            <span>Debug</span>.<span>Assert</span>((<span>null</span> <span>!=</span> <span>value</span>) <span>&amp;&amp;</span> (<span>DBNull</span>.<span>Value</span> <span>!=</span> <span>value</span>), <span><span>"</span>unexpected missing or empty object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12775" data-line-number="12775"></td>
        <td id="LC12775">
</td>
      </tr>
      <tr>
        <td id="L12776" data-line-number="12776"></td>
        <td id="LC12776">            <span>if</span> (<span>normalizationVersion</span> <span>!=</span> <span>0x01</span>)</td>
      </tr>
      <tr>
        <td id="L12777" data-line-number="12777"></td>
        <td id="LC12777">            {</td>
      </tr>
      <tr>
        <td id="L12778" data-line-number="12778"></td>
        <td id="LC12778">                <span>throw</span> <span>SQL</span>.<span>UnsupportedNormalizationVersion</span>(<span>normalizationVersion</span>);</td>
      </tr>
      <tr>
        <td id="L12779" data-line-number="12779"></td>
        <td id="LC12779">            }</td>
      </tr>
      <tr>
        <td id="L12780" data-line-number="12780"></td>
        <td id="LC12780">
</td>
      </tr>
      <tr>
        <td id="L12781" data-line-number="12781"></td>
        <td id="LC12781">            <span><span>//</span> parameters are always sent over as BIG or N types</span></td>
      </tr>
      <tr>
        <td id="L12782" data-line-number="12782"></td>
        <td id="LC12782">            <span>switch</span> (<span>type</span>.<span>NullableType</span>)</td>
      </tr>
      <tr>
        <td id="L12783" data-line-number="12783"></td>
        <td id="LC12783">            {</td>
      </tr>
      <tr>
        <td id="L12784" data-line-number="12784"></td>
        <td id="LC12784">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLTN</span>:</td>
      </tr>
      <tr>
        <td id="L12785" data-line-number="12785"></td>
        <td id="LC12785">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L12786" data-line-number="12786"></td>
        <td id="LC12786">                        <span>return</span> <span>SerializeFloat</span>((<span>Single</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L12787" data-line-number="12787"></td>
        <td id="LC12787">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L12788" data-line-number="12788"></td>
        <td id="LC12788">                    {</td>
      </tr>
      <tr>
        <td id="L12789" data-line-number="12789"></td>
        <td id="LC12789">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>Invalid length for SqlDouble type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12790" data-line-number="12790"></td>
        <td id="LC12790">                        <span>return</span> <span>SerializeDouble</span>((<span>Double</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L12791" data-line-number="12791"></td>
        <td id="LC12791">                    }</td>
      </tr>
      <tr>
        <td id="L12792" data-line-number="12792"></td>
        <td id="LC12792">
</td>
      </tr>
      <tr>
        <td id="L12793" data-line-number="12793"></td>
        <td id="LC12793">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L12794" data-line-number="12794"></td>
        <td id="LC12794">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L12795" data-line-number="12795"></td>
        <td id="LC12795">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L12796" data-line-number="12796"></td>
        <td id="LC12796">                <span>case</span> <span>TdsEnums</span>.<span>SQLUDT</span>:</td>
      </tr>
      <tr>
        <td id="L12797" data-line-number="12797"></td>
        <td id="LC12797">                    {</td>
      </tr>
      <tr>
        <td id="L12798" data-line-number="12798"></td>
        <td id="LC12798">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isDataFeed</span>, <span><span>"</span>We cannot seriliaze streams<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12799" data-line-number="12799"></td>
        <td id="LC12799">                        <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>byte</span>[], <span><span>"</span>Value should be an array of bytes<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12800" data-line-number="12800"></td>
        <td id="LC12800">
</td>
      </tr>
      <tr>
        <td id="L12801" data-line-number="12801"></td>
        <td id="LC12801">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>actualLength</span>];</td>
      </tr>
      <tr>
        <td id="L12802" data-line-number="12802"></td>
        <td id="LC12802">                        <span>Buffer</span>.<span>BlockCopy</span>((<span>byte</span>[])<span>value</span>, <span>offset</span>, <span>b</span>, <span>0</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L12803" data-line-number="12803"></td>
        <td id="LC12803">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L12804" data-line-number="12804"></td>
        <td id="LC12804">                    }</td>
      </tr>
      <tr>
        <td id="L12805" data-line-number="12805"></td>
        <td id="LC12805">
</td>
      </tr>
      <tr>
        <td id="L12806" data-line-number="12806"></td>
        <td id="LC12806">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L12807" data-line-number="12807"></td>
        <td id="LC12807">                    {</td>
      </tr>
      <tr>
        <td id="L12808" data-line-number="12808"></td>
        <td id="LC12808">                        <span>System</span>.<span>Guid</span> <span>guid</span> <span>=</span> (<span>System</span>.<span>Guid</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L12809" data-line-number="12809"></td>
        <td id="LC12809">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>guid</span>.<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L12810" data-line-number="12810"></td>
        <td id="LC12810">
</td>
      </tr>
      <tr>
        <td id="L12811" data-line-number="12811"></td>
        <td id="LC12811">                        <span>Debug</span>.<span>Assert</span>((<span>actualLength</span> <span>==</span> <span>b</span>.<span>Length</span>) <span>&amp;&amp;</span> (<span>actualLength</span> <span>==</span> <span>16</span>), <span><span>"</span>Invalid length for guid type in com+ object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12812" data-line-number="12812"></td>
        <td id="LC12812">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L12813" data-line-number="12813"></td>
        <td id="LC12813">                    }</td>
      </tr>
      <tr>
        <td id="L12814" data-line-number="12814"></td>
        <td id="LC12814">
</td>
      </tr>
      <tr>
        <td id="L12815" data-line-number="12815"></td>
        <td id="LC12815">                <span>case</span> <span>TdsEnums</span>.<span>SQLBITN</span>:</td>
      </tr>
      <tr>
        <td id="L12816" data-line-number="12816"></td>
        <td id="LC12816">                    {</td>
      </tr>
      <tr>
        <td id="L12817" data-line-number="12817"></td>
        <td id="LC12817">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>, <span><span>"</span>Invalid length for SqlBoolean type<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12818" data-line-number="12818"></td>
        <td id="LC12818">
</td>
      </tr>
      <tr>
        <td id="L12819" data-line-number="12819"></td>
        <td id="LC12819">                        <span><span>//</span> We normalize to allow conversion across data types. BIT is serialized into a BIGINT.</span></td>
      </tr>
      <tr>
        <td id="L12820" data-line-number="12820"></td>
        <td id="LC12820">                        <span>return</span> <span>SerializeLong</span>((<span>bool</span>)<span>value</span> <span>==</span> <span>true</span> <span>?</span> <span>1</span> <span>:</span> <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12821" data-line-number="12821"></td>
        <td id="LC12821">                    }</td>
      </tr>
      <tr>
        <td id="L12822" data-line-number="12822"></td>
        <td id="LC12822">
</td>
      </tr>
      <tr>
        <td id="L12823" data-line-number="12823"></td>
        <td id="LC12823">                <span>case</span> <span>TdsEnums</span>.<span>SQLINTN</span>:</td>
      </tr>
      <tr>
        <td id="L12824" data-line-number="12824"></td>
        <td id="LC12824">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L12825" data-line-number="12825"></td>
        <td id="LC12825">                        <span>return</span> <span>SerializeLong</span>((<span>byte</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12826" data-line-number="12826"></td>
        <td id="LC12826">
</td>
      </tr>
      <tr>
        <td id="L12827" data-line-number="12827"></td>
        <td id="LC12827">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>2</span>)</td>
      </tr>
      <tr>
        <td id="L12828" data-line-number="12828"></td>
        <td id="LC12828">                        <span>return</span> <span>SerializeLong</span>((<span>Int16</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12829" data-line-number="12829"></td>
        <td id="LC12829">
</td>
      </tr>
      <tr>
        <td id="L12830" data-line-number="12830"></td>
        <td id="LC12830">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L12831" data-line-number="12831"></td>
        <td id="LC12831">                        <span>return</span> <span>SerializeLong</span>((<span>Int32</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12832" data-line-number="12832"></td>
        <td id="LC12832">
</td>
      </tr>
      <tr>
        <td id="L12833" data-line-number="12833"></td>
        <td id="LC12833">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for SqlIntN type:  <span>"</span></span> <span>+</span> <span>type</span>.<span>FixedLength</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L12834" data-line-number="12834"></td>
        <td id="LC12834">                    <span>return</span> <span>SerializeLong</span>((<span>Int64</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12835" data-line-number="12835"></td>
        <td id="LC12835">
</td>
      </tr>
      <tr>
        <td id="L12836" data-line-number="12836"></td>
        <td id="LC12836">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12837" data-line-number="12837"></td>
        <td id="LC12837">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12838" data-line-number="12838"></td>
        <td id="LC12838">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L12839" data-line-number="12839"></td>
        <td id="LC12839">                    {</td>
      </tr>
      <tr>
        <td id="L12840" data-line-number="12840"></td>
        <td id="LC12840">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isDataFeed</span>, <span><span>"</span>We cannot seriliaze streams<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12841" data-line-number="12841"></td>
        <td id="LC12841">                        <span>Debug</span>.<span>Assert</span>((<span>value</span> <span>is</span> <span>string</span> <span>||</span> <span>value</span> <span>is</span> <span>byte</span>[]), <span><span>"</span>Value is a byte array or string<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12842" data-line-number="12842"></td>
        <td id="LC12842">
</td>
      </tr>
      <tr>
        <td id="L12843" data-line-number="12843"></td>
        <td id="LC12843">                        <span>if</span> (<span>value</span> <span>is</span> <span>byte</span>[])</td>
      </tr>
      <tr>
        <td id="L12844" data-line-number="12844"></td>
        <td id="LC12844">                        { <span><span>//</span> If LazyMat non-filled blob, send cookie rather than value</span></td>
      </tr>
      <tr>
        <td id="L12845" data-line-number="12845"></td>
        <td id="LC12845">                            <span>byte</span>[] <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>actualLength</span>];</td>
      </tr>
      <tr>
        <td id="L12846" data-line-number="12846"></td>
        <td id="LC12846">                            <span>Buffer</span>.<span>BlockCopy</span>((<span>byte</span>[])<span>value</span>, <span>0</span>, <span>b</span>, <span>0</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L12847" data-line-number="12847"></td>
        <td id="LC12847">                            <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L12848" data-line-number="12848"></td>
        <td id="LC12848">                        }</td>
      </tr>
      <tr>
        <td id="L12849" data-line-number="12849"></td>
        <td id="LC12849">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12850" data-line-number="12850"></td>
        <td id="LC12850">                        {</td>
      </tr>
      <tr>
        <td id="L12851" data-line-number="12851"></td>
        <td id="LC12851">                            <span>return</span> <span>SerializeEncodingChar</span>((<span>string</span>)<span>value</span>, <span>actualLength</span>, <span>offset</span>, <span>_defaultEncoding</span>);</td>
      </tr>
      <tr>
        <td id="L12852" data-line-number="12852"></td>
        <td id="LC12852">                        }</td>
      </tr>
      <tr>
        <td id="L12853" data-line-number="12853"></td>
        <td id="LC12853">                    }</td>
      </tr>
      <tr>
        <td id="L12854" data-line-number="12854"></td>
        <td id="LC12854">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12855" data-line-number="12855"></td>
        <td id="LC12855">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L12856" data-line-number="12856"></td>
        <td id="LC12856">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L12857" data-line-number="12857"></td>
        <td id="LC12857">                <span>case</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>:</td>
      </tr>
      <tr>
        <td id="L12858" data-line-number="12858"></td>
        <td id="LC12858">                    {</td>
      </tr>
      <tr>
        <td id="L12859" data-line-number="12859"></td>
        <td id="LC12859">                        <span>Debug</span>.<span>Assert</span>(<span>!</span><span>isDataFeed</span>, <span><span>"</span>We cannot seriliaze streams<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12860" data-line-number="12860"></td>
        <td id="LC12860">                        <span>Debug</span>.<span>Assert</span>((<span>value</span> <span>is</span> <span>string</span> <span>||</span> <span>value</span> <span>is</span> <span>byte</span>[]), <span><span>"</span>Value is a byte array or string<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12861" data-line-number="12861"></td>
        <td id="LC12861">
</td>
      </tr>
      <tr>
        <td id="L12862" data-line-number="12862"></td>
        <td id="LC12862">                        <span>if</span> (<span>value</span> <span>is</span> <span>byte</span>[])</td>
      </tr>
      <tr>
        <td id="L12863" data-line-number="12863"></td>
        <td id="LC12863">                        { <span><span>//</span> If LazyMat non-filled blob, send cookie rather than value</span></td>
      </tr>
      <tr>
        <td id="L12864" data-line-number="12864"></td>
        <td id="LC12864">                            <span>byte</span>[] <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>actualLength</span>];</td>
      </tr>
      <tr>
        <td id="L12865" data-line-number="12865"></td>
        <td id="LC12865">                            <span>Buffer</span>.<span>BlockCopy</span>((<span>byte</span>[])<span>value</span>, <span>0</span>, <span>b</span>, <span>0</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L12866" data-line-number="12866"></td>
        <td id="LC12866">                            <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L12867" data-line-number="12867"></td>
        <td id="LC12867">                        }</td>
      </tr>
      <tr>
        <td id="L12868" data-line-number="12868"></td>
        <td id="LC12868">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12869" data-line-number="12869"></td>
        <td id="LC12869">                        { <span><span>//</span> convert to cchars instead of cbytes</span></td>
      </tr>
      <tr>
        <td id="L12870" data-line-number="12870"></td>
        <td id="LC12870">                            <span>actualLength</span> <span>&gt;&gt;=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L12871" data-line-number="12871"></td>
        <td id="LC12871">                            <span>return</span> <span>SerializeString</span>((<span>string</span>)<span>value</span>, <span>actualLength</span>, <span>offset</span>);</td>
      </tr>
      <tr>
        <td id="L12872" data-line-number="12872"></td>
        <td id="LC12872">                        }</td>
      </tr>
      <tr>
        <td id="L12873" data-line-number="12873"></td>
        <td id="LC12873">                    }</td>
      </tr>
      <tr>
        <td id="L12874" data-line-number="12874"></td>
        <td id="LC12874">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L12875" data-line-number="12875"></td>
        <td id="LC12875">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>&lt;=</span> <span>17</span>, <span><span>"</span>Decimal length cannot be greater than 17 bytes<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12876" data-line-number="12876"></td>
        <td id="LC12876">                    <span>return</span> <span>SerializeDecimal</span>((<span>Decimal</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12877" data-line-number="12877"></td>
        <td id="LC12877">
</td>
      </tr>
      <tr>
        <td id="L12878" data-line-number="12878"></td>
        <td id="LC12878">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMN</span>:</td>
      </tr>
      <tr>
        <td id="L12879" data-line-number="12879"></td>
        <td id="LC12879">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>&lt;=</span> <span>0xff</span>, <span><span>"</span>Invalid Fixed Length<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12880" data-line-number="12880"></td>
        <td id="LC12880">
</td>
      </tr>
      <tr>
        <td id="L12881" data-line-number="12881"></td>
        <td id="LC12881">                    <span>TdsDateTime</span> <span>dt</span> <span>=</span> <span>MetaType</span>.<span>FromDateTime</span>((<span>DateTime</span>)<span>value</span>, (<span>byte</span>)<span>type</span>.<span>FixedLength</span>);</td>
      </tr>
      <tr>
        <td id="L12882" data-line-number="12882"></td>
        <td id="LC12882">
</td>
      </tr>
      <tr>
        <td id="L12883" data-line-number="12883"></td>
        <td id="LC12883">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L12884" data-line-number="12884"></td>
        <td id="LC12884">                    {</td>
      </tr>
      <tr>
        <td id="L12885" data-line-number="12885"></td>
        <td id="LC12885">                        <span>if</span> (<span>0</span> <span>&gt;</span> <span>dt</span>.<span>days</span> <span>||</span> <span>dt</span>.<span>days</span> <span>&gt;</span> <span>UInt16</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L12886" data-line-number="12886"></td>
        <td id="LC12886">                            <span>throw</span> <span>SQL</span>.<span>SmallDateTimeOverflow</span>(<span>MetaType</span>.<span>ToDateTime</span>(<span>dt</span>.<span>days</span>, <span>dt</span>.<span>time</span>, <span>4</span>).<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L12887" data-line-number="12887"></td>
        <td id="LC12887">
</td>
      </tr>
      <tr>
        <td id="L12888" data-line-number="12888"></td>
        <td id="LC12888">                        <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bIntBytes</span>)</td>
      </tr>
      <tr>
        <td id="L12889" data-line-number="12889"></td>
        <td id="LC12889">                        {</td>
      </tr>
      <tr>
        <td id="L12890" data-line-number="12890"></td>
        <td id="LC12890">                            <span>stateObj</span>.<span>_bIntBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>4</span>];</td>
      </tr>
      <tr>
        <td id="L12891" data-line-number="12891"></td>
        <td id="LC12891">                        }</td>
      </tr>
      <tr>
        <td id="L12892" data-line-number="12892"></td>
        <td id="LC12892">
</td>
      </tr>
      <tr>
        <td id="L12893" data-line-number="12893"></td>
        <td id="LC12893">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>stateObj</span>.<span>_bIntBytes</span>;</td>
      </tr>
      <tr>
        <td id="L12894" data-line-number="12894"></td>
        <td id="LC12894">                        <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L12895" data-line-number="12895"></td>
        <td id="LC12895">
</td>
      </tr>
      <tr>
        <td id="L12896" data-line-number="12896"></td>
        <td id="LC12896">                        <span>byte</span>[] <span>bPart</span> <span>=</span> <span>SerializeShort</span>(<span>dt</span>.<span>days</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12897" data-line-number="12897"></td>
        <td id="LC12897">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L12898" data-line-number="12898"></td>
        <td id="LC12898">                        <span>current</span> <span>+=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L12899" data-line-number="12899"></td>
        <td id="LC12899">
</td>
      </tr>
      <tr>
        <td id="L12900" data-line-number="12900"></td>
        <td id="LC12900">                        <span>bPart</span> <span>=</span> <span>SerializeShort</span>(<span>dt</span>.<span>time</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12901" data-line-number="12901"></td>
        <td id="LC12901">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L12902" data-line-number="12902"></td>
        <td id="LC12902">
</td>
      </tr>
      <tr>
        <td id="L12903" data-line-number="12903"></td>
        <td id="LC12903">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L12904" data-line-number="12904"></td>
        <td id="LC12904">                    }</td>
      </tr>
      <tr>
        <td id="L12905" data-line-number="12905"></td>
        <td id="LC12905">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L12906" data-line-number="12906"></td>
        <td id="LC12906">                    {</td>
      </tr>
      <tr>
        <td id="L12907" data-line-number="12907"></td>
        <td id="LC12907">                        <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bLongBytes</span>)</td>
      </tr>
      <tr>
        <td id="L12908" data-line-number="12908"></td>
        <td id="LC12908">                        {</td>
      </tr>
      <tr>
        <td id="L12909" data-line-number="12909"></td>
        <td id="LC12909">                            <span>stateObj</span>.<span>_bLongBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>8</span>];</td>
      </tr>
      <tr>
        <td id="L12910" data-line-number="12910"></td>
        <td id="LC12910">                        }</td>
      </tr>
      <tr>
        <td id="L12911" data-line-number="12911"></td>
        <td id="LC12911">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>stateObj</span>.<span>_bLongBytes</span>;</td>
      </tr>
      <tr>
        <td id="L12912" data-line-number="12912"></td>
        <td id="LC12912">                        <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L12913" data-line-number="12913"></td>
        <td id="LC12913">
</td>
      </tr>
      <tr>
        <td id="L12914" data-line-number="12914"></td>
        <td id="LC12914">                        <span>byte</span>[] <span>bPart</span> <span>=</span> <span>SerializeInt</span>(<span>dt</span>.<span>days</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12915" data-line-number="12915"></td>
        <td id="LC12915">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L12916" data-line-number="12916"></td>
        <td id="LC12916">                        <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L12917" data-line-number="12917"></td>
        <td id="LC12917">
</td>
      </tr>
      <tr>
        <td id="L12918" data-line-number="12918"></td>
        <td id="LC12918">                        <span>bPart</span> <span>=</span> <span>SerializeInt</span>(<span>dt</span>.<span>time</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12919" data-line-number="12919"></td>
        <td id="LC12919">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L12920" data-line-number="12920"></td>
        <td id="LC12920">
</td>
      </tr>
      <tr>
        <td id="L12921" data-line-number="12921"></td>
        <td id="LC12921">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L12922" data-line-number="12922"></td>
        <td id="LC12922">                    }</td>
      </tr>
      <tr>
        <td id="L12923" data-line-number="12923"></td>
        <td id="LC12923">
</td>
      </tr>
      <tr>
        <td id="L12924" data-line-number="12924"></td>
        <td id="LC12924">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEYN</span>:</td>
      </tr>
      <tr>
        <td id="L12925" data-line-number="12925"></td>
        <td id="LC12925">                    {</td>
      </tr>
      <tr>
        <td id="L12926" data-line-number="12926"></td>
        <td id="LC12926">                        <span>return</span> <span>SerializeCurrency</span>((<span>Decimal</span>)<span>value</span>, <span>type</span>.<span>FixedLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L12927" data-line-number="12927"></td>
        <td id="LC12927">                    }</td>
      </tr>
      <tr>
        <td id="L12928" data-line-number="12928"></td>
        <td id="LC12928">
</td>
      </tr>
      <tr>
        <td id="L12929" data-line-number="12929"></td>
        <td id="LC12929">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATE</span>:</td>
      </tr>
      <tr>
        <td id="L12930" data-line-number="12930"></td>
        <td id="LC12930">                    {</td>
      </tr>
      <tr>
        <td id="L12931" data-line-number="12931"></td>
        <td id="LC12931">                        <span>return</span> <span>SerializeDate</span>((<span>DateTime</span>)<span>value</span>);</td>
      </tr>
      <tr>
        <td id="L12932" data-line-number="12932"></td>
        <td id="LC12932">                    }</td>
      </tr>
      <tr>
        <td id="L12933" data-line-number="12933"></td>
        <td id="LC12933">
</td>
      </tr>
      <tr>
        <td id="L12934" data-line-number="12934"></td>
        <td id="LC12934">                <span>case</span> <span>TdsEnums</span>.<span>SQLTIME</span>:</td>
      </tr>
      <tr>
        <td id="L12935" data-line-number="12935"></td>
        <td id="LC12935">                    <span>if</span> (<span>scale</span> <span>&gt;</span> <span>TdsEnums</span>.<span>DEFAULT_VARTIME_SCALE</span>)</td>
      </tr>
      <tr>
        <td id="L12936" data-line-number="12936"></td>
        <td id="LC12936">                    {</td>
      </tr>
      <tr>
        <td id="L12937" data-line-number="12937"></td>
        <td id="LC12937">                        <span>throw</span> <span>SQL</span>.<span>TimeScaleValueOutOfRange</span>(<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L12938" data-line-number="12938"></td>
        <td id="LC12938">                    }</td>
      </tr>
      <tr>
        <td id="L12939" data-line-number="12939"></td>
        <td id="LC12939">                    <span>return</span> <span>SerializeTime</span>((<span>TimeSpan</span>)<span>value</span>, <span>scale</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L12940" data-line-number="12940"></td>
        <td id="LC12940">
</td>
      </tr>
      <tr>
        <td id="L12941" data-line-number="12941"></td>
        <td id="LC12941">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIME2</span>:</td>
      </tr>
      <tr>
        <td id="L12942" data-line-number="12942"></td>
        <td id="LC12942">                    <span>if</span> (<span>scale</span> <span>&gt;</span> <span>TdsEnums</span>.<span>DEFAULT_VARTIME_SCALE</span>)</td>
      </tr>
      <tr>
        <td id="L12943" data-line-number="12943"></td>
        <td id="LC12943">                    {</td>
      </tr>
      <tr>
        <td id="L12944" data-line-number="12944"></td>
        <td id="LC12944">                        <span>throw</span> <span>SQL</span>.<span>TimeScaleValueOutOfRange</span>(<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L12945" data-line-number="12945"></td>
        <td id="LC12945">                    }</td>
      </tr>
      <tr>
        <td id="L12946" data-line-number="12946"></td>
        <td id="LC12946">                    <span>return</span> <span>SerializeDateTime2</span>((<span>DateTime</span>)<span>value</span>, <span>scale</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L12947" data-line-number="12947"></td>
        <td id="LC12947">
</td>
      </tr>
      <tr>
        <td id="L12948" data-line-number="12948"></td>
        <td id="LC12948">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMEOFFSET</span>:</td>
      </tr>
      <tr>
        <td id="L12949" data-line-number="12949"></td>
        <td id="LC12949">                    <span>if</span> (<span>scale</span> <span>&gt;</span> <span>TdsEnums</span>.<span>DEFAULT_VARTIME_SCALE</span>)</td>
      </tr>
      <tr>
        <td id="L12950" data-line-number="12950"></td>
        <td id="LC12950">                    {</td>
      </tr>
      <tr>
        <td id="L12951" data-line-number="12951"></td>
        <td id="LC12951">                        <span>throw</span> <span>SQL</span>.<span>TimeScaleValueOutOfRange</span>(<span>scale</span>);</td>
      </tr>
      <tr>
        <td id="L12952" data-line-number="12952"></td>
        <td id="LC12952">                    }</td>
      </tr>
      <tr>
        <td id="L12953" data-line-number="12953"></td>
        <td id="LC12953">                    <span>return</span> <span>SerializeDateTimeOffset</span>((<span>DateTimeOffset</span>)<span>value</span>, <span>scale</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L12954" data-line-number="12954"></td>
        <td id="LC12954">
</td>
      </tr>
      <tr>
        <td id="L12955" data-line-number="12955"></td>
        <td id="LC12955">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L12956" data-line-number="12956"></td>
        <td id="LC12956">                    <span>throw</span> <span>SQL</span>.<span>UnsupportedDatatypeEncryption</span>(<span>type</span>.<span>TypeName</span>);</td>
      </tr>
      <tr>
        <td id="L12957" data-line-number="12957"></td>
        <td id="LC12957">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L12958" data-line-number="12958"></td>
        <td id="LC12958">            <span><span>//</span> Debug.WriteLine("value:  " + value.ToString(CultureInfo.InvariantCulture));</span></td>
      </tr>
      <tr>
        <td id="L12959" data-line-number="12959"></td>
        <td id="LC12959">        }</td>
      </tr>
      <tr>
        <td id="L12960" data-line-number="12960"></td>
        <td id="LC12960">
</td>
      </tr>
      <tr>
        <td id="L12961" data-line-number="12961"></td>
        <td id="LC12961">        <span><span>//</span> For MAX types, this method can only write everything in one big chunk. If multiple</span></td>
      </tr>
      <tr>
        <td id="L12962" data-line-number="12962"></td>
        <td id="LC12962">        <span><span>//</span> chunk writes needed, please use WritePlpBytes/WritePlpChars</span></td>
      </tr>
      <tr>
        <td id="L12963" data-line-number="12963"></td>
        <td id="LC12963">        <span>private</span> <span>byte</span>[] <span>SerializeUnencryptedSqlValue</span>(<span>object</span> <span>value</span>, <span>MetaType</span> <span>type</span>, <span>int</span> <span>actualLength</span>, <span>int</span> <span>offset</span>, <span>byte</span> <span>normalizationVersion</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L12964" data-line-number="12964"></td>
        <td id="LC12964">        {</td>
      </tr>
      <tr>
        <td id="L12965" data-line-number="12965"></td>
        <td id="LC12965">            <span>Debug</span>.<span>Assert</span>(((<span>type</span>.<span>NullableType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>) <span>||</span></td>
      </tr>
      <tr>
        <td id="L12966" data-line-number="12966"></td>
        <td id="LC12966">                   (<span>value</span> <span>is</span> <span>INullable</span> <span>&amp;&amp;</span> <span>!</span>((<span>INullable</span>)<span>value</span>).<span>IsNull</span>)),</td>
      </tr>
      <tr>
        <td id="L12967" data-line-number="12967"></td>
        <td id="LC12967">                   <span><span>"</span>unexpected null SqlType!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12968" data-line-number="12968"></td>
        <td id="LC12968">
</td>
      </tr>
      <tr>
        <td id="L12969" data-line-number="12969"></td>
        <td id="LC12969">            <span>if</span> (<span>normalizationVersion</span> <span>!=</span> <span>0x01</span>)</td>
      </tr>
      <tr>
        <td id="L12970" data-line-number="12970"></td>
        <td id="LC12970">            {</td>
      </tr>
      <tr>
        <td id="L12971" data-line-number="12971"></td>
        <td id="LC12971">                <span>throw</span> <span>SQL</span>.<span>UnsupportedNormalizationVersion</span>(<span>normalizationVersion</span>);</td>
      </tr>
      <tr>
        <td id="L12972" data-line-number="12972"></td>
        <td id="LC12972">            }</td>
      </tr>
      <tr>
        <td id="L12973" data-line-number="12973"></td>
        <td id="LC12973">
</td>
      </tr>
      <tr>
        <td id="L12974" data-line-number="12974"></td>
        <td id="LC12974">            <span><span>//</span> parameters are always sent over as BIG or N types</span></td>
      </tr>
      <tr>
        <td id="L12975" data-line-number="12975"></td>
        <td id="LC12975">            <span>switch</span> (<span>type</span>.<span>NullableType</span>)</td>
      </tr>
      <tr>
        <td id="L12976" data-line-number="12976"></td>
        <td id="LC12976">            {</td>
      </tr>
      <tr>
        <td id="L12977" data-line-number="12977"></td>
        <td id="LC12977">                <span>case</span> <span>TdsEnums</span>.<span>SQLFLTN</span>:</td>
      </tr>
      <tr>
        <td id="L12978" data-line-number="12978"></td>
        <td id="LC12978">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L12979" data-line-number="12979"></td>
        <td id="LC12979">                        <span>return</span> <span>SerializeFloat</span>(((<span>SqlSingle</span>)<span>value</span>).<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L12980" data-line-number="12980"></td>
        <td id="LC12980">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L12981" data-line-number="12981"></td>
        <td id="LC12981">                    {</td>
      </tr>
      <tr>
        <td id="L12982" data-line-number="12982"></td>
        <td id="LC12982">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>Invalid length for SqlDouble type!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L12983" data-line-number="12983"></td>
        <td id="LC12983">                        <span>return</span> <span>SerializeDouble</span>(((<span>SqlDouble</span>)<span>value</span>).<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L12984" data-line-number="12984"></td>
        <td id="LC12984">                    }</td>
      </tr>
      <tr>
        <td id="L12985" data-line-number="12985"></td>
        <td id="LC12985">
</td>
      </tr>
      <tr>
        <td id="L12986" data-line-number="12986"></td>
        <td id="LC12986">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L12987" data-line-number="12987"></td>
        <td id="LC12987">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARBINARY</span>:</td>
      </tr>
      <tr>
        <td id="L12988" data-line-number="12988"></td>
        <td id="LC12988">                <span>case</span> <span>TdsEnums</span>.<span>SQLIMAGE</span>:</td>
      </tr>
      <tr>
        <td id="L12989" data-line-number="12989"></td>
        <td id="LC12989">                    {</td>
      </tr>
      <tr>
        <td id="L12990" data-line-number="12990"></td>
        <td id="LC12990">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>new</span> <span>byte</span>[<span>actualLength</span>];</td>
      </tr>
      <tr>
        <td id="L12991" data-line-number="12991"></td>
        <td id="LC12991">
</td>
      </tr>
      <tr>
        <td id="L12992" data-line-number="12992"></td>
        <td id="LC12992">                        <span>if</span> (<span>value</span> <span>is</span> <span>SqlBinary</span>)</td>
      </tr>
      <tr>
        <td id="L12993" data-line-number="12993"></td>
        <td id="LC12993">                        {</td>
      </tr>
      <tr>
        <td id="L12994" data-line-number="12994"></td>
        <td id="LC12994">                            <span>Buffer</span>.<span>BlockCopy</span>(((<span>SqlBinary</span>)<span>value</span>).<span>Value</span>, <span>offset</span>, <span>b</span>, <span>0</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L12995" data-line-number="12995"></td>
        <td id="LC12995">                        }</td>
      </tr>
      <tr>
        <td id="L12996" data-line-number="12996"></td>
        <td id="LC12996">                        <span>else</span></td>
      </tr>
      <tr>
        <td id="L12997" data-line-number="12997"></td>
        <td id="LC12997">                        {</td>
      </tr>
      <tr>
        <td id="L12998" data-line-number="12998"></td>
        <td id="LC12998">                            <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>SqlBytes</span>);</td>
      </tr>
      <tr>
        <td id="L12999" data-line-number="12999"></td>
        <td id="LC12999">                            <span>Buffer</span>.<span>BlockCopy</span>(((<span>SqlBytes</span>)<span>value</span>).<span>Value</span>, <span>offset</span>, <span>b</span>, <span>0</span>, <span>actualLength</span>);</td>
      </tr>
      <tr>
        <td id="L13000" data-line-number="13000"></td>
        <td id="LC13000">                        }</td>
      </tr>
      <tr>
        <td id="L13001" data-line-number="13001"></td>
        <td id="LC13001">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L13002" data-line-number="13002"></td>
        <td id="LC13002">                    }</td>
      </tr>
      <tr>
        <td id="L13003" data-line-number="13003"></td>
        <td id="LC13003">
</td>
      </tr>
      <tr>
        <td id="L13004" data-line-number="13004"></td>
        <td id="LC13004">                <span>case</span> <span>TdsEnums</span>.<span>SQLUNIQUEID</span>:</td>
      </tr>
      <tr>
        <td id="L13005" data-line-number="13005"></td>
        <td id="LC13005">                    {</td>
      </tr>
      <tr>
        <td id="L13006" data-line-number="13006"></td>
        <td id="LC13006">                        <span>byte</span>[] <span>b</span> <span>=</span> ((<span>SqlGuid</span>)<span>value</span>).<span>ToByteArray</span>();</td>
      </tr>
      <tr>
        <td id="L13007" data-line-number="13007"></td>
        <td id="LC13007">
</td>
      </tr>
      <tr>
        <td id="L13008" data-line-number="13008"></td>
        <td id="LC13008">                        <span>Debug</span>.<span>Assert</span>((<span>actualLength</span> <span>==</span> <span>b</span>.<span>Length</span>) <span>&amp;&amp;</span> (<span>actualLength</span> <span>==</span> <span>16</span>), <span><span>"</span>Invalid length for guid type in com+ object<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13009" data-line-number="13009"></td>
        <td id="LC13009">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L13010" data-line-number="13010"></td>
        <td id="LC13010">                    }</td>
      </tr>
      <tr>
        <td id="L13011" data-line-number="13011"></td>
        <td id="LC13011">
</td>
      </tr>
      <tr>
        <td id="L13012" data-line-number="13012"></td>
        <td id="LC13012">                <span>case</span> <span>TdsEnums</span>.<span>SQLBITN</span>:</td>
      </tr>
      <tr>
        <td id="L13013" data-line-number="13013"></td>
        <td id="LC13013">                    {</td>
      </tr>
      <tr>
        <td id="L13014" data-line-number="13014"></td>
        <td id="LC13014">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>, <span><span>"</span>Invalid length for SqlBoolean type<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13015" data-line-number="13015"></td>
        <td id="LC13015">
</td>
      </tr>
      <tr>
        <td id="L13016" data-line-number="13016"></td>
        <td id="LC13016">                        <span><span>//</span> We normalize to allow conversion across data types. BIT is serialized into a BIGINT.</span></td>
      </tr>
      <tr>
        <td id="L13017" data-line-number="13017"></td>
        <td id="LC13017">                        <span>return</span> <span>SerializeLong</span>(((<span>SqlBoolean</span>)<span>value</span>).<span>Value</span> <span>==</span> <span>true</span> <span>?</span> <span>1</span> <span>:</span> <span>0</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13018" data-line-number="13018"></td>
        <td id="LC13018">                    }</td>
      </tr>
      <tr>
        <td id="L13019" data-line-number="13019"></td>
        <td id="LC13019">
</td>
      </tr>
      <tr>
        <td id="L13020" data-line-number="13020"></td>
        <td id="LC13020">                <span>case</span> <span>TdsEnums</span>.<span>SQLINTN</span>:</td>
      </tr>
      <tr>
        <td id="L13021" data-line-number="13021"></td>
        <td id="LC13021">                    <span><span>//</span> We normalize to allow conversion across data types. All data types below are serialized into a BIGINT.</span></td>
      </tr>
      <tr>
        <td id="L13022" data-line-number="13022"></td>
        <td id="LC13022">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>1</span>)</td>
      </tr>
      <tr>
        <td id="L13023" data-line-number="13023"></td>
        <td id="LC13023">                        <span>return</span> <span>SerializeLong</span>(((<span>SqlByte</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13024" data-line-number="13024"></td>
        <td id="LC13024">
</td>
      </tr>
      <tr>
        <td id="L13025" data-line-number="13025"></td>
        <td id="LC13025">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>2</span>)</td>
      </tr>
      <tr>
        <td id="L13026" data-line-number="13026"></td>
        <td id="LC13026">                        <span>return</span> <span>SerializeLong</span>(((<span>SqlInt16</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13027" data-line-number="13027"></td>
        <td id="LC13027">
</td>
      </tr>
      <tr>
        <td id="L13028" data-line-number="13028"></td>
        <td id="LC13028">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L13029" data-line-number="13029"></td>
        <td id="LC13029">                        <span>return</span> <span>SerializeLong</span>(((<span>SqlInt32</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13030" data-line-number="13030"></td>
        <td id="LC13030">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L13031" data-line-number="13031"></td>
        <td id="LC13031">                    {</td>
      </tr>
      <tr>
        <td id="L13032" data-line-number="13032"></td>
        <td id="LC13032">                        <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>==</span> <span>8</span>, <span><span>"</span>invalid length for SqlIntN type:  <span>"</span></span> <span>+</span> <span>type</span>.<span>FixedLength</span>.<span>ToString</span>(<span>CultureInfo</span>.<span>InvariantCulture</span>));</td>
      </tr>
      <tr>
        <td id="L13033" data-line-number="13033"></td>
        <td id="LC13033">                        <span>return</span> <span>SerializeLong</span>(((<span>SqlInt64</span>)<span>value</span>).<span>Value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13034" data-line-number="13034"></td>
        <td id="LC13034">                    }</td>
      </tr>
      <tr>
        <td id="L13035" data-line-number="13035"></td>
        <td id="LC13035">
</td>
      </tr>
      <tr>
        <td id="L13036" data-line-number="13036"></td>
        <td id="LC13036">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L13037" data-line-number="13037"></td>
        <td id="LC13037">                <span>case</span> <span>TdsEnums</span>.<span>SQLBIGVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L13038" data-line-number="13038"></td>
        <td id="LC13038">                <span>case</span> <span>TdsEnums</span>.<span>SQLTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L13039" data-line-number="13039"></td>
        <td id="LC13039">                    <span>if</span> (<span>value</span> <span>is</span> <span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)</td>
      </tr>
      <tr>
        <td id="L13040" data-line-number="13040"></td>
        <td id="LC13040">                    {</td>
      </tr>
      <tr>
        <td id="L13041" data-line-number="13041"></td>
        <td id="LC13041">                        <span>String</span> <span>sch</span> <span>=</span> <span>new</span> <span>String</span>(((<span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)<span>value</span>).<span>Value</span>);</td>
      </tr>
      <tr>
        <td id="L13042" data-line-number="13042"></td>
        <td id="LC13042">                        <span>return</span> <span>SerializeEncodingChar</span>(<span>sch</span>, <span>actualLength</span>, <span>offset</span>, <span>_defaultEncoding</span>);</td>
      </tr>
      <tr>
        <td id="L13043" data-line-number="13043"></td>
        <td id="LC13043">                    }</td>
      </tr>
      <tr>
        <td id="L13044" data-line-number="13044"></td>
        <td id="LC13044">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L13045" data-line-number="13045"></td>
        <td id="LC13045">                    {</td>
      </tr>
      <tr>
        <td id="L13046" data-line-number="13046"></td>
        <td id="LC13046">                        <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>SqlString</span>);</td>
      </tr>
      <tr>
        <td id="L13047" data-line-number="13047"></td>
        <td id="LC13047">                        <span>return</span> <span>SerializeEncodingChar</span>(((<span>SqlString</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>, <span>_defaultEncoding</span>);</td>
      </tr>
      <tr>
        <td id="L13048" data-line-number="13048"></td>
        <td id="LC13048">                    }</td>
      </tr>
      <tr>
        <td id="L13049" data-line-number="13049"></td>
        <td id="LC13049">
</td>
      </tr>
      <tr>
        <td id="L13050" data-line-number="13050"></td>
        <td id="LC13050">
</td>
      </tr>
      <tr>
        <td id="L13051" data-line-number="13051"></td>
        <td id="LC13051">                <span>case</span> <span>TdsEnums</span>.<span>SQLNCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L13052" data-line-number="13052"></td>
        <td id="LC13052">                <span>case</span> <span>TdsEnums</span>.<span>SQLNVARCHAR</span>:</td>
      </tr>
      <tr>
        <td id="L13053" data-line-number="13053"></td>
        <td id="LC13053">                <span>case</span> <span>TdsEnums</span>.<span>SQLNTEXT</span>:</td>
      </tr>
      <tr>
        <td id="L13054" data-line-number="13054"></td>
        <td id="LC13054">                <span>case</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span>:</td>
      </tr>
      <tr>
        <td id="L13055" data-line-number="13055"></td>
        <td id="LC13055">                    <span><span>//</span> convert to cchars instead of cbytes</span></td>
      </tr>
      <tr>
        <td id="L13056" data-line-number="13056"></td>
        <td id="LC13056">                    <span><span>//</span> Xml type is already converted to string through GetCoercedValue</span></td>
      </tr>
      <tr>
        <td id="L13057" data-line-number="13057"></td>
        <td id="LC13057">                    <span>if</span> (<span>actualLength</span> <span>!=</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13058" data-line-number="13058"></td>
        <td id="LC13058">                        <span>actualLength</span> <span>&gt;&gt;=</span> <span>1</span>;</td>
      </tr>
      <tr>
        <td id="L13059" data-line-number="13059"></td>
        <td id="LC13059">
</td>
      </tr>
      <tr>
        <td id="L13060" data-line-number="13060"></td>
        <td id="LC13060">                    <span>if</span> (<span>value</span> <span>is</span> <span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)</td>
      </tr>
      <tr>
        <td id="L13061" data-line-number="13061"></td>
        <td id="LC13061">                    {</td>
      </tr>
      <tr>
        <td id="L13062" data-line-number="13062"></td>
        <td id="LC13062">                        <span>return</span> <span>SerializeCharArray</span>(((<span>System</span>.<span>Data</span>.<span>SqlTypes</span>.<span>SqlChars</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>);</td>
      </tr>
      <tr>
        <td id="L13063" data-line-number="13063"></td>
        <td id="LC13063">                    }</td>
      </tr>
      <tr>
        <td id="L13064" data-line-number="13064"></td>
        <td id="LC13064">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L13065" data-line-number="13065"></td>
        <td id="LC13065">                    {</td>
      </tr>
      <tr>
        <td id="L13066" data-line-number="13066"></td>
        <td id="LC13066">                        <span>Debug</span>.<span>Assert</span>(<span>value</span> <span>is</span> <span>SqlString</span>);</td>
      </tr>
      <tr>
        <td id="L13067" data-line-number="13067"></td>
        <td id="LC13067">                        <span>return</span> <span>SerializeString</span>(((<span>SqlString</span>)<span>value</span>).<span>Value</span>, <span>actualLength</span>, <span>offset</span>);</td>
      </tr>
      <tr>
        <td id="L13068" data-line-number="13068"></td>
        <td id="LC13068">                    }</td>
      </tr>
      <tr>
        <td id="L13069" data-line-number="13069"></td>
        <td id="LC13069">
</td>
      </tr>
      <tr>
        <td id="L13070" data-line-number="13070"></td>
        <td id="LC13070">                <span>case</span> <span>TdsEnums</span>.<span>SQLNUMERICN</span>:</td>
      </tr>
      <tr>
        <td id="L13071" data-line-number="13071"></td>
        <td id="LC13071">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>&lt;=</span> <span>17</span>, <span><span>"</span>Decimal length cannot be greater than 17 bytes<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13072" data-line-number="13072"></td>
        <td id="LC13072">                    <span>return</span> <span>SerializeSqlDecimal</span>((<span>SqlDecimal</span>)<span>value</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13073" data-line-number="13073"></td>
        <td id="LC13073">
</td>
      </tr>
      <tr>
        <td id="L13074" data-line-number="13074"></td>
        <td id="LC13074">                <span>case</span> <span>TdsEnums</span>.<span>SQLDATETIMN</span>:</td>
      </tr>
      <tr>
        <td id="L13075" data-line-number="13075"></td>
        <td id="LC13075">                    <span>SqlDateTime</span> <span>dt</span> <span>=</span> (<span>SqlDateTime</span>)<span>value</span>;</td>
      </tr>
      <tr>
        <td id="L13076" data-line-number="13076"></td>
        <td id="LC13076">
</td>
      </tr>
      <tr>
        <td id="L13077" data-line-number="13077"></td>
        <td id="LC13077">                    <span>if</span> (<span>type</span>.<span>FixedLength</span> <span>==</span> <span>4</span>)</td>
      </tr>
      <tr>
        <td id="L13078" data-line-number="13078"></td>
        <td id="LC13078">                    {</td>
      </tr>
      <tr>
        <td id="L13079" data-line-number="13079"></td>
        <td id="LC13079">                        <span>if</span> (<span>0</span> <span>&gt;</span> <span>dt</span>.<span>DayTicks</span> <span>||</span> <span>dt</span>.<span>DayTicks</span> <span>&gt;</span> <span>UInt16</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L13080" data-line-number="13080"></td>
        <td id="LC13080">                            <span>throw</span> <span>SQL</span>.<span>SmallDateTimeOverflow</span>(<span>dt</span>.<span>ToString</span>());</td>
      </tr>
      <tr>
        <td id="L13081" data-line-number="13081"></td>
        <td id="LC13081">
</td>
      </tr>
      <tr>
        <td id="L13082" data-line-number="13082"></td>
        <td id="LC13082">                        <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bIntBytes</span>)</td>
      </tr>
      <tr>
        <td id="L13083" data-line-number="13083"></td>
        <td id="LC13083">                        {</td>
      </tr>
      <tr>
        <td id="L13084" data-line-number="13084"></td>
        <td id="LC13084">                            <span>stateObj</span>.<span>_bIntBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>4</span>];</td>
      </tr>
      <tr>
        <td id="L13085" data-line-number="13085"></td>
        <td id="LC13085">                        }</td>
      </tr>
      <tr>
        <td id="L13086" data-line-number="13086"></td>
        <td id="LC13086">
</td>
      </tr>
      <tr>
        <td id="L13087" data-line-number="13087"></td>
        <td id="LC13087">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>stateObj</span>.<span>_bIntBytes</span>;</td>
      </tr>
      <tr>
        <td id="L13088" data-line-number="13088"></td>
        <td id="LC13088">                        <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13089" data-line-number="13089"></td>
        <td id="LC13089">
</td>
      </tr>
      <tr>
        <td id="L13090" data-line-number="13090"></td>
        <td id="LC13090">                        <span>byte</span>[] <span>bPart</span> <span>=</span> <span>SerializeShort</span>(<span>dt</span>.<span>DayTicks</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13091" data-line-number="13091"></td>
        <td id="LC13091">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L13092" data-line-number="13092"></td>
        <td id="LC13092">                        <span>current</span> <span>+=</span> <span>2</span>;</td>
      </tr>
      <tr>
        <td id="L13093" data-line-number="13093"></td>
        <td id="LC13093">
</td>
      </tr>
      <tr>
        <td id="L13094" data-line-number="13094"></td>
        <td id="LC13094">                        <span>bPart</span> <span>=</span> <span>SerializeShort</span>(<span>dt</span>.<span>TimeTicks</span> <span>/</span> <span>SqlDateTime</span>.<span>SQLTicksPerMinute</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13095" data-line-number="13095"></td>
        <td id="LC13095">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L13096" data-line-number="13096"></td>
        <td id="LC13096">
</td>
      </tr>
      <tr>
        <td id="L13097" data-line-number="13097"></td>
        <td id="LC13097">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L13098" data-line-number="13098"></td>
        <td id="LC13098">                    }</td>
      </tr>
      <tr>
        <td id="L13099" data-line-number="13099"></td>
        <td id="LC13099">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L13100" data-line-number="13100"></td>
        <td id="LC13100">                    {</td>
      </tr>
      <tr>
        <td id="L13101" data-line-number="13101"></td>
        <td id="LC13101">                        <span>if</span> (<span>null</span> <span>==</span> <span>stateObj</span>.<span>_bLongBytes</span>)</td>
      </tr>
      <tr>
        <td id="L13102" data-line-number="13102"></td>
        <td id="LC13102">                        {</td>
      </tr>
      <tr>
        <td id="L13103" data-line-number="13103"></td>
        <td id="LC13103">                            <span>stateObj</span>.<span>_bLongBytes</span> <span>=</span> <span>new</span> <span>byte</span>[<span>8</span>];</td>
      </tr>
      <tr>
        <td id="L13104" data-line-number="13104"></td>
        <td id="LC13104">                        }</td>
      </tr>
      <tr>
        <td id="L13105" data-line-number="13105"></td>
        <td id="LC13105">
</td>
      </tr>
      <tr>
        <td id="L13106" data-line-number="13106"></td>
        <td id="LC13106">                        <span>byte</span>[] <span>b</span> <span>=</span> <span>stateObj</span>.<span>_bLongBytes</span>;</td>
      </tr>
      <tr>
        <td id="L13107" data-line-number="13107"></td>
        <td id="LC13107">                        <span>int</span> <span>current</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13108" data-line-number="13108"></td>
        <td id="LC13108">
</td>
      </tr>
      <tr>
        <td id="L13109" data-line-number="13109"></td>
        <td id="LC13109">                        <span>byte</span>[] <span>bPart</span> <span>=</span> <span>SerializeInt</span>(<span>dt</span>.<span>DayTicks</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13110" data-line-number="13110"></td>
        <td id="LC13110">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L13111" data-line-number="13111"></td>
        <td id="LC13111">                        <span>current</span> <span>+=</span> <span>4</span>;</td>
      </tr>
      <tr>
        <td id="L13112" data-line-number="13112"></td>
        <td id="LC13112">
</td>
      </tr>
      <tr>
        <td id="L13113" data-line-number="13113"></td>
        <td id="LC13113">                        <span>bPart</span> <span>=</span> <span>SerializeInt</span>(<span>dt</span>.<span>TimeTicks</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13114" data-line-number="13114"></td>
        <td id="LC13114">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>bPart</span>, <span>0</span>, <span>b</span>, <span>current</span>, <span>4</span>);</td>
      </tr>
      <tr>
        <td id="L13115" data-line-number="13115"></td>
        <td id="LC13115">
</td>
      </tr>
      <tr>
        <td id="L13116" data-line-number="13116"></td>
        <td id="LC13116">                        <span>return</span> <span>b</span>;</td>
      </tr>
      <tr>
        <td id="L13117" data-line-number="13117"></td>
        <td id="LC13117">                    }</td>
      </tr>
      <tr>
        <td id="L13118" data-line-number="13118"></td>
        <td id="LC13118">
</td>
      </tr>
      <tr>
        <td id="L13119" data-line-number="13119"></td>
        <td id="LC13119">                <span>case</span> <span>TdsEnums</span>.<span>SQLMONEYN</span>:</td>
      </tr>
      <tr>
        <td id="L13120" data-line-number="13120"></td>
        <td id="LC13120">                    {</td>
      </tr>
      <tr>
        <td id="L13121" data-line-number="13121"></td>
        <td id="LC13121">                        <span>return</span> <span>SerializeSqlMoney</span>((<span>SqlMoney</span>)<span>value</span>, <span>type</span>.<span>FixedLength</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13122" data-line-number="13122"></td>
        <td id="LC13122">                    }</td>
      </tr>
      <tr>
        <td id="L13123" data-line-number="13123"></td>
        <td id="LC13123">
</td>
      </tr>
      <tr>
        <td id="L13124" data-line-number="13124"></td>
        <td id="LC13124">                <span>default</span>:</td>
      </tr>
      <tr>
        <td id="L13125" data-line-number="13125"></td>
        <td id="LC13125">                    <span>throw</span> <span>SQL</span>.<span>UnsupportedDatatypeEncryption</span>(<span>type</span>.<span>TypeName</span>);</td>
      </tr>
      <tr>
        <td id="L13126" data-line-number="13126"></td>
        <td id="LC13126">            } <span><span>//</span> switch</span></td>
      </tr>
      <tr>
        <td id="L13127" data-line-number="13127"></td>
        <td id="LC13127">        }</td>
      </tr>
      <tr>
        <td id="L13128" data-line-number="13128"></td>
        <td id="LC13128">
</td>
      </tr>
      <tr>
        <td id="L13129" data-line-number="13129"></td>
        <td id="LC13129">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L13130" data-line-number="13130"></td>
        <td id="LC13130">        <span><span>//</span> we always send over nullable types for parameters so we always write the varlen fields</span></td>
      </tr>
      <tr>
        <td id="L13131" data-line-number="13131"></td>
        <td id="LC13131">        <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L13132" data-line-number="13132"></td>
        <td id="LC13132">
</td>
      </tr>
      <tr>
        <td id="L13133" data-line-number="13133"></td>
        <td id="LC13133">        <span>internal</span> <span>void</span> <span>WriteParameterVarLen</span>(<span>MetaType</span> <span>type</span>, <span>int</span> <span>size</span>, <span>bool</span> <span>isNull</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>bool</span> <span>unknownLength</span> <span>=</span> <span>false</span>)</td>
      </tr>
      <tr>
        <td id="L13134" data-line-number="13134"></td>
        <td id="LC13134">        {</td>
      </tr>
      <tr>
        <td id="L13135" data-line-number="13135"></td>
        <td id="LC13135">            <span>if</span> (<span>type</span>.<span>IsLong</span>)</td>
      </tr>
      <tr>
        <td id="L13136" data-line-number="13136"></td>
        <td id="LC13136">            { <span><span>//</span> text/image/SQLVariant have a 4 byte length, plp datatypes have 8 byte lengths</span></td>
      </tr>
      <tr>
        <td id="L13137" data-line-number="13137"></td>
        <td id="LC13137">                <span>if</span> (<span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L13138" data-line-number="13138"></td>
        <td id="LC13138">                {</td>
      </tr>
      <tr>
        <td id="L13139" data-line-number="13139"></td>
        <td id="LC13139">                    <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L13140" data-line-number="13140"></td>
        <td id="LC13140">                    {</td>
      </tr>
      <tr>
        <td id="L13141" data-line-number="13141"></td>
        <td id="LC13141">                        <span>WriteLong</span>(<span>unchecked</span>((<span>long</span>)<span>TdsEnums</span>.<span>SQL_PLP_NULL</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13142" data-line-number="13142"></td>
        <td id="LC13142">                    }</td>
      </tr>
      <tr>
        <td id="L13143" data-line-number="13143"></td>
        <td id="LC13143">                    <span>else</span></td>
      </tr>
      <tr>
        <td id="L13144" data-line-number="13144"></td>
        <td id="LC13144">                    {</td>
      </tr>
      <tr>
        <td id="L13145" data-line-number="13145"></td>
        <td id="LC13145">                        <span>WriteInt</span>(<span>unchecked</span>((<span>int</span>)<span>TdsEnums</span>.<span>VARLONGNULL</span>), <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13146" data-line-number="13146"></td>
        <td id="LC13146">                    }</td>
      </tr>
      <tr>
        <td id="L13147" data-line-number="13147"></td>
        <td id="LC13147">                }</td>
      </tr>
      <tr>
        <td id="L13148" data-line-number="13148"></td>
        <td id="LC13148">                <span>else</span> <span>if</span> (<span>type</span>.<span>NullableType</span> <span>==</span> <span>TdsEnums</span>.<span>SQLXMLTYPE</span> <span>||</span> <span>unknownLength</span>)</td>
      </tr>
      <tr>
        <td id="L13149" data-line-number="13149"></td>
        <td id="LC13149">                {</td>
      </tr>
      <tr>
        <td id="L13150" data-line-number="13150"></td>
        <td id="LC13150">                    <span>WriteUnsignedLong</span>(<span>TdsEnums</span>.<span>SQL_PLP_UNKNOWNLEN</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13151" data-line-number="13151"></td>
        <td id="LC13151">                }</td>
      </tr>
      <tr>
        <td id="L13152" data-line-number="13152"></td>
        <td id="LC13152">                <span>else</span> <span>if</span> (<span>type</span>.<span>IsPlp</span>)</td>
      </tr>
      <tr>
        <td id="L13153" data-line-number="13153"></td>
        <td id="LC13153">                {</td>
      </tr>
      <tr>
        <td id="L13154" data-line-number="13154"></td>
        <td id="LC13154">                    <span><span>//</span> Non-xml plp types</span></td>
      </tr>
      <tr>
        <td id="L13155" data-line-number="13155"></td>
        <td id="LC13155">                    <span>WriteLong</span>((<span>long</span>)<span>size</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13156" data-line-number="13156"></td>
        <td id="LC13156">                }</td>
      </tr>
      <tr>
        <td id="L13157" data-line-number="13157"></td>
        <td id="LC13157">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L13158" data-line-number="13158"></td>
        <td id="LC13158">                {</td>
      </tr>
      <tr>
        <td id="L13159" data-line-number="13159"></td>
        <td id="LC13159">                    <span>WriteInt</span>(<span>size</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13160" data-line-number="13160"></td>
        <td id="LC13160">                }</td>
      </tr>
      <tr>
        <td id="L13161" data-line-number="13161"></td>
        <td id="LC13161">            }</td>
      </tr>
      <tr>
        <td id="L13162" data-line-number="13162"></td>
        <td id="LC13162">            <span>else</span> <span>if</span> (<span>type</span>.<span>IsVarTime</span>)</td>
      </tr>
      <tr>
        <td id="L13163" data-line-number="13163"></td>
        <td id="LC13163">            {</td>
      </tr>
      <tr>
        <td id="L13164" data-line-number="13164"></td>
        <td id="LC13164">                <span>if</span> (<span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L13165" data-line-number="13165"></td>
        <td id="LC13165">                {</td>
      </tr>
      <tr>
        <td id="L13166" data-line-number="13166"></td>
        <td id="LC13166">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FIXEDNULL</span>);</td>
      </tr>
      <tr>
        <td id="L13167" data-line-number="13167"></td>
        <td id="LC13167">                }</td>
      </tr>
      <tr>
        <td id="L13168" data-line-number="13168"></td>
        <td id="LC13168">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L13169" data-line-number="13169"></td>
        <td id="LC13169">                {</td>
      </tr>
      <tr>
        <td id="L13170" data-line-number="13170"></td>
        <td id="LC13170">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)<span>size</span>);</td>
      </tr>
      <tr>
        <td id="L13171" data-line-number="13171"></td>
        <td id="LC13171">                }</td>
      </tr>
      <tr>
        <td id="L13172" data-line-number="13172"></td>
        <td id="LC13172">            }</td>
      </tr>
      <tr>
        <td id="L13173" data-line-number="13173"></td>
        <td id="LC13173">            <span>else</span> <span>if</span> (<span>false</span> <span>==</span> <span>type</span>.<span>IsFixed</span>)</td>
      </tr>
      <tr>
        <td id="L13174" data-line-number="13174"></td>
        <td id="LC13174">            { <span><span>//</span> non-long but variable length column, must be a BIG* type: 2 byte length</span></td>
      </tr>
      <tr>
        <td id="L13175" data-line-number="13175"></td>
        <td id="LC13175">                <span>if</span> (<span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L13176" data-line-number="13176"></td>
        <td id="LC13176">                {</td>
      </tr>
      <tr>
        <td id="L13177" data-line-number="13177"></td>
        <td id="LC13177">                    <span>WriteShort</span>(<span>TdsEnums</span>.<span>VARNULL</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13178" data-line-number="13178"></td>
        <td id="LC13178">                }</td>
      </tr>
      <tr>
        <td id="L13179" data-line-number="13179"></td>
        <td id="LC13179">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L13180" data-line-number="13180"></td>
        <td id="LC13180">                {</td>
      </tr>
      <tr>
        <td id="L13181" data-line-number="13181"></td>
        <td id="LC13181">                    <span>WriteShort</span>(<span>size</span>, <span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13182" data-line-number="13182"></td>
        <td id="LC13182">                }</td>
      </tr>
      <tr>
        <td id="L13183" data-line-number="13183"></td>
        <td id="LC13183">            }</td>
      </tr>
      <tr>
        <td id="L13184" data-line-number="13184"></td>
        <td id="LC13184">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L13185" data-line-number="13185"></td>
        <td id="LC13185">            {</td>
      </tr>
      <tr>
        <td id="L13186" data-line-number="13186"></td>
        <td id="LC13186">                <span>if</span> (<span>isNull</span>)</td>
      </tr>
      <tr>
        <td id="L13187" data-line-number="13187"></td>
        <td id="LC13187">                {</td>
      </tr>
      <tr>
        <td id="L13188" data-line-number="13188"></td>
        <td id="LC13188">                    <span>stateObj</span>.<span>WriteByte</span>(<span>TdsEnums</span>.<span>FIXEDNULL</span>);</td>
      </tr>
      <tr>
        <td id="L13189" data-line-number="13189"></td>
        <td id="LC13189">                }</td>
      </tr>
      <tr>
        <td id="L13190" data-line-number="13190"></td>
        <td id="LC13190">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L13191" data-line-number="13191"></td>
        <td id="LC13191">                {</td>
      </tr>
      <tr>
        <td id="L13192" data-line-number="13192"></td>
        <td id="LC13192">                    <span>Debug</span>.<span>Assert</span>(<span>type</span>.<span>FixedLength</span> <span>&lt;=</span> <span>0xff</span>, <span><span>"</span>WriteParameterVarLen: invalid one byte length!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13193" data-line-number="13193"></td>
        <td id="LC13193">                    <span>stateObj</span>.<span>WriteByte</span>((<span>byte</span>)(<span>type</span>.<span>FixedLength</span> <span>&amp;</span> <span>0xff</span>)); <span><span>//</span> 1 byte for everything else</span></td>
      </tr>
      <tr>
        <td id="L13194" data-line-number="13194"></td>
        <td id="LC13194">                }</td>
      </tr>
      <tr>
        <td id="L13195" data-line-number="13195"></td>
        <td id="LC13195">            }</td>
      </tr>
      <tr>
        <td id="L13196" data-line-number="13196"></td>
        <td id="LC13196">        }</td>
      </tr>
      <tr>
        <td id="L13197" data-line-number="13197"></td>
        <td id="LC13197">
</td>
      </tr>
      <tr>
        <td id="L13198" data-line-number="13198"></td>
        <td id="LC13198">        <span><span>//</span> Reads the next chunk in a nvarchar(max) data stream.</span></td>
      </tr>
      <tr>
        <td id="L13199" data-line-number="13199"></td>
        <td id="LC13199">        <span><span>//</span> This call must be preceeded by a call to ReadPlpLength or ReadDataLength.</span></td>
      </tr>
      <tr>
        <td id="L13200" data-line-number="13200"></td>
        <td id="LC13200">        <span><span>//</span> Will not start reading into the next chunk if bytes requested is larger than</span></td>
      </tr>
      <tr>
        <td id="L13201" data-line-number="13201"></td>
        <td id="LC13201">        <span><span>//</span> the current chunk length. Do another ReadPlpLength, ReadPlpUnicodeChars in that case.</span></td>
      </tr>
      <tr>
        <td id="L13202" data-line-number="13202"></td>
        <td id="LC13202">        <span><span>//</span> Returns the actual chars read</span></td>
      </tr>
      <tr>
        <td id="L13203" data-line-number="13203"></td>
        <td id="LC13203">        <span>private</span> <span>bool</span> <span>TryReadPlpUnicodeCharsChunk</span>(<span>char</span>[] <span>buff</span>, <span>int</span> <span>offst</span>, <span>int</span> <span>len</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>int</span> <span>charsRead</span>)</td>
      </tr>
      <tr>
        <td id="L13204" data-line-number="13204"></td>
        <td id="LC13204">        {</td>
      </tr>
      <tr>
        <td id="L13205" data-line-number="13205"></td>
        <td id="LC13205">
</td>
      </tr>
      <tr>
        <td id="L13206" data-line-number="13206"></td>
        <td id="LC13206">            <span>Debug</span>.<span>Assert</span>((<span>buff</span> <span>==</span> <span>null</span> <span>&amp;&amp;</span> <span>len</span> <span>==</span> <span>0</span>) <span>||</span> (<span>buff</span>.<span>Length</span> <span>&gt;=</span> <span>offst</span> <span>+</span> <span>len</span>), <span><span>"</span>Invalid length sent to ReadPlpUnicodeChars()!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13207" data-line-number="13207"></td>
        <td id="LC13207">            <span>Debug</span>.<span>Assert</span>((<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>0</span>) <span>&amp;&amp;</span> (<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>TdsEnums</span>.<span>SQL_PLP_NULL</span>),</td>
      </tr>
      <tr>
        <td id="L13208" data-line-number="13208"></td>
        <td id="LC13208">                        <span><span>"</span>Out of sync plp read request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13209" data-line-number="13209"></td>
        <td id="LC13209">            <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13210" data-line-number="13210"></td>
        <td id="LC13210">            {</td>
      </tr>
      <tr>
        <td id="L13211" data-line-number="13211"></td>
        <td id="LC13211">                <span>Debug</span>.<span>Fail</span>(<span><span>"</span>Out of sync read request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13212" data-line-number="13212"></td>
        <td id="LC13212">                <span>charsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13213" data-line-number="13213"></td>
        <td id="LC13213">                <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L13214" data-line-number="13214"></td>
        <td id="LC13214">            }</td>
      </tr>
      <tr>
        <td id="L13215" data-line-number="13215"></td>
        <td id="LC13215">
</td>
      </tr>
      <tr>
        <td id="L13216" data-line-number="13216"></td>
        <td id="LC13216">            <span>charsRead</span> <span>=</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L13217" data-line-number="13217"></td>
        <td id="LC13217">
</td>
      </tr>
      <tr>
        <td id="L13218" data-line-number="13218"></td>
        <td id="LC13218">            <span><span>//</span> stateObj._longlenleft is in bytes</span></td>
      </tr>
      <tr>
        <td id="L13219" data-line-number="13219"></td>
        <td id="LC13219">            <span>if</span> ((<span>stateObj</span>.<span>_longlenleft</span> <span>&gt;&gt;</span> <span>1</span>) <span>&lt;</span> (<span>ulong</span>)<span>len</span>)</td>
      </tr>
      <tr>
        <td id="L13220" data-line-number="13220"></td>
        <td id="LC13220">                <span>charsRead</span> <span>=</span> (<span>int</span>)(<span>stateObj</span>.<span>_longlenleft</span> <span>&gt;&gt;</span> <span>1</span>);</td>
      </tr>
      <tr>
        <td id="L13221" data-line-number="13221"></td>
        <td id="LC13221">
</td>
      </tr>
      <tr>
        <td id="L13222" data-line-number="13222"></td>
        <td id="LC13222">            <span>for</span> (<span>int</span> <span>ii</span> <span>=</span> <span>0</span>; <span>ii</span> <span>&lt;</span> <span>charsRead</span>; <span>ii</span><span>++</span>)</td>
      </tr>
      <tr>
        <td id="L13223" data-line-number="13223"></td>
        <td id="LC13223">            {</td>
      </tr>
      <tr>
        <td id="L13224" data-line-number="13224"></td>
        <td id="LC13224">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadChar</span>(<span>out</span> <span>buff</span>[<span>offst</span> <span>+</span> <span>ii</span>]))</td>
      </tr>
      <tr>
        <td id="L13225" data-line-number="13225"></td>
        <td id="LC13225">                {</td>
      </tr>
      <tr>
        <td id="L13226" data-line-number="13226"></td>
        <td id="LC13226">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13227" data-line-number="13227"></td>
        <td id="LC13227">                }</td>
      </tr>
      <tr>
        <td id="L13228" data-line-number="13228"></td>
        <td id="LC13228">            }</td>
      </tr>
      <tr>
        <td id="L13229" data-line-number="13229"></td>
        <td id="LC13229">
</td>
      </tr>
      <tr>
        <td id="L13230" data-line-number="13230"></td>
        <td id="LC13230">            <span>stateObj</span>.<span>_longlenleft</span> <span>-=</span> ((<span>ulong</span>)<span>charsRead</span> <span>&lt;&lt;</span> <span>1</span>);</td>
      </tr>
      <tr>
        <td id="L13231" data-line-number="13231"></td>
        <td id="LC13231">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L13232" data-line-number="13232"></td>
        <td id="LC13232">        }</td>
      </tr>
      <tr>
        <td id="L13233" data-line-number="13233"></td>
        <td id="LC13233">
</td>
      </tr>
      <tr>
        <td id="L13234" data-line-number="13234"></td>
        <td id="LC13234">        <span>internal</span> <span>int</span> <span>ReadPlpUnicodeChars</span>(<span>ref</span> <span>char</span>[] <span>buff</span>, <span>int</span> <span>offst</span>, <span>int</span> <span>len</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L13235" data-line-number="13235"></td>
        <td id="LC13235">        {</td>
      </tr>
      <tr>
        <td id="L13236" data-line-number="13236"></td>
        <td id="LC13236">            <span>int</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13237" data-line-number="13237"></td>
        <td id="LC13237">            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_syncOverAsync</span>, <span><span>"</span>Should not attempt pends in a synchronous call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13238" data-line-number="13238"></td>
        <td id="LC13238">            <span>bool</span> <span>result</span> <span>=</span> <span>TryReadPlpUnicodeChars</span>(<span>ref</span> <span>buff</span>, <span>offst</span>, <span>len</span>, <span>stateObj</span>, <span>out</span> <span>charsRead</span>);</td>
      </tr>
      <tr>
        <td id="L13239" data-line-number="13239"></td>
        <td id="LC13239">            <span>if</span> (<span>!</span><span>result</span>)</td>
      </tr>
      <tr>
        <td id="L13240" data-line-number="13240"></td>
        <td id="LC13240">            { <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>(); }</td>
      </tr>
      <tr>
        <td id="L13241" data-line-number="13241"></td>
        <td id="LC13241">            <span>return</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13242" data-line-number="13242"></td>
        <td id="LC13242">        }</td>
      </tr>
      <tr>
        <td id="L13243" data-line-number="13243"></td>
        <td id="LC13243">
</td>
      </tr>
      <tr>
        <td id="L13244" data-line-number="13244"></td>
        <td id="LC13244">        <span><span>//</span> Reads the requested number of chars from a plp data stream, or the entire data if</span></td>
      </tr>
      <tr>
        <td id="L13245" data-line-number="13245"></td>
        <td id="LC13245">        <span><span>//</span> requested length is -1 or larger than the actual length of data. First call to this method</span></td>
      </tr>
      <tr>
        <td id="L13246" data-line-number="13246"></td>
        <td id="LC13246">        <span><span>//</span>  should be preceeded by a call to ReadPlpLength or ReadDataLength.</span></td>
      </tr>
      <tr>
        <td id="L13247" data-line-number="13247"></td>
        <td id="LC13247">        <span><span>//</span> Returns the actual chars read.</span></td>
      </tr>
      <tr>
        <td id="L13248" data-line-number="13248"></td>
        <td id="LC13248">        <span>internal</span> <span>bool</span> <span>TryReadPlpUnicodeChars</span>(<span>ref</span> <span>char</span>[] <span>buff</span>, <span>int</span> <span>offst</span>, <span>int</span> <span>len</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>int</span> <span>totalCharsRead</span>)</td>
      </tr>
      <tr>
        <td id="L13249" data-line-number="13249"></td>
        <td id="LC13249">        {</td>
      </tr>
      <tr>
        <td id="L13250" data-line-number="13250"></td>
        <td id="LC13250">            <span>int</span> <span>charsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13251" data-line-number="13251"></td>
        <td id="LC13251">            <span>int</span> <span>charsLeft</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13252" data-line-number="13252"></td>
        <td id="LC13252">            <span>char</span>[] <span>newbuf</span>;</td>
      </tr>
      <tr>
        <td id="L13253" data-line-number="13253"></td>
        <td id="LC13253">
</td>
      </tr>
      <tr>
        <td id="L13254" data-line-number="13254"></td>
        <td id="LC13254">            <span>if</span> (<span>stateObj</span>.<span>_longlen</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13255" data-line-number="13255"></td>
        <td id="LC13255">            {</td>
      </tr>
      <tr>
        <td id="L13256" data-line-number="13256"></td>
        <td id="LC13256">                <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L13257" data-line-number="13257"></td>
        <td id="LC13257">                <span>totalCharsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13258" data-line-number="13258"></td>
        <td id="LC13258">                <span>return</span> <span>true</span>;       <span><span>//</span> No data</span></td>
      </tr>
      <tr>
        <td id="L13259" data-line-number="13259"></td>
        <td id="LC13259">            }</td>
      </tr>
      <tr>
        <td id="L13260" data-line-number="13260"></td>
        <td id="LC13260">
</td>
      </tr>
      <tr>
        <td id="L13261" data-line-number="13261"></td>
        <td id="LC13261">            <span>Debug</span>.<span>Assert</span>(((<span>ulong</span>)<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>TdsEnums</span>.<span>SQL_PLP_NULL</span>),</td>
      </tr>
      <tr>
        <td id="L13262" data-line-number="13262"></td>
        <td id="LC13262">                    <span><span>"</span>Out of sync plp read request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13263" data-line-number="13263"></td>
        <td id="LC13263">
</td>
      </tr>
      <tr>
        <td id="L13264" data-line-number="13264"></td>
        <td id="LC13264">            <span>Debug</span>.<span>Assert</span>((<span>buff</span> <span>==</span> <span>null</span> <span>&amp;&amp;</span> <span>offst</span> <span>==</span> <span>0</span>) <span>||</span> (<span>buff</span>.<span>Length</span> <span>&gt;=</span> <span>offst</span> <span>+</span> <span>len</span>), <span><span>"</span>Invalid length sent to ReadPlpUnicodeChars()!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13265" data-line-number="13265"></td>
        <td id="LC13265">            <span>charsLeft</span> <span>=</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L13266" data-line-number="13266"></td>
        <td id="LC13266">
</td>
      </tr>
      <tr>
        <td id="L13267" data-line-number="13267"></td>
        <td id="LC13267">            <span><span>//</span> If total length is known up front, allocate the whole buffer in one shot instead of realloc'ing and copying over each time</span></td>
      </tr>
      <tr>
        <td id="L13268" data-line-number="13268"></td>
        <td id="LC13268">            <span>if</span> (<span>buff</span> <span>==</span> <span>null</span> <span>&amp;&amp;</span> <span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>TdsEnums</span>.<span>SQL_PLP_UNKNOWNLEN</span>)</td>
      </tr>
      <tr>
        <td id="L13269" data-line-number="13269"></td>
        <td id="LC13269">            {</td>
      </tr>
      <tr>
        <td id="L13270" data-line-number="13270"></td>
        <td id="LC13270">                <span>buff</span> <span>=</span> <span>new</span> <span>char</span>[(<span>int</span>)<span>Math</span>.<span>Min</span>((<span>int</span>)<span>stateObj</span>.<span>_longlen</span>, <span>len</span>)];</td>
      </tr>
      <tr>
        <td id="L13271" data-line-number="13271"></td>
        <td id="LC13271">            }</td>
      </tr>
      <tr>
        <td id="L13272" data-line-number="13272"></td>
        <td id="LC13272">
</td>
      </tr>
      <tr>
        <td id="L13273" data-line-number="13273"></td>
        <td id="LC13273">            <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13274" data-line-number="13274"></td>
        <td id="LC13274">            {</td>
      </tr>
      <tr>
        <td id="L13275" data-line-number="13275"></td>
        <td id="LC13275">                <span>ulong</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L13276" data-line-number="13276"></td>
        <td id="LC13276">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadPlpLength</span>(<span>false</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L13277" data-line-number="13277"></td>
        <td id="LC13277">                {</td>
      </tr>
      <tr>
        <td id="L13278" data-line-number="13278"></td>
        <td id="LC13278">                    <span>totalCharsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13279" data-line-number="13279"></td>
        <td id="LC13279">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13280" data-line-number="13280"></td>
        <td id="LC13280">                }</td>
      </tr>
      <tr>
        <td id="L13281" data-line-number="13281"></td>
        <td id="LC13281">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13282" data-line-number="13282"></td>
        <td id="LC13282">                { <span><span>//</span> Data read complete</span></td>
      </tr>
      <tr>
        <td id="L13283" data-line-number="13283"></td>
        <td id="LC13283">                    <span>totalCharsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13284" data-line-number="13284"></td>
        <td id="LC13284">                    <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L13285" data-line-number="13285"></td>
        <td id="LC13285">                }</td>
      </tr>
      <tr>
        <td id="L13286" data-line-number="13286"></td>
        <td id="LC13286">            }</td>
      </tr>
      <tr>
        <td id="L13287" data-line-number="13287"></td>
        <td id="LC13287">
</td>
      </tr>
      <tr>
        <td id="L13288" data-line-number="13288"></td>
        <td id="LC13288">            <span>totalCharsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13289" data-line-number="13289"></td>
        <td id="LC13289">
</td>
      </tr>
      <tr>
        <td id="L13290" data-line-number="13290"></td>
        <td id="LC13290">            <span>while</span> (<span>charsLeft</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13291" data-line-number="13291"></td>
        <td id="LC13291">            {</td>
      </tr>
      <tr>
        <td id="L13292" data-line-number="13292"></td>
        <td id="LC13292">                <span>charsRead</span> <span>=</span> (<span>int</span>)<span>Math</span>.<span>Min</span>((<span>stateObj</span>.<span>_longlenleft</span> <span>+</span> <span>1</span>) <span>&gt;&gt;</span> <span>1</span>, (<span>ulong</span>)<span>charsLeft</span>);</td>
      </tr>
      <tr>
        <td id="L13293" data-line-number="13293"></td>
        <td id="LC13293">                <span>if</span> ((<span>buff</span> <span>==</span> <span>null</span>) <span>||</span> (<span>buff</span>.<span>Length</span> <span>&lt;</span> (<span>offst</span> <span>+</span> <span>charsRead</span>)))</td>
      </tr>
      <tr>
        <td id="L13294" data-line-number="13294"></td>
        <td id="LC13294">                {</td>
      </tr>
      <tr>
        <td id="L13295" data-line-number="13295"></td>
        <td id="LC13295">                    <span><span>//</span> Grow the array</span></td>
      </tr>
      <tr>
        <td id="L13296" data-line-number="13296"></td>
        <td id="LC13296">                    <span>newbuf</span> <span>=</span> <span>new</span> <span>char</span>[<span>offst</span> <span>+</span> <span>charsRead</span>];</td>
      </tr>
      <tr>
        <td id="L13297" data-line-number="13297"></td>
        <td id="LC13297">                    <span>if</span> (<span>buff</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L13298" data-line-number="13298"></td>
        <td id="LC13298">                    {</td>
      </tr>
      <tr>
        <td id="L13299" data-line-number="13299"></td>
        <td id="LC13299">                        <span>Buffer</span>.<span>BlockCopy</span>(<span>buff</span>, <span>0</span>, <span>newbuf</span>, <span>0</span>, <span>offst</span> <span>*</span> <span>2</span>);</td>
      </tr>
      <tr>
        <td id="L13300" data-line-number="13300"></td>
        <td id="LC13300">                    }</td>
      </tr>
      <tr>
        <td id="L13301" data-line-number="13301"></td>
        <td id="LC13301">                    <span>buff</span> <span>=</span> <span>newbuf</span>;</td>
      </tr>
      <tr>
        <td id="L13302" data-line-number="13302"></td>
        <td id="LC13302">                }</td>
      </tr>
      <tr>
        <td id="L13303" data-line-number="13303"></td>
        <td id="LC13303">                <span>if</span> (<span>charsRead</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13304" data-line-number="13304"></td>
        <td id="LC13304">                {</td>
      </tr>
      <tr>
        <td id="L13305" data-line-number="13305"></td>
        <td id="LC13305">                    <span>if</span> (<span>!</span><span>TryReadPlpUnicodeCharsChunk</span>(<span>buff</span>, <span>offst</span>, <span>charsRead</span>, <span>stateObj</span>, <span>out</span> <span>charsRead</span>))</td>
      </tr>
      <tr>
        <td id="L13306" data-line-number="13306"></td>
        <td id="LC13306">                    {</td>
      </tr>
      <tr>
        <td id="L13307" data-line-number="13307"></td>
        <td id="LC13307">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13308" data-line-number="13308"></td>
        <td id="LC13308">                    }</td>
      </tr>
      <tr>
        <td id="L13309" data-line-number="13309"></td>
        <td id="LC13309">                    <span>charsLeft</span> <span>-=</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13310" data-line-number="13310"></td>
        <td id="LC13310">                    <span>offst</span> <span>+=</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13311" data-line-number="13311"></td>
        <td id="LC13311">                    <span>totalCharsRead</span> <span>+=</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13312" data-line-number="13312"></td>
        <td id="LC13312">                }</td>
      </tr>
      <tr>
        <td id="L13313" data-line-number="13313"></td>
        <td id="LC13313">                <span><span>//</span> Special case single byte left</span></td>
      </tr>
      <tr>
        <td id="L13314" data-line-number="13314"></td>
        <td id="LC13314">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>1</span> <span>&amp;&amp;</span> (<span>charsLeft</span> <span>&gt;</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L13315" data-line-number="13315"></td>
        <td id="LC13315">                {</td>
      </tr>
      <tr>
        <td id="L13316" data-line-number="13316"></td>
        <td id="LC13316">                    <span>byte</span> <span>b1</span>;</td>
      </tr>
      <tr>
        <td id="L13317" data-line-number="13317"></td>
        <td id="LC13317">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>b1</span>))</td>
      </tr>
      <tr>
        <td id="L13318" data-line-number="13318"></td>
        <td id="LC13318">                    {</td>
      </tr>
      <tr>
        <td id="L13319" data-line-number="13319"></td>
        <td id="LC13319">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13320" data-line-number="13320"></td>
        <td id="LC13320">                    }</td>
      </tr>
      <tr>
        <td id="L13321" data-line-number="13321"></td>
        <td id="LC13321">                    <span>stateObj</span>.<span>_longlenleft</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L13322" data-line-number="13322"></td>
        <td id="LC13322">                    <span>ulong</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L13323" data-line-number="13323"></td>
        <td id="LC13323">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadPlpLength</span>(<span>false</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L13324" data-line-number="13324"></td>
        <td id="LC13324">                    {</td>
      </tr>
      <tr>
        <td id="L13325" data-line-number="13325"></td>
        <td id="LC13325">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13326" data-line-number="13326"></td>
        <td id="LC13326">                    }</td>
      </tr>
      <tr>
        <td id="L13327" data-line-number="13327"></td>
        <td id="LC13327">                    <span>Debug</span>.<span>Assert</span>((<span>stateObj</span>.<span>_longlenleft</span> <span>!=</span> <span>0</span>), <span><span>"</span>ReadPlpUnicodeChars: Odd byte left at the end!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13328" data-line-number="13328"></td>
        <td id="LC13328">                    <span>byte</span> <span>b2</span>;</td>
      </tr>
      <tr>
        <td id="L13329" data-line-number="13329"></td>
        <td id="LC13329">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadByte</span>(<span>out</span> <span>b2</span>))</td>
      </tr>
      <tr>
        <td id="L13330" data-line-number="13330"></td>
        <td id="LC13330">                    {</td>
      </tr>
      <tr>
        <td id="L13331" data-line-number="13331"></td>
        <td id="LC13331">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13332" data-line-number="13332"></td>
        <td id="LC13332">                    }</td>
      </tr>
      <tr>
        <td id="L13333" data-line-number="13333"></td>
        <td id="LC13333">                    <span>stateObj</span>.<span>_longlenleft</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L13334" data-line-number="13334"></td>
        <td id="LC13334">                    <span><span>//</span> Put it at the end of the array. At this point we know we have an extra byte.</span></td>
      </tr>
      <tr>
        <td id="L13335" data-line-number="13335"></td>
        <td id="LC13335">                    <span>buff</span>[<span>offst</span>] <span>=</span> (<span>char</span>)(((<span>b2</span> <span>&amp;</span> <span>0xff</span>) <span>&lt;&lt;</span> <span>8</span>) <span>+</span> (<span>b1</span> <span>&amp;</span> <span>0xff</span>));</td>
      </tr>
      <tr>
        <td id="L13336" data-line-number="13336"></td>
        <td id="LC13336">                    <span>offst</span> <span>=</span> <span>checked</span>((<span>int</span>)<span>offst</span> <span>+</span> <span>1</span>);</td>
      </tr>
      <tr>
        <td id="L13337" data-line-number="13337"></td>
        <td id="LC13337">                    <span>charsRead</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L13338" data-line-number="13338"></td>
        <td id="LC13338">                    <span>charsLeft</span><span>--</span>;</td>
      </tr>
      <tr>
        <td id="L13339" data-line-number="13339"></td>
        <td id="LC13339">                    <span>totalCharsRead</span><span>++</span>;</td>
      </tr>
      <tr>
        <td id="L13340" data-line-number="13340"></td>
        <td id="LC13340">                }</td>
      </tr>
      <tr>
        <td id="L13341" data-line-number="13341"></td>
        <td id="LC13341">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13342" data-line-number="13342"></td>
        <td id="LC13342">                { <span><span>//</span> Read the next chunk or cleanup state if hit the end</span></td>
      </tr>
      <tr>
        <td id="L13343" data-line-number="13343"></td>
        <td id="LC13343">                    <span>ulong</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L13344" data-line-number="13344"></td>
        <td id="LC13344">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadPlpLength</span>(<span>false</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L13345" data-line-number="13345"></td>
        <td id="LC13345">                    {</td>
      </tr>
      <tr>
        <td id="L13346" data-line-number="13346"></td>
        <td id="LC13346">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13347" data-line-number="13347"></td>
        <td id="LC13347">                    }</td>
      </tr>
      <tr>
        <td id="L13348" data-line-number="13348"></td>
        <td id="LC13348">                }</td>
      </tr>
      <tr>
        <td id="L13349" data-line-number="13349"></td>
        <td id="LC13349">
</td>
      </tr>
      <tr>
        <td id="L13350" data-line-number="13350"></td>
        <td id="LC13350">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)   <span><span>//</span> Data read complete</span></td>
      </tr>
      <tr>
        <td id="L13351" data-line-number="13351"></td>
        <td id="LC13351">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L13352" data-line-number="13352"></td>
        <td id="LC13352">            }</td>
      </tr>
      <tr>
        <td id="L13353" data-line-number="13353"></td>
        <td id="LC13353">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L13354" data-line-number="13354"></td>
        <td id="LC13354">        }</td>
      </tr>
      <tr>
        <td id="L13355" data-line-number="13355"></td>
        <td id="LC13355">
</td>
      </tr>
      <tr>
        <td id="L13356" data-line-number="13356"></td>
        <td id="LC13356">        <span>internal</span> <span>int</span> <span>ReadPlpAnsiChars</span>(<span>ref</span> <span>char</span>[] <span>buff</span>, <span>int</span> <span>offst</span>, <span>int</span> <span>len</span>, <span>SqlMetaDataPriv</span> <span>metadata</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L13357" data-line-number="13357"></td>
        <td id="LC13357">        {</td>
      </tr>
      <tr>
        <td id="L13358" data-line-number="13358"></td>
        <td id="LC13358">            <span>int</span> <span>charsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13359" data-line-number="13359"></td>
        <td id="LC13359">            <span>int</span> <span>charsLeft</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13360" data-line-number="13360"></td>
        <td id="LC13360">            <span>int</span> <span>bytesRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13361" data-line-number="13361"></td>
        <td id="LC13361">            <span>int</span> <span>totalcharsRead</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13362" data-line-number="13362"></td>
        <td id="LC13362">
</td>
      </tr>
      <tr>
        <td id="L13363" data-line-number="13363"></td>
        <td id="LC13363">            <span>if</span> (<span>stateObj</span>.<span>_longlen</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13364" data-line-number="13364"></td>
        <td id="LC13364">            {</td>
      </tr>
      <tr>
        <td id="L13365" data-line-number="13365"></td>
        <td id="LC13365">                <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>);</td>
      </tr>
      <tr>
        <td id="L13366" data-line-number="13366"></td>
        <td id="LC13366">                <span>return</span> <span>0</span>;       <span><span>//</span> No data</span></td>
      </tr>
      <tr>
        <td id="L13367" data-line-number="13367"></td>
        <td id="LC13367">            }</td>
      </tr>
      <tr>
        <td id="L13368" data-line-number="13368"></td>
        <td id="LC13368">
</td>
      </tr>
      <tr>
        <td id="L13369" data-line-number="13369"></td>
        <td id="LC13369">            <span>Debug</span>.<span>Assert</span>(((<span>ulong</span>)<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>TdsEnums</span>.<span>SQL_PLP_NULL</span>),</td>
      </tr>
      <tr>
        <td id="L13370" data-line-number="13370"></td>
        <td id="LC13370">                    <span><span>"</span>Out of sync plp read request<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13371" data-line-number="13371"></td>
        <td id="LC13371">
</td>
      </tr>
      <tr>
        <td id="L13372" data-line-number="13372"></td>
        <td id="LC13372">            <span>Debug</span>.<span>Assert</span>((<span>buff</span> <span>==</span> <span>null</span> <span>&amp;&amp;</span> <span>offst</span> <span>==</span> <span>0</span>) <span>||</span> (<span>buff</span>.<span>Length</span> <span>&gt;=</span> <span>offst</span> <span>+</span> <span>len</span>), <span><span>"</span>Invalid length sent to ReadPlpAnsiChars()!<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13373" data-line-number="13373"></td>
        <td id="LC13373">            <span>charsLeft</span> <span>=</span> <span>len</span>;</td>
      </tr>
      <tr>
        <td id="L13374" data-line-number="13374"></td>
        <td id="LC13374">
</td>
      </tr>
      <tr>
        <td id="L13375" data-line-number="13375"></td>
        <td id="LC13375">            <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13376" data-line-number="13376"></td>
        <td id="LC13376">            {</td>
      </tr>
      <tr>
        <td id="L13377" data-line-number="13377"></td>
        <td id="LC13377">                <span>stateObj</span>.<span>ReadPlpLength</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L13378" data-line-number="13378"></td>
        <td id="LC13378">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13379" data-line-number="13379"></td>
        <td id="LC13379">                {<span><span>//</span> Data read complete</span></td>
      </tr>
      <tr>
        <td id="L13380" data-line-number="13380"></td>
        <td id="LC13380">                    <span>stateObj</span>.<span>_plpdecoder</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L13381" data-line-number="13381"></td>
        <td id="LC13381">                    <span>return</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13382" data-line-number="13382"></td>
        <td id="LC13382">                }</td>
      </tr>
      <tr>
        <td id="L13383" data-line-number="13383"></td>
        <td id="LC13383">            }</td>
      </tr>
      <tr>
        <td id="L13384" data-line-number="13384"></td>
        <td id="LC13384">
</td>
      </tr>
      <tr>
        <td id="L13385" data-line-number="13385"></td>
        <td id="LC13385">            <span>if</span> (<span>stateObj</span>.<span>_plpdecoder</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L13386" data-line-number="13386"></td>
        <td id="LC13386">            {</td>
      </tr>
      <tr>
        <td id="L13387" data-line-number="13387"></td>
        <td id="LC13387">                <span>Encoding</span> <span>enc</span> <span>=</span> <span>metadata</span>.<span>encoding</span>;</td>
      </tr>
      <tr>
        <td id="L13388" data-line-number="13388"></td>
        <td id="LC13388">
</td>
      </tr>
      <tr>
        <td id="L13389" data-line-number="13389"></td>
        <td id="LC13389">                <span>if</span> (<span>enc</span> <span>==</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L13390" data-line-number="13390"></td>
        <td id="LC13390">                {</td>
      </tr>
      <tr>
        <td id="L13391" data-line-number="13391"></td>
        <td id="LC13391">                    <span>if</span> (<span>null</span> <span>==</span> <span>_defaultEncoding</span>)</td>
      </tr>
      <tr>
        <td id="L13392" data-line-number="13392"></td>
        <td id="LC13392">                    {</td>
      </tr>
      <tr>
        <td id="L13393" data-line-number="13393"></td>
        <td id="LC13393">                        <span>ThrowUnsupportedCollationEncountered</span>(<span>stateObj</span>);</td>
      </tr>
      <tr>
        <td id="L13394" data-line-number="13394"></td>
        <td id="LC13394">
</td>
      </tr>
      <tr>
        <td id="L13395" data-line-number="13395"></td>
        <td id="LC13395">                    }</td>
      </tr>
      <tr>
        <td id="L13396" data-line-number="13396"></td>
        <td id="LC13396">
</td>
      </tr>
      <tr>
        <td id="L13397" data-line-number="13397"></td>
        <td id="LC13397">                    <span>enc</span> <span>=</span> <span>_defaultEncoding</span>;</td>
      </tr>
      <tr>
        <td id="L13398" data-line-number="13398"></td>
        <td id="LC13398">                }</td>
      </tr>
      <tr>
        <td id="L13399" data-line-number="13399"></td>
        <td id="LC13399">                <span>stateObj</span>.<span>_plpdecoder</span> <span>=</span> <span>enc</span>.<span>GetDecoder</span>();</td>
      </tr>
      <tr>
        <td id="L13400" data-line-number="13400"></td>
        <td id="LC13400">            }</td>
      </tr>
      <tr>
        <td id="L13401" data-line-number="13401"></td>
        <td id="LC13401">
</td>
      </tr>
      <tr>
        <td id="L13402" data-line-number="13402"></td>
        <td id="LC13402">            <span>while</span> (<span>charsLeft</span> <span>&gt;</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13403" data-line-number="13403"></td>
        <td id="LC13403">            {</td>
      </tr>
      <tr>
        <td id="L13404" data-line-number="13404"></td>
        <td id="LC13404">                <span>bytesRead</span> <span>=</span> (<span>int</span>)<span>Math</span>.<span>Min</span>(<span>stateObj</span>.<span>_longlenleft</span>, (<span>ulong</span>)<span>charsLeft</span>);</td>
      </tr>
      <tr>
        <td id="L13405" data-line-number="13405"></td>
        <td id="LC13405">                <span>if</span> ((<span>stateObj</span>.<span>_bTmp</span> <span>==</span> <span>null</span>) <span>||</span> (<span>stateObj</span>.<span>_bTmp</span>.<span>Length</span> <span>&lt;</span> <span>bytesRead</span>))</td>
      </tr>
      <tr>
        <td id="L13406" data-line-number="13406"></td>
        <td id="LC13406">                {</td>
      </tr>
      <tr>
        <td id="L13407" data-line-number="13407"></td>
        <td id="LC13407">                    <span><span>//</span> Grow the array</span></td>
      </tr>
      <tr>
        <td id="L13408" data-line-number="13408"></td>
        <td id="LC13408">                    <span>stateObj</span>.<span>_bTmp</span> <span>=</span> <span>new</span> <span>byte</span>[<span>bytesRead</span>];</td>
      </tr>
      <tr>
        <td id="L13409" data-line-number="13409"></td>
        <td id="LC13409">                }</td>
      </tr>
      <tr>
        <td id="L13410" data-line-number="13410"></td>
        <td id="LC13410">
</td>
      </tr>
      <tr>
        <td id="L13411" data-line-number="13411"></td>
        <td id="LC13411">                <span>bytesRead</span> <span>=</span> <span>stateObj</span>.<span>ReadPlpBytesChunk</span>(<span>stateObj</span>.<span>_bTmp</span>, <span>0</span>, <span>bytesRead</span>);</td>
      </tr>
      <tr>
        <td id="L13412" data-line-number="13412"></td>
        <td id="LC13412">
</td>
      </tr>
      <tr>
        <td id="L13413" data-line-number="13413"></td>
        <td id="LC13413">                <span>charsRead</span> <span>=</span> <span>stateObj</span>.<span>_plpdecoder</span>.<span>GetChars</span>(<span>stateObj</span>.<span>_bTmp</span>, <span>0</span>, <span>bytesRead</span>, <span>buff</span>, <span>offst</span>);</td>
      </tr>
      <tr>
        <td id="L13414" data-line-number="13414"></td>
        <td id="LC13414">                <span>charsLeft</span> <span>-=</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13415" data-line-number="13415"></td>
        <td id="LC13415">                <span>offst</span> <span>+=</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13416" data-line-number="13416"></td>
        <td id="LC13416">                <span>totalcharsRead</span> <span>+=</span> <span>charsRead</span>;</td>
      </tr>
      <tr>
        <td id="L13417" data-line-number="13417"></td>
        <td id="LC13417">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)  <span><span>//</span> Read the next chunk or cleanup state if hit the end</span></td>
      </tr>
      <tr>
        <td id="L13418" data-line-number="13418"></td>
        <td id="LC13418">                    <span>stateObj</span>.<span>ReadPlpLength</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L13419" data-line-number="13419"></td>
        <td id="LC13419">
</td>
      </tr>
      <tr>
        <td id="L13420" data-line-number="13420"></td>
        <td id="LC13420">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13421" data-line-number="13421"></td>
        <td id="LC13421">                { <span><span>//</span> Data read complete</span></td>
      </tr>
      <tr>
        <td id="L13422" data-line-number="13422"></td>
        <td id="LC13422">                    <span>stateObj</span>.<span>_plpdecoder</span> <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="L13423" data-line-number="13423"></td>
        <td id="LC13423">                    <span>break</span>;</td>
      </tr>
      <tr>
        <td id="L13424" data-line-number="13424"></td>
        <td id="LC13424">                }</td>
      </tr>
      <tr>
        <td id="L13425" data-line-number="13425"></td>
        <td id="LC13425">            }</td>
      </tr>
      <tr>
        <td id="L13426" data-line-number="13426"></td>
        <td id="LC13426">            <span>return</span> (<span>totalcharsRead</span>);</td>
      </tr>
      <tr>
        <td id="L13427" data-line-number="13427"></td>
        <td id="LC13427">        }</td>
      </tr>
      <tr>
        <td id="L13428" data-line-number="13428"></td>
        <td id="LC13428">
</td>
      </tr>
      <tr>
        <td id="L13429" data-line-number="13429"></td>
        <td id="LC13429">        <span><span>//</span> ensure value is not null and does not have an NBC bit set for it before using this method</span></td>
      </tr>
      <tr>
        <td id="L13430" data-line-number="13430"></td>
        <td id="LC13430">        <span>internal</span> <span>ulong</span> <span>SkipPlpValue</span>(<span>ulong</span> <span>cb</span>, <span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L13431" data-line-number="13431"></td>
        <td id="LC13431">        {</td>
      </tr>
      <tr>
        <td id="L13432" data-line-number="13432"></td>
        <td id="LC13432">            <span>ulong</span> <span>skipped</span>;</td>
      </tr>
      <tr>
        <td id="L13433" data-line-number="13433"></td>
        <td id="LC13433">            <span>Debug</span>.<span>Assert</span>(<span>stateObj</span>.<span>_syncOverAsync</span>, <span><span>"</span>Should not attempt pends in a synchronous call<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="L13434" data-line-number="13434"></td>
        <td id="LC13434">            <span>bool</span> <span>result</span> <span>=</span> <span>TrySkipPlpValue</span>(<span>cb</span>, <span>stateObj</span>, <span>out</span> <span>skipped</span>);</td>
      </tr>
      <tr>
        <td id="L13435" data-line-number="13435"></td>
        <td id="LC13435">            <span>if</span> (<span>!</span><span>result</span>)</td>
      </tr>
      <tr>
        <td id="L13436" data-line-number="13436"></td>
        <td id="LC13436">            { <span>throw</span> <span>SQL</span>.<span>SynchronousCallMayNotPend</span>(); }</td>
      </tr>
      <tr>
        <td id="L13437" data-line-number="13437"></td>
        <td id="LC13437">            <span>return</span> <span>skipped</span>;</td>
      </tr>
      <tr>
        <td id="L13438" data-line-number="13438"></td>
        <td id="LC13438">        }</td>
      </tr>
      <tr>
        <td id="L13439" data-line-number="13439"></td>
        <td id="LC13439">
</td>
      </tr>
      <tr>
        <td id="L13440" data-line-number="13440"></td>
        <td id="LC13440">        <span>internal</span> <span>bool</span> <span>TrySkipPlpValue</span>(<span>ulong</span> <span>cb</span>, <span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>ulong</span> <span>totalBytesSkipped</span>)</td>
      </tr>
      <tr>
        <td id="L13441" data-line-number="13441"></td>
        <td id="LC13441">        {</td>
      </tr>
      <tr>
        <td id="L13442" data-line-number="13442"></td>
        <td id="LC13442">            <span><span>//</span> Read and skip cb bytes or until  ReadPlpLength returns 0.</span></td>
      </tr>
      <tr>
        <td id="L13443" data-line-number="13443"></td>
        <td id="LC13443">            <span>int</span> <span>bytesSkipped</span>;</td>
      </tr>
      <tr>
        <td id="L13444" data-line-number="13444"></td>
        <td id="LC13444">            <span>totalBytesSkipped</span> <span>=</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13445" data-line-number="13445"></td>
        <td id="LC13445">
</td>
      </tr>
      <tr>
        <td id="L13446" data-line-number="13446"></td>
        <td id="LC13446">            <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13447" data-line-number="13447"></td>
        <td id="LC13447">            {</td>
      </tr>
      <tr>
        <td id="L13448" data-line-number="13448"></td>
        <td id="LC13448">                <span>ulong</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L13449" data-line-number="13449"></td>
        <td id="LC13449">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadPlpLength</span>(<span>false</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L13450" data-line-number="13450"></td>
        <td id="LC13450">                {</td>
      </tr>
      <tr>
        <td id="L13451" data-line-number="13451"></td>
        <td id="LC13451">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13452" data-line-number="13452"></td>
        <td id="LC13452">                }</td>
      </tr>
      <tr>
        <td id="L13453" data-line-number="13453"></td>
        <td id="LC13453">            }</td>
      </tr>
      <tr>
        <td id="L13454" data-line-number="13454"></td>
        <td id="LC13454">
</td>
      </tr>
      <tr>
        <td id="L13455" data-line-number="13455"></td>
        <td id="LC13455">            <span>while</span> ((<span>totalBytesSkipped</span> <span>&lt;</span> <span>cb</span>) <span>&amp;&amp;</span></td>
      </tr>
      <tr>
        <td id="L13456" data-line-number="13456"></td>
        <td id="LC13456">                    (<span>stateObj</span>.<span>_longlenleft</span> <span>&gt;</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L13457" data-line-number="13457"></td>
        <td id="LC13457">            {</td>
      </tr>
      <tr>
        <td id="L13458" data-line-number="13458"></td>
        <td id="LC13458">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>&gt;</span> <span>Int32</span>.<span>MaxValue</span>)</td>
      </tr>
      <tr>
        <td id="L13459" data-line-number="13459"></td>
        <td id="LC13459">                    <span>bytesSkipped</span> <span>=</span> <span>Int32</span>.<span>MaxValue</span>;</td>
      </tr>
      <tr>
        <td id="L13460" data-line-number="13460"></td>
        <td id="LC13460">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L13461" data-line-number="13461"></td>
        <td id="LC13461">                    <span>bytesSkipped</span> <span>=</span> (<span>int</span>)<span>stateObj</span>.<span>_longlenleft</span>;</td>
      </tr>
      <tr>
        <td id="L13462" data-line-number="13462"></td>
        <td id="LC13462">                <span>bytesSkipped</span> <span>=</span> ((<span>cb</span> <span>-</span> <span>totalBytesSkipped</span>) <span>&lt;</span> (<span>ulong</span>)<span>bytesSkipped</span>) <span>?</span> (<span>int</span>)(<span>cb</span> <span>-</span> <span>totalBytesSkipped</span>) <span>:</span> <span>bytesSkipped</span>;</td>
      </tr>
      <tr>
        <td id="L13463" data-line-number="13463"></td>
        <td id="LC13463">
</td>
      </tr>
      <tr>
        <td id="L13464" data-line-number="13464"></td>
        <td id="LC13464">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TrySkipBytes</span>(<span>bytesSkipped</span>))</td>
      </tr>
      <tr>
        <td id="L13465" data-line-number="13465"></td>
        <td id="LC13465">                {</td>
      </tr>
      <tr>
        <td id="L13466" data-line-number="13466"></td>
        <td id="LC13466">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13467" data-line-number="13467"></td>
        <td id="LC13467">                }</td>
      </tr>
      <tr>
        <td id="L13468" data-line-number="13468"></td>
        <td id="LC13468">                <span>stateObj</span>.<span>_longlenleft</span> <span>-=</span> (<span>ulong</span>)<span>bytesSkipped</span>;</td>
      </tr>
      <tr>
        <td id="L13469" data-line-number="13469"></td>
        <td id="LC13469">                <span>totalBytesSkipped</span> <span>+=</span> (<span>ulong</span>)<span>bytesSkipped</span>;</td>
      </tr>
      <tr>
        <td id="L13470" data-line-number="13470"></td>
        <td id="LC13470">
</td>
      </tr>
      <tr>
        <td id="L13471" data-line-number="13471"></td>
        <td id="LC13471">                <span>if</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>)</td>
      </tr>
      <tr>
        <td id="L13472" data-line-number="13472"></td>
        <td id="LC13472">                {</td>
      </tr>
      <tr>
        <td id="L13473" data-line-number="13473"></td>
        <td id="LC13473">                    <span>ulong</span> <span>ignored</span>;</td>
      </tr>
      <tr>
        <td id="L13474" data-line-number="13474"></td>
        <td id="LC13474">                    <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadPlpLength</span>(<span>false</span>, <span>out</span> <span>ignored</span>))</td>
      </tr>
      <tr>
        <td id="L13475" data-line-number="13475"></td>
        <td id="LC13475">                    {</td>
      </tr>
      <tr>
        <td id="L13476" data-line-number="13476"></td>
        <td id="LC13476">                        <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13477" data-line-number="13477"></td>
        <td id="LC13477">                    }</td>
      </tr>
      <tr>
        <td id="L13478" data-line-number="13478"></td>
        <td id="LC13478">                }</td>
      </tr>
      <tr>
        <td id="L13479" data-line-number="13479"></td>
        <td id="LC13479">            }</td>
      </tr>
      <tr>
        <td id="L13480" data-line-number="13480"></td>
        <td id="LC13480">
</td>
      </tr>
      <tr>
        <td id="L13481" data-line-number="13481"></td>
        <td id="LC13481">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L13482" data-line-number="13482"></td>
        <td id="LC13482">        }</td>
      </tr>
      <tr>
        <td id="L13483" data-line-number="13483"></td>
        <td id="LC13483">
</td>
      </tr>
      <tr>
        <td id="L13484" data-line-number="13484"></td>
        <td id="LC13484">        <span>internal</span> <span>ulong</span> <span>PlpBytesLeft</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L13485" data-line-number="13485"></td>
        <td id="LC13485">        {</td>
      </tr>
      <tr>
        <td id="L13486" data-line-number="13486"></td>
        <td id="LC13486">            <span>if</span> ((<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>0</span>) <span>&amp;&amp;</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L13487" data-line-number="13487"></td>
        <td id="LC13487">                <span>stateObj</span>.<span>ReadPlpLength</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L13488" data-line-number="13488"></td>
        <td id="LC13488">
</td>
      </tr>
      <tr>
        <td id="L13489" data-line-number="13489"></td>
        <td id="LC13489">            <span>return</span> <span>stateObj</span>.<span>_longlenleft</span>;</td>
      </tr>
      <tr>
        <td id="L13490" data-line-number="13490"></td>
        <td id="LC13490">        }</td>
      </tr>
      <tr>
        <td id="L13491" data-line-number="13491"></td>
        <td id="LC13491">
</td>
      </tr>
      <tr>
        <td id="L13492" data-line-number="13492"></td>
        <td id="LC13492">        <span>internal</span> <span>bool</span> <span>TryPlpBytesLeft</span>(<span>TdsParserStateObject</span> <span>stateObj</span>, <span>out</span> <span>ulong</span> <span>left</span>)</td>
      </tr>
      <tr>
        <td id="L13493" data-line-number="13493"></td>
        <td id="LC13493">        {</td>
      </tr>
      <tr>
        <td id="L13494" data-line-number="13494"></td>
        <td id="LC13494">            <span>if</span> ((<span>stateObj</span>.<span>_longlen</span> <span>!=</span> <span>0</span>) <span>&amp;&amp;</span> (<span>stateObj</span>.<span>_longlenleft</span> <span>==</span> <span>0</span>))</td>
      </tr>
      <tr>
        <td id="L13495" data-line-number="13495"></td>
        <td id="LC13495">            {</td>
      </tr>
      <tr>
        <td id="L13496" data-line-number="13496"></td>
        <td id="LC13496">                <span>if</span> (<span>!</span><span>stateObj</span>.<span>TryReadPlpLength</span>(<span>false</span>, <span>out</span> <span>left</span>))</td>
      </tr>
      <tr>
        <td id="L13497" data-line-number="13497"></td>
        <td id="LC13497">                {</td>
      </tr>
      <tr>
        <td id="L13498" data-line-number="13498"></td>
        <td id="LC13498">                    <span>return</span> <span>false</span>;</td>
      </tr>
      <tr>
        <td id="L13499" data-line-number="13499"></td>
        <td id="LC13499">                }</td>
      </tr>
      <tr>
        <td id="L13500" data-line-number="13500"></td>
        <td id="LC13500">            }</td>
      </tr>
      <tr>
        <td id="L13501" data-line-number="13501"></td>
        <td id="LC13501">
</td>
      </tr>
      <tr>
        <td id="L13502" data-line-number="13502"></td>
        <td id="LC13502">            <span>left</span> <span>=</span> <span>stateObj</span>.<span>_longlenleft</span>;</td>
      </tr>
      <tr>
        <td id="L13503" data-line-number="13503"></td>
        <td id="LC13503">            <span>return</span> <span>true</span>;</td>
      </tr>
      <tr>
        <td id="L13504" data-line-number="13504"></td>
        <td id="LC13504">        }</td>
      </tr>
      <tr>
        <td id="L13505" data-line-number="13505"></td>
        <td id="LC13505">
</td>
      </tr>
      <tr>
        <td id="L13506" data-line-number="13506"></td>
        <td id="LC13506">        <span>private</span> <span>const</span> <span>ulong</span> <span>_indeterminateSize</span> <span>=</span> <span>0xffffffffffffffff</span>;        <span><span>//</span> Represents unknown size</span></td>
      </tr>
      <tr>
        <td id="L13507" data-line-number="13507"></td>
        <td id="LC13507">
</td>
      </tr>
      <tr>
        <td id="L13508" data-line-number="13508"></td>
        <td id="LC13508">        <span>internal</span> <span>ulong</span> <span>PlpBytesTotalLength</span>(<span>TdsParserStateObject</span> <span>stateObj</span>)</td>
      </tr>
      <tr>
        <td id="L13509" data-line-number="13509"></td>
        <td id="LC13509">        {</td>
      </tr>
      <tr>
        <td id="L13510" data-line-number="13510"></td>
        <td id="LC13510">            <span>if</span> (<span>stateObj</span>.<span>_longlen</span> <span>==</span> <span>TdsEnums</span>.<span>SQL_PLP_UNKNOWNLEN</span>)</td>
      </tr>
      <tr>
        <td id="L13511" data-line-number="13511"></td>
        <td id="LC13511">                <span>return</span> <span>_indeterminateSize</span>;</td>
      </tr>
      <tr>
        <td id="L13512" data-line-number="13512"></td>
        <td id="LC13512">            <span>else</span> <span>if</span> (<span>stateObj</span>.<span>_longlen</span> <span>==</span> <span>TdsEnums</span>.<span>SQL_PLP_NULL</span>)</td>
      </tr>
      <tr>
        <td id="L13513" data-line-number="13513"></td>
        <td id="LC13513">                <span>return</span> <span>0</span>;</td>
      </tr>
      <tr>
        <td id="L13514" data-line-number="13514"></td>
        <td id="LC13514">
</td>
      </tr>
      <tr>
        <td id="L13515" data-line-number="13515"></td>
        <td id="LC13515">            <span>return</span> <span>stateObj</span>.<span>_longlen</span>;</td>
      </tr>
      <tr>
        <td id="L13516" data-line-number="13516"></td>
        <td id="LC13516">        }</td>
      </tr>
      <tr>
        <td id="L13517" data-line-number="13517"></td>
        <td id="LC13517">
</td>
      </tr>
      <tr>
        <td id="L13518" data-line-number="13518"></td>
        <td id="LC13518">        <span>const</span> <span>string</span> <span>StateTraceFormatString</span> <span>=</span> <span><span>"</span><span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13519" data-line-number="13519"></td>
        <td id="LC13519">                                        <span>+</span> <span><span>"</span>         _physicalStateObj = {0}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13520" data-line-number="13520"></td>
        <td id="LC13520">                                        <span>+</span> <span><span>"</span>         _pMarsPhysicalConObj = {1}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13521" data-line-number="13521"></td>
        <td id="LC13521">                                        <span>+</span> <span><span>"</span>         _state = {2}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13522" data-line-number="13522"></td>
        <td id="LC13522">                                        <span>+</span> <span><span>"</span>         _server = {3}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13523" data-line-number="13523"></td>
        <td id="LC13523">                                        <span>+</span> <span><span>"</span>         _fResetConnection = {4}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13524" data-line-number="13524"></td>
        <td id="LC13524">                                        <span>+</span> <span><span>"</span>         _defaultCollation = {5}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13525" data-line-number="13525"></td>
        <td id="LC13525">                                        <span>+</span> <span><span>"</span>         _defaultCodePage = {6}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13526" data-line-number="13526"></td>
        <td id="LC13526">                                        <span>+</span> <span><span>"</span>         _defaultLCID = {7}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13527" data-line-number="13527"></td>
        <td id="LC13527">                                        <span>+</span> <span><span>"</span>         _defaultEncoding = {8}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13528" data-line-number="13528"></td>
        <td id="LC13528">                                        <span>+</span> <span><span>"</span>         _encryptionOption = {10}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13529" data-line-number="13529"></td>
        <td id="LC13529">                                        <span>+</span> <span><span>"</span>         _currentTransaction = {11}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13530" data-line-number="13530"></td>
        <td id="LC13530">                                        <span>+</span> <span><span>"</span>         _pendingTransaction = {12}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13531" data-line-number="13531"></td>
        <td id="LC13531">                                        <span>+</span> <span><span>"</span>         _retainedTransactionId = {13}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13532" data-line-number="13532"></td>
        <td id="LC13532">                                        <span>+</span> <span><span>"</span>         _nonTransactedOpenResultCount = {14}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13533" data-line-number="13533"></td>
        <td id="LC13533">                                        <span>+</span> <span><span>"</span>         _connHandler = {15}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13534" data-line-number="13534"></td>
        <td id="LC13534">                                        <span>+</span> <span><span>"</span>         _fMARS = {16}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13535" data-line-number="13535"></td>
        <td id="LC13535">                                        <span>+</span> <span><span>"</span>         _sessionPool = {17}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13536" data-line-number="13536"></td>
        <td id="LC13536">                                        <span>+</span> <span><span>"</span>         _isShiloh = {18}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13537" data-line-number="13537"></td>
        <td id="LC13537">                                        <span>+</span> <span><span>"</span>         _isShilohSP1 = {19}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13538" data-line-number="13538"></td>
        <td id="LC13538">                                        <span>+</span> <span><span>"</span>         _isYukon = {20}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13539" data-line-number="13539"></td>
        <td id="LC13539">                                        <span>+</span> <span><span>"</span>         _sniSpnBuffer = {21}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13540" data-line-number="13540"></td>
        <td id="LC13540">                                        <span>+</span> <span><span>"</span>         _errors = {22}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13541" data-line-number="13541"></td>
        <td id="LC13541">                                        <span>+</span> <span><span>"</span>         _warnings = {23}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13542" data-line-number="13542"></td>
        <td id="LC13542">                                        <span>+</span> <span><span>"</span>         _attentionErrors = {24}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13543" data-line-number="13543"></td>
        <td id="LC13543">                                        <span>+</span> <span><span>"</span>         _attentionWarnings = {25}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13544" data-line-number="13544"></td>
        <td id="LC13544">                                        <span>+</span> <span><span>"</span>         _statistics = {26}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13545" data-line-number="13545"></td>
        <td id="LC13545">                                        <span>+</span> <span><span>"</span>         _statisticsIsInTransaction = {27}<span>\n\t</span><span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13546" data-line-number="13546"></td>
        <td id="LC13546">                                        <span>+</span> <span><span>"</span>         _fPreserveTransaction = {28}<span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13547" data-line-number="13547"></td>
        <td id="LC13547">                                        <span>+</span> <span><span>"</span>         _fParallel = {29}<span>"</span></span></td>
      </tr>
      <tr>
        <td id="L13548" data-line-number="13548"></td>
        <td id="LC13548">                                        ;</td>
      </tr>
      <tr>
        <td id="L13549" data-line-number="13549"></td>
        <td id="LC13549">        <span>internal</span> <span>string</span> <span>TraceString</span>()</td>
      </tr>
      <tr>
        <td id="L13550" data-line-number="13550"></td>
        <td id="LC13550">        {</td>
      </tr>
      <tr>
        <td id="L13551" data-line-number="13551"></td>
        <td id="LC13551">            <span>return</span> <span>String</span>.<span>Format</span>(<span><span>/*</span>IFormatProvider<span>*/</span></span> <span>null</span>,</td>
      </tr>
      <tr>
        <td id="L13552" data-line-number="13552"></td>
        <td id="LC13552">                            <span>StateTraceFormatString</span>,</td>
      </tr>
      <tr>
        <td id="L13553" data-line-number="13553"></td>
        <td id="LC13553">                            <span>null</span> <span>==</span> <span>_physicalStateObj</span>,</td>
      </tr>
      <tr>
        <td id="L13554" data-line-number="13554"></td>
        <td id="LC13554">                            <span>null</span> <span>==</span> <span>_pMarsPhysicalConObj</span>,</td>
      </tr>
      <tr>
        <td id="L13555" data-line-number="13555"></td>
        <td id="LC13555">                            <span>_state</span>,</td>
      </tr>
      <tr>
        <td id="L13556" data-line-number="13556"></td>
        <td id="LC13556">                            <span>_server</span>,</td>
      </tr>
      <tr>
        <td id="L13557" data-line-number="13557"></td>
        <td id="LC13557">                            <span>_fResetConnection</span>,</td>
      </tr>
      <tr>
        <td id="L13558" data-line-number="13558"></td>
        <td id="LC13558">                            <span>null</span> <span>==</span> <span>_defaultCollation</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_defaultCollation</span>.<span>TraceString</span>(),</td>
      </tr>
      <tr>
        <td id="L13559" data-line-number="13559"></td>
        <td id="LC13559">                            <span>_defaultCodePage</span>,</td>
      </tr>
      <tr>
        <td id="L13560" data-line-number="13560"></td>
        <td id="LC13560">                            <span>_defaultLCID</span>,</td>
      </tr>
      <tr>
        <td id="L13561" data-line-number="13561"></td>
        <td id="LC13561">                            <span>TraceObjectClass</span>(<span>_defaultEncoding</span>),</td>
      </tr>
      <tr>
        <td id="L13562" data-line-number="13562"></td>
        <td id="LC13562">                            <span><span>"</span><span>"</span></span>,</td>
      </tr>
      <tr>
        <td id="L13563" data-line-number="13563"></td>
        <td id="LC13563">                            <span>_encryptionOption</span>,</td>
      </tr>
      <tr>
        <td id="L13564" data-line-number="13564"></td>
        <td id="LC13564">                            <span>null</span> <span>==</span> <span>_currentTransaction</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_currentTransaction</span>.<span>TraceString</span>(),</td>
      </tr>
      <tr>
        <td id="L13565" data-line-number="13565"></td>
        <td id="LC13565">                            <span>null</span> <span>==</span> <span>_pendingTransaction</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_pendingTransaction</span>.<span>TraceString</span>(),</td>
      </tr>
      <tr>
        <td id="L13566" data-line-number="13566"></td>
        <td id="LC13566">                            <span>_retainedTransactionId</span>,</td>
      </tr>
      <tr>
        <td id="L13567" data-line-number="13567"></td>
        <td id="LC13567">                            <span>_nonTransactedOpenResultCount</span>,</td>
      </tr>
      <tr>
        <td id="L13568" data-line-number="13568"></td>
        <td id="LC13568">                            <span>null</span> <span>==</span> <span>_connHandler</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_connHandler</span>.<span>ObjectID</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>),</td>
      </tr>
      <tr>
        <td id="L13569" data-line-number="13569"></td>
        <td id="LC13569">                            <span>_fMARS</span>,</td>
      </tr>
      <tr>
        <td id="L13570" data-line-number="13570"></td>
        <td id="LC13570">                            <span>null</span> <span>==</span> <span>_sessionPool</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_sessionPool</span>.<span>TraceString</span>(),</td>
      </tr>
      <tr>
        <td id="L13571" data-line-number="13571"></td>
        <td id="LC13571">                            <span>_isShiloh</span>,</td>
      </tr>
      <tr>
        <td id="L13572" data-line-number="13572"></td>
        <td id="LC13572">                            <span>_isShilohSP1</span>,</td>
      </tr>
      <tr>
        <td id="L13573" data-line-number="13573"></td>
        <td id="LC13573">                            <span>_isYukon</span>,</td>
      </tr>
      <tr>
        <td id="L13574" data-line-number="13574"></td>
        <td id="LC13574">                            <span>null</span> <span>==</span> <span>_sniSpnBuffer</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_sniSpnBuffer</span>.<span>Length</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>),</td>
      </tr>
      <tr>
        <td id="L13575" data-line-number="13575"></td>
        <td id="LC13575">                            <span>_physicalStateObj</span> <span>!=</span> <span>null</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_physicalStateObj</span>.<span>ErrorCount</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>),</td>
      </tr>
      <tr>
        <td id="L13576" data-line-number="13576"></td>
        <td id="LC13576">                            <span>_physicalStateObj</span> <span>!=</span> <span>null</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_physicalStateObj</span>.<span>WarningCount</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>),</td>
      </tr>
      <tr>
        <td id="L13577" data-line-number="13577"></td>
        <td id="LC13577">                            <span>_physicalStateObj</span> <span>!=</span> <span>null</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_physicalStateObj</span>.<span>PreAttentionErrorCount</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>),</td>
      </tr>
      <tr>
        <td id="L13578" data-line-number="13578"></td>
        <td id="LC13578">                            <span>_physicalStateObj</span> <span>!=</span> <span>null</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_physicalStateObj</span>.<span>PreAttentionWarningCount</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>),</td>
      </tr>
      <tr>
        <td id="L13579" data-line-number="13579"></td>
        <td id="LC13579">                            <span>null</span> <span>==</span> <span>_statistics</span>,</td>
      </tr>
      <tr>
        <td id="L13580" data-line-number="13580"></td>
        <td id="LC13580">                            <span>_statisticsIsInTransaction</span>,</td>
      </tr>
      <tr>
        <td id="L13581" data-line-number="13581"></td>
        <td id="LC13581">                            <span>_fPreserveTransaction</span>,</td>
      </tr>
      <tr>
        <td id="L13582" data-line-number="13582"></td>
        <td id="LC13582">                            <span>null</span> <span>==</span> <span>_connHandler</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>MultiSubnetFailover</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>),</td>
      </tr>
      <tr>
        <td id="L13583" data-line-number="13583"></td>
        <td id="LC13583">                            <span>null</span> <span>==</span> <span>_connHandler</span> <span>?</span> <span><span>"</span>(null)<span>"</span></span> <span>:</span> <span>_connHandler</span>.<span>ConnectionOptions</span>.<span>TransparentNetworkIPResolution</span>.<span>ToString</span>((<span>IFormatProvider</span>)<span>null</span>));</td>
      </tr>
      <tr>
        <td id="L13584" data-line-number="13584"></td>
        <td id="LC13584">        }</td>
      </tr>
      <tr>
        <td id="L13585" data-line-number="13585"></td>
        <td id="LC13585">
</td>
      </tr>
      <tr>
        <td id="L13586" data-line-number="13586"></td>
        <td id="LC13586">        <span>private</span> <span>string</span> <span>TraceObjectClass</span>(<span>object</span> <span>instance</span>)</td>
      </tr>
      <tr>
        <td id="L13587" data-line-number="13587"></td>
        <td id="LC13587">        {</td>
      </tr>
      <tr>
        <td id="L13588" data-line-number="13588"></td>
        <td id="LC13588">            <span>if</span> (<span>null</span> <span>==</span> <span>instance</span>)</td>
      </tr>
      <tr>
        <td id="L13589" data-line-number="13589"></td>
        <td id="LC13589">            {</td>
      </tr>
      <tr>
        <td id="L13590" data-line-number="13590"></td>
        <td id="LC13590">                <span>return</span> <span><span>"</span>(null)<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="L13591" data-line-number="13591"></td>
        <td id="LC13591">            }</td>
      </tr>
      <tr>
        <td id="L13592" data-line-number="13592"></td>
        <td id="LC13592">            <span>else</span></td>
      </tr>
      <tr>
        <td id="L13593" data-line-number="13593"></td>
        <td id="LC13593">            {</td>
      </tr>
      <tr>
        <td id="L13594" data-line-number="13594"></td>
        <td id="LC13594">                <span>return</span> <span>instance</span>.<span>GetType</span>().<span>ToString</span>();</td>
      </tr>
      <tr>
        <td id="L13595" data-line-number="13595"></td>
        <td id="LC13595">            }</td>
      </tr>
      <tr>
        <td id="L13596" data-line-number="13596"></td>
        <td id="LC13596">        }</td>
      </tr>
      <tr>
        <td id="L13597" data-line-number="13597"></td>
        <td id="LC13597">
</td>
      </tr>
      <tr>
        <td id="L13598" data-line-number="13598"></td>
        <td id="LC13598">        <span>private</span> <span>static</span> <span>IntPtr</span> <span>ClientCertificateDelegate</span>(<span>IntPtr</span> <span>ptrContext</span>)</td>
      </tr>
      <tr>
        <td id="L13599" data-line-number="13599"></td>
        <td id="LC13599">        {</td>
      </tr>
      <tr>
        <td id="L13600" data-line-number="13600"></td>
        <td id="LC13600">            <span>GCHandle</span> <span>clientDelegate</span> <span>=</span> <span>GCHandle</span>.<span>FromIntPtr</span>(<span>ptrContext</span>);</td>
      </tr>
      <tr>
        <td id="L13601" data-line-number="13601"></td>
        <td id="LC13601">
</td>
      </tr>
      <tr>
        <td id="L13602" data-line-number="13602"></td>
        <td id="LC13602">            <span>try</span></td>
      </tr>
      <tr>
        <td id="L13603" data-line-number="13603"></td>
        <td id="LC13603">            {</td>
      </tr>
      <tr>
        <td id="L13604" data-line-number="13604"></td>
        <td id="LC13604">                <span>ClientCertificateRetrievalCallback</span> <span>clientCallback</span> <span>=</span> (<span>ClientCertificateRetrievalCallback</span>)<span>clientDelegate</span>.<span>Target</span>;</td>
      </tr>
      <tr>
        <td id="L13605" data-line-number="13605"></td>
        <td id="LC13605">
</td>
      </tr>
      <tr>
        <td id="L13606" data-line-number="13606"></td>
        <td id="LC13606">                <span>X509Certificate2</span> <span>cert</span> <span>=</span> <span>clientCallback</span>();</td>
      </tr>
      <tr>
        <td id="L13607" data-line-number="13607"></td>
        <td id="LC13607">                <span>if</span> (<span>cert</span> <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="L13608" data-line-number="13608"></td>
        <td id="LC13608">                {</td>
      </tr>
      <tr>
        <td id="L13609" data-line-number="13609"></td>
        <td id="LC13609">                    <span>return</span> <span>cert</span>.<span>Handle</span>;</td>
      </tr>
      <tr>
        <td id="L13610" data-line-number="13610"></td>
        <td id="LC13610">                }</td>
      </tr>
      <tr>
        <td id="L13611" data-line-number="13611"></td>
        <td id="LC13611">                <span>else</span></td>
      </tr>
      <tr>
        <td id="L13612" data-line-number="13612"></td>
        <td id="LC13612">                {</td>
      </tr>
      <tr>
        <td id="L13613" data-line-number="13613"></td>
        <td id="LC13613">                    <span>return</span> <span>IntPtr</span>.<span>Zero</span>;</td>
      </tr>
      <tr>
        <td id="L13614" data-line-number="13614"></td>
        <td id="LC13614">                }</td>
      </tr>
      <tr>
        <td id="L13615" data-line-number="13615"></td>
        <td id="LC13615">            }</td>
      </tr>
      <tr>
        <td id="L13616" data-line-number="13616"></td>
        <td id="LC13616">            <span>catch</span></td>
      </tr>
      <tr>
        <td id="L13617" data-line-number="13617"></td>
        <td id="LC13617">            {</td>
      </tr>
      <tr>
        <td id="L13618" data-line-number="13618"></td>
        <td id="LC13618">                <span><span>//</span> Currently  exceptions are not marshalled back.</span></td>
      </tr>
      <tr>
        <td id="L13619" data-line-number="13619"></td>
        <td id="LC13619">                <span><span>//</span></span></td>
      </tr>
      <tr>
        <td id="L13620" data-line-number="13620"></td>
        <td id="LC13620">                <span>Debug</span>.<span>Assert</span>(<span>false</span>);</td>
      </tr>
      <tr>
        <td id="L13621" data-line-number="13621"></td>
        <td id="LC13621">                <span>return</span> <span>IntPtr</span>.<span>Zero</span>;</td>
      </tr>
      <tr>
        <td id="L13622" data-line-number="13622"></td>
        <td id="LC13622">            }</td>
      </tr>
      <tr>
        <td id="L13623" data-line-number="13623"></td>
        <td id="LC13623">        }</td>
      </tr>
      <tr>
        <td id="L13624" data-line-number="13624"></td>
        <td id="LC13624">    }    <span><span>//</span> tdsparser</span></td>
      </tr>
      <tr>
        <td id="L13625" data-line-number="13625"></td>
        <td id="LC13625">}<span><span>//</span>namespace</span></td>
      </tr>
</tbody></table>

  

  </div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>