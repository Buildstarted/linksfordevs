<!DOCTYPE html>
<html lang="en">
<head>
    <title>
ASP.NET Blog | .NET Core Workers as Windows Services -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>ASP.NET Blog | .NET Core Workers as Windows Services</h1><div><div class="entry-content col-12 sharepostcontent"><h1 class="entry-title">.NET Core Workers as Windows Services</h1><div class="row justify-content-center"><div class="col-md-4"><div><img src="https://secure.gravatar.com/avatar/13edee8ed773de344d1f94e70d8cb7f7?s=58&amp;d=mm&amp;r=g" width="58" height="58" alt="Avatar" class="avatar avatar-58 wp-user-avatar wp-user-avatar-58 photo avatar-default"><p>Glenn</p></div></div></div><p>March 29th, 2019</p><p>In .NET Core 3.0 we are introducing a new type of application template called Worker Service. This template is intended to give you a starting point for writing long running services in .NET Core. In this walkthrough we will create a worker and run it as a Windows Service.</p><h2>Create a worker</h2><p><strong><em>Preview Note: In our preview releases the worker template is in the same menu as the Web templates. This will change in a future release. We intend to place the Worker Service template directly inside the create new project wizard.</em></strong></p><h3>Create a Worker in Visual Studio</h3><p><img src="https://user-images.githubusercontent.com/234688/53668589-285cb200-3c29-11e9-8b21-124722ed46ea.png" alt="image"></p><p><img src="https://user-images.githubusercontent.com/234688/53668594-2b57a280-3c29-11e9-9559-f95b8ab71384.png" alt="image"></p><p><img src="https://user-images.githubusercontent.com/234688/53668600-2d216600-3c29-11e9-8035-a65cd41a0bba.png" alt="image"></p><h3>Create a Worker on the command line</h3><p>Run <code>dotnet new worker</code></p><p><img src="https://user-images.githubusercontent.com/234688/53668641-55a96000-3c29-11e9-8b15-20941df06578.png" alt="image"></p><h2>Run as a Windows Service</h2><p>In order to run as a Windows Service we need our worker to listen for start and stop signals from <code>ServiceBase</code> the .NET type that exposes the Windows Service systems to .NET applications. To do this we want to:</p><p>Add the <code>Microsoft.Extensions.Hosting.WindowsServices</code> NuGet package</p><p><img src="https://user-images.githubusercontent.com/234688/55096742-b33d9a80-5077-11e9-9b98-3ea588baf243.png" alt="image"></p><p>Add the <code>UseServiceBaseLifetime</code> call to the <code>HostBuilder</code> in our Program.cs</p><pre><code class="csharp">public class Program
{
    public static void Main(string[] args)
    {
        CreateHostBuilder(args).Build().Run();
    }

    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;
        Host.CreateDefaultBuilder(args)
            .UseServiceBaseLifetime()
            .ConfigureServices(services =&gt;
            {
                services.AddHostedService&lt;Worker&gt;();
            });
}
</code></pre><p>This method does a couple of things. First, it checks whether or not the application is actually running as a Windows Service, if it isn’t then it noops which makes this method safe to be called when running locally or when running as a Windows Service. You don’t need to add guard clauses to it and can just run the app normally when not installed as a Windows Service.</p><p>Secondly, it configures your host to use a <code>ServiceBaseLifetime</code>. <code>ServiceBaseLifetime</code> works with <code>ServiceBase</code> to help control the lifetime of your app when run as a Windows Service. This overrides the default <code>ConsoleLifetime</code> that handles signals like CTL+C.</p><h3>Install the Worker</h3><p>Once we have our worker using the <code>ServiceBaseLifetime</code> we then need to install it:</p><p>First, lets publish the application. We will install the Windows Service in-place, meaning the exe will be locked whenever the service is running. The publish step is a nice way to make sure all the files I need to run the service are in one place and ready to be installed.</p><pre><code>dotnet publish -o c:\code\workerpub
</code></pre><p>Then we can use the <a href="https://docs.microsoft.com/en-us/windows/desktop/services/controlling-a-service-using-sc">sc utility</a> in an admin command prompt</p><pre><code>sc create workertest binPath=c:\code\workerpub\WorkerTest.exe
</code></pre><p>For example:</p><p><img src="https://user-images.githubusercontent.com/234688/53668781-b9338d80-3c29-11e9-903d-b8a24daa137b.png" alt="image"></p><p><em><strong>Security note:</strong> This command has the service run as local system, which <strong>isn’t something you will generally want to do</strong>. Instead you should create a service account and run the windows service as that account. We will not talk about that here, but there is some documentation on the ASP.NET docs talking about it here: <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/windows-service?view=aspnetcore-2.2">https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/windows-service?view=aspnetcore-2.2</a></em></p><h2>Logging</h2><p>The logging system has an Event Log provider that can send log message directly to the Windows Event Log. To log to the event log you can add the <code>Microsoft.Extensions.Logging.EventLog</code> package and then modify your <code>Program.cs</code>:</p><pre><code class="csharp">public static IHostBuilder CreateHostBuilder(string[] args) =&gt;
    Host.CreateDefaultBuilder(args)
        .ConfigureLogging(loggerFactory =&gt; loggerFactory.AddEventLog())
        .ConfigureServices(services =&gt;
        {
            services.AddHostedService&lt;Worker&gt;();
        });
</code></pre><h1>Future Work</h1><p>In upcoming previews we plan to improve the experience of using Workers with Windows Services by:</p><ol><li>Rename UseWindowsServiceBaseLifetime to UseWindowsService</li><li>Add automatic and improved integration with the Event Log when running as a Windows Service.</li></ol><h1>Conclusion</h1><p>We hope you try out this new template and want you to let us know how it goes, you can file any bugs or suggestions <a href="https://github.com/aspnet/AspNetCore/issues/new/choose">here</a>.</p><div class="authorinfoarea"></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>