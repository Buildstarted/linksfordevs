<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Performance testing -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Performance testing</h1>
    <textarea id="source">
name: template-default
layout: true ---
name: template-title
layout: true
template: template-default
class: slide-title, center
---
name: template-section
layout: true
template: template-default
class: slide-section, center, middle
---
name: template-page
layout: true
template: template-default
class: slide-page
---
template: template-title # Performance testing
## Andrey Akinshin, JetBrains
### Dotnetos, Warsaw, Poland, 10.10.2019 ---
template: template-section ## Part 1
## Introduction ---
layout: true
template: template-page <p>.footer-note[(1) Introduction]</p> ---
class: normal ### How do we typically solve performance problems? .center[![:scale 90%](img/dino.gif)]
.bottom-hint-huge[https://www.youtube.com/watch?v=z6_ZbG7Zu0c] ---
class: normal ### What do we want? -- 1. Prevent performance degradations -- 2. Detect not-prevented degradations -- 3. Detect other kinds of performance anomalies -- 4. Reduce Type I (false positive) error rate *(Detecting fake problem)* -- 5. Reduce Type II (false negative) error rate<p> *(Missing real problem)* -- 6. Automate everything ---
class: normal ### Agenda * Performance Summary Reports * Performance Comparing Reports * Performance Anomalies * Performance Alarms &amp; Asserts ---
template: template-section ## Part 2
## Performance Summary Reports ---
layout: true
template: template-page </p><p>.footer-note[(2) Performance Summary Reports]</p> ---
class: normal ### BenchmarkDotNet .up[]
.center[![:scale 100%](img/bdn.png)] ---
class: normal ### Normal distribution .up[]
.center[![:scale 65%](img/normal.png)] -- .up1[]
<p>
.c[
&gt; *Normality is a myth; there never was, and never will be, a normal distribution.* &gt; &quot;Testing for normality&quot;, R.C. Geary, 1947
]
</p> .bottom-hint-huge[https://aakinshin.net/posts/normality/] ---
class: normal ### An experiment .up[]
.size-50[
.center[
```md
| Method | Mean | Error | StdDev | Median |
|------- |---------:|---------:|---------:|---------:|
| A | `136.2 ms` | 19.30 ms | 56.92 ms | 107.0 ms |
| B | `133.7 ms` | 4.14 ms | 12.20 ms | 130.2 ms |
```
]
] -- .center[![:scale 60%](img/misleading.png)] ---
class: normal ### What kind of metrics should we report? .up3[]
.center[![:scale 80%](img/cloud.png)] ---
class: normal ### Mean and StdDev may be misleading .up[]
.center[![:scale 80%](img/samestats1.png)]
.bottom-hint[Justin Matejka, George Fitzmaurice (2017), &quot;Same Stats, Different Graphs: Generating Datasets with Varied Appearance and Identical Statistics through Simulated Annealing&quot;, CHI 2017 Conference proceedings: ACM SIGCHI Conference on Human Factors in Computing Systems] ---
class: normal ### Mean and StdDev may be misleading .center[![:scale 100%](img/samestats2.gif)]
.bottom-hint[Justin Matejka, George Fitzmaurice (2017), &quot;Same Stats, Different Graphs: Generating Datasets with Varied Appearance and Identical Statistics through Simulated Annealing&quot;, CHI 2017 Conference proceedings: ACM SIGCHI Conference on Human Factors in Computing Systems] ---
class: normal ### Ranges [User-friendly approach] -- .size-150[
```md
| Method | Range |
|------- |-------------:|
| A | `100ms..200ms` |
| B | `120ms..150ms` |
```
] ---
class: normal ### Ranges and Notes [User-friendly approach] .size-150[
```md
| Method | Range | Notes |
|------- |-------------:|--------------:|
| A | 100ms..200ms | `High outliers` |
| B | 120ms..150ms | |
```
] ---
class: normal ### Ranges and Notes [User-friendly approach] .size-150[
```md
| Method | Range | Notes |
|------- |-------------:|----------------:|
| A | 100ms..200ms | High outliers`^1` |
| B | 120ms..150ms | | `^1 High outliers: 327ms, 364ms, 396ms`
```
] ---
template: template-section ## Part 3
## Performance Comparing Reports ---
layout: true
template: template-page <p>.footer-note[(3) Performance Comparing Reports]</p> ---
class: normal ### Distribution comparing: Case 1 .up[]
.center[![:scale 55%](img/compare1.png)] ---
class: normal ### Overview [Statistical tests] .up[]
.center[![:scale 55%](img/statistics-tests-overview.png)] ---
class: normal ### Confusing naming [Statistical tests] -- * We have: -- * Null hypothesis (we don&apos;t have a degradation) -- * Alternative hypothesis (we have a degradation) -- * The result: p-value -- * p-value &lt; &#x3B1;: we reject the null hypothesis -- * p-value &gt; &#x3B1;: we fail to reject the null hypothesis ---
class: normal ### Limitations [Statistical tests] -- .up[]
```cs
// Before changes (N = 10000; Range = [1.01min..1.02min])
Iteration 0000: 1.011 min
Iteration 0001: 1.014 min
Iteration 0002: 1.021 min
Iteration 0003: 1.017 min
...
Iteration 9999: 1.012 min
```
.up1[]
```cs
// After changes (N = 1; Range = [60.127min..60.127min])
Iteration 0000: 60.127 min
``` -- ```md
&#x1F468;&#x200D;&#x1F4BC;Team Lead : Do we have a performance degradation?
```
--
.up1[]
```md
&#x1F469;&#x200D;&#x1F4BB;Performance Engineer : Yes, probably we have a degradation here.
```
--
.up1[]
```cs
&#x1F47B;Statistical Test : throw new DivideByZeroException(&quot;N should be &gt;= 1&quot;)
``` ---
class: normal ### Incorrect interpretation [Statistical tests] -- .up[]
```cs
// Before changes (N = 10000; Range = [1.01min..1.02min])
Iteration 0000: 1.011 min
Iteration 0001: 1.014 min
Iteration 0002: 1.021 min
Iteration 0003: 1.017 min
...
Iteration 9999: 1.012 min
```
.up1[]
```cs
// After changes (N = 3; Range = [60.1min..60.3min])
Iteration 0000: 60.127 min
Iteration 0001: 60.279 min
Iteration 0002: 60.241 min
``` -- ```md
&#x1F468;&#x200D;&#x1F4BC;Team Lead : Do we have a performance degradation?
```
--
.up1[]
```md
&#x1F469;&#x200D;&#x1F4BB;Performance Engineer : Yes, most likely we have a degradation here.
```
--
.up1[]
```md
&#x1F4A9;Statistical Test : We fail to reject the null hypothesis.
``` ---
class: normal ### Wrong question [Statistical tests] .size-80[
.c[
.cl[
```cs
// Before Changes
public void Foo(object x)
{ // Some code
}
```
]
.cr[
```cs
// After Changes
public void Foo(object x)
{ `if (x == null)` `throw new NullReferenceException(&quot;x&quot;);` // Some code
}
```
]
]
] -- ```md
&#x1F468;&#x200D;&#x1F4BC;Team Lead : Do we have a performance degradation?
```
--
.up1[]
```md
&#x1F469;&#x200D;&#x1F4BB;Performance Engineer : Yes! Because we added new code.
```
--
.up1[]
```md
&#x1F4A9;Statistical Test : We fail to reject the null hypothesis.
``` ---
class: normal ### Right question [Statistical tests] .size-80[
.c[
.cl[
```cs
// Before Changes
public void Foo(object x)
{ // Some code
}
```
]
.cr[
```cs
// After Changes
public void Foo(object x)
{ `if (x == null)` `throw new NullReferenceException(&quot;x&quot;);` // Some code
}
```
]
]
] -- ```md
&#x1F468;&#x200D;&#x1F4BC;Team Lead : How big is the degradation that we have?
```
--
.up1[]
```md
&#x1F469;&#x200D;&#x1F4BB;Performance Engineer : Very small, we can ignore it.
```
--
.up1[]
```cs
&#x1F47B;Statistical Test : throw new InvalidOperationException(&quot;:(&quot;)
``` ---
class: normal ### Distribution comparing: Case 2 .up[]
.center[![:scale 55%](img/compare2.png)] ---
class: normal ### Distribution comparing: Case 3 .up[]
.center[![:scale 55%](img/compare3.png)] ---
class: normal ### Shift function .up[]
.center[![:scale 70%](img/shift-build.png)] ---
class: normal ### Shift function .up[]
.center[![:scale 70%](img/shift.png)] ---
class: normal ### Ratio function .up[]
.center[![:scale 70%](img/ratio.png)] ---
class: normal ### Distribution Comparing: Case 4 .up[]
.center[![:scale 55%](img/compare4.png)] ---
class: normal ### Distribution Comparing: Case 5 .up[]
.center[![:scale 55%](img/compare5.png)] ---
class: normal ### Ranges [User-friendly approach] .size-150[
```md
| Method | Ratio |
|------- |---------:|
| A | Baseline |
| B | 2.0-3.0 |
| C | 0.5-0.6 |
| D | 0.3-8.5 |
```
] -- ```md
&#x1F468;&#x200D;&#x1F4BC;Team Lead : Are you sure that we have a degradation?
```
--
.up1[]
```md
&#x1F469;&#x200D;&#x1F4BB;Performance Engineer : Yes, I&apos;m sure, we should investigate it!
```
--
.up1[]
```md
&#x1F469;&#x200D;&#x1F4BB;Performance Engineer : No, we need more data to be sure.
``` ---
class: normal ### Ranges and Notes [User-friendly approach] .size-150[
```md
| Method | Ratio | Is result reliable? |
|------- |---------:|-------------------------:|
| A | Baseline | |
| B | 2.0-3.0 | `Most likely` |
| C | 0.5-0.6 | `Most likely` |
| D | 0.3-8.5 | `Not sure; need more data` |
```
] ---
template: template-section ## Part 4
## Performance Anomalies ---
layout: true
template: template-page <p>.footer-note[(4) Performance Anomalies]</p> ---
class: normal ### Performance anomalies -- * Changes in performance distribution (degradation, acceleration, something else) -- * Huge duration -- * Huge variance -- * Huge outliers -- * Multimodality -- * Clasterization -- * ... ---
class: normal ### Changes in performance distribution .up[]
.center[![:scale 75%](img/changes.png)] ---
class: normal ### ED-PELT .center[![:scale 90%](img/edpelt.png)] .bottom-hint-huge[https://link.springer.com/article/10.1007/s11222-016-9687-5<p>https://aakinshin.net/posts/edpelt/] ---
class: normal ### Huge degradation .center[![:scale 90%](img/degradation-big.png)] ---
class: normal ### Many small distributions .center[![:scale 90%](img/degradation-small.png)] ---
class: normal ### Huge duration .center[![:scale 90%](img/teamcity.png)] ---
class: normal ### Huge variance .center[![:scale 90%](img/analysis-anomalies-variance.png)] ---
class: normal ### Huge outliers .center[![:scale 90%](img/stats-outliers.png)] ---
class: normal ### Multimodality .center[![:scale 90%](img/analysis-anomalies-bimodal.png)] ---
class: normal ### Multimodality .center[![:scale 90%](img/nuget-blogpost.png)] .bottom-hint-huge[&quot;A story about slow NuGet package browsing&quot;, https://aakinshin.net/posts/nuget-package-browsing/] ---
class: normal ### Clasterization .center[![:scale 90%](img/analysis-anomalies-clustering1.png)] ---
class: normal ### Clasterization .center[![:scale 90%](img/analysis-anomalies-clustering2.png)] ---
class: normal ### Clasterization .center[![:scale 90%](img/analysis-anomalies-clustering3.png)] ---
class: normal ### False anomalies .center[![:scale 37%](img/friends.jpg)] -- * Changes in tests -- * Changes in the test order -- * Changes in CI agent software/hardware -- * Any other changes ---
template: template-section ## Part 5
## Performance Alarms &amp; Asserts ---
layout: true
template: template-page </p><p>.footer-note[(5) Performance Alarms &amp; Asserts]</p> ---
class: normal ### Alarms vs. Asserts | | Alarms | Asserts |
|:-----------------|:--------------------|:---------------|
| Action | Send a notification | Fail a test |
| False-positive | Acceptable | Not acceptable |
| Detection moment | After changes | Before changes |
| Amount of data | Doesn&apos;t matter | A lot | ---
class: normal ### Performance data -- * Sources * Unit/Integration/Functional/End-to-end tests * Microbenchmarks * Stress testing * GUI tests * Fuzz testing * Monitoring * Telemetry
-- * Metrics * Wall-clock time of the whole test * Wall-clock time of the test stages * CPU/Memory/Disk/Network usage * Performance counters (e.g., GC.CollectionCount) * Hardware counters (e.g., CacheMisses, BranchMispredictions) ---
class: normal ### Environment --
.up[]
.center[My workplace:]
.center[![:scale 70%](img/desktop.jpg)] ---
class: normal ### Physical environment .pull-left-33[![:scale 100%](img/env1.jpg)In a freezer]
.pull-left-33[![:scale 100%](img/env2.jpg)In a blanket]
.pull-left-33[![:scale 100%](img/env3.jpg)<p>In an owen] ---
class: normal ### Dashboard-oriented approach for alarms .up[]
.center[**Worst degradations**]
.up1[] | Test | Ratio |
|--------:|-----------:|
| Test472 | 35.0..48.0 |
| Test982 | 10.0..12.0 |
| Test872 | 1.1.. 1.2 |
| Test375 | 1.0.. 1.1 |
| Test184 | 0.9.. 1.0 |
| Test592 | 0.9.. 1.0 |
| Test824 | 0.9.. 1.0 |
| Test294 | 0.9.. 1.0 |
| Test235 | 0.9.. 1.0 |
| Test948 | 0.9.. 1.0 | ---
class: normal ### Absolute Threshold [Asserts] .up[] ```cs
[Test(Timeout = 5000)]
public void Foo()
{ // ...
}
``` ---
class: normal ### Relative Threshold [Asserts] .up[] ```cs
[Benchmark]
public void Foo()
{ // ...
} [Benchmark]
public void Baseline()
{ // ...
} [Test]
public void VerifyFooPerf()
{ Assert.True(Mean(Foo) / Mean(Baseline) &gt; 5000);
}
``` ---
class: normal ### Adaptive Threshold [Asserts] .up[] ```cs
[Test]
public void VerifyPerf(history: List<double>, current: List<double>)
{ var result = Compare(history, current) Assert.True(result.Ratio.Upper &lt; 2);
}
``` ---
class: normal ### Adaptive Threshold + Optional Stopping [Asserts] .up[] ```cs
[Test]
public void VerifyPerf(history: List<double>)
{ var current = new List<double>(); while (true) { var duration = Measure(); current.Add(duration); var result = Compare(history, current); if (result.Ratio.Upper &gt; 2) { if (result.Notes == &quot;We are sure&quot;) Fail(); // A degradation is detected! if (result.Notes == &quot;We are not sure&quot;) continue; // We need more data } else return; // No major degradations are detected }
}
``` ---
template: template-section ## Part 6
## Conclusion ---
layout: true
template: template-page <p>.footer-note[(6) Conclusion]</p> ---
class: normal ### Final tips -- * Make performance reports user-friendly -- * Learn mathematical statistics -- * Check all kinds of performance anomalies -- * Use all the data that you have -- * Automate everything that can be automated ---
class: normal ### Performance Culture .center[![:scale 50%](img/responsibility.jpg)] ---
class: normal ### My first performance monitoring attempt .up[]
.center[![:scale 100%](img/how-it-works.gif)] ---
class: normal ### Reference literature .up[]
.center[![:scale 38%](img/book.png)]
.bottom-hint-huge[https://aakinshin.net/prodotnetbenchmarking/] ---
class: normal ### Thank you for your attention! .center[![:scale 30%](img/bdn-logo.svg)] .center[
Andrey Akinshin https://aakinshin.net https://github.com/AndreyAkinshin https://twitter.com/andrey_akinshin andrey.akinshin@gmail.com
] </double></double></double></double></p></textarea>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>