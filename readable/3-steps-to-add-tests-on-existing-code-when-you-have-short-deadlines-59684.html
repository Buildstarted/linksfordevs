<!DOCTYPE html>
<html lang="en">
<head>
    <title>
3 steps to add tests on existing code when you have short deadlines - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="3 steps to add tests on existing code when you have short deadlines - linksfor.dev(s)"/>
    <meta property="og:description" content="Here&#x27;s a recipe you can follow when you want to add tests on Legacy Code, but you don&#x27;t have much time to do so."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://understandlegacycode.com/blog/3-steps-to-add-tests-on-existing-code-when-you-have-short-deadlines/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - 3 steps to add tests on existing code when you have short deadlines</title>
<div class="readable">
        <h1>3 steps to add tests on existing code when you have short deadlines</h1>
            <div>Reading time: 6-8 minutes</div>
        <div>Posted here: 15 Mar 2020</div>
        <p><a href="https://understandlegacycode.com/blog/3-steps-to-add-tests-on-existing-code-when-you-have-short-deadlines/">https://understandlegacycode.com/blog/3-steps-to-add-tests-on-existing-code-when-you-have-short-deadlines/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><blockquote><p>The code requires significant changes to support unit tests. I have deadlines to meet!</p></blockquote><p><img src="https://understandlegacycode.com/assets/time-for-dat.jpg" alt="Ain't nobody got time for that"></p><p>You have that pile of Legacy Code you need to change.</p><p>Of course, there are no tests. Deep in your heart, you know that you should add tests before touching this code. People on the Internet told you so. â€œFirst, you should add testsâ€ they said.</p><p>But you also have deadlines to meet. Time is flying. Maybe the project is already late. You canâ€™t afford spending <em>days</em> to write the tests that should be here in the first place.</p><p>BUT you know that you should. If you donâ€™t, youâ€™re making things worse! If you donâ€™t write the tests, you may even break something and you wonâ€™t realize!!! ğŸ™€</p><p><strong>You want to add tests, but you donâ€™t have time to!</strong></p><p>If thatâ€™s you, I do have a solution for you!</p><p>Itâ€™s not a pretty one, but <em>it works</em>â„¢. It did save me many times when I was in a hurry. It can help you too.</p><h2>The 3-steps recipe to add tests when you donâ€™t have time to ğŸš€</h2><p>What youâ€™re looking for is called â€<em>Approval Testing</em>â€. Some people call that â€<em>Characterization Testing</em>â€œ.</p><p>Hereâ€™s how it goes:</p><ol><li>ğŸ“¸ Generate an output you can snapshot</li><li>âœ… Use test coverage to find all input combinations</li><li>ğŸ‘½ Use mutations to verify your snapshots</li></ol><p>Follow that and youâ€™ll get your thing under tests <em>super fast</em>!</p><p>Letâ€™s see how you do that in detail.</p><h3>1. ğŸ“¸ Generate an output you can snapshot</h3><p>Thatâ€™s the most difficult part. When you get that done, youâ€™re almost done.</p><p>You need to find a way to capture what the code is doing, in a serialized way. Put simply: it should produce some text you can capture.</p><p>Call the code from a test file. Provide the simplest inputs you need to get it running.</p><p>You can face 3 scenarios:</p><ol><li><strong>What youâ€™re testing returns a value</strong>. Thatâ€™s your output. Easy!</li><li><strong>What youâ€™re testing performs side-effects</strong> (e.g. it calls an HTTP endpoint). You should intercept that and capture the parameters that are used. Youâ€™ll probably need a spy/stub/mock to do so.</li><li><strong>What youâ€™re testing does both</strong>. Thatâ€™s fine, you can test each side-effect and the return value separately.</li></ol><p>Go figure out how to get that output. What you need is a string that proves the code has executed.</p><p>When you got that string, write it in a file. <strong>Thatâ€™s your snapshot</strong>.</p><p>Some testing libraries will give you utilities to do that for you. For example, in JavaScript, <em>Jest</em> has <a href="https://jestjs.io/docs/en/snapshot-testing">a guide to snapshot testing</a>.</p><p>Hereâ€™s an example of a snapshot test with Jest:</p><pre data-language="js"><code><span><span>it</span><span>(</span><span>"should update quality"</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"foo"</span><span>, </span><span>0</span><span>, </span><span>0</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>})</span></span></code></pre><p>You get your snapshot? Sweet! Youâ€™re almost done ğŸ‘</p><h3>2. âœ… Use test coverage to find all input combinations</h3><p>With your first snapshot test running, youâ€™re executing some of the code you want to test.</p><p>Probably not all of it.</p><p>Thatâ€™s where test coverage is useful: it will tell you <strong>what youâ€™re not testing yet</strong>.</p><p>Hereâ€™s an example of a test coverage report:</p><p><img src="https://understandlegacycode.com/assets/test-coverage-gilded-rose.png" alt="Example of test coverage"></p><p>The red lines indicate the code thatâ€™s not executed.</p><p>The â€œIâ€ and â€œEâ€ symbols indicate the code inside the â€œIfâ€ or â€œElseâ€ branch is not executed.</p><p>Use this information to guide your next steps. <strong>You want to cover all the code with tests.</strong></p><p>Remember I told you to put the simplest inputs to get your test running? Great.</p><p>Now write another test and change one input. Try to find a combination that will exercise a part of the code youâ€™re not covering.</p><p>This is easier than it sounds. Actually, it can be solved by trying random inputs, if you really have no idea. In practice, youâ€™ll certainly make informed guesses of what the next combination should be.</p><p>Repeat that until you cover every line.</p><p><img src="https://understandlegacycode.com/assets/test-coverage-gilded-rose-done.png" alt="Test coverage showing all lines covered"></p><p>You might end up with a test looking like that:</p><pre data-language="js"><code><span><span>it</span><span>(</span><span>"should update quality"</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"foo"</span><span>, </span><span>0</span><span>, </span><span>0</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"foo"</span><span>, </span><span>0</span><span>, </span><span>1</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"foo"</span><span>, </span><span>0</span><span>, </span><span>2</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"Aged Brie"</span><span>, </span><span>0</span><span>, </span><span>1</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"Aged Brie"</span><span>, </span><span>0</span><span>, </span><span>50</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"Sulfuras"</span><span>, </span><span>0</span><span>, </span><span>1</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>(</span><span>"Sulfuras"</span><span>, -</span><span>1</span><span>, </span><span>1</span><span>)).</span><span>toMatchSnapshot</span><span>()</span></span>
<span><span>})</span></span></code></pre><p>If youâ€™re using Jest, you can use <a href="https://www.npmjs.com/package/jest-extended-snapshot">jest-extended-snapshot</a>. Itâ€™s a free library I created to simplify previous code into:</p><pre data-language="js"><code><span><span>it</span><span>(</span><span>"should update quality"</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>  </span><span>expect</span><span>(</span><span>updateQuality</span><span>).</span><span>toVerifyAllCombinations</span><span>(</span></span>
<span><span>    [</span><span>"foo"</span><span>, </span><span>"Aged Brie"</span><span>, </span><span>"Sulfuras"</span><span>],</span></span>
<span><span>    [-</span><span>1</span><span>, </span><span>0</span><span>],</span></span>
<span><span>    [</span><span>0</span><span>, </span><span>1</span><span>, </span><span>2</span><span>, </span><span>50</span><span>]</span></span>
<span><span>  )</span></span>
<span><span>})</span></span></code></pre><h3>3. ğŸ‘½ Use mutations to verify your snapshots</h3><p>Everything is now covered with snapshots.</p><p><strong>But 100% test coverage doesnâ€™t mean you actually test the code.</strong></p><p>Thereâ€™s a simple way to verify youâ€™re safe: introduce mutations!</p><p>And by â€œintroduce mutationsâ€ I really mean:</p><ul><li>deliberately change each line of code to introduce a silly mistake (I like to comment out the code)</li><li>verify a test is failing</li><li>revert the silly mistake</li><li>celebrate internally (yay!)</li></ul><p>For every line you mutate and see a failing snapshot, your confidence in the tests grows.</p><p><strong>If no test fails, you need to add other input combinations</strong>. Revert the silly mistake, find the correct combination that will exercise this line and try again. You want to see a failing test.</p><p>When you reach the end of the code, youâ€™re done!</p><p><img src="https://understandlegacycode.com/assets/self-high-five.gif"></p><h2>Why is it the fastest technique to add tests?</h2><p>Because you donâ€™t have to write comprehensive unit tests of the existing code.</p><p>Instead, you take it as a black box. You execute the code, whatever it does. And you capture the output.</p><p><strong>Itâ€™s the fastest way to put regression tests on existing code.</strong></p><p>With this technique, I already put monstrous lumps of code under tests within a couple of hours.</p><h2>Why donâ€™t we <em>always</em> use that kind of test?</h2><p>As sexy as this approach is, it has downsides:</p><ul><li>you capture existing behavior, bugs included</li><li>tests will fail whenever you change the behavior, even if itâ€™s intended</li><li>you canâ€™t read the tests and understand what the code does</li></ul><p>These kind of tests can be really noisy. If you notice people just update them when they fail, they donâ€™t provide any value. <strong>Delete them</strong>.</p><p>Itâ€™s fine to delete useless tests afterwards. They were useful when you had to change the code. Theyâ€™re not here to replace proper tests in your codebase!</p><p>Thatâ€™s my secret weapon to add tests when weâ€™re in a hurry. Thatâ€™s a pragmatic compromise. But itâ€™s a temporary solution until we have time to write better, helpful tests on the code.</p><p>Itâ€™s your secret weapon too now. Use it wisely!</p></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>