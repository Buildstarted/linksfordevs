<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Tip 273 - Getting started with Azure Image Builder - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Tip 273 - Getting started with Azure Image Builder - linksfor.dev(s)"/>
    <meta property="og:description" content="Having standard Virtual Machine (VM) images can help you to make sure that your VMs are all configured the same and have the same properties and security policies applied to them. You can create VM images with the Azure Image Builder. This allows you to define VM images in json format, store them somewhere (like in the Azure Shared Image Gallery), build them and deploy them into VMs."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://microsoft.github.io/AzureTipsAndTricks/blog/tip273.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Tip 273 - Getting started with Azure Image Builder</title>
<div class="readable">
        <h1>Tip 273 - Getting started with Azure Image Builder</h1>
            <div>Reading time: 6-7 minutes</div>
        <div>Posted here: 11 Aug 2020</div>
        <p><a href="https://microsoft.github.io/AzureTipsAndTricks/blog/tip273.html">https://microsoft.github.io/AzureTipsAndTricks/blog/tip273.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div data-v-0e4468e2=""> <h4 id="virtual-machine-images"> Virtual Machine Images</h4> <p>Having standard Virtual Machine (VM) images can help you to make sure that your VMs are all configured the same and have the same properties and security policies applied to them. You can create VM images with the <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/image-builder-overview?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Azure Image Builder</a>. This allows you to define VM images in json format, store them somewhere (like in the <a href="https://docs.microsoft.com/azure/virtual-machines/windows/shared-image-galleries?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Azure Shared Image Gallery</a>), build them and deploy them into VMs.</p> <p>In this post, we'll build a Linux-based VM image and create a VM from it using Azure Image Builder.</p> <h4 id="prerequisites"> Prerequisites</h4> <p>If you want to follow along, you'll need the following:</p> <ul><li>An Azure subscription (If you don't have an Azure subscription, create a <a href="https://azure.microsoft.com/free/?WT.mc_id=azure-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">free account</a> before you begin)</li> <li>The <a href="https://docs.microsoft.com/cli/azure/?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Azure CLI</a>. You can <a href="https://docs.microsoft.com/cli/azure/install-azure-cli?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">download it for Windows, Linux or Mac</a>. Or you can use the <a href="https://shell.azure.com/?WT.mc_id=azure-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Azure Cloud Shell</a></li></ul> <h4 id="creating-a-linux-vm-image-using-azure-image-builder"> Creating a Linux VM image using Azure Image Builder</h4> <p>Let's use Azure Image Builder to create a Linux VM image, build that image and deploy it as a VM. We'll do all of this using the Azure CLI, which you can run on your <a href="https://docs.microsoft.com/cli/azure/?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">local machine</a> or in the cloud using <a href="https://shell.azure.com/?WT.mc_id=azure-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Azure Cloud Shell</a>.</p> <p><strong>Things to do whilst Azure Image Builder is in Preview</strong></p> <p>Azure Image Builder is currently in preview. This means that we need to run a couple of commands to register the preview feature. You can skip this part when Azure image Builder is generally available.</p> <p>First, register the new feature:</p> <div><pre><code>az feature register --namespace Microsoft.VirtualMachineImages --name VirtualMachineTemplatePreview
</code></pre> <p><span>1</span><br></p></div><p>Next, check if the registration succeeded. It can take a while until the feature is registered, so keep trying this command until it is:</p> <div><pre><code>az feature show --namespace Microsoft.VirtualMachineImages --name VirtualMachineTemplatePreview 
</code></pre> <p><span>1</span><br></p></div><p>We also need to make sure that certain resource providers are registered in your subscription. You can check that with:</p> <div><pre><code>az provider show -n Microsoft.VirtualMachineImages 

az provider show -n Microsoft.Storage 
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br></p></div><p>If these are not registered, run the following command:</p> <div><pre><code>az provider register -n Microsoft.VirtualMachineImages

az provider register -n Microsoft.Storage
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br></p></div><p><strong>Setup variables and create the VM image</strong></p> <p>Before we begin, we should create some variables for the things that we are going to use more often. The following commands set variables that we'll use. Make sure to insert your Azure Subscription ID, which you can find with <strong>az account show</strong> or by looking in the Azure portal under <strong>Subscriptions</strong>:</p> <div><pre><code># Resource group name - we are using myImageBuilderRG in this example
imageResourceGroup=myImageBuilerRGLinux
# Datacenter location - we are using West US 2 in this example
location=WestUS2
# Name for the image - we are using myBuilderImage in this example
imageName=myBuilderImage
# Run output name
runOutputName=aibLinux
# Set Azure Subscription ID
subscriptionID=&lt;Your subscription ID&gt;
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></p></div><p>Next, we'll create the resource group that will contain the VM image:</p> <div><pre><code>az group create -n $imageResourceGroup -l $location
</code></pre> <p><span>1</span><br></p></div><p>We also need to grant Image Builder contributor rights on the Resource Group that we've just created. It needs this to build the image. You can use the exact assignee id in the code below. This is the app registration for the image Builder service and is the same for everyone.</p> <div><pre><code>az role assignment create 
    --assignee cf32a0cc-373c-47c9-9156-0db11f6a6dfc 
    --role Contributor 
    --scope /subscriptions/$subscriptionID/resourceGroups/$imageResourceGroup
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></p></div><p>Now to download the example VM template, which is a json file and apply our variables to it:</p> <div><pre><code>curl https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/quickquickstarts/0_Creating_a_Custom_Linux_Managed_Image/helloImageTemplateLinux.json -o helloImageTemplateLinux.json

sed -i -e "s/&lt;subscriptionID&gt;/$subscriptionID/g" helloImageTemplateLinux.json
sed -i -e "s/&lt;rgName&gt;/$imageResourceGroup/g" helloImageTemplateLinux.json
sed -i -e "s/&lt;region&gt;/$location/g" helloImageTemplateLinux.json
sed -i -e "s/&lt;imageName&gt;/$imageName/g" helloImageTemplateLinux.json
sed -i -e "s/&lt;runOutputName&gt;/$runOutputName/g" helloImageTemplateLinux.json
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></p></div><p>You can see the json file and that the parameters have been applied in the code editor by using:</p> <div><pre><code>code helloImageTemplateLinux.json
</code></pre> <p><span>1</span><br></p></div><p>Next, we'll submit the image configuration to the VM Image Builder service:</p> <div><pre><code>az resource create 
    --resource-group $imageResourceGroup 
    --properties @helloImageTemplateLinux.json 
    --is-full-object 
    --resource-type Microsoft.VirtualMachineImages/imageTemplates 
    -n helloImageTemplateLinux01
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></p></div><p>When that is done, we can build the image with the command below. Note that this can take about 15 minutes or so.</p> <div><pre><code>az resource invoke-action 
     --resource-group $imageResourceGroup 
     --resource-type  Microsoft.VirtualMachineImages/imageTemplates 
     -n helloImageTemplateLinux01 
     --action Run 
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></p></div><p>Once the build has completed, we can create a VM from the image using the following command:</p> <div><pre><code>az vm create 
  --resource-group $imageResourceGroup 
  --name myVM 
  --admin-username azureuser 
  --image $imageName 
  --location $location 
  --generate-ssh-keys
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></p></div><p>Note that you can also build and deploy and image using a <a href="https://marketplace.visualstudio.com/items?itemName=AzureImageBuilder.devOps-task-for-azure-image-builder&amp;WT.mc_id=other-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">task in Azure DevOps</a>.</p> <p>Once this is done, you should see a public IP address of the VM in the output. Use that IP address in the following command to SSH into the VM:</p> <div><pre><code>ssh azureuser@&lt;publicIpAddress&gt;
</code></pre> <p><span>1</span><br></p></div><p>That's it! You should now be connected with the VM and see something like the image below, which shows that this VM was built from the VM Image:</p> <p><img src="https://microsoft.github.io/AzureTipsAndTricks/files/61result.png"></p><p>(Connected to the VM that was built from the image)</p> <p>Also, if you go to the Azure portal and take a look at the Resource Group that we've created, you'll find the VM in there:</p> <p><img src="https://microsoft.github.io/AzureTipsAndTricks/files/61vmresult.png"></p><p>(The VM in the Azure portal)</p> <h4 id="conclusion"> Conclusion</h4> <p><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/image-builder-overview?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Azure Image Builder</a> provides a great way to create customized VM images that you can use as a standard to make sure that you can deploy consistent VMs with the same properties and policies. Go and check it out!</p></div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>