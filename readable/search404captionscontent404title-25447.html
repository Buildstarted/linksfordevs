<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Cumulative Update 15 for SQL Server 2017 - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Cumulative Update 15 for SQL Server 2017 - linksfor.dev(s)"/>
    <meta property="og:description" content="Describes cumulative update package 15 for SQL Server 2017."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://support.microsoft.com/en-us/help/4498951/cumulative-update-15-for-sql-server-2017"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Cumulative Update 15 for SQL Server 2017</title>
<div class="readable">
        <h1>Cumulative Update 15 for SQL Server 2017</h1>
            <div>Reading time: 10-13 minutes</div>
        <div>Posted here: 28 May 2019</div>
        <p><a href="https://support.microsoft.com/en-us/help/4498951/cumulative-update-15-for-sql-server-2017">https://support.microsoft.com/en-us/help/4498951/cumulative-update-15-for-sql-server-2017</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
            <div content-section-list="article.details.body" itemprop="articleBody"><!-- ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><p>This article describes Cumulative Update package 15&nbsp;(CU15) for SQL Server 2017. This update contains <a bookmark-id="hfi" href="https://support.microsoft.com/en-us/help/4498951/cumulative-update-15-for-sql-server-2017#hfi" managed-link="" target="" tabindex="0" data-bi-name="content-anchor-link">fixes</a> that were released after the initial release of SQL Server 2017 and updates the SQL Server and Analysis services components to the following builds:</p>

<table>
	<tbody>
		<tr>
			<td><strong>Component</strong></td>
			<td><strong>Build version</strong></td>
			<td><strong>File version</strong></td>
		</tr>
		<tr>
			<td><strong>SQL Server</strong></td>
			<td>14.0.3162.1</td>
			<td>2017.140.3162.1</td>
		</tr>
		<tr>
			<td><strong>Analysis Services</strong></td>
			<td>14.0.249.3</td>
			<td>2017.140.249.3</td>
		</tr>
	</tbody>
</table>



<h3>Important notices</h3>

<p>This article also provides important information about the following situations:</p>

<ul>
	<li><strong><a bookmark-id="pace" href="https://support.microsoft.com/en-us/help/4498951/cumulative-update-15-for-sql-server-2017#pace" managed-link="" tabindex="0" data-bi-name="content-anchor-link">Pacemaker:&nbsp;</a></strong>A behavioral change is made in distributions that use the latest available version of Pacemaker. Mitigations methods are provided.</li>
	<li><strong><a bookmark-id="query" href="https://support.microsoft.com/en-us/help/4498951/cumulative-update-15-for-sql-server-2017#query" managed-link="" tabindex="0" data-bi-name="content-anchor-link">Query Store:</a></strong>&nbsp;You must run this script if you use <strong>Query Store</strong> and you have previously installed SQL Server 2017 Cumulative Update 2 (CU2).</li>
	<li><a bookmark-id="avail" href="https://support.microsoft.com/en-us/help/4498951/cumulative-update-15-for-sql-server-2017#avail" managed-link="" tabindex="0" data-bi-name="content-anchor-link"><strong>Availability Group preferred replica backups:</strong></a>&nbsp;An error occurs if you use <strong>sys.fn_hadr_backup_is_preferred_replica</strong> to determine the preferred Availability Group replica for backup jobs.&nbsp;</li>
	<li><strong>Analysis Services CU build version:</strong> Beginning in SQL Server 2017, the Analysis Services build version number and SQL Server Database Engine build version number do not match. For more information, see&nbsp;<a data-content-id="" data-content-type="" href="https://docs.microsoft.com/en-us/sql/analysis-services/instances/analysis-services-component-version?view=sql-server-2017&amp;viewFallbackFrom=sql-server-" managed-link="" target="_blank" tabindex="0" data-bi-name="content-anchor-link">Verify Analysis Services cumulative update build version</a>.<br>
	&nbsp;</li>
</ul>

<h3>Cumulative updates</h3>

<div>
<div><p>Cumulative updates (CU) are now available at the Microsoft Download Center.</p><p>

Only the most recent CU that was released for SQL Server 2017 is available at the Download Center.</p></div>

<p>CU packages for Linux are available at&nbsp;<a href="https://packages.microsoft.com/">https://packages.microsoft.com/</a>.</p>

<p><strong>Notes</strong></p>

<ul>
	<li>Each new CU contains all the fixes that were included with the previous CU for the installed version of SQL Server.</li>
	<li>SQL Server CUs are certified to the same levels as Service Packs, and should be installed at the same level of confidence.</li>
	<li>Microsoft recommends ongoing, proactive installation of CUs as they become available according to these guidelines:<br>
	&nbsp;
	<ul>
		<li>Historical data shows that a significant number of support cases involve an issue that has already been addressed in a released CU.</li>
		<li>CUs may contain added value over and above hotfixes. This includes supportability, manageability, and reliability updates.</li>
	</ul>
	</li>
	<li>We recommend that you test CUs before you deploy them to production environments.</li>
</ul>
</div>
</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-1" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-1">
        <h2 ng-bind-html="contentSection.title">How to obtain this cumulative update package for Windows</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><div>
<p>The following update is available from the Microsoft Download Center:</p>







<ul>
	<li>After future cumulative updates are released for SQL Server 2017, this and all previous CUs can be downloaded from the <a href="http://catalog.update.microsoft.com/v7/site/search.aspx?q=sql%20server" id="kb-link-5" target="_self">Microsoft Update Catalog</a>. However, we recommend that you always install the latest cumulative update that is available.</li>
</ul>
</div>
</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-2" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-2">
        <h2 ng-bind-html="contentSection.title">How to obtain this cumulative update package for Linux</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><p>To update Linux to the latest CU, you must first have the&nbsp;<a data-content-id="" data-content-type="" href="https://docs.microsoft.com/sql/linux/sql-server-linux-setup#repositories" managed-link="" target="_blank" tabindex="0" data-bi-name="content-anchor-link">Cumulative Update repository configured</a>. Then, update your SQL Server packages by using the appropriate platform-specific update command.</p>

<p>For installation instructions and direct links to the CU package downloads, see the&nbsp;<a data-content-id="" data-content-type="" href="https://docs.microsoft.com/en-us/sql/linux/sql-server-linux-release-notes#cuinstall" target="_blank">release notes</a>.</p>
</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-3" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-3">
        <h2 ng-bind-html="contentSection.title">Additional hotfixes that are included in this cumulative update package</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-4" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-4">
        <h2 ng-bind-html="contentSection.title">Notes for this update </h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><div>
<h3>Hybrid environments deployment</h3>

<div><p>When you deploy an update to a hybrid environment (such as AlwaysOn, replication, cluster, and mirroring), we recommend that you refer to the following articles before you deploy the update:</p>
</div>








</div>


</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-5" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-5">
        <h2 ng-bind-html="contentSection.title">Cumulative update package information</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><div>
<h3>Prerequisites</h3><p>
To apply this cumulative update package, you must be running SQL Server 2017.

</p><h3>Restart information</h3>
<p><span> You may have to restart the computer after you apply this cumulative update package.</span></p><h3>Registry information</h3>
<p><span> To use one of the hotfixes in this package, you do not have to make any changes to the registry.</span></p></div>
</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-6" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-6">
        <h2 ng-bind-html="contentSection.title">More CU package information</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" id="pace" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-7" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-7">
        <h2 ng-bind-html="contentSection.title">Pacemaker notice</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><p><strong>IMPORTANT</strong></p>

<p>All distributions (including RHEL 7.3 and&nbsp;7.4) that use the latest available <strong>Pacemaker package 1.1.18-11.el7</strong> introduce&nbsp;a behavior change for the <strong>start-failure-is-fatal</strong> cluster setting when its value is <strong>false</strong>. This change affects the failover workflow. If a primary replica experiences an outage, the cluster is expected to failover to one of the available secondary replicas. Instead, users will notice that the cluster keeps trying to start the failed primary replica. If that primary never comes online (because of a permanent outage), the cluster never fails over to another available secondary replica.</p>

<p>This <span>issue</span> affects all SQL Server versions, regardless&nbsp;of the c<span>umulative u</span><span>pdate</span> version that they are on.</p>

<p>To mitigate the issue, use either of the following methods.</p>

<p><strong>Method&nbsp;1</strong></p>

<p>Follow these steps:</p>

<ol>
	<li>Remove the&nbsp;<strong>start-failure-is-fatal</strong> override from the existing cluster.&nbsp;

	<pre>   # RHEL, Ubuntu
&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp; pcs property unset start-failure-is-fatal
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    # or
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    pcs property set start-failure-is-fatal=true

   # SLES
         crm configure property start-failure-is-fatal=true</pre>
	</li>
	<li>Decrease the&nbsp;<strong>cluster-recheck-interval</strong> value.&nbsp;
	<pre>   # RHEL, Ubuntu
   &nbsp;&nbsp;&nbsp;   pcs property set cluster-recheck-interval=&lt;Xmin&gt;

   # SLES
&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp; crm configure property cluster-recheck-interval=&lt;Xmin&gt;</pre>
	</li>
	<li>Add the <strong>failure-timeout</strong> meta property to each AG resource.&nbsp;
	<pre>   # RHEL, Ubuntu
         pcs resource update ag1 meta failure-timeout=60s

   # SLES
         crm configure edit ag1

&nbsp;&nbsp;&nbsp;   # In the text editor, add `meta failure-timeout=60s` after any `param`s and before any `op`s</pre>
	&nbsp;

	<p><strong>Note</strong> In this code, substitute the value for &lt;Xmin&gt; as appropriate.&nbsp;If a replica goes down, the cluster tries to restart the replica at an interval that is bound by the&nbsp;<strong>failure-timeout</strong>&nbsp;value and the&nbsp;<strong>cluster-recheck-interval</strong>&nbsp;value. For example,&nbsp;if&nbsp;<strong>failure-timeout</strong> is set to 60 seconds and <strong>cluster-recheck-interval</strong> is set to 120 seconds, the restart is tried&nbsp;at an interval that is greater than 60 seconds but less than 120 seconds.&nbsp;We recommend that you set&nbsp;<strong>failure-timeout</strong> to <strong>60s</strong> and <strong>cluster-recheck-interval</strong> to a value that is greater than 60 seconds. Setting&nbsp;<strong>cluster-recheck-interval</strong> to a&nbsp;small value is not recommended. For more information, refer to the Pacemaker documentation or consult the system provider.</p>
	</li>
</ol>

<p><br>
<strong>Method 2</strong></p>

<p>Revert to Pacemaker version 1.1.16.</p>


</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" id="query" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-8" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-8">
        <h2 ng-bind-html="contentSection.title">Query Store notice</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><p><strong>IMPORTANT</strong></p>

<p>If you use the <strong>Query Store</strong> feature, and you have previously installed <a data-content-id="4052574" data-content-type="article" href="https://support.microsoft.com/en-us/help/4052574" managed-link="" target="_blank" tabindex="0" data-bi-name="content-anchor-link">Cumulative Update 2 (CU2) (14.0.3008.27)</a>, the following requirement applies to you:</p>

<p>After you install&nbsp;<a data-content-id="4052987" data-content-type="article" href="https://support.microsoft.com/en-us/help/4052987" managed-link="" target="_blank" tabindex="0" data-bi-name="content-anchor-link">Cumulative Update 3 (CU3) (14.0.3015.40)</a>&nbsp;or a later CU, you must&nbsp;immediately run the following script to delete all plans that were collected by Query Store while CU2 was installed:</p>

<pre>SET NOCOUNT ON;
DROP TABLE IF EXISTS #tmpUserDBs;

SELECT [database_id], 0 AS [IsDone]
INTO #tmpUserDBs
FROM master.sys.databases
WHERE [database_id] &gt; 4
&nbsp;AND [state] = 0 -- must be ONLINE
&nbsp;AND is_read_only = 0 -- cannot be READ_ONLY
&nbsp;AND [database_id] NOT IN (SELECT dr.database_id FROM sys.dm_hadr_database_replica_states dr -- Except all local Always On secondary replicas
&nbsp;&nbsp;INNER JOIN sys.dm_hadr_availability_replica_states rs ON dr.group_id = rs.group_id
&nbsp;&nbsp;INNER JOIN sys.databases d ON dr.database_id = d.database_id
&nbsp;&nbsp;WHERE rs.role = 2 -- Is Secondary
&nbsp;&nbsp;&nbsp;AND dr.is_local = 1
&nbsp;&nbsp;&nbsp;AND rs.is_local = 1)

DECLARE @userDB sysname;

WHILE (SELECT COUNT([database_id]) FROM #tmpUserDBs WHERE [IsDone] = 0) &gt; 0
BEGIN
&nbsp;SELECT TOP 1 @userDB = DB_NAME([database_id]) FROM #tmpUserDBs WHERE [IsDone] = 0

&nbsp;-- PRINT 'Working on database ' + @userDB

&nbsp;EXEC ('USE [' + @userDB + '];
DECLARE @clearPlan bigint, @clearQry bigint;
IF EXISTS (SELECT [actual_state] FROM sys.database_query_store_options WHERE [actual_state] IN (1,2))
BEGIN
&nbsp;IF EXISTS (SELECT plan_id FROM sys.query_store_plan WHERE engine_version = ''14.0.3008.27'')
&nbsp;BEGIN
&nbsp;&nbsp;DROP TABLE IF EXISTS #tmpclearPlans;

&nbsp;&nbsp;SELECT plan_id, query_id, 0 AS [IsDone]
&nbsp;&nbsp;INTO #tmpclearPlans
&nbsp;&nbsp;FROM sys.query_store_plan WHERE engine_version = ''14.0.3008.27''

&nbsp;&nbsp;WHILE (SELECT COUNT(plan_id) FROM #tmpclearPlans WHERE [IsDone] = 0) &gt; 0
&nbsp;&nbsp;BEGIN
&nbsp;&nbsp;&nbsp;SELECT TOP 1 @clearPlan = plan_id, @clearQry = query_id FROM #tmpclearPlans WHERE [IsDone] = 0
&nbsp;&nbsp;&nbsp;EXECUTE sys.sp_query_store_unforce_plan @clearQry, @clearPlan;
&nbsp;&nbsp;&nbsp;EXECUTE sys.sp_query_store_remove_plan @clearPlan;

&nbsp;&nbsp;&nbsp;UPDATE #tmpclearPlans
&nbsp;&nbsp;&nbsp;SET [IsDone] = 1
&nbsp;&nbsp;&nbsp;WHERE plan_id = @clearPlan AND query_id = @clearQry
&nbsp;&nbsp;END;

&nbsp;&nbsp;PRINT ''- Cleared possibly affected plans in database [' + @userDB + ']''
&nbsp;END
&nbsp;ELSE
&nbsp;BEGIN
&nbsp;&nbsp;PRINT ''- No affected plans in database [' + @userDB + ']''
&nbsp;END
END
ELSE
BEGIN
&nbsp;PRINT ''- Query Store not enabled in database [' + @userDB + ']''
END')
&nbsp;&nbsp;UPDATE #tmpUserDBs
&nbsp;&nbsp;SET [IsDone] = 1
&nbsp;&nbsp;WHERE [database_id] = DB_ID(@userDB)
END</pre>
</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><div ng-repeat="section in contentSectionList track by $index" ng-if="!isString &amp;&amp; hasContent()">
    <div content-section="section"><!-- ngIf: typeof(contentSection) !== 'string' --><section data-grid="col-12" ng-if="typeof(contentSection) !== 'string'" ng-show="shouldShow" applies-to-saps="[]" ng-attr-id="{{contentSection.meta.id}}" ng-class="{'internal-content': isInternalSection(), 'flighted-content': shouldHighlightFlight }" data-before="" id="avail" aria-hidden="false">
    <!-- ngIf: isInternalSection() -->
    <!-- ngIf: contentSection.title --><p id="section-9" ng-if="contentSection.title" data-js-in-page-navigation-anchor="section-9">
        <h2 ng-bind-html="contentSection.title">Availability Group preferred replica backups</h2>
        <hr>
        <!-- ngIf: contentSection.subtitle -->
    </p><!-- end ngIf: contentSection.title -->
    <!-- ngIf: contentSection.content && contentSection.content.length > 0 --><div ng-if="contentSection.content &amp;&amp; contentSection.content.length > 0">
        <!-- ngRepeat: content in contentSection.content track by $index --><div ng-attr-data-grid="{{getStyleClass()}}" ng-repeat="content in contentSection.content track by $index" data-grid="col-12">
            <div compile="content" data-grid="col-12"><p><strong>IMPORTANT</strong></p>

<p>Consider the following scenario:</p>

<ul>
	<li>You are running an Availability Group on a Windows Server failover cluster.</li>
	<li>You are using the <strong>sys.fn_hadr_backup_is_preferred_replica</strong> function within your backup jobs to determine whether to run a backup on the current replica.</li>
</ul>

<p>In this scenario, the function call fails and generates the following error message:&nbsp;</p>

<div>
<div role="alert">
<div>
<p>Msg 41070, Level 16, State 1, Line 1<br>
Configuration data for the availability group with Windows Server Failover Clustering (WSFC) resource ID '&lt;resource ID&gt;' is not found in the WSFC data store. &nbsp;The availability group may have been dropped, or a previous CREATE AVAILABILITY GROUP or DROP AVAILABILITY GROUP operation has failed. &nbsp;Please use DROP AVAILABILITY GROUP command to clean up previously failed operations before retrying the current operation.</p>
</div>
</div>
</div>

<p><br>
This issue does not affect the backup itself. Therefore, you can work around this issue by removing the call to <strong>sys.fn_hadr_backup_is_preferred_replica</strong>.</p>

<p>If you have to back up only on the preferred replica, we recommended that you do not apply Cumulative Update 15. This issue will be fixed in a future release.</p>
</div>
            <!-- ngIf: contentSection.meta.type != 'single-column' && !$last -->
        </div><!-- end ngRepeat: content in contentSection.content track by $index -->
    </div><!-- end ngIf: contentSection.content && contentSection.content.length > 0 -->
</section><!-- end ngIf: typeof(contentSection) !== 'string' --></div>
</div><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index --><!-- ngIf: !isString && hasContent() --><!-- end ngIf: !isString && hasContent() --><!-- end ngRepeat: section in contentSectionList track by $index -->
<!-- ngIf: !isString --><!-- end ngIf: !isString --></div>
        </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>