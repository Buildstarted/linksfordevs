<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Link&#x2019;s Awakening disassembly progress report &#x2013; week&#xA0;5 -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Link&#x2019;s Awakening disassembly progress report &#x2013; week&#xA0;5</h1>
    <section class="content "> <section class="byline"> 24 juillet 2019 </section> <p><em>This article is part of an ongoing &#x201C;<a href="/posts/category-disassembling-links-awakening">Disassembling Link&#x2019;s Awakening</a>&#x201D; series, where I attempt to gain some understanding on how special effects where implemented in this game.</em></p> <p>It&#x2019;s been a while! The <a href="/posts/links-awakening-disassembly-progress-report-week-4">last disassembly progress report</a> was published more than one year ago. Meanwhile, what happened?</p> <p>Well, kind of a slowdown, actually. But a few weeks ago, with the release of Link&#x2019;s Awakening remake on the Switch drawing nearer, the disassembling efforts gained some steam again.</p> <p>Which means many things appeared! Let&#x2019;s see what&#x2019;s new.</p> <h2 id="new-repository">New repository</h2> <p>In 2015, on the 11th of August, <a href="https://github.com/mojobojo/">mojobojo</a> started a disassembly project. Four years later, this project has grown tremendously. With the participation of <a href="https://github.com/zladx/LADX-Disassembly/blob/master/README.md#contributors">several external contributors</a>, it made little sense to still have the repository under a single user account.</p> <p>Thankfully, mojobojo agreed to <strong>transfer the admin rights to an organization</strong>. Which means the repository has a new home! It is now reachable at <a href="https://github.com/zladx/LADX-Disassembly">github.com/zladx/LADX-Disassembly</a>.</p> <p>The new organization makes also possible to add many admins and many contributors, which could make the contributions smoother.</p> <h2 id="more-maps">More maps</h2> <p>Many of Link&#x2019;s Awakening ROM hacks feature new maps. Throughout the years, many level editors came and went, trying to figure out how to read the game maps, and how to insert modified maps back without breaking the ROM.</p> <p><span class="pixel-art">
<a href="/images/zelda-links-awakening-progress-report-5/zelda-dx-overworld.jpg"><img src="/images/zelda-links-awakening-progress-report-5/zelda-dx-overworld.jpg" alt="Zelda Link&#x2019;s Awakening entire Overworld"></a>
</span>
<em>Isn&#x2019;t that beautiful?</em></p> <p>Unfortunately <strong>there is no central documentation about the map data format</strong>. Informations are scattered here and there, deep in the code of the level editors.</p> <p>So with the help of <a href="https://github.com/Xkeeper0">Xkeeper0</a>, a <a href="https://github.com/zladx/LADX-Disassembly/blob/master/tools/map_parser.py">new parser for the maps, rooms, objects and warp points</a> was written in Python. This parser emits nicely formatted files containing the rooms table and objects.</p> <p>In the end, the format is easy enough:</p> <ul> <li>Maps are 16x16 arrays of pointers to rooms;</li> <li>Rooms are variable-length objects, containing: <ul> <li>A two-bytes header describing the room tileset and floor template,</li> <li>A variable number of objects.</li> </ul> </li>
</ul> <p><strong>The neat thing is the objects format</strong>.</p> <p>To save space on the original cartridge, rooms are not stored as a sequential array of all the rooms&#x2019; blocks (which would always use 10&#xA0;&#xD7;&#xA0;8 bytes per room).</p> <p>Instead, <strong>rooms are painted</strong>.</p> <p>First, a configurable ground tile is repeated on the whole room.</p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-1.png" alt="room-1">
</span></p> <p>Then, in dungeons, as the walls of most rooms look the same, a room template is applied.</p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-2.png" alt="room-2">
</span></p> <p>And afterwards, objects are laid out individually on the room, in single-blocks &#x2013; or in strips spanning several blocks.</p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-3.png" alt="room-3">
</span></p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-4.png" alt="room-4">
</span></p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-5.png" alt="room-5">
</span></p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-6.png" alt="room-6">
</span></p> <p>In the end, here is how the final room looks like, after it has been entirely painted with objects.</p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-final.png" alt="room-final">
</span></p> <p>The final size for this: <strong>only 30 bytes</strong> (instead of 80 bytes if all objects had to be stored individually). Neat. The game even defines a few macros which can paint directly a whole house or tree, for instance.</p> <p>This also allows for nice animations of the rooms being constructed. You can even see the designers changing their minds mid-development, and overlapping bushes with flowers.</p> <p><span class="pixel-art">
<img src="/images/zelda-links-awakening-progress-report-5/room-painted.gif" alt="An animated version of an overworld room being constructed">
</span><br>
<em>Credits: XKeeper0 <a href="https://xkeeper.net/hacking/linksawakening/">Link&#x2019;s Awakening Depot</a></em></p> <h2 id="more-code">More code</h2> <p>Last year, around 3 banks of code had been disassembled. Today, we are at 9 banks of code disassembled&#x2013;and counting.</p> <p><strong>Disassembling new banks used to be difficult</strong>. The disassembler spew lot of invalid code, that had to be fixed by hand, and the existing variables and functions were not carried to the newly disassembled code.</p> <p>This changed with the use of mattcurie&#x2019;s <a href="https://github.com/mattcurrie/mgbdis">mgbdis</a> new disassembler, which emits very good quality code.</p> <p>But <strong>disassembling a bank is useless if we don&#x2019;t do anything with it</strong>. Once we have the raw code, it is only useful after cutting some noise: separate data from the actual code, and cross-referencing it with the existing banks. All of this takes time&#x2013;so new banks are added progressively.</p> <p>Recently, banks 14 and 20 were added. They contain some inventory code, the code responsible for applying room templates when loading a dungeon&#x2019;s room, overworld audio tasks, palette effects&#x2026;</p> <p>&#x2026; and something interesting: the code for enemies, NPC, dungeon bosses and entities behavior. Reverse-engineering the bosses IA will be fun.</p> <h2 id="more-audio">More audio</h2> <p>The game uses the Game Boy audio capabilities for good effect: it can may simultaneously a long music track, a short jingle, and very short sound-effect.</p> <p><span class="pixel-art gameboy-screen">
<img src="/images/zelda-links-awakening-progress-report-5/Marin singing.png" alt="A screenshot of Marin singing">
</span><br>
<em>I know you can hear the music in your head.</em></p> <p>For a long time, the disassembly labelled two variables to control the sound effect:</p> <div class="language-coffee highlighter-rouge"><pre class="highlight"><code><span class="p">;</span> <span class="nx">Play</span> <span class="nx">an</span> <span class="nx">audio</span> <span class="nx">effect</span> <span class="nx">immediately</span>
<span class="na">hSFX</span><span class="o">::</span> <span class="nx">ds</span> <span class="mi">1</span> <span class="p">;</span> <span class="nx">FFF3</span> <span class="p">;</span> <span class="nx">Play</span> <span class="nx">an</span> <span class="nx">audio</span> <span class="nx">effect</span> <span class="nx">next</span>
<span class="na">hNextSFX</span><span class="o">::</span> <span class="nx">ds</span> <span class="mi">1</span> <span class="p">;</span> <span class="nx">FFF4</span>
</code></pre>
</div> <p>Put the identifier of a sound effect in <code class="highlighter-rouge">hSFX</code>, and it will immediately. Put it in <code class="highlighter-rouge">hNextSFX</code>, and it will play after the current sound effect is finished.</p> <p>Easy, right?</p> <p>Well, while I was disassembling the code for the overworld audio tasks performed on each frame, I noticed <strong>the identifiers between these two variables didn&#x2019;t match</strong>. For instance, writing <code class="highlighter-rouge">$04</code> in <code class="highlighter-rouge">hSFX</code> would play a beeping <code class="highlighter-rouge">SFX_LOW_HEARTS</code> sound effect; but writing the same value in <code class="highlighter-rouge">hSFX</code> would play a &#x201C;The doors of the room are now open&#x201D; sound effect. Hmm.</p> <p>I dug into the code to find where <code class="highlighter-rouge">hNextSFX</code> was eventually written into <code class="highlighter-rouge">hSFX</code>. I couldn&#x2019;t find such code. Something was wrong.</p> <p>Now, audio is not my speciality. So I turned to the Game Boy hardware documentation. Turns out that the Game Boy can generate a wide variety of audio (in stereo, for good mesure): it has two square-wave outputs, one waveform output, and one configurable noise generator.</p> <p>Oh. Of course.</p> <p>The reason two sound effects can sound different is that there are actually <strong>two kind of sound-effects</strong>: wave-based, and noise-based. It all comes to the hardware capabilities.</p> <p>Everything makes much more sense:</p> <ul> <li><strong>Jingles</strong> are square-wave-based sound effects. They sound like the music: a sequence of <em>beeps</em>;</li> <li><strong>Wave sound effects</strong> are based on a wave-table. Although they are way larger to store, they can output a greater variety of sounds;</li> <li><strong>Noise sound effects</strong> use the configurable noise generator to produce <em>swings</em>, <em>swooshs</em>, <em>scratches</em> and <em>rumbles</em>.</li>
</ul> <p>Now I could fix the code:</p> <div class="language-coffee highlighter-rouge"><pre class="highlight"><code><span class="p">;</span> <span class="nx">Play</span> <span class="nx">a</span> <span class="nx">waveform</span><span class="o">-</span><span class="nx">based</span> <span class="nx">audio</span> <span class="nx">effect</span> <span class="nx">immediately</span>
<span class="na">hWaveSFX</span><span class="o">::</span> <span class="nx">ds</span> <span class="mi">1</span> <span class="p">;</span> <span class="nx">FFF3</span> <span class="p">;</span> <span class="nx">Play</span> <span class="nx">a</span> <span class="nx">noise</span><span class="o">-</span><span class="nx">based</span> <span class="nx">audio</span> <span class="nx">effect</span> <span class="nx">immediately</span>
<span class="na">hNoiseSFX</span><span class="o">::</span> <span class="nx">ds</span> <span class="mi">1</span> <span class="p">;</span> <span class="nx">FFF4</span>
</code></pre>
</div> <p>In hindsight this is quite obvious, and probably well-known by ROM hackers. But well, this was my epiphany. At least we now have a growing but already decent <a href="https://github.com/zladx/LADX-Disassembly/blob/master/src/constants/sfx.asm">list of the different sound effects</a>.</p> <h2 id="and-now">And now?</h2> <p>Two days ago, while trying to understand the entities data format, it occurred to me: <strong>this project is now closer to its completion than from its beginning</strong>. Maps, tiles and dialogs are dumped, most banks are disassembled, around half of the code is at least partially documented. And with all the data already labelled, the second half should be much easier.</p> <p>Of course there are tons of things still to be done. Tilesets, warp data and chest data are missing. The room formats could be much improved. The enemy IA is in view, but still will require efforts. Audio has only been lightly touched.</p> <p>But <strong>it has never been easier to make progress</strong>. Gone are the days of erring in a pile of assembly instructions, having no clue of what the code is doing: there is always a labelled variable to give a hint.</p> <p><em>Want to read more?
Discover <a href="https://github.com/mojobojo/LADX-Disassembly">more of the code</a>, or <a href="https://discord.gg/sSHrwdB">join the discussion on Discord</a>.</em></p> </section>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>