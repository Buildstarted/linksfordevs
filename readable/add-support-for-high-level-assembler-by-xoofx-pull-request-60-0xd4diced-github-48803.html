<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Add support for high level Assembler by xoofx &#xB7; Pull Request #60 &#xB7; 0xd4d/iced - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Add support for high level Assembler by xoofx &#xB7; Pull Request #60 &#xB7; 0xd4d/iced - linksfor.dev(s)"/>
    <meta property="article:author" content="0xd4d"/>
    <meta property="og:description" content="This is a PR for #49&#xA;It is an early preview to get early feedback and iterate ideas on the design, many things are not working as it should or are not completely covered or are subject to changes (..."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://github.com/0xd4d/iced/pull/60"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title">devring.club</span>
				<a href="https://devring.club/site/1/previous" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Add support for high level Assembler by xoofx &#xB7; Pull Request #60 &#xB7; 0xd4d/iced</title>
<div class="readable">
        <h1>Add support for high level Assembler by xoofx &#xB7; Pull Request #60 &#xB7; 0xd4d/iced</h1>
            <div>by 0xd4d</div>
            <div>Reading time: 27-34 minutes</div>
        <div>Posted here: 22 Jan 2020</div>
        <p><a href="https://github.com/0xd4d/iced/pull/60">https://github.com/0xd4d/iced/pull/60</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div data-channel="marked-as-read:pull-request:359444636">

        
<div data-gid="MDExOlB1bGxSZXF1ZXN0MzU5NDQ0NjM2" data-url="/_render_node/MDExOlB1bGxSZXF1ZXN0MzU5NDQ0NjM2/pull_requests/body" data-channel="pull_request:359444636">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>

  
<div id="issue-359444636">
  <div data-body-version="5fca3252b0dfeba5a4a7e0eb1418a3ca" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>This is a PR for <a data-error-text="Failed to load issue title" data-id="509460266" data-permission-text="Issue title is private" data-url="https://github.com/0xd4d/iced/issues/49" data-hovercard-type="issue" data-hovercard-url="/0xd4d/iced/issues/49/hovercard" href="https://github.com/0xd4d/iced/issues/49">#49</a></p>
<p>It is an early preview to get early feedback and iterate ideas on the design, many things are not working as it should or are not completely covered or are subject to changes (e.g naming)...etc.</p>
<p>It is currently only working on Legacy opcodes, and only supporting r/m and reg opcodes.</p>
<ul>
<li>
  <span>
    
  </span> Prototype of codegen for CSharp</li>
<li>
  <span>
    
  </span> Prototype of API ExtendedXXX API</li>
<li>
  <span>
    
  </span> Add support for immediate</li>
<li>
  <span>
    
  </span> Create overloads RegMem instructions to Register</li>
<li>
  <span>
    
  </span> Add checks for r/m size vs reg size to disambiguate when required</li>
<li>
  <span>
    
  </span> Add support for all remaining instructions in:
<ul>
<li> LegacyOpCode</li>
<li> VexOpCode</li>
<li> EvexOpCode
<ul>
<li> Add support for k/z flags for EVEX</li>
</ul>
</li>
<li> XopOpCode</li>
<li> D3nowOpCode</li>
</ul>
</li>
<li>
  <span>
    
  </span> Add support for labels and branches</li>
<li>
  <span>
    
  </span> Refactor disambiguation code to base class instead of C# using <code>OpCodeOperandKind</code></li>
<li>
  <span>
    
  </span> Add support for prefixes
<ul>
<li> Segment overrides eg. __dword_ptr_gs[] or __dword_ptr.gs[]. Instruction.SegmentPrefix = ; to initialize it.</li>
<li> lock / xacquire / xrelease. Maybe update mem syntax, eg. __dword_ptr.lock</li>
<li> bnd = jcc, ret, ret imm, call rel, jmp rel, call rm, jmp rm</li>
<li> notrack = call rm and jmp rm</li>
</ul>
</li>
<li>
  <span>
    
  </span> Better handling of OpCode encoding exceptions (avoid duplicate, use function helper, explain what is wrong in the parameters...etc.)</li>
<li>
  <span>
    
  </span> Add tests coverage</li>
<li>
  <span>
    
  </span> Add tests for unable to encode opcode</li>
<li>
  <span>
    
  </span> Add license headers</li>
<li>
  <span>
    
  </span> Add API xml documentation</li>
<li>
  <span>
    
  </span> Add user guide documentation</li>
<li>
  <span>
    
  </span> Add support for db/dw/dd/dq</li>
<li>
  <span>
    
  </span> Add support for label</li>
<li>
  <span>
    
  </span> Add support for direct ulong address for jmp/call...</li>
</ul>
<p>This branch is based on top of the <code>rust</code> branch</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>

</div>


        

  


  
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0Q29tbWl0MzU5NDQ0NjM2OmI5MDkyMzk0YmJlMzYwYTdjZDVhMDdkNjRhOGQ3M2M3MGVlNTY4YmU=">
  
      <div>
  <div>
      <div>
        
        <div>
          

<div data-channel="repo:147866440:commit:b9092394bbe360a7cd5a07d64a8d73c70ee568be" data-url="/0xd4d/iced/pull/60/commits/b9092394bbe360a7cd5a07d64a8d73c70ee568be/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx">
          <img height="20" width="20" alt="@xoofx" src="https://avatars2.githubusercontent.com/u/715038?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
</div>


        </div>
      </div>
  </div>
</div>


</div>

  
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTQzNzQx">
  
      

<div>
  
<div id="pullrequestreview-338543741" data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTQzNzQx" data-channel="pull_request_review:338543741" data-url="/_render_node/MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTQzNzQx/pull_request_reviews/body">

  <div>
    
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


    


    


    </div>
    <div>
      
<div id="pullrequestreview-338543741-body-html">
  <div data-body-version="b086577f9d3f6970a1062acd6fefc532" data-unfurl-hide-url="/content_reference_attachments/hide">
    <div>
  <p>
    

















<details>
  <summary aria-haspopup="menu" role="button">
    <svg aria-label="Show options" viewBox="0 0 13 16" version="1.1" width="13" height="16" role="img"><path fill-rule="evenodd" d="M1.5 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm5 0a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM13 7.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path></svg>
  </summary>
  <details-menu role="menu">
        <clipboard-copy for="pullrequestreview-338543741-permalink" role="menuitem" tabindex="0">
    Copy link
  </clipboard-copy>

        

      
  </details-menu>
</details>

  </p>


  

    
    <p><span aria-label="This user is the owner of the iced repository.">
      Owner
    </span></p><h3>



    <strong>
      

  <a show_full_name="false" data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d">0xd4d</a>
  

    </strong>


    left a comment




    <span>
        
  <span>â€¢</span>

  <details>
    <summary aria-haspopup="menu" role="button">
      
    </summary>
    <details-menu src="/_render_node/MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTQzNzQx/comments/comment_edit_history_log" preload="" role="menu">
      <include-fragment aria-label="Loading"></include-fragment>
    </details-menu>
  </details>

    </span>
  </h3>
</div>


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Thanks for the PR! I left a few comments in the code.</p>
<p>The generated code looks good (except those that check IsGPR64() multiple times on the same register).</p>
<p>One problem is how are you going to solve referencing some label/data in a memory operand? Or RIP relative memory operands? You'd probably need to extend the memory operand with more info and keep that info with the instruction before encoding it.</p>
<p>Other future problems will be to decide which encoding to use (VEX vs EVEX) when it's ambiguous, eg. vmovaps(xmm1,xmm2) is that VEX or EVEX? Or inc reg, if it's 32-bit, the 1-byte opcode can be used but if it's 64-bit the longer instruction must be used.</p>
<p>BTW, you can add your copyright and MIT header to those new files without headers.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>

  </div>
</div>

  
        



</div>

</div>

  
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTgyNzA2">
  
      

<div>
  
<div id="pullrequestreview-338582706" data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTgyNzA2" data-channel="pull_request_review:338582706" data-url="/_render_node/MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTgyNzA2/pull_request_reviews/body">

  <div>
    
<p><a data-hovercard-type="user" data-hovercard-url="/users/Konctantin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/Konctantin"><img height="40" width="40" alt="@Konctantin" src="https://avatars0.githubusercontent.com/u/82728?s=88&amp;v=4"></a>

</p>


    


    


  </div>
</div>

  
        



</div>

</div>

  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTEwNzQyMQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTEwNzQyMQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTEwNzQyMQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571107421">
    <div>
      

  

<details data-body-version="29fc104b55d099f07dfb8a18f49419d3">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="29fc104b55d099f07dfb8a18f49419d3" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>The generated code looks good (except those that check IsGPR64() multiple times on the same register).</p>
</blockquote>
<p>Yeah, this is part of the known issues.</p>
<blockquote>
<p>One problem is how are you going to solve referencing some label/data in a memory operand? Or RIP relative memory operands? You'd probably need to extend the memory operand with more info and keep that info with the instruction before encoding it.</p>
</blockquote>
<p>Likely it will require to propagate that in MemoryOperand. I haven't done yet any digging into jumps and labels.</p>
<blockquote>
<p>Other future problems will be to decide which encoding to use (VEX vs EVEX) when it's ambiguous, eg. vmovdqa(xmm1,xmm2) is that VEX or EVEX? Or inc reg, if it's 32-bit, the 1-byte opcode can be used but if it's 64-bit the longer instruction must be used.</p>
</blockquote>
<p>Yep. I'm aware of these cases. For inc reg I have an idea how it will be solved. For VEX vs EVEX, what do you suggest? What would be the rationale to select the best encoding?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTExNDUzNw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTExNDUzNw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTExNDUzNw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571114537">
    <div>
      

  

<details data-body-version="0f6c155ec0145a30cafbe3a52a7da9b5">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="0f6c155ec0145a30cafbe3a52a7da9b5" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>For VEX vs EVEX, what do you suggest? What would be the rationale to select the best encoding?</p>
</blockquote>
<p>I just checked masm, it uses VEX encoding unless it has to be EVEX eg. when xmm16 is used or an opmask register is used it uses EVEX encoding.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTI4MDExNQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTI4MDExNQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTI4MDExNQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571280115">
    <div>
      

  

<details data-body-version="472e3e682fc9cd58140c907ae57e9101">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="472e3e682fc9cd58140c907ae57e9101" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Question about <code>ret</code>: When it has multiple version of it with a postfix size:</p>
<pre><code>Code.Retnw
Code.Retnd
Code.Retnq
</code></pre>
<p>Do we want to have a single method <code>ret</code> or do we want to expose <code>retnq</code>?<br>
In case of a single <code>ret</code> method, on what underlying opcode info is based the selection rule? (encoder bitness with <code>OpCodeFlags.ModeXX</code>?)</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTI4MzQxMA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTI4MzQxMA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTI4MzQxMA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571283410">
    <div>
      

  

<details data-body-version="b0d47d771f246162210cdb42530e4946">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="b0d47d771f246162210cdb42530e4946" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>It seems that <code>OperandSize</code> and <code>AddressSize</code> for some of them could make it, let me check</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0Q29tbWl0MzU5NDQ0NjM2OjdkNjE5OTRiYmUyNWQ1NjBmOGNiZjEwZTAxYzZmOGI4NjgyOGJkZTI=">
  
      <div>
  <div>
      <div>
        
        <div>
          

<div data-channel="repo:147866440:commit:7d61994bbe25d560f8cbf10e01c6f8b86828bde2" data-url="/0xd4d/iced/pull/60/commits/7d61994bbe25d560f8cbf10e01c6f8b86828bde2/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx">
          <img height="20" width="20" alt="@xoofx" src="https://avatars2.githubusercontent.com/u/715038?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
    <div>
      <pre>â€¦Add support for rm as reg.</pre>
    </div>
</div>


        </div>
      </div>
  </div>
</div>


</div>

  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTMxMjUwNg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTMxMjUwNg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTMxMjUwNg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571312506">
    <div>
      

  

<details data-body-version="7a9954d2929d5ba6595613571224f721">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="7a9954d2929d5ba6595613571224f721" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>The last commit is:</p>
<ul>
<li>adding support for immediate</li>
<li>choose reg encoding over rm encoding for register only operands</li>
<li>improve a few disambiguations (bitness with OperandSize/AddressSize or  based on rm register)... still not perfect, as the code is generating still some invalid case.</li>
</ul>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTE3OTUw">
  
      

<div>
  
<div id="pullrequestreview-338917950" data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTE3OTUw" data-channel="pull_request_review:338917950" data-url="/_render_node/MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTE3OTUw/pull_request_reviews/body">

  <div>
    
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


    


    


    </div>
    <div>
      
<div id="pullrequestreview-338917950-body-html">
  <div data-body-version="858bda3dbe914ca3e64845f8e5db7d7d" data-unfurl-hide-url="/content_reference_attachments/hide">
    <div>
  <p>
    

















<details>
  <summary aria-haspopup="menu" role="button">
    <svg aria-label="Show options" viewBox="0 0 13 16" version="1.1" width="13" height="16" role="img"><path fill-rule="evenodd" d="M1.5 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm5 0a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM13 7.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path></svg>
  </summary>
  <details-menu role="menu">
        <clipboard-copy for="pullrequestreview-338917950-permalink" role="menuitem" tabindex="0">
    Copy link
  </clipboard-copy>

        

      
  </details-menu>
</details>

  </p>


  

    
    <p><span aria-label="This user is the owner of the iced repository.">
      Owner
    </span></p><h3>



    <strong>
      

  <a show_full_name="false" data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d">0xd4d</a>
  

    </strong>


    left a comment




    <span>
    </span>
  </h3>
</div>


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Retnw/d/q and branches should just default to the current bitness. Using anything other than that is almost never useful. String instructions are similar, you can override the memory register with an address size prefix but there's almost no use for that, so the default address size should be used with them too. Eg. in 64-bit mode <code>rep stosb</code> is using 64-bit regs, and in 32-bit mode 32-bit regs.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>

  </div>
</div>

  
        



</div>

</div>

  
  


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTQ5MTM2Ng==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTQ5MTM2Ng==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTQ5MTM2Ng==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571491366">
    <div>
      

  

<details data-body-version="2971abd89a6b3ef8da654088ae8411f1">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="2971abd89a6b3ef8da654088ae8411f1" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Quick update: I have made some good progress on disambiguation/opcode resolution with registers/rm/bitness. Codegen looks ok for the current set of opcodes supported (a few opcode detection cases with RAX/AX/EAX registers that I need to fix though)</p>
<p>I will finish supporting the remaining LegacyOpCode (support other registers...etc.) before continuing on vex/evex...</p>
<p>I will work on label for branches and memop after that.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  


  
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTU3NzA3">
  
      

<div>
  
<div id="pullrequestreview-339557707" data-gid="MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTU3NzA3" data-channel="pull_request_review:339557707" data-url="/_render_node/MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTU3NzA3/pull_request_reviews/body">

  <div>
    
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


    


    


  </div>
</div>

  
        



</div>

</div>

  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTkyNjcxNw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTkyNjcxNw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTkyNjcxNw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571926717">
    <div>
      

  

<details data-body-version="7741e3171750514ade8da04f23cd3e14">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="7741e3171750514ade8da04f23cd3e14" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>How do you encode instructions having an <code>EvexOpKind.VK</code>, it is supposed to be a mask but I'm failing to see which <code>Instruction.Create</code> is supporting that?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTkyNzI5NQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTkyNzI5NQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTkyNzI5NQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571927295">
    <div>
      

  

<details data-body-version="ca98929630ad8fd07f8c4f835500e340">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="ca98929630ad8fd07f8c4f835500e340" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Same question for <code>VexOpKind.Is4X</code> ?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTkzNzA0Mg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTkzNzA0Mg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTkzNzA0Mg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571937042">
    <div>
      

  

<details data-body-version="10580148fd91afb5bf7d97a44f8c1123">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="10580148fd91afb5bf7d97a44f8c1123" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>See <code>EncoderTypes</code>, it has a couple of tables to map <code>VexOpKind</code> to <code>OpCodeOperandKind</code> which has some documentation. I'll move these and other things to text files one day but it's low priority.</p>
<ul>
<li><code>EvexOpKind.VK</code> = <code>k_reg</code> and it's a <code>K</code> reg encoded in the <code>modrm.reg</code> field. (the <code>reg</code> in <code>k_reg</code> is the <code>modrm.reg</code> field).</li>
<li><code>VexOpKind.Is4X</code> = <code>xmm_is4</code> and it's an xmm register encoded in 4 bits in an immediate.</li>
</ul>
<p>Eg. <code>VEX_Vblendvps_xmm_xmm_xmmm128_xmm</code>'s last op is <code>xmm_is4</code> and you can just use <code>Create(reg,reg,reg/mem,reg)</code> to create such an instruction.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk1MTc5MQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk1MTc5MQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTk1MTc5MQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571951791">
    <div>
      

  

<details data-body-version="f4741f6beaba4909f3fa4f7b69a5eac5">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="f4741f6beaba4909f3fa4f7b69a5eac5" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>EvexOpKind.VK = k_reg and it's a K reg encoded in the modrm.reg field. (the reg in k_reg is the modrm.reg field).</p>
</blockquote>
<p>I don't know what is a K reg? Is it a regular register or an ymm register or? Do you have an example usage?</p>
<blockquote>
<p>VexOpKind.Is4X = xmm_is4 and it's an xmm register encoded in 4 bits in an immediate.</p>
</blockquote>
<p>Great, so if I pass a xmm register, the Instruction.Create will figure out how to encode this right?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk1NzI1Nw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk1NzI1Nw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTk1NzI1Nw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571957257">
    <div>
      

  

<details data-body-version="9555062dc2ed75842629b87e632618e9">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="9555062dc2ed75842629b87e632618e9" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>K regs are the op mask registers K0-K7. If they're just used as normal operands, the Create() methods can create such an instruction.</p>
<p>If they're used as operand masks and not normal operands, then you must call Create() and then initialize <code>instruction.OpMask = xxx</code> afterwards. <code>(OpCodeInfo.Flags &amp; OpCodeFlags.OpMaskRegister) != 0</code> if it supports op mask registers <code>{k1}</code> to <code>{k7}</code>. <code>OpCodeFlags.ZeroingMasking</code> flag is set if zeroing masking is supported <code>{z}</code></p>
<p>Example in masm with op mask regs and zeroing masking: <code>vunpcklps xmm2{k5}{z},xmm6,dword bcst [rax+4]</code></p>
<p>As you can see they're not operands so I don't know how we can support them. Maybe create extra args?</p>
<p>The broadcast args can probably easily be supported by adding a new __dword_bcst/etc struct. You'd then set <code>instruction.IsBroadcast</code> to true if it's broadcasted memory.</p>
<p>There are also other EVEX decorators <code>{sae}</code>, <code>{rn-sae}</code>, <code>{rd-sae}</code>, <code>{ru-sae}</code>, <code>{rz-sae}</code>.</p>
<blockquote>
<p>Great, so if I pass a xmm register, the Instruction.Create will figure out how to encode this right?</p>
</blockquote>
<p>Yes. It will create an instruction, the encoder will then figure out how to encode it to bytes.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk2MDE4MA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk2MDE4MA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTk2MDE4MA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571960180">
    <div>
      

  

<details data-body-version="ca3445373b4bf6ad713fb3835b88af40">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="ca3445373b4bf6ad713fb3835b88af40" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>To support the extra EVEX decorators, maybe the methods return something that has methods to enable them, eg.</p>
<p><code>vunpcklps xmm2{k5}{z},xmm6,dword bcst [rax+4]</code> =&gt; <code>vunpcklps(xmm2,xmm6,__dword_bcst[rax+4]).k5().z()</code></p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk2MDY5MA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MTk2MDY5MA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MTk2MDY5MA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-571960690">
    <div>
      

  

<details data-body-version="29d3e59cd1e0922690613bd86aadcdf0">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="29d3e59cd1e0922690613bd86aadcdf0" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Eg. <code>k5()</code> would grab the latest instruction and set <code>instruction.OpMask = Register.K5</code></p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjAwMTkwOQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjAwMTkwOQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MjAwMTkwOQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-572001909">
    <div>
      

  

<details data-body-version="87346c54da7b05bfe3f99ca6ed2461f4">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="87346c54da7b05bfe3f99ca6ed2461f4" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Great, thanks for all the infos, that's really helpful, didn't know a clue about all these new EVEX instructions encoding frankly! <g-emoji alias="sweat_smile" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png">ðŸ˜…</g-emoji></p>
<blockquote>
<p><code>vunpcklps(xmm2,xmm6,__dword_bcst[rax+4]).k5().z()</code></p>
</blockquote>
<p>Actually, as we can attach anything to these registers (<code>ExtendedRegister</code>), we could easily come up with a syntax like:</p>
<pre><code>vunpcklps(xmm2.k5.z, xmm6, __dword.bcst[rax+4])
</code></pre>
<p>Same for <code>.bcst, </code> that can be something that modifies the operand state by setting a broadcast boolean.</p>
<p>What do you think?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjAwNTQ5NA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjAwNTQ5NA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MjAwNTQ5NA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-572005494">
    <div>
      

  

<details data-body-version="7b6d6decc873912e5f408f33b663d14b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="7b6d6decc873912e5f408f33b663d14b" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Han nevermind, it seems that the encoding is a global thing for the whole instruction, so yeah, it will require a different syntax</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjAwNjE0NQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjAwNjE0NQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MjAwNjE0NQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-572006145">
    <div>
      

  

<details data-body-version="da3af09dc76261ad1130d5faab4df1f1">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="da3af09dc76261ad1130d5faab4df1f1" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>In that case that could be a first parameter:</p>
<pre><code>vunpcklps(k5.z, xmm2, xmm6, __dword.bcst[rax+4])
</code></pre>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjA2Mjk2Ng==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3MjA2Mjk2Ng==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3MjA2Mjk2Ng==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-572062966">
    <div>
      

  

<details data-body-version="ac5738be75029e19b48c47e6f4ca432f">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="ac5738be75029e19b48c47e6f4ca432f" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Attaching that state to the first operand (register or memory) is better and looks more like what you'd write in assembler. The property syntax you use (<code>xmm2.k5.z</code>) looks good, no useless parens.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>



  

    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2MzI4Ng==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2MzI4Ng==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU2MzI4Ng==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576563286">
    <div>
      

  

<details data-body-version="77a4f299a40f9bc07c6d9f70f85f4b97">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="77a4f299a40f9bc07c6d9f70f85f4b97" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>So for example in <code>sbb_reg16_i</code></p>
<pre><code>TestAssembler(c =&gt; c.sbb(bx, (short)sbyte.MinValue), Instruction.Create(Code.Sbb_rm16_imm8, bx, (short)sbyte.MinValue));
</code></pre>
<p>The comparison between the decoded instruction and encoded is now failing. While their printf version is the same:</p>
<pre><code>Expected: sbb bx,0FF80h (66 83 db 80 )
Actual Decoded: sbb bx,0FF80h
</code></pre>
<p>Debugging and I can see that the immediate of the encoded is -128, while the immediate of the decoding one is 128... what do you think is going wrong here?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2NDczMw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2NDczMw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU2NDczMw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576564733">
    <div>
      

  

<details data-body-version="3b2c9703ee91160085a1d9329934f324">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="3b2c9703ee91160085a1d9329934f324" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Could you show the fields of both instructions in the debugger?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2NTExNg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2NTExNg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU2NTExNg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576565116">
    <div>
      

  

<details data-body-version="475823936f6cf483b6c4abfc655c3962">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="475823936f6cf483b6c4abfc655c3962" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Encoded:</p>
<pre><code>codeFlags = {uint} 256
immediate = {uint} 4294967168
memBaseReg = {byte} 0
memDispl = {uint} 0
memIndexReg = {byte} 0
memoryFlags = {ushort} 0
nextRip = {ulong} 1
opKindFlags = {uint} 352
reg0 = {byte} 24
reg1 = {byte} 0
reg2 = {byte} 0
reg3 = {byte} 0
</code></pre>
<p>Decoded:</p>
<pre><code>codeFlags = {uint} 2097408
immediate = {uint} 128
memBaseReg = {byte} 0
memDispl = {uint} 0
memIndexReg = {byte} 0
memoryFlags = {ushort} 0
nextRip = {ulong} 4
opKindFlags = {uint} 3221225824
reg0 = {byte} 24
reg1 = {byte} 0
reg2 = {byte} 0
reg3 = {byte} 0
</code></pre>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2NjMwMA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2NjMwMA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU2NjMwMA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576566300">
    <div>
      

  

<details data-body-version="9ad905b60fd81b36c6f4264e052e40ed">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="9ad905b60fd81b36c6f4264e052e40ed" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>It looks like the decoder is no longer sign-extending.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2ODYwNw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU2ODYwNw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU2ODYwNw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576568607">
    <div>
      

  

<details data-body-version="249d5e3beb18b448ffd8955de113e29a">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="249d5e3beb18b448ffd8955de113e29a" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>There's a difference between the decoder and Create() methods. Some bits are ignored, and the Create() methods sign extend but it's not needed really and the decoder doesn't sign extend. Both is correct ,but when comparing bits it fails. I'll push a commit to rust soon.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU3MTg2Ng==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU3MTg2Ng==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU3MTg2Ng==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576571866">
    <div>
      

  

<details data-body-version="d326e499b51eadc6ecb8bb85495e98dc">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="d326e499b51eadc6ecb8bb85495e98dc" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>I've pushed a new commit, that should hopefully make them consistent again.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0Q29tbWl0MzU5NDQ0NjM2OmY4YTQ0YTdjZDNiMTFiYzJjN2JjYjY5NDNkMDNlNWVjZjdjMjhkYjY=">
  
      <div>
  <div>
      <div>
        
        <div>
          

<div data-channel="repo:147866440:commit:f8a44a7cd3b11bc2c7bcb6943d03e5ecf7c28db6" data-url="/0xd4d/iced/pull/60/commits/f8a44a7cd3b11bc2c7bcb6943d03e5ecf7c28db6/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx">
          <img height="20" width="20" alt="@xoofx" src="https://avatars2.githubusercontent.com/u/715038?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
</div>


        </div>
      </div>
  </div>
</div>


</div>

    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU3NDc5MA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU3NDc5MA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU3NDc5MA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576574790">
    <div>
      

  

<details data-body-version="b942a107e29f4120beacf6f73bfa4de3">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="b942a107e29f4120beacf6f73bfa4de3" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Cool, it is fixing the issue.</p>
<p>Now back to the ArgumentOutOfRangeException:</p>
<p>I have now many cases failing (which should better fail indeed, which is good) like <code>add_m_i</code></p>
<pre><code>} /* else */ { /* if (dst.Size == MemoryOperandSize.BytePtr) */
	TestAssembler(c =&gt; c.add(__byte_ptr[rdx], (int)(sbyte.MinValue - 1)), Instruction.Create(Code.Add_rm8_imm8, __byte_ptr[rdx].ToMemoryOperand(Bitness), (int)(sbyte.MinValue - 1)));
}
</code></pre>
<p>This is the case in the tests where we tests the different branches. Now of course this will not work for <code>Add_rm8_imm8</code> is imm8 is out of range. Should I skip this one when value are exceeding? (gonna be tricky because I don't have currently a context that says that the range might be not valid)...</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU3NjMwOQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NjU3NjMwOQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NjU3NjMwOQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576576309">
    <div>
      

  

<details data-body-version="c536a24ae03afb8cedc93b4d9ef694ca">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="c536a24ae03afb8cedc93b4d9ef694ca" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Yes, -129 isn't a valid byte/sbyte arg so they can be skipped since there's no other opcode with a bigger imm that can be used instead.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg3NjY3Mg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg3NjY3Mg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3Njg3NjY3Mg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576876672">
    <div>
      

  

<details data-body-version="51aef0c8fd578fa31ac52844452ef9bd">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="51aef0c8fd578fa31ac52844452ef9bd" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Just to confirm to handle the unsigned case, I'm gonna have to do something like that right?</p>
<div><pre>public void add(AssemblerMemoryOperand dst, uint imm) {
    Code op;
    if ((int)imm &gt;= sbyte.MinValue &amp;&amp; (int)imm &lt;= sbyte.MaxValue) {
        if (dst.Size == MemoryOperandSize.DwordPtr) {
            op = Code.Add_rm32_imm8;
        } else if (dst.Size == MemoryOperandSize.WordPtr) {
<span><span>+</span>           imm = (ushort)imm;</span>
            op = Code.Add_rm16_imm8;
        } else if (dst.Size == MemoryOperandSize.BytePtr) {
<span><span>+</span>           imm = (byte)imm;</span>
            op = Code.Add_rm8_imm8;
        } else {
            throw NoOpCodeFoundFor(Mnemonic.Add, dst, imm);
        }
    } else if (dst.Size == MemoryOperandSize.DwordPtr) {
        op = Code.Add_rm32_imm32;
    } else if (dst.Size == MemoryOperandSize.WordPtr) {
<span><span>+</span>       imm = (ushort)imm;</span>
        op = Code.Add_rm16_imm16;
    } else if (dst.Size == MemoryOperandSize.BytePtr) {
<span><span>+</span>       imm = (byte)imm;</span>
        op = Code.Add_rm8_imm8;
    } else {
        throw NoOpCodeFoundFor(Mnemonic.Add, dst, imm);
    }
    AddInstruction(Instruction.Create(op, dst.ToMemoryOperand(Bitness), imm));
}</pre></div>
<p>It's going to be a bit more involving to support this, as I don't have anything in the codegen that handles recasting based on the final instruction. (Same for the tests)</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg3ODkzNQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg3ODkzNQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3Njg3ODkzNQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576878935">
    <div>
      

  

<details data-body-version="d195ab47a69a6f99e5e822be750595bd">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="d195ab47a69a6f99e5e822be750595bd" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>I don't think the handler above needs to mask it, it's the users responsibility to pass in valid immediates.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg4MDAwNA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg4MDAwNA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3Njg4MDAwNA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576880004">
    <div>
      

  

<details data-body-version="443213396998be9a9e0a0e2ca92bbf3b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="443213396998be9a9e0a0e2ca92bbf3b" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>I don't think the handler above needs to mask it, it's the users responsibility to pass in valid immediates.</p>
</blockquote>
<p>Ok. I will have to handle this only in the tests then.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg5NDA5NQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg5NDA5NQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3Njg5NDA5NQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576894095">
    <div>
      

  

<details data-body-version="e8756c77d891f119c12a30dedb5a0fba">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="e8756c77d891f119c12a30dedb5a0fba" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Actually the unsigned tests aren't that important, I can add a to do to add it later.</p>
<p>Same thing about eg. cmppd/etc + byte arg, it's not important.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg5NDYyMg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3Njg5NDYyMg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3Njg5NDYyMg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-576894622">
    <div>
      

  

<details data-body-version="8b7d28c38858af87840f2402d57c42f4">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="8b7d28c38858af87840f2402d57c42f4" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Let me know if you want me to merge this!</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAyOTA4Ng==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAyOTA4Ng==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzAyOTA4Ng==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577029086">
    <div>
      

  

<details data-body-version="19e5b6a5ff5b89b2e8b30bd0fe65fca4">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="19e5b6a5ff5b89b2e8b30bd0fe65fca4" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>Actually the unsigned tests aren't that important, I can add a to do to add it later.</p>
</blockquote>
<p>I would like to try to finish this unsigned part <g-emoji alias="slightly_smiling_face" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png">ðŸ™‚</g-emoji> , I fear that there are issues on unsigned that are uncovered.</p>
<p>So for example, trying to get <code>add(m, u)</code> working, but I'm failing to see what to do with the condition:</p>
<p>For <code>uint</code>, I wanted to use <code>(byte)imm == imm</code>, but then it doesn't work with what the code is expecting behind in <code>Instruction.InitializeUnsignedImmediate</code>, for example for the case <code>Add_rm16_imm8</code> it seems to perform <code>if (!(immediate &lt;= (ulong)sbyte.MaxValue || (0xFF80 &lt;= immediate &amp;&amp; immediate &lt;= 0xFFFF)))</code>, but then how can we go in the range of sbyte.MinValue/sbyte.MaxValue if the underlying instruction create starts to look above 8 bits?</p>
<p>I really don't understand why the test is so complicated in <code>InitializeUnsignedImmediate</code> instead of just checking if imm is actually a real byte.</p>
<div><pre>		public void add(AssemblerMemoryOperand dst, uint imm) {
			Code op;
<span><span>+</span>			if ((byte)imm == imm) {</span>
				if (dst.Size == MemoryOperandSize.DwordPtr) {
					op = Code.Add_rm32_imm8;
				} else if (dst.Size == MemoryOperandSize.WordPtr) {
					op = Code.Add_rm16_imm8;
				} else if (dst.Size == MemoryOperandSize.BytePtr) {
					op = Code.Add_rm8_imm8;
				} else {
					throw NoOpCodeFoundFor(Mnemonic.Add, dst, imm);
				}
			} else if (dst.Size == MemoryOperandSize.DwordPtr) {
				op = Code.Add_rm32_imm32;
			} else if (dst.Size == MemoryOperandSize.WordPtr) {
				op = Code.Add_rm16_imm16;
			} else if (dst.Size == MemoryOperandSize.BytePtr) {
				op = Code.Add_rm8_imm8;
			} else {
				throw NoOpCodeFoundFor(Mnemonic.Add, dst, imm);
			}
			AddInstruction(Instruction.Create(op, dst.ToMemoryOperand(Bitness), imm));
		}</pre></div>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAzNzY5Nw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAzNzY5Nw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzAzNzY5Nw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577037697">
    <div>
      

  

<details data-body-version="3c8a75f27ef92e695e160322da99f36c">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="3c8a75f27ef92e695e160322da99f36c" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p><code>(byte)imm == imm</code> won't work if we pass in <code>0xFF80</code> and the immediate is sign extended from 8 bits to 16 bits, eg. it's <code>Add_rm16_imm8</code>.</p>
<p>Assume the user wants to use <code>Add_rm16_imm8</code>, then he/she would do:</p>
<div><pre><span>add</span>(<span>__word_ptr</span>[<span>m</span>],<span>-</span><span>128</span>);
<span>add</span>(<span>__word_ptr</span>[<span>m</span>],<span>0xFF80U</span>); <span><span>//</span> same as above but unsigned</span>
<span>add</span>(<span>__word_ptr</span>[<span>m</span>],<span>0xFFFFFF80U</span>); <span><span>//</span> too big value, throws</span></pre></div>
<p>The range for the short 8-bit imm version is -128..127, which is <code>FF80-FFFF &amp; 0000-007F</code> since it must also be a 16-bit value.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAzODU0Mw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAzODU0Mw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzAzODU0Mw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577038543">
    <div>
      

  

<details data-body-version="a908c920bca7533ba299d432410fd6d3">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="a908c920bca7533ba299d432410fd6d3" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>But then what would be the test instead of <code>if ((byte)imm == imm) {</code>  so that you could access <code>Add_rm16_imm8</code> or <code>Add_rm8_imm8</code> ?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAzOTU5Mg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzAzOTU5Mg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzAzOTU5Mg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577039592">
    <div>
      

  

<details data-body-version="0e0ac01cc46479a3fc0ff9bf78cb5e2d">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="0e0ac01cc46479a3fc0ff9bf78cb5e2d" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Yes it will get complicated in that case, so I assume it will require some refactoring since every line needs its own range check. It's not super important to support <code>uint</code>, and this can be fixed later if someone needs it.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA0MjAyNw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA0MjAyNw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzA0MjAyNw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577042027">
    <div>
      

  

<details data-body-version="cce3adaa9e76bc820a96474a34995446">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="cce3adaa9e76bc820a96474a34995446" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Right, so for uint, we can't use the same selector logic than int, we would have to write something like that right?</p>
<div><pre><span>public</span> <span>void</span> <span>add</span>(<span>AssemblerMemoryOperand</span> <span>dst</span>, <span>uint</span> <span>imm</span>) {
    <span>Code</span> <span>op</span>;
    <span>if</span> (<span>dst</span>.<span>Size</span> <span>==</span> <span>MemoryOperandSize</span>.<span>DwordPtr</span>) {
        <span>op</span> <span>=</span> <span>imm</span> <span>&lt;=</span> (<span>uint</span>)<span>sbyte</span>.<span>MaxValue</span> <span>||</span> (<span>0xFFFF_FF80</span> <span>&lt;=</span> <span>imm</span> <span>&amp;&amp;</span> <span>imm</span> <span>&lt;=</span> <span>0xFFFF_FFFF</span>) <span>?</span> <span>Code</span>.<span>Add_rm32_imm8</span> <span>:</span> <span>Code</span>.<span>Add_rm32_imm32</span>; 
    } <span>else</span> <span>if</span> (<span>dst</span>.<span>Size</span> <span>==</span> <span>MemoryOperandSize</span>.<span>WordPtr</span>) {
        <span>op</span> <span>=</span> <span>imm</span> <span>&lt;=</span> (<span>uint</span>)<span>sbyte</span>.<span>MaxValue</span> <span>||</span> (<span>0xFF80</span> <span>&lt;=</span> <span>imm</span> <span>&amp;&amp;</span> <span>imm</span> <span>&lt;=</span> <span>0xFFFF</span>) <span>?</span> <span>Code</span>.<span>Add_rm16_imm8</span> <span>:</span> <span>Code</span>.<span>Add_rm16_imm16</span>; 
    } <span>else</span> <span>if</span> (<span>dst</span>.<span>Size</span> <span>==</span> <span>MemoryOperandSize</span>.<span>BytePtr</span>) {
        <span>op</span> <span>=</span> <span>Code</span>.<span>Add_rm8_imm8</span>; 
    } <span>else</span> {
        <span>throw</span> <span>NoOpCodeFoundFor</span>(<span>Mnemonic</span>.<span>Add</span>, <span>dst</span>, <span>imm</span>);
    }
    <span>AddInstruction</span>(<span>Instruction</span>.<span>Create</span>(<span>op</span>, <span>dst</span>.<span>ToMemoryOperand</span>(<span>Bitness</span>), <span>imm</span>));
}</pre></div>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA0MzM0MQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA0MzM0MQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzA0MzM0MQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577043341">
    <div>
      

  

<details data-body-version="503312271599e221521f4fef42e372ef">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="503312271599e221521f4fef42e372ef" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Maybe I should use this same skeleton for <code>int</code>, but change the condition instead of early disambiguate with the immediate sbyte?</p>
<div><pre><span>public</span> <span>void</span> <span>add</span>(<span>AssemblerMemoryOperand</span> <span>dst</span>, <span>int</span> <span>imm</span>) {
    <span>Code</span> <span>op</span>;
    <span>if</span> (<span>dst</span>.<span>Size</span> <span>==</span> <span>MemoryOperandSize</span>.<span>DwordPtr</span>) {
        <span>op</span> <span>=</span> <span>imm</span> <span>&gt;=</span> <span>sbyte</span>.<span>MinValue</span> <span>&amp;&amp;</span> <span>imm</span> <span>&lt;=</span> <span>sbyte</span>.<span>MaxValue</span> <span>?</span> <span>Code</span>.<span>Add_rm32_imm8</span> <span>:</span> <span>Code</span>.<span>Add_rm32_imm32</span>; 
    } <span>else</span> <span>if</span> (<span>dst</span>.<span>Size</span> <span>==</span> <span>MemoryOperandSize</span>.<span>WordPtr</span>) {
        <span>op</span> <span>=</span> <span>imm</span> <span>&gt;=</span> <span>sbyte</span>.<span>MinValue</span> <span>&amp;&amp;</span> <span>imm</span> <span>&lt;=</span> <span>sbyte</span>.<span>MaxValue</span>  <span>?</span> <span>Code</span>.<span>Add_rm16_imm8</span> <span>:</span> <span>Code</span>.<span>Add_rm16_imm16</span>; 
    } <span>else</span> <span>if</span> (<span>dst</span>.<span>Size</span> <span>==</span> <span>MemoryOperandSize</span>.<span>BytePtr</span>) {
        <span>op</span> <span>=</span> <span>Code</span>.<span>Add_rm8_imm8</span>; 
    } <span>else</span> {
        <span>throw</span> <span>NoOpCodeFoundFor</span>(<span>Mnemonic</span>.<span>Add</span>, <span>dst</span>, <span>imm</span>);
    }
    <span>AddInstruction</span>(<span>Instruction</span>.<span>Create</span>(<span>op</span>, <span>dst</span>.<span>ToMemoryOperand</span>(<span>Bitness</span>), <span>imm</span>));
}</pre></div>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA1MzAzMw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA1MzAzMw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzA1MzAzMw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577053033">
    <div>
      

  

<details data-body-version="447aa80f51f4d390abee2bdabb8bf84e">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="447aa80f51f4d390abee2bdabb8bf84e" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>So I'm changing the selection model for immediate and it looks like the code will be much easier to handle.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA1NjMzOQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzA1NjMzOQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzA1NjMzOQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577056339">
    <div>
      

  

<details data-body-version="c662279ba57a7a525e05b8233001ff9a">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="c662279ba57a7a525e05b8233001ff9a" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>Right, so for uint, we can't use the same selector logic than int, we would have to write something like that right?</p>
</blockquote>
<p>Yes, that looks correct.</p>
<blockquote>
<p>So I'm changing the selection model for immediate and it looks like the code will be much easier to handle.</p>
</blockquote>
<p><g-emoji alias="+1" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png">ðŸ‘</g-emoji></p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDE3OlB1bGxSZXF1ZXN0Q29tbWl0MzU5NDQ0NjM2OmU3MWJlZjBjOGIzY2VhZTY1OTQ1Yzg2NDk5Y2QwNmY5ZDU5YTAyYTk=">
  
      <div>
  <div>
      <div>
        
        <div>
          

<div data-channel="repo:147866440:commit:e71bef0c8b3ceae65945c86499cd06f9d59a02a9" data-url="/0xd4d/iced/pull/60/commits/e71bef0c8b3ceae65945c86499cd06f9d59a02a9/_render_node/commit/pull_condensed">
  <div>
      
<div>
  <p><a data-skip-pjax="true" data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx">
          <img height="20" width="20" alt="@xoofx" src="https://avatars2.githubusercontent.com/u/715038?s=60&amp;v=4">
</a>  </p>
</div>


    

    

    

    
  </div>
</div>


        </div>
      </div>
  </div>
</div>


</div>

    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzMyMTAyOA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzMyMTAyOA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzMyMTAyOA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577321028">
    <div>
      

  

<details data-body-version="0df31a8d7ca5854c599b564dccfde822">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="0df31a8d7ca5854c599b564dccfde822" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>I just pushed the fix for support for uint with a merge with latest rust. It seems to be good. Let me know if there are any other issues, otherwise it is good to be merged! <g-emoji alias="crossed_fingers" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f91e.png">ðŸ¤ž</g-emoji></p>
<p>The little annoyance I went through is that some methods are supporting ushort, but the Instruction.Create API is providing uint, but when passing an ushort, it will select the int version instead which was very confusing. So I had to bend a bit the codegen (both the Assembler.g.cs and the tests) to add a few (uint) cast to make it pass through the correct method.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzMzMjQyNQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzMzMjQyNQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzMzMjQyNQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/0xd4d/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/0xd4d"><img height="40" width="40" alt="@0xd4d" src="https://avatars1.githubusercontent.com/u/1060731?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577332425">
    <div>
      

  

<details data-body-version="d302ed33d358f60f92ce8693dea485eb">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="d302ed33d358f60f92ce8693dea485eb" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>I just pushed the fix for support for uint with a merge with latest rust. It seems to be good. Let me know if there are any other issues, otherwise it is good to be merged! <g-emoji alias="crossed_fingers" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f91e.png">ðŸ¤ž</g-emoji></p>
</blockquote>
<p>Thanks! <g-emoji alias="+1" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png">ðŸ‘</g-emoji><g-emoji alias="+1" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png">ðŸ‘</g-emoji><g-emoji alias="+1" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png">ðŸ‘</g-emoji> This is a really good PR and I appreciate all the hard work you did!</p>
<p>I'll release 1.5.0 after I've merged it into master, maybe later this week.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzM0NTY1NQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDU3NzM0NTY1NQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDU3NzM0NTY1NQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/xoofx/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/xoofx"><img height="40" width="40" alt="@xoofx" src="https://avatars3.githubusercontent.com/u/715038?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-577345655">
    <div>
      

  

<details data-body-version="8a31d84b32e8775babe56262af67ca50">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="8a31d84b32e8775babe56262af67ca50" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>So happy about this, I will be heavily using it, glad that you have accepted the PR and thank you for your patience! <g-emoji alias="slightly_smiling_face" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f642.png">ðŸ™‚</g-emoji></p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


    
  





<!-- Rendered timeline since 2020-01-25 01:56:12 -->



      </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>