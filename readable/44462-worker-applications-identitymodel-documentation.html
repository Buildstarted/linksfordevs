<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Worker Applications &#x2014; IdentityModel documentation -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Worker Applications â€” IdentityModel  documentation</h1><div><div class="section" id="worker-applications"><p>Workers use the client credentials grant type to request tokens from an OAuth 2.0 compatible token service.</p><p>You register the token service, client ID and secret in <code class="docutils literal notranslate"><span class="pre">ConfigureServices</span></code>, e.g.:</p><div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span><span class="n">host</span><span class="p">=</span><span class="n">Host</span><span class="p">.</span><span class="n">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="p">.</span><span class="n">ConfigureServices</span><span class="p">((</span><span class="n">hostContext</span><span class="p">,</span><span class="n">services</span><span class="p">)</span><span class="p">=&gt;</span><span class="p">{</span><span class="n">services</span><span class="p">.</span><span class="n">AddAccessTokenManagement</span><span class="p">(</span><span class="n">options</span><span class="p">=&gt;</span><span class="p">{</span><span class="n">options</span><span class="p">.</span><span class="n">Client</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"identityserver"</span><span class="p">,</span><span class="k">new</span><span class="n">ClientCredentialsTokenRequest</span><span class="p">{</span><span class="n">Address</span><span class="p">=</span><span class="s">"https://demo.identityserver.io/connect/token"</span><span class="p">,</span><span class="n">ClientId</span><span class="p">=</span><span class="s">"m2m.short"</span><span class="p">,</span><span class="n">ClientSecret</span><span class="p">=</span><span class="s">"secret"</span><span class="p">,</span><span class="n">Scope</span><span class="p">=</span><span class="s">"api"</span><span class="c1">// optional</span><span class="p">});</span><span class="p">});</span><span class="p">});</span></pre></div></div><p>You can register multiple clients for one or more token services if you like. Just make sure you give every client a unique name.</p><p>You can also customize the HTTP client that is used for requesting the tokens by calling the <code class="docutils literal notranslate"><span class="pre">ConfigureBackchannelHttpClient</span></code> extension method, e.g.:</p><div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">services</span><span class="p">.</span><span class="n">AddAccessTokenManagement</span><span class="p">()</span><span class="p">.</span><span class="n">ConfigureBackchannelHttpClient</span><span class="p">()</span><span class="p">.</span><span class="n">AddTransientHttpErrorPolicy</span><span class="p">(</span><span class="n">policy</span><span class="p">=&gt;</span><span class="n">policy</span><span class="p">.</span><span class="n">WaitAndRetryAsync</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span><span class="p">{</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">),</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="p">}));</span></pre></div></div><p>The above code wires up the <code class="docutils literal notranslate"><span class="pre">AccessTokenManagementService</span></code> and the <code class="docutils literal notranslate"><span class="pre">ClientAccessTokenCache</span></code> in the DI system.
The service is the main entry point, and features a method called <code class="docutils literal notranslate"><span class="pre">GetClientAccessTokenAsync</span></code>
(which you can also access via the HTTP context using <code class="docutils literal notranslate"><span class="pre">HttpContext.GetClientAccessTokenAsync</span></code>).
This method checks if a token for the client is cached, and if not requests one and caches it. The cache implementation can be replaced.</p><p>One piece of plumbing that automatically uses the token management service is the <code class="docutils literal notranslate"><span class="pre">ClientAccessTokenHandler</span></code>, which is a delegating handler
to plug-in to <code class="docutils literal notranslate"><span class="pre">HttpClient</span></code>.</p><p>The easiest way to register an HTTP client that uses the token management is by calling <code class="docutils literal notranslate"><span class="pre">AddClientAccessTokenClient</span></code>:</p><div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">services</span><span class="p">.</span><span class="n">AddClientAccessTokenClient</span><span class="p">(</span><span class="s">"client"</span><span class="p">,</span><span class="n">configureClient</span><span class="p">:</span><span class="n">client</span><span class="p">=&gt;</span><span class="p">{</span><span class="n">client</span><span class="p">.</span><span class="n">BaseAddress</span><span class="p">=</span><span class="k">new</span><span class="n">Uri</span><span class="p">(</span><span class="s">"https://demo.identityserver.io/api/"</span><span class="p">);</span><span class="p">});</span></pre></div></div><p>You can pass in the name of your HTTP client, the name of the token service configuration (you can omit this if you only have one token client)
and additional customization.
This returns the typical builder for the HTTP client factory to add aditional handlers.</p><p>It is also possible to add the handler to any HTTP client registration using the <code class="docutils literal notranslate"><span class="pre">AddClientAccessTokenHandler</span></code> extension method
(which optionally also takes a token client name), e.g. a typed client:</p><div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">&lt;</span><span class="n">MyClient</span><span class="p">&gt;(</span><span class="n">client</span><span class="p">=&gt;</span><span class="p">{</span><span class="n">client</span><span class="p">.</span><span class="n">BaseAddress</span><span class="p">=</span><span class="k">new</span><span class="n">Uri</span><span class="p">(</span><span class="s">"https://demo.identityserver.io/api/"</span><span class="p">);</span><span class="p">})</span><span class="p">.</span><span class="n">AddClientAccessTokenHandler</span><span class="p">();</span></pre></div></div><div class="section" id="usage"><p>You can use use one of the various ways to obtain an HTTP client with the handler set up, e.g. using the HTTP client factory:</p><div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span><span class="nf">Worker</span><span class="p">(</span><span class="n">IHttpClientFactory</span><span class="n">factory</span><span class="p">)</span><span class="p">{</span><span class="n">_client</span><span class="p">=</span><span class="n">factory</span><span class="p">.</span><span class="n">CreateClient</span><span class="p">(</span><span class="s">"client"</span><span class="p">);</span><span class="p">}</span></pre></div></div><p>..and then use that client to make API calls - all token management will be done under the covers:</p><div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span><span class="k">override</span><span class="k">async</span><span class="n">Task</span><span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">CancellationToken</span><span class="n">stoppingToken</span><span class="p">)</span><span class="p">{</span><span class="k">while</span><span class="p">(!</span><span class="n">stoppingToken</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span><span class="p">{</span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"\n\n"</span><span class="p">);</span><span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">"Worker running at: {time}"</span><span class="p">,</span><span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span><span class="kt">var</span><span class="n">response</span><span class="p">=</span><span class="k">await</span><span class="n">_client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">"test"</span><span class="p">);</span><span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">"API response: {response}"</span><span class="p">,</span><span class="n">response</span><span class="p">);</span><span class="k">await</span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">5000</span><span class="p">,</span><span class="n">stoppingToken</span><span class="p">);</span><span class="p">}</span><span class="p">}</span></pre></div></div><img alt="../_images/Worker.gif" src="../_images/Worker.gif"><p>Full sample can be found in the <a class="reference external" href="https://github.com/IdentityModel/IdentityModel.AspNetCore">samples</a>.</p></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>