<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Creating a custom feature filter: Adding feature flags to an ASP.NET Core app - Part 4 -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Creating a custom feature filter: Adding feature flags to an ASP.NET Core app - Part 4</h1>
    <div class="post-content">
<p><a href="https://www.nuget.org/packages/Microsoft.FeatureManagement/1.0.0-preview-008560001-910"><em>Microsoft.FeatureManagement</em></a> allows you to add feature flags to an ASP.NET Core app that are controlled by the configuration system. In the <a href="/creating-dynamic-feature-flags-with-feature-filters-adding-feature-flags-to-an-asp-net-core-app-part-3/">previous post</a> I introduced feature filters, and showed how they can be used to create dynamic feature flags. I described two feature filters that are built-in to the library, the <code>TimeWindowFilter</code> and <code>PercentageFilter</code>. </p>
<p>In this post I show how you can create your own custom feature filter. The example in this post looks for a Claim in the <a href="/introduction-to-authentication-with-asp-net-core/">currently logged-in user&apos;s ClaimsPrincipal</a> and enables a feature flag if it&apos;s present. You could use this filter to enable a feature for a subset of your users.</p>
<blockquote>
<p><em>Microsoft.FeatureManagement</em> was introduced in a <a href="https://www.youtube.com/watch?v=cmd0Vh6pFfE">recent .NET Community Standup</a> and is currently in preview, so some details may change when it&apos;s properly released.</p>
</blockquote> <p>This post assumes that you&apos;re already familiar with feature filters, and the <em>Microsoft.FeatureManagement</em> in general, so if they&apos;re new to you, I suggest reading <a href="/series/adding-feature-flags-to-an-asp-net-core-app/">the previous posts in this series</a>.</p>
<p>Creating a custom feature filter requires two things:</p>
<ul>
<li>Create a class that derives from <code>IFeatureFilter</code>.</li>
<li>Optionally create a settings class to control your feature filter.</li>
</ul>
<p>I&apos;ll start with the settings class, as we&apos;ll use that inside our custom feature filter. </p> <p>For this example, we want to enable a feature for only those users that have a certain set of claims. For simplicity, I&apos;m only going to require the presence of a claim <em>type</em> and ignore the claim&apos;s value, but extending the example in this post should be simple enough. The settings object contains an array of claim types:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClaimsFilterSettings</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> RequiredClaims <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>There&apos;s nothing special about this settings class; it will be bound to your app&apos;s configuration, so you&apos;re only restricted by the limitations of the standard ASP.NET Core/<em>Microsoft.Extensions</em> configuration binder. </p> <p>To create a feature filter, you must implement the <code>IFeatureFilter</code> interface, which consists of a single method:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFeatureFilter</span>
<span class="token punctuation">{</span> <span class="token keyword">bool</span> <span class="token function">Evaluate</span><span class="token punctuation">(</span><span class="token class-name">FeatureFilterEvaluationContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>FeatureFilterEvaluationContext</code> argument passed in to the method contains the name of the feature requested, and an <code>IConfiguration</code> object that allows you to access the settings for the feature:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeatureFilterEvaluationContext</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">string</span> FeatureName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IConfiguration</span> Parameters <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It&apos;s worth noting that there&apos;s nothing specific to ASP.NET Core here - there&apos;s no <code>HttpContext</code>, and no <code>IServiceProvider</code>. Luckily, your class is pulled from the DI container, so you should be able to get everything you need in your feature filter&apos;s constructor.</p> <p>In order to implement our custom feature filter, we need to know who the current user is for the request. To do so, we need to access the <code>HttpContext</code>. The correct way to do that (when you don&apos;t have direct access to it as you do in MVC controllers etc) is to use the <code>IHttpContextAccessor</code>. </p>
<p>The <code>ClaimsFeatureFilter</code> below takes an <code>IHttpContextAccessor</code> in its constructor and uses the exposed <code>HttpContext</code> to retrieve the current user from the request. </p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">FilterAlias</span><span class="token punctuation">(</span><span class="token string">&quot;Claims&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClaimsFeatureFilter</span> <span class="token punctuation">:</span> <span class="token class-name">IFeatureFilter</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IHttpContextAccessor</span> _httpContextAccessor<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">ClaimsFeatureFilter</span><span class="token punctuation">(</span><span class="token class-name">IHttpContextAccessor</span> httpContextAccessor<span class="token punctuation">)</span> <span class="token punctuation">{</span> _httpContextAccessor <span class="token operator">=</span> httpContextAccessor<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Evaluate</span><span class="token punctuation">(</span><span class="token class-name">FeatureFilterEvaluationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> settings <span class="token operator">=</span> context<span class="token punctuation">.</span>Parameters<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Get</span><span class="token punctuation">&lt;</span><span class="token class-name">ClaimsFilterSettings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> user <span class="token operator">=</span> _httpContextAccessor<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>User<span class="token punctuation">;</span> <span class="token keyword">var</span> isEnabled <span class="token operator">=</span> settings<span class="token punctuation">.</span>RequiredClaims <span class="token punctuation">.</span><span class="token function">All</span><span class="token punctuation">(</span>claimType <span class="token operator">=</span><span class="token operator">&gt;</span> user<span class="token punctuation">.</span><span class="token function">HasClaim</span><span class="token punctuation">(</span>claim <span class="token operator">=</span><span class="token operator">&gt;</span> claim<span class="token punctuation">.</span>Type <span class="token operator">==</span> claimType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> isEnabled<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I named this feature filter &quot;Claims&quot; using the <code>[FilterAlias]</code> attribute. This is the string you need to add in configuration to enable the filter, as you&apos;ll see shortly. You can retrieve the <code>ClaimsFilterSettings</code> associated with a given instance of the custom feature filter by calling <code>context.Parameters.Get&lt;&gt;()</code>. </p>
<p>The logic of the filter is relatively straightforward - if the <code>ClaimsPrincipal</code> for the request has all of the required claims, the associated feature is enabled, otherwise the feature is disabled.</p> <p>To use the custom feature filter, you must explicitly register it with the feature management system in <code>Startup.ConfigureServices()</code>. We also need to make sure the <code>IHttpContextAccessor</code> is available in DI:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>FeatureManagement<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddHttpContextAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token function">AddFeatureManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddFeatureFilter</span><span class="token punctuation">&lt;</span><span class="token class-name">ClaimsFeatureFilter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>Depending on which framework and third-party services you&apos;ve already added to your app, <code>IHttpContextAccessor</code> may already be available. It&apos;s safe to call <code>AddHttpContextAccessor()</code> multiple times though, so worth including just in case.</p>
</blockquote>
<p>That&apos;s all the custom configuration needed to enable our <code>ClaimsFeatureFilter</code>. To actually use it in an app, we&apos;ll add a feature flag called &quot;Beta&quot;:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FeatureFlags</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">string</span> Beta <span class="token operator">=</span> <span class="token string">&quot;Beta&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>and enable the filter in configuration using the format <a href="/creating-dynamic-feature-flags-with-feature-filters-adding-feature-flags-to-an-asp-net-core-app-part-3/">described in the previous post</a>:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">&quot;FeatureManagement&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;Beta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;EnabledFor&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token property">&quot;Name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Claims&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;Parameters&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;RequiredClaims&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;Internal&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<p>Notice that I&apos;ve used the <code>[FilterAlias]</code> value of &quot;Claims&quot; as the filter&apos;s <code>Name</code>. The <code>Parameters</code> object corresponds to <a href="#creating-the-filter-settings-class">the <code>ClaimsFilterSettings</code> settings object</a>. With this configuration, user&apos;s who have the <code>&quot;Internal&quot;</code> claim will have the <code>Beta</code> feature flag enabled - other user&apos;s will find it&apos;s disabled.</p> <p>To test out the feature filter, it&apos;s easiest to start with an ASP.NET Core app that has individual authentication enabled. For demonstration purposes, I updated the home page <em>Index.cshtml</em> to show a banner when the <code>Beta</code> feature flag is enabled <a href="/filtering-action-methods-with-feature-flags-adding-feature-flags-to-an-asp-net-core-app-part-2/#hiding-links-in-views-for-disabled-features">using the FeatureTagHelper</a>:</p>
<pre class="language-xml"><code class="language-xml">@page
@model IndexModel
@{ ViewData[&quot;Title&quot;] = &quot;Home page&quot;;
} <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feature</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>@FeatureFlags.Beta<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>alert alert-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>alert<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> Congratulations - You&apos;re in the Beta test! <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>feature</span><span class="token punctuation">&gt;</span></span>


</code></pre>
<p>Run the database migrations for the application using</p>
<pre class="language-bash"><code class="language-bash">dotnet ef database update
</code></pre>
<p>and then run your app and register a new user. You should see the standard home page: </p>
<p><img src="/content/images/2019/featureflag_pre_beta.png" alt="The default home page when the feature flag is disabled"></p>
<p>The &quot;Beta&quot; banner is hidden because by default. Our <code>ClaimsFeatureFilter</code> checked the user&apos;s claims for the required <code>&quot;Internal&quot;</code> claim, which is absent by default, and so returned <code>false</code> for <code>IsEnabled()</code>. To enable the feature we need to add an extra claim to the user. </p>
<blockquote>
<p>There are a number of ways to add claims to users - either <a href="https://korzh.com/blogs/net-tricks/aspnet-identity-store-user-data-in-claims">when the user is created</a>, at a later time, or <a href="https://joonasw.net/view/adding-custom-claims-aspnet-core-2">when they sign in</a>. I&apos;m taking the easy route here and just manually adding the claim in the database.</p>
</blockquote>
<p>With ASP.NET Core Identity, arbitrary additional Claims can be added to a user. These are stored in the <em>AspNetUserClaims</em> table (by default). I used VisualStudio server explorer to add a new row in this table associated with my user, using the claim type <code>&quot;Internal&quot;</code></p>
<p><img src="/content/images/2019/featureflag_add_claim.png" alt="Adding the Internal claim to the user"></p>
<p>If you log out and then sign back in (to ensure the new claim is picked up) the &quot;Beta&quot; banner is now visible - the custom feature filter works!</p>
<p><img src="/content/images/2019/featureflag_in_beta_home_page.png" alt="The default home page when the feature flag is enabled"></p> <p>The custom feature filter <code>ClaimsFeatureFilter</code> described in this post is only intended as an example of a filter you could use. The reliance on <code>HttpContext</code> gives it a specific limitation: it can&apos;t be used outside the context of an HTTP request. </p>
<p>Attempting to access <code>HttpContext</code> outside of an HTTP request can result in a <code>NullReferenceException</code>. You also need to be careful about using it in a background thread, <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-context?view=aspnetcore-2.2#httpcontext-access-from-a-background-thread">as <code>HttpContext</code> is not thread safe</a>. </p>
<p>One of the slightly dangerous implications of this is that <em>consumers</em> of the feature flags don&apos;t necessarily know which features are safe to interrogate in which context. There&apos;s nothing in the following code that suggests it could throw when used on a background thread, or <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services">in a hosted service</a>. </p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> isEnabled <span class="token operator">=</span> _featureManager<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span>FeatureFlags<span class="token punctuation">.</span>Beta<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre>
<p>One basic option to avoid this situation is to use naming conventions for your feature flags. For example, you could use a convention where feature flags prefixed with <code>&quot;UI_&quot;</code> are only considered &quot;safe&quot; to access when withan an HTTP request context.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FeatureFlags</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">string</span> NewBranding <span class="token operator">=</span> <span class="token string">&quot;NewBranding&quot;</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">string</span> AlternativeColours <span class="token operator">=</span> <span class="token string">&quot;AlternativeColours&quot;</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Ui</span> <span class="token punctuation">{</span> <span class="token keyword">const</span> <span class="token keyword">string</span> _prefix <span class="token operator">=</span> <span class="token string">&quot;UI_&quot;</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">string</span> Beta <span class="token operator">=</span> _prefix <span class="token operator">+</span> <span class="token string">&quot;Beta&quot;</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">string</span> NewOnboardingExperiences <span class="token operator">=</span> _prefix <span class="token operator">+</span> <span class="token string">&quot;NewOnboardingExperiences&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This at least gives an indication to the caller when the flag is used. Obviously it requires you configure the flags correctly, but it&apos;s a step in the right direction!</p>
<pre class="language-csharp"><code class="language-csharp">
<span class="token keyword">var</span> isEnabled <span class="token operator">=</span> _featureManager<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span>FeatureFlags<span class="token punctuation">.</span>NewBranding<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> isEnabled <span class="token operator">=</span> _featureManager<span class="token punctuation">.</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span>FeatureFlags<span class="token punctuation">.</span>Ui<span class="token punctuation">.</span>Beta<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <p><em>Microsoft.FeatureManagement</em> allows using feature filters to add dynamic behaviour to your feature flags. In this post I showed how to implement your own custom <code>IFeatureFilter</code> which uses claims of the current user to decide whether a flag should be enabled. This feature filter works well in the context of a request, but it&apos;s important to be aware of the implications of using <code>HttpContext</code> as regards to using feature flags in background threads and outside of an HTTP context.</p>
</div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>