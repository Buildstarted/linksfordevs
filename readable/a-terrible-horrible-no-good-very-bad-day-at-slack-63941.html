<!DOCTYPE html>
<html lang="en">
<head>
    <title>
A Terrible, Horrible, No-Good, Very Bad Day at Slack - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="A Terrible, Horrible, No-Good, Very Bad Day at Slack - linksfor.dev(s)"/>
    <meta property="article:author" content="https://slack.engineering/@lnolan_54766"/>
    <meta property="og:description" content="On May 12, 2020, Slack had our first significant outage in a long time. This is a detailed look into the technical issues that caused it."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://slack.engineering/a-terrible-horrible-no-good-very-bad-day-at-slack-dfe05b485f82?gi=f9cab416681b"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - A Terrible, Horrible, No-Good, Very Bad Day at Slack</title>
<div class="readable">
        <h1>A Terrible, Horrible, No-Good, Very Bad Day at Slack</h1>
            <div>by https://slack.engineering/@lnolan_54766</div>
            <div>Reading time: 8-11 minutes</div>
        <div>Posted here: 07 Jul 2020</div>
        <p><a href="https://slack.engineering/a-terrible-horrible-no-good-very-bad-day-at-slack-dfe05b485f82?gi=f9cab416681b">https://slack.engineering/a-terrible-horrible-no-good-very-bad-day-at-slack-dfe05b485f82?gi=f9cab416681b</a></p>
        <hr/>
<div id="readability-page-1" class="page"><section><div><div><div><div><div><div><p><a href="https://slack.engineering/@lnolan_54766?source=post_page-----dfe05b485f82----------------------" rel="noopener"><img alt="Laura Nolan" src="https://miro.medium.com/fit/c/96/96/1*pADZfurie_QWpTM7OXiMcw.jpeg" width="48" height="48"></a></p></div></div></div></div><figure><div><div><div><div><p><img alt="A stack of stones balanced atop each other in ocean spray." src="https://miro.medium.com/max/60/1*IpaWqnHCZNFfaOrTJOUSbQ.jpeg?q=20" width="1920" height="1485"></p><p><img alt="A stack of stones balanced atop each other in ocean spray." width="1920" height="1485" srcset="https://miro.medium.com/max/552/1*IpaWqnHCZNFfaOrTJOUSbQ.jpeg 276w, https://miro.medium.com/max/1104/1*IpaWqnHCZNFfaOrTJOUSbQ.jpeg 552w, https://miro.medium.com/max/1280/1*IpaWqnHCZNFfaOrTJOUSbQ.jpeg 640w, https://miro.medium.com/max/1400/1*IpaWqnHCZNFfaOrTJOUSbQ.jpeg 700w" sizes="700px" src="https://miro.medium.com/max/1920/1*IpaWqnHCZNFfaOrTJOUSbQ.jpeg"></p></div></div></div></div></figure><blockquote><p id="63cc" data-selectable-paragraph="">This story describes the technical details of the problems that caused the Slack downtime on May 12th, 2020. To learn more about the process behind incident response for same outage, read Ryan Katkov’s post, “<a href="https://medium.com/@solidspark/91d6986c3ee" target="_blank" rel="noopener">All Hands on Deck</a>”.</p></blockquote><p id="1341" data-selectable-paragraph="">On May 12, 2020, Slack had our first significant outage in a long time. We <a href="https://status.slack.com/2020-05-12" target="_blank" rel="noopener">published a summary of the incident</a> shortly after, but this story is an interesting one, and we’d like to go into more detail on the technical issues around it.</p><p id="8243" data-selectable-paragraph="">The user-visible outage began at 4:45pm Pacific time, but the story really begins around 8:30am that morning. Our Database Reliability Engineering team was alerted for a significant load increase in part of our database infrastructure at the same time as our Traffic team received alerts that we were failing some API requests. The increased load on the database was due to a rollout of a configuration change, which triggered a longstanding performance bug. The change was quickly pinpointed and rolled back — it was a feature flag which performed a percentage-based rollout, so this was a fast process. We had some customer impact, but it lasted only for three minutes and most users were still able to send messages successfully throughout this brief morning incident.</p><p id="ba26" data-selectable-paragraph="">One of the incident’s effects was a significant scale-up of our main webapp tier. Our CEO Stewart Butterfield has written about some of the <a href="https://twitter.com/stewart/status/1243000509666955264" target="_blank" rel="noopener">impact </a>of the lockdown and stay-at-home orders on Slack usage. As a result of the pandemic, we’ve been running significantly higher numbers of instances in the webapp tier than we were in the long-ago days of February 2020. We autoscale quickly when workers become saturated, as happened here — but workers were waiting much longer for some database requests to complete, leading to higher utilization. We increased our instance count by 75% during the incident, ending with the highest number of webapp hosts that we’ve ever run to date.</p><p id="0eb9" data-selectable-paragraph="">Everything seemed fine for the next eight hours — until we were alerted that we were serving more <a href="https://http.cat/503" target="_blank" rel="noopener">HTTP 503</a> errors than normal. We spun up a new incident response channel and the on-call engineer for the webapp tier manually scaled up the webapp fleet as an initial mitigation. Unusually, this didn’t help at all. We very quickly noticed that a subset of the webapp fleet was under heavy load while the rest of the webapp instances were not. Multiple strands of investigations began, looking into both webapp performance and our loadbalancer tier. A few minutes later, we identified the problem.</p><p id="2966" data-selectable-paragraph="">We use a fleet of HAProxy instances behind a layer 4 load-balancer to distribute requests to the webapp tier. We use Consul for service discovery, and <a href="https://github.com/hashicorp/consul-template" target="_blank" rel="noopener">consul-template</a> to render lists of healthy webapp backends that HAProxy should route requests to.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*_Es6td9rCI1xnOkDaCgR0g.png?q=20" width="861" height="391" role="presentation"></p><p><img width="861" height="391" srcset="https://miro.medium.com/max/552/1*_Es6td9rCI1xnOkDaCgR0g.png 276w, https://miro.medium.com/max/1104/1*_Es6td9rCI1xnOkDaCgR0g.png 552w, https://miro.medium.com/max/1280/1*_Es6td9rCI1xnOkDaCgR0g.png 640w, https://miro.medium.com/max/1400/1*_Es6td9rCI1xnOkDaCgR0g.png 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph=""><strong>Figure 1: High-level view of Slack’s ingress load-balancing architecture</strong></figcaption></figure><p id="e4ba" data-selectable-paragraph="">We don’t render our webapp host list directly into our HAProxy configuration file, however. The reason for this is that updating the host list via the configuration file requires reloading HAProxy. The process of reloading HAProxy involves creating a brand-new HAProxy process while keeping the old one around until it’s finished dealing with in-flight requests. Very frequent reloads could lead to too many running HAProxy processes and poor performance. This constraint is in tension with the goal of autoscaling the webapp tier, which is to get new instances into service as quickly as possible. Therefore, we use <a href="https://www.haproxy.com/blog/dynamic-configuration-haproxy-runtime-api/" target="_blank" rel="noopener">HAProxy’s Runtime API</a> to manipulate the HAProxy server state without doing a reload each time a web tier backend comes into or goes out of service. It’s worth noting that HAProxy can <a href="https://learn.hashicorp.com/consul/integrations/haproxy-consul" target="_blank" rel="noopener">integrate</a> with Consul’s DNS interface, but this adds lag due to the DNS TTL, it limits the ability to use Consul tags, and managing very large DNS responses often seems to lead to hitting painful edge-cases and bugs.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*6zoR4pYG7EKiC_x90ygWAQ.png?q=20" width="512" height="399" role="presentation"></p><p><img width="512" height="399" srcset="https://miro.medium.com/max/552/1*6zoR4pYG7EKiC_x90ygWAQ.png 276w, https://miro.medium.com/max/1024/1*6zoR4pYG7EKiC_x90ygWAQ.png 512w" sizes="512px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph=""><strong>Figure 2: How the set of webapp backends is managed on a single Slack HAProxy server</strong></figcaption></figure><p id="85e5" data-selectable-paragraph="">We define HAProxy <a href="https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#4-server-template" target="_blank" rel="noopener">server templates</a> in our HAProxy state that are effectively ‘slots’ which our webapp backends can occupy. When a new webapp instance is provisioned, or an old one becomes unhealthy, the Consul service catalog is updated. Consul-template renders a new version of the host list, and a separate program developed at Slack, haproxy-server-state-management, reads that host list and uses the HAProxy Runtime API to update the HAProxy state.</p><p id="4247" data-selectable-paragraph="">We run M parallel pools of HAProxy instances and webapp instances, each pool in its own AWS Availability Zone. HAProxy is configured with N ‘slots’ for webapp backends in each AZ, giving a total of N * M backends that can be routed to across all the AZs. A few months ago, this total was more than ample headroom — we’d never needed to run anything even approaching that number of instances of our webapp tier. However, after the morning’s database incident, we were running slightly more than N * M instances of the webapp. If you think of the HAProxy slots as a giant game of musical chairs, a few of these webapp instances were left without a seat. That wasn’t a problem — we had more than enough serving capacity.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*sM4ndSLcHyFi7syPWyv36A.png?q=20" width="800" height="600" role="presentation"></p><p><img width="800" height="600" srcset="https://miro.medium.com/max/552/1*sM4ndSLcHyFi7syPWyv36A.png 276w, https://miro.medium.com/max/1104/1*sM4ndSLcHyFi7syPWyv36A.png 552w, https://miro.medium.com/max/1280/1*sM4ndSLcHyFi7syPWyv36A.png 640w, https://miro.medium.com/max/1400/1*sM4ndSLcHyFi7syPWyv36A.png 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph=""><strong>Figure 3: ‘Slots’ in the HAProxy process, with some excess webapp instances that aren’t receiving traffic</strong></figcaption></figure><p id="bcd9" data-selectable-paragraph="">However, over the course of the day, a problem developed. The program which synced the host list generated by consul template with the HAProxy server state had a bug. It always attempted to find a slot for new webapp instances before it freed slots taken up by old webapp instances that were no longer running. This program began to fail and exit early because it was unable to find any empty slots, meaning that the running HAProxy instances weren’t getting their state updated. As the day passed and the webapp autoscaling group scaled up and down, the list of backends in the HAProxy state became more and more stale.</p><p id="d484" data-selectable-paragraph="">By 4:45pm Pacific, most HAProxy instances were only able to send requests to the set of webapp backends that had been up since the morning, and this set of older webapp backends was now a minority of the fleet. We do regularly provision new HAProxy instances, so there would have been a few fresh HAProxy instances that had correct configuration, but most of them were more than eight hours old and therefore were stuck with full and stale backend state. The outage was eventually triggered at the end of the business day in the US because that’s when we begin to scale down the webapp tier as traffic drops. Autoscaling will preferentially terminate older instances, so this meant that there were no longer enough older webapp instances remaining in the HAProxy server state to serve demand.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*wlnhHV5BZ72tQ6a3pQRoWg.png?q=20" width="800" height="600" role="presentation"></p><p><img width="800" height="600" srcset="https://miro.medium.com/max/552/1*wlnhHV5BZ72tQ6a3pQRoWg.png 276w, https://miro.medium.com/max/1104/1*wlnhHV5BZ72tQ6a3pQRoWg.png 552w, https://miro.medium.com/max/1280/1*wlnhHV5BZ72tQ6a3pQRoWg.png 640w, https://miro.medium.com/max/1400/1*wlnhHV5BZ72tQ6a3pQRoWg.png 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph=""><strong>Figure 4: HAProxy state has grown stale over time and references mainly deprovisioned hosts</strong></figcaption></figure><p id="c669" data-selectable-paragraph="">Once we knew the cause of the failure, it was resolved quickly with a rolling restart of the HAProxy fleet. After the incident was mitigated, the first question we asked ourselves was why our monitoring didn’t catch this problem. We had alerting in place for this precise situation, but unfortunately, it wasn’t working as intended.<mark> The broken monitoring hadn’t been noticed partly because this system ‘just worked’ for a long time, and didn’t require any change.</mark> The wider HAProxy deployment that this is part of is also relatively static. With a low rate of change, fewer engineers were interacting with the monitoring and alerting infrastructure.</p><p id="d289" data-selectable-paragraph="">The reason that we haven’t been doing any significant work on this HAProxy stack is that we’re moving towards <a href="https://www.envoyproxy.io/" target="_blank" rel="noopener">Envoy Proxy</a> for all of our ingress load-balancing (we’ve recently moved our websockets traffic onto Envoy). While HAProxy has served us well and reliably for many years, it also has some operational sharp edges, of exactly the kind highlighted by this incident. The complex pipeline we use to manipulate HAProxy server state will be replaced by Envoy’s native integration with an xDS control plane for endpoint discovery. The most recent versions of HAProxy (since the 2.0 release) also solve many of these operational pain points. However, Envoy has been our proxy of choice for our internal service mesh project for some time, and this makes a move to Envoy for our ingress load-balancing attractive. Our initial testing of Envoy + xDS at scale is very exciting and this migration should improve both performance and availability going forward. Our new load-balancing and service discovery architecture is not susceptible to the problem that caused this outage.</p><p id="7486" data-selectable-paragraph="">We strive to keep Slack available and reliable, and in this case, we failed. We know that Slack is a critical tool for our users, and that is why we aim to learn as much as we can from every incident, whether customer visible or not. We apologize for the inconvenience this outage caused and will continue to use the lessons learned to drive improvements in both our systems and our processes.</p></div></div></section></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>