<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Getting Started with CQRS &#x2013; Part 3 - Simple Talk - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Getting Started with CQRS &#x2013; Part 3 - Simple Talk - linksfor.dev(s)"/>
    <meta property="article:author" content="Diogo Souza"/>
    <meta property="og:description" content="Diogo Souza completes his series on CQRS. He demonstrates Event Sourcing to capture the data as it flows through the system which can then be analyzed without affecting the source."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.red-gate.com/simple-talk/dotnet/c-programming/getting-started-with-cqrs-part-3/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Getting Started with CQRS &#x2013; Part 3 - Simple Talk</title>
<div class="readable">
        <h1>Getting Started with CQRS &#x2013; Part 3 - Simple Talk</h1>
            <div>by Diogo Souza</div>
            <div>Reading time: 56-71 minutes</div>
        <div>Posted here: 02 Apr 2020</div>
        <p><a href="https://www.red-gate.com/simple-talk/dotnet/c-programming/getting-started-with-cqrs-part-3/">https://www.red-gate.com/simple-talk/dotnet/c-programming/getting-started-with-cqrs-part-3/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><p>Diogo Souza completes his series on CQRS. He demonstrates Event Sourcing to capture the data as it flows through the system which can then be analyzed without affecting the source. </p><div>
				<p><strong>The series so far:</strong></p>
<ol>
<li><a href="https://www.red-gate.com/simple-talk/dotnet/c-programming/getting-started-with-cqrs-part-1/">Getting Started with CQRS – Part 1</a></li>
<li><a href="https://www.red-gate.com/simple-talk/dotnet/c-programming/getting-started-with-cqrs-part-2/">Getting Started with CQRS – Part 2</a></li>
<li><a href="https://www.red-gate.com/simple-talk/dotnet/c-programming/getting-started-with-cqrs-part-3/">Getting Started with CQRS – Part 3</a></li>
</ol>

<p>Until now, this series played a bit with a ‘fake’ CQRS implementation built on top of a simple architecture in ASP.NET. It used SQLite and Mongo to store the data at the end of the tiers. <a href="https://martinfowler.com/bliki/CQRS.html">It’s been well-known</a> through the community that this pattern, unlike many others, must be carefully analyzed before putting into your systems, especially if your systems are big and have been functioning for a long time.</p>
<p>If you’re a novice developer, or you don’t have much help from experienced .NET engineers, I wouldn’t recommend adding CQRS to your domain. There are tons of things to consider in order to scale up your applications, rather than going for the first design pattern that’ll save the nation. You can (and certainly must) check the performance gaps, refactor the bottlenecks, and safely implement concurrency in places where it would be welcome.</p>
<p>If you feel adventurous (and still want to play safe), you can go for <a href="https://eventstore.com/">Event Store</a> or <a href="https://axoniq.io/">Axon</a>.</p>
<p>Instead of thinking about the cons of wanting to adopt CQRS, consider <a href="https://martinfowler.com/eaaDev/EventSourcing.html"><strong>Event Sourcing</strong></a>, or ES. Those are the magic words. After all, why not save as much historical data of your system’s events as possible?</p>
<p>Just think about it. If your system</p>
<ul>
<li>deals with actions other than ordinary CRUD operations,</li>
<li>or it needs to reconstitute the information from and to some point in history,</li>
<li>or it needs to be audited or analyzed (i.e., machine learning, BI),</li>
<li>or it is perfectly described by the events happening on it.</li>
</ul>
<p>Well, then you probably have the need for an ES solution.</p>
<p>The irony here is that, for the sake of simplicity, the example will continue to use the Customers CRUD application, but this time adapted to the use of CQRS along with ES. But don’t worry, I’ll keep it simple and straightforward, so then you can follow up when applying to your systems.</p>
<p>Before you jump into it, understand a bit about ES and some patterns that accompany it next.</p>
<h2>What is Event Sourcing?</h2>
<p>When you think about reality, how things work, and how they happen, you can see a chronological sequence of steps and events going on. The act of an event ending is called a <em>commit</em>.</p>
<p>The same thing happens with systems. When an API receives a request and stores it to a database, an event (or, usually, a series of events) happens there. Whether it is synchronous or not, they’re taking place in the servers while transporting data around. What if you store these events, like snapshots of how they are exactly when they happen? That’s when ES comes into play.</p>
<p>Then, you can take advantage of distributed systems, cloud and microservices to send those same events over a powerful message broker, store them in robust NoSQL databases, digest and transform them with flexible tools, all of that easily integrated, error-prone and monitored.</p>
<p>Now, put all those events together in a stream, like a river, and let it flow. Alongside the stream, you can plug in subscribers, watchers, or readers that’ll consume the data and do whatever they want with it, without affecting the original data. The data is read-only. Do you want to get the last record? Sort your stream and get the top record. Sounds good, doesn’t it?</p>
<h2>Aggregating things</h2>
<p>The <a href="https://www.martinfowler.com/bliki/DDD_Aggregate.html">Aggregate pattern</a> is known for walking hand in hand with the ES. Once you’re dealing with a stream, i.e., a list of items or records, it’s often easier for the domain to consider a specific list of them as a single and cohesive unit — an aggregate.</p>
<p>In other words, to be considered an aggregate a list of objects must be consistent together, they must be related at some point that makes sense to your domain. A good way to think of it is a transaction. If your objects usually commit together within a transaction, they are probably a good fit for an aggregate.</p>
<p>The example project will make use of the pattern below. Then, you’ll get to see how both patterns conversate with each other.</p>
<p>Figure 1 shows how the final project will look.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/04/word-image.png" data-lazy-load=""></p>
<p>Figure 1. Final project architecture</p>
<p>Here, some new actors arrived at the house. The structure of commands and queries will practically remain the same, with some adjustments. A new layer to handle the commands is necessary to process each one and trigger the correspondent domain aggregations.</p>
<p>The aggregations, in turn, take care of summarizing the data to the repository interface, the one which stores the events in an <strong>Event Store</strong>. To create the event store, you’ll use an in-memory <em>Dictionary</em>, just to keep things simple. However, you’re free to change any of the tools for the ones of your preference.</p>
<p>An <strong>Event Bus</strong> layer supplies the features needed to send the events asynchronously from one side to the others. Both <em>Repository</em> and <em>Event Bus</em> layers are going to be reused for reading and writing models since they just define the interface methods for such.</p>
<p>The <strong>Event Handlers</strong> are a couple of classes that deal with the same RabbitMQ messages created in the previous articles and then save the customers to the Mongo database. However, this time it will be with everything asynchronous.</p>
<p>Mongo is going to be the database to supply data for the read model. Mainly because it’s robust and performant, but also because the NoSQL adapts better to the query side, as already demonstrated. You can choose it to be your Event Store database as well.</p>
<p>To help even more with the amount of code needed for this implementation, a part of it is going to take advantage of the <a href="https://github.com/gautema/CQRSlite">CQRSLite framework</a>, an extended version of a framework proposed and created by <a href="https://github.com/gregoryyoung/m-r">Greg Young</a>. It is a lightweight framework to help when creating CQRS and event sourcing applications in C# and provides the classes and features colored in red in Figure 1. Don’t worry; by the end of the article, you’ll understand how it works integrated with the application.</p>
<h2>Setup adjustments</h2>
<p>For this part of the tutorial, I’ll change things a bit. First, the example doesn’t use SQLite anymore. As you may have noticed, Mongo is the only database tool used for storing data.</p>
<p>RabbitMQ, MongoDB, Compass, and Postman are used as developing and testing tools as before.</p>
<p>Before proceeding, download the <a href="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/03/CustomerApi.zip">source code</a> to your local machine, and copy the <em>/CQRSLite</em> folder to the root of your current CustomerApi project.</p>
<p><em>Note: The reason you’re copying from my project is that the original GitHub project is updated continuously, and so are the package names. If you still want to go with the GitHub version, be aware of these naming changes.</em></p>
<p>The example also makes use of some new packages from NuGet:</p>
<ul>
<li><a href="https://www.nuget.org/packages/NLog/">NLog</a>: it’ll be interesting to have some logs spread around</li>
<li><a href="https://www.nuget.org/packages/System.Runtime.Caching/">System.Runtime.Caching</a>: this one is useful for in-memory caching</li>
<li><a href="https://github.com/dotnet/wcf">System.ServiceModel.Primitives</a> and <a href="https://www.nuget.org/packages/System.Private.ServiceModel/">System.Private.ServiceModel</a>: these provide the common types used by all of the WCF libraries</li>
<li><a href="https://www.nuget.org/packages/Castle.Windsor.MsDependencyInjection/">Castle.Windsor.MsDependencyInjection</a> and <a href="https://www.nuget.org/packages/Castle.Facilities.AspNetCore/">Castle.Facilities.AspNetCore</a>: the <a href="http://www.castleproject.org/">Castle Project</a> facilitates the configuration of dependencies and avoids circular dependencies problems since everything is going to work together within the same project.</li>
</ul>
<p>Go ahead and install them all via <em>NuGet Package Manager</em>.</p>
<p>Don’t forget to install the packages used in the previous two articles:</p>
<ul>
<li>RabbitMQ.Client</li>
<li>mongocsharpdriver</li>
</ul>
<p>The current project structure will change almost completely. It can be seen in Figure 2. The only remaining folder is the <em>/Controllers</em> which hosts the <em>CustomersController.cs</em> the same way, with a few changes to be made.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/04/word-image-1.png" data-lazy-load=""></p>
<p>Figure 2. New project structure.</p>
<p>Please, update your project with the same folders accordingly. The new division is made of:</p>
<ul>
<li><em>Commons</em>: it’ll store common interfaces for the bus components, and repositories, as well as constants, exceptions, etc.</li>
<li><em>CQRSLite</em>: the framework you’ve imported previously</li>
<li><em>ReadModels</em>: it’ll contain the services to provide reading features for the queries</li>
<li><em>WriteModels</em>: the domain, commands, events, event store for the command side.</li>
<li><em>Services</em>: contains the services, in this case, just <em>CustomerService</em>.</li>
</ul>
<h2>The Write Models</h2>
<p>Begin by working on the lengthiest side. The folder <em>/WriteModels</em> will have five others inside of it: <em>/Commands</em>, <em>/Domain</em>, <em>/Events</em>, <em>/EventStore</em> and <em>/VOs</em>. Go ahead and create them.</p>
<p>Create a new class called <em>Command</em> (or move the old one to here), along with its three basic implementations: <em>CreateCustomerCommand</em>, <em>UpdateCustomerCommand</em> and <em>DeleteCustomerCommand</em>. You can check their respective codes in Listing 1 below.</p>
<p>Listing 1. Command classes.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e85800752894224366797" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p></div>
				</td>
						<td><div><p><span>// class Command</span></p><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Commands</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>Serialization</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataContract</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>KnownType</span><span>(</span><span>typeof</span><span>(</span><span>CreateCustomerCommand</span><span>)</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>KnownType</span><span>(</span><span>typeof</span><span>(</span><span>UpdateCustomerCommand</span><span>)</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>KnownType</span><span>(</span><span>typeof</span><span>(</span><span>DeleteCustomerCommand</span><span>)</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>abstract</span><span> </span><span>class</span><span> </span><span>Command</span><span> </span><span>:</span><span> </span><span>ICommand</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Guid</span><span> </span><span>Id</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>int</span><span> </span><span>ExpectedVersion</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p><p><span>// class CreateCustomerCommand</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>VOs</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>Serialization</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataContract</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CreateCustomerCommand</span><span> </span><span>:</span><span> </span><span>Command</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>string</span><span> </span><span>Name</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>string</span><span> </span><span>Email</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>int</span><span> </span><span>Age</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>Phones</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p><p><span>// class UpdateCustomerCommand</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>VOs</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>Serialization</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span></p><p><span>{</span></p><p><span>	</span><span>[</span><span>DataContract</span><span>]</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>UpdateCustomerCommand</span><span> </span><span>:</span><span> </span><span>Command</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>string</span><span> </span><span>Name</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>Age</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>Phones</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p><p><span>// class DeleteCustomerCommand</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>Serialization</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span></p><p><span>{</span></p><p><span>	</span><span>[</span><span>DataContract</span><span>]</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>DeleteCustomerCommand</span><span> </span><span>:</span><span> </span><span>Command</span></p><p><span>	</span><span>{</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<p>Note that their constitution is not that different from what’s been created before, except for getting simpler. The id is now a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.guid?view=netframework-4.8">Guid</a> (A globally unique identifier represented by a hash string), which facilitates the usage with Mongo. The conversion methods (to events and entities) are removed and, now, left with the attributes only.</p>
<p>They are annotated with data contracts from the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.serialization?view=netframework-4.8">System Serialization</a> package to help with the serialization and deserialization through the API.</p>
<p>You’ll see that the VOs’ class is missing. For that, under the <em>/VOs</em> folder, create a new class called <code>Phone</code> and add the following code:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e8580075289e600520364" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>Commons</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>Serialization</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>VOs</span></p><p><span>{</span></p><p><span>	</span><span>[</span><span>DataContract</span><span>]</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>Phone</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>PhoneType</span><span> </span><span>Type</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>AreaCode</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>DataMember</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>Number</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>Next, create a new folder <em>/Handlers</em> inside of the <em>/Commands</em> folder, and add the class <code>CustomerCommandHandler</code> represented in Listing 2.</p>
<p>Listing 2. CustomerCommandHandler class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528a2513219842" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Commands</span><span>;</span></p><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Domain</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Domain</span><span>.</span><span>Aggregates</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>VOs</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Linq</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span><span>.</span><span>Handlers</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerCommandHandler</span><span> </span><span>:</span><span> </span><span>ICommandHandler</span><span>&lt;</span><span>CreateCustomerCommand</span><span>&gt;</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ICommandHandler</span><span>&lt;</span><span>UpdateCustomerCommand</span><span>&gt;</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ICommandHandler</span><span>&lt;</span><span>DeleteCustomerCommand</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>ISession </span><span>_session</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>NLog</span><span>.</span><span>Logger </span><span>logger</span><span> </span><span>=</span><span> </span><span>NLog</span><span>.</span><span>LogManager</span><span>.</span><span>GetLogger</span><span>(</span><span>"CustomerCommandHandlers"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerCommandHandler</span><span>(</span><span>ISession </span><span>session</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_session</span><span> </span><span>=</span><span> </span><span>session</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Handle</span><span>(</span><span>CreateCustomerCommand </span><span>command</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>item</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>CustomerAggregate</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Id</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Email</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Name</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Age</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Phones</span><span>.</span><span>Select</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>new</span><span> </span><span>Phone</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Type</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Type</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AreaCode</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>AreaCode</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Number</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Number</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>ExpectedVersion</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_session</span><span>.</span><span>Add</span><span>(</span><span>item</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_session</span><span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>T</span><span> </span><span>Get</span><span>&lt;</span><span>T</span><span>&gt;</span><span>(</span><span>Guid </span><span>id</span><span>,</span><span> </span><span>int</span><span>?</span><span> </span><span>expectedVersion</span><span> </span><span>=</span><span> </span><span>null</span><span>)</span><span> </span><span>where</span><span> </span><span>T</span><span> </span><span>:</span><span> </span><span>AggregateRoot</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>_session</span><span>.</span><span>Get</span><span>&lt;</span><span>T</span><span>&gt;</span><span>(</span><span>id</span><span>,</span><span> </span><span>expectedVersion</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>catch</span><span> </span><span>(</span><span>Exception</span><span> </span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>Error</span><span>(</span><span>"Cannot get object of type {0} with id={1} ({2}) from session"</span><span>,</span><span> </span><span>typeof</span><span>(</span><span>T</span><span>)</span><span>,</span><span> </span><span>id</span><span>,</span><span> </span><span>expectedVersion</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>e</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Handle</span><span>(</span><span>UpdateCustomerCommand </span><span>command</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>Info</span><span>(</span><span>"Handling UpdateCustomerCommand {0} ({1})"</span><span>,</span><span> </span><span>command</span><span>.</span><span>Id</span><span>,</span><span> </span><span>command</span><span>.</span><span>ExpectedVersion</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CustomerAggregate </span><span>item</span><span> </span><span>=</span><span> </span><span>Get</span><span>&lt;</span><span>CustomerAggregate</span><span>&gt;</span><span>(</span><span>command</span><span>.</span><span>Id</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>item</span><span>.</span><span>Update</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Id</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Name</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Age</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>Phones</span><span>.</span><span>Select</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>new</span><span> </span><span>Phone</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Type</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Type</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AreaCode</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>AreaCode</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Number</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Number</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>command</span><span>.</span><span>ExpectedVersion</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_session</span><span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Handle</span><span>(</span><span>DeleteCustomerCommand </span><span>command</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CustomerAggregate </span><span>item</span><span> </span><span>=</span><span> </span><span>Get</span><span>&lt;</span><span>CustomerAggregate</span><span>&gt;</span><span>(</span><span>command</span><span>.</span><span>Id</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>item</span><span>.</span><span>Delete</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_session</span><span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0022 seconds] -->

<p>There are some interesting changes here. The previous version of this class kept both the <code>repository</code> and <code>eventPublisher</code>, at the same time, to mock the behavior of a CQRS. Now, with the courtesy of CQRSLite, there is the <code>ICommandHandler</code> interface that enables the command handler to implement as many <code>Handle()</code> methods as the total of commands. This way, you can decide what is going to happen with each type of command once they arrive.</p>
<p>Get back to Figure 1 again and take another look. From now on, you need to safely aggregate the command’s data and store it to the event store as events. That’s why you’re saving, updating and deleting the information directly to the <em>session</em> object. The session is also another perk from the CQRSLite framework. It has a triad of repositories with fallback management, to assure that the information is going to be persisted. Of course, everything is in memory, so make sure to adapt the framework to connect to a real database in case you’re considering using it in production.</p>
<p>Each operation over the session must be committed. At the end of this operation, the framework publishes the event as a message to the <code>IEventPublisher</code> object it has injected. If you want to overwrite its behavior (and you do), you need to create your own publisher handler and implement it (soon).</p>
<p><em>Obs: For all the CQRSLite components mentioned in this article, and for a better understanding, it’s recommended that you go into each one and analyze their content.</em></p>
<p>Next stop: <em>Domain</em> folder. This has two inner folders: <em>/Aggregates</em> and <em>/Bus</em> (create them). Inside of the first folder, create the class shown in Listing 3.</p>
<p>Listing 3. CustomerAggregate class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528a6062121906" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Domain</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>VOs</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Domain</span><span>.</span><span>Aggregates</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerAggregate</span><span> </span><span>:</span><span> </span><span>AggregateRoot</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>string</span><span> </span><span>email</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>string</span><span> </span><span>name</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>int</span><span> </span><span>age</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>phones</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>Apply</span><span>(</span><span>CustomerCreatedEvent</span><span> </span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Version</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Version</span><span>++</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>email</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Email</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>age</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Age</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>phones</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Phones</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>Apply</span><span>(</span><span>CustomerUpdatedEvent</span><span> </span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Version</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Version</span><span>++</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>name</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Name</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>age</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Age</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>phones</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Phones</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>Apply</span><span>(</span><span>CustomerDeletedEvent</span><span> </span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Version</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>Version</span><span>++</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>CustomerAggregate</span><span>(</span><span>)</span><span> </span><span>{</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerAggregate</span><span>(</span><span>Guid </span><span>id</span><span>,</span><span> </span><span>string</span><span> </span><span>email</span><span>,</span><span> </span><span>string</span><span> </span><span>name</span><span>,</span><span> </span><span>int</span><span> </span><span>age</span><span>,</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>phones</span><span>,</span><span> </span><span>int</span><span> </span><span>version</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>string</span><span>.</span><span>IsNullOrEmpty</span><span>(</span><span>email</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>ArgumentException</span><span>(</span><span>"email"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>string</span><span>.</span><span>IsNullOrEmpty</span><span>(</span><span>name</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>ArgumentException</span><span>(</span><span>"name"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>age</span><span> </span><span>==</span><span> </span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>ArgumentException</span><span>(</span><span>"age"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>phones</span><span> </span><span>==</span><span> </span><span>null</span><span> </span><span>||</span><span> </span><span>phones</span><span>.</span><span>Count</span><span> </span><span>==</span><span> </span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>ArgumentException</span><span>(</span><span>"phones"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Id</span><span> </span><span>=</span><span> </span><span>id</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ApplyChange</span><span>(</span><span>new</span><span> </span><span>CustomerCreatedEvent</span><span>(</span><span>id</span><span>,</span><span> </span><span>email</span><span>,</span><span> </span><span>name</span><span>,</span><span> </span><span>age</span><span>,</span><span> </span><span>phones</span><span>,</span><span> </span><span>version</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Update</span><span>(</span><span>Guid </span><span>id</span><span>,</span><span> </span><span>string</span><span> </span><span>name</span><span>,</span><span> </span><span>int</span><span> </span><span>age</span><span>,</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>phones</span><span>,</span><span> </span><span>int</span><span> </span><span>version</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ApplyChange</span><span>(</span><span>new</span><span> </span><span>CustomerUpdatedEvent</span><span>(</span><span>id</span><span>,</span><span> </span><span>name</span><span>,</span><span> </span><span>age</span><span>,</span><span> </span><span>phones</span><span>,</span><span> </span><span>version</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Delete</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ApplyChange</span><span>(</span><span>new</span><span> </span><span>CustomerDeletedEvent</span><span>(</span><span>Id</span><span>,</span><span> </span><span>Version</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>The Aggregate pattern is rich not only for allowing you to group data that’s relevant but also for being a great place to validate it. Again, you’re making use of <code>AggregateRoot</code> class from CQRSLite, which provides a handful of methods to apply the pattern to any object that extends from it. Don’t forget that it keeps the list of events in memory, and it’s ok to be this way since you’re interested in the data being transported to the event store.</p>
<p>For each creation, update or deletion, you’re making sure to increment the version and validate the data. It’s focused in simple validations, like whether the data is null or empty. Feel free to play around here too, even injecting other validator classes of your own and fancy treat the exception flows.</p>
<p>In the <em>/Bus</em> folder, start with the Rabbit stuff. You’ve already created a publisher and a subscriber, so you’ll just adapt them a bit and make sure it works integrated with CQRSLite. Please, refer to the Listings 4 and 5 for that.</p>
<p>Listing 4. AMQPEventSubscriber class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528ab307018242" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>.</span><span>Handlers</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Hosting</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>Extensions</span><span>.</span><span>Configuration</span><span>;</span></p><p><span>using</span><span> </span><span>Newtonsoft</span><span>.</span><span>Json</span><span>;</span></p><p><span>using</span><span> </span><span>RabbitMQ</span><span>.</span><span>Client</span><span>;</span></p><p><span>using</span><span> </span><span>RabbitMQ</span><span>.</span><span>Client</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>RabbitMQ</span><span>.</span><span>Client</span><span>.</span><span>MessagePatterns</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Linq</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Reflection</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Text</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Domain</span><span>.</span><span>Bus</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>AMQPEventSubscriber</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>IBusEventHandler</span><span>[</span><span>]</span><span> </span><span>_handlers</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>Dictionary</span><span>&lt;</span><span>Type</span><span>,</span><span> </span><span>MethodInfo</span><span>&gt;</span><span> </span><span>lookups</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>Type</span><span>,</span><span> </span><span>MethodInfo</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>AMQPEventSubscriber</span><span>(</span><span>IHostingEnvironment </span><span>env</span><span>,</span><span> </span><span>IBusEventHandler</span><span>[</span><span>]</span><span> </span><span>handlers</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_handlers</span><span> </span><span>=</span><span> </span><span>handlers</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>foreach</span><span> </span><span>(</span><span>var</span><span> </span><span>handler </span><span>in</span><span> </span><span>_handlers</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>meth</span><span> </span><span>=</span><span> </span><span>(</span><span>from</span><span> </span><span>m</span><span> </span><span>in</span><span> </span><span>handler</span><span>.</span><span>GetType</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>GetMethods</span><span>(</span><span>BindingFlags</span><span>.</span><span>Public</span><span> </span><span>|</span><span> </span><span>BindingFlags</span><span>.</span><span>Instance</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>let </span><span>prms</span><span> </span><span>=</span><span> </span><span>m</span><span>.</span><span>GetParameters</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>where </span><span>prms</span><span>.</span><span>Count</span><span>(</span><span>)</span><span> </span><span>==</span><span> </span><span>1</span><span> </span><span>&amp;&amp;</span><span> </span><span>m</span><span>.</span><span>Name</span><span>.</span><span>Contains</span><span>(</span><span>"Handle"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>select</span><span> </span><span>new</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>EventType</span><span> </span><span>=</span><span> </span><span>handler</span><span>.</span><span>HandlerType</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Method</span><span> </span><span>=</span><span> </span><span>m</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>meth</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lookups</span><span>.</span><span>Add</span><span>(</span><span>meth</span><span>.</span><span>EventType</span><span>,</span><span> </span><span>meth</span><span>.</span><span>Method</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Thread</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Start</span><span>(</span><span>env</span><span>.</span><span>ContentRootPath</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Start</span><span>(</span><span>string</span><span> </span><span>contentRootPath</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ConnectionFactory </span><span>connectionFactory</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ConnectionFactory</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>builder</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ConfigurationBuilder</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>SetBasePath</span><span>(</span><span>contentRootPath</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddJsonFile</span><span>(</span><span>"appsettings.json"</span><span>,</span><span> </span><span>optional</span><span>:</span><span> </span><span>false</span><span>,</span><span> </span><span>reloadOnChange</span><span>:</span><span> </span><span>false</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddEnvironmentVariables</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>builder</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>.</span><span>GetSection</span><span>(</span><span>"amqp"</span><span>)</span><span>.</span><span>Bind</span><span>(</span><span>connectionFactory</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>connectionFactory</span><span>.</span><span>AutomaticRecoveryEnabled</span><span> </span><span>=</span><span> </span><span>true</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>connectionFactory</span><span>.</span><span>NetworkRecoveryInterval</span><span> </span><span>=</span><span> </span><span>TimeSpan</span><span>.</span><span>FromSeconds</span><span>(</span><span>15</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>using</span><span> </span><span>(</span><span>IConnection </span><span>conn</span><span> </span><span>=</span><span> </span><span>connectionFactory</span><span>.</span><span>CreateConnection</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>using</span><span> </span><span>(</span><span>IModel </span><span>channel</span><span> </span><span>=</span><span> </span><span>conn</span><span>.</span><span>CreateModel</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>DeclareQueues</span><span>(</span><span>channel</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>subscriptionCreated</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Subscription</span><span>(</span><span>channel</span><span>,</span><span> </span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_CREATED</span><span>,</span><span> </span><span>false</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>subscriptionUpdated</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Subscription</span><span>(</span><span>channel</span><span>,</span><span> </span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_UPDATED</span><span>,</span><span> </span><span>false</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>subscriptionDeleted</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Subscription</span><span>(</span><span>channel</span><span>,</span><span> </span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_DELETED</span><span>,</span><span> </span><span>false</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>while</span><span> </span><span>(</span><span>true</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// Sleeps for 5 sec before trying again</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Thread</span><span>.</span><span>Sleep</span><span>(</span><span>5000</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Thread</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ListerCreated</span><span>(</span><span>subscriptionCreated</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Thread</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ListenUpdated</span><span>(</span><span>subscriptionUpdated</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Thread</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ListenDeleted</span><span>(</span><span>subscriptionDeleted</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>ListenDeleted</span><span>(</span><span>Subscription </span><span>subscriptionDeleted</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>BasicDeliverEventArgs </span><span>eventArgsDeleted</span><span> </span><span>=</span><span> </span><span>subscriptionDeleted</span><span>.</span><span>Next</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>eventArgsDeleted</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>string</span><span> </span><span>messageContent</span><span> </span><span>=</span><span> </span><span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetString</span><span>(</span><span>eventArgsDeleted</span><span>.</span><span>Body</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>HandleEvent</span><span>(</span><span>JsonConvert</span><span>.</span><span>DeserializeObject</span><span>&lt;</span><span>CustomerDeletedEvent</span><span>&gt;</span><span>(</span><span>messageContent</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>subscriptionDeleted</span><span>.</span><span>Ack</span><span>(</span><span>eventArgsDeleted</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>ListenUpdated</span><span>(</span><span>Subscription </span><span>subscriptionUpdated</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>BasicDeliverEventArgs </span><span>eventArgsUpdated</span><span> </span><span>=</span><span> </span><span>subscriptionUpdated</span><span>.</span><span>Next</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>eventArgsUpdated</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>string</span><span> </span><span>messageContent</span><span> </span><span>=</span><span> </span><span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetString</span><span>(</span><span>eventArgsUpdated</span><span>.</span><span>Body</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>HandleEvent</span><span>(</span><span>JsonConvert</span><span>.</span><span>DeserializeObject</span><span>&lt;</span><span>CustomerUpdatedEvent</span><span>&gt;</span><span>(</span><span>messageContent</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>subscriptionUpdated</span><span>.</span><span>Ack</span><span>(</span><span>eventArgsUpdated</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>ListerCreated</span><span>(</span><span>Subscription </span><span>subscriptionCreated</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>BasicDeliverEventArgs </span><span>eventArgsCreated</span><span> </span><span>=</span><span> </span><span>subscriptionCreated</span><span>.</span><span>Next</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>eventArgsCreated</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>string</span><span> </span><span>messageContent</span><span> </span><span>=</span><span> </span><span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetString</span><span>(</span><span>eventArgsCreated</span><span>.</span><span>Body</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>HandleEvent</span><span>(</span><span>JsonConvert</span><span>.</span><span>DeserializeObject</span><span>&lt;</span><span>CustomerCreatedEvent</span><span>&gt;</span><span>(</span><span>messageContent</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>subscriptionCreated</span><span>.</span><span>Ack</span><span>(</span><span>eventArgsCreated</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>HandleEvent</span><span>(</span><span>IEvent</span><span> </span><span>@</span><span>event</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>theHandler</span><span> </span><span>=</span><span> </span><span>_handlers</span><span>.</span><span>SingleOrDefault</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>x</span><span>.</span><span>HandlerType</span><span> </span><span>==</span><span> </span><span>@</span><span>event</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>foreach</span><span> </span><span>(</span><span>KeyValuePair</span><span>&lt;</span><span>Type</span><span>,</span><span> </span><span>MethodInfo</span><span>&gt;</span><span> </span><span>entry </span><span>in</span><span> </span><span>lookups</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>entry</span><span>.</span><span>Key</span><span> </span><span>==</span><span> </span><span>@</span><span>event</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>entry</span><span>.</span><span>Value</span><span>.</span><span>Invoke</span><span>(</span><span>theHandler</span><span>,</span><span> </span><span>new</span><span>[</span><span>]</span><span> </span><span>{</span><span> </span><span>(</span><span>object</span><span>)</span><span>@</span><span>event</span><span> </span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>Wait</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>static</span><span> </span><span>void</span><span> </span><span>DeclareQueues</span><span>(</span><span>IModel </span><span>channel</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>channel</span><span>.</span><span>QueueDeclare</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>queue</span><span>:</span><span> </span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_CREATED</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>durable</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exclusive</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>autoDelete</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>arguments</span><span>:</span><span> </span><span>null</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>channel</span><span>.</span><span>QueueDeclare</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>queue</span><span>:</span><span> </span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_UPDATED</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>durable</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exclusive</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>autoDelete</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>arguments</span><span>:</span><span> </span><span>null</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>channel</span><span>.</span><span>QueueDeclare</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>queue</span><span>:</span><span> </span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_DELETED</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>durable</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exclusive</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>autoDelete</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>arguments</span><span>:</span><span> </span><span>null</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0049 seconds] -->

<p>Don’t forget to add the same <code>Constants</code> class created in the previous tutorial to <em>/Bus</em> folder:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528b1722951688" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Domain</span><span>.</span><span>Bus</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>Constants</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>		</span><span>public</span><span> </span><span>const</span><span> </span><span>string</span><span> </span><span>QUEUE_CUSTOMER_CREATED</span><span> </span><span>=</span><span> </span><span>"customer_created"</span><span>;</span></p><p><span>		</span><span>public</span><span> </span><span>const</span><span> </span><span>string</span><span> </span><span>QUEUE_CUSTOMER_UPDATED</span><span> </span><span>=</span><span> </span><span>"customer_updated"</span><span>;</span></p><p><span>		</span><span>public</span><span> </span><span>const</span><span> </span><span>string</span><span> </span><span>QUEUE_CUSTOMER_DELETED</span><span> </span><span>=</span><span> </span><span>"customer_deleted"</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>The class is pretty much the same as before, so this section. Except for the constructor that injects an array of <code>IBusEventHandler</code> (more on it soon). Just for you to not see a bunch of errors in your IDE, create this class into <em>Events/Handlers/</em> folder:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528b4091699755" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>.</span><span>Handlers</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>interface</span><span> </span><span>IBusEventHandler</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Type</span><span> </span><span>HandlerType</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>void</span><span> </span><span>Handle</span><span>(</span><span>IEvent</span><span> </span><span>@</span><span>event</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>Look carefully at the code in Listing 4’s constructor. It makes use of reflection to collect the handler type (an attribute of each event handler to define which type of event it takes care of) and the respective method it must execute when called. The method, in case, will always be <code>Handle()</code>.</p>
<p>Plus, the thread to start the RabbitMQ subscriber that was previously located into the Startup class, has been moved to this class, just to make more sense.</p>
<p>Every <code>ListenXX</code> method calls the new <code>HandleEvent()</code> that, in turn, invokes (via reflection) the method mapped for the current event being subscribed.</p>
<p>Listing 5. AMQPEventPublisher class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528b7896569623" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Hosting</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>Extensions</span><span>.</span><span>Configuration</span><span>;</span></p><p><span>using</span><span> </span><span>Newtonsoft</span><span>.</span><span>Json</span><span>;</span></p><p><span>using</span><span> </span><span>RabbitMQ</span><span>.</span><span>Client</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Text</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Domain</span><span>.</span><span>Bus</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>AMQPEventPublisher</span><span> </span><span>:</span><span> </span><span>IEventPublisher</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>private</span><span> </span><span>readonly</span><span> </span><span>ConnectionFactory </span><span>connectionFactory</span><span>;</span></p><p><span>		</span><span>public</span><span> </span><span>AMQPEventPublisher</span><span>(</span><span>IHostingEnvironment </span><span>env</span><span>,</span><span> </span><span>AMQPEventSubscriber </span><span>aMQPEventSubscriber</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>connectionFactory</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ConnectionFactory</span><span>(</span><span>)</span><span>;</span></p><p><span>			</span><span>var</span><span> </span><span>builder</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ConfigurationBuilder</span><span>(</span><span>)</span></p><p><span>				</span><span>.</span><span>SetBasePath</span><span>(</span><span>env</span><span>.</span><span>ContentRootPath</span><span>)</span></p><p><span>				</span><span>.</span><span>AddJsonFile</span><span>(</span><span>"appsettings.json"</span><span>,</span><span> </span><span>optional</span><span>:</span><span> </span><span>false</span><span>,</span><span> </span><span>reloadOnChange</span><span>:</span><span> </span><span>false</span><span>)</span></p><p><span>				</span><span>.</span><span>AddEnvironmentVariables</span><span>(</span><span>)</span><span>;</span></p><p><span>			</span><span>builder</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>.</span><span>GetSection</span><span>(</span><span>"amqp"</span><span>)</span><span>.</span><span>Bind</span><span>(</span><span>connectionFactory</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>void</span><span> </span><span>Publish</span><span>&lt;</span><span>T</span><span>&gt;</span><span>(</span><span>T</span><span> </span><span>@</span><span>event</span><span>)</span><span> </span><span>where</span><span> </span><span>T</span><span> </span><span>:</span><span> </span><span>IEvent</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>using</span><span> </span><span>(</span><span>IConnection </span><span>conn</span><span> </span><span>=</span><span> </span><span>connectionFactory</span><span>.</span><span>CreateConnection</span><span>(</span><span>)</span><span>)</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>using</span><span> </span><span>(</span><span>IModel </span><span>channel</span><span> </span><span>=</span><span> </span><span>conn</span><span>.</span><span>CreateModel</span><span>(</span><span>)</span><span>)</span></p><p><span>				</span><span>{</span></p><p><span>					</span><span>var</span><span> </span><span>queue</span><span> </span><span>=</span><span> </span><span>@</span><span>event</span><span> </span><span>is</span><span> </span><span>CustomerCreatedEvent</span><span> </span><span>?</span><span> </span></p><p><span>						</span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_CREATED</span><span> </span><span>:</span><span> </span><span>@</span><span>event</span><span> </span><span>is</span><span> </span><span>CustomerUpdatedEvent</span><span> </span><span>?</span><span> </span></p><p><span>							</span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_UPDATED</span><span> </span><span>:</span><span> </span><span>Constants</span><span>.</span><span>QUEUE_CUSTOMER_DELETED</span><span>;</span></p><p><span>					</span><span>channel</span><span>.</span><span>QueueDeclare</span><span>(</span></p><p><span>						</span><span>queue</span><span>:</span><span> </span><span>queue</span><span>,</span></p><p><span>						</span><span>durable</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>						</span><span>exclusive</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>						</span><span>autoDelete</span><span>:</span><span> </span><span>false</span><span>,</span></p><p><span>						</span><span>arguments</span><span>:</span><span> </span><span>null</span></p><p><span>					</span><span>)</span><span>;</span></p><p><span>					</span><span>var</span><span> </span><span>body</span><span> </span><span>=</span><span> </span><span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetBytes</span><span>(</span><span>JsonConvert</span><span>.</span><span>SerializeObject</span><span>(</span><span>@</span><span>event</span><span>)</span><span>)</span><span>;</span></p><p><span>					</span><span>channel</span><span>.</span><span>BasicPublish</span><span>(</span></p><p><span>						</span><span>exchange</span><span>:</span><span> </span><span>""</span><span>,</span></p><p><span>						</span><span>routingKey</span><span>:</span><span> </span><span>queue</span><span>,</span></p><p><span>						</span><span>basicProperties</span><span>:</span><span> </span><span>null</span><span>,</span></p><p><span>						</span><span>body</span><span>:</span><span> </span><span>body</span></p><p><span>					</span><span>)</span><span>;</span></p><p><span>				</span><span>}</span></p><p><span>			</span><span>}</span></p><p><span>		</span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>The publisher class is the same as before, except it implements the <code>IEventPublisher</code> interface from CQRSLite — the one that is called by <code>session</code> after each commit.</p>
<p>The <code>Constants</code> class, which hosts the names of the queues, must be moved to the <em>Bus</em> folder too.</p>
<p>The folder <em>/Events</em> hosts, as the name suggests, the same events already created. The changes are very slight. The first one is an <code>AbstractEvent</code> class to hold the information of ids, version, and datetime of the event:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528ba289409459" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>AbstractEvent</span><span> </span><span>:</span><span> </span><span>IEvent</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Guid</span><span> </span><span>Id</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>int</span><span> </span><span>Version</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>DateTimeOffset</span><span> </span><span>TimeStamp</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>This will compensate the repetition of values among its children. Look at the current implementation of the creation event:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528bc818927737" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>VOs</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerCreatedEvent</span><span> </span><span>:</span><span> </span><span>AbstractEvent</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>public</span><span> </span><span>string</span><span> </span><span>Email</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>string</span><span> </span><span>Name</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>Age</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>Phones</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>CustomerCreatedEvent</span><span>(</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>		</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerCreatedEvent</span><span>(</span><span>Guid </span><span>id</span><span>,</span><span> </span><span>string</span><span> </span><span>email</span><span>,</span><span> </span><span>string</span><span> </span><span>name</span><span>,</span><span> </span><span>int</span><span> </span><span>age</span><span>,</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>phones</span><span>,</span><span> </span><span>int</span><span> </span><span>version</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>Id</span><span> </span><span>=</span><span> </span><span>id</span><span>;</span></p><p><span>			</span><span>Email</span><span> </span><span>=</span><span> </span><span>email</span><span>;</span></p><p><span>			</span><span>Name</span><span> </span><span>=</span><span> </span><span>name</span><span>;</span></p><p><span>			</span><span>Age</span><span> </span><span>=</span><span> </span><span>age</span><span>;</span></p><p><span>			</span><span>Phones</span><span> </span><span>=</span><span> </span><span>phones</span><span>;</span></p><p><span>			</span><span>Version</span><span> </span><span>=</span><span> </span><span>version</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->

<p>The converter methods are removed; the rest is just fields and constructors. If you feel that’s too repetitive, you can set one single VO class for all the operations you’re dealing with: database storing, API and event transits. Go ahead and adjust the other events alike:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528be517206364" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p></div>
				</td>
						<td><div><p><span>// CustomerUpdatedEvent class</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>VOs</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerUpdatedEvent</span><span> </span><span>:</span><span> </span><span>AbstractEvent</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>public</span><span> </span><span>string</span><span> </span><span>Name</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>Age</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>Phones</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>CustomerUpdatedEvent</span><span>(</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>CustomerUpdatedEvent</span><span>(</span><span>Guid </span><span>id</span><span>,</span><span> </span><span>string</span><span> </span><span>name</span><span>,</span><span> </span><span>int</span><span> </span><span>age</span><span>,</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>phones</span><span>,</span><span> </span><span>int</span><span> </span><span>version</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>Id</span><span> </span><span>=</span><span> </span><span>id</span><span>;</span></p><p><span>			</span><span>Name</span><span> </span><span>=</span><span> </span><span>name</span><span>;</span></p><p><span>			</span><span>Age</span><span> </span><span>=</span><span> </span><span>age</span><span>;</span></p><p><span>			</span><span>Phones</span><span> </span><span>=</span><span> </span><span>phones</span><span>;</span></p><p><span>			</span><span>Version</span><span> </span><span>=</span><span> </span><span>version</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>And for the event of deletion, you have:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528c0562076860" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>// CustomerDeletedEvent class</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerDeletedEvent</span><span> </span><span>:</span><span> </span><span>AbstractEvent</span></p><p><span>	</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerDeletedEvent</span><span>(</span><span>Guid </span><span>id</span><span>,</span><span> </span><span>int</span><span> </span><span>version</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Id</span><span> </span><span>=</span><span> </span><span>id</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Version</span><span> </span><span>=</span><span> </span><span>version</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>Now’s time to create the implementations of <code>IBusEventHandler</code>. One for each event. Start with the event of creation (Listing 6).</p>
<p>Listing 6. CustomerCreatedEventHandler class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528c2040801285" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>.</span><span>Repositories</span><span>;</span></p><p><span>using</span><span> </span><span>NLog</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Linq</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>.</span><span>Handlers</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerCreatedEventHandler</span><span> </span><span>:</span><span> </span><span>IBusEventHandler</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>CustomerReadModelRepository </span><span>readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>Logger </span><span>logger</span><span> </span><span>=</span><span> </span><span>LogManager</span><span>.</span><span>GetLogger</span><span>(</span><span>"CustomerCreatedEventHandler"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerCreatedEventHandler</span><span>(</span><span>CustomerReadModelRepository </span><span>readModelRepository</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>readModelRepository</span><span> </span><span>=</span><span> </span><span>readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Type</span><span> </span><span>HandlerType</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>get</span><span> </span><span>{</span><span> </span><span>return</span><span> </span><span>typeof</span><span>(</span><span>CustomerCreatedEvent</span><span>)</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>void</span><span> </span><span>Handle</span><span>(</span><span>IEvent</span><span> </span><span>@</span><span>event</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CustomerCreatedEvent </span><span>customerCreatedEvent</span><span> </span><span>=</span><span> </span><span>(</span><span>CustomerCreatedEvent</span><span>)</span><span>@</span><span>event</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await</span><span> </span><span>readModelRepository</span><span>.</span><span>Create</span><span>(</span><span>new</span><span> </span><span>Customer</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Id</span><span> </span><span>=</span><span> </span><span>customerCreatedEvent</span><span>.</span><span>Id</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Email</span><span> </span><span>=</span><span> </span><span>customerCreatedEvent</span><span>.</span><span>Email</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Name</span><span> </span><span>=</span><span> </span><span>customerCreatedEvent</span><span>.</span><span>Name</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Age</span><span> </span><span>=</span><span> </span><span>customerCreatedEvent</span><span>.</span><span>Age</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Phones</span><span> </span><span>=</span><span> </span><span>customerCreatedEvent</span><span>.</span><span>Phones</span><span>.</span><span>Select</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Phone</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Type</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Type</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AreaCode</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>AreaCode</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Number</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Number</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>Info</span><span>(</span><span>"A new CustomerCreatedEvent has been processed: {0} ({1})"</span><span>,</span><span> </span><span>customerCreatedEvent</span><span>.</span><span>Id</span><span>,</span><span> </span><span>customerCreatedEvent</span><span>.</span><span>Version</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<p>The first thing to note is that those are the classes responsible for updating the final database, Mongo.</p>
<p>Second, the <code>HandlerType</code>. Remember the reflection created to define which method takes care of each event that’s arriving? Well, the <code>Handle(</code><em>)</em> is the method based on this type. Each handler is associated with an event by what’s defined in <code>HandlerType</code> field.</p>
<p>Third, be aware of the asynchronous nature of the methods now. It helps to turn the whole implementation faster by no locking of resources. The handling <em>per se</em> is just the same Mongo management seen before with a few changes.</p>
<p>Listing 7 shows how the update event is handled.</p>
<p>Listing 7. CustomerUpdatedEventHandler class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528c5781259714" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>.</span><span>Repositories</span><span>;</span></p><p><span>using</span><span> </span><span>NLog</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Linq</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>.</span><span>Handlers</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerUpdatedEventHandler</span><span> </span><span>:</span><span> </span><span>IBusEventHandler</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>CustomerReadModelRepository </span><span>readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>Logger </span><span>logger</span><span> </span><span>=</span><span> </span><span>LogManager</span><span>.</span><span>GetLogger</span><span>(</span><span>"CustomerUpdatedEventHandler"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerUpdatedEventHandler</span><span>(</span><span>CustomerReadModelRepository </span><span>readModelRepository</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>readModelRepository</span><span> </span><span>=</span><span> </span><span>readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Type</span><span> </span><span>HandlerType</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>get</span><span> </span><span>{</span><span> </span><span>return</span><span> </span><span>typeof</span><span>(</span><span>CustomerUpdatedEvent</span><span>)</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>void</span><span> </span><span>Handle</span><span>(</span><span>IEvent</span><span> </span><span>@</span><span>event</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CustomerUpdatedEvent </span><span>customerUpdatedEvent</span><span> </span><span>=</span><span> </span><span>(</span><span>CustomerUpdatedEvent</span><span>)</span><span>@</span><span>event</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Customer </span><span>customer</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>readModelRepository</span><span>.</span><span>GetCustomer</span><span>(</span><span>@</span><span>event</span><span>.</span><span>Id</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await</span><span> </span><span>readModelRepository</span><span>.</span><span>Update</span><span>(</span><span>new</span><span> </span><span>Customer</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Id</span><span> </span><span>=</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Id</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Email</span><span> </span><span>=</span><span> </span><span>customer</span><span>.</span><span>Email</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Name</span><span> </span><span>=</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Name</span><span> </span><span>!=</span><span> </span><span>null</span><span> </span><span>?</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Name</span><span> </span><span>:</span><span> </span><span>customer</span><span>.</span><span>Name</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Age</span><span> </span><span>=</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Age</span><span> </span><span>!=</span><span> </span><span>0</span><span> </span><span>?</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Age</span><span> </span><span>:</span><span> </span><span>customer</span><span>.</span><span>Age</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Phones</span><span> </span><span>=</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Phones</span><span> </span><span>!=</span><span> </span><span>null</span><span> </span><span>?</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Phones</span><span>.</span><span>Select</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Phone</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Type</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Type</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AreaCode</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>AreaCode</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Number</span><span> </span><span>=</span><span> </span><span>x</span><span>.</span><span>Number</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span> </span><span>:</span><span> </span><span>customer</span><span>.</span><span>Phones</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>Info</span><span>(</span><span>"A new CustomerUpdatedEvent has been processed: {0} ({1})"</span><span>,</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Id</span><span>,</span><span> </span><span>customerUpdatedEvent</span><span>.</span><span>Version</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

<p>This class has the implementation except for the handle method. This time, it checks for the nullity of each customer’s attribute, since you don’t want to update absent or null values.</p>
<p>Finally, Listing 8 shows how the deletion takes place.</p>
<p>Listing 8. CustomerDeletedEventHandler class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528c9444255081" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>.</span><span>Repositories</span><span>;</span></p><p><span>using</span><span> </span><span>NLog</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>.</span><span>Handlers</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerDeletedEventHandler</span><span> </span><span>:</span><span> </span><span>IBusEventHandler</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>CustomerReadModelRepository </span><span>readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>Logger </span><span>logger</span><span> </span><span>=</span><span> </span><span>LogManager</span><span>.</span><span>GetLogger</span><span>(</span><span>"CustomerDeletedEventHandler"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerDeletedEventHandler</span><span>(</span><span>CustomerReadModelRepository </span><span>readModelRepository</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>readModelRepository</span><span> </span><span>=</span><span> </span><span>readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Type</span><span> </span><span>HandlerType</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>get</span><span> </span><span>{</span><span> </span><span>return</span><span> </span><span>typeof</span><span>(</span><span>CustomerDeletedEvent</span><span>)</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>void</span><span> </span><span>Handle</span><span>(</span><span>IEvent</span><span> </span><span>@</span><span>event</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CustomerDeletedEvent </span><span>customerDeletedEvent</span><span> </span><span>=</span><span> </span><span>(</span><span>CustomerDeletedEvent</span><span>)</span><span>@</span><span>event</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await</span><span> </span><span>readModelRepository</span><span>.</span><span>Remove</span><span>(</span><span>customerDeletedEvent</span><span>.</span><span>Id</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>Info</span><span>(</span><span>"A new CustomerDeletedEvent has been processed: {0} ({1})"</span><span>,</span><span> </span><span>customerDeletedEvent</span><span>.</span><span>Id</span><span>,</span><span> </span><span>customerDeletedEvent</span><span>.</span><span>Version</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>This class has just a single call to Mongo’s removal method. Don’t worry about the errors in Visual Studio caused by not finding the class <code>CustomerReadModelRepository</code>. As soon it’s created it in the read model part, they’ll disappear.</p>
<p>Now to finish the write model by creating the last class into the <em>/EventStore</em> folder: <code>CustomerEventStore</code> (Listing 9).</p>
<p>Listing 9. CustomerEventStore class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528cc932118753" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Linq</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>EventStore</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerEventStore</span><span> </span><span>:</span><span> </span><span>IEventStore</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>Dictionary</span><span>&lt;</span><span>Guid</span><span>,</span><span> </span><span>List</span><span>&lt;</span><span>IEvent</span><span>&gt;&gt;</span><span> </span><span>customerInMemDictionary</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Dictionary</span><span>&lt;</span><span>Guid</span><span>,</span><span> </span><span>List</span><span>&lt;</span><span>IEvent</span><span>&gt;&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>IEvent</span><span>&gt;</span><span> </span><span>Get</span><span>(</span><span>Guid </span><span>aggregateId</span><span>,</span><span> </span><span>int</span><span> </span><span>fromVersion</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>List</span><span>&lt;</span><span>IEvent</span><span>&gt;</span><span> </span><span>customerEvents</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>customerInMemDictionary</span><span>.</span><span>TryGetValue</span><span>(</span><span>aggregateId</span><span>,</span><span> </span><span>out</span><span> </span><span>customerEvents</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>customerEvents</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>customerEvents</span><span>.</span><span>Where</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>x</span><span>.</span><span>Version</span><span> </span><span>&gt;</span><span> </span><span>fromVersion</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>IEvent</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Save</span><span>(</span><span>IEvent</span><span> </span><span>@</span><span>event</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>List</span><span>&lt;</span><span>IEvent</span><span>&gt;</span><span> </span><span>customerEvents</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>customerInMemDictionary</span><span>.</span><span>TryGetValue</span><span>(</span><span>@</span><span>event</span><span>.</span><span>Id</span><span>,</span><span> </span><span>out</span><span> </span><span>customerEvents</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>customerEvents</span><span> </span><span>==</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>customerEvents</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>IEvent</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>customerInMemDictionary</span><span>.</span><span>Add</span><span>(</span><span>@</span><span>event</span><span>.</span><span>Id</span><span>,</span><span> </span><span>customerEvents</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>customerEvents</span><span>.</span><span>Add</span><span>(</span><span>@</span><span>event</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>It is a simple event store with just two operations: <code>get</code> an aggregated element from the history and <code>save</code> a new one to the dictionary. Note that the <code>get</code> method receives a second argument <code>fromVersion</code> that you’ll use to filter the items from that specific version.</p>
<p>The key of each aggregation is the customer Guid, and the values a List. Since List guarantees the order of the stacked items, you can rest assured that the events are ok.</p>
<h2>The Read Models</h2>
<p>The read models are much simpler; they constitute the Mongo entities (you can import the same ones from the previous article) and the Mongo repository. For the matter of the best architecture, you can decide if you want to place the classes responsible for the event handling here since they exist in the borders of both worlds.</p>
<p>First, create the entity models into the <em>/ReadModels</em> folder, adapting from the ones in the previous tutorial:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528cf789301609" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p></div>
				</td>
						<td><div><p><span>// Customer entity class</span></p><p><span>using</span><span> </span><span>MongoDB</span><span>.</span><span>Bson</span><span>;</span></p><p><span>using</span><span> </span><span>MongoDB</span><span>.</span><span>Bson</span><span>.</span><span>Serialization</span><span>.</span><span>Attributes</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>Customer</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"Id"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>Guid</span><span> </span><span>Id</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"Email"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>string</span><span> </span><span>Email</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"Name"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>string</span><span> </span><span>Name</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"Age"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>Age</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"Phones"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>List</span><span>&lt;</span><span>Phone</span><span>&gt;</span><span> </span><span>Phones</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p><p><span>// Phone entity class</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>Commons</span><span>;</span></p><p><span>using</span><span> </span><span>MongoDB</span><span>.</span><span>Bson</span><span>.</span><span>Serialization</span><span>.</span><span>Attributes</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>partial</span><span> </span><span>class</span><span> </span><span>Phone</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"Type"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>PhoneType</span><span> </span><span>Type</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"AreaCode"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>AreaCode</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>		</span><span>[</span><span>BsonElement</span><span>(</span><span>"Number"</span><span>)</span><span>]</span></p><p><span>		</span><span>public</span><span> </span><span>int</span><span> </span><span>Number</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<p>Listing 10 shows the content of the <em>CustomerReadModelRepository</em> class.</p>
<p>Listing 10. CustomerReadModelRepository class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528d2568141803" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></p><p><span>using</span><span> </span><span>MongoDB</span><span>.</span><span>Driver</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>.</span><span>Repositories</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerReadModelRepository</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>private</span><span> </span><span>const</span><span> </span><span>string</span><span> </span><span>_customerDB</span><span> </span><span>=</span><span> </span><span>"CustomerDB"</span><span>;</span></p><p><span>		</span><span>private</span><span> </span><span>const</span><span> </span><span>string</span><span> </span><span>_customerCollection</span><span> </span><span>=</span><span> </span><span>"Customers"</span><span>;</span></p><p><span>		</span><span>private</span><span> </span><span>IMongoDatabase </span><span>_db</span><span>;</span></p><p><span>		</span><span>public</span><span> </span><span>CustomerReadModelRepository</span><span>(</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>MongoClient </span><span>_client</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>MongoClient</span><span>(</span><span>"mongodb://localhost:27017"</span><span>)</span><span>;</span></p><p><span>			</span><span>_db</span><span> </span><span>=</span><span> </span><span>_client</span><span>.</span><span>GetDatabase</span><span>(</span><span>_customerDB</span><span>)</span><span>;</span></p><p><span>			</span><span>_db</span><span>.</span><span>DropCollection</span><span>(</span><span>_customerCollection</span><span>)</span><span>;</span></p><p><span>			</span><span>_db</span><span>.</span><span>CreateCollection</span><span>(</span><span>_customerCollection</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>List</span><span>&lt;</span><span>Customer</span><span>&gt;&gt;</span><span> </span><span>GetCustomers</span><span>(</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>return</span><span> </span><span>_db</span><span>.</span><span>GetCollection</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>(</span><span>_customerCollection</span><span>)</span><span>.</span><span>Find</span><span>(</span><span>_</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>true</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span></p><p><span>			</span><span>}</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span> </span><span>GetCustomer</span><span>(</span><span>Guid </span><span>id</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>return</span><span> </span><span>_db</span><span>.</span><span>GetCollection</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>(</span><span>_customerCollection</span><span>)</span><span>.</span><span>Find</span><span>(</span><span>customer</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>customer</span><span>.</span><span>Id</span><span>.</span><span>Equals</span><span>(</span><span>id</span><span>)</span><span>)</span><span>.</span><span>SingleOrDefault</span><span>(</span><span>)</span><span>;</span></p><p><span>			</span><span>}</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>List</span><span>&lt;</span><span>Customer</span><span>&gt;&gt;</span><span> </span><span>GetCustomerByEmail</span><span>(</span><span>string</span><span> </span><span>email</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>return</span><span> </span><span>_db</span><span>.</span><span>GetCollection</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>(</span><span>_customerCollection</span><span>)</span><span>.</span><span>Find</span><span>(</span><span>customer</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>customer</span><span>.</span><span>Email</span><span> </span><span>==</span><span> </span><span>email</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span></p><p><span>			</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>bool</span><span>&gt;</span><span> </span><span>Create</span><span>(</span><span>Customer </span><span>customer</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>_db</span><span>.</span><span>GetCollection</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>(</span><span>_customerCollection</span><span>)</span><span>.</span><span>InsertOne</span><span>(</span><span>customer</span><span>)</span><span>;</span></p><p><span>				</span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>			</span><span>}</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>bool</span><span>&gt;</span><span> </span><span>Update</span><span>(</span><span>Customer </span><span>customer</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>var</span><span> </span><span>filter</span><span> </span><span>=</span><span> </span><span>Builders</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>.</span><span>Filter</span><span>.</span><span>Where</span><span>(</span><span>_</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>_</span><span>.</span><span>Id</span><span> </span><span>==</span><span> </span><span>customer</span><span>.</span><span>Id</span><span>)</span><span>;</span></p><p><span>				</span><span>_db</span><span>.</span><span>GetCollection</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>(</span><span>_customerCollection</span><span>)</span><span>.</span><span>ReplaceOne</span><span>(</span><span>filter</span><span>,</span><span> </span><span>customer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>			</span><span>}</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>bool</span><span>&gt;</span><span> </span><span>Remove</span><span>(</span><span>Guid </span><span>id</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>var</span><span> </span><span>filter</span><span> </span><span>=</span><span> </span><span>Builders</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>.</span><span>Filter</span><span>.</span><span>Where</span><span>(</span><span>_</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>_</span><span>.</span><span>Id</span><span>.</span><span>Equals</span><span>(</span><span>id</span><span>)</span><span>)</span><span>;</span></p><p><span>				</span><span>var</span><span> </span><span>operation</span><span> </span><span>=</span><span> </span><span>_db</span><span>.</span><span>GetCollection</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span>(</span><span>_customerCollection</span><span>)</span><span>.</span><span>DeleteOne</span><span>(</span><span>filter</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>			</span><span>}</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->

<p>Most of its content remained the same. Pay attention to the dropping and recreating of the Mongo collection right into the constructor. That’s because the whole implementation works based on in-memory collections storing the data and simulating a real environment.</p>
<p>Once you restart the application multiple times and create many events, they’ll lose the link to the original data in the physical database.</p>
<p>Here, two options apply: you get to choose whether you prefer to implement the same repository to the session and event store management or delete all the items from the database, for the sake of simplicity. You can also create a routine to insert data to both database and event store, in order to test without having to input manually every time.</p>
<p>Except for that, the only change left is that the methods are now async. Every operation runs inside of a new thread and returns a <code>Task</code>. The same task would be transported all the way up to the controller and, so, to the ASP.NET HTTP async engine, making the application’s architecture async.</p>
<h2>The rest of the classes</h2>
<p>Two packages remain to be coded. Start with the <em>/Commons</em> folder. The first class to be created is <code>PhoneType</code> (that already existed). I decided to put it here to facilitate its usage over the whole application.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528d5355032045" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>Commons</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>enum</span><span> </span><span>PhoneType</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>HOMEPHONE</span><span>,</span><span> </span><span>CELLPHONE</span><span>,</span><span> </span><span>WORKPHONE</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>The <code>ServiceException </code>class just embraces a new type of exception to be used in the services. It’s a generic utilitarian exception class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528d8882776235" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>Serialization</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Security</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>Commons</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>ServiceException</span><span> </span><span>:</span><span> </span><span>Exception</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>ServiceException</span><span>(</span><span>)</span><span> </span><span>:</span><span> </span><span>base</span><span>(</span><span>)</span><span> </span><span>{</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>ServiceException</span><span>(</span><span>string</span><span> </span><span>message</span><span>)</span><span> </span><span>:</span><span> </span><span>base</span><span>(</span><span>message</span><span>)</span><span> </span><span>{</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>SecuritySafeCritical</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protected</span><span> </span><span>ServiceException</span><span>(</span><span>SerializationInfo </span><span>info</span><span>,</span><span> </span><span>StreamingContext </span><span>context</span><span>)</span><span> </span><span>:</span><span> </span><span>base</span><span>(</span><span>info</span><span>,</span><span> </span><span>context</span><span>)</span><span> </span><span>{</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>ServiceException</span><span>(</span><span>string</span><span> </span><span>message</span><span>,</span><span> </span><span>Exception </span><span>innerException</span><span>)</span><span> </span><span>:</span><span> </span><span>base</span><span>(</span><span>message</span><span>,</span><span> </span><span>innerException</span><span>)</span><span> </span><span>{</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>The <em>/Services</em> folder, in turn, is made of the methods that embrace both queries and commands of the CQRS model. Here, it’s interesting to note that the development of these facades doesn’t have to necessarily be in the same class, not even in the same project.</p>
<p>Methods to request queries or issue commands can be in different applications and still work well as a distributed system that accesses the same data sources.</p>
<p>Despite the fact they are put together, take a look at how they differentiate from each other (Listing 11).</p>
<p>Listing 11. CustomerService class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528da831339668" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>Commons</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>.</span><span>Repositories</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span><span>.</span><span>Handlers</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Linq</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Reflection</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>Services</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomerService</span><span> </span><span>:</span><span> </span><span>ICustomerService</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>CustomerCommandHandler </span><span>_commandHandlers</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>CustomerReadModelRepository </span><span>_readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomerService</span><span>(</span><span>CustomerCommandHandler </span><span>commandHandlers</span><span>,</span><span> </span><span>CustomerReadModelRepository </span><span>readModelRepository</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>_commandHandlers</span><span> </span><span>=</span><span> </span><span>commandHandlers</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>_readModelRepository</span><span> </span><span>=</span><span> </span><span>readModelRepository</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>bool</span><span>&gt;</span><span> </span><span>IssueCommandAsync</span><span>(</span><span>Command </span><span>cmd</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>method</span><span> </span><span>=</span><span> </span><span>(</span><span>from </span><span>meth </span><span>in</span><span> </span><span>typeof</span><span>(</span><span>CustomerCommandHandler</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>GetMethods</span><span>(</span><span>BindingFlags</span><span>.</span><span>Public</span><span> </span><span>|</span><span> </span><span>BindingFlags</span><span>.</span><span>Instance</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>let</span><span> </span><span>@</span><span>params</span><span> </span><span>=</span><span> </span><span>meth</span><span>.</span><span>GetParameters</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>where</span><span> </span><span>@</span><span>params</span><span>.</span><span>Count</span><span>(</span><span>)</span><span> </span><span>==</span><span> </span><span>1</span><span> </span><span>&amp;&amp;</span><span> </span><span>@</span><span>params</span><span>[</span><span>0</span><span>]</span><span>.</span><span>ParameterType</span><span> </span><span>==</span><span> </span><span>cmd</span><span>.</span><span>GetType</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>select </span><span>meth</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>method</span><span> </span><span>==</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>name</span><span> </span><span>=</span><span> </span><span>cmd</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span>.</span><span>Name</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>ServiceException</span><span>(</span><span>string</span><span>.</span><span>Format</span><span>(</span><span>"Command handler of {0} not found"</span><span>,</span><span> </span><span>name</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>method</span><span>.</span><span>Invoke</span><span>(</span><span>_commandHandlers</span><span>,</span><span> </span><span>new</span><span>[</span><span>]</span><span> </span><span>{</span><span> </span><span>cmd</span><span> </span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>List</span><span>&lt;</span><span>Customer</span><span>&gt;&gt;</span><span> </span><span>GetAllCustomersAsync</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>await</span><span> </span><span>_readModelRepository</span><span>.</span><span>GetCustomers</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span> </span><span>GetCustomerAsync</span><span>(</span><span>Guid </span><span>orderId</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>await</span><span> </span><span>_readModelRepository</span><span>.</span><span>GetCustomer</span><span>(</span><span>orderId</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>List</span><span>&lt;</span><span>Customer</span><span>&gt;&gt;</span><span> </span><span>GetCustomersByEmailAsync</span><span>(</span><span>string</span><span> </span><span>email</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>await</span><span> </span><span>_readModelRepository</span><span>.</span><span>GetCustomerByEmail</span><span>(</span><span>email</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->

<p>There are two main parts in this class, identifying the queries and commands. The method <code>IssueCommandAsync()</code> takes as a parameter a command itself to run in the correspondent command handler. Here, it’s making use of reflection once more to inflect flexibility, similarly to what was done before in the write model.</p>
<p>The rest of the methods are all query related. They access the Mongo repository directly to ensure they’ll get the stored information, i.e., the data that’s not guaranteed to be the most recent, which is fine given the CQRS nature of the API.</p>
<p>Here’s how the interface of the service <code>ICustomerService</code> should look:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528de963088792" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>ServiceModel</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>Services</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>ServiceContract</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>interface</span><span> </span><span>ICustomerService</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>OperationContract</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Task</span><span>&lt;</span><span>bool</span><span>&gt;</span><span> </span><span>IssueCommandAsync</span><span>(</span><span>Command </span><span>cmd</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>OperationContract</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Task</span><span>&lt;</span><span>List</span><span>&lt;</span><span>Customer</span><span>&gt;&gt;</span><span> </span><span>GetAllCustomersAsync</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>OperationContract</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Task</span><span>&lt;</span><span>Customer</span><span>&gt;</span><span> </span><span>GetCustomerAsync</span><span>(</span><span>Guid </span><span>custId</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>OperationContract</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Task</span><span>&lt;</span><span>List</span><span>&lt;</span><span>Customer</span><span>&gt;&gt;</span><span> </span><span>GetCustomersByEmailAsync</span><span>(</span><span>string</span><span> </span><span>email</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<h2>Controller and Startup</h2>
<p>The controller class also remains almost intact. Regarding the structure, method signatures, etc. nothing has suffered changes. However, now it’s async by the core, and so, the methods should be too. See at Listing 12 the new code.</p>
<p>Listing 12. New CustomersController class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528e1500205416" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>Services</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Mvc</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span><span>.</span><span>Controllers</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>Route</span><span>(</span><span>"api/[controller]"</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>CustomersController</span><span> </span><span>:</span><span> </span><span>Controller</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>readonly</span><span> </span><span>ICustomerService </span><span>_customerService</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomersController</span><span>(</span><span>ICustomerService </span><span>customerService</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_customerService</span><span> </span><span>=</span><span> </span><span>customerService</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>HttpGet</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>Get</span><span>(</span><span>[</span><span>FromQuery</span><span>]</span><span> </span><span>string</span><span> </span><span>email</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>async</span><span> </span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>email</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IActionResult </span><span>result</span><span> </span><span>=</span><span> </span><span>NotFound</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>customer</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>GetCustomersByEmailAsync</span><span>(</span><span>email</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>customer</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ObjectResult</span><span>(</span><span>customer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>result</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>new</span><span> </span><span>ObjectResult</span><span>(</span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>GetAllCustomersAsync</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>HttpGet</span><span>(</span><span>"{id}"</span><span>,</span><span> </span><span>Name</span><span> </span><span>=</span><span> </span><span>"GetCustomer"</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>GetById</span><span>(</span><span>Guid </span><span>id</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>async</span><span> </span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IActionResult </span><span>result</span><span> </span><span>=</span><span> </span><span>NotFound</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>customer</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>GetCustomerAsync</span><span>(</span><span>id</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>customer</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ObjectResult</span><span>(</span><span>customer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>result</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>HttpPost</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>Post</span><span>(</span><span>[</span><span>FromBody</span><span>]</span><span> </span><span>CreateCustomerCommand </span><span>customer</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>customer</span><span>.</span><span>Id</span><span> </span><span>=</span><span> </span><span>Guid</span><span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>async</span><span> </span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IActionResult </span><span>result</span><span> </span><span>=</span><span> </span><span>NotFound</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>bool</span><span> </span><span>created</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>IssueCommandAsync</span><span>(</span><span>customer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>created</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>CreatedAtRoute</span><span>(</span><span>"GetCustomer"</span><span>,</span><span> </span><span>new</span><span> </span><span>{</span><span> </span><span>id</span><span> </span><span>=</span><span> </span><span>customer</span><span>.</span><span>Id</span><span> </span><span>}</span><span>,</span><span> </span><span>customer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>result</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>HttpPut</span><span>(</span><span>"{id}"</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>Put</span><span>(</span><span>Guid </span><span>id</span><span>,</span><span> </span><span>[</span><span>FromBody</span><span>]</span><span> </span><span>UpdateCustomerCommand </span><span>customer</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>async</span><span> </span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IActionResult </span><span>result</span><span> </span><span>=</span><span> </span><span>NotFound</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>record</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>GetCustomerAsync</span><span>(</span><span>id</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>record</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>customer</span><span>.</span><span>Id</span><span> </span><span>=</span><span> </span><span>id</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>bool</span><span> </span><span>updated</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>IssueCommandAsync</span><span>(</span><span>customer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>updated</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>NoContent</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>result</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>HttpDelete</span><span>(</span><span>"{id}"</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>Delete</span><span>(</span><span>Guid </span><span>id</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>Task</span><span>.</span><span>Run</span><span>(</span><span>async</span><span> </span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IActionResult </span><span>result</span><span> </span><span>=</span><span> </span><span>NotFound</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>record</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>GetCustomerAsync</span><span>(</span><span>id</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>record</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>bool</span><span> </span><span>updated</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>_customerService</span><span>.</span><span>IssueCommandAsync</span><span>(</span><span>new</span><span> </span><span>DeleteCustomerCommand</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Id</span><span> </span><span>=</span><span> </span><span>id</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>updated</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>NoContent</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>result</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0031 seconds] -->

<p>The changes are very straightforward, so there is not much to do here.</p>
<p>The Startup class, in turn, changed a bit more, since you’re adding a new library to manage the registration of the services to the <code>IServiceProvider</code>. Look at Listing 13 for that.</p>
<p>Listing 13. Startup configuration class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528e5422379255" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>Castle</span><span>.</span><span>Facilities</span><span>.</span><span>AspNetCore</span><span>;</span></p><p><span>using</span><span> </span><span>Castle</span><span>.</span><span>MicroKernel</span><span>.</span><span>Registration</span><span>;</span></p><p><span>using</span><span> </span><span>Castle</span><span>.</span><span>Windsor</span><span>;</span></p><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Cache</span><span>;</span></p><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Domain</span><span>;</span></p><p><span>using</span><span> </span><span>CQRSlite</span><span>.</span><span>Events</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>Controllers</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>ReadModels</span><span>.</span><span>Repositories</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>Services</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Commands</span><span>.</span><span>Handlers</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Domain</span><span>.</span><span>Bus</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>Events</span><span>.</span><span>Handlers</span><span>;</span></p><p><span>using</span><span> </span><span>CustomerApi</span><span>.</span><span>WriteModels</span><span>.</span><span>EventStore</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Builder</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Hosting</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Http</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>Extensions</span><span>.</span><span>Configuration</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>Extensions</span><span>.</span><span>DependencyInjection</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></p><p><span>namespace</span><span> </span><span>CustomerApi</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>Startup</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>IHostingEnvironment </span><span>_env</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>static</span><span> </span><span>readonly</span><span> </span><span>WindsorContainer </span><span>Container</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>WindsorContainer</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Startup</span><span>(</span><span>IHostingEnvironment </span><span>env</span><span>,</span><span> </span><span>IConfiguration </span><span>config</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_env</span><span> </span><span>=</span><span> </span><span>env</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Configuration</span><span> </span><span>=</span><span> </span><span>config</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>IConfiguration</span><span> </span><span>Configuration</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// This method gets called by the runtime. Use this method to add services to the container.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>IServiceProvider </span><span>ConfigureServices</span><span>(</span><span>IServiceCollection </span><span>services</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>services</span><span>.</span><span>AddMvc</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// Setup component model contributors for making windsor services available to IServiceProvider</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Container</span><span>.</span><span>AddFacility</span><span>&lt;</span><span>AspNetCoreFacility</span><span>&gt;</span><span>(</span><span>f</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>f</span><span>.</span><span>CrossWiresInto</span><span>(</span><span>services</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// Custom application component registrations, ordering is important here</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>RegisterApplicationComponents</span><span>(</span><span>services</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// Castle Windsor integration, controllers, tag helpers and view components, this should always come after RegisterApplicationComponents</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>services</span><span>.</span><span>AddWindsor</span><span>(</span><span>Container</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opts</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>opts</span><span>.</span><span>UseEntryAssembly</span><span>(</span><span>typeof</span><span>(</span><span>CustomersController</span><span>)</span><span>.</span><span>Assembly</span><span>)</span><span>,</span><span> </span><span>// &lt;- Recommended</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>services</span><span>.</span><span>BuildServiceProvider</span><span>(</span><span>validateScopes</span><span>:</span><span> </span><span>false</span><span>)</span><span>)</span><span>;</span><span> </span><span>// &lt;- Optional</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>void</span><span> </span><span>RegisterApplicationComponents</span><span>(</span><span>IServiceCollection </span><span>services</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// Application components</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Container</span><span>.</span><span>Register</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>IEventPublisher</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>ImplementedBy</span><span>&lt;</span><span>AMQPEventPublisher</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Singleton</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>AMQPEventSubscriber</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Singleton</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>CustomerCommandHandler</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Transient</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>CustomerReadModelRepository</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Singleton</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>ICustomerService</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>ImplementedBy</span><span>&lt;</span><span>CustomerService</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Transient</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>CQRSlite</span><span>.</span><span>Domain</span><span>.</span><span>ISession</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>ImplementedBy</span><span>&lt;</span><span>Session</span><span>&gt;</span><span>(</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>IEventStore</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>ImplementedBy</span><span>&lt;</span><span>CustomerEventStore</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Singleton</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>IBusEventHandler</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>ImplementedBy</span><span>&lt;</span><span>CustomerCreatedEventHandler</span><span>&gt;</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>Named</span><span>(</span><span>"CustomerCreatedEventHandler"</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Singleton</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>IBusEventHandler</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>ImplementedBy</span><span>&lt;</span><span>CustomerUpdatedEventHandler</span><span>&gt;</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>Named</span><span>(</span><span>"CustomerUpdatedEventHandler"</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Singleton</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>IBusEventHandler</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>ImplementedBy</span><span>&lt;</span><span>CustomerDeletedEventHandler</span><span>&gt;</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>Named</span><span>(</span><span>"CustomerDeletedEventHandler"</span><span>)</span><span>.</span><span>LifeStyle</span><span>.</span><span>Singleton</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Component</span><span>.</span><span>For</span><span>&lt;</span><span>IRepository</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>UsingFactoryMethod</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>kernel</span><span> </span><span>=</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>new</span><span> </span><span>CacheRepository</span><span>(</span><span>new</span><span> </span><span>Repository</span><span>(</span><span> </span><span>//</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>kernel</span><span>.</span><span>Resolve</span><span>&lt;</span><span>IEventStore</span><span>&gt;</span><span>(</span><span>)</span><span>,</span><span> </span><span>kernel</span><span>.</span><span>Resolve</span><span>&lt;</span><span>IEventPublisher</span><span>&gt;</span><span>(</span><span>)</span><span>)</span><span>,</span><span> </span><span>kernel</span><span>.</span><span>Resolve</span><span>&lt;</span><span>IEventStore</span><span>&gt;</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>Configure</span><span>(</span><span>IApplicationBuilder </span><span>app</span><span>,</span><span> </span><span>IHostingEnvironment </span><span>env</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>env</span><span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span><span>	</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// For making component registrations of middleware easier</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Container</span><span>.</span><span>GetFacility</span><span>&lt;</span><span>AspNetCoreFacility</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>RegistersMiddlewareInto</span><span>(</span><span>app</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>app</span><span>.</span><span>UseMvc</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// Example of framework configured middleware component, can't consume types registered in Windsor</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>FrameworkMiddleware</span><span> </span><span>:</span><span> </span><span>IMiddleware</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async</span><span> </span><span>Task </span><span>InvokeAsync</span><span>(</span><span>HttpContext </span><span>context</span><span>,</span><span> </span><span>RequestDelegate </span><span>next</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await</span><span> </span><span>next</span><span>(</span><span>context</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0031 seconds] -->

<p>First, an instance of <code>WindsorContainer</code> needs to be created on the top of the class, to provide the methods for registering the services and adding facilities. The code itself is commented, so you can understand the context while following the configs down the lines.</p>
<p>Don’t forget to add any of the services, repositories and handlers, since that’ll lead to errors.</p>
<p>That’s it. It was a long way to the implementation, and now’s time to test it.</p>
<p>As a warning, remember that you’ve been using the same Rabbit queues created in parts 1 and 2 of this series. Before testing, you need to make sure that those queues are empty; otherwise, old messages stuck in there could cause problems with the new event subscriber.</p>
<p>For that, just go to the Rabbit management panel, click in <em>Queues</em> tab and locate the option <em>Purge</em> at the end of the screen. Click the button and confirm the action. Then, do the same with the <em>Delete</em> option, right above. See Figure 3 for reference. Don’t worry, every time the app starts up, it checks for the existence of the queues and, if they’re not there, the app recreates them.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/04/word-image-2.png" data-lazy-load=""></p>
<p>Figure 3. Purging and deleting queues.</p>
<p>Now, run the application, open Postman, and run the same requests configured in Part 2 of this tutorial. You don’t have to change anything to send a POST request, for example.</p>
<p>The result should look like:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e858007528eb923297799" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>{</span></p><p><span>"name"</span><span>:</span>&nbsp;<span>"John&nbsp;Paul&nbsp;2"</span><span>,</span></p><p><span>"email"</span><span>:</span>&nbsp;<span>"j@paul.com"</span><span>,</span></p><p><span>"age"</span><span>:</span>&nbsp;<span>23</span><span>,</span></p><p><span>"phones"</span><span>:</span>&nbsp;<span>[</span></p><p><span>{</span></p><p><span>"type"</span><span>:</span>&nbsp;<span>0</span><span>,</span></p><p><span>"areaCode"</span><span>:</span>&nbsp;<span>321</span><span>,</span></p><p><span>"number"</span><span>:</span>&nbsp;<span>1544</span></p><p><span>}</span></p><p><span>]</span><span>,</span></p><p><span>"id"</span><span>:</span>&nbsp;<span>"8ef5a99f-72c7-4876-9970-5cc83a0c3f04"</span><span>,</span></p><p><span>"expectedVersion"</span><span>:</span>&nbsp;<span>0</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>Note that now there is a different <code>id</code> coming up, and the attribute <code>expectedVersion</code> from the CQRSLite framework. The creation is faster than before since you don’t have to wait for a database during the creation of a record.</p>
<p>The same <code>id</code> must be used to the other endpoints to update and delete a customer. Be careful to provide the same <code>expectedVersion</code> when updating a value. You can update the framework not to need this, and always upgrade the latest data in the store when the version is not provided.</p>
<p>Don’t forget to check the database after each operation has finished. The same goes for your RabbitMQ queues. You can also debug each part of the application when running it, to see how each step goes on, in which class and order.</p>
<h2>Conclusion</h2>
<p>This is it for the series. I hope it’s been fruitful and helpful, at least for you to have a better understating of these patterns, since they’re quite confusing, even for experienced developers.</p>
<p>I highly recommend reading over Martin Fowler’s articles about <a href="https://martinfowler.com/bliki/CQRS.html">CQRS</a> and <a href="https://martinfowler.com/tags/event%20architectures.html">Event-driven</a> architectures, a reference to the community for years. Also, take a look at Greg Young’s first <a href="https://github.com/gregoryyoung/m-r">CQRS sample repo at GitHub</a>.</p>
<p>If you still feel adventurous, what about implementing the example over the <a href="https://eventstore.com/">Event Store</a> stream database? It’s free and open source. And its usage is very simple and clean. Good luck!</p>
			</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>