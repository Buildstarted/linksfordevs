<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Automatic reconnects with SignalR 3.0 &#x2022; Jerrie Pelser&#x27;s Blog -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Automatic reconnects with SignalR 3.0 &#x2022; Jerrie Pelser&#x27;s Blog</h1>
    <div class="col-md-12"> <p><strong>Published:&#xA0;</strong>10 June 2019</p> <p>In ASP.NET Core 3.0, Microsoft is updating the SignalR client by adding the ability to automatically reconnect when a connection is dropped. This blog post will show you how you can use this feature.</p> <h2 id="background">Background</h2> <p>I am developing a Google Docs Add-On for <a href="https://www.usecloudpress.com/">Cloudpress</a> that will allow users to publish content to their Content Management System from inside Google Docs. When a user publishes a document, the content is sent to Cloudpress where it will be processed by a background job (using <a href="https://www.hangfire.io/">Hangfire</a>).</p> <p>While the background job is being processed I want to give the user feedback on the progress, so I have implemented SignalR in the application for this purpose. I have implemented this using the same principles as I described previously in my <a href="https://www.jerriepelser.com/blog/communicate-status-background-job-signalr/">Communicate the status of a background job with SignalR</a> blog post.</p> <p>This is what it looks like in action:</p> <video class="mb-3">
<source src="https://d33wubrfki0l68.cloudfront.net/707a949bb9d57639a4c468989a5df5ea9b5ad86f/0d7f4/images/blog/2019-06-10-automatic-reconnects-signalr/screencast.mp4" type="video/mp4">
</video> <p>This works great, but every so often I would run into an issue with the SignalR connection dropping. When this happens, the user experience is really bad, since the status of the job will not update, and the user does not know what is happening. You can manually reconnect, but you need to be careful about it and take things like exponential back-off into account.</p> <p>I am aware that automatic reconnect is being added to SignalR in ASP.NET Core 3.0 and that the <a href="https://github.com/aspnet/AspNetCore/pull/8566">PR for it was already merged</a> a few months ago. So, I decided rather than creating my own retry mechanism, I would try and use the 3.0 preview JavaScript client with my ASP.NET 2.2 application.</p> <p>It turns out that for my limited use case, it works great. Let&#x2019;s see how we can configure it.</p> <h2 id="configuring-automatic-reconnects">Configuring automatic reconnects</h2> <p>Configuring automatic reconnects only requires a call to <code>withAutomaticReconnect</code> on the <code>HubConnectionBuilder</code>. Here is what my JavaScript code looks like for configuring my connection:</p>
<div class="highlight"><pre><code class="language-js"><span>connection</span> <span>=</span> <span>new</span> <span>signalR</span>.<span>HubConnectionBuilder</span>() .<span>withUrl</span>(<span>&quot;/publish-document-job-progress&quot;</span>) .<span>withAutomaticReconnect</span>() .<span>configureLogging</span>(<span>signalR</span>.<span>LogLevel</span>.<span>Information</span>) .<span>build</span>();
</code></pre></div>
<p>To try it out I ran the application and killed IIS after the SignalR connection was established. As you can see from the browser&#x2019;s console output, the connection is lost and SignalR tries to reconnect. Once I started IIS again, the connection was reestablished.</p> <p><img src="https://d33wubrfki0l68.cloudfront.net/f09e99f312e3fc6980e3ded043a91ba109b05f3d/fba95/images/blog/2019-06-10-automatic-reconnects-signalr/signalr-reconnect.png" alt="SignalR tries to reconnect using exponential back-off"></p> <p>You will notice in the screenshot above, that SignalR tried to reconnect as soon as the connection was lost. It could not reconnect at that time, so it tried again 2 seconds later at which time IIS was back up and the connection was reestablished.</p> <p>By default, SignalR will try and reconnect immediately, then 2 seconds later, then again after 10 seconds and then after 30 seconds. At that time, if the connection could still not be reestablished, it will stop trying to reconnect:</p> <p><img src="https://d33wubrfki0l68.cloudfront.net/e43074845725efcfe32fa9c959e28adbdcdee175/25730/images/blog/2019-06-10-automatic-reconnects-signalr/signalr-permanent-disconnect.png" alt="SignalR disconnects permanently after 5 tries"></p> <p>You can configure the backoff period by passing an array of retry delays to the call to <code>withAutomaticReconnect()</code>. The default for this is <code>[0, 2000, 10000, 30000, null]</code>. The <code>null</code> value tells SignalR to stop trying. So, for example, if I wanted it to retry at 0, 1 second and 5 seconds, I can configure my <code>HubConnectionBuilder</code> as follows:</p>
<div class="highlight"><pre><code class="language-js"><span>connection</span> <span>=</span> <span>new</span> <span>signalR</span>.<span>HubConnectionBuilder</span>() .<span>withUrl</span>(<span>&quot;/publish-document-job-progress&quot;</span>) .<span>withAutomaticReconnect</span>([<span>0</span>, <span>1000</span>, <span>5000</span>, <span>null</span>]) .<span>configureLogging</span>(<span>signalR</span>.<span>LogLevel</span>.<span>Information</span>) .<span>build</span>();
</code></pre></div>
<p>In my tests, it appears that it will stop retrying either when it runs out of retry delays in the array, or when it encounters a <code>null</code> value. So calling <code>withAutomaticReconnect([0, 1000, 5000, null])</code> or <code>withAutomaticReconnect([0, 1000, 5000,])</code> appears to have pretty much the same result.</p> <p>Looking at the TypeScript source code for <code>HubConnectionBuilder</code>, it seems <a href="https://github.com/aspnet/AspNetCore/blob/4683b077da3ae8ddfbe238b4bc23e186147d8f99/src/SignalR/clients/ts/signalr/src/HubConnectionBuilder.ts#L169">you can also pass a custom retry policy</a>. The signature for that method is</p>
<div class="highlight"><pre><code class="language-ts"><span>public</span> <span>withAutomaticReconnect</span>(<span>reconnectPolicy</span>: <span>IRetryPolicy</span>)<span>:</span> <span>HubConnectionBuilder</span>;</code></pre></div>
<p>Where <code>IRetryPolicy</code> is defined as</p>
<div class="highlight"><pre><code class="language-ts"><span>/** An abstraction that controls when the client attempts to reconnect and how many times it does so. */</span>
<span>export</span> <span>interface</span> <span>IRetryPolicy</span> { <span>/** Called after the transport loses the connection.
</span><span> *
</span><span> * @param {RetryContext} retryContext Details related to the retry event to help determine how long to wait for the next retry.
</span><span> *
</span><span> * @returns {number | null} The amount of time in milliseconds to wait before the next retry. `null` tells the client to stop retrying.
</span><span> */</span> <span>nextRetryDelayInMilliseconds</span>(<span>retryContext</span>: <span>RetryContext</span>)<span>:</span> <span>number</span> <span>|</span> <span>null</span>;
} <span>export</span> <span>interface</span> <span>RetryContext</span> { <span>/**
</span><span> * The number of consecutive failed tries so far.
</span><span> */</span> <span>readonly</span> <span>previousRetryCount</span>: <span>number</span>; <span>/**
</span><span> * The amount of time in milliseconds spent retrying so far.
</span><span> */</span> <span>readonly</span> <span>elapsedMilliseconds</span>: <span>number</span>; <span>/**
</span><span> * The error that forced the upcoming retry.
</span><span> */</span> <span>readonly</span> <span>retryReason</span>: <span>Error</span>;
}</code></pre></div>
<p>So, if you want to write retry logic with more complicated logic, you have that option at your disposal as well.</p> <p class="mt-2"> <strong>PS: </strong>I publish a weekly newsletter for ASP.NET Developers called <strong>ASP.NET Weekly</strong>. If you want to get an email every Friday with all the best ASP.NET related blog posts from the previous week, please <a href="https://www.getrevue.co/profile/aspnetweekly">sign up</a>! </p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>