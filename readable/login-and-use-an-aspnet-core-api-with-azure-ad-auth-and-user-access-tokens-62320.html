<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Login and use an ASP.NET Core API with Azure AD Auth and user access tokens - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Login and use an ASP.NET Core API with Azure AD Auth and user access tokens - linksfor.dev(s)"/>
    <meta property="article:author" content="damienbod"/>
    <meta property="og:description" content="In this blog post, Azure AD will be setup and used to authenticate and authorize an ASP.NET core Razor Page application which uses an API from a separate ASP.NET Core MVC project. User access token&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Login and use an ASP.NET Core API with Azure AD Auth and user access tokens</title>
<div class="readable">
        <h1>Login and use an ASP.NET Core API with Azure AD Auth and user access tokens</h1>
            <div>by damienbod</div>
            <div>Reading time: 11-13 minutes</div>
        <div>Posted here: 01 Jun 2020</div>
        <p><a href="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/">https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>

							<p>In this blog post, Azure AD will be setup and used to authenticate and authorize an ASP.NET core Razor Page application which uses an API from a separate ASP.NET Core MVC project. User access tokens are used to access to API, so that an email can be used in the API. The API is not dependent on the UI project as the access token comes straight from Azure AD token server. </p>
<p><strong>Code</strong>: <a href="https://github.com/damienbod/AzureAD-Auth-MyUI-with-MyAPI" rel="nofollow">https://github.com/damienbod/AzureAD-Auth-MyUI-with-MyAPI</a></p>
<p><strong>Setup the APP registrations in Azure</strong></p>
<p>Two Azure AD APP registrations can be created to configure this setup. One registration will be used for the Web API and a second registration is used for the UI application. In this post, the Azure portal is used to this up. The email claim will be added to the access token which is then used in the ASP.NET Core Web API.</p>
<p><strong>Setup the Web API APP registration</strong></p>
<p>In the Azure Active directory, click the <strong>App registrations</strong> and create a new registration using the <strong>New registration</strong> button.</p>
<p><img data-attachment-id="13823" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_01/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png" data-orig-size="1057,906" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=640&amp;h=549" alt="" width="640" height="549" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=640&amp;h=549 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=150&amp;h=129 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=600&amp;h=514 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=768&amp;h=658 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png?w=1024&amp;h=878 1024w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_01.png 1057w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Leave all the defaults and <strong>Register</strong>. We want to only use this inside our tenant.</p>
<p><img data-attachment-id="13824" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_02/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png" data-orig-size="1067,1109" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_02" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=577" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=640&amp;h=665" alt="" width="640" height="665" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=640&amp;h=665 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=144&amp;h=150 144w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=577&amp;h=600 577w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=768&amp;h=798 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png?w=985&amp;h=1024 985w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_02.png 1067w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Click the <strong>Expose an API</strong>, and add a new scope using <strong>Add a scope</strong>. We want to use the API for user access tokens.</p>
<p><img data-attachment-id="13825" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_03/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png" data-orig-size="1096,1104" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_03" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=596" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=640&amp;h=645" alt="" width="640" height="645" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=640&amp;h=645 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=150&amp;h=150 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=596&amp;h=600 596w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=768&amp;h=774 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png?w=1017&amp;h=1024 1017w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_03.png 1096w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>The Application ID URI needs to be created before the required scope can be added. <strong>Save and continue</strong>.</p>
<p><img data-attachment-id="13826" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_04/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png" data-orig-size="1237,1050" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_04" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=640&amp;h=543" alt="" width="640" height="543" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=640&amp;h=543 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=150&amp;h=127 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=600&amp;h=509 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=768&amp;h=652 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png?w=1024&amp;h=869 1024w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_04.png 1237w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Now add the <strong>access_as_user</strong> scope. set the <strong>Admins and users</strong>, add the required texts, and <strong>Add scope</strong>. This scope can be used as  “api://–clientId–/access_as_user”</p>
<p><img data-attachment-id="13827" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_05/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png" data-orig-size="1341,1046" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_05" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=640&amp;h=499" alt="" width="640" height="499" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=640&amp;h=499 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=1280&amp;h=998 1280w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=150&amp;h=117 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=600&amp;h=468 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=768&amp;h=599 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_05.png?w=1024&amp;h=799 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Now we need to add a permission so that the email claim can be added to the access token. Click the <strong>Add Permission</strong>.</p>
<p><img data-attachment-id="13828" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_06/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png" data-orig-size="1125,1029" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_06" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=640&amp;h=585" alt="" width="640" height="585" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=640&amp;h=585 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=150&amp;h=137 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=600&amp;h=549 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=768&amp;h=702 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png?w=1024&amp;h=937 1024w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_06.png 1125w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>From the <strong>Microsoft Graph</strong>, <strong>Delegated permissions</strong>, add the <strong>email </strong>permission. You can add whatever you require in the access token.</p>
<p><img data-attachment-id="13829" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_07/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png" data-orig-size="1234,1152" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_07" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=640&amp;h=597" alt="" width="640" height="597" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=640&amp;h=597 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=150&amp;h=140 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=600&amp;h=560 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=768&amp;h=717 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png?w=1024&amp;h=956 1024w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_07.png 1234w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>In the <strong>Token Configuration</strong> add the optional email claim to the access token.</p>
<p><img data-attachment-id="13835" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_08/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png" data-orig-size="1522,885" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_08" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=640&amp;h=372" alt="" width="640" height="372" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=640&amp;h=372 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=1280&amp;h=744 1280w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=150&amp;h=87 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=600&amp;h=349 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=768&amp;h=447 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_08.png?w=1024&amp;h=595 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Setup the UI APP registration</strong></p>
<p>Now that the Web API is setup, the user interface client APP registration can be created. An ASP.NET Core Razor Page application will be used and this will the access the API. This type of application requires the WEB setup.</p>
<p>Create a new registration for the UI. set the redirect URL to match your application. Click <strong>Register</strong></p>
<p><img data-attachment-id="13838" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_09/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png" data-orig-size="1069,1440" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_09" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=445" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=640&amp;h=862" alt="" width="640" height="862" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=640&amp;h=862 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=111&amp;h=150 111w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=445&amp;h=600 445w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=768&amp;h=1035 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png?w=760&amp;h=1024 760w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_09.png 1069w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>In the <strong>Authentication </strong>blade, define a <strong>Logout URL</strong> which matches your application and add support for <strong>ID Tokens</strong>.</p>
<p><img data-attachment-id="13839" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_10/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png" data-orig-size="1253,1022" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_10" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=640&amp;h=522" alt="" width="640" height="522" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=640&amp;h=522 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=150&amp;h=122 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=600&amp;h=489 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=768&amp;h=626 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png?w=1024&amp;h=835 1024w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_10.png 1253w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>In the API permissions add the API registration which was created above. This can be done in the <strong>API permissions</strong>, <strong>Add a permission</strong>, <strong>My APIs</strong> and add.</p>
<p><img data-attachment-id="13840" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_11/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png" data-orig-size="1670,1013" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_11" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=640&amp;h=388" alt="" width="640" height="388" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=640&amp;h=388 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=1280&amp;h=776 1280w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=150&amp;h=91 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=600&amp;h=364 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=768&amp;h=466 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_11.png?w=1024&amp;h=621 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>The ASP.NET Core application requires a secret to access the API. In <strong>Certificates &amp; secrets</strong>, create a new secret, and save this somewhere for later usage.</p>
<p><img data-attachment-id="13841" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_12/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png" data-orig-size="1237,1097" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_12" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=640&amp;h=568" alt="" width="640" height="568" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=640&amp;h=568 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=150&amp;h=133 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=600&amp;h=532 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=768&amp;h=681 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png?w=1024&amp;h=908 1024w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_12.png 1237w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Web API implementation</strong></p>
<p>The Web API can now be implemented using ASP.NET Core. An API project was created using the Visual Studio templates.</p>
<p>Now add the <a href="https://github.com/AzureAD/microsoft-identity-web">Microsoft.Identity.Web</a> Nuget package to the project. This will be used for the Azure AD auth.</p>
<p>Add the AzureAd configuration to the app.settings.json which must match the APP registration created above.</p>
<div><div id="highlighter_718632"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p></td><td><div><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>"AzureAd"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Domain"</code><code>: </code><code>"damienbodhotmail.onmicrosoft.com"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"TenantId"</code><code>: </code><code>"7ff95b15-dc21-4ba6-bc92-824856578fc1"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"ClientId"</code><code>: </code><code>"98328d53-55ec-4f14-8407-0ca5ff2f2d20"</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"Logging"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"LogLevel"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Default"</code><code>: </code><code>"Information"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Microsoft"</code><code>: </code><code>"Warning"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Microsoft.Hosting.Lifetime"</code><code>: </code><code>"Information"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"AllowedHosts"</code><code>: </code><code>"*"</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>In the Startup class, add the <strong>AddProtectedWebApi </strong>from the <strong>Microsoft.Identity.Web</strong> package to the ConfigureServices method. Then switch off the default ASP.NET Core claim mappings, and add an authorization policy to only allowed authorized requests and the access token must contain an email claim.</p>
<div><div id="highlighter_16754"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p></td><td><div><p><code>public</code> <code>void</code> <code>ConfigureServices(IServiceCollection services)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>JwtSecurityTokenHandler.DefaultInboundClaimTypeMap.Clear();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddProtectedWebApi(Configuration);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddControllers(options =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>policy = </code><code>new</code> <code>AuthorizationPolicyBuilder()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.RequireAuthenticatedUser()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.RequireClaim(</code><code>"email"</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.Build();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>options.Filters.Add(</code><code>new</code> <code>AuthorizeFilter(policy));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Add the <strong>UseAuthentication </strong>and the <strong>UseAuthorization </strong>middleware in the correct order.</p>
<div><div id="highlighter_943744"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></td><td><div><p><code>public</code> <code>void</code> <code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(env.IsDevelopment())</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseDeveloperExceptionPage();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseHttpsRedirection();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseRouting();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseAuthentication();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseAuthorization();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseEndpoints(endpoints =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>endpoints.MapControllers();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p><strong>Razor Page UI implementation</strong></p>
<p>The User interfaxe application is implemented using a ASP.NET Core razor page application. This again was created using the Visual Studio templates.<br>
Add the <strong>Microsoft.Identity.Web</strong> nuget package and also the <strong>Microsoft.Identity.Web.UI</strong> package to the UI project.</p>
<p>Add the AzureAd configuration to the app.settings.json and also the API url and the scope to use this. These settings must match what was configured in the portal for the UI registration.</p>
<div><div id="highlighter_45598"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p></td><td><div><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>"AzureAd"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Domain"</code><code>: </code><code>"damienbodhotmail.onmicrosoft.com"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"TenantId"</code><code>: </code><code>"7ff95b15-dc21-4ba6-bc92-824856578fc1"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"ClientId"</code><code>: </code><code>"64ecb044-417b-4892-83d4-5c03e8c977b9"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"CallbackPath"</code><code>: </code><code>"/signin-oidc"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"SignedOutCallbackPath "</code><code>: </code><code>"/signout-callback-oidc"</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"CallApi"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"ScopeForAccessToken"</code><code>: </code><code>"api://98328d53-55ec-4f14-8407-0ca5ff2f2d20/access_as_user"</code><code>,</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"Logging"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"LogLevel"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Default"</code><code>: </code><code>"Information"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Microsoft"</code><code>: </code><code>"Warning"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Microsoft.Hosting.Lifetime"</code><code>: </code><code>"Information"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"AllowedHosts"</code><code>: </code><code>"*"</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Add the secret to the project using the secrets manager. This is also added in the AzureAd Json object.</p>
<div><div id="highlighter_346481"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p></td><td><div><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>"AzureAd"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"ClientSecret"</code><code>: </code><code>"your secret.."</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Add an <strong>AddSignIn </strong>and an <strong>AddWebAppCallsProtectedWebApi </strong>method to login the UI in Azure, and to configure the API for use. Add the authorization as required for the UI app. The <strong>AddMicrosoftIdentityUI</strong> is required for the UI views.</p>
<div><div id="highlighter_311236"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p></td><td><div><p><code>public</code> <code>void</code> <code>ConfigureServices(IServiceCollection services)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddTransient&lt;ApiService&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddHttpClient();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddOptions();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddSignIn(Configuration);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddWebAppCallsProtectedWebApi(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Configuration, </code><code>new</code> <code>string</code><code>[] </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{ </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Configuration[</code><code>"CallApi:ScopeForAccessToken"</code><code>] </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}).AddInMemoryTokenCaches();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>services.AddRazorPages().AddMvcOptions(options =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>policy = </code><code>new</code> <code>AuthorizationPolicyBuilder()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.RequireAuthenticatedUser()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.Build();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>options.Filters.Add(</code><code>new</code> <code>AuthorizeFilter(policy));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}).AddMicrosoftIdentityUI();</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Add the <strong>UseAuthentication </strong>and the <strong>UseAuthorization </strong>middleware in the correct order.</p>
<div><div id="highlighter_463231"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></td><td><div><p><code>public</code> <code>void</code> <code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(env.IsDevelopment())</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseDeveloperExceptionPage();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>else</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseExceptionHandler(</code><code>"/Error"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseHsts();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseHttpsRedirection();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseStaticFiles();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseRouting();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseAuthentication();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseAuthorization();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>app.UseEndpoints(endpoints =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>endpoints.MapRazorPages();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>endpoints.MapControllers();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Implement the API service as required. The <strong>ITokenAcquisition </strong>interface is used to get the access token, so that the API can be used. The required scope for the API is read from the configuration.</p>
<div><div id="highlighter_98710"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p></td><td><div><p><code>using</code> <code>Microsoft.Extensions.Configuration;</code></p><p><code>using</code> <code>Microsoft.Identity.Web;</code></p><p><code>using</code> <code>Newtonsoft.Json.Linq;</code></p><p><code>using</code> <code>System;</code></p><p><code>using</code> <code>System.Net.Http;</code></p><p><code>using</code> <code>System.Net.Http.Headers;</code></p><p><code>using</code> <code>System.Threading.Tasks;</code></p><p><code>namespace</code> <code>MyServerRenderedPortal</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>class</code> <code>ApiService</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>IHttpClientFactory _clientFactory;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>ITokenAcquisition _tokenAcquisition;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>IConfiguration _configuration;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>ApiService(IHttpClientFactory clientFactory, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ITokenAcquisition tokenAcquisition, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>IConfiguration configuration)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_clientFactory = clientFactory;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_tokenAcquisition = tokenAcquisition;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_configuration = configuration;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>async</code> <code>Task&lt;JArray&gt; GetApiDataAsync()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>try</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>client = _clientFactory.CreateClient();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>scope = _configuration[</code><code>"CallApi:ScopeForAccessToken"</code><code>];</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>accessToken = </code><code>await</code> <code>_tokenAcquisition.GetAccessTokenForUserAsync(</code><code>new</code><code>[] { scope });</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>client.BaseAddress = </code><code>new</code> <code>Uri(_configuration[</code><code>"CallApi:ApiBaseAddress"</code><code>]);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>client.DefaultRequestHeaders.Authorization = </code><code>new</code> <code>AuthenticationHeaderValue(</code><code>"Bearer"</code><code>, accessToken);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>client.DefaultRequestHeaders.Accept.Add(</code><code>new</code> <code>MediaTypeWithQualityHeaderValue(</code><code>"application/json"</code><code>));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>response = </code><code>await</code> <code>client.GetAsync(</code><code>"weatherforecast"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(response.IsSuccessStatusCode)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>responseContent = </code><code>await</code> <code>response.Content.ReadAsStringAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>data = JArray.Parse(responseContent);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>data;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>throw</code> <code>new</code> <code>ApplicationException($</code><code>"Status code: {response.StatusCode}, Error: {response.ReasonPhrase}"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>catch</code> <code>(Exception e)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>throw</code> <code>new</code> <code>ApplicationException($</code><code>"Exception {e}"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Use the API service as required in the razor pages.</p>
<div><div id="highlighter_313700"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p></td><td><div><p><code>using</code> <code>Microsoft.AspNetCore.Mvc.RazorPages;</code></p><p><code>using</code> <code>Newtonsoft.Json.Linq;</code></p><p><code>using</code> <code>System.Threading.Tasks;</code></p><p><code>namespace</code> <code>MyServerRenderedPortal.Pages</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>class</code> <code>CallApiModel : PageModel</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>ApiService _apiService;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>JArray DataFromApi { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>CallApiModel(ApiService apiService)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_apiService = apiService;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>async</code> <code>Task OnGetAsync()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>DataFromApi = </code><code>await</code> <code>_apiService.GetApiDataAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The login and the logout need to be added for the application which uses the <strong>Microsoft.Identity.Web.UI</strong> package.</p>
<p>The _LoginPartial.cshtml can be implemented, and this uses the UI package which added the MicrosoftIdentity area and the view implementation.</p>
<div><div id="highlighter_930921"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></td><td><div><p><code>&lt;ul </code><code>class</code><code>=</code><code>"navbar-nav"</code><code>&gt;</code></p><p><code>@</code><code>if</code> <code>(User.Identity.IsAuthenticated)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;li </code><code>class</code><code>=</code><code>"nav-item"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;span </code><code>class</code><code>=</code><code>"navbar-text text-dark"</code><code>&gt;Hello @User.Identity.Name!&lt;/span&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;/li&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;li </code><code>class</code><code>=</code><code>"nav-item"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;a </code><code>class</code><code>=</code><code>"nav-link text-dark"</code> <code>asp-area=</code><code>"MicrosoftIdentity"</code> <code>asp-controller=</code><code>"Account"</code> <code>asp-action=</code><code>"SignOut"</code><code>&gt;Sign </code><code>out</code><code>&lt;/a&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;/li&gt;</code></p><p><code>}</code></p><p><code>else</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;li </code><code>class</code><code>=</code><code>"nav-item"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;a </code><code>class</code><code>=</code><code>"nav-link text-dark"</code> <code>asp-area=</code><code>"MicrosoftIdentity"</code> <code>asp-controller=</code><code>"Account"</code> <code>asp-action=</code><code>"SignIn"</code><code>&gt;Sign </code><code>in</code><code>&lt;/a&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;/li&gt;</code></p><p><code>}</code></p><p><code>&lt;/ul&gt;</code></p></div></td></tr></tbody></table></div></div>
<p>Now you can start both applications, and if everything is configured correctly, the UI project can login, and use the API in a secure way.</p>
<p><img data-attachment-id="13857" data-permalink="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/appregistrationsuiapi_13/" data-orig-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png" data-orig-size="1317,991" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="appRegistrationsUIApi_13" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=640" src="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=640&amp;h=482" alt="" width="640" height="482" srcset="https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=640&amp;h=482 640w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=1280&amp;h=964 1280w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=150&amp;h=113 150w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=600&amp;h=451 600w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=768&amp;h=578 768w, https://damienbod.files.wordpress.com/2020/05/appregistrationsuiapi_13.png?w=1024&amp;h=771 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Links</strong>:</p>
<p><a href="https://github.com/AzureAD/microsoft-identity-web" rel="nofollow">https://github.com/AzureAD/microsoft-identity-web</a></p>
<p><a href="https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2" rel="nofollow">https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2</a></p>
<p><a href="https://jwt.io/" rel="nofollow">https://jwt.io/</a></p>

							
							
						</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>