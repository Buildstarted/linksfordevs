<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Validating phone numbers with Twilio using ASP.NET Core Identity and Razor Pages - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Validating phone numbers with Twilio using ASP.NET Core Identity and Razor Pages - linksfor.dev(s)"/>
    <meta property="og:description" content="In this post I show how to add phone number validation with Twilio&#x27;s Lookup API to a Razor Pages app that uses ASP.NET Core Identity for user management"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://andrewlock.net/validating-phone-numbers-with-twilio-using-asp-net-core-identity-and-razor-pages/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Validating phone numbers with Twilio using ASP.NET Core Identity and Razor Pages</title>
<div class="readable">
        <h1>Validating phone numbers with Twilio using ASP.NET Core Identity and Razor Pages</h1>
            <div>Reading time: 24-31 minutes</div>
        <div>Posted here: 30 Apr 2019</div>
        <p><a href="https://andrewlock.net/validating-phone-numbers-with-twilio-using-asp-net-core-identity-and-razor-pages/">https://andrewlock.net/validating-phone-numbers-with-twilio-using-asp-net-core-identity-and-razor-pages/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
<p>ASP.NET Core Identity is a membership system that adds login and user functionality to ASP.NET Core apps. It includes many features out of the box and has basic support for storing a phone number for a user. You can improve the robustness of ASP.NET Core’s phone number validation and provide a better user experience by integrating Twilio’s telephony features in your application.</p>
<p>By default the phone number in <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity">ASP.NET Core Identity</a> is validated <a href="https://docs.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.phoneattribute">with a regular expression</a>, but that's too basic to confirm whether the number is <em>really</em> valid, whether it includes the country dialling code, or whether it can receive SMS messages. You could implement improved validation using the library <a href="https://github.com/twcclegg/libphonenumber-csharp">libphonenumber-csharp</a>, as described in <a href="https://www.twilio.com/blog/validating-phone-numbers-effectively-with-c-and-the-net-frameworks">a previous Twilio blog post</a>. Alternatively you could use various Twilio APIs to thoroughly validate the phone number, lookup details about the number (such as carrier or type), and prove ownership of the phone with a text or voice verification message. </p>
<p>Multiple stages of validation are required to determine if a phone number can be associated with an application user for a specific purpose, but I'll only be looking at the first step in this post: ensuring a number is valid for a specific country and determining if it is likely to be able to receive text messages. <a href="https://www.twilio.com/docs/lookup/api">Twilio's Lookup API</a> can provide this functionality in a Razor Pages app that uses ASP.NET Core Identity for user management.</p>
<h2 id="prerequisites">Prerequisites<a href="#prerequisites"></a></h2>
<p>To follow along with this post you'll need </p>
<ul>
<li>A Twilio account (<a href="https://www.twilio.com/try-twilio">sign up for a free Twilio account here</a>)</li>
<li>.NET Core 2.2 SDK (<a href="https://dotnet.microsoft.com/download">version 2.2.102 or greater</a>)</li>
<li><a href="https://code.visualstudio.com/">VS Code</a>, <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 2017</a>, or other editor</li>
<li>A familiarity with Razor Pages (see my previous post for <a href="https://www.twilio.com/blog/introduction-asp-net-core-razor-pages">an introduction to Razor Pages</a>)</li>
</ul>
<p>You can find the complete code for this post <a href="https://github.com/andrewlock/TwilioSamples/tree/master/src/ValidatePhoneNumberDemo">on GitHub</a>.</p>
<h2 id="data-validation-in-asp-net-core-razor-pages">Data validation in ASP.NET Core Razor Pages<a href="#data-validation-in-asp-net-core-razor-pages"></a></h2>
<p>Razor Pages is a new aspect of ASP.NET Core MVC that was introduced in ASP.NET Core 2.0. It's very similar to the traditional Model-View-controller (MVC) pattern commonly used in ASP.NET Core, but uses a "page-based" approach. See <a href="https://www.twilio.com/blog/introduction-asp-net-core-razor-pages">my previous post</a> for an introduction on Razor Pages, and how they differ from ASP.NET Core MVC.</p>
<p>Razor Pages uses the same model binding and model validation processes as MVC, but applies them to a "Page Model" instead of action method parameters. For example, <code>[Required]</code>, and <code>[EmailAddress]</code> are validation attributes that check the value of the <code>InputModel.Email</code> property is correct.</p>
<pre><code><span>public</span> <span>partial</span> <span>class</span> <span>IndexModel</span> <span>:</span> <span>PageModel</span>
<span>{</span>
    <span>[</span><span>BindProperty</span><span>]</span>
    <span>public</span> <span>InputModel</span> Input <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>class</span> <span>InputModel</span>
    <span>{</span>
        <span>[</span><span>Required</span><span>]</span>
        <span>[</span><span>EmailAddress</span><span>]</span>
        <span>public</span> <span>string</span> Email <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>These attributes are found in the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations">System.ComponentModel.DataAnnotations</a> namespace, which includes a <code>[Phone]</code> attribute for validating phone numbers. Unfortunately, this attribute is simplistic and doesn't take into account the highly complex set of <a href="https://github.com/googlei18n/libphonenumber/blob/master/FALSEHOODS.md">rules and exceptions</a> that apply to phone numbers. </p>
<p>For better validation you could use the open source library that Google created and uses for validating phone numbers: <a href="https://github.com/googlei18n/libphonenumber">libphonenumber</a>. There's a C# port of the library, <a href="https://github.com/twcclegg/libphonenumber-csharp">libphonenumber-csharp</a>, that you can install in your application using <a href="https://www.nuget.org/packages/libphonenumber-csharp">the NuGet package</a>. <a href="https://www.twilio.com/blog/validating-phone-numbers-effectively-with-c-and-the-net-frameworks">This post on the Twilio blog shows how to use it in your applications</a>. </p>
<p>Alternatively, you could use the <a href="https://www.twilio.com/docs/lookup/api">Twilio Lookup API</a> to validate phone numbers. This uses the same libphonenumber validation library behind the scenes, but it can also provide extra details such as carrier information (in the US), the type of the phone number (landline/mobile/VOIP), or details of suspected fraud associated with the number.</p>
<p>In this post I'll show how you can use the Twilio Lookup API in a new Razor Pages app to validate the optional phone number provided by users. We'll validate that the number the user entered is valid for their selected country, that it can likely receive SMS messages, and, if so, we'll save the number in <a href="https://www.twilio.com/docs/glossary/what-e164">the standard E.164 format</a>. </p>
<h2 id="customizing-asp-net-core-identity-razor-pages">Customizing ASP.NET Core Identity Razor Pages<a href="#customizing-asp-net-core-identity-razor-pages"></a></h2>
<p>In older versions of ASP.NET Core, creating a new MVC or Razor Pages app using the ASP.NET Core Identity templates would dump thousands of lines of code into your app. That changed in ASP.NET Core 2.1 with the introduction of <a href="https://docs.microsoft.com/en-us/aspnet/core/razor-pages/ui-class">Razor Class Libraries</a>.</p>
<p>Razor Class Libraries allow you to bundle views, Razor Pages, and View Components into a NuGet package. To include the UI elements in an app, you simply reference the NuGet package. All of the Razor Pages from the library will then be available in your app with no additional work required on your side.</p>
<p>This is how ASP.NET Core Identity ships now. When you create a new ASP.NET Core app with Identity, your project directory will be virtually empty instead of having thousands of files. That's generally a good thing—you don't have to manage the infrastructure code or keep it up to date. </p>
<p>The obvious downside is that if you want to customize the default experience, for example to improve phone validation like we are, you can't just start updating the code. Luckily, Razor Class Libraries let you override any of the included views or Razor Pages by placing a Page at the same <em>path</em> in your application.</p>
<p>ASP.NET Core provides tools for scaffolding these "override" files for ASP.NET Core Identity. The Identity scaffolder <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/scaffold-identity?view=aspnetcore-2.2&amp;tabs=visual-studio">is built into Visual Studio 2017</a>, or there is a cross-platform global tool <code>dotnet-aspnet-codegenerator</code> you can run from the command line. I'll show how to use the global tool to scaffold the <code>/Identity/Account/Manage</code> page that we need to customize. </p>
<h2 id="creating-the-case-study-project">Creating the case study project<a href="#creating-the-case-study-project"></a></h2>
<p>Using Visual Studio 2017+ or the .NET CLI, create a new solution and project with the following characteristics: </p>
<ul>
<li>Type: ASP.NET Core 2.2 Web Application (not MVC) with Visual C#</li>
<li>Name: ValidatePhoneNumberDemo</li>
<li>Solution directory</li>
<li>Git repository</li>
<li>https</li>
<li>Authentication: Individual user accounts, Store user accounts in-app</li>
</ul>
<p>ASP.NET Core Identity uses Entity Framework Core to store the users in the database, so be sure to run the database migrations after building your app:</p>
<pre><code>dotnet ef database update
</code></pre>
<h3 id="using-the-net-cli-to-scaffold-identity-pages">Using the .NET CLI to scaffold Identity pages<a href="#using-the-net-cli-to-scaffold-identity-pages"></a></h3>
<p>Install the <code>aspnet-codegenerator</code> <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/global-tools">global tool</a>. Note that there <a href="https://github.com/dotnet/cli/issues/10459">is a bug in the latest version of the tool at the time of writing (2.2.0)</a>, so the following installs the last known good version (2.1.6). </p>
<pre><code>dotnet tool <span>install</span> -g dotnet-aspnet-codegenerator --version 2.1.6
</code></pre>
<p>The Microsoft.VisualStudio.Web.CodeGeneration.Design NuGet is required by the <code>aspnet-codegenerator</code> global tool so, install it in to into your project using the NuGet Package Manager, Package Manager Console CLI, or by editing the the <em>ValidatePhoneNumberDemo.csproj</em> file. Be sure to set the <code>PrivateAssets</code> attribute to <code>All</code>, so that the package is used only during development.</p>
<pre><code><span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Microsoft.VisualStudio.Web.CodeGeneration.Design<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>2.2.1<span>"</span></span> <span>PrivateAssets</span><span><span>=</span><span>"</span>All<span>"</span></span> <span>/&gt;</span></span>
</code></pre>
<p>Open a console window inside your app's <em>project</em> folder (not the <em>solution</em> folder). Run the scaffolding tool to generate the <code>Account.Manage.Index</code> Razor Page. As well as listing the files to generate, you need to specify the full name of the EF Core DB Context for your project.</p>
<pre><code>dotnet aspnet-codegenerator identity --files Account.Manage.Index -dc ValidatePhoneNumberDemo.Data.ApplicationDbContext 
</code></pre>
<p>The scaffolder should complete in a few seconds, and afterwards you'll see new files in your project. The scaffolder generates the requested file, plus layout view files and partials. </p>
<p><img src="https://andrewlock.net/content/images/2019/razor_identity_1.png" alt="Image of files generated using the scaffolder"></p>
<p>You can view a list of all possible pages to generate using <code>dotnet aspnet-codegenerator identity --listFiles</code>. </p>
<p>Once your app is running, explore the existing phone number validation for users in ASP.NET Core Identity</p>
<ul>
<li>Register a new user by clicking <strong>Register</strong> from the menu bar</li>
<li>Enter an email and password</li>
<li>Click <strong>Hello &lt;email&gt;!</strong> from the menu bar to see the profile/manage account page, or navigate to <code>/Account/Manage</code></li>
<li>Try saving various phone numbers to see what's valid. Hint: <code>0</code> is apparently a valid phone number!</li>
</ul>
<h2 id="initializing-the-twilio-api">Initializing the Twilio API<a href="#initializing-the-twilio-api"></a></h2>
<p>We'll be using the Twilio helper library to simplify calling the Twilio HTTP API. Install the Twilio NuGet package (version 5.22.0 or later) using the NuGet Package Manager, Package Manager Console CLI, or by editing the <em>ValidatePhoneNumberDemo.csproj</em> file. After using any of these methods the <code>&lt;ItemGroup&gt;</code> section of the project file should look like this (version numbers may be higher):</p>
<pre><code><span><span><span>&lt;</span>ItemGroup</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Microsoft.AspNetCore.App<span>"</span></span><span>/&gt;</span></span>
  <span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Microsoft.AspNetCore.Razor.Design<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>2.2.0<span>"</span></span> <span>PrivateAssets</span><span><span>=</span><span>"</span>All<span>"</span></span> <span>/&gt;</span></span>
  <span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Microsoft.VisualStudio.Web.CodeGeneration.Design<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>2.2.1<span>"</span></span> <span>PrivateAssets</span><span><span>=</span><span>"</span>All<span>"</span></span> <span>/&gt;</span></span>
  <span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>Twilio<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>5.22.0<span>"</span></span> <span>/&gt;</span></span>
<span><span><span>&lt;/</span>ItemGroup</span><span>&gt;</span></span>
</code></pre>
<p>To call the Twilio API you'll need your Twilio Account Sid and Auth Token (found in the <a href="https://www.twilio.com/console">Twilio Dashboard</a>). When developing locally these should be stored using the Secrets Manager so they don't get accidentally committed to your source code repository. You can read about how and why to do that in <a href="https://www.twilio.com/blog/2018/05/user-secrets-in-a-net-core-web-app.html">this post on the Twilio Blog</a>. Your resulting <em>Secrets.json</em> should look something like this:</p>
<pre><code><span>"TwilioAccountDetails"</span><span>:</span> <span>{</span>
  <span>"AccountSID"</span><span>:</span> <span>"ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span><span>,</span>
  <span>"AuthToken"</span><span>:</span> <span>"your_auth_token"</span>
<span>}</span>
</code></pre>
<p>The Twilio helper libraries use a singleton instance of the Twilio client, which means you only need to set it up once in your app. The best place to configure things like this are in the <em>Startup.cs</em> file. Add <code>using Twilio;</code> at the top of <em>Startup.cs</em>, and add the following at the end of <code>ConfigureServices</code>:</p>
<pre><code><span>public</span> <span>void</span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    

    <span>var</span> accountSid <span>=</span> Configuration<span>[</span><span>"TwilioAccountDetails:AccountSID"</span><span>]</span><span>;</span>
    <span>var</span> authToken <span>=</span> Configuration<span>[</span><span>"TwilioAccountDetails:AuthToken"</span><span>]</span><span>;</span>
    TwilioClient<span>.</span><span>Init</span><span>(</span>accountSid<span>,</span> authToken<span>)</span><span>;</span>
<span>}</span>
</code></pre>
<p>This sets up the static Twilio client using your credentials using <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration">the ASP.NET Core configuration system</a>. If you need to customize the requests made to Twilio (e.g. using a proxy server), or want to make use of <code>HttpClientFactory</code> features introduced in ASP.NET Core 2.1, see <a href="https://www.twilio.com/blog/dependency-injection-twilio-sms-asp-net-core-2-1">my previous post on the Twilio blog</a> for an alternative approach.</p>
<h2 id="an-inconvenient-truth-phone-numbers-are-hard">An inconvenient truth: phone numbers are hard<a href="#an-inconvenient-truth-phone-numbers-are-hard"></a></h2>
<p>As any developer who has had the (dis-)pleasure of working with time zones will know; time zones are hard. Unfortunately, phone numbers are hard too! There's a great number of misconceptions that developers have to tackle when they really start working with phone numbers. This document from the libphonenumber library on <a href="https://github.com/googlei18n/libphonenumber/blob/master/FALSEHOODS.md">Falsehoods Programmers Believe About Phone Numbers</a> is a great introduction.</p>
<p>One such problem is that different countries have different rules about what constitutes a valid phone number. So to unambiguously validate a phone number you need to know the <em>country</em> in which it was issued. See the falsehoods document linked above for some examples of why that's necessary.</p>
<p>In order to correctly validate the provided phone number, we need users to choose the issuing country at the same time. That means when we validate the phone number with Twilio we can include the 2-digit ISO 3166 country code, and confirm whether the phone number is valid <em>specifically</em> for that country. </p>
<h2 id="adding-a-country-code-dropdown">Adding a country code dropdown<a href="#adding-a-country-code-dropdown"></a></h2>
<p>We'll add a dropdown of countries to the ASP.NET Core Identity management page to make it easy for users to choose the appropriate country code. </p>
<p>To build the dropdown, we'll load this list of countries from a JSON file <em>countries.json</em> stored in the project folder. A snippet of the file is shown below; you can find a complete file in the sample <a href="https://github.com/andrewlock/TwilioSamples/blob/master/src/ValidatePhoneNumberDemo/countries.json">here</a>.</p>
<p>Ellipsis (“<code>...</code>”) in code blocks represents a section redacted for brevity.</p>
<pre><code><span>[</span>
    <span>{</span>
        <span>"Text"</span><span>:</span> <span>"United States of America"</span><span>,</span>
        <span>"Value"</span><span>:</span> <span>"US"</span>
    <span>}</span><span>,</span>
    <span>{</span>
        <span>"Text"</span><span>:</span> <span>"United Kingdom of Great Britain and Northern Ireland"</span><span>,</span>
        <span>"Value"</span><span>:</span> <span>"GB"</span>
    <span>}</span><span>,</span>
    <span>{</span>
        <span>"Text"</span><span>:</span> <span>"Canada"</span><span>,</span>
        <span>"Value"</span><span>:</span> <span>"CA"</span>
    <span>}</span><span>,</span>
...
<span>]</span>
</code></pre>
<p>Next, we'll create a service to load the JSON file, and convert it into a <code>List&lt;SelectListItem&gt;</code>. Create the <em>CountryService.cs</em> file in the root of your project and add the following code:</p>
<pre><code><span>using</span> System<span>;</span>
<span>using</span> System<span>.</span>Collections<span>.</span>Generic<span>;</span>
<span>using</span> System<span>.</span>IO<span>;</span>
<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>Hosting<span>;</span>
<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>Mvc<span>.</span>Rendering<span>;</span>
<span>using</span> Newtonsoft<span>.</span>Json<span>;</span>

<span>namespace</span> ValidatePhoneNumberDemo
<span>{</span>
    <span>public</span> <span>class</span> <span>CountryService</span>
    <span>{</span>
        <span>private</span> <span>readonly</span> <span>IHostingEnvironment</span> _environment<span>;</span>
        <span>private</span> <span>readonly</span> Lazy<span>&lt;</span>List<span>&lt;</span>SelectListItem<span>&gt;</span><span>&gt;</span> _countries<span>;</span>

        <span>public</span> <span>CountryService</span><span>(</span><span>IHostingEnvironment</span> environment<span>)</span>
        <span>{</span>
            _environment <span>=</span> environment<span>;</span>
            _countries <span>=</span> <span>new</span> <span>Lazy</span><span>&lt;</span>List<span>&lt;</span>SelectListItem<span>&gt;</span><span>&gt;</span><span>(</span>LoadCountries<span>)</span><span>;</span>
        <span>}</span>

        <span>public</span> List<span>&lt;</span>SelectListItem<span>&gt;</span> <span>GetCountries</span><span>(</span><span>)</span>
        <span>{</span>
            <span>return</span> _countries<span>.</span>Value<span>;</span>
        <span>}</span>

        <span>private</span> List<span>&lt;</span>SelectListItem<span>&gt;</span> <span>LoadCountries</span><span>(</span><span>)</span>
        <span>{</span>
            <span>var</span> fileInfo <span>=</span> _environment<span>.</span>ContentRootFileProvider<span>.</span><span>GetFileInfo</span><span>(</span><span>"countries.json"</span><span>)</span><span>;</span>

            <span>using</span> <span>(</span><span>var</span> stream <span>=</span> fileInfo<span>.</span><span>CreateReadStream</span><span>(</span><span>)</span><span>)</span>
            <span>using</span> <span>(</span><span>var</span> streamReader <span>=</span> <span>new</span> <span>StreamReader</span><span>(</span>stream<span>)</span><span>)</span>
            <span>using</span> <span>(</span><span>var</span> jsonTextReader <span>=</span> <span>new</span> <span>JsonTextReader</span><span>(</span>streamReader<span>)</span><span>)</span>
            <span>{</span>
                <span>var</span> serializer <span>=</span> <span>new</span> <span>JsonSerializer</span><span>(</span><span>)</span><span>;</span>
                <span>return</span> serializer<span>.</span>Deserialize<span>&lt;</span>List<span>&lt;</span>SelectListItem<span>&gt;</span><span>&gt;</span><span>(</span>jsonTextReader<span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>This service uses <code>Lazy&lt;&gt;</code> to provide <a href="https://docs.microsoft.com/en-us/dotnet/framework/performance/lazy-initialization">lazy initialization</a>, an optimization that only loads the countries from the JSON file once, when they’re needed, in a thread-safe manner. It also uses the <a href="https://www.newtonsoft.com/json/help/html/Performance.htm">streaming support of Newtonsoft.Json</a> to deserialize the contents directly to a <code>List&lt;SelectListItem&gt;</code>, instead of loading it as a <code>string</code> first. The deserialized list of countries is exposed via the <code>GetCountries()</code> method.</p>
<p>In order to use the <code>CountryService</code> you must register it with the app's <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection">dependency injection (DI) container</a>. Open up <em>Startup.cs</em> and add the following line at the end of the <code>ConfigureServices</code> method:</p>
<pre><code>services<span>.</span><span><span>AddSingleton</span><span>&lt;</span><span>CountryService</span><span>&gt;</span></span><span>(</span><span>)</span><span>;</span>
</code></pre>
<p>This registers the service with the DI container as a singleton so we can inject it into our Razor Page. Open the code behind for the account management Razor Page at <em>Areas\Identity\Pages\Account\Manage\Index.cshtml.cs</em>, add <code>using Microsoft.AspNetCore.Mvc.Rendering;</code> at the top of the file, and inject an instance of <code>CountryService</code> into the constructor. Create a new property <code>AvailableCountries</code> on your page model and use the injected <code>CountryService</code> to assign the list of countries. Note that if you're using Visual Studio, you need to expand the <em>Index.cshtml</em> file node in Solution Explorer to see the code-behind file, <em>Index.cshtml.cs</em>.</p>
<pre><code><span>namespace</span> ValidatePhoneNumberDemo<span>.</span>Areas<span>.</span>Identity<span>.</span>Pages<span>.</span>Account<span>.</span>Manage
<span>{</span>
    <span>public</span> <span>partial</span> <span>class</span> <span>IndexModel</span> <span>:</span> <span>PageModel</span>
    <span>{</span>
        <span>public</span> <span>IndexModel</span><span>(</span>
            UserManager<span>&lt;</span>IdentityUser<span>&gt;</span> userManager<span>,</span>
            SignInManager<span>&lt;</span>IdentityUser<span>&gt;</span> signInManager<span>,</span>
            <span>IEmailSender</span> emailSender<span>,</span>
            <span>CountryService</span> countryService<span>)</span>
        <span>{</span>
            _userManager <span>=</span> userManager<span>;</span>
            _signInManager <span>=</span> signInManager<span>;</span>
            _emailSender <span>=</span> emailSender<span>;</span>
            
            AvailableCountries <span>=</span> countryService<span>.</span><span>GetCountries</span><span>(</span><span>)</span><span>;</span>
        <span>}</span>

        <span>public</span> List<span>&lt;</span>SelectListItem<span>&gt;</span> AvailableCountries <span>{</span> <span>get</span><span>;</span> <span>}</span>
        <span>.</span><span>.</span><span>.</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>Our page model now has the list of available countries so we can populate the dropdown, but we also need somewhere to store the user's selection. Update the nested <code>InputModel</code> and add the <code>PhoneNumberCountryCode</code> property:</p>
<pre><code><span>namespace</span> ValidatePhoneNumberDemo<span>.</span>Areas<span>.</span>Identity<span>.</span>Pages<span>.</span>Account<span>.</span>Manage
<span>{</span>
    <span>public</span> <span>partial</span> <span>class</span> <span>IndexModel</span> <span>:</span> <span>PageModel</span>
    <span>{</span>
        <span>public</span> <span>class</span> <span>InputModel</span>
        <span>{</span>
            <span>[</span><span>Required</span><span>]</span>
            <span>[</span><span>EmailAddress</span><span>]</span>
            <span>public</span> <span>string</span> Email <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

            <span>[</span><span>Phone</span><span>]</span>
            <span>[</span><span>Display</span><span>(</span>Name <span>=</span> <span>"Phone number"</span><span>)</span><span>]</span>
            <span>public</span> <span>string</span> PhoneNumber <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

            
            <span>[</span><span>Display</span><span>(</span>Name <span>=</span> <span>"Phone number country"</span><span>)</span><span>]</span>
            <span>public</span> <span>string</span> PhoneNumberCountryCode <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>Finally, add the following Razor to <em>Areas\Identity\Pages\Account\Manage\Index.cshtml</em>, just above the Razor code for the phone number input.</p>
<pre><code><span><span><span>&lt;</span>div</span> <span>class</span><span><span>=</span><span>"</span>form-group<span>"</span></span><span>&gt;</span></span>
    <span><span><span>&lt;</span>label</span> <span>asp-for</span><span><span>=</span><span>"</span>Input.PhoneNumberCountryCode<span>"</span></span><span>&gt;</span></span><span><span><span>&lt;/</span>label</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>select</span> <span>asp-for</span><span><span>=</span><span>"</span>Input.PhoneNumberCountryCode<span>"</span></span> <span>asp-items</span><span><span>=</span><span>"</span>Model.AvailableCountries<span>"</span></span> <span>class</span><span><span>=</span><span>"</span>form-control<span>"</span></span><span>&gt;</span></span><span><span><span>&lt;/</span>select</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>span</span> <span>asp-validation-for</span><span><span>=</span><span>"</span>Input.PhoneNumberCountryCode<span>"</span></span> <span>class</span><span><span>=</span><span>"</span>text-danger<span>"</span></span><span>&gt;</span></span><span><span><span>&lt;/</span>span</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
</code></pre>
<p>This Razor uses the <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/views/working-with-forms#the-select-tag-helper">Select Tag Helper</a> to generate a <code>&lt;select&gt;</code> element populated with the values in the <code>AvailableCountries</code> property, which binds to the <code>Input.PhoneNumberCountryCode</code> property on form POST. If you run your app now and navigate to the account management page, you should see the country dropdown displayed above the phone number option.</p>
<p><img src="https://andrewlock.net/content/images/2019/razor_identity.png" alt="Phone number country code dropdown"></p>
<p>In this example, we don't have a "none" or "unselected" option in the <code>&lt;select&gt;</code> element. Consequently, the first item is selected and sent back to the user. That's OK for our purposes, but a more comprehensive approach might be to select the default country based on the user's location.</p>
<h2 id="adding-phone-number-validation-using-the-twilio-lookup-api">Adding phone number validation using the Twilio Lookup API<a href="#adding-phone-number-validation-using-the-twilio-lookup-api"></a></h2>
<p>At this point we have everything in place to add our extra validation; we have the Twilio client configured, the <code>CountryService</code> loading our list of country codes, and our dropdown for the user to select their country. Now we'll add the validation call to the Twilio API. </p>
<p>Open <em>Index.chstml.cs</em> and add the following namespace <code>using</code> statements:</p>
<pre><code><span>using</span> Twilio<span>.</span>Exceptions<span>;</span>
<span>using</span> Twilio<span>.</span>Rest<span>.</span>Lookups<span>.</span>V1<span>;</span>
</code></pre>
<p>Now replace the following code found inside <code>OnPostAsync</code>:</p>
<pre><code><span>.</span><span>.</span><span>.</span>
<span>var</span> phoneNumber <span>=</span> <span>await</span> _userManager<span>.</span><span>GetPhoneNumberAsync</span><span>(</span>user<span>)</span><span>;</span>
<span>if</span> <span>(</span>Input<span>.</span>PhoneNumber <span>!=</span> phoneNumber<span>)</span>
<span>{</span>
    <span>var</span> setPhoneResult <span>=</span> <span>await</span> _userManager<span>.</span><span>SetPhoneNumberAsync</span><span>(</span>user<span>,</span> Input<span>.</span>PhoneNumber<span>)</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span>setPhoneResult<span>.</span>Succeeded<span>)</span>
    <span>{</span>
        <span>var</span> userId <span>=</span> <span>await</span> _userManager<span>.</span><span>GetUserIdAsync</span><span>(</span>user<span>)</span><span>;</span>
        <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span>$<span>"Unexpected error occurred setting phone number for user with ID '{userId}'."</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
<span>.</span><span>.</span><span>.</span>
</code></pre>
<p>with our updated validation code. Take care to preserve the code both above and below the snippet that you're replacing:</p>
<pre><code><span>.</span><span>.</span><span>.</span>
<span>var</span> phoneNumber <span>=</span> <span>await</span> _userManager<span>.</span><span>GetPhoneNumberAsync</span><span>(</span>user<span>)</span><span>;</span>
<span>if</span> <span>(</span>Input<span>.</span>PhoneNumber <span>!=</span> phoneNumber<span>)</span>
<span>{</span>
    <span>try</span>
    <span>{</span>
        <span>var</span> numberDetails <span>=</span> <span>await</span> PhoneNumberResource<span>.</span><span>FetchAsync</span><span>(</span>
            pathPhoneNumber<span>:</span> <span>new</span> <span>Twilio<span>.</span>Types<span>.</span>PhoneNumber</span><span>(</span>Input<span>.</span>PhoneNumber<span>)</span><span>,</span>
            countryCode<span>:</span> Input<span>.</span>PhoneNumberCountryCode<span>,</span>
            type<span>:</span> <span>new</span> <span>List</span><span>&lt;</span><span>string</span><span>&gt;</span> <span>{</span> <span>"carrier"</span> <span>}</span><span>)</span><span>;</span>

        
        <span>var</span> phoneNumberType <span>=</span> numberDetails<span>.</span><span>GetPhoneNumberType</span><span>(</span><span>)</span><span>;</span>
        <span>if</span> <span>(</span>phoneNumberType <span>!=</span> <span>null</span> 
            <span>&amp;&amp;</span> phoneNumberType <span>==</span> PhoneNumberResource<span>.</span>TypeEnum<span>.</span>Landline<span>)</span>
        <span>{</span>
            ModelState<span>.</span><span>AddModelError</span><span>(</span>$<span>"{nameof(Input)}.{nameof(Input.PhoneNumber)}"</span><span>,</span>
                $<span>"The number you entered does not appear to be capable of receiving SMS ({phoneNumberType}). Please enter a different value and try again"</span><span>)</span><span>;</span>
            <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
        <span>}</span>

        <span>var</span> numberToSave <span>=</span> numberDetails<span>.</span>PhoneNumber<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>
        <span>var</span> setPhoneResult <span>=</span> <span>await</span> _userManager<span>.</span><span>SetPhoneNumberAsync</span><span>(</span>user<span>,</span> numberToSave<span>)</span><span>;</span>
        <span>if</span> <span>(</span><span>!</span>setPhoneResult<span>.</span>Succeeded<span>)</span>
        <span>{</span>
            <span>var</span> userId <span>=</span> <span>await</span> _userManager<span>.</span><span>GetUserIdAsync</span><span>(</span>user<span>)</span><span>;</span>
            <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span>$<span>"Unexpected error occurred setting phone number for user with ID '{userId}'."</span><span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>
    <span>catch</span> <span>(</span><span>ApiException</span> ex<span>)</span>
    <span>{</span>
        ModelState<span>.</span><span>AddModelError</span><span>(</span>$<span>"{nameof(Input)}.{nameof(Input.PhoneNumber)}"</span><span>,</span>
            $<span>"The number you entered was not valid (Twilio code {ex.Code}), please check it and try again"</span><span>)</span><span>;</span>
        <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
<span>.</span><span>.</span><span>.</span>
</code></pre>
<p>That's a lot of code to digest, so I'll walk through it below. </p>
<p>Before we do anything with the phone number, we load the existing number for the Identity user and check whether it's changed. If the number hasn't changed, there's no need to validate it, call the Twilio API, or update the value. </p>
<pre><code><span>var</span> phoneNumber <span>=</span> <span>await</span> _userManager<span>.</span><span>GetPhoneNumberAsync</span><span>(</span>user<span>)</span><span>;</span>
<span>if</span> <span>(</span>Input<span>.</span>PhoneNumber <span>!=</span> phoneNumber<span>)</span>
<span>{</span>
    
<span>}</span>
</code></pre>
<p>If the number <em>has</em> changed, we need to validate the value using <a href="https://www.twilio.com/docs/lookup/api">the Twilio Lookup API</a>. We use the <code>PhoneNumberResource</code> helper to make an asynchronous call to the Twilio API, passing in the <code>PhoneNumber</code> and <code>PhoneNumberCountryCode</code> from the <code>InputModel</code>. We wrap the call in a <code>try</code>-<code>catch</code> block, as it will throw an exception if it's invalid. In that case we display a generic error and redisplay the form. You could also log the exception, but be wary of storing personally identifiable information (PII) in log messages. </p>
<pre><code><span>try</span>
<span>{</span>
    <span>var</span> numberDetails <span>=</span> <span>await</span> PhoneNumberResource<span>.</span><span>FetchAsync</span><span>(</span>
        pathPhoneNumber<span>:</span> <span>new</span> <span>Twilio<span>.</span>Types<span>.</span>PhoneNumber</span><span>(</span>Input<span>.</span>PhoneNumber<span>)</span><span>,</span>
        countryCode<span>:</span> Input<span>.</span>PhoneNumberCountryCode<span>,</span>
        type<span>:</span> <span>new</span> <span>List</span><span>&lt;</span><span>string</span><span>&gt;</span> <span>{</span> <span>"carrier"</span> <span>}</span><span>)</span><span>;</span>

    
<span>}</span>
<span>catch</span> <span>(</span><span>ApiException</span> ex<span>)</span>
<span>{</span>
    ModelState<span>.</span><span>AddModelError</span><span>(</span>$<span>"{nameof(Input)}.{nameof(Input.PhoneNumber)}"</span><span>,</span>
            $<span>"The number you entered was not valid (Twilio code {ex.Code}), please check it and try again"</span><span>)</span><span>;</span>
    <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre>
<p>Note that we've added the error as a <em>property</em> error by including the field name in the call to <code>AddModelError()</code>. That means the error will be shown next to the phone number field, as well as in the Validation Summary Tag Helper by default. I've also included the Twilio code in the error message for demonstration purposes. In practice you probably won't want to expose that to users, but you may well want to use it for logging and metric purposes. </p>
<p>As well as validating the number, in this example we also requested the carrier information for the number by passing <code>"carrier"</code> to the <code>type</code> parameter of <code>FetchAsync()</code>. This is not necessary for the validation itself, but it can provide some useful additional information for some business use-cases. Including the <code>"carrier"</code> also returns the likely <a href="https://www.twilio.com/docs/lookup/api#phone-number-type-values">phone number type</a> of the number.</p>
<p>We extract the phone number type from the response, taking care to handle nulls and missing values. The phone number type has one of three <code>string</code> values: <code>landline</code>, <code>mobile</code>, or <code>voip</code>. We use that value to try and determine if the number can receive SMS. If it can't, we redisplay the form and make the user enter a different value.</p>
<pre><code>
<span>var</span> phoneNumberType <span>=</span> numberDetails<span>.</span><span>GetPhoneNumberType</span><span>(</span><span>)</span><span>;</span>
<span>if</span> <span>(</span>phoneNumberType <span>!=</span> <span>null</span> 
    <span>&amp;&amp;</span> phoneNumberType <span>==</span> PhoneNumberResource<span>.</span>TypeEnum<span>.</span>Landline<span>)</span>
<span>{</span>
    ModelState<span>.</span><span>AddModelError</span><span>(</span>$<span>"{nameof(Input)}.{nameof(Input.PhoneNumber)}"</span><span>,</span>
        $<span>"The number you entered does not appear to be capable of receiving SMS ({phoneNumberType}). Please enter a different value and try again"</span><span>)</span><span>;</span>
    <span>return</span> <span>Page</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre>
<p>This behavior may be undesirable in many cases; a better approach might be to return a warning, but still save the number. In any case, the only way to be sure whether the number can receive SMS or voice is to try to message or call it, using the <a href="https://www.twilio.com/docs/verify">Twilio Verify API</a> for example.</p>
<p>Once we've validated the phone number with Twilio's API and confirmed it's not a landline number, we save the phone number to the Identity user. This code is essentially the same as before we added our customizations with one exception—instead of saving the number as it was entered by the user, we store the number <em>formatted in E.164 format</em>. This has the benefit of not requiring us to store the country code (as it's contained in the formatted number).</p>
<pre><code><span>var</span> numberToSave <span>=</span> numberDetails<span>.</span>PhoneNumber<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>
<span>var</span> setPhoneResult <span>=</span> <span>await</span> _userManager<span>.</span><span>SetPhoneNumberAsync</span><span>(</span>user<span>,</span> numberToSave<span>)</span><span>;</span>
<span>if</span> <span>(</span><span>!</span>setPhoneResult<span>.</span>Succeeded<span>)</span>
<span>{</span>
    <span>var</span> userId <span>=</span> <span>await</span> _userManager<span>.</span><span>GetUserIdAsync</span><span>(</span>user<span>)</span><span>;</span>
    <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span>$<span>"Unexpected error occurred setting phone number for user with ID '{userId}'."</span><span>)</span><span>;</span>
<span>}</span>
</code></pre>
<p>With this code in place you can test out the validation in your own app. When a number fails Twilio's validation, you will see the error message shown below on the top left. When it passes validation but is a landline, you'll see the error message on the bottom left. Finally, when it passes all validation and is not a landline, you'll see the number is updated to the E.164 format (the <code>+1</code> format) as shown on the right.</p>
<p><img src="https://andrewlock.net/content/images/2019/razor_identity_2.png" alt="Testing out the phone number validation"></p>
<p>The extension method for extracting the phone number type from the <code>PhoneResource</code> object is shown below. It handles nulls, as well as cases where you may not have requested the <code>type</code> using the <code>"carrier"</code> argument.</p>
<pre><code><span>using</span> Twilio<span>.</span>Rest<span>.</span>Lookups<span>.</span>V1<span>;</span>

<span>namespace</span> ValidatePhoneNumberDemo
<span>{</span>
    <span>public</span> <span>static</span> <span>class</span> <span>PhoneNumberResourceExtensions</span>
    <span>{</span>
        <span>public</span> <span>static</span> <span>PhoneNumberResource<span>.</span>TypeEnum</span> <span>GetPhoneNumberType</span><span>(</span><span>this</span> <span>PhoneNumberResource</span> phoneNumber<span>)</span>
        <span>{</span>
            <span>if</span> <span>(</span>phoneNumber<span>?</span><span>.</span>Carrier <span>!=</span> <span>null</span> 
                <span>&amp;&amp;</span> phoneNumber<span>.</span>Carrier<span>.</span><span>TryGetValue</span><span>(</span><span>"type"</span><span>,</span> <span>out</span> <span>string</span> rawType<span>)</span><span>)</span>
            <span>{</span>
                
                <span>return</span> rawType<span>;</span>
            <span>}</span>

            <span>return</span> <span>null</span><span>;</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre>
<p>It's important to remember that validating a number using libphonenumber or the Twilio Lookup API (as we did in this post) is typically only the first step in a multi stage process to verify a user controls a phone number. Before using the phone number for business purposes you should confirm the user has access to the device either by sending a verification message/phone call, using the <a href="https://www.twilio.com/docs/verify">Twilio Verify API</a> for example.</p>
<h2 id="summary">Summary<a href="#summary"></a></h2>
<p>In this post I showed how you can improve the phone number validation in ASP.NET Core Identity by using the Twilio Lookup API. I showed how to scaffold ASP.NET Core Identity pages so they can be customized using the <code>dotnet-aspnet-codegenerator</code> global tool, and how to load countries for a dropdown list from a JSON file. It's important to include the country when validating phone numbers as different countries have different rules. </p>
<p>The Twilio Lookup API uses the libphonenumber library to check the phone number is valid, but it can also return additional information like the carrier, phone number type, or fraud details. For thorough verification that the user has control of the phone number, you should consider using the Twilio Verify API to send a message/call to the phone number.</p>
<h2 id="additional-resources">Additional Resources<a href="#additional-resources"></a></h2>
<p>For an introduction to Razor Pages, see <a href="https://www.twilio.com/blog/introduction-asp-net-core-razor-pages">my previous post</a>, or the excellent resource, <a href="https://www.learnrazorpages.com/">https://www.learnrazorpages.com/</a>. For more information on phone numbers and why they're difficult, see <a href="https://github.com/googlei18n/libphonenumber/blob/master/FALSEHOODS.md">The Falsehoods Programmers Believe About Phone Numbers</a>. For a post on using the libphonenumber directly in your ASP.NET Core application, see <a href="https://www.twilio.com/blog/validating-phone-numbers-effectively-with-c-and-the-net-frameworks">this post on the Twilio blog</a>.</p>
</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>