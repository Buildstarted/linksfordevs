<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Streaming Kubernetes&#x2019; logs using SignalR &#x2013; Do Not Panic -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Streaming Kubernetes‚Äô logs using SignalR ‚Äì Do Not Panic</h1><div><div class="entry-content"><p>As I‚Äôm using a lot Kubernetes to work on my project, I had the need to be able to view the logs produced by the pods.<br>Actually, you can use the Kubernetes Dashboard to view the logs but it means you have to use the proxy to connect using http://127.0.0.1 and that solution was not perfect for me.</p><p>So I decided to play with the Kubernetes C# SDK and it appears that there is a nice method called ReadNamespacedPodLogAsync:</p><pre class="brush: csharp; title: ; notranslate" title="">var stream = await this.kubernetesClient.ReadNamespacedPodLogAsync(pod, ns, follow: true, sinceSeconds: 1500, cancellationToken: cancellationToken);
</pre><p>Problem: this method actually returns a Stream, meaning you‚Äôll get data ‚Äúon the flow‚Äù. So you can‚Äôt use it (directly) on a WebAPI controller and you need to find a way to send the chunks as soon as you retrieve them.</p><p>This is where IAsyncEnumerable (from C# 8) is useful because it was designed for that purpose! So we can easily have a code similar to this one:</p><pre class="brush: csharp; title: ; notranslate" title="">public class LogStreamHub : Hub
{   
    private readonly Kubernetes kubernetesClient;

    public LogStreamHub(Kubernetes kubernetesClient)
    {
        this.kubernetesClient = kubernetesClient;
    }

    public async IAsyncEnumerable&lt;string&gt; GetPodLog(string ns, string pod, [EnumeratorCancellation] CancellationToken cancellationToken)
    {
        cancellationToken.ThrowIfCancellationRequested();

        var stream = await this.kubernetesClient.ReadNamespacedPodLogAsync(pod, ns, follow: true, sinceSeconds: 1500, cancellationToken: cancellationToken);

        var buffer = new byte[8192];

        var count = 0;

        do
        {
            count = stream.Read(buffer, 0, buffer.Length);
            if (count != 0)
            {
                var tmpString = Encoding.Default.GetString(buffer, 0, count);

                yield return tmpString
                        .Replace("\u001b[40m\u001b[37mtrce\u001b[39m\u001b[22m\u001b[49m", "trce")
                        .Replace("\u001b[40m\u001b[37mdbug\u001b[39m\u001b[22m\u001b[49m", "dbug")
                        .Replace("\u001b[40m\u001b[32minfo\u001b[39m\u001b[22m\u001b[49m", "info")
                        .Replace("\u001b[40m\u001b[1m\u001b[33mwarn\u001b[39m\u001b[22m\u001b[49m", "warn")
                        .Replace("\u001b[41m\u001b[30mfail\u001b[39m\u001b[22m\u001b[49m", "fail")
                        .Replace("\u001b[41m\u001b[1m\u001b[37mcrit\u001b[39m\u001b[22m\u001b[49m", "crit");
            }
        } while (count &gt; 0);
    }
}
</pre><p>Note that the Replace stuff is not mandatory but it‚Äôs useful if you want to display color on your application, as the .NET Core Console does.</p><p>On the client side, using the SignalR Javascript library, we can connect to the GetPodLog method:</p><pre class="brush: jscript; title: ; notranslate" title="">function registerForStreamNotifications() {
    signalRSubscription = signalRConnection.stream("GetPodLog", $("#namespaces").val(), $("#pods").val()).subscribe({
        next: (content) =&gt; {
            var container = $('&lt;div class="logs-element"&gt;&lt;/div&gt;');

            var line = $('&lt;span class="log-line"&gt;' + applyHighlights(content) + '&lt;/span&gt;');
            container.append(line);

            $("#logs").append(container);

            // Auto-scroll
            $('#logs').scrollTop($('#logs')[0].scrollHeight);
        }
    });
}
</pre><p>Running the above code, you are now able to display your logs, in <strong>real time</strong>, in your application:</p><figure class="wp-block-image"><img src="/wp-content/uploads/2020/01/image-3-1024x437.png" alt="" class="wp-image-159" srcset="/wp-content/uploads/2020/01/image-3-1024x437.png 1024w, /wp-content/uploads/2020/01/image-3-300x128.png 300w, /wp-content/uploads/2020/01/image-3-768x328.png 768w, /wp-content/uploads/2020/01/image-3.png 1395w" sizes="(max-width: 1024px) 100vw, 1024px"></figure><p>Happy coding ! üôÇ</p><p>PS: For those who are interested, here is the code for the applyHighlights method:</p><pre class="brush: jscript; title: ; notranslate" title="">function applyHighlights(text) {
    text = text
        .replace("trce:", '&lt;span class="trce"&gt;$&amp;amp;&lt;/span&gt;:')
        .replace("trce:", 'trce')
        .replace("dbug:", '&lt;span class="dbug"&gt;$&amp;amp;&lt;/span&gt;:')
        .replace("dbug:", 'dbug')
        .replace("info:", '&lt;span class="info"&gt;$&amp;amp;&lt;/span&gt;:')
        .replace("info:", 'info')
        .replace("warn:", '&lt;span class="warn"&gt;$&amp;amp;&lt;/span&gt;:')
        .replace("warn:", 'warn')
        .replace("fail:", '&lt;span class="fail"&gt;$&amp;amp;&lt;/span&gt;:')
        .replace("fail:", 'fail')
        .replace("crit:", '&lt;span class="crit"&gt;$&amp;amp;&lt;/span&gt;:')
        .replace("crit:", 'crit');

    return text;
}
</pre><p>d</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>