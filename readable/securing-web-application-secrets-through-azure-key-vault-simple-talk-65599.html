<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Securing Web Application Secrets Through Azure Key Vault - Simple Talk - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Securing Web Application Secrets Through Azure Key Vault - Simple Talk - linksfor.dev(s)"/>
    <meta property="article:author" content="Rishit Mishra"/>
    <meta property="og:description" content="Azure Key Vault is a service for storing securely certificates, credentials, connection strings, and more. In this article, Rishit Mishra walks through how to use the service to secure a connection string for an application."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.red-gate.com/simple-talk/dotnet/net-development/securing-web-application-secrets-through-azure-key-vault/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Securing Web Application Secrets Through Azure Key Vault - Simple Talk</title>
<div class="readable">
        <h1>Securing Web Application Secrets Through Azure Key Vault - Simple Talk</h1>
            <div>by Rishit Mishra</div>
            <div>Reading time: 16-20 minutes</div>
        <div>Posted here: 13 Aug 2020</div>
        <p><a href="https://www.red-gate.com/simple-talk/dotnet/net-development/securing-web-application-secrets-through-azure-key-vault/">https://www.red-gate.com/simple-talk/dotnet/net-development/securing-web-application-secrets-through-azure-key-vault/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><p>Azure Key Vault is a service for storing securely certificates, credentials, connection strings, and more. In this article, Rishit Mishra walks through how to use the service to secure a connection string for an application.</p><div>
				<p>As the adoption of cloud technologies increases day by day, companies are enhancing their web applications by using the varied services provided by different cloud providers. Security is an important step while developing any application. In this article, I am going to provide the details of one such Azure service that helps safely store your application configuration secrets – Azure Key Vault. I’ll go through what Azure Key Vault is and how you can use it to store application secrets securely.</p>
<p>While developing applications, you might have seen scenarios where you need to provide connection strings to resources such as databases or cache. As a developer, you might be quite aware that these values are being put into the configuration files (i.e., web.config) of the application. These values are further used by the application to establish connections and communicate with the resources. This may be seen as one of the security issues as the connection strings might be accidentally visible to unauthorized individuals. This is one of the security threats for the Production database information. Azure Key Vault can come to the rescue here so that the crucial information is saved on the Azure cloud with more secured role-based authorization and access control policies. The next section explains the Azure Key Vault in more detail.</p>
<h2>Azure Key Vault</h2>
<p>As the name suggests, Azure Key Vault is used to store and manage keys securely. Key Vault can be used to store the cryptographic secrets and keys such as authentication keys, storage account keys, data encryption keys, passwords and certificates.</p>
<p>Azure Key Vault enables developers to create the keys for development and testing in minutes, and they can further migrate this setup seamlessly onto the production environment.</p>
<p>The centralized key store/vault can be securely managed by the Key Vault owner who manages permissions to this key store and would be responsible for keeping the secrets secure.</p>
<h3>Sensitive Date Categories</h3>
<p><strong>Keys</strong>: These are the cryptographic keys which are most often used by other Azure services. For example, say you want to write data to Azure Storage, and you want to encrypt it. Such highly sensitive encryption codes can be stored as the keys.</p>
<p><strong>Secrets</strong>: These include sensitive information that application might need during the run time such as SQL database connection strings and other connections string such as Azure Storage, Redis Cache, etc. that the application is using.</p>
<p><strong>Certificates</strong>: The certificates that are used for HTTP/SSL communication is a good example. These certificates consist of private and public keys, and such values should be stored securely.</p>
<h3>Benefits of Azure Key Vault</h3>
<ul>
<li>Reduces the need for deployments if there is a change in resource’s configuration. The main reason for this is that access keys/secrets are stored in Azure Key Vault and not in web.config, so there is no need for redeploying web.config. Just update the value in Azure Key Vault, and your application is ready to use it.</li>
<li>Securely manage application key/secrets by enforcing role-based access policies.</li>
<li>Reduce latency in accessing the keys by making use of the Azure Cloud Global redundancy feature. This makes sure your application keys are accessible at all times.</li>
<li>Applications have no direct access to keys. This ensures the secrets are not passed on to a person who has no permissions to the respective resources.</li>
<li>Helps to create and export keys in no time.</li>
</ul>
<p>Take a look at how you can store application secrets in Azure Key Vault and use them to build applications.</p>
<h2>Setup in Azure</h2>
<p>The application demonstrated here is a simple console application that fetches an image from Azure blob storage and downloads it to the local folder specified in the application. Since the app must grab the image from the Azure storage blob, it must establish a secure connection. Typically, this connection string is stored in the config file of the application; however, this example makes use of Azure Key Vault to store this connection string value. The essential components needed for this application are</p>
<ul>
<li>Azure Blob Container Storage with a file to download.</li>
<li>Azure Key Vault with a storage account connection string stored in a secret.</li>
<li>Application registered on the Azure Active Directory that provides the ClientId and ClientSecret to access the key vault.</li>
</ul>
<h3>Setting up Azure Storage container</h3>
<ul>
<li>The first step is to log in to the <a href="https://portal.azure.com/">Azure Portal</a>. For this, you would need an Azure Subscription.</li>
<li>Create an Azure storage account for Blob Storage first if you don’t want to use an existing one. Navigate to Storage Accounts by typing in the search section. Click Add and fill in the necessary information such as Storage account name, subscription, and resource group. I have created an account with the name quickuploadappstorage. You may want to create it and the other services in a new Resource Group, so it’s easy to delete everything once you are done with the example.</li>
</ul>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_19-00-02_azurestorage.jpeg" data-lazy-load="" alt="2020-07-13_19-00-02_AzureSTorage"></p>
<p>Click Review + Create. After you see that all the Validation Passed you can hit Create button. This takes you to the deployment page, which takes a couple of minutes. After it’s successful, you can go back to the Storage Accounts page where you can see newly added storage account.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_19-08-20_storagedeployed.jpeg" data-lazy-load="" alt="2020-07-13_19-08-20_STorageDeployed"></p>
<ul>
<li>The next step is to note down the connection string of the storage account that you just created. Click the quickuploadappstorage to see the details and click on Access Keys. Grab the Connection string from this page and make sure you keep a backup of the Connection string from the storage keys; you will need it later while creating the secret.</li>
</ul>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_19-10-20_storageconnection.jpeg" data-lazy-load="" alt="2020-07-13_19-10-20_StorageConnection"></p>
<ul>
<li>Add a new container to upload the image. For this click on the Overview option and click the Containers.</li>
</ul>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_19-19-05_container.jpeg" data-lazy-load="" alt="2020-07-13_19-19-05_Container"></p>
<p>Once you are on the Containers page, click on the + Container option. Provide the Container Name and set the Public Access Level to “Blob (anonymous read access for blobs only) ”. To understand the different public level access you can refer <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/anonymous-read-access-configure?tabs=portal">this</a> documentation. For demo purposes, I have created a container uploadedpictureforvalutdemo. After I created it, I navigated down</p>
<p>to the specific container and uploaded a file <em>lotus-flower.jpg </em>to this container using the upload blade. Be sure to upload a file in your own container.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_19-25-24_lotusfile.jpeg" data-lazy-load="" alt="2020-07-13_19-25-24_LotusFile"></p>
<h3>Setting up a secret in Azure Key Vault</h3>
<p>Back on the main page, search for key vaults and navigate to that page. Click + Add to create a new key vault for storing the secrets as below:</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/c-users-supriya-pande-desktop-article-2020-06-20_.jpeg" data-lazy-load="" alt="C:\Users\supriya.pande\Desktop\Article\2020-06-20_18-08-29_KeyVaultSetup.jpg"></p>
<p>On the networking page, make sure that all networks are allowed.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-6.png" data-lazy-load=""></p>
<p>After you have created the key vault, navigate to it. You can add a new secret by selecting Secrets on the key vault page and by clicking the Generate/Import button.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-7.png" data-lazy-load=""></p>
<p>Add the new secret Name and Value. You can think of Name and Value as a key-value pair that you provide in web.config or app.config of an application. For instance, the entry that you provide in app.config is something similar to this</p>
<p>&lt;add key=”StorageConnection” value=”Sample connection string” /&gt;.</p>
<p>The Secret Name is the Key (StorageConnection), and the value is the Storage Connection string that you copied from the Azure Storage connection in the previous step.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/c-users-supriya-pande-desktop-article-2020-06-29_.jpeg" data-lazy-load="" alt="C:\Users\supriya.pande\Desktop\Article\2020-06-29_16-00-20_createSecret.jpg"></p>
<p>After all the details are entered hit “Create”. This creates a new secret in your vault that you will use shortly in the application.</p>
<h3>Register Application on Azure Active Directory</h3>
<p>After you have created the secret in your vault, the next important setup step is registering an app with the Azure Active Directory. After this app is registered, you will get the Client Id and Client secret that can be used to authenticate to Azure Active Directory and, consequently, to the key vault.</p>
<p>To register the app just search the “App registration” in the Azure portal search box or you can browse to Default Directory and search with the same keyword in the default directory.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-8.png" data-lazy-load=""></p>
<p>Then click “New registration” and provide the details such as display name and redirect url if required.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-9.png" data-lazy-load=""></p>
<p>Also, save the Application (client) ID from the registered app confirmation page. Unlike client secret, this is accessible to you later.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-10.png" data-lazy-load=""></p>
<p>The next step is generating the Client Secret. For this go to registered app DemoAzureVault Select Certificates &amp; Secrets blade -&gt; Click New client secret.</p>
<p><strong><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_21-54-29_registration.jpeg" data-lazy-load="" alt="2020-07-13_21-54-29_Registration"></strong></p>
<p>Provide the client secret description and the expiration information and click add.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-11.png" data-lazy-load=""></p>
<p>When you click register on the next screen, make sure you save the value of the key as this is the only time you will be able to see it. This is the Client Secret that you will use in the application.</p>
<p>The very first time you add a new secret, the value shows without asterisks *. Make sure you make a note of it that time.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_22-05-32_addedsecret.jpeg" data-lazy-load="" alt="2020-07-13_22-05-32_AddedSecret"></p>
<p>After the app is registered, the next step is to provide access to the app to the key vault. For this, navigate to the Key vault -&gt; Click access policies -&gt; Add access policy</p>
<p>In the access policy page, you can select the permissions to keys, secrets and certificates. For the demo application, I have provided full access at the moment. You can choose the access you want to grant from the drop-down values.</p>
<p>Make sure you select the app you just registered through app registration as the Principal. I have selected the DemoAzureVault app. This provides the necessary permissions to the app. According to Azure documentation “Principal is an object that represents a user, group, service principal, or managed identity that is requesting access to Azure resources.” Authorized application is another set of applications or users that you can provide access to Key Vault.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/2020-07-13_21-33-47_accesspolicy.jpeg" data-lazy-load="" alt="2020-07-13_21-33-47_AccessPolicy"></p>
<p>Once the Access Policy shows up in the list of Access policies, remember to click Save!</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-12.png" data-lazy-load=""></p>
<p>Another step is grabbing the base secret uri. You can get this by navigating down to the secret by clicking Secrets, and the StorageConnectionDetails see the highlighted details below.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-13.png" data-lazy-load=""></p>
<p>The Secret identifier is the uri that’s needed to copy for the application.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-14.png" data-lazy-load=""></p>
<h2>Setting up Key Vault Client</h2>
<p>After you have these things ready, you can start writing code for the application.</p>
<p>In the traditional way of writing the connection strings in the app.config, you would have specified the Azure Storage Account connection string something like this.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f34d7cf261e5751413600" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>&lt;</span><span>appSettings</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>add </span><span>key</span><span>=</span><span>"StorageAccount"</span><span> </span><span>value</span><span>=</span><span>"your Azure Storage Connection String here"</span><span>/</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;</span><span>&lt;</span><span>/</span><span>appSettings</span><span>&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>However, this is how your app.config look like instead. It will have the ClientId, ClientSecret and the BaseSecretUri values that you captured in the previous steps</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f34d7cf261ee465715272" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>&lt;</span><span>appSettings</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>add </span><span>key</span><span>=</span><span>"ClientSecret"</span><span> </span><span>value</span><span>=</span><span>"your client secret value"</span><span> </span><span>/</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>add </span><span>key</span><span>=</span><span>"ClientId"</span><span> </span><span>value</span><span>=</span><span>"your client Id details"</span><span> </span><span>/</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>add </span><span>key</span><span>=</span><span>"BaseSecretUri"</span><span> </span><span>value</span><span>=</span><span>"your base secret uri value"</span><span> </span><span>/</span><span>&gt;</span></p><p><span> </span><span>&lt;</span><span>/</span><span>appSettings</span><span>&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>Begin by creating a .NET Framework Console app. Before writing code, add the references below from the Nuget Package Browser.</p>
<ul>
<li>System.Configuration.ConfigurationManager</li>
<li>Microsoft.WindowsAzure.Storage</li>
<li>Microsoft.Azure.KeyVault</li>
<li>Microsoft.IdentityModel.Clients.ActiveDirectory</li>
</ul>
<p>Since you have to get the Image file from Azure Blob Storage, you need first get the access keys from Azure Key Vault. The very first step to establishing a connection to the key vault for this set up a key vault client by using ClientId and ClientSecret (Saved in app.config) from your registered app on Azure Directory. The GetToken() method helps generate the token and create a successful Key Vault Client.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f34d7cf261f1778377699" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>var</span><span> </span><span>vaultClient</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>KeyVaultClient</span><span>(</span><span>GetToken</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>Fetching the storage connection string from Secret is the next step. The vaultClient can further be used to fetch the secret details.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f34d7cf261f4691716552" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>var</span><span> </span><span>storageAccountSecretValue</span><span> </span><span>=</span><span> </span><span>vaultClient</span><span>.</span><span>GetSecretAsync</span><span>(</span><span>BaseSecretUri</span><span>)</span><span>.</span><span>Result</span><span>.</span><span>Value</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<p>This connection string is what you use to establish a successful connection to the Azure Blob Storage container. Finally, you will use the DownloadImage() method to download the file to the specified location. I have mentioned the folder C:\UploadFiles\” and the name of the file image to download is “lotus – flower.jpg”. The code also has the container name, uploadedpictureforvalutdemo, that should be replaced if you named your container something else.</p>
<p>Here is the complete code that I wrote in Program.cs file.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5f34d7cf261f6894995736" data-settings=" minimize scroll-always">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p></div>
				</td>
						<td><div><p><span>using</span><span> </span><span>System</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Configuration</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>IO</span><span>;</span></p><p><span>using</span><span> </span><span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>Azure</span><span>.</span><span>KeyVault</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>IdentityModel</span><span>.</span><span>Clients</span><span>.</span><span>ActiveDirectory</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>WindowsAzure</span><span>.</span><span>Storage</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>WindowsAzure</span><span>.</span><span>Storage</span><span>.</span><span>Blob</span><span>;</span></p><p><span>namespace</span><span> </span><span>DemoAzureVault</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>internal</span><span> </span><span>class</span><span> </span><span>Program</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//get the connection details from app settings</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>static</span><span> </span><span>readonly</span><span> </span><span>string</span><span> </span><span>ClientSecret</span><span> </span><span>=</span><span> </span><span>ConfigurationManager</span><span>.</span><span>AppSettings</span><span>[</span><span>"ClientSecret"</span><span>]</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>static</span><span> </span><span>readonly</span><span> </span><span>string</span><span> </span><span>ClientId</span><span> </span><span>=</span><span> </span><span>ConfigurationManager</span><span>.</span><span>AppSettings</span><span>[</span><span>"ClientId"</span><span>]</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>static</span><span> </span><span>readonly</span><span> </span><span>string</span><span> </span><span>BaseSecretUri</span><span> </span><span>=</span><span> </span><span>ConfigurationManager</span><span>.</span><span>AppSettings</span><span>[</span><span>"BaseSecretUri"</span><span>]</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>static</span><span> </span><span>void</span><span> </span><span>Main</span><span>(</span><span>string</span><span>[</span><span>]</span><span> </span><span>args</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//initialize key vault client</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>vaultClient</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>KeyVaultClient</span><span>(</span><span>GetToken</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//get the secret(storage account connection string) from key vault</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>storageAccountSecretValue</span><span> </span><span>=</span><span> </span><span>vaultClient</span><span>.</span><span>GetSecretAsync</span><span>(</span><span>BaseSecretUri</span><span>)</span><span>.</span><span>Result</span><span>.</span><span>Value</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//connect to storage account using connection string</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>storageAccount</span><span> </span><span>=</span><span> </span><span>CloudStorageAccount</span><span>.</span><span>Parse</span><span>(</span><span>storageAccountSecretValue</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>blobClient</span><span> </span><span>=</span><span> </span><span>storageAccount</span><span>.</span><span>CreateCloudBlobClient</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>blobContainer</span><span> </span><span>=</span><span> </span><span>blobClient</span><span>.</span><span>GetContainerReference</span><span>(</span><span>"&lt;a id="</span><span>post</span><span>-</span><span>87740</span><span>-</span><span>_Hlk47452325</span><span>"&gt;&lt;/a&gt;uploadedpictureforvalutdemo"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//Download the file from blob storage to the destination folder</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>blobContainer</span><span>.</span><span>Exists</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>filetoDownload</span><span> </span><span>=</span><span> </span><span>"lotus - flower.jpg"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>DownloadImage</span><span>(</span><span>filetoDownload</span><span>,</span><span> </span><span>"uploadedpictureforvalutdemo"</span><span>,</span><span> </span><span>storageAccountSecretValue</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>Write</span><span>(</span><span>"Download Complete"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>Write</span><span>(</span><span>"Press any key to exit..."</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>ReadKey</span><span>(</span><span>true</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>static</span><span> </span><span>void</span><span> </span><span>DownloadImage</span><span>(</span><span>string</span><span> </span><span>fileToDownload</span><span>,</span><span> </span><span>string</span><span> </span><span>azure_ContainerName</span><span>,</span><span> </span><span>string</span><span> </span><span>storageAccountSecretValue</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CloudStorageAccount </span><span>storageAccount</span><span> </span><span>=</span><span> </span><span>CloudStorageAccount</span><span>.</span><span>Parse</span><span>(</span><span>storageAccountSecretValue</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CloudBlobClient </span><span>blobClient</span><span> </span><span>=</span><span> </span><span>storageAccount</span><span>.</span><span>CreateCloudBlobClient</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CloudBlobContainer </span><span>blobContainer</span><span> </span><span>=</span><span> </span><span>blobClient</span><span>.</span><span>GetContainerReference</span><span>(</span><span>azure_ContainerName</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CloudBlockBlob </span><span>cloudBlob</span><span> </span><span>=</span><span> </span><span>blobContainer</span><span>.</span><span>GetBlockBlobReference</span><span>(</span><span>fileToDownload</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// provide the file download location below&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Stream </span><span>file</span><span> </span><span>=</span><span> </span><span>File</span><span>.</span><span>OpenWrite</span><span>(</span><span>@"C:\UploadFiles\"</span><span> </span><span>+</span><span> </span><span>fileToDownload</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cloudBlob</span><span>.</span><span>DownloadToStream</span><span>(</span><span>file</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>static</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>string</span><span>&gt;</span><span> </span><span>GetToken</span><span>(</span><span>string</span><span> </span><span>authority</span><span>,</span><span> </span><span>string</span><span> </span><span>resource</span><span>,</span><span> </span><span>string</span><span> </span><span>scope</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>authContext</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>AuthenticationContext</span><span>(</span><span>authority</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>clientCred</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>ClientCredential</span><span>(</span><span>ClientId</span><span>,</span><span> </span><span>ClientSecret</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>result</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>authContext</span><span>.</span><span>AcquireTokenAsync</span><span>(</span><span>resource</span><span>,</span><span> </span><span>clientCred</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>result</span><span> </span><span>==</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>InvalidOperationException</span><span>(</span><span>"Failed to obtain the token"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>result</span><span>.</span><span>AccessToken</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->

<h2>Results</h2>
<p>After you successfully run the code and check the specified location, you will see that the image is downloaded successfully from Azure Blob Storage to the folder.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPAAAPLy8v///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" data-src="https://www.red-gate.com/simple-talk/wp-content/uploads/2020/08/word-image-15.png" data-lazy-load=""></p>
<h2>Conclusion</h2>
<p>Azure Key Vault provides a secure, reliable and easy to manage capabilities for storing the application secrets in a quick and hassle-free setup. After reading this article, you will be able to learn how to securely store the critical information in the form of keys, secrets and certificates in the Azure Key Vault and use them to build varied applications.</p>
<h2>References</h2>
<p><a href="https://docs.microsoft.com/en-us/azure/key-vault/general/basic-concepts">https://docs.microsoft.com/en-us/azure/key-vault/general/basic-concepts</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/key-vault/general/authentication">https://docs.microsoft.com/en-us/azure/key-vault/general/authentication</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/key-vault/general/overview">https://docs.microsoft.com/en-us/azure/key-vault/general/overview</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction">https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/storage/blobs/anonymous-read-access-configure?tabs=portal">https://docs.microsoft.com/en-us/azure/storage/blobs/anonymous-read-access-configure?tabs=portal</a></p>

			</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>