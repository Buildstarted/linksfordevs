<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Publishing to Azure Container Registry using Azure Pipelines -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Publishing to Azure Container Registry using Azure Pipelines</h1>
    <div class="post-content"> <p><strong>Part 1</strong> - <a href="https://chrissainty.com/containerising-blazor-applications-with-docker-containerising-a-blazor-server-app/">Containerising a Blazor Server App</a><br><strong>Part 2</strong> - <a href="https://chrissainty.com/containerising-blazor-applications-with-docker-containerising-a-blazor-webassembly-app/">Containerising a Blazor WebAssembly App</a><br><strong>Part 3</strong> - Publishing to Azure Container Registry using Azure Pipelines (this post)</p><p>In <a href="https://chrissainty.com/containerising-blazor-applications-with-docker-containerising-a-blazor-server-app/">part 1</a> and <a href="https://chrissainty.com/containerising-blazor-applications-with-docker-containerising-a-blazor-webassembly-app/">part 2</a> we looked at how to containerise Blazor applications with Docker. We can now run Blazor Server and Blazor WebAssembly apps in containers locally - which is great! But how do we go about automating the building of Docker images as part of a CI pipeline? And where do we keep our images once they&apos;re built?</p><p>In this post, we&apos;re going to answer at those two questions. We&apos;re going to see how to automate the building of Docker images using Azure Pipelines, then how to publish them to Azure Container Registry. I&apos;m going to use the Blazor Server app from <a href="https://chrissainty.com/containerising-blazor-applications-with-docker-containerising-a-blazor-server-app/">Part 1</a> as the example project in this post. It&apos;s hosted on GitHub so all instructions will be based on code being hosted there. If your code is hosted elsewhere don&apos;t worry, Azure Pipelines can connect to lots of <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/?view=azure-devops#supported-repository-types">different code repositories</a>.</p><h2 id="creating-an-azure-container-registry">Creating an Azure Container Registry</h2><p>We&apos;re going to start by creating an <a href="https://azure.microsoft.com/en-gb/services/container-registry/">Azure Container Registry (ACR)</a>. ACR is a service for hosting Docker images in Azure, similar to Docker Hub, allowing us to store and manage our container images in a central place.</p><p>Start by logging into the <a href="https://portal.azure.com/">Azure Portal</a> and then select <strong>All Services</strong> from the left menu and search for c<em>ontainer registries</em>.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/open-container-registries.png" class="kg-image"></figure><p>Once the blade loads click on <strong>Add</strong> at the top.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/AddACR.png" class="kg-image"></figure><p>You will then see the <strong>Create container registry</strong> screen. Give your registry a <em>name</em>, select your <em>subscription</em>, <em>resource group</em> and <em>location</em>. Leave <em>Admin user</em> disabled, we&apos;ll be using a service connection to connect to the registry from Azure Pipelines for the moment. Finally, select the <em>SKU</em> (pricing level) that fits your needs. I&apos;m going to select <em>Basic</em> for now.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/new-acr-details.png" class="kg-image"></figure><p>Once you&apos;re done click <strong>Create</strong> at the bottom of the screen and after a minute or two the new ACR will be available. That&apos;s all we need to do in the Azure Portal for the moment, the rest of our time is going to be spend in Azure Pipelines.</p><h2 id="azure-pipelines">Azure Pipelines</h2><p>If you&apos;re new to <a href="https://azure.microsoft.com/en-gb/services/devops/pipelines/">Azure Pipelines</a>, it&apos;s a Continuous Integration (CI)/Continuous Deployment (CD) service which allows developers to build, test and deploy their code anywhere - It&apos;s also free to use! If you don&apos;t already have an account then you can head over to <a href="https://devops.azure.com/">devops.azure.com</a> to signup.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/AzureDevOpsSignUp.png" class="kg-image"></figure><p>Once you have logged into your account click the <strong>New Project</strong> button in the top right hand corner and give your project a name and select its visibility.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/devops-new-project.png" class="kg-image"></figure><p>Once you&apos;re done click the <strong>Create</strong> button, your project will be created and you should see the project home screen.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/new-project.png" class="kg-image"></figure><p>Using the left hand menu, head to <strong>Pipelines</strong> and then <strong>Builds</strong>. Then select the <em>New pipeline</em> button from the main panel.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/new-pipeline.png" class="kg-image"></figure><p>This starts the new pipeline wizard which is made up of 4 steps. The first step is to connect to source control. As I mentioned at the start, my example project is hosted on GitHub but choose whichever option you need.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/select-source-control.png" class="kg-image"></figure><p>You&apos;ll then see a list of the available repositories, select the one you want to connect to.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/source-repo.png" class="kg-image"></figure><p>Step three is where we configure the pipeline. You may have to click the <strong>Show More</strong> button to see the full list. Once you see the full list scroll down and select <strong>Docker</strong>.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/configure-pipeline.png" class="kg-image"></figure><p>We now get presented with a drawer asking us to specify where to find our dockerfile. </p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/locate-dockerfile.png" class="kg-image"></figure><p>One thing to note here is that the name of the file is case sensitive. In my project, the dockerfile has a lower-case <em>d</em>, so I&apos;m going to change the default value to <code>**/dockerfile</code>, then click <strong>Validate and configure</strong>.</p><p>The last step presents us with the final <code>yaml</code> file which will be used to build our image. </p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/yaml-file.png" class="kg-image"></figure><p>Go ahead and click <strong>Save and run</strong> in the top right and you will see the Save and run confirmation dialogue.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/save-run-commit-to-branch.png" class="kg-image"></figure><p>Here you can choose whether to commit the yaml file to your repositories master branch or to create a new branch and commit it there. I&apos;m going to commit it to a new branch called azure-pipelines. That way I can play with the configuration until everything is setup how I want then raise a PR to merge it to master. Once you&apos;re done click <strong>Save and run</strong> to complete the process.</p><p>Azure Pipelines will then commit the yaml file and start a new built. Once it&apos;s complete you should see the build summary screen.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/build-complete.png" class="kg-image"></figure><p>We now have our image being built by Azure Pipelines - Which is great! The next step is to publish it to Azure Container Registry. </p><p>We&apos;re going to start by adding a <em>service connection</em> to the container registry. Go to <strong>Project settings</strong> in the bottom left of the screen and then select <strong>Service connections</strong> under the <em>Pipelines</em> sub-menu.</p><p>From there, click on <strong>New service connection</strong> then select <strong>Docker registry</strong> from the list.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/new-service-connection.png" class="kg-image"></figure><p>You&apos;ll then see the following modal.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/registry-service-connection-1.png" class="kg-image"></figure><p>Select <strong>Azure Container Registry</strong> and give the connection a name. Select which Azure subscription to use and then select the container registry you want to connect to. When you&apos;re done click <strong>OK</strong> to save the connection.</p><p>We need to make some changes to our yaml file to tell it to publish to the container registry. Click on <strong>Pipelines</strong> then <strong>Builds</strong> on the main menu. Then click the <strong>Edit</strong> button in the top right of the screen.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/edit-build.png" class="kg-image"></figure><p>This will load up the yaml editor. Update the Docker task to match the following code.</p><pre><code class="language-yaml">- task: <a href="/cdn-cgi/l/email-protection" class="__cf_email__">[email&#xA0;protected]</a>
  displayName: Build and push image to container registry
  inputs:
    command: buildAndPush
    repository: demos/BlazorServerWithDocker
    dockerfile: &apos;**/dockerfile&apos;
    containerRegistry: AzureContainerRegistry
    tags: |
      $(tag)
</code></pre>
<p>We&apos;re now using the <code>buildAndPush</code> command instead of the <code>build</code> command. Then specifying which <code>repository</code> to publish the image to. Repositories are a way of organising your images in the registry, similar to a GitHub account which contains repositories. If a repository doesn&apos;t exist then it will be created for you when the image is published. The other change is specifying the <code>containerRegistry</code> to use, this is where we use the name of the service connection we just setup.</p><p>Once you&apos;re done click <strong>Save</strong> and you will see the following modal where you can add a commit message before the build file is committed.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/save-updated-yaml.png" class="kg-image"></figure><p>This should trigger a build using the new build file. If it hasn&apos;t then after you&apos;ve committed the changes, click <strong>Run</strong> at the top right of the screen.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/run-updated-yaml.png" class="kg-image"></figure><p>Hopefully, after a minute or two, you will see the build summary screen and lots of green!</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/completed-build-and-publish.png" class="kg-image"></figure><p>You can check everything was published successfully by heading back over to Azure and checking the <strong>Repositories</strong> link in your Azure Container Registry. You should see your repository, if you click on it you will be able to view your image.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/08/repo-in-acr.png" class="kg-image"></figure><p>In this post I&apos;ve shown how to automate the building of a Docker image using Azure Pipelines. As well as how to automatically publish the image to an Azure Container Registry. </p><p>I&apos;m really impressed with how easy it&apos;s been to automate the building and publishing of the image with Azure Pipelines, it really is a fantastic service and the fact it&apos;s freely available to everyone is just amazing. I also want to point out that this post isn&apos;t in any way specific to Blazor and you should be able use the information here to build any docker image.</p> <div class="post-tags"> Tagged in: <a href="/dev-ops/">DevOps</a> | <a href="/docker/">Docker</a> </div> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>