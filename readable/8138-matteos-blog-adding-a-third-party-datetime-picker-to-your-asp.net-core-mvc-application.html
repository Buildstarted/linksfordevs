<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Matteo&#x27;s Blog - Adding a third party datetime picker to your ASP.NET Core MVC Application -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Matteo's Blog - Adding a third party datetime picker to your ASP.NET Core MVC Application</h1><div><div id="content" class="col-md-12"><p>In this blog post I want to show something that is trivial and yet always causes me headaches. DateTime pickers have always been a pain to implement, and there are so many ways to accomplish them. For my own reference and maybe for someone out there that is looking for a solution this is how I implement DateTime pickers using <a href="https://tempusdominus.github.io/bootstrap-4/Usage/">tempusdominus-bootstrap-4</a> including localization and some of its problems it brings.</p><h2 id="installing-the-required-package">Installing the required package</h2><p>We need to install the required packages. In most of my projects I use <code>libman</code> to install client side packages, but you could also use <code>npm</code> or a <code>cdn</code>. The tempusdominus-bootstrap-4 package requires to also include <code>moment.js</code> which is a very useful package if you are working with dates in JavaScript.</p><pre><code class="language-json">{
    "library": "tempusdominus-bootstrap-4@5.1.2",
    "destination": "wwwroot/lib/datepicker"
},
{
    "library": "moment.js@2.24.0",
    "destination": "wwwroot/lib/momentjs",
    "files": [ "locale/de-ch.js", "moment.min.js" ]
}
</code></pre><p>Add the packages to the <code>_Layout.cshtml</code>, inside the <code>head</code> tag:</p><pre><code class="language-html">&lt;link rel="stylesheet" href="~/lib/datepicker/css/bootstrap-datepicker.min.css" /&gt;
</code></pre><p>At the bottom of you <code>_Layout.cshtml</code>:</p><pre><code class="language-html">&lt;script src="~/lib/momentjs/moment.min.js"&gt;&lt;/script&gt;
&lt;script src="~/lib/momentjs/locale/de-CH.js"&gt;&lt;/script&gt;
&lt;script src="~/lib/datepicker/js/tempusdominus-bootstrap-4.min.js"&gt;&lt;/script&gt;
</code></pre><h2 id="updating-the-html">Updating the HTML</h2><p>I changed the default <code>input</code> to the same <code>input group</code> that is shown on the usage page of the library (see <a href="https://tempusdominus.github.io/bootstrap-4/Usage/">here</a>). It appends a small calendar symbol to the input box which I find a nice touch. A next step could be, to encapsulated this into a <code>TagHelper</code> to make it easier for developers.</p><pre><code class="language-html">&lt;div class="form-group"&gt;
    &lt;label asp-for="DateOfBirth"&gt;&lt;/label&gt;
    &lt;div class="form-group"&gt;
        &lt;div class="input-group date" id="dateofbirth" data-target-input="nearest"&gt;
            &lt;input asp-for="DateOfBirth" name="DateOfBirth" type="text" class="form-control datetimepicker-input" data-target="#dateofbirth"/&gt;
            &lt;div class="input-group-append" data-target="#dateofbirth" data-toggle="datetimepicker"&gt;
                &lt;div class="input-group-text"&gt;&lt;i class="fa fa-calendar"&gt;&lt;/i&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre><h2 id="configure-the-datepicker">Configure the datepicker</h2><p>We need to add a little piece of javscript to the page to add the functionality to the input field for the datepicker. We call the <code>datetimepicker</code> method on all items with the class <code>date</code>. There are many options that you can pass as a parameter to the method. Details about them can be found <a href="https://tempusdominus.github.io/bootstrap-4/Options/">here</a>.</p><pre><code class="language-js">$(function(){
    $('.date').datetimepicker({
        format: 'L'
    });
});
</code></pre><h2 id="adding-localization">Adding Localization</h2><p>If your app requires localized dates and you want to show the date in the regions date format we need to specify the current locale to the options of the datetimepicker.</p><pre><code class="language-js">$(function(){
    $('.date').datetimepicker({
        locale: '@System.Threading.Thread.CurrentThread.CurrentUICulture.Name',
        format: 'L'
    });
});
</code></pre><p>Since I am working with Razor Pages we can simply get the current threads ui culture and pass it to the locale property of the options object.</p><p>After this I thought I was done but if I had the locale set to <code>de-CH</code> the client side validation failed if I selected a date like <code>28.02.2019</code>. This is because I am using the jQuery unobtrusive validation and it does not validate a datetime properly if they are in a non US format. But there is an easy fix to this, and since <code>moment.js</code> is already in place it is really simple. All that we have to do is update the <code>date</code> validation method.</p><pre><code class="language-js">$.validator.methods.date = function (value, element) {
    return this.optional(element) || moment(value, window.currentDateTimeFormat, true).isValid();
}
</code></pre><p>I am setting a global JavaScript variable for the current date time format:</p><pre><code>window.currentDateTimeFormat = '@System.Threading.Thread.CurrentThread.CurrentUICulture.DateTimeFormat.ShortDatePattern.ToUpper()';
</code></pre><p>Everything worked at this point, except the <code>Edit</code> page. If there was a datetime set and that value should be loaded into the input, there were strange exceptions in the browsers console.</p><p>I figured out that the parsing method of the library was not working properly. I used the option to override the <code>parseInputDate</code> function as shown below.</p><pre><code class="language-js">$(function(){
    var parseInputDate = function (inputDate) {
        var resultDate;
        if (moment.isMoment(inputDate) || inputDate instanceof Date) {
            resultDate = moment(inputDate);
        } else {
            resultDate = moment(inputDate, window.currentDateTimeFormat);
        }
        return resultDate;
    }

    $('.date').datetimepicker({
        locale: '@System.Threading.Thread.CurrentThread.CurrentUICulture.Name',
        format: 'L',
        parseInputDate: parseInputDate
    });
});
</code></pre><h2 id="custom-model-binder">Custom model binder</h2><p>If you are using the regions date format as a query string parameter strange things might happen. For example if you choose the <code>01.02.2019</code> the model binding binds using the format <code>month day year</code>, and the result is <code>02.01.2019</code> on the server which is wrong. It gets even better. If you choose <code>28.02.2019</code> it silently fails and sets the value to null (if you have a nullable DateTime type). To fix this issue I created a custom implementation of a <code>DateTimeModelBinder</code>.</p><pre><code class="language-csharp">public class DateTimeModelBinder : IModelBinder 
{ 
    public Task BindModelAsync(ModelBindingContext bindingContext) 
    {
        if (bindingContext == null)
        {
            throw new ArgumentNullException(nameof(bindingContext)); 
        }

        var modelName = bindingContext.ModelName; 
        var valueProviderResult = bindingContext.ValueProvider.GetValue(modelName); 

        if (valueProviderResult == ValueProviderResult.None) 
        {
            return Task.CompletedTask; 
        }

        bindingContext.ModelState.SetModelValue(modelName, valueProviderResult); 

        var value = valueProviderResult.FirstValue; 

        if (string.IsNullOrEmpty(value)) 
        { 
            return Task.CompletedTask; 
        }

        if (!DateTime.TryParse(value, out var dateTime)) 
        { 
            bindingContext.ModelState.TryAddModelError(modelName, $"Unable to parse {value} to datetime"); 
            return Task.CompletedTask; 
        } 

        bindingContext.Result = ModelBindingResult.Success(dateTime); 
        return Task.CompletedTask; 
    } 
}
</code></pre><p>We have to register our <code>DateTimeModelBinder</code> either by adding an attribute to the property:</p><pre><code class="language-csharp">[BindProperty]
[DataType(DataType.Date)]
[ModelBinder(typeof(DateTimeModelBinder))]
public DateTime? DateOfBirth { get; set; }
</code></pre><p>or globally by adding a <code>ModelBinderProvider</code> to the MvcOptions:</p><pre><code class="language-csharp">public class CustomModelBinderProvider : IModelBinderProvider
{
    public IModelBinder GetBinder(ModelBinderProviderContext context)
    {
        if (context.Metadata.ModelType == typeof(DateTime) || context.Metadata.ModelType == typeof(DateTime?))
        {
            return new DateTimeModelBinder();
        }

        return null;
    }
}
</code></pre><p>and registering it:</p><pre><code class="language-csharp">services.AddMvc()
    .AddMvcOptions(options =&gt;
    {
        options.ModelBinderProviders.Insert(0, new CustomModelBinderProvider());
    })
    .AddNewtonsoftJson();
</code></pre><h2 id="summary">Summary</h2><p>As we all now DateTime is one of the hardest things to get right in software development. And there are also some issues I know that we can get into with the approach I used above. For example if we register the <code>DateTimeModelBinder</code> globally, use a query string parameter and you would like to copy the url and send it to a colleague and he uses a different locale this approach will not work. A solution to this would be to use a special format and model provider for query string parameters e.g. <code>yyyy-MM-dd</code>.</p><p>If you like this blog post drop a comment or buy me a coffee at the bottom of the page...</p><a href="https://disqus.com" class="dsq-brlink">comments powered by </a></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>