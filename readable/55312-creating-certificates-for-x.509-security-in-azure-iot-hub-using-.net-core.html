<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Creating Certificates for X.509 security in Azure IoT Hub using .NET Core -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Creating Certificates for X.509 security in Azure IoT Hub using .NET Core</h1><div><div class="entry-content"><p>This article shows how to create certificates in .NET Core which can be used for Azure IoT Hub. The chained certificates are created using the nuget package <a href="https://www.nuget.org/packages/CertificateManager/">CertificateManager</a>. </p><p><strong>Code: </strong><a href="https://github.com/damienbod/AspNetCoreCertificates" rel="nofollow">https://github.com/damienbod/AspNetCoreCertificates</a></p><p>To use X.509 security with Azure IoT Hub, we would like to create chained certificates. This would make it possible to separate devices or group them together using intermediate certificates and so on. In this example a self signed root certificate is created which can produce child certificates. The devices will be created from the child intermediate certificates. A cer file is exported from the certificate which can then be used in the IoT Hub setup. The pfx files can be uses to create new child certificates. You would need to persist these somewhere in a safe way.</p><p><strong>Create chained certificates for Azure IoT Hub</strong></p><pre class="brush: csharp; title: ; notranslate" title="">var serviceProvider = new ServiceCollection()
	.AddCertificateManager()
	.BuildServiceProvider();

var spCerts = serviceProvider.GetService&lt;CreateCertificatesClientServerAuth&gt;();

var root = spCerts.NewRootCertificate(
	new DistinguishedName { CommonName = "root dev" },
	new ValidityPeriod { ValidFrom = DateTime.UtcNow, 
		ValidTo = DateTime.UtcNow.AddYears(10) },
	3, "localhost");
root.FriendlyName = "developement root certificate";

var intermediate = spCerts.NewIntermediateChainedCertificate(
	new DistinguishedName { CommonName = "intermediate dev"},
	new ValidityPeriod { ValidFrom = DateTime.UtcNow, 
		ValidTo = DateTime.UtcNow.AddYears(10) },
	2, "localhost", root);
intermediate.FriendlyName = "developement Intermediate certificate";

string password = "1234";
var iec = serviceProvider.GetService&lt;ImportExportCertificate&gt;();

var rootCertInPfxBtyes = iec.ExportRootPfx(password, root);
File.WriteAllBytes("root.pfx", rootCertInPfxBtyes);

var rootPublicKey = iec.ExportCertificatePublicKey(root);
var rootPublicKeyBytes = rootPublicKey.Export(X509ContentType.Cert);
File.WriteAllBytes($"root.cer", rootPublicKeyBytes);

var intermediateCertInPfxBtyes = iec.ExportChainedCertificatePfx(password, intermediate, root);
File.WriteAllBytes("intermediate.pfx", intermediateCertInPfxBtyes);

</pre><p><strong>Create a verify certificate for Azure IoT Hub (.pem or .cer)</strong></p><p>Once you upload the cer file to Azure IoT Hub, the certificate needs to be verified. To do this, you can create a pem export or a cer export of the certificate using the verify code from Azure IoT Hub. The root certificate from the previous code is used to create the verification certificate.</p><pre class="brush: csharp; title: ; notranslate" title="">var serviceProvider = new ServiceCollection()
	.AddCertificateManager()
	.BuildServiceProvider();

var spCerts = serviceProvider.GetService&lt;CreateCertificatesClientServerAuth&gt;();

var iec = serviceProvider.GetService&lt;ImportExportCertificate&gt;();

var root = new X509Certificate2("root.pfx", "1234");

var deviceVerify = spCerts.NewDeviceVerificationCertificate(
"4C8C754C6DA4280DBAB7FC7BB320E7FFFB7F411CBB7EAA7D", root);
deviceVerify.FriendlyName = "device verify";

var deviceVerifyPEM = iec.PemExportPublicKeyCertificate(deviceVerify);
File.WriteAllText("deviceVerify.pem", deviceVerifyPEM);

var deviceVerifyPublicKey = iec.ExportCertificatePublicKey(deviceVerify);
var deviceVerifyPKyBytes = deviceVerifyPublicKey.Export(X509ContentType.Cert);
File.WriteAllBytes($"deviceVerify.cer", deviceVerifyPKBytes);

</pre><p><strong>Create a device (Leaf) certificate for Azure IoT Hub device</strong></p><p>For each device, a device certificate can be created from the required intermediate certificate. The device certificate CommonName must match the Device ID from Azure IoT Hub, which is defined when a new device is created in Azure. The distinguished name CommonName property is used to set the Subject and Issuer CN which is used on Azure IoT Hub as part of the certificate validation.</p><pre class="brush: csharp; title: ; notranslate" title="">var serviceProvider = new ServiceCollection()
	.AddCertificateManager()
	.BuildServiceProvider();

var spCerts = serviceProvider.GetService&lt;CreateCertificatesClientServerAuth&gt;();

var intermediate = new X509Certificate2("intermediate.pfx", "1234");

var testDevice01 = spCerts.NewDeviceChainedCertificate(
	new DistinguishedName { CommonName = "TestDevice01" },
	new ValidityPeriod { ValidFrom = DateTime.UtcNow, 
		ValidTo = DateTime.UtcNow.AddYears(10) },
	"localhost", intermediate);
testDevice01.FriendlyName = "IoT device testDevice01";

string password = "1234";
var iec = serviceProvider.GetService&lt;ImportExportCertificate&gt;();

var deviceInPfxBytes = iec.ExportChainedCertificatePfx(
	password, 
	testDevice01, 
	intermediate);
File.WriteAllBytes("testDevice01.pfx", deviceInPfxBytes);

</pre><p><strong>Setup the Azure IoT Hub</strong></p><p>The Azure IoT Hub can then be setup using the certificates and these docs:</p><p><a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started" rel="nofollow">https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started</a></p><p><img data-attachment-id="13264" data-permalink="https://damienbod.com/2020/01/29/creating-certificates-for-x-509-security-in-azure-iot-hub-using-net-core/certsiothubazure_01/" data-orig-file="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png" data-orig-size="1582,694" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="CertsIoTHubAzure_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=640" src="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=640&amp;h=281" alt="" width="640" height="281" class="alignnone size-full wp-image-13264" srcset="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=640&amp;h=281 640w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=1280&amp;h=562 1280w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=150&amp;h=66 150w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=600&amp;h=263 600w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=768&amp;h=337 768w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_01.png?w=1024&amp;h=449 1024w" sizes="(max-width: 640px) 100vw, 640px"></p><p><strong>Simulate an Azure IoT Device to test</strong></p><p>Now that Azure IoT Hub is setup and ready to accept devices, you can test this with a simple device simulation. The following demo code was created using this Azure <a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started">documentation</a>.</p><p>The Microsoft.Azure.Devices.Client package is used to connect to the Hub.</p><pre class="brush: xml; title: ; notranslate" title="">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;

 &lt;PropertyGroup&gt;
  &lt;OutputType&gt;Exe&lt;/OutputType&gt;
  &lt;TargetFramework&gt;netcoreapp3.1&lt;/TargetFramework&gt;
 &lt;/PropertyGroup&gt;

 &lt;ItemGroup&gt;
  &lt;PackageReference Include="Microsoft.Azure.Devices.Client" Version="1.21.3" /&gt;
 &lt;/ItemGroup&gt;

 &lt;ItemGroup&gt;
  &lt;None Update="testDevice01.pfx"&gt;
     &lt;CopyToOutputDirectory&gt;PreserveNewest&lt;/CopyToOutputDirectory&gt;
  &lt;/None&gt;
 &lt;/ItemGroup&gt;
&lt;/Project&gt;

</pre><p>The simulator sends messages if the test application can connect to the Hub device. (Code from Azure docs)</p><p>We use the certificates created from above. The Device ID of the certificate and the device setup on Azure need to match.</p><p><img data-attachment-id="13265" data-permalink="https://damienbod.com/2020/01/29/creating-certificates-for-x-509-security-in-azure-iot-hub-using-net-core/certsiothubazure_02/" data-orig-file="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png" data-orig-size="1461,1011" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="CertsIoTHubAzure_02" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=640" src="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=640&amp;h=443" alt="" width="640" height="443" class="alignnone size-full wp-image-13265" srcset="https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=640&amp;h=443 640w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=1280&amp;h=886 1280w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=150&amp;h=104 150w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=600&amp;h=415 600w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=768&amp;h=531 768w, https://damienbod.files.wordpress.com/2020/01/certsiothubazure_02.png?w=1024&amp;h=709 1024w" sizes="(max-width: 640px) 100vw, 640px"></p><pre class="brush: csharp; title: ; notranslate" title="">using System;
using Microsoft.Azure.Devices.Client;
using Microsoft.Azure.Devices.Shared;
using System.Security.Cryptography.X509Certificates;
using System.Text;
using System.Threading.Tasks;

namespace SimulateAzureIoTDevice
{
    class Program
    {
        private static int MESSAGE_COUNT = 5;
        private const int TEMPERATURE_THRESHOLD = 30;
        private static String deviceId = "TestDevice01";
        private static float temperature;
        private static float humidity;
        private static Random rnd = new Random();

        static void Main(string[] args)
        {
            try
            {
                var cert = new X509Certificate2(@"testDevice01.pfx", "1234");
                var auth = new DeviceAuthenticationWithX509Certificate("TestDevice01", cert);
                var deviceClient = DeviceClient.Create("damienbod.azure-devices.net", auth, TransportType.Amqp_Tcp_Only);

                if (deviceClient == null)
                {
                    Console.WriteLine("Failed to create DeviceClient!");
                }
                else
                {
                    Console.WriteLine("Successfully created DeviceClient!");
                    SendEvent(deviceClient).Wait();
                }

                Console.WriteLine("Exiting...\n");
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error in sample: {0}", ex.Message);
            }
        }

        static async Task SendEvent(DeviceClient deviceClient)
        {
            string dataBuffer;
            Console.WriteLine("Device sending {0} messages to IoTHub...\n", MESSAGE_COUNT);

            for (int count = 0; count &lt; MESSAGE_COUNT; count++)
            {
                temperature = rnd.Next(20, 35);
                humidity = rnd.Next(60, 80);
                dataBuffer = string.Format("{{\"deviceId\":\"{0}\",\"messageId\":{1},\"temperature\":{2},\"humidity\":{3}}}", deviceId, count, temperature, humidity);
                Message eventMessage = new Message(Encoding.UTF8.GetBytes(dataBuffer));
                eventMessage.Properties.Add("temperatureAlert", (temperature &gt; TEMPERATURE_THRESHOLD) ? "true" : "false");
                Console.WriteLine("\t{0}&gt; Sending message: {1}, Data: [{2}]", DateTime.Now.ToLocalTime(), count, dataBuffer);

                await deviceClient.SendEventAsync(eventMessage);
            }
        }
    }
}

</pre><p>Now we have completely setup the certificates for Azure IoT Hub using .NET Core only code which can run on windows, Linux and Mac without scripts or other tools to create the certificates. The next step would be to automatic this process and persist the certificates in a safe way which can be managed. </p><p><strong>Links:</strong></p><p><a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started" rel="nofollow">https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started</a></p><p><a href="https://github.com/damienbod/AspNetCoreCertificates" rel="nofollow">https://github.com/damienbod/AspNetCoreCertificates</a></p><p><a href="https://www.nuget.org/packages/CertificateManager/" rel="nofollow">https://www.nuget.org/packages/CertificateManager/</a></p><div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><h3 class="jp-relatedposts-headline"><em>Related</em></h3></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>