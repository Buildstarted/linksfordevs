<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Optimize database traffic with future results in NHibernate - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Optimize database traffic with future results in NHibernate - linksfor.dev(s)"/>
    <meta property="article:author" content="Gunnar Peipman"/>
    <meta property="og:description" content="How to use future results and delayed queries in NHibernate to optimize database traffic. Send and retrieve multiple queries with one batch to database."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://gunnarpeipman.com/nhibernate-future-results/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Optimize database traffic with future results in NHibernate</title>
<div class="readable">
        <h1>Optimize database traffic with future results in NHibernate</h1>
            <div>by Gunnar Peipman</div>
            <div>Reading time: 7-9 minutes</div>
        <div>Posted here: 26 Mar 2020</div>
        <p><a href="https://gunnarpeipman.com/nhibernate-future-results/">https://gunnarpeipman.com/nhibernate-future-results/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><p>One nice feature that NHibernate has is future results. It is technically a capability to put queries on hold until data is actually asked. When data is asked from one delayed query then all queries are sent to database server as one batch and results are read also as one batch of multiple result sets. This blog post explains how to use future results with NHibernate.</p><h3>Why future results?</h3><p>Future results decrease traffic between application and database server. Most of database servers support processing of multiple queries sent as one batch resulting in returning multiple result sets with one batch.</p><p><picture><source data-srcset="https://static.gunnarpeipman.com/wp-content/uploads/2020/03/nhibernate-future-results.png.webp" type="image/webp" srcset="https://static.gunnarpeipman.com/wp-content/uploads/2020/03/nhibernate-future-results.png.webp"><img width="779" height="295" title="NHibernate future results" alt="NHibernate future results" src="https://static.gunnarpeipman.com/wp-content/uploads/2020/03/nhibernate-future-results.png" data-src="https://static.gunnarpeipman.com/wp-content/uploads/2020/03/nhibernate-future-results.png"></picture></p><p>Suppose we have a dashboard showing some charts, tables and gauges. We can send queries to database one by one. After sending query to server we have to wait when results are sent back and then we can execute next query. But our dashboard turns out to be an excellent use case for future results because all queries we need to execute are not dependent on other queries results.</p><blockquote><p><strong>As future results</strong> are used to query data from database you should consider using stateless session of NHibernate. Stateless session performs better as it doesn’t have change tracking enabled.</p></blockquote><h3>How to use future results?</h3><p>Using future results is actually easy. We build queries like usually but the last call in row is to ToFuture() or ToFutureValue() method. ToFuture() and ToFutureValue() methods put queries on hold until data is asked.</p><p>Let’s start with simple ASP.NET Core model for dashboard.</p><pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>DashboardModel</span><br>{<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>IList</span>&lt;<span>Task</span>&gt; MyPendingTasks { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>IList</span>&lt;<span>Task</span>&gt; MyOverDueTasks { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>IList</span>&lt;<span>WorkLog</span>&gt; MyWorkToday { <span>get</span>; <span>set</span>; }<br>}</pre><p>We need three database queries to get values to all properties of this model. Here are sample queries that are all delayed until data is actually asked in code.</p><pre><span>var</span>&nbsp;<span>myPendingTasks</span> = _nhSession.Query&lt;<span color="#2b91af">ProjectTask</span>&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Fetch</span>(<span>t</span> =&gt; <span>t</span>.Project)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Where</span>(<span>t</span> =&gt; <span>t</span>.AssignedTo.InternalName == <span>userName</span> &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>t</span>.Deadline <span>&gt;</span>&nbsp;<span>DateTime</span>.Now &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>t</span>.Status != <span>ProjectTaskStatusEnum</span>.Closed &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>t</span>.Status != <span>ProjectTaskStatusEnum</span>.WaitingForApproval)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Take</span>(10)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>ToFuture</span>();<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>myOverDueTasks</span> = _nhSession.Query&lt;</p><span color="#2b91af">ProjectTask</span>&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Fetch</span>(<span>t</span> =&gt; <span>t</span>.Project)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Where</span>(<span>t</span> =&gt; <span>t</span>.AssignedTo.InternalName == <span>userName</span> &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>t</span>.Deadline <span>&lt;</span>&nbsp;<span>DateTime</span>.Now &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>t</span>.Status != <span>ProjectTaskStatusEnum</span>.Closed &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>t</span>.Status != <span>ProjectTaskStatusEnum</span>.WaitingForApproval)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Take</span>(10)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>ToFuture</span>();<p> <span>var</span>&nbsp;<span>myWork</span> = _nhSession.Query&lt;</p><span color="#2b91af">WorkLog</span>&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Fetch</span>(<span>w</span> =&gt; <span>w</span>.Task)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>ThenFetch</span>(<span>w</span> =&gt; <span>w</span>.Project)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Where</span>(<span>w</span> =&gt; <span>w</span>.User.InternalName == <span>userName</span> &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>w</span>.Date <span>==</span>&nbsp;<span>DateTime</span>.Now.Date)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>ToFuture</span>();<p> <span>var</span>&nbsp;<span>model</span> = <span>new</span>&nbsp;<span>DashboardModel</span>();<br><span>model</span>.MyPendingTasks = (<span>await</span>&nbsp;<span>myPendingTasks</span>.<span>GetEnumerableAsync</span>()).<span>ToList</span>();<br><span>model</span>.MyOverDueTasks = (<span>await</span>&nbsp;<span>myOverDueTasks</span>.<span>GetEnumerableAsync</span>()).<span>ToList</span>();<br><span>model</span>.MyWorkToday = (<span>await</span>&nbsp;<span>myWork</span>.<span>GetEnumerableAsync</span>()).<span>ToList</span>();</p></pre><p>Asking of data happens when model.MyPendingTasks is assigned. Here’s the query that was sent to database server when data was asked first time from some of those delayed queries. <strong>NB!</strong> I left out fields list from FROM clauses to keep queries more readable.</p><pre><span>select</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; <span>...</span>&nbsp;<br><span>from</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; ProjectTasks projecttas0_ <br>&nbsp;&nbsp;&nbsp; <span>inner</span>&nbsp;<span>join</span> Users user1_ <span>on</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; projecttas0_<span>.</span>AssignedToId<span>=</span>user1_<span>.</span>Id <br>&nbsp;&nbsp;&nbsp; <span>left</span>&nbsp;<span>outer</span>&nbsp;<span>join</span> Projects project2_ <span>on</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; projecttas0_<span>.</span>ProjectId<span>=</span>project2_<span>.</span>Id <br><span>where</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; user1_<span>.</span>InternalName<span>=</span>@p0 <span>and</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; projecttas0_<span>.</span>Deadline<span>&gt;</span>@p1 <span>and</span>&nbsp;<br><span>&nbsp;&nbsp;&nbsp; </span><span>(</span>projecttas0_<span>.</span><span>Status</span><span>&lt;&gt;</span>@p2 <span>or</span> projecttas0_<span>.</span><span>Status</span>&nbsp;<span>is</span>&nbsp;<span>null)</span>&nbsp;<span>and</span>&nbsp;<br><span>&nbsp;&nbsp;&nbsp; </span><span>(</span>projecttas0_<span>.</span><span>Status</span><span>&lt;&gt;</span>@p3 <span>or</span> projecttas0_<span>.</span><span>Status</span>&nbsp;<span>is</span>&nbsp;<span>null)</span>&nbsp;<br><span>ORDER</span>&nbsp;<span>BY</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; <span>CURRENT_TIMESTAMP</span>&nbsp;<br>OFFSET 0 <span>ROWS</span>&nbsp;<span>FETCH</span>&nbsp;<span>FIRST</span> @p4 <span>ROWS</span> ONLY<span>;</span><p> <span>select</span><br>&nbsp;&nbsp;&nbsp; <span>...</span><br><span>from</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; ProjectTasks projecttas0_ <br>&nbsp;&nbsp;&nbsp; <span>inner</span>&nbsp;<span>join</span> Users user1_ <span>on</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; projecttas0_<span>.</span>AssignedToId<span>=</span>user1_<span>.</span>Id <br>&nbsp;&nbsp;&nbsp; <span>left</span>&nbsp;<span>outer</span>&nbsp;<span>join</span> Projects project2_ <span>on</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; projecttas0_<span>.</span>ProjectId<span>=</span>project2_<span>.</span>Id <br><span>where</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; user1_<span>.</span>InternalName<span>=</span>@p5 <span>and</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; projecttas0_<span>.</span>Deadline<span>&lt;</span>@p6 <span>and</span>&nbsp;<br><span>&nbsp;&nbsp;&nbsp; </span><span>(</span>projecttas0_<span>.</span><span>Status</span><span>&lt;&gt;</span>@p7 <span>or</span> projecttas0_<span>.</span><span>Status</span>&nbsp;<span>is</span>&nbsp;<span>null)</span>&nbsp;<span>and</span>&nbsp;<br><span>&nbsp;&nbsp;&nbsp; </span><span>(</span>projecttas0_<span>.</span><span>Status</span><span>&lt;&gt;</span>@p8 <span>or</span> projecttas0_<span>.</span><span>Status</span>&nbsp;<span>is</span>&nbsp;<span>null)</span>&nbsp;<br><span>ORDER</span>&nbsp;<span>BY</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; <span>CURRENT_TIMESTAMP</span>&nbsp;<br>OFFSET 0 <span>ROWS</span>&nbsp;<span>FETCH</span>&nbsp;<span>FIRST</span> @p9 <span>ROWS</span> ONLY<span>;</span></p><p> <span>select</span><br>&nbsp;&nbsp;&nbsp; <span>...</span><br><span>from</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; WorkLogs worklog0_ <br>&nbsp;&nbsp;&nbsp; <span>inner</span>&nbsp;<span>join</span> Users user1_ <span>on</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; worklog0_<span>.</span>UserId<span>=</span>user1_<span>.</span>Id <br>&nbsp;&nbsp;&nbsp; <span>left</span>&nbsp;<span>outer</span>&nbsp;<span>join</span> ProjectTasks projecttas2_ <span>on</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; worklog0_<span>.</span>TaskId<span>=</span>projecttas2_<span>.</span>Id <br>&nbsp;&nbsp;&nbsp; <span>left</span>&nbsp;<span>outer</span>&nbsp;<span>join</span> Projects project3_ <span>on</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; projecttas2_<span>.</span>ProjectId<span>=</span>project3_<span>.</span>Id <br><span>where</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; user1_<span>.</span>InternalName<span>=</span>@p10 <span>and</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; worklog0_<span>.</span>[Date]<span>=</span>@p11<span>;</span></p></pre><p>We can clearly see that it was batch of multiple queries that was sent to database server with one shot.</p><blockquote><p><strong>NB!</strong> If you want to mimic DbContext from Entity Framework Core then please take a look at my blog post <a title="NHibernate on ASP.NET Core" href="https://gunnarpeipman.com/aspnet-core-nhibernate/">NHibernate on ASP.NET Core</a>.</p></blockquote><h3>Using Count() with future results</h3><p>Using Count() function is not very straightforward but it’s there and it’s easy to use. I mentioned previously extension method called ToFutureValue(). This method helps us turn queries to count queries.</p><pre><span>var</span>&nbsp;<span>futureCount</span> = _nhSession.Query&lt;<span color="#2b91af">WorkLog</span>&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Fetch</span>(<span>w</span> =&gt; <span>w</span>.Task)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>ThenFetch</span>(<span>w</span> =&gt; <span>w</span>.Project)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>Where</span>(<span>w</span> =&gt; <span>w</span>.User.InternalName == <span>userName</span> &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>w</span>.Date <span>==</span>&nbsp;<span>DateTime</span>.Now.Date)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .<span>ToFutureValue</span>(<span>v</span> =&gt; <span>v</span>.<span>Count</span>());<p> <span>var</span>&nbsp;<span>count</span> = <span>await</span>&nbsp;<span>futureCount</span>.<span>GetValueAsync</span>();</p></pre><p>Here is the query sent to database.</p><pre><span>select</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; <span>cast</span><span>(</span><span>count</span><span>(*)</span>&nbsp;<span>as</span>&nbsp;<span>INT</span><span>)</span>&nbsp;<span>as</span> col_0_0_ <br><span>from</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; WorkLogs worklog0_ <br>&nbsp;&nbsp;&nbsp; <span>inner</span>&nbsp;<span>join</span> Users user1_ <span>on</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; worklog0_<span>.</span>UserId<span>=</span>user1_<span>.</span>Id <br><span>where</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; user1_<span>.</span>InternalName<span>=</span>@p0 <span>and</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; worklog0_<span>.</span>[Date]<span>=</span>@p1</pre><p>Same way we can use also other aggregate functions but also LINQ methods like Any(), FirstOrDefault(), etc.</p><blockquote><p><strong>NB!</strong> If you prefer to write queries using criteria API or if you don’t have any other option than criteria API then future results are also supported there. With criteria API you can also use <a title="Query batch (NHibernate documentation)" href="https://nhibernate.info/doc/nhibernate-reference/performance.html#performance-multi-query">query batches</a>. Query batches let you define sets of queries that are sent to database together. Future results are gathered by NHibernate and they are all executed as soon as data is actually asked from some future query.</p></blockquote><h3>Wrapping up</h3><p>Future results in NHibernate lead to decreased database traffic as all delayed queries are sent to database with one shot and results are also read back with one shot. It may put some additional load to client application but in these cases I suggest to use stateless sessions as they come with less overhead and no change tracking. Future results are not silver bullets and your mileage may vary. Like always – if you make any performance improvements to your application, make sure you measure the effect.</p></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>