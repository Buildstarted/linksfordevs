<!DOCTYPE html>
<html lang="en">
<head>
    <title>
BlazorHelp Website &gt; Blog - Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>BlazorHelp Website &gt; Blog - Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider</h1><div><div class="BlogBody"><acronym class="BlogPublished" title="12/22/2019 9:39 AM"><span class="BlogPubMonth"><span id="dnn_ctr382_MainView_ViewEntry_lblEntryMonth">Dec</span></span><span class="BlogPubDate"><span id="dnn_ctr382_MainView_ViewEntry_lblEntryDay">22</span></span></acronym><p class="BlogSubHead"><span class="blog_author"><span id="dnn_ctr382_MainView_ViewEntry_lblPostedBy">Written by:</span><span id="dnn_ctr382_MainView_ViewEntry_lblUserID">Michael Washington</span></span><br><span id="dnn_ctr382_MainView_ViewEntry_lblDateTime" class="BlogDate">12/22/2019 9:39 AM</span>&nbsp;
  <a id="dnn_ctr382_MainView_ViewEntry_lnkRss" href="http://blazorhelpwebsite.com/Blog/tabid/61/rssid/1/Default.aspx" target="_blank"><img id="dnn_ctr382_MainView_ViewEntry_lnkRssIcon" src="/desktopmodules/Blog/Images/feed-icon-12x12.gif" alt="RssIcon"></a></p><p><img src="/images/BlazorClientADAnimation.gif"></p><p>You can easily implement <strong>authentication</strong> for your <strong>Client Side</strong><strong>Blazor</strong> applications using <strong>Azure Active Directory</strong>. </p><p>We do this by <a href="https://docs.microsoft.com/en-us/aspnet/core/security/blazor/?view=aspnetcore-3.1&amp;tabs=visual-studio#implement-a-custom-authenticationstateprovider">Implementing a custom AuthenticationStateProvider</a>.</p><h1>Walk-Thru</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_56546721-92f4-4f70-9055-f03f2c80add2.png" width="579" height="174"></p><p>When we navigate to the <strong>Fetch data</strong> page, without being <em>logged in</em>, it will indicate that you <strong>Must be logged in</strong>.</p><p>To <em>log in</em>, click the <strong>Log In</strong> link.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_3110380a-cab6-444b-ba44-5c35c3263827.png" width="575" height="288"></p><p>You can <em>log in</em> with an <strong>Azure Active Directory</strong> account that has <a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/developer-guidance-for-integrating-applications">authorization to log into the Azure registered application</a>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_46165413-910c-4633-95ef-c5c82093bab6.png" width="577" height="328"></p><p>Once the user is <em>logged in</em>, navigating to the <strong>Fetch data</strong> page displays the data.</p><p>The <strong>logged in user’s name</strong> is also <em>displayed</em> at the top of the application.</p><h1>Install Blazor Client Side (Blazor WebAssembly)</h1><p>See the following directions to install <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/hosting-models?view=aspnetcore-3.1#blazor-webassembly">Blazor WebAssembly</a> (<strong>Client Side Blazor</strong>):</p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/get-started?view=aspnetcore-3.1&amp;tabs=visual-studio">https://docs.microsoft.com/en-us/aspnet/core/blazor/get-started?view=aspnetcore-3.1&amp;tabs=visual-studio</a></p><h1>Create The Project</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_8052552d-b995-4580-9372-7e07f3f3fc5d.png" width="80" height="92"></p><p>Open <a href="https://www.visualstudio.com/vs/">Visual Studio 2019</a> (or higher).</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_62aa192b-1667-4d55-baaf-859cfed1288e.png" width="373" height="106"></p><p>Create a <strong>new project</strong>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_f2a9a18a-8682-46b2-a5ca-8e3d8020bb8d.png" width="535" height="121"></p><p>Select <strong>Blazor App</strong>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_58c6fd09-500a-4ef6-b0be-83e62bc0e1f4.png" width="506" height="338"></p><p>Name the project <strong>BlazorClientAD</strong></p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_2e9f5c29-5a91-482a-a291-26d6d4c06661.png" width="707" height="462"></p><p>Select the <strong>ASP.NET 3.1 (or higher) Blazor WebAssembly</strong> template and select <strong>ASP.NET Core hosted</strong>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_18f9873a-3c3e-4607-9f5f-ef3a78ceacb3.png" width="263" height="502"></p><p>The <strong>Solution</strong> will be created.</p><p>Open the <strong>launchSettings.json</strong> file.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_c6a98d8f-81fe-4697-aa18-07bb287ac632.png" width="500" height="323"></p><p>Note the <strong>sslPort</strong>. </p><p>You will need it in the next section.</p><h1>Set-Up The Application In Azure</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_f607f0af-846b-485d-a27e-18eb954bb832.png" width="180" height="34"></p><p>You will need a <a href="https://azure.microsoft.com/en-us/free">free Azure Account</a> for the following steps.</p><p>Log into <a href="https://portal.azure.com/">https://portal.azure.com/</a> and select the <strong>Azure Active Directory</strong> node.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_c41b39f5-170c-4bcd-8598-47c92330743f.png" width="154" height="44"></p><p>Next, select <strong>App registrations</strong>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_70c5a31e-f6b9-42a4-a3ad-f213861e0c4e.png" width="156" height="38"></p><p>Select <strong>New registration</strong>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_63db6bf7-89ff-4a5b-b6fa-97569405ca6a.png" width="555" height="524"></p><p>Create a <strong>Registration</strong>.</p><p>For <strong>Redirect URI</strong>, select <strong>Web</strong>, and use the following url (<em>replacing</em> {<span>your sslPort</span>} with the number you copied earlier):</p><blockquote><p>https://localhost:{<span>your sslPort</span>}/signin-oidc</p></blockquote><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_420c30b2-2619-4a81-b24c-f43a9b90ac95.png" width="662" height="310"></p><p>On the <strong>Overview</strong> node for the application, <em>copy</em> the <strong>Application (client) ID</strong>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_7ff065d9-b994-4de6-82e3-2e02f237a621.png" width="742" height="270"></p><p>Click on the <strong>Authentication</strong> node and enable <strong>ID Tokens</strong>.</p><h1>Configure The Application</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_dbdd3b60-26e9-4852-a8ea-0901862c8db9.png" width="267" height="500"></p><p>Return to <strong>Visual Studio</strong>, and add a <strong>appsettings.json</strong> file to the <strong>Server</strong> project using the following code (replacing <span>{Your Application (client ID)}</span> with the <strong>ID</strong> you copied in the previous step):</p><pre><pre>{
</pre><pre>  "<span>AzureAd</span>": {
</pre><pre>    "Instance": "https://login.microsoftonline.com/common",
</pre><pre>    "ClientId": "<span>{Your Application (client) ID}</span>",
</pre><pre>    "<span>CallbackPath</span>": "/<span>signin-oidc</span>"
</pre><pre>  },
</pre><pre>  "<span>Logging</span>": {
</pre><pre>    "<span>LogLevel</span>": {
</pre><pre>      "Default": "Information",
</pre><pre>      "Microsoft": "Warning",
</pre><pre>      "Microsoft.Hosting.Lifetime": "Information"
</pre><pre>    }
</pre><pre>  },
</pre><pre>  "<span>AllowedHosts</span>": "*"
</pre><pre>}</pre></pre><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_0e3bc1f5-4e97-4d32-bb90-31e99394798d.png" width="382" height="228"></p><p><em>Right-click</em> on the <strong>Server</strong> project and select <strong>Manage NuGet Packages…</strong></p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_e1bc66e0-16ae-4e87-9861-ca16185d7905.png" width="678" height="361"></p><p>Install:</p><blockquote><p>Microsoft.AspNetCore.Authentication.AzureAD.UI</p></blockquote><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_1845272e-8f7b-47d1-a833-0697e9bd0094.png" width="298" height="327"></p><p><em>Right-click</em> on the <strong>Client </strong>project and select <strong>Manage NuGet Packages…</strong></p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_32b881b3-59ee-4a03-86bb-f9d53c77ea09.png" width="622" height="137"></p><p>Install:</p><blockquote><p>Microsoft.AspNetCore.Components.Authorization</p></blockquote><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_0caf410d-1836-43e8-ba6f-651835644fd0.png" width="217" height="166"></p><p>Open the <strong>Startup.cs</strong> file in the <strong>Server</strong> project.</p><p>Add the following <strong>using statements</strong>:</p><pre><pre><span>using</span> Microsoft.IdentityModel.Tokens;
</pre><pre><span>using</span> Microsoft.Extensions.Configuration;
</pre><pre><span>using</span> Microsoft.AspNetCore.Authentication.AzureAD.UI;
</pre><pre><span>using</span> Microsoft.AspNetCore.Authentication;
</pre><pre><span>using</span> Microsoft.AspNetCore.Authentication.OpenIdConnect;
</pre><pre><span>using</span> System.Threading.Tasks;</pre></pre><p>Add the following to the <strong>top</strong> of the class:</p><pre><pre><span>public</span> IConfiguration Configuration { <span>get</span>; }
</pre><pre><span>public</span> Startup(IConfiguration configuration)
</pre><pre>        {
</pre><pre>            Configuration = configuration;
</pre><pre>        }</pre></pre><p>Add the following to the end of the <strong>ConfigureServices</strong> section:</p><pre><pre>services.AddAuthentication(AzureADDefaults.AuthenticationScheme)
</pre><pre>    .AddAzureAD(options =&gt; Configuration.Bind("<span>AzureAd</span>", options));
</pre><pre></pre><pre>services.Configure&lt;OpenIdConnectOptions&gt;(AzureADDefaults.OpenIdScheme,
</pre><pre>options =&gt;
</pre><pre>{
</pre><pre>    options.TokenValidationParameters = <span>new</span> TokenValidationParameters
</pre><pre>    {
</pre><pre><span>// Instead of using the default validation (validating against a </span></pre><pre><span>// single issuer value, as we do in</span></pre><pre><span>// line of business apps), we inject our own multitenant </span></pre><pre><span>// validation logic</span></pre><pre>        ValidateIssuer = <span>false</span>,
</pre><pre></pre><pre><span>// If the app is meant to be accessed by entire organizations, </span></pre><pre><span>// add your issuer validation logic here.</span></pre><pre><span>// IssuerValidator = </span></pre><pre><span>// (issuer, securityToken, validationParameters) =&gt; {</span></pre><pre><span>//    if (myIssuerValidationLogic(issuer)) return issuer;</span></pre><pre><span>//}</span></pre><pre>    };
</pre><pre></pre><pre>    options.Events = <span>new</span> OpenIdConnectEvents
</pre><pre>    {
</pre><pre>        OnTicketReceived = context =&gt;
</pre><pre>        {
</pre><pre><span>// This is called on successful authentication</span></pre><pre><span>// This is an opportunity to write to the database </span></pre><pre><span>// or alter internal roles ect.</span></pre><pre><span>return</span> Task.CompletedTask;
</pre><pre>        },
</pre><pre>        OnAuthenticationFailed = context =&gt;
</pre><pre>        {
</pre><pre>            context.Response.Redirect("<span>/Error</span>");
</pre><pre>            context.HandleResponse(); <span>// Suppress the exception</span></pre><pre><span>return</span> Task.CompletedTask;
</pre><pre>        }
</pre><pre>    };
</pre><pre>});</pre></pre><p>Add the following to the <strong>Configure</strong> section (under the <strong>UseRouting()</strong> line):</p><pre><pre>            app.UseAuthentication();
</pre><pre>            app.UseAuthorization();</pre></pre><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_e3f1edda-6c61-4ec2-85d7-c57d1e6f4151.png" width="272" height="498"></p><p>In the <strong>Client</strong> project, open the <strong>_Imports.razor</strong> file and <u><strong>add</strong></u> the following lines:</p><pre><pre>@<span>using</span> Microsoft.AspNetCore.Authorization
</pre><pre>@<span>using</span> Microsoft.AspNetCore.Components.Authorization</pre></pre><h1>Server Side User Security</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_6a1229f2-9bfa-4b3e-a8d6-efe3582d6f99.png" width="274" height="512"></p><p>All security <em>must be enforced</em> in the <strong>Server</strong> project.</p><p>Add a file called <strong>BlazorUser.cs</strong> using the following code:</p><pre><pre><span>using</span> System;
</pre><pre><span>using</span> System.Collections.Generic;
</pre><pre><span>using</span> System.Text;
</pre><pre></pre><pre><span>namespace</span> BlazorClientAD.Shared
</pre><pre>{
</pre><pre><span>public</span><span>class</span> BlazorUser
</pre><pre>    {
</pre><pre><span>public</span><span>string</span> UserName { <span>get</span>; <span>set</span>; }
</pre><pre>    }
</pre><pre>}</pre></pre><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_223956bc-2d96-4d2b-b71e-65cfdc2f828b.png" width="250" height="187"></p><p>Add a file to the <strong>Controllers</strong> folder in the <strong>Server</strong> project called <strong>UserController.cs</strong> using the following code:</p><pre><pre><span>using</span> BlazorClientAD.Shared;</pre><pre><span>using</span> Microsoft.AspNetCore.Mvc;</pre><pre></pre><pre><span>namespace</span> BlazorClientAD.Server.Controllers</pre><pre>{</pre><pre>    [ApiController]</pre><pre><span>public</span><span>class</span> UserController : Controller</pre><pre>    {</pre><pre>        [HttpGet("<span>api/user/GetUser</span>")]</pre><pre><span>public</span> BlazorUser GetUser()</pre><pre>        {</pre><pre>            BlazorUser objBlazorUser = <span>new</span> BlazorUser();</pre><pre></pre><pre><span>if</span> (<span>this</span>.User.Identity.IsAuthenticated)
</pre><pre>            {
</pre><pre>                objBlazorUser.UserName = <span>this</span>.User.Identity.Name;
</pre><pre>            }</pre><pre><span>else</span></pre><pre>            {
</pre><pre>                objBlazorUser.UserName = "<span></span>"; <span>// Not logged in</span></pre><pre>            }</pre><pre></pre><pre><span>return</span> objBlazorUser;</pre><pre>        }</pre><pre>    }</pre><pre>}</pre></pre><p>This code provides a method for the<strong> Blazor client </strong>side <strong>custom authentication provider</strong> (that we will create later), to determine if the user is <em>logged in</em>.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_c032e04a-eb64-47df-84a2-a873fbd66e3a.png" width="255" height="190"></p><p>In the <strong>Controllers</strong> folder in the <strong>Server</strong> project, open the <strong>WeatherForecastController.cs</strong> file and add the following <em>using statement</em>:</p><pre><pre><span>using</span> Microsoft.AspNetCore.Authorization;</pre></pre><p>Add the following above the <em><strong>public IEnumerable&lt;WeatherForecast&gt; Get()</strong></em> method:</p><pre><pre>        [Authorize]</pre></pre><p>This will prevent <em>non-authenticated users</em> from calling this method.</p><p>This is where we are implementing the required <strong>server side security</strong> that <u>cannot</u> be <em>bypassed</em> by a user manipulating <strong>client side</strong> code in the <strong>Blazor WebAssembly</strong> project.</p><h1>Implement A Custom AuthenticationStateProvider</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_bfe911d8-c435-4602-aa43-835020461c57.png" width="287" height="433"></p><p>In the <strong>Client</strong> project, create a <strong>Util</strong> folder and a file called <strong>CustomAuthenticationProvider.cs</strong> with the following code:</p><pre><pre><span>using</span> BlazorClientAD.Shared;
</pre><pre><span>using</span> Microsoft.AspNetCore.Components;
</pre><pre><span>using</span> Microsoft.AspNetCore.Components.Authorization;
</pre><pre><span>using</span> System.Net.Http;
</pre><pre><span>using</span> System.Security.Claims;
</pre><pre><span>using</span> System.Threading.Tasks;
</pre><pre></pre><pre><span>namespace</span> BlazorClientAD</pre><pre>{</pre><pre><span>public</span><span>class</span> CustomAuthenticationProvider : AuthenticationStateProvider</pre><pre>    {
</pre><pre><span>private</span><span>readonly</span> HttpClient _httpClient;
</pre><pre></pre><pre><span>public</span> CustomAuthenticationProvider(HttpClient httpClient)
</pre><pre>        {
</pre><pre>            _httpClient = httpClient;
</pre><pre>        }</pre><pre></pre><pre><span>public</span><span>override</span> async Task&lt;AuthenticationState&gt;
</pre><pre>            GetAuthenticationStateAsync()</pre><pre>        {
</pre><pre>            ClaimsPrincipal user;
</pre><pre></pre><pre><span>// Call the GetUser method to get the status</span></pre><pre><span>// This only sets things like the AuthorizeView</span></pre><pre><span>// and the AuthenticationState CascadingParameter</span></pre><pre>            var result =
</pre><pre>                await _httpClient.GetJsonAsync&lt;BlazorUser&gt;("<span>api/user/GetUser</span>");
</pre><pre></pre><pre><span>// Was a UserName returned?</span></pre><pre><span>if</span> (result.UserName != "<span></span>")
</pre><pre>            {
</pre><pre><span>// Create a ClaimsPrincipal for the user</span></pre><pre>                var identity = <span>new</span> ClaimsIdentity(<span>new</span>[]
</pre><pre>                {
</pre><pre><span>new</span> Claim(ClaimTypes.Name, result.UserName),
</pre><pre>                }, "<span>AzureAdAuth</span>");
</pre><pre></pre><pre>                user = <span>new</span> ClaimsPrincipal(identity);
</pre><pre>            }
</pre><pre><span>else</span></pre><pre>            {
</pre><pre>                user = <span>new</span> ClaimsPrincipal(); <span>// Not logged in</span></pre><pre>            }
</pre><pre></pre><pre><span>return</span> await Task.FromResult(<span>new</span> AuthenticationState(user));</pre><pre>        }</pre><pre>    }</pre><pre>}</pre><pre></pre></pre><p>The purpose of this code is to call the <strong>GetUser</strong> method, created earlier, to determine if the user is <em>logged in</em>.</p><p>If the user is <em>logged in</em>, it creates a <strong>ClaimsPrincipal</strong> with a <strong>user</strong>, otherwise it creates a <strong>ClaimsPrincipal</strong> without a <strong>user</strong>. The <strong>Blazor</strong> security knows that a <strong>ClaimsPrincipal</strong> with a <strong>user</strong> indicates that a <strong>user</strong> is <em>logged in</em>.</p><p>In the next step, this class will be registered as the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/blazor/?view=aspnetcore-3.1&amp;tabs=visual-studio#authenticationstateprovider-service">AuthenticationStateProvider</a>, and the <strong>Blazor</strong> security will allow us to <em>show</em> and <em>hide</em> elements using the <em>built-in authentication</em><strong>tags</strong> and <strong>interfaces</strong>.</p><p>See this <strong>video</strong>: <a href="https://youtu.be/dCgqTDki-VM?t=1777">Blazor in more depth - Steve Sanderson &amp; Ryan Nowak</a> for a detailed explanation of exactly how this works.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_8e1f8301-3f28-4e18-a9cb-40a0143e015b.png" width="294" height="432"></p><p>In the <strong>Client</strong> project, open the <strong>Startup.cs</strong> file and add the following <em>using statement</em>:</p><pre><pre><span>using</span> Microsoft.AspNetCore.Components.Authorization;</pre></pre><p>Add the following to the <strong>ConfigureServices</strong> method:</p><pre><pre><span>// Must call AddAuthorizationCore for Blazor Client auth </span></pre><pre>    services.AddAuthorizationCore();
</pre><pre><span>// First register our CustomAuthenticationProvider</span></pre><pre>    services.AddScoped&lt;CustomAuthenticationProvider&gt;();
</pre><pre><span>// Use our CustomAuthenticationProvider as the </span></pre><pre><span>// AuthenticationStateProvider</span></pre><pre>    services.AddScoped&lt;AuthenticationStateProvider&gt;(
</pre><pre>        provider =&gt; provider
</pre><pre>        .GetRequiredService&lt;CustomAuthenticationProvider&gt;());</pre></pre><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_756d83f4-3b6b-41ae-90e6-5068ca05072d.png" width="271" height="360"></p><p>In the <strong>Client</strong> project, open the <strong>App.razor</strong> file and add <em>replace all the code</em> with the following:</p><pre><pre><span>&lt;</span><span>Router</span><span>AppAssembly</span>=<span>"@typeof(Program).Assembly"</span><span>&gt;</span></pre><pre><span>&lt;</span><span>Found</span><span>Context</span>=<span>"routeData"</span><span>&gt;</span></pre><pre><span>&lt;</span><span>AuthorizeRouteView</span><span>RouteData</span>=<span>"@routeData"</span><span>DefaultLayout</span>=<span>"@typeof(MainLayout)"</span><span>/&gt;</span></pre><pre><span>&lt;/</span><span>Found</span><span>&gt;</span></pre><pre><span>&lt;</span><span>NotFound</span><span>&gt;</span></pre><pre><span>&lt;</span><span>CascadingAuthenticationState</span><span>&gt;</span></pre><pre><span>&lt;</span><span>LayoutView</span><span>Layout</span>=<span>"@typeof(MainLayout)"</span><span>&gt;</span></pre><pre><span>&lt;</span><span>p</span><span>&gt;</span>Sorry, there's nothing at this address.<span>&lt;/</span><span>p</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>LayoutView</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>CascadingAuthenticationState</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>NotFound</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>Router</span><span>&gt;</span></pre></pre><p>This will <a href="https://docs.microsoft.com/en-us/aspnet/core/security/blazor/?view=aspnetcore-3.1&amp;tabs=visual-studio#authorization-in-blazor-webassembly-apps">implement authentication in the routing</a>.</p><h1>Create the Login / Logout Buttons</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_bed68a0b-a9aa-4c51-8de1-07f128931058.png" width="278" height="434"></p><p>In the <strong>Client</strong> project, add a <strong>LoginDisplay.razor</strong> file to the <strong>Shared</strong> directory using the following code:</p><pre><pre><span>&lt;</span><span>AuthorizeView</span><span>&gt;</span></pre><pre><span>&lt;</span><span>Authorized</span><span>&gt;</span></pre><pre><span>&lt;</span><span>h6</span><span>&gt;</span>Hello, @context.User.Identity.Name! <span>&lt;/</span><span>h6</span><span>&gt;</span></pre><pre><span>&lt;</span><span>a</span><span>href</span>=<span>"AzureAD/Account/SignOut"</span><span>&gt;</span>[Log out]<span>&lt;/</span><span>a</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>Authorized</span><span>&gt;</span></pre><pre><span>&lt;</span><span>NotAuthorized</span><span>&gt;</span></pre><pre><span>&lt;</span><span>a</span><span>href</span>=<span>"AzureAD/Account/SignIn"</span><span>&gt;</span>[Log in]<span>&lt;/</span><span>a</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>NotAuthorized</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>AuthorizeView</span><span>&gt;</span></pre></pre><p>Notice this directs the user to <em>endpoints</em> that begin with <em>AzureAD/Account</em>.</p><p>These endpoints will be serviced by code from the <em>Microsoft.AspNetCore.Authentication.AzureAD.UI</em><strong>NuGet package</strong> that was installed earlier.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_0d382b16-b9ac-49b3-bc7d-91bfeb64cbe1.png" width="266" height="430"></p><p>In the <strong>Client</strong> project, open the <strong>MainLayout.razor</strong> file and add <em>replace all the code</em> with the following:</p><pre><pre><span>@</span>inherits LayoutComponentBase
</pre><pre></pre><pre><span>&lt;</span><span>div</span><span>class</span>=<span>"sidebar"</span><span>&gt;</span></pre><pre><span>&lt;</span><span>NavMenu</span><span>/&gt;</span></pre><pre><span>&lt;/</span><span>div</span><span>&gt;</span></pre><pre></pre><pre><span>&lt;</span><span>div</span><span>class</span>=<span>"main"</span><span>&gt;</span></pre><pre><span>&lt;</span><span>div</span><span>class</span>=<span>"top-row px-4"</span><span>&gt;</span></pre><pre><span>&lt;</span><span>LoginDisplay</span><span>/&gt;</span></pre><pre><span>&lt;/</span><span>div</span><span>&gt;</span></pre><pre></pre><pre><span>&lt;</span><span>div</span><span>class</span>=<span>"content px-4"</span><span>&gt;</span></pre><pre><span>@</span>Body
</pre><pre><span>&lt;/</span><span>div</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>div</span><span>&gt;</span></pre></pre><p>This adds the <strong>LoginDisplay </strong>control to the top of the page in the application.</p><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_e4beceb6-c7c3-419e-af31-bcc0992405bb.png" width="259" height="414"></p><p>In the <strong>Client</strong> project, open the <strong>Index.razor</strong> file in the <strong>Pages</strong> directory, and add the following to the top of the file:</p><pre><pre><span>@</span>page "<span>/Account/SignOut</span>"</pre></pre><p>When the user <em>logs out</em> of the application, the user will be sent to the <em>Account/SignOut</em> url. This code allows the <strong>Index.razor</strong> page to also service that destination.</p><h1>Consume The Blazor Client Side Security</h1><p><img title="image" border="0" alt="image" src="/Portals/0/Blog/Files/1/4370/Windows-Live-Writer-d1e22ca31329_1218A-image_c3b0c766-5535-4741-9317-4e994eb1ecf1.png" width="263" height="414"></p><p>Finally, in the <strong>Client</strong> project, open the <strong>FetchData.razor</strong> file, in the <strong>Pages</strong> directory, and add <em>replace all the code</em> with the following:</p><pre><pre>@page "<span>/fetchdata</span>"
</pre><pre>@<span>using</span> BlazorClientAD.Shared
</pre><pre>@inject HttpClient Http</pre></pre><pre><pre><span>&lt;</span><span>h1</span><span>&gt;</span>Weather forecast<span>&lt;/</span><span>h1</span><span>&gt;</span></pre><pre></pre><pre><span>&lt;</span><span>p</span><span>&gt;</span>This component demonstrates fetching data from the server.<span>&lt;/</span><span>p</span><span>&gt;</span></pre><pre><span>&lt;</span><span>AuthorizeView</span><span>&gt;</span></pre><pre><span>&lt;</span><span>Authorized</span><span>&gt;</span></pre><pre>        @if (forecasts == null)
</pre><pre>        {
</pre><pre><span>&lt;</span><span>p</span><span>&gt;</span><span>&lt;</span><span>em</span><span>&gt;</span>Loading...<span>&lt;/</span><span>em</span><span>&gt;</span><span>&lt;/</span><span>p</span><span>&gt;</span></pre><pre>        }
</pre><pre>        else
</pre><pre>        {
</pre><pre><span>&lt;</span><span>table</span><span>class</span>=<span>"table"</span><span>&gt;</span></pre><pre><span>&lt;</span><span>thead</span><span>&gt;</span></pre><pre><span>&lt;</span><span>tr</span><span>&gt;</span></pre><pre><span>&lt;</span><span>th</span><span>&gt;</span>Date<span>&lt;/</span><span>th</span><span>&gt;</span></pre><pre><span>&lt;</span><span>th</span><span>&gt;</span>Temp. (C)<span>&lt;/</span><span>th</span><span>&gt;</span></pre><pre><span>&lt;</span><span>th</span><span>&gt;</span>Temp. (F)<span>&lt;/</span><span>th</span><span>&gt;</span></pre><pre><span>&lt;</span><span>th</span><span>&gt;</span>Summary<span>&lt;/</span><span>th</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>tr</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>thead</span><span>&gt;</span></pre><pre><span>&lt;</span><span>tbody</span><span>&gt;</span></pre><pre>                    @foreach (var forecast in forecasts)
</pre><pre>                    {
</pre><pre><span>&lt;</span><span>tr</span><span>&gt;</span></pre><pre><span>&lt;</span><span>td</span><span>&gt;</span>@forecast.Date.ToShortDateString()<span>&lt;/</span><span>td</span><span>&gt;</span></pre><pre><span>&lt;</span><span>td</span><span>&gt;</span>@forecast.TemperatureC<span>&lt;/</span><span>td</span><span>&gt;</span></pre><pre><span>&lt;</span><span>td</span><span>&gt;</span>@forecast.TemperatureF<span>&lt;/</span><span>td</span><span>&gt;</span></pre><pre><span>&lt;</span><span>td</span><span>&gt;</span>@forecast.Summary<span>&lt;/</span><span>td</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>tr</span><span>&gt;</span></pre><pre>                    }
</pre><pre><span>&lt;/</span><span>tbody</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>table</span><span>&gt;</span></pre><pre>        }
</pre><pre><span>&lt;/</span><span>Authorized</span><span>&gt;</span></pre><pre><span>&lt;</span><span>NotAuthorized</span><span>&gt;</span></pre><pre><span>&lt;</span><span>p</span><span>&gt;</span>Must be logged in<span>&lt;/</span><span>p</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>NotAuthorized</span><span>&gt;</span></pre><pre><span>&lt;/</span><span>AuthorizeView</span><span>&gt;</span></pre><pre></pre></pre><pre><pre><span>@</span>code {
</pre><pre>    [CascadingParameter]
</pre><pre><span>private</span> Task&lt;AuthenticationState&gt;
</pre><pre>        authenticationStateTask
</pre><pre>    { <span>get</span>; <span>set</span>; }
</pre><pre></pre><pre><span>private</span> WeatherForecast[] forecasts;
</pre><pre></pre><pre><span>protected</span><span>override</span> async Task OnInitializedAsync()
</pre><pre>    {
</pre><pre>        var authState = await authenticationStateTask;
</pre><pre>        var user = authState.User;
</pre><pre><span>if</span> (user.Identity != <span>null</span>)
</pre><pre>        {
</pre><pre><span>if</span> (user.Identity.IsAuthenticated)
</pre><pre>            {
</pre><pre>                forecasts =
</pre><pre>                    await Http
</pre><pre>                    .GetJsonAsync&lt;WeatherForecast[]&gt;("<span>WeatherForecast</span>");
</pre><pre>            }
</pre><pre>        }
</pre><pre>    }
</pre><pre>}</pre></pre><p>The <strong>AuthorizeView</strong> tag and <strong>AuthenticationState</strong><a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/components?view=aspnetcore-3.1#cascading-values-and-parameters">Cascading Parameter</a> will be triggered by the <strong>custom authentication provider</strong> created earlier.</p><p><strong>Note:</strong> This is helpful for the application to determine what should be shown, but, because <strong>Blazor Client Side security</strong> can be <em>bypassed</em>, security <u>must always be enforced</u> in the <strong>server side code</strong>.</p><h1>Links</h1><p><strong><a href="https://blazor.net/">Blazor.net</a></strong></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/blazor/?view=aspnetcore-3.0&amp;tabs=visual-studio">ASP.NET Core Blazor authentication and authorization</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/blazor/?view=aspnetcore-3.1&amp;tabs=visual-studio#implement-a-custom-authenticationstateprovider">Implement a custom AuthenticationStateProvider</a></p><p><a href="https://youtu.be/dCgqTDki-VM?t=1777">Blazor in more depth - Steve Sanderson &amp; Ryan Nowak</a></p><p><a href="https://chrissainty.com/building-a-blogging-app-with-blazor-adding-authentication/">Adding Authentication</a> (Chris Sainty)</p><p><a href="https://www.mikesdotnetting.com/article/342/managing-authentication-token-expiry-in-webassembly-based-blazor">Managing Authentication Token Expiry In WebAssembly-based Blazor</a></p><p><a href="/Blog/tabid/61/EntryId/4358/Blazor-Microsoft-Graph-Calendar-Example-With-Active-Directory-Authentication.aspx">Blazor Microsoft Graph Calendar Example With Active Directory Authentication</a></p><h1>Download</h1><p>The project is available at <a href="/Downloads.aspx">http://Blazorhelpwebsite.com/Downloads.aspx</a></p><p>You must have <strong>Visual Studio 2019 </strong>(or higher) installed to run the code.</p><div id="dnn_ctr382_MainView_ViewEntry_pnlComments"><p><a href="#AddComment"><span id="dnn_ctr382_MainView_ViewEntry_lblComments" class="BlogComments">7 comment(s) so far...</span></a></p><br><table id="dnn_ctr382_MainView_ViewEntry_lstComments" cellspacing="0" width="100%"><tbody><tr><td><div id="dnn_ctr382_MainView_ViewEntry_lstComments_divBlogBubble_0" class="BlogBubble"><blockquote><p><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblTitle_0" class="NormalBold">Re: Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider</span></p><p>
       Great tutorial! Is it possible this may be modified to accommodate Azure B2C?
      </p></blockquote><cite><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblUserName_0" class="NormalBold">By Adam on </span>
      &nbsp;
      <span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblCommentDate_0" class="Normal">1/7/2020 7:19 AM</span></cite></div></td></tr><tr><td><div id="dnn_ctr382_MainView_ViewEntry_lstComments_divBlogBubble_1" class="BlogBubbleOwner"><blockquote><p><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblTitle_1" class="NormalBold">Re: Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider</span></p><p>
       @Adam - Yest it can. I don't have an example, sorry. However, you should be able to follow the steps from any .Net Core Azure B2C tutorial and it should work. 
      </p></blockquote><cite><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblUserName_1" class="NormalBold">By Michael Washington on </span>
      &nbsp;
      <span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblCommentDate_1" class="Normal">1/7/2020 7:21 AM</span></cite></div></td></tr><tr><td><div id="dnn_ctr382_MainView_ViewEntry_lstComments_divBlogBubble_2" class="BlogBubble"><blockquote><p><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblTitle_2" class="NormalBold">Azure AD B2C</span></p><p>
       @Adam, I used this tutorial for an Azure AD B2C Blazor project with just a few changes.</p><p>Basically, in the server project, replace AzureAD with AzureADB2C everywere. Examples:<br>- Nuget package Microsoft.AspNetCore.Authentication.AzureADB2C.UI (instead of Microsoft.AspNetCore.Authentication.AzureAD.UI)<br>- using Microsoft.AspNetCore.Authentication.AzureADB2C.UI;<br>- services.AddAuthentication(AzureADB2CDefaults.AuthenticationScheme)<br>.AddAzureADB2C(options =&gt; Configuration.Bind("AzureADB2C", options));<br>- services.Configure(AzureADB2CDefaults.OpenIdScheme,</p><p>In the client project in LoginDisplay.razor also replace AzureAD with AzureADB2C (href="AzureADB2C/Account/SignIn")</p><p>A little bit more complicated was the GetUser() method in the UserController, because depending on the configuration of your AD B2C tenant User.Identity.Name can be empty. In that case you must find an alternative to get the user name or use some other claim.</p><p>If you need to setup an AD B2C tenant from scratch, you can start with this tutorial: https://docs.microsoft.com/en-us/azure/active-directory-b2c/tutorial-create-tenant</p></blockquote><cite><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblUserName_2" class="NormalBold">By Marcel Wolterbeek on </span>
      &nbsp;
      <span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblCommentDate_2" class="Normal">1/8/2020 4:56 AM</span></cite></div></td></tr><tr><td><div id="dnn_ctr382_MainView_ViewEntry_lstComments_divBlogBubble_3" class="BlogBubble"><blockquote><p><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblTitle_3" class="NormalBold">Re: Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider</span></p><p>
       This is great thanks! Do you have an example that shows how to do B2C/AD Auth using JWT tokens?
      </p></blockquote><cite><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblUserName_3" class="NormalBold">By Andrew on </span>
      &nbsp;
      <span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblCommentDate_3" class="Normal">1/14/2020 5:19 AM</span></cite></div></td></tr><tr><td><div id="dnn_ctr382_MainView_ViewEntry_lstComments_divBlogBubble_4" class="BlogBubbleOwner"><blockquote><p><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblTitle_4" class="NormalBold">Re: Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider</span></p><p>
       @Andrew - Sorry, I don't have a JWT example. However, others have covered that and did a good job. See Chris Sainty.
      </p></blockquote><cite><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblUserName_4" class="NormalBold">By Michael Washington on </span>
      &nbsp;
      <span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblCommentDate_4" class="Normal">1/14/2020 5:20 AM</span></cite></div></td></tr><tr><td><div id="dnn_ctr382_MainView_ViewEntry_lstComments_divBlogBubble_5" class="BlogBubble"><blockquote><p><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblTitle_5" class="NormalBold">Re: Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider</span></p><p>
       Hi, I've been searching around and might be missing it but I'm wanting to make a blazor app which only uses client side similar to angular. However I'm having problems finding what the best way to make calls to azure ad authenticated apis. My blazor app is using azure ad to sign and in the app registration for it there is access to the api granted. When I sign in I see that I'm being granted access to both the api and the app however I dont believe my token is being sent to the api and I've used fiddler and am seeing the token is not applied. Any thoughts?
      </p></blockquote><cite><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblUserName_5" class="NormalBold">By Scott Blankenship on </span>
      &nbsp;
      <span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblCommentDate_5" class="Normal">1/16/2020 6:13 PM</span></cite></div></td></tr><tr><td><div id="dnn_ctr382_MainView_ViewEntry_lstComments_divBlogBubble_6" class="BlogBubbleOwner"><blockquote><p><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblTitle_6" class="NormalBold">Re: Client Side Blazor Authentication Using Azure AD and a Custom AuthenticationStateProvider</span></p><p>
       @Scott Blankenship - For an example of calling an API like Microsoft Graph see: http://blazorhelpwebsite.com/Blog/tabid/61/EntryId/4358/Blazor-Microsoft-Graph-Calendar-Example-With-Active-Directory-Authentication.aspx
      </p></blockquote><cite><span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblUserName_6" class="NormalBold">By Michael Washington on </span>
      &nbsp;
      <span id="dnn_ctr382_MainView_ViewEntry_lstComments_lblCommentDate_6" class="Normal">1/16/2020 6:14 PM</span></cite></div></td></tr></tbody></table></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>