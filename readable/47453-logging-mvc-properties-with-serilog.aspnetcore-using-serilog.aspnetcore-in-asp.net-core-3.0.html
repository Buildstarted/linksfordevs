<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Logging MVC properties with Serilog.AspNetCore: Using Serilog.AspNetCore in ASP.NET Core 3.0 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Logging MVC properties with Serilog.AspNetCore: Using Serilog.AspNetCore in ASP.NET Core 3.0</h1><div><div class="post-content"><p>In my previous post I described how to configure Serilog's RequestLogging middleware to add additional properties (such as the request hostname or the selected endpoint name) to Serilog's request log summary. These properties are available from <code>HttpContext</code> so can be added directly by the middleware itself. </p><p>Other properties, such as MVC-specific features like the action method ID, RazorPages Handler name, or the ModelValidationState are <em>only</em> available in an MVC context, so can't be directly accessed by Serilog's middleware.</p><p>In this post I show how you can create action/page filters to record these properties for you, which the middleware can access later when creating the log.</p><blockquote><p><a href="https://nblumhardt.com/2019/10/serilog-mvc-logging/">Nicholas Blumhardt, creator of Serilog, has addressed this topic before</a>. The solutions are very similar, though in his example he creates an attribute that you can use to decorate on actions/controllers. I skip that approach in this post, and require it be applied globally, which I expect will be the common use case. Be sure to check out <a href="https://nblumhardt.com/2019/10/serilog-in-aspnetcore-3/">his previous comprehensive post on Serilog in ASP.NET Core 3.0</a> as well!</p></blockquote><h2 id="recording-additional-information-from-mvc" class="heading-with-anchor">Recording additional information from MVC<a href="#recording-additional-information-from-mvc"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>A common thread in ASP.NET Core as it stands is that there's a lot of behaviour "locked-up" inside the MVC "infrastructure". Endpoint routing was one of the first efforts to take an MVC-feature and move it down into the core framework. There's an ongoing effort in the ASP.NET Core team to push more MVC specific features (for example model binding or action results) out of MVC and "down" into the core framework. <a href="https://www.youtube.com/watch?v=7dJBmV_psW0">See Ryan Nowak's discussion of Project Houdini at NDC for more on this</a>).</p><p>However, as it stands, there are still some things inside MVC that aren't easy to get to from other parts of the application. When we consider that in terms of <a href="/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/">Serilog's request logging middleware</a>, that means there are some things that we can't easily log. For example:</p><ul><li>HandlerName (<code>OnGet</code>)</li><li>ActionId (<code>1fbc88fa-42db-424f-b32b-c2d0994463f1</code>)</li><li>ActionName (<code>MyController.SomeApiMethod (MyTestApp)</code>)</li><li>RouteData (<code>{action = "SomeApiMethod", controller = "My", page = ""}</code>)</li><li>ValidationState (<code>True</code>/<code>False</code>)</li></ul><p>In <a href="/using-serilog-aspnetcore-in-asp-net-core-3-logging-the-selected-endpoint-name-with-serilog/">the previous post</a> I showed how you can use the <code>IDiagnosticContext</code> to write additional values to Serilog's request log using an extension of the RequestLogging middleware. This only works for values that are available in <code>HttpContext</code>. In this post I show how you can use the <code>IDiagnosticContext</code> in an <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-3.0">action filter</a> to add MVC-specific values to the log as well. I also show how you can add RazorPages-specific values (like <code>HandlerName</code>) by using a <a href="https://docs.microsoft.com/en-us/aspnet/core/razor-pages/filter?view=aspnetcore-3.0#implement-razor-page-filters-globally">page filter</a>.</p><h2 id="logging-mvc-properties-with-a-custom-action-filter" class="heading-with-anchor">Logging MVC properties with a custom action filter<a href="#logging-mvc-properties-with-a-custom-action-filter"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Filters are the MVC equivalent of a mini middleware pipeline that runs for every request. There are multiple types of filter, each running at a different point in the MVC filter pipeline (<a href="/asp-net-core-in-action-filters/">see this post for more details</a>). We're going to be using one of the most common filters in this post, an action filter.</p><p>Action filters run just before, and just after, an MVC action method is executed. They have access to lots of MVC-specific values like the Action being executed and the parameters that it will be called with.</p><p>The action filter below directly implements <code>IActionFilter</code>. The <code>OnActionExecuting</code> method is called just before the action method is invoked, and adds the extra MVC-specific properties to the <code>IDiagnosticContext</code> passed in to the constructor.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">SerilogLoggingActionFilter</span><span class="token punctuation">:</span><span class="token class-name">IActionFilter</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IDiagnosticContext</span> _diagnosticContext<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">SerilogLoggingActionFilter</span><span class="token punctuation">(</span><span class="token class-name">IDiagnosticContext</span> diagnosticContext<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _diagnosticContext <span class="token operator">=</span> diagnosticContext<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">OnActionExecuting</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"RouteData"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>ActionDescriptor<span class="token punctuation">.</span>RouteValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"ActionName"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>ActionDescriptor<span class="token punctuation">.</span>DisplayName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"ActionId"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>ActionDescriptor<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"ValidationState"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>ModelState<span class="token punctuation">.</span>IsValid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">OnActionExecuted</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutedContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>You can register the filter globally when you add the MVC services to your application in <code>Startup.ConfigureServices()</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span>opts <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
        opts<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Add</span><span class="token punctuation">&lt;</span><span class="token class-name">SerilogLoggingPageFilter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p>You can add the filter globally in the same way whether you're using <code>AddControllers</code>, <code>AddControllersWithViews</code>, <code>AddMvc</code>, or <code>AddMvcCore</code>.</p></blockquote><p>With this configuration complete, if you call an MVC controller, you'll see the extra data (<code>ActionName</code>, <code>ActionId</code>, and <code>RouteData</code>, <code>ValidationState</code>) recorded on the Serilog request log message:</p><p><img src="/content/images/2019/serilog_action_name.png" alt="Image of extra MVC properties being recorded on Serilog request log"></p><p>You can add any additional data you require to your logs here. Just be careful about logging parameter values - you don't want to accidentally log sensitive or personally identifiable information! </p><blockquote><p>The action filter that <a href="https://nblumhardt.com/2019/10/serilog-mvc-logging/">Nicholas Blumhardt suggests in his post</a> derives from <code>ActionFilterAttribute</code>, so it can be applied directly as an attribute to controllers and actions. Unfortunately that means you have to use service location to retrieve the singleton <code>IDiagnosticContext</code> from the <code>HttpContext</code> for every request. My approach can use constructor injection instead, but it can't be applied as an attribute, so it must be used globally as shown above. Also, MVC will use a scoped lifetime for my implementation rather than a singleton, so it creates a new instance each request.</p></blockquote><p>If you want to log values from other points in the MVC filter pipeline, you can always implement other filters in similar ways, such as a resource filter, result filter, or authorization filter.</p><h2 id="logging-razorpages-properties-with-a-custom-page-filter" class="heading-with-anchor">Logging RazorPages properties with a custom page filter<a href="#logging-razorpages-properties-with-a-custom-page-filter"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The <code>IActionFilter</code> above runs for both MVC and API controllers, but it <em>won't</em> run for RazorPages. If you want to log the HandlerName that was selected for a given Razor Page, you'll need to create a custom <code>IPageFilter</code> instead.</p><p>Page filters are directly analogous to action filters, but they only run for Razor Pages. The example below retrieves the handler name from the <code>PageHandlerSelectedContext</code> and logs it as the property <code>RazorPageHandler</code>. There's a bit more boiler-plate code required in this case but the meat of the filter is again very basic - call <code>IDiagnosticContext.Set()</code> to record a property.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">SerilogLoggingPageFilter</span><span class="token punctuation">:</span><span class="token class-name">IPageFilter</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IDiagnosticContext</span> _diagnosticContext<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">SerilogLoggingPageFilter</span><span class="token punctuation">(</span><span class="token class-name">IDiagnosticContext</span> diagnosticContext<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _diagnosticContext <span class="token operator">=</span> diagnosticContext<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">OnPageHandlerSelected</span><span class="token punctuation">(</span><span class="token class-name">PageHandlerSelectedContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> name <span class="token operator">=</span> context<span class="token punctuation">.</span>HandlerMethod<span class="token operator">?</span><span class="token punctuation">.</span>Name <span class="token operator">?</span><span class="token operator">?</span> context<span class="token punctuation">.</span>HandlerMethod<span class="token operator">?</span><span class="token punctuation">.</span>MethodInfo<span class="token punctuation">.</span>Name<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            _diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"RazorPageHandler"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">OnPageHandlerExecuted</span><span class="token punctuation">(</span><span class="token class-name">PageHandlerExecutedContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">OnPageHandlerExecuting</span><span class="token punctuation">(</span><span class="token class-name">PageHandlerExecutingContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Note that the <code>IActionFilter</code> we wrote previously <em>won't</em> run for Razor Pages, so if you want to record additional details like <code>RouteData</code> or <code>ValidationState</code> for RazorPages too, then you'll need to add that here too. The <code>context</code> property contains most of the properties you could want, like the <code>ModelState</code> and <code>ActionDescriptor</code>.</p><p>Next you need to register the page filter in your <code>Startup.ConfigureServices()</code> method. <a href="https://docs.microsoft.com/en-us/aspnet/core/razor-pages/filter?view=aspnetcore-3.0#implement-razor-page-filters-globally">The docs show an approach that requires creating the filter up-front</a>, but that doesn't work when your filter uses constructor injection parameters (as in this case). Instead, you can register the page filter in the standard MVC filters list exposed in <code>AddMvcCore()</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddMvcCore</span><span class="token punctuation">(</span>opts <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
        opts<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Add</span><span class="token punctuation">&lt;</span><span class="token class-name">SerilogLoggingPageFilter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>This feels a bit naff, but it works. 🤷‍♂️</p><p>With the filter added, requests to your Razor Pages can now add additional properties the the <code>IDiagnosticContext</code> which are added to the Serilog request log. See the <code>RazorPageHandler</code> property in the image below:</p><p><img src="/content/images/2019/serilog_razor_handler.png" alt="Image of extra Razor Page properties being recorded on Serilog request log"></p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>By default, when you replace the ASP.NET Core infrastructure logging with Serilog's request logging middleware, you lose some information (compared to the default configuration for Development environments). In this post I show how you can customise Serilog's <code>RequestLoggingOptions</code> to add the MVC-specific additional properties back in. </p><p>To add MVC-related properties to the Serilog request log, create an <code>IActionFilter</code> and add the properties using <code>IDiagnosticContext.Set()</code>. To add Razor Page-related properties to the Serilog request log, create an <code>IPageFilter</code> and add properties using <code>IDiagnosticContext</code> in the same way.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>