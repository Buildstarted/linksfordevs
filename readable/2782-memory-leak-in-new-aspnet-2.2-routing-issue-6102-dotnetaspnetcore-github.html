<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Memory Leak in new ASPNET 2.2 routing? &#xB7; Issue #6102 &#xB7; dotnet/aspnetcore &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Memory Leak in new ASPNET 2.2 routing? ¬∑ Issue #6102 ¬∑ dotnet/aspnetcore ¬∑ GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><h3>Describe the bug</h3><p>I was editing some Razor Pages (the <code>Project\Pages</code> kind) then refreshing the changes in Chrome (Version 71.0.3578.98). My dev loop is tight, so I make a small edit then refresh the page, and the change is visible in Chrome.</p><p>Eventually, I noticed my edits were not making their way to the browser. On a few occasions, I noticed waiting a longer time delay before refreshing the browser <em>sometimes</em> helped the situation. Eventually, though, edits would no longer make their way to the browser.</p><p>Originally, I was using <code>InProcess</code> but decided to switch to <code>OutOfProcess</code>, rebooted PC, and the same problem occurred. Somewhere between 15 minutes to 1 hour of constantly editing Razor Pages in Visual Studio, I begin to notice my edits not showing up in the browser.</p><p>With out of <code>OutOfProcess</code> enabled, I noticed, a massive <strong>9.7 GB</strong> memory usage in <code>dotnet.exe</code></p><p><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377694-aae84600-05d6-11e9-9523-71e47f3ae378.png"><img src="https://user-images.githubusercontent.com/478118/50377694-aae84600-05d6-11e9-9523-71e47f3ae378.png" alt="procexp64_2548"></a></p><p>(later, trying to debug <code>dotnet.exe</code>, we're up at <strong>27GB</strong>)<br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377847-b426e200-05d9-11e9-94e5-f72ffb7a6c1b.png"><img src="https://user-images.githubusercontent.com/478118/50377847-b426e200-05d9-11e9-94e5-f72ffb7a6c1b.png" alt="devenv_2562"></a></p><p><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377696-b8053500-05d6-11e9-90ae-412cad8b3945.png"><img src="https://user-images.githubusercontent.com/478118/50377696-b8053500-05d6-11e9-90ae-412cad8b3945.png" alt="procexp64_2550"></a></p><p><code>dotnet.exe</code>:<br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377901-9dcd5600-05da-11e9-9bbd-ad9d0ff8c2d4.gif"><img src="https://user-images.githubusercontent.com/478118/50377901-9dcd5600-05da-11e9-9bbd-ad9d0ff8c2d4.gif" alt="screen_2567"></a></p><p>As <code>dotnet.exe</code> consumes memory, there appears to be a few threads that pop off <code>coreclr_shutdown</code>. Not much to discern, but worth noting.</p><p>Next, I attached a VS debugger to <code>dotnet.exe</code>, broke into the debugger and landed in <code>Program.Main()</code>. None of my user code was running. <strong>Continue &amp; Pausing</strong> the debugger multiple times did show one thread standing out. Specifically, <strong>Thread 3952</strong> playing around in the new ASPNET Core 22 routing code? <code>Microsoft.AspNetCore.Routing.DecisionTree</code>.</p><p>Specifically, <code>Array.Copy</code>, <code>DecisionTree.Resize</code> and <code>Capacity.set</code> seem to be popular destinations with <strong>Thread 3952</strong>. <strong>Thread 3952</strong> is the only thread that appears to be active during this memory leak.</p><p><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377752-e20b2700-05d7-11e9-8a49-2fe84149a71f.png"><img src="https://user-images.githubusercontent.com/478118/50377752-e20b2700-05d7-11e9-8a49-2fe84149a71f.png" alt="devenv_2561"></a><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377753-e59eae00-05d7-11e9-8296-e69c4fc3db04.png"><img src="https://user-images.githubusercontent.com/478118/50377753-e59eae00-05d7-11e9-8296-e69c4fc3db04.png" alt="devenv_2560"></a><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377755-edf6e900-05d7-11e9-9166-288de7001d94.png"><img src="https://user-images.githubusercontent.com/478118/50377755-edf6e900-05d7-11e9-9166-288de7001d94.png" alt="devenv_2558"></a><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377756-f0f1d980-05d7-11e9-8cbf-7779f42406eb.png"><img src="https://user-images.githubusercontent.com/478118/50377756-f0f1d980-05d7-11e9-8cbf-7779f42406eb.png" alt="devenv_2557"></a></p><h3>To Reproduce</h3><p>Steps to reproduce the behavior:</p><ol><li>Using this version of ASP.NET Core '2.2'</li><li>Edit somewhat complex Razor Pages for about 15 minutes to 1 hour in a tight dev loop.</li></ol><h3>Expected behavior</h3><p>I should be able to make edits in Razor Pages and see my changes in the browser without having to restart <code>IISExpress</code> or kill <code>dotnet.exe</code> manually or experience a memory leak during the editing experience.</p><h3>Additional context</h3><h4>Operating System</h4><h4>IDE</h4><pre><code>C:\&gt;dotnet --info
.NET Core SDK (reflecting any global.json):
 Version:   2.2.101
 Commit:    236713b0b7

Runtime Environment:
 OS Name:     Windows
 OS Version:  6.1.7601
 OS Platform: Windows
 RID:         win7-x64
 Base Path:   C:\Program Files\dotnet\sdk\2.2.101\

Host (useful for support):
  Version: 2.2.0
  Commit:  1249f08fed

.NET Core SDKs installed:
  1.0.0 [C:\Program Files\dotnet\sdk]
  1.0.1 [C:\Program Files\dotnet\sdk]
  1.0.2 [C:\Program Files\dotnet\sdk]
  1.0.3 [C:\Program Files\dotnet\sdk]
  1.0.4 [C:\Program Files\dotnet\sdk]
  1.1.0 [C:\Program Files\dotnet\sdk]
  2.0.0 [C:\Program Files\dotnet\sdk]
  2.0.3 [C:\Program Files\dotnet\sdk]
  2.1.4 [C:\Program Files\dotnet\sdk]
  2.1.101 [C:\Program Files\dotnet\sdk]
  2.1.103 [C:\Program Files\dotnet\sdk]
  2.1.104 [C:\Program Files\dotnet\sdk]
  2.1.200 [C:\Program Files\dotnet\sdk]
  2.1.201 [C:\Program Files\dotnet\sdk]
  2.1.202 [C:\Program Files\dotnet\sdk]
  2.1.300 [C:\Program Files\dotnet\sdk]
  2.1.302 [C:\Program Files\dotnet\sdk]
  2.1.401 [C:\Program Files\dotnet\sdk]
  2.1.402 [C:\Program Files\dotnet\sdk]
  2.1.403 [C:\Program Files\dotnet\sdk]
  2.1.500 [C:\Program Files\dotnet\sdk]
  2.1.502 [C:\Program Files\dotnet\sdk]
  2.2.100 [C:\Program Files\dotnet\sdk]
  2.2.101 [C:\Program Files\dotnet\sdk]

.NET Core runtimes installed:
  Microsoft.AspNetCore.All 2.1.0 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
  Microsoft.AspNetCore.All 2.1.2 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
  Microsoft.AspNetCore.All 2.1.3 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
  Microsoft.AspNetCore.All 2.1.4 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
  Microsoft.AspNetCore.All 2.1.5 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
  Microsoft.AspNetCore.All 2.1.6 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
  Microsoft.AspNetCore.All 2.2.0 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.All]
  Microsoft.AspNetCore.App 2.1.0 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
  Microsoft.AspNetCore.App 2.1.2 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
  Microsoft.AspNetCore.App 2.1.3 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
  Microsoft.AspNetCore.App 2.1.4 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
  Microsoft.AspNetCore.App 2.1.5 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
  Microsoft.AspNetCore.App 2.1.6 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
  Microsoft.AspNetCore.App 2.2.0 [C:\Program Files\dotnet\shared\Microsoft.AspNetCore.App]
  Microsoft.NETCore.App 1.0.4 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 1.0.5 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 1.1.1 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 1.1.2 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.0.0 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.0.3 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.0.5 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.0.6 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.0.7 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.0.9 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.1.0 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.1.2 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.1.3-servicing-26724-03 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.1.3 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.1.4 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.1.5 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.1.6 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]
  Microsoft.NETCore.App 2.2.0 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App]

To install additional .NET Core runtimes or SDKs:
  https://aka.ms/dotnet-download
</code></pre><p>Also, here is <strong>Process Monitor</strong> monitoring file access during the memory leak event:<br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/478118/50377780-5219ad00-05d8-11e9-9536-47f4bc8666ce.png"><img src="https://user-images.githubusercontent.com/478118/50377780-5219ad00-05d8-11e9-9536-47f4bc8666ce.png" alt="procmon64_2553"></a></p><hr><p>I will continue to do more testing to see if I can narrow down the issue. Thanks for your help in advance.</p><p>Thanks,<br>Brian Chavez</p><p><g-emoji class="g-emoji" alias="chocolate_bar" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f36b.png">üç´</g-emoji><g-emoji class="g-emoji" alias="cookie" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f36a.png">üç™</g-emoji><g-emoji class="g-emoji" alias="lollipop" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f36d.png">üç≠</g-emoji><a href="https://www.youtube.com/watch?v=GeIAXlwVlZc" rel="nofollow"><strong>Ronald Jenkees - Stay Crunchy</strong></a></p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>