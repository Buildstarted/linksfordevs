<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Fixing ASP.NET Core&#x27;s UseStatusCodePages Middleware -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Fixing ASP.NET Core's UseStatusCodePages Middleware</h1><div><div id="" class=""><p class="freshness" data-freshness-datetime="2019-08-02T11:30:59-04:00"><i class="icon heartbeat freshness-icon-js"></i><em>This post is <span class="freshness-days-old-js"></span> days old.</em></p><p>Here at RIMdev, we are unapologetic about our love for static websites. Folks, static sites are the future! That said, there are times we need a little dynamic in our lives. For our documentation site, we generate most of the content using Hugo and control access to content utilizing ASP.NET Core. From a user’s perspective, while navigating the site, they could see any number of HTTP status errors: 404 Not Found, 403 Forbidden, 500 Internal Server Errors. We wanted to make sure that not only a real user would see these errors, but crawlers and bots would see these errors in the response via HTTP semantics.</p><h2 id="just-use-statuscodepagemiddleware">Just Use StatusCodePageMiddleware!</h2><p>We started here, but found out someone interesting. Using <code class="language-plaintext highlighter-rouge">UseStatusCodePagesWithReExecute</code>, The middleware always returned a <code class="language-plaintext highlighter-rouge">200 OK</code> response, even if we were seeing our error page. The incorrect HTTP semantics isn’t ideal, as it may send the wrong message to search engine crawlers.</p><p><img src="/images/asp-net-core-statusmiddleware.png" alt="status code middleware result" class="img-fluid border"></p><p>I looked through the implementation, and no mention of <code class="language-plaintext highlighter-rouge">StatusCode</code> anywhere.</p><p>https://github.com/aspnet/AspNetCore/blob/master/src/Middleware/Diagnostics/src/StatusCodePage/StatusCodePagesExtensions.cs</p><h2 id="well-iis-customerrors-right">Well IIS CustomErrors Right?!</h2><p>I’ve actually written about using <a href="/hugo-error-pages-with-iis-in-windows-azure/">IIS custom error handling</a> and hoped this would work but…nope. The ASP.NET Core Pipeline doesn’t defer to IIS and I’m not sure it can. If you know what the issue is here, I’d love to know.</p><h2 id="custom-middleware">Custom Middleware</h2><p>The easiest approach was to write custom middleware. The following code is our current implementation. It can be enhanced to handle a collection of status codes and display an appropriate error page.</p><div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// &lt;summary&gt;</span><span class="c1">/// This writes the page out into the response using the</span><span class="c1">/// status code of the error that was generated (400,500,etc).</span><span class="c1">/// &lt;/summary&gt;</span><span class="c1">/// &lt;param name="app"&gt;&lt;/param&gt;</span><span class="c1">/// &lt;param name="filePath"&gt;The error page (based in wwwroot)&lt;/param&gt;</span><span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span><span class="c1">/// &lt;exception cref="ArgumentNullException"&gt;File path cannot be null&lt;/exception&gt;</span><span class="c1">/// &lt;exception cref="ArgumentException"&gt;File must exist&lt;/exception&gt;</span><span class="k">public</span><span class="k">static</span><span class="n">IApplicationBuilder</span><span class="nf">UseErrorPages</span><span class="p">(</span><span class="k">this</span><span class="n">IApplicationBuilder</span><span class="n">app</span><span class="p">,</span><span class="kt">string</span><span class="n">filePath</span><span class="p">)</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">app</span><span class="p">==</span><span class="k">null</span><span class="p">)</span><span class="k">throw</span><span class="k">new</span><span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">app</span><span class="p">));</span><span class="kt">var</span><span class="n">env</span><span class="p">=</span><span class="n">app</span><span class="p">.</span><span class="n">ApplicationServices</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IHostingEnvironment</span><span class="p">&gt;();</span><span class="kt">var</span><span class="n">file</span><span class="p">=</span><span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">WebRootPath</span><span class="p">,</span><span class="n">filePath</span><span class="p">);</span><span class="k">if</span><span class="p">(!</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="k">throw</span><span class="k">new</span><span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"file does not exist"</span><span class="p">,</span><span class="k">nameof</span><span class="p">(</span><span class="n">filePath</span><span class="p">));</span><span class="n">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="k">async</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">next</span><span class="p">)</span><span class="p">=&gt;</span><span class="p">{</span><span class="k">await</span><span class="n">next</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">();</span><span class="kt">var</span><span class="n">handled</span><span class="p">=</span><span class="n">context</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">ErrorPageFeature</span><span class="p">&gt;();</span><span class="kt">var</span><span class="n">statusCode</span><span class="p">=</span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="n">handled</span><span class="p">==</span><span class="k">null</span><span class="p">&amp;&amp;</span><span class="n">statusCode</span><span class="p">&gt;=</span><span class="m">400</span><span class="p">)</span><span class="p">{</span><span class="kt">var</span><span class="n">page</span><span class="p">=</span><span class="k">await</span><span class="n">File</span><span class="p">.</span><span class="nf">ReadAllTextAsync</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">=</span><span class="n">statusCode</span><span class="p">;</span><span class="k">await</span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="n">page</span><span class="p">);</span><span class="c1">// make sure we don't get into an infinite loop</span><span class="n">context</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="k">new</span><span class="nf">ErrorPageFeature</span><span class="p">());</span><span class="p">}</span><span class="p">});</span><span class="k">return</span><span class="n">app</span><span class="p">;</span><span class="p">}</span><span class="k">private</span><span class="k">class</span><span class="nc">ErrorPageFeature</span><span class="p">{</span><span class="p">}</span></code></pre></div></div><p>The thing I love about writing middleware in ASP.NET Core is the introduction of Features. We use our feature as an indicator that the error was handled and to prevent an infinite loop.</p><p>To use the middlware, just call it in your <code class="language-plaintext highlighter-rouge">Startup</code> file and pass it a static error page. In our instance we only have one error page (but are planning to have more).</p><div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="p">.</span><span class="nf">UseErrorPages</span><span class="p">(</span><span class="s">"404.html"</span><span class="p">);</span></code></pre></div></div><p>And it works!</p><p><img src="/images/asp-net-core-statusmiddleware-working.png" alt="status code middleware working" class="img-fluid border"></p><p>Hope you found this helpful, and I’d be happy to hear if you have a better solution.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>