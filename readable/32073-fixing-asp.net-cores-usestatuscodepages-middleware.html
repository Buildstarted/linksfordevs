<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Fixing ASP.NET Core&#x27;s UseStatusCodePages Middleware -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Fixing ASP.NET Core&#x27;s UseStatusCodePages Middleware</h1>
    <div class="ui middle aligned stackable text container"> <article> <p class="freshness"> <i class="icon heartbeat freshness-icon-js"></i> <em>This post is <span class="freshness-days-old-js"></span> days old.</em> </p> <p>Here at RIMdev, we are unapologetic about our love for static websites. Folks, static sites are the future! That said, there are times we need a little dynamic in our lives. For our documentation site, we generate most of the content using Hugo and control access to content utilizing ASP.NET Core. From a user&#x2019;s perspective, while navigating the site, they could see any number of HTTP status errors: 404 Not Found, 403 Forbidden, 500 Internal Server Errors. We wanted to make sure that not only a real user would see these errors, but crawlers and bots would see these errors in the response via HTTP semantics.</p> <h2 id="just-use-statuscodepagemiddleware">Just Use StatusCodePageMiddleware!</h2> <p>We started here, but found out someone interesting. Using <code class="highlighter-rouge">UseStatusCodePagesWithReExecute</code>, The middleware always returned a <code class="highlighter-rouge">200 OK</code> response, even if we were seeing our error page. The incorrect HTTP semantics isn&#x2019;t ideal, as it may send the wrong message to search engine crawlers.</p> <p><img src="/images/asp-net-core-statusmiddleware.png" alt="status code middleware result" class="img-fluid border"></p> <p>I looked through the implementation, and no mention of <code class="highlighter-rouge">StatusCode</code> anywhere.</p> <p>https://github.com/aspnet/AspNetCore/blob/master/src/Middleware/Diagnostics/src/StatusCodePage/StatusCodePagesExtensions.cs</p> <h2 id="well-iis-customerrors-right">Well IIS CustomErrors Right?!</h2> <p>I&#x2019;ve actually written about using <a href="/hugo-error-pages-with-iis-in-windows-azure/">IIS custom error handling</a> and hoped this would work but&#x2026;nope. The ASP.NET Core Pipeline doesn&#x2019;t defer to IIS and I&#x2019;m not sure it can. If you know what the issue is here, I&#x2019;d love to know.</p> <h2 id="custom-middleware">Custom Middleware</h2> <p>The easiest approach was to write custom middleware. The following code is our current implementation. It can be enhanced to handle a collection of status codes and display an appropriate error page.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// This writes the page out into the response using the</span>
<span class="c1">/// status code of the error that was generated (400,500,etc).</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="c1">/// &lt;param name=&quot;app&quot;&gt;&lt;/param&gt;</span>
<span class="c1">/// &lt;param name=&quot;filePath&quot;&gt;The error page (based in wwwroot)&lt;/param&gt;</span>
<span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="c1">/// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;File path cannot be null&lt;/exception&gt;</span>
<span class="c1">/// &lt;exception cref=&quot;ArgumentException&quot;&gt;File must exist&lt;/exception&gt;</span>
<span class="k">public</span> <span class="k">static</span> <span class="n">IApplicationBuilder</span> <span class="nf">UseErrorPages</span><span class="p">(</span> <span class="k">this</span> <span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="kt">string</span> <span class="n">filePath</span><span class="p">)</span>
<span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">app</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span> <span class="p">(</span><span class="n">app</span><span class="p">));</span> <span class="kt">var</span> <span class="n">env</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">ApplicationServices</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IHostingEnvironment</span><span class="p">&gt;();</span> <span class="kt">var</span> <span class="n">file</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">WebRootPath</span><span class="p">,</span> <span class="n">filePath</span><span class="p">);</span> <span class="k">if</span> <span class="p">(!</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">&quot;file does not exist&quot;</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">filePath</span><span class="p">));</span> <span class="n">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">await</span> <span class="n">next</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">();</span> <span class="kt">var</span> <span class="n">handled</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">ErrorPageFeature</span><span class="p">&gt;();</span> <span class="kt">var</span> <span class="n">statusCode</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="n">handled</span> <span class="p">==</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">statusCode</span> <span class="p">&gt;=</span> <span class="m">400</span><span class="p">)</span> <span class="p">{</span> <span class="kt">var</span> <span class="n">page</span> <span class="p">=</span> <span class="k">await</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllTextAsync</span><span class="p">(</span><span class="n">file</span><span class="p">);</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="n">statusCode</span><span class="p">;</span> <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="n">page</span><span class="p">);</span> <span class="c1">// make sure we don&apos;t get into an infinite loop</span> <span class="n">context</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="k">new</span> <span class="nf">ErrorPageFeature</span><span class="p">());</span> <span class="p">}</span> <span class="p">});</span> <span class="k">return</span> <span class="n">app</span><span class="p">;</span>
<span class="p">}</span> <span class="k">private</span> <span class="k">class</span> <span class="nc">ErrorPageFeature</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div> <p>The thing I love about writing middleware in ASP.NET Core is the introduction of Features. We use our feature as an indicator that the error was handled and to prevent an infinite loop.</p> <p>To use the middlware, just call it in your <code class="highlighter-rouge">Startup</code> file and pass it a static error page. In our instance we only have one error page (but are planning to have more).</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="p">.</span><span class="nf">UseErrorPages</span><span class="p">(</span><span class="s">&quot;404.html&quot;</span><span class="p">);</span>
</code></pre></div></div> <p>And it works!</p> <p><img src="/images/asp-net-core-statusmiddleware-working.png" alt="status code middleware working" class="img-fluid border"></p> <p>Hope you found this helpful, and I&#x2019;d be happy to hear if you have a better solution.</p> <div class="articles-footer"> <time class="ui horizontal divider center aligned">Published Aug 2, 2019 by</time> </div> </article> <p class="ui">Suggested reading</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>