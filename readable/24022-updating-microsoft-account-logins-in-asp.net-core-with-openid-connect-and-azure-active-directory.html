<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Updating Microsoft Account Logins in ASP.NET Core with OpenID Connect and Azure Active Directory -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Updating Microsoft Account Logins in ASP.NET Core with OpenID Connect and Azure Active Directory</h1><div><div class="entry-content"><p>This article shows how to implement an <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredAppsPreview">Azure Active Directory</a> login for an ASP.NET Core application. The <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/azure-ad-endpoint-comparison">Microsoft identity platform (v2.0)</a> is now <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-protocols-openid-connect-code">Open ID Connect</a> certified and the Microsoft Account logins can now be replaced with this. By using OpenID Connect instead of Microsoft Accounts, it is easy to force a login, or a consent screen as well as following a standard. A full signout can also be supported if required. The AddOpenIdConnect OIDC extension method should now be used instead of the AddMicrosoftAccount method. This replaces the existing post: <a href="https://damienbod.com/2017/07/11/adding-an-external-microsoft-login-to-identityserver4/">Adding an external Microsoft login to IdentityServer4</a>. It is still possible to use the <a href="https://apps.dev.microsoft.com" rel="nofollow">https://apps.dev.microsoft.com</a> if only Microsoft accounts are required.</p><p><strong>Code</strong><a href="https://github.com/damienbod/AspNetCoreID4External" rel="nofollow">https://github.com/damienbod/AspNetCoreID4External</a></p><p><strong>Updating Microsoft Account Logins in ASP.NET Core with OpenID Connect and Azure Active Directory</strong></p><p>If you open an existing Microsoft Account App configuration on <a href="https://apps.dev.microsoft.com" rel="nofollow">https://apps.dev.microsoft.com</a> , it will offer you the possibility to configure this on the Azure portal as an Azure Active Directory App. You can also create a new one using the <strong>Azure Active Directory/App Registrations/New Registration</strong> button. </p><p><img data-attachment-id="12431" data-permalink="https://damienbod.com/2019/05/17/updating-microsoft-account-logins-in-asp-net-core-with-openid-connect-and-azure-active-directory/aad_ms_login_01/" data-orig-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png" data-orig-size="1321,805" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_ms_login_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=640" src="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=640&amp;h=390" alt="" width="640" height="390" class="alignnone size-full wp-image-12431" srcset="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=640&amp;h=390 640w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=1280&amp;h=780 1280w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=150&amp;h=91 150w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=600&amp;h=366 600w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=768&amp;h=468 768w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_01.png?w=1024&amp;h=624 1024w" sizes="(max-width: 640px) 100vw, 640px"></p><p>We want to create an <strong>Accounts in any organizational directory and personal Microsoft accounts (e.g. Skype, Xbox, Outlook.com)</strong> type, because we would like that our AAD any other AAD or live accounts can login to our software. We also want to define the return URLs which are required. Live SDK support is also required.</p><p><img data-attachment-id="12432" data-permalink="https://damienbod.com/2019/05/17/updating-microsoft-account-logins-in-asp-net-core-with-openid-connect-and-azure-active-directory/aad_ms_login_02/" data-orig-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png" data-orig-size="1390,1526" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_ms_login_02" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=547" data-large-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=640" src="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=640&amp;h=703" alt="" width="640" height="703" class="alignnone size-full wp-image-12432" srcset="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=640&amp;h=703 640w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=1280&amp;h=1406 1280w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=137&amp;h=150 137w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=547&amp;h=600 547w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=768&amp;h=843 768w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_02.png?w=933&amp;h=1024 933w" sizes="(max-width: 640px) 100vw, 640px"></p><p>Then we need to create a new secret which is required to access the login from our OIDC Authorization Code Flow client in the ASP.NET Core application. The Implicit Flow is not required. We could also define the logout URL in the Authentication blade, so that when the user logs out from his/her account, the application will also do a logout.</p><p><img data-attachment-id="12433" data-permalink="https://damienbod.com/2019/05/17/updating-microsoft-account-logins-in-asp-net-core-with-openid-connect-and-azure-active-directory/aad_ms_login_03/" data-orig-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png" data-orig-size="1489,1149" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_ms_login_03" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=640" src="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=640&amp;h=494" alt="" width="640" height="494" class="alignnone size-full wp-image-12433" srcset="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=640&amp;h=494 640w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=1280&amp;h=988 1280w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=150&amp;h=116 150w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=600&amp;h=463 600w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=768&amp;h=593 768w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_03.png?w=1024&amp;h=790 1024w" sizes="(max-width: 640px) 100vw, 640px"></p><p>The application ID is required to configure the OIDC client in the ASP.NET Core application.</p><p><img data-attachment-id="12434" data-permalink="https://damienbod.com/2019/05/17/updating-microsoft-account-logins-in-asp-net-core-with-openid-connect-and-azure-active-directory/aad_ms_login_04/" data-orig-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png" data-orig-size="1142,1268" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_ms_login_04" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=540" data-large-file="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=640" src="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=640&amp;h=711" alt="" width="640" height="711" class="alignnone size-full wp-image-12434" srcset="https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=640&amp;h=711 640w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=135&amp;h=150 135w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=540&amp;h=600 540w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=768&amp;h=853 768w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png?w=922&amp;h=1024 922w, https://damienbod.files.wordpress.com/2019/05/aad_ms_login_04.png 1142w" sizes="(max-width: 640px) 100vw, 640px"></p><p>In the startup class of the ASP.NET Core application, the AddOpenIdConnect extension method is used to implement the Open ID Connect code flow client to access the Azure AD App. The common V2.0 endpoint is used. The SignInScheme is defined as “Identity.External”. This is because ASP.NET Core Identity is used in this application, and the identity is then stored to the Identity database, with the defined login. Cookies could also be used here if you use only Azure AD and Live accounts with the V2.0 common endpoint. The RemoteAuthenticationTimeout property is set so that the user has enough time to do the login. The response type is code as per OpenID Connect specification. The Issuer will not be validated and this is configured to false. This is because any AAD or live account can be used here, and so the Issuer will always be different. If you know or want to allow only specific AAD tenants etc, then you should validate this. The email scope is requested and this is then mapped to the name property which can be accessed easily in the HttpContext object.</p><p>The Prompt property can be used to force a login, or the consent screen. Per specification, “none”, “login”, “consent”, “select_account” values can be used here. If the login is not forced, the user will automatically be logged in, if only one account is active. </p><p>The CallbackPath path is set to match the App configuration in the Azure AD app registration.</p><pre class="brush: csharp; title: ; notranslate" title="">services.AddAuthentication()
.AddOpenIdConnect("Azure AD / Microsoft", "Azure AD / Microsoft", options =&gt; 
{
	//  https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
	options.ClientId = _clientId;
	options.ClientSecret = _clientSecret;
	options.SignInScheme = "Identity.External";
	options.RemoteAuthenticationTimeout = TimeSpan.FromSeconds(30);
	options.Authority = "https://login.microsoftonline.com/common/v2.0/";
	options.ResponseType = "code";

	// new in .NET Core 3.1
	options.UsePkce = false; // live does not support this yet

	options.Scope.Add("profile");
	options.Scope.Add("email");
	options.TokenValidationParameters = new TokenValidationParameters
	{
	   ValidateIssuer = false,
	   NameClaimType = "email",
	};
	options.CallbackPath = "/signin-microsoft";
	options.Prompt = "login"; // login, consent
});
</pre><p><strong>Troubleshooting Correlation Exceptions</strong></p><p>When the Application is deployed, sometimes you will start receiving Correlation Exceptions which are caused for a number of different reasons and can be difficult to figure out why it worked in dev, but not in the deployment.</p><p><em>RemoteAuthenticationTimeout</em></p><p>Sometimes not enough time is allowed for the user to login, maybe a 2FA login is required or something which takes time to complete. Try increasing the RemoteAuthenticationTimeout value to allow more time if this is causing the Correlation exceptions.</p><p><em>No Cookie exception</em></p><p>This is caused when the Client PC is blocking cookies or has some weird IT setup with a Firewall/ Anti-Virus which blocks this. Get the IT Admin to open up the security for your applications.</p><p><em>Multiple instance deployments</em></p><p>This can happen when multiple instances are used for the deployment, and the data protection does not store the keys to a common store. This is not required for Azure App Services deployment, but maybe you deploy with Service Fabric or docker, and a common cache, store should be coded for the data protection.</p><p><em>Cookie Policy overwritten</em></p><p>If the Cookie policy is configured to strict or non essential, then the Correlation Cookie Builder would have to be coded, and set so that these cookies are same site = none and essential.</p><p><strong>Summary</strong></p><p>The AddMicrosoftAccount extension method can now be replaced with the AddOpenIdConnect method, and AddMicrosoftAccount should no longer be used. The Azure V2.0 Common endpoint is now certified and this would be following a specification and best practice.</p><p><strong>Links</strong></p><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-v2-aspnet-core-webapp" rel="nofollow">https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-v2-aspnet-core-webapp</a></p><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-overview" rel="nofollow">https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-overview</a></p><p><a href="https://openid.net/specs/openid-connect-core-1_0.html" rel="nofollow">https://openid.net/specs/openid-connect-core-1_0.html</a></p><p><a href="https://docs.microsoft.com/en-us/azure/app-service-mobile/app-service-mobile-how-to-configure-microsoft-authentication" rel="nofollow">https://docs.microsoft.com/en-us/azure/app-service-mobile/app-service-mobile-how-to-configure-microsoft-authentication</a></p><p><a href="http://docs.identityserver.io/en/release/topics/signin_external_providers.html" rel="nofollow">http://docs.identityserver.io/en/release/topics/signin_external_providers.html</a></p><p><a href="https://developer.microsoft.com/en-us/identity/blogs/new-app-registrations-experience-is-now-generally-available/" rel="nofollow">https://developer.microsoft.com/en-us/identity/blogs/new-app-registrations-experience-is-now-generally-available/</a></p><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/app-registrations-training-guide" rel="nofollow">https://docs.microsoft.com/en-us/azure/active-directory/develop/app-registrations-training-guide</a></p><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-protocols-openid-connect-code" rel="nofollow">https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-protocols-openid-connect-code</a></p><div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><h3 class="jp-relatedposts-headline"><em>Related</em></h3></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>