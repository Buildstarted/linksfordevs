<!DOCTYPE html>
<html lang="en">
<head>
    <title>
External Identity Provider with ASP.NET Core Identity - Code Maze - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="External Identity Provider with ASP.NET Core Identity - Code Maze - linksfor.dev(s)"/>
    <meta property="og:description" content="In this article, we are going to learn how to configure an External Identity Provider with ASP.NET Core Identity and how to implement it in our solution."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://code-maze.com/external-identity-provider-aspnet-core-identity/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - External Identity Provider with ASP.NET Core Identity - Code Maze</title>
<div class="readable">
        <h1>External Identity Provider with ASP.NET Core Identity - Code Maze</h1>
            <div>Reading time: 14-18 minutes</div>
        <div>Posted here: 11 Mar 2020</div>
        <p><a href="https://code-maze.com/external-identity-provider-aspnet-core-identity/">https://code-maze.com/external-identity-provider-aspnet-core-identity/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
																<article id="post-51783">
														
							
														
							
														
							<div>
															<div>
									<p><div><p><a href="https://code-maze.com/ultimate-aspnet-core-3-web-api/?topb=true" target="_blank"><img src="https://code-maze.com/wp-content/uploads/2020/01/Code-Maze-Book-Collection-V3-1024x483.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/01/Code-Maze-Book-Collection-V3-1024x483.png" alt="Code Maze Book Collection V3" width="775" height="366" data-pagespeed-url-hash="2051067523" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></a></p><p>Looking to learn how to build <strong>great APIs</strong>? Or become <strong>even better</strong> at it? Check our newest book <strong><a href="https://code-maze.com/ultimate-aspnet-core-3-web-api/?topb=true" target="_blank" rel="noopener">Ultimate ASP.NET Core 3 Web API</a>.</strong> Learn how to create a full production-ready ASP.NET Core API using only the <strong>latest and greatest technologies</strong>. Bonus materials awaiting inside!</p></div>Using an external identity provider while login to the application is a quite common case. This enables us to log in with our external accounts like Google, Facebook, etc. By using ASP.NET Core Identity, we are going to see that this is not a hard process at all.</p>
<p>So, in this article, we are going to learn how to configure an external identity provider in our ASP.NET Core application and how to use a Google account to login to our application. Of course, in a very similar way, you can configure any other external account.</p>
<p>One important thing to know here. Once an external user logs in into our system, they will always bring an identifier that is unique for that user in our system. That user could have different Ids for different sites but for our site, that Id will always be the same.</p>
<p>To download the source code for this project, you can visit the <a href="https://github.com/CodeMazeBlog/identity-aspnetcore/tree/external-provider-identity" target="_blank" rel="nofollow noopener noreferrer">External Identity Provider with ASP.NET Core Identity</a> repository.</p>
<p>To navigate through the entire series, visit the <a href="https://code-maze.com/asp-net-core-identity-series/" target="_blank" rel="noopener noreferrer">ASP.NET Core Identity series</a> page.</p>
<p>Let’s look at the basic navigation for this article:</p>
<ul>
<li><a href="#google-api-platform">Google API Platform</a></li>
<li><a href="#external-identity-configuration">External Identity Provider Configuration</a></li>
<li><a href="#external-identity-implementation">External Identity Provider Implementation</a></li>
<li><a href="#testing">Testing the Solution</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<p>So, let’s get on it.</p>
<h2 id="google-api-platform">Google API Platform</h2>
<p>The first thing we have to do is to navigate to the <a href="https://developers.google.com/identity/sign-in/web/sign-in#before_you_begin" target="_blank" rel="nofollow noopener noreferrer">Integrate Google Sign-In</a> page. In the middle of the screen, we can see a blue <code>Configure a project</code> button, so let’s click on it:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/40-Configuring-google-external.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/40-Configuring-google-external.png" alt="Configuring google external identity provider" width="588" height="226" srcset="https://code-maze.com/wp-content/uploads/2020/03/40-Configuring-google-external.png 588w, https://code-maze.com/wp-content/uploads/2020/03/40-Configuring-google-external-300x115.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/40-Configuring-google-external.png 588w, https://code-maze.com/wp-content/uploads/2020/03/40-Configuring-google-external-300x115.png 300w" sizes="(max-width: 588px) 100vw, 588px"></p>
<p>So, we have to provide a project name and click the next button. In the next window, we are going to type the same name as the project name. Then, let’s choose the web server options for the OAuth client and https://localhost:5001/signin-google for the Authorized redirect URIs:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/41-OAuth-client.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/41-OAuth-client.png" alt="OAuth client - external identity provider" width="581" height="437" srcset="https://code-maze.com/wp-content/uploads/2020/03/41-OAuth-client.png 581w, https://code-maze.com/wp-content/uploads/2020/03/41-OAuth-client-300x226.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/41-OAuth-client.png 581w, https://code-maze.com/wp-content/uploads/2020/03/41-OAuth-client-300x226.png 300w" sizes="(max-width: 581px) 100vw, 581px"></p>
<p>Once we click the Create button, we will get the ClientID and ClientSecret values. For now, just save them in a notepad file for example.</p>
<p>And that’s it. We can move on to the project configuration.</p>
<h2 id="external-identity-configuration">External Identity Provider configuration</h2>
<p>Now, we are going to register Google as our external identity provider. To do that, we have to install the <code>Microsoft.AspNetCore.Authentication.Google</code> package first:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/42-Google-package.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/42-Google-package.png" alt="Google package" width="615" height="68" srcset="https://code-maze.com/wp-content/uploads/2020/03/42-Google-package.png 615w, https://code-maze.com/wp-content/uploads/2020/03/42-Google-package-300x33.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/42-Google-package.png 615w, https://code-maze.com/wp-content/uploads/2020/03/42-Google-package-300x33.png 300w" sizes="(max-width: 615px) 100vw, 615px"></p>
<p>After the installation, we have to modify the <code>appsettings.json</code> file:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d24893369794" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>"Authentication"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"Google"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ClientId"</span><span>:</span><span> </span><span>"871483539737-m7u9ohi6rg16sk77hs4v73ddibevgbjm.apps.googleusercontent.com"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ClientSecret"</span><span>:</span><span> </span><span>"mTSMmqtTlNf5w5oDirvAN7eb"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>.</span><span>.</span><span>.</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>So, we just store our ClientId and ClientSecret values in a separate file. Of course, the better practice would be to store these values as a secret or environment variable, but for this example, the appsetting file will do just fine.</p>
<p>Now let’s configure Google as an external provider by modifying the <code>ConfigureServices</code> method:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d2c517220385" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>services</span><span>.</span><span>AddAuthentication</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddGoogle</span><span>(</span><span>"google"</span><span>,</span><span> </span><span>opt</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>googleAuth</span><span> </span>=<span> </span><span>Configuration</span><span>.</span><span>GetSection</span><span>(</span><span>"Authentication:Google"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>ClientId</span><span> </span>=<span> </span><span>googleAuth</span><span>[</span><span>"ClientId"</span><span>]</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>ClientSecret</span><span> </span>=<span> </span><span>googleAuth</span><span>[</span><span>"ClientSecret"</span><span>]</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>SignInScheme</span><span> </span>=<span> </span><span>IdentityConstants</span><span>.</span><span>ExternalScheme</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The <code>AddIdentity</code> method configures default scheme settings. But the <code>AddAuthentication</code> allows configuring different authentication options, like Google for example. That’s why this method must be placed below the <code>AddIdentity</code> method.</p>
<p>Now, let’s create the <code>_ExternalAuthentication</code> partial view, to support external authentication:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d2e584660750" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p></div>
				</td>
						<td><div><p><span>@</span>using<span> </span>Microsoft<span>.</span>AspNetCore<span>.</span>Identity</p><p><span>@</span>using<span> </span>IdentityByExamples<span>.</span>Models</p><p><span>@</span>inject<span> </span>SignInManager<span>&lt;User&gt;</span><span> SignInManager</span></p><p><span>&lt;div </span><span>class</span>=<span>"col-md-4 offset-2"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;section&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;h4&gt;</span><span>Use different service for log in:</span><span>&lt;/h4&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;hr </span><span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var providers = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToList();</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!providers.Any())</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;div&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;p&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We couldn't find any external provider</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/p&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/div&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;form </span><span>asp-action</span>=<span>"ExternalLogin"</span><span> </span><span>asp-route-returnurl</span>=<span>"@ViewData["</span>ReturnUrl<span>"]"</span><span> </span><span>method</span>=<span>"post"</span><span> </span><span>class</span>=<span>"form-horizontal"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;div&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;p&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@foreach (var provider in providers)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;input </span><span>type</span>=<span>"submit"</span><span> </span><span>class</span>=<span>"btn btn-info"</span><span> </span><span>value</span>=<span>"@provider.Name"</span><span> </span><span>name</span>=<span>"provider"</span><span> /&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/p&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/div&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/form&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/section&gt;</span></p><p><span>&lt;/div&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>By using the <code>SignInManager.GetExternalAuthenticationSchemesAsync</code> method, we fetch all the registered providers in our application. And if we find any, we show it in the view. So, in order to see these changes, let’s just include this partial view in the <code>Login</code> view:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d2f325053397" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>&lt;div </span><span>class</span>=<span>"col-md-4"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;form </span><span>asp-action</span>=<span>"Login"</span><span> </span><span>asp-route-returnUrl</span>=<span>"@ViewData["</span>ReturnUrl<span>"]"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//code removed for clarity reasons&nbsp;&nbsp;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/form&gt;</span></p><p><span>&lt;/div&gt;</span></p><p><span>&lt;partial </span><span>name</span>=<span>"_ExternalAuthentication"</span><span> /&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Now, if we navigate to the Login view:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view.png" alt="" width="948" height="364" srcset="https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view.png 948w, https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view-300x115.png 300w, https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view-768x295.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view.png 948w, https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view-300x115.png 300w, https://code-maze.com/wp-content/uploads/2020/03/43-External-provider-view-768x295.png 768w" sizes="(max-width: 948px) 100vw, 948px"></p>
<p>This looks great. Now, we can implement actions in the <code>Account</code> controller.</p>
<h2 id="external-identity-implementation">External Identity Provider Implementation</h2>
<p>The form the <code>_ExternalAuthentication</code> partial view alreadt targets the <code>ExternalLogin</code> action. So we have to create it and add the required logic:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d30333911714" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>[</span><span>HttpPost</span><span>]</span></p><p><span>[</span><span>ValidateAntiForgeryToken</span><span>]</span></p><p><span>public</span><span> </span><span>IActionResult </span><span>ExternalLogin</span><span>(</span><span>string</span><span> </span><span>provider</span><span>,</span><span> </span><span>string</span><span> </span><span>returnUrl</span><span> </span>=<span> </span><span>null</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>redirectUrl</span><span> </span>=<span> </span><span>Url</span><span>.</span><span>Action</span><span>(</span><span>nameof</span><span>(</span><span>ExternalLoginCallback</span><span>)</span><span>,</span><span> </span><span>"Account"</span><span>,</span><span> </span><span>new</span><span> </span><span>{</span><span> </span><span>returnUrl</span><span> </span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>properties</span><span> </span>=<span> </span><span>_signInManager</span><span>.</span><span>ConfigureExternalAuthenticationProperties</span><span>(</span><span>provider</span><span>,</span><span> </span><span>redirectUrl</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>Challenge</span><span>(</span><span>properties</span><span>,</span><span> </span><span>provider</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>This is the action that we target by clicking the <code>google</code> button. It has two parameters: provider and returnUrl. If you take a look at the submit button code, you are going to see the name attribute with the provider value. Therefore, MVC will pair the value from that button to the provider parameter in this action. The second parameter is populated through the URI.</p>
<p>Inside the action, we create two variables: redirectUrl and properties. We assign the redirect address to the first variable and use the <code>ConfigureExternalAuthenticationProperties</code> method to create an object of type <code>AuthenticationProperties</code> that contains our <code>provider</code> and <code>redirectUrl</code>:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/44-Authentication-properties.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/44-Authentication-properties.png" alt="Authentication properties" width="712" height="213" srcset="https://code-maze.com/wp-content/uploads/2020/03/44-Authentication-properties.png 712w, https://code-maze.com/wp-content/uploads/2020/03/44-Authentication-properties-300x90.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/44-Authentication-properties.png 712w, https://code-maze.com/wp-content/uploads/2020/03/44-Authentication-properties-300x90.png 300w" sizes="(max-width: 712px) 100vw, 712px"></p>
<p>After that, we return a challenge. With it, we challenge a user to provide an identity supplied by the provider, in this case, Google.</p>
<p>Of course, we have to implement the <code>ExternalLoginCallback</code> action.</p>
<h3><span lang="SR-LATN-RS">Additional Implementation</span></h3>
<p>So, let’s create a new action and add the required logic:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d33334415641" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div>
				</td>
						<td><div><p><span>[</span><span>HttpGet</span><span>]</span></p><p><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>ExternalLoginCallback</span><span>(</span><span>string</span><span> </span><span>returnUrl</span><span> </span>=<span> </span><span>null</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>info</span><span> </span>=<span> </span><span>await</span><span> </span><span>_signInManager</span><span>.</span><span>GetExternalLoginInfoAsync</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>info</span><span> </span>==<span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>RedirectToAction</span><span>(</span><span>nameof</span><span>(</span><span>Login</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>signInResult</span><span> </span>=<span> </span><span>await</span><span> </span><span>_signInManager</span><span>.</span><span>ExternalLoginSignInAsync</span><span>(</span><span>info</span><span>.</span><span>LoginProvider</span><span>,</span><span> </span><span>info</span><span>.</span><span>ProviderKey</span><span>,</span><span> </span><span>isPersistent</span><span>:</span><span> </span><span>false</span><span>,</span><span> </span><span>bypassTwoFactor</span><span>:</span><span> </span><span>true</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>signInResult</span><span>.</span><span>Succeeded</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>RedirectToLocal</span><span>(</span><span>returnUrl</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>signInResult</span><span>.</span><span>IsLockedOut</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>RedirectToAction</span><span>(</span><span>nameof</span><span>(</span><span>ForgotPassword</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ViewData</span><span>[</span><span>"ReturnUrl"</span><span>]</span><span> </span>=<span> </span><span>returnUrl</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ViewData</span><span>[</span><span>"Provider"</span><span>]</span><span> </span>=<span> </span><span>info</span><span>.</span><span>LoginProvider</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>email</span><span> </span>=<span> </span><span>info</span><span>.</span><span>Principal</span><span>.</span><span>FindFirstValue</span><span>(</span><span>ClaimTypes</span><span>.</span><span>Email</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>View</span><span>(</span><span>"ExternalLogin"</span><span>,</span><span> </span><span>new</span><span> </span><span>ExternalLoginModel</span><span> </span><span>{</span><span> </span><span>Email</span><span> </span>=<span> </span><span>email</span><span> </span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>With the <code>GetExternalLoginInfoAsync</code> method, we collect exactly that – external login info. So the information like provider, given name, last name, email, name identifier, etc, are going to be provided in the <code>info</code> variable. If it’s not null we try to sign in a user with an external provider by using the <code>ExternalLoginSignInAsync</code> method. If this succeeds, we redirect the user to the Home or some other view.</p>
<p>On the other hand, if the account is locked out, we currently just redirect to the ForgotPassword view, but you can implement a different logic that suits your needs. Finally, if nothing checks out, we extract an email and the provider from the info variable and redirect the user to the ExternalLogin view, where they need to associate an external account to the existing one.</p>
<p>If you want users to manually enter their email address, you have to remove the Email property initialization in the <code>ExternalLoginModel</code>.</p>
<p>As you can see, we are missing some parts of this action. So, let’s add those.</p>
<h3><span lang="SR-LATN-RS">ExternalLogin and ExternalLoginConfirmation Implementation</span></h3>
<p>The first thing, we are going to do is to add the <code>ExternalLoginModel</code> class:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d34191866658" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>class</span><span> </span><span>ExternalLoginModel</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>Required</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>EmailAddress</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>string</span><span> </span><span>Email</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>ClaimsPrincipal</span><span> </span><span>Principal</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Then, we have to create a view:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d35477279338" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p></div>
				</td>
						<td><div><p><span>@</span>model<span> </span>IdentityByExamples<span>.</span>Models<span>.</span>ExternalLoginModel</p><p><span>&lt;h4&gt;</span><span>External provider registration</span><span>&lt;/h4&gt;</span></p><p><span>&lt;hr </span><span>/&gt;</span></p><p><span>&lt;p </span><span>class</span>=<span>"text-info"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;Enter an email to associate your </span><span>&lt;strong&gt;</span><span>@ViewData["Provider"]</span><span>&lt;/strong&gt;</span><span> account.</span></p><p><span>&lt;/p&gt;</span></p><p><span>&lt;div </span><span>class</span>=<span>"row"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;div </span><span>class</span>=<span>"col-md-4"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;form </span><span>asp-action</span>=<span>"ExternalLoginConfirmation"</span><span> </span><span>asp-route-returnurl</span>=<span>"@ViewData["</span>ReturnUrl<span>"]"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;div </span><span>asp-validation-summary</span>=<span>"All"</span><span> </span><span>class</span>=<span>"text-danger"</span><span>&gt;</span><span>&lt;/div&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;div </span><span>class</span>=<span>"form-group"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;label </span><span>asp-for</span>=<span>"Email"</span><span> </span><span>class</span>=<span>"control-label"</span><span>&gt;</span><span>&lt;/label&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;input </span><span>asp-for</span>=<span>"Email"</span><span> </span><span>class</span>=<span>"form-control"</span><span> /&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;span </span><span>asp-validation-for</span>=<span>"Email"</span><span> </span><span>class</span>=<span>"text-danger"</span><span>&gt;</span><span>&lt;/span&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/div&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;div </span><span>class</span>=<span>"form-group"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;input </span><span>type</span>=<span>"submit"</span><span> </span><span>value</span>=<span>"Submit"</span><span> </span><span>class</span>=<span>"btn btn-primary"</span><span> /&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/div&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/form&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;/div&gt;</span></p><p><span>&lt;/div&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>There is nothing new in this view. But, you can see that once the user clicks the Submit button, they will be directed to the <code>ExternalLoginConfirmation</code> action, to either associate the account or create a new one if it doesn’t exist. Well, to support that logic, we need that action:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e68ee7a16d36550658315" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p></div>
				</td>
						<td><div><p><span>[</span><span>HttpPost</span><span>]</span></p><p><span>[</span><span>ValidateAntiForgeryToken</span><span>]</span></p><p><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>ExternalLoginConfirmation</span><span>(</span><span>ExternalLoginModel </span><span>model</span><span>,</span><span> </span><span>string</span><span> </span><span>returnUrl</span><span> </span>=<span> </span><span>null</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>!</span><span>ModelState</span><span>.</span><span>IsValid</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>View</span><span>(</span><span>model</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>info</span><span> </span>=<span> </span><span>await</span><span> </span><span>_signInManager</span><span>.</span><span>GetExternalLoginInfoAsync</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>info</span><span> </span>==<span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>View</span><span>(</span><span>nameof</span><span>(</span><span>Error</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>user</span><span> </span>=<span> </span><span>await</span><span> </span><span>_userManager</span><span>.</span><span>FindByEmailAsync</span><span>(</span><span>model</span><span>.</span><span>Email</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IdentityResult </span><span>result</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>user</span><span> </span><span>!</span>=<span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span>=<span> </span><span>await</span><span> </span><span>_userManager</span><span>.</span><span>AddLoginAsync</span><span>(</span><span>user</span><span>,</span><span> </span><span>info</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>result</span><span>.</span><span>Succeeded</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await</span><span> </span><span>_signInManager</span><span>.</span><span>SignInAsync</span><span>(</span><span>user</span><span>,</span><span> </span><span>isPersistent</span><span>:</span><span> </span><span>false</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>RedirectToLocal</span><span>(</span><span>returnUrl</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>model</span><span>.</span><span>Principal</span><span> </span>=<span> </span><span>info</span><span>.</span><span>Principal</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>user</span><span> </span>=<span> </span><span>_mapper</span><span>.</span><span>Map</span><span>&lt;</span><span>User</span><span>&gt;</span><span>(</span><span>model</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span>=<span> </span><span>await</span><span> </span><span>_userManager</span><span>.</span><span>CreateAsync</span><span>(</span><span>user</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>result</span><span>.</span><span>Succeeded</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span>=<span> </span><span>await</span><span> </span><span>_userManager</span><span>.</span><span>AddLoginAsync</span><span>(</span><span>user</span><span>,</span><span> </span><span>info</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>result</span><span>.</span><span>Succeeded</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//TODO: Send an emal for the email confirmation and add a default role as in the Register action</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await</span><span> </span><span>_signInManager</span><span>.</span><span>SignInAsync</span><span>(</span><span>user</span><span>,</span><span> </span><span>isPersistent</span><span>:</span><span> </span><span>false</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>RedirectToLocal</span><span>(</span><span>returnUrl</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>foreach</span><span> </span><span>(</span><span>var</span><span> </span><span>error </span><span>in</span><span> </span><span>result</span><span>.</span><span>Errors</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ModelState</span><span>.</span><span>TryAddModelError</span><span>(</span><span>error</span><span>.</span><span>Code</span><span>,</span><span> </span><span>error</span><span>.</span><span>Description</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>View</span><span>(</span><span>nameof</span><span>(</span><span>ExternalLogin</span><span>)</span><span>,</span><span> </span><span>model</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>So, we first check for the model validity and check the external login info as in the previous action. Then, we try to get a user from the database. If exists, we just associate this external account with the existing one by adding another entry in the <code>AspNetUserLogins</code> table and sign in the user. But if we can’t find a user, we create a new one in the <code>AspNetUsers</code> table, connect the external account with the <code>AddLoginAsync</code> method and sing in that user. Of course, we didn’t want to repeat the same code, but you can extract the code for sending a confirmation email and adding a role to the user in the separate method and call it in here.</p>
<p>Finally, if something fails, we collect errors and return a view.<!-- <span id="ezoic-pub-ad-placeholder-176" class="ezoic-adpicker-ad" data-ezadblocked='true'></span> --><!-- placeholder 176 blocked.  Reason : no sizes --></p>
<h2 id="testing">Testing the Solution</h2>
<p>We are going to start with the existing user. So, after starting our application, we are going to navigate to the Login page and click the Google button. Once we do that, our challenge appears:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/45-Challenge.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/45-Challenge.png" alt="Challenge - external identity provider" width="459" height="313" srcset="https://code-maze.com/wp-content/uploads/2020/03/45-Challenge.png 459w, https://code-maze.com/wp-content/uploads/2020/03/45-Challenge-300x205.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/45-Challenge.png 459w, https://code-maze.com/wp-content/uploads/2020/03/45-Challenge-300x205.png 300w" sizes="(max-width: 459px) 100vw, 459px"></p>
<p>After we click on the Testing Mail option, we are going to be redirected to the ExternalLogin view:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/46-External-login-view.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/46-External-login-view.png" alt="External login view" width="384" height="308" srcset="https://code-maze.com/wp-content/uploads/2020/03/46-External-login-view.png 384w, https://code-maze.com/wp-content/uploads/2020/03/46-External-login-view-300x241.png 300w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/46-External-login-view.png 384w, https://code-maze.com/wp-content/uploads/2020/03/46-External-login-view-300x241.png 300w" sizes="(max-width: 384px) 100vw, 384px"></p>
<p>Once we click the Submit button, we will be logged in.</p>
<p>Now if we inspect the database:</p>
<p><img src="https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider.png" alt="Table check for user and provider" width="862" height="219" srcset="https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider.png 862w, https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider-300x76.png 300w, https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider-768x195.png 768w" data-srcset="https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider.png 862w, https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider-300x76.png 300w, https://code-maze.com/wp-content/uploads/2020/03/47-Table-check-for-user-and-provider-768x195.png 768w" sizes="(max-width: 862px) 100vw, 862px"></p>
<p>We can see the Google provider assigned to the codemazetest user. If you log out and log in again with the external account, you will be logged in as soon as you choose your external account. You will skip the external provider registration. Of course, this will be the case only if you set the <code>bypassTwoFactor</code> parameter to true. If that parameter is set to false, you would have to add additional logic in the <code>ExternalLoginConfirmation</code> action because it opens some different use cases. If you want, you can play a bit with the <code>bypassTwoFactore</code> parameter.</p>
<p>Additionally, if we remove our user from the database and then repeat the login process again, a new user is going to be created in the database and an external provider will be assigned. Of course, don’t forget to implement an <a href="https://code-maze.com/email-confirmation-aspnet-core-identity/">email confirmation functionality</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>So, that’s all it takes to configure and integrate an external identity provider into our ASP.NET Core application.</p>
<p>To sum up. We have learned:</p>
<ul>
<li>How to configure our project with the Google API</li>
<li>The way to configure External Identity Provider in our application</li>
<li>How to implement External Identity Provider with actions and views</li>
</ul>
<p>We hope you have enjoyed this article and the complete series as well.</p>

</div>
														</div>
														

																				</article>

						
						
												
										
				
			</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>