<!DOCTYPE html>
<html lang="en">
<head>
    <title>
The reasons behind why I don&#x27;t use AutoMapper. -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>The reasons behind why I don&#x27;t use AutoMapper.</h1>
    <article> <header> <p><i class="fa fa-calendar"></i> <time>5 February 2018</time></p> </header> <img src="social_splashscreen.jpg" width="100%"> <br> <p>The idea behind this blog post is pretty old but I haven&#x2019;t had enough motivation to write this down till now. Recently, I&#x2019;ve came across a couple of new articles about AutoMapper and I&#x2019;ve been struck when I saw how people utilize AutoMapper in their projects. I&#x2019;ve encountered cases when AutoMapper transforms simple thing like mapping values from object to other into a really complex problem, which results with highly complicated code only for the price of not writing mappings explicitly. Finally, I&#x2019;ve found a provoking tweet on my timeline that definitely motivated me to materialize my reflections about AutoMapper into the form of this blog post.</p> <p><img src="tweet.jpg" alt="tweet"></p> <p>Over 5 years ago I participated in a project where there was a trial of using AutoMapper but happily we drown back from this idea in time. Bear with me and I&#x2019;ll explain you why this was a good decision.</p> <h2 id="misleading-static-analysis">Misleading static analysis<a href="#misleading-static-analysis" class="hanchor"> &#x1F517;&#xFE0E;</a> </h2> <p>The first problem is that static analysis starts to report that some fields from my entity are never used. There is no direct reference in the code because on one side ORM automatically maps those fields into database table columns and on the other side there is AutoMapper. This issue is related to fields which are not involved in any business logic and they are simply read from user input, saved into database and read back only for raw presentation purpose (the business always wants to gather as much information as possible). So when we take advice from static analysis report and we drop those fields, we simply break the system. We could mark those fields with [UsedImplicity] attributes (if you use Resharper static analysis) or disable this inspection completely, but that only hides the problem. We experience the same situation with DTO objects. On one side there&#x2019;s AutoMapper, on the other - some kind of serializer. And again, if we rename or drop the field we silently break the system. We&#x2019;ll get feedback only when we run some kind of test during the runtime.
For me, the static analysis plays a really important role in managing the project&#x2019;s code quality and when some library starts to undermine the credibility of this report I have to have a really good reason to choose that library. It&#x2019;s the same situation like in the story about a building with a broken window - when we have to ignore some set of errors caused by usage of given library, sooner or later we start to ignore other errors because we are not able to distinguish which one is a real problem. If you are in a situation where you are not burdened with errors that you have to mentally ignore, you can treat static analysis as another type of test for your system. You can run static analysis tool as a part of your continuous integration pipeline and treat all reported errors the same way as you treat failed unit tests.</p> <p><img src="failure_condition.jpg" alt="Use inspection error as build failure condition"></p> <p>This will definitely save your code from really sophisticated bugs. You can read more about problems that can be solved thanks to static analysis in my post devoted to <a href="../../post/hunt-your-bugs-design-time/">Resharper Solution Wide Analysis</a></p> <p>Another problem is that it is not possible to find out which field from DTO maps to which field in entity (or entities). When we use tools like &#x201C;show usages&#x201D; it shows us only this single occurrence because there is no explicit mapping in the codebase. The resolution is to explicitly write mapping configuration for all the fields we want to map, but do I really need a heavy reflection mechanism to rewrite value from field in one object to another?</p> <h2 id="hard-to-debug">Hard to debug<a href="#hard-to-debug" class="hanchor"> &#x1F517;&#xFE0E;</a> </h2> <p>The next important issue is fluent configuration. I&#x2019;m not a huge fan of this code writing approach, actually I don&#x2019;t like it at all. Why? It&#x2019;s very hard to debug this kind of code and sometimes it&#x2019;s even impossible. This is not a code which is evaluated, it&#x2019;s only a declarative description of expected behavior. Your &#x201C;code&#x201D; is processed by third party library which produces real code based on this description. Even if you provide mapping code within <strong>MapFrom&lt;&gt;</strong> method, you can&#x2019;t put there breakpoint and expect that program invocation stops when you call <strong>Mapper.Map&lt;&gt;()</strong> method. This is due the fact that <strong>MapFrom&lt;&gt;()</strong> is expecting <strong>Expression&lt;Func&lt;TSource, TSourceMember&gt;&gt;</strong> not <strong>Func&lt;TSource, TSourceMember&gt;</strong>. And if you have a bug in your mapping code you don&#x2019;t get exception in the place where you could potentially expect it. Actually you don&#x2019;t get any exception at all. I observed that AutoMapper is somehow swallowing exception that occurs during the mapping. These reasons makes debugging very hard.</p> <pre><code class="language-csharp">static void Main(string[] args)
{
    Mapper.Initialize(cfg =&gt;
    {
        cfg.CreateMap&lt;UserEntity, UserDTO&gt;()
           .ForMember(x=&gt;x.FullName, opt=&gt; opt.MapFrom(x=&gt; $&quot;{x.FirstName} {x.LastName} ({x.Address.City})&quot;));
    });

    var userEntity = new UserEntity()
    {
        FirstName = &quot;Cezary&quot;,
        LastName = &quot;Pi&#x105;tek&quot;,
        Address = null
    };
    var userDto = Mapper.Map&lt;UserDTO&gt;(userEntity);
    var serialized = JsonConvert.SerializeObject(userDto, Formatting.Indented);
    Console.WriteLine(serialized);
    Console.ReadKey();
}
</code></pre> <p>In the example above I&#x2019;ve been expecting <em>NullReferenceException</em> when I called <em>Mapper.Map<userdto>(userEntity)</userdto></em> (because x.Address in mapping code is null) but as the result I got the following output on my console:</p> <pre><code class="language-javascript">{
    FullName : null
}
</code></pre> <h2 id="broken-code-organization">Broken code organization<a href="#broken-code-organization" class="hanchor"> &#x1F517;&#xFE0E;</a> </h2> <p>Some people say that AutoMapper is perfectly fine for simple projects, but believe me - there is no such thing as simple project. Even when it looks simple at the beginning - sooner or later it gets complex. Starting with straigth one-to-one mapping between entities and dtos (or whatever types of objects you need to map) doesn&#x2019;t mean that you won&#x2019;t need to implement the following requirements in further stages of your project development:</p> <ol>
<li>Formatting</li>
<li>Composing one object from few others (ViewModel build with data that comes from couple of different entities)</li>
<li>Conditional mapping based on business and security rules</li>
<li>Limited access to given model&#x2019;s attributes based on user permissions.</li>
</ol> <p>People tend to put this complex mapping logic inside the AutoMapper configuration because this is the fastest way to achieve expected effect. I think it&#x2019;s a really bad practice to put your business and security logic inside some infrastructure tool configuration. This is the beginning of slippery slope and in the long term it will make the development, testing and maintenance more complicated. You can say ok - if I&#x2019;ve got complex mapping then I write it explicitly. But then you have two ways of implementing one thing - AutoMapper and explicit mapping. And then the question appears: &#x201C;When should I use which?&#x201D;. And the answer is: &#x201C;it depends&#x2026;&#x201D;. And you introduce chaos into your codebase.</p> <h2 id="how-to-organize-mappings">How to organize mappings<a href="#how-to-organize-mappings" class="hanchor"> &#x1F517;&#xFE0E;</a> </h2> <p>Write your mapping explicitly. If you find this boring you can utilize some kind of snippets or scaffolding tools (such as T4 Scaffolding or something based on Roslyn) to generate this &#x201C;dummy&#x201D; code. You can encapsulate this code inside the new component type responsible for mapping objects. In the project I&#x2019;ve mentioned at the beginning of this article, we introduced a notion of *ServiceMapper components with a set of MapTo* and MapFrom* methods which serve the purpose of mapping objects for given endpoint service. Why not to use extension methods? The reason is again the complexity. Sometimes you need other dependencies to fulfill the mapping logic and the extension method makes it hard to utilize dependency injection to provide these dependencies (you can use only service locator which is considered as an anti-pattern or ambient context). Example service mapper can look like this below:</p> <pre><code class="language-cs">public class UserServiceMapper{

	private readonly AddressServiceMapper addressServiceMapper;
	
	public UserServiceMapper(AddressServiceMapper addressServiceMapper)
	{
		this.addressServiceMapper = addressServiceMapper;
	}
	
	public UserDTO MapToUserDTO(UserEntity entity)
	{
		return new UserDTO {
			FirstName = entity.FirstName,
			LastName = entity.LastName,
			Address = this.addressServiceMapper.MapToAddressDTO(entity.Address)
		};
	}
	
	public void UpdateUserEntity(UserEntity entity, UserDTO dto)
	{
		entity.FirstName = dto.FirstName;
		entity.LastName = dto.LastName;
		entity.Age = dto.Age;
		this.addressServiceMapper.UpdateAddress(entity.Address, dto.Address);
	}
}
</code></pre> <h2 id="final-thought">Final thought<a href="#final-thought" class="hanchor"> &#x1F517;&#xFE0E;</a> </h2> <p>AutoMapper is probably good for really small, short-lived projects or proof of concepts, but when you start to care about your code quality, you should definitely rethink all pros and cons regarding using AutoMapper. When you observe problems like the ones described in this blog post, you should consider abandoning AutoMapper and start to write your mappings explicitly (it really doesn&#x2019;t hurt). If you encountered other problems which arised from using AutoMapper I would be really appreciate if you could share your experience in the comment section down below.</p> <p>If you find this blog post useful and you think it&apos;s worth to share this idea with others, please don&apos;t hesitate to use these buttons below:</p> </article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>