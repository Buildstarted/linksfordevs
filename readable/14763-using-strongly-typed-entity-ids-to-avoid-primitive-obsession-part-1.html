<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using strongly-typed entity IDs to avoid primitive obsession (Part 1) -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Using strongly-typed entity IDs to avoid primitive obsession (Part 1)</h1><div><div class="post-content"><p>Have you ever requested an entity from a service (web API / database / generic service) and got a 404 / not found response when you're <em>sure</em> it exists? I've seen it quite a few times, and it sometimes comes down to requesting the entity using the wrong ID. In this post I show one way to avoid these sorts of errors by acknowledging the problem as <em>primitive obsession</em>, and using the C# type system to catch the errors for us.</p><blockquote><p>Lots of people smarter than me have talked about primitive obsession in C#. In particular I found these resources by <a href="https://lostechies.com/jimmybogard/2007/12/03/dealing-with-primitive-obsession/">Jimmy Bogard</a>, <a href="http://blog.ploeh.dk/2011/05/25/DesignSmellPrimitiveObsession/">Mark Seemann</a>, <a href="http://www.weeklydevtips.com/012">Steve Smith</a>, and <a href="https://enterprisecraftsmanship.com/2015/03/07/functional-c-primitive-obsession/">Vladimir Khorikov</a>, as well as <a href="https://martinfowler.com/articles/refactoring-2nd-ed.html">Martin Fowler's Refactoring book</a>. I've recently started looking into F#, in which this is considered a solved problem as far as I can tell!</p></blockquote><h2 id="an-example-of-the-problem" class="heading-with-anchor">An example of the problem<a href="#an-example-of-the-problem"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>To give some context, below is a very basic example of the problem. Imagine you have an eCommerce site, in which <code>User</code>s can place an <code>Order</code>. An <code>Order</code> for this example is very basic, just the following few properties:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">Order</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">Guid</span> Id <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">Guid</span> UserId <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">decimal</span> Total <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>You can create and read the <code>Order</code>s for a <code>User</code> using the <code>OrderService</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">OrderService</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span> List<span class="token operator">&lt;</span>Order<span class="token operator">&gt;</span> _orders <span class="token operator">=</span><span class="token keyword">new</span><span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">AddOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _orders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">Order</span><span class="token function">GetOrderForUser</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">,</span><span class="token class-name">Guid</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> _orders<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>
            order <span class="token operator">=</span><span class="token operator">&gt;</span> order<span class="token punctuation">.</span>Id <span class="token operator">==</span> orderId <span class="token operator">&amp;&amp;</span> order<span class="token punctuation">.</span>UserId <span class="token operator">==</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>This trivial implementation stores the <code>Order</code> objects in memory, and has just two methods:</p><ul><li><code>AddOrder()</code>: Add a new <code>Order</code> to the collection</li><li><code>GetOrderForUser()</code>: Get an <code>Order</code> with the given <code>Id</code> and <code>UserId</code>.</li></ul><p>Finally, we have an API controller that can be called to create a new <code>Order</code> or fetch an <code>Order</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">,</span> Authorize<span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">OrderController</span><span class="token punctuation">:</span><span class="token class-name">ControllerBase</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">OrderService</span> _service<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">OrderController</span><span class="token punctuation">(</span><span class="token class-name">OrderService</span> service<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _service <span class="token operator">=</span> service<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">]</span><span class="token keyword">public</span> ActionResult<span class="token operator">&lt;</span>Order<span class="token operator">&gt;</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> userId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token function">FindFirstValue</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>NameIdentifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> order <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">Order</span><span class="token punctuation">{</span> Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UserId <span class="token operator">=</span> userId <span class="token punctuation">}</span><span class="token punctuation">;</span>

        _service<span class="token punctuation">.</span><span class="token function">AddOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token function">Ok</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{orderId}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span> ActionResult<span class="token operator">&lt;</span>Order<span class="token operator">&gt;</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> userId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token function">FindFirstValue</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>NameIdentifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> order <span class="token operator">=</span> _service<span class="token punctuation">.</span><span class="token function">GetOrderForUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>order <span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> order<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>This <code>ApiController</code> is protected with an <code>[Authorize]</code> attribute, so users have to be logged in to call it. It exposes two action methods:</p><ul><li><code>Post()</code>: Used to create a new <code>Order</code>. The new <code>Order</code> object is returned in the response body.</li><li><code>Get()</code>: Used to fetch an order with the provided ID. If found, the <code>Order</code> is returned in the response body.</li></ul><p>Both methods need to know the <code>UserId</code> for the currently logged in user, so they find the <code>ClaimTypes.NameIdentifier</code> from the current <code>User</code> claims and parse it into a <code>Guid</code>.</p><p>Unfortunately, the code API controller above has a bug. </p><p>Did you spot it?</p><p>I don't blame you if not, I doubt I would.</p><h3 id="the-bug-all-guids-are-interchangeable" class="heading-with-anchor">The bug - All GUIDs are interchangeable<a href="#the-bug-all-guids-are-interchangeable"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>The code compiles and you can add a new <code>Order</code> successfully, but calling <code>Get()</code><em>always</em> returns a <code>404 Not Found</code>. </p><p>The problem is on this line in <code>OrderController.Get()</code>, where we're fetching the <code>Order</code> from the <code>OrderService</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> order <span class="token operator">=</span> _service<span class="token punctuation">.</span><span class="token function">GetOrderForUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The signature for that method is:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token class-name">Order</span><span class="token function">GetOrderForUser</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">,</span><span class="token class-name">Guid</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The <code>userId</code> and <code>orderId</code> arguments are inverted at the call site!</p><p>This example might seem a little contrived (requiring the <code>userId</code> to be provided feels a bit redundant) but this general pattern is something you'll probably see in practice many times. Part of the problem is that we're using a primitive object (<code>System.Guid</code>) to represent two different concepts: the unique identifier of a user, and the unique identifier of an order. The problem of using primitive values to represent domain concepts is called <em>primitive obsession</em>.</p><h2 id="primitive-obsession" class="heading-with-anchor">Primitive obsession<a href="#primitive-obsession"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>"Primitives" in this case refer to the built-in types in C#, <code>bool</code>, <code>int</code>, <code>Guid</code>, <code>string</code> etc. "Primitive obsession" refers to over-using these types to represent domain concepts that aren't a perfect fit. A common example might be a <code>ZipCode</code> or <code>PhoneNumber</code> field that is represented as a <code>string</code> (or even worse, an <code>int</code>!) </p><p>A <code>string</code> might make sense initially, after all, you <em>can</em> represent a Zip Code as a string of characters, but there's a couple of problems with this. </p><p>First, by using a built-in type (<code>string</code>), all the logic <em>associated</em> with the "Zip Code" <em>concept</em> must be stored somewhere <em>external</em> to the type. For example, only a limited number of <code>string</code> values are valid Zip Codes, so you will no-doubt have some validation for Zip Codes in your app. <a href="https://lostechies.com/jimmybogard/2007/12/03/dealing-with-primitive-obsession/">If you had a <code>ZipCode</code> type</a> you could encapsulate all this logic in one place. Instead, by using a <code>string</code>, you're forced to keep the logic somewhere else. That means the data (the <code>ZipCode</code> field) and the methods for operating on it are separated, breaking encapsulation.</p><p>Secondly, by using primitives for domain concepts, you lose a lot of the benefits of the type system. C# won't let you do something like the following:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">int</span> total <span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token keyword">string</span> name <span class="token operator">=</span><span class="token string">"Jim"</span><span class="token punctuation">;</span>
name <span class="token operator">=</span> total<span class="token punctuation">;</span></code></pre><p>But it has no problem with this, even though this would almost certainly be a bug:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">string</span> phoneNumber <span class="token operator">=</span><span class="token string">"+1-555-229-1234"</span><span class="token punctuation">;</span><span class="token keyword">string</span> zipCode <span class="token operator">=</span><span class="token string">"1000 AP"</span>

zipCode <span class="token operator">=</span> phoneNumber<span class="token punctuation">;</span></code></pre><p>You might think this sort of "mis-assignment" is rare, but a common place to find it is in methods that take multiple primitive objects as parameters. This was the problem in the original <code>GetOrderForUser()</code> method.</p><p>So what's the solution to this primitive obsession?</p><p>The answer is encapsulation. Instead of using primitives, we can create custom types for each separate domain concept. Instead of a <code>string</code><em>representing</em> a Zip Code, <a href="https://lostechies.com/jimmybogard/2007/12/03/dealing-with-primitive-obsession/">create a <code>ZipCode</code> class</a> that encapsulates the concept, and use the <code>ZipCode</code> type throughout your domain models and application. </p><h2 id="using-strongly-typed-ids" class="heading-with-anchor">Using strongly-typed IDs<a href="#using-strongly-typed-ids"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>So coming back to the original problem, how do we avoid the transposition error in <code>GetOrderForUser</code>?</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> order <span class="token operator">=</span> _service<span class="token punctuation">.</span><span class="token function">GetOrderForUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>By using encapsulation! Instead of using a <code>Guid</code><em>representing</em> the ID of a <code>User</code> or the ID of an <code>Order</code>, we can create strongly-typed IDs for both. So instead of a method signature like this:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token class-name">Order</span><span class="token function">GetOrderForUser</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">,</span><span class="token class-name">Guid</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>You have a method like this (note the method argument types):</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token class-name">Order</span><span class="token function">GetOrderForUser</span><span class="token punctuation">(</span><span class="token class-name">OrderId</span> orderId<span class="token punctuation">,</span><span class="token class-name">UserId</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>An <code>OrderId</code> cannot be assigned to a <code>UserId</code>, and vice versa, so there's no way to call the <code>GetOrderForUser</code> method with the arguments in the wrong order - it wouldn't compile!</p><p>So what do the <code>OrderId</code> and <code>UserId</code> types look like? That's up to you, but in the following section I show an example of one way you could implement them. </p><h3 id="an-implementation-of-orderid" class="heading-with-anchor">An implementation of <code>OrderId</code><a href="#an-implementation-of-orderid"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>The following example is an implementation of <code>OrderId</code>.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">readonly</span><span class="token keyword">struct</span> OrderId <span class="token punctuation">:</span> IComparable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">,</span> IEquatable<span class="token operator">&lt;</span>OrderId<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">Guid</span> Value <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token function">OrderId</span><span class="token punctuation">(</span><span class="token class-name">Guid</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Value <span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token class-name">OrderId</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">bool</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token class-name">OrderId</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">int</span><span class="token function">CompareTo</span><span class="token punctuation">(</span><span class="token class-name">OrderId</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> Value<span class="token punctuation">.</span><span class="token function">CompareTo</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">bool</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token keyword">object</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token keyword">false</span><span class="token punctuation">;</span><span class="token keyword">return</span> obj <span class="token keyword">is</span><span class="token class-name">OrderId</span> other <span class="token operator">&amp;&amp;</span><span class="token function">Equals</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">int</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> Value<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">override</span><span class="token keyword">string</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> Value<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">bool</span><span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span><span class="token class-name">OrderId</span> a<span class="token punctuation">,</span><span class="token class-name">OrderId</span> b<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> a<span class="token punctuation">.</span><span class="token function">CompareTo</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">bool</span><span class="token keyword">operator</span><span class="token operator">!=</span><span class="token punctuation">(</span><span class="token class-name">OrderId</span> a<span class="token punctuation">,</span><span class="token class-name">OrderId</span> b<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token operator">!</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><code>OrderId</code> is implemented as a <code>struct</code> here - it's a simple type that just wraps a <code>Guid</code>, so a <code>class</code> would probably be overkill. That said, if you're using an ORM like EF 6, using a <code>struct</code> might cause you problems, so a <code>class</code> might be easier. That also gives the option of creating a base <code>StronglyTypedId</code> class to avoid some of the boiler plate.</p><blockquote><p>There are some other potential issues with using a <code>stuct</code>, for example implicit parameterless constructors. <a href="https://enterprisecraftsmanship.com/2017/12/04/net-value-type-ddd-value-object/">Vladimir has a discussion about these problems here</a>.</p></blockquote><p>The only data in the type is held in the property, <code>Value</code>, which wraps the original <code>Guid</code> value that we were previously passing around. We have a single constructor that requires you pass in the <code>Guid</code> value. </p><p>Most of the functions are overrides of the standard <code>object</code> methods, and implementations of the <code>IEquatable&lt;T&gt;</code> and <code>IComparable&lt;T&gt;</code> methods to make it easier to work with the type. There's also overrides for the equality operators. I've written a few example tests demonstrating the type below.</p><blockquote><p>Note, as <a href="https://twitter.com/jaredpar">Jared Parsons</a> suggests in <a href="http://blog.paranoidcoding.com/2019/03/27/readonly-struct-breaking-change.html">his recent post, I marked the <code>stuct</code> as <code>readonly</code> for performance reasons.</a>. You need to be using C# 7.2 at least to use <code>readonly struct</code>.</p></blockquote><h3 id="testing-the-strongly-typed-id-behaviour" class="heading-with-anchor">Testing the strongly-typed ID behaviour<a href="#testing-the-strongly-typed-id-behaviour"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>The following xUnit tests demonstrate some of the characteristics of the strongly-typed ID <code>OrderId</code>. They also use a (similarly defined) <code>UserId</code> to demonstrate that they are distinct types.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">StronglyTypedIdTests</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token class-name">Fact</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">SameValuesAreEqual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> order1 <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> order2 <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>order1<span class="token punctuation">,</span> order2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">Fact</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">DifferentValuesAreUnequal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> order1 <span class="token operator">=</span> OrderId<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> order2 <span class="token operator">=</span> OrderId<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Assert<span class="token punctuation">.</span><span class="token function">NotEqual</span><span class="token punctuation">(</span>order1<span class="token punctuation">,</span> order2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">Fact</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">DifferentTypesAreUnequal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> userId <span class="token operator">=</span> UserId<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> orderId <span class="token operator">=</span> OrderId<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">NotEqual</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">)</span> bar<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">)</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">Fact</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">OperatorsWorkCorrectly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> same1 <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> same2 <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">OrderId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> different <span class="token operator">=</span> OrderId<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>same1 <span class="token operator">==</span> same2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>same1 <span class="token operator">!=</span> different<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">False</span><span class="token punctuation">(</span>same1 <span class="token operator">==</span> different<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">False</span><span class="token punctuation">(</span>same1 <span class="token operator">!=</span> same2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>By using strongly-typed IDs like these we can take full advantage of the C# type system to ensure different concepts cannot be accidentally used interchangeably. Using these types in the core of your domain will help prevent simple bugs like incorrect argument order issues, which can be easy to do, and tricky to spot! </p><p>Unfortunately, it's not all sunshine and roses. You may be able to use these types in the core of your domain easily enough, but inevitably you'll eventually have to interface with the outside world. These days, that's typically via JSON APIs, often using MVC with ASP.NET Core. In the next post I'll show how to create some simple convertors to make working with your strongly-typed IDs simpler.</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>C# has a great type system, so we should use it! Primitive obsession is very common, but you should do your best to fight against it. In this post I showed a way to avoid issues with incorrectly using IDs by using strongly-typed IDs, so the type system can protect you. In the next post I'll extend these types to make them easier to use in an ASP.NET Core app.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>