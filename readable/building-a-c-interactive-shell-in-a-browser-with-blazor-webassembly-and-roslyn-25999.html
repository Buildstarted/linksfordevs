<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Building a C# Interactive shell in a browser with Blazor (WebAssembly) and Roslyn | StrathWeb. A free flowing web tech monologue. - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Building a C# Interactive shell in a browser with Blazor (WebAssembly) and Roslyn | StrathWeb. A free flowing web tech monologue. - linksfor.dev(s)"/>
    <meta property="og:description" content="In this post I wanted to show you how to write and embed a C# interactive shell (a REPL &#x2013; read-evaluate-print-loop) in a browser, on top of WebAssembly."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.strathweb.com/2019/06/building-a-c-interactive-shell-in-a-browser-with-blazor-webassembly-and-roslyn/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title">devring.club</span>
				<a href="https://devring.club/site/1/previous" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Building a C# Interactive shell in a browser with Blazor (WebAssembly) and Roslyn | StrathWeb. A free flowing web tech monologue.</title>
<div class="readable">
        <h1>Building a C# Interactive shell in a browser with Blazor (WebAssembly) and Roslyn | StrathWeb. A free flowing web tech monologue.</h1>
            <div>Reading time: 27-34 minutes</div>
        <div>Posted here: 08 Jun 2019</div>
        <p><a href="https://www.strathweb.com/2019/06/building-a-c-interactive-shell-in-a-browser-with-blazor-webassembly-and-roslyn/">https://www.strathweb.com/2019/06/building-a-c-interactive-shell-in-a-browser-with-blazor-webassembly-and-roslyn/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
														<p>In this post I wanted to show you how to write and embed a C# interactive shell (a REPL – read-evaluate-print-loop) in a browser, on top of WebAssembly.</p>
<p>The REPL will give you fully fledged C# interactive development playground, while still being completely sandboxed in the browser environment. I originally wrote this example for my session at Dotnet Cologne on May 10 this year.</p>
<p>More after the jump.</p>

<h3 id="toc_1">TL;DR?</h3>
<p>Here is a preview what we are going to be building – in the browser (!) – today. A C# interactive experience.</p>

<p><strong>DEMO</strong>: <a href="https://csharpinteractive.azurewebsites.net/">https://csharpinteractive.azurewebsites.net</a> – warning: this is running on F1 free web app in Azure, so if it goes down, well, it goes down. Also there is no much optimization so it is a laaarge download and it might take a while; after that it should be in local cache.</p>
<p><strong>source code</strong>: <a href="https://github.com/filipw/Strathweb.Samples.BlazorCSharpInteractive">on Github</a></p>
<h3 id="toc_2">Getting started with Blazor</h3>
<p>There are plenty of excellent tutorials on how to get started with <a href="https://dotnet.microsoft.com/apps/aspnet/web-apps/client">Blazor</a> – Microsoft’s framework, that’s part of the ASP.NET family, that allows us to run C# code on the client side in the browser, on top of WebAssembly.</p>
<p>This blog post is not intended to be an introduction to Blazor, instead, I’d like to show you how to bootstrap the C# compiler in the interactive mode (submission based compilations), in order to deliver an interactive experience to the user.</p>
<p>The most basic introductory Blazor tutorial is <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/get-started?view=aspnetcore-3.0&amp;tabs=visual-studio-code">available here</a>, and if you are not familiar with Blazor, it is recommended that you have a read before continuing here.</p>
<h3 id="toc_3">Building a C# REPL with Roslyn</h3>
<p>It is actually remarkably simple to build a C# Interactive shell with Roslyn. Via the package called <a href="">Microsoft.CodeAnalysis.CSharp.Scripting</a>, you get access to what I like to call <strong>high level scripting APIs</strong> of the C# compiler.</p>
<p>The simplest possible C# REPL with those APIs can be constructed in just a few lines of code:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac0f805970369" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>ScriptState</span><span>&lt;</span><span>object</span><span>&gt;</span><span> </span><span>scriptState</span><span> </span><span>=</span><span> </span><span>null</span><span>;</span></p><p><span>while</span><span> </span><span>(</span><span>true</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>Write</span><span>(</span><span>"&gt; "</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>input</span><span> </span><span>=</span><span> </span><span>Console</span><span>.</span><span>ReadLine</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>scriptState</span><span> </span><span>=</span><span> </span><span>scriptState</span><span> </span><span>==</span><span> </span><span>null</span><span> </span><span>?</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await </span><span>CSharpScript</span><span>.</span><span>RunAsync</span><span>(</span><span>input</span><span>)</span><span> </span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await </span><span>scriptState</span><span>.</span><span>ContinueWithAsync</span><span>(</span><span>input</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0075 seconds] -->
</div>
<p>So what goes on here? We run an infinite loop, that prompts the user to input some C# code. We then take that input and execute it as a C# script code block using the scripting APIs found in <em>Microsoft.CodeAnalysis.CSharp.Scripting</em>, and we ask for more input. After the initial execution of code, the state gets created, and going forward, instead of running the subsequent submissions stand alone, we simply invoke them as continuations on the earlier state (again, the relevant API is exposed by Roslyn). What happens under the hood, is that each submission of code into the REPL actually gets compiled by Roslyn and the compiler takes care of all the necessary glue to join it all together.</p>
<p>This is a trivial example and it doesn’t cover a lot of cases such as capturing and printing potential result of an evaluated expression, doesn’t bootstrap any of the more complex assembly references, doesn’t predefine and global namespace imports, doesn’t support multi-line input and plenty more. It is however a valid starting point, and from the pure language perspective it is a fully functional C# interactive shell.</p>
<h3 id="toc_4">Building a C# REPL in a browser</h3>
<p>As we have seen in the example above, building a simple interactive shell with the high-level scripting APIs of Roslyn is very simple. Now, to get this working on top of Blazor, is a bit more challenging – as we will see soon.</p>
<p>We will be using version <em>3.0.0-preview5-19227-01</em> of Blazor for this exercise.</p>
<p>Once you create a basic Blazor project, we can start putting together the basic pieces. To not complicate things a lot, I will stuff everything – both the HTML side, and the C# code – into the <em>Index.razor</em> page. This will not be the most elegant solution, and of course in real life you may choose to architect things in a bit cleaner way, but for the purpose of this exercise it should be more than enough.</p>
<p>My HTML is going to look like this:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac24879540674" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>&lt;</span><span>div </span><span>id</span><span>=</span><span>"outer-screen"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;</span><span>&lt;</span><span>div </span><span>id</span><span>=</span><span>"inner-screen"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>div </span><span>id</span><span>=</span><span>"output-outer"</span><span>&gt;</span><span>&lt;</span><span>div </span><span>id</span><span>=</span><span>"output"</span><span>&gt;</span><span>&lt;</span><span>!</span><span>--</span><span> </span><span>TODO</span><span>:</span><span> </span><span>display </span><span>output</span><span> </span><span>--</span><span>&gt;</span><span>&lt;</span><span>/</span><span>div</span><span>&gt;</span><span>&lt;</span><span>/</span><span>div</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>div </span><span>id</span><span>=</span><span>"blank-line"</span><span>&gt;</span><span>&amp;</span><span>nbsp</span><span>;</span><span>&lt;</span><span>/</span><span>div</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>div </span><span>id</span><span>=</span><span>"input-row"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>span</span><span>&gt;</span><span>&amp;</span><span>gt</span><span>;</span><span>&lt;</span><span>/</span><span>span</span><span>&gt;</span><span>&lt;</span><span>!</span><span>--</span><span> </span><span>TODO</span><span>:</span><span> </span><span>display </span><span>input </span><span>prompt</span><span> </span><span>--</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>/</span><span>div</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;</span><span>&lt;</span><span>/</span><span>div</span><span>&gt;</span></p><p><span>&lt;</span><span>/</span><span>div</span><span>&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
</div>
<p>We can skip the CSS and styling part, other than say that it’s there to make things look nice – it’s available in the source code, if you follow the repository link at the end of this blog. The actual HTML+CSS styling used for this example comes from <a href="https://github.com/AlanLynn/Web-Terminal">Alan</a>, so big thanks to him.</p>
<p>The HTML comes with two placeholders that we’ll need to fill with:</p>
<ul>
<li>input prompt for the user (so that the user can type in C# code)</li>
<li>output – in case the user’s code evaluates to a return value, we’d want to show that to the user. We’ll also mirror back user’s input into the output panel so that the user gets a nice experience/feeling of working with an interactive shell</li>
</ul>
<p>We will be writing all the code inline in the <em>Index.razor</em>, under the <em>@functions {}</em> section. This means we can just use fields, properties and methods straight up, without needing to wrap them into a class.</p>
<p>The first piece of C# code to add will handle the ability to run code – so bind to the ENTER key being pressed inside the input field. That’s corresponding to the HTML we haven’t seen yet, and it will be slotted in the <em>TODO: display input prompt</em> placeholder we had seen earlier.</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac32532016370" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>&lt;</span><span>input </span><span>id</span><span>=</span><span>"input"</span><span> </span><span>bind</span><span>=</span><span>"@Input"</span><span> </span><span>type</span><span>=</span><span>"text"</span><span> </span><span>onkeyup</span><span>=</span><span>"@Run"</span><span> </span><span>autofocus</span><span> </span><span>/</span><span>&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
</div>
<p>The value of the input field will be 2-way bound to an <em>@Input</em> C# property which we will place under <em>@functions {}</em>. Again, we could have used a proper dedicated class as a view model here, but let’s keep things simple. When the key up JS event occurs, we will be invoking <em>@Run</em> method, which will be responsible for submitting the user-written code to our REPL engine. Note that the event happens for each key up, but we are only interested in ENTER key, so we will need to filter them.</p>
<p>At the moment our C# code looks like this:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac3f637758169" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p></div>
				</td>
						<td><div><p><span>@</span><span>functions</span><span> </span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>string</span><span> </span><span>Output</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>""</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>string</span><span> </span><span>Input</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>""</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async </span><span>Task </span><span>Run</span><span>(</span><span>UIKeyboardEventArgs</span><span> </span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>e</span><span>.</span><span>Key</span><span> </span><span>!=</span><span> </span><span>"Enter"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>Input</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Input</span><span> </span><span>=</span><span> </span><span>""</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await </span><span>RunSubmission</span><span>(</span><span>code</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->
</div>
<p>I already added an <em>Output</em> property to our <em>@functions {}</em> too. It is not used yet, but we’ll be making use of it very soon. It will be bound to the HTML that we shall place in the <em>TODO: display output</em> placeholder.</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac4b356359150" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>&lt;</span><span>div </span><span>id</span><span>=</span><span>"output"</span><span>&gt;</span><span>@</span><span>(</span><span>(</span><span>MarkupString</span><span>)</span><span>Output</span><span>)</span><span>&lt;</span><span>/</span><span>div</span><span>&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
</div>
<p>Finally, in our C# code snippet, we called a method <em>RunSubmission(code)</em>, which doesn’t actually exist yet, but we’ll be adding it soon – it will be the entry point into our in browser REPL engine, powered by the C# compiler.</p>
<p>But before we get there, let’s discuss for a moment how we can actually compile the snippets of code that users will submit into the interactive shell. We already mentioned that there is a very easy to bootstrap a REPL with the high-level Roslyn scripting APIs. The problem is that those APIs currently do not work on top of Mono WASM (the WebAssembly implementation backing Blazor). The main hurdle is that Roslyn scripting APIs will attempt to add an implicit reference to the assembly containing the <em>object</em> type implementation to each of our compilations (each submission into the interactive shell). This is very useful under normal circumstances, but on WASM it fails; Roslyn will look for this assembly using the <em>Assembly.Location</em> property and attempt to load it from disk – but on Mono WASM the location property returns a file name that doesn’t correspond to the real location and the whole thing crashes. In fact, under WASM you run inside of the browser sandbox, so the file system, from the application perspective, is completely empty. Therefore any attempt to load those DLLs from there would fail.</p>
<p>However, there is no problem – we can fairly easily get around all of this, by using the lower level APIs of the Roslyn compiler. It will no longer be so elegant as the earlier example but it will work; it will just mean we will have to manually take care of a bunch of things that the high-level scripting APIs normally give us “for free”.</p>
<p>At the lower level, the compiler exposes a method <em>CreateScriptCompilation()</em> on <em>CSharpCompilation</em> which can be used to create compilations relevant for the interactive context. It will also allow us to emit the assembly in the script-specific format – with the entry point that can handle the chain of submissions too.</p>
<p>The code that uses it, is shown next:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac57102398988" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p></div>
				</td>
						<td><div><p><span>private</span><span> </span><span>bool</span><span> </span><span>TryCompile</span><span>(</span><span>string</span><span> </span><span>source</span><span>,</span><span> </span><span>out </span><span>Assembly </span><span>assembly</span><span>,</span><span> </span><span>out </span><span>IEnumerable</span><span>&lt;</span><span>Diagnostic</span><span>&gt;</span><span> </span><span>errorDiagnostics</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assembly</span><span> </span><span>=</span><span> </span><span>null</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>scriptCompilation</span><span> </span><span>=</span><span> </span><span>CSharpCompilation</span><span>.</span><span>CreateScriptCompilation</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Path</span><span>.</span><span>GetRandomFileName</span><span>(</span><span>)</span><span>,</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CSharpSyntaxTree</span><span>.</span><span>ParseText</span><span>(</span><span>source</span><span>,</span><span> </span><span>CSharpParseOptions</span><span>.</span><span>Default</span><span>.</span><span>WithKind</span><span>(</span><span>SourceCodeKind</span><span>.</span><span>Script</span><span>)</span><span>.</span><span>WithLanguageVersion</span><span>(</span><span>LanguageVersion</span><span>.</span><span>Preview</span><span>)</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_references</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>CSharpCompilationOptions</span><span>(</span><span>OutputKind</span><span>.</span><span>DynamicallyLinkedLibrary</span><span>,</span><span> </span><span>usings</span><span>:</span><span> </span><span>new</span><span>[</span><span>]</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.IO"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Collections.Generic"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Console"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Diagnostics"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Dynamic"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Linq"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Linq.Expressions"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Net.Http"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Text"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Threading.Tasks"</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_previousCompilation</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>errorDiagnostics</span><span> </span><span>=</span><span> </span><span>scriptCompilation</span><span>.</span><span>GetDiagnostics</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>x</span><span>.</span><span>Severity</span><span> </span><span>==</span><span> </span><span>DiagnosticSeverity</span><span>.</span><span>Error</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>errorDiagnostics</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>false</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>using</span><span> </span><span>(</span><span>var</span><span> </span><span>peStream</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>MemoryStream</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>emitResult</span><span> </span><span>=</span><span> </span><span>scriptCompilation</span><span>.</span><span>Emit</span><span>(</span><span>peStream</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>emitResult</span><span>.</span><span>Success</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_submissionIndex</span><span>++</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_previousCompilation</span><span> </span><span>=</span><span> </span><span>scriptCompilation</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assembly</span><span> </span><span>=</span><span> </span><span>Assembly</span><span>.</span><span>Load</span><span>(</span><span>peStream</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>false</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0105 seconds] -->
</div>
<p>There is a little bit to unpack here. First of all, when we call the <em>CreateScriptCompilation()</em>, we need to pass in the code that the user attempts to compile, but already converted into a syntax tree. In other to get a syntax tree out of a string-based code representation, we use a parser, specifically configured to use  <em>SourceCodeKind.Script</em> when parsing the code. That will enable those slightly more relaxed rules of scripted C#, like ability to have global members. That is of course really important in a REPL context, because we don’t want to force the user to package every single submission into the interactive shell in a class or a, ugh, <em>static void Main()</em>!</p>
<p>There are three additional things we will pass into the <em>CreateScriptCompilation()</em> – metadata references (so, really assembly references), global using statements and a reference to previous compilation. </p>
<p>Global using statements are allowed in the script mode, and really do make sense if you think about it; this way our interactive shell user can interact with types in those predefined namespaces without having to explicitly import them. This is not mandatory, but is a very welcome convenience when working in a REPL; in our case, I simply decided to import some common ones.</p>
<p>The reason why we pass in a previous compilation reference is so that the user can reference types and members created in earlier submissions from later submissions. For example, when a user sends <em>var x = 1;</em> into the REPL, it will be natural for the user to expect that the variable <em>x</em> is accessible in subsequent submissions, allowing the user to execute, for example <em>x+x</em>. Of course since each submission is a separate compilation, then the declaration and usage would really be detached from each other – and that’s the reason why we need to keep passing the previous compilation into the subsequent one. We don’t need to worry about anything else – Roslyn will take care of the rest.</p>
<p>Finally, as mentioned, we need to pass in some <em>MetadataReferences</em> into the compliation. At the very least, the <em>mscorlib</em>, or <em>System.Runtime</em>, depending on the platform, so the assembly containing the implementation of <em>object</em> and other BCL types in ecessary for anything useful to work. We already mentioned that typically high-level scripting APIs will take care of that, but since we are not using them, we need to do it manually.</p>
<p>In this particular case our runtime environment is Blazor and we need to pick up those references in a way that will work – we already mentioned that under Mono WASM, the <em>Location</em> property of the assemblies returns a filename that doesn’t really correspond to the real physical location. We will need to work around that, and the workaround is shown next:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac65583645925" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>var</span><span> </span><span>refs</span><span> </span><span>=</span><span> </span><span>AppDomain</span><span>.</span><span>CurrentDomain</span><span>.</span><span>GetAssemblies</span><span>(</span><span>)</span><span>;</span></p><p><span>var</span><span> </span><span>client</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>HttpClient</span><span> </span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>BaseAddress</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Uri</span><span>(</span><span>WebAssemblyUriHelper</span><span>.</span><span>Instance</span><span>.</span><span>GetBaseUri</span><span>(</span><span>)</span><span>)</span></p><p><span>}</span><span>;</span></p><p><span>var</span><span> </span><span>references</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>MetadataReference</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>foreach</span><span>(</span><span>var</span><span> </span><span>reference </span><span>in</span><span> </span><span>refs</span><span>.</span><span>Where</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>!</span><span>x</span><span>.</span><span>IsDynamic</span><span> </span><span>&amp;&amp;</span><span> </span><span>!</span><span>string</span><span>.</span><span>IsNullOrWhiteSpace</span><span>(</span><span>x</span><span>.</span><span>Location</span><span>)</span><span>)</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>var</span><span> </span><span>stream</span><span> </span><span>=</span><span> </span><span>await </span><span>client</span><span>.</span><span>GetStreamAsync</span><span>(</span><span>$</span><span>"_framework/_bin/{reference.Location}"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>references</span><span>.</span><span>Add</span><span>(</span><span>MetadataReference</span><span>.</span><span>CreateFromStream</span><span>(</span><span>stream</span><span>)</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0077 seconds] -->
</div>
<p>Basically what we want to do, is we’d configure the interactive shell to have access to all the assemblies that our host Blazor application has. This will be the entire BCL plus some of the Blazor specific ASP.NET Core libraries. We already established that fetching them using the filesystem won’t work – the trick to fetch them using an HTTP request and handle as <em>Stream</em>. They will actually be available under <em>_framework/_bin/{assembly.Location}</em>.</p>
<p>Once we have those references, we can pass them into the compilation – and we will continue passing them to each subsequent compilation too. However, we need to fetch them using those HTTP requests only once, for the initial compilation, and can then reuse them, that’s why it makes sense to move this code into our Blazor app initialization, and simply store all the references in a field.</p>
<p>In order to run some code at app initialization in Blazor, you can override a method called <em>OnInitAsync()</em> – this works both from a dedicated view model class, as well as inside the <em>@functions {}</em> block. The result is shown next – and will become part of our <em>Index.razor</em>:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac72090801569" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p></div>
				</td>
						<td><div><p><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>MetadataReference</span><span>&gt;</span><span> </span><span>_references</span><span>;</span></p><p><span>protected</span><span> </span><span>async </span><span>override </span><span>Task </span><span>OnInitAsync</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>refs</span><span> </span><span>=</span><span> </span><span>AppDomain</span><span>.</span><span>CurrentDomain</span><span>.</span><span>GetAssemblies</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>client</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>HttpClient</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>BaseAddress</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Uri</span><span>(</span><span>WebAssemblyUriHelper</span><span>.</span><span>Instance</span><span>.</span><span>GetBaseUri</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>references</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>MetadataReference</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>foreach</span><span>(</span><span>var</span><span> </span><span>reference </span><span>in</span><span> </span><span>refs</span><span>.</span><span>Where</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>!</span><span>x</span><span>.</span><span>IsDynamic</span><span> </span><span>&amp;&amp;</span><span> </span><span>!</span><span>string</span><span>.</span><span>IsNullOrWhiteSpace</span><span>(</span><span>x</span><span>.</span><span>Location</span><span>)</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>stream</span><span> </span><span>=</span><span> </span><span>await </span><span>client</span><span>.</span><span>GetStreamAsync</span><span>(</span><span>$</span><span>"_framework/_bin/{reference.Location}"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>references</span><span>.</span><span>Add</span><span>(</span><span>MetadataReference</span><span>.</span><span>CreateFromStream</span><span>(</span><span>stream</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_references</span><span> </span><span>=</span><span> </span><span>references</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0088 seconds] -->
</div>
<p>This addition allows us to interact with the <em>_references</em> field inside our <em>TryCompile()</em> method we were discussing earlier.</p>
<p>The remainder of the <em>TryCompile()</em> is checking for compilation errors by looking at the diagnostics, and emitting the assembly in case the compilation succeeded. We emit into a memory stream, and load the assembly from there – there is no need to write out anything to disk.</p>
<p>Finally, we store the compilation in the <em>_previousCompilation</em> field – so that it can be used when compiling the subsequent submission, and we also store an index (<em>_submissionIndex</em>). This state tracking will be needed soon and we’ll explain that in a moment.</p>
<p>What’s left to do is to write the <em>RunSubmission()</em> method we mentioned already in the first snippet – it will of course make use of our new <em>TryCompile()</em> we have just written and analyzed. It is shown next:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac7f388006929" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p></div>
				</td>
						<td><div><p><span>private</span><span> </span><span>async </span><span>Task </span><span>RunSubmission</span><span>(</span><span>string</span><span> </span><span>code</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>@</span><span>"&lt;br /&gt;&lt;span class="</span><span>"info"</span><span>"&gt;{HttpUtility.HtmlEncode(code)}&lt;/span&gt;"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>previousOut</span><span> </span><span>=</span><span> </span><span>Console</span><span>.</span><span>Out</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>TryCompile</span><span>(</span><span>code</span><span>,</span><span> </span><span>out </span><span>var</span><span> </span><span>script</span><span>,</span><span> </span><span>out </span><span>var</span><span> </span><span>errorDiagnostics</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>writer</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>StringWriter</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>SetOut</span><span>(</span><span>writer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>entryPoint</span><span> </span><span>=</span><span> </span><span>_previousCompilation</span><span>.</span><span>GetEntryPoint</span><span>(</span><span>CancellationToken</span><span>.</span><span>None</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>type</span><span> </span><span>=</span><span> </span><span>script</span><span>.</span><span>GetType</span><span>(</span><span>$</span><span>"{entryPoint.ContainingNamespace.MetadataName}.{entryPoint.ContainingType.MetadataName}"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>entryPointMethod</span><span> </span><span>=</span><span> </span><span>type</span><span>.</span><span>GetMethod</span><span>(</span><span>entryPoint</span><span>.</span><span>MetadataName</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>submission</span><span> </span><span>=</span><span> </span><span>(</span><span>Func</span><span>&lt;</span><span>object</span><span>[</span><span>]</span><span>,</span><span> </span><span>Task</span><span>&gt;</span><span>)</span><span>entryPointMethod</span><span>.</span><span>CreateDelegate</span><span>(</span><span>typeof</span><span>(</span><span>Func</span><span>&lt;</span><span>object</span><span>[</span><span>]</span><span>,</span><span> </span><span>Task</span><span>&gt;</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>_submissionIndex</span><span> </span><span>&gt;=</span><span> </span><span>_submissionStates</span><span>.</span><span>Length</span><span>)</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Array</span><span>.</span><span>Resize</span><span>(</span><span>ref </span><span>_submissionStates</span><span>,</span><span> </span><span>Math</span><span>.</span><span>Max</span><span>(</span><span>_submissionIndex</span><span>,</span><span> </span><span>_submissionStates</span><span>.</span><span>Length *</span><span> </span><span>2</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>returnValue</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>(</span><span>(</span><span>Task</span><span>&lt;</span><span>object</span><span>&gt;</span><span>)</span><span>submission</span><span>(</span><span>_submissionStates</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>returnValue</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>CSharpObjectFormatter</span><span>.</span><span>Instance</span><span>.</span><span>FormatObject</span><span>(</span><span>returnValue</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>output</span><span> </span><span>=</span><span> </span><span>HttpUtility</span><span>.</span><span>HtmlEncode</span><span>(</span><span>writer</span><span>.</span><span>ToString</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>!</span><span>string</span><span>.</span><span>IsNullOrWhiteSpace</span><span>(</span><span>output</span><span>)</span><span>)</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>"&lt;br /&gt;{output}"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>foreach</span><span> </span><span>(</span><span>var</span><span> </span><span>diag </span><span>in</span><span> </span><span>errorDiagnostics</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>@</span><span>"&lt;br / &gt;&lt;span class="</span><span>"error"</span><span>"&gt;{HttpUtility.HtmlEncode(diag)}&lt;/span&gt;"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>catch</span><span> </span><span>(</span><span>Exception </span><span>ex</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>@</span><span>"&lt;br /&gt;&lt;span class="</span><span>"error"</span><span>"&gt;{HttpUtility.HtmlEncode(CSharpObjectFormatter.Instance.FormatException(ex))}&lt;/span&gt;"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>finally</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>SetOut</span><span>(</span><span>previousOut</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0184 seconds] -->
</div>
<p>Let’s quickly go through this code. First of all, we’ll echo user’s input into the output – that sort of makes sense, because in a REPL you are used to seeing your code “jump up” into the history of commands, rather than completely disappearing. Note that for simplicity we’ll sprinkle in some HTML into the output; obviously you could make it nicer if you wanted to. We are also going to escape the HTML encoding here because some code, such as for example generics, wouldn’t display otherwise.</p>
<p>We’ll then capture <em>Console.Out</em> into a temporary variable, this will allow us to temporarily pipe all <em>Console</em> output through a <em>StringWriter</em>, which we can than add to the <em>Output</em> field too. This way, if the user runs any code that writes to <em>Console.Out</em>, we’ll be able to intercept that and show it on the screen to – it’s a simple convenience thing for the user; otherwise it would be quite confusing if the <em>Console.Out</em> didn’t show up on the screen, but instead go the browser’s developer tools and the console there, which is the default behavior in Blazor.</p>
<p>We then reach a point where we compile the code, using the method we already wrote. If the compilation fails, we will print out the diagnostics in red color and exit – resetting the <em>Console.Out</em> at the end. If there is any other exception that is unhandled we also print that and exit with the console being reset.</p>
<p>The interesting stuff happens though, when the compilation succeeds. At that point we get an assembly that we can execute – but we need to find an entry point – after all this is not a regular console application but something the compiler called “script compilation”. In reality, under the hood, there is a special <em>Script</em> class that gets emitted, that contains a static method with a funky metadata name <em>&lt;Factory&gt;</em> (with angle brackets, yes) that is the real entry point we should use. We don’t need to hardcode those implementation details of the compiler here though, because we can actually determine the entry point by looking at the compilation itself (that information is exposed), and use that metadata to locate the entry point. </p>
<p>C# scripting factory method (entry point) can be cast to <em>Func&lt;object[], Task&gt;</em> so we will do that to get some semi-type safety. The input to it, the <em>object[]</em> array, is called a submission array. This is again an implementation detail of scripting in the C# compiler, and is normally hidden by the high level scripting APIs (<em>CSharpScript</em> class). In this case we have to manage it manually though. Without going into much details, this is a state array that links separate compilations in our interactive shell together. We will leave the first entry <em>null</em>, since it’s reserved for other purposes that are out of scope for this article (the so called globals object) and from index 1 onwards, the runtime, when our scripted code executes, will actually be internally filling the array with instances of the script wrapper class itself (which gets tried inside our entry point). Therefore, we need to do one more thing that normally the high level APIs would do for us – and that is take care of the manual resizing of the submission array, so that we don’t run out of slots (recall our <em>_submissionIndex</em> from earlier? we need it to manage this array resizing).</p>
<p>It is possible for a script expression in a REPL to have a return value – i.e. our aforementioned <em>x+x</em> expression which might produce value <em>2</em>. If that is the case, it will actually come out from the factory entry point as <em>object</em> wrapped in a <em>Task</em> – so we can unwrap it and print to the output.</p>
<p>To summarize, all the code is here:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cfc2696eac8d542728836" data-settings=" minimize scroll-mouseover wrap">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p></div>
				</td>
						<td><div><p><span>@</span><span>functions</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>string</span><span> </span><span>Output</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>""</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>string</span><span> </span><span>Input</span><span> </span><span>{</span><span> </span><span>get</span><span>;</span><span> </span><span>set</span><span>;</span><span> </span><span>}</span><span> </span><span>=</span><span> </span><span>""</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>CSharpCompilation </span><span>_previousCompilation</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>MetadataReference</span><span>&gt;</span><span> </span><span>_references</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>object</span><span>[</span><span>]</span><span> </span><span>_submissionStates</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>object</span><span>[</span><span>]</span><span> </span><span>{</span><span> </span><span>null</span><span>,</span><span> </span><span>null</span><span> </span><span>}</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>int</span><span> </span><span>_submissionIndex</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protected</span><span> </span><span>async </span><span>override </span><span>Task </span><span>OnInitAsync</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>refs</span><span> </span><span>=</span><span> </span><span>AppDomain</span><span>.</span><span>CurrentDomain</span><span>.</span><span>GetAssemblies</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>client</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>HttpClient</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>BaseAddress</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Uri</span><span>(</span><span>WebAssemblyUriHelper</span><span>.</span><span>Instance</span><span>.</span><span>GetBaseUri</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>references</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>MetadataReference</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>foreach</span><span>(</span><span>var</span><span> </span><span>reference </span><span>in</span><span> </span><span>refs</span><span>.</span><span>Where</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>!</span><span>x</span><span>.</span><span>IsDynamic</span><span> </span><span>&amp;&amp;</span><span> </span><span>!</span><span>string</span><span>.</span><span>IsNullOrWhiteSpace</span><span>(</span><span>x</span><span>.</span><span>Location</span><span>)</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>stream</span><span> </span><span>=</span><span> </span><span>await </span><span>client</span><span>.</span><span>GetStreamAsync</span><span>(</span><span>$</span><span>"_framework/_bin/{reference.Location}"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>references</span><span>.</span><span>Add</span><span>(</span><span>MetadataReference</span><span>.</span><span>CreateFromStream</span><span>(</span><span>stream</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_references</span><span> </span><span>=</span><span> </span><span>references</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>async </span><span>Task </span><span>Run</span><span>(</span><span>UIKeyboardEventArgs</span><span> </span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>e</span><span>.</span><span>Key</span><span> </span><span>!=</span><span> </span><span>"Enter"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>Input</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Input</span><span> </span><span>=</span><span> </span><span>""</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>await </span><span>RunSubmission</span><span>(</span><span>code</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>async </span><span>Task </span><span>RunSubmission</span><span>(</span><span>string</span><span> </span><span>code</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>@</span><span>"&lt;br /&gt;&lt;span class="</span><span>"info"</span><span>"&gt;{HttpUtility.HtmlEncode(code)}&lt;/span&gt;"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>previousOut</span><span> </span><span>=</span><span> </span><span>Console</span><span>.</span><span>Out</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>TryCompile</span><span>(</span><span>code</span><span>,</span><span> </span><span>out </span><span>var</span><span> </span><span>script</span><span>,</span><span> </span><span>out </span><span>var</span><span> </span><span>errorDiagnostics</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>writer</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>StringWriter</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>SetOut</span><span>(</span><span>writer</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>entryPoint</span><span> </span><span>=</span><span> </span><span>_previousCompilation</span><span>.</span><span>GetEntryPoint</span><span>(</span><span>CancellationToken</span><span>.</span><span>None</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>type</span><span> </span><span>=</span><span> </span><span>script</span><span>.</span><span>GetType</span><span>(</span><span>$</span><span>"{entryPoint.ContainingNamespace.MetadataName}.{entryPoint.ContainingType.MetadataName}"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>entryPointMethod</span><span> </span><span>=</span><span> </span><span>type</span><span>.</span><span>GetMethod</span><span>(</span><span>entryPoint</span><span>.</span><span>MetadataName</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>submission</span><span> </span><span>=</span><span> </span><span>(</span><span>Func</span><span>&lt;</span><span>object</span><span>[</span><span>]</span><span>,</span><span> </span><span>Task</span><span>&gt;</span><span>)</span><span>entryPointMethod</span><span>.</span><span>CreateDelegate</span><span>(</span><span>typeof</span><span>(</span><span>Func</span><span>&lt;</span><span>object</span><span>[</span><span>]</span><span>,</span><span> </span><span>Task</span><span>&gt;</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>_submissionIndex</span><span> </span><span>&gt;=</span><span> </span><span>_submissionStates</span><span>.</span><span>Length</span><span>)</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Array</span><span>.</span><span>Resize</span><span>(</span><span>ref </span><span>_submissionStates</span><span>,</span><span> </span><span>Math</span><span>.</span><span>Max</span><span>(</span><span>_submissionIndex</span><span>,</span><span> </span><span>_submissionStates</span><span>.</span><span>Length *</span><span> </span><span>2</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>returnValue</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>(</span><span>(</span><span>Task</span><span>&lt;</span><span>object</span><span>&gt;</span><span>)</span><span>submission</span><span>(</span><span>_submissionStates</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>returnValue</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>CSharpObjectFormatter</span><span>.</span><span>Instance</span><span>.</span><span>FormatObject</span><span>(</span><span>returnValue</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>output</span><span> </span><span>=</span><span> </span><span>HttpUtility</span><span>.</span><span>HtmlEncode</span><span>(</span><span>writer</span><span>.</span><span>ToString</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>!</span><span>string</span><span>.</span><span>IsNullOrWhiteSpace</span><span>(</span><span>output</span><span>)</span><span>)</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>"&lt;br /&gt;{output}"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>foreach</span><span> </span><span>(</span><span>var</span><span> </span><span>diag </span><span>in</span><span> </span><span>errorDiagnostics</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>@</span><span>"&lt;br / &gt;&lt;span class="</span><span>"error"</span><span>"&gt;{HttpUtility.HtmlEncode(diag)}&lt;/span&gt;"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>catch</span><span> </span><span>(</span><span>Exception </span><span>ex</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Output</span><span> </span><span>+=</span><span> </span><span>$</span><span>@</span><span>"&lt;br /&gt;&lt;span class="</span><span>"error"</span><span>"&gt;{HttpUtility.HtmlEncode(CSharpObjectFormatter.Instance.FormatException(ex))}&lt;/span&gt;"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>finally</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>SetOut</span><span>(</span><span>previousOut</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>bool</span><span> </span><span>TryCompile</span><span>(</span><span>string</span><span> </span><span>source</span><span>,</span><span> </span><span>out </span><span>Assembly </span><span>assembly</span><span>,</span><span> </span><span>out </span><span>IEnumerable</span><span>&lt;</span><span>Diagnostic</span><span>&gt;</span><span> </span><span>errorDiagnostics</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assembly</span><span> </span><span>=</span><span> </span><span>null</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>scriptCompilation</span><span> </span><span>=</span><span> </span><span>CSharpCompilation</span><span>.</span><span>CreateScriptCompilation</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Path</span><span>.</span><span>GetRandomFileName</span><span>(</span><span>)</span><span>,</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CSharpSyntaxTree</span><span>.</span><span>ParseText</span><span>(</span><span>source</span><span>,</span><span> </span><span>CSharpParseOptions</span><span>.</span><span>Default</span><span>.</span><span>WithKind</span><span>(</span><span>SourceCodeKind</span><span>.</span><span>Script</span><span>)</span><span>.</span><span>WithLanguageVersion</span><span>(</span><span>LanguageVersion</span><span>.</span><span>Preview</span><span>)</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_references</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>CSharpCompilationOptions</span><span>(</span><span>OutputKind</span><span>.</span><span>DynamicallyLinkedLibrary</span><span>,</span><span> </span><span>usings</span><span>:</span><span> </span><span>new</span><span>[</span><span>]</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.IO"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Collections.Generic"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Console"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Diagnostics"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Dynamic"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Linq"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Linq.Expressions"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Net.Http"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Text"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"System.Threading.Tasks"</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_previousCompilation</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>errorDiagnostics</span><span> </span><span>=</span><span> </span><span>scriptCompilation</span><span>.</span><span>GetDiagnostics</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>x</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>x</span><span>.</span><span>Severity</span><span> </span><span>==</span><span> </span><span>DiagnosticSeverity</span><span>.</span><span>Error</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>errorDiagnostics</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>false</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>using</span><span> </span><span>(</span><span>var</span><span> </span><span>peStream</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>MemoryStream</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>emitResult</span><span> </span><span>=</span><span> </span><span>scriptCompilation</span><span>.</span><span>Emit</span><span>(</span><span>peStream</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>emitResult</span><span>.</span><span>Success</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_submissionIndex</span><span>++</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_previousCompilation</span><span> </span><span>=</span><span> </span><span>scriptCompilation</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assembly</span><span> </span><span>=</span><span> </span><span>Assembly</span><span>.</span><span>Load</span><span>(</span><span>peStream</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>false</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0455 seconds] -->
</div>
<h3 id="toc_5">Summary</h3>
<p>And that’s it! We now have a fully functional (well, “fully functional”, it could be much better but it can do lots of stuff already) C# REPL. It runs entirely in the browser, on top of Mono WASM / Blazor and it has full browser sandbox. You could try interacting with the file system, and see that it’s empty – but you can create new files for yourself. You can attempt to make HTTP calls from <em>HttpClient</em> – and you will find out that they really show up in the browser’s XHR tools as outgoing browser calls. In fact they will even be subject to browser CORS rules!</p>
<p>I think in general the concept is pretty cool. Imagine a documentation site such as <a href="https://docs.microsoft.com/">docs.microsoft.com</a> or StackOverflow any other site with readmes/tutorials – providing an in-browser C# REPL so that you can play around with the types/examples straight away – that could be extremely valuable.</p>
<p>All the code for this article is available <a href="https://github.com/filipw/Strathweb.Samples.BlazorCSharpInteractive">on Github</a>. If there is enough interest, we might do a second part of this – wiring in intellisense and language services into this. Let me know if you’d find that interesting. One final note – if you are interested in this area in general, have a look at <a href="https://github.com/Suchiman/Runny">this nice example of Roslyn and WASM</a> from Suchiman.</p>
						</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>