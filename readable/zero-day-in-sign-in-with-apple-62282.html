<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Zero-day in Sign in with Apple - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Zero-day in Sign in with Apple - linksfor.dev(s)"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://bhavukjain.com/blog/2020/05/30/zeroday-signin-with-apple/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
				<a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Zero-day in Sign in with Apple</title>
<div class="readable">
        <h1>Zero-day in Sign in with Apple</h1>
            <div>Reading time: 3-4 minutes</div>
        <div>Posted here: 30 May 2020</div>
        <p><a href="https://bhavukjain.com/blog/2020/05/30/zeroday-signin-with-apple/">https://bhavukjain.com/blog/2020/05/30/zeroday-signin-with-apple/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p><img src="https://bhavukjain.com/assets/images/siwa.png" alt="image"></p>

<p>What if I say, your Email ID is all I need to takeover your account on your favorite website or an app. Sounds scary, right? This is what a bug in <code>Sign in with Apple</code> allowed me to do.</p>

<p>In the month of April, I found a zero-day in <code>Sign in with Apple</code> that affected third-party applications which were using it and didn’t implement their own additional security measures. This bug could have resulted in a <strong>full account takeover of user accounts</strong> on that third party application irrespective of a victim having a valid Apple ID or not.</p>

<blockquote>
  <p>For this vulnerability, I was paid $100,000 by Apple under their Apple Security Bounty program.</p>
</blockquote>

<p><strong>Technical Details</strong></p>

<p>The <code>Sign in with Apple</code> works similarly to OAuth 2.0. There are two possible ways to authenticate a user by either using a <code>JWT (JSON Web Token)</code> or a <code>code</code> generated by the Apple server. The code is then used to generate a JWT. The below diagram represents how the JWT creation and validation works.</p>

<p><img src="https://bhavukjain.com/assets/images/flow_apple_auth.png" alt="image"></p>

<p>In the 2nd step, while authorizing, Apple gives an option to a user to either share the Apple Email ID with the 3rd party app or not. If the user decides to hide the Email ID, Apple generates its own user-specific Apple relay Email ID. Depending upon the user selection, after successful authorization, Apple creates a JWT which contains this Email ID which is then used by the 3rd party app to login a user.</p>

<p>A decoded JWT’s payload looks like this:</p>

<div><div><pre><code><span>{</span>
  <span>"iss"</span>: <span>"<a href="https://appleid.apple.com/" rel="nofollow"><span>https</span><span>://</span><span>appleid</span><span>.</span><span>apple</span><span>.</span><span>com</span></a>"</span>,
  <span>"aud"</span>: <span>"com.XXXX.weblogin"</span>,
  <span>"exp"</span>: 158XXXXXXX,
  <span>"iat"</span>: 158XXXXXXX,
  <span>"sub"</span>: <span>"XXXX.XXXXX.XXXX"</span>,
  <span>"c_hash"</span>: <span>"FJXwx9EHQqXXXXXXXX"</span>,
  <span>"email"</span>: <span>"contact@bhavukjain.com"</span>, // or <span>"XXXXX@privaterelay.appleid.com"</span>
  <span>"email_verified"</span>: <span>"true"</span>,
  <span>"auth_time"</span>: 158XXXXXXX,
  <span>"nonce_supported"</span>: <span>true</span>
<span>}</span>
</code></pre></div></div>
<p><strong>**BUG</strong>**</p>

<p>I found I could request JWTs for any Email ID from Apple and when the signature of these tokens was verified using Apple’s public key, they showed as valid. This means an attacker could forge a JWT by linking any Email ID to it and gaining access to the victim’s account.</p>

<p>Sample Request (2nd step)</p>



<p>Here on passing any <code>email</code>, Apple generated a valid JWT (id_token) for that particular Email ID.</p>

<p>Sample Response</p>

<div><div><pre><code><span>{</span>
  <span>"authorization"</span> : <span>{</span>
    <span>"id_token"</span> : <span>"eyJraWQiOiJlWGF1bm1MIiwiYWxnIjoiUlMyNTYifQ.XXXXX.XXXXX"</span>,
    <span>"grant_code"</span> : <span>"XXX.0.nzr.XXXX"</span>,
    <span>"scope"</span> : <span>[</span> <span>"name"</span>, <span>"email"</span> <span>]</span>
  <span>}</span>,
  <span>"authorizedData"</span> : <span>{</span>
    <span>"userId"</span> : <span>"XXX.XXXXX.XXXX"</span>
  <span>}</span>,
  <span>"consentRequired"</span> : <span>false</span>
<span>}</span>
</code></pre></div></div>

<p>The impact of this vulnerability was quite critical as it could have allowed full account takeover. A lot of developers have integrated <code>Sign in with Apple</code> since it is mandatory for applications that support other social logins. To name a few that use <code>Sign in with Apple</code> - Dropbox, Spotify, Airbnb, Giphy (Now acquired by Facebook). These applications were not tested but could have been vulnerable to a full account takeover if there weren’t any other security measures in place while verifying a user.</p>

<p>Apple also did an investigation of their logs and determined there was no misuse or account compromise due to this vulnerability.</p>

<p>A huge thanks to the Apple Security Team.</p>

<p>Thanks for the read, see you in next article :)</p>


  </div>
  
  
</article>

      </div>
    </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>