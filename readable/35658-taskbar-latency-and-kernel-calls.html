<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Taskbar Latency and Kernel&#xA0;Calls -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Taskbar Latency and Kernel&#xA0;Calls</h1>
    <div id="post-3208" class="post-3208 post type-post status-publish format-standard hentry category-investigative-reporting category-performance category-uiforetw-2 category-xperf tag-menus tag-readfile tag-taskbar tag-windows-10"> <div class="entry-content"> <p>I work quickly on my computer and I get frustrated when I am forced to wait on an operation that should be fast. A persistent nuisance on my over-powered home laptop is that closing windows on the taskbar is slow. I right-click on an entry, wait for the menu to appear, and then select &#x201C;Close window&#x201D;. The mouse movement should be the slow part of this but instead I find that the delay before the menu appears is the longest component.</p>
<p>This has been bothering me for a long time but I had been showing uncharacteristic self control and had resisted being distracted. Until today, when I finally broke down and grabbed an <a href="https://randomascii.wordpress.com/2015/09/24/etw-central/">ETW</a> trace.</p>
<blockquote>
<p>This post was written as a test of speed-blogging. Total time from finding the issue and <a href="https://twitter.com/BruceDawson0xB/status/1170924849004367873">sarcastically tweeting</a> about it to publishing the initial post was about 90 minutes.</p>
</blockquote>
<p>The ETW trace records me right-clicking on the task bar to close two Explorer windows. I used <a href="https://randomascii.wordpress.com/2015/09/01/xperf-basics-recording-a-trace-the-ultimate-easy-way/">UIforETW</a>&#x2019;s <em>Tracing to file</em> with the default options, giving me a <a href="https://github.com/randomascii/blogstuff/tree/master/TaskbarLatency">20.9 MB trace</a>.</p> <p>Sometimes the challenge in trace analysis is to find where the issue is, but for this issue that part of the analysis was trivial. There were three clear signals that all pointed to the right place, and a painfully obvious culprit.</p>
<p>The first signal is the input events. UIforETW contains an integrated <a href="https://github.com/google/UIforETW/blob/master/UIforETW/KeyLoggerThread.cpp">input logger</a> (anonymized enough so that I don&#x2019;t accidentally steal passwords or personal information) so I could just drill down to the <em>MouseUp</em> events with a <em>Button Type</em> of 2, which represents the right mouse button. This draws highlights on the <a href="https://randomascii.wordpress.com/2012/06/19/wpaxperf-trace-analysis-reimagined/">WPA</a> timeline for when those events happened &#x2013; see the vertical lines below:</p>
<p><a href="https://randomascii.files.wordpress.com/2019/09/image.png"><img width="630" alt="image" src="https://randomascii.files.wordpress.com/2019/09/image_thumb.png?w=630&amp;h=778"></a></p>
<p>That tells me when I released the right mouse button, and there is very suggestive window focus change that happens about 600 ms later which I&#x2019;m guessing is when the menu appeared. Finally there is a clear block of CPU activity in RuntimeBroker.exe between the mouse up and window focus events.</p>
<p>The window focus change and CPU activity are not <em>proven</em> to show the end time, but measurements with a screen recorder app showed the menu taking about 660 ms to appear so I&#x2019;m going to trust them.</p>
<p>The next step was to see what RuntimeBroker.exe was doing. While <a href="https://randomascii.wordpress.com/2012/05/05/xperf-wait-analysisfinding-idle-time/">CPU Usage (Precise)</a> is great for seeing how much CPU time a process is using, and why it is sitting idle, the <a href="https://randomascii.wordpress.com/2013/04/23/xperf-for-excess-cpu-consumption-wpa-edition/">CPU Usage (Sampled) table</a> is the right tool for figuring out where CPU time is being spent. I drilled down and quickly found 264 samples hitting in <em>KernelBase.dll!ReadFile</em>:</p>
<p><a href="https://randomascii.files.wordpress.com/2019/09/image-1.png"><img width="668" alt="image" src="https://randomascii.files.wordpress.com/2019/09/image_thumb-1.png?w=668&amp;h=330"></a></p>
<p>Looking around a bit I found other call stacks that also ended up in that function so I right-clicked on it and went <em>View Callers-&gt; By Function</em>. The view this gave me (with stacks now inverted) shows that a total of 628 samples, along various call stacks, ended up going through that function, accounting for 70% of the 899 total samples in that process:</p>
<p><a href="https://randomascii.files.wordpress.com/2019/09/image-2.png"><img width="681" alt="image" src="https://randomascii.files.wordpress.com/2019/09/image_thumb-2.png?w=681&amp;h=335"></a></p>
<p>271 samples in that thread didn&#x2019;t go through that function, and the remaining samples (not shown) were in other threads.</p>
<p>Note that the 899 samples in thread 10,252 represent two mouse clicks, so about 450 samples or about 450 ms (using the default 1 kHz sampling rate) per mouse-click.</p>
<h2>Sometimes file I/O is CPU time</h2>
<p>CPU Usage (Sampled) shows <em>CPU</em> time, so disk I/O usually doesn&#x2019;t show up there because then the thread goes to sleep and waits on the disk. The fact that this shows up as CPU time suggests that the reads were all hitting in the system cache and the CPU time was the kernel overhead (note <em>ntoskrnl.exe</em> on the first sampled call stack) of grabbing data from the cache.</p>
<p>Now that we suspect file I/O it&#x2019;s necessary to go to <em>Graph Explorer-&gt; Storage-&gt; File I/O</em>. With a bit of column rearranging we get this impressive result:</p>
<p><a href="https://randomascii.files.wordpress.com/2019/09/image-3.png"><img width="681" alt="image" src="https://randomascii.files.wordpress.com/2019/09/image_thumb-3.png?w=681&amp;h=273"></a></p>
<p>What this says is that, over the course of two right-mouse clicks, <em>RuntimeBroker.exe</em>, thread 10,252, issued 229,604 <em>ReadFile</em> calls, reading a total of 15,686,586 bytes. That is an average read of 68 bytes each time.</p>
<p>Think about that for a moment.</p>
<p>Remember that these are calls to the operating system &#x2013; kernel calls. This means that there is no caching between <em>RuntimeBroker.exe</em> and this file. In fact, the file itself is only 4,027,904 bytes long, so each time I right-click an explorer icon on the task bar this file is read 1.9 times in the slowest possible way.</p>
<p>After some encouragement from readers I decided to delete the file in question and now my explorer jumplist menus are almost instantaneous. I don&#x2019;t recommend it but deleting this file might help you also (at the cost of losing your explorer history):</p>
<p><font>%appdata%\Microsoft\Windows\Recent\AutomaticDestinations\f01b4d95cf55d32a.automaticDestinations-ms</font></p>
<p>The gains from deleting that file can be seen in this WPA screenshot. The thin vertical lines are right mouse clicks and the bottom row of rectangles represents when the menu started appearing. I deleted the file after the first two clicks and the delay is hugely reduced on the last two clicks:</p>
<p><img width="654" alt="Image" src="https://pbs.twimg.com/media/EECcuaFUYAAFh1M?format=png&amp;name=900x900"></p>
<p>Alternately &#x201C;you can use the official doohickey in Settings to both clear (toggle 2x) or disable (toggle 1x) jumplists on Start/Taskbar. Be sure to also disable animations for an extra speed boost.&#x201D; <a href="https://twitter.com/WithinRafael/status/1171228479251025920">Thanks Rafael</a>!</p>
<p>This seems like a fixable problem. Once explorer&#x2019;s taskbar menu latency is reduced it would be great to see the other delays addressed so that all taskbar menus appear instantly instead of with hundreds of ms of delays.</p>
<h2>Summary</h2>
<ul>
<li>Don&#x2019;t call ReadFile to get 68 bytes. Or, at least, don&#x2019;t do it a hundred thousand times. I get cranky when <a href="https://randomascii.wordpress.com/2012/08/19/fixing-another-photo-gallery-performance-bug/">databases do 4-KiB reads</a> but this is <em>amazing.</em></li>
<li>I hope somebody fixes this but until then I&#x2019;ve got a workaround by deleting the problematic file</li>
<li>I hope somebody investigates to find out why context menus are slow in general. Hey, I <a href="https://github.com/randomascii/blogstuff/tree/master/TaskbarLatency">shared an ETW trace</a> and everything!</li>
<li>Feedback shared through official channels at <a href="https://aka.ms/AA60dfg">https://aka.ms/AA60dfg</a></li>
<li>If you want to learn how to do this type of analysis then get my tool <a href="https://randomascii.wordpress.com/2015/09/01/xperf-basics-recording-a-trace-the-ultimate-easy-way/">UIforETW</a> and read some of my tutorials, linked from <a href="https://randomascii.wordpress.com/2015/09/24/etw-central/">here</a></li>
<li>Note that you can get a context menu (simpler than the default Jumplist menu) much faster by <a href="https://twitter.com/ericlaw/status/1171030922755530753">shift+right-clicking on the icons</a>. I&#x2019;m gonna use this trick when closing lots of windows.</li>
<li>Hacker news discussion is <a href="https://news.ycombinator.com/item?id=20916072#20919612">here</a></li>
<li>Reddit discussion is <a href="https://www.reddit.com/r/programming/comments/d1ofql/taskbar_latency_and_kernel_calls/">here</a></li>
<li>Twitter threads are <a href="https://twitter.com/BruceDawson0xB/status/1170924849004367873">here</a> and <a href="https://twitter.com/BruceDawson0xB/status/1171107806373539841">here</a></li>
</ul> </div> <div id="entry-author-info"> </div> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>