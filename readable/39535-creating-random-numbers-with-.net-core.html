<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Creating Random Numbers With .NET Core -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Creating Random Numbers With .NET Core</h1>
    <div class="post-content"> <p>When we think about programming, we usually think about well-intentioned systematic instructions executing when and how we intended. In a digital world of One&#x2019;s and Zero&#x2019;s, the idea of randomness is madness. In the real world, randomness is a necessary part of our lives.</p> <p>When programming, you may be required to generate random values to mimic the real-world system you are trying to emulate. Before we get to code, it is essential to define what we mean by <em>randomness</em> because it can have variations that can lead to consequences we never intended.</p> <h2 id="what-is-randomness">What Is Randomness?</h2> <p>The idea of randomness may seem intuitive, but there are two kinds of randomness you should consider when looking to add it to your applications:</p> <ol> <li><strong>Predictability</strong></li> <li><strong>Uniformity</strong></li>
</ol> <p>If you look at Merriam-Webster&#x2019;s definition of random, you&#x2019;ll get an explanation mentioning both concepts. The first being about predictability.</p> <blockquote> <p>lacking a definite plan, purpose, or pattern<cite>&#x2013;<a href="https://www.merriam-webster.com/dictionary/random">Merriam-Webster</a></cite></p>
</blockquote> <p>In this case, given our previous set of values, can I predict with high confidence what the next value will be? If I can not, then I have a random process.</p> <p>Uniformity may be more critical when wanting randomness.</p> <blockquote> <p>relating to, having, or being elements or events with [a] definite probability of occurrence <cite>&#x2013;<a href="https://www.merriam-webster.com/dictionary/random">Merriam-Webster</a></cite></p>
</blockquote> <p>Uniformity doesn&#x2019;t look at any single value, but the complete set of our random values. If our collection has a general distribution, then we know our randomness is even and has no biases that could potentially be hurting us.</p> <p>The following post will look at several ways to generate random values in .NET Core from the perspective of predictability and uniformity. You will also see samples in C# and .NET Core that you can use for your particular use cases.</p> <h2 id="random-class">Random Class</h2> <p>The .NET Framework has shipped with the <code class="highlighter-rouge">Random</code> class since the initial releases. The <code class="highlighter-rouge">Random</code> class is still here in .NET Core and performs very similarly.</p> <p>When generating values, you have the option between several outputs:</p> <p>1.Integers (<code class="highlighter-rouge">int</code>)
1.Bytes (<code class="highlighter-rouge">byte</code>)
1.Doubles (<code class="highlighter-rouge">double</code>)</p> <p>Accessing values occurs through methods <code class="highlighter-rouge">Next</code>, <code class="highlighter-rouge">NextBytes</code>, and <code class="highlighter-rouge">NextDouble</code> appropriately.</p> <h3 id="generate-using-random-vanilla">Generate Using Random (Vanilla)</h3> <p>Let&#x2019;s generate a basic random integer with a C# sample.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>
<span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">Next</span><span class="p">();</span>
<span class="k">return</span> <span class="k">value</span><span class="p">;</span>
</code></pre></div></div> <p>With the following output</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Random Using Next: 303739907
</code></pre></div></div> <p>This value is random, so your number will likely be different.</p> <p>The <code class="highlighter-rouge">Random</code> class can also take a <code class="highlighter-rouge">seed</code> parameter that can impact the number generated by our class.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span><span class="m">1</span><span class="p">);</span>
<span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">Next</span><span class="p">();</span>
<span class="k">return</span> <span class="k">value</span><span class="p">;</span>
</code></pre></div></div> <blockquote> <p>But what is the seed, and what is it doing to our random values?</p>
</blockquote> <p>The <a href="https://docs.microsoft.com/en-us/dotnet/api/system.random.-ctor?view=netframework-4.8">Microsoft Documentation</a> explicitly states: <strong>&#x201C;A number used to calculate a starting value for the pseudo-random number sequence.&#x201D;</strong></p> <p>If you read that definition carefully, you may notice some words that indicate the presence of predictability, one of our randomness concepts.</p> <h3 id="the-problem-with-random-the-class">The Problem With Random (the class)</h3> <p><strong>While not generally an issue, the class is predictable. Given similar circumstances, we could generate the same random numbers every time with the <code class="highlighter-rouge">Random</code> class.</strong></p> <p>On the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.random.-ctor?view=netframework-4.8">Microsoft Documentation</a> site, they show an example where the random class generates the same values when using the same <code class="highlighter-rouge">seed</code></p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Random numbers from a Random object with seed = 456: 2044805024 1323311594 1087799997 1907260840 179380355 120870348 0.21988117 0.21026556 0.39236514 0.42420498 0.24102703 0.47310170

Random numbers from a Random object with seed = 456: 2044805024 1323311594 1087799997 1907260840 179380355 120870348 0.21988117 0.21026556 0.39236514 0.42420498 0.24102703 0.47310170
</code></pre></div></div> <p>While the general distribution may look random (uniformity), this randomness is predictable.</p> <blockquote> <p>Providing an identical seed value to different Random objects causes each instance to produce identical sequences of random numbers. <a href="https://docs.microsoft.com/en-us/dotnet/api/system.random.-ctor?view=netframework-4.8">Microsoft Documentation</a></p>
</blockquote> <p>Well, what if we want unpredictable randomness?</p> <h2 id="randomnumbergenerator--cryptographic-randomness">RandomNumberGenerator &amp; Cryptographic Randomness</h2> <p>.NET Core ships with a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.randomnumbergenerator?view=netframework-4.8"><code class="highlighter-rouge">RandomNumberGenerator</code></a>. The specific implementation of the random number generator is <code class="highlighter-rouge">RNGCryptoServiceProvider</code>. This class generates cryptographically secure values. In other words, the values it produces are not predictable by you or anyone. They are truly random, but that comes at a cost, as you&#x2019;ll see.</p> <p>The most significant difference is that the <code class="highlighter-rouge">RandomNumberGenerator</code> and <code class="highlighter-rouge">Random</code> is that the former can only generate random bytes. Luckily, bytes are the building blocks of all C# types. Let&#x2019;s look at an example where we create a random integer that is cryptographically secure.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="n">RandomNumberGenerator</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)];</span> <span class="c1">// 4 bytes</span>
<span class="n">random</span><span class="p">.</span><span class="nf">GetNonZeroBytes</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
</code></pre></div></div> <p>The example above uses the <code class="highlighter-rouge">sizeof</code> operator to get the size of our target type <code class="highlighter-rouge">int</code>, which is 4 bytes. Next, we fill a <code class="highlighter-rouge">byte[]</code> with 4 bytes. Finally, we use the <code class="highlighter-rouge">BitConverter</code> class to convert our bytes to our target type of <code class="highlighter-rouge">int</code>. Try this technique to any kind that <code class="highlighter-rouge">BitConverter</code> supports.</p> <p>I&#x2019;ve also written a simple static method that gives you <code class="highlighter-rouge">Next</code> functionality similar to the one in the <code class="highlighter-rouge">Random</code> class.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">Next</span><span class="p">(</span><span class="k">this</span> <span class="n">RandomNumberGenerator</span> <span class="n">generator</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span> <span class="c1">// match Next of Random</span> <span class="c1">// where max is exclusive</span> <span class="n">max</span> <span class="p">=</span> <span class="n">max</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)];</span> <span class="c1">// 4 bytes</span> <span class="n">generator</span><span class="p">.</span><span class="nf">GetNonZeroBytes</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span> <span class="kt">var</span> <span class="n">val</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span> <span class="c1">// constrain our values to between our min and max</span> <span class="c1">// https://stackoverflow.com/a/3057867/86411</span> <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="p">((</span><span class="n">val</span> <span class="p">-</span> <span class="n">min</span><span class="p">)</span> <span class="p">%</span> <span class="p">(</span><span class="n">max</span> <span class="p">-</span> <span class="n">min</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span> <span class="p">+</span> <span class="p">(</span><span class="n">max</span> <span class="p">-</span> <span class="n">min</span> <span class="p">+</span> <span class="m">1</span><span class="p">))</span> <span class="p">%</span> <span class="p">(</span><span class="n">max</span> <span class="p">-</span> <span class="n">min</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span> <span class="p">+</span> <span class="n">min</span><span class="p">;</span> <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="the-problem-with-randomnumbergenerator">The Problem With RandomNumberGenerator</h3> <p>Performance is the high cost of gaining cryptographic randomness. When generating 10,000 random values, the difference is magnitudes more expensive.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>
<span class="k">using</span> <span class="nn">var</span> <span class="n">crypto</span> <span class="p">=</span> <span class="n">RandomNumberGenerator</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">min</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">max</span> <span class="p">=</span> <span class="m">10000</span><span class="p">;</span> <span class="kt">var</span> <span class="n">watch</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>
<span class="n">watch</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span> <span class="n">random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">watch</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span> <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$&quot;Random took </span><span class="p">{</span><span class="n">watch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">}</span><span class="s"> ms&quot;</span><span class="p">);</span> <span class="n">watch</span><span class="p">.</span><span class="nf">Restart</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span> <span class="n">crypto</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">watch</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span> <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$&quot;RandomNumberGenerator took </span><span class="p">{</span><span class="n">watch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">}</span><span class="s"> ms&quot;</span><span class="p">);</span>
</code></pre></div></div> <p>The results speak for themselves, showing <code class="highlighter-rouge">RandomNumberGenerator</code> trailing <code class="highlighter-rouge">Random</code>.</p> <table> <thead> <tr> <th>Random</th> <th>RandomNumberGenerator</th> </tr> </thead> <tbody> <tr> <td>0.4052 ms</td> <td>90.7277 ms</td> </tr> </tbody>
</table> <p>The performance issue may not be a deal-breaker for you, and you should evaluate the cost of using <code class="highlighter-rouge">RandomNumberGenerator</code> based on your specific needs.</p> <h2 id="what-about-uniformity">What About Uniformity</h2> <p>Well, this is where things get interesting. I hypothesized that a cryptographic implementation would produce more uniform values over time. Given a range of possible values, they would all have an equal probability if being generated.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">GenerateComparisonDistributions</span><span class="p">()</span>
<span class="p">{</span> <span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span> <span class="k">using</span> <span class="nn">var</span> <span class="n">crypto</span> <span class="p">=</span> <span class="n">RandomNumberGenerator</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span> <span class="kt">var</span> <span class="n">min</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="kt">var</span> <span class="n">max</span> <span class="p">=</span> <span class="m">10000</span><span class="p">;</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">&quot;random_distribution.csv&quot;</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="p">{</span> <span class="n">File</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span> <span class="p">}</span> <span class="k">using</span> <span class="nn">var</span> <span class="n">file</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenWrite</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span> <span class="kt">var</span> <span class="n">encoding</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UTF8Encoding</span><span class="p">(</span><span class="k">true</span><span class="p">);</span> <span class="n">file</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">encoding</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">&quot;random,cryptography\n&quot;</span><span class="p">));</span> <span class="k">for</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span><span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span> <span class="kt">var</span> <span class="n">row</span> <span class="p">=</span> <span class="n">encoding</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$&quot;</span><span class="p">{</span><span class="n">random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">)}</span><span class="s">,</span><span class="p">{</span><span class="n">crypto</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">)}</span><span class="s">\n&quot;</span><span class="p">);</span> <span class="n">file</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">row</span><span class="p">);</span> <span class="p">}</span> <span class="n">file</span><span class="p">.</span><span class="nf">Flush</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>The experiment I ran generated 10,000 random values between 1 and 10,000. If the series averages 5,000, then we know we have a uniform distribution. So what was the outcome?</p> <table> <thead> <tr> <th>Random</th> <th>RandomNumberGenerator</th> </tr> </thead> <tbody> <tr> <td>4994.29863</td> <td>4973.205721</td> </tr> </tbody>
</table> <p>Remember, the distribution of both generator values are random, but both averages are converging on 5,000 with an insignificant difference.</p> <blockquote> <p><code class="highlighter-rouge">Random</code> has the exact random uniformity as <code class="highlighter-rouge">RandomNumberGenerator</code>.</p>
</blockquote> <p>If you are not concerned about predictability, you should use <code class="highlighter-rouge">Random</code>. It is significantly more performance, with no compromise in uniformity.</p> <h2 id="conclusion">Conclusion</h2> <p>Randomness in a non-random domain like computer programming is a difficult problem to solve. Luckily, we have the fine folks working on the .NET Framework giving us tools to make it easier.</p> <p><strong>Remember to consider both predictability and uniformity when choosing your random implementation, as it can make a big difference in the areas of security and performance.</strong></p> <p>If you need to generate a cryptographically secure (unpredictable) value, remember that the combination of <code class="highlighter-rouge">RandomNumberGenerator</code> and <code class="highlighter-rouge">BitConverter</code> can go a long way to help you. Ultimately, both <code class="highlighter-rouge">Random</code> and <code class="highlighter-rouge">RandomNumberGenerator</code> will give you the same uniform output.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>