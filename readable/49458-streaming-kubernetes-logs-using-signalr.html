<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Streaming Kubernetes&#x2019; logs using SignalR -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Streaming Kubernetes&#x2019; logs using SignalR</h1>
    <article id="post-156" class="post-preview post-156 post type-post status-publish format-standard hentry category-net-core category-asp-net-core category-blogging category-kubernetes category-signalr tag-net-core tag-asp-net-core tag-kubernetes tag-signalr"> <div class="entry-content"> <p>As I&#x2019;m using a lot Kubernetes to work on my project, I had the need to be able to view the logs produced by the pods.<br>Actually, you can use the Kubernetes Dashboard to view the logs but it means you have to use the proxy to connect using http://127.0.0.1 and that solution was not perfect for me.</p> <p>So I decided to play with the Kubernetes C# SDK and it appears that there is a nice method called ReadNamespacedPodLogAsync:</p> <pre class="brush: csharp; title: ; notranslate">
var stream = await this.kubernetesClient.ReadNamespacedPodLogAsync(pod, ns, follow: true, sinceSeconds: 1500, cancellationToken: cancellationToken);
</pre> <p>Problem: this method actually returns a Stream, meaning you&#x2019;ll get data &#x201C;on the flow&#x201D;. So you can&#x2019;t use it (directly) on a WebAPI controller and you need to find a way to send the chunks as soon as you retrieve them.</p> <p>This is where IAsyncEnumerable (from C# 8) is useful because it was designed for that purpose! So we can easily have a code similar to this one:</p> <pre class="brush: csharp; title: ; notranslate">
public class LogStreamHub : Hub
{   
    private readonly Kubernetes kubernetesClient;

    public LogStreamHub(Kubernetes kubernetesClient)
    {
        this.kubernetesClient = kubernetesClient;
    }

    public async IAsyncEnumerable&lt;string&gt; GetPodLog(string ns, string pod, [EnumeratorCancellation] CancellationToken cancellationToken)
    {
        cancellationToken.ThrowIfCancellationRequested();

        var stream = await this.kubernetesClient.ReadNamespacedPodLogAsync(pod, ns, follow: true, sinceSeconds: 1500, cancellationToken: cancellationToken);

        var buffer = new byte[8192];

        var count = 0;

        do
        {
            count = stream.Read(buffer, 0, buffer.Length);
            if (count != 0)
            {
                var tmpString = Encoding.Default.GetString(buffer, 0, count);

                yield return tmpString
                        .Replace(&quot;\u001b[40m\u001b[37mtrce\u001b[39m\u001b[22m\u001b[49m&quot;, &quot;trce&quot;)
                        .Replace(&quot;\u001b[40m\u001b[37mdbug\u001b[39m\u001b[22m\u001b[49m&quot;, &quot;dbug&quot;)
                        .Replace(&quot;\u001b[40m\u001b[32minfo\u001b[39m\u001b[22m\u001b[49m&quot;, &quot;info&quot;)
                        .Replace(&quot;\u001b[40m\u001b[1m\u001b[33mwarn\u001b[39m\u001b[22m\u001b[49m&quot;, &quot;warn&quot;)
                        .Replace(&quot;\u001b[41m\u001b[30mfail\u001b[39m\u001b[22m\u001b[49m&quot;, &quot;fail&quot;)
                        .Replace(&quot;\u001b[41m\u001b[1m\u001b[37mcrit\u001b[39m\u001b[22m\u001b[49m&quot;, &quot;crit&quot;);
            }
        } while (count &gt; 0);
    }
}
</pre> <p>Note that the Replace stuff is not mandatory but it&#x2019;s useful if you want to display color on your application, as the .NET Core Console does.</p> <p>On the client side, using the SignalR Javascript library, we can connect to the GetPodLog method:</p> <pre class="brush: jscript; title: ; notranslate">
function registerForStreamNotifications() {
    signalRSubscription = signalRConnection.stream(&quot;GetPodLog&quot;, $(&quot;#namespaces&quot;).val(), $(&quot;#pods&quot;).val()).subscribe({
        next: (content) =&gt; {
            var container = $(&apos;&lt;div class=&quot;logs-element&quot;&gt;&lt;/div&gt;&apos;);

            var line = $(&apos;&lt;span class=&quot;log-line&quot;&gt;&apos; + applyHighlights(content) + &apos;&lt;/span&gt;&apos;);
            container.append(line);

            $(&quot;#logs&quot;).append(container);

            // Auto-scroll
            $(&apos;#logs&apos;).scrollTop($(&apos;#logs&apos;)[0].scrollHeight);
        }
    });
}
</pre> <p>Running the above code, you are now able to display your logs, in <strong>real time</strong>, in your application:</p> <figure class="wp-block-image"><img src="/wp-content/uploads/2020/01/image-3-1024x437.png" alt class="wp-image-159" srcset="http://bit.ly/wp-content/uploads/2020/01/image-3-1024x437.png 1024w, http://bit.ly/wp-content/uploads/2020/01/image-3-300x128.png 300w, http://bit.ly/wp-content/uploads/2020/01/image-3-768x328.png 768w, http://bit.ly/wp-content/uploads/2020/01/image-3.png 1395w" sizes="(max-width: 1024px) 100vw, 1024px"></figure> <p>Happy coding ! &#x1F642;</p> <p>PS: For those who are interested, here is the code for the applyHighlights method:</p> <pre class="brush: jscript; title: ; notranslate">
function applyHighlights(text) {
    text = text
        .replace(&quot;trce:&quot;, &apos;&lt;span class=&quot;trce&quot;&gt;$&amp;amp;&lt;/span&gt;:&apos;)
        .replace(&quot;trce:&quot;, &apos;trce&apos;)
        .replace(&quot;dbug:&quot;, &apos;&lt;span class=&quot;dbug&quot;&gt;$&amp;amp;&lt;/span&gt;:&apos;)
        .replace(&quot;dbug:&quot;, &apos;dbug&apos;)
        .replace(&quot;info:&quot;, &apos;&lt;span class=&quot;info&quot;&gt;$&amp;amp;&lt;/span&gt;:&apos;)
        .replace(&quot;info:&quot;, &apos;info&apos;)
        .replace(&quot;warn:&quot;, &apos;&lt;span class=&quot;warn&quot;&gt;$&amp;amp;&lt;/span&gt;:&apos;)
        .replace(&quot;warn:&quot;, &apos;warn&apos;)
        .replace(&quot;fail:&quot;, &apos;&lt;span class=&quot;fail&quot;&gt;$&amp;amp;&lt;/span&gt;:&apos;)
        .replace(&quot;fail:&quot;, &apos;fail&apos;)
        .replace(&quot;crit:&quot;, &apos;&lt;span class=&quot;crit&quot;&gt;$&amp;amp;&lt;/span&gt;:&apos;)
        .replace(&quot;crit:&quot;, &apos;crit&apos;);

    return text;
}
</pre> <p>d</p> </div> <p class="post-info"> <span class="cat-links"><i class="fa fa-folder-open"></i> <a href="http://donotpanic.azurewebsites.net/category/blogging/net-core/">.NET Core</a>, <a href="http://donotpanic.azurewebsites.net/category/blogging/asp-net-core/">ASP.NET Core</a>, <a href="http://donotpanic.azurewebsites.net/category/blogging/">Blogging</a>, <a href="http://donotpanic.azurewebsites.net/category/blogging/kubernetes/">Kubernetes</a>, <a href="http://donotpanic.azurewebsites.net/category/blogging/signalr/">SignalR</a></span><span class="tags-links"><i class="fa fa-tags"></i> <a href="http://donotpanic.azurewebsites.net/tag/net-core/">.net core</a>, <a href="http://donotpanic.azurewebsites.net/tag/asp-net-core/">asp.net core</a>, <a href="http://donotpanic.azurewebsites.net/tag/kubernetes/">kubernetes</a>, <a href="http://donotpanic.azurewebsites.net/tag/signalr/">signalr</a></span> </p>
</article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>