<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Age of JIT Compilation. Part 2. CLR is Watching You -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Age of JIT Compilation. Part 2. CLR is Watching You</h1><div><div class="entry-content"><p>In my <a href="https://codingsight.com/age-of-jit-compilation-part-i-genesis/" target="_blank" rel="noopener noreferrer">previous publication</a>, we have started analyzing JIT compilation. Today we are going to explore method dispatch of interfaces and generics (both for classes and separate methods along with real signatures), as well as how to debug release-mode assemblies with optimization. In addition, we’ll figure out the true purpose of System.__Canon.</p><h3>Environment configuration</h3><p>At first, we need to set up Visual Studio for debugging release-mode assemblies.</p><p>We are going to use VS 2013. Thus, I recommend doing the following:</p><ol><li>enable a compatibility mode to use SOS.dll.<br><b class="spoiler_title">Tools -&gt; Options -&gt; Debugging -&gt; General</b><br><a href="https://codingsight.com/wp-content/uploads/2017/04/2-1.png"><img src="https://codingsight.com/wp-content/uploads/2017/04/2-1.png" alt="" width="758" height="441"></a></li><li>uncheck Suppress JIT optimization on module load and Enable Just My Code.</li><li>Enable Native Debugging<br><div id="crayon-5e4208fca3bab159688763" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">Project Settings -&gt; Debug -&gt; Enable native code debugging</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3bab159688763-1"><span class="crayon-e">Project </span><span class="crayon-v">Settings</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-v">Debug</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-e">Enable </span><span class="crayon-e">native </span><span class="crayon-e">code </span><span class="crayon-v">debugging</span></div></div></td></tr></tbody></table></div></div></li></ol><p>Now, we can move on to our analysis.</p><h2>Interface dispatch stubs (Virtual Stub Dispatch)</h2><p>CLR is constantly monitoring the whole code, especially interfaces. In addition, it has several strategies for updating method’s native code.</p><p>This feature appeared in CLR 2.0 in 2006. Since then it remained the same in many ways with new heuristics addition.</p><p>Consider the following example:</p><div id="crayon-5e4208fca3bbb807323476" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
    static void Main(string[] args)
    {
        ICallable target = new FirstCallableImpl();
        CallInterface(target);

        ICallable target2 = new SecondCallableImpl();
        CallInterface(target2);
    }

    [MethodImpl(MethodImplOptions.NoInlining)]
    private static void CallInterface(ICallable callable)
    {
        for (int i = 0; i &lt; 1000000; i++)
        {
            callable.DoSomething(); // place breakpoint
        }
    }
}

interface ICallable
{
    void DoSomething();
}

class FirstCallableImpl : ICallable
{
    public void DoSomething()
    {

    }
}

class SecondCallableImpl : ICallable
{
    public void DoSomething()
    {

    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3bbb807323476-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bbb807323476-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ICallable </span><span class="crayon-v">target</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">FirstCallableImpl</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bbb807323476-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ICallable </span><span class="crayon-v">target2</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">SecondCallableImpl</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bbb807323476-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">MethodImpl</span><span class="crayon-sy">(</span><span class="crayon-v">MethodImplOptions</span><span class="crayon-sy">.</span><span class="crayon-v">NoInlining</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5e4208fca3bbb807323476-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">CallInterface</span><span class="crayon-sy">(</span><span class="crayon-e">ICallable </span><span class="crayon-v">callable</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bbb807323476-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-v">i</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-v">i</span><span class="crayon-h"></span><span class="crayon-o">&lt;</span><span class="crayon-h"></span><span class="crayon-cn">1000000</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bbb807323476-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">callable</span><span class="crayon-sy">.</span><span class="crayon-e">DoSomething</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-c">// place breakpoint</span></div><div class="crayon-line" id="crayon-5e4208fca3bbb807323476-27"><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-v">FirstCallableImpl</span><span class="crayon-h"></span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-e">ICallable</span></div><div class="crayon-line" id="crayon-5e4208fca3bbb807323476-35"><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-v">SecondCallableImpl</span><span class="crayon-h"></span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-e">ICallable</span></div></div></td></tr></tbody></table></div></div><p>
Run Debug. Then, open the Disassembly window (Debug -&gt; Windows -&gt; Disassembly).</p><p><a href="https://codingsight.com/wp-content/uploads/2017/04/3-1.png"><img src="https://codingsight.com/wp-content/uploads/2017/04/3-1.png" alt="" width="609" height="407"></a></p><p>Take a look at the call <em>dword ptr ds:[00450010h]instruction</em>.</p><p>To find out a value by the 0x00450010 address, open the Memory window (Debug -&gt; Windows-&gt; Memory-&gt; Memory1).</p><p><a href="https://codingsight.com/wp-content/uploads/2017/04/4-1.png"><img src="https://codingsight.com/wp-content/uploads/2017/04/4-1.png" alt="" width="580" height="407"></a></p><p>At this stage, JIT has not created a required call node yet. Thus, the environment interprets a call of the interface method. It means that we can see a linear search of the required method at the runtime.</p><p>However, let’s run this code twice. After that, we will see that the value of the <u>0x0450010</u> address has been changed:</p><p><a href="https://codingsight.com/wp-content/uploads/2017/04/5-1.png"><img src="https://codingsight.com/wp-content/uploads/2017/04/5-1.png" alt="" width="580" height="407"></a></p><p>To check the 00457012 value, load SOS.dll:</p><div id="crayon-5e4208fca3bbe524306103" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">Immediate window -&gt; .load sos

!u 00457012
Unmanaged code
00457012 813908314400     cmp         dword ptr [ecx],443108h
00457018 0F85F32F0000     jne         0045A011
0045701E E9BD901D00       jmp         006300E0</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3bbe524306103-1"><span class="crayon-e">Immediate </span><span class="crayon-v">window</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-sy">.</span><span class="crayon-e">load </span><span class="crayon-v">sos</span></div><div class="crayon-line" id="crayon-5e4208fca3bbe524306103-5"><span class="crayon-cn">00457012</span><span class="crayon-h"></span><span class="crayon-cn">813908314400</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">dword </span><span class="crayon-i">ptr</span><span class="crayon-h"></span><span class="crayon-sy">[</span><span class="crayon-v">ecx</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-cn">443108h</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bbe524306103-6"><span class="crayon-cn">00457018</span><span class="crayon-h"></span><span class="crayon-cn">0F85F32F0000</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-i">jne</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">0045A011</span></div><div class="crayon-line" id="crayon-5e4208fca3bbe524306103-7"><span class="crayon-cn">0045701E</span><span class="crayon-h"></span><span class="crayon-e">E9BD901D00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-i">jmp</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">006300E0</span></div></div></td></tr></tbody></table></div></div><p>
The jmp 006300E0 instruction is a call to the required interface method. You can check it using this code:</p><div id="crayon-5e4208fca3bc1155331678" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">!u 006300E0
Normal JIT generated code
ConsoleApplication1.FirstCallableImpl.DoSomething()
Begin 006300e0, size 1
&gt;&gt;&gt; 006300E0 C3               ret</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc1155331678-2"><span class="crayon-e">Normal </span><span class="crayon-e">JIT </span><span class="crayon-e">generated </span><span class="crayon-e">code</span></div><div class="crayon-line" id="crayon-5e4208fca3bc1155331678-3"><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">FirstCallableImpl</span><span class="crayon-sy">.</span><span class="crayon-e">DoSomething</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td></tr></tbody></table></div></div><p>
Well… Let’s figure out what the cmp dword ptr [ecx],443108h&nbsp;instruction compares.</p><div id="crayon-5e4208fca3bc3212660546" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">!DumpMT 443108
EEClass: 00441378
Module: 00442c5c
Name: ConsoleApplication1.FirstCallableImpl
mdToken: 02000004  (C:\*path to project*\InterfaceStubsTest.exe)
BaseSize: 0xc
ComponentSize: 0x0
Number of IFaces in IFaceMap: 1
Slots in VTable: 6</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc3212660546-4"><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-e">FirstCallableImpl</span></div><div class="crayon-line" id="crayon-5e4208fca3bc3212660546-5"><span class="crayon-v">mdToken</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-cn">02000004</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">(</span><span class="crayon-v">C</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-o">*</span><span class="crayon-e">path </span><span class="crayon-e">to </span><span class="crayon-v">project</span><span class="crayon-o">*</span><span class="crayon-sy">\</span><span class="crayon-v">InterfaceStubsTest</span><span class="crayon-sy">.</span><span class="crayon-v">exe</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc3212660546-8"><span class="crayon-e">Number </span><span class="crayon-e">of </span><span class="crayon-e">IFaces </span><span class="crayon-st">in</span><span class="crayon-h"></span><span class="crayon-v">IFaceMap</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-cn">1</span></div></div></td></tr></tbody></table></div></div><p>
Compare <strong>this </strong>to the <em>FirstCallableImpl </em>type (i.e. MethodTable). If it is <strong>true, </strong>call the <em>FirstCallableImpl.DoSomething</em>() method.</p><p>The jne 0045A011 instruction is fallback&nbsp;to a linear search (as it has been before caching).</p><p>When it comes to calling the next type – SecondCallableImpl, it will still be checked in the call-site exactly FirstCallableImpl, rather than SecondCallableImpl.</p><p>Still, it is not effective! Thus, after several iterations of code invocations, the environment will exchange the node with cache for a linear search.</p><p>Thus, caching is quite effective when we call methods of collections, for example.</p><h2>Generic type stubs</h2><p>The release of CLR 2.0 along with generics led to important changes in the runtime environment. Before we needed only the <strong>EEClass </strong>structure to describe a particular type. Now, we need binding <strong>EEClass+MethodTable.</strong></p><p>Moreover, List&lt;string&gt; and List&lt;int&gt; will have different EEClass.</p><p>Consider an example:</p><div id="crayon-5e4208fca3bc5755033492" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
    static void Main(string[] args)
    {
        var refTypeHolder = new HolderOf&lt;object&gt;(null);
        var intTypeHolder = new HolderOf&lt;int&gt;(0);

        // call JIT
        refTypeHolder.GetPointer();
        intTypeHolder.GetPointer();

        Console.Read(); // place breakpoint
    }
}

class HolderOf&lt;T&gt;
{
    private readonly T _pointer;

    public HolderOf(T pointer)
    {
        _pointer = pointer;
    }

    public T GetPointer()
    {
        return _pointer;
    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3bc5755033492-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bc5755033492-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">refTypeHolder</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-v">HolderOf</span><span class="crayon-o">&lt;</span><span class="crayon-t">object</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-t">null</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc5755033492-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">intTypeHolder</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-v">HolderOf</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e4208fca3bc5755033492-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">refTypeHolder</span><span class="crayon-sy">.</span><span class="crayon-e">GetPointer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc5755033492-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">intTypeHolder</span><span class="crayon-sy">.</span><span class="crayon-e">GetPointer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc5755033492-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">Read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-c">// place breakpoint</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc5755033492-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-m">readonly</span><span class="crayon-h"></span><span class="crayon-i">T</span><span class="crayon-h"></span><span class="crayon-v">_pointer</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><p>
To check it, we will use the !dumpheap command:</p><div id="crayon-5e4208fca3bc7299523256" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">.load sos.dll

!dumpheap -type HolderOf
PDB symbol for mscorwks.dll not loaded
 Address       MT     Size
02d332c8 00f531e0       12     
02d332d4 00f53268       12     
total 2 objects
Statistics:
      MT    Count    TotalSize Class Name
00f53268        1           12 ConsoleApplication1.HolderOf`1[[System.Int32, mscorlib]]
00f531e0        1           12 ConsoleApplication1.HolderOf`1[[System.Object, mscorlib]]
Total 2 objects</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc7299523256-4"><span class="crayon-e">PDB </span><span class="crayon-e">symbol </span><span class="crayon-st">for</span><span class="crayon-h"></span><span class="crayon-v">mscorwks</span><span class="crayon-sy">.</span><span class="crayon-e">dll </span><span class="crayon-e">not </span><span class="crayon-e">loaded</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc7299523256-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">MT&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">Count&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">TotalSize </span><span class="crayon-t">Class</span><span class="crayon-h"></span><span class="crayon-i">Name</span></div><div class="crayon-line" id="crayon-5e4208fca3bc7299523256-11"><span class="crayon-cn">00f53268</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">12</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Int32</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc7299523256-12"><span class="crayon-cn">00f531e0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">12</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div></div></td></tr></tbody></table></div></div><p>
As you can see, the environment has created two different specializations of the HolderOf&lt;T&gt; class:</p><p>!dumpmt -md 00f53268 (HolderOf&lt;int&gt;)</p><div id="crayon-5e4208fca3bc9907673658" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">)" &gt;!dumpmt -md 00f53268
EEClass: 00f514cc
Module: 00f52c5c
Name: ConsoleApplication1.HolderOf`1[[System.Int32, mscorlib]]
mdToken: 02000006  (C:\*path to samples*\InterfaceStubsTest.exe)
BaseSize: 0xc
ComponentSize: 0x0
Number of IFaces in IFaceMap: 0
Slots in VTable: 6
--------------------------------------
MethodDesc Table
   Entry MethodDesc      JIT Name
66ae6a30   66964968   PreJIT System.Object.ToString()
66ae6a50   66964970   PreJIT System.Object.Equals(System.Object)
66ae6ac0   669649a0   PreJIT System.Object.GetHashCode()
66b57940   669649c4   PreJIT System.Object.Finalize()
00f5c088   00f53250      JIT ConsoleApplication1.HolderOf`1[[System.Int32, mscorlib]]..ctor(Int32)
00f5c090   00f5325c     NONE ConsoleApplication1.HolderOf`1[[System.Int32, mscorlib]].GetPointer()</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc9907673658-4"><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Int32</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5e4208fca3bc9907673658-5"><span class="crayon-v">mdToken</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-cn">02000006</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">(</span><span class="crayon-v">C</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-o">*</span><span class="crayon-e">path </span><span class="crayon-e">to </span><span class="crayon-v">samples</span><span class="crayon-o">*</span><span class="crayon-sy">\</span><span class="crayon-v">InterfaceStubsTest</span><span class="crayon-sy">.</span><span class="crayon-v">exe</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc9907673658-8"><span class="crayon-e">Number </span><span class="crayon-e">of </span><span class="crayon-e">IFaces </span><span class="crayon-st">in</span><span class="crayon-h"></span><span class="crayon-v">IFaceMap</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc9907673658-10"><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc9907673658-12"><span class="crayon-e">&nbsp;&nbsp; </span><span class="crayon-e">Entry </span><span class="crayon-e">MethodDesc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">JIT </span><span class="crayon-i">Name</span></div><div class="crayon-line" id="crayon-5e4208fca3bc9907673658-13"><span class="crayon-cn">66ae6a30</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">66964968</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc9907673658-14"><span class="crayon-cn">66ae6a50</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">66964970</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Equals</span><span class="crayon-sy">(</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bc9907673658-15"><span class="crayon-cn">66ae6ac0</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">669649a0</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">GetHashCode</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc9907673658-16"><span class="crayon-cn">66b57940</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">669649c4</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Finalize</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bc9907673658-17"><span class="crayon-cn">00f5c088</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">00f53250</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">JIT </span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Int32</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-e">ctor</span><span class="crayon-sy">(</span><span class="crayon-v">Int32</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bc9907673658-18"><span class="crayon-cn">00f5c090</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">00f5325c</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">NONE </span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Int32</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">GetPointer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td></tr></tbody></table></div></div><p>
!dumpmt -md 00f531e0 (HolderOf&lt;object&gt;)</p><div id="crayon-5e4208fca3bcb500693867" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">!dumpmt -md 00f531e0
EEClass: 00f51438
Module: 00f52c5c
Name: ConsoleApplication1.HolderOf`1[[System.Object, mscorlib]]
mdToken: 02000006  (C:\*path to samples*\InterfaceStubsTest.exe)
BaseSize: 0xc
ComponentSize: 0x0
Number of IFaces in IFaceMap: 0
Slots in VTable: 6
--------------------------------------
MethodDesc Table
   Entry MethodDesc      JIT Name
66ae6a30   66964968   PreJIT System.Object.ToString()
66ae6a50   66964970   PreJIT System.Object.Equals(System.Object)
66ae6ac0   669649a0   PreJIT System.Object.GetHashCode()
66b57940   669649c4   PreJIT System.Object.Finalize()
00f5c068   00f53154      JIT ConsoleApplication1.HolderOf`1[[System.__Canon, mscorlib]]..ctor(System.__Canon)
00f5c070   00f53160     NONE ConsoleApplication1.HolderOf`1[[System.__Canon, mscorlib]].GetPointer()</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcb500693867-4"><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5e4208fca3bcb500693867-5"><span class="crayon-v">mdToken</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-cn">02000006</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">(</span><span class="crayon-v">C</span><span class="crayon-o">:</span><span class="crayon-sy">\</span><span class="crayon-o">*</span><span class="crayon-e">path </span><span class="crayon-e">to </span><span class="crayon-v">samples</span><span class="crayon-o">*</span><span class="crayon-sy">\</span><span class="crayon-v">InterfaceStubsTest</span><span class="crayon-sy">.</span><span class="crayon-v">exe</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcb500693867-8"><span class="crayon-e">Number </span><span class="crayon-e">of </span><span class="crayon-e">IFaces </span><span class="crayon-st">in</span><span class="crayon-h"></span><span class="crayon-v">IFaceMap</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcb500693867-10"><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span><span class="crayon-o">--</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcb500693867-12"><span class="crayon-e">&nbsp;&nbsp; </span><span class="crayon-e">Entry </span><span class="crayon-e">MethodDesc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">JIT </span><span class="crayon-i">Name</span></div><div class="crayon-line" id="crayon-5e4208fca3bcb500693867-13"><span class="crayon-cn">66ae6a30</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">66964968</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcb500693867-14"><span class="crayon-cn">66ae6a50</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">66964970</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Equals</span><span class="crayon-sy">(</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bcb500693867-15"><span class="crayon-cn">66ae6ac0</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">669649a0</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">GetHashCode</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcb500693867-16"><span class="crayon-cn">66b57940</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">669649c4</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PreJIT </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">.</span><span class="crayon-e">Finalize</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bcb500693867-17"><span class="crayon-cn">00f5c068</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">00f53154</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">JIT </span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">__Canon</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-e">ctor</span><span class="crayon-sy">(</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">__Canon</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcb500693867-18"><span class="crayon-cn">00f5c070</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">00f53160</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">NONE </span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">__Canon</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">GetPointer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td></tr></tbody></table></div></div><p>
In the above-mentioned dump, we are interested in <strong>HolderOf&lt;T&gt;.GetPointer(). </strong>Consider:</p><p>!dumpmd 00f5325c (HolderOf&lt;int&gt;.GetPointer())</p><div id="crayon-5e4208fca3bcd247965717" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">!dumpmd 00f5325c
Method Name: ConsoleApplication1.HolderOf`1[[System.Int32, mscorlib]].GetPointer()
Class: 00f514cc
MethodTable: 00f53268
mdToken: 0600000b
Module: 00f52c5c
IsJitted: yes
CodeAddr: 01090318</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcd247965717-2"><span class="crayon-e">Method </span><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Int32</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">GetPointer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td></tr></tbody></table></div></div><p>
!dumpmd 00f53160 (HolderOf&lt;object&gt;.GetPointer())</p><div id="crayon-5e4208fca3bcf834903773" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">!dumpmd 00f53160
Method Name: ConsoleApplication1.HolderOf`1[[System.__Canon, mscorlib]].GetPointer()
Class: 00f51438
MethodTable: 00f53178
mdToken: 0600000b
Module: 00f52c5c
IsJitted: yes
CodeAddr: 010902b8</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bcf834903773-2"><span class="crayon-e">Method </span><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">`</span><span class="crayon-cn">1</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">__Canon</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">GetPointer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td></tr></tbody></table></div></div><p><a href="https://codingsight.com/wp-content/uploads/2017/04/7-1.png"><img class="alignleft size-full wp-image-1333" src="https://codingsight.com/wp-content/uploads/2017/04/7-1.png" alt="" width="777" height="107" srcset="https://codingsight.com/wp-content/uploads/2017/04/7-1.png 777w, https://codingsight.com/wp-content/uploads/2017/04/7-1-300x41.png 300w, https://codingsight.com/wp-content/uploads/2017/04/7-1-768x106.png 768w" sizes="(max-width: 777px) 100vw, 777px"></a></p><p>Thus, we can see that both Methodtable and a native code (CodeAddr) differ.</p><p>Please notice that there is no <strong>System.Object </strong>for Holderof&lt;object&gt;. Instead, we have <strong>System.__Canon</strong></p><div id="crayon-5e4208fca3bd1322329995" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">[Serializable()]
[ClassInterface(ClassInterfaceType.AutoDual)]
[ComVisible(true)]
internal class __Canon
{
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bd1322329995-2"><span class="crayon-sy">[</span><span class="crayon-e">ClassInterface</span><span class="crayon-sy">(</span><span class="crayon-v">ClassInterfaceType</span><span class="crayon-sy">.</span><span class="crayon-v">AutoDual</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div></div></td></tr></tbody></table></div></div><p>
In short, it is usually considered that for reference types, the environment uses the System.__Canon type code sharing. But that’s not the point. Really.</p><p>The fact is that generic types may contain circular dependencies to other types which may lead to creating unlimited specializations of the code. For example:</p><div id="crayon-5e4208fca3bde241546513" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class GenericClassOne&lt;T&gt;
{
    private T field;
}

class GenericClassTwo&lt;U&gt;
{
    private GenericClassThree&lt;GenericClassOne&lt;U&gt;&gt; field
}

class GenericClassThree&lt;S&gt;
{
    private GenericClassTwo&lt;GenericClassOne&lt;S&gt;&gt; field
}
class Program
{
    static void Main(string[] args)
    {
        Console.WriteLine((new GenericClassTwo&lt;object&gt;()).ToString());
        Console.Read();
    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bde241546513-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-v">GenericClassThree</span><span class="crayon-o">&lt;</span><span class="crayon-v">GenericClassOne</span><span class="crayon-o">&lt;</span><span class="crayon-v">U</span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"></span><span class="crayon-i">field</span></div><div class="crayon-line" id="crayon-5e4208fca3bde241546513-11"><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-e">GenericClassThree</span><span class="crayon-o">&lt;</span><span class="crayon-e">S</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-5e4208fca3bde241546513-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-v">GenericClassTwo</span><span class="crayon-o">&lt;</span><span class="crayon-v">GenericClassOne</span><span class="crayon-o">&lt;</span><span class="crayon-v">S</span><span class="crayon-o">&gt;&gt;</span><span class="crayon-h"></span><span class="crayon-i">field</span></div><div class="crayon-line" id="crayon-5e4208fca3bde241546513-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3bde241546513-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-v">GenericClassTwo</span><span class="crayon-o">&lt;</span><span class="crayon-t">object</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><p>
However, this code won’t fail, but rather output <strong>GenericClassTwo`1[System.Object]</strong>.</p><p>So, what about dependencies?</p><p><strong>Type loader </strong>scans each generic type to find circular dependencies and assigns the order of priority – LoadLevel for a class. Though System.__Canon serves as a type argument for all specializations for reference types, it is a consequence, rather than a cause.</p><p>ClassLoadLevels:</p><div id="crayon-5e4208fca3be2227170818" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">enum ClassLoadLevel
{
    CLASS_LOAD_BEGIN,
    CLASS_LOAD_UNRESTOREDTYPEKEY,
    CLASS_LOAD_UNRESTORED,  
    CLASS_LOAD_APPROXPARENTS,
    CLASS_LOAD_EXACTPARENTS,
    CLASS_DEPENDENCIES_LOADED,
    CLASS_LOADED,
    CLASS_LOAD_LEVEL_FINAL = CLASS_LOADED,
};</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be2227170818-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">CLASS_LOAD_UNRESTOREDTYPEKEY</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be2227170818-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">CLASS_LOAD_APPROXPARENTS</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be2227170818-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">CLASS_DEPENDENCIES_LOADED</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be2227170818-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">CLASS_LOAD_LEVEL_FINAL</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">CLASS_LOADED</span><span class="crayon-sy">,</span></div></div></td></tr></tbody></table></div></div><p>
For SSLCI (Rotor), The code responsible for scanning is in the file sscli20/clr/src/vm/Generics.cpp.</p><div id="crayon-5e4208fca3be4178190977" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">BOOL Generics::CheckInstantiationForRecursion(const unsigned int nGenericClassArgs, const TypeHandle pGenericArgs[])
{
    CONTRACTL
    {
        NOTHROW;
        GC_NOTRIGGER;
    }
    CONTRACTL_END;
    
    if (nGenericClassArgs == 0)
        return TRUE;


    _ASSERTE(pGenericArgs);


    struct PerIterationData {
        const TypeHandle * genArgs;
        int index;
        int numGenArgs;
    };
    
    PerIterationData stack[MAX_GENERIC_INSTANTIATION_DEPTH];
    stack[0].genArgs = pGenericArgs;
    stack[0].numGenArgs = nGenericClassArgs;
    stack[0].index = 0;
    int curDepth = 0;


    // Walk over each instantiation, doing a depth-first search looking for any
    // instantiation with a depth of over 100, in an attempt at flagging 
    // recursive type definitions.  We're doing this to help avoid a stack 
    // overflow in the loader.  
    // Avoid recursion here, to avoid a stack overflow.  Also, this code
    // doesn't allocate memory.
    while(curDepth &gt;= 0) {
        PerIterationData * cur = &amp;stack[curDepth];
        if (cur-&gt;index == cur-&gt;numGenArgs) {
            // Pop
            curDepth--;
            if (curDepth &gt;= 0)
                stack[curDepth].index++;
            continue;
        }
        if (cur-&gt;genArgs[cur-&gt;index].HasInstantiation()) {
            // Push
            curDepth++;
            if (curDepth &gt;= MAX_GENERIC_INSTANTIATION_DEPTH)
                return FALSE;
            stack[curDepth].genArgs = cur-&gt;genArgs[cur-&gt;index].GetInstantiation();
            stack[curDepth].numGenArgs = cur-&gt;genArgs[cur-&gt;index].GetNumGenericArgs();
            stack[curDepth].index = 0;
            continue;
        }
        
        // Continue to the next item
        cur-&gt;index++;
    }
    return TRUE;
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3be4178190977-1"><span class="crayon-t">BOOL</span><span class="crayon-h"></span><span class="crayon-v">Generics</span><span class="crayon-o">::</span><span class="crayon-e">CheckInstantiationForRecursion</span><span class="crayon-sy">(</span><span class="crayon-m">const</span><span class="crayon-h"></span><span class="crayon-e">unsigned </span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-v">nGenericClassArgs</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-m">const</span><span class="crayon-h"></span><span class="crayon-e">TypeHandle </span><span class="crayon-v">pGenericArgs</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">PerIterationData </span><span class="crayon-v">stack</span><span class="crayon-sy">[</span><span class="crayon-v">MAX_GENERIC_INSTANTIATION_DEPTH</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">stack</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">genArgs</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">pGenericArgs</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">stack</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">numGenArgs</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">nGenericClassArgs</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Walk over each instantiation, doing a depth-first search looking for any</span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// instantiation with a depth of over 100, in an attempt at flagging </span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// recursive type definitions.&nbsp;&nbsp;We're doing this to help avoid a stack </span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// overflow in the loader.&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Avoid recursion here, to avoid a stack overflow.&nbsp;&nbsp;Also, this code</span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// doesn't allocate memory.</span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">PerIterationData</span><span class="crayon-h"></span><span class="crayon-o">*</span><span class="crayon-h"></span><span class="crayon-v">cur</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-o">&amp;</span><span class="crayon-v">stack</span><span class="crayon-sy">[</span><span class="crayon-v">curDepth</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">index</span><span class="crayon-h"></span><span class="crayon-o">==</span><span class="crayon-h"></span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">numGenArgs</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">genArgs</span><span class="crayon-sy">[</span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">index</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">HasInstantiation</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">curDepth</span><span class="crayon-h"></span><span class="crayon-o">&gt;=</span><span class="crayon-h"></span><span class="crayon-v">MAX_GENERIC_INSTANTIATION_DEPTH</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">stack</span><span class="crayon-sy">[</span><span class="crayon-v">curDepth</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">genArgs</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">genArgs</span><span class="crayon-sy">[</span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">index</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">GetInstantiation</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e4208fca3be4178190977-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">stack</span><span class="crayon-sy">[</span><span class="crayon-v">curDepth</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">numGenArgs</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">genArgs</span><span class="crayon-sy">[</span><span class="crayon-v">cur</span><span class="crayon-o">-&gt;</span><span class="crayon-v">index</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">GetNumGenericArgs</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be4178190977-56"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Continue to the next item</span></div></div></td></tr></tbody></table></div></div><p>
For CoreCLR, a <a href="https://github.com/dotnet/coreclr/blob/master/src/vm/generics.cpp" target="_blank" rel="noopener noreferrer nofollow">code</a> has been changed towards ООP.</p><p>Thus, reference types have code sharing, while value types don’t. Why? After all, if it comes down to the size of the type (ref is the word size, In32 is 4 bytes, double is 8 bytes, etc.), then we can share DateTime’ and long’ specialization.</p><p>First, it is incorrect from the point of semantics. Second, the developers of CLR decided not to do this.</p><h2>Generic method stubs</h2><p>We have analyzed the code specialization for generic types. But how to find single methods outside the class.</p><p>Consider an example:</p><div id="crayon-5e4208fca3be6775887505" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
    static void Main(string[] args)
    {
        var refTypeHolder = new HolderOf();
        
        Test(refTypeHolder);
        Test2(refTypeHolder);
        Console.Read();
    }

    [MethodImpl(MethodImplOptions.NoInlining)]
    static void Test(HolderOf typeHolder)
    {
        for (int i = 0; i &lt; 10; i++)
        {
            typeHolder.GetPointer&lt;Program&gt;();
        }
    } // place breakpoint

    [MethodImpl(MethodImplOptions.NoInlining)]
    static void Test2(HolderOf typeHolder)
    {
        for (int i = 0; i &lt; 10; i++)
        {
            typeHolder.GetPointer&lt;object&gt;();
        }
    } // place breakpoint
}

class HolderOf
{
    [MethodImpl(MethodImplOptions.NoInlining)]
    public void GetPointer&lt;T&gt;()
    {
        Console.WriteLine(typeof(T));
    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3be6775887505-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3be6775887505-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">refTypeHolder</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">HolderOf</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be6775887505-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">MethodImpl</span><span class="crayon-sy">(</span><span class="crayon-v">MethodImplOptions</span><span class="crayon-sy">.</span><span class="crayon-v">NoInlining</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5e4208fca3be6775887505-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Test</span><span class="crayon-sy">(</span><span class="crayon-e">HolderOf </span><span class="crayon-v">typeHolder</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208fca3be6775887505-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">typeHolder</span><span class="crayon-sy">.</span><span class="crayon-v">GetPointer</span><span class="crayon-o">&lt;</span><span class="crayon-v">Program</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e4208fca3be6775887505-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">MethodImpl</span><span class="crayon-sy">(</span><span class="crayon-v">MethodImplOptions</span><span class="crayon-sy">.</span><span class="crayon-v">NoInlining</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be6775887505-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Test2</span><span class="crayon-sy">(</span><span class="crayon-e">HolderOf </span><span class="crayon-v">typeHolder</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be6775887505-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">typeHolder</span><span class="crayon-sy">.</span><span class="crayon-v">GetPointer</span><span class="crayon-o">&lt;</span><span class="crayon-t">object</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e4208fca3be6775887505-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">MethodImpl</span><span class="crayon-sy">(</span><span class="crayon-v">MethodImplOptions</span><span class="crayon-sy">.</span><span class="crayon-v">NoInlining</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be6775887505-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-v">GetPointer</span><span class="crayon-o">&lt;</span><span class="crayon-v">T</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3be6775887505-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">T</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><p>
At the breakpoint in the Disassembly window, you can see the following assembly code for method Test():</p><div id="crayon-5e4208fca3bed152016066" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">00000045  mov         ecx,dword ptr [ebp-3Ch] 
00000048  mov         edx,10031B8h 
0000004d  cmp         dword ptr [ecx],ecx 
0000004f  call        FFE8BF40</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3bed152016066-1"><span class="crayon-cn">00000045</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">ecx</span><span class="crayon-sy">,</span><span class="crayon-e">dword </span><span class="crayon-i">ptr</span><span class="crayon-h"></span><span class="crayon-sy">[</span><span class="crayon-v">ebp</span><span class="crayon-o">-</span><span class="crayon-cn">3Ch</span><span class="crayon-sy">]</span><span class="crayon-h"></span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bed152016066-2"><span class="crayon-cn">00000048</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">edx</span><span class="crayon-sy">,</span><span class="crayon-cn">10031B8h</span><span class="crayon-h"></span></div><div class="crayon-line" id="crayon-5e4208fca3bed152016066-3"><span class="crayon-cn">0000004d</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">dword </span><span class="crayon-i">ptr</span><span class="crayon-h"></span><span class="crayon-sy">[</span><span class="crayon-v">ecx</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-i">ecx</span><span class="crayon-h"></span></div></div></td></tr></tbody></table></div></div><p>
As for Test2(), consider the following:</p><div id="crayon-5e4208fca3bf0721433389" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">00000045  mov         ecx,dword ptr [ebp-3Ch] 
00000048  mov         edx,1003574h 
0000004d  cmp         dword ptr [ecx],ecx 
0000004f  call        FFE8BE40</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208fca3bf0721433389-1"><span class="crayon-cn">00000045</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">ecx</span><span class="crayon-sy">,</span><span class="crayon-e">dword </span><span class="crayon-i">ptr</span><span class="crayon-h"></span><span class="crayon-sy">[</span><span class="crayon-v">ebp</span><span class="crayon-o">-</span><span class="crayon-cn">3Ch</span><span class="crayon-sy">]</span><span class="crayon-h"></span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bf0721433389-2"><span class="crayon-cn">00000048</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">edx</span><span class="crayon-sy">,</span><span class="crayon-cn">1003574h</span><span class="crayon-h"></span></div><div class="crayon-line" id="crayon-5e4208fca3bf0721433389-3"><span class="crayon-cn">0000004d</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">dword </span><span class="crayon-i">ptr</span><span class="crayon-h"></span><span class="crayon-sy">[</span><span class="crayon-v">ecx</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-i">ecx</span><span class="crayon-h"></span></div></div></td></tr></tbody></table></div></div><p>
The <strong>ECX</strong>&nbsp;register contains a pointer to <strong>this </strong>(calling convention — FastCall). However, GetPointer() has no arguments. In this case, what is written into <strong>EDX</strong>?</p><p>Let’s check:</p><p>!dumpmd 10031B8 (from Test())</p><div id="crayon-5e4208fca3bf2939763875" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">!dumpmd 10031B8
Method Name: ConsoleApplication1.HolderOf.GetPointer[[ConsoleApplication1.Program, InterfaceStubsTest]]()
Class: 01001444
MethodTable: 01003118
mdToken: 0600000e
Module: 01002c5c
IsJitted: no
CodeAddr: ffffffffffffffff</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bf2939763875-2"><span class="crayon-e">Method </span><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">.</span><span class="crayon-v">GetPointer</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">Program</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">InterfaceStubsTest</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bf2939763875-8"><span class="crayon-v">CodeAddr</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ffffffffffffffff</span></div></div></td></tr></tbody></table></div></div><p>
!dumpmd 1003574 (from Test2())</p><div id="crayon-5e4208fca3bf8262104048" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">!dumpmd 1003574
Method Name: ConsoleApplication1.HolderOf.GetPointer[[System.Object, mscorlib]]()
Class: 01001444
MethodTable: 01003118
mdToken: 0600000e
Module: 01002c5c
IsJitted: no
CodeAddr: ffffffffffffffff</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bf8262104048-2"><span class="crayon-e">Method </span><span class="crayon-v">Name</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ConsoleApplication1</span><span class="crayon-sy">.</span><span class="crayon-v">HolderOf</span><span class="crayon-sy">.</span><span class="crayon-v">GetPointer</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">mscorlib</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208fca3bf8262104048-8"><span class="crayon-v">CodeAddr</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-v">ffffffffffffffff</span></div></div></td></tr></tbody></table></div></div><p>
Bingo! The&nbsp;<strong>MethodDesc </strong>structure is passed, which contains a pointer to MethodTable (note: both descriptors point to the same MethodTable&nbsp;<u>0x01003118</u>) and serves as a metadata source.</p><p>Thus, when calling generic methods, an additional parameter is passed with MethodDesc.</p><p>The addresses <u>FFE8BF40</u> and <u>FFE8BE40</u> themselves are the traps that forward the real specialized (for int, object, etc.) native code.</p><p>Due to fact that the descriptor itself also stores generic parameters, we gained in the reduction of the number of arguments passed, especially in the case of several generic parameters like Some&lt;T, TU, TResult&gt;(), for example.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>