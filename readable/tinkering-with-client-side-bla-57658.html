<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Tinkering with client-side Blazor and the AWS SDK for .NET - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Tinkering with client-side Blazor and the AWS SDK for .NET - linksfor.dev(s)"/>
    <meta property="og:description" content="Being a .NET lover, a cross-platform hopeful and a JavaScript ignorant, I was immediately enthused about client-side Blazor. The promise of statically hosted web applications that run on every plat&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://matteo.tech.blog/2020/02/11/tinkering-with-client-side-blazor-and-the-aws-sdk-for-net/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Tinkering with client-side Blazor and the AWS SDK for .NET</title>
<div class="readable">
        <h1>Tinkering with client-side Blazor and the AWS SDK for .NET</h1>
            <div>Reading time: 16-20 minutes</div>
        <div>Posted here: 12 Feb 2020</div>
        <p><a href="https://matteo.tech.blog/2020/02/11/tinkering-with-client-side-blazor-and-the-aws-sdk-for-net/">https://matteo.tech.blog/2020/02/11/tinkering-with-client-side-blazor-and-the-aws-sdk-for-net/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="content">

	<div id="primary">
		<main id="main" role="main">

		
			
<article id="post-20">
	<!-- .entry-header -->

	<div>
		
<p>Being a .NET lover, a cross-platform hopeful and a JavaScript ignorant, I was immediately enthused about client-side Blazor. The promise of statically hosted web applications that run on every platform is very exciting. Being able to write them in .NET is the dream!</p>



<p>Being an engineer on the <a href="https://github.com/aws/aws-sdk-net">AWS SDK for .NET</a> team, I tasked myself with figuring out how to use our libraries under Blazor in the browser.</p>



<h3>Beware!</h3>



<p>This post is not a design document about how to optimize the experience of .NET users, nor a guide on software development best practices. This is a proof of concept and a chronicle of the, sometimes tortuous, route I took to get Blazor and AWS to get along.</p>



<p>Because client-side Blazor is in a pre-release stage and the AWS SDK for .NET hasn’t been updated yet to easily support Blazor development, the steps described in this post are likely to become outdated in the next few months.</p>



<h2>Defining the goal</h2>



<p>A good starting point to demonstrate the viability of using the AWS SDK for .NET on WebAssembly is to reproduce the <a href="https://aws.amazon.com/developers/getting-started/browser/">very first walkthrough</a> AWS proposes to JavaScript developers who are learning to write an in-browser application.</p>



<p>The project covers:</p>



<ul><li>web identity federation with Facebook</li><li>hosting the website in an S3 bucket</li><li>handling credentials and privileges with IAM</li><li>using S3 APIs for reading and writing objects from JavaScript</li></ul>



<p>I followed the whole guide, built and tested the JavaScript website. The plan is to later replace the JavaScript-based <em>index.html</em> with an equivalent Blazor website.</p>



<p>Facebook now requires your website to use https so, in order to get the JavaScript project to work, I also had to create a <a href="https://aws.amazon.com/cloudfront/">CloudFront</a> distribution pointing to the S3 bucket and use the distribution’s URI instead of the bucket’s URI when following the guide steps.</p>



<p>All AWS resources (S3 bucket, IAM role and policy, CloudFront distribution…) will be reused without modifications when converting the website to Blazor.</p>



<h2>Spoilers</h2>



<p>This post is about the journey, not the destination. Still, before jumping into this lengthy narration, you may be interested in knowing that we will indeed succeed in converting our JavaScript sample to C# and we will have a functioning (and horribly looking) website.</p>



<div>
<div>
<div><figure><img data-attachment-id="81" data-permalink="https://matteo.tech.blog/image/" data-orig-file="https://matteotechblog.files.wordpress.com/2020/02/image.png" data-orig-size="929,629" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-medium-file="https://matteotechblog.files.wordpress.com/2020/02/image.png?w=300" data-large-file="https://matteotechblog.files.wordpress.com/2020/02/image.png?w=775" src="https://matteotechblog.files.wordpress.com/2020/02/image.png?w=929" alt="" width="465" height="315" srcset="https://matteotechblog.files.wordpress.com/2020/02/image.png?w=465 465w, https://matteotechblog.files.wordpress.com/2020/02/image.png?w=150 150w, https://matteotechblog.files.wordpress.com/2020/02/image.png?w=300 300w, https://matteotechblog.files.wordpress.com/2020/02/image.png?w=768 768w, https://matteotechblog.files.wordpress.com/2020/02/image.png 929w" sizes="(max-width: 465px) 100vw, 465px"><figcaption>Login prompt</figcaption></figure></div>
</div>



<div>
<div><figure><img data-attachment-id="82" data-permalink="https://matteo.tech.blog/image-1/" data-orig-file="https://matteotechblog.files.wordpress.com/2020/02/image-1.png" data-orig-size="929,629" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-1" data-image-description="" data-medium-file="https://matteotechblog.files.wordpress.com/2020/02/image-1.png?w=300" data-large-file="https://matteotechblog.files.wordpress.com/2020/02/image-1.png?w=775" src="https://matteotechblog.files.wordpress.com/2020/02/image-1.png?w=929" alt="" width="465" height="315" srcset="https://matteotechblog.files.wordpress.com/2020/02/image-1.png?w=465 465w, https://matteotechblog.files.wordpress.com/2020/02/image-1.png?w=150 150w, https://matteotechblog.files.wordpress.com/2020/02/image-1.png?w=300 300w, https://matteotechblog.files.wordpress.com/2020/02/image-1.png?w=768 768w, https://matteotechblog.files.wordpress.com/2020/02/image-1.png 929w" sizes="(max-width: 465px) 100vw, 465px"><figcaption>File list</figcaption></figure></div>




</div>
</div>



<h2>Setting up Blazor</h2>



<p>I set up Blazor following the steps listed <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/get-started">here</a> for the Blazor WebAssembly template. Then I created a sample Blazor project using the command line:</p>



<pre><code>dotnet new blazorwasm</code></pre>



<p>I didn’t use the <em>–hosted</em> option because I want a simple client-only Blazor application.</p>



<p>Now that I have a working Blazor app, it is simple enough to hollow it out so that it is ready to host my code. Because this is a sample application with a single page, we will do most of the work in <em>Index.razor</em> (actual page), <em>index.html</em> (scripts) and <em>Startup.cs</em> (dependency injection).</p>



<h2>Referencing the SDK</h2>



<p>As part of this exercise, I used <a href="https://www.nuget.org/packages/AWSSDK.SecurityToken/">Security Token Service</a> (to convert the Facebook identity into AWS credentials) and <a href="https://www.nuget.org/packages/AWSSDK.S3/">S3</a>. I added references to the corresponding NuGet packages to the project file.</p>


<div><div id="highlighter_663579"><div><div><p><code>&lt;</code><code>ItemGroup</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"AWSSDK.Core"</code> <code>Version</code><code>=</code><code>"3.3.104.22"</code> <code>/&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"AWSSDK.S3"</code> <code>Version</code><code>=</code><code>"3.3.110.20"</code> <code>/&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"AWSSDK.SecurityToken"</code> <code>Version</code><code>=</code><code>"3.3.104.27"</code> <code>/&gt;</code></p><p><code>&lt;/</code><code>ItemGroup</code><code>&gt;</code></p></div></div></div></div>


<p>I would normally also reference <a href="https://www.nuget.org/packages/AWSSDK.Extensions.NETCore.Setup/">AWSSDK.Extensions.NETCore.Setup</a> to simplify dependency injection, but Blazor requires some exotic configuration, so I had to take care of dependency injection myself.</p>



<h2>First roadblock – HttpClient injection</h2>



<p>The default behavior of the AWS SDK for .NET, when performing service calls, is to create instances of <em>HttpClient </em>and configure them. This is not compatible with the networking restrictions imposed by the browser.</p>



<p>Fortunately we can configure the AWS service clients with a custom <a href="https://github.com/aws/aws-sdk-net/blob/af0911060e045977b042bfbc478ab05886aaf1cd/sdk/src/Core/Amazon.Runtime/Pipeline/HttpHandler/_mobile/HttpRequestMessageFactory.cs#L52"><em>HttpClientFactory</em></a> that simply instructs the client to use Blazor’s injected <em>HttpClient</em>.</p>


<div><div id="highlighter_888058"><div><div><p><code>class</code> <code>HttpInjectorFactory : HttpClientFactory</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>HttpClient InjectedClient;</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>HttpInjectorFactory(HttpClient injectedClient)</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>InjectedClient = injectedClient;</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>override</code> <code>HttpClient CreateHttpClient(IClientConfig clientConfig)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>=&gt; InjectedClient;</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>override</code> <code>bool</code> <code>DisposeHttpClientsAfterUse(IClientConfig clientConfig)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>=&gt; </code><code>false</code><code>;</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>override</code> <code>bool</code> <code>UseSDKHttpClientCaching(IClientConfig clientConfig)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>=&gt; </code><code>false</code><code>;</code></p><p><code>}</code></p></div></div></div></div>


<h2>Second roadblock – User-Agent header</h2>



<p>The AWS SDK for .NET sets the <em>User-Agent</em> header of every http request to a specific string. Before the request is sent to the service, the header is used as one of the inputs used in <a href="https://docs.aws.amazon.com/general/latest/gr/signing_aws_api_requests.html">calculating the message signature</a>.</p>



<p>This is a problem because the browser overwrites the <em>User-Agent</em> header, resulting in an invalid signature that will cause the request to be rejected by the service.</p>



<p>This will likely require a code change in the AWS SDK for .NET in order to allow a different behavior when running inside the browser! But I didn’t want to change the code of the SDK yet, so I decided to work around the issue instead.</p>



<h3>Kids, don’t try this at home!</h3>



<p>Service clients in the AWS SDK for .NET use a “pipeline”: a sequence of “handlers” that, in multiple steps, transform the request object provided by the user into an http message.</p>



<p>We can use the <a href="https://github.com/aws/aws-sdk-net/blob/b691e46e57a3e24477e6a5fa2e849da44db7002f/sdk/src/Core/Amazon.Runtime/Internal/RuntimePipelineCustomizerRegistry.cs#L13"><em>RuntimePipelineCustomizerRegistry</em></a> to inject a new pipeline handler into every service client created in our application. Our pipeline handler swaps the <em>User-Agent</em> header for the <em>x-amz-user-agent</em> header that the browser won’t overwrite. Because headers are used when signing the message, our handler has to be placed before the one that performs the signing.</p>



<figure><blockquote><p>Any new release of the AWS SDK for .NET may change these classes and could break this implementation. Don’t use any of this in production code!</p></blockquote></figure>


<div><div id="highlighter_250891"><div><div><p><code>class</code> <code>UserAgentFixer : PipelineHandler</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>override</code> <code>Task&lt;T&gt; InvokeAsync&lt;T&gt;(IExecutionContext executionContext)</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>FixHeaders(executionContext);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>base</code><code>.InvokeAsync&lt;T&gt;(executionContext);</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>override</code> <code>void</code> <code>InvokeSync(IExecutionContext executionContext)</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>FixHeaders(executionContext);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>base</code><code>.InvokeSync(executionContext);</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>void</code> <code>FixHeaders(IExecutionContext executionContext)</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>headers = executionContext.RequestContext.Request.Headers;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(headers.TryGetValue(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Amazon.Util.HeaderKeys.UserAgentHeader,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>out</code> <code>var</code> <code>value))</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>headers[Amazon.Util.HeaderKeys.XAmzUserAgentHeader] = value;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>headers.Remove(Amazon.Util.HeaderKeys.UserAgentHeader);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p><p><code>class</code> <code>UserAgentFixerCustomizer : IRuntimePipelineCustomizer</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>UniqueName =&gt; </code><code>"UserAgentFixer"</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>void</code> <code>Customize(Type type, RuntimePipeline pipeline)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>pipeline.AddHandlerBefore&lt;Signer&gt;(</code><code>new</code> <code>UserAgentFixer());</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></div></div></div>


<p>All the classes that I have just used are in the <em>Amazon.Runtime.Internal</em> namespace. The AWS SDK for .NET doesn’t guarantee backward compatibility of <em>Internal </em>namespaces. Also the inner workings of the pipeline are not a documented feature. So a new release of the AWS SDK for .NET may change these classes and could break this implementation. Don’t use any of this in production code!</p>



<h2>Web Identity Federation</h2>



<p>Now that the AWS SDK for .NET behaves in a way that is compatible with client-side Blazor, I can start converting the <a href="https://aws.amazon.com/developers/getting-started/browser/">JavaScript application</a> to C#.</p>



<p>The trickiest part is how to handle authentication. I decided to use the Facebook SDK in the same way as the original JavaScript application. But, because I wanted to minimize the amount of JavaScript code I had to write, I invoked it from C# and immediately called back into C# code as soon as the authentication was done. Because this is a proof of concept, I kept it simple and wrote this directly in <em>index.html</em>.</p>


<div><div id="highlighter_702734"><div><div><p><code>&lt;</code><code>script</code> <code>id</code><code>=</code><code>"facebook-jssdk"</code> <code>src</code><code>=</code><code>"//connect.facebook.net/en_US/all.js"</code><code>&gt;</code></p><p><code>&lt;/</code><code>script</code><code>&gt;</code></p><p><code>&lt;</code><code>script</code> <code>type</code><code>=</code><code>"text/javascript"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>window.blazorJsScripts = {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>fbInit: function (appId, dotNetInstance, callbackMethod) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>FB.init({</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>appId: appId</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>FB.login(function (response) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return dotNetInstance.invokeMethodAsync(callbackMethod, response);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&lt;/</code><code>script</code><code>&gt;</code></p></div></div></div></div>


<p>Once we have the web identity token returned by Facebook, we can pass it to STS to get the AWS credentials for an IAM role.</p>



<p>I have decided to put all this logic in a new credential class. <a href="https://github.com/aws/aws-sdk-net/blob/662be216d79d4c34f058d4e1bb1b7891e4d682fc/sdk/src/Core/Amazon.Runtime/Credentials/RefreshingAWSCredentials.cs#L27"><em>RefreshingAWSCredentials</em></a> is an abstract class provided by the AWS SDK for .NET which calls back into our code to get new credentials when the current ones are expired.</p>


<div><div id="highlighter_569747"><div><div><p><code>class</code> <code>RefreshingFacebookCredentials : RefreshingAWSCredentials</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>class</code> <code>JavascriptCompletableTask&lt;T&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>TaskCompletionSource&lt;T&gt; TaskCompletionSource</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>= </code><code>new</code> <code>TaskCompletionSource&lt;T&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[JSInvokable]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>void</code> <code>Complete(T value)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>TaskCompletionSource.SetResult(value);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>Task&lt;T&gt; Task =&gt; TaskCompletionSource.Task;</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>IJSRuntime JSRuntime;</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>HttpClientFactory HttpClientFactory;</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>string</code> <code>AppId;</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>string</code> <code>RoleArn;</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>JsonElement? FacebookToken = </code><code>null</code><code>;</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>RefreshingFacebookCredentials(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>IJSRuntime jsRuntime,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>HttpClientFactory httpClientFactory,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>string</code> <code>appId,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>string</code> <code>roleArn)</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>JSRuntime = jsRuntime;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>HttpClientFactory = httpClientFactory;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>AppId = appId;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>RoleArn = roleArn;</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>public</code> <code>async</code> <code>Task&lt;</code><code>string</code><code>&gt; GetUserIdAsync()</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>facebookResponse = </code><code>await</code> <code>GetFacebookTokenAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>authResponse = facebookResponse.GetProperty(</code><code>"authResponse"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>authResponse.GetProperty(</code><code>"userID"</code><code>).GetString();</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>private</code> <code>async</code> <code>Task&lt;JsonElement&gt; GetFacebookTokenAsync()</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(FacebookToken == </code><code>null</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>javascriptCompletableTask</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>= </code><code>new</code> <code>JavascriptCompletableTask&lt;JsonElement&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await</code> <code>JSRuntime.InvokeVoidAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"blazorJsScripts.fbInit"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>AppId,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>DotNetObjectReference.Create(javascriptCompletableTask),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>nameof(javascriptCompletableTask.Complete));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>FacebookToken = </code><code>await</code> <code>javascriptCompletableTask.Task;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>FacebookToken.Value;</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>protected</code> <code>override</code> <code>async</code> <code>Task&lt;CredentialsRefreshState&gt; GenerateNewCredentialsAsync()</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>facebookResponse = </code><code>await</code> <code>GetFacebookTokenAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>authResponse = facebookResponse.GetProperty(</code><code>"authResponse"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>accessToken = authResponse.GetProperty(</code><code>"accessToken"</code><code>).GetString();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>using</code> <code>(</code><code>var</code> <code>client = </code><code>new</code> <code>AmazonSecurityTokenServiceClient(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>AnonymousAWSCredentials(),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>AmazonSecurityTokenServiceConfig</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>HttpClientFactory = HttpClientFactory</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}))</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>response = </code><code>await</code> <code>client.AssumeRoleWithWebIdentityAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>Amazon.SecurityToken.Model.AssumeRoleWithWebIdentityRequest</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ProviderId = </code><code>"graph.facebook.com"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>RoleArn = RoleArn,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>WebIdentityToken = accessToken,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>RoleSessionName = Guid.NewGuid().ToString()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>new</code> <code>CredentialsRefreshState(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>ImmutableCredentials(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>response.Credentials.AccessKeyId,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>response.Credentials.SecretAccessKey,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>response.Credentials.SessionToken),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>response.Credentials.Expiration);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>protected</code> <code>override</code> <code>CredentialsRefreshState GenerateNewCredentials()</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>throw</code> <code>new</code> <code>NotImplementedException();</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></div></div></div>


<p>I can go back later and improve on this implementation by handling the expiration and refresh of the Facebook token. It would be a simple improvement, but it is outside of the scope of this proof of concept.</p>



<h2>Dependency injection</h2>



<p>With all the pieces ready, setting up the dependency injection in <em>Startup.cs</em> is straightforward.</p>


<div><div id="highlighter_473468"><div><div><p><code>public</code> <code>void</code> <code>ConfigureServices(IServiceCollection services)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>RuntimePipelineCustomizerRegistry.Instance</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.Register(</code><code>new</code> <code>UserAgentFixerCustomizer());</code></p><p><code>&nbsp;&nbsp;</code><code>services.AddSingleton((serviceProvider) =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>RefreshingFacebookCredentials(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>serviceProvider.GetService&lt;IJSRuntime&gt;(),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>HttpInjectorFactory(serviceProvider.GetService&lt;HttpClient&gt;()),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>appId: </code><code>"012345678901"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>roleArn: </code><code>"arn:aws:iam::012345678901:role/TestBlazorS3FacebookApp"</code><code>));</code></p><p><code>&nbsp;&nbsp;</code><code>services.AddSingleton&lt;IAmazonS3&gt;((serviceProvider) =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>AmazonS3Client(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>serviceProvider.GetService&lt;RefreshingFacebookCredentials&gt;(),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>AmazonS3Config</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>RegionEndpoint = RegionEndpoint.USWest2,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>HttpClientFactory</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>= </code><code>new</code> <code>HttpInjectorFactory(serviceProvider.GetService&lt;HttpClient&gt;())</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}));</code></p><p><code>}</code></p></div></div></div></div>


<h2>Let’s write some Blazor</h2>



<p>I then went in the <em>Index.blazor</em> file and used the S3 service client as I would normally do in a .NET Framework or .NET Core application:</p>


<div><div id="highlighter_949002"><div><div><p><code>@page "/"</code></p><p><code>@using Amazon.S3</code></p><p><code>@using Amazon.S3.Model</code></p><p><code>@inject IAmazonS3 S3Client </code></p><p><code>@inject RefreshingFacebookCredentials FacebookCredentials</code></p><p><code>&lt;</code><code>h1</code><code>&gt;S3 Objects&lt;/</code><code>h1</code><code>&gt;</code></p><p><code>@if (Objects == null)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>button</code> <code>class</code><code>=</code><code>"btn btn-primary"</code> <code>@</code><code>onclick</code><code>=</code><code>"OnLoginClickAsync"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Log in with Facebook&lt;/</code><code>button</code><code>&gt;</code></p><p><code>}</code></p><p><code>else</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>table</code> <code>class</code><code>=</code><code>"table"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>thead</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>tr</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>th</code><code>&gt;Key&lt;/</code><code>th</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>th</code><code>&gt;Size&lt;/</code><code>th</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;/</code><code>tr</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;/</code><code>thead</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>tbody</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>@foreach (var s3Object in Objects)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>tr</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>td</code><code>&gt;@s3Object.Key&lt;/</code><code>td</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>td</code><code>&gt;@s3Object.Size&lt;/</code><code>td</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;/</code><code>tr</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;/</code><code>tbody</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;/</code><code>table</code><code>&gt;</code></p><p><code>}</code></p><p><code>@code {</code></p><p><code>&nbsp;&nbsp;</code><code>private string bucketName = "s3-bucket-name";</code></p><p><code>&nbsp;&nbsp;</code><code>private List&lt;</code><code>S3Object</code><code>&gt; Objects;</code></p><p><code>&nbsp;&nbsp;</code><code>public Task OnLoginClickAsync()</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return UpdateObjectListAsync();</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>public async Task UpdateObjectListAsync()</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var userId = await FacebookCredentials.GetUserIdAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var response = await S3Client.ListObjectsV2Async(new ListObjectsV2Request</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>BucketName = bucketName,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Prefix = "facebook-" + userId</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Objects = response.S3Objects;</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></div></div></div>


<h2>Deployment</h2>



<p>I can test my new website with</p>



<pre><code>dotnet run</code></pre>



<p>In case I need to debug, the browser’s development tools allow me to see the JavaScript code and put breakpoints. I can use <em>Console.WriteLine()</em> from C# to write in the browser’s debugging console and unhandled exceptions show up in the console as well.</p>



<p>When we are done, we can easily deploy the website to S3 and replace the JavaScript sample website created before. We run</p>



<pre><code>dotnet publish -c Release</code></pre>



<p>and copy the content of the <em>/bin/Release/netstandard2.1/publish/ProjectName/dist</em> into the S3 bucket.</p>



<h2>Finishing it up</h2>



<p>If we want to achieve parity with the JavaScript sample, we have to add the ability to upload files to S3.</p>



<p>To make my file easier and avoid more JavaScript interop, I decided to use the <a href="https://www.nuget.org/packages/Tewr.Blazor.FileReader/">Tewr.Blazor.FileReader</a> package.</p>


<div><div id="highlighter_116403"><div><div><p><code>public</code> <code>void</code> <code>ConfigureServices(IServiceCollection services)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>services.AddFileReaderService(options =&gt; options.UseWasmSharedBuffer = </code><code>true</code><code>);</code></p><p><code>&nbsp;&nbsp;</code><code>...</code></p></div></div></div></div>


<p>I then edited Index.razor adding the following code in the headers, html and code sections.</p>


<div><div id="highlighter_664865"><div><div><p><code>@using System.IO</code></p><p><code>@using Blazor.FileReader</code></p><p><code>@inject IFileReaderService FileReaderService</code></p><p><code>...</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>input</code> <code>type</code><code>=</code><code>"file"</code> <code>id</code><code>=</code><code>"file-chooser"</code> <code>@</code><code>ref</code><code>=</code><code>"FileChooserReference"</code> <code>/&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>button</code> <code>class</code><code>=</code><code>"btn btn-primary"</code> <code>@</code><code>onclick</code><code>=</code><code>"OnUploadClickAsync"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Upload to S3&lt;/</code><code>button</code><code>&gt;</code></p><p><code>...</code></p><p><code>&nbsp;&nbsp;</code><code>private ElementReference FileChooserReference;</code></p><p><code>&nbsp;&nbsp;</code><code>public async Task OnUploadClickAsync()</code></p><p><code>&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var userId = await FacebookCredentials.GetUserIdAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var files = await FileReaderService.CreateReference(FileChooserReference)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.EnumerateFilesAsync()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>foreach (var file in files)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var fileInfo = await file.ReadFileInfoAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>//Tewr.Blazor.FileReader's streams are async-only and would not work</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>//with PutObjectAsync, so we have to read the file into a MemoryStream</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>MemoryStream memoryStream;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>using (var fileStream = await file.OpenReadAsync())</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>memoryStream = new MemoryStream();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await fileStream.CopyToAsync(memoryStream);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await S3Client.PutObjectAsync(new PutObjectRequest()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>BucketName = bucketName,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Key = $"facebook-{userId}/{fileInfo.Name}",</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>CannedACL = S3CannedACL.PublicRead,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ContentType = fileInfo.Type,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>InputStream = memoryStream</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await UpdateObjectListAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p></div></div></div></div>


<h2>The devil is in CORS</h2>



<p>Before doing anything more complex, it is worth knowing that not all calls to AWS services are allowed from within a browser. For example, if I had called S3’s <a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListBuckets.html"><em>ListBuckets</em></a>, I would have received the following error:</p>



<pre>Access to fetch at 'https://s3.us-west-2.amazonaws.com/' from origin
'https://localhost:44335' has been blocked by CORS policy: Response to
preflight request doesn't pass access control check: No
'Access-Control-Allow-Origin' header is present on the requested
resource. If an opaque response serves your needs, set the request's
mode to 'no-cors' to fetch the resource with CORS disabled.</pre>



<p>My call was blocked by the CORS policy of S3. CORS is nicely explained <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">here</a>. If you followed along the JavaScript project setup, when we did the S3 configuration, we specified a <em>CORSConfiguration </em>for the bucket that allows the <em>ListObject</em> and <em>PutObject</em> operations to succeed (but not <em>ListBuckets</em>, because it is not a bucket-level operation).</p>



<p>A workaround for this would be to move the unsupported calls to an <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> function and call the function from our Blazor application.</p>



<h2>What now</h2>



<p>For the reader, the next step is to go write some cool application using Blazor and AWS!</p>



<p>For me, to start thinking about which code changes to the AWS SDK for .NET would allow most of the steps in this post to be skipped and the whole configuration to happen magically.</p>
			</div><!-- .entry-content -->

	<!-- .entry-footer -->
</article><!-- #post-## -->

			
			
<!-- #comments -->

		
		</main><!-- #main -->
	</div><!-- #primary -->



	</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>