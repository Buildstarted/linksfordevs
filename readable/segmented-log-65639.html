<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Segmented Log - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Segmented Log - linksfor.dev(s)"/>
    <meta property="og:description" content="Split log into multiple smaller files instead of a single large file for easier operations."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://martinfowler.com/articles/patterns-of-distributed-systems/log-segmentation.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Segmented Log</title>
<div class="readable">
        <h1>Segmented Log</h1>
            <div>Reading time: 4-5 minutes</div>
        <div>Posted here: 14 Aug 2020</div>
        <p><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/log-segmentation.html">https://martinfowler.com/articles/patterns-of-distributed-systems/log-segmentation.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
<div>




<p>Split log into multiple smaller files instead of a single large file for easier operations.</p>

<p>13 August 2020</p>

<section>
<h2>Problem</h2>

<p>A single log file can grow and become a performance bottleneck while its read at the startup. 
     Older logs are cleaned up periodically and doing cleanup operations on a single huge file is difficult to implement</p>
</section>

<section>
<h2>Solution</h2>

<p>Single log is split into multiple segments. 
     Log files are rolled after a specified size limit.
     
</p><pre>public Long writeEntry(WALEntry entry) {
<span>    maybeRoll();</span>
    return openSegment.writeEntry(entry);
}

<span>private void maybeRoll() {</span>
    if (openSegment.
            size() &gt;= config.getMaxLogSize()) {
        openSegment.flush();
        sortedSavedSegments.add(openSegment);
        long lastId = openSegment.getLastLogEntryId();
        openSegment = WALSegment.open(lastId, config.getWalDir());
    }
}</pre>


<p>With log segmentation, there needs to be an easy way to map logical log offsets (or log sequence numbers) to the log segment files.
      This can be done in two ways:
      
</p><ul>
<li>Each log segment name is generated by some well known prefix and the base offset (or log sequence number). </li>

<li>Each log sequence number is divided into two parts, the name of the file and the transaction offset. </li>
</ul>

<pre>public static String createFileName(Long startIndex) {
    return logPrefix + "_" + startIndex + logSuffix;
}

public static Long getBaseOffsetFromFileName(String fileName) {
    String[] nameAndSuffix = fileName.split(logSuffix);
    String[] prefixAndOffset = nameAndSuffix[0].split("_");
    if (prefixAndOffset[0].equals(logPrefix))
        return Long.parseLong(prefixAndOffset[1]);

    return -1l;
}</pre>


<p>
      With this information, the read operation is two steps. 
      For a given offset (or transaction id), the log segment is identified and all the log records are read from subsequent log segments.
      
</p><pre>public List&lt;WALEntry&gt; readFrom(Long startIndex) {
    List&lt;WALSegment&gt; segments = getAllSegmentsContainingLogGreaterThan(startIndex);
    return readWalEntriesFrom(startIndex, segments);
}</pre>

<pre>private List&lt;WALSegment&gt; getAllSegmentsContainingLogGreaterThan(Long startIndex) {
    List&lt;WALSegment&gt; segments = new ArrayList&lt;&gt;();
    //Start from the last segment to the first segment with starting offset less than startIndex
    //This will get all the segments which have log entries more than the startIndex
    for (int i = sortedSavedSegments.size() - 1; i &gt;= 0; i--) {
        WALSegment walSegment = sortedSavedSegments.get(i);
        segments.add(walSegment);

        if (walSegment.getBaseOffset() &lt;= startIndex) {
            break; // break for the first segment with baseoffset less than startIndex
        }
    }

    if (openSegment.getBaseOffset() &lt;= startIndex) {
        segments.add(openSegment);
    }

    return segments;
}</pre>




</section>

<section>
<h2>Examples</h2>

<ul>
<li> The log implementation in all Consensus implementations like <a href="https://github.com/apache/zookeeper/blob/master/zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnLog.java"> Zookeeper </a> and <a href="https://github.com/etcd-io/etcd/blob/master/wal/wal.go">RAFT</a> uses log segmentation.</li>

<li> The storage implementation in <a href="https://github.com/axbaretto/kafka/blob/master/core/src/main/scala/kafka/log/Log.scala"> Kafka </a> follows log segmentation.</li>

<li> All the databases, including the nosql databases like 
                <a href="https://github.com/facebookarchive/cassandra/blob/master/src/org/apache/cassandra/db/CommitLog.java">  Cassandra </a>
                use roll over strategy based on some pre configured log size.
            </li>
</ul>
</section>

<nav>
<p>This page is part of:</p>

<p>Patterns of Distributed Systems</p>
<img src="https://martinfowler.com/articles/patterns-of-distributed-systems/card.png">
<p><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/">Main Narrative Article</a></p>

<p>Patterns</p>

<ul>
<li>Consistent Core †</li>

<li><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/generation.html">Generation Clock</a></li>

<li><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/heartbeat.html">HeartBeat</a></li>

<li><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/high-watermark.html">High-Water Mark</a></li>

<li><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/leader-follower.html">Leader and Followers</a></li>

<li>Low-Water Mark †</li>

<li><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/quorum.html">Quorum</a></li>

<li>Request Pipeline †</li>

<li><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/log-segmentation.html">Segmented Log</a></li>

<li>Single Socket Channel †</li>

<li>Singular Update Queue †</li>

<li>State Watch †</li>

<li>Time Bound Lease †</li>

<li><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/wal.html">Write-Ahead Log</a></li>
</ul>

<p>† pattern in progress</p>
</nav>

<p>
<details id="SignificantRevisions">
<summary>Significant Revisions</summary>
</details>
</p>
</div>
</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>