<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Creating a custom xUnit theory test DataAttribute to load data from JSON files -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Creating a custom xUnit theory test DataAttribute to load data from JSON files</h1><div><div class="post-content"><p>In my <a href="/creating-parameterised-tests-in-xunit-with-inlinedata-classdata-and-memberdata/">last post</a>, I described the various ways to pass data to an xUnit <code>[Theory]</code> test. These are:</p><ul><li><code>[InlineData]</code> - Pass the data for the theory test method parameters as arguments to the attribute</li><li><code>[ClassData]</code> - Create a custom class that implements <code>IEnumerable&lt;object[]&gt;</code>, and use this to return the test data</li><li><code>[MemberData]</code> - Create a <code>static</code> property or method that returns an <code>IEnumerable&lt;object[]&gt;</code> and use it to supply the test data.</li></ul><p>All of these attributes derive from the base <code>DataAttribute</code> class that's part of the xUnit SDK namespace: <code>XUnit.Sdk</code>.</p><p>In this post I'll show how you can create your own implementation of <code>DataAttribute</code>. This allows you to load data from any source you choose. As an example I'll show how you can load data from a JSON file.</p><h2 id="the-dataattribute-base-class" class="heading-with-anchor">The <code>DataAttribute</code> base class<a href="#the-dataattribute-base-class"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The base <code>DataAttribute</code> class is very simple. It's an <code>abstract</code> class that derives from <code>Attribute</code>, with a single method to implement, <code>GetData()</code>, which returns the test data:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">abstract</span><span class="token keyword">class</span><span class="token class-name">DataAttribute</span><span class="token punctuation">:</span><span class="token class-name">Attribute</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">virtual</span><span class="token keyword">string</span> Skip <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">abstract</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token class-name">MethodInfo</span> testMethod<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>The <code>GetData()</code> method returns an <code>IEnumerable&lt;object[]&gt;</code>, which should be familiar if you read my last post, or you've used either <code>[ClassData]</code> or <code>[MemberData]</code>. Each <code>object[]</code> item that's part of the <code>IEnumerable&lt;&gt;</code> contains the parameters for a single run of a <code>[Theory]</code> test.</p><h2 id="using-the-custom-jsonfiledataattribute" class="heading-with-anchor">Using the custom <code>JsonFileDataAttribute</code><a href="#using-the-custom-jsonfiledataattribute"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>To implement a custom method, you just need to derive from this class, and implement <code>GetData</code>. You can then use your new attribute to pass data to a theory test method. In this post we'll create an attribute that loads data from a JSON file, called, <code>JsonFileDataAttribute</code>. We can add this to a theory test, and it will use all the data in the JSON file as data for test runs:</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">Theory</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">JsonFileData</span><span class="token punctuation">(</span><span class="token string">"all_data.json"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">CanAddAll</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span><span class="token keyword">int</span> value2<span class="token punctuation">,</span><span class="token keyword">int</span> expected<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> calculator <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>With this usage, the entire file provides the data for the <code>[Theory]</code> test. Alternatively, you can specify a property value in addition to the file name. This lets you have a single JSON file containing data for multiple theory tests, e.g.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">Theory</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">JsonFileData</span><span class="token punctuation">(</span><span class="token string">"data.json"</span><span class="token punctuation">,</span><span class="token string">"AddData"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">CanAdd</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span><span class="token keyword">int</span> value2<span class="token punctuation">,</span><span class="token keyword">int</span> expected<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> calculator <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">Theory</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">JsonFileData</span><span class="token punctuation">(</span><span class="token string">"data.json"</span><span class="token punctuation">,</span><span class="token string">"SubtractData"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">CanSubtract</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span><span class="token keyword">int</span> value2<span class="token punctuation">,</span><span class="token keyword">int</span> expected<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> calculator <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> result <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>That's how we'll use the attribute, Now we'll look at how to create it.</p><h2 id="creating-the-custom-jsonfiledataattribute" class="heading-with-anchor">Creating the custom <code>JsonFileDataAttribute</code><a href="#creating-the-custom-jsonfiledataattribute"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The implementation of <code>JsonFileDataAttribute</code> uses the provided file path to load a JSON file. It then deserialises the file into an <code>IEnumerable&lt;object[]&gt;</code>, optionally selecting a sub-property first. I've not tried to optimise this at all at, so it just loads the whole file into memory and then deserialises it. You could do a lot more in that respect if performance is an issue, but it does the job.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">JsonFileDataAttribute</span><span class="token punctuation">:</span><span class="token class-name">DataAttribute</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token keyword">string</span> _filePath<span class="token punctuation">;</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token keyword">string</span> _propertyName<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">JsonFileDataAttribute</span><span class="token punctuation">(</span><span class="token keyword">string</span> filePath<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">this</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token function">JsonFileDataAttribute</span><span class="token punctuation">(</span><span class="token keyword">string</span> filePath<span class="token punctuation">,</span><span class="token keyword">string</span> propertyName<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
        _propertyName <span class="token operator">=</span> propertyName<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">override</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token class-name">MethodInfo</span> testMethod<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>testMethod <span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">throw</span><span class="token keyword">new</span><span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>testMethod<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> path <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">IsPathRooted</span><span class="token punctuation">(</span>_filePath<span class="token punctuation">)</span><span class="token operator">?</span> _filePath
            <span class="token punctuation">:</span> Path<span class="token punctuation">.</span><span class="token function">GetRelativePath</span><span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _filePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">throw</span><span class="token keyword">new</span><span class="token class-name">ArgumentException</span><span class="token punctuation">(</span>$<span class="token string">"Could not find file at path: {path}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> fileData <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span>_filePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>_propertyName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> JsonConvert<span class="token punctuation">.</span>DeserializeObject<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> allData <span class="token operator">=</span> JObject<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> data <span class="token operator">=</span> allData<span class="token punctuation">[</span>_propertyName<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">return</span> data<span class="token punctuation">.</span>ToObject<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The <code>JsonFileDataAttribute</code> supports relative or absolute file paths, just remember that the the file path will be relative to the <em>folder in which your tests execute</em>.</p><p>You may have also noticed that the <code>GetData()</code> method is supplied a <code>MethodInfo</code> parameter. If you wanted, you could update the <code>JsonFileDataAttribute</code> to automatically use the theory test method name as the JSON sub-property, but I'll leave that as an exercise!</p><h2 id="loading-data-from-json-files" class="heading-with-anchor">Loading data from JSON files<a href="#loading-data-from-json-files"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Just to complete the picture, the following solution contains two JSON files, <em>data.json</em> and <em>all_data.json</em>, which provide the data for the tests shown earlier in this post. </p><p><img src="/content/images/2017/11/solution.png" alt="Solution including JSON files"></p><p>You have to make sure the files are copied to the test output, which you can do from the properties dialog as shown above, or by setting the <code>CopyToOutputDirectory</code> attribute in your <em>.csproj</em> directly: </p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>None</span><span class="token attr-name">Update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>all_data.json<span class="token punctuation">"</span></span><span class="token attr-name">CopyToOutputDirectory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>PreserveNewest<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>None</span><span class="token attr-name">Update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>data.json<span class="token punctuation">"</span></span><span class="token attr-name">CopyToOutputDirectory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>PreserveNewest<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>None</span><span class="token attr-name">Update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xunit.runner.json<span class="token punctuation">"</span></span><span class="token attr-name">CopyToOutputDirectory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>PreserveNewest<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span></code></pre><p>The <em>data.json</em> file contains two properties, for two different theory tests. Notice that each property is an array of arrays, so that we can deserialize it into an <code>IEnumerable&lt;object[]&gt;</code>.</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"AddData"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span> -<span class="token number">4</span><span class="token punctuation">,</span> -<span class="token number">6</span><span class="token punctuation">,</span> -<span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span> -<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"SubtractData"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span> -<span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span> -<span class="token number">4</span><span class="token punctuation">,</span> -<span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>The <em>all_data.json</em> file on the other hand, consists of a single array of arrays, as we're using the whole file as the source for the theory test.</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span> -<span class="token number">4</span><span class="token punctuation">,</span> -<span class="token number">6</span><span class="token punctuation">,</span> -<span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span> -<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><p>With everything in place, we can run all the theory tests, using the data from the files:</p><p><img src="/content/images/2017/11/theory_tests.png" alt="Theory tests"></p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>xUnit contains the concept of parameterised tests, so you can write tests using a range of data. Out of the box, you can use <code>[InlineData]</code>, <code>[ClassData]</code>, and <code>[MemberData]</code> classes to pass data to such a theory test. All of these attributes derive from <code>DataAttribute</code>, which you can also derive from to create your own custom data source.</p><p>In this post, I showed how you could create a custom <code>DataAttribute</code> called <code>JsonFileDataAttribute</code> to load data from a JSON file. This is a basic implementation, but you could easily extend it to meet your own needs. You can find the code for this and the last post <a href="https://github.com/andrewlock/blog-examples/tree/master/XUnitTheoryTests">on GitHub</a>.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>