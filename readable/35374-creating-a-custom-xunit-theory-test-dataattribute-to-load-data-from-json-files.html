<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Creating a custom xUnit theory test DataAttribute to load data from JSON files -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Creating a custom xUnit theory test DataAttribute to load data from JSON files</h1>
    <div class="post-content">
<p>In my <a href="/creating-parameterised-tests-in-xunit-with-inlinedata-classdata-and-memberdata/">last post</a>, I described the various ways to pass data to an xUnit <code>[Theory]</code> test. These are:</p>
<ul>
<li><code>[InlineData]</code> - Pass the data for the theory test method parameters as arguments to the attribute</li>
<li><code>[ClassData]</code> - Create a custom class that implements <code>IEnumerable&lt;object[]&gt;</code>, and use this to return the test data</li>
<li><code>[MemberData]</code> - Create a <code>static</code> property or method that returns an <code>IEnumerable&lt;object[]&gt;</code> and use it to supply the test data.</li>
</ul>
<p>All of these attributes derive from the base <code>DataAttribute</code> class that&apos;s part of the xUnit SDK namespace: <code>XUnit.Sdk</code>.</p>
<p>In this post I&apos;ll show how you can create your own implementation of <code>DataAttribute</code>. This allows you to load data from any source you choose. As an example I&apos;ll show how you can load data from a JSON file.</p> <p>The base <code>DataAttribute</code> class is very simple. It&apos;s an <code>abstract</code> class that derives from <code>Attribute</code>, with a single method to implement, <code>GetData()</code>, which returns the test data:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DataAttribute</span> <span class="token punctuation">:</span> <span class="token class-name">Attribute</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">string</span> Skip <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">abstract</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">GetData</span><span class="token punctuation">(</span><span class="token class-name">MethodInfo</span> testMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>GetData()</code> method returns an <code>IEnumerable&lt;object[]&gt;</code>, which should be familiar if you read my last post, or you&apos;ve used either <code>[ClassData]</code> or <code>[MemberData]</code>. Each <code>object[]</code> item that&apos;s part of the <code>IEnumerable&lt;&gt;</code> contains the parameters for a single run of a <code>[Theory]</code> test.</p> <p>To implement a custom method, you just need to derive from this class, and implement <code>GetData</code>. You can then use your new attribute to pass data to a theory test method. In this post we&apos;ll create an attribute that loads data from a JSON file, called, <code>JsonFileDataAttribute</code>. We can add this to a theory test, and it will use all the data in the JSON file as data for test runs:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">Theory</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">JsonFileData</span><span class="token punctuation">(</span><span class="token string">&quot;all_data.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">CanAddAll</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span> <span class="token keyword">int</span> value2<span class="token punctuation">,</span> <span class="token keyword">int</span> expected<span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token keyword">var</span> calculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> result <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span> Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>With this usage, the entire file provides the data for the <code>[Theory]</code> test. Alternatively, you can specify a property value in addition to the file name. This lets you have a single JSON file containing data for multiple theory tests, e.g.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">Theory</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">JsonFileData</span><span class="token punctuation">(</span><span class="token string">&quot;data.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AddData&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">CanAdd</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span> <span class="token keyword">int</span> value2<span class="token punctuation">,</span> <span class="token keyword">int</span> expected<span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token keyword">var</span> calculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> result <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span> Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token class-name">Theory</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">JsonFileData</span><span class="token punctuation">(</span><span class="token string">&quot;data.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SubtractData&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">CanSubtract</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span> <span class="token keyword">int</span> value2<span class="token punctuation">,</span> <span class="token keyword">int</span> expected<span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token keyword">var</span> calculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> result <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span> Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>That&apos;s how we&apos;ll use the attribute, Now we&apos;ll look at how to create it.</p> <p>The implementation of <code>JsonFileDataAttribute</code> uses the provided file path to load a JSON file. It then deserialises the file into an <code>IEnumerable&lt;object[]&gt;</code>, optionally selecting a sub-property first. I&apos;ve not tried to optimise this at all at, so it just loads the whole file into memory and then deserialises it. You could do a lot more in that respect if performance is an issue, but it does the job.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonFileDataAttribute</span> <span class="token punctuation">:</span> <span class="token class-name">DataAttribute</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span> _filePath<span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span> _propertyName<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">JsonFileDataAttribute</span><span class="token punctuation">(</span><span class="token keyword">string</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token function">JsonFileDataAttribute</span><span class="token punctuation">(</span><span class="token keyword">string</span> filePath<span class="token punctuation">,</span> <span class="token keyword">string</span> propertyName<span class="token punctuation">)</span> <span class="token punctuation">{</span> _filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span> _propertyName <span class="token operator">=</span> propertyName<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">override</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">GetData</span><span class="token punctuation">(</span><span class="token class-name">MethodInfo</span> testMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>testMethod <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>testMethod<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">var</span> path <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">IsPathRooted</span><span class="token punctuation">(</span>_filePath<span class="token punctuation">)</span> <span class="token operator">?</span> _filePath <span class="token punctuation">:</span> Path<span class="token punctuation">.</span><span class="token function">GetRelativePath</span><span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _filePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">(</span>$<span class="token string">&quot;Could not find file at path: {path}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">var</span> fileData <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span>_filePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>_propertyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> JsonConvert<span class="token punctuation">.</span>DeserializeObject<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">var</span> allData <span class="token operator">=</span> JObject<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> data <span class="token operator">=</span> allData<span class="token punctuation">[</span>_propertyName<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">return</span> data<span class="token punctuation">.</span>ToObject<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>JsonFileDataAttribute</code> supports relative or absolute file paths, just remember that the the file path will be relative to the <em>folder in which your tests execute</em>.</p>
<p>You may have also noticed that the <code>GetData()</code> method is supplied a <code>MethodInfo</code> parameter. If you wanted, you could update the <code>JsonFileDataAttribute</code> to automatically use the theory test method name as the JSON sub-property, but I&apos;ll leave that as an exercise!</p> <p>Just to complete the picture, the following solution contains two JSON files, <em>data.json</em> and <em>all_data.json</em>, which provide the data for the tests shown earlier in this post. </p>
<p><img src="/content/images/2017/11/solution.png" alt="Solution including JSON files"></p>
<p>You have to make sure the files are copied to the test output, which you can do from the properties dialog as shown above, or by setting the <code>CopyToOutputDirectory</code> attribute in your <em>.csproj</em> directly: </p>
<pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>None</span> <span class="token attr-name">Update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>all_data.json<span class="token punctuation">&quot;</span></span> <span class="token attr-name">CopyToOutputDirectory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>PreserveNewest<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>None</span> <span class="token attr-name">Update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>data.json<span class="token punctuation">&quot;</span></span> <span class="token attr-name">CopyToOutputDirectory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>PreserveNewest<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>None</span> <span class="token attr-name">Update</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>xunit.runner.json<span class="token punctuation">&quot;</span></span> <span class="token attr-name">CopyToOutputDirectory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>PreserveNewest<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The <em>data.json</em> file contains two properties, for two different theory tests. Notice that each property is an array of arrays, so that we can deserialize it into an <code>IEnumerable&lt;object[]&gt;</code>.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">&quot;AddData&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> -<span class="token number">4</span><span class="token punctuation">,</span> -<span class="token number">6</span><span class="token punctuation">,</span> -<span class="token number">10</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> -<span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">&quot;SubtractData&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> -<span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> -<span class="token number">4</span><span class="token punctuation">,</span> -<span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <em>all_data.json</em> file on the other hand, consists of a single array of arrays, as we&apos;re using the whole file as the source for the theory test.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> -<span class="token number">4</span><span class="token punctuation">,</span> -<span class="token number">6</span><span class="token punctuation">,</span> -<span class="token number">10</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> -<span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre>
<p>With everything in place, we can run all the theory tests, using the data from the files:</p>
<p><img src="/content/images/2017/11/theory_tests.png" alt="Theory tests"></p> <p>xUnit contains the concept of parameterised tests, so you can write tests using a range of data. Out of the box, you can use <code>[InlineData]</code>, <code>[ClassData]</code>, and <code>[MemberData]</code> classes to pass data to such a theory test. All of these attributes derive from <code>DataAttribute</code>, which you can also derive from to create your own custom data source.</p>
<p>In this post, I showed how you could create a custom <code>DataAttribute</code> called <code>JsonFileDataAttribute</code> to load data from a JSON file. This is a basic implementation, but you could easily extend it to meet your own needs. You can find the code for this and the last post <a href="https://github.com/andrewlock/blog-examples/tree/master/XUnitTheoryTests">on GitHub</a>.</p>
</div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>