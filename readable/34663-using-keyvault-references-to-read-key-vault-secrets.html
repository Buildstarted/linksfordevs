<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using KeyVault References to Read Key Vault Secrets -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Using KeyVault References to Read Key Vault Secrets</h1>
    <div class="article_user-content user-content">
<p class="user-content_text text "><img class="_js aligncenter size-large wp-image-74754" alt width="1280" sizes="(max-width: 1280px) 100vw, 1280px" src="https://www.petri.com/wp-content/uploads/sites/3/2016/08/Microsoft-Azure-cloud-hero-1280x720.png" srcset="https://www.petri.com/wp-content/uploads/sites/3/2016/08/Microsoft-Azure-cloud-hero.png 1280w, https://www.petri.com/wp-content/uploads/sites/3/2016/08/Microsoft-Azure-cloud-hero-300x169.png 300w, https://www.petri.com/wp-content/uploads/sites/3/2016/08/Microsoft-Azure-cloud-hero-768x432.png 768w, https://www.petri.com/wp-content/uploads/sites/3/2016/08/Microsoft-Azure-cloud-hero-800x450.png 800w, https://www.petri.com/wp-content/uploads/sites/3/2016/08/Microsoft-Azure-cloud-hero-310x175.png 310w, https://www.petri.com/wp-content/uploads/sites/3/2016/08/Microsoft-Azure-cloud-hero-500x281.png 500w"></p>
<p class="user-content_text text ">Azure KeyVault is the place to store secrets and cryptographic keys for our applications and services. I&#x2019;m sure you already know that Key Vault can safeguard keys in hardware security modules and audit access to all the secrets inside, but if not, you can read about the basic features in the <a href="https://docs.microsoft.com/en-us/azure/key-vault/key-vault-overview" class="user-content_link link ">Key Vault documentation</a>.</p>
<p class="user-content_text text ">In this post, I want to look at a relatively new feature in Azure App Services that will allow you to consume Key Vault secrets from any application, service, or function running in App Services. This feature is currently in preview but is expected to be generally available in only a few weeks. I believe this new feature, called Key Vault references, is the best approach for using Key Vault. To understand why, let&#x2019;s take a quick look at how we traditionally use Key Vault from an App Service.</p> <h2 class="user-content_title">Key Vault&#x2019;s REST API</h2>
<p class="user-content_text text ">Key Vault, like every service inside of Azure, exposes an API. You can use the API to retrieve a secret from Key Vault. All you need to do is send an HTTPS request with the appropriate authorization token generated from an account with read access to the vault. The API allows us to use KeyVault from any platform and any language with quite a bit of flexibility. Applications can dynamically load secrets and connection strings from Key Vault and keep the settings cached.</p>
<p class="user-content_text text ">Microsoft provides wrappers around the low-level HTTP API for many platforms and languages. When building apps or services with ASP.NET Core for example, you can reference a NuGet package for a Key Vault configuration provider. The provider will load a complete set of secrets into the app&#x2019;s native configuration settings. &#xA0;The code is simple and looks like the following.<br>
</p>
<div id="crayon-5d679576b9993526235398" class="crayon-syntax crayon-theme-1c-zapros crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums "> </td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5d679576b9993526235398-1"><span class="crayon-e">var </span><span class="crayon-i">azureServiceTokenProvider</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">new </span><span class="crayon-e">AzureServiceTokenProvider</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5d679576b9993526235398-3"><span class="crayon-e">var </span><span class="crayon-i">keyVaultClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">new </span><span class="crayon-e">KeyVaultClient</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-5d679576b9993526235398-4"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="crayon-e">new </span><span class="crayon-i">KeyVaultClient</span><span class="crayon-sy">.</span><span class="crayon-e">AuthenticationCallback</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-5d679576b9993526235398-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="crayon-i">azureServiceTokenProvider</span><span class="crayon-sy">.</span><span class="crayon-i">KeyVaultTokenCallback</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5d679576b9993526235398-7"><span class="crayon-i">config</span><span class="crayon-sy">.</span><span class="crayon-e">AddAzureKeyVault</span><span class="crayon-sy">(</span></p><p class="crayon-line" id="crayon-5d679576b9993526235398-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="crayon-sy">$</span><span class="crayon-s">&quot;https://{yourvaultname}.vault.azure.net/&quot;</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b9993526235398-9"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="crayon-i">keyVaultClient</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b9993526235398-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span class="crayon-e">new </span><span class="crayon-e">DefaultKeyVaultSecretManager</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td>
</tr>
</table>
</div>
</div> <p><br>
The downside is that ops teams and admins have a tough time seeing what keys an application is using with the API approach. The API calls hide the configuration keys inside of application code. To change a key a service is using, for example, someone needs to make changes in the code base and then re-build and re-deploy the service.</p>
<p class="user-content_text text ">Using ARM Templates</p>
<p class="user-content_text text ">Another approach to using Key Vault secrets is to deploy an App Service or Function App using ARM templates with Key Vault parameters inside. This approach does not require any API calls to Key Vault at runtime because the ARM deployment will read Key Vault secrets during a deployment operation and create genuine App Settings in the service with the values of those secrets. The ARM template will look something like the following excerpt, which wants to create an App Setting named TheClientSecret with a secret value from Key Vault.<br>
</p>
<div id="crayon-5d679576b9998262277592" class="crayon-syntax crayon-theme-1c-zapros crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums "> </td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5d679576b9998262277592-1"><span class="crayon-s">&quot;resources&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-2"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;name&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">&quot;appsettings&quot;</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-4"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;type&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">&quot;config&quot;</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;apiVersion&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">&quot;2015-08-01&quot;</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;dependsOn&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-7"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;[resourceId(&apos;Microsoft.Web/sites/YourAppServiceName&apos;))]&quot;</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-9"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;properties&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;ClientSecret&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">&quot;[parameters(&apos;TheClientSecret&apos;)]&quot;</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-11"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5d679576b9998262277592-12"><span class="crayon-sy">}</span><span class="crayon-sy">]</span></p></div></td>
</tr>
</table>
</div>
</div> <p>
The template needs to specify the Key Vault secret to use by first adding to the parameters of the template.</p>
<div id="crayon-5d679576b999a332848326" class="crayon-syntax crayon-theme-1c-zapros crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums "> </td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5d679576b999a332848326-1"><span class="crayon-s">&quot;parameters&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5d679576b999a332848326-2"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-s">&quot;TheClientSecret&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5d679576b999a332848326-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;type&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">&quot;securestring&quot;</span></p><p class="crayon-line" id="crayon-5d679576b999a332848326-4"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5d679576b999a332848326-5"><span class="crayon-sy">}</span></p></div></td>
</tr>
</table>
</div>
</div> <p>
And finally, by specifying the vault ID and secret name to substitute into the App Setting at deployment.</p>
<div id="crayon-5d679576b999b561581553" class="crayon-syntax crayon-theme-1c-zapros crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums "> </td>
<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5d679576b999b561581553-1"><span class="crayon-s">&quot;TheClientSecret&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5d679576b999b561581553-2"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-s">&quot;reference&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5d679576b999b561581553-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;keyVault&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5d679576b999b561581553-4"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;id&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">&quot;YourKeyVaultID&quot;</span></p><p class="crayon-line" id="crayon-5d679576b999b561581553-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5d679576b999b561581553-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s">&quot;secretName&quot;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">&quot;ClientIdSecretNameInKeyVault&quot;</span></p><p class="crayon-line" id="crayon-5d679576b999b561581553-7"><span class="crayon-h">&#xA0;&#xA0;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5d679576b999b561581553-8"><span class="crayon-sy">}</span></p></div></td>
</tr>
</table>
</div>
</div> <p><br>
The ARM template approach makes it easy for ops teams to change settings because the settings are available in the service&#x2019;s App Settings. However, it might not be obvious to the person making the changes that the next deployment will overwrite the change. When using an ARM template, the proper way to change a secret is to make the change in Key Vault and then redeploy the template.</p>
<h2 class="user-content_title">Key Vault References</h2>
<p class="user-content_text text ">The Key Vault references feature of Azure App Services gives us the security benefits of using Azure Key Vault while keeping configuration settings outside of application code and deployment templates, which gives the ops team more flexibility and control.</p>
<p class="user-content_text text ">Let&#x2019;s take the example where we have an application that wants to display a secret message. We&#x2019;ll store the message in a new Azure Key Vault secret with the name SecretMessage.</p>
<figure id="attachment_620654" class="wp-caption alignnone"><img class="_js size-large wp-image-620654" alt width="1280" sizes="(max-width: 1280px) 100vw, 1280px" src="https://www.petri.com/wp-content/uploads/sites/3/2019/08/secretmessagekey-1280x724.jpg" srcset="https://www.petri.com/wp-content/uploads/sites/3/2019/08/secretmessagekey.jpg 1280w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/secretmessagekey-300x170.jpg 300w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/secretmessagekey-768x434.jpg 768w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/secretmessagekey-650x368.jpg 650w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/secretmessagekey-955x540.jpg 955w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/secretmessagekey-500x283.jpg 500w"><figcaption id="caption-attachment-620654" class="wp-caption-text"> A Key Vault Secret</figcaption></figure> <p class="user-content_text text ">In the Application Settings for the app, we can specify a Key Vault reference using the syntax @Microsoft.KeyVault(SecretUri=https://YourKeyVaultName.vault.azure.net/secrets/SecretMessage/Version). You can find the full URI for a secret including the version number by drilling into the properties for the secret in the Azure portal.</p>
<figure id="attachment_620655" class="wp-caption alignnone"><img class="_js size-large wp-image-620655" alt width="1280" sizes="(max-width: 1280px) 100vw, 1280px" src="https://www.petri.com/wp-content/uploads/sites/3/2019/08/specifyappsettings-1280x720.jpg" srcset="https://www.petri.com/wp-content/uploads/sites/3/2019/08/specifyappsettings-1280x720.jpg 1280w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/specifyappsettings-300x169.jpg 300w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/specifyappsettings-768x432.jpg 768w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/specifyappsettings-650x366.jpg 650w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/specifyappsettings-960x540.jpg 960w, https://www.petri.com/wp-content/uploads/sites/3/2019/08/specifyappsettings-500x281.jpg 500w"><figcaption id="caption-attachment-620655" class="wp-caption-text"> Application Setting using Key Vault Reference</figcaption></figure> <p class="user-content_text text ">All the application needs to do is ask for the configuration value &#x201C;SecretMessage&#x201D; with the same code it uses for any other App Setting. There are no code changes required. App services will place the value into the configuration system when the App Service starts. Note this means you&#x2019;ll need to restart the app if you change the setting in Key Vault. However, for the ops team it is clear what configuration settings the application requires and where the settings come from. There is no more configuration hidden in application code or ARM templates.You will need to give the App Service a managed identity and grant the identity read access to the secrets it needs.</p>
<h2 class="user-content_title">Summary</h2>
<p class="user-content_text text ">Although Key Vault references have been in preview for many months, my sources tell me the feature is stable and will be available by the end of September. Key Vault references are flexible while being transparent and secure, and I believe they should be everyone&#x2019;s first choice for configuring secrets into an App Service.</p>
</div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>