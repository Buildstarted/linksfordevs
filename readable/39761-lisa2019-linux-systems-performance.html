<!DOCTYPE html>
<html lang="en">
<head>
    <title>
LISA2019 Linux Systems Performance -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>LISA2019 Linux Systems Performance</h1>
    <div class="slideshow-info-container"> <p class="notranslate"> <ol class="j-transcripts transcripts no-bullet no-style"> <li> 1. Linux Systems
Performance
Brendan Gregg
Senior Performance Engineer
Oct, 2019
USENIX LISA 2019, Portland, Oct 28-30 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-2-638.jpg?cb=1572382474"> 2. </a> Experience: A 3x Perf Difference </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-3-638.jpg?cb=1572382474"> 3. </a> mpstat
serverA# mpstat 10
Linux 4.4.0-130-generic (serverA) 07/18/2019 _x86_64_ (48 CPU)
10:07:55 PM CPU %usr %nice %sys %iowait %irq %soft %steal %guest %gnice %idle
10:08:05 PM all 89.72 0.00 7.84 0.00 0.00 0.04 0.00 0.00 0.00 2.40
10:08:15 PM all 88.60 0.00 9.18 0.00 0.00 0.05 0.00 0.00 0.00 2.17
10:08:25 PM all 89.71 0.00 9.01 0.00 0.00 0.05 0.00 0.00 0.00 1.23
[...]
Average: all 89.49 0.00 8.47 0.00 0.00 0.05 0.00 0.00 0.00 1.99
serverB# mpstat 10
Linux 4.19.26-nflx (serverB) 07/18/2019 _x86_64_ (64 CPU)
09:56:11 PM CPU %usr %nice %sys %iowait %irq %soft %steal %guest %gnice %idle
09:56:21 PM all 23.21 0.01 0.32 0.00 0.00 0.10 0.00 0.00 0.00 76.37
09:56:31 PM all 20.21 0.00 0.38 0.00 0.00 0.08 0.00 0.00 0.00 79.33
09:56:41 PM all 21.58 0.00 0.39 0.00 0.00 0.10 0.00 0.00 0.00 77.92
[...]
Average: all 21.50 0.00 0.36 0.00 0.00 0.09 0.00 0.00 0.00 78.04
load averages: serverA 90, serverB 17 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-4-638.jpg?cb=1572382474"> 4. </a> pmcarch
serverA# ./pmcarch -p 4093 10
K_CYCLES K_INSTR IPC BR_RETIRED BR_MISPRED BMR% LLCREF LLCMISS LLC%
982412660 575706336 0.59 126424862460 2416880487 1.91 15724006692 10872315070 30.86
999621309 555043627 0.56 120449284756 2317302514 1.92 15378257714 11121882510 27.68
991146940 558145849 0.56 126350181501 2530383860 2.00 15965082710 11464682655 28.19
996314688 562276830 0.56 122215605985 2348638980 1.92 15558286345 10835594199 30.35
979890037 560268707 0.57 125609807909 2386085660 1.90 15828820588 11038597030 30.26
^C
serverB# ./pmcarch -p 1928219 10
K_CYCLES K_INSTR IPC BR_RETIRED BR_MISPRED BMR% LLCREF LLCMISS LLC%
147523816 222396364 1.51 46053921119 641813770 1.39 8880477235 968809014 89.09
156634810 229801807 1.47 48236123575 653064504 1.35 9186609260 1183858023 87.11
152783226 237001219 1.55 49344315621 692819230 1.40 9314992450 879494418 90.56
140787179 213570329 1.52 44518363978 631588112 1.42 8675999448 712318917 91.79
136822760 219706637 1.61 45129020910 651436401 1.44 8689831639 617678747 92.89 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-5-638.jpg?cb=1572382474"> 5. </a> perf
serverA# perf stat -e cs -a -I 1000
# time counts unit events
1.000411740 2,063,105 cs
2.000977435 2,065,354 cs
3.001537756 1,527,297 cs
4.002028407 515,509 cs
5.002538455 2,447,126 cs
[...]
serverB# perf stat -e cs -p 1928219 -I 1000
# time counts unit events
1.001931945 1,172 cs
2.002664012 1,370 cs
3.003441563 1,034 cs
4.004140394 1,207 cs
5.004947675 1,053 cs
[...] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-6-638.jpg?cb=1572382474"> 6. </a> bcc/BPF
serverA# /usr/share/bcc/tools/cpudist -p 4093 10 1
Tracing on-CPU time... Hit Ctrl-C to end.
usecs : count distribution
0 -&gt; 1 : 3618650 |****************************************|
2 -&gt; 3 : 2704935 |***************************** |
4 -&gt; 7 : 421179 |**** |
8 -&gt; 15 : 99416 |* |
16 -&gt; 31 : 16951 | |
32 -&gt; 63 : 6355 | |
[...]
serverB# /usr/share/bcc/tools/cpudist -p 1928219 10 1
Tracing on-CPU time... Hit Ctrl-C to end.
usecs : count distribution
256 -&gt; 511 : 44 | |
512 -&gt; 1023 : 156 |* |
1024 -&gt; 2047 : 238 |** |
2048 -&gt; 4095 : 4511 |****************************************|
4096 -&gt; 8191 : 277 |** |
8192 -&gt; 16383 : 286 |** |
16384 -&gt; 32767 : 77 | |
[...] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-7-638.jpg?cb=1572382474"> 7. </a> Systems Performance in 45 mins
&#x2022; This is slides + discussion
&#x2022; For more detail and stand-alone texts: </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-8-638.jpg?cb=1572382474"> 8. </a> Agenda
1. Observability
2. Methodologies
3. Benchmarking
4. Profiling
5. Tracing
6. Tuning </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-9-638.jpg?cb=1572382474"> 9. </a> 1. Observability </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-10-638.jpg?cb=1572382474"> 10. </a> How do you measure these? </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-11-638.jpg?cb=1572382474"> 11. </a> Linux Observability Tools </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-12-638.jpg?cb=1572382474"> 12. </a> Why Learn Tools?
&#x2022; Most analysis at Netflix is via GUIs
&#x2022; Benefits of command-line tools:
&#x2013; Helps you understand GUIs: they show the same metrics
&#x2013; Often documented, unlike GUI metrics
&#x2013; Often have useful options not exposed in GUIs
&#x2022; Installing essential tools (something like):
$ sudo apt-get install sysstat bcc-tools bpftrace linux-tools-common linux-tools-$(uname -r) iproute2 msr-tools
$ git clone https://github.com/brendangregg/msr-cloud-tools
$ git clone https://github.com/brendangregg/bpf-perf-tools-book
These are crisis tools and should be installed by default
In a performance meltdown you may be unable to install them </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-13-638.jpg?cb=1572382474"> 13. </a> uptime
&#x2022; One way to print load averages:
&#x2022; A measure of resource demand: CPUs + disks
&#x2013; Includes TASK_UNINTERRUPTIBLE state to show all demand types
&#x2013; You can use BPF &amp; off-CPU flame graphs to explain this state:
http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html
&#x2013; PSI in Linux 4.20 shows CPU, I/O, and memory loads
&#x2022; Exponentially-damped moving averages
&#x2013; With time constants of 1, 5, and 15 minutes. See historic trend.
&#x2022; Load &gt; # of CPUs, may mean CPU saturation
$ uptime
07:42:06 up 8:16, 1 user, load average: 2.27, 2.84, 2.91
Don&#x2019;t spend more than 5 seconds studying these </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-14-638.jpg?cb=1572382474"> 14. </a> top
&#x2022; System and per-process interval summary:
&#x2022; %CPU is summed across all CPUs
&#x2022; Can miss short-lived processes (atop won&#x2019;t)
$ top - 18:50:26 up 7:43, 1 user, load average: 4.11, 4.91, 5.22
Tasks: 209 total, 1 running, 206 sleeping, 0 stopped, 2 zombie
Cpu(s): 47.1%us, 4.0%sy, 0.0%ni, 48.4%id, 0.0%wa, 0.0%hi, 0.3%si, 0.2%st
Mem: 70197156k total, 44831072k used, 25366084k free, 36360k buffers
Swap: 0k total, 0k used, 0k free, 11873356k cached
PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND
5738 apiprod 20 0 62.6g 29g 352m S 417 44.2 2144:15 java
1386 apiprod 20 0 17452 1388 964 R 0 0.0 0:00.02 top
1 root 20 0 24340 2272 1340 S 0 0.0 0:01.51 init
2 root 20 0 0 0 0 S 0 0.0 0:00.00 kthreadd
[&#x2026;] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-15-638.jpg?cb=1572382474"> 15. </a> htop
&#x2022; Pros: configurable. Cons: misleading colors.
&#x2022; dstat is similar, and now dead (May 2019); see pcp-dstat
$ htop
1 [||||||||||70.0%] 13 [||||||||||70.6%] 25 [||||||||||69.7%] 37 [||||||||||66.6%]
2 [||||||||||68.7%] 14 [||||||||||69.4%] 26 [||||||||||67.7%] 38 [||||||||||66.0%]
3 [||||||||||68.2%] 15 [||||||||||68.5%] 27 [||||||||||68.8%] 39 [||||||||||73.3%]
4 [||||||||||69.3%] 16 [||||||||||69.2%] 28 [||||||||||67.6%] 40 [||||||||||67.0%]
5 [||||||||||68.0%] 17 [||||||||||67.6%] 29 [||||||||||70.1%] 41 [||||||||||66.5%]
[&#x2026;]
Mem[||||||||||||||||||||||||||||||176G/187G] Tasks: 80, 3206 thr; 43 running
Swp[ 0K/0K] Load average: 36.95 37.19 38.29
Uptime: 01:39:36
PID USER PRI NI VIRT RES SHR S CPU% MEM% TIME+ Command
4067 www-data 20 0 202G 173G 55392 S 3359 93.0 48h51:30 /apps/java/bin/java -Dnop -Djdk.map
6817 www-data 20 0 202G 173G 55392 R 56.9 93.0 48:37.89 /apps/java/bin/java -Dnop -Djdk.map
6826 www-data 20 0 202G 173G 55392 R 25.7 93.0 22:26.90 /apps/java/bin/java -Dnop -Djdk.map
6721 www-data 20 0 202G 173G 55392 S 25.0 93.0 22:05.51 /apps/java/bin/java -Dnop -Djdk.map
6616 www-data 20 0 202G 173G 55392 S 13.6 93.0 11:15.51 /apps/java/bin/java -Dnop -Djdk.map
[&#x2026;]
F1Help F2Setup F3SearchF4FilterF5Tree F6SortByF7Nice -F8Nice +F9Kill F10Quit </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-16-638.jpg?cb=1572382474"> 16. </a> vmstat
&#x2022; Virtual memory statistics and more:
&#x2022; USAGE: vmstat [interval [count]]
&#x2022; First output line has some summary since boot values
&#x2022; High level CPU summary
&#x2013; &#x201C;r&#x201D; is runnable tasks
$ vmstat &#x2013;Sm 1
procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----
r b swpd free buff cache si so bi bo in cs us sy id wa
8 0 0 1620 149 552 0 0 1 179 77 12 25 34 0 0
7 0 0 1598 149 552 0 0 0 0 205 186 46 13 0 0
8 0 0 1617 149 552 0 0 0 8 210 435 39 21 0 0
8 0 0 1589 149 552 0 0 0 0 218 219 42 17 0 0
[&#x2026;] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-17-638.jpg?cb=1572382474"> 17. </a> iostat
&#x2022; Block I/O (disk) stats. 1st output is since boot.
$ iostat -xz 1
Linux 5.0.21 (c099.xxxx) 06/24/19 _x86_64_ (32 CPU)
[...]
Device r/s w/s rkB/s wkB/s rrqm/s wrqm/s %rrqm %wrqm ...
sda 0.01 0.00 0.16 0.00 0.00 0.00 0.00 0.00 /...
nvme3n1 19528.04 20.39 293152.56 14758.05 0.00 4.72 0.00 18.81 ...
nvme1n1 18513.51 17.83 286402.15 13089.56 0.00 4.05 0.00 18.52 /...
nvme0n1 16560.88 19.70 258184.52 14218.55 0.00 4.78 0.00 19.51 ...
... r_await w_await aqu-sz rareq-sz wareq-sz svctm %util
.../ 1.90 0.00 0.00 17.01 0.00 1.13 0.00
... 0.13 53.56 1.05 15.01 723.80 0.02 47.29
.../ 0.13 49.26 0.85 15.47 734.21 0.03 48.09
... 0.13 50.46 0.96 15.59 721.65 0.03 46.64
Workload
Resulting Performance
Very useful
set of stats </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-18-638.jpg?cb=1572382474"> 18. </a> free
&#x2022; Main memory usage:
&#x2022; Recently added &#x201C;available&#x201D; column
&#x2013; buff/cache: block device I/O cache + virtual page cache
&#x2013; available: memory likely available to apps
&#x2013; free: completely unused memory
$ free -m
total used free shared buff/cache available
Mem: 23850 18248 592 3776 5008 1432
Swap: 31699 2021 29678 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-19-638.jpg?cb=1572382474"> 19. </a> strace
&#x2022; System call tracer:
&#x2022; Translates syscall arguments
&#x2022; Not all kernel requests (e.g., page faults)
&#x2022; Currently has massive overhead (ptrace based)
&#x2013; Can slow the target by &gt; 100x. Skews measured time (-ttt, -T).
&#x2013; http://www.brendangregg.com/blog/2014-05-11/strace-wow-much-syscall.html
&#x2022; perf trace will replace it: uses a ring buffer &amp; BPF
$ strace &#x2013;tttT &#x2013;p 313
1408393285.779746 getgroups(0, NULL) = 1 &lt;0.000016&gt;
1408393285.779873 getgroups(1, [0]) = 1 &lt;0.000015&gt;
1408393285.780797 close(3) = 0 &lt;0.000016&gt;
1408393285.781338 write(1, &quot;wow much syscalln&quot;, 17wow much syscall
) = 17 &lt;0.000048&gt; </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-20-638.jpg?cb=1572382474"> 20. </a> tcpdump
&#x2022; Sniff network packets for post analysis:
&#x2022; Study packet sequences with timestamps (us)
&#x2022; CPU overhead optimized (socket ring buffers), but can
still be significant. Use BPF in-kernel summaries
instead.
$ tcpdump -i eth0 -w /tmp/out.tcpdump
tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
^C7985 packets captured
8996 packets received by filter
1010 packets dropped by kernel
# tcpdump -nr /tmp/out.tcpdump | head
reading from file /tmp/out.tcpdump, link-type EN10MB (Ethernet)
20:41:05.038437 IP 10.44.107.151.22 &gt; 10.53.237.72.46425: Flags [P.], seq 18...
20:41:05.038533 IP 10.44.107.151.22 &gt; 10.53.237.72.46425: Flags [P.], seq 48...
20:41:05.038584 IP 10.44.107.151.22 &gt; 10.53.237.72.46425: Flags [P.], seq 96...
[&#x2026;] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-21-638.jpg?cb=1572382474"> 21. </a> nstat
&#x2022; Replacement for netstat from iproute2
&#x2022; Various network protocol statistics:
&#x2013; -s won&#x2019;t reset counters,
otherwise intervals
can be examined
&#x2013; -d for daemon mode
&#x2022; Linux keeps adding
more counters
$ nstat -s
#kernel
IpInReceives 31109659 0.0
IpInDelivers 31109371 0.0
IpOutRequests 33209552 0.0
[...]
TcpActiveOpens 508924 0.0
TcpPassiveOpens 388584 0.0
TcpAttemptFails 933 0.0
TcpEstabResets 1545 0.0
TcpInSegs 31099176 0.0
TcpOutSegs 56254112 0.0
TcpRetransSegs 3762 0.0
TcpOutRsts 3183 0.0
[...] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-22-638.jpg?cb=1572382474"> 22. </a> slabtop
&#x2022; Kernel slab allocator memory usage:
$ slabtop
Active / Total Objects (% used) : 4692768 / 4751161 (98.8%)
Active / Total Slabs (% used) : 129083 / 129083 (100.0%)
Active / Total Caches (% used) : 71 / 109 (65.1%)
Active / Total Size (% used) : 729966.22K / 738277.47K (98.9%)
Minimum / Average / Maximum Object : 0.01K / 0.16K / 8.00K
OBJS ACTIVE USE OBJ SIZE SLABS OBJ/SLAB CACHE SIZE NAME
3565575 3565575 100% 0.10K 91425 39 365700K buffer_head
314916 314066 99% 0.19K 14996 21 59984K dentry
184192 183751 99% 0.06K 2878 64 11512K kmalloc-64
138618 138618 100% 0.94K 4077 34 130464K xfs_inode
138602 138602 100% 0.21K 3746 37 29968K xfs_ili
102116 99012 96% 0.55K 3647 28 58352K radix_tree_node
97482 49093 50% 0.09K 2321 42 9284K kmalloc-96
22695 20777 91% 0.05K 267 85 1068K shared_policy_node
21312 21312 100% 0.86K 576 37 18432K ext4_inode_cache
16288 14601 89% 0.25K 509 32 4072K kmalloc-256
[&#x2026;] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-23-638.jpg?cb=1572382474"> 23. </a> pcstat
&#x2022; Show page cache residency by file:
&#x2022; Uses mincore(2) syscall. Used for database perf analysis.
# ./pcstat data0*
|----------+----------------+------------+-----------+---------|
| Name | Size | Pages | Cached | Percent |
|----------+----------------+------------+-----------+---------|
| data00 | 104857600 | 25600 | 25600 | 100.000 |
| data01 | 104857600 | 25600 | 25600 | 100.000 |
| data02 | 104857600 | 25600 | 4080 | 015.938 |
| data03 | 104857600 | 25600 | 25600 | 100.000 |
| data04 | 104857600 | 25600 | 16010 | 062.539 |
| data05 | 104857600 | 25600 | 0 | 000.000 |
|----------+----------------+------------+-----------+---------| </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-24-638.jpg?cb=1572382474"> 24. </a> docker stats
&#x2022; Soft limits (cgroups) by container:
&#x2022; Stats are in /sys/fs/cgroups
&#x2022; CPU shares and bursting breaks monitoring assumptions
# docker stats
CONTAINER CPU % MEM USAGE / LIMIT MEM % NET I/O BLOCK I/O PIDS
353426a09db1 526.81% 4.061 GiB / 8.5 GiB 47.78% 0 B / 0 B 2.818 MB / 0 B 247
6bf166a66e08 303.82% 3.448 GiB / 8.5 GiB 40.57% 0 B / 0 B 2.032 MB / 0 B 267
58dcf8aed0a7 41.01% 1.322 GiB / 2.5 GiB 52.89% 0 B / 0 B 0 B / 0 B 229
61061566ffe5 85.92% 220.9 MiB / 3.023 GiB 7.14% 0 B / 0 B 43.4 MB / 0 B 61
bdc721460293 2.69% 1.204 GiB / 3.906 GiB 30.82% 0 B / 0 B 4.35 MB / 0 B 66
6c80ed61ae63 477.45% 557.7 MiB / 8 GiB 6.81% 0 B / 0 B 9.257 MB / 0 B 19
337292fb5b64 89.05% 766.2 MiB / 8 GiB 9.35% 0 B / 0 B 5.493 MB / 0 B 19
b652ede9a605 173.50% 689.2 MiB / 8 GiB 8.41% 0 B / 0 B 6.48 MB / 0 B 19
d7cd2599291f 504.28% 673.2 MiB / 8 GiB 8.22% 0 B / 0 B 12.58 MB / 0 B 19
05bf9f3e0d13 314.46% 711.6 MiB / 8 GiB 8.69% 0 B / 0 B 7.942 MB / 0 B 19
09082f005755 142.04% 693.9 MiB / 8 GiB 8.47% 0 B / 0 B 8.081 MB / 0 B 19
[...] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-25-638.jpg?cb=1572382474"> 25. </a> showboost
&#x2022; Determine current CPU clock rate
&#x2022; Uses MSRs. Can also use PMCs for this.
&#x2022; Also see turbostat.
# showboost
Base CPU MHz : 2500
Set CPU MHz : 2500
Turbo MHz(s) : 3100 3200 3300 3500
Turbo Ratios : 124% 128% 132% 140%
CPU 0 summary every 1 seconds...
TIME C0_MCYC C0_ACYC UTIL RATIO MHz
23:39:07 1618910294 89419923 64% 5% 138
23:39:08 1774059258 97132588 70% 5% 136
23:39:09 2476365498 130869241 99% 5% 132
^C
https://github.com/brendangregg/msr-cloud-tools </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-26-638.jpg?cb=1572382474"> 26. </a> Also: Static Performance Tuning Tools </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-27-638.jpg?cb=1572382474"> 27. </a> Where do you start...and stop?
Workload Observability Static Configuration </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-28-638.jpg?cb=1572382474"> 28. </a> 2. Methodologies </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-29-638.jpg?cb=1572382474"> 29. </a> Anti-Methodologies
&#x2022; The lack of a deliberate methodology&#x2026;
&#x2022; Street Light Anti-Method:
&#x2013; 1. Pick observability tools that are
&#x2022; Familiar
&#x2022; Found on the Internet
&#x2022; Found at random
&#x2013; 2. Run tools
&#x2013; 3. Look for obvious issues
&#x2022; Drunk Man Anti-Method:
&#x2013; Tune things at random until the problem goes away </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-30-638.jpg?cb=1572382474"> 30. </a> Methodologies
&#x2022; Linux Performance Analysis in 60 seconds
&#x2022; The USE method
&#x2022; Workload characterization
&#x2022; Many others:
&#x2013; Resource analysis
&#x2013; Workload analysis
&#x2013; Drill-down analysis
&#x2013; CPU profile method
&#x2013; Off-CPU analysis
&#x2013; Static performance tuning
&#x2013; 5 whys
&#x2026; </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-31-638.jpg?cb=1572382474"> 31. </a> Linux Perf Analysis in 60s
http://techblog.netflix.com/2015/11/linux-performance-analysis-in-60s.html
1. uptime
2. dmesg -T | tail
3. vmstat 1
4. mpstat -P ALL 1
5. pidstat 1
6. iostat -xz 1
7. free -m
8. sar -n DEV 1
9. sar -n TCP,ETCP 1
10. top
load averages
kernel errors
overall stats by time
CPU balance
process usage
disk I/O
memory usage
network I/O
TCP stats
check overview </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-32-638.jpg?cb=1572382474"> 32. </a> USE Method
For every resource, check:
1. Utilization
2. Saturation
3. Errors
For example, CPUs:
- Utilization: time busy
- Saturation: run queue length or latency
- Errors: ECC errors, etc.
Can be applied to hardware and software (cgroups)
Resource
Utilization
(%)
Saturation
Errors
X
Start with the questions,
then find the tools </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-33-638.jpg?cb=1572382474"> 33. </a> Workload Characterization
Analyze workload characteristics, not resulting performance
For example, CPUs:
1. Who: which PIDs, programs, users
2. Why: code paths, context
3. What: CPU instructions, cycles
4. How: changing over time
TargetWorkload </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-34-638.jpg?cb=1572382474"> 34. </a> 3. Benchmarking </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-35-638.jpg?cb=1572382474"> 35. </a> ~100% of benchmarks are wrong
The energy needed to refute benchmarks
is orders of magnitude bigger than
to run them (so, no one does) </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-36-638.jpg?cb=1572382474"> 36. </a> Benchmarking
&#x2022; An experimental analysis activity
&#x2013; Try observational analysis first; benchmarks can perturb
&#x2022; Benchmarking is error prone:
&#x2013; Testing the wrong target
&#x2022; eg, FS cache I/O instead of disk I/O
&#x2013; Choosing the wrong target
&#x2022; eg, disk I/O instead of FS cache I/O
&#x2013; Invalid results
&#x2022; eg, bugs
&#x2013; Misleading results:
&#x2022; you benchmark A,
but actually measure B,
and conclude you measured C caution: benchmarking </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-37-638.jpg?cb=1572382474"> 37. </a> Benchmark Examples
&#x2022; Micro benchmarks:
&#x2013; File system maximum cached read operations/sec
&#x2013; Network maximum throughput
&#x2022; Macro (application) benchmarks:
&#x2013; Simulated application max request rate
&#x2022; Bad benchmarks:
&#x2013; gitpid() in a tight loop
&#x2013; Context switch timing
kitchen sink benchmarks </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-38-638.jpg?cb=1572382474"> 38. </a> caution: despair
If your product&#x2019;s chances of
winning a benchmark are
50/50, you&#x2019;ll usually lose
Benchmark paradox
http://www.brendangregg.com/blog/2014-05-03/the-benchmark-paradox.html </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-39-638.jpg?cb=1572382474"> 39. </a> Solution: Active Benchmarking
&#x2022; Root cause analysis while the benchmark runs
&#x2013; Use the earlier observability tools
&#x2013; Identify the limiter (or suspect) and include it with the results
&#x2022; For any given benchmark, ask: why not 10x?
&#x2022; This takes time, but uncovers most mistakes </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-40-638.jpg?cb=1572382474"> 40. </a> 4. Profiling </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-41-638.jpg?cb=1572382474"> 41. </a> Profiling
Can you do this?
&#x201C;As an experiment to investigate the performance of the resulting TCP/IP
implementation ... the 11/750 is CPU saturated, but the 11/780 has about
30% idle time. The time spent in the system processing the data is spread
out among handling for the Ethernet (20%), IP packet processing (10%),
TCP processing (30%), checksumming (25%), and user system call
handling (15%), with no single part of the handling dominating the time in
the system.&#x201D;
&#x2013; Bill Joy, 1981, TCP-IP Digest, Vol 1 #6
https://www.rfc-editor.org/rfc/museum/tcp-ip-digest/tcp-ip-digest.v1n6.1 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-42-638.jpg?cb=1572382474"> 42. </a> perf: CPU profiling
&#x2022; Sampling full stack traces at 99 Hertz, for 30 secs:
# perf record -F 99 -ag -- sleep 30
[ perf record: Woken up 9 times to write data ]
[ perf record: Captured and wrote 2.745 MB perf.data (~119930 samples) ]
# perf report -n --stdio
1.40% 162 java [kernel.kallsyms] [k] _raw_spin_lock
|
--- _raw_spin_lock
|
|--63.21%-- try_to_wake_up
| |
| |--63.91%-- default_wake_function
| | |
| | |--56.11%-- __wake_up_common
| | | __wake_up_locked
| | | ep_poll_callback
| | | __wake_up_common
| | | __wake_up_sync_key
| | | |
| | | |--59.19%-- sock_def_readable
[&#x2026;78,000 lines truncated&#x2026;] </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-43-638.jpg?cb=1572382474"> 43. </a> Full &quot;perf report&quot; Output </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-44-638.jpg?cb=1572382474"> 44. </a> &#x2026; as a Flame Graph </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-45-638.jpg?cb=1572382474"> 45. </a> Flame Graphs
&#x2022; Visualizes a collection of stack traces
&#x2013; x-axis: alphabetical stack sort, to maximize merging
&#x2013; y-axis: stack depth
&#x2013; color: random (default), or a dimension
&#x2022; Perl + SVG + JavaScript
&#x2013; https://github.com/brendangregg/FlameGraph
&#x2013; Takes input from many different profilers
&#x2013; Multiple d3 versions are being developed
&#x2022; References:
&#x2013; http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html
&#x2013; http://queue.acm.org/detail.cfm?id=2927301
&#x2013; &quot;The Flame Graph&quot; CACM, June 2016 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-46-638.jpg?cb=1572382474"> 46. </a> Linux CPU Flame Graphs
Linux 2.6+, via perf:
Linux 4.9+, via BPF:
&#x2013; Most efficient: no perf.data file, summarizes in-kernel
git clone --depth 1 https://github.com/brendangregg/FlameGraph
cd FlameGraph
perf record -F 99 -a &#x2013;g -- sleep 30
perf script --header &gt; out.perf01
./stackcollapse-perf.pl &lt; out.perf01 |./flamegraph.pl &gt; perf.svg
git clone --depth 1 https://github.com/brendangregg/FlameGraph
git clone --depth 1 https://github.com/iovisor/bcc
./bcc/tools/profile.py -dF 99 30 | ./FlameGraph/flamegraph.pl &gt; perf.svg
These files can be read using FlameScope </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-47-638.jpg?cb=1572382474"> 47. </a> FlameScope
&#x25CF;
Analyze variance, perturbations
https://github.com/
Netflix/flamescope
Subsecond-offset heat map
Flame graph </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-48-638.jpg?cb=1572382474"> 48. </a> perf: Counters
&#x2022; Performance Monitoring Counters (PMCs):
&#x2022;
&#x2022; Measure instructions-per-cycle (IPC) and CPU stall types
&#x2022; PMCs only enabled for some cloud instance types
$ perf list | grep &#x2013;i hardware
cpu-cycles OR cycles [Hardware event]
stalled-cycles-frontend OR idle-cycles-frontend [Hardware event]
stalled-cycles-backend OR idle-cycles-backend [Hardware event]
instructions [Hardware event]
[&#x2026;]
L1-dcache-loads [Hardware cache event]
L1-dcache-load-misses [Hardware cache event]
[&#x2026;]
rNNN (see &apos;perf list --help&apos; on how to encode it) [Raw hardware event &#x2026;
mem:&lt;addr&gt;[:access] [Hardware breakpoint]
My front-ends, incl. pmcarch:
https://github.com/brendangregg/pmc-cloud-tools </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-49-638.jpg?cb=1572382474"> 49. </a> 5. Tracing </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-50-638.jpg?cb=1572382474"> 50. </a> Linux Tracing Events </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-51-638.jpg?cb=1572382474"> 51. </a> Tracing Stack
tracepoints, kprobes, uprobes
Ftrace, perf_events, BPF
perffront-end tools:
tracing frameworks:
back-end instrumentation:
trace-cmd, perf-tools, bcc, bpftraceadd-on tools:
in
Linux
BPF enables a new class of
custom, efficient, and production safe
performance analysis tools </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-52-638.jpg?cb=1572382474"> 52. </a> Ftrace: perf-tools funccount
&#x2022; Built-in kernel tracing capabilities, added by Steven
Rostedt and others since Linux 2.6.27
&#x2022; Also see trace-cmd
# ./funccount -i 1 &apos;bio_*&apos;
Tracing &quot;bio_*&quot;... Ctrl-C to end.
FUNC COUNT
[...]
bio_alloc_bioset 536
bio_endio 536
bio_free 536
bio_fs_destructor 536
bio_init 536
bio_integrity_enabled 536
bio_put 729
bio_add_page 1004 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-53-638.jpg?cb=1572382474"> 53. </a> perf: Tracing Tracepoints
http://www.brendangregg.com/perf.html
https://perf.wiki.kernel.org/index.php/Main_Page
# perf stat -e block:block_rq_complete -a sleep 10
Performance counter stats for &apos;system wide&apos;:
91 block:block_rq_complete
&#x25CF;
perf was introduced earlier; it is also a powerful tracer
# perf record -e block:block_rq_complete -a sleep 10
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.428 MB perf.data (~18687 samples) ]
# perf script
run 30339 [000] 2083345.722857: block:block_rq_complete: 202,1 W () 12986336 + 8 [0]
run 30339 [000] 2083345.723180: block:block_rq_complete: 202,1 W () 12986528 + 8 [0]
swapper 0 [000] 2083345.723489: block:block_rq_complete: 202,1 W () 12986496 + 8 [0]
swapper 0 [000] 2083346.745840: block:block_rq_complete: 202,1 WS () 1052984 + 144 [0]
supervise 30342 [000] 2083346.746571: block:block_rq_complete: 202,1 WS () 1053128 + 8 [0]
[...]
In-kernel counts (efficient)
Dump &amp; post-process </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-54-638.jpg?cb=1572382474"> 54. </a> BCC/BPF: ext4slower
&#x2022; ext4 operations slower than the threshold:
&#x2022; Better indicator of application pain than disk I/O
&#x2022; Measures &amp; filters in-kernel for efficiency using BPF
# ./ext4slower 1
Tracing ext4 operations slower than 1 ms
TIME COMM PID T BYTES OFF_KB LAT(ms) FILENAME
06:49:17 bash 3616 R 128 0 7.75 cksum
06:49:17 cksum 3616 R 39552 0 1.34 [
06:49:17 cksum 3616 R 96 0 5.36 2to3-2.7
06:49:17 cksum 3616 R 96 0 14.94 2to3-3.4
06:49:17 cksum 3616 R 10320 0 6.82 411toppm
06:49:17 cksum 3616 R 65536 0 4.01 a2p
06:49:17 cksum 3616 R 55400 0 8.77 ab
06:49:17 cksum 3616 R 36792 0 16.34 aclocal-1.14
[&#x2026;]
https://github.com/iovisor/bcc </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-55-638.jpg?cb=1572382474"> 55. </a> bpftrace: one-liners
&#x2022; Block I/O (disk) events by type; by size &amp; comm:
# bpftrace -e &apos;t:block:block_rq_issue { @[args-&gt;rwbs] = count(); }&apos;
Attaching 1 probe...
^C
@[WS]: 2
@[RM]: 12
@[RA]: 1609
@[R]: 86421
# bpftrace -e &apos;t:block:block_rq_issue { @bytes[comm] = hist(args-&gt;bytes); }&apos;
Attaching 1 probe...
^C
@bytes[dmcrypt_write]:
[4K, 8K) 68 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[8K, 16K) 35 |@@@@@@@@@@@@@@@@@@@@@@@@@@ |
[16K, 32K) 4 |@@@ |
[32K, 64K) 1 | |
[64K, 128K) 2 |@ |
[...]
https://github.com/iovisor/bpftrace </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-56-638.jpg?cb=1572382474"> 56. </a> BPF Perf
Tools
(2019)
BCC &amp; bpftrace repos
contain many of these.
The book has them all. </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-57-638.jpg?cb=1572382474"> 57. </a> Off-CPU Analysis
&#x2022; Explain all blocking events. High-overhead: needs BPF.
file read
from disk
directory read
from disk
pipe write
path read from disk
fstat from disk </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-58-638.jpg?cb=1572382474"> 58. </a> 6. Tuning </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-59-638.jpg?cb=1572382474"> 59. </a> &#x2022; CPU
schedtool &#x2013;B PID
disable Ubuntu apport (crash reporter)
upgrade to Bionic (scheduling improvements)
&#x2022; Virtual Memory
vm.swappiness = 0 # from 60
&#x2022; Memory
echo madvise &gt; /sys/kernel/mm/transparent_hugepage/enabled
kernel.numa_balancing = 0
&#x2022; File System
vm.dirty_ratio = 80 # from 40
vm.dirty_background_ratio = 5 # from 10
vm.dirty_expire_centisecs = 12000 # from 3000
mount -o defaults,noatime,discard,nobarrier &#x2026;
&#x2022; Storage I/O
/sys/block/*/queue/rq_affinity 1 # or 2
/sys/block/*/queue/scheduler kyber
/sys/block/*/queue/nr_requests 256
/sys/block/*/queue/read_ahead_kb 128
mdadm &#x2013;chunk=64 &#x2026;
Ubuntu Bionic Tuning: Late 2019 (1/2) </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-60-638.jpg?cb=1572382474"> 60. </a> Ubuntu Bionic Tuning: Late 2019 (2/2)
&#x2022; Networking
net.core.default_qdisc = fq
net.core.netdev_max_backlog = 5000
net.core.rmem_max = 16777216
net.core.somaxconn = 1024
net.core.wmem_max = 16777216
net.ipv4.ip_local_port_range = 10240 65535
net.ipv4.tcp_abort_on_overflow = 1 # maybe
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_rmem = 4096 12582912 16777216 # or 8388608 ...
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_wmem = 4096 12582912 16777216 # or 8388608 ...
&#x2022; Hypervisor
echo tsc &gt; /sys/devices/&#x2026;/current_clocksource
Plus use AWS Nitro
&#x2022; Other
net.core.bpf_jit_enable = 1
sysctl -w kernel.perf_event_max_stack=1000 </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-61-638.jpg?cb=1572382474"> 61. </a> Takeaways
Systems Performance is:
Observability, Methodologies, Benchmarking, Profiling, Tracing, Tuning
Print out for your office wall:
1. uptime
2. dmesg -T | tail
3. vmstat 1
4. mpstat -P ALL 1
5. pidstat 1
6. iostat -xz 1
7. free -m
8. sar -n DEV 1
9. sar -n TCP,ETCP 1
10. top </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-62-638.jpg?cb=1572382474"> 62. </a> Links
Netflix Tech Blog on Linux:
&#x25CF;
http://techblog.netflix.com/2015/11/linux-performance-analysis-in-60s.html
&#x25CF;
http://techblog.netflix.com/2015/08/netflix-at-velocity-2015-linux.html
Linux Performance:
&#x25CF;
http://www.brendangregg.com/linuxperf.html
Linux perf:
&#x25CF;
https://perf.wiki.kernel.org/index.php/Main_Page
&#x25CF;
http://www.brendangregg.com/perf.html
Linux ftrace:
&#x25CF;
https://www.kernel.org/doc/Documentation/trace/ftrace.txt
&#x25CF;
https://github.com/brendangregg/perf-tools
Linux BPF:
&#x25CF;
http://www.brendangregg.com/ebpf.html
&#x25CF;
http://www.brendangregg.com/bpf-performance-tools-book.html
&#x25CF;
https://github.com/iovisor/bcc
&#x25CF;
https://github.com/iovisor/bpftrace
Methodologies:
&#x25CF;
http://www.brendangregg.com/USEmethod/use-linux.html
&#x25CF;
http://www.brendangregg.com/activebenchmarking.html
Flame Graphs &amp; FlameScope:
&#x25CF;
http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html
&#x25CF;
http://queue.acm.org/detail.cfm?id=2927301
&#x25CF;
https://github.com/Netflix/flamescope
MSRs and PMCs
&#x25CF;
https://github.com/brendangregg/msr-cloud-tools
&#x25CF;
https://github.com/brendangregg/pmc-cloud-tools BPF Performance Tools </li> <li> <a href="https://image.slidesharecdn.com/lisa2019linuxsystemsperformance-191029205308/95/lisa2019-linux-systems-performance-63-638.jpg?cb=1572382474"> 63. </a> Thanks
&#x2022; Questions?
&#x2022; http://slideshare.net/brendangregg
&#x2022; http://www.brendangregg.com
&#x2022; bgregg@netflix.com
&#x2022; @brendangregg
Look out for 2nd
Ed.
USENIX LISA 2019, Portland, Oct 28-30 </li> </ol> </p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>