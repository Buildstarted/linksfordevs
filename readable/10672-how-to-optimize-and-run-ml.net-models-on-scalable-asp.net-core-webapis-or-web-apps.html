<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How to optimize and run ML.NET models on scalable ASP.NET Core WebAPIs or web apps -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>How to optimize and run ML.NET models on scalable ASP.NET Core WebAPIs or web apps</h1><div><div class="entry-content col-12 sharepostcontent"><h1 class="entry-title">How to optimize and run ML.NET models on scalable ASP.NET Core WebAPIs or web apps</h1><div class="row justify-content-center"><div class="col-md-4"><div><img src="https://secure.gravatar.com/avatar/e58f2727f49ef3410ff517abf0161683?s=58&amp;d=mm&amp;r=g" width="58" height="58" alt="Avatar" class="avatar avatar-58 wp-user-avatar wp-user-avatar-58 photo avatar-default"><p>Cesar</p></div></div></div><p>March 24th, 2019</p><h2><a id="user-content-context" class="anchor" aria-hidden="true" href="#context"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Context</h2><p>â€”â€”</p><p><strong>UPDATE on May 13th 2019: The recommended way to deploy/run an ML.NET model into ASP.NET Core web apps or WebAPI services is by using the â€˜Microsoft.Extensions.MLâ€™ Integration package. Read about it in this tutorial: </strong></p><p>â€“ <a href="https://docs.microsoft.com/en-us/dotnet/machine-learning/how-to-guides/serve-model-web-api-ml-net" rel="nofollow">Deploy an ML.NET model in an ASP.NET Core Web API</a></p><p>The tutorial above uses optimized code based on an <em>.NET Core Integration Package</em> comparable to integration packages targeting Entity Framework, SignalR, etc. so itâ€™s transparent and a lot easier for you than the explained blog post below.</p><p><strong>This article below was written before that mentioned integration package was created by Microsoft. It explains the reasons why some ML.NET classes can run as singleton and why the PredictionEngine (not threadsafe) needs more advanced deployment such as using object pooling.<br></strong></p><p>In fact, the code explained in this blog post is very similar to the final implementation of the Microsoft.Extensions.ML package which took it as a baseline for the official component.</p><p><strong>BUT YOU DONâ€™T NEED TO IMPLEMENT THIS BY YOURSELF SINCE WEâ€™RE TAKING CARE OF IT WITH THE .NET CORE INTEGRATION PACKAGE EXPLAINED IN THE ABOVE TUTORIALâ€™s LINK</strong></p><p>â€”â€”</p><p><strong>ML.NET model used</strong>: The ML.NET model used in this example is the  model you can train/create with the <a href="https://github.com/dotnet/machinelearning-samples/tree/master/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis">Sentiment Analysis Getting Started sample</a>. But for your convenience, that model is already serialized as a .zip file and already available in this sample code which only focuses on how to better run/score a model in scalable apps.</p><p><strong>Model running on WebAPI</strong>: Although the ML scenario is not really important in this case (execution optimization), the sample implemented is about running a Sentiment Analysis model on a WebAPI, as show in the following image:</p><p><img src="https://github.com/CESARDELATORRE/MLNET-Posts/raw/master/Posts/001-Running-MLNET-Models-in-ASPNETCore/images/Browser-WebAPI-screenshot.png" alt="alt text" title="Browser with model execution screenshot"></p><p>If the provided text in the URL â€˜sentimentTextâ€™ parameter was rude, then the % of toxicity would be he high.</p><p><strong>Show me the code!</strong>: The sample WebAPI and code explained in this blog post is published <a href="https://github.com/dotnet/machinelearning-samples/tree/master/samples/csharp/end-to-end-apps/ScalableMLModelOnWebAPI">here as an ML.NET Sample</a></p><h1><a id="user-content-goal" class="anchor" aria-hidden="true" href="#goal"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Goal</h1><p><strong>The goal is to be able to make predictions with an ML.NET model while optimizing the executions by sharing objects across Http requests and implementing code which should be very easy to use/consume by the user when predicting</strong>, like the following line of code that you could write on any ASP.NET Core controllerâ€™s method or custom service class:</p><div id="crayon-5e3a42da44571462584108" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">SamplePrediction prediction = _modelEngine.Predict(sampleData);</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><p class="crayon-num" data-line="crayon-5e3a42da44571462584108-1">1</p></td><td class="crayon-code"><p class="crayon-line" id="crayon-5e3a42da44571462584108-1"><span class="crayon-e">SamplePrediction </span><span class="crayon-i">prediction</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">_modelEngine</span><span class="crayon-sy">.</span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-i">sampleData</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></td></tr></tbody></table></div></div><p>Thatâ€™s it. Very simple. A single line. The object _modelEngine will be injected into your WebAPI controllerâ€™s constructor or into your custom class, so you just need to use it.</p><p>Internally, it will be optimized so the object dependencies are cached and shared across Http requests with minimized overhead when creating those objects.</p><h1><a id="user-content-background-on-scalable-and-multithreaded-aspnet-core-services-and-apps" class="anchor" aria-hidden="true" href="#background-on-scalable-and-multithreaded-aspnet-core-services-and-apps"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Background on scalable and multithreaded ASP.NET Core services and apps</h1><p>ASP.NET Core services and apps are multithreaded applications so they can serve many HTTP requests at the same time.</p><p>.NET Core provides a managed thread pool that is managed by the system. As a developer, you donâ€™t need to deal with the thread management.</p><p>As shown in the simplified image below, and ASP.NET Core WebAPI or web app accepts many Http requests which will be handled by that thread pool.</p><p><img src="https://github.com/CESARDELATORRE/MLNET-Posts/raw/master/Posts/001-Running-MLNET-Models-in-ASPNETCore/images/Simplified-threading-in-ASPNETCore-app.png" alt="alt text" title="Multi-threads in ASP.NET Core apps"></p><p>The specifics of the architecture are not exactly the same if you deploy your application into <em>IIS</em> or selfhosted by using <em>Kestrel</em>, but those differences are not important in this case.</p><p>The bottom line here is that when writing code for a multithreaded application such as ASP.NET Core services or apps <strong>your code and objects used in your code need to be <em>thread-safe</em> if the same object is going to be shared across multiple threads while updating data in-memory</strong>. The reason is because if you update data within the same shared object from multiple threads, those multiple threads can access to the same address space at the same time. So, they can write to the exact same memory location at the same time causing data corruption and application mal-function.</p><p>A code is called <em>thread-safe</em> if it is being called from multiple threads concurrently without the breaking of functionalities.</p><h3><a id="user-content-this-is-usually-not-a-problem-in-regular-aspnet-core-apps" class="anchor" aria-hidden="true" href="#this-is-usually-not-a-problem-in-regular-aspnet-core-apps"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>This is usually not a problem in regular ASP.NET Core apps</h3><p>Usually, most of the code and objects you use in an ASP.NET Core WebAPI or app, for instance, objects you instanciate in a controller, are not shared across Http requests because the most common pattern is to use objects you create for each Http requests scope, either with <code>new</code> or with <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-2.2#service-lifetimes" rel="nofollow">transient lifetime</a> when using dependency injection in .NET Core, as shown in the following image. Not a problem here:</p><p><img src="https://github.com/CESARDELATORRE/MLNET-Posts/raw/master/Posts/001-Running-MLNET-Models-in-ASPNETCore/images/Transient-Objects-in-ASPNETCore-app.png" alt="alt text" title="Multi-threads in ASP.NET Core apps"></p><p>However, issues can happen if you share objects across threads, for example by using <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/static-classes-and-static-class-members#static-members" rel="nofollow">static member variables</a> or <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-2.2#service-lifetimes" rel="nofollow">singleton lifetime</a> objects in Dependency Injection, as explained later on in this post.</p><h1><a id="user-content-minimum-c-code-needed-to-run-an-mlnet-model-to-make-a-single-prediction" class="anchor" aria-hidden="true" href="#minimum-c-code-needed-to-run-an-mlnet-model-to-make-a-single-prediction"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Minimum C# code needed to run an ML.NET model to make a single prediction</h1><p>As you can check out on may ML.NET getting started samples at the <a href="https://github.com/dotnet/machinelearning-samples">ML.NET Samples GitHub repo</a>, the basic code you need for loading an already trained and serialized ML.NET model and do a single prediction with it (usually called â€˜ML model scoring codeâ€™), is the following:</p><div id="crayon-5e3a42da44588397708248" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">// (*Expensive*) Load ML model from serialized .zip file 
ITransformer mlModel;
using (var stream = new FileStream(modelFilePath, FileMode.Open, FileAccess.Read, FileShare.Read))
{
    mlModel = mlContext.Model.Load(stream);
}

// Create sample data to do a single prediction with it 
SampleObservation sampleData = CreateMySingleDataSample();

// (*Expensive*) Create Prediction Engine
var predictionEngine = mlModel.CreatePredictionEngine&lt;SampleObservation, SamplePrediction&gt;(mlContext);

// Try a single prediction
SamplePrediction predictionResult = predictionEngine.Predict(sampleData);</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da44588397708248-1"><span class="crayon-c">// (*Expensive*) Load ML model from serialized .zip file </span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-2"><span class="crayon-e">ITransformer </span><span class="crayon-i">mlModel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-3"><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">stream</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">FileStream</span><span class="crayon-sy">(</span><span class="crayon-i">modelFilePath</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">FileMode</span><span class="crayon-sy">.</span><span class="crayon-i">Open</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">FileAccess</span><span class="crayon-sy">.</span><span class="crayon-i">Read</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">FileShare</span><span class="crayon-sy">.</span><span class="crayon-i">Read</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-4"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">mlModel</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">mlContext</span><span class="crayon-sy">.</span><span class="crayon-i">Model</span><span class="crayon-sy">.</span><span class="crayon-e">Load</span><span class="crayon-sy">(</span><span class="crayon-i">stream</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-6"><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-8"><span class="crayon-c">// Create sample data to do a single prediction with it </span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-9"><span class="crayon-e">SampleObservation </span><span class="crayon-i">sampleData</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-e">CreateMySingleDataSample</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-11"><span class="crayon-c">// (*Expensive*) Create Prediction Engine</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-12"><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">mlModel</span><span class="crayon-sy">.</span><span class="crayon-i">CreatePredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">SampleObservation</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">SamplePrediction</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">mlContext</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-14"><span class="crayon-c">// Try a single prediction</span></p><p class="crayon-line" id="crayon-5e3a42da44588397708248-15"><span class="crayon-e">SamplePrediction </span><span class="crayon-i">predictionResult</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-sy">.</span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-i">sampleData</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></tbody></table></div></div><p>This code looks very atraightforward and simple to use. If you just copy that code and run it on any application (console, desktop, web, etc.) itâ€™ll work okay.</p><p>However, the lines of code marked with <code>(*Expensive*)</code> in the comments are object instantiations that are significantly â€˜expensiveâ€™, meaning that it takes significant time to execute such as a few hundred miliseconds per each call if usign small models (i.e. half a second), but that can increase significantly depending on the size of the ML model.</p><h2><a id="user-content-you-need-to-improve-your-mlnet-model-scoring-code-when-targeting-scalable-apps" class="anchor" aria-hidden="true" href="#you-need-to-improve-your-mlnet-model-scoring-code-when-targeting-scalable-apps"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>You need to improve your ML.NET model scoring code when targeting scalable apps</h2><p>As you would initially think, improving that execution for a multi-threaded application that will run multiple predictions could be as simple as â€˜cachingâ€™ the ML model (<code>ITransformer</code>) object and the <code>PredictionEngine</code> object, so those objects are instantiaated just once and shared across the upcoming requests, right?</p><p>Well, that is partially true, but there are important caveats here and this is the reason why I created this blog post, precisely. ðŸ˜‰</p><h1><a id="user-content-sharing-the-ml-model-itransformer-across-http-requests-in-aspnet-core" class="anchor" aria-hidden="true" href="#sharing-the-ml-model-itransformer-across-http-requests-in-aspnet-core"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Approach A: Sharing the ML model (ITransformer) across HTTP requests in ASP.NET Core</h1><p>Therefore, the first optimization you could do would be to cache in memory the ML model object that you loaded from the .zip file, so it can be re-used across many Http requests.</p><p>Since the <strong>ML model (ITransformer) object is <em>thread-safe</em></strong>, this is not an issue and can be done very easily.</p><p>The recommended way to share the ITransfomer object across Http requests is to register it as <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-2.2#service-lifetimes" rel="nofollow">singleton lifetime</a> object in your IoC container for Dependency Injection usage, as shown in the code below:</p><div id="crayon-5e3a42da44596399022293" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">Startup.cs

public void ConfigureServices(IServiceCollection services)
{
    //..Other code..

    // Register Types in IoC container for DI

    //MLContext created as singleton for the whole ASP.NET Core app
    services.AddSingleton&lt;MLContext&gt;();

    //ML Model (ITransformed) created as singleton for the whole ASP.NET Core app. Loads from .zip file here.
    services.AddSingleton&lt;ITransformer,
                            TransformerChain&lt;ITransformer&gt;&gt; ((ctx) =&gt;
                        {
                            MLContext mlContext = ctx.GetRequiredService&lt;MLContext&gt;();
                            string modelFilePathName = Configuration["MLModel:MLModelFilePath"];

                            ITransformer mlModel;
                            using (var fileStream = File.OpenRead(modelFilePathName))
                                mlModel = mlContext.Model.Load(fileStream);

                            return (TransformerChain&lt;ITransformer&gt;) mlModel;
                        });
    //..Other code..
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-1">1</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-2">2</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-3">3</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-4">4</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-5">5</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-6">6</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-7">7</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-8">8</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-9">9</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-10">10</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-11">11</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-12">12</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-13">13</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-14">14</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-15">15</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-16">16</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-17">17</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-18">18</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-19">19</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-20">20</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-21">21</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-22">22</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-23">23</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-24">24</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-25">25</p><p class="crayon-num" data-line="crayon-5e3a42da44596399022293-26">26</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da44596399022293-1"><span class="crayon-i">Startup</span><span class="crayon-sy">.</span><span class="crayon-e">cs</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-3"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">ConfigureServices</span><span class="crayon-sy">(</span><span class="crayon-e">IServiceCollection </span><span class="crayon-i">services</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-4"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//..Other code..</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Register Types in IoC container for DI</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//MLContext created as singleton for the whole ASP.NET Core app</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">services</span><span class="crayon-sy">.</span><span class="crayon-i">AddSingleton</span><span class="crayon-h">&lt;</span><span class="crayon-i">MLContext</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//ML Model (ITransformed) created as singleton for the whole ASP.NET Core app. Loads from .zip file here.</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">services</span><span class="crayon-sy">.</span><span class="crayon-i">AddSingleton</span><span class="crayon-h">&lt;</span><span class="crayon-i">ITransformer</span><span class="crayon-sy">,</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">TransformerChain</span><span class="crayon-h">&lt;</span><span class="crayon-i">ITransformer</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-i">ctx</span><span class="crayon-sy">)</span><span class="crayon-h"></span>=<span class="crayon-h">&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">MLContext </span><span class="crayon-i">mlContext</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">ctx</span><span class="crayon-sy">.</span><span class="crayon-i">GetRequiredService</span><span class="crayon-h">&lt;</span><span class="crayon-i">MLContext</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">modelFilePathName</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">Configuration</span><span class="crayon-sy">[</span><span class="crayon-s">"MLModel:MLModelFilePath"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">ITransformer </span><span class="crayon-i">mlModel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">fileStream</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">File</span><span class="crayon-sy">.</span><span class="crayon-e">OpenRead</span><span class="crayon-sy">(</span><span class="crayon-i">modelFilePathName</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">mlModel</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">mlContext</span><span class="crayon-sy">.</span><span class="crayon-i">Model</span><span class="crayon-sy">.</span><span class="crayon-e">Load</span><span class="crayon-sy">(</span><span class="crayon-i">fileStream</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-i">TransformerChain</span><span class="crayon-h">&lt;</span><span class="crayon-i">ITransformer</span><span class="crayon-h">&gt;</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-i">mlModel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//..Other code..</span></p><p class="crayon-line" id="crayon-5e3a42da44596399022293-26"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Okay, that would be ready for you so you can inject and use the ML model (ITransformer) object on any object, for instance, by injecting it into any controllerâ€™s constructor, like in the following code:</p><div id="crayon-5e3a42da445a3739671300" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">MyController.cs

[Route("api/[controller]")]
[ApiController]
public class MyController : ControllerBase
{
    private readonly MLContext _mlContext;
    private readonly ITransformer _mlModel;
    
    public MyController(MLContext mlContext, ITransformer mlModel)
    {
        // Get the injected objects
        _mlContext = mlContext;
        _mlModel = mlModel;
    }

    //...Other code using the ML model (ITransformer) object...
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-1">1</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-2">2</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-3">3</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-4">4</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-5">5</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-6">6</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-7">7</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-8">8</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-9">9</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-10">10</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-11">11</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-12">12</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-13">13</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-14">14</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-15">15</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-16">16</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-17">17</p><p class="crayon-num" data-line="crayon-5e3a42da445a3739671300-18">18</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da445a3739671300-1"><span class="crayon-i">MyController</span><span class="crayon-sy">.</span><span class="crayon-i">cs</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-3"><span class="crayon-sy">[</span><span class="crayon-e">Route</span><span class="crayon-sy">(</span><span class="crayon-s">"api/[controller]"</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-4"><span class="crayon-sy">[</span><span class="crayon-i">ApiController</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-5"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-i">MyController</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-e">ControllerBase</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-6"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-e">MLContext </span><span class="crayon-i">_mlContext</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-e">ITransformer </span><span class="crayon-i">_mlModel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">MyController</span><span class="crayon-sy">(</span><span class="crayon-e">MLContext </span><span class="crayon-i">mlContext</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-e">ITransformer </span><span class="crayon-i">mlModel</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Get the injected objects</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_mlContext</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">mlContext</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_mlModel</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">mlModel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//...Other code using the ML model (ITransformer) object...</span></p><p class="crayon-line" id="crayon-5e3a42da445a3739671300-18"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>If later on, you create a <code>PredictionEngine</code> object whenever you need to call <code>predictionEngine.Predict()</code>, either by explicitely creating it with <code>new</code> or registering it as <code>Transient</code> lifetime, that would be safe in ASP.NET Core.</p><p>This is approximately the approach taken by this ML.NET tutorial named <a href="https://docs.microsoft.com/en-us/dotnet/machine-learning/how-to-guides/serve-model-web-api-ml-net" rel="nofollow">How-To: Serve Machine Learning Model Through ASP.NET Core Web API</a></p><p>However, you can do a lot better because with that initial approach it wonâ€™t be fully optimized since whenever you get an Http request youâ€™ll be creating a new <code>PredictionEngine</code> object which, as previously mentioned, is also a pretty â€˜expensiveâ€™ operation for scalable applications.</p><p>For achieving better performance in your application when predicting simultaneosuly from multiple threads (like when you handle multiple Http requests from many users) you will need, somehow, to cache the <code>PredictionEngine</code> object. But as mentioned, there are important caveats and problems here to solve.</p><h1><a id="user-content-approach-b-sharing-predictionengine-objects-object-pooling-based-across-http-requests-in-aspnet-core" class="anchor" aria-hidden="true" href="#approach-b-sharing-predictionengine-objects-object-pooling-based-across-http-requests-in-aspnet-core"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Approach B: Sharing PredictionEngine objects (Object Pooling based) across HTTP requests in ASP.NET Core</h1><p>This approach requires some more coding and complexity (Object Pooling) for several reasons. So, before talking about its design and related implementation, letâ€™s talk about the problem to solve.</p><h2><a id="user-content-the-problem-when-runningscoring-an-mlnet-model-in-multi-threaded-applications" class="anchor" aria-hidden="true" href="#the-problem-when-runningscoring-an-mlnet-model-in-multi-threaded-applications"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The problem when running/scoring an ML.NET model in multi-threaded applications</h2><p>The problem when running/scoring an ML.NET model in multi-threaded applications comes when you want to do single predictions with the PredictionEngine object and you want to cache that object (i.e. as Singleton) so it is being reused by multiple Http requests (therefore it would be accessed by multiple threads). Thatâ€™s is a problem because <strong>the Prediction Engine is not thread-safe</strong> (<a href="https://github.com/dotnet/machinelearning/issues/1718">ML.NET issue, Nov 2018</a>).</p><p>Hereâ€™s a diagram showing the important ML.NET classes you need to use, the dependecies between them and what kind of object lifetimes are recommended:</p><p><img src="https://github.com/CESARDELATORRE/MLNET-Posts/raw/master/Posts/001-Running-MLNET-Models-in-ASPNETCore/images/MLNET-classes-dependencies-for-scoring.png" alt="alt text" title="ML.NET classes dependencies for scoring code with prediction engine"></p><p>If you register the Prediction Engine object as Singleton or Static, you will get into trouble because it is not thread-safe.</p><p>You could then think, okay, letâ€™s make it static while thread-safe with the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threadstaticattribute?view=netcore-2.2" rel="nofollow">[ThreadStatic] attribute</a>? â€“ Well, using the <code>[ThreadStatic]</code> attribute in ASP.NET apps is pretty dangerous. It might initially look that it is working, but write some async code (async/await) in your code and itâ€™ll probably stop working. Also, the mainstream approach for objectâ€™s lifetime in ASP.NET Core is to use DI (Dependency Injection). Using static objects usage sometimes and DI other times would be very confusing, as well.</p><p>If you want to learn more about it, see <a href="https://github.com/aspnet/AspNetCore/issues/1371">this discussion with David Fowler</a> recommending not to use <code>[ThreadStatic]</code> in ASP.NET Core apps.</p><p>Other possible approaches could be to use <a href="https://docs.microsoft.com/en-us/dotnet/standard/threading/overview-of-synchronization-primitives" rel="nofollow">multi-threading synchronization primitives</a> such as <em>critical sections</em>, <em>locks</em>, <em>mutex</em>, etc., but those locks would create a bottleneck in your code which wonâ€™t be optimized for high-scalable scenarios.</p><h2><a id="user-content-the-solution-use-object-pooling-for-predictionengine-objects" class="anchor" aria-hidden="true" href="#the-solution-use-object-pooling-for-predictionengine-objects"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The solution: Use Object Pooling for PredictionEngine objects</h2><p>Since a PredictionEngine object cannot be singleton because it is not â€˜thread safeâ€™, a good solution for being able to have â€˜ready to useâ€™ PredictionEngine objects  is to use an object pooling-based approach.</p><p>When it is necessary to work with a number of objects that are particularly expensive to instantiate and each object is only needed for a short period of time, the performance of an entire application may be adversely affected. This issue will happen if you instantiate a Prediction Engine object whenever you get an Http request.</p><p>An object pool design pattern can be very effective in such cases.</p><p>The <a href="https://en.wikipedia.org/wiki/Object_pool_pattern" rel="nofollow">object pool pattern</a> is a design pattern that uses a set of initialized objects kept ready to use (a â€˜poolâ€™) rather than allocating and destroying them on demand.</p><p>This â€˜pooling strategy; is also applicable to othe â€˜expensive creation resourcesâ€™ like database connections and connection pool solution.</p><p>The solutionâ€™s implementation is based on a higher level class (named MLModelEngine) which is instantiated as singleton and creates the needed infrastructure for such an object pool solution, as shown in the following diagram.</p><p><img src="https://github.com/CESARDELATORRE/MLNET-Posts/raw/master/Posts/001-Running-MLNET-Models-in-ASPNETCore/images/MLModelEngine-class-Diagram.png" alt="alt text" title="MLModelEngine class diagram"></p><p>This approach achieves the original goal mentioned at the begining of this article by offering a very simple interface for making predictions: <code>.Predict()</code>, like the following line of code that you could write on any ASP.NET Core controllerâ€™s method or custom service class:</p><div id="crayon-5e3a42da445b1116475310" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">SamplePrediction prediction = _modelEngine.Predict(sampleData);</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><p class="crayon-num" data-line="crayon-5e3a42da445b1116475310-1">1</p></td><td class="crayon-code"><p class="crayon-line" id="crayon-5e3a42da445b1116475310-1"><span class="crayon-e">SamplePrediction </span><span class="crayon-i">prediction</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">_modelEngine</span><span class="crayon-sy">.</span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-i">sampleData</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></td></tr></tbody></table></div></div><h2><a id="user-content-implementing-the-mlmodelengine-and-object-pool" class="anchor" aria-hidden="true" href="#implementing-the-mlmodelengine-and-object-pool"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implementing the MLModelEngine and object pool</h2><p>The class MLModelEngine has three main member objects:</p><ul><li><code>MLContext</code> member object.<ul><li>Singleton, since MLModelEngine will be used as singleton</li></ul></li><li><code>ITransformer</code> member object. This is the ML model.<ul><li>Singleton, since MLModelEngine will be used as singleton</li></ul></li><li><code>ObjectPool&lt;PredictionEngine&gt;</code> member object: Object Pool of PredictionEngine objects.<ul><li>The ObjectPool is singleton, but each PredictionEngine within the pool will only be used by one thread when needed, then will be returned to the pool when the prediction is done.</li></ul></li></ul><p>The MLModelEngine class implementation is as follows:</p><div id="crayon-5e3a42da445bf036080010" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">MLModelEngine.cs

public class MLModelEngine&lt;TData, TPrediction&gt; : IMLModelEngine&lt;TData, TPrediction&gt;
                where TData : class
                where TPrediction : class, new()
{
    private readonly MLContext _mlContext;
    private readonly ITransformer _mlModel;
    private readonly ObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt; _predictionEnginePool;
    private readonly int _maxObjectsRetained;

    /// &lt;summary&gt;
    /// Exposing the ML model allowing additional ITransformer operations such as Bulk predictions', etc.
    /// &lt;/summary&gt;
    public ITransformer MLModel
    {
        get =&gt; _mlModel;
    }

    /// &lt;summary&gt;
    /// Constructor with modelFilePathName to load from
    /// &lt;/summary&gt;
    public MLModelEngine(string modelFilePathName, int maxObjectsRetained = -1)
    {
        //Create the MLContext object to use under the scope of this class 
        _mlContext = new MLContext();

        //Load the ProductSalesForecast model from the .ZIP file
        using (var fileStream = File.OpenRead(modelFilePathName))
        {
            _mlModel = _mlContext.Model.Load(fileStream);
        }

        _maxObjectsRetained = maxObjectsRetained;

        //Create PredictionEngine Object Pool
        _predictionEnginePool = CreatePredictionEngineObjectPool();
    }

    private ObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt; CreatePredictionEngineObjectPool()
    {
        var predEnginePolicy = new PooledPredictionEnginePolicy&lt;TData, TPrediction&gt;(_mlContext, _mlModel);

        DefaultObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt; pool;

        if (_maxObjectsRetained != -1)
        {
            pool = new DefaultObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt;(predEnginePolicy, _maxObjectsRetained);
        }
        else
        {
            //default maximumRetained is Environment.ProcessorCount * 2, if not explicitly provided
            pool = new DefaultObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt;(predEnginePolicy);
        }

        return pool;
    }

    public TPrediction Predict(TData dataSample)
    {
        //Get PredictionEngine object from the Object Pool
        PredictionEngine&lt;TData, TPrediction&gt; predictionEngine = _predictionEnginePool.Get();

        try
        {
            //Predict
            TPrediction prediction = predictionEngine.Predict(dataSample);
            return prediction;
        }
        finally
        {
            //Release used PredictionEngine object into the Object Pool
            _predictionEnginePool.Return(predictionEngine);
        }
    }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-1">1</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-2">2</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-3">3</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-4">4</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-5">5</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-6">6</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-7">7</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-8">8</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-9">9</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-10">10</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-11">11</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-12">12</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-13">13</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-14">14</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-15">15</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-16">16</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-17">17</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-18">18</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-19">19</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-20">20</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-21">21</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-22">22</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-23">23</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-24">24</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-25">25</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-26">26</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-27">27</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-28">28</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-29">29</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-30">30</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-31">31</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-32">32</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-33">33</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-34">34</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-35">35</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-36">36</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-37">37</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-38">38</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-39">39</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-40">40</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-41">41</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-42">42</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-43">43</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-44">44</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-45">45</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-46">46</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-47">47</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-48">48</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-49">49</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-50">50</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-51">51</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-52">52</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-53">53</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-54">54</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-55">55</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-56">56</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-57">57</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-58">58</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-59">59</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-60">60</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-61">61</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-62">62</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-63">63</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-64">64</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-65">65</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-66">66</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-67">67</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-68">68</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-69">69</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-70">70</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-71">71</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-72">72</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-73">73</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-74">74</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-75">75</p><p class="crayon-num" data-line="crayon-5e3a42da445bf036080010-76">76</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da445bf036080010-1"><span class="crayon-i">MLModelEngine</span><span class="crayon-sy">.</span><span class="crayon-e">cs</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-3"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-i">MLModelEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-i">IMLModelEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">where </span><span class="crayon-i">TData</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-t">class</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">where </span><span class="crayon-i">TPrediction</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-6"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-e">MLContext </span><span class="crayon-i">_mlContext</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-e">ITransformer </span><span class="crayon-i">_mlModel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-i">ObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">_predictionEnginePool</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-i">_maxObjectsRetained</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/// &lt;summary&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/// Exposing the ML model allowing additional ITransformer operations such as Bulk predictions', etc.</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/// &lt;/summary&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">ITransformer</span><span class="crayon-h"></span><span class="crayon-e">MLModel</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">get</span><span class="crayon-h"></span>=<span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">_mlModel</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/// &lt;summary&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/// Constructor with modelFilePathName to load from</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">/// &lt;/summary&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">MLModelEngine</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">modelFilePathName</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-i">maxObjectsRetained</span><span class="crayon-h"></span>=<span class="crayon-h"></span>-<span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Create the MLContext object to use under the scope of this class </span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_mlContext</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">MLContext</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Load the ProductSalesForecast model from the .ZIP file</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">fileStream</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">File</span><span class="crayon-sy">.</span><span class="crayon-e">OpenRead</span><span class="crayon-sy">(</span><span class="crayon-i">modelFilePathName</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_mlModel</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">_mlContext</span><span class="crayon-sy">.</span><span class="crayon-i">Model</span><span class="crayon-sy">.</span><span class="crayon-e">Load</span><span class="crayon-sy">(</span><span class="crayon-i">fileStream</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_maxObjectsRetained</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">maxObjectsRetained</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Create PredictionEngine Object Pool</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_predictionEnginePool</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-e">CreatePredictionEngineObjectPool</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-i">ObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">CreatePredictionEngineObjectPool</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">predEnginePolicy</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-i">PooledPredictionEnginePolicy</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">_mlContext</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">_mlModel</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">DefaultObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">pool</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-i">_maxObjectsRetained</span><span class="crayon-h"></span><span class="crayon-sy">!</span>=<span class="crayon-h"></span>-<span class="crayon-cn">1</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-47"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">pool</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-i">DefaultObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">predEnginePolicy</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">_maxObjectsRetained</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//default maximumRetained is Environment.ProcessorCount * 2, if not explicitly provided</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-53"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">pool</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-i">DefaultObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">predEnginePolicy</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-56"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-i">pool</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-57"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-59"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">TPrediction </span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-e">TData </span><span class="crayon-i">dataSample</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-60"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-61"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Get PredictionEngine object from the Object Pool</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-62"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">_predictionEnginePool</span><span class="crayon-sy">.</span><span class="crayon-e">Get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-64"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">try</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-65"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-66"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Predict</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-67"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">TPrediction </span><span class="crayon-i">prediction</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-sy">.</span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-i">dataSample</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-i">prediction</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-69"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-70"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">finally</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-71"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-72"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Release used PredictionEngine object into the Object Pool</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-73"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_predictionEnginePool</span><span class="crayon-sy">.</span><span class="crayon-st">Return</span><span class="crayon-sy">(</span><span class="crayon-i">predictionEngine</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-74"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-75"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445bf036080010-76"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Whatâ€™s related to the MLContext and ITransformer objects is pretty straightforward. The â€˜special codeâ€™ here is related to the Object Pool.</p><h3><a id="user-content-object-pool-implementation-objectpool" class="anchor" aria-hidden="true" href="#object-pool-implementation-objectpool"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Object Pool implementation: ObjectPool</h3><p>The implementation of the object pool is not using a custom object pool approach but an official class provided by Microsoft in the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.objectpool" rel="nofollow">Microsoft.Extensions.ObjectPool namespace</a> which is part of .NET Core.</p><p>The object pool class used is the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.objectpool.objectpool-1" rel="nofollow">ObjectPool</a>, so we can use it as:</p><div id="crayon-5e3a42da445cd109255857" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">ObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt; _predictionEnginePool;</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><p class="crayon-num" data-line="crayon-5e3a42da445cd109255857-1">1</p></td><td class="crayon-code"><p class="crayon-line" id="crayon-5e3a42da445cd109255857-1"><span class="crayon-i">ObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">_predictionEnginePool</span><span class="crayon-sy">;</span></p></td></tr></tbody></table></div></div><p>Meaning an object pool of <code>PredictionEngine</code> objects using generics so you can provide your particular <code>SampleObservation</code> and <code>SamplePrediction</code> data classes.</p><p>The object pool usage is pretty straightforward in the Predict() method:</p><div id="crayon-5e3a42da445e0160441135" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">public TPrediction Predict(TData dataSample)
{
    //Get PredictionEngine object from the Object Pool
    PredictionEngine&lt;TData, TPrediction&gt; predictionEngine = _predictionEnginePool.Get();

    try
    {
        //Predict
        TPrediction prediction = predictionEngine.Predict(dataSample);
        return prediction;
    }
    finally
    {
        //Release used PredictionEngine object into the Object Pool
        _predictionEnginePool.Return(predictionEngine);
    }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-1">1</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-2">2</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-3">3</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-4">4</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-5">5</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-6">6</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-7">7</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-8">8</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-9">9</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-10">10</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-11">11</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-12">12</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-13">13</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-14">14</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-15">15</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-16">16</p><p class="crayon-num" data-line="crayon-5e3a42da445e0160441135-17">17</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da445e0160441135-1"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">TPrediction </span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-e">TData </span><span class="crayon-i">dataSample</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Get PredictionEngine object from the Object Pool</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">_predictionEnginePool</span><span class="crayon-sy">.</span><span class="crayon-e">Get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">try</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Predict</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">TPrediction </span><span class="crayon-i">prediction</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-sy">.</span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-i">dataSample</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-i">prediction</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">finally</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Release used PredictionEngine object into the Object Pool</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_predictionEnginePool</span><span class="crayon-sy">.</span><span class="crayon-st">Return</span><span class="crayon-sy">(</span><span class="crayon-i">predictionEngine</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445e0160441135-17"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Basically, whenever the Predict() method is called, you take a PredictionEngine from the pool, use it to predict and then return it to the pool so it is available for any upcoming request.</p><p>If thereâ€™s not any PredictionEngine object available in the pool (that will happen the first time you use the pool or if under pressure with many Http requests), then the pool needs to create a PredictionEngine object.</p><p>Basically, you have now to solve the following question:</p><p><em>â€œHow do you tell the object pool how the PredictionEngine object has to be created whenever a new instance is needed in the object pool?â€</em></p><p>You do that by using an ObjectPool <em>Policy</em> specified when creating the object pool in the <code>CreatePredictionEngineObjectPool()</code> method which is run once from the constructor, as in the following simplified code:</p><div id="crayon-5e3a42da445ee288476983" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">private ObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt; CreatePredictionEngineObjectPool()
{
    var predEnginePolicy = new PooledPredictionEnginePolicy&lt;TData, TPrediction&gt;(_mlContext, _mlModel);

    var pool  = new DefaultObjectPool&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt;(predEnginePolicy);
    
    return pool;
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da445ee288476983-1"><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-i">ObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">CreatePredictionEngineObjectPool</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445ee288476983-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445ee288476983-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">predEnginePolicy</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-i">PooledPredictionEnginePolicy</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">_mlContext</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">_mlModel</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445ee288476983-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">pool</span><span class="crayon-h">&nbsp;&nbsp;</span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-i">DefaultObjectPool</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">predEnginePolicy</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445ee288476983-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-i">pool</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445ee288476983-8"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Then, in the Policy class you define how the PredictionEngine will be created, which is by invoking our â€˜well knownâ€™ <code>ITransformer.CreatePredictionEngine()</code> method:</p><div id="crayon-5e3a42da445fb612601911" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">public class PooledPredictionEnginePolicy&lt;TData, TPrediction&gt; : IPooledObjectPolicy&lt;PredictionEngine&lt;TData, TPrediction&gt;&gt;
                where TData : class
                where TPrediction : class, new()
{
    private readonly MLContext _mlContext;
    private readonly ITransformer _model;
    public PooledPredictionEnginePolicy(MLContext mlContext, ITransformer model)
    {
        _mlContext = mlContext;
        _model = model;
    }

    public PredictionEngine&lt;TData, TPrediction&gt; Create()
    {
        var predictionEngine = _model.CreatePredictionEngine&lt;TData, TPrediction&gt;(_mlContext);

        return predictionEngine;
    }

    public bool Return(PredictionEngine&lt;TData, TPrediction&gt; obj)
    {
        if (obj == null)
            return false;

        return true;
    }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-1">1</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-2">2</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-3">3</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-4">4</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-5">5</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-6">6</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-7">7</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-8">8</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-9">9</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-10">10</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-11">11</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-12">12</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-13">13</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-14">14</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-15">15</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-16">16</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-17">17</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-18">18</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-19">19</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-20">20</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-21">21</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-22">22</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-23">23</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-24">24</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-25">25</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-26">26</p><p class="crayon-num" data-line="crayon-5e3a42da445fb612601911-27">27</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da445fb612601911-1"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-i">PooledPredictionEnginePolicy</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-i">IPooledObjectPolicy</span><span class="crayon-h">&lt;</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">where </span><span class="crayon-i">TData</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-t">class</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">where </span><span class="crayon-i">TPrediction</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-4"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-e">MLContext </span><span class="crayon-i">_mlContext</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-e">ITransformer </span><span class="crayon-i">_model</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">PooledPredictionEnginePolicy</span><span class="crayon-sy">(</span><span class="crayon-e">MLContext </span><span class="crayon-i">mlContext</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-e">ITransformer </span><span class="crayon-i">model</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_mlContext</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">mlContext</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_model</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">model</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">Create</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">_model</span><span class="crayon-sy">.</span><span class="crayon-i">CreatePredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">_mlContext</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-i">predictionEngine</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">bool</span><span class="crayon-h"></span><span class="crayon-st">Return</span><span class="crayon-sy">(</span><span class="crayon-i">PredictionEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">TData</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">TPrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">obj</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-i">obj</span><span class="crayon-h"></span>==<span class="crayon-h"></span><span class="crayon-t">null</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-t">false</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-t">true</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da445fb612601911-27"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><h2><a id="user-content-registering-the-mlmodelengine-class-as-singleton-for-di-dependency-injection" class="anchor" aria-hidden="true" href="#registering-the-mlmodelengine-class-as-singleton-for-di-dependency-injection"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Registering the MLModelEngine class as singleton for DI (Dependency Injection)</h2><p>For using this system in your ASP.NET Core WebAPI or web app you just need to register the MLModelEngine class as singleton in the DI system through the <code>services</code> collection at the <code>Startup.cs</code> like in the following code:</p><div id="crayon-5e3a42da44608454013015" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">public void ConfigureServices(IServiceCollection services)
{
    // ...Other code...

    // Register as singleton in the IoC container for DI
    services.AddSingleton&lt;MLModelEngine&lt;SampleObservation, SamplePrediction&gt;&gt;((ctx) =&gt;
                {
                    string modelFilePathName = GetAbsolutePath(Configuration["MLModel:MLModelFilePath"]);
                    return new MLModelEngine&lt;SampleObservation, SamplePrediction&gt;(modelFilePathName);
                });
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da44608454013015-1"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">ConfigureServices</span><span class="crayon-sy">(</span><span class="crayon-e">IServiceCollection </span><span class="crayon-i">services</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// ...Other code...</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Register as singleton in the IoC container for DI</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">services</span><span class="crayon-sy">.</span><span class="crayon-i">AddSingleton</span><span class="crayon-h">&lt;</span><span class="crayon-i">MLModelEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">SampleObservation</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">SamplePrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-i">ctx</span><span class="crayon-sy">)</span><span class="crayon-h"></span>=<span class="crayon-h">&gt;</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">modelFilePathName</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-e">GetAbsolutePath</span><span class="crayon-sy">(</span><span class="crayon-i">Configuration</span><span class="crayon-sy">[</span><span class="crayon-s">"MLModel:MLModelFilePath"</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-i">MLModelEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">SampleObservation</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">SamplePrediction</span><span class="crayon-h">&gt;</span><span class="crayon-sy">(</span><span class="crayon-i">modelFilePathName</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44608454013015-11"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Since we need the filepath pointing to the modelâ€™s .ZIP, weâ€™re using a lambda function as a factory to be able to provide that info to the constructor.</p><h2><a id="user-content-using-the-injected-mlmodelengine-object-from-your-webapi-controllers-to-make-predictions" class="anchor" aria-hidden="true" href="#using-the-injected-mlmodelengine-object-from-your-webapi-controllers-to-make-predictions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using the injected MLModelEngine object from your WebAPI controllers to make predictions</h2><p>Using the injected MLModelEngine object from your WebAPI controllers to make predictions is very simple.</p><p>First, the MLModelEngine object is injected in the controllerâ€™s constructor.</p><p>Second, you simple use it by calling the .Predict() method, as in the following controllerâ€™s code for a sentiment prediction example:</p><div id="crayon-5e3a42da44615724126042" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">[Route("api/[controller]")]
[ApiController]
public class PredictorController : ControllerBase
{
    private readonly MLModelEngine&lt;SampleObservation, SamplePrediction&gt; _modelEngine;

    public PredictorController(MLModelEngine&lt;SampleObservation, SamplePrediction&gt; modelEngine)
    {
        // Get the ML Model Engine injected, for scoring
        _modelEngine = modelEngine;
    }

    // GET api/predictor/sentimentprediction?sentimentText=ML.NET is awesome!
    [HttpGet]
    [Route("sentimentprediction")]
    public ActionResult&lt;string&gt; PredictSentiment([FromQuery]string sentimentText)
    {
        SampleObservation sampleData = new SampleObservation() { SentimentText = sentimentText };

        //Predict sentiment
        SamplePrediction prediction = _modelEngine.Predict(sampleData);

        return retVal = prediction.IsToxic.ToString();
    }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="hide"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-1">1</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-2">2</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-3">3</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-4">4</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-5">5</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-6">6</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-7">7</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-8">8</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-9">9</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-10">10</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-11">11</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-12">12</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-13">13</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-14">14</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-15">15</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-16">16</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-17">17</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-18">18</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-19">19</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-20">20</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-21">21</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-22">22</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-23">23</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-24">24</p><p class="crayon-num" data-line="crayon-5e3a42da44615724126042-25">25</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e3a42da44615724126042-1"><span class="crayon-sy">[</span><span class="crayon-e">Route</span><span class="crayon-sy">(</span><span class="crayon-s">"api/[controller]"</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-2"><span class="crayon-sy">[</span><span class="crayon-i">ApiController</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-3"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-i">PredictorController</span><span class="crayon-h"></span><span class="crayon-sy">:</span><span class="crayon-h"></span><span class="crayon-e">ControllerBase</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-4"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">readonly </span><span class="crayon-i">MLModelEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">SampleObservation</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">SamplePrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">_modelEngine</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">PredictorController</span><span class="crayon-sy">(</span><span class="crayon-i">MLModelEngine</span><span class="crayon-h">&lt;</span><span class="crayon-i">SampleObservation</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-i">SamplePrediction</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-i">modelEngine</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Get the ML Model Engine injected, for scoring</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">_modelEngine</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">modelEngine</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// GET api/predictor/sentimentprediction?sentimentText=ML.NET is awesome!</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-i">HttpGet</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">Route</span><span class="crayon-sy">(</span><span class="crayon-s">"sentimentprediction"</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-i">ActionResult</span><span class="crayon-h">&lt;</span><span class="crayon-t">string</span><span class="crayon-h">&gt;</span><span class="crayon-h"></span><span class="crayon-e">PredictSentiment</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-i">FromQuery</span><span class="crayon-sy">]</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-i">sentimentText</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">SampleObservation </span><span class="crayon-i">sampleData</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">SampleObservation</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-sy">{</span><span class="crayon-h"></span><span class="crayon-i">SentimentText</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">sentimentText</span><span class="crayon-h"></span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//Predict sentiment</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">SamplePrediction </span><span class="crayon-i">prediction</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">_modelEngine</span><span class="crayon-sy">.</span><span class="crayon-e">Predict</span><span class="crayon-sy">(</span><span class="crayon-i">sampleData</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-i">retVal</span><span class="crayon-h"></span>=<span class="crayon-h"></span><span class="crayon-i">prediction</span><span class="crayon-sy">.</span><span class="crayon-i">IsToxic</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e3a42da44615724126042-25"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>With that, we achieved our original goal of <em>â€˜making super simple to predict with an ML.NET model while having good performance in scalable ASP.NET Core appsâ€™</em> thanks to the explained optimizations.</p><p>To recap, hereâ€™s a high level end-to-end architecture diagram of the Web API using the MLModelEngine with the Object Pool of PredictionEngine objects.</p><p><img src="https://github.com/CESARDELATORRE/MLNET-Posts/raw/master/Posts/001-Running-MLNET-Models-in-ASPNETCore/images/WebAPI-MLModelEngine-Architecture.png" alt="alt text" title="End-to-end-simplified-architecture"></p><p>Feel free to provide your feedback if you implement this approach in your end-user applications.</p><p>Happy coding! ðŸ™‚</p><h1><a id="user-content-references" class="anchor" aria-hidden="true" href="#references"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>References</h1><p><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection" rel="nofollow">Dependency injection in ASP.NET Core</a></p><p><a href="https://docs.microsoft.com/en-us/dotnet/standard/threading/managed-threading-best-practices" rel="nofollow">Managed threading best practices</a></p><p><a href="https://docs.microsoft.com/en-us/dotnet/standard/threading/overview-of-synchronization-primitives" rel="nofollow">Overview of synchronization primitives</a></p><p><a href="https://docs.microsoft.com/en-us/dotnet/machine-learning/how-to-guides/single-predict-model-ml-net" rel="nofollow">Use the PredictionEngine to make one prediction at a time â€“ ML.NET</a></p><div class="authorinfoarea"><div><p>Principal Program Manager,&nbsp;.NET</p><p><strong>Follow Cesar</strong>&nbsp;&nbsp;&nbsp;<a class="no-underline stayinformed" aria-label="Cesar De la Torre Twitter profile" target="_blank" href="https://twitter.com/CESARDELATORRE"></a><a class="no-underline stayinformed" aria-label="Cesar De la Torre LinkedIn profile" target="_blank" href="https://www.linkedin.com/in/cesar-de-la-torre-b31b512/"><i class="fa fa-linkedin"></i></a><a class="no-underline stayinformed" aria-label="Cesar De la Torre GitHub profile" target="_blank" href="https://github.com/CESARDELATORRE"><i class="fa fa-github"></i></a><a class="no-underline stayinformed hvr-pop" aria-label="Cesar De la Torre RSS Feed" target="_blank" href="https://devblogs.microsoft.com/cesardelatorre/author/cesardl/feed/"></a></p></div></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>