<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Call MS Graph APIs from ASP.NET Core 3.1 - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Call MS Graph APIs from ASP.NET Core 3.1 - linksfor.dev(s)"/>
    <meta property="og:description" content="As I spend more time in my role as a PM for Microsoft Identity, the more I realize there is a whole world I don&#x27;t know about. And as many of the developers out there, I make sure I spend as much time as I can learning new things. Today&#x27;s"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://cmatskas.com/call-ms-graph-apis-from-asp-net-core-3-1/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Call MS Graph APIs from ASP.NET Core 3.1</title>
<div class="readable">
        <h1>Call MS Graph APIs from ASP.NET Core 3.1</h1>
            <div>Reading time: 22-28 minutes</div>
        <div>Posted here: 22 Apr 2020</div>
        <p><a href="https://cmatskas.com/call-ms-graph-apis-from-asp-net-core-3-1/">https://cmatskas.com/call-ms-graph-apis-from-asp-net-core-3-1/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><section>
<p>As I spend more time in my role as a PM for Microsoft Identity, the more I realize there is a whole world I don't know about. And as many of the developers out there, I make sure I spend as much time as I can learning new things. Today's learning? Integrating MS Graph into an existing ASP.NET Core 3.1 app. It may sound straightforward, but getting it to work proved a little bit more challenging because our developer story is so new. In addition, I wanted to experience what it would take to add MS Graph to an existing ASP.NET Core app and not start with a sample or pre-canned project.</p>
<p>Let's get started</p>
<h3 id="1theaspnetcoreapp">1. The ASP.NET Core app</h3>
<p>Although not a true representation of a real life app, I created a standard ASP.NET Core with Azure AD Authentication. This is pretty common when developers create ASP.NET Core that consumes Azure AD for authentication. There are a few ways to do this. The easiest by far is to use Visual Studio 2019 to create the new ASP.NET Core app and also register a new application in Azure AD. </p>

<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-3-1.png" alt=""></p>
<p>The last step will enumerate all the Azure AD directories you have access to. Once you've made your selection, press <strong>Create</strong>. Visual Studio will do two things next:</p>
<ol>
<li>It will create an Application Registration inside the Azure AD tenant you chose on the last step </li>
<li>It will create the ASP.NET Core app and configure it to use the new Azure AD app to authenticate, include the appropriate endpoints. </li>
</ol>
<p>To confirm this you can go to the Azure Portal and then select your Azure AD tenant and navigate to App Registrations. There, you should see an auto-registered app that looks similar to this:</p>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-4.png" alt=""></p>
<p>And if you open the <code>appsettings.json</code> in the VS Solution Explorer, you can find the populated fields necessary to perform the authentication. Pay close attention to the <code>ClientId</code> which should be identical in the Azure portal and the code.</p>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-5.png" alt=""></p>
<p>We can test the authentication by running the application. You'll notice that we get prompted for a login straight away. Make sure to use an account that has access to the configured Azure AD tenant to login :)</p>
<blockquote>
<p>while testing things I like to not have to authenticate for the home page as there may be issues with the code and I want to eliminate authentication as one of the moving parts. If you're like me, you can add the <code>[AllowAnonymous]</code> attribute to the Index() method in the Home controller to make things smoother at startup</p>
</blockquote>
<h3 id="2addingmsgraphtoouraspnetcore31app">2. Adding MS Graph to our ASP.NET Core 3.1 app</h3>
<p>As we look into how we can integrate MS Graph to our app, it's useful to take a step back to understand what's happening here. The important thing is that the current app is not configured to use MSAL to authenticate against Azure AD. As such, we don't have the appropriate token that we can use to call MS Graph. To fix this, we need to add a couple of NuGet packages that can be used to do the appropriate authentication, acquire the necessary token and pass it to the Graph API calls. We also need to update our App registration in Azure AD to give us access to the MS Graph data.</p>
<p>2.1 Update the App Registration <br>
Before we update our code, we need to do a few changes in the App that Visual Studio kindly created for us to ensure that it can be used by our updated (not yet) authentication code. Go to your app registration in the Azure portal and navigate to the <strong>Authentication</strong> blade. Update the following and press <strong>Save</strong>:</p>
<ul>
<li>Redirect URLs (they should match your app urls, i.e localhost:portnumber)</li>
<li>Logout URLs (they should match our asp.net core URLs)</li>
<li>Implicit Grant / ID Tokens (check)</li>
</ul>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-6.png" alt=""></p>
<p>Then, navigate to the <strong>API Permissions</strong> blade to ensure that the <strong>Microsoft.Graph &gt; User.Read</strong> permission has been granted:</p>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-7.png" alt=""></p>
<p>Unless you need to pull more information than the standard user profile (which we will be doing for this example) you don't need to add any more permissions.</p>
<p>Finally, we need a create a new secret that our application will use to speak to Azure AD. Navigate to <strong>Certificates &amp;&amp; secrets</strong> blade and create a new client secret:</p>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-8.png" alt="">
<img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-9.png" alt=""></p>
<p>Make sure to copy the <strong>secret value</strong> as you will not be able to access it ever again. However, if you lose it, you can easily create a new secret and delete the old one (as soon as you're confident that no one else is using it).</p>
<h3 id="3updatetheaspnetcorecode">3. Update the ASP.NET Core code</h3>
<p>To take our existing ASP.NET Core app and add code to authenticate and call MS Graph we need to do quite a few, subtle changes.</p>
<p>Let's start with the NuGet packages. For MS Graph of course, you can always write code to call the API using REST but where's the fun in that? I love using SDKs as they tend to hide away certain complexities and provide a straight path to what I want to achieve. Let's add the necessary packages. Open the NuGet Package Manager in VS2019 and run the following:</p>
<pre><code>Install-Package Microsoft.Identity.Web -Version 0.1.0-preview  
Install-Package Microsoft.Identity.Web.UI -Version 0.1.0-preview  
Install-Package Microsoft.Graph -Version 3.3.0  
Uninstall-Package Microsoft.AspNetCore.Authentication.AzureAD.UI  
</code></pre>
<p>Next, we need to update our <code>appsettings.json</code> file with a couple of new entries:</p>
<pre><code>"SignedOutCallbackPath ": "/signout-callback-oidc",
"ClientSecret": "&lt;your App client secret&gt;"
"GraphApiUrl": "https://graph.microsoft.com/beta"
</code></pre>
<p>In the end, your <code>appsettings.json</code> file should look like this:</p>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-10.png" alt=""></p>
<p>To call graph, we need some new classes that will allow us to register the Graph Client (a wrapper class around the Graph SDK to give us a client to work with) as well as a helper class authenticate our calls.</p>
<p><strong>GraphServiceClientFactory</strong></p>
<div id="gist102556964">
    <div>
      <div>
        <div>
  <div id="file-graphserviceclientfactory-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-graphserviceclientfactory-cs-L1" data-line-number="1"></td>
        <td id="file-graphserviceclientfactory-cs-LC1"><span>using</span> <span>Microsoft</span>.<span>Graph</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L2" data-line-number="2"></td>
        <td id="file-graphserviceclientfactory-cs-LC2"><span>using</span> <span>System</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L3" data-line-number="3"></td>
        <td id="file-graphserviceclientfactory-cs-LC3"><span>using</span> <span>System</span>.<span>Net</span>.<span>Http</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L4" data-line-number="4"></td>
        <td id="file-graphserviceclientfactory-cs-LC4"><span>using</span> <span>System</span>.<span>Net</span>.<span>Http</span>.<span>Headers</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L5" data-line-number="5"></td>
        <td id="file-graphserviceclientfactory-cs-LC5"><span>using</span> <span>System</span>.<span>Threading</span>.<span>Tasks</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L6" data-line-number="6"></td>
        <td id="file-graphserviceclientfactory-cs-LC6">
</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L7" data-line-number="7"></td>
        <td id="file-graphserviceclientfactory-cs-LC7"><span>namespace</span> <span>WebApplication1</span></td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L8" data-line-number="8"></td>
        <td id="file-graphserviceclientfactory-cs-LC8">{</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L9" data-line-number="9"></td>
        <td id="file-graphserviceclientfactory-cs-LC9">    <span>public</span> <span>class</span> <span>GraphServiceClientFactory</span></td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L10" data-line-number="10"></td>
        <td id="file-graphserviceclientfactory-cs-LC10">    {</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L11" data-line-number="11"></td>
        <td id="file-graphserviceclientfactory-cs-LC11">        <span>public</span> <span>static</span> <span>GraphServiceClient</span> <span>GetAuthenticatedGraphClient</span>(<span>Func</span>&lt;<span>Task</span>&lt;<span>string</span>&gt;&gt; <span>acquireAccessToken</span>,</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L12" data-line-number="12"></td>
        <td id="file-graphserviceclientfactory-cs-LC12">                                                                                 <span>string</span> <span>baseUrl</span>)</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L13" data-line-number="13"></td>
        <td id="file-graphserviceclientfactory-cs-LC13">        {</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L14" data-line-number="14"></td>
        <td id="file-graphserviceclientfactory-cs-LC14">
</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L15" data-line-number="15"></td>
        <td id="file-graphserviceclientfactory-cs-LC15">            <span>return</span> <span>new</span> <span>GraphServiceClient</span>(<span>baseUrl</span>, <span>new</span> <span>CustomAuthenticationProvider</span>(<span>acquireAccessToken</span>));</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L16" data-line-number="16"></td>
        <td id="file-graphserviceclientfactory-cs-LC16">        }</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L17" data-line-number="17"></td>
        <td id="file-graphserviceclientfactory-cs-LC17">    }</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L18" data-line-number="18"></td>
        <td id="file-graphserviceclientfactory-cs-LC18">
</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L19" data-line-number="19"></td>
        <td id="file-graphserviceclientfactory-cs-LC19">    <span>class</span> <span>CustomAuthenticationProvider</span> : <span>IAuthenticationProvider</span></td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L20" data-line-number="20"></td>
        <td id="file-graphserviceclientfactory-cs-LC20">    {</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L21" data-line-number="21"></td>
        <td id="file-graphserviceclientfactory-cs-LC21">        <span>public</span> <span>CustomAuthenticationProvider</span>(<span>Func</span>&lt;<span>Task</span>&lt;<span>string</span>&gt;&gt; <span>acquireTokenCallback</span>)</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L22" data-line-number="22"></td>
        <td id="file-graphserviceclientfactory-cs-LC22">        {</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L23" data-line-number="23"></td>
        <td id="file-graphserviceclientfactory-cs-LC23">            <span>acquireAccessToken</span> <span>=</span> <span>acquireTokenCallback</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L24" data-line-number="24"></td>
        <td id="file-graphserviceclientfactory-cs-LC24">        }</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L25" data-line-number="25"></td>
        <td id="file-graphserviceclientfactory-cs-LC25">
</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L26" data-line-number="26"></td>
        <td id="file-graphserviceclientfactory-cs-LC26">        <span>private</span> <span>readonly</span> <span>Func</span>&lt;<span>Task</span>&lt;<span>string</span>&gt;&gt; <span>acquireAccessToken</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L27" data-line-number="27"></td>
        <td id="file-graphserviceclientfactory-cs-LC27">
</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L28" data-line-number="28"></td>
        <td id="file-graphserviceclientfactory-cs-LC28">        <span>public</span> <span>async</span> <span>Task</span> <span>AuthenticateRequestAsync</span>(<span>HttpRequestMessage</span> <span>request</span>)</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L29" data-line-number="29"></td>
        <td id="file-graphserviceclientfactory-cs-LC29">        {</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L30" data-line-number="30"></td>
        <td id="file-graphserviceclientfactory-cs-LC30">            <span>string</span> <span>accessToken</span> <span>=</span> <span>await</span> <span>acquireAccessToken</span>.<span>Invoke</span>();</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L31" data-line-number="31"></td>
        <td id="file-graphserviceclientfactory-cs-LC31">
</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L32" data-line-number="32"></td>
        <td id="file-graphserviceclientfactory-cs-LC32">            <span><span>//</span> Append the access token to the request.</span></td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L33" data-line-number="33"></td>
        <td id="file-graphserviceclientfactory-cs-LC33">            <span>request</span>.<span>Headers</span>.<span>Authorization</span> <span>=</span> <span>new</span> <span>AuthenticationHeaderValue</span>(<span><span>"</span>Bearer<span>"</span></span>, <span>accessToken</span>);</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L34" data-line-number="34"></td>
        <td id="file-graphserviceclientfactory-cs-LC34">        }</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L35" data-line-number="35"></td>
        <td id="file-graphserviceclientfactory-cs-LC35">    }</td>
      </tr>
      <tr>
        <td id="file-graphserviceclientfactory-cs-L36" data-line-number="36"></td>
        <td id="file-graphserviceclientfactory-cs-LC36">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p><strong>GraphSettings</strong></p>
<div id="gist102556989">
    <div>
      <div>
        <div>
  <div id="file-graphsettings">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-graphsettings-L1" data-line-number="1"></td>
        <td id="file-graphsettings-LC1">namespace WebApplication1</td>
      </tr>
      <tr>
        <td id="file-graphsettings-L2" data-line-number="2"></td>
        <td id="file-graphsettings-LC2">{</td>
      </tr>
      <tr>
        <td id="file-graphsettings-L3" data-line-number="3"></td>
        <td id="file-graphsettings-LC3">    public class GraphSettings</td>
      </tr>
      <tr>
        <td id="file-graphsettings-L4" data-line-number="4"></td>
        <td id="file-graphsettings-LC4">    {</td>
      </tr>
      <tr>
        <td id="file-graphsettings-L5" data-line-number="5"></td>
        <td id="file-graphsettings-LC5">        public string GraphApiUrl { get; set; }</td>
      </tr>
      <tr>
        <td id="file-graphsettings-L6" data-line-number="6"></td>
        <td id="file-graphsettings-LC6">    }</td>
      </tr>
      <tr>
        <td id="file-graphsettings-L7" data-line-number="7"></td>
        <td id="file-graphsettings-LC7">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p><strong>GraphServiceRegistration</strong></p>
<div id="gist102557008">
    <div>
      <div>
        <div>
  <div id="file-graphserviceregistration-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-graphserviceregistration-cs-L1" data-line-number="1"></td>
        <td id="file-graphserviceregistration-cs-LC1"><span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>Configuration</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L2" data-line-number="2"></td>
        <td id="file-graphserviceregistration-cs-LC2"><span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>DependencyInjection</span>;</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L3" data-line-number="3"></td>
        <td id="file-graphserviceregistration-cs-LC3">
</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L4" data-line-number="4"></td>
        <td id="file-graphserviceregistration-cs-LC4"><span>namespace</span> <span>WebApplication1</span></td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L5" data-line-number="5"></td>
        <td id="file-graphserviceregistration-cs-LC5">{</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L6" data-line-number="6"></td>
        <td id="file-graphserviceregistration-cs-LC6">    <span>public</span> <span>static</span> <span>class</span> <span>GraphServiceRegistration</span></td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L7" data-line-number="7"></td>
        <td id="file-graphserviceregistration-cs-LC7">    {</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L8" data-line-number="8"></td>
        <td id="file-graphserviceregistration-cs-LC8">        <span>public</span> <span>static</span> <span>void</span> <span>AddGraphService</span>(<span>this</span> <span>IServiceCollection</span> <span>services</span>, <span>IConfiguration</span> <span>configuration</span>)</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L9" data-line-number="9"></td>
        <td id="file-graphserviceregistration-cs-LC9">        {</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L10" data-line-number="10"></td>
        <td id="file-graphserviceregistration-cs-LC10">            <span>services</span>.<span>Configure</span>&lt;<span>GraphSettings</span>&gt;(<span>configuration</span>);</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L11" data-line-number="11"></td>
        <td id="file-graphserviceregistration-cs-LC11">        }</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L12" data-line-number="12"></td>
        <td id="file-graphserviceregistration-cs-LC12">    }</td>
      </tr>
      <tr>
        <td id="file-graphserviceregistration-cs-L13" data-line-number="13"></td>
        <td id="file-graphserviceregistration-cs-LC13">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>We then move on to the <code>Startup.cs</code> where the bulk of the changes need to take place:</p>
<div id="gist102557675">
    <div>
      <div>
        <div>
  <div id="file-startup-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-startup-cs-L1" data-line-number="1"></td>
        <td id="file-startup-cs-LC1"><span>using</span> <span>Microsoft</span>.<span>AspNetCore</span>.<span>Authorization</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L2" data-line-number="2"></td>
        <td id="file-startup-cs-LC2"><span>using</span> <span>Microsoft</span>.<span>AspNetCore</span>.<span>Builder</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L3" data-line-number="3"></td>
        <td id="file-startup-cs-LC3"><span>using</span> <span>Microsoft</span>.<span>AspNetCore</span>.<span>Hosting</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L4" data-line-number="4"></td>
        <td id="file-startup-cs-LC4"><span>using</span> <span>Microsoft</span>.<span>AspNetCore</span>.<span>Mvc</span>.<span>Authorization</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L5" data-line-number="5"></td>
        <td id="file-startup-cs-LC5"><span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>Configuration</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L6" data-line-number="6"></td>
        <td id="file-startup-cs-LC6"><span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>DependencyInjection</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L7" data-line-number="7"></td>
        <td id="file-startup-cs-LC7"><span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>Hosting</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L8" data-line-number="8"></td>
        <td id="file-startup-cs-LC8"><span>using</span> <span>Microsoft</span>.<span>Identity</span>.<span>Web</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L9" data-line-number="9"></td>
        <td id="file-startup-cs-LC9"><span>using</span> <span>Microsoft</span>.<span>Identity</span>.<span>Web</span>.<span>TokenCacheProviders</span>.<span>InMemory</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L10" data-line-number="10"></td>
        <td id="file-startup-cs-LC10"><span>using</span> <span>Microsoft</span>.<span>Identity</span>.<span>Web</span>.<span>UI</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L11" data-line-number="11"></td>
        <td id="file-startup-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L12" data-line-number="12"></td>
        <td id="file-startup-cs-LC12"><span>namespace</span> <span>WebApplication1</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L13" data-line-number="13"></td>
        <td id="file-startup-cs-LC13">{</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L14" data-line-number="14"></td>
        <td id="file-startup-cs-LC14">    <span>public</span> <span>class</span> <span>Startup</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L15" data-line-number="15"></td>
        <td id="file-startup-cs-LC15">    {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L16" data-line-number="16"></td>
        <td id="file-startup-cs-LC16">        <span>public</span> <span>Startup</span>(<span>IConfiguration</span> <span>configuration</span>)</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L17" data-line-number="17"></td>
        <td id="file-startup-cs-LC17">        {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L18" data-line-number="18"></td>
        <td id="file-startup-cs-LC18">            <span>Configuration</span> <span>=</span> <span>configuration</span>;</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L19" data-line-number="19"></td>
        <td id="file-startup-cs-LC19">        }</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L20" data-line-number="20"></td>
        <td id="file-startup-cs-LC20">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L21" data-line-number="21"></td>
        <td id="file-startup-cs-LC21">        <span>public</span> <span>IConfiguration</span> <span>Configuration</span> { <span>get</span>; }</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L22" data-line-number="22"></td>
        <td id="file-startup-cs-LC22">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L23" data-line-number="23"></td>
        <td id="file-startup-cs-LC23">        <span><span>//</span> This method gets called by the runtime. Use this method to add services to the container.</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L24" data-line-number="24"></td>
        <td id="file-startup-cs-LC24">        <span>public</span> <span>void</span> <span>ConfigureServices</span>(<span>IServiceCollection</span> <span>services</span>)</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L25" data-line-number="25"></td>
        <td id="file-startup-cs-LC25">        {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L26" data-line-number="26"></td>
        <td id="file-startup-cs-LC26">            <span>object</span> <span>p</span> <span>=</span> <span>services</span>.<span>AddSignIn</span>(<span>Configuration</span>);</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L27" data-line-number="27"></td>
        <td id="file-startup-cs-LC27">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L28" data-line-number="28"></td>
        <td id="file-startup-cs-LC28">            <span>services</span>.<span>AddWebAppCallsProtectedWebApi</span>(<span>Configuration</span>, <span>new</span> <span>string</span>[] { <span><span>"</span>user.read<span>"</span></span> })</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L29" data-line-number="29"></td>
        <td id="file-startup-cs-LC29">                .<span>AddInMemoryTokenCaches</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L30" data-line-number="30"></td>
        <td id="file-startup-cs-LC30">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L31" data-line-number="31"></td>
        <td id="file-startup-cs-LC31">            <span>services</span>.<span>AddGraphService</span>(<span>Configuration</span>);</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L32" data-line-number="32"></td>
        <td id="file-startup-cs-LC32">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L33" data-line-number="33"></td>
        <td id="file-startup-cs-LC33">            <span>services</span>.<span>AddRazorPages</span>().<span>AddMvcOptions</span>(<span>options</span> <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L34" data-line-number="34"></td>
        <td id="file-startup-cs-LC34">            {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L35" data-line-number="35"></td>
        <td id="file-startup-cs-LC35">                <span>var</span> <span>policy</span> <span>=</span> <span>new</span> <span>AuthorizationPolicyBuilder</span>()</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L36" data-line-number="36"></td>
        <td id="file-startup-cs-LC36">                    .<span>RequireAuthenticatedUser</span>()</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L37" data-line-number="37"></td>
        <td id="file-startup-cs-LC37">                    .<span>Build</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L38" data-line-number="38"></td>
        <td id="file-startup-cs-LC38">                <span>options</span>.<span>Filters</span>.<span>Add</span>(<span>new</span> <span>AuthorizeFilter</span>(<span>policy</span>));</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L39" data-line-number="39"></td>
        <td id="file-startup-cs-LC39">            }).<span>AddMicrosoftIdentityUI</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L40" data-line-number="40"></td>
        <td id="file-startup-cs-LC40">        }</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L41" data-line-number="41"></td>
        <td id="file-startup-cs-LC41">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L42" data-line-number="42"></td>
        <td id="file-startup-cs-LC42">        <span><span>//</span> This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L43" data-line-number="43"></td>
        <td id="file-startup-cs-LC43">        <span>public</span> <span>void</span> <span>Configure</span>(<span>IApplicationBuilder</span> <span>app</span>, <span>IWebHostEnvironment</span> <span>env</span>)</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L44" data-line-number="44"></td>
        <td id="file-startup-cs-LC44">        {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L45" data-line-number="45"></td>
        <td id="file-startup-cs-LC45">            <span>if</span> (<span>env</span>.<span>IsDevelopment</span>())</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L46" data-line-number="46"></td>
        <td id="file-startup-cs-LC46">            {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L47" data-line-number="47"></td>
        <td id="file-startup-cs-LC47">                <span>app</span>.<span>UseDeveloperExceptionPage</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L48" data-line-number="48"></td>
        <td id="file-startup-cs-LC48">            }</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L49" data-line-number="49"></td>
        <td id="file-startup-cs-LC49">            <span>else</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L50" data-line-number="50"></td>
        <td id="file-startup-cs-LC50">            {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L51" data-line-number="51"></td>
        <td id="file-startup-cs-LC51">                <span>app</span>.<span>UseExceptionHandler</span>(<span><span>"</span>/Error<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L52" data-line-number="52"></td>
        <td id="file-startup-cs-LC52">                <span><span>//</span> The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L53" data-line-number="53"></td>
        <td id="file-startup-cs-LC53">                <span>app</span>.<span>UseHsts</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L54" data-line-number="54"></td>
        <td id="file-startup-cs-LC54">            }</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L55" data-line-number="55"></td>
        <td id="file-startup-cs-LC55">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L56" data-line-number="56"></td>
        <td id="file-startup-cs-LC56">            <span>app</span>.<span>UseHttpsRedirection</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L57" data-line-number="57"></td>
        <td id="file-startup-cs-LC57">            <span>app</span>.<span>UseStaticFiles</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L58" data-line-number="58"></td>
        <td id="file-startup-cs-LC58">            <span>app</span>.<span>UseCookiePolicy</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L59" data-line-number="59"></td>
        <td id="file-startup-cs-LC59">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L60" data-line-number="60"></td>
        <td id="file-startup-cs-LC60">            <span>app</span>.<span>UseRouting</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L61" data-line-number="61"></td>
        <td id="file-startup-cs-LC61">            <span>app</span>.<span>UseAuthentication</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L62" data-line-number="62"></td>
        <td id="file-startup-cs-LC62">            <span>app</span>.<span>UseAuthorization</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L63" data-line-number="63"></td>
        <td id="file-startup-cs-LC63">
</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L64" data-line-number="64"></td>
        <td id="file-startup-cs-LC64">            <span>app</span>.<span>UseEndpoints</span>(<span>endpoints</span> <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="file-startup-cs-L65" data-line-number="65"></td>
        <td id="file-startup-cs-LC65">            {</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L66" data-line-number="66"></td>
        <td id="file-startup-cs-LC66">                <span>endpoints</span>.<span>MapRazorPages</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L67" data-line-number="67"></td>
        <td id="file-startup-cs-LC67">                <span>endpoints</span>.<span>MapControllers</span>();</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L68" data-line-number="68"></td>
        <td id="file-startup-cs-LC68">            });</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L69" data-line-number="69"></td>
        <td id="file-startup-cs-LC69">        }</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L70" data-line-number="70"></td>
        <td id="file-startup-cs-LC70">    }</td>
      </tr>
      <tr>
        <td id="file-startup-cs-L71" data-line-number="71"></td>
        <td id="file-startup-cs-LC71">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>The most notable change is how configure the authentication and registering the Graph Client, especially lines 26-39.</p>
<p>Finally, we want to add a new <code>Profile</code> page where we can display the data we pull from MS Graph. In Visual Studio, right click to your project/Pages and add a new Razor Page -&gt; Profile.cshtml</p>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-11.png" alt=""></p>
<p>Change the code-behind to make the call to MS Graph and populate the <code>ViewData[me]</code> and <code>ViewData[Photo]</code> object with the results: </p>
<div id="gist102557977">
    <div>
      <div>
        <div>
  <div id="file-profile-cshtml-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-profile-cshtml-cs-L1" data-line-number="1"></td>
        <td id="file-profile-cshtml-cs-LC1"><span>using</span> <span>Microsoft</span>.<span>AspNetCore</span>.<span>Mvc</span>.<span>RazorPages</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L2" data-line-number="2"></td>
        <td id="file-profile-cshtml-cs-LC2"><span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>Options</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L3" data-line-number="3"></td>
        <td id="file-profile-cshtml-cs-LC3"><span>using</span> <span>Microsoft</span>.<span>Graph</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L4" data-line-number="4"></td>
        <td id="file-profile-cshtml-cs-LC4"><span>using</span> <span>Microsoft</span>.<span>Identity</span>.<span>Web</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L5" data-line-number="5"></td>
        <td id="file-profile-cshtml-cs-LC5"><span>using</span> <span>System</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L6" data-line-number="6"></td>
        <td id="file-profile-cshtml-cs-LC6"><span>using</span> <span>System</span>.<span>IO</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L7" data-line-number="7"></td>
        <td id="file-profile-cshtml-cs-LC7"><span>using</span> <span>System</span>.<span>Threading</span>.<span>Tasks</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L8" data-line-number="8"></td>
        <td id="file-profile-cshtml-cs-LC8">
</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L9" data-line-number="9"></td>
        <td id="file-profile-cshtml-cs-LC9"><span>namespace</span> <span>WebApplication1</span>.<span>Pages</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L10" data-line-number="10"></td>
        <td id="file-profile-cshtml-cs-LC10">{</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L11" data-line-number="11"></td>
        <td id="file-profile-cshtml-cs-LC11">    [<span>AuthorizeForScopes</span>(<span>Scopes</span> <span>=</span> <span>new</span>[] { <span><span>"</span>user.read<span>"</span></span> })]</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L12" data-line-number="12"></td>
        <td id="file-profile-cshtml-cs-LC12">    <span>public</span> <span>class</span> <span>ProfileModel</span> : <span>PageModel</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L13" data-line-number="13"></td>
        <td id="file-profile-cshtml-cs-LC13">    {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L14" data-line-number="14"></td>
        <td id="file-profile-cshtml-cs-LC14">        <span>readonly</span> <span>ITokenAcquisition</span> <span>tokenAcquisition</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L15" data-line-number="15"></td>
        <td id="file-profile-cshtml-cs-LC15">        <span>readonly</span> <span>GraphSettings</span> <span>graphSettings</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L16" data-line-number="16"></td>
        <td id="file-profile-cshtml-cs-LC16">        <span>public</span> <span>ProfileModel</span>(<span>ITokenAcquisition</span> <span>tokenAcquisition</span>, <span>IOptions</span>&lt;<span>GraphSettings</span>&gt; <span>graphSettingsValue</span>)</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L17" data-line-number="17"></td>
        <td id="file-profile-cshtml-cs-LC17">        {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L18" data-line-number="18"></td>
        <td id="file-profile-cshtml-cs-LC18">            <span>this</span>.<span>tokenAcquisition</span> <span>=</span> <span>tokenAcquisition</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L19" data-line-number="19"></td>
        <td id="file-profile-cshtml-cs-LC19">            <span>this</span>.<span>graphSettings</span> <span>=</span> <span>graphSettingsValue</span>.<span>Value</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L20" data-line-number="20"></td>
        <td id="file-profile-cshtml-cs-LC20">        }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L21" data-line-number="21"></td>
        <td id="file-profile-cshtml-cs-LC21">        <span>public</span> <span>async</span> <span>Task</span> <span>OnGetAsync</span>()</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L22" data-line-number="22"></td>
        <td id="file-profile-cshtml-cs-LC22">        {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L23" data-line-number="23"></td>
        <td id="file-profile-cshtml-cs-LC23">            <span>GraphServiceClient</span> <span>graphClient</span> <span>=</span> <span>GetGraphServiceClient</span>(<span>new</span>[] { <span><span>"</span>user.read<span>"</span></span> });</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L24" data-line-number="24"></td>
        <td id="file-profile-cshtml-cs-LC24">
</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L25" data-line-number="25"></td>
        <td id="file-profile-cshtml-cs-LC25">            <span>var</span> <span>me</span> <span>=</span> <span>await</span> <span>graphClient</span>.<span>Me</span>.<span>Request</span>().<span>GetAsync</span>();</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L26" data-line-number="26"></td>
        <td id="file-profile-cshtml-cs-LC26">            <span>ViewData</span>[<span><span>"</span>Me<span>"</span></span>] <span>=</span> <span>me</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L27" data-line-number="27"></td>
        <td id="file-profile-cshtml-cs-LC27">
</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L28" data-line-number="28"></td>
        <td id="file-profile-cshtml-cs-LC28">            <span>try</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L29" data-line-number="29"></td>
        <td id="file-profile-cshtml-cs-LC29">            {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L30" data-line-number="30"></td>
        <td id="file-profile-cshtml-cs-LC30">                <span><span>//</span> Get user photo</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L31" data-line-number="31"></td>
        <td id="file-profile-cshtml-cs-LC31">                <span>using</span> (<span>var</span> <span>photoStream</span> <span>=</span> <span>await</span> <span>graphClient</span>.<span>Me</span>.<span>Photo</span>.<span>Content</span>.<span>Request</span>().<span>GetAsync</span>())</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L32" data-line-number="32"></td>
        <td id="file-profile-cshtml-cs-LC32">                {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L33" data-line-number="33"></td>
        <td id="file-profile-cshtml-cs-LC33">                    <span>byte</span>[] <span>photoByte</span> <span>=</span> ((<span>MemoryStream</span>)<span>photoStream</span>).<span>ToArray</span>();</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L34" data-line-number="34"></td>
        <td id="file-profile-cshtml-cs-LC34">                    <span>ViewData</span>[<span><span>"</span>Photo<span>"</span></span>] <span>=</span> <span>Convert</span>.<span>ToBase64String</span>(<span>photoByte</span>);</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L35" data-line-number="35"></td>
        <td id="file-profile-cshtml-cs-LC35">                }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L36" data-line-number="36"></td>
        <td id="file-profile-cshtml-cs-LC36">            }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L37" data-line-number="37"></td>
        <td id="file-profile-cshtml-cs-LC37">            <span>catch</span> (<span>System</span>.<span>Exception</span>)</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L38" data-line-number="38"></td>
        <td id="file-profile-cshtml-cs-LC38">            {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L39" data-line-number="39"></td>
        <td id="file-profile-cshtml-cs-LC39">                <span>ViewData</span>[<span><span>"</span>Photo<span>"</span></span>] <span>=</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L40" data-line-number="40"></td>
        <td id="file-profile-cshtml-cs-LC40">            }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L41" data-line-number="41"></td>
        <td id="file-profile-cshtml-cs-LC41">        }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L42" data-line-number="42"></td>
        <td id="file-profile-cshtml-cs-LC42">
</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L43" data-line-number="43"></td>
        <td id="file-profile-cshtml-cs-LC43">        <span>private</span> <span>GraphServiceClient</span> <span>GetGraphServiceClient</span>(<span>string</span>[] <span>scopes</span>)</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L44" data-line-number="44"></td>
        <td id="file-profile-cshtml-cs-LC44">        {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L45" data-line-number="45"></td>
        <td id="file-profile-cshtml-cs-LC45">            <span>return</span> <span>GraphServiceClientFactory</span>.<span>GetAuthenticatedGraphClient</span>(<span>async</span> () <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L46" data-line-number="46"></td>
        <td id="file-profile-cshtml-cs-LC46">            {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L47" data-line-number="47"></td>
        <td id="file-profile-cshtml-cs-LC47">                <span>string</span> <span>result</span> <span>=</span> <span>await</span> <span>tokenAcquisition</span>.<span>GetAccessTokenForUserAsync</span>(<span>scopes</span>);</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L48" data-line-number="48"></td>
        <td id="file-profile-cshtml-cs-LC48">                <span>return</span> <span>result</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L49" data-line-number="49"></td>
        <td id="file-profile-cshtml-cs-LC49">            }, <span>graphSettings</span>.<span>GraphApiUrl</span>);</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L50" data-line-number="50"></td>
        <td id="file-profile-cshtml-cs-LC50">        }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L51" data-line-number="51"></td>
        <td id="file-profile-cshtml-cs-LC51">    }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-cs-L52" data-line-number="52"></td>
        <td id="file-profile-cshtml-cs-LC52">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p><strong>Disclosure</strong>: I admit that this is a bit of a hacky approach as I choose to dump all the data to the page instead of filtering it and creating a nice(r) UI to display it. Feel free to mess about with the UI once you get everything working.</p>
<p>Let's add the necessary HTML/Razor code to the view to render the data: </p>
<div id="gist102558044">
    <div>
      <div>
        <div>
  <div id="file-profile-cshtml">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-profile-cshtml-L1" data-line-number="1"></td>
        <td id="file-profile-cshtml-LC1"><span>@page</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L2" data-line-number="2"></td>
        <td id="file-profile-cshtml-LC2"><span>@model </span><span>WebApplication1</span>.<span>Pages</span>.<span>ProfileModel</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L3" data-line-number="3"></td>
        <td id="file-profile-cshtml-LC3"><span>@{</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L4" data-line-number="4"></td>
        <td id="file-profile-cshtml-LC4">    <span>ViewData</span>[<span><span>"</span>Title<span>"</span></span>] <span>=</span> <span><span>"</span>Profile<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L5" data-line-number="5"></td>
        <td id="file-profile-cshtml-LC5"><span>}</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L6" data-line-number="6"></td>
        <td id="file-profile-cshtml-LC6">
</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L7" data-line-number="7"></td>
        <td id="file-profile-cshtml-LC7">&lt;<span>table</span> <span>class</span>=<span><span>"</span>table table-striped table-condensed<span>"</span></span> <span>style</span>=<span><span>"</span><span><span><span>font-family</span></span>: <span>monospace</span></span><span>"</span></span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L8" data-line-number="8"></td>
        <td id="file-profile-cshtml-LC8">    &lt;<span>tr</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L9" data-line-number="9"></td>
        <td id="file-profile-cshtml-LC9">        &lt;<span>th</span>&gt;Property&lt;/<span>th</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L10" data-line-number="10"></td>
        <td id="file-profile-cshtml-LC10">        &lt;<span>th</span>&gt;Value&lt;/<span>th</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L11" data-line-number="11"></td>
        <td id="file-profile-cshtml-LC11">    &lt;/<span>tr</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L12" data-line-number="12"></td>
        <td id="file-profile-cshtml-LC12">    &lt;<span>tr</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L13" data-line-number="13"></td>
        <td id="file-profile-cshtml-LC13">        &lt;<span>td</span>&gt;photo&lt;/<span>td</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L14" data-line-number="14"></td>
        <td id="file-profile-cshtml-LC14">        &lt;<span>td</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L15" data-line-number="15"></td>
        <td id="file-profile-cshtml-LC15">            <span>@{</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L16" data-line-number="16"></td>
        <td id="file-profile-cshtml-LC16">                <span>if</span> (<span>ViewData</span>[<span><span>"</span>photo<span>"</span></span>] <span>!=</span> <span>null</span>)</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L17" data-line-number="17"></td>
        <td id="file-profile-cshtml-LC17">                {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L18" data-line-number="18"></td>
        <td id="file-profile-cshtml-LC18">                    <span>&lt;</span><span>img</span> <span>style</span><span>=</span><span><span>"</span>margin: 5px 0; width: 150px<span>"</span></span> <span>src</span><span>=</span><span><span>"</span>data:image/jpeg;base64, @ViewData[<span>"</span></span><span>photo</span><span><span>"</span>]<span>"</span></span> <span>/</span><span>&gt;</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L19" data-line-number="19"></td>
        <td id="file-profile-cshtml-LC19">                }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L20" data-line-number="20"></td>
        <td id="file-profile-cshtml-LC20">                <span>else</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L21" data-line-number="21"></td>
        <td id="file-profile-cshtml-LC21">                {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L22" data-line-number="22"></td>
        <td id="file-profile-cshtml-LC22">                    &lt;<span>h3</span>&gt;<span>NO</span> <span>PHOTO</span>&lt;/<span>h3</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L23" data-line-number="23"></td>
        <td id="file-profile-cshtml-LC23">                    &lt;<span>p</span>&gt;<span>Check</span> <span>user</span> <span>profile</span> <span>in</span> <span>Azure</span> <span>Active</span> <span>Directory</span> <span>to</span> <span>add</span> <span>a</span> <span>photo</span>.&lt;/<span>p</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L24" data-line-number="24"></td>
        <td id="file-profile-cshtml-LC24">                }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L25" data-line-number="25"></td>
        <td id="file-profile-cshtml-LC25">            }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L26" data-line-number="26"></td>
        <td id="file-profile-cshtml-LC26">        &lt;/<span>td</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L27" data-line-number="27"></td>
        <td id="file-profile-cshtml-LC27">    &lt;/<span>tr</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L28" data-line-number="28"></td>
        <td id="file-profile-cshtml-LC28">    @{</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L29" data-line-number="29"></td>
        <td id="file-profile-cshtml-LC29">        <span>var</span> <span>me</span> <span>=</span> <span>ViewData</span>[<span><span>"</span>me<span>"</span></span>] <span>as</span> <span>Microsoft</span>.<span>Graph</span>.<span>User</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L30" data-line-number="30"></td>
        <td id="file-profile-cshtml-LC30">        <span>var</span> <span>properties</span> <span>=</span> <span>me</span>.<span>GetType</span>().<span>GetProperties</span>();</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L31" data-line-number="31"></td>
        <td id="file-profile-cshtml-LC31">        <span>foreach</span> (<span>var</span> <span>child</span> <span>in</span> <span>properties</span>)</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L32" data-line-number="32"></td>
        <td id="file-profile-cshtml-LC32">        {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L33" data-line-number="33"></td>
        <td id="file-profile-cshtml-LC33">            <span>object</span> <span>value</span> <span>=</span> <span>child</span>.<span>GetValue</span>(<span>me</span>);</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L34" data-line-number="34"></td>
        <td id="file-profile-cshtml-LC34">            <span>string</span> <span>stringRepresentation</span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L35" data-line-number="35"></td>
        <td id="file-profile-cshtml-LC35">            <span>if</span> (<span>!</span>(<span>value</span> <span>is</span> <span>string</span>) <span>&amp;&amp;</span> <span>value</span> <span>is</span> <span>IEnumerable</span>&lt;<span>string</span>&gt;)</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L36" data-line-number="36"></td>
        <td id="file-profile-cshtml-LC36">            {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L37" data-line-number="37"></td>
        <td id="file-profile-cshtml-LC37">                <span>stringRepresentation</span> <span>=</span> <span><span>"</span>[<span>"</span></span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L38" data-line-number="38"></td>
        <td id="file-profile-cshtml-LC38">                    <span>+</span> <span>string</span>.<span>Join</span>(<span><span>"</span>, <span>"</span></span>, (<span>value</span> <span>as</span> <span>IEnumerable</span>&lt;<span>string</span>&gt;).<span>OfType</span>&lt;<span>object</span>&gt;().<span>Select</span>(<span>c</span> <span>=&gt;</span> <span>c</span>.<span>ToString</span>()))</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L39" data-line-number="39"></td>
        <td id="file-profile-cshtml-LC39">                    <span>+</span> <span><span>"</span>]<span>"</span></span>;</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L40" data-line-number="40"></td>
        <td id="file-profile-cshtml-LC40">            }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L41" data-line-number="41"></td>
        <td id="file-profile-cshtml-LC41">            <span>else</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L42" data-line-number="42"></td>
        <td id="file-profile-cshtml-LC42">            {</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L43" data-line-number="43"></td>
        <td id="file-profile-cshtml-LC43">                <span>stringRepresentation</span> <span>=</span> <span>value</span><span>?</span>.<span>ToString</span>();</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L44" data-line-number="44"></td>
        <td id="file-profile-cshtml-LC44">            }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L45" data-line-number="45"></td>
        <td id="file-profile-cshtml-LC45">
</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L46" data-line-number="46"></td>
        <td id="file-profile-cshtml-LC46">            <span>&lt;</span><span>tr</span><span>&gt;</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L47" data-line-number="47"></td>
        <td id="file-profile-cshtml-LC47">                <span>&lt;</span><span>td</span><span>&gt;</span> <span>@child</span>.<span>Name</span> <span>&lt;</span><span>/</span><span>td</span><span>&gt;</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L48" data-line-number="48"></td>
        <td id="file-profile-cshtml-LC48">                <span>&lt;</span><span>td</span><span>&gt;</span> <span>@stringRepresentation</span> <span>&lt;</span><span>/</span><span>td</span><span>&gt;</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L49" data-line-number="49"></td>
        <td id="file-profile-cshtml-LC49">            <span>&lt;</span><span>/</span><span>tr</span><span>&gt;</span></td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L50" data-line-number="50"></td>
        <td id="file-profile-cshtml-LC50">        }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L51" data-line-number="51"></td>
        <td id="file-profile-cshtml-LC51">    }</td>
      </tr>
      <tr>
        <td id="file-profile-cshtml-L52" data-line-number="52"></td>
        <td id="file-profile-cshtml-LC52">&lt;/<span>table</span>&gt;</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>And a couple of finishing touches. Firstly, I want to make sure that I can navigate to the new page from the UI so we need to update the _Layout.cshtml code in the Pages/Shared folder and add a new entry in the nav bar.</p>
<pre><code>&lt;li class="nav-item"&gt;  
   &lt;a class="nav-link text-dark" asp-area="" asp-page="/Profile"&gt;Profile&lt;/a&gt;
&lt;/li&gt;  
</code></pre>
<p>Finally, we need to fix the logout logic as right now this will be broken since it's not using the <code>MicrosoftIdentityUI</code> code. Open the <code>_LoginPartial.cshtml</code> page in Pages/Shared folder and change <code>asp-area="AzureAD"</code> to <code>asp-area="MicrosoftIdentity"</code>. The full code shown below:</p>
<div id="gist102558245">
    <div>
      <div>
        <div>
  <div id="file-loginpartial-cshtml">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-loginpartial-cshtml-L1" data-line-number="1"></td>
        <td id="file-loginpartial-cshtml-LC1">&lt;<span>ul</span> <span>class</span>=<span><span>"</span>navbar-nav<span>"</span></span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L2" data-line-number="2"></td>
        <td id="file-loginpartial-cshtml-LC2"><span>@if</span> (<span>User</span>.<span>Identity</span>.<span>IsAuthenticated</span>)</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L3" data-line-number="3"></td>
        <td id="file-loginpartial-cshtml-LC3"><span>{</span></td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L4" data-line-number="4"></td>
        <td id="file-loginpartial-cshtml-LC4">        &lt;<span>li</span> <span>class</span>=<span><span>"</span>nav-item<span>"</span></span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L5" data-line-number="5"></td>
        <td id="file-loginpartial-cshtml-LC5">            &lt;<span>span</span> <span>class</span>=<span><span>"</span>navbar-text text-dark<span>"</span></span>&gt;<span>Hello</span> <span>@User.Identity.Name</span><span>!</span>&lt;/<span>span</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L6" data-line-number="6"></td>
        <td id="file-loginpartial-cshtml-LC6">        &lt;/<span>li</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L7" data-line-number="7"></td>
        <td id="file-loginpartial-cshtml-LC7">        &lt;<span>li</span> <span>class</span>=<span><span>"</span>nav-item<span>"</span></span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L8" data-line-number="8"></td>
        <td id="file-loginpartial-cshtml-LC8">            &lt;<span>a</span> <span>class</span>=<span><span>"</span>nav-link text-dark<span>"</span></span> <span>asp-area</span>=<span><span>"</span>MicrosoftIdentity<span>"</span></span> <span>asp-controller</span>=<span><span>"</span>Account<span>"</span></span> <span>asp-action</span>=<span><span>"</span>SignOut<span>"</span></span>&gt;<span>Sign</span> <span>out</span>&lt;/<span>a</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L9" data-line-number="9"></td>
        <td id="file-loginpartial-cshtml-LC9">        &lt;/<span>li</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L10" data-line-number="10"></td>
        <td id="file-loginpartial-cshtml-LC10"><span>}</span></td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L11" data-line-number="11"></td>
        <td id="file-loginpartial-cshtml-LC11"><span>else</span></td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L12" data-line-number="12"></td>
        <td id="file-loginpartial-cshtml-LC12"><span>{</span></td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L13" data-line-number="13"></td>
        <td id="file-loginpartial-cshtml-LC13">        &lt;<span>li</span> <span>class</span>=<span><span>"</span>nav-item<span>"</span></span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L14" data-line-number="14"></td>
        <td id="file-loginpartial-cshtml-LC14">            &lt;<span>a</span> <span>class</span>=<span><span>"</span>nav-link text-dark<span>"</span></span> <span>asp-area</span>=<span><span>"</span>MicrosoftIdentity<span>"</span></span> <span>asp-controller</span>=<span><span>"</span>Account<span>"</span></span> <span>asp-action</span>=<span><span>"</span>SignIn<span>"</span></span>&gt;<span>Sign</span> <span>in</span>&lt;/<span>a</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L15" data-line-number="15"></td>
        <td id="file-loginpartial-cshtml-LC15">        &lt;/<span>li</span>&gt;</td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L16" data-line-number="16"></td>
        <td id="file-loginpartial-cshtml-LC16"><span>}</span></td>
      </tr>
      <tr>
        <td id="file-loginpartial-cshtml-L17" data-line-number="17"></td>
        <td id="file-loginpartial-cshtml-LC17">&lt;/<span>ul</span>&gt;</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>Running the app and navigating to my Profile page I get the following:</p>
<p><img src="https://cmatskas.com/content/images/2020/04/asp-net-core-with-Graph-12.png" alt=""></p>
<p>Awesome!!!</p>
<p>If you want to see this project in action, you can clone the <a href="https://github.com/cmatskas/aspnetcorewithgraph">GitHub repo</a>, configure the <code>appsettings.json</code> with your app details and off you go.</p>
<h3 id="4somethoughts">4. Some thoughts</h3>
<p>This blog post walks us through the steps necessary to integrate MS Graph into an existing ASP.NET Core app using the MS Graph SDK. The end result works as expected but there are a few things that need full disclosure.</p>
<ol>
<li>The <code>Microsoft.Identity.Web</code> and <code>Microsoft.Identity.Web.UI</code> are Preview NuGet package and will most change before hitting GA. Therefore, you should be aware that the code in this post is cutting edge tech and only got released as a package a few days ago. </li>
<li>The way we inject and consume the Graph Client comes with a bit of <em>code smell</em> as we are exposing things that we shouldn't, see <code>ITokenAcquisition</code> injection in the <code>Profile.cshtml.cs</code> contructor.</li>
</ol>
<p>We are working on fixing these to provide a much smoother experience for developers that wish to consume MS Graph in their ASP.NET Core 3.1 app. </p>
<p>Next time I will be writing about how to add MS Graph to a <strong>WebForms</strong> app because not everyone is on the bleeding edge of .NET :)</p>
<p>Give this a go and let me know how you get on....</p>
</section></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>