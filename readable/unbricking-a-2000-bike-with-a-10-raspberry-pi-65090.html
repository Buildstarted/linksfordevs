<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Unbricking a $2,000 Bike With a $10 Raspberry Pi - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Unbricking a $2,000 Bike With a $10 Raspberry Pi - linksfor.dev(s)"/>
    <meta property="og:description" content="The Flywheel Home Bike. Image: Flywheel Sports."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Unbricking a $2,000 Bike With a $10 Raspberry Pi</title>
<div class="readable">
        <h1>Unbricking a $2,000 Bike With a $10 Raspberry Pi</h1>
            <div>Reading time: 30-38 minutes</div>
        <div>Posted here: 01 Aug 2020</div>
        <p><a href="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/">https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="content"><article><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/flywheel-bike-3.jpg" alt="The Flywheel Home Bike. Image: Flywheel Sports." width="100%"><figcaption><p>The Flywheel Home Bike. Image: Flywheel Sports.</p></figcaption></figure><p>A few years ago I splurged on an exercise bike. It’s a pretty expensive
item imho, both in upfront and ongoing subscription costs. But I was able
to justify it by riding it all the time so that per-ride it wasn’t that
expensive. I’m happy to say this was a huge boon for my fitness and it
was worth every penny.</p><p>The bike is the Flywheel Home Bike by Flywheel Sports. You open up the app,
pick a class, and start riding. The app shows you a live video stream of an
instructor, your position on the leaderboard so you can compete with the
other people in the class, and your realtime stats like power (watts) and
cadence (rpm). There’s all the usual motivational badges that come with
fitness apps these days, and each ride is logged so you can track your
progress over time.</p><p>Or, that’s how it used to work anyway.</p><p>Flywheel recently and abruptly <a href="https://www.theverge.com/2020/2/19/21144268/flywheel-digital-classes-shut-down-peloton-exercise-trade-in">shut down</a> the Home Bike service following a legal battle with their competitor, Peloton. The bike does still work in that you can still pedal and adjust the resistance and technically get a workout. But the app is no longer so there are no classes, no competition, and no stats.</p><p>Flywheel customers left wanting a bit more had a few options:</p><ol><li>Swap it for a free refurbished Peloton. Join Peloton for the same monthly fee and take their classes instead. Not a bad deal and arguably an upgrade.</li><li>Use the free <a href="https://lifefitness.com/icg-digital-experience/training-app">LifeFitness ICG Training App</a>. The Flywheel Home Bike is a rebranded LifeFitness IC5 so it just happens to work with this app. This gives you live stats like power and cadence and the ability to track your progress but doesn’t provide any live classes or competition, nor is it officially supported.</li><li>Add a set of power meter pedals ($). Use the bike with the massively-multiplayer online cycling simulator <a href="https://www.zwift.com/">Zwift</a> and other training apps.</li><li>Reverse engineer the bike. Set its data free to be used with Zwift and other training apps. No power meter pedals required.</li></ol><p>The rest of the post is a walk-through of my experience writing some code that enables the Flywheel Home Bike to work with Zwift and other training apps. It likely also works for the LifeFitness IC5 and support for other bikes should be easy to add.</p><p>The finished program is called <a href="https://github.com/ptx2/gymnasticon">Gymnasticon</a> and <a href="https://github.com/ptx2/gymnasticon">the code</a> is open-source on GitHub.</p><h3 id="project-goals">Project goals</h3><p>The primary goal is to make the Flywheel Home Bike work with Zwift. It would be great if it also works with other cycling apps like TrainerRoad and Rouvy.</p><p>The solution should be easy to use for a non-developer and non-destructive to the bike.</p><p>The plan to get there is broken down into 3 parts:</p><ol><li>Write some code to get power and cadence data out of the bike’s proprietary protocol</li><li>Write some code to send power and cadence data to Zwift emulating a Bluetooth bike</li><li>Put the two together into a final working solution</li></ol><h3 id="part-1---getting-data-out-of-the-bike">Part 1 - Getting data out of the bike</h3><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/data-in-the-bike.jpg" width="100%"></figure><p>Only two pieces of information are needed to make a bike work with Zwift: power (watts) and cadence (rpm). Power enables Zwift to calculate your speed and position in the game. Cadence improves the experience of cadence-based workouts and enables Zwift to accurately animate your character.</p><p>We know from experience that this bike is capable of producing that information and that it communicates with the official Flywheel app using Bluetooth so the first step
is to open up a Bluetooth service explorer and see what’s available.</p><figure><video autoplay="" loop="" muted="" playsinline="" src="videos/clip4_bluetility.mp4" alt="Bluetility on macOS shows the services offered by the Flywheel Home Bike." width="100%"></video><figcaption><p><a href="https://github.com/jnross/Bluetility">Bluetility</a> on macOS shows the services offered by the Flywheel Home Bike.</p></figcaption></figure><p>The bike advertises a single service with two characteristics (aka data values). A web
search for the service UUID tells us this is <a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/include/bluetooth/services/nus.html">Nordic UART Service</a> which
is a custom service defined by Nordic Semiconductor. It allows sending
arbitrary data back and forth, emulating a serial port.</p><p>The characteristics are named from the bike’s perspective. To transmit
data to the bike we write to the receive (RX) characteristic. To receive data
from the bike we subscribe to the transmit (TX) characteristic.</p><p>Clicking subscribe on the (TX) characteristic shows that the bike is already sending some data. It is a bit hard to see the data here though. The short JavaScript program below uses the <a href="https://github.com/abandonware/noble">noble</a> Bluetooth client library to connect to the bike and dump all the received data to the console so we can begin to analyze it.</p><div><pre><code data-lang="javascript"><span>/**
</span><span> * Connect to the Flywheel Home Bike's Bluetooth UART service and log
</span><span> * received data to the console.
</span><span> */</span>

<span>import</span> <span>noble</span> <span>from</span> <span>'@abandonware/noble'</span><span>;</span>
<span>import</span> <span>{</span><span>on</span><span>,</span> <span>once</span><span>}</span> <span>from</span> <span>'events'</span><span>;</span>

<span>(</span><span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
  <span>// nordic uart service and characteristics
</span><span></span>  <span>const</span> <span>uuid</span> <span>=</span> <span>'6e400001b5a3f393e0a9e50e24dcca9e'</span><span>;</span>
  <span>const</span> <span>rxUuid</span> <span>=</span> <span>'6e400002b5a3f393e0a9e50e24dcca9e'</span><span>;</span>
  <span>const</span> <span>txUuid</span> <span>=</span> <span>'6e400003b5a3f393e0a9e50e24dcca9e'</span><span>;</span>

  <span>// wait for adapter
</span><span></span>  <span>const</span> <span>[</span><span>state</span><span>]</span> <span>=</span> <span>await</span> <span>once</span><span>(</span><span>noble</span><span>,</span> <span>'stateChange'</span><span>);</span>
  <span>if</span> <span>(</span><span>state</span> <span>!==</span> <span>'poweredOn'</span><span>)</span> <span>{</span>
    <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>`bluetooth adapter state </span><span>${</span><span>state</span><span>}</span><span>`</span><span>);</span>
  <span>}</span>

  <span>// scan
</span><span></span>  <span>await</span> <span>noble</span><span>.</span><span>startScanningAsync</span><span>([</span><span>uuid</span><span>],</span> <span>false</span><span>);</span>
  <span>const</span> <span>[</span><span>peripheral</span><span>]</span> <span>=</span> <span>await</span> <span>once</span><span>(</span><span>noble</span><span>,</span> <span>'discover'</span><span>);</span>
  <span>await</span> <span>noble</span><span>.</span><span>stopScanningAsync</span><span>();</span>

  <span>// connect
</span><span></span>  <span>await</span> <span>peripheral</span><span>.</span><span>connectAsync</span><span>();</span>
  <span>const</span> <span>{</span><span>characteristics</span><span>:</span> <span>[</span><span>tx</span><span>,</span> <span>rx</span><span>]}</span> <span>=</span> <span>await</span>
      <span>peripheral</span><span>.</span><span>discoverSomeServicesAndCharacteristicsAsync</span><span>([</span><span>uuid</span><span>],</span>
      <span>[</span><span>txUuid</span><span>,</span> <span>rxUuid</span><span>]);</span>

  <span>// start receiving
</span><span></span>  <span>await</span> <span>tx</span><span>.</span><span>subscribeAsync</span><span>();</span>
  <span>const</span> <span>packets</span> <span>=</span> <span>on</span><span>(</span><span>tx</span><span>,</span> <span>'read'</span><span>);</span>

  <span>// exit on ctrl-c
</span><span></span>  <span>let</span> <span>exit</span> <span>=</span> <span>false</span><span>;</span>
  <span>process</span><span>.</span><span>on</span><span>(</span><span>'SIGINT'</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span> <span>exit</span> <span>=</span> <span>true</span><span>;</span> <span>});</span>

  <span>// print all received data
</span><span></span>  <span>const</span> <span>start</span> <span>=</span> <span>new</span> <span>Date</span><span>();</span>
  <span>for</span> <span>await</span> <span>(</span><span>const</span> <span>[</span><span>packet</span><span>]</span> <span>of</span> <span>packets</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>exit</span><span>)</span>
      <span>break</span><span>;</span>

    <span>const</span> <span>t</span> <span>=</span> <span>new</span> <span>Date</span><span>()</span> <span>-</span> <span>start</span><span>;</span>
    <span>const</span> <span>mm</span> <span>=</span> <span>`</span><span>${</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>t</span><span>/</span><span>60</span><span>)</span><span>}</span><span>`</span><span>.</span><span>padStart</span><span>(</span><span>2</span><span>,</span> <span>'0'</span><span>);</span>
    <span>const</span> <span>ss</span> <span>=</span> <span>`</span><span>${</span><span>t</span> <span>%</span> <span>60</span><span>}</span><span>`</span><span>.</span><span>padStart</span><span>(</span><span>2</span><span>,</span> <span>'0'</span><span>);</span>
    <span>const</span> <span>mmss</span> <span>=</span> <span>`</span><span>${</span><span>mm</span><span>}</span><span>:</span><span>${</span><span>ss</span><span>}</span><span>`</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>mmss</span><span>,</span> <span>packet</span><span>);</span>
  <span>}</span>

  <span>// stop receiving
</span><span></span>  <span>await</span> <span>tx</span><span>.</span><span>unsubscribeAsync</span><span>();</span>

  <span>// disconnect
</span><span></span>  <span>await</span> <span>peripheral</span><span>.</span><span>disconnectAsync</span><span>();</span>
<span>})();</span>
</code></pre></div><p>Running the program, we get our first clear look at the data the bike is sending:</p><div><pre><code data-lang="text">00:00 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 26 00 00 00 00&gt;
00:00 &lt;Buffer 00 00 00 00 00 00 00 0c 00 00 00 01 38 55&gt;
00:01 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 26 00 00 00 00&gt;
00:01 &lt;Buffer 00 00 00 00 00 00 00 0c 00 00 00 01 38 55&gt;
00:02 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 26 00 00 00 00&gt;
00:02 &lt;Buffer 00 00 00 00 00 00 00 0c 00 00 00 01 38 55&gt;
00:03 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 26 00 00 00 00&gt;
00:03 &lt;Buffer 00 00 00 00 00 00 00 0c 00 00 00 01 38 55&gt;
00:04 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 26 00 00 00 00&gt;
00:04 &lt;Buffer 00 00 00 00 00 00 00 0c 00 00 00 01 38 55&gt;
</code></pre></div><p>Some initial observations on the data:</p><ul><li>The bike sends two packets of data every second.</li><li>First packet is 20 bytes long, second is 14 bytes long.</li></ul><p>Bluetooth LE 4.0 and 4.1 allow at most 20 bytes of application data per packet so this is likely a single 34-byte message sent in two chunks. A small change to the program joins the two chunks back together and adds a heading to make the output easier to read and reference.</p><p>Updated program output:</p><div><pre><code data-lang="text">Offset         0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33

00:23 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0c 00 00 00 01 1e 55&gt;
00:24 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0c 00 00 00 01 1e 55&gt;
00:25 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0c 00 00 00 01 1e 55&gt;
00:26 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0c 00 00 00 01 1e 55&gt;
00:27 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0c 00 00 00 01 1e 55&gt;

(started pedaling)

00:28 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0d 00 00 00 01 2e 55&gt;
00:29 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0e 00 00 00 01 2d 55&gt;
00:30 &lt;Buffer ff 1f 0c 00 21 00 14 00 00 00 00 04 58 00 95 00 00 00 00 00 00 00 00 00 00 00 00 0f 00 00 00 01 e1 55&gt;
00:31 &lt;Buffer ff 1f 0c 00 21 00 14 00 00 00 00 04 58 00 95 00 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 01 fe 55&gt;
00:32 &lt;Buffer ff 1f 0c 00 21 00 14 00 00 00 00 04 60 00 95 00 00 00 00 00 00 00 00 00 00 00 00 11 00 00 00 01 c7 55&gt;
00:33 &lt;Buffer ff 1f 0c 00 21 00 14 00 00 00 00 04 62 00 95 00 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00 01 c6 55&gt;
00:34 &lt;Buffer ff 1f 0c 00 21 00 14 00 00 00 00 04 62 00 95 00 00 00 00 00 00 00 00 00 00 00 00 13 00 00 00 01 c7 55&gt;
00:35 &lt;Buffer ff 1f 0c 00 20 00 14 00 00 00 00 04 5e 00 93 00 00 00 00 00 00 00 00 00 00 00 00 14 00 00 00 01 fb 55&gt;
00:36 &lt;Buffer ff 1f 0c 00 1f 00 13 00 00 00 00 04 5e 00 90 00 00 00 00 00 00 00 00 00 00 00 00 15 00 01 00 01 c0 55&gt;
00:37 &lt;Buffer ff 1f 0c 00 1d 00 12 00 00 00 00 04 54 00 8c 00 00 00 00 00 00 00 00 00 00 00 00 16 00 01 00 01 d6 55&gt;
00:38 &lt;Buffer ff 1f 0c 00 1c 00 11 00 00 00 00 04 54 00 89 00 00 00 00 00 00 00 00 00 00 00 00 17 00 01 00 01 d0 55&gt;
00:39 &lt;Buffer ff 1f 0c 00 1c 00 11 00 00 00 00 04 4f 00 89 00 00 00 00 00 00 00 00 00 00 00 00 18 00 01 00 02 c7 55&gt;
00:40 &lt;Buffer ff 1f 0c 00 1c 00 11 00 00 00 00 04 4d 00 89 00 00 00 00 00 00 00 00 00 00 00 00 19 00 01 00 02 c4 55&gt;
00:41 &lt;Buffer ff 1f 0c 00 1b 00 11 00 00 00 00 04 4d 00 87 00 00 00 00 00 00 00 00 00 00 00 00 1a 00 01 00 02 ce 55&gt;
00:42 &lt;Buffer ff 1f 0c 00 1b 00 11 00 00 00 00 04 4b 00 87 00 00 00 00 00 00 00 00 00 00 00 00 1b 00 01 00 02 c9 55&gt;
00:43 &lt;Buffer ff 1f 0c 00 1a 00 10 00 00 00 00 03 4b 00 84 00 00 00 00 00 00 00 00 00 00 00 00 1c 00 01 00 02 ca 55&gt;
00:44 &lt;Buffer ff 1f 0c 00 19 00 0f 00 00 00 00 03 45 00 82 00 00 00 00 00 00 00 00 00 00 00 00 1d 00 01 00 02 df 55&gt;
00:45 &lt;Buffer ff 1f 0c 00 18 00 0f 00 00 00 00 03 45 00 7f 00 00 00 00 00 00 00 00 00 00 00 00 1e 00 01 00 02 20 55&gt;
00:46 &lt;Buffer ff 1f 0c 00 18 00 0f 00 00 00 00 03 43 00 7f 00 00 00 00 00 00 00 00 00 00 00 00 1f 00 01 00 02 27 55&gt;
00:47 &lt;Buffer ff 1f 0c 00 17 00 0e 00 00 00 00 03 3e 00 7d 00 00 00 00 00 00 00 00 00 00 00 00 20 00 01 00 02 69 55&gt;
00:48 &lt;Buffer ff 1f 0c 00 16 00 0e 00 00 00 00 03 3e 00 7a 00 00 00 00 00 00 00 00 00 00 00 00 21 00 01 00 02 6e 55&gt;
00:49 &lt;Buffer ff 1f 0c 00 15 00 0d 00 00 00 00 03 37 00 77 00 00 00 00 00 00 00 00 00 00 00 00 22 00 01 00 02 69 55&gt;
00:50 &lt;Buffer ff 1f 0c 00 15 00 0d 00 00 00 00 03 37 00 77 00 00 00 00 00 00 00 00 00 00 00 00 23 00 01 00 02 68 55&gt;
00:51 &lt;Buffer ff 1f 0c 00 16 00 0e 00 00 00 00 03 3c 00 7a 00 00 00 00 00 00 00 00 00 00 00 00 24 00 01 00 02 69 55&gt;
00:52 &lt;Buffer ff 1f 0c 00 16 00 0e 00 00 00 00 03 3c 00 7a 00 00 00 00 00 00 00 00 00 00 00 00 25 00 01 00 02 68 55&gt;
00:53 &lt;Buffer ff 1f 0c 00 17 00 0e 00 00 00 00 03 42 00 7d 00 00 00 00 00 00 00 00 00 00 00 00 26 00 01 00 02 13 55&gt;
00:54 &lt;Buffer ff 1f 0c 00 17 00 0e 00 00 00 00 03 42 00 7d 00 00 00 00 00 00 00 00 00 00 00 00 27 00 01 00 03 13 55&gt;
00:55 &lt;Buffer ff 1f 0c 00 17 00 0e 00 00 00 00 03 42 00 7d 00 00 00 00 00 00 00 00 00 00 00 00 28 00 01 00 03 1c 55&gt;
00:56 &lt;Buffer ff 1f 0c 00 17 00 0e 00 00 00 00 03 43 00 7d 00 00 00 00 00 00 00 00 00 00 00 00 29 00 01 00 03 1c 55&gt;
00:57 &lt;Buffer ff 1f 0c 00 17 00 0e 00 00 00 00 03 43 00 7d 00 00 00 00 00 00 00 00 00 00 00 00 2a 00 01 00 03 1f 55&gt;
00:58 &lt;Buffer ff 1f 0c 00 17 00 0e 00 00 00 00 03 43 00 7d 00 00 00 00 00 00 00 00 00 00 00 00 2b 00 01 00 03 1e 55&gt;
</code></pre></div><p>Some more observations:</p><ul><li>When not pedaling, it’s almost all zeroes.</li><li>Upon pedaling, a few of the zero values change – a promising sign.</li><li>Some non-zero values (0, 1, 2, 33) remain constant.</li><li>Some values (27, 29, 31) are increasing monotonically at different rates.</li></ul><p>Power and cadence are hopefully some of those values that become non-zero upon pedaling.</p><h4 id="finding-the-cadence">Finding the cadence</h4><p>Our approach here is to record some data while riding at a known steady cadence
(60 rpm) for 30-60 seconds and then search for that value in the data.
We can repeat this process at a couple different cadences to verify and clear up any coincidences.</p><p>This <a href="https://www.google.com/search?q=metronome">metronome</a> came in handy for keeping a steady cadence.</p><p>The first few seconds of data:</p><div><pre><code data-lang="text">Offset         0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33

00:00 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 35 00 00 00 00 00 00 00 00 00 00 02 d0 00 2c 00 5f 87 55&gt;
00:01 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 2a 00 00 00 00 00 00 00 00 00 00 02 d0 00 2c 00 5f 98 55&gt;
00:02 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 24 00 00 00 00 00 00 00 00 00 00 02 d0 00 2c 00 5f 96 55&gt;
00:03 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 25 00 00 00 00 00 00 00 00 00 00 02 d0 00 2c 00 5f 97 55&gt;
00:04 &lt;Buffer ff 1f 0c 00 58 00 36 00 00 00 00 0c 35 00 f2 25 00 00 00 00 00 00 00 00 00 00 02 d1 00 2c 00 5f 33 55&gt;
00:05 &lt;Buffer ff 1f 0c 00 5a 00 38 00 00 00 00 0c 35 00 f5 25 00 00 00 00 00 00 00 00 00 00 02 d2 00 2c 00 5f 3b 55&gt;
00:06 &lt;Buffer ff 1f 0c 00 57 00 36 00 00 00 00 0c 49 00 f1 25 00 00 00 00 00 00 00 00 00 00 02 d3 00 2c 00 5f 41 55&gt;
00:07 &lt;Buffer ff 1f 0c 00 52 00 33 00 00 00 00 0b 49 00 ea 24 00 00 00 00 00 00 00 00 00 00 02 d4 00 2c 00 5f 5b 55&gt;
00:08 &lt;Buffer ff 1f 0c 00 4f 00 31 00 00 00 00 0b 40 00 e6 26 00 00 00 00 00 00 00 00 00 00 02 d5 00 2c 00 5f 42 55&gt;
</code></pre></div><p>The recording begins and ends at standstill and otherwise should be approximately 60 rpm. Any offset with a max above 80rpm or below 50rpm or that doesn’t start and end with 0 is a non-match and can be discarded. We’re left with only two candidates:</p><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/cadence.png"></figure><p>It is clear from the chart that cadence is the uint8 at offset 12. A few extra tests at different cadences confirm this. There are non-zero values at offset 11 and 13 which confirms cadence is a uint8 and not the lower byte of a uint16.</p><p>This means the bike can report a maximum cadence of 255 rpm. What happens at 256 rpm?
Does it wrap to 0 or clamp to 255? It turns out it’s pretty hard to pedal that fast and so this remains a mystery.</p><figure><video autoplay="" loop="" muted="" playsinline="" src="videos/rpm.mp4" alt="Francois Pervis @ 260 RPM" width="100%"></video><figcaption><p><a href="https://www.youtube.com/watch?v=a5PcQJF5Jl0">Francois Pervis @ 260 RPM</a></p></figcaption></figure><h4 id="finding-the-power">Finding the power</h4><p>The exact same approach could work here: ride at a steady known wattage for 30-60 seconds and then look for that value in the data. However I don’t have a good way to know exactly what wattage I’m doing.</p><p>So this time we’ll keep a steady cadence and just keep adding resistance every few seconds. The data should show a series of plateaus each higher than the last. The absolute values should also be within a reasonble range starting out around 100 watts and staying well under 1000 watts.</p><p>We are most likely looking for a 16-bit integer this time and we’ll have to consider both big and little endian encodings.</p><p>The first few seconds of data:</p><div><pre><code data-lang="text">Offset         0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33

00:00 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 2d 00 00 00 00 00 00 00 00 00 00 01 b2 00 12 00 25 ba 55&gt;
00:01 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 00 00 00 2d 00 00 00 00 00 00 00 00 00 00 01 b2 00 12 00 25 ba 55&gt;
00:02 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 28 00 00 2d 00 00 00 00 00 00 00 00 00 00 01 b3 00 12 00 25 93 55&gt;
00:03 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 28 00 00 2d 00 00 00 00 00 00 00 00 00 00 01 b4 00 12 00 25 94 55&gt;
00:04 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 25 00 00 2d 00 00 00 00 00 00 00 00 00 00 01 b5 00 12 00 25 98 55&gt;
00:05 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 25 00 00 2d 00 00 00 00 00 00 00 00 00 00 01 b6 00 12 00 25 9b 55&gt;
00:06 &lt;Buffer ff 1f 0c 00 00 00 00 00 00 00 00 00 29 00 00 2d 00 00 00 00 00 00 00 00 00 00 01 b7 00 12 00 25 96 55&gt;
00:07 &lt;Buffer ff 1f 0c 00 56 00 35 00 00 00 00 0b 35 00 f0 2c 00 00 00 00 00 00 00 00 00 00 01 b8 00 12 00 25 1c 55&gt;
00:08 &lt;Buffer ff 1f 0c 00 5a 00 38 00 00 00 00 0c 35 00 f5 2d 00 00 00 00 00 00 00 00 00 00 01 b9 00 12 00 26 1c 55&gt;
</code></pre></div><p>Any offset with a max below 100W or above 1000W, or that doesn’t start and end with 0 can be discarded. This time we’re left with three possibilities: offset 3, 5 and 13.</p><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/power.png"></figure><p>The absolute values suggest that offset 3 is the current power in watts. Based on my effort, offset 13 starts out too high and offset 5 doesn’t peak high enough.</p><p>So, what is the data at offset 5 and 13?</p><p>After some experimentation with the ICG Training App, I discovered that
the bike has some hidden features not exposed by the Flywheel app. One of those features
is that you can take a test to see the maximum power you can sustain over one hour of riding, known as Functional Threshold Power (FTP). The FTP result is stored on the bike and it reports your power as both watts (offset 3) and percentage of FTP (offset 5). The FTP% is frequently used in training programs. The default FTP stored in the bike appears to be 160 watts as when offset 3 ≈ 160, offset 5 ≈ 100.</p><p>The value at offset 13 is a very optimistic estimate of speed in km/h × 10. It could be that the rider weight defaults to 0.</p><p>As a bonus, when I was recording data I noticed that offset 15 is the position of the resistance dial ranging from 0 (easy) to 100 (hard). This was easy to see in the program’s output when adjusting the resistance while not pedaling as it was one of the only values changing. It’s not necessary for making the bike work with Zwift.</p><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/resistance.png"></figure><h4 id="a-bug-in-the-bike">A bug in the bike?</h4><p>Another thing I noticed during this testing is what appears to be a bug in the bike:</p><div><pre><code data-lang="text">Offset         0  1  2 <span> 3  4</span>  5  6  7  8  9 10 11 <span>12</span> 13 14 <span>15</span> 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33<br>
02:21 &lt;Buffer ff 1f 0c <span>01 7b</span> 00 ea 00 00 00 00 33 <span>6c</span> 01 f6 <span>3a</span> 00 00 00 00 00 00 00 00 00 00 00 7e 00 06 00 0e 67 55&gt;
02:22 &lt;Buffer ff 1f 0c <span>01 92</span> 00 f8 00 00 00 00 36 <span>6b</span> 02 05 <span>3b</span> 00 00 00 00 00 00 00 00 00 00 00 7f 00 06 00 0e 6e 55&gt;
02:23 &lt;Buffer ff 1f 0c <span>01 96</span> 00 fb 00 00 00 00 36 <span>6b</span> 02 08 <span>3b</span> 00 00 00 00 00 00 00 00 00 00 00 80 00 07 00 0f 9b 55&gt;
<b>02:24 &lt;Buffer ff 1f 0c <span>00 00</span> 00 00 00 00 00 00 00 <span>6b</span> 00 00 <span>00</span> 00 00 00 00 00 00 00 00 00 00 00 81 00 07 00 0f f1 55&gt;</b>
02:25 &lt;Buffer ff 1f 0c <span>01 a2</span> 01 02 00 00 00 00 38 <span>6c</span> 02 0f <span>3b</span> 00 00 00 00 00 00 00 00 00 00 00 82 00 07 00 0f 5b 55&gt;
02:26 &lt;Buffer ff 1f 0c <span>01 97</span> 00 fb 00 00 00 00 36 <span>6c</span> 02 08 <span>3b</span> 00 00 00 00 00 00 00 00 00 00 00 83 00 07 00 10 81 55&gt;
                         |                        |        |
                       power                   cadence   resistance</code></pre></div><p>The data at 2:24 shows a blip where power, resistance and some other values briefly drop to 0, while cadence
is unaffected. Then at 2:25 they’re back. It turns out there are several instances of this throughout the data.</p><p>What this means is that you could be riding at a very high effort and all of a sudden your power drops to 0 for a second. Not the end of the world but it has the potential to be annoying. It seems to happen once every few minutes.</p><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/bug.png"></figure><p>Flywheel doesn’t publish any details on how the bike works internally but the original manufacturer does hint at how power is calculated. From the <a href="https://lifefitness.com/facility/products/icg-series/ic5">LifeFitness IC5 page</a>:</p><blockquote><p>WattRate® Power Meter Displays a precise measurement of the user’s effort in watts. This precision is achieved by a positioning sensor that measures the resistance applied to the magnetic brake system.</p></blockquote><p>So the bike doesn’t actually <em>measure</em> power like a power meter would. Instead, it maps the position of the magnetic brake to a point on some factory calibrated curve or lookup table.</p><p>One possible explanation then is that there’s a hardware problem with the positioning sensor or, perhaps more likely, a firmware bug causing resistance to occasionally incorrectly read 0. The power value is derived
from the resistance reading and so it also ends up as 0.</p><p>A simple fix is to just use the previous power value if ever: the cadence is non-zero <em>and</em> the previous power is non-zero <em>and</em> the current power is zero. A slight improvement is to keep track of the slope and factor it in when calculating the predicted value. If the bug occurs during a fast acceleration or deceleration that should give a slightly better result.</p><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/fix.png"></figure><h4 id="the-message-format">The message format</h4><p>What we know about the message so far:</p><div><pre><code data-lang="text">Offset         0  1  2 <span> 3  4</span> <span> 5  6</span>  7  8  9 10 11 <span>12</span> <span>13 14</span> <span>15</span> 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33<br>
02:23 &lt;Buffer ff 1f 0c <span>01 96</span> <span>00 fb</span> 00 00 00 00 36 <span>6b</span> <span>02 08</span> <span>3b</span> 00 00 00 00 00 00 00 00 00 00 00 80 00 07 00 0f 9b 55&gt;
                         |     |                  |    |   |
                       power   |             cadence   |  resistance
                             power%                  speed</code></pre><table><thead><tr><th>Offset</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>3</td><td>Power (watts)</td><td>uint16</td></tr><tr><td>5</td><td>Power (percentage of FTP)</td><td>uint16</td></tr><tr><td>12</td><td>Cadence (rpm)</td><td>uint8</td></tr><tr><td>13</td><td>Speed (km/h × 10)</td><td>uint16</td></tr><tr><td>15</td><td>Resistance (percentage)</td><td>uint8</td></tr></tbody></table><p>We already have what we need but we can make some educated guesses about some of the rest of the packet.</p><p>The name “Nordic UART Service” hints that this protocol was intended for use on a real UART and if so the first and last few bytes would be for serial frame synchronization and error detection.</p><table><thead><tr><th>Offset</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>0</td><td>Start of packet marker (?)</td><td>uint8</td></tr><tr><td>1</td><td>Length (of bytes to follow, excl. end) (?)</td><td>uint8</td></tr><tr><td>2</td><td>Type of payload (?)</td><td>uint8</td></tr><tr><td>26</td><td>Active duration (seconds) (confirmed)</td><td>uint16</td></tr><tr><td>28</td><td>16-bit counter (distance?)</td><td>uint16</td></tr><tr><td>30</td><td>16-bit counter (distance?)</td><td>uint16</td></tr><tr><td>32</td><td>Checksum (xor of 0 and 1..31 inclusive) (confirmed)</td><td>uint8</td></tr><tr><td>33</td><td>End of packet marker (?)</td><td>uint8</td></tr></tbody></table><p>One last small change to our program’s output gives us a really primitive replacement for the Flywheel app’s “free ride” function.</p><div><pre><code data-lang="text">power cadence resistance
  23W   63rpm   0%
  24W   73rpm   0%
  26W   73rpm   0%
  27W   82rpm   0%
  29W   82rpm   0%
  30W   89rpm   0%
  32W   89rpm   0%
  33W   99rpm   0%
  35W  110rpm   0%
  41W  110rpm  15%
  47W  119rpm  15%
  57W  119rpm  20%
  66W  121rpm  19%
  74W  121rpm  24%
  80W  119rpm  23%
  84W  118rpm  24%
 100W  118rpm  32%
 115W  117rpm  35%
 136W  117rpm  40%
 160W  107rpm  41%
 177W  107rpm  41%
</code></pre></div><h3 id="part-2---getting-data-into-zwift">Part 2 - Getting data into Zwift</h3><p>Now that we can get realtime Power and Cadence data from the bike, it’s time to figure out how to communicate with Zwift.</p><p>The plan is to pick a bike that Zwift already supports and mimic it. The first step is to download Zwift and have a look over the website.</p><p>It turns out Zwift supports <em>a lot</em> of devices. It took some research to decide which one to emulate. We want to pick one that is easy to emulate and widely supported by other apps too.</p><p>From the Zwift website <a href="https://zwift.com/hardware">supported devices</a> page:</p><blockquote><p>There are many indoor bikes on the market that use proprietary communication channels. Zwift supports indoor bikes that broadcast power (watts) via ANT+ or Bluetooth Smart (BLE) using open standards.</p></blockquote><p>After looking into ANT+ and Bluetooth LE, I decided to go with Bluetooth LE. ANT+ would have required extra hardware for no obvious benefit in this case.</p><h4 id="bluetooth-le-cycling-power-service">Bluetooth LE Cycling Power Service</h4><p>The Cycling Power Service is what we need to implement. The <a href="https://www.bluetooth.com/specifications/gatt/">spec</a> is available on the official Bluetooth website. It’s very detailed. Here is the relevant summary:</p><dl><dt>Cycling Power Service (UUID 0x1818):</dt><dd><dl><dt>Characteristics:</dt><dd>Cycling Power Feature (UUID 0x2a65) (Read)</dd><dd>Cycling Power Measurement (UUID 0x2a63) (Notify)</dd><dd>Sensor Location (UUID 0x2a5d) (Read)</dd></dl></dd></dl><p>The Cycling Power Feature and Sensor Location characteristics are constants
that tell Zwift what extra features we have (cadence) and where the power measurement is being taken.</p><p>The Cycling Power Measurement characteristic is where the realtime data from the Flywheel bike goes. Power can go in as-is. Cadence needs to be provided in a different format. Rather than periodically telling Zwift an instantaneous cadence like “60 rpm” we need to send two values: the total count of crank revolutions (pedal strokes), and the timestamp of the last crank revolution, then Zwift will calculate the rpm itself.</p><p><a href="https://github.com/abandonware/noble">noble</a>, the Bluetooth client library we used earlier to talk to the bike has a companion library,
<a href="https://github.com/abandonware/bleno">bleno</a>, for writing Bluetooth servers/peripherals, which we’ll use here.</p><p>After some trial and error we end up at the following screen:</p><figure><video autoplay="" loop="" muted="" playsinline="" src="videos/clip_devices.mp4" alt="Sending random power and cadence data to Zwift over Bluetooth." width="100%"></video><figcaption><p>Sending random power and cadence data to Zwift over Bluetooth.</p></figcaption></figure><h3 id="part-3---putting-it-all-together">Part 3 - Putting it all together</h3><p>We can talk to the bike and we can talk to Zwift. Now all that’s left to do is combine the code from parts 1 and 2 and get live data streaming from the bike directly into Zwift.</p><p>The final program:</p><figure><img src="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/img/diagram.png" width="80%"></figure>&nbsp;
&nbsp;
&nbsp;<p>For the most part this went as planned however I did run into one issue.</p><h4 id="bluetooth-le-connection-parameters">Bluetooth LE connection parameters</h4><p>Shortly into the first test ride on the Raspberry Pi the bike lost its Bluetooth connection. I figured maybe it was some wireless interference but it continued to happen.</p><p>Debugging at the application level didn’t reveal any insights or useful error messages so I captured a btsnoop trace with <a href="https://manpages.debian.org/buster/bluez/btmon.1.en.html">btmon</a>.</p><p>The excerpt below shows the disconnection reason. There is a relative timestamp (seconds) on the top-right of log entry.</p><div><pre><code data-lang="text">&gt; HCI Event: Disconnect Complete (0x05) plen 4                                #449 [hci0] 118.546006
        Status: Success (0x00)
        Handle: 64
        Reason: Unacceptable Connection Parameters (0x3b)
</code></pre></div><p>Scrolling back, there is about 30 seconds of successful communication:</p><div><pre><code data-lang="text">&gt; ACL Data RX: Handle 64 flags 0x02 dlen 27                                    #384 [hci0] 87.541516
      ATT: Handle Value Notification (0x1b) len 22
        Handle: 0x000b
          Data: ff1f0c0000000000000000000000002200000000
&gt; ACL Data RX: Handle 64 flags 0x02 dlen 21                                    #385 [hci0] 87.543353
      ATT: Handle Value Notification (0x1b) len 16
        Handle: 0x000b
          Data: 0000000000000000000000003155
</code></pre></div><p>Then the bike asks to update connection parameters and the system rejects the request. The bike continues to send data for 30 more seconds then gives up and disconnects.</p><div><pre><code data-lang="text">&gt; ACL Data RX: Handle 64 flags 0x02 dlen 16                                    #386 [hci0] 88.440929
      LE L2CAP: Connection Parameter Update Request (0x12) ident 6 len 8
        Min interval: 16
        Max interval: 60
        Slave latency: 0
        Timeout multiplier: 400
&lt; ACL Data TX: Handle 64 flags 0x00 dlen 10                                    #387 [hci0] 88.441103
      LE L2CAP: Connection Parameter Update Response (0x13) ident 6 len 2
        Result: Connection Parameters rejected (0x0001)
</code></pre></div><p>The connection parameters are used to control the tradeoff between data throughput and power consumption. The Texas Instruments <a href="https://software-dl.ti.com/lprf/simplelink_cc2640r2_latest/docs/blestack/ble_user_guide/html/ble-stack-3.x/gap.html#connection-parameters">BLE-Stack docs</a> gives a good breakdown of how each parameter works.</p><p>So why is BlueZ rejecting these parameters and can we get it to accept them?</p><p>There are some debugfs endpoints that imply it is possible to control the range of acceptable connection parameters:</p><div><pre><code data-lang="text">/sys/kernel/debug/bluetooth/hci0/conn_min_interval
/sys/kernel/debug/bluetooth/hci0/conn_max_interval
/sys/kernel/debug/bluetooth/hci0/conn_latency
/sys/kernel/debug/bluetooth/hci0/supervision_timeout
</code></pre></div><p>However I was unable to get them to have any impact. The connections continued to be created with unfavorable parameters and the update requests continued to be rejected.</p><p>Next, I tried an option in noble (<code>HCI_CHANNEL_USER</code>) to allow the application to handle these requests directly. This fixed the immediate problem but presented a new problem. <code>HCI_CHANNEL_USER</code> gives noble exclusive access to the Bluetooth adapter and prevents bleno from working. After reading over the noble and bleno code it didn’t seem like there was an easy way to have them co-operate on a single exclusive socket.</p><p>After reading over the linux-bluetooth mailing list and some searching, I stumbled upon this <a href="https://github.com/IanHarvey/bluepy/issues/117#issuecomment-222049293">GitHub issue</a> where a poster mentioned they had success using <a href="https://manpages.debian.org/buster/bluez/hcitool.1.en.html">hcitool</a> to update the parameters on a connection.</p><p>For the Flywheel bike the command used is:</p><div><pre><code data-lang="text">hcitool lecup --handle 64 --min 16 --max 60 --latency 0 --timeout 400
</code></pre></div><p>(Note: the min and max are in units of 1.25ms and timeout is in units of 10ms.)</p><p>The log below shows the above command successfully updates the connection parameters:</p><div><pre><code data-lang="text">@ RAW Open: hcitool (privileged) version 2.22                                     {0x0006} 81.324864
@ RAW Close: hcitool                                                              {0x0006} 81.328082
@ RAW Open: hcitool (privileged) version 2.22                              {0x0006} [hci0] 81.329693
&lt; HCI Command: LE Connection Update (0x08|0x0013) plen 14                      #388 [hci0] 81.331279
        Handle: 64
        Min connection interval: 20.00 msec (0x0010)
        Max connection interval: 75.00 msec (0x003c)
        Connection latency: 0 (0x0000)
        Supervision timeout: 4000 msec (0x0190)
        Min connection length: 0.625 msec (0x0001)
        Max connection length: 0.625 msec (0x0001)
&gt; HCI Event: Command Status (0x0f) plen 4                                      #389 [hci0] 81.333532
      LE Connection Update (0x08|0x0013) ncmd 1
        Status: Success (0x00)
&gt; HCI Event: LE Meta Event (0x3e) plen 10                                      #392 [hci0] 81.841057
      LE Connection Update Complete (0x03)
        Status: Success (0x00)
        Handle: 64
        Connection interval: 75.00 msec (0x003c)
        Connection latency: 0 (0x0000)
        Supervision timeout: 4000 msec (0x0190)
@ RAW Close: hcitool                                                       {0x0006} [hci0] 81.842147
&gt; ACL Data RX: Handle 64 flags 0x02 dlen 27                                    #393 [hci0] 82.441717
      ATT: Handle Value Notification (0x1b) len 22
        Handle: 0x000b
          Data: ff1f0c0000000000000000000000002100000000
&gt; ACL Data RX: Handle 64 flags 0x02 dlen 21                                    #394 [hci0] 82.591155
      ATT: Handle Value Notification (0x1b) len 16
        Handle: 0x000b
          Data: 0000000000000000000000003255
</code></pre></div><p>30 seconds later we’re still connected and receiving data from the bike…</p><div><pre><code data-lang="text">&gt; ACL Data RX: Handle 64 flags 0x02 dlen 27                                   #453 [hci0] 112.441630
      ATT: Handle Value Notification (0x1b) len 22
        Handle: 0x000b
          Data: ff1f0c0000000000000000000000002100000000
&gt; ACL Data RX: Handle 64 flags 0x02 dlen 21                                   #454 [hci0] 112.516077
      ATT: Handle Value Notification (0x1b) len 16
        Handle: 0x000b
          Data: 0000000000000000000000003255
&gt; ACL Data RX: Handle 64 flags 0x02 dlen 27                                   #455 [hci0] 113.416650
      ATT: Handle Value Notification (0x1b) len 22
        Handle: 0x000b
          Data: ff1f0c0000000000000000000000002100000000
&gt; ACL Data RX: Handle 64 flags 0x02 dlen 21                                   #456 [hci0] 113.566099
      ATT: Handle Value Notification (0x1b) len 16
        Handle: 0x000b
          Data: 0000000000000000000000003255
</code></pre></div><p>60 seconds later we’re still connected and receiving data from the bike…</p><div><pre><code data-lang="text">&gt; ACL Data RX: Handle 64 flags 0x02 dlen 27                                   #525 [hci0] 148.516576
      ATT: Handle Value Notification (0x1b) len 22
        Handle: 0x000b
          Data: ff1f0c0000000000000000000000002100000000
&gt; ACL Data RX: Handle 64 flags 0x02 dlen 21                                   #526 [hci0] 148.666003
      ATT: Handle Value Notification (0x1b) len 16
        Handle: 0x000b
          Data: 0000000000000000000000003255
</code></pre></div><p>Problem solved! Fortunately this was the end of the disconnects.</p><p>The dependency on hcitool is not ideal. I’d still like to know what was going on with the debugfs endpoints or how to otherwise influence BlueZ to accept these connection parameters. If you have any ideas let me know.</p><p>It is worth noting that the HCI socket interface used by noble and bleno is deprecated by BlueZ in favor of the D-Bus API.</p><h4 id="deploying">Deploying</h4><p>The final step is to set this up on the Raspberry Pi Zero W to start on boot and restart on failure. Whenever the Raspberry Pi is plugged-in and within range, we can jump on the bike and start the Zwift app and everything should just work.</p><p>First, the <code>node</code> binary needs permission to advertise Bluetooth services:</p><div><pre><code data-lang="text">sudo setcap cap_net_raw+eip /usr/local/bin/node
</code></pre></div><p>And the following <code>systemd</code> unit file takes care of starting the application at boot and keeping it running:</p><div><pre><code data-lang="text">[Unit]
Description=Gymnasticon
After=bluetooth.target
Requires=bluetooth.target

[Service]
Type=simple
Environment=
WorkingDirectory=/home/pi
User=pi
Group=pi
ExecStart=/usr/local/bin/gymnasticon
RestartSec=1
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre></div><p>The first test ride in action. Note the bike has a convenient USB charging port that can power the Pi.</p><figure><video autoplay="" loop="" muted="" playsinline="" src="videos/vid2.mp4" alt="Zwift working with the Flywheel Home Bike with the help of a Raspberry Pi." width="100%"></video><figcaption><p>Zwift working with the Flywheel Home Bike with the help of a Raspberry Pi.</p></figcaption></figure><h3 id="conclusion">Conclusion</h3><p>This has been in daily use for over 2,000 miles and works really well.</p><p>Zwift is a lot of fun.</p><p>TrainerRoad and Rouvy work but I haven’t used them much.</p><p>The Raspberry Pi Zero W is very versatile and affordable. It’s great that it can be powered by USB.</p><p>The Flywheel Home Bike is a very solid build quality bike. I’m glad to have found a way to reuse it.</p><h3 id="todo">Todo</h3><ol><li><p>Figure out the Bluetooth messages that need to be sent to calibrate the bike. The first pass at this would be to use the ICG Training App to perform the calibration procedure while using Bluetooth developer tools on the device or a sniffing proxy.</p></li><li><p>Add a motor to the resistance dial and implement the Bluetooth Fitness Machine Service so Zwift can control the resistance.</p></li></ol></div></article></div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>