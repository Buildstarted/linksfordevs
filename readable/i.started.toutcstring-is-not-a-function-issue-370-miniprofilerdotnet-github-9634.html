<!DOCTYPE html>
<html lang="en">
<head>
    <title>linksfor.dev(s)</title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">ðŸŽ‰</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <div class="readable">
        <h1>Uncaught TypeError: i.Started.toUTCString is not a function &#xB7; Issue #370 &#xB7; MiniProfiler/dotnet</h1>
        <p>
by tomglover24 <br/>Reading time: 5-7 minutes        </p>
        <p><a href="https://github.com/MiniProfiler/dotnet/issues/370">https://github.com/MiniProfiler/dotnet/issues/370</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div disabled="" sortable="">
<div>
          <p>I was looking to integrate MiniProfiler to an ASP.net Core 2.2 MVC app and have come across a rendering issue. This issue only affects rendering of the MiniProfiler widget and seems to be related to the format that Started is being provided in JSON back to the widget.</p>
<p><strong>Setup</strong></p>
<ul>
<li>.Net Core 2.2</li>
<li>ASP.Net Core 2.2.0 MVC</li>
<li>MiniProfiler.AspNetCore.Mvc 4.0.165</li>
<li>MiniProfiler.Providers.MySql 4.0.165</li>
<li>Default config from the getting started page, with the exception of:</li>
</ul>
<div><pre><span>options</span>.<span>Storage</span> <span>=</span> <span>new</span> <span>MySqlStorage</span>(<span>Configuration</span>[<span><span>"</span>ConnectionStrings:DefaultConnection<span>"</span></span>]);</pre></div>
<p><strong>The Full Error</strong></p>
<pre><code>Uncaught TypeError: i.Started.toUTCString is not a function
    at n.renderProfiler (includes.min.js?v=4.0.165+g04f8ac4653:formatted:4790)
    at n.buttonShow (includes.min.js?v=4.0.165+g04f8ac4653:formatted:4800)
    at Object.success (includes.min.js?v=4.0.165+g04f8ac4653:formatted:4552)
    at l (includes.min.js?v=4.0.165+g04f8ac4653:formatted:1825)
    at Object.fireWith [as resolveWith] (includes.min.js?v=4.0.165+g04f8ac4653:formatted:1876)
    at b (includes.min.js?v=4.0.165+g04f8ac4653:formatted:3539)
    at XMLHttpRequest.&lt;anonymous&gt; (includes.min.js?v=4.0.165+g04f8ac4653:formatted:3757)
</code></pre>
<p><strong>Example JS Response</strong></p>
<div><pre>{"Id":"d0d344d0-fed2-4215-9bcd-71039db08141","Name":"Home/Index","Started":"2019-03-16T15:54:50Z","DurationMilliseconds":3.0,"MachineName":"LDCL139658","Root":{"Id":"4649f8ab-5119-483c-9025-aedcf7c58ac4","Name":"https://localhost:44326/","DurationMilliseconds":3.000,"StartMilliseconds":0.000,"Children":[{"Id":"60d2bc5d-6ca1-4f55-b551-9a90b707eef4","Name":"MiniProfiler Prep","DurationMilliseconds":1.400,"StartMilliseconds":0.000},{"Id":"7c551655-915b-4995-82a8-b620f9b41937","Name":"Controller: Home.Index","DurationMilliseconds":0.000,"StartMilliseconds":1.600},{"Id":"6dba533e-96df-425d-a81f-6583fdc89146","Name":"Find: Index","DurationMilliseconds":0.000,"StartMilliseconds":1.600},{"Id":"0fb7b931-b50d-43a4-bf01-9184033e9fc7","Name":"Render: /Views/Home/Index.cshtml","DurationMilliseconds":0.700,"StartMilliseconds":1.700,"Children":[{"Id":"7b4023c6-4c7b-40c2-855b-b87b7f1c3939","Name":"Find: _CookieConsentPartial","DurationMilliseconds":0.000,"StartMilliseconds":2.200},{"Id":"ecbdccb1-b652-42d5-b8c1-0550a8290190","Name":"Render: /Views/Shared/_CookieConsentPartial.cshtml","DurationMilliseconds":0.000,"StartMilliseconds":2.300}]}]},"ClientTimings":{"RedirectCount":0,"Timings":[{"Name":"fetchStart","Start":0.0,"Duration":0.0},{"Name":"domainLookupStart","Start":0.0,"Duration":0.0},{"Name":"connectStart","Start":0.0,"Duration":0.0},{"Name":"requestStart","Start":3.0,"Duration":11.0},{"Name":"responseStart","Start":14.0,"Duration":13.0},{"Name":"domLoading","Start":27.0,"Duration":36.0},{"Name":"firstPaintTime","Start":220.0,"Duration":0.0},{"Name":"domInteractive","Start":282.0,"Duration":0.0},{"Name":"domContentLoadedEventStart","Start":282.0,"Duration":1.0},{"Name":"domComplete","Start":316.0,"Duration":0.0},{"Name":"loadEventStart","Start":316.0,"Duration":0.0}]},"User":"4","HasUserViewed":true}</pre></div>
<p>The key value being "Started":"2019-03-16T15:54:50Z"</p>
<p>Looking through the source I think I may have traced this to how the js handles the full page rendering and button rendering specifically JSON Ajax response is parsed using this regex:<br>
</p><div>
  
    <div itemprop="text">
    <table data-tab-size="8">

        <tbody><tr>
          <td id="L418" data-line-number="418"></td>
          <td id="LC418"> <span><span>const</span></span> isoDate <span>=</span> <span><span>/</span><span>^</span>(<span>\d</span><span>{4}</span>)-(<span>\d</span><span>{2}</span>)-(<span>\d</span><span>{2}</span>)T(<span>\d</span><span>{2}</span>):(<span>\d</span><span>{2}</span>):(<span>\d</span><span>{2}</span>(?:<span>\.</span><span>\d</span><span>*</span>))(?:Z<span>|</span>(<span>\+</span><span>|</span>-)(<span>[<span>\d</span>|:]</span><span>*</span>))<span>?</span><span>$</span><span>/</span></span>; </td>
        </tr>

        <tr>
          <td id="L419" data-line-number="419"></td>
          <td id="LC419"> <span><span>const</span></span> parseDates <span>=</span> (<span>key</span><span>:</span> <span>string</span>, <span>value</span><span>:</span> <span>any</span>) <span>=&gt;</span> </td>
        </tr>

        <tr>
          <td id="L420" data-line-number="420"></td>
          <td id="LC420">           <span>key</span> <span>===</span> <span><span>'</span>Started<span>'</span></span> <span>&amp;&amp;</span> <span>typeof</span> <span>value</span> <span>===</span> <span><span>'</span>string<span>'</span></span> <span>&amp;&amp;</span> <span>isoDate</span>.<span>exec</span>(<span>value</span>) <span>?</span> <span>new</span> <span>Date</span>(<span>value</span>) <span>:</span> <span>value</span>; </td>
        </tr>

        <tr>
          <td id="L421" data-line-number="421"></td>
          <td id="LC421">  </td>
        </tr>

        <tr>
          <td id="L422" data-line-number="422"></td>
          <td id="LC422"> <span>mp</span>.<span>fetchStatus</span>[<span>id</span>] <span>=</span> <span><span>'</span>Starting fetch<span>'</span></span>; </td>
        </tr>

        <tr>
          <td id="L423" data-line-number="423"></td>
          <td id="LC423"> <span>this</span>.<span>jq</span>.<span>ajax</span>({ </td>
        </tr>

        <tr>
          <td id="L424" data-line-number="424"></td>
          <td id="LC424">     url: <span>this</span>.<span>options</span>.<span>path</span> <span>+</span> <span><span>'</span>results<span>'</span></span>, </td>
        </tr>

        <tr>
          <td id="L425" data-line-number="425"></td>
          <td id="LC425">     data: <span>JSON</span>.<span>stringify</span>(<span>request</span>), </td>
        </tr>

        <tr>
          <td id="L426" data-line-number="426"></td>
          <td id="LC426">     dataType: <span><span>'</span>json<span>'</span></span>, </td>
        </tr>

        <tr>
          <td id="L427" data-line-number="427"></td>
          <td id="LC427">     contentType: <span><span>'</span>application/json<span>'</span></span>, </td>
        </tr>

        <tr>
          <td id="L428" data-line-number="428"></td>
          <td id="LC428">     type: <span><span>'</span>POST<span>'</span></span>, </td>
        </tr>

        <tr>
          <td id="L429" data-line-number="429"></td>
          <td id="LC429">     converters: { </td>
        </tr>

        <tr>
          <td id="L430" data-line-number="430"></td>
          <td id="LC430">         <span><span>'</span>text json<span>'</span></span>: (<span>result</span>) <span>=&gt;</span> <span>JSON</span>.<span>parse</span>(<span>result</span>, <span>parseDates</span>), </td>
        </tr>

        <tr>
          <td id="L431" data-line-number="431"></td>
          <td id="LC431">     }, </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p>Vs the full html page which takes a JS object, assumes the string is correct and just parses it:<br>
</p><div>
  
    <div itemprop="text">
    <table data-tab-size="8">

        <tbody><tr>
          <td id="L325" data-line-number="325"></td>
          <td id="LC325"> <span><span>//</span> profiler will be defined in the full page's head</span> </td>
        </tr>

        <tr>
          <td id="L326" data-line-number="326"></td>
          <td id="LC326"> <span>window</span>.<span>profiler</span>.<span>Started</span> <span>=</span> <span>new</span> <span>Date</span>(<span><span>'</span><span>'</span></span> <span>+</span> <span>window</span>.<span>profiler</span>.<span>Started</span>); <span><span>//</span> Ugh, JavaScript</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p><strong>The Underlying Fault</strong><br>
The underlying fault seems to be the lack of precision returned from MySQL causing the iso date format to be simplified when converted to a string, ignoring the micro seconds.</p>
<p>A small change to the regex string used to Parse the dates to allow for optional micro seconds resolves the parsing issue:</p>
<div><pre><span>isoDate</span> <span>=</span> <span><span>/</span><span>^</span>(<span>\d</span><span>{4}</span>)-(<span>\d</span><span>{2}</span>)-(<span>\d</span><span>{2}</span>)T(<span>\d</span><span>{2}</span>):(<span>\d</span><span>{2}</span>):(<span>\d</span><span>{2}</span>(?:<span>\.</span><span>\d</span><span>*</span>)<span>?</span>)(?:Z<span>|</span>(<span>\+</span><span>|</span>-)(<span>[<span>\d</span>|:]</span><span>*</span>))<span>?</span><span>$</span><span>/</span></span>;</pre></div>
<p>Sorry if this was not enough detail or incorrectly formatted, this is my first OSS issue.</p>
<p>I will try and create a pull request for this too, I haven't built the full repo to test the fix, as I don't know how and have never used typescript, I'm still learning C# with simple repos.</p>
      </div>
</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>