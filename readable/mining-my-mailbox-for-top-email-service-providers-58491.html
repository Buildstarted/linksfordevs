<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Mining my mailbox for top email service providers - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Mining my mailbox for top email service providers - linksfor.dev(s)"/>
    <meta property="og:description" content="I was reviewing some stats for Mailintel and was curious about what email service top apps use; being particularly interested in transactional email services. Is there a way I can go through my mai..."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://obem.be/2020/02/18/mining-my-mailbox-for-top-email-service-providers.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Mining my mailbox for top email service providers</title>
<div class="readable">
        <h1>Mining my mailbox for top email service providers</h1>
            <div>Reading time: 8-10 minutes</div>
        <div>Posted here: 18 Feb 2020</div>
        <p><a href="https://obem.be/2020/02/18/mining-my-mailbox-for-top-email-service-providers.html">https://obem.be/2020/02/18/mining-my-mailbox-for-top-email-service-providers.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
    <nav>
        <a href="https://obem.be/opeyemi">/Opeyemi</a> <span>·</span> <a href="https://obem.be/posts">Blog Posts</a> <span>·</span> <a href="https://thenow.page/kehers">Now</a> <span>·</span> <a href="http://everygood.co/" target="_blank">Projects</a>
    </nav>

    <section>
      <article>
        <date>18 Feb 2020</date>
        
        <p>I was reviewing some stats for <a href="https://mailintel.io/?ref=oo">Mailintel</a> and was curious about what email service top apps use; being particularly interested in transactional email services. Is there a way I can go through my mailbox, check product emails and check the service for each? Sounds like a fun experiment to give a shot.</p>

<h3 id="connecting-my-mailbox">Connecting my mailbox</h3>
<p>With my recent <a href="https://obem.be/2019/05/01/imap-new-messages-since-last-check.html">experiments with IMAP</a>, connecting to my mailbox wasn’t difficult. I am using <a href="https://github.com/emailjs/emailjs-imap-client">emailjs-imap-client</a>, a JS IMAP client.</p>

<div><div><pre><code><span>const</span> <span>ImapClient</span> <span>=</span> <span>require</span><span>(</span><span>'</span><span>emailjs-imap-client</span><span>'</span><span>).</span><span>default</span>

<span>;(</span><span>async</span> <span>function</span> <span>()</span> <span>{</span>
  <span>try</span> <span>{</span>
    <span>const</span> <span>confOption</span> <span>=</span> <span>{</span>
      <span>auth</span><span>:</span> <span>{</span>
        <span>user</span><span>:</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>EMAIL</span><span>,</span>
        <span>pass</span><span>:</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>PASS</span>
      <span>},</span>
      <span>logLevel</span><span>:</span> <span>'</span><span>error</span><span>'</span>
    <span>}</span>

    <span>if</span> <span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>PORT</span> <span>===</span> <span>'</span><span>993</span><span>'</span><span>){</span> <span>confOption</span><span>.</span><span>useSecureTransport</span> <span>=</span> <span>true</span> <span>}</span>
    <span>const</span> <span>imap</span> <span>=</span> <span>new</span> <span>ImapClient</span><span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>HOST</span><span>,</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>PORT</span><span>,</span> <span>confOption</span><span>)</span>
    <span>await</span> <span>imap</span><span>.</span><span>connect</span><span>()</span>
  <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>e</span><span>)</span>
  <span>}</span>
<span>})()</span>
</code></pre></div></div>

<p>My environmental variables look something like this:</p>

<div><div><pre><code>EMAIL="myemail@yahoo.com"
PASS="mypassword"
PORT=993
HOST="imap.mail.yahoo.com"
</code></pre></div></div>

<p>If you are connecting to a Yahoo mail, you will need to <a href="https://help.yahoo.com/kb/generate-third-party-passwords-sln15241.html">generate an app password</a>. Using your real email password won’t work.&nbsp;Gmail is a little more complex. To start with, you neexd to <a href="https://support.google.com/mail/answer/7126229?hl=en">enable IMAP access</a> your account. You can then go with any of the options:</p>

<ol>
  <li><a href="https://myaccount.google.com/lesssecureapps?pli=1">Allow less secure apps</a>. But don’t forget to turn this off once you are done with the experiment. If you still can’t connect, you may need to <a href="https://accounts.google.com/b/0/displayunlockcaptcha">allow app access to your account</a>.</li>
  <li><a href="https://support.google.com/mail/answer/185833?hl=en">Create an app password</a> (more secured option).</li>
</ol>

<h3 id="checking-product-emails">Checking <del>product</del> emails</h3>
<p>Getting product emails is a tricky one. How do you identify product emails from regular emails? How do you differentiate marketing from transactional emails? This can be done but the ideas I came up with were not worth the effort. In the end, I decided to pull all the emails instead. (This was also easier because I have a Yahoo mail dedicated to product signups, subscriptions and newsletters <sup id="fnref:1"><a href="#fn:1">1</a></sup>).</p>

<div><div><pre><code><span>const</span> <span>ImapClient</span> <span>=</span> <span>require</span><span>(</span><span>'</span><span>emailjs-imap-client</span><span>'</span><span>).</span><span>default</span>

<span>;(</span><span>async</span> <span>function</span> <span>()</span> <span>{</span>
  <span>try</span> <span>{</span>
    <span>// …connection code</span>
    <span>await</span> <span>imap</span><span>.</span><span>connect</span><span>()</span>
    <span>const</span> <span>box</span> <span>=</span> <span>await</span> <span>imap</span><span>.</span><span>selectMailbox</span><span>(</span><span>'</span><span>INBOX</span><span>'</span><span>)</span>

    <span>// Reading 5k mails at once can choke the process so let's chunk into 50 mails per request. We are also assuming there are &gt; 5k emails in the mailbox</span>
    <span>let</span> <span>start</span> <span>=</span> <span>+</span><span>box</span><span>.</span><span>exists</span> <span>-</span> <span>5000</span>
    <span>while</span> <span>(</span><span>true</span><span>)</span> <span>{</span>
      <span>const</span> <span>messages</span> <span>=</span> <span>await</span> <span>imap</span><span>.</span><span>listMessages</span><span>(</span><span>'</span><span>INBOX</span><span>'</span><span>,</span> <span>`</span><span>${</span><span>start</span> <span>+</span> <span>1</span><span>}</span><span>:</span><span>${</span><span>start</span> <span>+</span> <span>50</span><span>}</span><span>`</span><span>,</span> <span>[</span><span>'</span><span>uid</span><span>'</span><span>,</span> <span>'</span><span>body[]</span><span>'</span><span>])</span>
      <span>if</span> <span>(</span><span>!</span><span>Array</span><span>.</span><span>isArray</span><span>(</span><span>messages</span><span>))</span> <span>{</span> <span>return</span> <span>}</span>
      <span>// Do stuff with email here</span>
      <span>start</span> <span>+=</span> <span>50</span>
      <span>if</span> <span>(</span><span>start</span> <span>&gt;=</span> <span>+</span><span>box</span><span>.</span><span>exists</span><span>)</span> <span>{</span> <span>break</span> <span>}</span>
    <span>}</span>
  <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>e</span><span>)</span>
  <span>}</span>
<span>})()</span>
</code></pre></div></div>

<h3 id="checking-the-service-provider">Checking the service provider</h3>
<p>How do I know the email service used for the mail? I checked a couple of email headers and noticed a couple of places the provider details can be extracted from. Here is what an email header looks like:</p>

<p><img src="https://obem.be/assets/image/2020/02/headers.png" alt=""></p>

<p>At first glance at some headers, the <code>message-id</code> header looks the most straight forward. Here are a couple of message IDs from 3 different mail headers.&nbsp;</p>

<div><div><pre><code>Message-ID: &lt;22.BD.09488.F97644E5@ar.mta1vrest.cc.prd.sparkpost&gt;
Message-ID: &lt;4ebb47b9-4454-afc4-e6448cd22897-000000@email.amazonses.com&gt;
Message-ID: &lt;ZCA0TmwnS-SqPHh2_-gciw@ismtpd0039p1iad2.sendgrid.net&gt;
</code></pre></div></div>

<p>By looking at the host part of the <code>message-id</code>, it’s easy to know the service provider. But not so fast. Looking at more headers, I noticed some message IDs have a host that is different from the sender value in the <code>received</code> header. Below are examples from Bitbucket and Letsencrypt. (Some parts truncated for brevity).</p>

<div><div><pre><code>Message-ID: &lt;pr-~@bitbucket.org&gt;
Received: by filter0225p1iad2.sendgrid.net with ~
</code></pre></div></div>
<div><div><pre><code>Message-Id: &lt;~.expiry@letsencrypt.org&gt;
Received: from mail132-5.atl131.mandrillapp.com ~
</code></pre></div></div>

<p>The <code>received</code> headers seem the most accurate place to get the provider but it poses its challenges. They are structured in different ways depending on how the mail is sent. After reviewing a couple of headers in Yahoo mail, I was able to find a pattern to match the provider. (Not 100% accurate).</p>

<ol>
  <li>For more than one <code>received</code> header, match <code>by *</code> of the second <code>received</code> header.&nbsp;</li>
  <li>If that doesn’t exist or does not have a host address or there is just one <code>received</code> header, then match <code>(EHLO *)</code> in the first <code>received</code> header.</li>
</ol>

<p>Now we can rewrite our script to use <code>received</code> headers. To be able to easily extract this, I will be bringing in <a href="https://github.com/nodemailer/mailparser">Mailparser</a>.</p>

<div><div><pre><code><span>const</span> <span>ImapClient</span> <span>=</span> <span>require</span><span>(</span><span>'</span><span>emailjs-imap-client</span><span>'</span><span>).</span><span>default</span>
<span>const</span> <span>simpleParser</span> <span>=</span> <span>require</span><span>(</span><span>'</span><span>mailparser</span><span>'</span><span>).</span><span>simpleParser</span>
<span>const</span> <span>PULL</span> <span>=</span> <span>10000</span>

<span>;(</span><span>async</span> <span>function</span> <span>()</span> <span>{</span>
  <span>const</span> <span>sites</span> <span>=</span> <span>{}</span>
  <span>try</span> <span>{</span>
    <span>const</span> <span>confOption</span> <span>=</span> <span>{</span>
      <span>auth</span><span>:</span> <span>{</span>
        <span>user</span><span>:</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>EMAIL</span><span>,</span>
        <span>pass</span><span>:</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>PASS</span>
      <span>},</span>
      <span>logLevel</span><span>:</span> <span>'</span><span>error</span><span>'</span>
    <span>}</span>

    <span>if</span> <span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>PORT</span> <span>===</span> <span>'</span><span>993</span><span>'</span><span>)</span> <span>{</span> <span>confOption</span><span>.</span><span>useSecureTransport</span> <span>=</span> <span>true</span> <span>}</span>
    <span>const</span> <span>imap</span> <span>=</span> <span>new</span> <span>ImapClient</span><span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>HOST</span><span>,</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>PORT</span><span>,</span> <span>confOption</span><span>)</span>
    <span>await</span> <span>imap</span><span>.</span><span>connect</span><span>()</span>
    <span>const</span> <span>box</span> <span>=</span> <span>await</span> <span>imap</span><span>.</span><span>selectMailbox</span><span>(</span><span>'</span><span>INBOX</span><span>'</span><span>)</span>
    <span>const</span> <span>exists</span> <span>=</span> <span>+</span><span>box</span><span>.</span><span>exists</span>

    <span>if</span> <span>(</span><span>exists</span> <span>&lt;=</span> <span>PULL</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>'</span><span>You specified a pull number more than or equal to the number of emails in the mailbox</span><span>'</span><span>)</span>
      <span>return</span>
    <span>}</span>
    <span>let</span> <span>start</span> <span>=</span> <span>exists</span> <span>-</span> <span>PULL</span>
    <span>while</span> <span>(</span><span>true</span><span>)</span> <span>{</span>
      <span>const</span> <span>messages</span> <span>=</span> <span>await</span> <span>imap</span><span>.</span><span>listMessages</span><span>(</span><span>'</span><span>INBOX</span><span>'</span><span>,</span> <span>`</span><span>${</span><span>start</span> <span>+</span> <span>1</span><span>}</span><span>:</span><span>${</span><span>start</span> <span>+</span> <span>50</span><span>}</span><span>`</span><span>,</span> <span>[</span><span>'</span><span>uid</span><span>'</span><span>,</span> <span>'</span><span>body[]</span><span>'</span><span>])</span>

      <span>if</span> <span>(</span><span>!</span><span>Array</span><span>.</span><span>isArray</span><span>(</span><span>messages</span><span>))</span> <span>{</span> <span>return</span> <span>}</span>
      <span>for</span> <span>(</span><span>const</span> <span>message</span> <span>of</span> <span>messages</span><span>)</span> <span>{</span>
        <span>const</span> <span>mail</span> <span>=</span> <span>await</span> <span>simpleParser</span><span>(</span><span>message</span><span>[</span><span>'</span><span>body[]</span><span>'</span><span>])</span>
        <span>const</span> <span>headers</span> <span>=</span> <span>mail</span><span>.</span><span>headers</span><span>.</span><span>get</span><span>(</span><span>'</span><span>received</span><span>'</span><span>)</span>
        <span>let</span> <span>esp</span>
        <span>if</span> <span>(</span><span>headers</span><span>.</span><span>length</span> <span>&gt;</span> <span>1</span><span>)</span> <span>{</span>
          <span>const</span> <span>header</span> <span>=</span> <span>headers</span><span>[</span><span>1</span><span>]</span>
          <span>const</span> <span>match</span> <span>=</span> <span>header</span><span>.</span><span>match</span><span>(</span><span>/by </span><span>([^\s]</span><span>*</span><span>)</span><span>/</span><span>)</span>
          <span>if</span> <span>(</span><span>match</span> <span>&amp;&amp;</span> <span>match</span><span>.</span><span>length</span> <span>&gt;</span> <span>1</span> <span>&amp;&amp;</span> <span>match</span><span>[</span><span>1</span><span>].</span><span>indexOf</span><span>(</span><span>'</span><span>.</span><span>'</span><span>)</span> <span>!==</span> <span>-</span><span>1</span><span>)</span> <span>{</span>
            <span>esp</span> <span>=</span> <span>match</span><span>[</span><span>1</span><span>].</span><span>split</span><span>(</span><span>'</span><span>.</span><span>'</span><span>).</span><span>slice</span><span>(</span><span>-</span><span>2</span><span>).</span><span>join</span><span>(</span><span>'</span><span>.</span><span>'</span><span>)</span>
          <span>}</span>
        <span>}</span>
        <span>if</span> <span>(</span><span>!</span><span>esp</span><span>)</span> <span>{</span>
          <span>const</span> <span>header</span> <span>=</span> <span>Array</span><span>.</span><span>isArray</span><span>(</span><span>headers</span><span>)</span> <span>?</span> <span>headers</span><span>[</span><span>0</span><span>]</span> <span>:</span> <span>headers</span>
          <span>const</span> <span>match</span> <span>=</span> <span>header</span><span>.</span><span>match</span><span>(</span><span>/EHLO </span><span>([^</span><span>)</span><span>]</span><span>*</span><span>)</span><span>/</span><span>)</span>
          <span>if</span> <span>(</span><span>match</span> <span>&amp;&amp;</span> <span>match</span><span>.</span><span>length</span> <span>&gt;</span> <span>1</span> <span>&amp;&amp;</span> <span>match</span><span>[</span><span>1</span><span>].</span><span>indexOf</span><span>(</span><span>'</span><span>.</span><span>'</span><span>)</span> <span>!==</span> <span>-</span><span>1</span><span>)</span> <span>{</span>
            <span>esp</span> <span>=</span> <span>match</span><span>[</span><span>1</span><span>].</span><span>split</span><span>(</span><span>'</span><span>.</span><span>'</span><span>).</span><span>slice</span><span>(</span><span>-</span><span>2</span><span>).</span><span>join</span><span>(</span><span>'</span><span>.</span><span>'</span><span>)</span>
          <span>}</span>
        <span>}</span>
        <span>if</span> <span>(</span><span>!</span><span>esp</span><span>)</span> <span>{</span>
          <span>// Todo: Track failed matches</span>
          <span>continue</span>
        <span>}</span>
        <span>if</span> <span>(</span><span>sites</span><span>[</span><span>esp</span><span>])</span> <span>{</span>
          <span>sites</span><span>[</span><span>esp</span><span>]</span><span>++</span>
        <span>}</span> <span>else</span> <span>{</span>
          <span>sites</span><span>[</span><span>esp</span><span>]</span> <span>=</span> <span>1</span>
        <span>}</span>
      <span>}</span>
      <span>start</span> <span>+=</span> <span>50</span>
      <span>if</span> <span>(</span><span>start</span> <span>&gt;=</span> <span>exists</span><span>)</span> <span>{</span> <span>break</span> <span>}</span>
    <span>}</span>

    <span>await</span> <span>imap</span><span>.</span><span>logout</span><span>()</span>
    <span>await</span> <span>imap</span><span>.</span><span>close</span><span>()</span>
  <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>e</span><span>)</span>
  <span>}</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>sites</span><span>)</span>
<span>})()</span>
</code></pre></div></div>

<h3 id="results">Results</h3>
<p>This was the breakdown after stripping the results to the top ones.</p>

<p><img src="https://obem.be/assets/image/2020/02/breakdown.png" alt=""></p>

<p>Few notes:</p>
<ul>
  <li>rsgsv.net, mcsv.net and mcdlv.net are from <a href="http://mailchimp.com/">Mailchimp</a>. As you know, Mailchimp provides marketing email service. Mandrillapp.com is the transactional email service for Mailchimp. It used to be a standalone service until it became deeply integrated into Mailchimp.</li>
  <li>spmta.com is for <a href="http://sparkpost.com/">Sparkpost</a>.</li>
  <li>marketo.org is for <a href="http://marketo.com/">Marketo.com</a>, currently owned by Adobe. Provides marketing email service.</li>
  <li>Interesting to see <a href="http://intercom.com/">Intercom</a> there. It’s amazing the number of products using Intercom for customer engagement.</li>
  <li>mailgun.net and mailgun.org belong to <a href="http://mailgun.com/">Mailgun</a>, obviously. Mailgun also recently acquired <a href="http://mailjet.com/">Mailjet</a>. Mailjet provides both marketing and transactional email services. It will take more deep-diving into the headers (or content) to figure if the mail was sent as a marketing or transactional email.</li>
  <li><a href="http://sendgrid.com/">Sendgrid</a>, also like Mailjet, offers both marketing and transactional email services. It’s the most used from my experiment but it’s hard to know what fraction of that is marketing and what other is transactional. PS: they were recently acquired by Twilio.</li>
</ul>

<h3 id="conclusion">Conclusion</h3>
<p>I merged the same providers for a more accurate chart.&nbsp;</p>

<p><img src="https://obem.be/assets/image/2020/02/breakdown-merged.png" alt=""></p>

<p>This is only a fun experiment and doesn’t show the true market share of the services. Since the data is based on the product emails in just my mailbox, it is flawed by selection bias. However, it’s something you can run on your mailbox for the fun of it. You can also extend it to see what service your favourite product/app uses. Remember, you may need to look at the full headers of some of your emails to come up with the best way to know the service provider.&nbsp;</p>

<p>By the way, if you use Mailgun or Amazon SES for transactional emails, check out <a href="https://mailintel.io/?ref=oo">Mailintel</a> for detailed analytics, reporting and business intelligence.</p>

<p>-</p>



      </article>
      
      
      <p>My name is Opeyemi Obembe. I build things for web and mobile and write about my experiments. Follow me on Twitter–<a href="http://twitter.com/kehers">@kehers</a>.</p>

      
      
      
      <p>Next post: <a href="https://obem.be/2019/09/20/the-now-page.html">The Now page</a></p>
      
    </section>
  </div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>