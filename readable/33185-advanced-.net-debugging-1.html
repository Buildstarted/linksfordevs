<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Advanced .NET Debugging #1 -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Advanced .NET Debugging #1</h1>
    <article class="post-content"> <p>After eyeing it for a while I finally decided to buy <a href="https://www.goodreads.com/book/show/7306509-advanced-net-debugging">Advanced .NET Debugging</a> by Mario Hewardt. I&#x2019;ve been studying <code class="highlighter-rouge">WinDbg</code> for some time and consider myself somewhere between beginner and intermediate level. To my dismay I got stuck on the first excercise! Luckily I didn&#x2019;t give up and finally stumbled on a blog post that unblocked me. This series has for goal to make <a href="https://www.goodreads.com/book/show/7306509-advanced-net-debugging">Advanced .NET Debugging</a> more accessible to people - quite like me - that haven&#x2019;t grasped all the concepts yet.</p> <h2 id="prerequisites">Prerequisites</h2> <h2 id="the-problem">The problem</h2> <p>In the section <strong>Loading Native Images</strong>, Mario explains how Windows is loading a native image using <code class="highlighter-rouge">Notepad.exe</code> (<code class="highlighter-rouge">%SystemRoot%\notepad.exe</code>) as an example. As the first step, Mario instructs the reader to:</p> <blockquote> <p>go to file offset <code class="highlighter-rouge">0x108</code> where you will find the <code class="highlighter-rouge">AddressOfEntryPoint</code> field</p>
</blockquote> <p>The book was written a few years ago and back then Mario was running <code class="highlighter-rouge">Windows Vista</code> (most likely in <code class="highlighter-rouge">32-bit</code> too). If you look at the same file offset in <code class="highlighter-rouge">Windows 10 64-bit</code> you&#x2019;ll be disapointed:</p> <p><img src="/assets/advanced-dotnet-debugging-1/no-address-of-entry-point.png" alt="No AddressOfEntryPoint"></p> <p>OK, there are quite a few things to unpack in this screenshot.</p> <h3 id="hexadecimal">Hexadecimal</h3> <p>Each white cell represents a <code class="highlighter-rouge">byte</code>. A <code class="highlighter-rouge">byte</code> has 256 different values (from <code class="highlighter-rouge">0</code> to <code class="highlighter-rouge">255</code>). If we want to represent the value <code class="highlighter-rouge">255</code> in <code class="highlighter-rouge">base 2</code> (<code class="highlighter-rouge">binary</code>), we would need 8 characters: <code class="highlighter-rouge">11111111</code>. The same value in <code class="highlighter-rouge">base 10</code> (<code class="highlighter-rouge">decimal</code>) still requires 3 characters: <code class="highlighter-rouge">255</code>. In <code class="highlighter-rouge">base 16</code> (<code class="highlighter-rouge">hexadecimal</code>) we only need 2 characters: <code class="highlighter-rouge">FF</code>. Hence <code class="highlighter-rouge">hexadecimal</code> strikes a good balance between brevity and not being too remote from the decimal base we human-beings use. You can use the <code class="highlighter-rouge">Windows 10</code> calculator in <code class="highlighter-rouge">Programmer</code> mode to convert between <code class="highlighter-rouge">hexadecimal</code> and <code class="highlighter-rouge">decimal</code>:</p> <p><img src="/assets/advanced-dotnet-debugging-1/win-10-calc.png" alt="Convert between hex and dec"></p> <h3 id="file-offset">File offset</h3> <p>The <code class="highlighter-rouge">byte</code>s are displayed from left to right and top to bottom. They are accessed via a <strong>file offset</strong>, represented by the blue numbers. The left column represents the 7 most significant digits while the top row represents the least significant digit.</p> <p><img src="/assets/advanced-dotnet-debugging-1/file-offset.png" alt="File offset"></p> <p>The cell on the third row (<code class="highlighter-rouge">00000020</code>) and last column (<code class="highlighter-rouge">0F</code>) has a <strong>file offset</strong> of <code class="highlighter-rouge">0000002F</code>. <strong>File offset</strong>s are 4 <code class="highlighter-rouge">byte</code>s long, so every time we&#x2019;ll be looking for an offset or an address we know it&#x2019;ll be encoded over 4 <code class="highlighter-rouge">byte</code>s.</p> <h3 id="endianness">Endianness</h3> <p>Windows is a <a href="https://en.wikipedia.org/wiki/Endianness">little-endian</a> system. This means than the least significant <code class="highlighter-rouge">byte</code>s will appear <strong>before</strong> the most significant ones. So if you were to find the following value: <code class="highlighter-rouge">E0 93 01 00</code>, the address would be <code class="highlighter-rouge">00 01 93 E0</code> - only the <code class="highlighter-rouge">byte</code> order is inverted, not the order within a <code class="highlighter-rouge">byte</code> - which would commonly be written as <code class="highlighter-rouge">0x193E0</code> (<code class="highlighter-rouge">0x</code> denotes a hex notation and the leading <code class="highlighter-rouge">0</code>s are dropped as they are not significant).</p> <h2 id="figuring-out-the-file-offset-of-addressofentrypoint">Figuring out the file offset of <code class="highlighter-rouge">AddressOfEntryPoint</code></h2> <p>Now that we know how to read the <code class="highlighter-rouge">hex</code> dump, we&#x2019;re still left with the same problem: there is no address where it&#x2019;s supposed to be. This is when I started to browse the Internet trying to understand where <code class="highlighter-rouge">AddressOfEntryPoint</code> was supposed to be located. My quest initially took me to the <a href="https://msdn.microsoft.com/library/windows/desktop/ms680547(v=vs.85).aspx">PE Format specification</a>, after reading it for a while I ended up being more confused than I initially was. The situation was dire and I needed some hope, and hope did appear in the person of Simon Cooper and his brilliant post <a href="https://www.red-gate.com/simple-talk/blogs/anatomy-of-a-net-assembly-pe-headers/">Anatomy of a .NET Assembly &#x2013; PE Headers</a>. This illustration details the required steps to find the value of the <code class="highlighter-rouge">AddressOfEntryPoint</code>:</p> <p><img src="/assets/advanced-dotnet-debugging-1/address-of-entry-point.png" alt="AddressOfEntryPoint"></p> <p>Thanks to Simon&#x2019;s detailed write-up I was able to figure out the file offset of the <code class="highlighter-rouge">AddressOfEntryPoint</code> (<code class="highlighter-rouge">0x120</code>), I also found its value: <code class="highlighter-rouge">0x193E0</code>. You can use the below formula to compute the <code class="highlighter-rouge">AddressOfEntryPoint</code> file offset based of the signature file offset:</p> <blockquote> <p>Signature file offset + <code class="highlighter-rouge">0x28</code> = <code class="highlighter-rouge">AddressOfEntryPoint</code> file offset</p>
</blockquote> <p>If we look back at the screenshot above we can see than the signature file offset was <code class="highlighter-rouge">0xF8</code>. Hence <code class="highlighter-rouge">0xF8</code> + <code class="highlighter-rouge">0x28</code> = <code class="highlighter-rouge">0x120</code>, which is exactly what we found without using the formula.</p> <h2 id="relative-virtual-address">Relative virtual address</h2> <p>But we&#x2019;re now faced with another issue, the address entry point (<code class="highlighter-rouge">0x193E0</code>) resolves to some kind of wasteland:</p> <p><img src="/assets/advanced-dotnet-debugging-1/wasteland.png" alt="That can&apos;t be the entry point!"></p> <p>The Portable Executable format has the concept of <strong>Relative Virtual Address</strong> (<code class="highlighter-rouge">RVA</code>) which it defines like this:</p> <blockquote> <p>In an image file, the address of an item after it is loaded into memory, with the base address of the image file subtracted from it.</p>
</blockquote> <p>As it turns out the <code class="highlighter-rouge">AddressOfEntryPoint</code> is <strong>not</strong> a file offset, it is actually a <code class="highlighter-rouge">RVA</code>.</p> <p>So we need to <em>load Notepad in memory</em> which equates to running it. But we also need to be able to see the <code class="highlighter-rouge">base address</code> of the image which is not something than the <code class="highlighter-rouge">Task Manager</code> or any other basic tool will be able to provide us. To see this value we need a debugger. Open <code class="highlighter-rouge">Notepad.exe</code> (<code class="highlighter-rouge">%SystemRoot%\notepad.exe</code>) using <a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md#store">WinDbg Preview</a>:</p> <p><img src="/assets/advanced-dotnet-debugging-1/open-notepad-windbg-preview.gif" alt="Opening Notepad with WinDbg Preview"></p> <p>Type the command <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/lm--list-loaded-modules-">List Loaded Modules</a>:</p> <figure class="highlight"><pre><code class="language-text">0:000&gt; lm
start             end                 module name
00007ff6`f92f0000 00007ff6`f9331000   notepad    (deferred)
00007ffd`09ce0000 00007ffd`09f49000   COMCTL32   (deferred)
00007ffd`0abb0000 00007ffd`0ad7c000   urlmon     (deferred)
// Abbreviated</code></pre></figure> <p>The value we&#x2019;re interested in is <code class="highlighter-rouge">00007ff6`f92f0000</code>, this is the <code class="highlighter-rouge">start</code> (i.e. the <code class="highlighter-rouge">base address</code>) of the <code class="highlighter-rouge">notepad</code> module.</p> <p>Armed with this information we&#x2019;ll be able to look at the instructions located at the <code class="highlighter-rouge">RVA</code> <code class="highlighter-rouge">0x193E0</code> by using the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/u--unassemble-">Unassemble</a> command:</p> <figure class="highlight"><pre><code class="language-text">0:000&gt; u 00007ff6`f92f0000+0x193E0
notepad!WinMainCRTStartup:
00007ff6`f93093e0 4883ec28        sub     rsp,28h
00007ff6`f93093e4 e8c7070000      call    notepad!_security_init_cookie (00007ff6`f9309bb0)
00007ff6`f93093e9 4883c428        add     rsp,28h
00007ff6`f93093ed e902000000      jmp     notepad!__mainCRTStartup (00007ff6`f93093f4)
00007ff6`f93093f2 cc              int     3
00007ff6`f93093f3 cc              int     3
notepad!__mainCRTStartup:
00007ff6`f93093f4 48895c2408      mov     qword ptr [rsp+8],rbx
00007ff6`f93093f9 48897c2410      mov     qword ptr [rsp+10h],rdi</code></pre></figure> <p>Bingo!</p> <h2 id="conclusion">Conclusion</h2> <p>I hope this post clarified how to find the entry point of a native Windows executable.</p> </article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>