<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How .NET 4.8 Can Break Your&#xA0;Application -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>How .NET 4.8 Can Break Your&#xA0;Application</h1>
    <article id="post-646" class="post-646 post type-post status-publish format-standard hentry category-uncategorized"> <div class="entry-content"> <p>A colleague was calling me in to look at a broken .NET application after installing a preview up an upcoming Windows KB. The application was not starting up all the time. That are easy issues because it is easy and fast to reproduce the problem. Since it was happening on a VM with no Visual Studio installed I used the best und most underestimated tool named <a href="https://github.com/0xd4d/dnSpy">dnSpy</a>. I learned about this tool by reading the book <a href="https://www.amazon.de/Pro-NET-Memory-Management-Performance/dp/148424026X/ref=sr_1_1?hvadid=11953128392&amp;hvbmt=be&amp;hvdev=c&amp;hvqmt=e&amp;keywords=pro+net+performance&amp;qid=1567963220&amp;s=gateway&amp;sr=8-1">Pro .NET Memory Management</a> from Konrad Kokosa is not only an in depth explanation how the GC works but it covers also many not so well known tools to drill into .NET for Windows and Linux. The most useful sections are in my opinion the last ones which cover in depth usage of Span and&#xA0; <a href="https://devblogs.microsoft.com/dotnet/system-io-pipelines-high-performance-io-in-net/">System.IO.Pipelines</a>. The GC is a fascinating piece of software but in practice you are fastest if you do not need to rely on it. dnSpy is a xcopy deployable Visual Studio Debugger clone which automatically decompiles managed code on the fly where you can set breakpoints and do line level debugging without having the actual source code. If you ever have to do production debugging you need to have this tool in your toolbox. In many ways dnSpy is better than Windbg because until today Windbg has no way to debug .NET code with a source code window which is in my opinion a shame. </p>
<p>One really cool option of dnSpy is to edit the decompiled source code and modify a running binary. Why am I excited about that? Will strong name verification not prevent loading such a tampered assembly? First of all: No you can recompile a strong named assembly and it will load normally since <a href="https://docs.microsoft.com/en-us/dotnet/framework/app-domains/create-and-use-strong-named-assemblies">.NET 3.5 SP1</a></p>
<blockquote> <p>Starting with the .NET Framework 3.5 Service Pack 1, <font><strong>strong-name signatures are not validated when an assembly is loaded into a full-trust application domain</strong></font>,</p>
</blockquote>
<p>Not many people are aware of this. To repeat: Strong naming won&#xB4;t give you any security since over 10 years.</p>
<p>This makes it easy to force a&#xA0; highly sporadic exception on production machines (e.g. connection loss, disk full, &#x2026;.) with ease by modifying the original method where the exception was thrown. If you have e.g. a small application which for some reason ends up in the general exception handler and there the error handling does bad things with some code like this:</p>
<pre class="csharpcode"> <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args) { <span class="kwrd">try</span> { <span class="kwrd">new</span> FileStream(<span class="str">@&quot;C:\temp\NotexistingFile.txt&quot;</span>, FileMode.Open); Console.WriteLine(<span class="str">&quot;Got Here&quot;</span>); } <span class="kwrd">catch</span>(FileNotFoundException ex) { Console.WriteLine(<span class="str">&quot;File was not found.&quot;</span>); } <span class="kwrd">catch</span>(Exception ex) { Console.WriteLine(<span class="str">&quot;Fatal exception encountered!&quot;</span>);
            }
        }</pre>
<p><a href="https://aloiskraus.files.wordpress.com/2019/09/image.png"><img alt="image" src="https://aloiskraus.files.wordpress.com/2019/09/image_thumb.png?w=1304&amp;h=846" width="1304"></a></p>
<p>If you start the application from dnSpy it will skip using Native Images which will give you even for release builds all local variables with full fidelity. While debugging the same application in VS 2019 even with Source Server support often it cannot locate .NET Framework sources and you see no local variables and no C# code:</p>
<p><a href="https://aloiskraus.files.wordpress.com/2019/09/image-1.png"><img alt="image" src="https://aloiskraus.files.wordpress.com/2019/09/image_thumb-1.png?w=1395&amp;h=850" width="1395"></a></p>
<p>That is not nice. What is the reason for that? First Visual Studio uses Native Images if present. If these were compiled with no debug settings then the local variables will be optimized away. Even if you check </p>
<p><a href="https://aloiskraus.files.wordpress.com/2019/09/image-2.png"><img alt="image" src="https://aloiskraus.files.wordpress.com/2019/09/image_thumb-2.png?w=361&amp;h=24" width="361"></a></p>
<p>in Debugger &#x2013; Options will not help because it only affects JITed code like your application but not loaded NGenned images. But there is a way out</p>
<p>1. Set the environment variable COMPLUS_ZAPDISABLE=1&#xA0; or the registry key HKLM\SOFTWARE\Microsoft\.NETFramework\ZapDisable&#xA0; and launch from that shell either VS or your application to which you attach later. See <a href="https://github.com/Microsoft/dotnet/blob/master/Documentation/testing-with-ryujit.md">here</a> for more information.</p>
<p>2. Create a file in C:\Windows\Microsoft.NET\assembly\GAC_32\mscorlib\v4.0_4.0.0.0__b77a5c561934e089\mscorlib.ini with the content </p>
<pre class="csharpcode">[.NET Framework Debugging Control]
GenerateTrackingInfo=1
AllowOptimize=0</pre>
<p>Point 1 will disable loading of native images. If you set this system wide your application will start much slower but all of your code will be JITed now. Point 2 will disable JIT optimizations for a given dll where the ini file must be named for an assembly xxxx.dll like xxxx.ini but NOT xxxx.dll.ini or xxxx.ini.dll. You need to do this for each assembly you want to disable JIT optimizations. The&#xA0; post of <a href="https://www.hanselman.com/blog/DebugVsReleaseTheBestOfBothWorlds.aspx">Scott Hanselman</a> gives misleading advice. His post leaves you with the impression you need to create that ini file only for your executable. That is not the case. To make things easier I have wrapped that stuff into a powershell script which allows me to disable the use of native images system wide and generate the ini files in the GAC and additionally in my application directory.</p>
<pre class="csharpcode">PS D:\Utils\EnableLocalVars.ps1 -enable 1 -dir <span class="str">&quot;C:\Program Files\Test&quot;</span> -gac -ngen 0</pre>
<pre class="csharpcode">Did set NGen Flag to 0. NGen Images are disabled now. This will impact application startup!
Adding 1518 files from GAC
Adding 68 files from GAC64
Adding 2 files from C:\Program Files\Test
Skipped 8 files because ini file already exists
Created 1580 ini files.</pre>
<p>That script makes it easy to enable/disable on an installed machine. I have put a link to my OneDrive Folder <a href="https://1drv.ms/u/s!AhcFq7XO98yJgssQT4QP-l4szC_AHA?e=Sxc52S">here</a>. </p>
<pre class="csharpcode">.\EnableLocalVars.ps1 EnableLocalVars.ps1 -enable 0/1 -dir xxxx [-recurse] or [-gac] [-Ngen 0/1] by Alois Kraus 2018-2019 Use <span class="kwrd">this</span> script when you want to attach to a running process or you want to get memory dumps of crashed processes of release builds with all local variables not optimized away. This will disable JIT optimizations to enable viewing local variables of methods <span class="kwrd">in</span> a debugger which otherwise would be optimized away. -enable 0/1 Enable local variables to view <span class="kwrd">in</span> debugger If 1 enable local variables. The .ini files are created. If 0 disable local variables. The .ini files are removed. -dir directory Select directory <span class="kwrd">where</span> all dll/exe files get a .ini file -recurse If set it will search recursively <span class="kwrd">for</span> all dlls below that path -gac Make all GAC dlls debuggable -NGen 0/1 Disable/enable usage of NGen binaries system wide by setting the registry key HKLM\SOFTWARE\Microsoft\.NETFramework\ZapDisable 1 Enable NGen Images == ZapDisable=1 0 Disable NGen Images == ZapDisable=0 You need to enable <span class="kwrd">this</span> <span class="kwrd">if</span> you want to view variables of .NET Framework code or <span class="kwrd">if</span> your application was NGenned
You need to restart the applications after executing <span class="kwrd">this</span> command <span class="kwrd">for</span> the changes to take effect.
Examples Enable locals <span class="kwrd">for</span> all GAC and application dlls on an installed and NGenned machine EnableLocalVars.ps1 -enable 1 -gac -dir <span class="str">&quot;c:\program files\myApp\bin&quot;</span> -ngen 0 Reset settings EnableLocalVars.ps1 -enable 0 -gac -dir <span class="str">&quot;c:\program files\myApp\bin&quot;</span> -ngen 1
 Enable NGen Images again
  EnableLocalVars.ps1  -ngen 1
WARNING: NGen images are disabled. Do not forget to enable them (EnableLocalVars.ps1 -Ngen 1) when you are done or all .NET applications will start ca. x2 times slower!
</pre>
<p>It comes with extensive help so it should make it easy enough that you perform this step automatically before taking a memory dump. This will make memory dump debugging a whole lot easier. Usually I make the error configurable by e.g. checking for the existence of a file to force the error when I want to inject some error in .NET Framework code like this:</p>
<p><a href="https://aloiskraus.files.wordpress.com/2019/09/image-3.png"><img alt="image" src="https://aloiskraus.files.wordpress.com/2019/09/image_thumb-3.png?w=824&amp;h=505" width="824"></a></p>
<p><span class="kwrd">This trick helped me a lot to force the error only when the application has got into the initial non faulted state. Now I can trigger the issue by creating a file from the command line with</span></p>
<p><span class="kwrd">&#xA0;<font>C&gt;echo Hi &gt; c:\temp\ForceError.txt </font></span></p>
<p><span class="kwrd">This will trigger the exception in the patched file:</span></p>
<p><span class="kwrd">if</span> (File.Exists(<span class="str">&#x201C;C:\\Temp\\ForceError.txt&#x201D;</span>)){</p><p>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; <span class="kwrd">throw</span> <span class="kwrd">new</span> Exception(<span class="str">&#x201C;This one is rare!&#x201D;</span>);</p><br>}</div></article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>