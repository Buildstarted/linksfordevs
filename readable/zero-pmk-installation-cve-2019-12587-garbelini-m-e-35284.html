<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Zero PMK Installation (CVE-2019-12587) | Garbelini M. E. - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Zero PMK Installation (CVE-2019-12587) | Garbelini M. E. - linksfor.dev(s)"/>
    <meta property="article:author" content="Matheus Eduardo Garbelini"/>
    <meta property="og:description" content="Hijacking ESP32/ESP8266 clients connected to enterprise networks"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://matheus-garbelini.github.io/home/post/zero-pmk-installation/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Zero PMK Installation (CVE-2019-12587) | Garbelini M. E.</title>
<div class="readable">
        <h1>Zero PMK Installation (CVE-2019-12587) | Garbelini M. E.</h1>
            <div>by Matheus Eduardo Garbelini</div>
            <div>Reading time: 4 minutes</div>
        <div>Posted here: 04 Sep 2019</div>
        <p><a href="https://matheus-garbelini.github.io/home/post/zero-pmk-installation/">https://matheus-garbelini.github.io/home/post/zero-pmk-installation/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
      



<p>The vulnerability (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-12587">CVE-2019-12587</a>) found in SDKs of ESP32 and ESP8266 allows an attacker to take control of the Wi-Fi device in a enterprise network by sending an EAP-Fail message in the final step during connection between the device and the access point (AP). It was discovered that ESP32/ESP8266 devices updates their Pairwise Master Key (PMK) only when they receive an EAP-Success message. If an EAP-Fail message is received before the EAP-Success, the device skips updating the PMK received during a normal EAP exchange (EAP-PEAP, EAP-TTLS or EAP-TLS). Even in such situation, the device accepts normally the EAPoL 4-Way handshake which in turn establishes a session key based on this PMK.</p>

<p>Each time ESP32/ESP8266 starts, the PMK is initialised as zero, thus, if an EAP-Fail message is sent before the EAP-Success, the device uses a zero PMK. This allows an attacker to hijack the connection between the AP and the device.</p>

<p>The affected stable and development versions are listed below:</p>

<ul>
<li>ESP32-IDF Stable <a href="https://github.com/espressif/ESP8266_NONOS_SDK/releases/tag/v3.0">release 3.0</a> and earlier. Vulnerable until <strong>July 15, 2019</strong>.</li>
<li>ESP32-IDF Development Master <a href="https://github.com/espressif/esp-idf/commit/b68f5b4f8cae3d315a4d82dea5f5a623a18e0c72">#b68f5b4f</a> and earlier. Vulnerable until <strong>May 30, 2019</strong>.</li>
<li>Arduino-ESP32 Pre-release <a href="https://github.com/espressif/arduino-esp32/releases/tag/1.0.3-rc2">1.0.3-rc2</a> and earlier. Vulnerable until <strong>September 5, 2019.</strong></li>
<li>Arduino-ESP32 Development Master <a href="https://github.com/espressif/arduino-esp32/commit/aff2e42ac612e32e6c52283e16d85d83ed6ef03b">#aff2e42</a> and earlier.  Vulnerable until <strong>May 12, 2019</strong>.</li>
</ul>



<p>​   The vulnerability can be better understood when presented in the diagram of the figure below. At the end of the exploit, the attacker has control over the encrypted Wi-Fi session of ESP32/ESP8266.</p>

<p><img src="https://matheus-garbelini.github.io/home/post/zero-pmk-installation/zero_pmk_diagram.png" alt="drawing" width="550"></p>

<p>A Wireshark capture (<a href="https://matheus-garbelini.github.io/home/post/zero-pmk-installation/capture_vulnerability_TTLS.pcapng">download</a>) of the attacker triggering the vulnerability is shown in the figure below.</p>

<p><img src="https://matheus-garbelini.github.io/home/post/zero-pmk-installation/wireshark_capture.png" alt="wireshark_capture"></p>

<p>The highlighted packet (Failure) is sent by the attacker, which then proceeds to send a Message 1, generated with a PMK (or pre-shared key) equal to zero. As you can see, the client normally responds with message 3 and 4 during the EaPoL handshake. Wi-Fi devices that are not vulnerable simply ignores such failure message and respond only when they received a valid message 1 from the real AP instead.</p>



<p>Attackers can exploit this vulnerability to hijack ESP32/ESP8266 Wi-Fi clients connected to enterprise network without even knowing anything about username, password or certificates used during the enterprise keys exchanging methods (EAP-PEAP, EAP-TTLS or EAP-TLS). This allows an attackers in radio range to replay, decrypt, or spoof frames via a rogue access point, thus facilitating stealing of session keys/ usernames/passwords if communications betwen ESP an AP are not using TLS. This practically means that <strong>unpatched ESP devices are more secure by actually using just WPA2 Personal.</strong></p>

<p>It’s important to mention that attackers can also exploit <a href="https://matheus-garbelini.github.io/home/post/esp32-esp8266-eap-crash/">CVE-2019-12586</a> and <a href="https://matheus-garbelini.github.io/home/post/esp8266-beacon-frame-crash/">CVE-2019-12588</a> to force both ESP32 and ESP8266 to crash, which reinitialise the PMK to zero again.</p>



<p>Espressif has fixed such problem and committed patches for ESP32 SDK, however, as of the date of this post, the NONOS SDK and Arduino core for ESP8266 appears to be unpatched. The security patches can be tracked in the following commit link:</p>

<ul>
<li><a href="https://github.com/espressif/esp-idf/releases/tag/v3.3">ESP32 ESP-IDF Stable Release 3.3 (5 September, 2019)</a></li>
<li><a href="https://github.com/espressif/esp-idf/commit/8009320fb44abaf8acf8a1e1a38a67fc4c8d458c">ESP32 ESP-IDF Development Master (30 May, 2019)</a></li>
<li><a href="https://github.com/espressif/arduino-esp32/releases/tag/1.0.3-rc3">Arduino-ESP32 Stable Release 1.0.3 RC3 (5 September, 2019)</a></li>
<li><a href="https://github.com/espressif/arduino-esp32/commit/d5e2bb12ca02ae9066e9dad84d9dbf268aca6fa3">Arduino-ESP32 Development Master (August  20,  2019)</a></li>
</ul>



<p>If you wish to test your ESP32/8266 device against this vulnerability, you can check my repository:</p>

<p><a href="https://github.com/Matheus-Garbelini/esp32_esp8266_attacks">https://github.com/Matheus-Garbelini/esp32_esp8266_attacks</a></p>

    </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>