<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Proxyjump, the SSH option you probably never heard of - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Proxyjump, the SSH option you probably never heard of - linksfor.dev(s)"/>
    <meta property="article:author" content="https://medium.com/@khristopher.tolbert"/>
    <meta property="og:description" content="Today, it is becoming more and more common for Penetration Testers, Security Researchers, Red Teams, and the like to require some sort of&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://medium.com/maverislabs/proxyjump-the-ssh-option-you-probably-never-heard-of-2d7e41d43464"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Proxyjump, the SSH option you probably never heard of</title>
<div class="readable">
        <h1>Proxyjump, the SSH option you probably never heard of</h1>
            <div>by https://medium.com/@khristopher.tolbert</div>
            <div>Reading time: 5-7 minutes</div>
        <div>Posted here: 17 Jun 2020</div>
        <p><a href="https://medium.com/maverislabs/proxyjump-the-ssh-option-you-probably-never-heard-of-2d7e41d43464">https://medium.com/maverislabs/proxyjump-the-ssh-option-you-probably-never-heard-of-2d7e41d43464</a></p>
        <hr/>
<div id="readability-page-1" class="page"><section><div><div><div><div><div><div><p><a rel="noopener" href="https://medium.com/@khristopher.tolbert?source=post_page-----2d7e41d43464----------------------"><img alt="Khris Tolbert" src="https://miro.medium.com/fit/c/96/96/2*aDrHZNeqCKCb9vGDIfUAbg.jpeg" width="48" height="48"></a></p></div></div></div></div><p id="790c" data-selectable-paragraph="">Today, it is becoming more and more common for Penetration Testers, Security Researchers, Red Teams, and the like to require some sort of tunneling in and out of an organizationâ€™s infrastructure. Internal Red Teams, especially, who may need to cordon off their Command and Control Infrastructure will likely employ SSH (or VPN, but that will be a different post) tunnels from their External Infrastructure (such as callback servers, web hosting, mail, etc) to the Internal assets. Setting up these tunnels can become quite convoluted and difficult to manage, especially once the number of hops or jumps between servers increase.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*6CDo8qwaLsxZcFB8.jpg?q=20" width="1033" height="499" role="presentation"></p><p><img width="1033" height="499" srcset="https://miro.medium.com/max/552/0*6CDo8qwaLsxZcFB8.jpg 276w, https://miro.medium.com/max/1104/0*6CDo8qwaLsxZcFB8.jpg 552w, https://miro.medium.com/max/1280/0*6CDo8qwaLsxZcFB8.jpg 640w, https://miro.medium.com/max/1400/0*6CDo8qwaLsxZcFB8.jpg 700w" sizes="700px" role="presentation" src="https://miro.medium.com/max/1033/0*6CDo8qwaLsxZcFB8.jpg"></p></div></div></div></div><figcaption data-selectable-paragraph="">Cascading SSH Tunnels can be a real pain in the hind-parts</figcaption></figure><p id="2d0b" data-selectable-paragraph="">For the purpose of this blog post, an environment as depicted below has been set up. The goal is to ensure beacons from the <em>Victims </em>can reach the <em>teamserver </em>host<em> </em>embedded deep in a corporate datacenter.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*QtXI5oI-D15ceS3z?q=20" width="1280" height="720" role="presentation"></p><p><img width="1280" height="720" srcset="https://miro.medium.com/max/552/0*QtXI5oI-D15ceS3z 276w, https://miro.medium.com/max/1104/0*QtXI5oI-D15ceS3z 552w, https://miro.medium.com/max/1280/0*QtXI5oI-D15ceS3z 640w, https://miro.medium.com/max/1400/0*QtXI5oI-D15ceS3z 700w" sizes="700px" role="presentation" src="https://miro.medium.com/max/1280/0*QtXI5oI-D15ceS3z"></p></div></div></div></div></figure><p id="c050" data-selectable-paragraph="">Historically, due to my own ignorance of advanced SSH options, I would attempt to manage these multiple tunnels by cascading each tunnel onto another:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*zlM5vN8xcIZKD3Nt?q=20" width="1280" height="720" role="presentation"></p><p><img width="1280" height="720" srcset="https://miro.medium.com/max/552/0*zlM5vN8xcIZKD3Nt 276w, https://miro.medium.com/max/1104/0*zlM5vN8xcIZKD3Nt 552w, https://miro.medium.com/max/1280/0*zlM5vN8xcIZKD3Nt 640w, https://miro.medium.com/max/1400/0*zlM5vN8xcIZKD3Nt 700w" sizes="700px" role="presentation" src="https://miro.medium.com/max/1280/0*zlM5vN8xcIZKD3Nt"></p></div></div></div></div></figure><p id="47fa" data-selectable-paragraph="">To ensure beacons that hit the last-hop<em> </em>would be able to reach the internal team server, the multiple tunnel commands look like such:</p><pre><span id="e724" data-selectable-paragraph="">[teamserver]<br>ssh -R 8080:127.0.0.1:80 internal-proxy -f -N</span><span id="dc43" data-selectable-paragraph="">[Int. Proxy Server]<br>ssh -R 8080:127.0.0.1:8080 external-proxy -f -N</span><span id="7b95" data-selectable-paragraph="">[Ext. Proxy Server ]<br>ssh -R 0.0.0.0:8080:127.0.0.1:8080 last-hop -f -N</span></pre><p id="a29c" data-selectable-paragraph="">After executing each of these respective commands, a simple web request demonstrates that the web request follows each of the tunnels all the way back to the teamserver.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*qdDqfCNlcQPwJpIN?q=20" width="802" height="515" role="presentation"></p><p><img width="802" height="515" srcset="https://miro.medium.com/max/552/0*qdDqfCNlcQPwJpIN 276w, https://miro.medium.com/max/1104/0*qdDqfCNlcQPwJpIN 552w, https://miro.medium.com/max/1280/0*qdDqfCNlcQPwJpIN 640w, https://miro.medium.com/max/1400/0*qdDqfCNlcQPwJpIN 700w" sizes="700px" role="presentation"></p></div></div></div></div></figure><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*OaO9na6FNeG0C1Qz?q=20" width="804" height="413" role="presentation"></p><p><img width="804" height="413" srcset="https://miro.medium.com/max/552/0*OaO9na6FNeG0C1Qz 276w, https://miro.medium.com/max/1104/0*OaO9na6FNeG0C1Qz 552w, https://miro.medium.com/max/1280/0*OaO9na6FNeG0C1Qz 640w, https://miro.medium.com/max/1400/0*OaO9na6FNeG0C1Qz 700w" sizes="700px" role="presentation"></p></div></div></div></div></figure><p id="a8b9" data-selectable-paragraph="">Setting this up requires each of these commands to be run on their respective machines. Any changes, however, require killing the tunnel at each stop, and re-executing. The headache in practice-without some sort of management software running across each of the servers-becomes very apparent. An easier way to manage these tunnels must exist.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/0*akrI3NN_Ai7lO1ci.jpg?q=20" width="534" height="467" role="presentation"></p><p><img width="534" height="467" srcset="https://miro.medium.com/max/552/0*akrI3NN_Ai7lO1ci.jpg 276w, https://miro.medium.com/max/1068/0*akrI3NN_Ai7lO1ci.jpg 534w" sizes="534px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph="">Just like we found out last month about Aliens, ProxyJump is a real thing!</figcaption></figure><p id="60e0" data-selectable-paragraph="">Enter <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts" target="_blank" rel="noopener nofollow">[ProxyJump]</a>, an SSH advanced option which is simply a simplification of ProxyCommand (<code><em>ProxyCommand ssh proxy-host -W %h:%p</em></code>). ProxyJump allows for an SSH tunnel to pivot through one SSH host (proxy) to another. The ProxyJump option can be invoked by <code><em>-J</em></code><em> </em>on the commandline:</p><pre><span id="76d9" data-selectable-paragraph="">ssh -J internal-proxy last-hop -f -N</span></pre><p id="418a" data-selectable-paragraph="">My personal preference is using an SSH config (<em>/home/user/.ssh/config</em>) and SSH keys (if not, you would be prompted for a password to login to each ProxyJump hop). Here, a single hop can be specified as such to SSH :</p><pre><span id="a553" data-selectable-paragraph="">Host internal-proxy<br>    HostName 10.20.30.253<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>Host last-hop<br>    HostName 10.100.2.240<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>    ProxyJump internal-proxy</span></pre><p id="122c" data-selectable-paragraph="">Saving the example above and executing the ssh command <em>ssh last-hop, </em>the prompt of <em>last-hop</em> is presented (with <em>netstat</em> output) below. The <em>internal-proxy </em>is seen connected over TCP port 22 vice the teamserver itself.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*bMFeEgZWWmpBFNwR?q=20" width="770" height="392" role="presentation"></p><p><img width="770" height="392" srcset="https://miro.medium.com/max/552/0*bMFeEgZWWmpBFNwR 276w, https://miro.medium.com/max/1104/0*bMFeEgZWWmpBFNwR 552w, https://miro.medium.com/max/1280/0*bMFeEgZWWmpBFNwR 640w, https://miro.medium.com/max/1400/0*bMFeEgZWWmpBFNwR 700w" sizes="700px" role="presentation"></p></div></div></div></div></figure><p id="2eba" data-selectable-paragraph="">Ok, so what about multiple proxies? As referenced <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts" target="_blank" rel="noopener nofollow">[here]</a>, one must simply chain the proxies in the order from closest to farthest from the teamserver in the SSH config:</p><pre><span id="ab17" data-selectable-paragraph="">Host internal-proxy<br>    HostName 10.20.30.253<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>Host external-proxy<br>    HostName 10.100.2.200<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>    ProxyJump internal-proxy<br>Host next-hop<br>    HostName 10.100.2.210<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>    ProxyJump external-proxy<br>Host last-hop<br>    HostName 10.100.2.240<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>    ProxyJump next-hop</span></pre><p id="9912" data-selectable-paragraph="">Executing <em>ssh last-hop</em>, and running netstat from last-hop, it is shown that <em>next-hop </em>is the only system connected over TCP port 22 to <em>last-hop</em>:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*zEVxPtJ0syTNhLta?q=20" width="803" height="351" role="presentation"></p><p><img width="803" height="351" srcset="https://miro.medium.com/max/552/0*zEVxPtJ0syTNhLta 276w, https://miro.medium.com/max/1104/0*zEVxPtJ0syTNhLta 552w, https://miro.medium.com/max/1280/0*zEVxPtJ0syTNhLta 640w, https://miro.medium.com/max/1400/0*zEVxPtJ0syTNhLta 700w" sizes="700px" role="presentation"></p></div></div></div></div></figure><p id="31ed" data-selectable-paragraph="">So how does this help tunneling port forwards? Well, simply adding the line <code>RemoteForward 8080 127.0.0.1:80</code> at the end of the SSH config will setup the remote port forward:</p><pre><span id="7d22" data-selectable-paragraph="">Host last-hop<br>    HostName 10.100.2.240<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>    ProxyJump next-hop<br>    <strong>RemoteForward 8080 127.0.0.1:80</strong></span></pre><p id="9b5f" data-selectable-paragraph="">After saving the config and executing this time (<em>ssh last-hop)</em>, a quick netstat on <em>last-hop </em>shows that 8080 is now bound. Also, using curl to request <em>last-hop:8080</em> shows that the tunnel is indeed forwarding back any requests from <em>last-hop </em>through <em>next-hop, external-proxy, and internal-proxy</em> to <em>teamserver</em> on port 80:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*JpdH0YiLpskQvFcN?q=20" width="802" height="573" role="presentation"></p><p><img width="802" height="573" srcset="https://miro.medium.com/max/552/0*JpdH0YiLpskQvFcN 276w, https://miro.medium.com/max/1104/0*JpdH0YiLpskQvFcN 552w, https://miro.medium.com/max/1280/0*JpdH0YiLpskQvFcN 640w, https://miro.medium.com/max/1400/0*JpdH0YiLpskQvFcN 700w" sizes="700px" role="presentation"></p></div></div></div></div></figure><p id="f6d7" data-selectable-paragraph="">If different jump hosts use separate identity files, the user and identity file just need to match their respective host in the config. For example, in our demo config, we will use <em>user2</em> as an identity on the <em>internal-proxy</em> and <em>nopriv</em> on the last-hop:</p><pre><span id="517e" data-selectable-paragraph="">Host internal-proxy<br>    HostName 10.20.30.253<br>    Port 22<br>    User user2<br>    IdentityFile /home/nopriv/.ssh/user2<br>[â€¦]<br>Host last-hop<br>    HostName 10.100.2.240<br>    Port 22<br>    User nopriv<br>    IdentityFile /home/nopriv/.ssh/id_rsa<br>    ProxyJump internal-proxy</span></pre><p id="784e" data-selectable-paragraph="">Executing our ssh command <em>ssh last-hop</em>, presents a successful login at <em>last-hop</em> through the <em>internal-proxy, external-proxy</em>, and <em>next-hop</em>:</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/0*7-wR2SDk30xpHR_-?q=20" width="633" height="349" role="presentation"></p><p><img width="633" height="349" srcset="https://miro.medium.com/max/552/0*7-wR2SDk30xpHR_- 276w, https://miro.medium.com/max/1104/0*7-wR2SDk30xpHR_- 552w, https://miro.medium.com/max/1266/0*7-wR2SDk30xpHR_- 633w" sizes="633px" role="presentation"></p></div></div></div></figure><p id="4f93" data-selectable-paragraph="">The key exchange with <em>internal-proxy </em>verifies the user2 credentials were used in the authentication:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/0*Q8gsu5j5Whabx-V_?q=20" width="761" height="340" role="presentation"></p><p><img width="761" height="340" srcset="https://miro.medium.com/max/552/0*Q8gsu5j5Whabx-V_ 276w, https://miro.medium.com/max/1104/0*Q8gsu5j5Whabx-V_ 552w, https://miro.medium.com/max/1280/0*Q8gsu5j5Whabx-V_ 640w, https://miro.medium.com/max/1400/0*Q8gsu5j5Whabx-V_ 700w" sizes="700px" role="presentation"></p></div></div></div></div></figure><p id="8666" data-selectable-paragraph="">In summary, ProxyJump is an easy way to manage SSH tunnels across proxies, extending services that may be buried in a corporate data center or in the cloud to where you need them. The use of ProxyJump minimizes the number of separate tunnels required and when coupled SSH configs, modification of such tunnels are quite simple and quick.</p></div></div></section></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>