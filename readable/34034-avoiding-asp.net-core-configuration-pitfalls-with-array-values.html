<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Avoiding ASP.Net Core Configuration Pitfalls With Array Values -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Avoiding ASP.Net Core Configuration Pitfalls With Array Values</h1><div><div id="" class=""><p class="freshness" data-freshness-datetime="2019-08-21T09:21:39-04:00"><i class="icon heartbeat freshness-icon-js"></i><em>This post is <span class="freshness-days-old-js"></span> days old.</em></p><p>ASP.NET Core continues to improve on the legacy of the .NET Framework. Our team is impressed with its performance and excited about future possibilities, but change is seldom a smooth transition. In this post, I’ll explain a pitfall you may run into using the newest configuration model in .NET Core and options to mitigate the issue.</p><h2 id="example">Example</h2><p>Look at the two following configurations for <code class="language-plaintext highlighter-rouge">appSettings.json</code> and its production environment copy of <code class="language-plaintext highlighter-rouge">appSettings.Production.json</code>.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// appSettings.json</span><span class="p">{</span><span class="dl">"</span><span class="s2">Logging</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">LogLevel</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">Default</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Warning</span><span class="dl">"</span><span class="p">}</span><span class="p">},</span><span class="dl">"</span><span class="s2">AllowedHosts</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">AppSettings</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">Features</span><span class="dl">"</span><span class="p">:</span><span class="p">[</span><span class="dl">"</span><span class="s2">Normal Feature</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">Super Secret Feature</span><span class="dl">"</span><span class="p">]</span><span class="p">}</span><span class="p">}</span><span class="c1">// appSettings.Production.json</span><span class="p">{</span><span class="dl">"</span><span class="s2">Logging</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">LogLevel</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">Default</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Debug</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">System</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Information</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">Microsoft</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Information</span><span class="dl">"</span><span class="p">}</span><span class="p">},</span><span class="dl">"</span><span class="s2">AppSettings</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">Features</span><span class="dl">"</span><span class="p">:</span><span class="p">[</span><span class="dl">"</span><span class="s2">Normal Feature</span><span class="dl">"</span><span class="p">]</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>What would you expect the <code class="language-plaintext highlighter-rouge">Production</code> configuration and values for <code class="language-plaintext highlighter-rouge">AppSettings:Features</code> to be when run through the configuration builder? What if I told you it was the following?</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hosting Environment: Production
Features Include: Normal Feature, Super Secret Feature
</code></pre></div></div><p>Well, it is! How did this happen?</p><h2 id="explanation">Explanation</h2><p>ASP.NET Core’s configuration is based on keys, not file structure. In the example, each array item generates a unique key.</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hosting Environment: Production
Features Include: Normal Feature, Super Secret Feature

Keys:
AppSettings:Features:0
AppSettings:Features:1
</code></pre></div></div><p>Since configurations build on each other, they are additive and not destructive. Any key not overwritten remains from the previously loaded configuration. In our case, <code class="language-plaintext highlighter-rouge">appSettings.json</code> array values are not completely overwritten by the array values in <code class="language-plaintext highlighter-rouge">appSettings.Production.json</code>, just each unique key.</p><p>Read more at the <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-2.2">docs sites</a>.</p><h2 id="workarounds">Workarounds</h2><p>There are a few “solutions” but I’m not sure I love any of them.</p><h3 id="configuration-solution-1">Configuration Solution #1</h3><p>The most natural solution to this problem is <strong>never</strong> store array values in your base configuration. By doing so, you force each environment to set up any necessary settings. The solution works, but it could mean that the development team requires a bit more ceremony to get started or keeping up with configuration changes.</p><h3 id="configuration-solution-2">Configuration Solution #2</h3><p>Include every position in the array, and make sure your primitive type is nullable. When you get your app setting, you can filter out all null values, and you will have fulfilled the key requirements. In the example above, our configuration would look like this.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="dl">"</span><span class="s2">Logging</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">LogLevel</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">Default</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Warning</span><span class="dl">"</span><span class="p">}</span><span class="p">},</span><span class="dl">"</span><span class="s2">AllowedHosts</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">AppSettings</span><span class="dl">"</span><span class="p">:</span><span class="p">{</span><span class="dl">"</span><span class="s2">Features</span><span class="dl">"</span><span class="p">:</span><span class="p">[</span><span class="dl">"</span><span class="s2">Normal Feature</span><span class="dl">"</span><span class="p">,</span><span class="kc">null</span><span class="p">]</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>Not great, but it works.</p><h3 id="style-solution">Style Solution</h3><p>Just don’t use arrays. It’s a bummer, but since indexes won’t create numeric keys, you’ll be able to predict what all the keys will be. Maybe consider a comma-delimited string, as it may work just as well.</p><h3 id="code-solution">Code Solution</h3><p>Just don’t use the <code class="language-plaintext highlighter-rouge">IConfiguration</code> construct in the instance you need arrays and build a different configuration mechanism entirely. The code solution is likely the best answer, as you can determine the outcome every single time with little chance of user error.</p><h2 id="conclusion">Conclusion</h2><p>Configuration is a communication tool for developers to express intent to each other and into our environments. The way ASP.NET Core’s configuration ultimately works with arrays is not intuitive, but understandable after reading the documentation. We’d love to hear from you if you’ve run into this problem, or have a different solution. Thank you, and I hope you found this post informative and helpful.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>