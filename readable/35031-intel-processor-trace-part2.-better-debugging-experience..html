<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Intel Processor Trace Part2. Better debugging experience. -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Intel Processor Trace Part2. Better debugging experience.</h1>
    <div><div class="notebody"> <p><strong>Contents:</strong></p> <p><strong>Subscribe to my <a href="/blog/2019/08/30/Intel-PT-part2#mc_embed_signup">mailing list</a> to get more updates from me!</strong></p> <p>In the <a href="https://easyperf.net/blog/2019/08/23/Intel-Processor-Trace">first part</a> of my series about Intel Processor Traces (PT) I showed the underlying mechanics of this HW feature and talked a bit about its main use cases. In this article I will go into one of areas where PT can provide additional value, which is debugging.</p> <h3 id="postmortem-debugging">Postmortem debugging</h3> <p>Traditionally, in embedded world, issues that happen in production environment are being debugged by logging. But sometimes it&#x2019;s not enough. Suppose we have a function like this with a big switch inside:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">someComplexFunc</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span> <span class="n">log</span><span class="p">(</span><span class="s">&quot;Enter calculations&quot;</span><span class="p">);</span> <span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span> <span class="k">case</span> <span class="mi">7498536</span><span class="p">:</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">7498536</span> <span class="o">/</span> <span class="n">x</span><span class="p">;</span> <span class="c1">// potential div by zero
</span> <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">42</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// &lt;lots of other cases&gt;
</span> <span class="nl">default:</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span> <span class="n">log</span><span class="p">(</span><span class="s">&quot;result: x = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Customer reports that once in a while they see some of their machines crash. In the logs they provided the last lines are:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time           message
19:25:13:0124: bar: calling foo
19:25:13:0134: foo: Enter calculations
</code></pre></div></div> <p>Well, that&#x2019;s better than nothing, still doesn&#x2019;t give any clue what exactly the problem is. If the switch is big enough it will be hard to find where exactly is the issue.</p> <p>Intel PT can provide a little bit more insights. I used <a href="https://github.com/andikleen/simple-pt">simple-pt</a> to collect the traces <sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>. Please refer to <code class="highlighter-rouge">simple-pt</code> documentation<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> for how to build and use it.</p> <p>Source code for this example is available on my <a href="https://github.com/dendibakh/dendibakh.github.io/tree/master/_posts/code/IntelPT/postmortem">github</a>. I built the program like this:</p> <p>The command below collects the traces. By default <code class="highlighter-rouge">simple-pt</code> saves the traces into 2MB circular buffer. This means new traces overwrite the old ones. So, even for long running applications we can have a trace of what was happening just before the crash:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>sptcmd <span class="nt">-K</span> <span class="nt">--cyc</span> 1 taskset <span class="nt">-c</span> 0 ./app
</code></pre></div></div> <p>After we collected the traces we can decode them with: <sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>sptdecode <span class="nt">-s</span> ptout.sideband <span class="nt">--pt</span> ptout.0 <span class="nt">-i</span> <span class="nt">-t</span> | xed <span class="nt">-F</span> insn: <span class="nt">-A</span> <span class="nt">-64</span> <span class="o">&gt;</span> dump.txt
</code></pre></div></div> <p>If we now look into the <code class="highlighter-rouge">dump.txt</code>, right at the bottom we will see something like:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;...&gt;
560a8ef2870d 0  call  callq  0x560a8ef2866allq
560a8ef2866b 0 other  mov %rsp, %rbp
560a8ef2866e 0 other  movl  %edi, -0x14(%rbp) 
560a8ef28671 0 other  movl  $0x0, -0x8(%rbp) 
560a8ef28678 0 other  movl  -0x14(%rbp), %eax 
560a8ef2867b 0 other  cmp $0x1d4a, %eax
560a8ef28680 0 cjump  jnz 0x560a8ef28699	// arg == 7498536
560a8ef28682 0 other  mov $0x1d4a, %eax 	// entering the block
560a8ef28687 0 other  cdq			// with div by zero
</code></pre></div></div> <p>I was having some issues with emitting source code lines in the dumps. In <code class="highlighter-rouge">sptdecode</code> there is <code class="highlighter-rouge">-d</code> option that is supposed to print source code intermixed with the associated assembly code. After discussing the issue with Andi Kleen it looks like the problem is somewhere on my side.<sup id="fnref:5"><a href="#fn:5" class="footnote">4</a></sup></p> <p>In this example you can see how Intel PT can tell us the last instructions that were executed<sup id="fnref:4"><a href="#fn:4" class="footnote">5</a></sup>. <strong>Intel PT can be used as an almost free<sup id="fnref:6"><a href="#fn:6" class="footnote">6</a></sup> addition to the logging capabilities of your applications and often can provide a big chunk of useful information for postmortem debugging</strong>.</p> <p>Logs still are very useful because you can print some values in them. Until <code class="highlighter-rouge">PTWRITE</code> instruction came out there was no way of dumping data in processor traces. Traces were only useful for determining control flow. But in recent CPUs we have <code class="highlighter-rouge">PTWRITE</code> instruction that allows writing values into the PT packets<sup id="fnref:7"><a href="#fn:7" class="footnote">7</a></sup>. According to <a href="https://software.intel.com/en-us/articles/intel-sdm">Intel SD Manual</a>:</p> <blockquote> <p>This instruction reads data in the source operand and sends it to the Intel Processor Trace hardware to be encoded
in a PTW packet.</p>
</blockquote> <p>I haven&#x2019;t used <code class="highlighter-rouge">PTWRITE</code> in practice, but I assume that every time you want to print something new you need to recompile the binary. Though you need to do the same when using logs.</p> <p>My Intel Core i5-8259U doesn&#x2019;t have <code class="highlighter-rouge">PTWRITE</code> support. You can check whether your CPU has <code class="highlighter-rouge">PTWRITE</code> support with <a href="http://halobates.de/spt-man/ptfeature.html">ptfeature</a> tool which is a part of <code class="highlighter-rouge">simple-pt</code>.</p> <h3 id="debugging-stack-corruption-issues">Debugging stack corruption issues</h3> <p>Now let me show another case where Intel PT can be useful.</p> <p>Let me jump right into the example with the program where the call stack is being corrupted:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a.c
</span><span class="kt">void</span> <span class="n">bar</span><span class="p">();</span> <span class="c1">// implemented in assembly below
</span>
<span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span>
<span class="p">{</span> <span class="n">bar</span><span class="p">();</span>
<span class="p">}</span> <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <pre><code class="language-asm">// b.asm
GLOBAL bar

bar:
pop rdx       ; remove return address from the stack
xor rax, rax
ret
ud2
</code></pre> <p>Source code for this example is available on my <a href="https://github.com/dendibakh/dendibakh.github.io/tree/master/_posts/code/IntelPT/stack_corruption">github</a>. Let&#x2019;s build the program and make sure it&#x2019;s crashing:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gcc a.c <span class="nt">-c</span> <span class="nt">-g</span>
<span class="nv">$ </span>nasm <span class="nt">-f</span> elf64 b.asm <span class="nt">-g</span>
<span class="nv">$ </span>gcc a.o b.o
<span class="nv">$ </span>./a.out
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
</code></pre></div></div> <p>When I run usual (pre-installed) version of gdb:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/bin/gdb ./a.out
GNU gdb <span class="o">(</span>Ubuntu 8.1-0ubuntu3<span class="o">)</span> 8.1.0.20180409-git
<span class="o">(</span>gdb<span class="o">)</span> r
Starting program: /path/to/a.out
Program received signal SIGSEGV, Segmentation fault.
0x00007fffffffe336 <span class="k">in</span> ?? <span class="o">()</span>
<span class="o">(</span>gdb<span class="o">)</span> bt
<span class="c">#0 0x00007fffffffe336 in ?? ()</span>
<span class="c">#1 0x00007fffffffe320 in ?? ()</span>
<span class="c">#2 0x00007fffffffe320 in ?? ()</span>
<span class="c">#3 0x00007fffffffe320 in ?? ()</span>
<span class="c">#4 0x0000555555554619 in main () at a.c:10</span>
Backtrace stopped: frame did not save the PC
</code></pre></div></div>
<p>Stack is corrupted, so gdb is not able to unwind it. According to my experiments, <a href="https://rr-project.org/">rr</a> tool cannot provide any additional value either.</p> <p>Now let&#x2019;s try to run the same example using build-from-sources gdb and record traces. You can find particular instructions in the <a href="/blog/2019/08/30/Intel-PT-part2#appendix-how-to-build-gdb-with-intel-pt-support">appendix</a> of this article.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/local/bin/gdb ./a.out
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> 8.3.50.20190822-git
<span class="o">(</span>gdb<span class="o">)</span> start
Starting program: /path/to/a.out
Temporary breakpoint 1, main <span class="o">()</span> at a.c:10
10 foo<span class="o">()</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span> record btrace pt
<span class="o">(</span>gdb<span class="o">)</span> c
Continuing.
Program received signal SIGSEGV, Segmentation fault.
0x00007fffffffe336 <span class="k">in</span> ?? <span class="o">()</span>
</code></pre></div></div>
<p>We have the crash, let&#x2019;s now see the call history:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> record <span class="k">function</span><span class="nt">-call-history</span>
1       main
2       foo
3       bar
4       ??
</code></pre></div></div>
<p>We can even pull the previous executed instructions.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> record instruction-history /m -
4 0x00005555555545fb &lt;foo+1&gt;: mov %rsp,%rbp
a.c:5 bar<span class="o">()</span><span class="p">;</span>
5 0x00005555555545fe &lt;foo+4&gt;: mov <span class="nv">$0x0</span>,%eax
6 0x0000555555554603 &lt;foo+9&gt;: callq 0x555555554620 &lt;bar&gt;
7 0x0000555555554620 &lt;bar+0&gt;: pop %rdx
8 0x0000555555554621 &lt;bar+1&gt;: xor %rax,%rax
9 0x0000555555554624 &lt;bar+4&gt;: retq
10 0x00007fffffffe330: xor %al,0x55<span class="o">(</span>%rsi<span class="o">)</span>
11         0x00007fffffffe333:  push   %rbp
12         0x00007fffffffe334:  push   %rbp
13         0x00007fffffffe335:  push   %rbp
</code></pre></div></div>
<p>Here <code class="highlighter-rouge">/m</code> switch is used for intermixing source code with assembly instructions. Because <code class="highlighter-rouge">bar</code> is implemented in assembly there is obviously no source line for it. But for <code class="highlighter-rouge">foo</code> function we see the corresponding source line (<code class="highlighter-rouge">a.c:5</code>).</p> <p>After we know the exact place where the issue happened we can put normal breakpoint and restart debugging session as usual.</p> <p><strong>As you see, Intel PT helps when debugging programs with corrupted stack</strong>.</p> <h3 id="appendix-how-to-build-gdb-with-intel-pt-support">Appendix: How to build gdb with Intel PT support</h3> <p>This <a href="http://sourceware-org.1504.n7.nabble.com/Could-not-use-quot-record-btrace-quot-even-if-I-have-Intel-PT-hardware-feature-td412196.html">page</a> would probably be a good starting point. GDB uses <a href="https://github.com/intel/libipt">libipt</a> for collecting PT, so we need to build it first:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/intel/libipt.git
mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
cmake ../libipt
make
make install
</code></pre></div></div> <p>Then we build gdb from sources as shown <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1526617#c5">here</a>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt install texinfo bison flex
git clone git://sourceware.org/git/binutils-gdb.git
mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
../binutils-gdb/configure <span class="nt">--disable-binutils</span> <span class="nt">--disable-ld</span> <span class="nt">--disable-gold</span> <span class="nt">--disable-gas</span> <span class="nt">--disable-sim</span> <span class="nt">--disable-gprof</span>
make
make install
</code></pre></div></div> </div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>