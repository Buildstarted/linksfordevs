<!DOCTYPE html>
<html lang="en">
<head>
    <title>
CoreCLR&#x2019;s environment is not your environment -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>CoreCLR’s environment is not your environment</h1><div><div id="post-set-environment-variable" class="page post mb6"><header><p class="post-date heading"><time datetime="2019-02-28T00:00:00+00:00">28 Feb 2019</time> in <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a> / <span>Dotnetcore</span> / <span>Version</span> / <span>Api</span> / <span>Design</span></p><p class="message"> CoreCLR maintains its own private copy of environment variables</p></header><p>This came up when I was helping another collegue in a previous job (where I still write C# code probably 50% of the time), diagnosing a library load failure problem inside a linux container. Internally there is this library that loads different implementations (mock implementation and real implementation) of another library based on a environment variable <code class="highlighter-rouge">USE_MAGIC_TEST_LIB</code>, and the .NET code calling that library is calling <code class="highlighter-rouge">SetEnvironmentVariable</code> to set it conditionally as part of a testing framework:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="n">useTestFramework</span><span class="p">)</span><span class="p">{</span><span class="n">Environment</span><span class="p">.</span><span class="nf">SetEnvironmentVariable</span><span class="p">(</span><span class="s">"USE_MAGIC_TEST_LIB"</span><span class="p">,</span><span class="s">"1"</span><span class="p">);</span><span class="p">}</span><span class="n">NativeCode</span><span class="p">.</span><span class="nf">CallToSomeNativeLibraryThatLoadsDifferentLibraryDependsOnEnv</span><span class="p">();</span></code></pre></div></div><p>This looks reasonable except that it didn’t work at all. It loaded the wrong library and things quickly went down hill after that.</p><p>We were scratching our heads for a while until we decided to add a trace to see if the environment is actually taking effect or not in the native code. Interestingly, the native code didn’t see it at all. It’s like they don’t know about each other’s environment!</p><p>Actually that observation is more or less what’s going on. Before we dig in a bit deeper, here is a bit of history of CoreCLR cross-platform implementation. Not surprisingly, .NET code started as Windows centric and all the OS calls are strictly Windows API. At some point folks decide to port it to linux/Mac as part of Rotor (later Silverlight), there are two options:</p><ol><li>Design a new platform abstraction from scratch and move it to that</li><li>Align the API design to Windows and implement Windows API on top of Linux API</li></ol><p>2 is obviously the cheaper solution and has the advantage that Windows code would be untouched and therefore won’t get regressions, which is super important. The caveat is that implementing Windows API using Linux API can get tricky, but is the risk people are willing to take. So the new PAL layer is introduced with “new” APIs that looks exactly like Windows APIs implemented using Linux APIs.</p><p>In the case of <code class="highlighter-rouge">SetEnvironmentVariable</code>, it is implemented in PAL/environ.cpp:</p><div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span><span class="n">PALAPI</span><span class="nf">SetEnvironmentVariableA</span><span class="p">(</span><span class="n">IN</span><span class="n">LPCSTR</span><span class="n">lpName</span><span class="p">,</span><span class="n">IN</span><span class="n">LPCSTR</span><span class="n">lpValue</span><span class="p">)</span><span class="p">{</span><span class="c1">// ...
</span><span class="c1">// All the conditions are met. Set the variable.
</span><span class="kt">int</span><span class="n">iLen</span><span class="o">=</span><span class="n">strlen</span><span class="p">(</span><span class="n">lpName</span><span class="p">)</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">lpValue</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span><span class="n">LPSTR</span><span class="n">string</span><span class="o">=</span><span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">PAL_malloc</span><span class="p">(</span><span class="n">iLen</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="n">string</span><span class="o">==</span><span class="nb">nullptr</span><span class="p">)</span><span class="p">{</span><span class="n">bRet</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span><span class="n">ERROR</span><span class="p">(</span><span class="s">"Unable to allocate memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="n">SetLastError</span><span class="p">(</span><span class="n">ERROR_NOT_ENOUGH_MEMORY</span><span class="p">);</span><span class="k">goto</span><span class="n">done</span><span class="p">;</span><span class="p">}</span><span class="n">sprintf_s</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">iLen</span><span class="p">,</span><span class="s">"%s=%s"</span><span class="p">,</span><span class="n">lpName</span><span class="p">,</span><span class="n">lpValue</span><span class="p">);</span><span class="n">nResult</span><span class="o">=</span><span class="n">EnvironPutenv</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">FALSE</span><span class="p">)</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">PAL_free</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="n">string</span><span class="o">=</span><span class="nb">nullptr</span><span class="p">;</span><span class="c1">// If EnvironPutenv returns FALSE, it almost certainly failed to allocate memory.
</span><span class="k">if</span><span class="p">(</span><span class="n">nResult</span><span class="o">==</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="p">{</span><span class="n">bRet</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span><span class="n">ERROR</span><span class="p">(</span><span class="s">"Unable to allocate memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="n">SetLastError</span><span class="p">(</span><span class="n">ERROR_NOT_ENOUGH_MEMORY</span><span class="p">);</span><span class="k">goto</span><span class="n">done</span><span class="p">;</span><span class="p">}</span></code></pre></div></div><p>This looks a bit fishy. It’s allocating its own buffer and calls into EnvironPutenv, which basically does this:</p><div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="nb">nullptr</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="p">{</span><span class="k">const</span><span class="kt">char</span><span class="o">*</span><span class="n">existingEquals</span><span class="o">=</span><span class="n">strchr</span><span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="sc">'='</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="n">existingEquals</span><span class="o">-</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">nameLength</span><span class="p">)</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nameLength</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="p">{</span><span class="n">free</span><span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">copy</span><span class="p">;</span><span class="n">result</span><span class="o">=</span><span class="n">TRUE</span><span class="p">;</span><span class="k">break</span><span class="p">;</span><span class="p">}</span><span class="p">}</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="nb">nullptr</span><span class="p">)</span><span class="p">{</span><span class="n">_ASSERTE</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">palEnvironmentCapacity</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="p">(</span><span class="n">palEnvironmentCapacity</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="p">{</span><span class="c1">// We found the first null, but it's the last element in our environment
</span><span class="c1">// block. We need more space in our environment, so let's double its size.
</span><span class="kt">int</span><span class="n">resizeRet</span><span class="o">=</span><span class="n">ResizeEnvironment</span><span class="p">(</span><span class="n">palEnvironmentCapacity</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="n">resizeRet</span><span class="o">!=</span><span class="n">TRUE</span><span class="p">)</span><span class="p">{</span><span class="n">free</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span><span class="k">goto</span><span class="n">done</span><span class="p">;</span><span class="p">}</span><span class="p">}</span><span class="n">_ASSERTE</span><span class="p">(</span><span class="n">copy</span><span class="o">!=</span><span class="nb">nullptr</span><span class="p">);</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">copy</span><span class="p">;</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">nullptr</span><span class="p">;</span><span class="n">palEnvironmentCount</span><span class="o">++</span><span class="p">;</span><span class="n">result</span><span class="o">=</span><span class="n">TRUE</span><span class="p">;</span><span class="p">}</span></code></pre></div></div><p>So it’s basically managing its own memory in <code class="highlighter-rouge">palEnvironment</code> environment array! No wonder things don’t work.</p><p>But why go through all the trouble while Linux has its own <code class="highlighter-rouge">getenv</code>/<code class="highlighter-rouge">setenv</code>?</p><p>These posts provides the answer:</p><p>http://rachelbythebay.com/w/2017/01/30/env/</p><blockquote><p>Modifications of environment variables are not allowed in multi-threaded programs. – the glibc manual</p></blockquote><p>https://github.com/dotnet/coreclr/issues/635</p><blockquote><p>From looking at the code, I suspect that the cached environment was attempt to fix thread safety or consistency problems between Environment.GetEnvironmentVariables and Environment.SetEnvironmentVariable.</p></blockquote><blockquote><p>The enumeration of the environment starts by reading the <a href="https://linux.die.net/man/5/environ">environ</a> global variable, without any locks. Consider what may happen if somebody calls setenv while the enumeration is in progress.</p></blockquote><p>It’s because <code class="highlighter-rouge">setenv</code>/<code class="highlighter-rouge">getenv</code> isn’t particularly thread safe - you can crash when reading environment while the environment get modifed by another thread, or two threads modifying environment at the same time can lead to leaks.</p><p>In this case, one can see a few options:</p><ol><li>Do nothing - the issues are linux-specific and you should take care when calling these functions, the same way just like you call them in linux.</li><li>Throw PlatformNotSupported - getenv/setenv just isn’t safe</li><li>Adding critical section around getenv/setenv - make them safe to be called in multiple threads</li><li>Implement your own safe environment helpers - as a result rest of the native library won’t observe the change through <code class="highlighter-rouge">getenv</code>/<code class="highlighter-rouge">setenv</code></li></ol><p>1 isn’t really acceptable because .NET developers need the code to be portable - they don’t want handle the platform special oddies to make their code portable. They would like .NET platform library to be safe and reliable.</p><p>2 isn’t great either for the same reason, and also it’ll break a ton of code when ported to linux.</p><p>3 makes .NET code safe, but it wouldn’t protect against native code racing with getenv/setenv calls from within .NET code, so race conditions would still occur and .NET developer has little control.</p><p>4 is safe, but can lead to subtle breaking changes.</p><p>Unfortunately there isn’t a great option here. 1, 2, and 4 are safe option, but all of them have their downsides. At the end of the day, it comes down to compatibility/portability vs surprising behavior. .NET team favors compatibility and portability. While it can lead to sutble breaking changes, fortunately the breaking changes are consistent and therefore easier to diagnose. In our case being a container launched by another system makes the whole thing much harder to diagnose, but that’s more a problem of the container launcher itself. Even though we were bit by the very same problem, I agree it is most likely the better choice.</p><p>For more information, you can refer to CoreCLR code here:</p><p>https://github.com/dotnet/coreclr/blob/master/src/pal/src/misc/environ.cpp#L607</p><p>And here is a simple code snippet to demonstrate the issue. I’ve tested this on my MBP.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span><span class="nn">System</span><span class="p">;</span><span class="k">using</span><span class="nn">System.Runtime.InteropServices</span><span class="p">;</span><span class="k">namespace</span><span class="nn">set_env</span><span class="p">{</span><span class="k">class</span><span class="nc">Program</span><span class="p">{</span><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"/usr/lib/system/libsystem_c.dylib"</span><span class="p">)]</span><span class="k">static</span><span class="k">extern</span><span class="n">IntPtr</span><span class="nf">getenv</span><span class="p">(</span><span class="kt">string</span><span class="n">name</span><span class="p">);</span><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"/usr/lib/system/libsystem_c.dylib"</span><span class="p">)]</span><span class="k">static</span><span class="k">extern</span><span class="kt">int</span><span class="nf">setenv</span><span class="p">(</span><span class="kt">string</span><span class="n">name</span><span class="p">,</span><span class="kt">string</span><span class="k">value</span><span class="p">);</span><span class="k">static</span><span class="k">void</span><span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span><span class="n">args</span><span class="p">)</span><span class="p">{</span><span class="kt">string</span><span class="n">envName</span><span class="p">=</span><span class="s">"MY_ENV"</span><span class="p">;</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"MY_ENV={0}"</span><span class="p">,</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">));</span><span class="n">Environment</span><span class="p">.</span><span class="nf">SetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">,</span><span class="s">"~/path"</span><span class="p">);</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Setting it to ~/path"</span><span class="p">);</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"MY_ENV={0}"</span><span class="p">,</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">));</span><span class="n">IntPtr</span><span class="n">env</span><span class="p">=</span><span class="nf">getenv</span><span class="p">(</span><span class="n">envName</span><span class="p">);</span><span class="kt">string</span><span class="n">envStr</span><span class="p">=</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAnsi</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"getenv(MY_ENV)={0}"</span><span class="p">,</span><span class="n">envStr</span><span class="p">);</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Setting it using setenv"</span><span class="p">);</span><span class="nf">setenv</span><span class="p">(</span><span class="n">envName</span><span class="p">,</span><span class="s">"~/path"</span><span class="p">);</span><span class="n">env</span><span class="p">=</span><span class="nf">getenv</span><span class="p">(</span><span class="n">envName</span><span class="p">);</span><span class="n">envStr</span><span class="p">=</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAnsi</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"getenv(MY_ENV)={0}"</span><span class="p">,</span><span class="n">envStr</span><span class="p">);</span><span class="p">}</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>Now if you are interested to dig in a bit more, here are some bonus questions for your consideration:</p><ol><li>Does the same problem happen in Windows? And why/why not?</li><li>Why does the above code above use <code class="highlighter-rouge">Marshal.PtrToStringAnsi</code> instead of just have <code class="highlighter-rouge">getenv</code> returning the string?</li></ol><p>That’s all for now. Thanks for reading!</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>