<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Zero PMK Installation (CVE-2019-12587) | Garbelini M. E. -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Zero PMK Installation (CVE-2019-12587) | Garbelini M. E.</h1>
    <div class="article-style"> <p>The vulnerability (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-12587">CVE-2019-12587</a>) found in latest SDK version of ESP32 and ESP8266 (ESP-IDF v4.0-dev-459-gba1ff1692 and NONOS-SDK v3.0-103-g7a31cb7 respectivelly) allows an attacker to take control of the Wi-Fi device EAP session by sending an EAP-Fail message in the final step during connection between the device and the access point (AP). It was discovered that both devices updates their Pairwise Master Key (PMK) only when they receive an EAP-Success message. If an EAP-Fail message is received before the EAP-Success, the device skips to update the PMK received during a normal EAP exchange (EAP-PEAP, EAP-TTLS or EAP-TLS). Even in such situation, the device accepts normally the EAPoL 4-Way handshake.</p> <p>Each time ESP32/ESP8266 starts, the PMK is initialised as zero, thus, if an EAP-Fail message is sent before the EAP-Success, the device uses a zero PMK. This allows an attacker to hijack the connection between the AP and the device.</p> <h2 id="exploitation-scenario">Exploitation scenario</h2> <p>&#x200B; The vulnerability can be better understood when presented in the following diagram:</p> <p><img src="zero_pmk_diagram.png" alt="pdfresizer.com-pdf-convert"></p> <p>A Wireshark capture (<a href="capture_vulnerability_TTLS.pcapng">download</a>) of the attacker triggering the vulnerability is shown in the figure below.</p> <p><img src="wireshark_capture.png" alt="wireshark_capture"></p> <p>The highlighted packet (Failure) is sent by the attacker, which then proceeds to send a Message 1, generated with a PMK or pre shared key equal to zero. As you can see, the client normally responds with message 3 and 4. Wi-Fi devices that are not vulnerable simply ignores such failure message and respond only when they received a valid message 1 from the real AP.</p> <h2 id="impact">Impact</h2> <p>Attackers can exploit this vulnerability to hijack ESP32/ESP8266 Wi-Fi clients connected to enterprise network without even knowing anything about username, password or certificates used during the enterprise keys exchanging methods (EAP-PEAP, EAP-TTLS or EAP-TLS). This allows an attackers in radio range to replay, decrypt, or spoof frames via a rogue access point. This practically means that <strong>unpatched ESP devices are more secure by actually using just WPA2 Personal.</strong></p> <p>It&#x2019;s important to mention that attackers can also exploit <a href="../../post/esp32-esp8266-eap-crash/">CVE-2019-12586</a> and <a href="../../post/esp8266-beacon-frame-crash/">CVE-2019-12588</a> to force both ESP32 and ESP8266 to crash, which reinitializes their default PMK to zero again.</p> <p>Espressif has fixed such problem and committed patches for ESP32 SDK, however, as of the date of this post, the SDK and Arduino board support for ESP8266 appears to be unpatched.</p> <p>The security patch made by Espressif can be tracked in the following commit link:</p> <h2 id="proof-of-concept-tool">Proof of Concept tool</h2> <p>If you wish to test your ESP32/8266 device against this vulnerability, you can check my repository:</p> <p><a href="https://github.com/Matheus-Garbelini/esp32_esp8266_attacks">https://github.com/Matheus-Garbelini/esp32_esp8266_attacks</a></p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>