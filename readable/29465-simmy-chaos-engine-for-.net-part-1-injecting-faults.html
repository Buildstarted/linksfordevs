<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Simmy Chaos Engine for .NET &#x2013; Part 1, Injecting Faults -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Simmy Chaos Engine for .NET – Part 1, Injecting Faults</h1><div><div class="entry-content"><p><i>Full source code <a href="https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/SimmyFault.zip">here</a></i>.</p><p>For quite a while I have been writing, presenting and making videos about using Polly to make applications more stable.</p><p>With this post I’m starting a series on how break your applications with a chaos engine, the kind you might have heard about from the likes of NetFlix.</p><p>The team behind Polly released a chaos engineering module in June 2019. It allows you to inject faults, latency and arbitrary behavior into your application.</p><p>There are two general ways of using these policies –<br>1. Within your own business logic (if you have access to it).<br>2. Within the calls to business logic (if you can’t or don’t want to change it).</p><p>I’m going to deal with the latter case in this post. I want to see how my code responds when failures occur in third party dependencies, since I have no control over those dependencies I have to introduce the errors myself.</p><p><strong>Making a good service go bad</strong><br>In the provided code I have dependency on remote service and I want make it seem that that service suffers from a high percentage of faults.<br>This example will make <code>GET</code> requests to an API that looks up breweries, from what I can tell it is a highly reliable API, but I will make look as though 50% of requests to it fail. The point of doing this is to see how my application reacts to these errors – does it do so gracefully, or does it fall on its face.</p><p>If you made requests to the API without interfering with them you should see a 100% success rate. But I want to see failures, so I’ll use the Fault Policy to inject exceptions.</p><p>First, I added two NuGet packages to my project – <code>Polly.Contrib.Simmy</code> and <code>Microsoft.Extensions.Http.Polly</code> to the project. </p><p>In <code>Startup.cs</code> I add the fault policy.</p><pre class="brush: csharp; title: ; notranslate" title="">AsyncInjectOutcomePolicy&lt;HttpResponseMessage&gt; faultPolicy = MonkeyPolicy.InjectFaultAsync&lt;HttpResponseMessage&gt;(
	new HttpRequestException("Simmy threw an exception"), 
		injectionRate: .5,
		enabled: () =&gt; true
	);
</pre><p>The parameters specify the exception to throw, the percentage of requests that throw the exception, and whether the policy is enabled. You can use set the injection rate and  whether the policy is enabled via configuration, but I’m not going to show that here.<br>In this case, I am throwing an <code>HttpRequestException</code> 50% of the time, and the policy is enabled.</p><p>Then create a <code>HttpClientFactory</code> for the <a href="https://www.openbrewerydb.org" rel="noopener" target="_blank">OpenBreweryDb</a> – </p><pre class="brush: csharp; title: ; notranslate" title="">services.AddHttpClient("OpenBreweryDb", client =&gt;
{
	client.BaseAddress = new Uri("https://api.openbrewerydb.org/breweries/");
	client.DefaultRequestHeaders.Add("Accept", "application/json");
}).AddPolicyHandler(faultPolicy);
</pre><p>If you are not yet using the <code>HttpClientFactory</code>, the source code has an example for you too, check the <code>BreweryNoHttpClientFactoryController</code>.</p><p>Start up the application, it should open on port 5000 and make a request to look up Night Shift Brewing in Massachusetts. There is a 50% chance of an exception occurring with each request.</p><p>Try it out. You’ll see that my application does not handle these failures very well, it simply returns the error to original caller.</p><p><a href="https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/Simmy-Fault-Error-Page.jpg"><img src="https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/Simmy-Fault-Error-Page-1024x375.jpg" alt="" width="640" height="234" class="aligncenter size-large wp-image-1390" srcset="https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/Simmy-Fault-Error-Page-1024x375.jpg 1024w, https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/Simmy-Fault-Error-Page-300x110.jpg 300w, https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/Simmy-Fault-Error-Page-768x281.jpg 768w, https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/Simmy-Fault-Error-Page.jpg 1544w" sizes="(max-width: 640px) 100vw, 640px"></a></p><p>That’s it, you are now starting down the road of mixing in some chaos into your application.</p><p><strong>What then?</strong><br>Great, my application fails, but we always knew it could. There’s not much point introducing failures unless you plan to handle them in some way, and this is where you might add a retry policy to improve you likelihood of a successful request.</p><p>Of course, the Polly retry, or wait and retry policies would be ideal. I’ll show how to do just that in the next post.</p><p><i>Full source code <a href="https://nodogmablog.bryanhogan.net/wp-content/uploads/2019/07/SimmyFault.zip">here</a></i>.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>