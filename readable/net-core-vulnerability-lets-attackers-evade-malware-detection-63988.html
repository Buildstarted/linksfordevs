<!DOCTYPE html>
<html lang="en">
<head>
    <title>
.NET Core vulnerability lets attackers evade malware detection - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content=".NET Core vulnerability lets attackers evade malware detection - linksfor.dev(s)"/>
    <meta property="article:author" content="Ax Sharma"/>
    <meta property="og:description" content="A vulnerability in the .NET Core library allows malicious programs to be launched while evading detection by security software."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.bleepingcomputer.com/news/security/net-core-vulnerability-lets-attackers-evade-malware-detection/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - .NET Core vulnerability lets attackers evade malware detection</title>
<div class="readable">
        <h1>.NET Core vulnerability lets attackers evade malware detection</h1>
            <div>by Ax Sharma</div>
            <div>Reading time: 6-7 minutes</div>
        <div>Posted here: 08 Jul 2020</div>
        <p><a href="https://www.bleepingcomputer.com/news/security/net-core-vulnerability-lets-attackers-evade-malware-detection/">https://www.bleepingcomputer.com/news/security/net-core-vulnerability-lets-attackers-evade-malware-detection/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
<p><img alt=".NET Core" height="450" src="https://www.bleepstatic.com/content/hl-images/2020/03/11/net-core.jpg" width="1280"></p>
<p>A vulnerability in the .NET Core library allows malicious programs to be launched while evading detection by security software.</p>
<p>This vulnerability is caused by a Path Traversal bug in Microsoft’s .NET Core library that allows malicious garbage collection DLLs to be loaded by users with low privileges.</p>
<p>This bug affects the latest <a href="https://dotnet.microsoft.com/download/dotnet-core/3.1" rel="nofollow" target="_blank">stable release</a> (3.1.x versions) of .NET Core.&nbsp;A fix is not currently available and could let attackers execute malicious code on a system without being readily detected by antivirus and EDR products. 1</p>
<p>Discovered by <a href="https://www.contextis.com/en/blog/bring-your-own-.net-core-garbage-collector" rel="nofollow" target="_blank">Paul Laîné</a> of Context Information Security, the vulnerability is possible due to two main reasons:</p>
<ul><li>
<p role="presentation">.NET Core lets you use a custom DLL as its garbage collector</p>
</li>
<li>
<p role="presentation">The environment variable “COMPlus_GCName” used for specifying a custom .NET garbage collector is not sanitized. Therefore any traversal characters (../) provided in the garbage collector path go unfiltered.&nbsp; &nbsp;</p>
</li>
</ul><p>.NET Core uses a 'garbage collector' to allocate and free up system memory used by a .NET Core application.</p>
<p>It is possible, though, for users to create custom garbage collectors in the form of DLLs that will be loaded by a .NET core application.</p>
<p>.NET Core, though, allows any user, including those with low privileges, to load a custom garbage collector DLL, even those containing malicious code.</p>
<h2>Exploiting this bug</h2>
<p>Before exploiting this flaw, the attacker already needs to have at least some level of access to the system&nbsp;to set environment variables. That means&nbsp;this flaw would realistically be used in conjunction with an existing exploit, such as in a&nbsp;<a href="https://www.first.org/cvss/user-guide#3-4-Vulnerability-Chaining" rel="nofollow" target="_blank">vulnerability chaining</a> scenario.</p>
<p>The main incentive for a hacker to incorporate this attack in their toolkit would be to prevent their malicious payload from being detected by security software running on the compromised machine.</p>
<p>To exploit this bug, an attacker would first create a <a href="http://github.com/am0nsec/MCGC" rel="nofollow" target="_blank">custom garbage collector</a> containing malicious code that they want to execute on a compromised machine.</p>
<p>They then set an environment variable that causes .NET Core to use this customized DLL.</p>
<div>
<figure><img alt="Set a custom garbage collector" height="372" src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/set-garbage-collector.jpg" width="798"><figcaption><strong>Set a custom garbage collector</strong><br>
Source: <a href="https://www.reddit.com/r/purpleteamsec/comments/hkrufe/net_core_directory_traversal_vulnerability_attack/" target="_blank">Reddit</a></figcaption></figure></div>
<p data-inc="1">When loaded, the malicious code will be executed by the legitimate .NET Core process, dotnet.exe, under the impression that the DLL is merely a customized garbage collector.</p>
<div>
<figure><img alt="Example of a malicious garbage collector DLL" height="500" src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/code.jpg" width="871"><figcaption><strong>Example of a malicious garbage collector DLL</strong></figcaption></figure></div>
<p>Once the garbage collector DLL is loaded by the .NET Core framework, the payload begins execution, which <a href="http://www.reddit.com/r/purpleteamsec/comments/hkrufe/net_core_directory_traversal_vulnerability_attack/" rel="nofollow" target="_blank">in this cause</a> is a reverse TCP shell.</p>
<div>
<figure><img alt="Reverse meterpreter shell launched" height="500" src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/shell-launched.jpg" width="1430" data-src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/shell-launched.jpg"><figcaption><strong>Reverse meterpreter shell launched</strong></figcaption></figure></div>
<p>In a real-world scenario, an attacker with access to a compromised machine can use a simple batch script to have .NET Core run their malicious DLL, without being detected.</p>
<h2>Why can’t EDR products detect this?</h2>
<p>The researchers at Pentest Laboratories further analyzed this vulnerability and provided additional insight.</p>
<p>The researchers explain that the exploit uses what’s known as a <a href="https://attack.mitre.org/techniques/T1093/" rel="nofollow" target="_blank">process hollowing</a> technique.&nbsp;</p>
<p>“Paul Laîné in his proof of concept used the technique process hollowing to inject code into a legitimate process since the process is created in a suspended state, memory regions are not mapped to a file and are replaced by the actual shellcode,” explains the Pentest Laboratories&nbsp;<a href="https://pentestlaboratories.com/2020/07/02/net-core-evasion-detection/" rel="nofollow" target="_blank">blog post</a>.&nbsp;</p>
<p>Because the malicious code execution happens under a legitimate process, this technique is useful in evading stringent detection and defense controls employed by security software products.</p>
<h2>How to detect and remediate the evasive code execution?</h2>
<p>Pentest Laboratories researchers have provided a couple of strategies for detecting if this vulnerability is being abused.</p>
<p>While it is nearly impossible to predict where the malicious garbage detector DLL resides on a system, the environment variable “COMPlus_GCName” remains a fixed string and can be monitored.</p>
<div>
<figure><img alt="Process using a custom garbage collector" height="520" src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/process-properties.jpg" width="825" data-src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/process-properties.jpg"><figcaption><strong>Process using a custom garbage collector</strong><br>
Source: Pentest Laboratories</figcaption></figure></div>
<p>“Even though the name of the DLL file, the path, the process,and the .NET application are completely arbitrary the ‘COMPlus_GCName’ is a fixed string,” state the researchers.&nbsp;</p>
<p>The researchers provide a YARA rule which can be used to monitor for instances of “COMPlus_GCName” within the evasive processes:</p>
<div>
<figure><img alt="YARA rule to detect .NET Core evasion" height="450" src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/yara-rule.jpg" width="745" data-src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/yara-rule.jpg"><figcaption><strong>YARA rule to detect .NET Core evasion</strong><br>
Source: Pentest Laboratories</figcaption></figure></div>
<p>Additionally, the researchers have provided Sysmon event IDs, which are sequentially created in environments where this vulnerability is being actively exploited.</p>
<div>
<figure><img alt="Sysmon events created by the .NET Core vulnerability" height="450" src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/sysmon-events.jpg" width="1062" data-src="https://www.bleepstatic.com/images/news/security/vulnerabilities/m/microsoft/net-core/sysmon-events.jpg"><figcaption><strong>Sysmon events created by the .NET Core vulnerability</strong><br>
Source: Pentest Laboratories</figcaption></figure></div>
<h2>Not a vulnerability, says Microsoft&nbsp;</h2>
<p data-inc="2">Because the exploitation of this mechanism requires that the attackers to have already the ability to set environment variables on the compromised&nbsp;system, Microsoft does not consider this a security vulnerability:&nbsp;</p>
<p>“Per MSRC, we do not consider this to be a security vulnerability. Exploiting this would require the adversary to modify the environment block, at which point they're already in control over other aspects of the application's execution.”, stated Microsoft’s representative in the <a href="http://github.com/dotnet/runtime/issues/38078#issuecomment-646089090" rel="nofollow" target="_blank">GitHub issue </a>reported by Laîné.</p>
<p>Laîné&nbsp;<a href="https://www.contextis.com/en/blog/bring-your-own-.net-core-garbage-collector" rel="nofollow" target="_blank">acknowledged</a> in his original disclosure, “Having the ability to use a custom GC is a legitimate feature and should probably not be removed. However, the path traversal should be addressed in order to limit the use of a custom GC to only users with local administrator privileges, which should be the case for a server-side application or in a development environment.”</p>
<p>Given there is no trivial fix for this “legitimate” feature, there remains the potential for abuse in .NET heavy enterprise environments.</p>

</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>