<!DOCTYPE html>
<html lang="en">
<head>
    <title>
WinDbg&#x200A;&#x2014;&#x200A;the Fun Way: Part 1 - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="WinDbg&#x200A;&#x2014;&#x200A;the Fun Way: Part 1 - linksfor.dev(s)"/>
    <meta property="article:author" content="https://medium.com/@yardenshafir2"/>
    <meta property="og:description" content="A while ago WinDbg added support for a new debugger data model, a change that completely changed the way we can use WinDbg. No more&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://medium.com/@yardenshafir2/windbg-the-fun-way-part-1-2e4978791f9b"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - WinDbg&#x200A;&#x2014;&#x200A;the Fun Way: Part 1</title>
<div class="readable">
        <h1>WinDbg&#x200A;&#x2014;&#x200A;the Fun Way: Part 1</h1>
            <div>by https://medium.com/@yardenshafir2</div>
            <div>Reading time: 25-32 minutes</div>
        <div>Posted here: 21 May 2020</div>
        <p><a href="https://medium.com/@yardenshafir2/windbg-the-fun-way-part-1-2e4978791f9b">https://medium.com/@yardenshafir2/windbg-the-fun-way-part-1-2e4978791f9b</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><section><div><div><div><div><div><div><p><a rel="noopener" href="https://medium.com/@yardenshafir2?source=post_page-----2e4978791f9b----------------------"><img alt="Yarden Shafir" src="https://miro.medium.com/fit/c/96/96/1*zlXYBZfOf8yzpBnGc2ufIQ.jpeg" width="48" height="48"></a></p></div></div></div></div><p id="bcef" data-selectable-paragraph="">A while ago WinDbg added support for a new <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/using-linq-with-the-debugger-objects" target="_blank" rel="noopener nofollow">debugger data model</a>, a change that completely changed the way we can use WinDbg. No more horrible MASM commands and obscure syntax. No more copying addresses or parameters to a notepad file so that you can use them in the next commands without scrolling up. No more running the same command over and over with different addresses to iterate over a list or an array.</p><p id="efd6" data-selectable-paragraph="">This is part 1 of this guide, because I didn’t actually think anyone would read through 8000 words of me explaining WinDbg commands. So you get 2 posts of 4000 words! That’s better, right?<br>In this first post we will learn the basics of how to use this new data model — using custom registers and new built-in registers, iterating over objects, searching them and filtering them and customizing them with anonymous types. And finally we will learn how to parse arrays and lists in a much nicer and easier way than you’re used to.<br>And in the net post we’ll learn the more complicated and fancier methods and features that this data model gives us.</p><p id="bb09" data-selectable-paragraph="">Now that we all know what to expect and grabbed another cup of coffee, let’s start!</p><p id="5f5b" data-selectable-paragraph="">This data model, accessed in WinDbg through the <code>dx</code> command, is an extremely powerful tool, able to define custom variables, structures, functions and use a wide range of new capabilities. It also lets us search and filter information with LINQ — an infrastructure similar to SQL.</p><p id="f315" data-selectable-paragraph="">This data model is documented and even has usage examples on github. Also all of its modules have documentation that can be viewed in the debugger with <code>dx -v &lt;method&gt;</code> (though you will get the same documentation if you run <code>dx &lt;method&gt;</code> without the <code>-v</code> flag):</p><pre><span id="04b4" data-selectable-paragraph=""><strong>dx -v Debugger.Utility.Collections.FromListEntry</strong></span><span id="e1c1" data-selectable-paragraph="">Debugger.Utility.Collections.FromListEntry [FromListEntry(ListEntry, [&lt;ModuleName | ModuleObject&gt;], TypeName, FieldExpression) — Method which converts a LIST_ENTRY specified by the ‘ListEntry’ parameter of types whose name is specified by the string ‘TypeName’ and whose embedded links within that type are accessed via an expression specified by the string ‘FieldExpression’ into a collection object. If an optional module name or object is specified, the type name is looked up in the context of such module]</span></pre><p id="3d36" data-selectable-paragraph="">There has also been some <a href="https://github.com/hugsy/defcon_27_windbg_workshop/blob/master/windbg_cheatsheet.md" target="_blank" rel="noopener nofollow">external</a> documentation, but I felt like there were things that needed further explanation and that this feature is worth more attention than it receives.</p><p id="bf86" data-selectable-paragraph="">First, NatVis adds the option for custom registers. Kind of like MASM had <code>@$t1</code>, <code>@$t2</code>, <code>@$t3</code> , etc. Only now you can call them whatever name you want, and they can have a type of your choice:</p><div id="7ea4" data-selectable-paragraph=""><p><code>dx @$myString = “My String”<br> dx @$myInt = 123</code></p><p>  We can see all our variables with <code>dx @$vars</code> and remove them with <code>dx @$vars.Remove("var name")</code>, or clear all with <code>@$vars.Clear()</code>. We can also use <code>dx</code> to show handle more complicated structures, such as an <code>EPROCESS</code>. As you might know, symbols in public PDBs don’t have types. That’s why with the old debugger we had to print the System process like this:</p></div><pre><span id="a7d8" data-selectable-paragraph="">0: kd&gt; <strong>x nt!PsInitialSystemProcess</strong><br>fffff807`4ef843a0 nt!PsInitialSystemProcess = &lt;no type information&gt;</span><span id="2484" data-selectable-paragraph="">0: kd&gt; dt nt!_EPROCESS fffff807`4ef843a0<br>+0x000 Pcb : _KPROCESS<br>+0x2e0 ProcessLock : _EX_PUSH_LOCK<br>+0x2e8 UniqueProcessId : (null) <br> …</span></pre><p id="ab9a" data-selectable-paragraph="">We first had to get the address of <code>PsInitialSystemProcess</code> and then print it as an <code>EPROCESS</code>. With <code>dx</code> we can be smarter and cast symbols directly, using c-style casts. But when we try to cast <code>nt!PsInitialSystemProcess</code> to a pointer to an <code>EPROCESS</code>:</p><pre><span id="30fb" data-selectable-paragraph=""><strong>dx @$systemProc = (nt!_EPROCESS*)nt!PsInitialSystemProcess</strong><br>Error: No type (or void) for object at Address 0xfffff8074ef843a0</span></pre><p id="b0fb" data-selectable-paragraph="">We get an error.</p><p id="9c87" data-selectable-paragraph="">Like we said, symbols have no type. And we can’t cast something with no type. So we need to take the address of the symbol, and cast it to a pointer to the type we want (In this case, <code>PsInitialSystemProcess</code> is already a pointer to an <code>EPROCESS</code> so we need to cast its address to a pointer to a pointer to an <code>EPROCESS</code>).</p><pre><span id="24a8" data-selectable-paragraph="">dx @$systemProc = *(nt!_EPROCESS**)&amp; nt!PsInitialSystemProcess</span></pre><p id="406f" data-selectable-paragraph="">Now that we have a typed variable, we can access its fields like we would do in C:</p><pre><span id="d613" data-selectable-paragraph="">0: kd&gt; <strong>dx @$systemProc-&gt;ImageFileName</strong></span><span id="55e3" data-selectable-paragraph="">@$systemProc-&gt;ImageFileName               [Type: unsigned char [15]]<br>[0]              : 0x53 [Type: unsigned char]<br>[1]              : 0x79 [Type: unsigned char]<br>[2]              : 0x73 [Type: unsigned char]<br>[3]              : 0x74 [Type: unsigned char]<br>[4]              : 0x65 [Type: unsigned char]<br>[5]              : 0x6d [Type: unsigned char]<br>[6]              : 0x0 [Type: unsigned char]</span></pre><p id="a96c" data-selectable-paragraph="">And we can cast that to get a nicer output:</p><pre><span id="6de2" data-selectable-paragraph=""><strong>dx (char*)@$systemProc-&gt;ImageFileName</strong></span><span id="7493" data-selectable-paragraph="">(char*)@$systemProc-&gt;ImageFileName                 : 0xffffc10c8e87e710 : "System" [Type: char *]</span></pre><p id="2f23" data-selectable-paragraph="">We can also use <code>ToDisplayString</code> to cast it from a <code>char*</code> to a string. We have two options — <code>ToDisplayString("s")</code>, which will cast it to a string and keep the quotes as part of the string, or <code>ToDisplayString("sb")</code>, which will remove them:</p><pre><span id="38d7" data-selectable-paragraph=""><strong>dx ((char*)@$systemProc-&gt;ImageFileName).ToDisplayString("s")</strong><br>((char*)@$systemProc-&gt;ImageFileName).ToDisplayString("s") : "System"<br>    Length           : 0x8</span><span id="89d3" data-selectable-paragraph=""><strong>dx ((char*)@$systemProc-&gt;ImageFileName).ToDisplayString("sb")</strong><br>((char*)@$systemProc-&gt;ImageFileName).ToDisplayString("sb") : System<br>    Length           : 0x6</span></pre><p id="90b9" data-selectable-paragraph="">This is fun, but for processes (and a few other things) there is an even easier way. Together with NatVis implementation in WinDbg we got some “free” registers already containing some useful information — <code>curframe</code>, <code>curprocess</code>, <code>cursession</code>, <code>curstack</code> and <code>curthread</code>. It’s not hard to guess their contents by the names, but let’s take a look:</p><p id="a1f7" data-selectable-paragraph="">Gives us information about the current frame. I never actually used it myself, but it might be useful:</p><pre><span id="1014" data-selectable-paragraph=""><strong>dx -r1 @$curframe.Attributes</strong></span><span id="dc2e" data-selectable-paragraph="">@$curframe.Attributes                <br>    InstructionOffset : 0xfffff8074ebda1e1<br>    ReturnOffset     : 0xfffff80752ad2b61<br>    FrameOffset      : 0xfffff80751968830<br>    StackOffset      : 0xfffff80751968838<br>    FuncTableEntry   : 0x0<br>    Virtual          : 1<br>    FrameNumber      : 0x0</span></pre><p id="edbc" data-selectable-paragraph="">A container with information about the current process. This is not an EPROCESS (though it does contain it). It contains easily-accessible information about the current process, like its threads, loaded modules, handles, etc.</p><pre><span id="57d6" data-selectable-paragraph=""><strong>dx @$curprocess</strong></span><span id="73de" data-selectable-paragraph="">@$curprocess                 : System [Switch To]<br>    KernelObject     [Type: _EPROCESS]<br>    Name             : System<br>    Id               : 0x4<br>    Handle           : 0xf0f0f0f0<br>    Threads         <br>    Modules         <br>    Environment     <br>    Devices         <br>    Io</span></pre><p id="8369" data-selectable-paragraph="">In <code>KernelObject</code> we have the <code>EPROCESS</code>, but we can also use the other fields. For example, we can access all the handles held by the process through <code>@$curprocess.Io.Handles</code>, which will lead us to an array of handles, indexed by their handle number:</p><pre><span id="f4a8" data-selectable-paragraph=""><strong>dx @$curprocess.Io.Handles</strong></span><span id="b980" data-selectable-paragraph="">@$curprocess.Io.Handles                <br>    [0x4]           <br>    [0x8]           <br>    [0xc]           <br>    [0x10]          <br>    [0x14]          <br>    [0x18]          <br>    [0x1c]          <br>    [0x20]          <br>    [0x24]          <br>    [0x28]<br>    ...</span></pre><p id="3d85" data-selectable-paragraph=""><code>System</code> has a lot of handles, these are just the first few! Let’s just take a look at the first one (which we can also access through <code>@$curprocess.Io.Handles[0x4]</code>):</p><pre><span id="17d2" data-selectable-paragraph=""><strong>dx @$curprocess.Io.Handles.First()</strong></span><span id="e37c" data-selectable-paragraph="">@$curprocess.Io.Handles.First()                <br>    Handle           : 0x4<br>    Type             : Process<br>    GrantedAccess    : Delete | ReadControl | WriteDac | WriteOwner | Synch | Terminate | CreateThread | VMOp | VMRead | VMWrite | DupHandle | CreateProcess | SetQuota | SetInfo | QueryInfo | SetPort<br>    Object           [Type: _OBJECT_HEADER]</span></pre><p id="c605" data-selectable-paragraph="">We can see the handle, the type of object the handle is for, its access and even have a pointer to the object itself!</p><p id="ac93" data-selectable-paragraph="">There are plenty more things to find under this register, and we encourage you to investigate them, but we will not show all of them.</p><p id="242d" data-selectable-paragraph="">By the way, have we mentioned already that <code>dx</code> allows tab completion?</p><p id="eabe" data-selectable-paragraph="">As its name suggests, this register gives us information about the current debugger session:</p><pre><span id="8773" data-selectable-paragraph=""><strong>dx @$cursession</strong></span><span id="dafc" data-selectable-paragraph="">@$cursession                 : Remote KD: KdSrv:Server=@{&lt;Local&gt;},Trans=@{NET:Port=55556,Key=1.2.3.4,Target=192.168.251.21}<br>    Processes       <br>    Id               : 0<br>    Devices         <br>    Attributes</span></pre><p id="fdba" data-selectable-paragraph="">So we can get information about our debugger session, which is always fun. But there are more useful things to be found here, such as the Processes field, which is an array of all running processes, indexed by their PID. Let’s pick one of them:</p><pre><span id="6e6d" data-selectable-paragraph=""><strong>dx @$cursession.Processes[0x1d8]</strong></span><span id="1ae6" data-selectable-paragraph="">@$cursession.Processes[0x1d8]                 : smss.exe [Switch To]<br>    KernelObject     [Type: _EPROCESS]<br>    Name             : smss.exe<br>    Id               : 0x1d8<br>    Handle           : 0xf0f0f0f0<br>    Threads         <br>    Modules         <br>    Environment     <br>    Devices         <br>    Io</span></pre><p id="301a" data-selectable-paragraph="">Now we can get all that useful information about every single process! We can also search for processes containing specific things, or filter processes based on a search (such as name, specific modules loaded into them, strings in their command line, etc. But we will explain all of that later.</p><p id="97a0" data-selectable-paragraph="">This register contains a single field — frames — which shows us the current stack in an easily-handled way:</p><pre><span id="dbd7" data-selectable-paragraph=""><strong>dx @$curstack.Frames</strong></span><span id="5707" data-selectable-paragraph="">@$curstack.Frames                <br>    [0x0]        : nt!DbgBreakPointWithStatus + 0x1 [Switch To]<br>    [0x1]        : kdnic!TXTransmitQueuedSends + 0x125 [Switch To]<br>    [0x2]        : kdnic!TXSendCompleteDpc + 0x14d [Switch To]<br>    [0x3]        : nt!KiProcessExpiredTimerList + 0x169 [Switch To]<br>    [0x4]        : nt!KiRetireDpcList + 0x4e9 [Switch To]<br>    [0x5]        : nt!KiIdleLoop + 0x7e [Switch To]</span></pre><p id="8161" data-selectable-paragraph="">Gives us information about the current thread, similar to <code>@$curprocess</code>:</p><pre><span id="60a5" data-selectable-paragraph=""><strong>dx @$curthread</strong></span><span id="5537" data-selectable-paragraph="">@$curthread                 : nt!DbgBreakPointWithStatus+0x1 (fffff807`4ebda1e1)  [Switch To]<br>    KernelObject     [Type: _ETHREAD]<br>    Id               : 0x0<br>    Stack           <br>    Registers       <br>    Environment</span></pre><p id="31db" data-selectable-paragraph="">It contains the <code>ETHREAD</code> in <code>KernelObject</code>, but also contains the <code>TEB</code> in <code>Environment</code>, and can show us the thread ID, stack and registers.</p><pre><span id="f48d" data-selectable-paragraph=""><strong>dx @$curthread.Registers</strong></span><span id="4a47" data-selectable-paragraph="">@$curthread.Registers                <br>    User            <br>    Kernel          <br>    SIMD            <br>    FloatingPoint</span></pre><p id="86c7" data-selectable-paragraph="">We have them conveniently separated to <code>user</code>, <code>kernel</code>, <code>SIMD</code> and <code>FloatingPoint</code> registers, and we can look at each separately:</p><pre><span id="2bfe" data-selectable-paragraph=""><strong>dx -r1 @$curthread.Registers.Kernel</strong></span><span id="4184" data-selectable-paragraph="">@$curthread.Registers.Kernel                <br>    cr0              : 0x3e00220074006e<br>    cr2              : 0x650074005f006d<br>    cr3              : 0x6c004100740078<br>    cr4              : 0x6d006e00670069<br>    cr8              : 0xa000d003e006d<br>    gdtr             : 0x3e006d00650074<br>    gdtl             : 0x49<br>    idtr             : 0x720074006e006f<br>    idtl             : 0x43<br>    tr               : 0x6f<br>    ldtr             : 0x6c<br>    kmxcsr           : 0x29002a<br>    kdr0             : 0x3c0074006e0065<br>    kdr1             : 0x6500740049002f<br>    kdr2             : 0xa000d003e006d<br>    kdr3             : 0x20002000200020<br>    kdr6             : 0xfffe0ff0<br>    kdr7             : 0x400<br>    xcr0             : 0xa000d000a000d</span></pre><p id="6b79" data-selectable-paragraph="">A very useful thing that NatVis allows us to do, which we briefly mentioned before, is searching, filtering and ordering information in an SQL-like way through <code>Select</code>, <code>Where</code>, <code>OrderBy</code> and more.</p><p id="837f" data-selectable-paragraph="">Foe example, let’s try to find all the processes that don’t enable high entropy ASLR. This infotmation is stored in the <code>EPROCESS-&gt;MitigationFlags</code> field, and the value for <code>HighEntropyASLREnabled</code> is 0x20 (all values can be found <a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/structs/eprocess/mitigationflags.htm" target="_blank" rel="noopener nofollow">here</a> and in the public symbols).</p><p id="db56" data-selectable-paragraph="">First we’ll declare a new register with that value, just to make things more readable:</p><pre><span id="3299" data-selectable-paragraph="">0: kd&gt; <strong>dx @$highEntropyAslr = 0x20</strong><br>@$highEntropyAslr = 0x20 : 32</span></pre><p id="51b7" data-selectable-paragraph="">And then create our query to iterate over all processes and only pick ones where the <code>HighEntropyASLREnabled</code> bit is not set:</p><pre><span id="98a0" data-selectable-paragraph=""><strong>dx -r1 @$cursession.Processes.Where(p =&gt; (p.KernelObject.MitigationFlags &amp; @$highEntropyAslr) == 0)</strong></span><span id="4058" data-selectable-paragraph="">@$cursession.Processes.Where(p =&gt; (p.KernelObject.MitigationFlags &amp; @$highEntropyAslr) == 0)                <br>    [0x910]          : spoolsv.exe [Switch To]<br>    [0xb40]          : IpOverUsbSvc.exe [Switch To]<br>    [0x1610]         : explorer.exe [Switch To]<br>    [0x1d8c]         : OneDrive.exe [Switch To]</span></pre><p id="ccc0" data-selectable-paragraph="">Or we can check the flag directly through <code>MitigationFlagsValues</code> and get the same results:</p><pre><span id="3cbf" data-selectable-paragraph=""><strong>dx -r1 @$cursession.Processes.Where(p =&gt; (p.KernelObject.MitigationFlagsValues.HighEntropyASLREnabled == 0))</strong></span><span id="2577" data-selectable-paragraph="">@$cursession.Processes.Where(p =&gt; (p.KernelObject.MitigationFlagsValues.HighEntropyASLREnabled == 0))                <br>    [0x910]          : spoolsv.exe [Switch To]<br>    [0xb40]          : IpOverUsbSvc.exe [Switch To]<br>    [0x1610]         : explorer.exe [Switch To]<br>    [0x1d8c]         : OneDrive.exe [Switch To]</span></pre><p id="824d" data-selectable-paragraph="">We can also use <code>Select()</code> to only show certain attributes of things we iterate over. Here we choose to see only the number of threads each process has:</p><pre><span id="ac50" data-selectable-paragraph=""><strong>dx @$cursession.Processes.Select(p =&gt; p.Threads.Count())</strong></span><span id="932f" data-selectable-paragraph="">@$cursession.Processes.Select(p =&gt; p.Threads.Count())                <br>    [0x0]            : 0x6<br>    [0x4]            : 0xeb<br>    [0x78]           : 0x4<br>    [0x1d8]          : 0x5<br>    [0x244]          : 0xe<br>    [0x294]          : 0x8<br>    [0x2a0]          : 0x10<br>    [0x2f8]          : 0x9<br>    [0x328]          : 0xa<br>    [0x33c]          : 0xd<br>    [0x3a8]          : 0x2c<br>    [0x3c0]          : 0x8<br>    [0x3c8]          : 0x8<br>    [0x204]          : 0x15<br>    [0x300]          : 0x1d<br>    [0x444]          : 0x3f<br>    ...</span></pre><p id="c0d0" data-selectable-paragraph="">We can also see everything in decimal by adding <code>, d</code> to the end of the command, to specify the output format (we can also use <code>b</code> for binary, <code>o</code> for octal or <code>s</code> for string):</p><pre><span id="ea29" data-selectable-paragraph=""><strong>dx @$cursession.Processes.Select(p =&gt; p.Threads.Count()), d</strong></span><span id="4225" data-selectable-paragraph="">@$cursession.Processes.Select(p =&gt; p.Threads.Count()), d                <br>    [0]              : 6<br>    [4]              : 235<br>    [120]            : 4<br>    [472]            : 5<br>    [580]            : 14<br>    [660]            : 8<br>    [672]            : 16<br>    [760]            : 9<br>    [808]            : 10<br>    [828]            : 13<br>    [936]            : 44<br>    [960]            : 8<br>    [968]            : 8<br>    [516]            : 21<br>    [768]            : 29<br>    [1092]           : 63<br>    ...</span></pre><p id="cad2" data-selectable-paragraph="">Or, in a slightly more complicated example, see the ideal processor for each thread running in a certain process (I chose a process at random, just to see something that is not the System process):</p><pre><span id="3b05" data-selectable-paragraph=""><strong>dx -r1 @$cursession.Processes[0x1b2c].Threads.Select(t =&gt; t.Environment.EnvironmentBlock.CurrentIdealProcessor.Number)</strong></span><span id="17ee" data-selectable-paragraph="">@$cursession.Processes[0x1b2c].Threads.Select(t =&gt; t.Environment.EnvironmentBlock.CurrentIdealProcessor.Number)                <br>    [0x1b30]         : 0x1 [Type: unsigned char]<br>    [0x1b40]         : 0x2 [Type: unsigned char]<br>    [0x1b4c]         : 0x3 [Type: unsigned char]<br>    [0x1b50]         : 0x4 [Type: unsigned char]<br>    [0x1b48]         : 0x5 [Type: unsigned char]<br>    [0x1b5c]         : 0x0 [Type: unsigned char]<br>    [0x1b64]         : 0x1 [Type: unsigned char]</span></pre><p id="5e81" data-selectable-paragraph="">We can also use <code>OrderBy</code> to get nicer results, for example to get a list of all processes sorted by alphabetical order:</p><pre><span id="13b4" data-selectable-paragraph=""><strong>dx -r1 @$cursession.Processes.OrderBy(p =&gt; p.Name)</strong></span><span id="4bb2" data-selectable-paragraph="">@$cursession.Processes.OrderBy(p =&gt; p.Name)                <br>    [0x1848]         : ApplicationFrameHost.exe [Switch To]<br>    [0x0]            : Idle [Switch To]<br>    [0xb40]          : IpOverUsbSvc.exe [Switch To]<br>    [0x106c]         : LogonUI.exe [Switch To]<br>    [0x754]          : MemCompression [Switch To]<br>    [0x187c]         : MicrosoftEdge.exe [Switch To]<br>    [0x1b94]         : MicrosoftEdgeCP.exe [Switch To]<br>    [0x1b7c]         : MicrosoftEdgeSH.exe [Switch To]<br>    [0xb98]          : MsMpEng.exe [Switch To]<br>    [0x1158]         : NisSrv.exe [Switch To]<br>    [0x1d8c]         : OneDrive.exe [Switch To]<br>    [0x78]           : Registry [Switch To]<br>    [0x1ed0]         : RuntimeBroker.exe [Switch To]<br>    ...</span></pre><p id="4e4e" data-selectable-paragraph="">If we want them in a descending order we can use <code>OrderByDescending</code>.</p><p id="0386" data-selectable-paragraph="">But what if we want to pick more than one attribute to see? There is a solution for that too.</p><p id="dbb4" data-selectable-paragraph="">We can declare a type of our own, that will be unnamed and only used in the scope of our query, using this syntax: <code>Select(x =&gt; new { var1 = x.A, var2 = x.B, ...})</code>.</p><p id="cad8" data-selectable-paragraph="">We’ll try it out on one of our previous examples. Let’s say for each process we want to show a process name and its thread count:</p><pre><span id="a879" data-selectable-paragraph=""><strong>dx @$cursession.Processes.Select(p =&gt; new {Name = p.Name, ThreadCount = p.Threads.Count()})</strong></span><span id="7290" data-selectable-paragraph="">@$cursession.Processes.Select(p =&gt; new {Name = p.Name, ThreadCount = p.Threads.Count()})                <br>    [0x0]           <br>    [0x4]           <br>    [0x78]          <br>    [0x1d8]         <br>    [0x244]         <br>    [0x294]         <br>    [0x2a0]         <br>    [0x2f8]         <br>    [0x328]<br>    ...</span></pre><p id="0b3a" data-selectable-paragraph="">But now we only see the process container, not the actual information. To see the information itself we need to go one layer deeper, by using <code>-r2</code>. The number specifies the output recursion level. The default is <code>-r1</code>, <code>-r0</code> will show no output, <code>-r2</code> will show two levels, etc.</p><pre><span id="0b7f" data-selectable-paragraph=""><strong>dx -r2 @$cursession.Processes.Select(p =&gt; new {Name = p.Name, ThreadCount = p.Threads.Count()})</strong></span><span id="8a4f" data-selectable-paragraph="">@$cursession.Processes.Select(p =&gt; new {Name = p.Name, ThreadCount = p.Threads.Count()})                <br>    [0x0]           <br>        Name             : Idle<br>        ThreadCount      : 0x6<br>    [0x4]           <br>        Name             : System<br>        ThreadCount      : 0xeb<br>    [0x78]          <br>        Name             : Registry<br>        ThreadCount      : 0x4<br>    [0x1d8]         <br>        Name             : smss.exe<br>        ThreadCount      : 0x5<br>    [0x244]         <br>        Name             : csrss.exe<br>        ThreadCount      : 0xe<br>    [0x294]         <br>        Name             : wininit.exe<br>        ThreadCount      : 0x8<br>    [0x2a0]         <br>        Name             : csrss.exe<br>        ThreadCount      : 0x10<br>    ...</span></pre><p id="9271" data-selectable-paragraph="">This already looks much better, but we can make it look even nicer with the new graphic module, accessed through the <code>-g</code> flag:</p><pre><span id="05b9" data-selectable-paragraph="">dx -g @$cursession.Processes.Select(p =&gt; new {Name = p.Name, ThreadCount = p.Threads.Count()})</span></pre><figure><div><div><div><div><p><img src="https://miro.medium.com/max/48/1*0mgf4Nze9URfZOpa198EpQ.png?q=20" width="973" height="1210" role="presentation"></p><p><img width="973" height="1210" srcset="https://miro.medium.com/max/552/1*0mgf4Nze9URfZOpa198EpQ.png 276w, https://miro.medium.com/max/1104/1*0mgf4Nze9URfZOpa198EpQ.png 552w, https://miro.medium.com/max/1280/1*0mgf4Nze9URfZOpa198EpQ.png 640w, https://miro.medium.com/max/1400/1*0mgf4Nze9URfZOpa198EpQ.png 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">Output of dx -g @$cursession.Processes.Select(p =&gt; new {Name = p.Name, ThreadCount = p.Threads.Count()})</figcaption></figure><p id="9a5c" data-selectable-paragraph="">Ok, this just looks awesome. And yes, these headings are clickable and will sort the table!</p><p id="b126" data-selectable-paragraph="">And if we want to see the PIDs and thread numbers in decimal we can just add <code>, d</code> to the end of the command:</p><pre><span id="bd51" data-selectable-paragraph="">dx -g @$cursession.Processes.Select(p =&gt; new {Name = p.Name, ThreadCount = p.Threads.Count()}),d</span></pre><p id="fb94" data-selectable-paragraph=""><code>DX</code> also gives us a new, much easier way, to handle arrays and lists with new syntax.<br> Let’s look at arrays first, where the syntax is <code>dx *(TYPE(*)[Size])&lt;pointer to array start&gt;</code>.</p><p id="3b91" data-selectable-paragraph="">For this example we will dump the contents on <code>PsInvertedFunctionTable</code>, which contains an array of up to 256 cached modules in its <code>TableEntry</code> field.</p><p id="b4a7" data-selectable-paragraph="">First we will get the pointer of this symbol and cast it to <code>_INVERTED_FUNCTION_TABLE</code>:</p><pre><span id="c352" data-selectable-paragraph=""><strong>dx @$inverted = (nt!_INVERTED_FUNCTION_TABLE*)&amp;nt!PsInvertedFunctionTable</strong></span><span id="9e57" data-selectable-paragraph="">@$inverted = (nt!_INVERTED_FUNCTION_TABLE*)&amp;nt!PsInvertedFunctionTable                 : 0xfffff8074ef9b010 [Type: _INVERTED_FUNCTION_TABLE *]<br>    [+0x000] CurrentSize      : 0xbe [Type: unsigned long]<br>    [+0x004] MaximumSize      : 0x100 [Type: unsigned long]<br>    [+0x008] Epoch            : 0x19e [Type: unsigned long]<br>    [+0x00c] Overflow         : 0x0 [Type: unsigned char]<br>    [+0x010] TableEntry       [Type: _INVERTED_FUNCTION_TABLE_ENTRY [256]]</span></pre><p id="fe39" data-selectable-paragraph="">Now we can create our array. Unfortunately, the size of the array has to be static and can’t use a register, so we need to input it manually, based on <code>CurrentSize</code> (or just set it to 256, which is the size of the whole array). And we can use the graphic module to print it nicely:</p><pre><span id="a810" data-selectable-paragraph="">dx -g @$tableEntry = *(nt!_INVERTED_FUNCTION_TABLE_ENTRY(*)[0xbe])@$inverted-&gt;TableEntry</span></pre><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*ciV6cZ6qaVAsSFBCTf3Arw.png?q=20" width="1750" height="1081" role="presentation"></p><p><img width="1750" height="1081" srcset="https://miro.medium.com/max/552/1*ciV6cZ6qaVAsSFBCTf3Arw.png 276w, https://miro.medium.com/max/1104/1*ciV6cZ6qaVAsSFBCTf3Arw.png 552w, https://miro.medium.com/max/1280/1*ciV6cZ6qaVAsSFBCTf3Arw.png 640w, https://miro.medium.com/max/1400/1*ciV6cZ6qaVAsSFBCTf3Arw.png 700w" sizes="700px" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">Output of dx -g @$tableEntry = *(nt!_INVERTED_FUNCTION_TABLE_ENTRY(*)[0xbe])@$inverted-&gt;TableEntry</figcaption></figure><p id="6740" data-selectable-paragraph="">Alternatively, we can use the <code>Take()</code> method, which receives a number and prints that amount of elements from a collection, and get the same result:</p><pre><span id="cc31" data-selectable-paragraph="">dx -g @$inverted-&gt;TableEntry-&gt;Take(@$inverted-&gt;CurrentSize)</span></pre><p id="987b" data-selectable-paragraph="">We can also do the same thing to see the <code>UserInvertedFunctionTable</code> (right after we switch to user that’s not System), starting from <code>nt!KeUserInvertedFunctionTable</code>:</p><pre><span id="c29d" data-selectable-paragraph=""><strong>dx @$inverted = *(nt!_INVERTED_FUNCTION_TABLE**)&amp;nt!KeUserInvertedFunctionTable</strong></span><span id="5591" data-selectable-paragraph="">@$inverted = *(nt!_INVERTED_FUNCTION_TABLE**)&amp;nt!KeUserInvertedFunctionTable                 : 0x7ffa19e3a4d0 [Type: _INVERTED_FUNCTION_TABLE *]<br>    [+0x000] CurrentSize      : 0x2 [Type: unsigned long]<br>    [+0x004] MaximumSize      : 0x200 [Type: unsigned long]<br>    [+0x008] Epoch            : 0x6 [Type: unsigned long]<br>    [+0x00c] Overflow         : 0x0 [Type: unsigned char]<br>    [+0x010] TableEntry       [Type: _INVERTED_FUNCTION_TABLE_ENTRY [256]]</span><span id="dc78" data-selectable-paragraph="">dx -g @$inverted-&gt;TableEntry-&gt;Take(@$inverted-&gt;CurrentSize)</span></pre><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*-fqwAwoYsGM4wjB3Pp-WNQ.png?q=20" width="1516" height="197" role="presentation"></p><p><img width="1516" height="197" srcset="https://miro.medium.com/max/552/1*-fqwAwoYsGM4wjB3Pp-WNQ.png 276w, https://miro.medium.com/max/1104/1*-fqwAwoYsGM4wjB3Pp-WNQ.png 552w, https://miro.medium.com/max/1280/1*-fqwAwoYsGM4wjB3Pp-WNQ.png 640w, https://miro.medium.com/max/1400/1*-fqwAwoYsGM4wjB3Pp-WNQ.png 700w" sizes="700px" role="presentation"></p></div></div></div></div></figure><p id="5a1a" data-selectable-paragraph="">And of course we can use <code>Select()</code> , <code>Where()</code> or other functions to filter, sort or select only specific fields for our output and get tailored results that fit exactly what we need.</p><p id="aec3" data-selectable-paragraph="">The next thing to handle is lists — Windows is full of linked lists, you can find them everywhere. Linking processes, threads, modules, DPCs, IRPs…</p><p id="4aeb" data-selectable-paragraph="">Fortunately the new data model has a very useful Debugger method - <code>Debugger.Utiilty.Collections.FromListEntry</code>, which takes in a linked list start point, type and name of the field in this type containing the <code>LIST_ENTRY</code> structure, and will return a container of all the list contents.</p><p id="660e" data-selectable-paragraph="">So for our example let’s dump all the handle tables in the system. Our starting point will be the symbol <code>nt!HandleTableListHead</code>, the type of the objects in the list is <code>nt!_HANDLE_TABLE</code> and the field linking the list is <code>HandleTableList</code>:</p><pre><span id="7738" data-selectable-paragraph=""><strong>dx -r2 Debugger.Utility.Collections.FromListEntry(*(nt!_LIST_ENTRY*)&amp;nt!HandleTableListHead, "nt!_HANDLE_TABLE", "HandleTableList")</strong></span><span id="af09" data-selectable-paragraph="">Debugger.Utility.Collections.FromListEntry(*(nt!_LIST_ENTRY*)&amp;nt!HandleTableListHead, "nt!_HANDLE_TABLE", "HandleTableList")                <br>    [0x0]            [Type: _HANDLE_TABLE]<br>        [+0x000] NextHandleNeedingPool : 0x3400 [Type: unsigned long]<br>        [+0x004] ExtraInfoPages   : 0 [Type: long]<br>        [+0x008] TableCode        : 0xffff8d8dcfd18001 [Type: unsigned __int64]<br>        [+0x010] QuotaProcess     : 0x0 [Type: _EPROCESS *]<br>        [+0x018] HandleTableList  [Type: _LIST_ENTRY]<br>        [+0x028] UniqueProcessId  : 0x4 [Type: unsigned long]<br>        [+0x02c] Flags            : 0x0 [Type: unsigned long]<br>        [+0x02c ( 0: 0)] StrictFIFO       : 0x0 [Type: unsigned char]<br>        [+0x02c ( 1: 1)] EnableHandleExceptions : 0x0 [Type: unsigned char]<br>        [+0x02c ( 2: 2)] Rundown          : 0x0 [Type: unsigned char]<br>        [+0x02c ( 3: 3)] Duplicated       : 0x0 [Type: unsigned char]<br>        [+0x02c ( 4: 4)] RaiseUMExceptionOnInvalidHandleClose : 0x0 [Type: unsigned char]<br>        [+0x030] HandleContentionEvent [Type: _EX_PUSH_LOCK]<br>        [+0x038] HandleTableLock  [Type: _EX_PUSH_LOCK]<br>        [+0x040] FreeLists        [Type: _HANDLE_TABLE_FREE_LIST [1]]<br>        [+0x040] ActualEntry      [Type: unsigned char [32]]<br>        [+0x060] DebugInfo        : 0x0 [Type: _HANDLE_TRACE_DEBUG_INFO *]<br>    [0x1]            [Type: _HANDLE_TABLE]<br>        [+0x000] NextHandleNeedingPool : 0x400 [Type: unsigned long]<br>        [+0x004] ExtraInfoPages   : 0 [Type: long]<br>        [+0x008] TableCode        : 0xffff8d8dcb651000 [Type: unsigned __int64]<br>        [+0x010] QuotaProcess     : 0xffffb90a530e4080 [Type: _EPROCESS *]<br>        [+0x018] HandleTableList  [Type: _LIST_ENTRY]<br>        [+0x028] UniqueProcessId  : 0x78 [Type: unsigned long]<br>        [+0x02c] Flags            : 0x10 [Type: unsigned long]<br>        [+0x02c ( 0: 0)] StrictFIFO       : 0x0 [Type: unsigned char]<br>        [+0x02c ( 1: 1)] EnableHandleExceptions : 0x0 [Type: unsigned char]<br>        [+0x02c ( 2: 2)] Rundown          : 0x0 [Type: unsigned char]<br>        [+0x02c ( 3: 3)] Duplicated       : 0x0 [Type: unsigned char]<br>        [+0x02c ( 4: 4)] RaiseUMExceptionOnInvalidHandleClose : 0x1 [Type: unsigned char]<br>        [+0x030] HandleContentionEvent [Type: _EX_PUSH_LOCK]<br>        [+0x038] HandleTableLock  [Type: _EX_PUSH_LOCK]<br>        [+0x040] FreeLists        [Type: _HANDLE_TABLE_FREE_LIST [1]]<br>        [+0x040] ActualEntry      [Type: unsigned char [32]]<br>        [+0x060] DebugInfo        : 0x0 [Type: _HANDLE_TRACE_DEBUG_INFO *]<br>    ...</span></pre><p id="84b9" data-selectable-paragraph="">See the <code>QuotaProcess</code> field? That field points to the process that this handle table belongs to. Since every process has a handle table, this allows us to enumerate all the processes on the system in a way that’s not widely known. This method has been used by rootkits in the past to enumerate processes without being detected by EDR products. So to implement this we just need to <code>Select()</code> the <code>QuotaProcess</code> from each entry in our handle table list. To create a nicer looking output we can also create an anonymous container with the process name, PID and <code>EPROCESS</code> pointer:</p><pre><span id="0cf8" data-selectable-paragraph=""><strong>dx -r2 (Debugger.Utility.Collections.FromListEntry(*(nt!_LIST_ENTRY*)&amp;nt!HandleTableListHead, "nt!_HANDLE_TABLE", "HandleTableList")).Select(h =&gt; new { Object = h.QuotaProcess, Name = (char*)h.QuotaProcess-&gt;ImageFileName, PID = (__int64)h.QuotaProcess-&gt;UniqueProcessId})</strong></span><span id="9b58" data-selectable-paragraph="">(Debugger.Utility.Collections.FromListEntry(*(nt!_LIST_ENTRY*)&amp;nt!HandleTableListHead, "nt!_HANDLE_TABLE", "HandleTableList")).Select(h =&gt; new { Object = h.QuotaProcess, Name = (char*)h.QuotaProcess-&gt;ImageFileName, PID = (__int64)h.QuotaProcess-&gt;UniqueProcessId})                <br>    [0x0]          : Unable to read memory at Address 0x2e8<br>    [0x1]           <br>        Object     : 0xffffb90a530e4080 [Type: _EPROCESS *]<br>        Name       : 0xffffb90a530e44d0 : "Registry" [Type: char *]<br>        PID        : 120 [Type: __int64]<br>    [0x2]           <br>        Object     : 0xffffb90a574c9400 [Type: _EPROCESS *]<br>        Name       : 0xffffb90a574c9850 : "smss.exe" [Type: char *]<br>        PID        : 472 [Type: __int64]<br>    [0x3]           <br>        Object     : 0xffffb90a573a7240 [Type: _EPROCESS *]<br>        Name       : 0xffffb90a573a7690 : "csrss.exe" [Type: char *]<br>        PID              : 580 [Type: __int64]<br>    [0x4]           <br>        Object     : 0xffffb90a587a8080 [Type: _EPROCESS *]<br>        Name       : 0xffffb90a587a84d0 : "wininit.exe" [Type: char *]<br>        PID        : 660 [Type: __int64]<br>    [0x5]           <br>        Object     : 0xffffb90a587bb080 [Type: _EPROCESS *]<br>        Name       : 0xffffb90a587bb4d0 : "csrss.exe" [Type: char *]<br>        PID        : 672 [Type: __int64]<br>    [0x6]           <br>        Object     : 0xffffb90a59407080 [Type: _EPROCESS *]<br>        Name       : 0xffffb90a594074d0 : "winlogon.exe" [Type: char *]<br>        PID        : 760 [Type: __int64]<br>    ...</span></pre><p id="3474" data-selectable-paragraph="">The first result is the table belonging to the System process and it does not have a <code>QuotaProcess</code>, which is the reason this query returns an error for it. But it should work perfectly for every other entry in the array. If we want to make our output prettier, we can filter out entries where <code>QuotaProcess == 0</code> before we do the <code>Select()</code>:</p><pre><span id="4296" data-selectable-paragraph="">dx -r2 (Debugger.Utility.Collections.FromListEntry(*(nt!_LIST_ENTRY*)&amp;nt!HandleTableListHead, “nt!_HANDLE_TABLE”, “HandleTableList”)).Where(h =&gt; h.QuotaProcess != 0).Select(h =&gt; new { Object = h.QuotaProcess, Name = (char*)h.QuotaProcess-&gt;ImageFileName, PID = h.QuotaProcess-&gt;UniqueProcessId})</span></pre><p id="a4b9" data-selectable-paragraph="">As we already showed before, we can also print this list in a graphic view or use any LINQ queries to make the output match our needs.</p><p id="f630" data-selectable-paragraph="">This is the end of our first part, but don’t worry, the second part is right <a target="_blank" rel="noopener" href="https://medium.com/@yardenshafir2/windbg-the-fun-way-part-2-7a904cba5435">here</a>, and it contains all the fancy new <code>dx</code> methods such as a new disassembler, defining our own methods, conditional breakpoints that actually work, and more.</p></div></div></section></div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>