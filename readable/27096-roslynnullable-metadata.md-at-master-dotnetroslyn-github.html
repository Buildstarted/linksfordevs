<!DOCTYPE html>
<html lang="en">
<head>
    <title>
roslyn/nullable-metadata.md at master &#xB7; dotnet/roslyn &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>roslyn/nullable-metadata.md at master · dotnet/roslyn · GitHub</h1><div><div id="" class="markdown-body entry-content p-3 p-md-6"><p>The following describes the representation of nullable annotations in metadata.</p><h2><a id="user-content-nullableattribute" class="anchor" aria-hidden="true" href="#nullableattribute"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NullableAttribute</h2><p>Type references are annotated in metadata with a <code>NullableAttribute</code>.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">namespace</span><span class="pl-en">System</span>.<span class="pl-en">Runtime</span>.<span class="pl-en">CompilerServices</span>
{
    [<span class="pl-en">AttributeUsage</span>(
        <span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Class</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Event</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Field</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">GenericParameter</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Parameter</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Property</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">ReturnValue</span>,
        <span class="pl-en">AllowMultiple</span><span class="pl-k">=</span><span class="pl-c1">false</span>,
        <span class="pl-en">Inherited</span><span class="pl-k">=</span><span class="pl-c1">false</span>)]
    <span class="pl-k">public</span><span class="pl-k">sealed</span><span class="pl-k">class</span><span class="pl-en">NullableAttribute</span> : <span class="pl-en">Attribute</span>
    {
        <span class="pl-k">public</span><span class="pl-k">readonly</span><span class="pl-k">byte</span>[] <span class="pl-smi">NullableFlags</span>;
        <span class="pl-k">public</span><span class="pl-en">NullableAttribute</span>(<span class="pl-k">byte</span><span class="pl-smi">flag</span>)
        {
            <span class="pl-smi">NullableFlags</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">byte</span>[] { <span class="pl-smi">flag</span> };
        }
        <span class="pl-k">public</span><span class="pl-en">NullableAttribute</span>(<span class="pl-k">byte</span>[] <span class="pl-smi">flags</span>)
        {
            <span class="pl-smi">NullableFlags</span><span class="pl-k">=</span><span class="pl-smi">flags</span>;
        }
    }
}</pre></div><p>The <code>NullableAttribute</code> type is for compiler use only - it is not permitted in source.
The type declaration is synthesized by the compiler if not already included in the compilation.</p><p>Each type reference in metadata may have an associated <code>NullableAttribute</code> with a <code>byte[]</code> where each <code>byte</code>
represents nullability: 0 for oblivious, 1 for not annotated, and 2 for annotated.</p><p>The <code>byte[]</code> is constructed as follows:</p><ul><li>Reference type: the nullability (0, 1, or 2), followed by the representation of the type arguments in order including containing types</li><li>Nullable value type: the representation of the type argument only</li><li>Non-generic value type: skipped</li><li>Generic value type: 0, followed by the representation of the type arguments in order including containing types</li><li>Array: the nullability (0, 1, or 2), followed by the representation of the element type</li><li>Tuple: the representation of the underlying constructed type</li><li>Type parameter reference: the nullability (0, 1, or 2, with 0 for unconstrained type parameter)</li></ul><p>Note that non-generic value types are represented by an empty <code>byte[]</code>.
However, generic value types and type parameters constrained to value types have an explicit 0 in the <code>byte[]</code> for nullability.
The reason generic types and type parameters are represented with an explicit <code>byte</code> is to simplify metadata import.
Specifically, this avoids the need to calculate whether a type parameter is constrained to a value type when
decoding nullability metadata, since the constraints may include a (valid) cyclic reference to the type parameter.</p><h3><a id="user-content-optimizations" class="anchor" aria-hidden="true" href="#optimizations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Optimizations</h3><p>If the <code>byte[]</code> is empty, the <code>NullableAttribute</code> is omitted.</p><p>If all values in the <code>byte[]</code> are the same, the <code>NullableAttribute</code> is constructed with that single <code>byte</code> value. (For instance, <code>NullableAttribute(1)</code> rather than <code>NullableAttribute(new byte[] { 1, 1 }))</code>.)</p><h3><a id="user-content-type-parameters" class="anchor" aria-hidden="true" href="#type-parameters"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Type parameters</h3><p>Each type parameter definition may have an associated <code>NullableAttribute</code> with a single <code>byte</code>:</p><ol><li><code>notnull</code> constraint: <code>NullableAttribute(1)</code></li><li><code>class</code> constraint in <code>#nullable disable</code> context: <code>NullableAttribute(0)</code></li><li><code>class</code> constraint in <code>#nullable enable</code> context: <code>NullableAttribute(1)</code></li><li><code>class?</code> constraint: <code>NullableAttribute(2)</code></li><li>No <code>notnull</code>, <code>class</code>, <code>struct</code>, <code>unmanaged</code>, or type constraints in <code>#nullable disable</code> context: <code>NullableAttribute(0)</code></li><li>No <code>notnull</code>, <code>class</code>, <code>struct</code>, <code>unmanaged</code>, or type constraints in <code>#nullable enable</code> context
(equivalent to an <code>object?</code> constraint): <code>NullableAttribute(2)</code></li></ol><h2><a id="user-content-nullablecontextattribute" class="anchor" aria-hidden="true" href="#nullablecontextattribute"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NullableContextAttribute</h2><p><code>NullableContextAttribute</code> can be used to indicate the nullability of type references that have no <code>NullableAttribute</code> annotations.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">namespace</span><span class="pl-en">System</span>.<span class="pl-en">Runtime</span>.<span class="pl-en">CompilerServices</span>
{
    [<span class="pl-k">System</span>.<span class="pl-en">AttributeUsage</span>(
        <span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Class</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Delegate</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Interface</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Method</span><span class="pl-k">|</span><span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Struct</span>,
        <span class="pl-en">AllowMultiple</span><span class="pl-k">=</span><span class="pl-c1">false</span>,
        <span class="pl-en">Inherited</span><span class="pl-k">=</span><span class="pl-c1">false</span>)]
    <span class="pl-k">public</span><span class="pl-k">sealed</span><span class="pl-k">class</span><span class="pl-en">NullableContextAttribute</span> : <span class="pl-en">Attribute</span>
    {
        <span class="pl-k">public</span><span class="pl-k">readonly</span><span class="pl-k">byte</span><span class="pl-smi">Flag</span>;
        <span class="pl-k">public</span><span class="pl-en">NullableContextAttribute</span>(<span class="pl-k">byte</span><span class="pl-smi">flag</span>)
        {
            <span class="pl-smi">Flag</span><span class="pl-k">=</span><span class="pl-smi">flag</span>;
        }
    }
}</pre></div><p>The <code>NullableContextAttribute</code> type is for compiler use only - it is not permitted in source.
The type declaration is synthesized by the compiler if not already included in the compilation.</p><p>The <code>NullableContextAttribute</code> is optional - nullable annotations can be represented in metadata with full fidelity using <code>NullableAttribute</code> only.</p><p><code>NullableContextAttribute</code> is valid in metadata on type and method declarations.
The <code>byte</code> value represents the implicit <code>NullableAttribute</code> value for type references within that scope
that do not have an explicit <code>NullableAttribute</code> and would not otherwise be represented by an empty <code>byte[]</code>.
The nearest <code>NullableContextAttribute</code> in the metadata hierarchy applies.
If there are no <code>NullableContextAttribute</code> attributes in the hierarchy,
missing <code>NullableAttribute</code> attributes are treated as <code>NullableAttribute(0)</code>.</p><p>The attribute is not inherited.</p><p>The C#8 compiler uses the following algorithm to determine which <code>NullableAttribute</code> and
<code>NullableContextAttribute</code> attributes to emit.
First, <code>NullableAttribute</code> attributes are generated at each type reference and type parameter definition by:
calculating the <code>byte[]</code>, skipping empty <code>byte[]</code>, and collapsing <code>byte[]</code> to single <code>byte</code> where possible.
Then at each level in metadata hierarchy starting at methods:
The compiler finds the most common single <code>byte</code> value across all the <code>NullableAttribute</code> attributes at that level
and any <code>NullableContextAttribute</code> attributes on immediate children.
If there are no single <code>byte</code> values, there are no changes.
Otherwise, a <code>NullableContext(value)</code> attribute is created at that level where <code>value</code> is most common
value (preferring <code>0</code> over <code>1</code> and preferring <code>1</code> over <code>2</code>), and all <code>NullableAttribute</code> and <code>NullableContextAttribute</code> attributes with that value are removed.</p><p>Note that an assembly compiled with C#8 where all reference types are oblivious will have no
<code>NullableContextAttribute</code> and no <code>NullableAttribute</code> attributes emitted.
That is equivalent to a legacy assembly.</p><h3><a id="user-content-examples" class="anchor" aria-hidden="true" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Examples</h3><div class="highlight highlight-source-cs"><pre><span class="pl-c"><span class="pl-c">//</span> C# representation of metadata</span>
[<span class="pl-en">NullableContext</span>(<span class="pl-c1">2</span>)]
<span class="pl-k">class</span><span class="pl-en">Program</span>
{
    <span class="pl-k">string</span><span class="pl-smi">s</span>;                        <span class="pl-c"><span class="pl-c">//</span> string?</span>
    [<span class="pl-en">Nullable</span>({ <span class="pl-c1">2</span>, <span class="pl-c1">1</span>, <span class="pl-c1">2</span> }] <span class="pl-smi">Dictionary</span><span class="pl-k">&lt;</span><span class="pl-smi">string</span>, <span class="pl-smi">object</span><span class="pl-k">&gt;</span><span class="pl-smi">d</span>; <span class="pl-c"><span class="pl-c">//</span> Dictionary&lt;string!, object?&gt;?</span>
    [<span class="pl-en">Nullable</span>(<span class="pl-c1">1</span>)] <span class="pl-smi">int</span>[] <span class="pl-smi">a</span>;           <span class="pl-c"><span class="pl-c">//</span> int[]!</span><span class="pl-smi">int</span>[] <span class="pl-smi">b</span>;                         <span class="pl-c"><span class="pl-c">//</span> int[]?</span>
    [<span class="pl-en">Nullable</span>({ <span class="pl-c1">0</span>, <span class="pl-c1">2</span> })] <span class="pl-smi">object</span>[] <span class="pl-smi">c</span>; <span class="pl-c"><span class="pl-c">//</span> object?[]~</span>
}</pre></div><h2><a id="user-content-private-members" class="anchor" aria-hidden="true" href="#private-members"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Private members</h2><p>To reduce the size of metadata, the C#8 compiler can be configured to not emit attributes
for members that are inaccessible outside the assembly (<code>private</code> members, and also <code>internal</code> members
if the assembly does not contain <code>InternalsVisibleToAttribute</code> attributes).</p><p>The compiler behavior is configured from a command-line flag.
For now a feature flag is used: <code>-features:nullablePublicOnly</code>.</p><p>If private member attributes are dropped, the compiler will emit a <code>[module: NullablePublicOnly]</code> attribute.
The presence or absence of the <code>NullablePublicOnlyAttribute</code> can be used by tools to interpret
the nullability of private members that do not have an associated <code>NullableAttribute</code> attribute.</p><p>For members that do not have explicit accessibility in metadata
(specifically for parameters, type parameters, events, and properties),
the compiler uses the accessibility of the container to determine whether to emit nullable attributes.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">namespace</span><span class="pl-en">System</span>.<span class="pl-en">Runtime</span>.<span class="pl-en">CompilerServices</span>
{
    [<span class="pl-k">System</span>.<span class="pl-en">AttributeUsage</span>(<span class="pl-smi">AttributeTargets</span>.<span class="pl-smi">Module</span>, <span class="pl-en">AllowMultiple</span><span class="pl-k">=</span><span class="pl-c1">false</span>)]
    <span class="pl-k">public</span><span class="pl-k">sealed</span><span class="pl-k">class</span><span class="pl-en">NullablePublicOnlyAttribute</span> : <span class="pl-en">Attribute</span>
    {
        <span class="pl-k">public</span><span class="pl-k">readonly</span><span class="pl-k">bool</span><span class="pl-smi">IncludesInternals</span>;
        <span class="pl-k">public</span><span class="pl-en">NullablePublicOnlyAttribute</span>(<span class="pl-k">bool</span><span class="pl-smi">includesInternals</span>)
        {
            <span class="pl-smi">IncludesInternals</span><span class="pl-k">=</span><span class="pl-smi">includesInternals</span>;
        }
    }
}</pre></div><p>The <code>NullablePublicOnlyAttribute</code> type is for compiler use only - it is not permitted in source.
The type declaration is synthesized by the compiler if not already included in the compilation.</p><p><code>IncludesInternal</code> is true if <code>internal</code> members are annotated in addition to <code>public</code> and <code>protected</code> members.</p><h2><a id="user-content-compatibility" class="anchor" aria-hidden="true" href="#compatibility"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compatibility</h2><p>The nullable metadata does not include an explicit version number.
Where possible, the compiler will silently ignore attribute forms that are unexpected.</p><p>The metadata format described here is incompatible with the format used by earlier C#8 previews:</p><ol><li>Concrete non-generic value types are no longer included in the <code>byte[]</code>, and</li><li><code>NullableContextAttribute</code> attributes are used in place of explicit <code>NullableAttribute</code> attributes.</li></ol><p>Those differences mean that assemblies compiled with earlier previews may be read incorrectly by later previews,
and assemblies compiled with later previews may be read incorrectly by earlier previews.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>