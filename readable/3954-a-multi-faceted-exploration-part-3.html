<!DOCTYPE html>
<html lang="en">
<head>
    <title>
A Multi-Faceted Exploration (Part 3) -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>A Multi-Faceted Exploration (Part 3)</h1><div><div class="entry-content"><p><img class="center" src="/images/multi-faceted/title-3.jpg"></p><h2 id="a-new-dimension">A New Dimension</h2><p>In the <a href="https://blog.selfshadow.com/2018/06/04/multi-faceted-part-2/">last post</a>, I’d shown how a small tweak to Imageworks’ multiple-scattering Fresnel term, $\color{brown}{F_\mathrm{ms}}$, brought their approximation closer to the reference solution of Heitz et al. However, there was still a niggling difference at high roughness, most noticeable under uniform lighting:</p><p><img class="center" src="/images/multi-faceted/conductors/spi_fixed_vs_heitz_wf.png"></p><p><em>Figure 1: Furnace test, with roughness $\in [\frac{1}{8}, \frac{2}{8}, \ldots 1]$ (left halves: Imageworks, right halves: Heitz).</em></p><p>At the end of the day, $\color{brown}{F_\mathrm{ms}}$ is based on a simple diffuse model, and its limitations become more apparent as multiple scattering increases with roughness.</p><p>A more accurate alternative would be to precalculate a multiple-scattering directional albedo LUT that incorporates Fresnel, directly from the <em>Heitz</em> model. This new term, which I’ll call $\color{teal}{E_\mathrm{Fms}}$, leads to the following minor change to the multiple-scattering lobe:</p><p>The good news is that this version produces results that match <em>Heitz</em> in a furnace environment:</p><p><img class="center" src="/images/multi-faceted/conductors/lut_vs_heitz_wf.png"></p><p><em>Figure 2: Furnace test, with roughness $\in [\frac{1}{8}, \frac{2}{8}, \ldots 1]$ (left halves: with $\Ems$, right halves: Heitz).</em></p><p>The bad news is that we need a 3D LUT for $\Ems$, since it depends not only on the view angle ($\mu_o$) and roughness, but also $\Fr$ (or <em>specular reflectance</em>). Worse, for coloured metals – such as our lovely copper example – we’d need to do three separate 3D lookups for R, G and B. The only silver lining is that this cost can potentially be amortised across lights, but it’s still less than ideal for real-time applications.</p><p><em>Note: a secondary concern is that this change also breaks the recipriocity of the multiple-scattering model, since the results will be different if $\mu_o$ and $\mu_i$ are swapped. While this isn’t a practical issue for real-time rendering, it could be a problem in other contexts (e.g. bidirectional path tracing).</em></p><h2 id="schlick-alternative">Schlick Alternative</h2><p>If we’re willing to restrict ourselves to Schlick’s Fresnel approximation<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, then we can adapt a popular approach that’s been used with environmental lighting in games for a number of years [<a href="https://www.guerrilla-games.com/read/killzone-shadow-fall-creating-art-tools-for-a-new-generation">Drobot 2013</a>; <a href="http://blog.selfshadow.com/publications/s2013-shading-course/">Karis 2013</a>; <a href="http://blog.selfshadow.com/publications/s2013-shading-course/">Lazarov 2013</a>]. In this context, the roughness and directional-dependent effects of microfacet shadowing and Fresnel reflection are factored out and <em>preintegrated</em> ahead of time for a given BRDF. At run time, this term is combined with separately prefiltered environmental maps to produce a cheap but effective approximation of the real integral of the BRDF and the lighting.</p><p>This idea goes back further (see the <em>Ambient BRDF</em> of [<a href="http://renderwonk.com/publications/s2010-shading-course/">Gotanda 2010</a>]), but the newer variants more compact as they exploit the linearity of <em>Schlick Fresnel</em>, $\Fs$, to factor out $\Fr$, which reduces the dimensionality of the preintegrated table (or fit, in the case of [<a href="http://blog.selfshadow.com/publications/s2013-shading-course/">Lazarov 2013</a>]). I’ll quickly recap how this works, as it naturally extends to a solution for $\Ems$.</p><p>What these approaches are effectively calculating is a version of the <em>single-scattering</em> directional albedo, $\E$, that incorporates $\Fs$. Let’s call this $\Ess$:</p><p>where $\fssp$ is the single-scattering BRDF without Fresnel.</p><p>The key observation is that <em>Schlick Fresnel’s</em> additive form</p><p>allows $\Ess$ to be split into two parts:</p><p>one that will be tinted by $\Fr$ of the material at run time, and another that’s left untinted. This means that we can precompute a 2D LUT containing these two terms, rather than needing a 3D LUT.</p><p>A little more formally, we can view this as decomposing $\E$ into two factors, $\wa$ and $\wb$:</p><p>which are then multiplied by two orders of $\Fr$ and summed to form $\Ess$:</p><p>Apologies if I have laboured the point, but hopefully you can see where this is going: we can do a similar decomposition with the multiple-scattering albedo, $1 - \E$.</p><p>This time I’ll present things visually, since I think we’ve seen enough integrals for now. First, here’s $1 - \E$ for GGX, which you may recognise from Imageworks’ slides:</p><p><img class="center" src="/images/multi-faceted/fresnel/e_lut.svg" width="282"></p><p><em>Figure 3: $1 - \E$, for GGX.</em></p><p>and here is the decomposition into factors for the various orders of $\Fr$, over the ($\mu$, roughness) domain:</p><p><img class="center" src="/images/multi-faceted/fresnel/factors.svg"></p><p><em>Figure 4: Multiple-scattering Fresnel factors for GGX.</em></p><p>Naturally we have more factors this time, since with multiple scattering there could be $1 \ldots N$ additional reflections before light leaves the microsurface. Given these factors, we can calculate $\Ems$ thusly:</p><p>As with the approach for environmental lighting, these factors can be precomputed and stored in 2D LUTs. At run time, we fetch the appropriate factors (based on view angle and roughness) and calculate $\Ems$ using Eq. $\ref{eq:ms_sum}$.</p><p>While this hopefully all makes sense, it’s a little abstract, so let’s visualise $\Ems$ for our copper material:</p><p><img class="center" src="/images/multi-faceted/fresnel/f_lut.svg" width="282"></p><p><em>Figure 5: $\Ems$ for copper GGX material.</em></p><p>As we can see, it’s just like the multiple-scattering albedo shown in Figure 3, only now it’s been tinted by the different orders of Fresnel reflection. Note how the saturation increases from top left (low roughness, grazing angle) to bottom right (high roughness, incident view angle), as we would expect<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>.</p><p>Finally, here are the spheres again with this LUT-based solution, this time under direct lighting:</p><p><img class="center" src="/images/multi-faceted/conductors/lut_vs_heitz.png"></p><p><em>Figure 6: Lit spheres, with roughness $\in [\frac{1}{8}, \frac{2}{8}, \ldots 1]$ (left halves: with $\Ems$, right halves: Heitz).</em></p><p>In this example, our revised multiple-scattering approximation (Eq.$~\ref{eq:fms}$) is barely indistinguishable from the <em>Heitz</em> model. The only slight difference, at roughness = 1, comes from the multiple-scattering lobe not being a perfect match to the ground truth, as we already saw in the <a href="http://blog.selfshadow.com/2018/06/04/multi-faceted-part-2/">last post</a>:</p><p><img class="center" src="/images/multi-faceted/conservation/spi_vs_heitz_r1.png" width="256"></p><p><em>Figure 7: GGX with multiple scattering, roughness = 1<br>(left half: Imageworks, right half: Heitz).</em></p><p>I will stop things here as this post has already reached a comfortable reading length, but I hope you’ll agree that we’ve made some progress.</p><p><em>In the <a href="https://blog.selfshadow.com/2019/03/30/multi-faceted-part-4/">next post</a>, I cover how the precomputation of $\Ems$ is achieved in practice, and how it can be further optimised for real-time use.</em></p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>