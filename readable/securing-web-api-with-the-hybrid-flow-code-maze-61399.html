<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Securing Web API with the Hybrid Flow - Code Maze - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Securing Web API with the Hybrid Flow - Code Maze - linksfor.dev(s)"/>
    <meta property="og:description" content="In this article, we are going to learn about Securing Web API by using the Hybrid Flow. Additionally, we are going to use Policies to secure our app."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://code-maze.com/securing-webapi-hybrid-flow/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Securing Web API with the Hybrid Flow - Code Maze</title>
<div class="readable">
        <h1>Securing Web API with the Hybrid Flow - Code Maze</h1>
            <div>Reading time: 14-18 minutes</div>
        <div>Posted here: 06 May 2020</div>
        <p><a href="https://code-maze.com/securing-webapi-hybrid-flow/">https://code-maze.com/securing-webapi-hybrid-flow/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
																<article id="post-52278">
														
							
														
							
														
							<div>
															<div>
									<p><div><p><a href="https://code-maze.com/ultimate-aspnet-core-3-web-api/?topb=true" target="_blank"><img src="https://code-maze.com/wp-content/uploads/2020/01/Code-Maze-Book-Collection-V3-1024x483.png" data-lazy-type="image" data-src="https://code-maze.com/wp-content/uploads/2020/01/Code-Maze-Book-Collection-V3-1024x483.png" alt="Code Maze Book Collection V3" width="775" height="366" data-pagespeed-url-hash="2051067523" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></a></p><p>Looking to learn how to build <strong>great APIs</strong>? Or become <strong>even better</strong> at it? Check our newest book <strong><a href="https://code-maze.com/ultimate-aspnet-core-3-web-api/?topb=true" target="_blank" rel="noopener">Ultimate ASP.NET Core 3 Web API</a>.</strong> Learn how to create a full production-ready ASP.NET Core API using only the <strong>latest and greatest technologies</strong>. Bonus materials awaiting inside!</p></div>In the<a href="https://code-maze.com/identityserver4-ui-webapi-basic-security/" target="_blank" rel="noopener noreferrer"> second part of this series</a>, we were talking about securing Web API. But, we used the <code>ResourceOwnerPassword</code> and the <code>ClientCredentials</code> flows and Postman as a client. But now, we have our MVC client application, secured with the Hybrid Flow, which requires access to the Web API. So, securing Web API with the Hybrid flow requires additional configuration and this is going to be our goal for this article. Additionally, we are going to learn how we can use policies instead of roles to secure endpoints in our application.</p>
<p>To download the source code for the client application, you can visit the <a href="https://github.com/CodeMazeBlog/identity-server-4-aspnetcore/tree/securing-webapi-hybridflow" target="_blank" rel="nofollow noopener noreferrer">Securing Web API repository</a>.</p>
<p>We highly recommend visiting the&nbsp;<a href="https://code-maze.com/identityserver-4-series/" target="_blank" rel="noopener noreferrer">IdentityServer4 series&nbsp;</a>page to learn about all the articles in this series because this article is strongly related to the previous ones.</p>
<p>This article is divided into the following sections:</p>
<ul>
<li><a href="#securing-webapi">Securing Web API – Adding Additional Configuration</a></li>
<li><a href="#providing-accesstoken">Providing Access Token for Each Call to the API</a></li>
<li><a href="#redirecting-client">Redirecting the Client to the Unauthorized Page</a></li>
<li><a href="#policies">Securing Application with Policies</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<p>So, let’s get down to business.</p>
<h2 id="securing-webapi">Securing Web API – Adding Additional Configuration</h2>
<p>As we said, we have already added most of the required configuration for the IdentityServer and our Web API.</p>
<p>We have set up <code>ApiResource</code> in the <code>InMemoryConfig</code> class:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80b8546421981" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>static</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>ApiResource</span><span>&gt;</span><span> </span><span>GetApiResources</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>ApiResource</span><span>&gt;</span><span> </span><span>{</span><span> </span><span>new</span><span> </span><span>ApiResource</span><span>(</span><span>"companyApi"</span><span>,</span><span> </span><span>"CompanyEmployee API"</span><span>)</span><span> </span><span>}</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Configuration for the Web API client:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80c0239639334" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>new</span><span> </span><span>Client</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ClientId</span><span> </span>=<span> </span><span>"company-employee"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ClientSecrets</span><span> </span>=<span> </span><span>new</span><span> </span><span>[</span><span>]</span><span> </span><span>{</span><span> </span><span>new</span><span> </span><span>Secret</span><span>(</span><span>"codemazesecret"</span><span>.</span><span>Sha512</span><span>(</span><span>)</span><span>)</span><span> </span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AllowedGrantTypes</span><span> </span>=<span> </span><span>GrantTypes</span><span>.</span><span>ResourceOwnerPasswordAndClientCredentials</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AllowedScopes</span><span> </span>=<span> </span><span>{</span><span> </span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>OpenId</span><span>,</span><span> </span><span>"companyApi"</span><span> </span><span>}</span></p><p><span>}</span><span>,</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Lastly, we can find the configuration in the Web API project to communicate with the IdentityServer project:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80c2435792563" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>services</span><span>.</span><span>AddAuthentication</span><span>(</span><span>"Bearer"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>AddJwtBearer</span><span>(</span><span>"Bearer"</span><span>,</span><span> </span><span>opt</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>RequireHttpsMetadata</span><span> </span>=<span> </span><span>false</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>Authority</span><span> </span>=<span> </span><span>"https://localhost:5005"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>Audience</span><span> </span>=<span> </span><span>"companyApi"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>This enables back-channel communication between the Web API project and our IdentityServer, where API asks for a public key from IdentityServer to validate the <code>access_token</code>.</p>
<p>But now we have our client application that communicates with the Web API project and we need to add additional steps to complete the Hybrid Flow cycle and protect our API.</p>
<p>So, the first thing we have to do is to add a scope to the MvcClient in the IdentityServer configuration:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80c4784483029" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></div>
				</td>
						<td><div><p><span>new</span><span> </span><span>Client</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ClientName</span><span> </span>=<span> </span><span>"MVC Client"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ClientId</span><span> </span>=<span> </span><span>"mvc-client"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AllowedGrantTypes</span><span> </span>=<span> </span><span>GrantTypes</span><span>.</span><span>Hybrid</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>RedirectUris</span><span> </span>=<span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>string</span><span>&gt;</span><span>{</span><span> </span><span>"https://localhost:5010/signin-oidc"</span><span> </span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>AllowedScopes</span><span> </span>=</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>OpenId</span><span>,</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>Profile</span><span>,</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>Address</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"roles"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"companyApi"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ClientSecrets</span><span> </span>=<span> </span><span>{</span><span> </span><span>new</span><span> </span><span>Secret</span><span>(</span><span>"MVCSecret"</span><span>.</span><span>Sha512</span><span>(</span><span>)</span><span>)</span><span> </span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>PostLogoutRedirectUris</span><span> </span>=<span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>string</span><span>&gt;</span><span> </span><span>{</span><span> </span><span>"https://localhost:5010/signout-callback-oidc"</span><span> </span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>The <code>companyApi</code> value comes from the ApiResource configuration and we have to add it to the allowed scopes of our MVC client application.</p>
<p>Next, let’s modify the client’s OIDC configuration by adding a scope:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80c6267828861" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>.</span><span>AddOpenIdConnect</span><span>(</span><span>"oidc"</span><span>,</span><span> </span><span>opt</span><span> </span>=<span>&gt;</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//previous code</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>ClaimActions</span><span>.</span><span>MapUniqueJsonKey</span><span>(</span><span>"roles"</span><span>,</span><span> </span><span>"role"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>TokenValidationParameters</span><span> </span>=<span> </span><span>new</span><span> </span><span>TokenValidationParameters</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>RoleClaimType</span><span> </span>=<span> </span><span>"roles"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>Scope</span><span>.</span><span>Add</span><span>(</span><span>"companyApi"</span><span>)</span><span>;</span></p><p><span>}</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Finally, we have to uncomment the <code>[Authorize]</code> attribute in the Web API’s Companies controller:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80c9155354021" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>[</span><span>Authorize</span><span>]</span></p><p><span>[</span><span>HttpGet</span><span>]</span></p><p><span>public</span><span> </span><span>IActionResult </span><span>GetCompanies</span><span>(</span><span>)</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Now, we can start the IdentityServer, Web API, and client application. As soon as we log in, we are going to see a different consent screen:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/45-CompanyEmployee-API-access.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/45-CompanyEmployee-API-access-e1588252443675.png" alt="CompanyEmployee API access - Securing Web API" width="770" height="385" srcset="https://code-maze.com/wp-content/uploads/2020/04/45-CompanyEmployee-API-access-e1588252443675.png 770w, https://code-maze.com/wp-content/uploads/2020/04/45-CompanyEmployee-API-access-e1588252443675-300x150.png 300w, https://code-maze.com/wp-content/uploads/2020/04/45-CompanyEmployee-API-access-e1588252443675-768x384.png 768w" sizes="(max-width: 770px) 100vw, 770px"></a></p>
<p>But, once we click the <code>Allow</code> button, we are going to get an error page:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/46-Unauthorized-client-access-to-API.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/46-Unauthorized-client-access-to-API.png" alt="Unauthorized client access to API - Securing Web API" width="833" height="148" srcset="https://code-maze.com/wp-content/uploads/2020/04/46-Unauthorized-client-access-to-API.png 833w, https://code-maze.com/wp-content/uploads/2020/04/46-Unauthorized-client-access-to-API-300x53.png 300w, https://code-maze.com/wp-content/uploads/2020/04/46-Unauthorized-client-access-to-API-768x136.png 768w" sizes="(max-width: 833px) 100vw, 833px"></a></p>
<p>Even though we have all these configurations in place, we are still missing something.</p>
<h2 id="providing-accesstoken">Providing Access Token for Each Call to the API</h2>
<p>Before we dive into the code, let’s explain the reason our client is still unauthorized. Well, as we learned in <a href="https://code-maze.com/hybrid-flow-securing-aspnetcore-web-application/" target="_blank" rel="noopener noreferrer">the third part of this series</a>, the Hybrid flow has several steps. Our client sends a request for the <code>code</code> and <code>id_token</code> to the <code>/authorization</code> endpoint. IdentityServer returns them to the client. Then the client validates the <code>id_token</code> and if it’s valid it sends another request with the <code>code</code> to the <code>/token</code> endpoint. IdentityServer issues the <code>access_token</code> and <code>id_token</code>.</p>
<p>So, the client has the <code>access_token</code>, but it must provide that token as a Bearer token in the Authorization header (as we did in <a href="https://code-maze.com/identityserver4-ui-webapi-basic-security/" target="_blank" rel="noopener noreferrer">the second part of this series</a> with the Postman). But right now, our client application is not using that access token at all. That’s why we get an Unauthorized response.</p>
<p>To provide access token as a Bearer token, we have to modify the <code>GetClient</code> method in the <code>CompanyHttpClient</code> class in the client application:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80cb706032018" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p></div>
				</td>
						<td><div><p><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>HttpClient</span><span>&gt;</span><span> </span><span>GetClient</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>accessToken</span><span> </span>=<span> </span><span>await</span><span> </span><span>_httpContextAccessor</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>HttpContext</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>GetTokenAsync</span><span>(</span><span>OpenIdConnectParameterNames</span><span>.</span><span>AccessToken</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>!</span><span>string</span><span>.</span><span>IsNullOrWhiteSpace</span><span>(</span><span>accessToken</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_httpClient</span><span>.</span><span>SetBearerToken</span><span>(</span><span>accessToken</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_httpClient</span><span>.</span><span>BaseAddress</span><span> </span>=<span> </span><span>new</span><span> </span><span>Uri</span><span>(</span><span>"https://localhost:5001/"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_httpClient</span><span>.</span><span>DefaultRequestHeaders</span><span>.</span><span>Accept</span><span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_httpClient</span><span>.</span><span>DefaultRequestHeaders</span><span>.</span><span>Accept</span><span>.</span><span>Add</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>new</span><span> </span><span>MediaTypeWithQualityHeaderValue</span><span>(</span><span>"application/json"</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>_httpClient</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>So, we extract the access token from the <code>HttpContext</code> by using the <code>_httpContextAccessor</code> object and the <code>GetTokenAsync</code> method. If we find the token, we store it as a Bearer token with the <code>SetBearerToken</code> method. For all of these to work, we have to add additional using directives:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80cd375145494" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>using</span><span> </span><span>IdentityModel</span><span>.</span><span>Client</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Authentication</span><span>;</span></p><p><span>using</span><span> </span><span>Microsoft</span><span>.</span><span>IdentityModel</span><span>.</span><span>Protocols</span><span>.</span><span>OpenIdConnect</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Now, we can start our client app and login again. This time, we can see the data from the API.</p>
<h2 id="redirecting-client">Redirecting the Client to the Unauthorized Page</h2>
<p>It is not a good user experience to show the generic error page when an unauthorized user tries to access a protected page. Moreover, we have the AccessDenied page created. So, all we have to do is redirect an unauthorized user to that page.</p>
<p>To do that, let’s modify the <code>Index</code> action in the <code>Home</code> controller:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80cf414644833" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></div>
				</td>
						<td><div><p><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>Index</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>httpClient</span><span> </span>=<span> </span><span>await</span><span> </span><span>_companyHttpClient</span><span>.</span><span>GetClient</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>response</span><span> </span>=<span> </span><span>await</span><span> </span><span>httpClient</span><span>.</span><span>GetAsync</span><span>(</span><span>"api/companies"</span><span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>response</span><span>.</span><span>IsSuccessStatusCode</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>companiesString</span><span> </span>=<span> </span><span>await</span><span> </span><span>response</span><span>.</span><span>Content</span><span>.</span><span>ReadAsStringAsync</span><span>(</span><span>)</span><span>.</span><span>ConfigureAwait</span><span>(</span><span>false</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>companyViewModel</span><span> </span>=<span> </span><span>JsonConvert</span><span>.</span><span>DeserializeObject</span><span>&lt;</span><span>List</span><span>&lt;</span><span>CompanyViewModel</span><span>&gt;</span><span>&gt;</span><span>(</span><span>companiesString</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>View</span><span>(</span><span>companyViewModel</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span> </span><span>if</span><span>(</span><span>response</span><span>.</span><span>StatusCode</span><span> </span>==<span> </span><span>HttpStatusCode</span><span>.</span><span>Unauthorized</span><span> </span><span>|</span><span>|</span><span> </span><span>response</span><span>.</span><span>StatusCode</span><span> </span>==<span> </span><span>HttpStatusCode</span><span>.</span><span>Forbidden</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>RedirectToAction</span><span>(</span><span>"AccessDenied"</span><span>,</span><span> </span><span>"Account"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>Exception</span><span>(</span><span>$</span><span>"Problem with fetching data from the API: {response.ReasonPhrase}"</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>So, we check the <code>StatusCode</code> property from our response. If it is unauthorized or forbidden, we redirect a user to the <code>AccessDenied</code> page.</p>
<p>Now, let’s try this. But, on the consent page, we are not going to allow the API access:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/47-Declient-API-access.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/47-Declient-API-access.png" alt="Declined API access - Securing Web API" width="768" height="431" srcset="https://code-maze.com/wp-content/uploads/2020/04/47-Declient-API-access.png 768w, https://code-maze.com/wp-content/uploads/2020/04/47-Declient-API-access-300x168.png 300w" sizes="(max-width: 768px) 100vw, 768px"></a></p>
<p>After we click the Allow button, we are going to see the AccessDenied page for sure.</p>
<h2 id="policies">Securing Application with Policies</h2>
<p>In the previous article, we explained how to use Role Base Authorization (RBA) to protect our application. But, there is another approach – Attribute-based Access Control (ABAC), which is more suited for the authorization with complex rules. When we talk about the complex rules, we mean something like the user has to be authenticated and it must have a certain title and from a certain country, for example. So, as you can see, there are several rules for authorization to be completed, and the best way to configure that is by using the ABAC approach. This approach is also known as Policy-based Access Control because it uses policies to grant access for users to protected resources.</p>
<p>So, let’s learn how to use Policies in our client application.</p>
<p>We have to modify the configuration class on the IDP level first. So, let’s add new identity resources:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80d0530209721" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>static</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>IdentityResource</span><span>&gt;</span><span> </span><span>GetIdentityResources</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>IdentityResource</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>IdentityResources</span><span>.</span><span>OpenId</span><span>(</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>IdentityResources</span><span>.</span><span>Profile</span><span>(</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>IdentityResources</span><span>.</span><span>Address</span><span>(</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>IdentityResource</span><span>(</span><span>"roles"</span><span>,</span><span> </span><span>"User role(s)"</span><span>,</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>string</span><span>&gt;</span><span> </span><span>{</span><span> </span><span>"role"</span><span> </span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>IdentityResource</span><span>(</span><span>"position"</span><span>,</span><span> </span><span>"Your position"</span><span>,</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>string</span><span>&gt;</span><span> </span><span>{</span><span> </span><span>"position"</span><span> </span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>IdentityResource</span><span>(</span><span>"country"</span><span>,</span><span> </span><span>"Your country"</span><span>,</span><span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>string</span><span>&gt;</span><span> </span><span>{</span><span> </span><span>"country"</span><span> </span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>We want our client to request these scopes, so let’s modify allowed scopes for the MVC client:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80d2300070224" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>AllowedScopes</span><span> </span>=</p><p><span>{</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>OpenId</span><span>,</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>Profile</span><span>,</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>IdentityServerConstants</span><span>.</span><span>StandardScopes</span><span>.</span><span>Address</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"roles"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"companyApi"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"position"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"country"</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Finally, let’s add these claims to our users:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80d4277543629" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p></div>
				</td>
						<td><div><p><span>public</span><span> </span><span>static</span><span> </span><span>List</span><span>&lt;</span><span>TestUser</span><span>&gt;</span><span> </span><span>GetUsers</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>TestUser</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>TestUser</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>SubjectId</span><span> </span>=<span> </span><span>"a9ea0f25-b964-409f-bcce-c923266249b4"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Username</span><span> </span>=<span> </span><span>"Mick"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Password</span><span> </span>=<span> </span><span>"MickPassword"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Claims</span><span> </span>=<span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>Claim</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"given_name"</span><span>,</span><span> </span><span>"Mick"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"family_name"</span><span>,</span><span> </span><span>"Mining"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"address"</span><span>,</span><span> </span><span>"Sunny Street 4"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"role"</span><span>,</span><span> </span><span>"Admin"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"position"</span><span>,</span><span> </span><span>"Administrator"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"country"</span><span>,</span><span> </span><span>"USA"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>TestUser</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>SubjectId</span><span> </span>=<span> </span><span>"c95ddb8c-79ec-488a-a485-fe57a1462340"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Username</span><span> </span>=<span> </span><span>"Jane"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Password</span><span> </span>=<span> </span><span>"JanePassword"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Claims</span><span> </span>=<span> </span><span>new</span><span> </span><span>List</span><span>&lt;</span><span>Claim</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"given_name"</span><span>,</span><span> </span><span>"Jane"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"family_name"</span><span>,</span><span> </span><span>"Downing"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"address"</span><span>,</span><span> </span><span>"Long Avenue 289"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"role"</span><span>,</span><span> </span><span>"Visitor"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"position"</span><span>,</span><span> </span><span>"Viewer"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new</span><span> </span><span>Claim</span><span>(</span><span>"country"</span><span>,</span><span> </span><span>"USA"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
<p>Excellent. That’s it regarding the IDP level modifications.</p>
<p>Now, on the client level, we have to modify the OIDC configuration with familiar actions:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80d5760593598" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>.</span><span>AddOpenIdConnect</span><span>(</span><span>"oidc"</span><span>,</span><span> </span><span>opt</span><span> </span>=<span>&gt;</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//previous code</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>Scope</span><span>.</span><span>Add</span><span>(</span><span>"companyApi"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>Scope</span><span>.</span><span>Add</span><span>(</span><span>"position"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>Scope</span><span>.</span><span>Add</span><span>(</span><span>"country"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>ClaimActions</span><span>.</span><span>MapUniqueJsonKey</span><span>(</span><span>"position"</span><span>,</span><span> </span><span>"position"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>opt</span><span>.</span><span>ClaimActions</span><span>.</span><span>MapUniqueJsonKey</span><span>(</span><span>"country"</span><span>,</span><span> </span><span>"country"</span><span>)</span><span>;</span></p><p><span>}</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>And, we have to create our policies right above the<code> AddControllersWithViews</code> method:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80d8268497934" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>services</span><span>.</span><span>AddAuthorization</span><span>(</span><span>authOpt</span><span> </span>=<span>&gt;</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>authOpt</span><span>.</span><span>AddPolicy</span><span>(</span><span>"CanCreateAndModifyData"</span><span>,</span><span> </span><span>policyBuilder</span><span> </span>=<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>policyBuilder</span><span>.</span><span>RequireAuthenticatedUser</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>policyBuilder</span><span>.</span><span>RequireClaim</span><span>(</span><span>"position"</span><span>,</span><span> </span><span>"Administrator"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>policyBuilder</span><span>.</span><span>RequireClaim</span><span>(</span><span>"country"</span><span>,</span><span> </span><span>"USA"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>}</span><span>)</span><span>;</span></p><p><span>services</span><span>.</span><span>AddControllersWithViews</span><span>(</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We use the <code>AddAuthorization</code> method to add Authorization in the service collection. By using the <code>AddPolicy</code> method, we provide the policy name and all the policies required for the authorization process to complete. As you can see, we require a user to be an authenticated administrator from the USA.<!-- <span id="ezoic-pub-ad-placeholder-176" class="ezoic-adpicker-ad" data-ezadblocked='true'></span> --><!-- placeholder 176 blocked.  Reason : no sizes --></p>
<p>So, once we log in, we are going to see additional scopes in our consent screen:</p>
<p><a href="https://code-maze.com/wp-content/uploads/2020/04/48-Additional-Scopes-Country-and-Position.png"><img src="https://code-maze.com/wp-content/uploads/2020/04/48-Additional-Scopes-Country-and-Position.png" alt="Additional Scopes Country and Position" width="578" height="361" srcset="https://code-maze.com/wp-content/uploads/2020/04/48-Additional-Scopes-Country-and-Position.png 578w, https://code-maze.com/wp-content/uploads/2020/04/48-Additional-Scopes-Country-and-Position-300x187.png 300w, https://code-maze.com/wp-content/uploads/2020/04/48-Additional-Scopes-Country-and-Position-400x250.png 400w" sizes="(max-width: 578px) 100vw, 578px"></a></p>
<p>And, if we navigate to the Privacy page, we are going to see additional claims for sure.</p>
<p>But, we are not using our created policy for authorization. At least not yet. So, let’s change that.</p>
<h3>Using Policies</h3>
<p>We are going to modify the <code>Index</code> view first:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80d9656237026" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></div>
				</td>
						<td><div><p><span>@</span><span>if</span><span> </span><span>(</span><span>(</span><span>await</span><span> </span><span>AuthorizationService</span><span>.</span><span>AuthorizeAsync</span><span>(</span><span>User</span><span>,</span><span> </span><span>"CanCreateAndModifyData"</span><span>)</span><span>)</span><span>.</span><span>Succeeded</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>p</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>a</span><span> </span><span>asp</span>-<span>action</span>=<span>"Create"</span><span>&gt;</span><span>Create </span><span>New</span><span>&lt;</span>/<span>a</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span>/<span>p</span><span>&gt;</span></p><p><span>}</span></p><p><span>//additional code</span></p><p><span>@</span><span>if</span><span> </span><span>(</span><span>(</span><span>await</span><span> </span><span>AuthorizationService</span><span>.</span><span>AuthorizeAsync</span><span>(</span><span>User</span><span>,</span><span> </span><span>"CanCreateAndModifyData"</span><span>)</span><span>)</span><span>.</span><span>Succeeded</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span><span>td</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>Html</span><span>.</span><span>ActionLink</span><span>(</span><span>"Edit"</span><span>,</span><span> </span><span>"Edit"</span><span>,</span><span> </span><span>new</span><span> </span><span>{</span><span> </span><span>/* id=item.PrimaryKey */</span><span> </span><span>}</span><span>)</span><span> </span><span>|</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>Html</span><span>.</span><span>ActionLink</span><span>(</span><span>"Details"</span><span>,</span><span> </span><span>"Details"</span><span>,</span><span> </span><span>new</span><span> </span><span>{</span><span> </span><span>/* id=item.PrimaryKey */</span><span> </span><span>}</span><span>)</span><span> </span><span>|</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>Html</span><span>.</span><span>ActionLink</span><span>(</span><span>"Delete"</span><span>,</span><span> </span><span>"Delete"</span><span>,</span><span> </span><span>new</span><span> </span><span>{</span><span> </span><span>/* id=item.PrimaryKey */</span><span> </span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;</span>/<span>td</span><span>&gt;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>And finally, let’s modify the <code>[Authorize]</code> attribute for the Privacy action:</p><!-- Urvanov Syntax Highlighter v2.8.9 -->

		<div id="urvanov-syntax-highlighter-5eb252f6e80db909765361" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>[</span><span>Authorize</span><span>(</span><span>Policy</span><span> </span>=<span> </span><span>"CanCreateAndModifyData"</span><span>)</span><span>]</span></p><p><span>public</span><span> </span><span>async</span><span> </span><span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span><span> </span><span>Privacy</span><span>(</span><span>)</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>And that’s it. We can test this with both Mick and Jane. For sure with Jane’s account, we won’t be able to see Create, Update, Delete, and Details link and we are going to be redirected to the AccessDenied page if we try to navigate to the Privacy page. You can try it out.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Excellent.</p>
<p>In this article, we have learned how to implement the Hybrid Flow to protect our Web API. Additionally, we’ve learned how to place an access_token to each call from our client to the API and how to use Policies to protect our application.</p>
<p>In the next article, we are going to show you how to transfer all the in-memory configuration to the database.</p>
<p>Until then,</p>
<p>Best regards.</p>

</div>
														</div>
														

																				</article>

						
						
												
										
				
			</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>