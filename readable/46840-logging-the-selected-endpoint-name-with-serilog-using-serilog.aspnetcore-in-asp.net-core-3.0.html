<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Logging the selected Endpoint Name with Serilog: Using Serilog.AspNetCore in ASP.NET Core 3.0 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Logging the selected Endpoint Name with Serilog: Using Serilog.AspNetCore in ASP.NET Core 3.0</h1><div><div class="post-content"><p>In <a href="/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/">my previous post</a> I described how to configure Serilog's RequestLogging middleware to create "summary" logs for each request, to replace the 10 or more logs you get from ASP.NET Core by default.</p><p>In this post I show how you can add additional metadata to Serilog's summary request log, such as the Request's hostname, the Response's content-type, or the selected Endpoint Name from <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-3.0#endpoint-routing-differences-from-earlier-versions-of-routing">the endpoint routing middleware</a> used in ASP.NET Core 3.0.</p><h2 id="asp-net-core-infrastructure-logs-are-verbose-but-have-more-details-by-default" class="heading-with-anchor">ASP.NET Core infrastructure logs are verbose, but have more details by default<a href="#asp-net-core-infrastructure-logs-are-verbose-but-have-more-details-by-default"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>As I showed in <a href="/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/">my previous post</a>, in the Development environment the ASP.NET Core infrastructure generates 10 log messages for a request to a RazorPage handler:</p><p><img src="/content/images/2019/logs_before_serilog.png" alt="Image of many infrastructure logs without using Serilog request logging"></p><p>By switching to Serilog's <code>RequestLoggingMiddleware</code> that comes with the <a href="https://github.com/serilog/serilog-aspnetcore">Serilog.AspNetCore</a> NuGet package you can reduce this to a single log message:</p><p><img src="/content/images/2019/logs_after_serilog.png" alt="Image of the summary log generated by Serilog's request logging"></p><blockquote><p>All the images of logs used in this post are <a href="https://datalust.co/seq">taken using Seq</a>, which is an excellent tool for viewing structured logs</p></blockquote><p>Clearly the original set of logs are more verbose, and a large part of that is not especially useful information. However, if you take the original 10 logs as a whole, they do record some additional fields in the structure log template when compared to the Serilog summary log. </p><p>Additional fields logged by the ASP.NET Core infrastructure which are <em>not</em> logged by Serilog include:</p><ul><li>Host (<code>localhost:5001</code>)</li><li>Scheme (<code>https</code>)</li><li>Protocol (<code>HTTP/2</code>)</li><li>QueryString (<code>test=true</code>)</li><li>EndpointName (<code>/Index</code>)</li><li>HandlerName (<code>OnGet</code>/<code>SerilogRequestLogging.Pages.IndexModel.OnGet</code>)</li><li>ActionId (<code>1fbc88fa-42db-424f-b32b-c2d0994463f1</code>)</li><li>ActionName (<code>/Index</code>)</li><li>RouteData (<code>{page = "/Index"}</code>)</li><li>ValidationState (<code>True</code>/<code>False</code>)</li><li>ActionResult (<code>PageResult</code>)</li><li>ContentType (<code>text/html; charset=utf-8</code>)</li></ul><p>I'd argue that <em>some</em> of these points would definitely be useful to include in the summary log message. For example, if your app is bound to multiple host names then <code>Host</code> is definitely important to log. <code>QueryString</code> is potentially another useful field. <code>EndpointName</code>/<code>HandlerName</code>, <code>ActionId</code>, and <code>ActionName</code> seem slightly less critical, given that you should be able to deduce those given the request path, but logging them explicitly will help you catch bugs, as well as make it easier to filter all requests to a specific action.</p><p>Broadly speaking, you can separate these properties into two categories:</p><ul><li><em>Request/Response</em> properties e.g. <code>Host</code>, <code>Scheme</code>, <code>ContentType</code>, <code>QueryString</code>, <code>EndpointName</code></li><li><em>MVC/RazorPages-related</em> properties e.g. <code>HandlerName</code>, <code>ActionId</code>, <code>ActionResult</code> etc</li></ul><p>In this post i'll show how you can add the first of these categories, properties related to the Request/Response, and in the next post I'll show how you can add MVC/RazorPages-based properties.</p><h2 id="adding-additional-data-to-the-serilog-request-log" class="heading-with-anchor">Adding additional data to the Serilog request log<a href="#adding-additional-data-to-the-serilog-request-log"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>I showed how to add Serilog request logging to your application <a href="/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/">in my previous post</a>, so I'm not going to cover that again here. For now, I'll assume you've already set that up, and you have a <code>Startup.Configure</code> method that looks something like this: </p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span><span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span><span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseSerilogRequestLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
        endpoints<span class="token punctuation">.</span><span class="token function">MapRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>The <code>UseSerilogRequestLogging()</code> extension method adds the Serilog <code>RequestLoggingMiddleware</code> to the pipeline. You can also call an overload to <a href="https://github.com/serilog/serilog-aspnetcore/blob/ffed9d231aefc3de7c13a03a570fb45c326632b0/src/Serilog.AspNetCore/AspNetCore/RequestLoggingOptions.cs">configure an instance of <code>RequestLoggingOptions</code></a>. This class has several properties that let you customise how the request logger generates the log statements:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">RequestLoggingOptions</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">string</span> MessageTemplate <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> Func<span class="token operator">&lt;</span>HttpContext<span class="token punctuation">,</span><span class="token keyword">double</span><span class="token punctuation">,</span> Exception<span class="token punctuation">,</span> LogEventLevel<span class="token operator">&gt;</span> GetLevel <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> Action<span class="token operator">&lt;</span>IDiagnosticContext<span class="token punctuation">,</span> HttpContext<span class="token operator">&gt;</span> EnrichDiagnosticContext <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The <code>MessageTemplate</code> property controls how the log is rendered to a string and <code>GetLevel</code> lets you control whether a given log should be level <code>Debug</code>/<code>Info</code>/<code>Warning</code> etc. The property we're interested in here is the <code>EnrichDiagnosticContext</code> property.</p><p>When set, this <code>Action&lt;&gt;</code> is executed by Serilog's middleware when it generates a log message. It's run <em>just before</em> the log is written, which means it runs <em>after</em> the middleware pipeline has executed. For example, in the image below (<a href="https://www.manning.com/books/asp-dot-net-core-in-action?a_aid=aspnetcore-in-action&amp;a_bid=5b1b11eb">taken from my book ASP.NET Core in Action</a>) the log is written at step 5, when the response "passes back through" the middleware pipeline:</p><p><img src="/content/images/2017/07/03_01.png" alt="Example of a middleware pipeline"></p><p>The fact that the log is written <em>after</em> the pipeline has processed means a couple of things: </p><ul><li>We can access properties of the <em>Response</em>, such as the status code, elapsed time, or the content type</li><li>We can access <em>Features</em> that are set by middleware <em>later</em> in the pipeline, for example the <code>IEndpointFeature</code> set by the <code>EndpointRoutingMiddleware</code> (added via <code>UseRouting()</code>).</li></ul><p>In the next section, I provide a helper function that adds all the "missing" properties to the Serilog request log message.</p><h2 id="setting-values-in-idiagnosticcontext" class="heading-with-anchor">Setting values in IDiagnosticContext<a href="#setting-values-in-idiagnosticcontext"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p><em>Serilog.AspNetCore</em> adds the interface <code>IDiagnosticContext</code> to the DI container as a singleton, so you can access it from any of your classes. You can then use it to attach additional properties to the request log message by calling <code>Set()</code>.</p><p>For example, <a href="https://github.com/serilog/serilog-aspnetcore#request-logging">as shown in the documentation</a>, you can add arbitrary values from an action method: </p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">HomeController</span><span class="token punctuation">:</span><span class="token class-name">Controller</span><span class="token punctuation">{</span><span class="token keyword">readonly</span><span class="token class-name">IDiagnosticContext</span> _diagnosticContext<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">HomeController</span><span class="token punctuation">(</span><span class="token class-name">IDiagnosticContext</span> diagnosticContext<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _diagnosticContext <span class="token operator">=</span> diagnosticContext<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">IActionResult</span><span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        _diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"CatalogLoadTime"</span><span class="token punctuation">,</span><span class="token number">1423</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The resulting summary log will then include the property <code>CatalogLoadTime</code>. </p><p>We essentially use exactly the same approach to customise the <code>RequestLoggingOptions</code> used by the middleware, by setting values on the provided <code>IDiagnosticContext</code> instance. The static helper class below retrieves values from the current <code>HttpContext</code> and sets them if they're available.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">class</span><span class="token class-name">LogHelper</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">void</span><span class="token function">EnrichFromRequest</span><span class="token punctuation">(</span><span class="token class-name">IDiagnosticContext</span> diagnosticContext<span class="token punctuation">,</span><span class="token class-name">HttpContext</span> httpContext<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> request <span class="token operator">=</span> httpContext<span class="token punctuation">.</span>Request<span class="token punctuation">;</span>
        diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>Host<span class="token punctuation">)</span><span class="token punctuation">;</span>
        diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Protocol"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>Protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Scheme"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>QueryString<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span><span class="token punctuation">{</span>
            diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"QueryString"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>QueryString<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"ContentType"</span><span class="token punctuation">,</span> httpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> endpoint <span class="token operator">=</span> httpContext<span class="token punctuation">.</span><span class="token function">GetEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>endpoint <span class="token keyword">is</span><span class="token keyword">object</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            diagnosticContext<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"EndpointName"</span><span class="token punctuation">,</span> endpoint<span class="token punctuation">.</span>DisplayName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The helper function above retrieves values from the Request, from the Response, and from features set by other middleware (Endpoint Name). You could extend this to add other values from the request as appropriate.</p><p>You can register the helper by setting the <code>EnrichDiagnosticContext</code> property when you call <code>UseSerilogRequestLogging</code> in your <code>Startup.Configure()</code> method:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span><span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span><span class="token punctuation">{</span>

    app<span class="token punctuation">.</span><span class="token function">UseSerilogRequestLogging</span><span class="token punctuation">(</span>opts
        <span class="token operator">=</span><span class="token operator">&gt;</span> opts<span class="token punctuation">.</span>EnrichDiagnosticContext <span class="token operator">=</span> LogHelper<span class="token punctuation">.</span>EnrichFromRequest<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>Now when you make requests, you will see all the extra properties added to your Serilog structured logs:</p><p><img src="/content/images/2019/logs_after_serilog_endriched.png" alt="Log message from Seq showing the additional properties"></p><p>You can use this approach whenever you have values that are generally available to the middleware pipeline via the current <code>HttpContext</code>. The exception to that is MVC-specific features which are "internal" to the MVC middleware, like action names, or RazorPage handler names. In the next post I'll show how you can also add those to your Serilog request log.</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>By default, when you replace the ASP.NET Core infrastructure logging with Serilog's request logging middleware, you lose some information compared to the default logging configuration for Development environments. In this post I show how you can customise Serilog's <code>RequestLoggingOptions</code> to add these additional properties back in. </p><p>The method for doing so is very simple - you have access to the <code>HttpContext</code> so you can retrieve any values it has available and can set them as properties on the provided <code>IDiagnosticContext</code>. These are added as extra properties to the structured log generated by Serilog. In the next post I'll show how you can add MVC-specific values to the request log.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>