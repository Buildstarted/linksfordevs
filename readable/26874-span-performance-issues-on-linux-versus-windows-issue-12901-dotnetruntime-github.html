<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Span performance issues on Linux versus Windows &#xB7; Issue #12901 &#xB7; dotnet/runtime &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Span<t> performance issues on Linux versus Windows · Issue #12901 · dotnet/runtime · GitHub</t></h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>Looks like there are two main contributors to the perf impact.</p><ul><li><code>Average</code> is not inlined in the span case</li><li><code>Average</code> method CQ is not as good for span as it is for pointers</li></ul><p>For inlining, the inliner overestimates the size of the <code>Span</code> variant as it does not realize the calls made in <code>Average</code> are to intrinsics. It underestimates the benefit as the impact of the constant length <code>4</code> is not readily apparent (as it requires looking through span fields). Also, the size of the call site for the <code>Span</code> version is somewhat under-estimated as the inliner does not accurately model the SysV conventions.</p><p>Net impact is that the pointer version of <code>Average</code> looks like a very good inline candidate, and the <code>Span</code> version does not.</p><pre><code>;; pointer version
Inline candidate has an arg that feeds a constant test.  Multiplier increased to 1.
Inline candidate has const arg that feeds a conditional.  Multiplier increased to 4.
Inline candidate callsite is in a loop.  Multiplier increased to 7.
calleeNativeSizeEstimate=382
callsiteNativeSizeEstimate=145
benefit multiplier=7
threshold=1015
Native estimate for function size is within threshold for inlining 38.2 &lt;= 101.5 (multiplier = 7)

;; span version
Inline candidate has an arg that feeds a constant test.  Multiplier increased to 1.
Inline candidate callsite is in a loop.  Multiplier increased to 4.
calleeNativeSizeEstimate=776
callsiteNativeSizeEstimate=135
benefit multiplier=4
threshold=540
Native estimate for function size exceeds threshold for inlining 77.6 &gt; 54 (multiplier = 4)
</code></pre><p>Also, the method we end up calling is not as well optimized as its pointer-based counterpart. There seem to be two factors here as well: we spill the incoming span (passed in regs) to the stack and then reload it back to regs, and we have an extra move in the inner loop. The extra arg passing costs may dominate here as the loop itself only runs 4 iterations.</p><div class="highlight highlight-source-assembly"><pre><span class="pl-c">;; Average(byte*, int)</span><span class="pl-en">G_M63158_IG01:</span><span class="pl-en"></span><span class="pl-k">push</span><span class="pl-en"></span><span class="pl-v">rbp</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rbp</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">rsp</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-en">G_M63158_IG02:</span><span class="pl-en"></span><span class="pl-k">xor</span><span class="pl-en"></span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">eax</span><span class="pl-en"></span><span class="pl-k">xor</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-en"></span><span class="pl-k">test</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-en"></span><span class="pl-k">jle</span><span class="pl-en">      SHORT G_M63158_IG04</span><span class="pl-en">G_M63158_IG03:</span><span class="pl-en"></span><span class="pl-k">movsxd</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-en"></span><span class="pl-k">movzx</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"> byte  ptr </span><span class="pl-s1">[</span><span class="pl-v">rsi</span><span class="pl-s1">+</span><span class="pl-v">rcx</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">ecx</span><span class="pl-en"></span><span class="pl-k">inc</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-en"></span><span class="pl-k">cmp</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-en"></span><span class="pl-k">jl</span><span class="pl-en">       SHORT G_M63158_IG03</span><span class="pl-en">G_M63158_IG04:</span><span class="pl-en"></span><span class="pl-k">cdq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">idiv</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-en">:</span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-en"></span><span class="pl-k">movzx</span><span class="pl-en"></span><span class="pl-v">rax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">al</span><span class="pl-en">G_M63158_IG05:</span><span class="pl-en"></span><span class="pl-k">pop</span><span class="pl-en"></span><span class="pl-v">rbp</span><span class="pl-en"></span><span class="pl-k">ret</span><span class="pl-en"></span></pre></div><div class="highlight highlight-source-assembly"><pre><span class="pl-c">;; Average(Span&lt;byte&gt;)</span><span class="pl-en">G_M63160_IG01:</span><span class="pl-en"></span><span class="pl-k">push</span><span class="pl-en"></span><span class="pl-v">rbp</span><span class="pl-en"></span><span class="pl-k">sub</span><span class="pl-en"></span><span class="pl-v">rsp</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-c1">16</span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rbp</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rsp</span><span class="pl-s1">+</span><span class="pl-c1">10H</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en">      bword ptr </span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">10H</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">rsi</span><span class="pl-en">    // spill back to stack</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en">      qword ptr </span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">08H</span><span class="pl-s1">],</span><span class="pl-en"></span><span class="pl-v">rdx</span><span class="pl-en">    // ...</span><span class="pl-en">G_M63160_IG02:</span><span class="pl-en"></span><span class="pl-k">xor</span><span class="pl-en"></span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">eax</span><span class="pl-en"></span><span class="pl-k">xor</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">esi</span><span class="pl-s1">,</span><span class="pl-en"> dword ptr </span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">08H</span><span class="pl-s1">]</span><span class="pl-en">   // </span><span class="pl-k">and</span><span class="pl-en"> reload</span><span class="pl-en"></span><span class="pl-k">test</span><span class="pl-en"></span><span class="pl-v">esi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">esi</span><span class="pl-en"></span><span class="pl-k">jle</span><span class="pl-en">      SHORT G_M63160_IG04</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">rdx</span><span class="pl-s1">,</span><span class="pl-en"> bword ptr </span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">-</span><span class="pl-c1">10H</span><span class="pl-s1">]</span><span class="pl-en">   // ....</span><span class="pl-en">G_M63160_IG03:</span><span class="pl-en"></span><span class="pl-k">movsxd</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-en"></span><span class="pl-k">movzx</span><span class="pl-en"></span><span class="pl-v">rcx</span><span class="pl-s1">,</span><span class="pl-en"> byte  ptr </span><span class="pl-s1">[</span><span class="pl-v">rdx</span><span class="pl-s1">+</span><span class="pl-v">rcx</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">add</span><span class="pl-en"></span><span class="pl-v">ecx</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">eax</span><span class="pl-en"></span><span class="pl-k">mov</span><span class="pl-en"></span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">ecx</span><span class="pl-en">                   // extra move</span><span class="pl-en"></span><span class="pl-k">inc</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-en"></span><span class="pl-k">cmp</span><span class="pl-en"></span><span class="pl-v">edi</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">esi</span><span class="pl-en"></span><span class="pl-k">jl</span><span class="pl-en">       SHORT G_M63160_IG03</span><span class="pl-en">G_M63160_IG04:</span><span class="pl-en"></span><span class="pl-k">cdq</span><span class="pl-en"></span><span class="pl-en"></span><span class="pl-k">idiv</span><span class="pl-en"></span><span class="pl-v">edx</span><span class="pl-en">:</span><span class="pl-v">eax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">esi</span><span class="pl-en"></span><span class="pl-k">movzx</span><span class="pl-en"></span><span class="pl-v">rax</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-v">al</span><span class="pl-en">G_M63160_IG05:</span><span class="pl-en"></span><span class="pl-k">lea</span><span class="pl-en"></span><span class="pl-v">rsp</span><span class="pl-s1">,</span><span class="pl-en"></span><span class="pl-s1">[</span><span class="pl-v">rbp</span><span class="pl-s1">]</span><span class="pl-en"></span><span class="pl-k">pop</span><span class="pl-en"></span><span class="pl-v">rbp</span><span class="pl-en"></span><span class="pl-k">ret</span><span class="pl-en"></span></pre></div><p>As a workaround, adding <code>AggressiveInlining</code> to the <code>Average</code> method brings things back in line:</p><table><thead><tr><th>Method</th><th>S</th><th>C</th><th align="right">Mean</th><th align="right">Error</th><th align="right">StdDev</th></tr></thead><tbody><tr><td>Span</td><td>256</td><td>4</td><td align="right">3.339 us</td><td align="right">0.0260 us</td><td align="right">0.0243 us</td></tr><tr><td>Ptr</td><td>256</td><td>4</td><td align="right">3.406 us</td><td align="right">0.0062 us</td><td align="right">0.0052 us</td></tr></tbody></table><p>We could consider boosting inline profitabilty for <code>Span</code> and perhaps discount the cost of methods called on <code>Span</code> types.</p><p>cc <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/CarolEidt/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/CarolEidt">@CarolEidt</a>: an example where we're not using SysV ABI to its best advantage.</p><p>I don't see anything we can do here for 3.0 so am going to move this to future.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>