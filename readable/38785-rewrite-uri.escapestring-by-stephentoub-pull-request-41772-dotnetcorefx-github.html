<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Rewrite Uri.EscapeString by stephentoub &#xB7; Pull Request #41772 &#xB7; dotnet/corefx &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Rewrite Uri.EscapeString by stephentoub · Pull Request #41772 · dotnet/corefx · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>Several public methods (Uri.EscapeDataString, Uri.EscapeUriString) and a bunch of internal call sites rely on the internal EscapeString helper.  This helper has several issues with it:</p><ul><li>It uses unsafe code.</li><li>It unnecessarily requires and copies through a char[] to get to a string when a string is the required result.</li><li>It has a lot of complexity around the handling of unicode.</li></ul><p>This PR rewrites it to utilize Span, Rune, and other newer features in a way that enables it to be both safe and efficient.  Most inputs ends up being faster, and for very long inputs, it's much, much faster.  The use of ValueStringBuilder also results in less memory allocation, in some cases significantly.</p><p>The use of Rune also fixes two arguable bugs in the existing implementation around invalid Unicode sequences, which is why a couple tests were tweaked:</p><ul><li>Some but not all invalid unicode patterns result in replacement characters being used: a few invalid sequences (e.g. just a high surrogate) result in an exception.  We should be standardized on using replacement characters for all such invalid sequences.</li><li>Some patterns with invalid unicode patterns actually result in unnecessary encoding, e.g. <code>Uri.EscapeDataString("\uD800\uD800a")</code> results in <code>a</code> being encoded.</li></ul><table><thead><tr><th>Method</th><th>Tool</th><th>Length</th><th>Kind</th><th align="right">Mean</th><th align="right">Ratio</th><th align="right">Allocated</th></tr></thead><tbody><tr><td>EscapeData</td><td>new</td><td>10</td><td>Unreserved</td><td align="right">19.92 ns</td><td align="right">0.23</td><td align="right">-</td></tr><tr><td>EscapeData</td><td>old</td><td>10</td><td>Unreserved</td><td align="right">84.86 ns</td><td align="right">1.00</td><td align="right">-</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>10</td><td>Unreserved</td><td align="right">17.00 ns</td><td align="right">0.17</td><td align="right">-</td></tr><tr><td>EscapeUri</td><td>old</td><td>10</td><td>Unreserved</td><td align="right">103.09 ns</td><td align="right">1.00</td><td align="right">-</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>10</td><td>Unicode</td><td align="right">316.53 ns</td><td align="right">0.96</td><td align="right">264 B</td></tr><tr><td>EscapeData</td><td>old</td><td>10</td><td>Unicode</td><td align="right">330.18 ns</td><td align="right">1.00</td><td align="right">1248 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>10</td><td>Unicode</td><td align="right">313.91 ns</td><td align="right">0.95</td><td align="right">264 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>10</td><td>Unicode</td><td align="right">328.76 ns</td><td align="right">1.00</td><td align="right">1248 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>10</td><td>OneRe(...)erved [25]</td><td align="right">154.93 ns</td><td align="right">1.04</td><td align="right">48 B</td></tr><tr><td>EscapeData</td><td>old</td><td>10</td><td>OneRe(...)erved [25]</td><td align="right">149.36 ns</td><td align="right">1.00</td><td align="right">312 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>10</td><td>OneRe(...)erved [25]</td><td align="right">152.34 ns</td><td align="right">0.85</td><td align="right">48 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>10</td><td>OneRe(...)erved [25]</td><td align="right">179.05 ns</td><td align="right">1.00</td><td align="right">312 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>10</td><td>Alternating</td><td align="right">192.87 ns</td><td align="right">0.73</td><td align="right">120 B</td></tr><tr><td>EscapeData</td><td>old</td><td>10</td><td>Alternating</td><td align="right">262.74 ns</td><td align="right">1.00</td><td align="right">392 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>10</td><td>Alternating</td><td align="right">189.67 ns</td><td align="right">0.65</td><td align="right">120 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>10</td><td>Alternating</td><td align="right">289.09 ns</td><td align="right">1.00</td><td align="right">392 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100</td><td>Unreserved</td><td align="right">83.99 ns</td><td align="right">0.13</td><td align="right">-</td></tr><tr><td>EscapeData</td><td>old</td><td>100</td><td>Unreserved</td><td align="right">660.66 ns</td><td align="right">1.00</td><td align="right">-</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100</td><td>Unreserved</td><td align="right">83.69 ns</td><td align="right">0.09</td><td align="right">-</td></tr><tr><td>EscapeUri</td><td>old</td><td>100</td><td>Unreserved</td><td align="right">943.46 ns</td><td align="right">1.00</td><td align="right">-</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100</td><td>Unicode</td><td align="right">3,015.49 ns</td><td align="right">0.96</td><td align="right">2424 B</td></tr><tr><td>EscapeData</td><td>old</td><td>100</td><td>Unicode</td><td align="right">3,150.40 ns</td><td align="right">1.00</td><td align="right">12144 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100</td><td>Unicode</td><td align="right">3,004.75 ns</td><td align="right">0.90</td><td align="right">2424 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>100</td><td>Unicode</td><td align="right">3,334.80 ns</td><td align="right">1.00</td><td align="right">12144 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100</td><td>OneRe(...)erved [25]</td><td align="right">997.48 ns</td><td align="right">0.96</td><td align="right">232 B</td></tr><tr><td>EscapeData</td><td>old</td><td>100</td><td>OneRe(...)erved [25]</td><td align="right">1,034.85 ns</td><td align="right">1.00</td><td align="right">496 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100</td><td>OneRe(...)erved [25]</td><td align="right">1,009.19 ns</td><td align="right">0.89</td><td align="right">232 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>100</td><td>OneRe(...)erved [25]</td><td align="right">1,126.74 ns</td><td align="right">1.00</td><td align="right">496 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100</td><td>Alternating</td><td align="right">1,705.95 ns</td><td align="right">0.72</td><td align="right">1080 B</td></tr><tr><td>EscapeData</td><td>old</td><td>100</td><td>Alternating</td><td align="right">2,361.35 ns</td><td align="right">1.00</td><td align="right">2536 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100</td><td>Alternating</td><td align="right">1,690.50 ns</td><td align="right">0.63</td><td align="right">1080 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>100</td><td>Alternating</td><td align="right">2,691.28 ns</td><td align="right">1.00</td><td align="right">2536 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100000</td><td>Unreserved</td><td align="right">66,052.21 ns</td><td align="right">0.09</td><td align="right">-</td></tr><tr><td>EscapeData</td><td>old</td><td>100000</td><td>Unreserved</td><td align="right">710,216.92 ns</td><td align="right">1.00</td><td align="right">-</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100000</td><td>Unreserved</td><td align="right">66,393.07 ns</td><td align="right">0.08</td><td align="right">-</td></tr><tr><td>EscapeUri</td><td>old</td><td>100000</td><td>Unreserved</td><td align="right">874,426.80 ns</td><td align="right">1.00</td><td align="right">1 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100000</td><td>Unicode</td><td align="right">4,295,295.08 ns</td><td align="right">0.003</td><td align="right">6594352 B</td></tr><tr><td>EscapeData</td><td>old</td><td>100000</td><td>Unicode</td><td align="right">1,490,528,971.72 ns</td><td align="right">1.000</td><td align="right">6006095568 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100000</td><td>Unicode</td><td align="right">4,214,907.36 ns</td><td align="right">0.003</td><td align="right">6594359 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>100000</td><td>Unicode</td><td align="right">1,517,378,125.77 ns</td><td align="right">1.000</td><td align="right">6006096360 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100000</td><td>OneRe(...)erved [25]</td><td align="right">939,019.21 ns</td><td align="right">0.94</td><td align="right">200033 B</td></tr><tr><td>EscapeData</td><td>old</td><td>100000</td><td>OneRe(...)erved [25]</td><td align="right">984,792.58 ns</td><td align="right">1.00</td><td align="right">400328 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100000</td><td>OneRe(...)erved [25]</td><td align="right">966,883.99 ns</td><td align="right">0.89</td><td align="right">200040 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>100000</td><td>OneRe(...)erved [25]</td><td align="right">1,082,288.94 ns</td><td align="right">1.00</td><td align="right">400331 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeData</td><td>new</td><td>100000</td><td>Alternating</td><td align="right">1,751,153.61 ns</td><td align="right">0.01</td><td align="right">1066679 B</td></tr><tr><td>EscapeData</td><td>old</td><td>100000</td><td>Alternating</td><td align="right">146,994,750.75 ns</td><td align="right">1.00</td><td align="right">615528622 B</td></tr><tr><td></td><td></td><td></td><td></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td>EscapeUri</td><td>new</td><td>100000</td><td>Alternating</td><td align="right">1,735,597.85 ns</td><td align="right">0.01</td><td align="right">1066676 B</td></tr><tr><td>EscapeUri</td><td>old</td><td>100000</td><td>Alternating</td><td align="right">151,358,658.00 ns</td><td align="right">1.00</td><td align="right">615528920 B</td></tr></tbody></table><div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span><span class="pl-en">BenchmarkDotNet</span>.<span class="pl-en">Attributes</span>;
<span class="pl-k">using</span><span class="pl-en">BenchmarkDotNet</span>.<span class="pl-en">Diagnosers</span>;
<span class="pl-k">using</span><span class="pl-en">BenchmarkDotNet</span>.<span class="pl-en">Running</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Linq</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Text</span>;

[<span class="pl-en">MemoryDiagnoser</span>]
<span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">Program</span>
{
    <span class="pl-k">static</span><span class="pl-k">void</span><span class="pl-en">Main</span>(<span class="pl-k">string</span>[] <span class="pl-smi">args</span>) <span class="pl-k">=&gt;</span><span class="pl-smi">BenchmarkSwitcher</span>.<span class="pl-en">FromTypes</span>(<span class="pl-k">new</span>[] { <span class="pl-k">typeof</span>(<span class="pl-en">Program</span>) }).<span class="pl-en">Run</span>(<span class="pl-smi">args</span>);

    [<span class="pl-en">Params</span>(<span class="pl-c1">10</span>, <span class="pl-c1">100</span>, <span class="pl-c1">100_000</span>)]
    <span class="pl-k">public</span><span class="pl-k">int</span><span class="pl-smi">Length</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }

    [<span class="pl-en">Params</span>(<span class="pl-smi">InputKind</span>.<span class="pl-smi">Unreserved</span>, <span class="pl-smi">InputKind</span>.<span class="pl-smi">Unicode</span>, <span class="pl-smi">InputKind</span>.<span class="pl-smi">OneReservedThenUnreserved</span>, <span class="pl-smi">InputKind</span>.<span class="pl-smi">Alternating</span>)]
    <span class="pl-k">public</span><span class="pl-en">InputKind</span><span class="pl-smi">Kind</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }

    <span class="pl-k">public</span><span class="pl-k">enum</span><span class="pl-en">InputKind</span>
    {
        <span class="pl-en">Unreserved</span>, <span class="pl-en">Unicode</span>, <span class="pl-en">OneReservedThenUnreserved</span>, <span class="pl-en">Alternating</span>
    }

    [<span class="pl-en">GlobalSetup</span>]
    <span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Setup</span>()
    {
        <span class="pl-k">switch</span> (<span class="pl-smi">Kind</span>)
        {
            <span class="pl-k">case</span><span class="pl-smi">InputKind</span>.<span class="pl-smi">Unreserved</span>: <span class="pl-smi">_input</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-k">string</span>(<span class="pl-s">'s'</span>, <span class="pl-smi">Length</span>); <span class="pl-k">break</span>;
            <span class="pl-k">case</span><span class="pl-smi">InputKind</span>.<span class="pl-smi">Unicode</span>: <span class="pl-smi">_input</span><span class="pl-k">=</span><span class="pl-smi">string</span>.<span class="pl-en">Concat</span>(<span class="pl-smi">Enumerable</span>.<span class="pl-en">Repeat</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\x</span>D83D<span class="pl-cce">\x</span>DE00<span class="pl-pds">"</span></span>, <span class="pl-smi">Length</span>)); <span class="pl-k">break</span>;
            <span class="pl-k">case</span><span class="pl-smi">InputKind</span>.<span class="pl-smi">OneReservedThenUnreserved</span>: <span class="pl-smi">_input</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>&lt;<span class="pl-pds">"</span></span><span class="pl-k">+</span><span class="pl-k">new</span><span class="pl-k">string</span>(<span class="pl-s">'s'</span>, <span class="pl-smi">Length</span><span class="pl-k">-</span><span class="pl-c1">1</span>); <span class="pl-k">break</span>;
            <span class="pl-k">case</span><span class="pl-smi">InputKind</span>.<span class="pl-smi">Alternating</span>:
                <span class="pl-k">var</span><span class="pl-smi">sb</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">StringBuilder</span>(<span class="pl-smi">Length</span>);
                <span class="pl-k">for</span> (<span class="pl-k">int</span><span class="pl-smi">i</span><span class="pl-k">=</span><span class="pl-c1">0</span>; <span class="pl-smi">i</span><span class="pl-k">&lt;</span><span class="pl-smi">Length</span>; <span class="pl-smi">i</span><span class="pl-k">++</span>)
                {
                    <span class="pl-k">switch</span> (<span class="pl-smi">i</span><span class="pl-k">%</span><span class="pl-c1">3</span>)
                    {
                        <span class="pl-k">case</span><span class="pl-c1">0</span>: <span class="pl-smi">sb</span>.<span class="pl-en">Append</span>(<span class="pl-s">'s'</span>); <span class="pl-k">break</span>;
                        <span class="pl-k">case</span><span class="pl-c1">1</span>: <span class="pl-smi">sb</span>.<span class="pl-en">Append</span>(<span class="pl-s">'&lt;'</span>); <span class="pl-k">break</span>;
                        <span class="pl-k">default</span>: <span class="pl-smi">sb</span>.<span class="pl-en">Append</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\x</span>D83D<span class="pl-cce">\x</span>DE00<span class="pl-pds">"</span></span>); <span class="pl-k">break</span>;
                    }
                }
                <span class="pl-smi">_input</span><span class="pl-k">=</span><span class="pl-smi">sb</span>.<span class="pl-en">ToString</span>();
                <span class="pl-k">break</span>;
        }
    }

    <span class="pl-k">private</span><span class="pl-k">string</span><span class="pl-smi">_input</span>;

    [<span class="pl-en">Benchmark</span>] <span class="pl-k">public</span><span class="pl-k">string</span><span class="pl-en">EscapeData</span>() <span class="pl-k">=&gt;</span><span class="pl-smi">Uri</span>.<span class="pl-en">EscapeDataString</span>(<span class="pl-smi">_input</span>);
    [<span class="pl-en">Benchmark</span>] <span class="pl-k">public</span><span class="pl-k">string</span><span class="pl-en">EscapeUri</span>() <span class="pl-k">=&gt;</span><span class="pl-smi">Uri</span>.<span class="pl-en">EscapeUriString</span>(<span class="pl-smi">_input</span>);
}</pre></div><p>cc: <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/davidsh/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/davidsh">@davidsh</a>, <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/GrabYourPitchforks/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/GrabYourPitchforks">@GrabYourPitchforks</a>, <a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/alnikola/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/alnikola">@alnikola</a></p><p><a class="user-mention" data-hovercard-type="user" data-hovercard-url="/users/alnikola/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/alnikola">@alnikola</a>, I realize this conflicts with your PR.  Apologies.  But seeing your PR is what led me to want to do this.  I suggest we look at doing something similar to this PR for the "Unescape" paths as well.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>