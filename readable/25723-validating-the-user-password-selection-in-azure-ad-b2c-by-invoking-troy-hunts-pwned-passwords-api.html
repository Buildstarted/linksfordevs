<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Validating the user password selection in Azure AD B2C by invoking Troy Hunt&#x2019;s &#x201C;Pwned Passwords&#x201D; API -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Validating the user password selection in Azure AD B2C by invoking Troy Hunt’s “Pwned Passwords” API</h1><div><div class="ac ae af ag ah ef aj ak"><figure class="gl gm gn go gp gq dr ds paragraph-image"><p id="af2a" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">I recently gave a <a href="https://www.meetup.com/Auckland-Azure-Lunchtime-Meetup/events/260558096/" class="df by hs ht hu hv" target="_blank" rel="noopener nofollow">presentation</a> on Azure AD B2C custom policies.</p><p id="a529" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">The collateral for the demo. is on <a href="https://rbrayb.github.io/Presentations/A-lap-around-Azure-AD-B2C-custom-policies/" class="df by hs ht hu hv" target="_blank" rel="noopener nofollow">Github pages</a>.</p><p id="9672" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">As part of this, I was looking for a killer demo. to demonstrate a B2C SignInSignUp user journey calling a <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-custom-rest-api-netfw" class="df by hs ht hu hv" target="_blank" rel="noopener nofollow">REST API</a> from custom policies during a sign-up flow.</p><p id="e684" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">In Azure AD, if you pick a new password that is suspect because it appears in so many breaches (e.g. “Password123”), you get a message saying:</p><p id="54fc" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea"><em class="hw">“We’ve seen this password too many times. Please pick a more secure one”</em></p><p id="5e6e" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">This feature is not yet on B2C and I realised that I could implement this using “<a href="https://haveibeenpwned.com/Passwords" class="df by hs ht hu hv" target="_blank" rel="noopener nofollow">Pwned Passwords</a>”.</p><p id="3156" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">This is described in much more detail <a href="https://www.troyhunt.com/ive-just-launched-pwned-passwords-version-2/#cloudflareprivacyandkanonymity" class="df by hs ht hu hv" target="_blank" rel="noopener nofollow">here</a>.</p><p id="d89d" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">This is invoked by the API:</p><pre class="gl gm gn go gp hx hy cs"><span id="16ed" class="hz ia cm at ib b fk ic id r ie">https://api.pwnedpasswords.com/range/{hashPrefix}</span></pre><p id="2c2b" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">Essentially, you hash the password using SHA1 and then use the first five digits as the hash prefix.</p><p id="c9e7" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea"><a href="https://api.pwnedpasswords.com/range/12345" class="df by hs ht hu hv" target="_blank" rel="noopener nofollow"><em class="hw">https://api.pwnedpasswords.com/range/12345</em></a></p><p id="c8ad" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">returns:</p><figure class="gl gm gn go gp gq dr ds paragraph-image"><p id="702b" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">This is just a part of it but essentially each line is the rest of the hash (i.e. minus the first five characters) and the number of times each hash has appeared in a breach.</p><p id="6fab" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">We could use this by having B2C call an Azure webAPI (a REST API) and the REST API could then call <a href="https://api.pwnedpasswords.com/range/12345" class="df by hs ht hu hv" target="_blank" rel="noopener nofollow">api.pwnedpasswords.com</a>.</p><p id="9ccb" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">The TrustFrameworkExtensions.xml custom policy (in the collateral above) looks like:</p><figure class="gl gm gn go gp gq"><blockquote class="ii ij ik"><p id="51ef" class="he hf cm hw hg b hh hi hj hk hl hm hn ho hp hq hr ea">&lt;Item Key=”ServiceUrl”&gt;https://mywebapplication.azurewebsites.net/api/Identity/CheckPassword&lt;/Item&gt;</p><p id="54ab" class="he hf cm hw hg b hh hi hj hk hl hm hn ho hp hq hr ea">&lt;Item Key=”AuthenticationType”&gt;None&lt;/Item&gt;</p><p id="f45e" class="he hf cm hw hg b hh hi hj hk hl hm hn ho hp hq hr ea">&lt;Item Key=”SendClaimsIn”&gt;QueryString&lt;/Item&gt;</p></blockquote><p id="da06" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">The “ServiceURL” contains the URL of the web API.</p><p id="c470" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">There is no authentication so “AuthenticationType” is “None”.</p><p id="8b7a" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">It’s a GET request so we send the claims in the “QueryString”.</p><p id="6c10" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">We map “NewPassword” to “password” so the API call looks like:</p><p id="4f72" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea"><em class="hw">?password=password123</em></p><p id="9cce" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">The user journey calls “LocalAccountSignUpWithLogonEmail”</p><p id="1ead" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">We extend this technical profile by adding a validation technical profile that calls the “REST-API-PwnedPassword” technical profile and this calls the Azure web API.</p><p id="1f75" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">The Azure webAPI code (in the collateral above) is:</p><figure class="gl gm gn go gp gq"><p id="69d9" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">So we hash the password, send off the first five characters to the API, get the response and then search for the rest of the hash. Once we get the correct line, we get the number of times that password has appeared in a breach.</p><p id="fea0" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">If it has appeared, we send an error message back to B2C with a “ HttpStatusCode.Conflict” code that tells B2C to display the error and stop the user journey.</p><p id="9efd" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">The technical profile “LocalAccountSignUpWithLogonEmail” has two claims added to it.</p><blockquote class="ii ij ik"><p id="c2a9" class="he hf cm hw hg b hh hi hj hk hl hm hn ho hp hq hr ea">&lt;! — Optional claims, to be collected from the user →<br>&lt;OutputClaim ClaimTypeReferenceId=”extension_ugName” /&gt;<br>&lt;OutputClaim ClaimTypeReferenceId=”extension_ugVenue” /&gt;</p></blockquote><p id="8771" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">As this is a self-asserted technical profile (i.e. the user is expected to provide some input), these fields will appear on the sign-up form.</p><p id="8183" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">Let’s see what happens when we run the sign-up journey.</p><p id="9fed" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">We’ve added some branding so we see:</p><figure class="gl gm gn go gp gq dr ds paragraph-image"><p id="8c30" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">We click “Sign up now”:</p><figure class="gl gm gn go gp gq dr ds paragraph-image"><p id="f17f" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">Notice the two new textboxes containing the user group information “ugName” and “ugVenue”.</p><p id="bf15" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">We use password “Password123”.</p><figure class="gl gm gn go gp gq dr ds paragraph-image"><p id="4337" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">And we get the “Pwned Password” error!</p><p id="1ee8" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">If we enter a password that has not appeared in a breach, we get the JWT back with the user group fields.</p><figure class="gl gm gn go gp gq dr ds paragraph-image"><p id="e4b6" class="he hf cm at hg b hh hi hj hk hl hm hn ho hp hq hr ea">All good!</p></figure></figure></figure></figure></figure></figure></figure></figure></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>