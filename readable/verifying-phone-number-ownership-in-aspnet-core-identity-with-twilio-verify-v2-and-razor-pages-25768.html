<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Verifying Phone Number Ownership in ASP.NET Core Identity with Twilio Verify v2 and Razor Pages - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Verifying Phone Number Ownership in ASP.NET Core Identity with Twilio Verify v2 and Razor Pages - linksfor.dev(s)"/>
    <meta property="article:author" content="By Andrew Lock&#xA;      2019-05-31"/>
    <meta property="og:description" content="Learn to verify phone number ownership using ASP.NET Core Identity and Twilio Verify version 2."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.twilio.com/blog/verify-phone-number-ownership-asp-net-core-razor-pages"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Verifying Phone Number Ownership in ASP.NET Core Identity with Twilio Verify v2 and Razor Pages</title>
<div class="readable">
        <h1>Verifying Phone Number Ownership in ASP.NET Core Identity with Twilio Verify v2 and Razor Pages</h1>
            <div>by By Andrew Lock&#xA;      2019-05-31</div>
            <div>Reading time: 21-26 minutes</div>
        <div>Posted here: 04 Jun 2019</div>
        <p><a href="https://www.twilio.com/blog/verify-phone-number-ownership-asp-net-core-razor-pages">https://www.twilio.com/blog/verify-phone-number-ownership-asp-net-core-razor-pages</a></p>
        <hr/>
<div id="readability-page-1" class="page"><section>
    
    
      <div><p>ASP.NET Core Identity is a membership system that adds user sign in and user management functionality to ASP.NET Core apps. It includes many features out of the box and has basic support for storing a phone number for a user. By default, ASP.NET Core Identity doesn't try to verify ownership of phone numbers, but you can add that functionality yourself by integrating Twilio’s identity verification features into your application.</p>
<p>In this post you'll learn how you can prove ownership of a phone number provided by a user using <a href="https://www.twilio.com/verify">Twilio Verify</a>&nbsp;in an ASP.NET Core application using Razor Pages. This involves sending a code in an SMS message to the provided phone number. The user enters the code received and Twilio confirms whether it is correct. If so, you can be confident the user has control of the provided phone number.</p>
<p>You typically only confirm phone number ownership once for a user. This is in contrast to two-factor authentication (2FA) where you might send an SMS code to the user every time they login. Twilio has a separate <a href="https://www.twilio.com/docs/authy">Authy API</a>&nbsp;for performing 2FA checks at sign in, but it won't be covered in this post.</p>
<p>Note that this post uses <a href="https://www.twilio.com/docs/verify/api-beta/migrating-1x-2x">version 2.x</a>&nbsp;of the Twilio Verify API. <a href="https://www.twilio.com/blog/verifying-phone-number-ownership-asp-net-core-identity-razor-pages">A previous post on the Twilio blog</a>&nbsp;shows how to use <a href="https://www.twilio.com/docs/verify">version 1 of the API </a>.</p>
<h2>Prerequisites</h2>
<p>To follow along with this post you'll need:</p>
<ul>
<li>A Twilio account (<a href="https://www.twilio.com/try-twilio" data-glinktype="blog post" data-glinklocation="blog:Verifying Phone Number Ownership in ASP.NET Core Identity with Twilio Verify v2 and Razor Pages" data-glinkname="sign up">sign up for a free Twilio account here</a>)</li>
<li>A &nbsp;Twilio Verify Service (<a href="https://www.twilio.com/console/verify/services">create a new Verify Service here</a>)</li>
<li>.NET Core 2.2 SDK (<a href="https://dotnet.microsoft.com/download">version 2.2.102 or greater</a>)</li>
<li><a href="https://code.visualstudio.com/">VS Code</a>, <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 2017/2019</a>, or other editor</li>
<li>A familiarity with Razor Pages (see a previous post for <a href="https://www.twilio.com/blog/introduction-asp-net-core-razor-pages">an introduction to Razor Pages)</a></li>
</ul>
<p>You can find the complete code for this post <a href="https://github.com/andrewlock/TwilioSamples/tree/master/SendVerificationSmsV2Demo">on GitHub</a>.</p>
<h2>Creating the case study project</h2>
<p>Using Visual Studio 2017+ or the .NET CLI, create a new solution and project with the following characteristics:</p>
<ul>
<li>Type: ASP.NET Core 2.2 Web Application (not MVC) with Visual C#</li>
<li>Name: SendVerificationSmsV2Demo</li>
<li>Solution directory / uncheck Place solution and project in the same directory</li>
<li>Git repository</li>
<li>https</li>
<li>Authentication: Individual user accounts, Store user accounts in-app</li>
</ul>
<p>ASP.NET Core Identity uses <a href="https://docs.microsoft.com/en-us/ef/core/">Entity Framework Core</a>&nbsp;to store the users in the database, so be sure to run the database migrations in the project folder after building your app. Execute one of the following command line instructions to build the database:</p>
<p><strong>.NET CLI</strong></p></div>
    
      

<div>
    <div><pre><span><span>dotnet</span> <span>ef</span> <span>database</span> <span>update</span>
</span></pre></div>
</div>

    
      <p><strong>Package Manager Console</strong></p>
    
      



    
      <div><h2>The Twilio C# SDK and the Twilio Verify API</h2>
<p>The Twilio API is a typical REST API, but to make it easier to work with Twilio provides helper SDK libraries in a variety of languages. Previous posts have shown how to use the C# SDK <a href="https://www.twilio.com/blog/validate-phone-numbers-asp-net-core-identity-razor-pages-lookup">to validate phone numbers</a>, and <a href="https://www.twilio.com/blog/dependency-injection-twilio-sms-asp-net-core-2-1">how to customize it to work with the ASP.NET Core dependency injection container</a>.</p>
<p>Version 1.x of the Twilio Verify API was not supported by the C# SDK, so you had to make "raw" HTTP requests with an <code>HttpClient</code>. Luckily the SDK has been updated to work with version 2 of the Verify API, which drastically simplifies interacting with the API. Version 2 of the API also allows working with <a href="https://www.twilio.com/docs/glossary/what-e164">E.164 formatted numbers</a>.</p>
<h2>Initializing the Twilio API</h2>
<p>Install the Twilio C# SDK by installing the <a href="https://www.nuget.org/packages/Twilio/">Twilio NuGet package</a>&nbsp;(version 5.29.1 or later) using the NuGet Package Manager, Package Manager Console CLI, or by editing the <em>SendVerificationSmsV2Demo.csproj</em>&nbsp;file. After using any of these methods the <code>&lt;ItemGroup&gt;</code> section of the project file should look like this (version numbers may be higher):</p></div>
    
      

<div>
    <div><pre><span><span>&lt;ItemGroup&gt;</span>
</span><span> <span>&lt;PackageReference</span> <span>Include=</span><span>"Microsoft.AspNetCore.App"</span><span>/&gt;</span>
</span><span> <span>&lt;PackageReference</span> <span>Include=</span><span>"Microsoft.AspNetCore.Razor.Design"</span> <span>Version=</span><span>"2.2.0"</span> <span>PrivateAssets=</span><span>"All"</span> <span>/&gt;</span>
</span><span> <span>&lt;PackageReference</span> <span>Include=</span><span>"Twilio"</span> <span>Version=</span><span>"5.29.1"</span> <span>/&gt;</span>
</span><span><span>&lt;/ItemGroup&gt;</span>
</span></pre></div>
</div>

    
      <p>To call the Twilio API you'll need your Twilio Account SID and Auth Token (found in the <a href="https://www.twilio.com/console">Twilio Dashboard</a>). When developing locally these should be stored using the Secrets Manager or as environment variables so they don't get accidentally committed to your source code repository. You can read about how and why to use the Secrets Manager in <a href="https://www.twilio.com/blog/2018/05/user-secrets-in-a-net-core-web-app.html">this post on the Twilio Blog</a>. You'll also need the Service SID for your Twilio Verify Service (found under Settings for the Verify Service you created, in the Verify section of the <a href="https://www.twilio.com/console/verify/services">Twilio Dashboard</a>). Your resulting <em>Secrets.json</em>&nbsp;should look something like this:</p>
    
      

<div>
    <div><pre><span><span>{</span>
</span><span> <span>"Twilio"</span><span>:</span> <span>{</span>
</span><span>   <span>"AccountSID"</span><span>:</span> <span>"ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span><span>,</span>
</span><span>   <span>"AuthToken"</span><span>:</span> <span>"your_auth_token"</span><span>,</span>
</span><span>   <span>"VerificationServiceSID"</span><span>:</span> <span>"VAxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
</span><span> <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>

    
      <p>The Twilio helper libraries use a singleton instance of the Twilio client, which means you only need to set it up once in your app. The best place to configure things like this are in the <em>Startup.cs</em>&nbsp;file. Add <code>using Twilio;</code> at the top of <em>Startup.cs</em>, and add the following at the end of <code>ConfigureServices</code>:</p>
    
      

<div>
    <div><pre><span><span>public</span> <span>void</span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> <span>services</span><span>)</span>
</span><span><span>{</span>
</span><span>   <span>// existing configuration</span>
</span><span>
</span><span>   <span>var</span> <span>accountSid</span> <span>=</span> <span>Configuration</span><span>[</span><span>"Twilio:AccountSID"</span><span>];</span>
</span><span>   <span>var</span> <span>authToken</span> <span>=</span> <span>Configuration</span><span>[</span><span>"Twilio:AuthToken"</span><span>];</span>
</span><span>   <span>TwilioClient</span><span>.</span><span>Init</span><span>(</span><span>accountSid</span><span>,</span> <span>authToken</span><span>);</span>
</span><span><span>}</span>
</span></pre></div>
</div>

    
      <div><p>This sets up the static Twilio client using your credentials using <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration">the ASP.NET Core configuration system</a>. If you need to customize the requests made to Twilio (by using a proxy server, for example), or want to make use of <code>HttpClientFactory</code> features introduced in ASP.NET Core 2.1, see <a href="https://www.twilio.com/blog/dependency-injection-twilio-sms-asp-net-core-2-1">a previous post on the Twilio blog</a>&nbsp;for an alternative approach.</p>
<p>You also need to make the Verify Service ID accessible in the app, so <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options">create a strongly-typed Options object</a>&nbsp;and bind the settings to it. Create the file <em>TwilioVerifySettings.cs</em>&nbsp;in the project directory and add the following code:</p></div>
    
      

<div>
    <div><pre><span><span>public</span> <span>class</span> <span>TwilioVerifySettings</span>
</span><span><span>{</span>
</span><span>   <span>public</span> <span>string</span> <span>VerificationServiceSID</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>

    
      <p>You can bind this class to the configuration object so it's accessible from everywhere via the dependency injection container. Add the following line to the end of the <code>Startup.ConfigureServices</code> method:</p>
    
      

<div>
    <div><pre><span><span>services</span><span>.</span><span>Configure</span><span>&lt;</span><span>TwilioVerifySettings</span><span>&gt;(</span><span>Configuration</span><span>.</span><span>GetSection</span><span>(</span><span>"Twilio"</span><span>));</span>
</span></pre></div>
</div>

    
      <div><p>With the Twilio SDK configuration complete, you can start adding the phone verification functionality to your ASP.NET Core Identity application.</p>
<h2>Adding the required scaffolding files</h2>
<p>In this post you're going to be adding some additional pages to the Identity area. Typically when you're adding or editing Identity pages in ASP.NET Core you should use the built-in scaffolding tools to generate the pages, as shown in <a href="https://www.twilio.com/blog/validate-phone-numbers-asp-net-core-identity-razor-pages-lookup">this post</a>. If you've already done that, you can skip this section.</p>
<p>Rather than adding all the Identity scaffolding, all you need for this post is a single file. Create the file <em>_ViewImports.cshtml</em>&nbsp;in the <em>Areas/Identity/Pages</em>&nbsp;folder and add the following code:</p></div>
    
      

<div>
    <div><pre><span><span>@using</span> <span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Identity</span>
</span><span><span>@using</span> <span>SendVerificationSmsV2Demo</span><span>.</span><span>Areas</span><span>.</span><span>Identity</span>
</span><span><span>@namespace</span> <span>SendVerificationSmsV2Demo</span><span>.</span><span>Areas</span><span>.</span><span>Identity</span><span>.</span><span>Pages</span>
</span><span><span>@addTagHelper</span> <span>*,</span> <span>Microsoft</span><span>.</span><span>AspNetCore</span><span>.</span><span>Mvc</span><span>.</span><span>TagHelpers</span>
</span></pre></div>
</div>

    
      <div><p>This adds all the namespaces and tag helpers required by your Razor Pages. It will also light up the IntelliSense in Visual Studio. If you've already scaffolded Identity pages you'll already have this file!</p>
<h2>Sending a verification code to a phone number</h2>
<p>The default ASP.NET Core Identity templates provide the functionality for <em>storing</em>&nbsp;a phone number for a user, but don't provide the capability to <em>verify ownership</em>&nbsp;of the number. In the post <a href="https://www.twilio.com/blog/validate-phone-numbers-asp-net-core-identity-razor-pages-lookup">Validating Phone Numbers in ASP.NET Core Identity Razor Pages with Twilio Lookup</a>&nbsp;you can learn how to <em>validate</em>&nbsp;a phone number by using the <a href="https://www.twilio.com/docs/lookup/api">Twilio Lookup API</a>.</p>
<p>As noted in the previous post, it’s a good idea to store the result formatted as <a href="https://www.twilio.com/docs/glossary/what-e164">an E.164 number</a>. This post assume you've done that so the <code>PhoneNumber</code> property for an <code>IdentityUser</code> is the E.164 formatted phone number.</p>
<p>Create a new folder <em>Account</em>, under the <em>Areas/Identity/Pages</em>&nbsp;folder, and add a&nbsp;new Razor Page in the folder&nbsp;called <em>VerifyPhone.cshtml</em>. Replace the <code>VerifyPhoneModel</code> class in the code-behind file <em>VerifyPhone.cshtml.cs</em>&nbsp;with the following:</p></div>
    
      

<div>
    <div><pre><span><span>using</span> <span>System</span><span>;</span>
</span><span><span>using</span> <span>System.Threading.Tasks</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Authorization</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Identity</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Mvc</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Mvc.RazorPages</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Options</span><span>;</span>
</span><span><span>using</span> <span>Twilio.Rest.Verify.V2.Service</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>SendVerificationSmsV2Demo.Areas.Identity.Pages.Account</span>
</span><span><span>{</span>
</span><span><span>   [Authorize]</span>
</span><span>   <span>public</span> <span>class</span> <span>VerifyPhoneModel</span> <span>:</span> <span>PageModel</span>
</span><span>   <span>{</span>
</span><span>       <span>private</span> <span>readonly</span> <span>TwilioVerifySettings</span> <span>_settings</span><span>;</span>
</span><span>       <span>private</span> <span>readonly</span> <span>UserManager</span><span>&lt;</span><span>IdentityUser</span><span>&gt;</span> <span>_userManager</span><span>;</span>
</span><span>
</span><span>       <span>public</span> <span>VerifyPhoneModel</span><span>(</span><span>IOptions</span><span>&lt;</span><span>TwilioVerifySettings</span><span>&gt;</span> <span>settings</span><span>,</span> <span>UserManager</span><span>&lt;</span><span>IdentityUser</span><span>&gt;</span> <span>userManager</span><span>)</span>
</span><span>       <span>{</span>
</span><span>           <span>_settings</span> <span>=</span> <span>settings</span><span>.</span><span>Value</span><span>;</span>
</span><span>           <span>_userManager</span> <span>=</span> <span>userManager</span><span>;</span>
</span><span>       <span>}</span>
</span><span>
</span><span>       <span>public</span> <span>string</span> <span>PhoneNumber</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>
</span><span>       <span>public</span> <span>async</span> <span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span> <span>OnGetAsync</span><span>()</span>
</span><span>       <span>{</span>
</span><span>           <span>await</span> <span>LoadPhoneNumber</span><span>();</span>
</span><span>           <span>return</span> <span>Page</span><span>();</span>
</span><span>       <span>}</span>
</span><span>
</span><span>       <span>public</span> <span>async</span> <span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span> <span>OnPostAsync</span><span>()</span>
</span><span>       <span>{</span>
</span><span>           <span>await</span> <span>LoadPhoneNumber</span><span>();</span>
</span><span>
</span><span>           <span>try</span>
</span><span>           <span>{</span>
</span><span>               <span>var</span> <span>verification</span> <span>=</span> <span>await</span> <span>VerificationResource</span><span>.</span><span>CreateAsync</span><span>(</span>
</span><span>                   <span>to</span><span>:</span> <span>PhoneNumber</span><span>,</span>
</span><span>                   <span>channel</span><span>:</span> <span>"sms"</span><span>,</span>
</span><span>                   <span>pathServiceSid</span><span>:</span> <span>_settings</span><span>.</span><span>VerificationServiceSID</span>
</span><span>               <span>);</span>
</span><span>
</span><span>               <span>if</span> <span>(</span><span>verification</span><span>.</span><span>Status</span> <span>==</span> <span>"pending"</span><span>)</span>
</span><span>               <span>{</span>
</span><span>                   <span>return</span> <span>RedirectToPage</span><span>(</span><span>"ConfirmPhone"</span><span>);</span>
</span><span>               <span>}</span>
</span><span>
</span><span>               <span>ModelState</span><span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span> <span>$</span><span>"There was an error sending the verification code: {verification.Status}"</span><span>);</span>
</span><span>           <span>}</span>
</span><span>           <span>catch</span> <span>(</span><span>Exception</span><span>)</span>
</span><span>           <span>{</span>
</span><span>               <span>ModelState</span><span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span>
</span><span>                   <span>"There was an error sending the verification code, please check the phone number is correct and try again"</span><span>);</span>
</span><span>           <span>}</span>
</span><span>
</span><span>           <span>return</span> <span>Page</span><span>();</span>
</span><span>       <span>}</span>
</span><span>
</span><span>       <span>private</span> <span>async</span> <span>Task</span> <span>LoadPhoneNumber</span><span>()</span>
</span><span>       <span>{</span>
</span><span>           <span>var</span> <span>user</span> <span>=</span> <span>await</span> <span>_userManager</span><span>.</span><span>GetUserAsync</span><span>(</span><span>User</span><span>);</span>
</span><span>           <span>if</span> <span>(</span><span>user</span> <span>==</span> <span>null</span><span>)</span>
</span><span>           <span>{</span>
</span><span>               <span>throw</span> <span>new</span> <span>Exception</span><span>(</span><span>$</span><span>"Unable to load user with ID '{_userManager.GetUserId(User)}'."</span><span>);</span>
</span><span>           <span>}</span>
</span><span>           <span>PhoneNumber</span> <span>=</span> <span>user</span><span>.</span><span>PhoneNumber</span><span>;</span>
</span><span>       <span>}</span>
</span><span>   <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>

    
      <div><p>The phone number for the current user is loaded in the <code>OnGetAsync</code> using the <code>LoadPhoneNumber</code> helper method, and is assigned to the <code>PhoneNumber</code> property for display in the UI. The <code>OnPostAsync</code> handler is where the verification process begins.</p>
<p>The phone number is loaded again at the start of the <code>OnPostAsync</code> method and used to send a verification message with the Twilio helper SDK. The <code>VerificationResource.CreateAsync</code> method sends a verification code to the provided number using the Twilio Verify API. When calling this method you also need to provide the Verify Service ID. You retrieve the value from configuration by injecting an <code>IOptions&lt;TwilioVerifySettings&gt;</code> into the page constructor using the <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options">Options pattern</a>.</p>
<p>The response from the Twilio Verify API contains a <code>Status</code> field indicating the overall status of the verification process. If the message is sent successfully, the response will return <code>"pending"</code>, indicating that a check is waiting to be performed. On success, the user is redirected to the <code>ConfirmPhone</code> page, which you'll create shortly. If the Verify API indicates the request failed, or if an exception is thrown, an error is added to the <code>ModelState</code>, and the page is re-displayed to the user.</p>
<p>The form itself consists of just a message and a submit button. Replace the contents of <em>VerifyPhone.cshtml</em>&nbsp;with the following Razor markup:</p></div>
    
      

<div>
    <div><pre><span>@page
</span><span>@model VerifyPhoneModel
</span><span>@{
</span><span>   ViewData["Title"] = "Verify Phone number";
</span><span>}
</span><span>
</span><span><span>&lt;</span><span>h4</span><span>&gt;</span>@ViewData["Title"]<span>&lt;/</span><span>h4</span><span>&gt;</span>
</span><span><span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"row"</span><span>&gt;</span>
</span><span>   <span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"col-md-8"</span><span>&gt;</span>
</span><span>       <span>&lt;</span><span>form</span> <span>method</span><span>=</span><span>"post"</span><span>&gt;</span>
</span><span>           <span>&lt;</span><span>p</span><span>&gt;</span>
</span><span>               We will verify your phone number by sending a code to @Model.PhoneNumber.
</span><span>           <span>&lt;/</span><span>p</span><span>&gt;</span>
</span><span>           <span>&lt;</span><span>div</span> <span>asp-validation-summary</span><span>=</span><span>"All"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span>
</span><span>           <span>&lt;</span><span>button</span> <span>type</span><span>=</span><span>"submit"</span> <span>class</span><span>=</span><span>"btn btn-primary"</span><span>&gt;</span>Send verification code<span>&lt;/</span><span>button</span><span>&gt;</span>
</span><span>       <span>&lt;/</span><span>form</span><span>&gt;</span>
</span><span>   <span>&lt;/</span><span>div</span><span>&gt;</span>
</span><span><span>&lt;/</span><span>div</span><span>&gt;</span>
</span></pre></div>
</div>

    
      <div><p>When rendered, the form looks like the following:</p>
<p><img alt="Verify phone number form" height="191" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/wIL__BLMqn6gPvDNjRl-Q61d1KsWw8B0VbVgXAzn13R6kb.width-800.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/wIL__BLMqn6gPvDNjRl-Q61d1KsWw8B0VbVgXAzn13R6kb.width-800.png 800w, https://twilio-cms-prod.s3.amazonaws.com/images/wIL__BLMqn6gPvDNjRl-Q61d1KsWw8B0VbVgXAzn13R6k.width-1600.png 1085w" width="800"></p>
<p>To test the form, sign in to your app, navigate to <em>/Identity/Account/Manage</em>&nbsp;and add your phone number to the account. Remember to use an <a href="https://www.twilio.com/docs/glossary/what-e164">E.164 formatted number</a>&nbsp;that includes your country code, for example +14155552671, and remember to click <strong>Save</strong>&nbsp;so the number is written to the database.&nbsp;</p>
<p>Next, navigate to <em>/Identity/Account/VerifyPhone</em>&nbsp;in your browser's address bar and click <strong>Send verification code</strong>. If your phone number is valid, you’ll receive an SMS similar to the message shown below. Note that you can customize this message, including the service name and code length: see the <a href="https://www.twilio.com/docs/verify/api-beta/service-beta">Verify API documentation for details</a>.</p></div>
    
      

<div>
    <div><pre><span><span>Your Twilio Verify API demo verification code is: 293312</span>
</span></pre></div>
</div>

    
      <div><p>At this point, your app will crash, as it’s trying to redirect to a page that doesn’t exist yet. Now you’ll need to create that page where the user enters the code they receive.</p>
<h2>Checking the verification code</h2>
<p>The check verification code page contains a single text box where the user enters the code they receive. Create a new Razor Page in the <em>Areas/Identity/Pages/Account</em>&nbsp;folder called <em>ConfirmPhone.cshtml</em>. In the code-behind file, <em>ConfirmPhone.cshtml.cs,</em>&nbsp;replace the <code>ConfirmPhoneModel</code> class with the following code:</p></div>
    
      

<div>
    <div><pre><span><span>using</span> <span>System</span><span>;</span>
</span><span><span>using</span> <span>System.ComponentModel.DataAnnotations</span><span>;</span>
</span><span><span>using</span> <span>System.Threading.Tasks</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Authorization</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Identity</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Mvc</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.AspNetCore.Mvc.RazorPages</span><span>;</span>
</span><span><span>using</span> <span>Microsoft.Extensions.Options</span><span>;</span>
</span><span><span>using</span> <span>Twilio.Rest.Verify.V2.Service</span><span>;</span>
</span><span>
</span><span><span>namespace</span> <span>SendVerificationSmsV2Demo.Areas.Identity.Pages.Account</span>
</span><span><span>{</span>
</span><span><span>   [Authorize]</span>
</span><span>   <span>public</span> <span>class</span> <span>ConfirmPhoneModel</span> <span>:</span> <span>PageModel</span>
</span><span>   <span>{</span>
</span><span>       <span>private</span> <span>readonly</span> <span>TwilioVerifySettings</span> <span>_settings</span><span>;</span>
</span><span>       <span>private</span> <span>readonly</span> <span>UserManager</span><span>&lt;</span><span>IdentityUser</span><span>&gt;</span> <span>_userManager</span><span>;</span>
</span><span>
</span><span>       <span>public</span> <span>ConfirmPhoneModel</span><span>(</span><span>UserManager</span><span>&lt;</span><span>IdentityUser</span><span>&gt;</span> <span>userManager</span><span>,</span> <span>IOptions</span><span>&lt;</span><span>TwilioVerifySettings</span><span>&gt;</span> <span>settings</span><span>)</span>
</span><span>       <span>{</span>
</span><span>           <span>_userManager</span> <span>=</span> <span>userManager</span><span>;</span>
</span><span>           <span>_settings</span> <span>=</span> <span>settings</span><span>.</span><span>Value</span><span>;</span>
</span><span>       <span>}</span>
</span><span>
</span><span>       <span>public</span> <span>string</span> <span>PhoneNumber</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>
</span><span><span>       [BindProperty, Required, Display(Name = "Code")]</span>
</span><span>       <span>public</span> <span>string</span> <span>VerificationCode</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</span><span>
</span><span>
</span><span>       <span>public</span> <span>async</span> <span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span> <span>OnGetAsync</span><span>()</span>
</span><span>       <span>{</span>
</span><span>           <span>await</span> <span>LoadPhoneNumber</span><span>();</span>
</span><span>           <span>return</span> <span>Page</span><span>();</span>
</span><span>       <span>}</span>
</span><span>
</span><span>       <span>public</span> <span>async</span> <span>Task</span><span>&lt;</span><span>IActionResult</span><span>&gt;</span> <span>OnPostAsync</span><span>()</span>
</span><span>       <span>{</span>
</span><span>           <span>await</span> <span>LoadPhoneNumber</span><span>();</span>
</span><span>           <span>if</span> <span>(!</span><span>ModelState</span><span>.</span><span>IsValid</span><span>)</span>
</span><span>           <span>{</span>
</span><span>               <span>return</span> <span>Page</span><span>();</span>
</span><span>           <span>}</span>
</span><span>
</span><span>           <span>try</span>
</span><span>           <span>{</span>
</span><span>               <span>var</span> <span>verification</span> <span>=</span> <span>await</span> <span>VerificationCheckResource</span><span>.</span><span>CreateAsync</span><span>(</span>
</span><span>                   <span>to</span><span>:</span> <span>PhoneNumber</span><span>,</span>
</span><span>                   <span>code</span><span>:</span> <span>VerificationCode</span><span>,</span>
</span><span>                   <span>pathServiceSid</span><span>:</span> <span>_settings</span><span>.</span><span>VerificationServiceSID</span>
</span><span>               <span>);</span>
</span><span>               <span>if</span> <span>(</span><span>verification</span><span>.</span><span>Status</span> <span>==</span> <span>"approved"</span><span>)</span>
</span><span>               <span>{</span>
</span><span>                   <span>var</span> <span>identityUser</span> <span>=</span> <span>await</span> <span>_userManager</span><span>.</span><span>GetUserAsync</span><span>(</span><span>User</span><span>);</span>
</span><span>                   <span>identityUser</span><span>.</span><span>PhoneNumberConfirmed</span> <span>=</span> <span>true</span><span>;</span>
</span><span>                   <span>var</span> <span>updateResult</span> <span>=</span> <span>await</span> <span>_userManager</span><span>.</span><span>UpdateAsync</span><span>(</span><span>identityUser</span><span>);</span>
</span><span>
</span><span>                   <span>if</span> <span>(</span><span>updateResult</span><span>.</span><span>Succeeded</span><span>)</span>
</span><span>                   <span>{</span>
</span><span>                       <span>return</span> <span>RedirectToPage</span><span>(</span><span>"ConfirmPhoneSuccess"</span><span>);</span>
</span><span>                   <span>}</span>
</span><span>                   <span>else</span>
</span><span>                   <span>{</span>
</span><span>                       <span>ModelState</span><span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span> <span>"There was an error confirming the verification code, please try again"</span><span>);</span>
</span><span>                   <span>}</span>
</span><span>               <span>}</span>
</span><span>               <span>else</span>
</span><span>               <span>{</span>
</span><span>                   <span>ModelState</span><span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span> <span>$</span><span>"There was an error confirming the verification code: {verification.Status}"</span><span>);</span>
</span><span>               <span>}</span>
</span><span>           <span>}</span>
</span><span>           <span>catch</span> <span>(</span><span>Exception</span><span>)</span>
</span><span>           <span>{</span>
</span><span>               <span>ModelState</span><span>.</span><span>AddModelError</span><span>(</span><span>""</span><span>,</span>
</span><span>                   <span>"There was an error confirming the code, please check the verification code is correct and try again"</span><span>);</span>
</span><span>           <span>}</span>
</span><span>
</span><span>           <span>return</span> <span>Page</span><span>();</span>
</span><span>       <span>}</span>
</span><span>
</span><span>       <span>private</span> <span>async</span> <span>Task</span> <span>LoadPhoneNumber</span><span>()</span>
</span><span>       <span>{</span>
</span><span>           <span>var</span> <span>user</span> <span>=</span> <span>await</span> <span>_userManager</span><span>.</span><span>GetUserAsync</span><span>(</span><span>User</span><span>);</span>
</span><span>           <span>if</span> <span>(</span><span>user</span> <span>==</span> <span>null</span><span>)</span>
</span><span>           <span>{</span>
</span><span>               <span>throw</span> <span>new</span> <span>Exception</span><span>(</span><span>$</span><span>"Unable to load user with ID '{_userManager.GetUserId(User)}'."</span><span>);</span>
</span><span>           <span>}</span>
</span><span>           <span>PhoneNumber</span> <span>=</span> <span>user</span><span>.</span><span>PhoneNumber</span><span>;</span>
</span><span>       <span>}</span>
</span><span>   <span>}</span>
</span><span><span>}</span>
</span></pre></div>
</div>

    
      <div><p>As before, the <code>OnGetAsync</code> handler loads the current user's phone number for display in the UI using the <code>LoadPhoneNumber</code> helper method. The phone number is loaded again in the <code>OnPostAsync</code> handler for calling the verification check API. You verify the user's code by calling <code>VerificationCheckResource.CreateAsync</code>, passing in the phone number, the provided verification code, and the Verify Service ID.</p>
<p>If the code is correct, the Verify API will return <code>result.Status="approved"</code>. You can store the confirmation result on the <code>IdentityUser</code> object directly by setting the <code>PhoneNumberConfirmed</code> property and saving the changes.</p>
<p>If everything completes successfully, you redirect the user to a simple <code>ConfirmPhoneSuccess</code> page (that you'll create shortly). If there are any errors or exceptions, an error is added to the <code>ModelState</code> and the page is redisplayed.</p>
<p>Replace the contents of <em>ConfirmPhone.cshtml</em>&nbsp;with the Razor markup below:</p></div>
    
      

<div>
    <div><pre><span>@page
</span><span>@model ConfirmPhoneModel
</span><span>@{
</span><span>   ViewData["Title"] = "Confirm Phone number";
</span><span>}
</span><span>
</span><span><span>&lt;</span><span>h4</span><span>&gt;</span>@ViewData["Title"]<span>&lt;/</span><span>h4</span><span>&gt;</span>
</span><span><span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"row"</span><span>&gt;</span>
</span><span>   <span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"col-md-6"</span><span>&gt;</span>
</span><span>       <span>&lt;</span><span>form</span> <span>method</span><span>=</span><span>"post"</span><span>&gt;</span>
</span><span>           <span>&lt;</span><span>p</span><span>&gt;</span>
</span><span>               We have sent a confirmation code to @Model.PhoneNumber
</span><span>               Enter the code you receive to confirm your phone number.
</span><span>           <span>&lt;/</span><span>p</span><span>&gt;</span>
</span><span>           <span>&lt;</span><span>div</span> <span>asp-validation-summary</span><span>=</span><span>"All"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span>
</span><span>
</span><span>           <span>&lt;</span><span>div</span> <span>class</span><span>=</span><span>"form-group"</span><span>&gt;</span>
</span><span>               <span>&lt;</span><span>label</span> <span>asp-for</span><span>=</span><span>"VerificationCode"</span><span>&gt;&lt;/</span><span>label</span><span>&gt;</span>
</span><span>               <span>&lt;</span><span>input</span> <span>asp-for</span><span>=</span><span>"VerificationCode"</span> <span>class</span><span>=</span><span>"form-control"</span> <span>type</span><span>=</span><span>"number"</span> <span>/&gt;</span>
</span><span>               <span>&lt;</span><span>span</span> <span>asp-validation-for</span><span>=</span><span>"VerificationCode"</span> <span>class</span><span>=</span><span>"text-danger"</span><span>&gt;&lt;/</span><span>span</span><span>&gt;</span>
</span><span>           <span>&lt;/</span><span>div</span><span>&gt;</span>
</span><span>           <span>&lt;</span><span>button</span> <span>type</span><span>=</span><span>"submit"</span> <span>class</span><span>=</span><span>"btn btn-primary"</span><span>&gt;</span>Confirm<span>&lt;/</span><span>button</span><span>&gt;</span>
</span><span>       <span>&lt;/</span><span>form</span><span>&gt;</span>
</span><span>   <span>&lt;/</span><span>div</span><span>&gt;</span>
</span><span><span>&lt;/</span><span>div</span><span>&gt;</span>
</span><span>
</span><span>@section Scripts {
</span><span>   <span>&lt;</span><span>partial</span> <span>name</span><span>=</span><span>"_ValidationScriptsPartial"</span> <span>/&gt;</span>
</span><span>}
</span></pre></div>
</div>

    
      <div><p>When rendered, this looks like the following:</p>
<p><img alt="Confirm phone number rendered page." height="342" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/czV8v_xWW2oj_K3UC0coD4NFp2X2dIPJNWjq_enbGjrY7I.width-800.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/czV8v_xWW2oj_K3UC0coD4NFp2X2dIPJNWjq_enbGjrY7I.width-800.png 800w, https://twilio-cms-prod.s3.amazonaws.com/images/czV8v_xWW2oj_K3UC0coD4NFp2X2dIPJNWjq_enbGjrY7.width-1600.png 1380w" width="800"></p>
<p>Once the user successfully confirms their phone number you can be confident they have access to it and you can use it in other parts of your application with confidence.</p>
<h2>Showing a confirmation success page</h2>
<p>To create a simple "congratulations" page for the user, create a new Razor Page in the <em>Areas/Identity/Pages/Account</em>&nbsp;folder called <em>ConfirmPhoneSuccess.cshtml</em>. You don't need to change the code-behind for this page, just add the following markup to <em>ConfirmPhoneSuccess.cshtml</em>:</p></div>
    
      

<div>
    <div><pre><span>@page
</span><span>@model ConfirmPhoneSuccessModel
</span><span>@{
</span><span>   ViewData["Title"] = "Phone number confirmed";
</span><span>}
</span><span>
</span><span><span>&lt;</span><span>h1</span><span>&gt;</span>@ViewData["Title"]<span>&lt;/</span><span>h1</span><span>&gt;</span>
</span><span><span>&lt;</span><span>div</span><span>&gt;</span>
</span><span>   <span>&lt;</span><span>p</span><span>&gt;</span>
</span><span>       Thank you for confirming your phone number.
</span><span>   <span>&lt;/</span><span>p</span><span>&gt;</span>
</span><span>   <span>&lt;</span><span>a</span> <span>asp-page</span><span>=</span><span>"/Index"</span><span>&gt;</span>Back to home<span>&lt;/</span><span>a</span><span>&gt;</span>
</span><span><span>&lt;/</span><span>div</span><span>&gt;</span>
</span></pre></div>
</div>

    
      <div><p>After entering a correct verification code, users will be redirected to this page. From here, they can return to the home page.</p>
<p><img alt="Phone number confirmed screen" height="154" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/1BarYHz9Sk3P2yfmdw8S_dsTFVPKCm2ZEIgyxKa4RPVdks.width-800.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/1BarYHz9Sk3P2yfmdw8S_dsTFVPKCm2ZEIgyxKa4RPVdks.width-800.png 800w, https://twilio-cms-prod.s3.amazonaws.com/images/1BarYHz9Sk3P2yfmdw8S_dsTFVPKCm2ZEIgyxKa4RPVdk.width-1600.png 1500w" width="800"></p>
<h2>Trying out the Twilio Verify functionality</h2>
<p>Try out what you’ve just built by running the app. Follow these steps to validate a user’s ownership of a phone number with Verify:</p>
<p>Navigate to <em>/Identity/Account/Manage</em>&nbsp;in your browser. Because this page is protected by ASP.NET Core authorization, you’ll be redirected to the account sign in page.</p>
<p>Register as a new user. You will be redirected to the account management route where you can enter your phone number, and click <strong>Save</strong>. Next, navigate to the &nbsp;<em>/Identity/Account/VerifyPhone</em>&nbsp;route and you'll see the rendered <em>VerifyPhone.cshtml</em>&nbsp;Razor page, indicating that a verification&nbsp;code will be sent to the number you just entered.</p>
<p>Click <strong>Send verification code</strong>&nbsp;and you will be routed to <em>/Identity/Account/ConfirmPhone</em>. In a matter of moments you should receive an SMS message with a verification code. Note that the message reflects the name of the service you created in Twilio Verify.</p>
<p>At this point you can go to the Verify console at <a href="https://www.twilio.com/console/verify/services">https://www.twilio.com/console/verify/services</a>, select your Verify service, and view the logs. You should see a log with a status of "Pending" next to your phone number.</p>
<p>Enter the numeric code from the SMS message in the Code box on the <em>Confirm phone number</em>&nbsp;page and click <strong>Confirm</strong>. (Validation codes expire, so you need to do this within 10 minutes of receiving the code.)</p>
<p>If everything worked correctly you should be redirected to the <em>/Identity/Account/ConfirmPhoneSuccess</em>&nbsp;page. If you refresh the logs for your Verify service in the Twilio Console you should see the successful validation reflected in the "status" column.</p>
<p>Good work! You've successfully integrated Twilio Verify with ASP.NET Core 2.2 Identity.</p>
<h2>Possible improvements</h2>
<p>This post showed the basic approach for using version 2 of the Verify API with ASP.NET Core Identity, but there are many improvements you could make:</p>
<ul>
<li><em>Include a link the <code>VerifyPhone</code> page</em>. Currently you have to navigate manually to <em>/Identity/Account/VerifyPhone</em>, but in practice you would want to add a link to it somewhere in your app.</li>
<li><em>Show the verification status of the phone number in the app</em>. By default, ASP.NET Core Identity doesn't display the <code>IdentityUser.PhoneNumberConfirmed</code> property anywhere in the app.</li>
<li><em>Only verify unconfirmed numbers</em>. Related to the previous improvement, you probably only want to verify phone numbers once, so you should check for <code>PhoneNumberConfirmed=true</code> in the <code>VerifyPhone</code> page, as well as hide any verification links.</li>
<li><em>Allow re-sending the code</em>. In some cases, users might find the verification code doesn't arrive. For a smoother user experience, you could add functionality to allow re-sending a confirmation code to the <code>ConfirmPhone</code> page.</li>
</ul>
<h2>Summary</h2>
<p>In this post you saw how to use version 2 of the Twilio Verify API to confirm phone number ownership in an ASP.NET Core Identity application. You learned how to use the Twilio helper SDK to create a verification and a verification check, and how to update the ASP.NET Core Identity user once the phone number is confirmed.</p>
<p>You can find the complete sample code for this post <a href="https://github.com/andrewlock/TwilioSamples/tree/master/SendVerificationSmsV2Demo">on GitHub</a>.</p>
<p><em>Andrew Lock is a Microsoft MVP and author of </em><a href="https://www.manning.com/books/asp-dot-net-core-in-action?a_aid=aspnetcore-in-action&amp;a_bid=5b1b11eb"><em>ASP.NET Core in Action by Manning</em></a><em>. He can be reached on Twitter at </em><a href="https://twitter.com/andrewlocknet"><em>@andrewlocknet</em></a><em>, or via his blog at </em><a href="https://andrewlock.net/"><em>https://andrewlock.net</em></a><em>.</em></p></div>
    

    

    


    
      




    
  </section></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>