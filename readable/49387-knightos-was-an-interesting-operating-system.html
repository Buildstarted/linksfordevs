<!DOCTYPE html>
<html lang="en">
<head>
    <title>
KnightOS was an interesting operating system -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>KnightOS was an interesting operating system</h1>
    <article> <p><a href="https://knightos.org">KnightOS</a> is an operating system I started writing about
10 years ago, for Texas Instruments line of z80 calculators &#x2014; the TI-73,
TI-83+, TI-84+, and similar calculators are supported. It still gets the rare
improvements, but these days myself and most of the major contributors are just
left with starry eyed empty promises to themselves that one day they&#x2019;ll do one
of those big refactorings we&#x2019;ve been planning&#x2026; for 4 or 5 years now.</p> <p>Still, it was a really interesting operating system which was working under some
challenging constraints, and overcame them to offer a rather nice Unix-like
environment, with a filesystem, preemptive multiprocessing <em>and</em> multithreading,
assembly and C programming environments, and more. The entire system was written
in handwritten z80 assembly, almost 50,000 lines of it, on a compiler toolchain
we built from scratch.</p> <p>There was only 64 KiB of usable RAM. The kernel stored <em>all</em> of its state in
1024 bytes of statically allocated RAM. Many subsystems used overlapping parts
of this memory, which was carefully planned for to avoid conflicts. The
userspace memory allocator used a simple linked list for tracking allocations,
to minimize the overhead of each allocation and maximize the usable space for
userspace programs. There was no MMU in the sense that we have on modern
computers, so any program could freely overwrite any other programs. In fact,
the &#x201C;userspace&#x201D; task switching GUI would read the kernel&#x2019;s process table
directly to make a list of running programs.</p> <p>The non-volatile storage was NOR Flash, which presents some interesting
constraints. In the worst case we only had 512 KiB of storage, and even in the
best case just 4MiB (this for a device released in 2013). This space was shared
with the kernel, whose core code was less than 4KiB, and including high-address
subsystems still clocked in at less than 16KiB. Due to the constraints of NOR
Flash, a custom filesystem was designed which did all daily operations by only
<em>resetting</em> bits in the underlying storage. In order to <em>set</em> any bits, we had
to set the entire 64 KiB sector to 1. Overhead was also kept to a bare minimum
here to maximize storage space available to users.</p> <p>Writing to Flash storage also renders it unreadable while the operation is in
progress. The kernel normally executes directly from Flash, resident at the
bottom of the memory. Therefore, in order to modify Flash, the kernel&#x2019;s Flash
driver copies part of itself to RAM, jumps to it, and then jumps back after the
operation is complete. Recall that all of the kernel&#x2019;s memory is statically
allocated, and there&#x2019;s not much of it &#x2014; we used only 128 bytes for the
code which runs in RAM, and it&#x2019;s shared with some other stuff that we had to
plan around. In order to meet these constraints, we employ <em>self modifying code</em>
&#x2014; the Flash driver copies some of itself into RAM, then pre-computes some
information and <em>modifies</em> that machine code in-place before jumping to it.</p> <p>We also had some basic networking support. The calculator has a 2.5mm jack,
similar to headphone jacks &#x2014; if you had a 3.5mm adapter, we had a music
player which would play MIDI or WAV files. The kernel had direct control of the
voltages on the ring and tip, and had to bitbang them directly in software<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>.
Based on this we built some basic networking support, which supported
calculator-to-calculator and calculator-to-PC information exchange. Later models
had a mini-USB controller (which, funnily enough, can also be bitbanged in
software), but we never ended up writing a driver for it.</p> <p>The KnightOS kernel also includes some code which is the first time I ever wrote
<a href="https://github.com/KnightOS/kernel/blob/e257f54e021ee743306a2a4a5a152860728fb3f8/src/00/restarts.asm#L129-L130">&#x201C;here be dragons&#x201D;</a>
into a comment, and I don&#x2019;t think I&#x2019;ve topped it since.</p> <p>Despite these constraints, KnightOS is completely booted up to a useful
Unix-like (with a graphical interface) faster than you can lift your finger off
of the power button. The battery could last the entire semester, if you&#x2019;re
lucky. Can the device you&#x2019;re reading this on claim the same?<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup></p> <video src="https://yukari.sr.ht/knightos.webm"></video> <p class="text-muted"> Have a comment on one of my posts? Start a discussion in my <a href="https://lists.sr.ht/~sircmpwn/public-inbox">public inbox</a> by sending an email to <a href="mailto:~sircmpwn/public-inbox@lists.sr.ht?Subject=Re%3A%20KnightOS%20was%20an%20interesting%20operating%20system"> ~sircmpwn/public-inbox@lists.sr.ht </a> <small> [<a href="https://man.sr.ht/lists.sr.ht/etiquette.md">mailing list etiquette</a>] </small>
</p> <p class="text-muted"> Are you a free software maintainer who is struggling with stress, demanding users, overwork, or any other social problems in the course of your work? Please <a href="mailto:sir@cmpwn.com">email me</a> &#x2014; I know how you feel, and I can lend a sympathetic ear and share some veteran advice.
</p> <section class="webring"> <section class="articles"> <div class="article"> <p class="summary">This post explains how to implement heap allocators from scratch. It presents and discusses different allocator designs, including bump allocation, linked list allocation, and fixed-size block allocation. For each of the three designs, we will create a ba&#x2026;</p> <small class="source"> via <a href="https://os.phil-opp.com">Writing an OS in Rust</a> </small> <small class="date">January 20, 2020</small> </div> <div class="article"> <p class="summary">This month&apos;s status update will be a little lighter than usual due to Christmas holidays. I&apos;ve still got the chance to send a patches to quite a few projects, and&#x2026; do a lot of releases! Weston, Wayland, Sway, mako and grim all have or will get a r&#x2026;</p> <small class="source"> via <a href="https://emersion.fr/blog/">emersion</a> </small> <small class="date">January 16, 2020</small> </div> <div class="article"> <p class="summary">Inspired by Peter Watts&#x2019; The Freeze-Frame Revolution and The Island. Each birth is violent in the same way. I erupt into the void, my mirrored surface riotous with gamma radiation,
parafluid sheeting from my forced extremities, ripped away by gravitational
sh&#x2026;</p> <small class="source"> via <a href="http://aphyr.com/">Aphyr: Posts</a> </small> <small class="date">January 15, 2020</small> </div> </section> <p class="attribution"> Generated by <a href="https://git.sr.ht/~sircmpwn/openring">openring</a> </p>
</section> </article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>