<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using dependency injection with Twilio SMS and ASP.NET Core 2.1 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Using dependency injection with Twilio SMS and ASP.NET Core 2.1</h1><div><div class="post-content"><p>ASP.NET Core is built with <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-2.1">first-class support for dependency injection (DI)</a>. It's used heavily by the framework, but you can also use it with your own classes. The Twilio C# helper libraries are largely <code>static</code>, so you don't <em>have</em> to use DI, but sometimes you might want to. For example, you might want to create a custom <code>TwilioRestClient</code> that uses <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests">the <code>HttpClientFactory</code> features of .NET Core 2.1</a>. In this post, I describe how to create a custom <code>ITwilioRestClient</code>, register it with the ASP.NET Core DI container, and inject it into a web API controller, so you can use it to send an SMS.</p><h2 id="prerequisites" class="heading-with-anchor">Prerequisites<a href="#prerequisites"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>To follow along with this post you'll need </p><p>You can find the complete code for this post <a href="https://github.com/andrewlock/TwilioSamples/tree/master/src/CustomTwilioRestClientDemo">on GitHub</a>.</p><h2 id="the-twiliorestclient-and-system-net-httpclient" class="heading-with-anchor">The <code>TwilioRestClient</code> and <code>System.Net.HttpClient</code><a href="#the-twiliorestclient-and-system-net-httpclient"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Twilio exposes a REST API that you can invoke to send messages, or make phone calls, for example. The C# helper libraries provide convenient, strongly-typed wrappers around the underlying HTTP calls. Typically you configure the Twilio client globally and use static methods to create resources. For example, a typical static method call to create a Twilio SMS message might look like this:</p><pre class="language-csharp"><code class="language-csharp">TwilioClient<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>accountSid<span class="token punctuation">,</span> authToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> message <span class="token operator">=</span> MessageResource<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>
    to<span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">PhoneNumber</span><span class="token punctuation">(</span><span class="token string">"+15558675309"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">PhoneNumber</span><span class="token punctuation">(</span><span class="token string">"+15017250604"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span><span class="token string">"Hello from C#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Behind the scenes, the helper library creates a <code>TwilioRestClient</code> using the Twilio credentials you pass to the <code>Init()</code> method. The <code>MessageResource.Create()</code> method uses this client by default.</p><p>But what if you need to customize the requests sent to the Twilio API? Perhaps you need to add a custom HTTP header to outgoing requests (perhaps as required by an upstream proxy server).</p><p>The <code>TwilioRestClient</code> uses the standard <code>HttpClient</code> class (in the <code>System.Net.Http</code> namespace) to call the REST API. By customizing the <code>HttpClient</code> you can control all the requests a <code>TwilioRestClient</code> makes. In .NET Core 2.1, the best way to customize an <code>HttpClient</code> is to use the <code>HttpClientFactory</code> feature.</p><h2 id="using-httpclientfactory-with-net-core-2-1" class="heading-with-anchor">Using HttpClientFactory with .NET Core 2.1<a href="#using-httpclientfactory-with-net-core-2-1"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p><code>HttpClient</code> has been around for a long time, and is a common tool for .NET developers, but it's easy to misuse. The class implements <code>IDisposable</code>, so some developers use <code>HttpClient</code> with a <code>using</code> statement. Unfortunately, <a href="https://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/">this can lead to "socket exhaustion".</a></p><p>To counteract this, <a href="https://docs.microsoft.com/dotnet/csharp/tutorials/console-webapiclient">Microsoft's advice</a> is to use the <code>HttpClient</code> as a <code>static</code> or singleton object. But this leads to another problemâ€”a static <code>HttpClient</code><a href="https://github.com/dotnet/corefx/issues/11224">doesn't respect DNS changes</a>. </p><p>To address these issues, .NET Core 2.1 introduces <code>HttpClientFactory</code>. Instead of having to micro-manage your <code>HttpClient</code> instances, <code>HttpClientFactory</code> takes care of managing the lifecycle of <code>HttpClient</code> instances for you. </p><p>As well as the performance benefits, <code>HttpClientFactory</code> allows you to easily customize each <code>HttpClient</code>, for example by <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly">adding automatic transient-fault handling</a> using the <a href="https://github.com/App-vNext/Polly">Polly library</a>.</p><h2 id="creating-the-web-api-project" class="heading-with-anchor">Creating the Web API project<a href="#creating-the-web-api-project"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>To get started, create a new ASP.NET Core 2.1 Web API project, "CustomTwilioRestClientDemo" using Visual Studio or your IDE of choice. </p><ul><li>If you're using the .NET Core CLI, use <code>dotnet new webapi --no-https</code>. </li><li>If you use Visual Studio 2017 open the project properties and uncheck <strong>Enable SSL</strong>.</li></ul><p>Disabling SSL/TLS is obviously not a best practice for production applications. For this demonstration, doing so will make testing the API with Postman easier. You can delete the <em>Controllers</em> folder and <em>ValuesController.cs</em> file that are generated, as we'll be replacing them later.</p><h2 id="installing-the-twilio-nuget-package" class="heading-with-anchor">Installing the Twilio NuGet package<a href="#installing-the-twilio-nuget-package"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Install the Twilio NuGet package (version 5.22.0 or later) using the NuGet Package Manager, Package Manager Console CLI, or by editing the the <em>CustomTwilioRestClient.csproj</em> file. After using any of these methods the <code>&lt;ItemGroup&gt;</code> section of the project file should look like this (version numbers may be higher):</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.App<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Razor.Design<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.1.2<span class="token punctuation">"</span></span><span class="token attr-name">PrivateAssets</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>All<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Twilio<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5.22.0<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span></code></pre><h2 id="creating-a-custom-twilio-client-using-httpclientfactory" class="heading-with-anchor">Creating a custom Twilio client using HttpClientFactory<a href="#creating-a-custom-twilio-client-using-httpclientfactory"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>You can consume an <code>HttpClientFactory</code>-managed <code>HttpClient</code> by injecting it into the constructor of any of your classes. You're then free to customize the headers or make any other necessary changes before using it to make requests. </p><p>Create <em>CustomTwilioClient.cs</em> in the project directory and replace the contents with the following code. This creates a custom <code>ITwilioRestClient</code> using an <code>HttpClient</code> injected into the constructor and adds a custom header to all outgoing requests.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span><span class="token keyword">using</span> Twilio<span class="token punctuation">.</span>Clients<span class="token punctuation">;</span><span class="token keyword">using</span> Twilio<span class="token punctuation">.</span>Http<span class="token punctuation">;</span><span class="token keyword">namespace</span> CustomTwilioRestClientDemo
<span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">CustomTwilioClient</span><span class="token punctuation">:</span><span class="token class-name">ITwilioRestClient</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">ITwilioRestClient</span> _innerClient<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">CustomTwilioClient</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> config<span class="token punctuation">,</span><span class="token class-name">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient</span> httpClient<span class="token punctuation">)</span><span class="token punctuation">{</span>
            httpClient<span class="token punctuation">.</span>DefaultRequestHeaders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"X-Custom-Header"</span><span class="token punctuation">,</span><span class="token string">"CustomTwilioRestClient-Demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            _innerClient <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">TwilioRestClient</span><span class="token punctuation">(</span>
                config<span class="token punctuation">[</span><span class="token string">"Twilio:AccountSid"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                config<span class="token punctuation">[</span><span class="token string">"Twilio:AuthToken"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                httpClient<span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">SystemNetHttpClient</span><span class="token punctuation">(</span>httpClient<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">Response</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> Task<span class="token operator">&lt;</span>Response<span class="token operator">&gt;</span><span class="token function">RequestAsync</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span><span class="token function">RequestAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">string</span> AccountSid <span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span>AccountSid<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">string</span> Region <span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span>Region<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token class-name">Twilio<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient</span> HttpClient <span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span>HttpClient<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>In this example, we inject and <code>HttpClient</code> into the constructor and customize it by adding a default request header, <code>X-Custom-Header</code>. We pass this <code>HttpClient</code> into the new <code>TwilioRestClient</code>, so all outgoing requests to the Twilio REST API using <code>_innerClient</code> will contain this header. </p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token function">CustomTwilioClient</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> config<span class="token punctuation">,</span><span class="token class-name">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient</span> httpClient<span class="token punctuation">)</span><span class="token punctuation">{</span>
    httpClient<span class="token punctuation">.</span>DefaultRequestHeaders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"X-Custom-Header"</span><span class="token punctuation">,</span><span class="token string">"CustomTwilioRestClient-Demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _innerClient <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">TwilioRestClient</span><span class="token punctuation">(</span>
        config<span class="token punctuation">[</span><span class="token string">"Twilio:AccountSid"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        config<span class="token punctuation">[</span><span class="token string">"Twilio:AuthToken"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        httpClient<span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">SystemNetHttpClient</span><span class="token punctuation">(</span>httpClient<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>This example uses a <a href="https://en.wikipedia.org/wiki/Decorator_pattern">decorator pattern</a>, in which we implement the <code>ITwilioRestClient</code> interface by delegating to a private <code>TwilioRestClient _innerClient</code>. For example, all of the following methods and properties call the same property on the <code>_innerClient</code> and return the result.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token class-name">Response</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> Task<span class="token operator">&lt;</span>Response<span class="token operator">&gt;</span><span class="token function">RequestAsync</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span><span class="token function">RequestAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">string</span> AccountSid <span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span>AccountSid<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token keyword">string</span> Region <span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span>Region<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token class-name">Twilio<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient</span> HttpClient <span class="token operator">=</span><span class="token operator">&gt;</span> _innerClient<span class="token punctuation">.</span>HttpClient<span class="token punctuation">;</span></code></pre><p>The client is created using credentials loaded from the injected <code>IConfiguration config</code>. This includes your Twilio Account Sid and Auth Token (<a href="https://www.twilio.com/console">found in the Twilio Dashboard</a>), which can be placed in a file like <em>appsettings.json</em> below or, better yet, <a href="https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets">using the Secrets Manager tool</a>. You can learn how in another Twilio blog post: <a href="https://www.twilio.com/blog/2018/05/user-secrets-in-a-net-core-web-app.html">User Secrets in a .NET Core Web App</a>. For this demo, add the following section to the <em>appsettings.json</em> file and insert your Twilio SID and Auth Token in place of the placeholders:</p><pre class="language-json"><code class="language-json"><span class="token property">"Twilio"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"AccountSID"</span><span class="token operator">:</span><span class="token string">"ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span><span class="token punctuation">,</span><span class="token property">"AuthToken"</span><span class="token operator">:</span><span class="token string">"your_auth_token"</span><span class="token punctuation">}</span></code></pre><p>Using the <code>IConfiguration</code> object directly in your classes is generally not the best approach. Instead, you should consider using <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options">strongly typed settings with the Options pattern</a>. I've used the configuration option here purely for convenience. </p><p>With your custom client created, you now need to register it with the DI container.</p><h2 id="registering-the-customtwilioclient-with-the-di-container" class="heading-with-anchor">Registering the CustomTwilioClient with the DI container<a href="#registering-the-customtwilioclient-with-the-di-container"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>You can register your classes with the DI container in <code>Startup.ConfigureServices()</code>. This class and method is created by default when you create a new ASP.NET Core project, and is where you configure your DI container. You need to register any framework services you require as well as your custom classes. Once a class is registered with the DI container you can inject it into the constructor of other classes.</p><p>We're using the <code>HttpClientFactory</code> to create the <code>HttpClient</code> required by our <code>CustomTwilioClient</code> so we can use the <code>AddHttpClient&lt;,&gt;()</code> convenience method to register our class as a <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests#how-to-use-typed-clients-with-httpclientfactory">"typed client"</a>. Add the directive <code>using Twilio.Clients;</code> to <em>Startup.cs</em>, then update the <code>ConfigureServices</code> method to the following</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetCompatibilityVersion</span><span class="token punctuation">(</span>CompatibilityVersion<span class="token punctuation">.</span>Version_2_1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpClient</span><span class="token punctuation">&lt;</span><span class="token class-name">ITwilioRestClient</span><span class="token punctuation">,</span><span class="token class-name">CustomTwilioClient</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><code>AddMvc()</code> is added by default when you create an ASP.NET Core application, and adds all the required framework services for using MVC in your app. </p><p>The following line registers your <code>CustomTwilioClient</code> as an implementation of the <code>ITwilioRestClient</code> service, and instructs the <code>HttpClientFactory</code> to inject an <code>HttpClient</code> at runtime.</p><pre class="language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpClient</span><span class="token punctuation">&lt;</span><span class="token class-name">ITwilioRestClient</span><span class="token punctuation">,</span><span class="token class-name">CustomTwilioClient</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If you wish, you can customize the <code>HttpClient</code> that will be injected into your <code>CustomTwilioClient</code> here. For example, instead of adding custom headers inside your <code>CustomTwilioClient</code> constructor, you could configure it here instead:</p><pre class="language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpClient</span><span class="token punctuation">&lt;</span><span class="token class-name">ITwilioRestClient</span><span class="token punctuation">,</span><span class="token class-name">CustomTwilioClient</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>client <span class="token operator">=</span><span class="token operator">&gt;</span> 
    client<span class="token punctuation">.</span>DefaultRequestHeaders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"X-Custom-Header"</span><span class="token punctuation">,</span><span class="token string">"HttpClientFactory-Sample"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The overall result is the same, so it comes down to your preferences whether you prefer this or the constructor approach. In addition, <code>AddHttpClient&lt;,&gt;()</code> returns an <code>IHttpClientBuilder</code> instance that you can use for further customization, for example to add <a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly">transient HTTP fault handling</a>. </p><h2 id="injecting-the-customtwilioclient-into-an-api-controller" class="heading-with-anchor">Injecting the CustomTwilioClient into an API Controller<a href="#injecting-the-customtwilioclient-into-an-api-controller"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Once your custom client is registered with the DI container you can inject an <code>ITwilioRestClient</code> into any class and the DI container will create a <code>CustomTwilioClient</code> for you. You can use this client to make calls using Twilio helper library methods, such as <code>MessageResource.Create()</code>. Create <em>MessageController.cs</em> and add the following code. This shows an API controller in which we've injected an <code>ITwilioRestClient</code>, and used it to send a message when it receives an HTTP POST.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc<span class="token punctuation">;</span><span class="token keyword">using</span> Twilio<span class="token punctuation">.</span>Clients<span class="token punctuation">;</span><span class="token keyword">using</span> Twilio<span class="token punctuation">.</span>Rest<span class="token punctuation">.</span>Api<span class="token punctuation">.</span>V2010<span class="token punctuation">.</span>Account<span class="token punctuation">;</span><span class="token keyword">using</span> Twilio<span class="token punctuation">.</span>Types<span class="token punctuation">;</span><span class="token keyword">namespace</span> CustomTwilioRestClientDemo
<span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">MessageController</span><span class="token punctuation">:</span><span class="token class-name">ControllerBase</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">ITwilioRestClient</span> _client<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">MessageController</span><span class="token punctuation">(</span><span class="token class-name">ITwilioRestClient</span> client<span class="token punctuation">)</span><span class="token punctuation">{</span>
            _client <span class="token operator">=</span> client<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"api/send-sms"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token class-name">IActionResult</span><span class="token function">SendSms</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> message <span class="token operator">=</span> MessageResource<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>
                to<span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">PhoneNumber</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>To<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">PhoneNumber</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>From<span class="token punctuation">)</span><span class="token punctuation">,</span>
                body<span class="token punctuation">:</span> model<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>
                client<span class="token punctuation">:</span> _client<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token function">Ok</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Sid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">MessageModel</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">string</span> To <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">string</span> From <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">string</span> Message <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>You can add any additional arguments to your <code>MessageController</code> constructor, and as long as you've registered the service with the DI container in <code>Startup.ConfigureServices()</code> the framework will inject it for you. In this case we're injecting an <code>ITwilioRestClient</code> and saving it in a <code>readonly</code> field for use by the action method.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">ITwilioRestClient</span> _client<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">MessageController</span><span class="token punctuation">(</span><span class="token class-name">ITwilioRestClient</span> client<span class="token punctuation">)</span><span class="token punctuation">{</span>
    _client <span class="token operator">=</span> client<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>The action method <code>SendSms</code> builds a <code>MessageModel</code> view model from POST requests, which we use to set the <code>to</code>, <code>from</code>, and <code>body</code>, parameters of the <code>MessageResource.Create()</code> call. We also pass in the custom <code>ITwilioRestClient</code> so that the helper library uses this instead of the default <code>TwilioRestClient</code>.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"api/send-sms"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token class-name">IActionResult</span><span class="token function">SendSms</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> message <span class="token operator">=</span> MessageResource<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>
        to<span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">PhoneNumber</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>To<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">from</span><span class="token punctuation">:</span><span class="token keyword">new</span><span class="token class-name">PhoneNumber</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>From<span class="token punctuation">)</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> model<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>
        client<span class="token punctuation">:</span> _client<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token function">Ok</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Sid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>Note that we've decorated the controller with the <code>[ApiController]</code> attribute, so we don't need to worry about specifying the <code>[FromBody]</code> parameter to bind JSON, or explicitly checking <code>ModelState.IsValid</code>. See <a href="https://docs.microsoft.com/en-us/aspnet/core/web-api/#annotation-with-apicontroller-attribute">the documentation</a> for further details on the <code>[ApiController]</code> attribute.</p><h2 id="testing-your-api-with-postman" class="heading-with-anchor">Testing your API with Postman<a href="#testing-your-api-with-postman"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>You have everything in place to test your app. You'll need to use a tool such as <a href="https://www.getpostman.com/">Postman</a> to make requests to your API. When the app starts, choose <strong>Create New</strong><strong>Request</strong>, enter a name for the request such as "CustomTwilioRestClientDemo", and choose a collection to save the Postman request in. Click <strong>Save</strong> to create the request.</p><p>Configure the request to call your API:</p><ul><li>Change the HTTP Method from <strong>GET</strong> to <strong>POST</strong></li><li>Set the request URL to <a href="http://localhost:5000/api/send-sms">http://localhost:5000/api/send-sms</a> (or whichever url your app is running at)</li><li>Click <strong>Body</strong>, choose <strong>raw</strong> , and change the Content-Type from <strong>Text</strong> to <strong>JSON(application/json)</strong></li><li>Enter a JSON request, like the one below, containing <code>to</code>, <code>from</code>, and <code>body</code>, parameters</li><li>Replace the value for the <code>from</code> parameter with your Twilio phone number</li><li>The value for the <code>to</code> parameter must be a phone number youâ€™ve registered with Twilio, typically the number you used when creating your account, and it must be able to receive SMS</li></ul><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"from"</span><span class="token operator">:</span><span class="token string">"+441123456789"</span><span class="token punctuation">,</span><span class="token property">"to"</span><span class="token operator">:</span><span class="token string">"+441123456789"</span><span class="token punctuation">,</span><span class="token property">"message"</span><span class="token operator">:</span><span class="token string">"Hello from CustomTwilioClient!"</span><span class="token punctuation">}</span></code></pre><p>When you send the message, your "create message" request will be sent using the Twilio REST API, with a custom header on the outgoing request. The <code>MessageController</code> then returns a 200 OK response containing the <code>Sid</code> of the message created:</p><p><img src="/content/images/p/custom_twilio_client.png" alt="Using PostMan to test the API controller"></p><p>If you want to try out the code in this post, you can download <a href="https://github.com/andrewlock/TwilioSamples/tree/master/src/CustomTwilioRestClientDemo">the source code from GitHub</a>.</p><h2 id="what-else-can-this-technique-be-used-for-" class="heading-with-anchor">What else can this technique be used for?<a href="#what-else-can-this-technique-be-used-for-"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>One of the big advantages of using Dependency Injection in your code, and especially of injecting interfaces instead of concrete classes, is that makes it easier to test your classes. If you were using the global <code>TwilioRestClient</code> and wanted to test your <code>MessageController</code> then you'd be sending a new message with every request. By injecting an <code>ITwilioRestClient</code> instead, you could inject a mock or stub implementation for your tests.</p><p>You can extend the <code>CustomTwilioClient</code> further by using the <code>HttpClientFactory</code> features to make it resistant to transient failures using the Polly library, use a proxy server, or add caching, for example. Once your <code>CustomTwilioClient</code> is registered with the DI container, you can inject it anywhereâ€”into API controllers, as in this article, but also into Razor pages, or your own custom services.</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>In this post you saw how to create a custom <code>ITwilioRestClient</code>, and use <code>HttpClientFactory</code> to inject a custom <code>HttpClient</code> into the <code>CustomTwilioClient</code> constructor. We used this custom <code>HttpClient</code> to add extra headers to all outgoing requests to the Twilio REST API. By registering the <code>ITwilioRestClient</code> with the DI container you were able to create a simple Web API controller for sending SMSs with Twilio using the <code>CustomTwilioClient</code>. Finally, you saw how to test your controller using Postman by sending a JSON request.</p><h2 id="additional-information" class="heading-with-anchor">Additional Information<a href="#additional-information"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>For more information about <code>HttpClientFactory</code> I recommend Steve Gordonâ€™s excellent blog post series: <a href="https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore">https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore</a>.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>