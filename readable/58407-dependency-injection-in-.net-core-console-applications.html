<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Dependency injection in .NET Core console applications -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
            <h1>
                    <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">ðŸŽ‰</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
            </h1>
        <div class="readable">
    <h1>Dependency injection in .NET Core console applications</h1>
    <p>
by Gunnar Peipman <br />Reading time: 6-8 minutes    </p>
    <p><a href="https://gunnarpeipman.com/dotnet-core-dependency-injection/">https://gunnarpeipman.com/dotnet-core-dependency-injection/</a></p>
    <hr/>
    <div id="readability-page-1" class="page"><div><p><a title="ASP.NET" href="https://asp.net/">ASP.NET Core</a> uses built-in dependency injection mechanism provided by Microsoft. This blog post intorduces how to use same mechanism in .NET Core console applications. For those who like other DI/IoC frameworks this writing provides demo about how to use <a title="Autofac" href="https://autofac.org/">Autofac</a> with .NET Core framework-level dependency injection.<span id="more-4268"></span></p><h3>Framework-level dependency injection in ASP.NET Core</h3><p>I donâ€™t describe here details of dependency injection in ASP.NET Core. Those who want to find out more about it can skim through these writings:</p><ul><li><a title="Dependency injection in ASP.NET Core" href="https://gunnarpeipman.com/aspnet/dependency-injection-in-asp-net-5/">Dependency injection in ASP.NET Core</a></li><li><a title="Using dependency injection with view components" href="https://gunnarpeipman.com/aspnet/using-dependency-injection-with-view-components/">Using dependency injection with view components</a></li><li><a title="Injecting services to ASP.NET Core controller actions" href="https://gunnarpeipman.com/aspnet/controller-action-injection/">Injecting services to ASP.NET Core controller actions</a></li><li><a title="ASP.NET Core: Using view injection" href="https://gunnarpeipman.com/aspnet/aspnet-core-view-injection/">ASP.NET Core: Using view injection</a></li><li><a title="ASP.NET Core: Using third-party DI/IoC containers" href="https://gunnarpeipman.com/aspnet/aspnet-core-structuremap-autofac/">ASP.NET Core: Using third-party DI/IoC containers</a></li></ul><h3>Dependency injection in .NET Core console applications</h3><p>We can use same dependecy injection mechanism also in .NET Core command line applications. Although we donâ€™t have there anything prepared for us itâ€™s very easy to put up something similar to web applications. Actually I prefer to use more lightweight approach for console applications.</p><p>Before writing any code we need Nuget package for dependency injection components:</p><ul><li>Microsoft.Extensions.DependencyInjection</li></ul><p>At very basic level we can create dependency injection service provider using the following code.</p><pre><span>static</span>&nbsp;<span>void</span>&nbsp;<span>Main</span>(<span>string</span>[] <span>args</span>)
{<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>collection</span> = <span>new</span>&nbsp;<span>ServiceCollection</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>collection</span>.<span>AddScoped</span>&lt;<span>IDemoService</span>, <span>DemoService</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>// ...</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp; <span>// Add other services</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp; <span>// ...</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>serviceProvider</span> = <span>collection</span>.<span>BuildServiceProvider</span>();

&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>service</span> = <span>serviceProvider</span>.<span>GetService</span>&lt;<span>IDemoService</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>service</span>.<span>DoSomething</span>();

&nbsp;&nbsp;&nbsp;&nbsp; <span>serviceProvider</span>.<span>Dispose</span>();<br>}</pre><p><strong>NB!</strong> Calling Dispose() on service provider is mandatory as otherwise registered instances will not get disposed. Keep this in mind.</p><h3>Preparing for disposables and third-party dependency injection frameworks</h3><p>Solution above works but it has one problem â€“ it doesnâ€™t consider possible use of third-party service providers. As ServiceProvider class is sealed and third-parties cannot extend it they must use IServiceProvider interface.</p><pre><span>public</span>&nbsp;<span>interface</span>&nbsp;<span>IServiceProvider</span>
{
&nbsp;&nbsp;&nbsp;&nbsp; <span>object</span>&nbsp;<span>GetService</span>(<span>Type</span>&nbsp;<span>serviceType</span>);
}</pre><p>Convenience methods like GetService&lt;T&gt;() are defined in ServiceProviderServiceExtensions class.</p><pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>class</span>&nbsp;<span>ServiceProviderServiceExtensions</span>
{
&nbsp;&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>static</span>&nbsp;<span>IServiceScope</span>&nbsp;<span>CreateScope</span>(<span>this</span>&nbsp;<span>IServiceProvider</span>&nbsp;<span>provider</span>);
&nbsp;&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>static</span>&nbsp;<span>object</span>&nbsp;<span>GetRequiredService</span>(<span>this</span>&nbsp;<span>IServiceProvider</span>&nbsp;<span>provider</span>, <span>Type</span>&nbsp;<span>serviceType</span>);
     <span>public</span>&nbsp;<span>static</span>&nbsp;<span>T</span>&nbsp;<span>GetRequiredService</span>&lt;<span>T</span>&gt;(<span>this</span>&nbsp;<span>IServiceProvider</span>&nbsp;<span>provider</span>);
&nbsp;&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>static</span>&nbsp;<span>T</span>&nbsp;<span>GetService</span>&lt;<span>T</span>&gt;(<span>this</span>&nbsp;<span>IServiceProvider</span>&nbsp;<span>provider</span>);
&nbsp;&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>static</span>&nbsp;<span>IEnumerable</span>&lt;<span>T</span>&gt; <span>GetServices</span>&lt;<span>T</span>&gt;(<span>this</span>&nbsp;<span>IServiceProvider</span>&nbsp;<span>provider</span>);
     <span>public</span>&nbsp;<span>static</span>&nbsp;<span>IEnumerable</span>&lt;<span>object</span>&gt; <span>GetServices</span>(<span>this</span>&nbsp;<span>IServiceProvider</span>&nbsp;<span>provider</span>, <span>Type</span>&nbsp;<span>serviceType</span>);
}</pre><p>IServiceProvider doesnâ€™t use IDisposable and therefore it doesnâ€™t have Dispose() method. Still classes that extend this interface may also extend IDisposable but we donâ€™t know it. To consider this possibility we have to implement disposing of service provider a little different way.</p><pre><span>static</span>&nbsp;<span>void</span>&nbsp;<span>Main</span>(<span>string</span>[] <span>args</span>)
{<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>collection</span> = <span>new</span>&nbsp;<span>ServiceCollection</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>collection</span>.<span>AddScoped</span>&lt;<span>IDemoService</span>, <span>DemoService</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp; <span>// Add other services</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp; <span>// ...</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp; <span>IServiceProvider</span>&nbsp;<span>serviceProvider</span> = <span>collection</span>.<span>BuildServiceProvider</span>();

&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>service</span> = <span>serviceProvider</span>.<span>GetService</span>&lt;<span>IDemoService</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp; <span>service</span>.<span>DoSomething</span>();

&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span> (<span>serviceProvider</span>&nbsp;<span>is</span>&nbsp;<span>IDisposable</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((<span>IDisposable</span>)<span>serviceProvider</span>).<span>Dispose</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp; }
}</pre><p>Now our code supports disposing of disposable service providers but we have still room to make things better.</p><h3>Getting code cleaner</h3><p>Main() method is currently messed up with all details of dependency injection. In real projects we have probably many services in service collection and filling this collection is worth separate method. Also I donâ€™t like to have service provider disposing logic in Main() method.</p><pre><span>class</span>&nbsp;<span>Program</span>
{
&nbsp;&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>static</span>&nbsp;<span>IServiceProvider</span> _serviceProvider;

&nbsp;&nbsp;&nbsp;&nbsp; <span>static</span>&nbsp;<span>void</span>&nbsp;<span>Main</span>(<span>string</span>[] <span>args</span>)
&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>RegisterServices</span>();

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>service</span> = _serviceProvider.<span>GetService</span>&lt;<span>IDemoService</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>service</span>.<span>DoSomething</span>();

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>DisposeServices</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp; }

&nbsp;&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>static</span>&nbsp;<span>void</span>&nbsp;<span>RegisterServices</span>()<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>collection</span> = <span>new</span>&nbsp;<span>ServiceCollection</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>collection</span>.<span>AddScoped</span>&lt;<span>IDemoService</span>, <span>DemoService</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>// ...</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>// Add other services</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>// ...</span><br><span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _serviceProvider = <span>collection</span>.<span>BuildServiceProvider</span>();
&nbsp;&nbsp;&nbsp;&nbsp; }

&nbsp;&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>static</span>&nbsp;<span>void</span>&nbsp;<span>DisposeServices</span>()
&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span>(_serviceProvider == <span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span> (_serviceProvider <span>is</span>&nbsp;<span>IDisposable</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((<span>IDisposable</span>)_serviceProvider).<span>Dispose</span>();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp;&nbsp; }
}</pre><p>Things are better now as Main() method is cleaner.</p><h3>Using Autofac</h3><p>Back in time I wrote about how to use <a title="ASP.NET Core: Using third-party DI/IoC containers" href="https://gunnarpeipman.com/aspnet/aspnet-core-structuremap-autofac/">Structuremap and Autofac with ASP.NET Core</a>. Using Autofac is simple and we need only small changes in our code to make it work.</p><p>First thing is to add <a title="Autofac" href="https://autofac.org/">Autofac</a> NuGet packages to .NET Core console application project.</p><ul><li>Autofac</li><li>Autofac.Extensions.DependencyInjection</li></ul><p>With Autofac packages in place we can change RegisterServices method to use Autofac.</p><pre><span>private</span>&nbsp;<span>static</span>&nbsp;<span>void</span>&nbsp;<span>RegisterServices</span>()
{
&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>collection</span> = <span>new</span>&nbsp;<span>ServiceCollection</span>();
&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>builder</span> = <span>new</span>&nbsp;<span>ContainerBuilder</span>();

&nbsp;&nbsp;&nbsp;&nbsp; <span>builder</span>.<span>RegisterType</span>&lt;<span>DemoService</span>&gt;().<span>As</span>&lt;<span>IDemoService</span>&gt;();
&nbsp;&nbsp;&nbsp;&nbsp; <span>//</span>
&nbsp;&nbsp;&nbsp;&nbsp; <span>// Add other services ...</span>
<span></span>&nbsp;&nbsp;&nbsp;&nbsp; <span>//</span>
<span></span>&nbsp;&nbsp;&nbsp;&nbsp; <span>builder</span>.<span>Populate</span>(<span>collection</span>);

&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>appContainer</span> = <span>builder</span>.<span>Build</span>();

&nbsp;&nbsp;&nbsp;&nbsp; _serviceProvider = <span>new</span>&nbsp;<span>AutofacServiceProvider</span>(<span>appContainer</span>);
}</pre><p>We donâ€™t need modifications to any other part of code. With these changes done and compiled our application uses Autofac now.</p><h3>Wrapping up</h3><p>Dependency injection mechanism provided by Microsoft with .NET Core is popular in ASP.NET but it can be used also in other types of .NET Core projects. Itâ€™s actually very easy to get dependency injection work as we need only small amount of code. In real applications biggest part of related code is about registering types. We were also able to use Autofac as third-party dependency injection framework. It was easy and we made only minor changes to our existing code.</p></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
            _dna = window._dna || {};
            _dna.siteId = "linksfor.devs";
            _dna.outlink = true;

            (function () {
                let dna = document.createElement('script');
                dna.type = 'text/javascript';
                dna.async = true;
                dna.src = '//dna.buildstarted.com/t.js';
                let s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(dna, s);
            })();
    </script>
</body>
</html>