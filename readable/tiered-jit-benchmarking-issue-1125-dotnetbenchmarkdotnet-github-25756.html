<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Tiered Jit Benchmarking &#xB7; Issue #1125 &#xB7; dotnet/BenchmarkDotNet - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Tiered Jit Benchmarking &#xB7; Issue #1125 &#xB7; dotnet/BenchmarkDotNet - linksfor.dev(s)"/>
    <meta property="article:author" content="AndreyAkinshin"/>
    <meta property="og:description" content="Hi I just wonder is that possible at all to benchmark code jitted as non optimised vs fully optimized? Like in 1st case as baseline I&amp;#39;d like code to be jitted with no any optimizations, just li..."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://github.com/dotnet/BenchmarkDotNet/issues/1125"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Tiered Jit Benchmarking &#xB7; Issue #1125 &#xB7; dotnet/BenchmarkDotNet</title>
<div class="readable">
        <h1>Tiered Jit Benchmarking &#xB7; Issue #1125 &#xB7; dotnet/BenchmarkDotNet</h1>
            <div>by AndreyAkinshin</div>
            <div>Reading time: 13-16 minutes</div>
        <div>Posted here: 04 Jun 2019</div>
        <p><a href="https://github.com/dotnet/BenchmarkDotNet/issues/1125">https://github.com/dotnet/BenchmarkDotNet/issues/1125</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div data-channel="marked-as-read:issue:428132274">

              
<div data-gid="MDU6SXNzdWU0MjgxMzIyNzQ=" data-url="/_render_node/MDU6SXNzdWU0MjgxMzIyNzQ=/issues/body" data-channel="issue:428132274">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issue-428132274">
  <div data-body-version="f7335b45c37d54007e31b571edc21334" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Hi</p>
<p>I just wonder is that possible at all to benchmark code jitted as non optimised vs fully optimized?<br>
Like in 1st case as baseline I'd like code to be jitted with no any optimizations, just like it is produced when app it just started and then against fully optimized just to make sure, and to understand, how faster optimized code is.</p>
<p>Thanks</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>

</div>


              

  


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODkzODE1MA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODkzODE1MA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODkzODE1MA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478938150">
    <div>
      

  

<details data-body-version="4f83e936cd8a4158b1fb0c4a664b29c0">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="4f83e936cd8a4158b1fb0c4a664b29c0" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi">@yahorsi</a> why do want to benchmark unoptimized code? What kind of valuable information do you want to get? How do you plan to use this information?<br>
It's possible to benchmark unoptimized code with BenchmarkDotNet, but this feature is disabled by default because the corresponding results are not relevant to the actual application performance. E.g., some microbenchmarks can work ~100 times slower in the DEBUG mode than in the RELEASE mode because runtime emits a lot of instructions which are required by the debugger.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODkzOTAyMQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODkzOTAyMQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODkzOTAyMQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478939021">
    <div>
      

  

<details data-body-version="ec389260787bc6ab6d01266d04747106">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="ec389260787bc6ab6d01266d04747106" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi">@yahorsi</a> why do want to benchmark unoptimized code? What kind of valuable information do you want to get? How do you plan to use this information?</p>
</blockquote>
<p>By unoptimized code I mean unoptimized by jit compiler, not by C# compiler.<br>
Main use case for such scenario os to understand how good/faster code is produced by tiered jit. I bet there are scenarios when tiered jid will produce code that is actually worse than non optimized.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk0MTc4MA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk0MTc4MA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk0MTc4MA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478941780">
    <div>
      

  

<details data-body-version="f151cad39fd0eb8086c88b35bfd41dd6">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="f151cad39fd0eb8086c88b35bfd41dd6" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi">@yahorsi</a> ok, now I get it, you want to compare performance results for different JIT tiers. I'm not sure that it's correct to call the first tier of the JIT "unoptimized code." Each tier of the JIT-compiler can work in both optimized and unoptimized mode. The first tier doesn't produce very smart native code, but it doesn't mean that it's "unoptimized code" in general case because optimizations can be enabled or disabled.</p>
<p>Currently, it's impossible to compare different tiers with the help of BenchmarkDotNet because we can't control the tier for each method. I guess we need some advanced API for that on the CoreCLR/CoreFX side.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk0NTYyNQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk0NTYyNQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk0NTYyNQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478945625">
    <div>
      

  

<details data-body-version="31b6886cb966f1b9da89d1ec7c7ae7cf">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="31b6886cb966f1b9da89d1ec7c7ae7cf" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>because we can't control the tier for each method</p>
</blockquote>
<p>Well, then we cannot compare apples to apples. We don't know how the target method will be optimized and simply cant compare. Looks like that is what's going on in my benchmark</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk0ODI5Mw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk0ODI5Mw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk0ODI5Mw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478948293">
    <div>
      

  

<details data-body-version="2110ae7ee44d38cf5f46a82f437f09b7">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="2110ae7ee44d38cf5f46a82f437f09b7" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>When tiered jitting is enabled, it's a good idea to manually increase the total number of warmup iterations to be sure that we use the last tier everywhere. I will think what can we don on the BenchmarkDotNet side, to improve the user experience.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk1MDAzOQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk1MDAzOQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk1MDAzOQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478950039">
    <div>
      

  

<details data-body-version="00fea85b5ac890fdcddf22feb6029ad0">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="00fea85b5ac890fdcddf22feb6029ad0" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>that we use the last tier everywhere.</p>
</blockquote>
<p>Tooo what?</p>
<p>I actually was trying to do this and in samples found SimpleJob, but, I didn't find any docs on SimpleJob and it members and have no idea what's are the best values to force the benchmark to run on most optimized jitted code.<br>
And, there is ShortRunJob that is not documented as well. Just 1 QA without mentioning what these 2 guys are</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk1ODkxOA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk1ODkxOA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk1ODkxOA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478958918">
    <div>
      

  

<details data-body-version="b2c1cd707cfd45fdf9bc25e491f3cab6">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="b2c1cd707cfd45fdf9bc25e491f3cab6" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Yeah, thereâ€™s room for improvement in the documentation.<br>
<code>SimpleJob</code> allows setting the number of warmup iterations as follows:</p>
<div><pre>[<span>SimpleJob</span>(<span>warmupCount</span>: <span>100</span>)]</pre></div>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk2MTQ0NQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk2MTQ0NQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk2MTQ0NQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478961445">
    <div>
      

  

<details data-body-version="c84052fa55715939754f010e2a0679d1">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="c84052fa55715939754f010e2a0679d1" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>warmupCount is more or less easy to understand :)<br>
How about others, like targetCount, invocationCount and launchCount? :)</p>
<p>Do you think 100 for warmupCount will be enouth?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk2NDYwMA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk2NDYwMA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk2NDYwMA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478964600">
    <div>
      

  

<details data-body-version="2df324f36004aa281db1cab2b399e0b9">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="2df324f36004aa281db1cab2b399e0b9" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>You can find a description of these terms here: <a rel="nofollow" href="https://benchmarkdotnet.org/articles/guides/how-it-works.html">https://benchmarkdotnet.org/articles/guides/how-it-works.html</a></p>
<blockquote>
<p>Do you think 100 for warmupCount will be enough?</p>
</blockquote>
<p>I hope so. =) By default, BenchmarkDotNet performs only 15 warmup iteration, but this number may be increased if observed measurements are "not stable enough".</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk2NjIwNA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk2NjIwNA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk2NjIwNA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478966204">
    <div>
      

  

<details data-body-version="96384ee7e7acd50b8e4847e8e23a1ef3">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="96384ee7e7acd50b8e4847e8e23a1ef3" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Well, as I understand:</p>
<ol>
<li>launchCount - How many times we create process. Once we have created process we</li>
<li>run warming up, count is defined in the warmupCount</li>
<li>run benchmark , count is defined in the invocationCount</li>
</ol>
<p>But, what is targetCount? It is not mentioned on the article you mention</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk3NDM5Mw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk3NDM5Mw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk3NDM5Mw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478974393">
    <div>
      

  

<details data-body-version="b058d9e79ceb602436f0b8edc3b0544b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="b058d9e79ceb602436f0b8edc3b0544b" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>We had a huge renaming recently; however, we missed a few occurrences. =(<br>
<code>TargetCount</code> or <code>IterationCount</code> is the number of actual iteration which will be measured (all warmup iterations don't affect results).<br>
<code>invocationCount</code> is the number of benchmark method invocation inside each iteration.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk3NTY2Mg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk3NTY2Mg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk3NTY2Mg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478975662">
    <div>
      

  

<details data-body-version="dd7086b99434afc0915cff0e39091114">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="dd7086b99434afc0915cff0e39091114" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Well I run my benchmark with manually set WithLaunchCount=1, WithWarmupCount=1000, WithInvocationCount=1000000 and for the case when tiered jit is enabled results are very different comparing to the run with default values. Basicly, for the tiered comp = 1 benchmark reports 0 durations.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk3NzU0MA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk3NzU0MA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk3NzU0MA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478977540">
    <div>
      

  

<details data-body-version="2e9739f1cefe0faf58b7db1fbc82a3e0">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="2e9739f1cefe0faf58b7db1fbc82a3e0" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>for the case when tiered jit is enabled results are very different comparing to the run with default values</p>
</blockquote>
<p>Well, it should be a tiered jitting effect.</p>
<blockquote>
<p>Basicly, for the tiered comp = 1 benchmark reports 0 durations.</p>
</blockquote>
<p>What do you mean?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk4NzEyOA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk4NzEyOA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk4NzEyOA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478987128">
    <div>
      

  

<details data-body-version="3f7092f42604a86c74077dd74f26a34b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="3f7092f42604a86c74077dd74f26a34b" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>What do you mean?</p>
</blockquote>
<p>Ignore<br>
The outcome of the todays research is following:<br>
Currently DotnetBenchmark produces the results that cannot be trusted because it does not explicitly control how code is jitted. Number of warmup iterations may vary from benchmark to benchmark and from run to run and that, currently, significantly affects code performance. One benchmark could be jitted with minimum optimisations, another with more optimisations. If current .NET Core does not allows to set the tier explicitly then IMHO it must be raised as an seriouse issue as does not allow to build robust benchmarks.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk4OTcwNA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ3ODk4OTcwNA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ3ODk4OTcwNA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-478989704">
    <div>
      

  

<details data-body-version="2b4c9ed676a5e3528feb2bb37b2debc7">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="2b4c9ed676a5e3528feb2bb37b2debc7" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>If current .NET Core does not allows to set the tier explicitly then IMHO it must be raised as an seriouse issue as does not allow to build robust benchmarks.</p>
</blockquote>
<p>Agree, I will try to figure out how to resolve this problem. Currently, BenchmarkDotNet should work fine on stable versions of the .NET Core (In .NET Core 2.x, the tiered jitting is disabled by default; .NET Core 3.0 is not released yet). However, we definitely should find a solution before .NET Core 3.0 is released.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ5NTAzODE3Mw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ5NTAzODE3Mw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ5NTAzODE3Mw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/Mrnikbobjeff/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/Mrnikbobjeff"><img height="40" width="40" alt="@Mrnikbobjeff" src="https://avatars3.githubusercontent.com/u/6277666?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-495038173">
    <div>
      

  

<details data-body-version="74735bed6c53ff0828f7200918f8103f">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="74735bed6c53ff0828f7200918f8103f" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>I have looked into Tiered Compilation, here is some Information I could gather:<br>
Typical slot value transitions when tiered compilation is enabled:</p>
<ul>
<li>Initially, the slot contains the method's temporary entry point, which always points to the prestub</li>
<li>After the tier 0 JIT completes, the slot is transitioned to the tier 0 entry point, and the slot is recorded for backpatching</li>
<li>When tiered compilation decides to begin counting calls for the method, the slot is transitioned to the temporary entry point (call counting currently happens in the prestub)</li>
<li>When the call count reaches the tier 1 threshold, the slot is transitioned to the tier 0 entry point and a tier 1 JIT is scheduled</li>
<li>After the tier 1 JIT completes, the slot is transitioned to the tier 1 entry point</li>
</ul>
<p>To determine whether a method is elligable for tiered compilation:</p>
<ul>
<li>It can not be zapped (Functional requirement) NGEN images embed direct calls that we would be unable to detect and redirect</li>
<li>The profiler has not given the command to disable tiered compilation</li>
<li>Not debug mode</li>
<li>If quick JIT is disabled for the startup tier and the module is not ReadyToRun the method would not be tiered currently, making it inelligable for tiering</li>
<li>Is a native method (obviously)<br>
Gleaming over ICorProfiler and the <a href="https://github.com/dotnet/coreclr/blob/master/Documentation/design-docs/code-versioning.md">Code Versioning Spec</a> it seems we can gather information about the current version of the method invoked. This is definitely doable with the information provided, but it sure will be a challenge to get right.</li>
</ul>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMDE5Ng==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMDE5Ng==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDUxMTEzMDE5Ng==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-511130196">
    <div>
      

  

<details data-body-version="2b16ce9cf45a42f596baaebc6862736b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="2b16ce9cf45a42f596baaebc6862736b" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>It seems that the tiered jitting is not such a big issue since .NET Core 3.0 preview 4 (after <a data-error-text="Failed to load issue title" data-id="427316801" data-permission-text="Issue title is private" data-url="https://github.com/dotnet/coreclr/issues/23599" data-hovercard-type="pull_request" data-hovercard-url="/dotnet/coreclr/pull/23599/hovercard" href="https://github.com/dotnet/coreclr/pull/23599">dotnet/coreclr#23599</a> was merged). I close this issue but feel free to create a new one if you notice any problems with tiered jitting on .NET Core 3.0 preview 6+. Also, you can track <a href="https://github.com/dotnet/coreclr/issues/25680">https://github.com/dotnet/coreclr/issues/25680</a> for further discussion about BenchmarkDotNet and tiered jitting.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMTIxNg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMTIxNg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDUxMTEzMTIxNg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/EgorBo/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/EgorBo"><img height="40" width="40" alt="@EgorBo" src="https://avatars1.githubusercontent.com/u/523221?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-511131216">
    <div>
      

  

<details data-body-version="0e87fa350200a9de33abf95fd6a42f9b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMjA4MQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMjA4MQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDUxMTEzMjA4MQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-511132081">
    <div>
      

  

<details data-body-version="04dd3ee5b4d1156fd90e20e9d225e215">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="04dd3ee5b4d1156fd90e20e9d225e215" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p><a data-hovercard-type="user" data-hovercard-url="/users/EgorBo/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/EgorBo">@EgorBo</a> in my experiments I have fluctuations during the warmup stage. I'm curious if it's possible to get a noticeable impact on the actual iterations.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMjQxOQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTEzMjQxOQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDUxMTEzMjQxOQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/EgorBo/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/EgorBo"><img height="40" width="40" alt="@EgorBo" src="https://avatars1.githubusercontent.com/u/523221?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-511132419">
    <div>
      

  

<details data-body-version="81b7f6574c0172320c7377901c0f929b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="81b7f6574c0172320c7377901c0f929b" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>I guess in general R2R code is as fast as IL-to-tier1 but there can be differences, e.g. R2R doesn't use the System.Runtime.Intrinsics API (it's used in some BCL stuff under the hood). so e.g. you benchmark some code and at some point (at the 30th iteration) it recompiles that R2R code, enables intrinsics and the code becomes a bit faster.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTE0NjE5OA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTE0NjE5OA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDUxMTE0NjE5OA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/yahorsi/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/yahorsi"><img height="40" width="40" alt="@yahorsi" src="https://avatars0.githubusercontent.com/u/9819679?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-511146198">
    <div>
      

  

<details data-body-version="33f432b0ac920ec6112af1737b2beeb9">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="33f432b0ac920ec6112af1737b2beeb9" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Ideally, we need a way to explicitly tell how to jit the benchmark. E.g. imagine you have benchmarked code being jitted using tier X and on production it is actually jitted using tier Y, results might be very different...</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTE0NjY2MA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDUxMTE0NjY2MA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDUxMTE0NjY2MA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/AndreyAkinshin/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/AndreyAkinshin"><img height="40" width="40" alt="@AndreyAkinshin" src="https://avatars2.githubusercontent.com/u/2259237?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-511146660">
    <div>
      

  

<details data-body-version="77cef2370ad5b728b010c90201ce0157">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  
</div>


</div>


</div>


  
  







<!-- Rendered timeline since 2020-01-30 23:26:27 -->



            </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>