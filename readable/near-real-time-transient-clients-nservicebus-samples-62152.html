<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Near Real-Time Transient Clients &#x2022; NServiceBus Samples - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Near Real-Time Transient Clients &#x2022; NServiceBus Samples - linksfor.dev(s)"/>
    <meta property="og:description" content="How to relay NServiceBus events to occasionally-connected clients via SignalR."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://docs.particular.net/samples/near-realtime-clients/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Near Real-Time Transient Clients &#x2022; NServiceBus Samples</title>
<div class="readable">
        <h1>Near Real-Time Transient Clients &#x2022; NServiceBus Samples</h1>
            <div>Reading time: 5-6 minutes</div>
        <div>Posted here: 27 May 2020</div>
        <p><a href="https://docs.particular.net/samples/near-realtime-clients/">https://docs.particular.net/samples/near-realtime-clients/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div> <p>SignalR can be used in a variety of ways. Browse the official <a href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/signalr?tabs=visual-studio&amp;view=aspnetcore-2.2">SignalR tutorials</a> and <a href="https://github.com/aspnet/SignalR-samples">SignalR samples</a> for information on how to use SignalR. This document focusses on how to relay NServiceBus events to SignalR clients.</p> <p>For near real-time, occasionally connected clients, messages are only relevant for a short period of time. Clients that received near real-time stock ticker updates are a common example of these types of clients.</p> <p>One of the basic features of message queuing is the ability for the receiving endpoints to maintain service even when offline. In this scenario, the long lasting, durable nature of message queuing can result in a backlog of messages that are no longer relevant which, if disconnected long enough, can result in queue quotas being exceeded. This can ultimately result in exceptions on the message sender possibly impacting other parts of the system.</p> <p>A possible answer is to <a href="https://docs.particular.net/nservicebus/messaging/publish-subscribe/controlling-what-is-subscribed#manually-subscribing-to-a-message">unsubscribe</a> on shutdown. This is a fragile option since the client may not successfully complete the unsubscribe when a crash occurs.</p> <p>Another solution is to avoid implementing each client as an NServiceBus endpoint, but instead use a push technology, such as <a href="https://signalr.net/">SignalR</a>, to update clients only while they are connected.</p> <p>This sample demonstrates how to use a SignalR server, which also acts as an NServiceBus endpoint, to push subscribed NServiceBus events to any connected SignalR clients.</p> <h2><a name="project-structure" href="#project-structure"><span></span></a>Project structure</h2> <p>Before running the sample, review the solution structure, the projects, and the classes. The projects <code>Publisher</code> and <code>ClientHub</code> are command-line applications that host an instance of NServiceBus.</p> <p>The <code>ClientHub</code> project also hosts a SignalR server. The <code>Client</code> project is a command-line application that hosts a SignalR client.</p> <h2><a name="sharing-message-types-with-signalr" href="#sharing-message-types-with-signalr"><span></span></a>Sharing message types with SignalR</h2> <p>The <code>StockEvents</code> project contains the definition a message class that is shared with both NServiceBus endpoints, the SignalR hub, and the SignalR client. Open "StockTick" to see the message that will be published by this sample. Note that this event is defined using <a href="https://docs.particular.net/nservicebus/messaging/unobtrusive-mode">unobtrusive mode message conventions</a>, allowing the <code>Client</code> project, which only uses SignalR, to reference the message type without requiring a reference to NServiceBus.</p>  <div> <div>  <div id="messageconventionsfornonnsb-nservicebus-v7_xId"> <pre><code><span>var</span> conventions = endpointConfiguration.Conventions();
conventions.DefiningEventsAs(type =&gt; type == <span>typeof</span>(StockTick));
</code></pre> </div> </div> </div>  <h2><a name="hosting-signalr-with-nservicebus" href="#hosting-signalr-with-nservicebus"><span></span></a>Hosting SignalR with NServiceBus</h2> <p>The sample shows how to host a self-hosted SignalR 2 server side-by-side with an NServiceBus endpoint. For more information on using SignalR Self-Host, see <a href="https://docs.microsoft.com/en-us/aspnet/signalr/overview/deployment/tutorial-signalr-self-host">the SignalR Self-Host tutorial</a>.</p> <h2><a name="bridging-the-bus-to-clients-using-signalr" href="#bridging-the-bus-to-clients-using-signalr"><span></span></a>Bridging the bus to clients using SignalR</h2> <p>The <code>ClientHub</code> project subscribes to the <code>StockTick</code> event published by <code>Publisher</code>.</p> <p><code>StockTickHub</code> defines an <code>async</code> method, <code>ForwardStockTick</code> that sends the <code>StockTick</code> message to the connected SignalR clients.</p>  <div> <div>  <div id="stocktickhub-nservicebus-v7_xId"> <pre><code><span>public</span> <span>class</span> <span>StockTicksHub</span> :
    <span>Hub</span>&lt;<span>IEmitStockTicks</span>&gt;
{
}

<span>public</span> <span>interface</span> <span>IEmitStockTicks</span>
{
    <span>Task <span>PushStockTick</span>(<span>StockTick tick</span>)</span>;
}
</code></pre> </div> </div> </div>  <p>When the <code>StockTick</code> event is handled, it invokes the <code>ForwardStockTick</code> method on the <code>StockTickHub</code>.</p>  <div> <div>  <div id="stocktickhandler-nservicebus-v7_xId"> <pre><code><span>public</span> <span>class</span> <span>StockTickHandler</span> :
    <span>IHandleMessages</span>&lt;<span>StockTick</span>&gt;
{
    <span>static</span> ILog log = LogManager.GetLogger&lt;StockTickHandler&gt;();
    IHubContext hub = GlobalHost.ConnectionManager.GetHubContext&lt;StockTicksHub&gt;();

    <span><span>public</span> Task <span>Handle</span>(<span>StockTick message, IMessageHandlerContext context</span>)
    </span>{
        log.Info(<span>$"StockTick event received for Symbol <span>{message.Symbol}</span> with timestamp: <span>{message.Timestamp:O}</span>. Press any key to exit."</span>);
        <span>return</span> hub.Clients.All.PushStockTick(message);
    }
}
</code></pre> </div> </div> </div>  <h2><a name="web-applications" href="#web-applications"><span></span></a>Web applications</h2> <p>In this sample, the SignalR client is implemented as a .NET console application. The client could also be implemented using the JavaScript SignalR client hosted in a web application.</p> <h2><a name="scaling-out-signalr-with-nservicebus" href="#scaling-out-signalr-with-nservicebus"><span></span></a>Scaling out SignalR with NServiceBus</h2> <p>When the number of connected clients exceeds the capability of a single SignalR server, it will be necessary to scale out the SignalR server. Scaling out SignalR is described in the <a href="https://docs.microsoft.com/en-us/aspnet/signalr/overview/performance/scaleout-in-signalr">Introduction to Scaleout in SignalR</a> article by Microsoft.</p> 
<div data-processed="true"><svg id="mermaid-1590570140379" width="100%" xmlns="http://www.w3.org/2000/svg" style="max-width: 860.6070251464844px;" viewBox="0 0 860.6070251464844 850.0406188964844"><g transform="translate(-12, -12)"><g><g><g id="subGraph2" transform="translate(368.35546875,813.0406188964844)" style="opacity: 1;"><rect width="696.7109375" height="82" x="-348.35546875" y="-41"></rect><g><g transform="translate(0,0)"><foreignObject width="0" height="0"></foreignObject></g></g><text x="0" y="-27" fill="black" stroke="none" id="mermaid-1590570140379Text" style="text-anchor: middle;">Load Balancer</text></g><g id="subGraph1" transform="translate(527.849609375,543.0203094482422)" style="opacity: 1;"><rect width="295.43359375" height="310.0406188964844" x="-147.716796875" y="-155.0203094482422"></rect><g><g transform="translate(0,0)"><foreignObject width="0" height="0"></foreignObject></g></g><text x="0" y="-141.0203094482422" fill="black" stroke="none" id="mermaid-1590570140379Text" style="text-anchor: middle;">Scaled-out Server 2</text></g><g id="subGraph0" transform="translate(426.7464828491211,220)" style="opacity: 1;"><rect width="761.6804656982422" height="188" x="-380.8402328491211" y="-94"></rect><g><g transform="translate(0,0)"><foreignObject width="0" height="0"></foreignObject></g></g><text x="0" y="-80" fill="black" stroke="none" id="mermaid-1590570140379Text" style="text-anchor: middle;">Scaled-out Server 1</text></g></g><g><g style="opacity: 1;"><path d="M275.1953125,52L275.1953125,89L275.1953125,126L275.1953125,151" marker-end="url(#arrowhead106)" style="fill:none"></path><defs><marker id="arrowhead106" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M275.1953125,183L275.1953125,220L275.1953125,257" marker-end="url(#arrowhead107)" style="fill:none"></path><defs><marker id="arrowhead107" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M502.4296875,506.0203094482422L502.4296875,604.0406188964844L505.7975383254717,641.0406188964844" marker-end="url(#arrowhead108)" style="fill:none"></path><defs><marker id="arrowhead108" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M321.65625,276.717662758606L787.5867156982422,314L787.5867156982422,351L787.5867156982422,388L788.0867156982421,413.5000030517581" marker-end="url(#arrowhead109)" style="fill:none"></path><defs><marker id="arrowhead109" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M742.7961620387583,522.2500682887585L624.8359375,604.0406188964844L542.750368514151,641.0406188964844" marker-end="url(#arrowhead110)" style="fill:none"></path><defs><marker id="arrowhead110" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M228.734375,284.65911155740446L111.8125,314L111.8125,351L111.8125,388L111.8125,490.0203094482422L111.8125,604.0406188964844L111.8125,657.0406188964844L111.8125,698.0406188964844L111.8125,735.0406188964844L111.8125,772.0406188964844L111.8125,797.0406188964844" marker-end="url(#arrowhead111)" style="fill:none"></path><defs><marker id="arrowhead111" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M275.1953125,289L275.1953125,314L275.1953125,351L275.1953125,388L275.1953125,490.0203094482422L275.1953125,604.0406188964844L275.1953125,657.0406188964844L275.1953125,698.0406188964844L275.1953125,735.0406188964844L275.1953125,772.0406188964844L275.1953125,797.0406188964844" marker-end="url(#arrowhead112)" style="fill:none"></path><defs><marker id="arrowhead112" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M489.3133574695122,673.0406188964844L461.28125,698.0406188964844L461.28125,735.0406188964844L461.28125,772.0406188964844L461.28125,797.0406188964844" marker-end="url(#arrowhead113)" style="fill:none"></path><defs><marker id="arrowhead113" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g style="opacity: 1;"><path d="M553.1395769817074,673.0406188964844L624.8359375,698.0406188964844L624.8359375,735.0406188964844L624.8359375,772.0406188964844L624.8359375,797.0406188964844" marker-end="url(#arrowhead114)" style="fill:none"></path><defs><marker id="arrowhead114" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g><g style="opacity: 1;" transform="translate(275.1953125,89)"><g transform="translate(-41.578125,-12)"><foreignObject width="83.15625" height="24"><p><span>NSB Event</span></p></foreignObject></g></g><g style="opacity: 1;" transform="translate(275.1953125,220)"><g transform="translate(-31.1796875,-12)"><foreignObject width="62.359375" height="24"><p><span>Forward</span></p></foreignObject></g></g><g style="opacity: 1;" transform="translate(502.4296875,604.0406188964844)"><g transform="translate(-31.1796875,-12)"><foreignObject width="62.359375" height="24"><p><span>Forward</span></p></foreignObject></g></g><g style="opacity: 1;" transform="translate(787.5867156982422,351)"><g transform="translate(-38.2734375,-12)"><foreignObject width="76.546875" height="24"><p><span>Broadcast</span></p></foreignObject></g></g><g style="opacity: 1;" transform=""><g transform="translate(0,0)"><foreignObject width="0" height="0"></foreignObject></g></g><g style="opacity: 1;" transform="translate(111.8125,604.0406188964844)"><g transform="translate(-66.625,-12)"><foreignObject width="133.25" height="24"><p><span>SignalR Message</span></p></foreignObject></g></g><g style="opacity: 1;" transform="translate(275.1953125,604.0406188964844)"><g transform="translate(-66.625,-12)"><foreignObject width="133.25" height="24"><p><span>SignalR Message</span></p></foreignObject></g></g><g style="opacity: 1;" transform="translate(461.28125,735.0406188964844)"><g transform="translate(-66.625,-12)"><foreignObject width="133.25" height="24"><p><span>SignalR Message</span></p></foreignObject></g></g><g style="opacity: 1;" transform="translate(624.8359375,735.0406188964844)"><g transform="translate(-66.625,-12)"><foreignObject width="133.25" height="24"><p><span>SignalR Message</span></p></foreignObject></g></g></g><g><g id="CA" transform="translate(111.8125,813.0406188964844)" style="opacity: 1;"><rect rx="5" ry="5" x="-56.8125" y="-16" width="113.625" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-46.8125,-6)"><foreignObject width="93.625" height="12"><p>SignalR Client A</p></foreignObject></g></g></g><g id="CB" transform="translate(275.1953125,813.0406188964844)" style="opacity: 1;"><rect rx="5" ry="5" x="-56.5703125" y="-16" width="113.140625" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-46.5703125,-6)"><foreignObject width="93.140625" height="12"><p>SignalR Client B</p></foreignObject></g></g></g><g id="CC" transform="translate(461.28125,813.0406188964844)" style="opacity: 1;"><rect rx="5" ry="5" x="-56.6796875" y="-16" width="113.359375" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-46.6796875,-6)"><foreignObject width="93.359375" height="12"><p>SignalR Client C</p></foreignObject></g></g></g><g id="CD" transform="translate(624.8359375,813.0406188964844)" style="opacity: 1;"><rect rx="5" ry="5" x="-56.875" y="-16" width="113.75" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-46.875,-6)"><foreignObject width="93.75" height="12"><p>SignalR Client D</p></foreignObject></g></g></g><g id="NS2" transform="translate(502.4296875,490.0203094482422)" style="opacity: 1;"><rect rx="0" ry="0" x="-87.296875" y="-16" width="174.59375" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-77.296875,-6)"><foreignObject width="154.59375" height="12"><p>NSB Subscriber instance 2</p></foreignObject></g></g></g><g id="SS2" transform="translate(507.25390625,657.0406188964844)" style="opacity: 1;"><rect rx="0" ry="0" x="-46.4609375" y="-16" width="92.921875" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-36.4609375,-6)"><foreignObject width="72.921875" height="12"><p>SignalR Host</p></foreignObject></g></g></g><g id="NS1" transform="translate(275.1953125,167)" style="opacity: 1;"><rect rx="0" ry="0" x="-87.296875" y="-16" width="174.59375" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-77.296875,-6)"><foreignObject width="154.59375" height="12"><p>NSB Subscriber instance 1</p></foreignObject></g></g></g><g id="SS1" transform="translate(275.1953125,273)" style="opacity: 1;"><rect rx="0" ry="0" x="-46.4609375" y="-16" width="92.921875" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-36.4609375,-6)"><foreignObject width="72.921875" height="12"><p>SignalR Host</p></foreignObject></g></g></g><g id="NP" transform="translate(275.1953125,36)" style="opacity: 1;"><rect rx="0" ry="0" x="-51.140625" y="-16" width="102.28125" height="32"></rect><g transform="translate(0,0)"><g transform="translate(-41.140625,-6)"><foreignObject width="82.28125" height="12"><p>NSB Publisher</p></foreignObject></g></g></g><g id="BP" transform="translate(787.5867156982422,490.0203094482422)" style="opacity: 1;"><polygon points="77.0203125,0 154.040625,-77.0203125 77.0203125,-154.040625 0,-77.0203125" rx="5" ry="5" transform="translate(-77.0203125,77.0203125)"></polygon><g transform="translate(0,0)"><g transform="translate(-53.578125,-12)"><foreignObject width="107.15625" height="24"><p>SignalR Backplane<br>(Redis/ASB/SQL)</p></foreignObject></g></g></g></g></g></g></svg></div>
 <p>In this diagram an NServiceBus event is being processed by <a href="https://docs.particular.net/nservicebus/architecture/scaling#scaling-out-to-multiple-nodes-competing-consumers">one of the two subscriber instances</a>. Server 1 is forwarding the NServiceBus event as a SignalR message, which is then broadcast via the configured backplane to Server 2's SignalR server. This allows the connected SignalR clients to receive the message.</p> </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>