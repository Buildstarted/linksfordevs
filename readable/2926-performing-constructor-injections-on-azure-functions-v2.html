<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Performing Constructor Injections on Azure Functions V2 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Performing Constructor Injections on Azure Functions V2</h1><div><div class="markdown text-lg leading-normal text-gray-700 pb-10"><blockquote><p><strong>DISCLAIMER</strong>: This post is purely a personal opinion, not representing or affiliating my employer’s.</p></blockquote><hr><blockquote><p><strong>UPDATE (May 9, 2019)</strong>: During the //Build event, <a href="https://twitter.com/jeffhollan" target="_blank" rel="nofollow noopener noreferrer">Jeff Hollan</a> officially announced this dependency injection. Here's the official document: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-dotnet-dependency-injection" target="_blank" rel="nofollow noopener noreferrer">https://docs.microsoft.com/en-us/azure/azure-functions/functions-dotnet-dependency-injection</a>.</p></blockquote><hr><blockquote><p><strong>UPDATE (Marth 28, 2019)</strong>: As of the current runtime version, <code class="shiki-inline">2.0.12353.0</code>, this constructor injection method has been pulled off for stabilisation purpose. Here's the conversation between myself and <a href="https://twitter.com/jeffhollan" target="_blank" rel="nofollow noopener noreferrer">Jeff Hollan</a> from Azure Functions Team.</p></blockquote><hr><p>In January 2019, Azure Functions Team has released a new version of its runtime, <code class="shiki-inline">2.0.12265</code>.</p><p><img src="https://sa0blogs.blob.core.windows.net/devkimchi/2019/02/getting-rid-of-static-modifier-from-azure-functions-01.png"></p><p>I wasn't able to believe what that meant at the first place.</p><blockquote><p>Does that mean we now can get rid of the infamous <code class="shiki-inline">static</code> modifier from both classes and methods?</p></blockquote><p>In fact, <a href="https://twitter.com/codesapien" target="_blank" rel="nofollow noopener noreferrer">Fabio</a> from Azure Functions Team showed a demo at <a href="https://www.youtube.com/embed/9Ep6N4PtAxc?start=2506" target="_blank" rel="nofollow noopener noreferrer">Ignite 2018</a>, so I wasn't that surprised at all but thought it would be a matter of time. Rather, I was more excited at the new beginning of Azure Functions runtime.</p><p>Maybe it was just me who didn't pay too much attention on this. But, throughout this post, I'm going to walk through how we can chuck out the <code class="shiki-inline">static</code> modifier from the Functions code, and use a constructor for dependency injection.</p><blockquote><p>The sample code used in this post can be found at <a href="https://github.com/devkimchi/Azure-Functions-Instance-Method-Sample" target="_blank" rel="nofollow noopener noreferrer">here</a>.</p></blockquote><h2 id="writing-instance-method"><a href="#writing-instance-method" aria-hidden="true"><span class="icon icon-link"></span></a>Writing Instance Method</h2><p>In C#, classes, fields, properties or methods can have the <code class="shiki-inline">static</code> modifiers. If we put this, regardless the class is instantiated or not, we can directly access to those fields, properties or methods. On the other hand, without the <code class="shiki-inline">static</code> modifier, we can access to them only after the class is instantiated. We call the method of the instance as <code class="shiki-inline">Instance Method</code>. Constructors can only be useful when we define a class without the <code class="shiki-inline">static</code> modifier, with regards to dependency injections.</p><p>The problem that Azure Functions has been keeping so far is that Function classes always comes with the <code class="shiki-inline">static</code> modifier. That has forced each method in the class to have the same <code class="shiki-inline">static</code> modifier as well. This brought about a lot of headaches when considering dependency injections and, in order to sort out this issue, either property injections using a service locator or method injections using custom binding extensions was introduced and these were, in general, not very recommended unless necessary.</p><p>Now, the new Azure Functions runtime enables to get rid of the <code class="shiki-inline">static</code> modifier. Let's have a look at the code below:</p><div><div id="gist94736116" class="gist"><div class="gist-file"><div class="gist-data"><div class="js-gist-file-update-container js-task-list-container file-box"><div id="file-sample-http-trigger-cs" class="file"><div itemprop="text" class="Box-body p-0 blob-wrapper data type-c "><table class="highlight tab-size js-file-line-container" data-tab-size="8"><tbody><tr><td id="file-sample-http-trigger-cs-L1" class="blob-num js-line-number" data-line-number="1"></td><td id="file-sample-http-trigger-cs-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">SampleHttpTrigger</span></td></tr><tr><td id="file-sample-http-trigger-cs-L2" class="blob-num js-line-number" data-line-number="2"></td><td id="file-sample-http-trigger-cs-LC2" class="blob-code blob-code-inner js-file-line">{</td></tr><tr><td id="file-sample-http-trigger-cs-L3" class="blob-num js-line-number" data-line-number="3"></td><td id="file-sample-http-trigger-cs-LC3" class="blob-code blob-code-inner js-file-line">    [<span class="pl-en">FunctionName</span>(<span class="pl-k">nameof</span>(<span class="pl-smi">GetSamples</span>))]</td></tr><tr><td id="file-sample-http-trigger-cs-L4" class="blob-num js-line-number" data-line-number="4"></td><td id="file-sample-http-trigger-cs-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">async</span><span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">GetSamples</span>(</td></tr><tr><td id="file-sample-http-trigger-cs-L5" class="blob-num js-line-number" data-line-number="5"></td><td id="file-sample-http-trigger-cs-LC5" class="blob-code blob-code-inner js-file-line">        [<span class="pl-en">HttpTrigger</span>(<span class="pl-smi">AuthorizationLevel</span>.<span class="pl-smi">Function</span>, <span class="pl-s"><span class="pl-pds">"</span>get<span class="pl-pds">"</span></span>, <span class="pl-en">Route</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>samples<span class="pl-pds">"</span></span>)] <span class="pl-en">HttpRequest</span><span class="pl-smi">req</span>,</td></tr><tr><td id="file-sample-http-trigger-cs-L6" class="blob-num js-line-number" data-line-number="6"></td><td id="file-sample-http-trigger-cs-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-en">ILogger</span><span class="pl-smi">log</span>)</td></tr><tr><td id="file-sample-http-trigger-cs-L7" class="blob-num js-line-number" data-line-number="7"></td><td id="file-sample-http-trigger-cs-LC7" class="blob-code blob-code-inner js-file-line">    {</td></tr><tr><td id="file-sample-http-trigger-cs-L8" class="blob-num js-line-number" data-line-number="8"></td><td id="file-sample-http-trigger-cs-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">name</span><span class="pl-k">=</span><span class="pl-smi">req</span>.<span class="pl-smi">Query</span>[<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>];</td></tr><tr><td id="file-sample-http-trigger-cs-L9" class="blob-num js-line-number" data-line-number="9"></td><td id="file-sample-http-trigger-cs-LC9" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-sample-http-trigger-cs-L10" class="blob-num js-line-number" data-line-number="10"></td><td id="file-sample-http-trigger-cs-LC10" class="blob-code blob-code-inner js-file-line"><span class="pl-k">return</span><span class="pl-k">new</span><span class="pl-en">OkObjectResult</span>(<span class="pl-s"><span class="pl-pds">$"</span>Hello {<span class="pl-smi">name</span>}<span class="pl-pds">"</span></span>);</td></tr><tr><td id="file-sample-http-trigger-cs-L11" class="blob-num js-line-number" data-line-number="11"></td><td id="file-sample-http-trigger-cs-LC11" class="blob-code blob-code-inner js-file-line">    }</td></tr><tr><td id="file-sample-http-trigger-cs-L12" class="blob-num js-line-number" data-line-number="12"></td><td id="file-sample-http-trigger-cs-LC12" class="blob-code blob-code-inner js-file-line">}</td></tr></tbody></table></div></div></div></div></div></div></div><p>Does it look different? Maybe not. But, when you closely look at the class definition – between <code class="shiki-inline">public</code> and <code class="shiki-inline">class</code> – and method definition – between <code class="shiki-inline">public async</code> and <code class="shiki-inline">Task&lt;IActionResult&gt;</code>, there's no <code class="shiki-inline">static</code> modifier any more. Wow, how does this even work? Let's run the Function app. If it runs properly, it should stop at the debugging break point:</p><p><img src="https://sa0blogs.blob.core.windows.net/devkimchi/2019/02/getting-rid-of-static-modifier-from-azure-functions-02.png"></p><p>And its result will look like <code class="shiki-inline">Hello [NAME]</code>.</p><p><img src="https://sa0blogs.blob.core.windows.net/devkimchi/2019/02/getting-rid-of-static-modifier-from-azure-functions-03.png"></p><p>It really is the instance method! This brings up massive implication that we can inject dependencies through constructors!</p><h2 id="injecting-dependencies-via-property"><a href="#injecting-dependencies-via-property" aria-hidden="true"><span class="icon icon-link"></span></a>Injecting Dependencies via Property</h2><p>If you use the library, <a href="https://www.nuget.org/packages/Aliencube.AzureFunctions.Extensions.DependencyInjection/" target="_blank" rel="nofollow noopener noreferrer">Aliencube.AzureFunctions.Extensions.DependencyInjection</a>, property injection can be used. I wrote a <a href="https://platform.deloitte.com.au/articles/dependency-injections-on-azure-functions-v2" target="_blank" rel="nofollow noopener noreferrer">blog post</a> around this property injection a while ago.</p><div><div id="gist94736116" class="gist"><div class="gist-file"><div class="gist-data"><div class="js-gist-file-update-container js-task-list-container file-box"><div id="file-sample-http-trigger-1-cs" class="file"><div itemprop="text" class="Box-body p-0 blob-wrapper data type-c "><table class="highlight tab-size js-file-line-container" data-tab-size="8"><tbody><tr><td id="file-sample-http-trigger-1-cs-L1" class="blob-num js-line-number" data-line-number="1"></td><td id="file-sample-http-trigger-1-cs-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">class</span><span class="pl-en">SampleHttpTrigger1</span></td></tr><tr><td id="file-sample-http-trigger-1-cs-L2" class="blob-num js-line-number" data-line-number="2"></td><td id="file-sample-http-trigger-1-cs-LC2" class="blob-code blob-code-inner js-file-line">{</td></tr><tr><td id="file-sample-http-trigger-1-cs-L3" class="blob-num js-line-number" data-line-number="3"></td><td id="file-sample-http-trigger-1-cs-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IFunctionFactory</span><span class="pl-smi">Factory</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; } <span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">FunctionFactory</span>(<span class="pl-k">new</span><span class="pl-en">AppModule</span>());</td></tr><tr><td id="file-sample-http-trigger-1-cs-L4" class="blob-num js-line-number" data-line-number="4"></td><td id="file-sample-http-trigger-1-cs-LC4" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-sample-http-trigger-1-cs-L5" class="blob-num js-line-number" data-line-number="5"></td><td id="file-sample-http-trigger-1-cs-LC5" class="blob-code blob-code-inner js-file-line">    [<span class="pl-en">FunctionName</span>(<span class="pl-k">nameof</span>(<span class="pl-smi">GetSamples1</span>))]</td></tr><tr><td id="file-sample-http-trigger-1-cs-L6" class="blob-num js-line-number" data-line-number="6"></td><td id="file-sample-http-trigger-1-cs-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">async</span><span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">GetSamples1</span>(</td></tr><tr><td id="file-sample-http-trigger-1-cs-L7" class="blob-num js-line-number" data-line-number="7"></td><td id="file-sample-http-trigger-1-cs-LC7" class="blob-code blob-code-inner js-file-line">        [<span class="pl-en">HttpTrigger</span>(<span class="pl-smi">AuthorizationLevel</span>.<span class="pl-smi">Function</span>, <span class="pl-s"><span class="pl-pds">"</span>post<span class="pl-pds">"</span></span>, <span class="pl-en">Route</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>samples1<span class="pl-pds">"</span></span>)] <span class="pl-en">HttpRequest</span><span class="pl-smi">req</span>,</td></tr><tr><td id="file-sample-http-trigger-1-cs-L8" class="blob-num js-line-number" data-line-number="8"></td><td id="file-sample-http-trigger-1-cs-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-en">ILogger</span><span class="pl-smi">log</span>)</td></tr><tr><td id="file-sample-http-trigger-1-cs-L9" class="blob-num js-line-number" data-line-number="9"></td><td id="file-sample-http-trigger-1-cs-LC9" class="blob-code blob-code-inner js-file-line">    {</td></tr><tr><td id="file-sample-http-trigger-1-cs-L10" class="blob-num js-line-number" data-line-number="10"></td><td id="file-sample-http-trigger-1-cs-LC10" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">options</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">GetSamplesFunctionOptions</span>(<span class="pl-s"><span class="pl-pds">"</span>sample 1<span class="pl-pds">"</span></span>);</td></tr><tr><td id="file-sample-http-trigger-1-cs-L11" class="blob-num js-line-number" data-line-number="11"></td><td id="file-sample-http-trigger-1-cs-LC11" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">result</span><span class="pl-k">=</span><span class="pl-k">await</span><span class="pl-smi">Factory</span>.<span class="pl-en">Create</span>&lt;<span class="pl-en">IGetSamplesFunction</span>, <span class="pl-en">ILogger</span>&gt;(<span class="pl-smi">log</span>)</td></tr><tr><td id="file-sample-http-trigger-1-cs-L12" class="blob-num js-line-number" data-line-number="12"></td><td id="file-sample-http-trigger-1-cs-LC12" class="blob-code blob-code-inner js-file-line">                                  .<span class="pl-en">InvokeAsync</span>&lt;<span class="pl-en">HttpRequest</span>, <span class="pl-en">IActionResult</span>&gt;(<span class="pl-smi">req</span>, <span class="pl-smi">options</span>)</td></tr><tr><td id="file-sample-http-trigger-1-cs-L13" class="blob-num js-line-number" data-line-number="13"></td><td id="file-sample-http-trigger-1-cs-LC13" class="blob-code blob-code-inner js-file-line">                                  .<span class="pl-en">ConfigureAwait</span>(<span class="pl-c1">false</span>);</td></tr><tr><td id="file-sample-http-trigger-1-cs-L14" class="blob-num js-line-number" data-line-number="14"></td><td id="file-sample-http-trigger-1-cs-LC14" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-sample-http-trigger-1-cs-L15" class="blob-num js-line-number" data-line-number="15"></td><td id="file-sample-http-trigger-1-cs-LC15" class="blob-code blob-code-inner js-file-line"><span class="pl-k">return</span><span class="pl-smi">result</span>;</td></tr><tr><td id="file-sample-http-trigger-1-cs-L16" class="blob-num js-line-number" data-line-number="16"></td><td id="file-sample-http-trigger-1-cs-LC16" class="blob-code blob-code-inner js-file-line">    }</td></tr><tr><td id="file-sample-http-trigger-1-cs-L17" class="blob-num js-line-number" data-line-number="17"></td><td id="file-sample-http-trigger-1-cs-LC17" class="blob-code blob-code-inner js-file-line">}</td></tr></tbody></table></div></div></div></div></div></div></div><p>The <code class="shiki-inline">static</code> property implements the <code class="shiki-inline">FunctionFactory</code> class through the <code class="shiki-inline">IFunctionFactory</code> interface and it accepts <code class="shiki-inline">AppModule</code> instance as its dependency, which registers all dependencies. The <code class="shiki-inline">AppModule</code> class actually looks like this:</p><div><div id="gist94736116" class="gist"><div class="gist-file"><div class="gist-data"><div class="js-gist-file-update-container js-task-list-container file-box"><div id="file-app-module-cs" class="file"><div itemprop="text" class="Box-body p-0 blob-wrapper data type-c "><table class="highlight tab-size js-file-line-container" data-tab-size="8"><tbody><tr><td id="file-app-module-cs-L1" class="blob-num js-line-number" data-line-number="1"></td><td id="file-app-module-cs-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">AppModule</span> : <span class="pl-en">Module</span></td></tr><tr><td id="file-app-module-cs-L2" class="blob-num js-line-number" data-line-number="2"></td><td id="file-app-module-cs-LC2" class="blob-code blob-code-inner js-file-line">{</td></tr><tr><td id="file-app-module-cs-L3" class="blob-num js-line-number" data-line-number="3"></td><td id="file-app-module-cs-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">override</span><span class="pl-k">void</span><span class="pl-en">Load</span>(<span class="pl-en">IServiceCollection</span><span class="pl-smi">services</span>)</td></tr><tr><td id="file-app-module-cs-L4" class="blob-num js-line-number" data-line-number="4"></td><td id="file-app-module-cs-LC4" class="blob-code blob-code-inner js-file-line">    {</td></tr><tr><td id="file-app-module-cs-L5" class="blob-num js-line-number" data-line-number="5"></td><td id="file-app-module-cs-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">services</span>.<span class="pl-en">AddSingleton</span>&lt;<span class="pl-en">AppSettings</span>&gt;();</td></tr><tr><td id="file-app-module-cs-L6" class="blob-num js-line-number" data-line-number="6"></td><td id="file-app-module-cs-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">services</span>.<span class="pl-en">AddTransient</span>&lt;<span class="pl-en">IGetSamplesFunction</span>, <span class="pl-en">GetSamplesFunction</span>&gt;();</td></tr><tr><td id="file-app-module-cs-L7" class="blob-num js-line-number" data-line-number="7"></td><td id="file-app-module-cs-LC7" class="blob-code blob-code-inner js-file-line">    }</td></tr><tr><td id="file-app-module-cs-L8" class="blob-num js-line-number" data-line-number="8"></td><td id="file-app-module-cs-LC8" class="blob-code blob-code-inner js-file-line">}</td></tr></tbody></table></div></div></div></div></div></div></div><p>Throughout <code class="shiki-inline">AppModule</code>, the <code class="shiki-inline">GetSamplesFunction</code> instance is registered as <code class="shiki-inline">IGetSamplesFunction</code> and the function method invokes it. Now, let's keep the same structure but just remove the <code class="shiki-inline">static</code> modifier.</p><h2 id="injecting-dependencies-via-constructor"><a href="#injecting-dependencies-via-constructor" aria-hidden="true"><span class="icon icon-link"></span></a>Injecting Dependencies via Constructor</h2><p>The approach that new Azure Functions runtime takes is to use <code class="shiki-inline">StartUp</code> class, which is similar to what ASP.NET Core app does. There's no longer <code class="shiki-inline">AppModule</code> necessary. Let's have a look at the code below:</p><div><div id="gist94736116" class="gist"><div class="gist-file"><div class="gist-data"><div class="js-gist-file-update-container js-task-list-container file-box"><div id="file-startup-cs" class="file"><div itemprop="text" class="Box-body p-0 blob-wrapper data type-c "><table class="highlight tab-size js-file-line-container" data-tab-size="8"><tbody><tr><td id="file-startup-cs-L1" class="blob-num js-line-number" data-line-number="1"></td><td id="file-startup-cs-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span> Registger assembly</span></td></tr><tr><td id="file-startup-cs-L2" class="blob-num js-line-number" data-line-number="2"></td><td id="file-startup-cs-LC2" class="blob-code blob-code-inner js-file-line">[<span class="pl-k">assembly</span>: <span class="pl-en">WebJobsStartup</span>(<span class="pl-k">typeof</span>(<span class="pl-en">StartUp</span>))]</td></tr><tr><td id="file-startup-cs-L3" class="blob-num js-line-number" data-line-number="3"></td><td id="file-startup-cs-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">namespace</span><span class="pl-en">Sample</span>.<span class="pl-en">FunctionApp</span></td></tr><tr><td id="file-startup-cs-L4" class="blob-num js-line-number" data-line-number="4"></td><td id="file-startup-cs-LC4" class="blob-code blob-code-inner js-file-line">{</td></tr><tr><td id="file-startup-cs-L5" class="blob-num js-line-number" data-line-number="5"></td><td id="file-startup-cs-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span> Implement IWebJobStartup interface.</span></td></tr><tr><td id="file-startup-cs-L6" class="blob-num js-line-number" data-line-number="6"></td><td id="file-startup-cs-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">StartUp</span> : <span class="pl-en">IWebJobsStartup</span></td></tr><tr><td id="file-startup-cs-L7" class="blob-num js-line-number" data-line-number="7"></td><td id="file-startup-cs-LC7" class="blob-code blob-code-inner js-file-line">    {</td></tr><tr><td id="file-startup-cs-L8" class="blob-num js-line-number" data-line-number="8"></td><td id="file-startup-cs-LC8" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Configure</span>(<span class="pl-en">IWebJobsBuilder</span><span class="pl-smi">builder</span>)</td></tr><tr><td id="file-startup-cs-L9" class="blob-num js-line-number" data-line-number="9"></td><td id="file-startup-cs-LC9" class="blob-code blob-code-inner js-file-line">        {</td></tr><tr><td id="file-startup-cs-L10" class="blob-num js-line-number" data-line-number="10"></td><td id="file-startup-cs-LC10" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">builder</span>.<span class="pl-smi">Services</span>.<span class="pl-en">AddSingleton</span>&lt;<span class="pl-en">AppSettings</span>&gt;();</td></tr><tr><td id="file-startup-cs-L11" class="blob-num js-line-number" data-line-number="11"></td><td id="file-startup-cs-LC11" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-startup-cs-L12" class="blob-num js-line-number" data-line-number="12"></td><td id="file-startup-cs-LC12" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">builder</span>.<span class="pl-smi">Services</span>.<span class="pl-en">AddTransient</span>&lt;<span class="pl-en">IGetSamplesFunction</span>, <span class="pl-en">GetSamplesFunction</span>&gt;();</td></tr><tr><td id="file-startup-cs-L13" class="blob-num js-line-number" data-line-number="13"></td><td id="file-startup-cs-LC13" class="blob-code blob-code-inner js-file-line">        }</td></tr><tr><td id="file-startup-cs-L14" class="blob-num js-line-number" data-line-number="14"></td><td id="file-startup-cs-LC14" class="blob-code blob-code-inner js-file-line">    }</td></tr><tr><td id="file-startup-cs-L15" class="blob-num js-line-number" data-line-number="15"></td><td id="file-startup-cs-LC15" class="blob-code blob-code-inner js-file-line">}</td></tr></tbody></table></div></div></div></div></div></div></div><p>The <code class="shiki-inline">StartUp</code> class implements the <code class="shiki-inline">IWebJobStartup</code> interface, which only defines one method, <code class="shiki-inline">Configure(IWebjobBuilder builder)</code>. In addition to that, it uses the decorator, <a href="https://github.com/Azure/azure-webjobs-sdk/blob/b9c8afd097ea270f693b1f1e897c14e27b838eec/src/Microsoft.Azure.WebJobs.Host/Hosting/WebJobsStartupAttribute.cs#L12" target="_blank" rel="nofollow noopener noreferrer"><code class="shiki-inline">WebJobsStartupAttribute</code> targeting <code class="shiki-inline">AttributeTargets.Assembly</code></a>, which registers dependencies as a part of starting up the host runtime. Let's see how dependencies are registered through the constructor.</p><div><div id="gist94736116" class="gist"><div class="gist-file"><div class="gist-data"><div class="js-gist-file-update-container js-task-list-container file-box"><div id="file-sample-http-trigger-2-cs" class="file"><div itemprop="text" class="Box-body p-0 blob-wrapper data type-c "><table class="highlight tab-size js-file-line-container" data-tab-size="8"><tbody><tr><td id="file-sample-http-trigger-2-cs-L1" class="blob-num js-line-number" data-line-number="1"></td><td id="file-sample-http-trigger-2-cs-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">SampleHttpTrigger2</span></td></tr><tr><td id="file-sample-http-trigger-2-cs-L2" class="blob-num js-line-number" data-line-number="2"></td><td id="file-sample-http-trigger-2-cs-LC2" class="blob-code blob-code-inner js-file-line">{</td></tr><tr><td id="file-sample-http-trigger-2-cs-L3" class="blob-num js-line-number" data-line-number="3"></td><td id="file-sample-http-trigger-2-cs-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">private</span><span class="pl-k">readonly</span><span class="pl-en">IGetSamplesFunction</span><span class="pl-smi">_function</span>;</td></tr><tr><td id="file-sample-http-trigger-2-cs-L4" class="blob-num js-line-number" data-line-number="4"></td><td id="file-sample-http-trigger-2-cs-LC4" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-sample-http-trigger-2-cs-L5" class="blob-num js-line-number" data-line-number="5"></td><td id="file-sample-http-trigger-2-cs-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-en">SampleHttpTrigger2</span>(<span class="pl-en">IGetSamplesFunction</span><span class="pl-smi">function</span>)</td></tr><tr><td id="file-sample-http-trigger-2-cs-L6" class="blob-num js-line-number" data-line-number="6"></td><td id="file-sample-http-trigger-2-cs-LC6" class="blob-code blob-code-inner js-file-line">    {</td></tr><tr><td id="file-sample-http-trigger-2-cs-L7" class="blob-num js-line-number" data-line-number="7"></td><td id="file-sample-http-trigger-2-cs-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-k">this</span>.<span class="pl-smi">_function</span><span class="pl-k">=</span><span class="pl-smi">function</span><span class="pl-k">??</span><span class="pl-k">throw</span><span class="pl-k">new</span><span class="pl-en">ArgumentNullException</span>(<span class="pl-k">nameof</span>(<span class="pl-smi">function</span>));</td></tr><tr><td id="file-sample-http-trigger-2-cs-L8" class="blob-num js-line-number" data-line-number="8"></td><td id="file-sample-http-trigger-2-cs-LC8" class="blob-code blob-code-inner js-file-line">    }</td></tr><tr><td id="file-sample-http-trigger-2-cs-L9" class="blob-num js-line-number" data-line-number="9"></td><td id="file-sample-http-trigger-2-cs-LC9" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-sample-http-trigger-2-cs-L10" class="blob-num js-line-number" data-line-number="10"></td><td id="file-sample-http-trigger-2-cs-LC10" class="blob-code blob-code-inner js-file-line">    [<span class="pl-en">FunctionName</span>(<span class="pl-k">nameof</span>(<span class="pl-smi">GetSamples2</span>))]</td></tr><tr><td id="file-sample-http-trigger-2-cs-L11" class="blob-num js-line-number" data-line-number="11"></td><td id="file-sample-http-trigger-2-cs-LC11" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">async</span><span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">GetSamples2</span>(</td></tr><tr><td id="file-sample-http-trigger-2-cs-L12" class="blob-num js-line-number" data-line-number="12"></td><td id="file-sample-http-trigger-2-cs-LC12" class="blob-code blob-code-inner js-file-line">        [<span class="pl-en">HttpTrigger</span>(<span class="pl-smi">AuthorizationLevel</span>.<span class="pl-smi">Function</span>, <span class="pl-s"><span class="pl-pds">"</span>post<span class="pl-pds">"</span></span>, <span class="pl-en">Route</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>samples2<span class="pl-pds">"</span></span>)] <span class="pl-en">HttpRequest</span><span class="pl-smi">req</span>,</td></tr><tr><td id="file-sample-http-trigger-2-cs-L13" class="blob-num js-line-number" data-line-number="13"></td><td id="file-sample-http-trigger-2-cs-LC13" class="blob-code blob-code-inner js-file-line"><span class="pl-en">ILogger</span><span class="pl-smi">log</span>)</td></tr><tr><td id="file-sample-http-trigger-2-cs-L14" class="blob-num js-line-number" data-line-number="14"></td><td id="file-sample-http-trigger-2-cs-LC14" class="blob-code blob-code-inner js-file-line">    {</td></tr><tr><td id="file-sample-http-trigger-2-cs-L15" class="blob-num js-line-number" data-line-number="15"></td><td id="file-sample-http-trigger-2-cs-LC15" class="blob-code blob-code-inner js-file-line"><span class="pl-k">this</span>.<span class="pl-smi">_function</span>.<span class="pl-smi">Log</span><span class="pl-k">=</span><span class="pl-smi">log</span>;</td></tr><tr><td id="file-sample-http-trigger-2-cs-L16" class="blob-num js-line-number" data-line-number="16"></td><td id="file-sample-http-trigger-2-cs-LC16" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-sample-http-trigger-2-cs-L17" class="blob-num js-line-number" data-line-number="17"></td><td id="file-sample-http-trigger-2-cs-LC17" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">options</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">GetSamplesFunctionOptions</span>(<span class="pl-s"><span class="pl-pds">"</span>sample 2<span class="pl-pds">"</span></span>);</td></tr><tr><td id="file-sample-http-trigger-2-cs-L18" class="blob-num js-line-number" data-line-number="18"></td><td id="file-sample-http-trigger-2-cs-LC18" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">result</span><span class="pl-k">=</span><span class="pl-k">await</span><span class="pl-k">this</span>.<span class="pl-smi">_function</span></td></tr><tr><td id="file-sample-http-trigger-2-cs-L19" class="blob-num js-line-number" data-line-number="19"></td><td id="file-sample-http-trigger-2-cs-LC19" class="blob-code blob-code-inner js-file-line">                               .<span class="pl-en">InvokeAsync</span>&lt;<span class="pl-en">HttpRequest</span>, <span class="pl-en">IActionResult</span>&gt;(<span class="pl-smi">req</span>, <span class="pl-smi">options</span>)</td></tr><tr><td id="file-sample-http-trigger-2-cs-L20" class="blob-num js-line-number" data-line-number="20"></td><td id="file-sample-http-trigger-2-cs-LC20" class="blob-code blob-code-inner js-file-line">                               .<span class="pl-en">ConfigureAwait</span>(<span class="pl-c1">false</span>);</td></tr><tr><td id="file-sample-http-trigger-2-cs-L21" class="blob-num js-line-number" data-line-number="21"></td><td id="file-sample-http-trigger-2-cs-LC21" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-sample-http-trigger-2-cs-L22" class="blob-num js-line-number" data-line-number="22"></td><td id="file-sample-http-trigger-2-cs-LC22" class="blob-code blob-code-inner js-file-line"><span class="pl-k">return</span><span class="pl-smi">result</span>;</td></tr><tr><td id="file-sample-http-trigger-2-cs-L23" class="blob-num js-line-number" data-line-number="23"></td><td id="file-sample-http-trigger-2-cs-LC23" class="blob-code blob-code-inner js-file-line">    }</td></tr><tr><td id="file-sample-http-trigger-2-cs-L24" class="blob-num js-line-number" data-line-number="24"></td><td id="file-sample-http-trigger-2-cs-LC24" class="blob-code blob-code-inner js-file-line">}</td></tr></tbody></table></div></div></div></div></div></div></div><p>The function method still keeps the existing structure, but substitutes the existing <code class="shiki-inline">static</code> property of <code class="shiki-inline">IFunctionFactory</code> with the constructor so that we can minimise the changes on the existing code-base.</p><h2 id="unit-testing-with-constructor-injection"><a href="#unit-testing-with-constructor-injection" aria-hidden="true"><span class="icon icon-link"></span></a>Unit Testing with Constructor Injection</h2><p>Now, we know Azure Function allows constructor injection. Why does this really matter? Let's think of unit testing code. Even before the constructor injection being enabled, we were able to perform unit testing, but it was pretty ugly. Now, we have a constructor, which means the same unit testing can be done in more beautiful way. Let's have a look at the code below:</p><div><div id="gist94736116" class="gist"><div class="gist-file"><div class="gist-data"><div class="js-gist-file-update-container js-task-list-container file-box"><div id="file-get-samples-http-trigger-test-cs" class="file"><div itemprop="text" class="Box-body p-0 blob-wrapper data type-c "><table class="highlight tab-size js-file-line-container" data-tab-size="8"><tbody><tr><td id="file-get-samples-http-trigger-test-cs-L1" class="blob-num js-line-number" data-line-number="1"></td><td id="file-get-samples-http-trigger-test-cs-LC1" class="blob-code blob-code-inner js-file-line">[<span class="pl-en">TestMethod</span>]</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L2" class="blob-num js-line-number" data-line-number="2"></td><td id="file-get-samples-http-trigger-test-cs-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">public</span><span class="pl-k">async</span><span class="pl-en">Task</span><span class="pl-en">Given_Request_Response_Should_Return_Result</span>()</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L3" class="blob-num js-line-number" data-line-number="3"></td><td id="file-get-samples-http-trigger-test-cs-LC3" class="blob-code blob-code-inner js-file-line">{</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L4" class="blob-num js-line-number" data-line-number="4"></td><td id="file-get-samples-http-trigger-test-cs-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">logger</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Mock</span>&lt;<span class="pl-en">ILogger</span>&gt;();</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L5" class="blob-num js-line-number" data-line-number="5"></td><td id="file-get-samples-http-trigger-test-cs-LC5" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L6" class="blob-num js-line-number" data-line-number="6"></td><td id="file-get-samples-http-trigger-test-cs-LC6" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">function</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Mock</span>&lt;<span class="pl-en">IGetSamplesFunction</span>&gt;();</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L7" class="blob-num js-line-number" data-line-number="7"></td><td id="file-get-samples-http-trigger-test-cs-LC7" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">function</span>.<span class="pl-en">SetupProperty</span>(<span class="pl-smi">p</span><span class="pl-k">=&gt;</span><span class="pl-smi">p</span>.<span class="pl-smi">Log</span>, <span class="pl-smi">logger</span>.<span class="pl-smi">Object</span>);</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L8" class="blob-num js-line-number" data-line-number="8"></td><td id="file-get-samples-http-trigger-test-cs-LC8" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L9" class="blob-num js-line-number" data-line-number="9"></td><td id="file-get-samples-http-trigger-test-cs-LC9" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">result</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">ObjectResult</span>(<span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">"</span></span>);</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L10" class="blob-num js-line-number" data-line-number="10"></td><td id="file-get-samples-http-trigger-test-cs-LC10" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">function</span>.<span class="pl-en">Setup</span>(<span class="pl-smi">p</span><span class="pl-k">=&gt;</span><span class="pl-smi">p</span>.<span class="pl-en">InvokeAsync</span>&lt;<span class="pl-en">HttpRequest</span>, <span class="pl-en">IActionResult</span>&gt;(</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L11" class="blob-num js-line-number" data-line-number="11"></td><td id="file-get-samples-http-trigger-test-cs-LC11" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">It</span>.<span class="pl-en">IsAny</span>&lt;<span class="pl-en">HttpRequest</span>&gt;(),</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L12" class="blob-num js-line-number" data-line-number="12"></td><td id="file-get-samples-http-trigger-test-cs-LC12" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">It</span>.<span class="pl-en">IsAny</span>&lt;<span class="pl-en">FunctionOptionsBase</span>&gt;()))</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L13" class="blob-num js-line-number" data-line-number="13"></td><td id="file-get-samples-http-trigger-test-cs-LC13" class="blob-code blob-code-inner js-file-line">        .<span class="pl-en">ReturnsAsync</span>(<span class="pl-smi">result</span>);</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L14" class="blob-num js-line-number" data-line-number="14"></td><td id="file-get-samples-http-trigger-test-cs-LC14" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L15" class="blob-num js-line-number" data-line-number="15"></td><td id="file-get-samples-http-trigger-test-cs-LC15" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">trigger</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">SampleHttpTrigger2</span>(<span class="pl-smi">function</span>.<span class="pl-smi">Object</span>);</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L16" class="blob-num js-line-number" data-line-number="16"></td><td id="file-get-samples-http-trigger-test-cs-LC16" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L17" class="blob-num js-line-number" data-line-number="17"></td><td id="file-get-samples-http-trigger-test-cs-LC17" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">req</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Mock</span>&lt;<span class="pl-en">HttpRequest</span>&gt;();</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L18" class="blob-num js-line-number" data-line-number="18"></td><td id="file-get-samples-http-trigger-test-cs-LC18" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">log</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Mock</span>&lt;<span class="pl-en">ILogger</span>&gt;();</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L19" class="blob-num js-line-number" data-line-number="19"></td><td id="file-get-samples-http-trigger-test-cs-LC19" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L20" class="blob-num js-line-number" data-line-number="20"></td><td id="file-get-samples-http-trigger-test-cs-LC20" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">response</span><span class="pl-k">=</span><span class="pl-k">await</span><span class="pl-smi">trigger</span>.<span class="pl-en">GetSamples2</span>(<span class="pl-smi">req</span>.<span class="pl-smi">Object</span>, <span class="pl-smi">log</span>.<span class="pl-smi">Object</span>).<span class="pl-en">ConfigureAwait</span>(<span class="pl-c1">false</span>);</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L21" class="blob-num js-line-number" data-line-number="21"></td><td id="file-get-samples-http-trigger-test-cs-LC21" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">response</span>.<span class="pl-en">Should</span>().<span class="pl-en">BeOfType</span>&lt;<span class="pl-en">ObjectResult</span>&gt;();</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L22" class="blob-num js-line-number" data-line-number="22"></td><td id="file-get-samples-http-trigger-test-cs-LC22" class="blob-code blob-code-inner js-file-line"></td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L23" class="blob-num js-line-number" data-line-number="23"></td><td id="file-get-samples-http-trigger-test-cs-LC23" class="blob-code blob-code-inner js-file-line"><span class="pl-k">var</span><span class="pl-smi">@return</span><span class="pl-k">=</span><span class="pl-smi">response</span><span class="pl-k">as</span><span class="pl-en">ObjectResult</span>;</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L24" class="blob-num js-line-number" data-line-number="24"></td><td id="file-get-samples-http-trigger-test-cs-LC24" class="blob-code blob-code-inner js-file-line"><span class="pl-smi">@return</span>.<span class="pl-smi">Value</span>.<span class="pl-en">Should</span>().<span class="pl-en">Be</span>(<span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">"</span></span>);</td></tr><tr><td id="file-get-samples-http-trigger-test-cs-L25" class="blob-num js-line-number" data-line-number="25"></td><td id="file-get-samples-http-trigger-test-cs-LC25" class="blob-code blob-code-inner js-file-line">}</td></tr></tbody></table></div></div></div></div></div></div></div><p>As the <code class="shiki-inline">SampleHttpTrigger</code> class doesn't have the <code class="shiki-inline">static</code> modifier any more, and it accepts a dependency through the constructor, we just simply mock the dependency, <code class="shiki-inline">IGetSamplesFunction</code> here in this example. This is not different from any other unit testing approach at all. Can you see how easy the unit testing is now?</p><h2 id="azure-functions-keeps-growing"><a href="#azure-functions-keeps-growing" aria-hidden="true"><span class="icon icon-link"></span></a>Azure Functions Keeps Growing!</h2><p>So far, we've walked through how to use constructor injection for Azure Functions, without using the <code class="shiki-inline">static</code> modifier. Like Azure WebJobs, Azure Functions, that works very well at the low level like replacing very simple workload, has now evolved to provide more sophisticated features and better development experiences. It is now 1) testable by proper dependency injection that has been dealt in this post, 2) <a href="https://www.youtube.com/watch?v=iZX1O1WSzz4" target="_blank" rel="nofollow noopener noreferrer">deployable by providing container packaging</a>, and 3) <a href="https://devkimchi.com/2019/02/02/introducing-swagger-ui-on-azure-functions/" target="_blank" rel="nofollow noopener noreferrer">discoverable by Open API adoption</a>. With these three aspects, I'm expecting there will be more use cases that we have never seen before.</p><blockquote><p>This was originally posted at <a href="https://platform.deloitte.com.au/articles/performing-constructor-injections-on-azure-functions-v2" target="_blank" rel="nofollow noopener noreferrer">Platform Engineering Blog</a>.</p></blockquote></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>