<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Nick Craver - Why you should wait on upgrading to .Net 4.6 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Nick Craver - Why you should wait on upgrading to .Net 4.6</h1><div><div id="" class="post-content"><p><strong>Update (August 11th):</strong> A patch for this bug has been released by Microsoft. Here’s their update to the advisory:</p><blockquote><p>We released an updated version of RyuJIT today, which resolves this advisory. The update was released as <a href="https://technet.microsoft.com/library/security/ms15-092.aspx">Microsoft Security Bulletin MS15-092</a> and is available on Windows Update or via direct download as <a href="https://support.microsoft.com/kb/3086251">KB3086251</a>. The update resolves: <a href="https://github.com/dotnet/coreclr/issues/1296">CoreCLR #1296</a>, <a href="https://github.com/dotnet/coreclr/issues/1299">CoreCLR #1299</a>, and <a href="https://github.com/Microsoft/visualfsharp/issues/536">VisualFSharp #536</a>. Major thanks to the developers who reported these issues. Thanks to everyone for their patience.</p></blockquote><h3 id="original-post">Original Post</h3><p>What follows is the work of several people: <a href="http://blog.marcgravell.com/">Marc Gravell</a> and I have taken lead on this at Stack Overflow and we continue to coordinate with Microsoft on a resolution. They have fixed the bug internally, but not for users. Given the severity, we can’t in good conscience let such a subtle yet high-impact bug linger silently. <strong>We are not upgrading Stack Overflow to .Net 4.6</strong>, and you shouldn’t upgrade yet either. You can find <a href="https://github.com/dotnet/coreclr/issues/1296">the issue we opened on GitHub (for public awareness) here</a>. <strong>A fix has been released, see Update 5 below</strong>.</p><p><strong>Update #1 (July 27th):</strong><a href="https://github.com/dotnet/coreclr/pull/1298">A pull request has been posted by Matt Michell (Microsoft)</a>.</p><p><strong>Update #2 (July 28th):</strong> There are several smaller repros now (<a href="https://github.com/dotnet/coreclr/issues/1296#issuecomment-125568026">including a small console app</a>). Microsoft has confirmed they are working on an expedited hotfix release but we don’t have details yet.</p><p><strong>Update #3 (July 28th):</strong> Microsoft’s Rich Lander has posted an update: <a href="https://blogs.msdn.microsoft.com/dotnet/2015/07/28/ryujit-bug-advisory-in-the-net-framework-4-6/">RyuJIT Bug Advisory in the .NET Framework 4.6</a>.</p><p><strong>Update #4 (July 29th):</strong> There’s <a href="https://github.com/dotnet/coreclr/issues/1299">another subtle bug</a> found by Andrey Akinshin and the F# Engine Exception <a href="https://github.com/Microsoft/visualfsharp/issues/536#issuecomment-125384182">is confirmed to be a separate issue</a>. I still recommend disabling RyuJIT in production given <a href="https://github.com/dotnet/coreclr/issues?utf8=%E2%9C%93&amp;q=is%3Aissue+RyuJIT">the increasing bug count</a>.</p><p><strong>Update #5 (August 11th):</strong> A patch for this bug has been released by Microsoft, see above.</p><p>This critical bug is specific to .Net 4.6 and RyuJIT (64-bit). I’ll make this big and bold so we get to the point quickly:</p><h3 id="the-methods-you-call-can-get-different-parameter-values-than-you-passed-in">The methods you call can get different parameter values than you passed in.</h3><p>The JIT (Just-in-Time compiler) in .Net (and many platforms) does something called Tail Call optimization. This happens to alleviate stack load on the last-called method in a chain. I won’t go into what a tail call is <a href="https://blogs.msdn.microsoft.com/davbr/2007/06/20/enter-leave-tailcall-hooks-part-2-tall-tales-of-tail-calls/">because there’s already an excellent write up by David Broman</a>.</p><p>The issue here is a bug in how RyuJIT x64 implements this optimization in certain situations. Let’s look at the specific example we hit at Stack Overflow (<a href="https://github.com/StackExchange/RyuJIT-TailCallBug">we have uploaded a minimal version of this reproduction to GitHub</a>).</p><p>We noticed that <a href="http://miniprofiler.com/">MiniProfiler</a> (which we use to track performance) was showing only on the first page load. The profiler then failed to show again until an application recycle. This turned out to be a caching bug based on the HTTP Cache usage locally. HTTP Cache is our “L1” cache at Stack Overflow; <a href="https://redis.io/">redis</a> is typically the “L2.” After over a day of debugging (and sanity checking), we tracked the crazy to here:</p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">void</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span><span class="n">key</span><span class="p">,</span><span class="n">T</span><span class="n">val</span><span class="p">,</span><span class="kt">int</span><span class="p">?</span><span class="n">durationSecs</span><span class="p">,</span><span class="kt">bool</span><span class="n">sliding</span><span class="p">,</span><span class="kt">bool</span><span class="n">broadcastRemoveFromCache</span><span class="p">=</span><span class="k">false</span><span class="p">)</span><span class="p">{</span><span class="n">SetWithPriority</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="n">sliding</span><span class="p">,</span><span class="n">CacheItemPriority</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span><span class="p">}</span><span class="k">void</span><span class="n">SetWithPriority</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span><span class="n">key</span><span class="p">,</span><span class="n">T</span><span class="n">val</span><span class="p">,</span><span class="kt">int</span><span class="p">?</span><span class="n">durationSecs</span><span class="p">,</span><span class="kt">bool</span><span class="n">isSliding</span><span class="p">,</span><span class="n">CacheItemPriority</span><span class="n">priority</span><span class="p">)</span><span class="p">{</span><span class="n">key</span><span class="p">=</span><span class="nf">KeyInContext</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="nf">RawSet</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="n">isSliding</span><span class="p">,</span><span class="n">priority</span><span class="p">);</span><span class="p">}</span><span class="k">void</span><span class="nf">RawSet</span><span class="p">(</span><span class="kt">string</span><span class="n">cacheKey</span><span class="p">,</span><span class="kt">object</span><span class="n">val</span><span class="p">,</span><span class="kt">int</span><span class="p">?</span><span class="n">durationSecs</span><span class="p">,</span><span class="kt">bool</span><span class="n">isSliding</span><span class="p">,</span><span class="n">CacheItemPriority</span><span class="n">priority</span><span class="p">)</span><span class="p">{</span><span class="kt">var</span><span class="n">absolute</span><span class="p">=</span><span class="p">!</span><span class="n">isSliding</span><span class="p">&amp;&amp;</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">HasValue</span><span class="p">?</span><span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="nf">AddSeconds</span><span class="p">(</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="p">:</span><span class="n">Cache</span><span class="p">.</span><span class="n">NoAbsoluteExpiration</span><span class="p">;</span><span class="kt">var</span><span class="n">sliding</span><span class="p">=</span><span class="n">isSliding</span><span class="p">&amp;&amp;</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">HasValue</span><span class="p">?</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="p">:</span><span class="n">Cache</span><span class="p">.</span><span class="n">NoSlidingExpiration</span><span class="p">;</span><span class="n">HttpRuntime</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="n">absolute</span><span class="p">,</span><span class="n">sliding</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="k">null</span><span class="p">);</span><span class="p">}</span></code></pre></figure><p>What was happening? We were setting the MiniProfiler cache duration (passed to <code class="language-plaintext highlighter-rouge">Set&lt;T&gt;</code>) as 3600 seconds. But often (~98% of the time), we were seeing it immediately expire from HTTP cache. Next we narrowed this down to being a bug <strong>only when optimizations are enabled</strong> (the “Optimize Code” checkbox on your project’s build properties). At this point sanity is out the window and you debug <em>everything</em>.</p><p>Here’s what that code looks like now. Note: I have slightly shortened it to fit this page. <a href="https://github.com/StackExchange/RyuJIT-TailCallBug/blob/master/StackRedis/Caches.Local.cs#L403">The unaltered code is on GitHub here</a>.</p><figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">void</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span><span class="n">key</span><span class="p">,</span><span class="n">T</span><span class="n">val</span><span class="p">,</span><span class="kt">int</span><span class="p">?</span><span class="n">durationSecs</span><span class="p">,</span><span class="kt">bool</span><span class="n">sliding</span><span class="p">,</span><span class="kt">bool</span><span class="n">broadcastRemoveFromCache</span><span class="p">=</span><span class="k">false</span><span class="p">)</span><span class="p">{</span><span class="n">LocalCache</span><span class="p">.</span><span class="nf">OnLogDuration</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="s">"LocalCache.Set"</span><span class="p">);</span><span class="n">SetWithPriority</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="n">sliding</span><span class="p">,</span><span class="n">CacheItemPriority</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span><span class="p">}</span><span class="k">void</span><span class="n">SetWithPriority</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span><span class="n">key</span><span class="p">,</span><span class="n">T</span><span class="n">val</span><span class="p">,</span><span class="kt">int</span><span class="p">?</span><span class="n">durationSecs</span><span class="p">,</span><span class="kt">bool</span><span class="n">isSliding</span><span class="p">,</span><span class="n">CacheItemPriority</span><span class="n">priority</span><span class="p">)</span><span class="p">{</span><span class="n">LocalCache</span><span class="p">.</span><span class="nf">OnLogDuration</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="s">"LocalCache.SetWithPriority"</span><span class="p">);</span><span class="n">key</span><span class="p">=</span><span class="nf">KeyInContext</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="nf">RawSet</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="n">isSliding</span><span class="p">,</span><span class="n">priority</span><span class="p">);</span><span class="p">}</span><span class="k">void</span><span class="nf">RawSet</span><span class="p">(</span><span class="kt">string</span><span class="n">cacheKey</span><span class="p">,</span><span class="kt">object</span><span class="k">value</span><span class="p">,</span><span class="kt">int</span><span class="p">?</span><span class="n">durationSecs</span><span class="p">,</span><span class="kt">bool</span><span class="n">isSliding</span><span class="p">,</span><span class="n">CacheItemPriority</span><span class="n">priority</span><span class="p">)</span><span class="p">{</span><span class="n">LocalCache</span><span class="p">.</span><span class="nf">OnLogDuration</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="s">"RawSet"</span><span class="p">);</span><span class="kt">var</span><span class="n">absolute</span><span class="p">=</span><span class="p">!</span><span class="n">isSliding</span><span class="p">&amp;&amp;</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">HasValue</span><span class="p">?</span><span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="nf">AddSeconds</span><span class="p">(</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="p">:</span><span class="n">Cache</span><span class="p">.</span><span class="n">NoAbsoluteExpiration</span><span class="p">;</span><span class="kt">var</span><span class="n">sliding</span><span class="p">=</span><span class="n">isSliding</span><span class="p">&amp;&amp;</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">HasValue</span><span class="p">?</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="n">durationSecs</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="p">:</span><span class="n">Cache</span><span class="p">.</span><span class="n">NoSlidingExpiration</span><span class="p">;</span><span class="n">HttpRuntime</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span><span class="k">value</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="n">absolute</span><span class="p">,</span><span class="n">sliding</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">Removed</span><span class="p">);</span><span class="kt">var</span><span class="n">evt</span><span class="p">=</span><span class="n">Added</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="n">evt</span><span class="p">!=</span><span class="k">null</span><span class="p">)</span><span class="nf">evt</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span><span class="k">value</span><span class="p">,</span><span class="n">absolute</span><span class="p">,</span><span class="n">sliding</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">durationSecs</span><span class="p">,</span><span class="n">isSliding</span><span class="p">);</span><span class="p">}</span></code></pre></figure><p>This is nothing fancy, all we have is some methods calling each other. Here’s the scary result of those <code class="language-plaintext highlighter-rouge">LocalCache.OnLogDuration</code> calls:</p><ul><li>LocalCache.Set: 3600</li><li>LocalCache.SetWithPriority: 3600</li><li>RawSet: <em>null</em>, or 114, or 97, or some other seemingly random value</li></ul><p>Here’s an example test run from <a href="https://github.com/StackExchange/RyuJIT-TailCallBug">the GitHub repo</a>:
 <img src="/blog/content/Blog-RyuJIT-Results.png" alt="RyuJIT Tail Tests"></p><p><strong>The method we called did not get the parameters we passed</strong>. That’s it. The net result of this is that local cache (which we use <em>very</em> heavily) is either unreliable or non-existent. This would add a tremendous amount of load to our entire infrastructure, making Stack Overflow much slower and likely leading to a full outage.</p><p>That’s not why we’re telling you about this though. Let’s step back and look at the big picture. What are some other variable names we could use?</p><ul><li><code class="language-plaintext highlighter-rouge">amountToWithdraw</code></li><li><code class="language-plaintext highlighter-rouge">qtyOfStockToBuy</code></li><li><code class="language-plaintext highlighter-rouge">carbonCopyToAccountId</code></li><li><code class="language-plaintext highlighter-rouge">voltage</code></li><li><code class="language-plaintext highlighter-rouge">targetAltitude</code></li><li><code class="language-plaintext highlighter-rouge">rotorVelocity</code></li><li><code class="language-plaintext highlighter-rouge">oxygenPressure</code></li><li><code class="language-plaintext highlighter-rouge">dosageMilliliters</code></li></ul><p>Does that help put things in perspective?</p><p>This bug is not obvious for several reasons:</p><ul><li>It only happens with optimizations enabled. For most developers and projects, that’s not in <code class="language-plaintext highlighter-rouge">DEBUG</code> and won’t show locally.
    <ul><li>That means you’ll only see this in <code class="language-plaintext highlighter-rouge">RELEASE</code>, which for most people is <strong>only production</strong>.</li></ul></li><li>Attaching a debugger alters the behavior. This almost always hides the issue.</li><li>Adding a <code class="language-plaintext highlighter-rouge">Debug.WriteLine()</code> will often fix the issue because of the tail change.</li><li>It won’t reproduce in certain scenarios (e.g. we can’t repro this in a console application or VS hosting, only IIS).</li><li>Given the nature of the bug, as far as we can tell, it can equally affect any framework library as well.</li><li>It can happen in a NuGet library (most of which are <code class="language-plaintext highlighter-rouge">RELEASE</code>); the issue may not be in your code at all.</li></ul><p>To address an obvious question: is this a security issue? Answer: it can be. It’s not something you could actively exploit in almost all cases, since stack variables are the things being swapped around here. However, it can be an issue indirectly. For example, if your code makes an assumption with a <code class="language-plaintext highlighter-rouge">null</code> param like <code class="language-plaintext highlighter-rouge">if (user == null) { user = SystemUser; }</code>, then a <code class="language-plaintext highlighter-rouge">null</code> passed in will certainly be a problem, giving other users that access sporadically. A more common example of this would be a value for a <code class="language-plaintext highlighter-rouge">Role</code> enum being passed incorrectly.</p><ol><li>Do not install .Net 4.6 in production.</li><li>If you have installed .Net 4.6, disable RyuJIT immediately (<strong>this is a temporary fix and should be removed when an update is released</strong>). You can disable RyuJIT via a registry setting (note: this requires an application pool recycle to take effect).
    <ul><li>Under <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework</code> add a <code class="language-plaintext highlighter-rouge">useLegacyJit</code><code class="language-plaintext highlighter-rouge">DWORD</code> with a value of <code class="language-plaintext highlighter-rouge">1</code></li><li>Or via PowerShell:</li></ul></li></ol><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Set-ItemProperty</span><span class="w"></span><span class="nt">-Path</span><span class="w"></span><span class="nx">HKLM:\Software\Microsoft\.NETFramework</span><span class="w"></span><span class="nt">-Name</span><span class="w"></span><span class="nx">useLegacyJit</span><span class="w"></span><span class="nt">-Type</span><span class="w"></span><span class="nx">DWord</span><span class="w"></span><span class="nt">-Value</span><span class="w"></span><span class="nx">1</span></code></pre></figure><p>Be aware, <a href="https://github.com/Microsoft/dotnet/blob/master/docs/testing-with-ryujit.md">the <code class="language-plaintext highlighter-rouge">web.config</code> method (#3)</a> of disabling RyuJIT <strong>does not work</strong>. Outside of IIS hosting, applying this fix via <code class="language-plaintext highlighter-rouge">app.config</code><em>does</em> work.</p><p>We are talking with and pushing Microsoft to get a fix for this shipped ASAP. We recognize releasing a fix for .Net on the Microsoft side isn’t a small deal. Our disclosure is prompted by the reality that a fix cannot be released, distributed, and applied immediately.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>