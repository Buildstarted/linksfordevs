<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Dependency Injection Lifetimes In ASP.NET CORE - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Dependency Injection Lifetimes In ASP.NET CORE - linksfor.dev(s)"/>
    <meta property="article:author" content="Mukesh Kumar"/>
    <meta property="og:description" content="Understanding the Dependency Injection &amp;amp; its lifetimes(Singleton, Transient, Scoped). Example can help to understand the different lifetimes and choose appropriate lifetime for service."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.c-sharpcorner.com/article/dependency-injection-lifetimes-in-asp-net-core/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Dependency Injection Lifetimes In ASP.NET CORE</title>
<div class="readable">
        <h1>Dependency Injection Lifetimes In ASP.NET CORE</h1>
            <div>by Mukesh Kumar</div>
            <div>Reading time: 7-8 minutes</div>
        <div>Posted here: 03 Apr 2020</div>
        <p><a href="https://www.c-sharpcorner.com/article/dependency-injection-lifetimes-in-asp-net-core/">https://www.c-sharpcorner.com/article/dependency-injection-lifetimes-in-asp-net-core/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="div2"><h2>Introduction</h2>  <p>When ASP.NET Core receives any request, it uses dependency injection container to resolve the required services &amp; process request. When a webhost is built, framework services are registered with dependency injection container, for example: logging, routing, environment dependencies, configuration etc. When ASP.NET Core receives any request which needs framework component like controllers, the framework component is activated along with its dependencies.</p>  <p>Kestrol, the ASP.NET Core web server passes each request to suitable middleware; for example; HTTP requests are passed to MVC Middleware which chooses suitable controller to process request.</p>  <div> <p><img data-src="/article/dependency-injection-lifetimes-in-asp-net-core/Images/middleware-2.jpg" alt="Dependency Injection Lifetimes In ASP.NET CORE" width="609" height="453" src="https://www.c-sharpcorner.com/article/dependency-injection-lifetimes-in-asp-net-core/Images/middleware-2.jpg"></p> </div>  <div> <p>The controllers are not registered directly in dependency injection container but during the activation process of framework component, controller instance is resolvable in dependency injection. In simple words, services are registered with container at start-up and resolved from container at runtime - when they are required.</p>  <p>When registering any service with container, it is important to consider carefully the lifetime of service because chosen lifetime affects the reuse of service instances. Dependency injection container manages all instances of services it creates. Once the lifetime is passed, this service is disposed or released for garbage collection. Extension methods are used to define lifetime using IServiceCollection when registering the service. There are three type of service lifetimes: Transient , Singleton &amp; Scoped</p>  <h2>Example Scenario</h2>  </div> <div> <p>With the help of an example, we will identify which service is suitable in which conditions. In our example, we have one Lucky Draw application that selects a lucky winner through a drawing. Suppose, a lucky winner is shown two screens in a company's own offices and also sent to agents who sell tickets as resellers. We need consistent data, the same one winner should be shown to all customers in a home office screen as well as the agent's (resellers) screens.</p>  <p>I have used a simple API application with many in-memory contestants. The constructor chooses one random contestant as <em>winner </em>which is returned as string when GetWinner method is called.</p> </div>  <div>  <ol start="1"> <li><span><span>public</span><span>&nbsp;</span><span>class</span><span>&nbsp;LuckyDrawService&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span><span>&nbsp;</span><span>readonly</span><span>&nbsp;</span><span>string</span><span>[]&nbsp;Contestants&nbsp;=&nbsp;{&nbsp;</span><span>"A100"</span><span>,</span><span>"B200"</span><span>,</span><span>"C300"</span><span>,</span><span>"D400"</span><span>,</span><span>"E500"</span><span>,</span><span>"F600"</span><span>,</span><span>"G700"</span><span>,</span><span>"H800"</span><span>,&nbsp;</span><span>"I900"</span><span>,&nbsp;</span><span>"J1000"</span><span>,&nbsp;</span><span>"K1100"</span><span>,&nbsp;</span><span>"L1200"</span><span>,&nbsp;</span><span>"M1300"</span><span>,&nbsp;</span><span>"N1400"</span><span>,&nbsp;</span><span>"O1500"</span><span>,&nbsp;</span><span>"P1600"</span><span>,&nbsp;</span><span>"Q1700"</span><span>,&nbsp;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>"R1800"</span><span>,&nbsp;</span><span>"S1900"</span><span>,&nbsp;</span><span>"T2000"</span><span>,&nbsp;</span><span>"U2100"</span><span>&nbsp;};&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span><span>&nbsp;</span><span>readonly</span><span>&nbsp;</span><span>string</span><span>&nbsp;lucky;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span><span>&nbsp;LuckyDrawService()&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lucky&nbsp;=&nbsp;Contestants[<span>new</span><span>&nbsp;Random().Next(0,20)];&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span><span>&nbsp;</span><span>string</span><span>&nbsp;GetWinner()&nbsp;=&gt;&nbsp;lucky;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li> </ol> </div> <div> <p>We have custom middleware which utilizes LuckyDrawService service when handles each request, it gets a winner from service and adds to the message variable.</p> </div> <div>  <ol start="1"> <li><span><span>public</span><span>&nbsp;</span><span>class</span><span>&nbsp;AgentMiddleware&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span><span>&nbsp;</span><span>readonly</span><span>&nbsp;RequestDelegate&nbsp;_broadcast;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span><span>&nbsp;AgentMiddleware(RequestDelegate&nbsp;broadcast)&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_broadcast&nbsp;=&nbsp;broadcast;&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span><span>&nbsp;async&nbsp;Task&nbsp;InvokeAsync(HttpContext&nbsp;request,&nbsp;LuckyDrawService&nbsp;luckyDrawService)&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span><span>&nbsp;message&nbsp;=&nbsp;$</span><span>"Broadcast&nbsp;to&nbsp;Agents&nbsp;Screen:&nbsp;Winner&nbsp;is&nbsp;{luckyDrawService.GetWinner()}"</span><span>;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.Items.Add(<span>"AgentWinner"</span><span>,&nbsp;message);&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await&nbsp;_broadcast(request);&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li> </ol> </div> <p>Also, I have injected LuckyDrawService in HomeController contrtoller as well.</p> <div>  <ol start="1"> <li><span><span>[ApiController]&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span><span>&nbsp;</span><span>class</span><span>&nbsp;HomeController&nbsp;:&nbsp;ControllerBase&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span><span>&nbsp;</span><span>readonly</span><span>&nbsp;LuckyDrawService&nbsp;_luckyDrawService;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span><span>&nbsp;HomeController(LuckyDrawService&nbsp;luckyDrawService&nbsp;)&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_luckyDrawService&nbsp;=&nbsp;luckyDrawService;&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Route(<span>""</span><span>)]&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span><span>&nbsp;IActionResult&nbsp;Index()&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span><span>&nbsp;message&nbsp;=&nbsp;$</span><span>"Broadcast&nbsp;to&nbsp;Company&nbsp;Home&nbsp;Screen:&nbsp;Winner&nbsp;is&nbsp;{_luckyDrawService.GetWinner()}"</span><span>;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;screen&nbsp;=&nbsp;<span>new</span><span>&nbsp;List&lt;</span><span>string</span><span>&gt;&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext.Items[<span>"AgentWinner"</span><span>].ToString(),&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;</span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span><span>&nbsp;Ok(screen);&nbsp;&nbsp;</span></span></li> <li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li> </ol> </div> <h2>Transient</h2>  <p>Every time a new instance for service is created and returned by container when called.</p>  <p>To use transient lifetime, add AddTransient in ConfigureService method in Startup.cs</p> <div>  <ol start="1"> <li><span><span>services.AddTransient&lt;LuckyDrawService&gt;();&nbsp;&nbsp;</span></span></li> </ol> </div> <p>Every dependant class using transient will receive a unique instance. AgentMiddleware &amp; HomeController has its own instance. Note here that values received in middleware &amp; controller are different,</p>  <div> <p><img data-src="/article/dependency-injection-lifetimes-in-asp-net-core/Images/transient-1.JPG" alt="Dependency Injection Lifetimes In ASP.NET CORE"></p> </div> <p>After Refresh (F5), you can see that a winner is changed in both middleware and controller,</p>  <div> <p><img data-src="/article/dependency-injection-lifetimes-in-asp-net-core/Images/transient-2.JPG" alt="Dependency Injection Lifetimes In ASP.NET CORE"></p> </div>  <h2>Singleton</h2>  <div> <p>The application has one shared instance and lifetime for instance is the lifetime of application. The one instance is created and injected into all dependant classes.</p>  <p>To use singleton lifetime, add AddSingleton in ConfigureService method in Startup.cs</p> </div>  <div>  <ol start="1"> <li><span><span>services.AddSingleton&lt;LuckyDrawService&gt;();&nbsp;&nbsp;</span></span></li> </ol> </div> <p>After running the application, we can see that middleware and controller have received the same winner,</p>  <div> <p><img data-src="/article/dependency-injection-lifetimes-in-asp-net-core/Images/singleton-1.JPG" alt="Dependency Injection Lifetimes In ASP.NET CORE"></p> </div>  <p>After Refresh (F5), the winner is still the same,</p>  <div> <p><img data-src="/article/dependency-injection-lifetimes-in-asp-net-core/Images/singleton-2.JPG" alt="Dependency Injection Lifetimes In ASP.NET CORE"></p> </div>  <h2>Scoped</h2>  <div> <p>The lifetime of the instance of scoped service is the lifetime of scope from which it is resolved. If a service instance is created, it is shared between middleware and controller. It is intermediate between transient &amp; singleton.</p>  <p>To use scoped lifetime, add AddScoped in ConfigureService method in Startup.cs</p>  </div> <div><p>We can notice that the winner is the same in both middleware and controller
</p><div> <p><img data-src="/article/dependency-injection-lifetimes-in-asp-net-core/Images/scoped-1.JPG" alt="Dependency Injection Lifetimes In ASP.NET CORE"></p> </div>  </div> <p>After Refresh(F5), we can notice that winner is changed but they are the same in both middleware and controller.</p>  <div> <p><img data-src="/article/dependency-injection-lifetimes-in-asp-net-core/Images/scoped-2.JPG" alt="Dependency Injection Lifetimes In ASP.NET CORE"></p> </div>  <h2>Conclusion</h2>  <p>We can notice how instances are resolving and can make different results. Transient was generating a different winner in middleware and controller; it was also changing with refresh of page - it is because new instance was created with each call.</p> <div>  <p>Singleton was giving the same winner in middleware and controller; even with refresh of the page, the result was the same. It is because one instance was created with the lifetime application.</p>  <p>It can help in performance if service is used frequently by fewer objects allocations &amp; less load on GC. It is thread-safe. While choosing it, the frequency for usage of service &amp; memory consumption should be considered as well. If usage of service is very rare and it occupies a lot of memory, it can cause performance issues or memory leaks as it never is released for garbage collection.</p>  <p>Scoped has a lifetime of scope of request so instance is created with request and shared in middleware and controller.</p>  <p>Also,&nbsp; service should not depend on a service whose lifetime is shorter than its own.</p>  </div> <div> <table> <tbody> <tr> <td><span>Transient</span></td> <td>Scoped</td> <td><span>Singleton</span></td> <td><br> </td> </tr> <tr> <td>Transient</td> <td> <p>Yes</p> </td> <td>Yes</td> <td>Yes</td> </tr> <tr> <td>Scoped</td> <td>No</td> <td>Yes</td> <td>Yes</td> </tr> <tr> <td>Singleton</td> <td>No</td> <td>No</td> <td> <p>&nbsp;No</p> </td> </tr> </tbody> </table> </div>   </div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>