<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Use UTF-16 Interfaces to Ship Windows Code -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Use UTF-16 Interfaces to Ship Windows Code</h1>
    <div><p>Character encoding can cause problems. P&#xE9;ter &#xC9;sik explains why UTF-16 interfaces help on Windows.</p><div><p>Listing 1 is a small program that takes a file path as a parameter, and queries its size. Even though <code>stat</code> is a POSIX function, it happens to be available on Windows as well, so this small program works on both POSIX platforms and Windows. Or does it? Let&#x2019;s try it out with two test files. For <span class="filename">test.txt</span>, it correctly reports the file&#x2019;s size. For <span class="filename">Hello, </span>&#x43C;&#x438;&#x440;<span class="filename">.txt</span>, however, the <code>stat</code> call fails (on my machine), even though the file clearly exists (see Figure 1). Why is that?</p> <h2>The &#x2018;ANSI&#x2019; vs. UTF-16 story in five minutes (or less)</h2> <p>Back in the day, character encodings were quite rudimentary. The first encoding widely adopted by computer systems was ASCII [<a href="#[Wikipedia-1]">Wikipedia-1</a>] (a 7-bit encoding) , capable of encoding the English alphabet and some other characters (numbers, mathematical symbols, control characters, etc.). Of course, the obvious need arose to encode more characters as users expected computers to speak their language, to type their native letters in e-mails, etc. 8-bit encodings provided a partial solution: code points 0&#x2013;127 were the same as ASCII (for compatibility), while extra characters were encoded in the range 128&#x2013;255.<a href="#FN01"><sup>1</sup></a> Those extra 128 code points were not enough to encode all letters of all languages at once, so character mappings were applied, most commonly known as code pages.</p> <p>This means that a character or a string that&#x2019;s encoded like this has no meaning in itself, you need to know what code page to interpret it with (this is somewhat analogous with files and their extensions). For example, code point 0x8A means &#xE4; (lowercase a with an umlaut) if you interpret it using the Macintosh Central European encoding [<a href="#[Wikipedia-2]">Wikipedia-2</a>], but encodes &#x160; (uppercase S with caron) if you use the Windows-1252 [<a href="#[Wikipedia-3]">Wikipedia-3</a>] (Latin alphabet) code page.</p> <p>This approach has two obvious problems: first, it&#x2019;s easy to get encodings wrong (for instance, .txt files have no header, so you simply can&#x2019;t store the code page used), resulting in so-called mojibake [<a href="#[Wikipedia-4]">Wikipedia-4</a>]. Second, you can&#x2019;t mix and match characters with different encodings easily. For example, if you wanted to encode the string &quot;&#x428;&#x43D;&#x443;&#x440;&#x43A;&#x438; means cip&#x151;f&#x171;z&#x151;&quot; (with Windows code pages), you would have to encode &quot;&#x428;&#x43D;&#x443;&#x440;&#x43A;&#x438;&quot; with code page 1251 (Windows Cyrillic) [<a href="#[Wikipedia-5]">Wikipedia-5</a>], &quot; means &quot; with a code page of your choice (as it contains ASCII characters only), and &quot;cip&#x151;f&#x171;z&#x151;&quot; with code page 1250 (Windows Central European) [<a href="#[Wikipedia-6]">Wikipedia-6</a>]. To correctly decode and display this string later, you would have to store which code pages were used for which parts, making string handling inefficient and extremely complex.</p> <p>Because of problems like these, encodings were desired that could represent &#x2018;all&#x2019; characters at once. One of these emerging encodings was UCS-2 (by the Unicode working group), which used 16-bit wide code units and code points. Windows adopted UCS-2 quite early, Windows NT 3.1 (the very first OS of the NT series, released in 1993) and its file system, NTFS, used it internally. Even though the 32-bit Windows API debuted with NT 3.1 as brand new, support for 8-bit encodings was still necessary.<a href="#FN02"><sup>2</sup></a> As UCS-2 used 16-bit code units, and the C language does not support function overloading, Microsoft introduced two versions of every API function that had to work with strings (either directly or indirectly): a UCS-2 version, with a W suffix (&#x2018;wide&#x2019;, working with <code>wchar_t</code> strings), and one for 8-bit code paged strings, with an A suffix (&#x2018;ANSI&#x2019;<a href="#FN03"><sup>3</sup></a>, working with <code>char</code> strings).</p> <p>The A functions act as mere wrappers, usually<a href="#FN04"><sup>4</sup></a> they just convert the string parameters and forward the call to the corresponding W version. So for example, there is no such function as <code>MessageBox</code>, there is only <code>MessageBoxA</code>, and <code>MessageBoxW</code>. Depending on the strings you have, you need to call the appropriate version of the two.<a href="#FN05"><sup>5</sup></a></p> <p>Which code page is used to interpret strings in the A family of functions? Is there a code page parameter passed? No, they use a system-wide setting called the <em>active code page</em>, located in the registry at HKLM\SYSTEM\CurrentControlSet\Control\Nls\CodePage\ACP. This value is decided based on your region you choose at installation time, but can also be changed later in the Control Panel.</p> <p>Eventually, UCS-2 evolved into UTF-16, and starting with Windows 2000, the OS had support for it. Since UCS-2 is fully compatible with UTF-16, programs didn&#x2019;t need to be rewritten or even recompiled.</p> <h2>Back to the test program</h2> <p>Armed with this knowledge, it&#x2019;s easy to see why the small test program doesn&#x2019;t work for certain files. This is what happens:</p> <ol> <li>The program is started (with whatever parameters).</li> <li>Very early in the startup phase, Windows converts the (native) UTF-16 command line to an &#x2018;ANSI&#x2019; string using the active code page, and stores it in a global variable.</li> <li>Because regular <code>main</code> was used (with &#x2018;narrow&#x2019;, <code>char</code> parameters) in this application, early in the startup phase the CRT queries the command line with <code>GetCommandLineA</code> (this just returns the global that was set up by the previous step), converts it into an array, and passes it down to <code>main</code>.</li> </ol> <p>The problem is that there might be characters in the UTF-16 command line that have no representation in the currently active code page. For example, my computer&#x2019;s locale is set to Hungarian, therefore my ACP is 1250 (Windows Central European) [<a href="#[Wikipedia-6]">Wikipedia-6</a>]. Cyrillic characters such as &#x43C;, &#x438;, and &#x440; have no representation in this encoding, so when the UTF-16 to &#x2018;ANSI&#x2019; conversion is performed, these characters are replaced with question marks (see Figure 2).<a href="#FN06"><sup>6</sup></a> When <code>stat</code> is called with the string <code>&quot;D:\temp\temp\Hello, ???.txt&quot;</code> (which by the way involves an &#x2018;ANSI&#x2019; to UTF-16 conversion internally), of course it fails, because there is no file named <span class="filename">Hello, ???.txt</span> in that directory.</p> <h2>cURL</h2> <p>It&#x2019;s not that hard to bump into applications or libraries suffering from these problems. cURL, for example, is one of them. Now don&#x2019;t get me wrong, I&#x2019;m in no way saying that it&#x2019;s a badly written piece of software, quite the contrary. It&#x2019;s a battle-tested, popular open source project with a long history and a plethora of users. Actually, I think this is what makes it a perfect example: even if your code is spot on, this aspect of shipping to Windows is very easy to overlook.</p> <p>For file IO, cURL uses standard C functions (such as <code>fopen</code>). This means that for example, if you want your request&#x2019;s result written into an output file, it will fail if the file&#x2019;s path contains characters not representable with the system&#x2019;s current &#x2018;ANSI&#x2019; code page.</p> <p>Another example is IDN (internationalized domain name) handling. cURL does support IDNs, but let&#x2019;s see what happens if I try it out using the standalone command line version (see Figure 3).</p> <p> Even though <span class="filename">magyarorsz&#xE1;g.icom.museum</span> exists, and its string form is perfectly representable with my machine&#x2019;s ACP (1250), cURL fails with an error. Looking at the source code quickly reveals the culprit:</p> <ul> <li>cURL needs to convert the IDN to so-called Punycode [<a href="#[Wikipedia-7]"></a>Wikipedia-7] before issuing the request.</li> <li>It does so with <code>IdnToAscii</code> [<a href="#[WindowsDev]">WindowsDev</a>], but this function expects a UTF-16 input string.</li> <li>Even though the original string (which originates from the command line parameter) is an &#x2018;ANSI&#x2019; string, conversion to UTF-16 is attempted assuming it&#x2019;s UTF-8. This makes the conversion fail, and thus cURL aborts with an error message.</li> </ul> <p>cURL developers are aware of this category of problems: it&#x2019;s listed on their known bugs page [<a href="#[curl]">curl</a>].</p> <h2>Solution</h2> <p>The solution is in the title of this article: use UTF-16 (native) interfaces on Windows. That is:</p> <ul> <li>Instead of regular <code>main</code>, use <code>wmain</code> as an entry point, which has <code>wchar_t</code> string arguments.</li> <li>Always use the wide version of runtime functions (<code>_wfopen_s</code> over plain <code>fopen</code>, <code>wcslen</code> instead of <code>strlen</code>, etc.).</li> <li>If you need to call Win32 functions directly, never use the &#x2018;ANSI&#x2019; version with the A suffix, use their UTF-16 counterparts (ending with W).</li> </ul> <p>While this sounds great on paper, there is a catch. You can only use these functions on Windows, as:</p> <ul> <li>Some of the widechar runtime functions are Windows-only (such as <code>_wfopen</code>).</li> <li>The size and semantics of <code>wchar_t</code> are implementation defined. While on Windows it&#x2019;s a 2-byte type representing a UTF-16 code unit, on POSIX systems it&#x2019;s usually 4 bytes in size, embodying a UTF-32 code unit.</li> </ul> <p>One possible solution is to utilize <code>typedef</code>s and macros. See Listing 2.</p> <p>This simple technique can go a long way (it can be done somewhat more elegantly, but you get the idea), unless you need to exchange strings between different platforms (over the network, serialization, etc.).</p> <h2>Closing thoughts</h2> <p>I know some people think that the problem presented in this article is marginal, and using <code>char</code> strings and &#x2018;ANSI&#x2019; interfaces on Windows is &#x2018;good enough&#x2019;. Keep in mind though that in commercial environments the following situation is not that rare:</p> <ul> <li>Company X outsources work to company Y, but they reside in different parts of the world.</li> <li>Therefore, the computers of company Y have a different ACP from those of company X.</li> <li>It&#x2019;s very likely that the outsourced work involves using strings in company X&#x2019;s locale, which will be problematic on Windows, if the software(s) used for doing said work misbehaves in this situation.</li> </ul> <p>Don&#x2019;t be surprised if a potential client of yours turns down a license purchase because of problems like this.</p> <h2>References</h2> <p class="bibliomixed"><a id="[curl]"></a>[curl] &#x2018;Known Bugs&#x2019;, curl: <a href="https://curl.haxx.se/docs/knownbugs.html#can_t_handle_Unicode_arguments_i">https://curl.haxx.se/docs/knownbugs.html#can_t_handle_Unicode_arguments_i</a></p> <p class="bibliomixed"><a id="[Microsoft18]"></a>[Microsoft18] &#x2018;Working with strings&#x2019;, published on 31 May 2018 at <a href="https://docs.microsoft.com/en-gb/windows/desktop/LearnWin32/working-with-strings">https://docs.microsoft.com/en-gb/windows/desktop/LearnWin32/working-with-strings</a></p> <p class="bibliomixed"><a id="[Wikipedia-1]"></a>[Wikipedia-1] ASCII: <a href="https://en.wikipedia.org/wiki/ASCII">https://en.wikipedia.org/wiki/ASCII</a></p> <p class="bibliomixed"><a id="[Wikipedia-2]"></a>[Wikipedia-2] Macintosh Central European Encoding: <a href="https://en.wikipedia.org/wiki/Macintosh_Central_European_encoding">https://en.wikipedia.org/wiki/Macintosh_Central_European_encoding</a></p> <p class="bibliomixed"><a id="[Wikipedia-3]"></a>[Wikipedia-3] Windows -1252 code page: <a href="https://en.wikipedia.org/wiki/Windows-1252">https://en.wikipedia.org/wiki/Windows-1252</a></p> <p class="bibliomixed"><a id="[Wikipedia-4]"></a>[Wikipedia-4] Mojibake: <a href="https://en.wikipedia.org/wiki/Mojibake">https://en.wikipedia.org/wiki/Mojibake</a></p> <p class="bibliomixed"><a id="[Wikipedia-5]"></a>[Wikipedia-5] Windows-1251: <a href="https://en.wikipedia.org/wiki/Windows-1251">https://en.wikipedia.org/wiki/Windows-1251</a></p> <p class="bibliomixed"><a id="[Wikipedia-6]"></a>[Wikipedia-6] Windows-1250: <a href="https://en.wikipedia.org/wiki/Windows-1250">https://en.wikipedia.org/wiki/Windows-1250</a></p> <p class="bibliomixed"><a id="[Wikipedia-7]"></a>[Wikipedia-7] Punycode: <a href="https://en.wikipedia.org/wiki/Punycode">https://en.wikipedia.org/wiki/Punycode</a></p> <p class="bibliomixed"><a id="[WindowsDev]"></a>[WindowsDev] IdnToAscii function, Windows Dev Center: <a href="https://docs.microsoft.com/en-gb/windows/desktop/api/winnls/nf-winnls-idntoascii">https://docs.microsoft.com/en-gb/windows/desktop/api/winnls/nf-winnls-idntoascii</a></p> <ol> <li><a id="FN01"></a>There are some languages with much more symbols than 128 or 255 (Japanese, Chinese, etc.), which led to the invention of DBCS/MBCS character sets. I&#x2019;m not mentioning them here for simplicity.</li> <li><a id="FN02"></a>One major reason for this was (other than UCS-2 not being widespread at the time) that the consumer line of Windows OSes (95, 98, etc.) had very limited support for UCS-2, but applications targeting Win32 had to run on both lines of Windows.</li> <li><a id="FN03"></a>Technically, it&#x2019;s not correct to call these functions &#x2018;ANSI&#x2019; versions, as none of the supported code pages are ANSI standards. This term has historical roots, as the first Windows code page (1252) was based on an ANSI draft. On recent versions of Windows 10, the ACP can be set to UTF-8. Therefore, it&#x2019;s best to think about &#x2018;ANSI code pages&#x2019; as &#x2018;some encoding that&#x2019;s not UTF-16&#x2019;.</li> <li><a id="FN04"></a>One exception I know of is <code>OutputDebugString</code>, where the &#x2018;ANSI&#x2019; version is the native one (<code>OutputDebugStringW</code> will convert to &#x2018;ANSI&#x2019; and call <code>OutputDebugStringA</code>)</li> <li><a id="FN05"></a>It&#x2019;s possible to create programs that can be compiled to support either the W or A interfaces without source changes, using predefined macros [<a href="#[Microsoft18]">Microsoft18</a>]. Nowadays, however, that&#x2019;s highly irrelevant. If you are writing programs that target modern Windows versions (only NT), there is almost absolutely no reason to use A interfaces.</li> <li><a id="FN06"></a>The exact mappings are defined in <span class="filename">.nls</span> files located in the System32 directory.</li> </ol> <p class="bio"><span class="author"><b>P&#xE9;ter &#xC9;sik</b></span> P&#xE9;ter has been working as a C++ software developer for 5 years. He has a knack for everything low level, including (but not limited to) OS internals, assembly, and post-mortem crash analysis. His blog can be found at <a href="http://peteronprogramming.wordpress.com">http://peteronprogramming.wordpress.com.</a></p> </div></div><hr><h4>Page 2</h4><div><p>Recent headlines declare a climate emergency. Sergey Ignatchenko considers how we can make an impact on IT&#x2019;s carbon footprint.</p><div><p class="EditorIntro">Disclaimer: as usual, the opinions within this article are those of &#x2018;No Bugs&#x2019; Hare, and do not necessarily coincide with the opinions of the translators and <em>Overload</em> editors; also, please keep in mind that translation difficulties from Lapine (like those described in [<a href="#[Loganberry04]">Loganberry04</a>]) might have prevented an exact translation. In addition, the translator and <em>Overload</em> expressly disclaim all responsibility from any action or inaction resulting from reading this article.</p> <p class="EditorIntro">Disclaimer #2: all the numbers within this article are calculated &#x2018;on the back-of-an-envelope&#x2019; (see, for example, [<a href="#[NoBugs17]">NoBugs17</a>] for discussion), and are at best accurate within an order of magnitude; still, even being accurate within an order of magnitude is good enough for our current purposes.</p> <p>These days, I happen to know quite a few fellow programmers who are bicycling to work; what&#x2019;s interesting, however, is that most of them are not doing it for fun, but instead are arguing that it is a Good Thing&#x2122; to save on their CO<sub>2</sub> footprint. I&#x2019;ve heard this line of argument soooo many times (if you&#x2019;re not familiar with it, take a look, say, at [<a href="#[Handy18]">Handy18</a>]), that I decided to make some back-of-an-envelope calculations to see whether we as software developers can save a bit more than that. BTW, even if you happen to believe that global warming has nothing to do with CO<sub>2</sub>, only a few will disagree (I hope) that burning non-renewable resources for nothing is a Bad Thing&#x2122;.</p> <p>In [<a href="#[Handy18]">Handy18</a>], it is mentioned that over 16 years the author saved 3 metric tons of CO<sub>2</sub> by bicycling to the office instead of driving; that&#x2019;s saving about 190 kilos of CO<sub>2</sub> per year. Now, let&#x2019;s see what IT-related changes can do in terms of saving the world (from global warming, that is).</p> <p>Let&#x2019;s consider a few real-world examples.</p> <h2>Example 1: Game with 100K simultaneous players</h2> <p>For the purposes of our first example, let&#x2019;s assume that you happen to work on a PC-based game with 100,000K simultaneous players, which uses about 100W when it is running. Now, if you can come up with a trick which saves mere 1% of this power, it means that you&#x2019;ll be saving 1W &#xD7; 100,000 = 100 kW of power at each and every moment, which translates into 2,400 kWh per day, or 876,000 kWh per year. Now, we can use [<a href="#[CarbonFootprint]">CarbonFootprint</a>] to translate this into CO<sub>2</sub> and discover that one such optimization will save a whopping 270 tons of CO<sub>2</sub> per year(!) &#x2013; that will cover 1,400 people (such as those in [<a href="#[Handy18]">Handy18</a>]) bicycling to the office and back.</p> <p>How we can save that 1% of power is a different story. Just as one example, often much more than that can be saved in practice by switching to V-sync by default (that is, in the absence of G-sync/Freesync). I certainly don&#x2019;t want to start a war on which is better for the end-user &#x2013; screen tearing without V-sync or lag without it (especially because the answer is very game-specific) &#x2013; but whenever you&#x2019;re in doubt, V-sync can be preferred by default as being more environmentally friendly.</p> <h2>Example 2: Multithreaded video codec with 1M active install base</h2> <p>Now, let&#x2019;s assume you&#x2019;re writing a video codec, and you&#x2019;re really good at it, so you have 1 million people actively using your codec, with each of these people using it 10% of the time, and while they&#x2019;re using it, it eats 100W of power.</p> <p>Also, let&#x2019;s assume that your codec uses fine-grained multithreading, and that when it uses 4 CPU cores &#x2013; it gets a 2&#xD7; wall-clock speed-up compared to running on a single core. But this means that in multithreaded mode (which you enabled by default, of course), it takes 4&#xD7; the power of a single core, multiplied by 0.5&#xD7; of the time needed to perform the task. This means that overall power consumption will increase by about 4 &#xD7; 0.5 = 2&#xD7; (in fact, usually a bit less due to interplay with other components, but not by much). In other words, in multithreaded mode only the power of 2 CPU cores is actually used to produce something useful, and anything the other 2 CPUs do goes towards paying for synchronization overheads. This means that you&#x2019;re wasting about 50 % of that 100 W of power per box &#x2013; that&#x2019;s about 50 W wasted per box!</p> <p>Now, if you rewrite your codec so that it separates jobs between threads on a per-keyframe basis (which means that there is no interaction between the data in different threads, hence there is almost zero thread sync and almost zero overhead), you can get most of that 50 W back; let&#x2019;s assume you&#x2019;ve got 40W back. With your user base, this translates into 100,000 simultaneous users &#xD7; 40 W = 4 MW. That&#x2019;s 40&#xD7; more than that of our 1st example &#x2013; and translates into savings equivalent to those of 56,000 people bicycling per year(!!).</p> <h2>Example 3: Single R-R op within Linux scheduler</h2> <p>In our 3rd example, let&#x2019;s assume that you&#x2019;ve noticed how to save one single R-R operation within Linux scheduler. Now, let&#x2019;s assume that Linux is running on a billion devices (which is a rather conservative estimate, if we take into account all Androids and all IoT stuff), and that the appropriate part of the scheduler is run every 10 ms. This means that you&#x2019;ll be saving one R-R operation on 1&#xD7; 10<sup>9</sup> devices &#xD7; (1sec/10ms) = 1&#xD7; 10<sup>11</sup> times every second. Assuming that an R-R operation takes one CPU cycle, this will very roughly correspond to running a hundred 1GHz CPU cores all the time &#x2013; and assuming that each of these cores will eat 30W (that&#x2019;s accounting for associated power consumption in memory etc.), this means that you&#x2019;ve got savings of 3kW (or 42 people bicycling instead of driving each and every day). That&#x2019;s just for saving one single R-R operation(!!).</p> <h3>Example 4: Better screen blanking defaults</h3> <p>Now, let&#x2019;s move from considering pure programming into other computer-related things. For the purposes of our 4th example, let&#x2019;s assume that you have the ability to change the default screen blanking time on a desktop system from 30 minutes down to 10 minutes, with a billion such systems working all over the world. Let&#x2019;s further assume that 80% of the users don&#x2019;t change defaults, that the chances that after 10 minutes a user is still staring at the monitor are 10%, that screen blanking fires three times a day, and that the monitor uses 20W when it is not blanked.</p> <p>Then, this simple change in defaults will result in savings of (30-10 minutes) &#xD7; 0.8 &#xD7; 0.9 &#xD7; 10<sup>9</sup> users &#xD7; 20W &#xD7; 5times/day = &#x2153; &#xD7; 3 hour/day &#xD7; 14W &#xD7; 10<sup>9</sup> = 0.014kWh/day &#xD7; 10<sup>9</sup> ~= 5&#xD7; 10<sup>9</sup> kWh/year, or 1,500,000 tons of CO<sub>2</sub> per year, which is equivalent to eight million people changing from a car to a bicycle for getting to/from the office.</p> <p>NB: BTW, if you change just your own 100% screen saver into screen blanking, you&#x2019;d save about 60 kilos of CO<sub>2</sub> per year &#x2013; which is &#x2153; of the savings from bicycling [<a href="#[Handy18]">Handy18</a>]; not a bad gain from such a non-effort.</p> <h3>Example 5: Giving up on cryptocurrency speculations</h3> <p>Each time you&#x2019;re making your Bitcoin &#x2018;investment&#x2019; (actually, most of the time it is pure speculation &#x2013; see [<a href="#[WallStreetMojo]">WallStreetMojo</a>] for the difference between the two) transaction &#x2013; think how much CO<sub>2</sub> waste it creates.</p> <p>The whole Bitcoin industry is estimated to use a whopping 22 terawatt-hours per year [<a href="#[Economist]">Economist</a>] &#x2013; that&#x2019;s 2.2&#xD7; 10<sup>10 </sup>kWh per year, equivalent to 35 million people bicycling to their offices &#x2013; which is about the population of the whole of California (and about &#x2153; of the workforce in the whole US).</p> <p>In other words,</p> <p><em>if we all simply give up on Bitcoins (which have a mostly speculative and dark-market value &#x2013; their use for other purposes such as processing real-world non-dark transactions still hasn&#x2019;t really started) &#x2013; this would result in </em>CO<sub>2</sub><em> savings comparable to the whole of California bicycling instead of driving(!!).</em></p> <p>By trying to speculate on Bitcoin (Ethereal, whatever else), we&#x2019;re not only gambling our hard-earned savings, but are also drastically increasing our CO<sub>2</sub> footprint. Moreover, this seems to be the very nature of cryptocurrencies because all of them rely on so-called Proof of Work (even the cryptocurrencies billed as &#x2018;without Proof of Work&#x2019; still need it at least for &#x2018;initial distribution&#x2019; [<a href="#[Bentov]">Bentov</a>]).</p> <p>As there are about 300,000 confirmed Bitcoin transactions per day, we can conservatively say that if you&#x2019;re making one such transaction per day, you become responsible for 1/300,000 of those 22 TWh/year. Actually, as long as you&#x2019;re losing in this gamble &#x2013; as the vast majority of individual investors do &#x2013; you&#x2019;re producing more than that share because you&#x2019;re feeding the pool where more transactions happen. That&#x2019;s 73,000 kWh/year, or 22.4 tons of CO<sub>2</sub> per year, or 120 people bicycling(!!). Or, looking at it from a different angle &#x2013; making just three Bitcoin transactions per year is enough to offset you bicycling all the year(!!!).</p> <p>Yes, <em>instead of bicycling to the office every day, just give up on three Bitcoin transactions per year &#x2013; you will get the same </em>CO<sub>2</sub><em> reduction</em>.</p> <h2>Conclusion</h2> <p>Sure, bicycling does reduce CO<sub>2</sub> footprint. However, in IT there are lots of ways to save even more (often much more) than by bicycling; it can be as simple as optimizing your own program so it uses less power, readjusting screen your saver, or even giving up on just three Bitcoin transactions per year(!).</p> <p><img src="/content/images/journals/ol151/Ignatchenko/Ignatchenko-01.png"></p> <p class="EditorIntro">We usually print purely technical articles in <em>Overload</em>, but hope that this article on a broader subject is still of interest to our readership.</p> <h2>Bibliography</h2> <p class="bibliomixed"><a id="[Bentov]"></a>[Bentov] Iddo Bentov, Ariel Gabizon and Alex Mizrahi (no date) &#x2018;Cryptocurrencies without Proof of Work&#x2019;, available at:<a href="https://fc16.ifca.ai/bitcoin/papers/BGM16.pdf">https://fc16.ifca.ai/bitcoin/papers/BGM16.pdf</a></p> <p class="bibliomixed"><a id="[CarbonFootprint]"></a>[CarbonFootprint] Carbon Calculator, available at:<a href="https://www.carbonfootprint.com/calculator.aspx">https://www.carbonfootprint.com/calculator.aspx</a></p> <p class="bibliomixed"><a id="[Economist]"></a>[Economist] &#x2018;Why bitcoin uses so much energy&#x2019;, in <em>The Economist explains</em>, published 9 July 2018 at <a href="https://www.economist.com/the-economist-explains/2018/07/09/why-bitcoin-uses-so-much-energy">https://www.economist.com/the-economist-explains/2018/07/09/why-bitcoin-uses-so-much-energy</a></p> <p class="bibliomixed"><a id="[Handy18]"></a>[Handy18] Susan Handy, &#x2018;Want to save tons of greenhouse gases? Bike it.&#x2019;, in <em>Science &amp; Climate</em>, published 6 September 2018, available at: <a href="https://climatechange.ucdavis.edu/what-can-i-do/want-to-save-tons-of-greenhouse-gases-bike-it/">https://climatechange.ucdavis.edu/what-can-i-do/want-to-save-tons-of-greenhouse-gases-bike-it/</a></p> <p class="bibliomixed"><a id="[Loganberry04]"></a>[Loganberry04] David &#x2018;Loganberry&#x2019;, Frithaes! - &#x2018;An Introduction to Colloquial Lapine!&#x2019;, available at <a href="http://bitsnbobstones.watershipdown.org/lapine/overview.html">http://bitsnbobstones.watershipdown.org/lapine/overview.html</a></p> <p class="bibliomixed"><a id="[NoBugs17]"></a>[NoBugs17] &#x2018;No Bugs&#x2019; Hare (2017) &#x2018;The Importance of Back-of-Envelope Estimates&#x2019;, <em>Overload</em> 137, available at: <a href="https://accu.org/index.php/journals/2341">https://accu.org/index.php/journals/2341</a></p> <p class="bibliomixed"><a id="[WallStreetMojo]"></a>[WallStreetMojo] &#x2018;Differences Between Investment and Speculation&#x2019; in <em>WallStreetMojo</em>, available at: <a href="https://www.wallstreetmojo.com/investment-vs-speculation/">https://www.wallstreetmojo.com/investment-vs-speculation/</a></p> <p class="bio"><span class="author"><b>Sergey Ignatchenko</b></span> has 15+ years of industry experience, including being a co-architect of a stock exchange, and the sole architect of a game with 400K simultaneous players. He currently holds the position of Security Researcher.</p> </div></div><hr><h4>Page 3</h4><div><p>Software developers are well aware of the &#x2018;DRY Principle&#x2019;. Lucian Radu Teodorescu investigates when this common wisdom does not always hold.</p><div><p>If you are a software developer, chances are that you heard about the DRY principle: &#x201C;<em>Don&#x2019;t repeat yourself</em>&#x201D;[<a href="#[Hunt99]">Hunt99</a>]. Actually, chances are that you&#x2019;ve heard it multiple times; probably many, many times. If you do a quick Internet search, you see that this phrase is repeated <em>ad nauseam</em>. But how come a mantra that preaches no repetition is repeated &#x2013; ironically &#x2013; so many times? Starting from this paradox, this article analyses why sometimes repetition is vital for people and also useful for software development.</p> <h2>The name of the game</h2> <p>Software development is a knowledge acquisition process [<a href="#[Henney19]">Henney19</a>]. It&#x2019;s not enough to write code for machines to understand; we need also people to be able to understand it and reason about it. It&#x2019;s mostly a social activity. It&#x2019;s not enough for the actual co-workers to understand your code, future co-workers also need to understand the code. Furthermore, if you understand your code now, you may not be able to do it 6 months in the future &#x2013; that&#x2019;s how volatile is the understanding of the code.</p> <p class="quote">Any fool can write code that a computer can understand. Good programmers write code that humans can understand<br>~ Martin Fowler</p> <p>The main bottleneck of software development is the understanding capacity of programmers. If, following Kevlin Henney, we rename the term code into codified knowledge [<a href="#[Henney19]">Henney19</a>], then the fundamental problem is arranging this knowledge in such a way that it allows easy acquisition by humans and easy reasoning on it.</p> <p>There are many aspects of organizing this knowledge, but for the purpose of this article, we are concerned only about the use of repetition.</p> <h2>Other forms of knowledge representations</h2> <p>Let us take verbal communication as the primary form of interacting with knowledge. First, there is the actual verbal communication, then there is the non-verbal one. The non-verbal communication often repeats the verbal communication; it&#x2019;s used most of the time to strengthen the message expressed through words.</p> <p>Looking at the language itself, we find that it&#x2019;s highly redundant. Some very common examples of redundancy in English include: plural and gender concordance, the third person singular -s, subject-predicate inversion (in the presence of an interrogative word), etc. It seems that humans are better equipped to understand messages with a lot of redundancy. If people find that processing natural language is easier in the presence of redundancy, why would we want to remove redundancy from the software that people are supposed to read?</p> <p>Let&#x2019;s go further in our analysis of repetition in discourse. Within rhetoric, repetition is an important strategy for producing emphasis, clarity, amplification or emotional effect. It can be of letters/syllables/sounds, words, clauses or ideas. For example, one can see a lot of repetition in the following speech:</p> <p class="blockquote">We shall not flag or fail. We shall go on to the end. We shall fight in France, we shall fight on the seas and oceans, we shall fight with growing confidence and growing strength in the air, we shall defend our island, whatever the cost may be, we shall fight on the beaches, we shall fight on the landing grounds, we shall fight in the fields and in the streets, we shall fight in the hills. We shall never surrender.<br>~ Winston Churchill</p> <p>One can say that the text is just a big repetition of the same idea. How would a DRY fan &#x2018;refactor&#x2019; this text? Probably something like the following:</p> <p class="blockquote">There are a few things we shall do: go on to the end, fight &#x2013; in France, on the seas, in the air (with growing confidence and growing strength), beaches, landing grounds, fields, streets, hills &#x2013; go to the end, defend our island (whatever the cost may be); but never surrender, flag or fail.<br>~ DRY enthusiast</p> <p>And, because refactoring is an iterative process, after a few shake-ups of the text, we would arrive at:</p> <p class="blockquote">We shall fight and never surrender.<br>~ DRY enthusiast</p> <p>For fun, and for the sake of repetition, let&#x2019;s have 3 more examples:</p> <p class="blockquote">O Romeo, Romeo! Wherefore art thou Romeo?<br>~ William Shakespeare</p> <p>Becomes:</p> <p class="blockquote">Hey, Romeo! Wherefore art thou?</p> <p>And:</p> <p class="blockquote">I am so happy. I got love, I got work, I got money, friends, and time. And you alive and be home soon.<br>~ Alice Walker</p> <p>Becomes:</p> <p class="blockquote">I&#x2019;ve got happiness, love, work, money, friends, time, you alive; reaching home soon.</p> <p>And finally:</p> <p class="blockquote">Happy families are all alike; every unhappy family is unhappy in its own way.<br>~ Leo Tolstoy</p> <p>Becomes:</p> <p class="blockquote">Happy families are all alike; the others not.</p> <p>And, because the last quote was from Anna Karenina, I would like to stress one more point. How would an author construct such a complex novel if it didn&#x2019;t have repetition? How can one construct characters without repeating types of behaviors? How can one distinguish between main characters and other characters without repeating the names of the main characters more? Imagine every name in Anna Karenina written only once, every detail about the world that Tolstoy created appearing only once.</p> <p>Ignoring its aesthetic value, we can always think of a novel as a knowledge source, and thus similar in some ways with our code. When writing a novel, the author typically wants the readers to understand and remember, if not all, at least some key aspects of the novel. That is exactly what software authors aim for.</p> <p>In fiction repetition is useful in:</p> <ul> <li>emphasising what&#x2019;s important</li> <li>keeping certain aspects fresh in the reader&#x2019;s memory</li> <li>simplifying reading.</li> </ul> <p>The same benefits can apply to repetition in code. Religiously eliminating repetition would remove these benefits as well, making the code harder to read.</p> <h2>Memory and learning</h2> <p class="quote">Tell the audience what you&#x2019;re going to say, say it; then tell them what you&#x2019;ve said<br>~ Dale Carnegie</p> <p>Repetition plays a key role in how our memory works. Both in terms of acquiring new memories and using those memories. And this is extremely important if we want to improve our knowledge acquisition process.</p> <p>Psychologists and neuroscientists differentiate between long-term memory and short-term memory [<a href="#[Foster09]">Foster09</a>]. For the purpose of this article, we could consider working memory to be a synonym for short-term memory. This long-term and short-term memory would correspond to external storage and CPU registers, in computing parlance.</p> <p>Since ancient times the best method to acquire knowledge in the long-term memory is rehearsal:</p> <p class="quote">Repetition is the mother of all learning<br>~ Ancient proverb</p> <p>Not only does it provide means to remember facts, but repetition also plays an important role in what&#x2019;s important and what&#x2019;s not. This is how we teach our children; we repeat a lot the facts the child needs to learn, and we repeat more often the more important facts.</p> <p>Just like with CPU registers, the most important thing about working memory is that it is very limited. Early models claimed 7 different things (plus or minus 2); recent studies claim that without any grouping tricks, the memory is generally limited to 4 different things. [<a href="#[Mastin]">Mastin</a>]</p> <p>The other problem with short-term memory is that it easily decays (in the order of seconds). To keep things in short-term memory (e.g., in focus), we need to constantly repeat those things. [<a href="#[Mastin]">Mastin</a>]</p> <p>Let&#x2019;s take an example. Let&#x2019;s assume that we are exploring a new codebase and we have 100 functions of equal importance. We need to find 3 functions that match the given criteria. Without any form of grouping, or repeating what&#x2019;s essential, we would iterate over the space of functions trying to capture the needed functions. But, the problem is that after a few functions visited, our memory is filled with unimportant stuff. We constantly defocus, and our search procedure is hard. If the important information is repeated just enough, and/or if we have some sort of grouping, it would be much easier for us to find what we are looking for.</p> <h2>When repetition is preferable</h2> <p>The reader must have repeatedly seen the downsides of repetition, so repeating them here would not be beneficial (pun intended). Instead, we are shall enumerate some of the benefits of repetition:</p> <ul> <li><strong>Emphasizes important aspects of the code.</strong> Indeed, if the readers of the code see that a certain principle/pattern/design choice is applied several times, they can easily reach the conclusion that the principle/pattern/design choice is important. Conversely, if an important decision is not repeated at all, but there are other constructs/patterns repeated, then the importance of the decision can easily slip past the reader.</li> <li><strong>Ease the learning.</strong> Repetition is the mother of all learning.</li> <li><strong>Create coherency.</strong> If all items in a group have completely different characteristics, then the group is not coherent at all. To make a group coherent is to give all the elements in a group a certain characteristic. That is, to repeat the characteristic.</li> <li><strong>Keeps abstractions at the same level.</strong> Refactoring techniques that aim to avoid repetition often make the new abstractions operate at different levels; this is typically bad for reading the code. If we want to keep the code at the same abstraction level, sometimes we need to duplicate some code.</li> <li><strong>Efficiency.</strong> Sometimes, to achieve maximum efficiency, certain (low-level) code snippets need to be duplicated.</li> </ul> <p>In the following subsections, we offer examples of when repetition applied in programming is good. However, as all design choices have both pros and cons, we also briefly indicate how not to apply the advice over-zealously.</p> <h3>Repetition and code documentation</h3> <p>Code documentation is essentially repetition. It repeats (to a certain degree) what the code is saying, but in a manner that is more understandable by people. We all agree that code documentation is good, therefore, a form of repetition is good.</p> <p>Then, we have repetition inside the documentation itself. For example, if we have an important architectural decision that we want the readers of the documentation to keep in mind, we should repeat it each time it provides insight into why certain things are designed in a certain way.</p> <p>People should use repetition inside code documentation to highlight what&#x2019;s important.</p> <p>However&#x2026; don&#x2019;t overdo it. Avoid documenting things that frequently change. Avoid repeating <em>ad nauseam</em> decisions that are not important.</p> <h3>Repetition in style</h3> <p>It&#x2019;s often a good idea to have a consistent style. But a consistent style can only be produced by repeating the same stylistic elements, so repetition is essential to a consistent style.</p> <p>Style can apply to a variety of things: from formatting the code, to the way architectural decisions are made. All of them are important, but I would argue that the latter part is more important than the first one. There are only a few things that can damage understandability more than having a set of incoherent decisions. To come back to the &#x2018;codified knowledge&#x2019; interpretation, having inconsistent knowledge is very harmful.</p> <p>However&#x2026; don&#x2019;t overdo it. I&#x2019;ve seen a lot of time spent in minor formatting style debates. Stylistic unity is good, but that doesn&#x2019;t mean that we have to burn a developer at the stake when they add spaces in the wrong place. Don&#x2019;t be dogmatic on this; use tools like <code>clang-format</code> to take the burden off developers.</p> <h3>Repetition in naming</h3> <p>Let&#x2019;s assume that one is writing code for a system based on the Model-View-Controller pattern. Naming all the model classes with the &#x2018;Model&#x2019; suffix, all the view classes with the &#x2018;View&#x2019; suffix and all the Controller classes with the &#x2018;Controller&#x2019; suffix is generally a good idea. It provides coherence within the 3 groups of classes, and it makes it easier for readers to understand the code. Just by looking at the name of such a class, the reader can have a basic understanding of what the class does, without looking at the details.</p> <p>Indeed, psychologies would label this naming repetition as a mnemonic system &#x2013; a learning technique that aids information retention or retrieval in human memory.</p> <p>However&#x2026; don&#x2019;t overdo it. If mnemonics are good, it doesn&#x2019;t mean that we should heavily use identifier naming conventions all over the place. Form should never outlive content. For example, Hungarian notation is heavily criticized in modern software literature. [<a href="#[Martin09]">Martin09</a>]</p> <h3>Don&#x2019;t complicate algorithms to avoid repetition</h3> <p>At the function level, we often don&#x2019;t encounter pure repetition. Two functions that look very similar can have slight differences. If two functions are 90% the same, we cannot avoid repetition by simply reusing the code. We have to carefully separate the commonalities from the differences.</p> <p>The main problem is the common part is too often interleaved with specifics of the two functions we want to collapse. How would we create a common function that can behave differently between the two cases? Often, we add parameters to the common function and pepper its body with <code>if</code> statements. And often the common function becomes more complicated than any of the original functions.</p> <p>As I&#x2019;m writing these lines, I can almost hear the <em>Clean Code</em> [<a href="#[Martin09]">Martin09</a>] fans screaming in my ear: you should create new abstraction classes that implement different policies and pass them to your function. This may work in some cases, but my experience so far is that is seldom a better choice. Two problems with this approach are that we increase the overall complexity of the code (each new abstraction increases complexity) and that it makes the functions hard to follow (the reader may have to jump between different abstractions). But most of the time, a bigger problem arises: to make it work properly, one needs to mix different abstraction level (see the following subsection); this increases a lot the overall complexity.</p> <p>Abstractions are best to be created as a result of the design process, not as a by-product of eliminating duplication.</p> <p>There are a lot of cases in which two functions that are 90% identical should be kept separate. It&#x2019;s just easier to understand them independently. If you really want people to read them together, you can add a comment explaining that they are linked, and they do almost the same thing.</p> <p>Take for example the two functions from Listing 1; it&#x2019;s a scoped down example, but it should be enough to prove our point. The only difference between the two functions is the <code>else break;</code> line. How would one unify the two functions without creating additional <code>if</code> clauses and without adding parameters that reflect implementation details? Would the code be more readable?</p> <p>Similar ideas can also be found (and better presented) in [<a href="#[tef18]">tef18</a>] and [<a href="#[Metz16]">Metz16</a>]. I think this entire section can be reduced to the following two quotes:</p> <p class="quote">The problem with always using an abstraction is that you&#x2019;re pre-emptively guessing which parts of the codebase need to change together. &#x201C;Don&#x2019;t Repeat Yourself&#x201D; will lead to a rigid, tightly coupled mess of code. Repeating yourself is the best way to discover which abstractions, if any, you actually need.<br>~ tef</p> <p class="quote">Duplication is far cheaper than the wrong abstraction<br>~ Sandi Metz</p> <p>However&#x2026; don&#x2019;t overdo it. Sometimes you can shift the abstractions in such a way in which you can eliminate the duplication; analyze each situation separately and don&#x2019;t religiously decide to duplicate code or avoid duplication.</p> <h3>Avoid mixing different abstraction levels</h3> <p>Two functions that do the same thing should not be combined if they operate at different abstraction levels or they belong to unrelated modules. It adds a great burden on the developer who needs to keep changing the context to properly understand the code.</p> <p>For example, summing numbers and summing back accounts are two completely different things; one should not combine the functions that perform the summation.</p> <p>Let us take another example that created a lot of heat in the last couple of months. [<a href="#[Aras18]">Aras18</a>] [<a href="#[Niebler18]">Niebler18</a>]. We aim to print the first N Pythagorean triples (computed in a naive way). A simple C-style solution to this problem is presented in Listing 2. It uses an imperative, plain C-style with one abstraction level.</p> <p>With the C++20 ranges feature, Eric Niebler proposes the implementation from Listing 3 (comments stripped out), arguing for more genericity [<a href="#[Niebler18]">Niebler18</a>].</p> <p>I believe that all readers would consider the latter code much harder to read. There are multiple reasons why this second version is more complex, but one of them is too much change in the abstraction level. Let&#x2019;s analyze this.</p> <p>The code in Listing 3 mixes imperative style (see <code>return</code> statements), with functional style (see piping operator), with more mathematical abstractions (Semiregular, iota), range-specific abstractions (<code>transform</code>, <code>join</code>, <code>take</code>), range building blocks abstractions (<code>view_interface</code>) and C++ in-depth abstractions (<code>IndirectUnaryInvocable</code>, concepts, move semantics). Too many abstraction levels. If you saw a <code>view::transform</code>, a <code>view::join</code> and a <code>view::take</code> in the same code, it would be fine, even if you type more: all the abstractions are at the same level; but don&#x2019;t mix the levels too much.</p> <p>A common side effect of using multiple abstraction levels in the same code is the need for more code to bridge between the abstractions. Having too much plumbing code is a good indication that there are multiple abstraction levels involved. And overall, this will make the understanding of the code much harder.</p> <p>Besides understandability costs, the ranges solution also have pretty high compilation-time costs as Aras points out [<a href="#[Aras18]">Aras18</a>].</p> <p>Related to this, overuse of generics in the name of eliminating duplicates can lead to major pain points. I had the misfortune to see a lot of cases in which templates are used in the name of genericity, and eliminating duplicates, but if you would just write the code without templates, with all the duplication, it would be far smaller than the code with templates.</p> <p>However&#x2026; don&#x2019;t overdo it. Taking the advice in this section too dogmatically would prevent you from creating any abstraction or very little abstraction. Of course, software without good abstraction is bad software.</p> <h3>Repeating the data</h3> <p>Repetition can happen at the code level, but also on the data level. There are cases in which repeating the data leads to a cleaner design and/or improved efficiency.</p> <p>Such is the case with multithreaded code. Instead of having multiple threads accessing the same data source, with the possibility of data-races and with mutexes (read bottleneck instead of mutex), it&#x2019;s sometimes much simpler to duplicate the data. If each thread would have a copy of the data, then there would be no race conditions when accessing the data, and no need to protect the data access. In this case, synchronizing the data between thread can be done by sending messages from one thread to another (which typically involves other data copies).</p> <p>Another case in which data repetition is used is for pure performance reasons. Cache locality is typically important for performance critical code, and cache locality often involves data copies. The classical example is improving the reads from external memory: one can often cache it in memory, and then, based on the algorithm, cache it in L2, L1 and CPU registers. Read duplicate it instead of cache it.</p> <p>However&#x2026; don&#x2019;t overdo it. Of course, both of the cases described here should not be applied blindly. One should typically have a good design/measurements before applying the techniques described here.</p> <h2>Conclusions</h2> <p>Andrew Hunt justifies the DRY principle mainly by the need to avoid maintenance work [<a href="#[Hunt99]">Hunt99</a>]. But we agreed that writing and maintaining code is not the most important part of a programmer&#x2019;s job; instead, reading, understanding and reasoning about the code is far more important. And repetition can help with this. Therefore, the DRY principle is not as justified as one would believe. And, again, ironically, it should not be repeated as often.</p> <p>The purpose of this article was not to convince the reader of how bad the DRY principle is; in general, this can be a good principle. The goal was to draw attention to the fact that applying the principle doctrinally can be harmful. The reader, who is or aspires to be a virtuous programmer, needs to balance the pros and cons when applying this principle. Therefore, it gives me great pleasure to end with Aristotle&#x2019;s golden rule:</p> <p class="quote">Virtue is the golden mean between two vices, the one of excess and the other of deficiency.<br>~ Aristotle</p> <h2>References</h2> <p class="bibliomixed"><a id="[Aras18]"></a>[Aras18] Aras Pranckevi?ius (2018), &#x2018;Modern&#x2019; C++ Lamentations, <a href="http://aras-p.info/blog/2018/12/28/Modern-C-Lamentations/">http://aras-p.info/blog/2018/12/28/Modern-C-Lamentations/</a></p> <p class="bibliomixed"><a id="[Foster09]"></a>[Foster09] Jonathan K. Foster (2009), <em>Memory: A Very Short Introduction</em>, Oxford University Press</p> <p class="bibliomixed"><a id="[Henney19]"></a>[Henney19] Kevlin Henney (2019) &#x2018;What do you mean?&#x2019;, <em>ACCU Conference 2019</em>, <a href="https://www.youtube.com/watch?v=ndnvOElnyUg">https://www.youtube.com/watch?v=ndnvOElnyUg</a></p> <p class="bibliomixed"><a id="[Hunt99]"></a>[Hunt99] Andrew Hunt and David Thomas (1999), <em>The Pragmatic Programmer: From Journeyman to Master</em>, Addison-Wesley Professional</p> <p class="bibliomixed"><a id="[Martin09]"></a>[Martin09] Robert C. Martin ed. (2009), <em>Clean Code: A Handbook of Agile Software Craftsmanship</em>, Pearson Education</p> <p class="bibliomixed"><a id="[Mastin]"></a>[Mastin] Luke Mastin, &#x2018;Short-term (working) memory&#x2019;, <a href="http://www.human-memory.net/types_short.html">http://www.human-memory.net/types_short.html</a></p> <p class="bibliomixed"><a id="[Metz16]"></a>[Metz16] Sandi Metz (2016), &#x2018;The wrong abstraction&#x2019;, <a href="https://www.sandimetz.com/blog/2016/1/20/the-wrong-abstraction">https://www.sandimetz.com/blog/2016/1/20/the-wrong-abstraction</a></p> <p class="bibliomixed"><a id="[Niebler18]"></a>[Niebler18] Eric Niebler (2018), &#x2018;Standard Ranges&#x2019;, <a href="http://ericniebler.com/2018/12/05/standard-ranges/">http://ericniebler.com/2018/12/05/standard-ranges/</a></p> <p class="bibliomixed"><a id="[tef18]"></a>[tef18] tef (2018), &#x2018;Repeat yourself, do more than one thing, and rewrite everything&#x2019;, <a href="https://programmingisterrible.com/post/176657481103/repeat-yourself-do-more-than-one-thing-and">https://programmingisterrible.com/post/176657481103/repeat-yourself-do-more-than-one-thing-and</a></p> <p class="bio"><span class="author"><b>Lucian Radu Teodorescu</b></span> has a PhD in programming languages and is a Software Architect at Garmin. In his spare time, he is working on his own programming language and he is improving his Chuck Norris debugging skills: staring at the code until all the bugs flee in horror.</p> </div></div><hr><h4>Page 4</h4><div><p>Getting different parties to collaborate might sound easy. Frances Buontempo explores where problems and opportunities arise.</p><div><p>We&#x2019;ve been considering a house move recently, so I&#x2019;ve been drowning in emails and forms and waiting for the solicitors to keep us up to date with what&#x2019;s going on. This has distracted me from writing an editorial, as you can imagine. They are sternly refusing to provide any estimates on how long this might take or what they are waiting on. I mean, how hard can it be? OK, to be fair, when we ask a specific question we do get a specific answer, sometimes to a different question. Sometimes, they have even given approximate timelines, saying something like &#x201C;<em>Searches usually take two weeks.</em>&#x201D; The estate agents have a different expectation of timelines, warning us this can take much longer. All very confusing and stressful. I&#x2019;m surprised anyone ever manages to buy a house in the UK. So, as ever, <em>Overload</em> is without an editorial. This did get me thinking though. Managing a project involving programmers or solicitors is like herding cats [<a href="#[Urbandictionary09]">Urban dictionary09</a>], as the saying goes.</p> <p>I can see some parallels between people with different perspectives or motivation trying to collaborate on a project, be that a house-move, writing software, or even a magazine or a book. I find it hard to give estimates for software projects. It is hard. And I don&#x2019;t always go deep into gory tech details if someone asks what I&#x2019;m working on at the moment. I try to adapt my response to the person asking. You can talk about APIs to some people or completed features to others. If you&#x2019;re a team of people working together, it&#x2019;s even harder to come to an agreement and provide a clear answer to a straight question. Larger teams can make this even harder. I can&#x2019;t imagine how Kevlin Henney managed to coordinate the <em>97 Things Every Programmer Should Know</em> book [<a href="#[Henney10]">Henney10</a>] &#x2013; lots of collaboration!</p> <p>Instead of talking about people, how do we get code to collaborate? We know collaborate means working together, so can we get different parts code to work together? How hard can it be? It depends. Remote procedure calls (RPCs) give one way to get code to work together. I haven&#x2019;t used this for a while, but have done my fair share of DCOM and similar. You need to know a lot about the internal workings of the code you call, and can make all sorts of mistakes. But it can work. Another in-tandem approach, without getting as complicated as remote calls, involves trying to get two different languages to work together. You can build several languages into one product using something like Simplified Wrapper and Interface Generator [<a href="#[SWIG]">SWIG</a>] or other bindings, or manually prototype function calls, making sure you find the equivalent of various types, or use a <em>lingua franca</em>, often C. You still need to be very careful about the size and endianness of numbers. Strings are another story. Some shared language and careful testing of assumptions is always required. Alternatively, you can have several &#x2018;products&#x2019; or programs, and get them to talk via messages rather than function calls. That seems simpler. In many ways, it is. You do need to spend time agreeing the syntax and semantics messages. How might you deal with different versions of each component? If you need to send new parameter, how do you approach this? I&#x2019;m getting ahead of myself, though. You can also start thinking about network programming in general and various protocols. Would you like to hear a UDP joke? I would tell you, but you probably won&#x2019;t get it [<a href="#[Hacker News]">Hacker News</a>]. Anyway, one program, in several languages solves some problems. Two or more programs, in the same language, calling each other&#x2019;s functions is suitable for other situations. Two or more programs communicating via messages give some flexibility, but also needs some thought. Yet another way to get things working together is one program, with several threads. You may have events and delegates, or locks around shared data to orchestrate this. If you are not careful, you can get into trouble. Many interviews immediately ask what a deadlock is when multi-threaded code gets mentioned. I wonder if our solicitors have deadlocked themselves somehow.</p> <p>Back to collaboration. Orchestration &#x201C;<em>is the automated configuration, coordination, and management of computer systems and software</em>&#x201D; according to Wikipedia [<a href="#[Wikipedia-1]">Wikipedia-1</a>]. This sounds somewhat like an automated attempt at herding cats. An orchestra plays many instruments together, possibly led by a conductor. The individual players can practise alone, or in smaller groups, but make beautiful music when they come together. This needs some background work and shared language, or at least notation. People can manage to dance together without being coordinated by herds of overseers. If a primary school teacher plays some music, the young people will manage to dance in their own way. They can be individually expressive while moving to the same beat. The idea of timing, through a rhythm or a drum beat is a recurring theme. A rowing team will be guided by a coxswain, in essence counting. It&#x2019;s the London marathon this Sunday. Some people may practise by trying to keep track of their pace. I suspect there&#x2019;s a similarity with the pace at which a team works, in order to get a larger project to succeed. Or even some multi-threaded code. How many problems are &#x2018;fixed&#x2019; by changing the lengths of sleeps, or other timeouts? Can two people work together if they don&#x2019;t speak the same language? I dimly recall a program on the television a while ago, exploring how babies through to toddlers learn. One child, who couldn&#x2019;t yet talk, was encouraged to learn to beat out a drum beat on a table top. He interacted with someone talking to him by responding with various drum beats. Language has a rhythm, and he seemed to instinctively grok that. Little in-roads into getting nearer TCP communication, wherein you get some kind of feedback indicating the message has been received and understood makes some kind of difference.</p> <p>Let&#x2019;s expand this out and talk about learning in a programming context. How can you tell if a mentee or apprentice is learning? Chris Oldwood [<a href="#[Oldwood18]">Oldwood18</a>] suggested counting how many of his jokes the mentee laughed at. Seriously? Damn it. Janet. See what I did there? People who have seen <em>The Rocky Horror Picture Show</em>, tend to immediately say &#x2018;Janet&#x2019; after the phrase &#x2018;Damn it&#x2019;. Sometimes shared &#x2018;secret&#x2019; knowledge comes through. This is almost like a beat or tune or, dare I say it, a joke. You are building a common language. If I say &#x2018;Knock, knock&#x2019; many people know to respond with &#x2018;Who&#x2019;s there?&#x2019; Is this really communicating? I suspect it would be relatively straightforward to get a chat bot to at least start trying to join in with certain jokes. This puts me in mind of an old children&#x2019;s game. Has anyone come across <em>Consequences</em> before [<a href="#[Wikipedia-2]">Wikipedia-2</a>]? You concertina a piece of paper, and fill out words answering questions one each folder, and refolding so you don&#x2019;t see what came before by filling in blanks in a story:</p> <p class="blockquote">Once upon a time, a [name an animal]</p> <p class="blockquote">went to [name a place]&#x2026;</p> <p>and so on.</p> <p>The stories are then read out and hilarity ensues. A variant involves drawing a person, head, neck, torso, legs, and feet. Then you can just laugh at the pictures afterwards, and not waste time reading a story. Does your software project have consequences? Or at least get developed like <em>Consequences</em>? Do you write code that needs to interface or integrate with other teams&#x2019; code? You have probably heard of the Fizz Buzz</p> <p class="blockquote">Write a program that prints the numbers from 1 to 100. But for multiples of three print &quot;Fizz&quot; instead of the number and for the multiples of five print &quot;Buzz&quot;. For numbers which are multiples of both three and five print &quot;FizzBuzz&quot;. [<a href="#[Wiki]">Wiki</a>]</p> <p>Have you heard of &#x2018;Evil Fizz Buzz&#x2019; [<a href="#[codemanship]">codemanship</a>]? This is team work Fizz Buzz, but</p> <ol> <li>Split the team into groups.</li> <li>Assign each part of FizzBuzz above to a pair. They can only work on code for that part of the whole.</li> <li>Task them to work together &#x2013; but only coding/TDD-ing their individual parts &#x2013; to deliver a complete solution that produces the desired output.</li> <li>Give them about an hour. And stand back and enjoy the train wreck.</li> </ol> <p>Try it one day. Figuring out how to get groups of people and software to work together can be challenging.</p> <p>I mentioned chat bots earlier. Let&#x2019;s talk about the rise of the machines. How can AI and humans collaborate? At the speakers&#x2019; dinner at the ACCU conference this year, Echoborg <a href="#[Echoborg]">[Echoborg</a>] entertained us. The website proclaims, &#x2018;A funny and thought-provoking show that is created afresh each time by the audience in conversation with an artificial intelligence.&#x2019; An actor voices the words of a chat bot. Members of the audience go up and chat to the actor. Speech recognition software sends the words to the chat bot, and the actor speaks back. You had to be there. What happens if two Echoborgs chat? Apparently this happened by mistake once, and was turned off forthwith. Could they collaborate and take over the world? What would they do? A while ago some sensationalist headline hit the world: &#x2018;Facebook shuts down chat bots after they invent their own language.&#x2019; The theory is that the bots were tasked with trying to negotiate. The New Scientist said:</p> <p class="blockquote">One bot was taught to mimic the way people negotiated in English, but it turned out to be a weak negotiator, and too willing to agree to unfavourable terms. A second was tasked with maximising its score. This bot was a much better negotiator but ended up using a nonsensical language impossible for humans to understand. [<a href="#[Reynolds17]">Reynolds17</a>].</p> <p>In some ways, negotiation is a form of collaboration, and many industries to end up inventing their own language. Programmers, musicians and solicitors. Just saying!</p> <p>Asking how to get humans and AI to collaborate possibly has a history that pre-dates computers. Elements of Frankenstein pull on the idea of what happens if people create a &#x2018;living&#x2019; autonomous intelligence. That doesn&#x2019;t end well. I&#x2019;ve seen a variety of tales about similar goings on. For example, the adventures of a robot trekking across the US, called HitchBOT. One British newspaper, who shall not be named, said &#x201C;<em>A friendly robot who was hitchhiking its way across America as part of a scientific experiment has been heartlessly attacked and beheaded just 300 miles into its journey.</em>&#x201D; Informative journalism at its height, not. Wait! Friendly? What would an unfriendly HitchBOT be like? A mash-up of Rutger Hauer in <em>The Hitcher </em><a href="#[IMDb-1]">[IMDb-1</a>] and Rutger Hauer in <em>Blade Runner</em><a href="#[IMDb-2]"> [IMDb-2</a>]?</p> <p>OK, enough scary dystopian imaginings. How can you have a human in the loop? Many automatic translation programs, in some ways a type of AI to my mind, have relied on humans giving feedback, including better translations. If you have a way to give feedback to a running algorithm (think AI) then you can collaborate. I gave a workshop with Chris Simons at this year&#x2019;s conference, where we showed how Evolutionary Programming can generate the code for Fizz Buzz. This begs the questions, should you? The code generated was disgusting. But if we then gave feedback, and nudged our fitness functions (think tests) a bit, we might end up with improved code. Maybe code readability doesn&#x2019;t matter if the machine writes its own code and it does what&#x2019;s required. No human need ever look at the implementation. People who want code had better be good at writing tests though. Or maybe we do need to learn to collaborate with the machines. &#x2018;Human in the loop&#x2019; learning is a trending topic in AI research currently. Watch this space.</p> <p class="blockquote">OK, so fill in a first sentence:</p> <p class="blockquote"> [..]. How hard can it be?</p> <p class="blockquote">Go.</p> <p>Yep, OK, getting the number of dots in an ellipsis correct [<a href="#[Buontempo19]">Buontempo19]. </a>Collaboration is difficult, frustrating, frequently involves making up languages and communication protocols but can be fun. It needn&#x2019;t be a collusion or conspiracy, though AI, software engineers and the legal profession can be regarded that way. Teaming up to produce something magical can be amazing. How hard can it be?</p> <h2>References</h2> <p class="bibliomixed"><a id="[Buontempo19]"></a>[Buontempo19] Frances Buontempo (2019) on Twitter, tweeted 27 April 2019: <a href="https://twitter.com/fbuontempo/status/1122074050946318341">https://twitter.com/fbuontempo/status/1122074050946318341</a></p> <p class="bibliomixed"><a id="[codemanship]"></a>[codemanship] &#x2018;Evil FizzBuzz&#x2019; (or &#x2018;So you think you&#x2019;re a team?&#x2019;), 2017, <a href="http://codemanship.co.uk/parlezuml/blog/?postid=1494">http://codemanship.co.uk/parlezuml/blog/?postid=1494</a></p> <p class="bibliomixed"><a id="[Echoborg]"></a>[Echoborg] <a href="http://echoborg.com/">http://echoborg.com/</a></p> <p class="bibliomixed"><a id="[Hacker News]"></a>[Hacker News] <a href="https://news.ycombinator.com/item?id=8466276">https://news.ycombinator.com/item?id=8466276</a></p> <p class="bibliomixed"><a id="[Henney10]"></a>[Henney10] Kevlin Henney (2010) 9<em>7 Things Every Programmer Should Know</em>, published by O&#x2019;Reilly <a href="https://www.oreilly.com/library/view/97-things-every/9780596809515/">https://www.oreilly.com/library/view/97-things-every/9780596809515/</a></p> <p class="bibliomixed"><a id="[IMDb-1]"></a>[IMDb-1] <em>The Hitcher</em> (1986) <a href="https://www.imdb.com/title/tt0091209/">https://www.imdb.com/title/tt0091209/</a></p> <p class="bibliomixed"><a id="[IMDb-2]"></a>[IMDb-2] <em>Blade Runner</em> (1982) <a href="https://www.imdb.com/title/tt0083658/">https://www.imdb.com/title/tt0083658/</a></p> <p class="bibliomixed"><a id="[Oldwood18]"></a>[Oldwood18] Chris Oldwood (2018) &#x2018;Are we nearly there yet?&#x2019; <em>Overload</em> 147, Oct 2018, <a href="https://accu.org/index.php/journals/2566">https://accu.org/index.php/journals/2566</a></p> <p class="bibliomixed"><a id="[Reynolds17]"></a>[Reynolds17] Matt Reynolds (2017) &#x2018;Chatbots learn how to negotiate and drive a hard bargain&#x2019;, <em>New Scientist</em>, posted 14 June 2017 at <a href="https://www.newscientist.com/article/mg23431304-300-chatbots-learn-how-to-drive-a-hard-bargain/">https://www.newscientist.com/article/mg23431304-300-chatbots-learn-how-to-drive-a-hard-bargain/</a></p> <p class="bibliomixed"><a id="[SWIG]"></a>[SWIG] <a href="http://www.swig.org/">http://www.swig.org/</a></p> <p class="bibliomixed"><a id="[Urbandictionary09]"></a>[Urbandictionary09] &#x2018;Herding cats&#x2019; (definition) at <a href="https://www.urbandictionary.com/define.php?term=herding%20cats">https://www.urbandictionary.com/define.php?term=herding%20cats</a></p> <p class="bibliomixed"><a id="[Wiki]"></a>[Wiki] <a href="http://wiki.c2.com/?FizzBuzzTest">http://wiki.c2.com/?FizzBuzzTest</a></p> <p class="bibliomixed"><a id="[Wikipedia-1]"></a>[Wikipedia-1] <a href="https://en.wikipedia.org/wiki/Orchestration_(computing)">https://en.wikipedia.org/wiki/Orchestration_(computing)</a></p> <p class="bibliomixed"><a id="[Wikipedia-2]"></a>[Wikipedia-2] <a href="https://en.wikipedia.org/wiki/Consequences_(game)">https://en.wikipedia.org/wiki/Consequences_(game)</a></p> <p class="bio"><span class="author"><b>Frances Buontempo</b></span> has a BA in Maths + Philosophy, an MSc in Pure Maths and a PhD technically in Chemical Engineering, but mainly programming and learning about AI and data mining. She has been a programmer since the 90s, and learnt to program by reading the manual for her Dad&#x2019;s BBC model B machine.</p> </div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>