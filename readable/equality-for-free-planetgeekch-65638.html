<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Equality for free &#x2013; planetgeek.ch - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Equality for free &#x2013; planetgeek.ch - linksfor.dev(s)"/>
    <meta property="article:author" content="Urs Enzler&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;View all posts"/>
    <meta property="og:description" content="We had one kind of defects in our C# that was very annoying: hidden usage of equality and missing equality members on involved classes."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.planetgeek.ch/2020/08/12/our-journey-to-f-equality-for-free/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Equality for free &#x2013; planetgeek.ch</title>
<div class="readable">
        <h1>Equality for free &#x2013; planetgeek.ch</h1>
            <div>by Urs Enzler&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;View all posts</div>
            <div>Reading time: 3-4 minutes</div>
        <div>Posted here: 14 Aug 2020</div>
        <p><a href="https://www.planetgeek.ch/2020/08/12/our-journey-to-f-equality-for-free/">https://www.planetgeek.ch/2020/08/12/our-journey-to-f-equality-for-free/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
    <article id="post-7563">
	
	                    
        <div>
                        
            
            
<p>We had one kind of defects in our C# that was very annoying: hidden usage of equality and missing equality members on involved classes. </p>



<p>We invested a lot of time to get rid of these in our C# code. Luckily, in F#, this problem does not exist because of the compiler.</p>



<p>But, let’s start at the beginning…</p>



<h2>The problem with equality in C#</h2>



<p>Imagine that somewhere there is this line of code:</p>


<div><div id="highlighter_534785"><table><tbody><tr><td><p>1</p></td><td><div><p><code>items.Union(additionalItems)</code></p></div></td></tr></tbody></table></div></div>


<p><code>items</code> and <code>additionalItems</code> are some enumerables, and we want the union of these, two. Union checks the resulting set for duplicates and removes them.</p>



<p>But to identify duplicates, equality must be implemented in a meaningful way. As we all know, in C#, the default implementation is reference equality.</p>



<p>Since our business logic uses data that was passed from the client and data that is read from the database, we often have the same data, but in two different objects. If we want them to be treated as equally, we need to implement the equality members. Of course, it’s obvious!</p>



<p>Not so much, when a line of code – like the <code>Union</code> above – is “hidden” in some code you are calling, either your code or a library. Or even worse, via a generic class: <code>SomeGeneric&lt;MyClassThatShouldImplementEqualityButIDidntKnow&gt;</code></p>



<h2>Let’s do something about it</h2>



<p>So we did several things to get a grip on this problem:</p>



<ul><li><a href="https://github.com/ursenzler/PreventEqualsMisusageAnalyzer">Code analyzer</a> that prohibits the usage of <code>Union</code>, <code>Distinct</code>, <code>GroupBy</code>, <code>Except</code>, <code>Intersect</code>, <code>Contains</code> and <code>Equals</code>.</li><li>Extension methods constraining the passed values to <code>IEquatable</code> for the prohibited methods mentioned above. So classes have to implement <code>IEquatable</code>. And we have a unit test that checks all classes implementing <code>IEquatable</code> for correctness.</li><li>Explicit equality comparer when equality was context-sensitive.</li><li>Equals.Fody when we needed real implementations for equality on a class (as little as possible because of the build time penalty this introduces)</li></ul>



<p>Manually implementing the equality members (or with the help of R#) is very time consuming, not refactoring friendly and error prone.</p>



<p>So it is a pain!</p>



<h2>And in F#?</h2>



<p>In F#, however, the compiler generates the equality members for records automatically. So all the pain simply goes away. Records have a reasonable default behaviour, compared to classes.</p>



<p><em>A side note:</em> almost all our classes in C# are immutable because of <a href="https://fsharpforfunandprofit.com/posts/correctness-immutability/">theses reasons</a>.</p>



<p>Almost. </p>



<h2>A mix of C# and F#</h2>



<p>Our code base is now a mix of C# and F# code. So when we are in a mixed context, equality still is a bit tricky. For us, this happens in the tests, when a test uses classes and records mixed in an object-graph. But luckily, there is <a href="https://fluentassertions.com/">FluentAssertions </a>, and we wrote some wrappers so that it can easily be used from F#. But this is another blog post.</p>





<p>Find all blog posts about our journey to F# <a href="https://www.planetgeek.ch/tag/f-journey/">here</a>.</p>



<figure><a href="http://timerocket.ch/"><img src="https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-1024x992.png" alt="" width="58" height="56" srcset="https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-1024x992.png 1024w, https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-300x291.png 300w, https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-768x744.png 768w, https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-1536x1488.png 1536w, https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-720x697.png 720w, https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-580x562.png 580w, https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket-320x310.png 320w, https://www.planetgeek.ch/wp-content/uploads/2020/05/timerocket-rocket.png 1917w" sizes="(max-width: 58px) 100vw, 58px"></a></figure>



<p>This blog post is made possible with the support of <a href="http://timerocket.ch/">Time Rocket</a>, the product this journey is all about. Take a look (German only).</p>



                        
                            
            
        </div>
        
                     	
	
		

	        
    </article>
</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>