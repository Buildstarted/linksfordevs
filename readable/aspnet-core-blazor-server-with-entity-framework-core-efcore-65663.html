<!DOCTYPE html>
<html lang="en">
<head>
    <title>
ASP.NET Core Blazor Server with Entity Framework Core (EFCore) - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="ASP.NET Core Blazor Server with Entity Framework Core (EFCore) - linksfor.dev(s)"/>
    <meta property="article:author" content="JeremyLikness"/>
    <meta property="og:description" content="Guidance for using EF Core in Blazor Server apps."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://docs.microsoft.com/en-us/aspnet/core/blazor/blazor-server-ef-core?view=aspnetcore-3.1"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - ASP.NET Core Blazor Server with Entity Framework Core (EFCore)</title>
<div class="readable">
        <h1>ASP.NET Core Blazor Server with Entity Framework Core (EFCore)</h1>
            <div>by JeremyLikness</div>
            <div>Reading time: 13-16 minutes</div>
        <div>Posted here: 14 Aug 2020</div>
        <p><a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/blazor-server-ef-core?view=aspnetcore-3.1">https://docs.microsoft.com/en-us/aspnet/core/blazor/blazor-server-ef-core?view=aspnetcore-3.1</a></p>
        <hr/>
<div id="readability-page-1" class="page">


	<div data-bi-name="body">

		<div>

			

			<section>
				<div>


				<div id="main-column">

					<main id="main" role="main" data-bi-name="content" lang="en-us" dir="ltr">



						

						<ul data-bi-name="page info" lang="en-us" dir="ltr">
							<li>
								<time data-article-date="" aria-label="Article review date" datetime="2020-08-14T00:00:00.000Z" data-article-date-source="ms.date">08/14/2020</time>
							</li>
								<li>8 minutes to read</li>
								<li>
									<a href="https://github.com/dotnet/AspNetCore.Docs/blob/master/aspnetcore/blazor/blazor-server-ef-core.md" title="1 Contributor" aria-label="1 Contributor">
										<ul data-bi-name="contributors" aria-hidden="true">
													<li><img src="https://github.com/JeremyLikness.png?size=32" data-src="https://github.com/JeremyLikness.png?size=32" role="presentation"></li>
										</ul>
									</a>
								</li>
						</ul>

						<nav id="center-doc-outline" data-bi-name="intopic toc" role="navigation" aria-label="Article Outline">
							<h3>In this article</h3>
						<ol><li><a href="#sample-app-1">Sample app</a></li><li><a href="#database-access-1">Database access</a></li><li><a href="#database-access-2">Database access</a></li><li><a href="#additional-resources">Additional resources</a></li></ol></nav>

						<!-- <content> -->
							<p>By: <a href="https://github.com/JeremyLikness" data-linktype="external">Jeremy Likness</a></p>
<div data-moniker="aspnetcore-5.0">
<p>Blazor Server is a stateful app framework. The app maintains an ongoing connection to the server, and the user's state is held in the server's memory in a <em>circuit</em>. One example of user state is data held in <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1" data-linktype="relative-path">dependency injection (DI)</a> service instances that are scoped to the circuit. The unique application model that Blazor Server provides requires a special approach to use Entity Framework Core.</p>
<div>
<p><span aria-hidden="true"></span> Note</p>
<p>This article addresses EF Core in Blazor Server apps. Blazor WebAssembly apps run in a WebAssembly sandbox that prevents most direct database connections. Running EF Core in Blazor WebAssembly is beyond the scope of this article.</p>
</div>
<h2 data-id="sample-app"><a href="#sample-app" aria-labelledby="sample-app"></a>Sample app</h2>
<p>The sample app was built as a reference for Blazor Server apps that use EF Core. The sample app includes a grid with sorting and filtering, delete, add, and update operations. The sample demonstrates use of EF Core to handle optimistic concurrency.</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/blazor/common/samples/5.x/BlazorServerEFCoreSample" data-linktype="external">View or download sample code</a> (<a href="https://docs.microsoft.com/en-us/aspnet/core/introduction-to-aspnet-core?view=aspnetcore-3.1#how-to-download-a-sample" data-linktype="relative-path">how to download</a>)</p>
<p>The sample uses a local <a href="https://www.sqlite.org/index.html" data-linktype="external">SQLite</a> database so that it can be used on any platform. The sample also configures database logging to show the SQL queries that are generated. This is configured in <code>appsettings.Development.json</code>:</p>
<pre tabindex="0"><code highlight-lines="8" data-author-content="{
  &quot;DetailedErrors&quot;: true,
  &quot;Logging&quot;: {
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Microsoft&quot;: &quot;Warning&quot;,
      &quot;Microsoft.Hosting.Lifetime&quot;: &quot;Information&quot;,
      &quot;Microsoft.EntityFrameworkCore.Database.Command&quot;: &quot;Information&quot;
    }
  }
}
"><span>{
  <span>"DetailedErrors"</span>: <span>true</span>,
  <span>"Logging"</span>: {
    <span>"LogLevel"</span>: {
      <span>"Default"</span>: <span>"Information"</span>,
      <span>"Microsoft"</span>: <span>"Warning"</span>,
      <span>"Microsoft.Hosting.Lifetime"</span>: <span>"Information"</span>,</span>
<mark>      <span>"Microsoft.EntityFrameworkCore.Database.Command"</span>: <span>"Information"</span></mark>
<span>    }
  }
}
</span></code></pre>
<p>The grid, add, and view components use the "context-per-operation" pattern, where a context is created for each operation. The edit component uses the "context-per-component" pattern, where a context is created for each component.</p>
<h2 data-id="database-access"><a href="#database-access" aria-labelledby="database-access"></a>Database access</h2>
<p>EF Core relies on a <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> as the means to <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/configuring-dbcontext" data-linktype="absolute-path">configure database access</a> and act as a <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external"><em>unit of work</em></a>. EF Core provides the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.entityframeworkservicecollectionextensions.adddbcontext" data-linktype="absolute-path">AddDbContext</a> extension for ASP.NET Core apps that registers the context as a <em>scoped</em> service by default. In Blazor Server apps, scoped service registrations can be problematic because the instance is shared across components within the user's circuit. <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> isn't thread safe and isn't designed for concurrent use. The existing lifetimes are inappropriate for these reasons:</p>
<ul>
<li><strong>Singleton</strong> shares state across all users of the app and leads to inappropriate concurrent use.</li>
<li><strong>Scoped</strong> (the default) poses a similar issue between components for the same user.</li>
<li><strong>Transient</strong> results in a new instance per request; but as components can be long-lived, this results in a longer-lived context than may be intended.</li>
</ul>
<p>The following recommendations are designed to provide a consistent approach to using EF Core in Blazor Server apps.</p>
<ul>
<li><p>By default, consider using one context per operation. The context is designed for fast, low overhead instantiation:</p>
<pre tabindex="0"><code data-author-content="var using context = new MyContext();

return await context.MyEntities.ToListAsync();
"><span><span>var</span> <span>using</span> context = <span>new</span> MyContext();

<span>return</span> <span>await</span> context.MyEntities.ToListAsync();
</span></code></pre>
</li>
<li><p>Use a flag to prevent multiple concurrent operations:</p>
<pre tabindex="0"><code data-author-content="if (Loading)
{
    return;
}
try 
{
    Loading = true;
    // operations go here
}
finally 
{
    Loading = false;
}
"><span><span>if</span> (Loading)
{
    <span>return</span>;
}
<span>try</span> 
{
    Loading = <span>true</span>;
    <span>// operations go here</span>
}
<span>finally</span> 
{
    Loading = <span>false</span>;
}
</span></code></pre>
</li>
<li><p>For longer-lived operations that take advantage of EF Core's <a href="https://docs.microsoft.com/en-us/ef/core/querying/tracking" data-linktype="absolute-path">change tracking</a> or <a href="https://docs.microsoft.com/en-us/ef/core/saving/concurrency" data-linktype="absolute-path">concurrency control</a>, <a href="#scope-to-the-component-lifetime" data-linktype="self-bookmark">scope the context to the lifetime of the component</a>.</p>
</li>
</ul>
<h3 data-id="new-dbcontext-instances"><a href="#new-dbcontext-instances" aria-labelledby="new-dbcontext-instances"></a>New DbContext instances</h3>
<p>The fastest way to create a new <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> instance is by using <code>new</code> to create a new instance. However, there are several scenarios that may require resolving additional dependencies. For example, you may wish to use <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/configuring-dbcontext#configuring-dbcontextoptions" data-linktype="absolute-path"><code>DbContextOptions</code></a> to configure the context.</p>
<p>The recommended solution to create a new <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> with dependencies is to use a factory. EF Core 5.0 or later provides a built-in factory for creating new contexts.</p>
<p>The following example configures <a href="https://www.sqlite.org/index.html" data-linktype="external">SQLite</a> and enables data logging. The code uses an extension method to configure the database factory for DI and provide default options:</p>
<pre tabindex="0"><code data-author-content="services.AddDbContextFactory<ContactContext>(opt =>
    opt.UseSqlite($&quot;Data Source={nameof(ContactContext.ContactsDb)}.db&quot;)
    .EnableSensitiveDataLogging());
"><span>services.AddDbContextFactory&lt;ContactContext&gt;(opt =&gt;
    opt.UseSqlite(<span>$"Data Source=<span>{<span>nameof</span>(ContactContext.ContactsDb)}</span>.db"</span>)
    .EnableSensitiveDataLogging());
</span></code></pre>
<p>The factory is injected into components and used to create new instances. For example, in <code>Pages/Index.razor</code>:</p>
<pre tabindex="0"><code data-author-content="private async Task DeleteContactAsync()
{
    using var context = DbFactory.CreateDbContext();
    Filters.Loading = true;
    var contact = await context.Contacts.FirstAsync(
        c => c.Id == Wrapper.DeleteRequestId);
    if (contact != null)
    {
        context.Contacts.Remove(contact);
        await context.SaveChangesAsync();
    }
    Filters.Loading = false;
    await ReloadAsync();
}
"><span><span>private async Task DeleteContactAsync()
{
    using var context = DbFactory.CreateDbContext();
    Filters.Loading = true;
    var contact = await context.Contacts.FirstAsync(
        c =&gt; c.Id == Wrapper.DeleteRequestId);
    if (contact != null)
    {
        context.Contacts.Remove(contact);
        await context.SaveChangesAsync();
    }
    Filters.Loading = false;
    await ReloadAsync();
}
</span></span></code></pre><h3 data-id="scope-to-the-component-lifetime"><a href="#scope-to-the-component-lifetime" aria-labelledby="scope-to-the-component-lifetime"></a>Scope to the component lifetime</h3>
<p>You may wish to create a <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> that exists for the lifetime of a component. This allows you to use it as a <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external">unit of work</a> and take advantage of built-in features, such as change tracking and concurrency resolution.
You can use the factory to create a context and track it for the lifetime of the component. First, implement <a href="https://docs.microsoft.com/en-us/dotnet/api/system.idisposable" data-linktype="absolute-path">IDisposable</a> and inject the factory as shown in <code>Pages/EditContact.razor</code>:</p>
<pre tabindex="0"><code data-author-content="@implements IDisposable

@inject IDbContextFactory<ContactContext> DbFactory
"><span><span></span><span><span>@implements</span><span> IDisposable</span></span><span>

</span><span><span>@inject</span><span> IDbContextFactory&lt;ContactContext&gt; DbFactory</span></span><span>
</span></span></code></pre>
<p>The sample app ensures the contact is disposed when the component is disposed:</p>
<pre tabindex="0"><code data-author-content="public void Dispose()
{
    Context.Dispose();
}
"><span><span>public void Dispose()
{
    Context.Dispose();
}
</span></span></code></pre>
<p>Finally, <code>OnInitializedAsync</code> is overridden to create a new context. In the sample app, <code>OnInitializedAsync</code> loads the contact in the same method:</p>
<pre tabindex="0"><code data-author-content="protected override async Task OnInitializedAsync()
{
    Busy = true; // start async
    try
    {
        Context = DbFactory.CreateDbContext();
        Contact = await Context.Contacts
            .SingleOrDefaultAsync(c => c.Id == ContactId);
        // additional error handling can go in a catch block below
    }
    finally
    {
        Busy = false; // end async
    }
    await base.OnInitializedAsync();
}
"><span><span>protected override async Task OnInitializedAsync()
{
    Busy = true; // start async
    try
    {
        Context = DbFactory.CreateDbContext();
        Contact = await Context.Contacts
            .SingleOrDefaultAsync(c =&gt; c.Id == ContactId);
        // additional error handling can go in a catch block below
    }
    finally
    {
        Busy = false; // end async
    }
    await base.OnInitializedAsync();
}
</span></span></code></pre></div>
<div data-moniker="aspnetcore-3.1">
<p>Blazor Server is a stateful app framework. The app maintains an ongoing connection to the server, and the user's state is held in the server's memory in a <em>circuit</em>. One example of user state is data held in <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1" data-linktype="relative-path">dependency injection (DI)</a> service instances that are scoped to the circuit. The unique application model that Blazor Server provides requires a special approach to use Entity Framework Core.</p>
<div>
<p><span aria-hidden="true"></span> Note</p>
<p>This article addresses EF Core in Blazor Server apps. Blazor WebAssembly apps run in a WebAssembly sandbox that prevents most direct database connections. Running EF Core in Blazor WebAssembly is beyond the scope of this article.</p>
</div>
<h2 id="sample-app-1"><a href="#sample-app-1" aria-labelledby="sample-app-1"></a>Sample app</h2>
<p>The sample app was built as a reference for Blazor Server apps that use EF Core. The sample app includes a grid with sorting and filtering, delete, add, and update operations. The sample demonstrates use of EF Core to handle optimistic concurrency.</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/blazor/common/samples/3.x/BlazorServerEFCoreSample" data-linktype="external">View or download sample code</a> (<a href="https://docs.microsoft.com/en-us/aspnet/core/introduction-to-aspnet-core?view=aspnetcore-3.1#how-to-download-a-sample" data-linktype="relative-path">how to download</a>)</p>
<p>The sample uses a local <a href="https://www.sqlite.org/index.html" data-linktype="external">SQLite</a> database so that it can be used on any platform. The sample also configures database logging to show the SQL queries that are generated. This is configured in <code>appsettings.Development.json</code>:</p>
<pre tabindex="0"><code highlight-lines="8" data-author-content="{
  &quot;DetailedErrors&quot;: true,
  &quot;Logging&quot;: {
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Microsoft&quot;: &quot;Warning&quot;,
      &quot;Microsoft.Hosting.Lifetime&quot;: &quot;Information&quot;,
      &quot;Microsoft.EntityFrameworkCore.Database.Command&quot;: &quot;Information&quot;
    }
  }
}
"><span>{
  <span>"DetailedErrors"</span>: <span>true</span>,
  <span>"Logging"</span>: {
    <span>"LogLevel"</span>: {
      <span>"Default"</span>: <span>"Information"</span>,
      <span>"Microsoft"</span>: <span>"Warning"</span>,
      <span>"Microsoft.Hosting.Lifetime"</span>: <span>"Information"</span>,</span>
<mark>      <span>"Microsoft.EntityFrameworkCore.Database.Command"</span>: <span>"Information"</span></mark>
<span>    }
  }
}
</span></code></pre>
<p>The grid, add, and view components use the "context-per-operation" pattern, where a context is created for each operation. The edit component uses the "context-per-component" pattern, where a context is created for each component.</p>
<h2 id="database-access-1"><a href="#database-access-1" aria-labelledby="database-access-1"></a>Database access</h2>
<p>EF Core relies on a <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> as the means to <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/configuring-dbcontext" data-linktype="absolute-path">configure database access</a> and act as a <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external"><em>unit of work</em></a>. EF Core provides the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.entityframeworkservicecollectionextensions.adddbcontext" data-linktype="absolute-path">AddDbContext</a> extension for ASP.NET Core apps that registers the context as a <em>scoped</em> service by default. In Blazor Server apps, this can be problematic because the instance is shared across components within the user's circuit. <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> isn't thread safe and isn't designed for concurrent use. The existing lifetimes are inappropriate for these reasons:</p>
<ul>
<li><strong>Singleton</strong> shares state across all users of the app and leads to inappropriate concurrent use.</li>
<li><strong>Scoped</strong> (the default) poses a similar issue between components for the same user.</li>
<li><strong>Transient</strong> results in a new instance per request; but as components can be long-lived, this results in a longer-lived context than may be intended.</li>
</ul>
<h2 id="database-access-2"><a href="#database-access-2" aria-labelledby="database-access-2"></a>Database access</h2>
<p>The following recommendations are designed to provide a consistent approach to using EF Core in Blazor Server apps.</p>
<ul>
<li><p>By default, consider using one context per operation. The context is designed for fast, low overhead instantiation:</p>
<pre tabindex="0"><code data-author-content="var using context = new MyContext();

return await context.MyEntities.ToListAsync();
"><span><span>var</span> <span>using</span> context = <span>new</span> MyContext();

<span>return</span> <span>await</span> context.MyEntities.ToListAsync();
</span></code></pre>
</li>
<li><p>Use a flag to prevent multiple concurrent operations:</p>
<pre tabindex="0"><code data-author-content="if (Loading)
{
    return;
}
try 
{
    Loading = true;
    // operations go here
}
finally 
{
    Loading = false;
}
"><span><span>if</span> (Loading)
{
    <span>return</span>;
}
<span>try</span> 
{
    Loading = <span>true</span>;
    <span>// operations go here</span>
}
<span>finally</span> 
{
    Loading = <span>false</span>;
}
</span></code></pre>
</li>
<li><p>For longer-lived operations that take advantage of EF Core's <a href="https://docs.microsoft.com/en-us/ef/core/querying/tracking" data-linktype="absolute-path">change tracking</a> or <a href="https://docs.microsoft.com/en-us/ef/core/saving/concurrency" data-linktype="absolute-path">concurrency control</a>, <a href="#scope-to-the-component-lifetime" data-linktype="self-bookmark">scope the context to the lifetime of the component</a>.</p>
</li>
</ul>
<h3 id="create-new-dbcontext-instances"><a href="#create-new-dbcontext-instances" aria-labelledby="create-new-dbcontext-instances"></a>Create new DbContext instances</h3>
<p>The fastest way to create a new <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> instance is by using <code>new</code> to create a new instance. However, there are several scenarios that may require resolving additional dependencies. For example, you may wish to use <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/configuring-dbcontext#configuring-dbcontextoptions" data-linktype="absolute-path"><code>DbContextOptions</code></a> to configure the context.</p>
<p>The recommended solution to create a new <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> with dependencies is to use a factory. The sample app implements its own factory in <code>Data/DbContextFactory.cs</code>.</p>
<pre tabindex="0"><code data-author-content="using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using System;

namespace BlazorServerDbContextExample.Data
{
    /// <summary>
    /// Factory to generate instances of <see cref=&quot;TContext&quot;/>.
    /// </summary>
    /// <typeparam name=&quot;TContext&quot;>The <see cref=&quot;DbContext&quot;/> type to provide.</typeparam>
    public class DbContextFactory<TContext> : IDbContextFactory<TContext> where TContext : DbContext
    {
        /// <summary>
        /// Service provider.
        /// </summary>
        private readonly IServiceProvider _provider;

        /// <summary>
        /// Inject the service provider.
        /// </summary>
        /// <param name=&quot;provider&quot;>The <see cref=&quot;IServiceProvider&quot;/> instance.</param>
        public DbContextFactory(IServiceProvider provider)
        {
            _provider = provider;
        }

        /// <summary>
        /// Create a newly created context.
        /// </summary>
        /// <returns>A new instance of <see cref=&quot;TContext&quot;/>.</returns>
        // rename to Create
        public TContext CreateDbContext()
        {
            if (_provider == null)
            {
                throw new InvalidOperationException($&quot;You must configure an instance of IServiceProvider&quot;);
            }

            // satisfies any dependencies via the provider
            return ActivatorUtilities.CreateInstance<TContext>(_provider);
        }
    }
}
"><span><span>using</span> Microsoft.EntityFrameworkCore;
<span>using</span> Microsoft.Extensions.DependencyInjection;
<span>using</span> System;

<span>namespace</span> <span>BlazorServerDbContextExample.Data</span>
{
    <span><span>///</span> <span>&lt;summary&gt;</span></span>
    <span><span>///</span> Factory to generate instances of <span>&lt;see cref="TContext"/&gt;</span>.</span>
    <span><span>///</span> <span>&lt;/summary&gt;</span></span>
    <span><span>///</span> <span>&lt;typeparam name="TContext"&gt;</span>The <span>&lt;see cref="DbContext"/&gt;</span> type to provide.<span>&lt;/typeparam&gt;</span></span>
    <span>public</span> <span>class</span> <span>DbContextFactory</span>&lt;<span>TContext</span>&gt; : <span>IDbContextFactory</span>&lt;<span>TContext</span>&gt; <span>where</span> <span>TContext</span> : <span>DbContext</span>
    {
        <span><span>///</span> <span>&lt;summary&gt;</span></span>
        <span><span>///</span> Service provider.</span>
        <span><span>///</span> <span>&lt;/summary&gt;</span></span>
        <span>private</span> <span>readonly</span> IServiceProvider _provider;

        <span><span>///</span> <span>&lt;summary&gt;</span></span>
        <span><span>///</span> Inject the service provider.</span>
        <span><span>///</span> <span>&lt;/summary&gt;</span></span>
        <span><span>///</span> <span>&lt;param name="provider"&gt;</span>The <span>&lt;see cref="IServiceProvider"/&gt;</span> instance.<span>&lt;/param&gt;</span></span>
        <span><span>public</span> <span>DbContextFactory</span>(<span>IServiceProvider provider</span>)</span>
        {
            _provider = provider;
        }

        <span><span>///</span> <span>&lt;summary&gt;</span></span>
        <span><span>///</span> Create a newly created context.</span>
        <span><span>///</span> <span>&lt;/summary&gt;</span></span>
        <span><span>///</span> <span>&lt;returns&gt;</span>A new instance of <span>&lt;see cref="TContext"/&gt;</span>.<span>&lt;/returns&gt;</span></span>
        <span>// rename to Create</span>
        <span><span>public</span> TContext <span>CreateDbContext</span>(<span></span>)</span>
        {
            <span>if</span> (_provider == <span>null</span>)
            {
                <span>throw</span> <span>new</span> InvalidOperationException(<span>$"You must configure an instance of IServiceProvider"</span>);
            }

            <span>// satisfies any dependencies via the provider</span>
            <span>return</span> ActivatorUtilities.CreateInstance&lt;TContext&gt;(_provider);
        }
    }
}
</span></code></pre>
<p>The following example configures <a href="https://www.sqlite.org/index.html" data-linktype="external">SQLite</a> and enables data logging. The code uses an extension method to configure the database factory for DI and provide default options:</p>
<pre tabindex="0"><code data-author-content="services.AddDbContextFactory<ContactContext>(opt =>
    opt.UseSqlite($&quot;Data Source={nameof(ContactContext.ContactsDb)}.db&quot;)
    .EnableSensitiveDataLogging());
"><span>services.AddDbContextFactory&lt;ContactContext&gt;(opt =&gt;
    opt.UseSqlite(<span>$"Data Source=<span>{<span>nameof</span>(ContactContext.ContactsDb)}</span>.db"</span>)
    .EnableSensitiveDataLogging());
</span></code></pre>
<p>The factory is injected into components and used to create new instances. For example, in <code>Pages/Index.razor</code>:</p>
<pre tabindex="0"><code data-author-content="private async Task DeleteContactAsync()
{
    using var context = DbFactory.CreateDbContext();
    Filters.Loading = true;
    var contact = await context.Contacts.FirstAsync(
        c => c.Id == Wrapper.DeleteRequestId);
    if (contact != null)
    {
        context.Contacts.Remove(contact);
        await context.SaveChangesAsync();
    }
    Filters.Loading = false;
    await ReloadAsync();
}
"><span><span>private async Task DeleteContactAsync()
{
    using var context = DbFactory.CreateDbContext();
    Filters.Loading = true;
    var contact = await context.Contacts.FirstAsync(
        c =&gt; c.Id == Wrapper.DeleteRequestId);
    if (contact != null)
    {
        context.Contacts.Remove(contact);
        await context.SaveChangesAsync();
    }
    Filters.Loading = false;
    await ReloadAsync();
}
</span></span></code></pre><h3 id="scope-to-the-component-lifetime-1"><a href="#scope-to-the-component-lifetime-1" aria-labelledby="scope-to-the-component-lifetime-1"></a>Scope to the component lifetime</h3>
<p>You may wish to create a <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext" data-linktype="absolute-path">DbContext</a> that exists for the lifetime of a component. This allows you to use it as a <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external">unit of work</a> and take advantage of built-in features, such as change tracking and concurrency resolution.
You can use the factory to create a context and track it for the lifetime of the component. First, implement <a href="https://docs.microsoft.com/en-us/dotnet/api/system.idisposable" data-linktype="absolute-path">IDisposable</a> and inject the factory as shown in <code>Pages/EditContact.razor</code>:</p>
<pre tabindex="0"><code data-author-content="@implements IDisposable

@inject IDbContextFactory<ContactContext> DbFactory
"><span><span></span><span><span>@implements</span><span> IDisposable</span></span><span>

</span><span><span>@inject</span><span> IDbContextFactory&lt;ContactContext&gt; DbFactory</span></span><span>
</span></span></code></pre>
<p>The sample app ensures the contact is disposed when the component is disposed:</p>
<pre tabindex="0"><code data-author-content="public void Dispose()
{
    Context.Dispose();
}
"><span><span>public void Dispose()
{
    Context.Dispose();
}
</span></span></code></pre>
<p>Finally, <code>OnInitializedAsync</code> is overridden to create a new context. In the sample app, <code>OnInitializedAsync</code> loads the contact in the same method:</p>
<pre tabindex="0"><code data-author-content="protected override async Task OnInitializedAsync()
{
    Busy = true; // start async
    try
    {
        Context = DbFactory.CreateDbContext();
        Contact = await Context.Contacts
            .SingleOrDefaultAsync(c => c.Id == ContactId);
        // additional error handling can go in a catch block below
    }
    finally
    {
        Busy = false; // end async
    }
    await base.OnInitializedAsync();
}
"><span><span>protected override async Task OnInitializedAsync()
{
    Busy = true; // start async
    try
    {
        Context = DbFactory.CreateDbContext();
        Contact = await Context.Contacts
            .SingleOrDefaultAsync(c =&gt; c.Id == ContactId);
        // additional error handling can go in a catch block below
    }
    finally
    {
        Busy = false; // end async
    }
    await base.OnInitializedAsync();
}
</span></span></code></pre></div>
<h2 id="additional-resources"><a href="#additional-resources" aria-labelledby="additional-resources"></a>Additional resources</h2>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/ef/" data-linktype="absolute-path">EF Core documentation</a></p>
</blockquote>

						<!-- </content> -->

						</main>

						<!-- page rating section -->
								
						<!-- end page rating section -->


						<!-- feedback section -->
<section data-bi-name="feedback-section">

    <h2 id="feedback">Feedback</h2>

    <div>
        <p aria-hidden="true" id="send-feedback-about">Submit and view feedback for</p>

        
    </div>

    
</section>

						<!-- end feedback section -->

						<!-- feedback report section -->
						<!-- end feedback report section -->

						
					</div>

					

					<!--end of div.columns -->
				</div>

			<!--end of .primary-holder -->
			</section>

			
		</div>

		<!--end of .mainContainer -->
	</div>

	

	

	
	<span id="adobe-target-experiment-container" hidden=""></span>


</div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>