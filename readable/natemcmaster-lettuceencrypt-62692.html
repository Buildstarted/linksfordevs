<!DOCTYPE html>
<html lang="en">
<head>
    <title>
natemcmaster/LettuceEncrypt - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="natemcmaster/LettuceEncrypt - linksfor.dev(s)"/>
    <meta property="og:description" content="Free, automatic HTTPS (SSL/TLS) certificate generation for ASP.NET Core web apps - natemcmaster/LettuceEncrypt"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://github.com/natemcmaster/LettuceEncrypt"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - natemcmaster/LettuceEncrypt</title>
<div class="readable">
        <h1>natemcmaster/LettuceEncrypt</h1>
            <div>Reading time: 9-11 minutes</div>
        <div>Posted here: 10 Jun 2020</div>
        <p><a href="https://github.com/natemcmaster/LettuceEncrypt">https://github.com/natemcmaster/LettuceEncrypt</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="readme">
    
      <div>
        <article itemprop="text">
<p><a href="https://dev.azure.com/natemcmaster/github/_build/latest?definitionId=11&amp;branchName=master" rel="nofollow"><img src="https://camo.githubusercontent.com/9c84fa5877367701e8fdf62dc1a0add6b3255642/68747470733a2f2f6465762e617a7572652e636f6d2f6e6174656d636d61737465722f6769746875622f5f617069732f6275696c642f7374617475732f4c657474756365456e63727970743f6272616e63684e616d653d6d6173746572" alt="Build Status" data-canonical-src="https://dev.azure.com/natemcmaster/github/_apis/build/status/LettuceEncrypt?branchName=master"></a> <a href="https://nuget.org/packages/LettuceEncrypt" rel="nofollow"><img src="https://camo.githubusercontent.com/d08dd11a442658e27c48eba4656c418892a7523b/68747470733a2f2f696d672e736869656c64732e696f2f6e756765742f762f4c657474756365456e63727970743f636f6c6f723d626c7565" alt="Nuget" data-canonical-src="https://img.shields.io/nuget/v/LettuceEncrypt?color=blue"></a></p>
<p>LettuceEncrypt <g-emoji alias="leafy_green" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f96c.png">ü•¨</g-emoji> provides API for ASP.NET Core projects to integrate with a certificate authority (CA), such as
<a href="https://letsencrypt.org/" rel="nofollow">Let's Encrypt</a>, for free, automatic HTTPS (SSL/TLS) certificates using the <a href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment" rel="nofollow">ACME</a> protocol.</p>
<p>When enabled, your web server will <strong>automatically</strong> generate an HTTPS certificate during start up.
It then configures Kestrel to use this certificate for all HTTPS traffic.
See <a href="#usage">usage instructions below</a> to get started.</p>
<p>Created and developed by <a href="https://github.com/natemcmaster">@natemcmaster</a> with <g-emoji alias="heart" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png">‚ù§Ô∏è</g-emoji> from Seattle <g-emoji alias="coffee" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2615.png">‚òïÔ∏è</g-emoji>.
This project was formerly known as "McMaster.AspNetCore.LetsEncrypt", but <a href="https://github.com/natemcmaster/LettuceEncrypt/issues/99">has been renamed for
trademark reasons</a>. This project is <strong>not an official
offering</strong> from Let's Encrypt¬Æ or ISRG‚Ñ¢.</p>
<p>Special thanks to my sponsors!</p>
<ul>
<li><a href="https://github.com/bordenit">@bordenit</a></li>
</ul>
<p>This project is 100% organic and best served cold with ranch and carrots.</p>
<h2>Will this work for me?</h2>
<p>That depends on <a href="#web-server-scenarios">which kind of web server you are using</a>. This library only works with
<a href="https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel" rel="nofollow">Kestrel</a>, which is the default server
configuration for ASP.NET Core projects. Other servers, such as IIS and HTTP.sys, are not supported.
Furthermore, this only works when Kestrel is the edge server.</p>
<p>Not sure? <a href="#web-server-scenarios">Read "Web Server Scenarios" below for more details.</a></p>
<p>Using <g-emoji alias="cloud" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2601.png">‚òÅÔ∏è</g-emoji> Azure App Services (aka WebApps)? This library isn't for you, but you can still get free HTTPS certificates.
See <a href="https://www.hanselman.com/blog/SecuringAnAzureAppServiceWebsiteUnderSSLInMinutesWithLetsEncrypt.aspx" rel="nofollow">"Securing An Azure App Service with Let's Encrypt"</a> by Scott Hanselman for more details.</p>
<h2>Usage</h2>
<p>Install this package into your project using NuGet (<a href="https://nuget.org/packages/LettuceEncrypt" rel="nofollow">see details here</a>).</p>
<p>The primary API usage is to call <code>IServiceCollection.AddLettuceEncrypt</code> in the <code>Startup</code> class <code>ConfigureServices</code> method.</p>
<div><pre><span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>DependencyInjection</span>;

<span>public</span> <span>class</span> <span>Startup</span>
{
    <span>public</span> <span>void</span> <span>ConfigureServices</span>(<span>IServiceCollection</span> <span>services</span>)
    {
        <span>services</span>.<span>AddLettuceEncrypt</span>();
    }
}</pre></div>
<p>A few required options should be set, typically via the appsettings.json file.</p>
<div><pre><span>// appsettings.json</span>
<span>{</span>
    <span>"LettuceEncrypt"</span>: <span>{</span>
        <span>// Set this to automatically accept the terms of service of your certificate authority.</span>
        <span>// If you don't set this in config, you will need to press "y" whenever the application starts</span>
        <span>"AcceptTermsOfService"</span>: <span>true</span><span>,</span>

        <span>// You must at least one domain name</span>
        <span>"DomainNames"</span>: <span>[</span> <span>"example.com"</span><span>,</span> <span>"www.example.com"</span> <span>]</span><span>,</span>

        <span>// You must specify an email address to register with the certificate authority</span>
        <span>"EmailAddress"</span>: <span>"it-admin@example.com"</span>
    <span>}</span>
<span>}</span></pre></div>
<h2>Additional options</h2>
<h3>Kestrel configuration</h3>
<p>If your code is using the <code>.UseKestrel()</code> method to configure IP addresses, ports, or HTTPS settings,
you will also need to call <code>UseLettuceEncrypt</code>. This is required to make Lettuce Encrypt work.</p>
<h4>Example: ConfigureHttpsDefaults</h4>
<p>If calling <code>ConfigureHttpsDefaults</code>, use <code>UseLettuceEncrypt</code> like this:</p>
<div><pre><span>webBuilder</span>.<span>UseKestrel</span>(<span>k</span> <span>=&gt;</span>
{
    <span>var</span> <span>appServices</span> <span>=</span> <span>k</span>.<span>ApplicationServices</span>;
    <span>k</span>.<span>ConfigureHttpsDefaults</span>(<span>h</span> <span>=&gt;</span>
    {
        <span>h</span>.<span>ClientCertificateMode</span> <span>=</span> <span>ClientCertificateMode</span>.<span>RequireCertificate</span>;
        <span>h</span>.<span>UseLettuceEncrypt</span>(<span>appServices</span>);
    });
});</pre></div>
<h4>Example: Listen + UseHttps</h4>
<p>If using <code>Listen</code> + <code>UseHttps</code> to manually configure Kestrel's address binding, use <code>UseLettuceEncrypt</code> like this:</p>
<div><pre><span>webBuilder</span>.<span>UseKestrel</span>(<span>k</span> <span>=&gt;</span>
{
    <span>var</span> <span>appServices</span> <span>=</span> <span>k</span>.<span>ApplicationServices</span>;
    <span>k</span>.<span>Listen</span>(
        <span>IPAddress</span>.<span>Any</span>, <span>443</span>,
        <span>o</span> <span>=&gt;</span> <span>o</span>.<span>UseHttps</span>(<span>h</span> <span>=&gt;</span>
        {
            <span>h</span>.<span>UseLettuceEncrypt</span>(<span>appServices</span>);
        }));
});</pre></div>
<h3>Customizing storage</h3>
<p>Certificates are stored to the machine's X.509 store by default. Certificates can be stored in additional
locations by using extension methods after calling <code>AddLettuceEncrypt()</code> in the <code>Startup</code> class.</p>
<p>Multiple storage locations can be configured.</p>
<h3>Save generated certificates and account information to a directory</h3>
<p>This will save and load certificate files (PFX format) using the specified directory.
It will also save your certificate authority account key into the same directory.</p>
<div><pre><span>using</span> <span>LettuceEncrypt</span>;
<span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>DependencyInjection</span>;

<span>public</span> <span>void</span> <span>ConfigureServices</span>(<span>IServiceCollection</span> <span>services</span>)
{
    <span>services</span>
        .<span>AddLettuceEncrypt</span>()
        .<span>PersistDataToDirectory</span>(<span>new</span> <span>DirectoryInfo</span>(<span><span>"</span>C:/data/LettuceEncrypt/<span>"</span></span>), <span><span>"</span>Password123<span>"</span></span>);
}</pre></div>
<h3>Save generated certificates to Azure Key Vault</h3>
<p>Install <a href="https://nuget.org/packages/LettuceEncrypt.Azure" rel="nofollow">LettuceEncrypt.Azure</a>.
This will save and load certificate files using an Azure Key Vault.
It will also save your certificate authority account key as a secret in the same vault.</p>
<div><pre><span>using</span> <span>LettuceEncrypt</span>;
<span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>DependencyInjection</span>;

<span>public</span> <span>void</span> <span>ConfigureServices</span>(<span>IServiceCollection</span> <span>services</span>)
{
    <span>services</span>
        .<span>AddLettuceEncrypt</span>()
        .<span>PersistCertificatesToAzureKeyVault</span>();
}</pre></div>
<div><pre><span>// appsettings.json</span>
<span>{</span>
    <span>"LettuceEncrypt"</span>: <span>{</span>
        <span>"AzureKeyVault"</span>: <span>{</span>
            <span>// Required - specify the name of your key vault</span>
            <span>"AzureKeyVaultEndpoint"</span>: <span>"https://myaccount.vault.azure.net/"</span>

            <span>// Optional - specify the secret name used to store your account info (used for cert rewewals)</span>
            <span>// If not specified, name defaults to "le-encrypt-${ACME server URL}"</span>
            <span>"AccountKeySecretName"</span>: <span>"my-lets-encrypt-account"</span>
        <span>}</span>
    <span>}</span>
<span>}</span></pre></div>
<h3>Customizing how the certs are saved and loaded</h3>
<p>Create a class that implements <code>ICertificateRepository</code> to customize how to save your certificates.</p>
<p>Create a class that implements <code>ICertificateSource</code> to customize where pre-existing certificates are
found when the server starts.</p>
<div><pre><span>using</span> <span>LettuceEncrypt</span>;
<span>using</span> <span>Microsoft</span>.<span>Extensions</span>.<span>DependencyInjection</span>;

<span>public</span> <span>void</span> <span>ConfigureServices</span>(<span>IServiceCollection</span> <span>services</span>)
{
    <span>services</span>.<span>AddLettuceEncrypt</span>();
    <span>services</span>.<span>AddSingleton</span>&lt;<span>ICertificateRepository</span>, <span>MyCertRepo</span>&gt;();
    <span>services</span>.<span>AddSingleton</span>&lt;<span>ICertificateSource</span>, <span>MyCertSource</span>&gt;();
}

<span>class</span> <span>MyCertRepo</span> : <span>ICertificateRepository</span>
{
    <span>public</span> <span>async</span> <span>Task</span> <span>SaveAsync</span>(<span>X509Certificate2</span> <span>certificate</span>, <span>CancellationToken</span> <span>cancellationToken</span>)
    {
        <span>byte</span>[] <span>certData</span> <span>=</span> <span>certificate</span>.<span>Export</span>(<span>X509ContentType</span>.<span>Pfx</span>, <span><span>"</span>optionallySetPfxPassword<span>"</span></span>);
        <span><span>//</span> save this data somehow</span>
    }
}

<span>class</span> <span>MyCertSource</span> : <span>ICertificateSource</span>
{
    <span>public</span> <span>async</span> <span>Task</span>&lt;<span>IEnumerable</span>&lt;<span>X509Certificate2</span>&gt;&gt; <span>GetCertificatesAsync</span>(<span>CancellationToken</span> <span>cancellationToken</span>);
    {
        <span><span>//</span> find and return certificate objects. Return an empty enumerable if none are found</span>
    }
}</pre></div>
<h3>Customizing saving your account key</h3>
<p>Your interactions with the certificate authority are encrypted with a private
key which is generated automatically on first-use. To ensure you can renew certificates
later using the same account, this account key is saved to disk by default.
You can customize where this account information is shared by adding your own implementation
of <code>IAccountStore</code>.</p>
<div><pre><span>using</span> <span>LettuceEncrypt</span>;
<span>using</span> <span>LettuceEncrypt</span>.<span>Accounts</span>;


<span>public</span> <span>void</span> <span>ConfigureServices</span>(<span>IServiceCollection</span> <span>services</span>)
{
    <span>services</span>.<span>AddLettuceEncrypt</span>();
    <span>services</span>.<span>AddSingleton</span>&lt;<span>IAccountStore</span>, <span>MyAccountStore</span>&gt;();
}


<span>class</span> <span>MyAccountStore</span>: <span>IAccountStore</span>
{
    <span>public</span> <span>Task</span> <span>SaveAccountAsync</span>(<span>AccountModel</span> <span>account</span>, <span>CancellationToken</span> <span>cancellationToken</span>)
    {
        <span><span>//</span> save the account object somewhere</span>
    }

    <span><span>//</span> add #nullable enable if using c#, or remove the question mark for older versions of C#</span>
    <span>public</span> <span>Task</span>&lt;<span>AccountModel</span>?&gt; <span>GetAccountAsync</span>(<span>CancellationToken</span> <span>cancellationToken</span>)
    {
        <span><span>//</span> return null if there is no account and one will be created for you</span>
    }
}</pre></div>
<h2>Testing in development</h2>
<p>See the <a href="https://github.com/natemcmaster/LettuceEncrypt/blob/master/test/Integration">developer docs</a> for details on how to test in a non-production environment.</p>
<h2>Web Server Scenarios</h2>
<p>I recommend also reading <a href="https://docs.microsoft.com/aspnet/core/host-and-deploy/" rel="nofollow">Microsoft's official documentation on hosting and deploying ASP.NET Core</a>.</p>
<h3>ASP.NET Core with Kestrel</h3>
<p><g-emoji alias="white_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png">‚úÖ</g-emoji> supported</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/41083ca6e848a39a6a5bb2ad9ddd1bc691d4df1e/68747470733a2f2f692e696d6775722e636f6d2f766851546755652e706e67"><img src="https://camo.githubusercontent.com/41083ca6e848a39a6a5bb2ad9ddd1bc691d4df1e/68747470733a2f2f692e696d6775722e636f6d2f766851546755652e706e67" alt="Diagram of Kestrel on the edge with Kestrel" data-canonical-src="https://i.imgur.com/vhQTgUe.png"></a></p>
<p>In this scenario, ASP.NET Core is hosted by the Kestrel server (the default, in-process HTTP server) and that web server exposes its ports directly to the internet. This library will configure Kestrel with an auto-generated certificate.</p>
<h3>ASP.NET Core with IIS</h3>
<p><g-emoji alias="x" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png">‚ùå</g-emoji> NOT supported</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/6f8a88297d043c94ee310fd8f40a2505d747ff2f/68747470733a2f2f692e696d6775722e636f6d2f506d72634c6b4e2e706e67"><img src="https://camo.githubusercontent.com/6f8a88297d043c94ee310fd8f40a2505d747ff2f/68747470733a2f2f692e696d6775722e636f6d2f506d72634c6b4e2e706e67" alt="Diagram of Kestrel on the edge with IIS" data-canonical-src="https://i.imgur.com/PmrcLkN.png"></a></p>
<p>In this scenario, ASP.NET Core is hosted by IIS and that web server exposes its ports directly to the internet. IIS does not support dynamically configuring HTTPS certificates, so this library cannot support this scenario, but you can still configure cert automation using a different tool. See <a href="https://weblog.west-wind.com/posts/2016/feb/22/using-lets-encrypt-with-iis-on-windows" rel="nofollow">"Using Let's Encrypt with IIS On Windows"</a> for details.</p>
<p>Azure App Service uses this for ASP.NET Core 2.2 and newer, which is why this library cannot support that scenario.. Older versions of ASP.NET Core on Azure App Service run with IIS as the reverse proxy (see below), which is also an unsupported scenario.</p>
<h3>ASP.NET Core with Kestrel Behind a TCP Load Balancer (aka SSL pass-thru)</h3>
<p><g-emoji alias="white_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png">‚úÖ</g-emoji> supported</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/1e0df5f455a2897f52235811d4348feb2073e5f3/68747470733a2f2f692e696d6775722e636f6d2f7478714c5476352e706e67"><img src="https://camo.githubusercontent.com/1e0df5f455a2897f52235811d4348feb2073e5f3/68747470733a2f2f692e696d6775722e636f6d2f7478714c5476352e706e67" alt="Diagram of TCP Load Balancer" data-canonical-src="https://i.imgur.com/txqLTv5.png"></a></p>
<p>In this scenario, ASP.NET Core is hosted by the Kestrel server (the default, in-process HTTP server) and that web server exposes its ports directly to a local network. A TCP load balancer such as nginx forwards traffic without decrypting it to the host running Kestrel. This library will configure Kestrel with an auto-generated certificate.</p>
<h3>ASP.NET Core with Kestrel Behind a Reverse Proxy</h3>
<p><g-emoji alias="x" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png">‚ùå</g-emoji> NOT supported</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/c88972f2e53bf05eed7de73e589a124ca292b609/68747470733a2f2f692e696d6775722e636f6d2f4c41346a6d73372e706e67"><img src="https://camo.githubusercontent.com/c88972f2e53bf05eed7de73e589a124ca292b609/68747470733a2f2f692e696d6775722e636f6d2f4c41346a6d73372e706e67" alt="Diagram of reverse proxy" data-canonical-src="https://i.imgur.com/LA4jms7.png"></a></p>
<p>In this scenario, HTTPS traffic is decrypted by a different web server that is beyond the control of ASP.NET Core. This library cannot support this scenario because HTTPS certificates must be configured by the reverse proxy server.</p>
<p>This is commonly done by web hosting providers. For example, <g-emoji alias="cloud" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2601.png">‚òÅÔ∏è</g-emoji> Azure App Services (aka WebApps) often runs older versions of ASP.NET Core in a reverse proxy.</p>
<p>If you are running the reverse proxy, you can still get free HTTPS certificates, but you'll need to use a different method. <a href="https://www.google.com/search?q=let%27s%20encrypt%20nginx" rel="nofollow">Try Googling this</a>.</p>
</article>
      </div>
  </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>