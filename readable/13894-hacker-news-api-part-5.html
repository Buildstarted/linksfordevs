<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Hacker News API Part 5 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Hacker News API Part 5</h1><div><div class="post-content" itemprop="articleBody"><p>Updated June 29th 2019 to work with latest ZIO version (1.0.0-RC8-12)</p><p>This post has accompanying source code on Github:</p><p>Hacker News is a news aggregation site which provides a simple API over http, for which the documentation can be found <a href="https://github.com/HackerNews/API">here</a>. Over several blog posts I have been writing programs that interact with the API as a way of exploring new techniques in Scala pure functional programming.</p><p>This post is the fifth in a series. Here’s what came before:</p><ol><li>Using Future[Either, E] with a http library and uPickle <a href="/2017/07/26/hacker-news-api-1.html">Hacker News API part 1</a></li><li>Using the Fetch library from 47 degrees <a href="/2017/07/30/hacker-news-api-2.html">Hacker News API part 2</a></li><li>Added a web front end using U-Dash, converted to ScalaJS and visualization of the Fetch operations with RefTree <a href="/2017/10/11/hacker-news-api-3.html">Hacker News API part 3</a></li><li>Get rid of Future and structure the program better using Monix’s effect type, Task. <a href="/2018/05/05/hacker-news-api-4.html">Hacker News API part 4</a></li></ol><p>A few months ago I attempted to update the code using two other techniques. The first was tagless final style (see <a href="https://softwaremill.com/free-tagless-compared-how-not-to-commit-to-monad-too-early/">https://softwaremill.com/free-tagless-compared-how-not-to-commit-to-monad-too-early/</a>) and the second was using a monad transformer library approach <a href="https://typelevel.org/cats-mtl/">https://typelevel.org/cats-mtl/</a></p><p>What these techniques have in common is they allow us to defer the specific Monad type used in our code until later, allowing more flexibility and the ability to, for example, replace an asynchronous Task effect with a simpler Monad such as Id. This would enable us to write test suites that run faster. In addition it allows to swap out implementations of things like logging. Something like dependency injection at the higher kinded type level.</p><p>While I was able to get my Hacker News API working with both these techniques, I never really got the code to a state where I wanted to share it with the world, or would be prepared to push it onto a team as an example of good style, so having seen this John de Goes talk <a href="https://skillsmatter.com/skillscasts/13247-scala-matters">The Death Of Final Tagless </a> and his follow up <a href="http://degoes.net/articles/zio-environment">Beautiful, Simple, Testable Functional Effects for Scala</a>, I decided it was time to start investigating ZIO.</p><p>Like Monix, ZIO is a library that provides a full suite of tools for writing asynchronous and concurrent programs. You can see the full documentation here: <a href="https://scalaz.github.io/scalaz-zio/">Zio documentation</a></p><p>The example code consists of three example programs. The first is based on my previous posts and simply retrieves and displays the current stories a page at a time.</p><h2 id="showing-front-page-stories">Showing front page stories</h2><p><a href="https://github.com/justinhj/ziohnapi/blob/blog-2019-04-07-b/src/main/scala/examples/ShowStories.scala">ShowStories.scala</a> is one of the examples include that simply gets the top stories (a list of story IDs ranked by their position on the Hacker News page) and then displays them in the console…</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span><span class="nv">runtime</span><span class="k">=</span><span class="k">new</span><span class="nc">LiveRuntime</span><span class="o">{}</span><span class="k">val</span><span class="nv">program</span><span class="k">=</span><span class="o">(</span><span class="nf">for</span><span class="o">(</span><span class="n">s</span><span class="k">&lt;-</span><span class="nv">httpclient</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">getTopItemsURL</span><span class="o">);</span><span class="n">items</span><span class="k">&lt;-</span><span class="nf">parseTopItemsResponse</span><span class="o">(</span><span class="n">s</span><span class="o">);</span><span class="k">_</span><span class="k">&lt;-</span><span class="nf">showPagesLoop</span><span class="o">(</span><span class="n">items</span><span class="o">)</span><span class="o">)</span><span class="nf">yield</span><span class="o">()).</span><span class="py">foldM</span><span class="o">(</span><span class="n">err</span><span class="k">=&gt;</span><span class="nf">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="s">"Program threw exception. ${err.getMessage}"</span><span class="o">),</span><span class="n">succ</span><span class="k">=&gt;</span><span class="nv">ZIO</span><span class="o">.</span><span class="py">succeed</span><span class="o">(())</span><span class="o">)</span><span class="nv">runtime</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">(</span><span class="n">program</span><span class="o">)</span></code></pre></div></div><p>The showPagesLoop asks the user for a page number and continues looping until the user enters something that is not a number:</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span><span class="nf">showPagesLoop</span><span class="o">(</span><span class="n">topItems</span><span class="k">:</span><span class="kt">HNItemIDList</span><span class="o">)</span><span class="k">:</span><span class="kt">ZIO</span><span class="o">[</span><span class="kt">Env</span>, <span class="kt">Throwable</span>, <span class="kt">Unit</span><span class="o">]</span><span class="k">=</span><span class="o">{</span><span class="k">val</span><span class="nv">itemsPerPage</span><span class="k">=</span><span class="mi">5</span><span class="nv">getUserPage</span><span class="o">.</span><span class="py">flatMap</span><span class="o">{</span><span class="k">case</span><span class="nc">Some</span><span class="o">(</span><span class="n">pageNumber</span><span class="o">)</span><span class="k">=&gt;</span><span class="nf">for</span><span class="o">(</span><span class="k">_</span><span class="k">&lt;-</span><span class="nf">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="s">"Page $pageNumber"</span><span class="o">);</span><span class="n">items</span><span class="k">&lt;-</span><span class="nf">fetchPage</span><span class="o">(</span><span class="n">pageNumber</span><span class="o">,</span><span class="n">itemsPerPage</span><span class="o">,</span><span class="n">topItems</span><span class="o">);</span><span class="k">_</span><span class="k">&lt;-</span><span class="nf">printPageItems</span><span class="o">(</span><span class="n">pageNumber</span><span class="o">,</span><span class="n">itemsPerPage</span><span class="o">,</span><span class="n">items</span><span class="o">);</span><span class="k">_</span><span class="k">&lt;-</span><span class="nf">showPagesLoop</span><span class="o">(</span><span class="n">topItems</span><span class="o">)</span><span class="o">)</span><span class="nf">yield</span><span class="o">()</span><span class="k">case</span><span class="nc">None</span><span class="k">=&gt;</span><span class="nf">putStrLn</span><span class="o">(</span><span class="s">"Have a nice day!"</span><span class="o">)</span><span class="o">}</span><span class="o">}</span></code></pre></div></div><h2 id="modules-and-the-environment">Modules and the environment</h2><p>The programs are built from modules that make up the R part of ZIO[R,E,A]. I’m using the built in ones Blocking and Console, along with my own HttpClient that takes of retrieving data from a url as a string.</p><p>An Environment for the runtime is an aggregation of the modules that make up your whole program:</p><p><code class="language-plaintext highlighter-rouge">type Environment = Clock with Console with System with Random with Blocking with HttpClient</code></p><p>Blocking is module that allows blocking operations to use a special threadpool, so that blocking calls don’t deplete threads from your main thread pool. Effects can be made to run on the blocking pool just by wrapping them as follows:</p><p><a href="https://github.com/justinhj/ziohnapi/blob/blog-2019-04-07-b/src/main/scala/org/justinhj/httpclient/HttpClient.scala">HttpClient.scala</a></p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">blocking</span><span class="o">(</span><span class="nv">ZIO</span><span class="o">.</span><span class="py">effect</span><span class="o">(</span><span class="nf">requestSync</span><span class="o">(</span><span class="n">url</span><span class="o">)))</span></code></pre></div></div><h2 id="testing">Testing</h2><p>The nice thing about HttpClient being a module is that I can test my code without a web connection, or without hitting the real Hacker News by swapping the real implementation with a test one. You can see that in action in the test suite:</p><p><a href="https://github.com/justinhj/ziohnapi/blob/blog-2019-04-07-b/src/test/scala/org/justinhj/HNApiTest.scala">HNApiTest.scala</a> - sample test suite</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The test http runtime
</span><span class="k">trait</span><span class="nc">HttpClientTest</span><span class="k">extends</span><span class="nc">HttpClient</span><span class="o">{</span><span class="k">val</span><span class="nv">sampleTopStories</span><span class="k">=</span><span class="nc">Test</span><span class="n">data</span><span class="n">omitted</span><span class="k">val</span><span class="nv">sampleItem</span><span class="k">=</span><span class="nc">Test</span><span class="n">data</span><span class="n">omitted</span><span class="k">val</span><span class="nv">httpClient</span><span class="k">:</span><span class="kt">Service</span><span class="o">[</span><span class="kt">Any</span><span class="kt">with</span><span class="kt">HttpClient</span><span class="kt">with</span><span class="kt">Blocking</span><span class="o">]</span><span class="k">=</span><span class="k">new</span><span class="nc">Service</span><span class="o">[</span><span class="kt">Any</span><span class="kt">with</span><span class="kt">HttpClient</span><span class="kt">with</span><span class="kt">Blocking</span><span class="o">]</span><span class="o">{</span><span class="k">def</span><span class="nf">requestSync</span><span class="o">(</span><span class="n">url</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">String</span><span class="o">=</span><span class="o">{</span><span class="nf">if</span><span class="o">(</span><span class="n">url</span><span class="o">==</span><span class="nv">HNApi</span><span class="o">.</span><span class="py">getTopItemsURL</span><span class="o">)</span><span class="n">sampleTopStories</span><span class="k">else</span><span class="nf">if</span><span class="o">(</span><span class="n">url</span><span class="o">==</span><span class="nv">HNApi</span><span class="o">.</span><span class="py">getItemURL</span><span class="o">(</span><span class="mi">11498534</span><span class="o">))</span><span class="n">sampleItem</span><span class="k">else</span><span class="k">throw</span><span class="k">new</span><span class="nc">Exception</span><span class="o">(</span><span class="n">s</span><span class="s">"$url not found in http mock client"</span><span class="o">)</span><span class="o">}</span><span class="k">final</span><span class="k">def</span><span class="nf">get</span><span class="o">(</span><span class="n">url</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span><span class="kt">Task</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span><span class="k">=</span><span class="o">{</span><span class="nv">ZIO</span><span class="o">.</span><span class="py">effect</span><span class="o">(</span><span class="nf">requestSync</span><span class="o">(</span><span class="n">url</span><span class="o">))</span><span class="o">}</span><span class="o">}</span><span class="o">}</span></code></pre></div></div><p>This concept of swapping out modules can be useful for testing different databases, different JSON parsers and so on.</p><h2 id="fibers">Fibers</h2><p>ZIO allows a large number of concurrent operations by using an implementation of green threads called Fibers. The API is straightforward. For example in this function that retrieves an item and them recursively retrieves its ‘kids’ (for example kids of a comment are nested comments, kids of a news story are the top level comments on that story) and we use the function <code class="language-plaintext highlighter-rouge">foreachParN(8)</code> to split the jobs across up to 8 individual fibers. This gives you control over the amount of active fibers in each part of your application.</p><p><a href="https://github.com/justinhj/ziohnapi/blob/2a7e5d634813afd43f6c9e306807c69186138c28/src/main/scala/org/justinhj/hnapi/HNApi.scala#L126">HNApi.scala</a></p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span><span class="nf">getItemAndKidsList</span><span class="o">(</span><span class="n">parentId</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span><span class="k">:</span><span class="kt">ZIO</span><span class="o">[</span><span class="kt">Env</span>, <span class="kt">Throwable</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">HNItem</span><span class="o">]]</span><span class="k">=</span><span class="nf">for</span><span class="o">(</span><span class="n">itemResponse</span><span class="k">&lt;-</span><span class="nv">httpclient</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="nf">getItemURL</span><span class="o">(</span><span class="n">parentId</span><span class="o">));</span><span class="n">item</span><span class="k">&lt;-</span><span class="nf">parseItemResponse</span><span class="o">(</span><span class="n">itemResponse</span><span class="o">);</span><span class="n">kids</span><span class="k">&lt;-</span><span class="nv">ZIO</span><span class="o">.</span><span class="py">foreachParN</span><span class="o">(</span><span class="mi">8</span><span class="o">)(</span><span class="nv">item</span><span class="o">.</span><span class="py">kids</span><span class="o">){</span><span class="n">id</span><span class="k">=&gt;</span><span class="nf">getItemAndKidsList</span><span class="o">(</span><span class="n">id</span><span class="o">)}</span><span class="o">)</span><span class="k">yield</span><span class="nv">kids</span><span class="o">.</span><span class="py">flatten</span><span class="o">:+</span><span class="n">item</span></code></pre></div></div><p>This function is used in the code below to show all the comments for a given news story (by its ID):</p><p><a href="https://github.com/justinhj/ziohnapi/blob/blog-2019-04-07-b/src/main/scala/examples/ShowStoryComments.scala">ShowStoryComments.scala</a></p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span><span class="nv">program</span><span class="k">=</span><span class="o">(</span><span class="nf">for</span><span class="o">(</span><span class="n">itemId</span><span class="k">&lt;-</span><span class="n">getItemId</span><span class="o">;</span><span class="n">itemsAndKids</span><span class="k">&lt;-</span><span class="nf">getItemAndKids</span><span class="o">(</span><span class="n">itemId</span><span class="o">);</span><span class="k">_</span><span class="k">&lt;-</span><span class="nf">showComments</span><span class="o">(</span><span class="n">itemId</span><span class="o">,</span><span class="n">itemsAndKids</span><span class="o">)</span><span class="o">)</span><span class="nf">yield</span><span class="o">()).</span><span class="py">foldM</span><span class="o">(</span><span class="n">err</span><span class="k">=&gt;</span><span class="nf">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="s">"Program threw exception. $err"</span><span class="o">),</span><span class="n">succ</span><span class="k">=&gt;</span><span class="nv">ZIO</span><span class="o">.</span><span class="py">succeed</span><span class="o">(())</span><span class="o">)</span></code></pre></div></div><h2 id="scheduling">Scheduling</h2><p>Another feature of ZIO is the scheduler data type. Again, the API is composed of simple operations that you can compose together to make more complex overall behaviours. In this simple example we grab the latest story or comment submitted to Hacker News every 10 seconds until the user quits.</p><p><a href="https://github.com/justinhj/ziohnapi/blob/blog-2019-04-07-b/src/main/scala/examples/LastItem.scala">LastItem.scala</a></p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span><span class="nv">showLastItem</span><span class="k">=</span><span class="nf">for</span><span class="o">(</span><span class="n">maxItemResponse</span><span class="k">&lt;-</span><span class="nv">httpclient</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">getMaxItemURL</span><span class="o">);</span><span class="n">maxItem</span><span class="k">&lt;-</span><span class="nf">parseMaxItemResponse</span><span class="o">(</span><span class="n">maxItemResponse</span><span class="o">);</span><span class="n">itemResponse</span><span class="k">&lt;-</span><span class="nv">httpclient</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="nf">getItemURL</span><span class="o">(</span><span class="n">maxItem</span><span class="o">));</span><span class="n">item</span><span class="k">&lt;-</span><span class="nf">parseItemResponse</span><span class="o">(</span><span class="n">itemResponse</span><span class="o">);</span><span class="k">_</span><span class="k">&lt;-</span><span class="nf">showComment</span><span class="o">(</span><span class="n">item</span><span class="o">)</span><span class="o">)</span><span class="nf">yield</span><span class="o">()</span><span class="k">val</span><span class="nv">program</span><span class="k">=</span><span class="nv">showLastItem</span><span class="o">.</span><span class="py">repeat</span><span class="o">(</span><span class="nv">Schedule</span><span class="o">.</span><span class="py">spaced</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">))</span><span class="nv">runtime</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">(</span><span class="n">program</span><span class="o">)</span></code></pre></div></div><h2 id="final-words">Final words</h2><p>ZIO is easy to use and very powerful, a great combination. Even though the applications are built using solid pure fp concepts such as the Reader and State monads, these are beneath the surface of the API, and the user can concentrate on building the application.</p><p>I am just getting started with ZIO and any feedback on my example program and post, good or bad, is welcome. You can contact me via Twitter or Email at the top of the page, or open a Github issue.</p><p>Thanks for getting to the end!</p><h2 id="post-script">Post script</h2><p>Thanks for all the great feedback on this article! I have now changed all occurences of the word Fibre with Fiber. I accidentally used the British spelling of the word which is inconsistent with the spelling in Zio itself.</p><p>Copyright (C) 2019 Justin-Heyes-Jones - All Rights Reserved</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>