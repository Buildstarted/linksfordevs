<!DOCTYPE html>
<html lang="en">
<head>
    <title>
New in ASP.NET Core 3 -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>New in ASP.NET Core 3</h1>
    <div class="post-content">
<p>In this post I describe the new &quot;validate on build&quot; feature that has been added to ASP.NET Core 3.0. This can be used to detect when your DI service provider is misconfigured. Specifically, the feature detects where you have a dependency on a service that you haven&apos;t registered in the DI container. </p>
<p>I&apos;ll start by showing how the feature works, and then show some situations where you can have a <em>misconfigured</em> DI container that the feature <em>won&apos;t</em> identify as faulty.</p>
<blockquote>
<p>It&apos;s worth pointing out that validating your DI configuration is not a new idea - this was a feature of StructureMap I used regularly, and <a href="https://jasperfx.github.io/lamar/documentation/ioc/diagnostics/validating-container-configuration/">it&apos;s spiritual successor, Lamar, has a similar feature.</a></p>
</blockquote> <p>For this post, I&apos;m going to use an app based on the default <code>dotnet new webapi</code> template. This consists of a single controller, the <code>WeatherForecastService</code>, that returns a randomly generated forecast based on some static data.</p>
<p>To exercise the DI container a little, I&apos;m going to extract a couple of services. First, the controller is refactored to: </p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">&quot;[controller]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> <span class="token class-name">ControllerBase</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">WeatherForecastService</span> _service<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span><span class="token class-name">WeatherForecastService</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span> _service <span class="token operator">=</span> service<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">]</span> <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _service<span class="token punctuation">.</span><span class="token function">GetForecasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>So the controller depends on the <code>WeatherForecastService</code>. This is shown below (I&apos;ve elided the actual implementation as it&apos;s not important for this post):</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastService</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">DataService</span> _dataService<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">WeatherForecastService</span><span class="token punctuation">(</span><span class="token class-name">DataService</span> dataService<span class="token punctuation">)</span> <span class="token punctuation">{</span> _dataService <span class="token operator">=</span> dataService<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span> <span class="token function">GetForecasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> data <span class="token operator">=</span> _dataService<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">WeatherForecast</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This service depends on another, the <code>DataService</code>, shown below:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataService</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;Freezing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bracing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Chilly&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cool&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mild&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Warm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Balmy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Hot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sweltering&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Scorching&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>That&apos;s all of the services we need, so all that remains is to register them in the DI container in <code>Startup.ConfigureServices</code>:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">WeatherForecastService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">DataService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I&apos;ve registered them as singletons for this example, but that&apos;s not important for this feature. With everything set up correctly, sending a request to <code>/WeatherForecast</code> returns a forecast:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-09-07T22:29:31.5545422+00:00&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;temperatureC&quot;</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token property">&quot;temperatureF&quot;</span><span class="token operator">:</span><span class="token number">87</span><span class="token punctuation">,</span> <span class="token property">&quot;summary&quot;</span><span class="token operator">:</span><span class="token string">&quot;Sweltering&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre>
<p>Everything looks good here, so let&apos;s see what happens if we mess up the DI registration.</p> <p>Let&apos;s mess things up a bit, and &quot;forget&quot; to register the <code>DataService</code> dependency in the DI container: </p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">WeatherForecastService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>If we run the app again with <code>dotnet run</code>, we get an exception, a giant stack trace, and the app fails to start. I&apos;ve truncated and formatted the result below:</p>
<pre class="language-bash"><code class="language-bash">Unhandled exception. System.AggregateException: Some services are not able to be constructed
<span class="token punctuation">(</span>Error <span class="token keyword">while</span> validating the <span class="token function">service</span> descriptor <span class="token string">&apos;ServiceType: TestApp.WeatherForecastService Lifetime: Scoped ImplementationType: TestApp.WeatherForecastService&apos;</span><span class="token keyword">:</span> Unable to resolve <span class="token function">service</span> <span class="token keyword">for</span> <span class="token function">type</span> <span class="token string">&apos;TestApp.DataService&apos;</span> <span class="token keyword">while</span> attempting to activate <span class="token string">&apos;TestApp.WeatherForecastService&apos;</span>.<span class="token punctuation">)</span>     
</code></pre>
<p>This error makes it clear what the problem is - &quot;Unable to resolve service for type &apos;TestApp.DataService&apos; while attempting to activate &apos;TestApp.WeatherForecastService&apos;&quot;. This is the DI validation feature doing it&apos;s job! It should help reduce the number of DI errors you discover during normal operation of your app, by throwing as soon as possible on app startup. It&apos;s not as useful as an error at compile-time, but that&apos;s the price of the flexibility a DI container provides.</p>
<p>What if we forget to register the <code>WeatherForecastService</code> instead:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">DataService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In this case the app starts up fine, and we don&apos;t get any error until we hit the API, at which point it blows up! </p>
<p>Oh dear, time for the gotchas&#x2026;</p> <p>The reason the validation feature doesn&apos;t catch this problem is that controllers aren&apos;t created using the DI container. As I described <a href="/controller-activation-and-dependency-injection-in-asp-net-core-mvc/">in a previous post</a>, the <code>DefaultControllerActivator</code> sources a controller&apos;s <em>dependencies</em> from the DI container, but not the controller itself. Consequently, the DI container doesn&apos;t know anything about the controllers, and so can&apos;t check their dependencies are registered.</p>
<p>Luckily, there&apos;s a way around this. You can change the controller activator so that controllers <em>are</em> added to the DI container by using the <code>AddControllersAsServices()</code> method on <code>IMvcBuilder</code>:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">AddControllersAsServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">DataService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This enables the <code>ServiceBasedControllerActivator</code> (<a href="/controller-activation-and-dependency-injection-in-asp-net-core-mvc/#the-servicebasedcontrolleractivator">see my previous post for a detailed explanation</a>) and registers the controllers in the DI container as services. If we run the app now, the validation detects the missing controller dependency on app startup, and throws an exception:</p>
<pre class="language-bash"><code class="language-bash">Unhandled exception. System.AggregateException: Some services are not able to be constructed
<span class="token punctuation">(</span>Error <span class="token keyword">while</span> validating the <span class="token function">service</span> descriptor <span class="token string">&apos;ServiceType: TestApp.Controllers.WeatherForecastController Lifetime: Transient ImplementationType: TestApp.Controllers.WeatherForecastController&apos;</span><span class="token keyword">:</span> Unable to resolve <span class="token function">service</span> <span class="token keyword">for</span> <span class="token function">type</span> <span class="token string">&apos;TestApp.WeatherForecastService&apos;</span> <span class="token keyword">while</span> attempting to activate<span class="token string">&apos;TestApp.Controllers.WeatherForecastController&apos;</span>.<span class="token punctuation">)</span>
</code></pre>
<p>This seems like a handy solution, but I&apos;m not <em>entirely</em> sure what the trade offs are, but it <em>should</em> be fine (it&apos;s a supported scenario after all).</p>
<p>We&apos;re not out of the woods yet though, as constructor injection isn&apos;t the only way to inject dependencies into controllers&#x2026;</p> <p><a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/models/model-binding?view=aspnetcore-2.2">Model binding is used in MVC actions</a> to control how an action method&apos;s parameters are created, based on the incoming request, using attributes such as <code>[FromBody]</code> and <code>[FromQuery]</code>. </p>
<p>In a similar vein, the <code>[FromServices]</code> attribute can be applied to action method parameters, and those parameters will be created by sourcing them from the DI container. This can be useful if you have a dependency which is only required by a single action method. Instead of injecting the service into the constructor (and therefore creating it for <em>every</em> action on that controller) you can inject it into the specific action instead.</p>
<p>For example, we could rewrite the <code>WeatherForecastController</code> to use <code>[FromServices]</code> injection as follows:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">&quot;[controller]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> <span class="token class-name">ControllerBase</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">]</span> <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span> <span class="token function">Get</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token class-name">FromServices</span><span class="token punctuation">]</span> <span class="token class-name">WeatherForecastService</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> service<span class="token punctuation">.</span><span class="token function">GetForecasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<p>There&apos;s obviously no reason to do that here, but it makes the point. Unfortunately, the DI validation won&apos;t be able to detect this use of an unregistered service. The app will start just fun, but will throw an Exception when you attempt to call the action. </p>
<p>The obvious solution to this one is to avoid the <code>[FromServices]</code> attribute where possible, which shouldn&apos;t be difficult to achieve, as you can always inject into the constructor if needs be.</p>
<p>There&apos;s one more way to source services from the DI container - using service location.</p> <p>Let&apos;s rewrite the <code>WeatherForecastController</code> one more time. Instead of directly injecting the <code>WeatherForecastService</code>, we&apos;ll inject an <code>IServiceProvider</code>, and use the <a href="https://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/">service location anti-pattern</a> to retrieve the dependency.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">&quot;[controller]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> <span class="token class-name">ControllerBase</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">WeatherForecastService</span> _service<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> provider<span class="token punctuation">)</span> <span class="token punctuation">{</span> _service <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">WeatherForecastService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">]</span> <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _service<span class="token punctuation">.</span><span class="token function">GetForecasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Code like this, where you&apos;re injecting the <code>IServiceProvider</code>, is generally a bad idea. Instead of being <em>explicit</em> about it&apos;s dependencies, this controller has an <em>implicit</em> dependency on <code>WeatherForecastController</code>. As well as being harder for developers to reason about, it also means the DI validator doesn&apos;t know about the dependency. Consequently, this app will start up fine, and throw on first use.</p>
<p>Unfortunately, you can&apos;t <em>always</em> avoid leveraging <code>IServiceProvider</code>. One case is where you have a singleton object that needs scoped dependencies <a href="/the-dangers-and-gotchas-of-using-scoped-services-when-configuring-options-in-asp-net-core/#3-creating-a-new-scope-in-iconfigureoptions">as I described here</a>. Another is where you have a singleton object that can&apos;t have constructor dependencies, like validation attributes (<a href="/injecting-services-into-validationattributes-in-asp-net-core/">as I described here</a>). Unfortunately there&apos;s no way around those situations, and you just have to be aware that the guard rails are off.</p>
<p>A similar gotcha that&apos;s not immediately obvious is when you&apos;re using a factory function to create your dependencies.</p> <p>Let&apos;s go back to our original controller, injecting <code>WeatherForecastService</code> into the constructor, and registering the controllers with the DI container using <code>AddControllersAsServices()</code>. But we&apos;ll make two changes:</p>
<ol>
<li>Forget to register the <code>DataService</code>.</li>
<li>Use a factory function to create <code>WeatherForecastService</code>.</li>
</ol>
<p>When I say a factory function, I mean a lambda that&apos;s provided at service registration time, that describes how to create the service. For example:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">AddControllersAsServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">WeatherForecastService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>provider <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> dataService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeatherForecastService</span><span class="token punctuation">(</span>dataService<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>In the above example, we provided a lambda for the <code>WeatherForecastService</code> that describes how to create the service. Inside the lambda we manually construct the <code>DataService</code> and <code>WeatherForecastService</code>. </p>
<p>This won&apos;t cause any problems in our app, as we are able to resolve the <code>WeatherForecastService</code> from the DI container using the above factory method. We never have to resolve the <code>DataService</code> directly from the DI container. We only need it in the <code>WeatherForecastService</code>, and we&apos;re manually constructing it, so there&apos;s no problems.</p>
<p>The difficulties arise if we use the injected <code>IServiceProvider provider</code> in the factory function:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">AddControllersAsServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">WeatherForecastService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>provider <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> dataService <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">DataService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeatherForecastService</span><span class="token punctuation">(</span>dataService<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>As far as the DI validation is concerned, this factory function is exactly the same as the previous one, but actually there&apos;s a problem. We&apos;re using the <code>IServiceProvider</code> to resolve the <code>DataService</code> at runtime using the service locator pattern; so we have an implicit dependency. This is essentially the same as gotcha 3 &#x2014; the service provider validator can&apos;t detect cases where services are obtained directly from the service provider. </p>
<p>As with the previous gotcha, code like this is sometimes necessary, and there&apos;s no easy way to work around it. If that&apos;s the case, just be extra careful that the dependencies you request are definitely registered correctly.</p>
<blockquote>
<p>An idea I toyed with is registering a &quot;dummy&quot; class in dev only, that takes all of these &quot;hidden&quot; classes as constructor dependencies. That may help catch registration issues using the service provider validator, but is probably more effort and error prone than it&apos;s worth.</p>
</blockquote> <p>The final gotcha is <a href="https://github.com/aspnet/Extensions/blob/fb7fdf5550614f6d73c87f46cbcd0d2409a46095/src/DependencyInjection/DI/src/ServiceProviderOptions.cs#L23">called out in the ASP.NET Core source code itself</a>: <code>ValidateOnBuild</code> does not validate open generic types.</p>
<p>As an example, imagine we have a generic <code>ForcastService&lt;T&gt;</code>, that can generate multiple <em>types</em> of forecast, <code>T</code>.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForecastService</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword">where</span> T<span class="token punctuation">:</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">DataService</span> _dataService<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">ForecastService</span><span class="token punctuation">(</span><span class="token class-name">DataService</span> dataService<span class="token punctuation">)</span> <span class="token punctuation">{</span> _dataService <span class="token operator">=</span> dataService<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">GetForecasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> data <span class="token operator">=</span> _dataService<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In <em>Startup.cs</em> we register the open generic, but again forget to register the <code>DataService</code>: </p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">AddControllersAsServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token function">Addingleton</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ForecastService<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>The service provider validation completely skips over the open generic registration, so it never detects the missing <code>DataService</code> dependency. The app starts up without errors, and will throw a runtime exception if you try to request a <code>ForecastService&lt;T&gt;</code>.</p>
<p>However, if you take a <em>closed</em> version of this dependency in your app anywhere (which is probably quite likely), the validation <em>will</em> detect the problem. For example, we can update the <code>WeatherForecastController</code> to use the generic service, by closing the generic with <code>T</code> as <code>WeatherForecast</code>:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">&quot;[controller]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> <span class="token class-name">ControllerBase</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> ForecastService<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span> _service<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span>ForecastService<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span> _service <span class="token operator">=</span> service<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">]</span> <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _service<span class="token punctuation">.</span><span class="token function">GetForecasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The service provider validation <em>does</em> detect this! So in reality, the lack of open generic testing is probably not going to be as big a deal as the service locator and factory function gotchas. You always need to close a generic to inject it into a service (unless that service <em>itself</em> is an open generic), so hopefully you should pick up many cases. The exception to this is if you&apos;re sourcing open generics using the service locator <code>IServiceProvider</code>, but then you&apos;re really back to gotchas 3 and 4 anyway!</p> <p>That&apos;s the last of the gotchas I&apos;m aware of, but as a final note, it&apos;s worth remembering that service provider validation is only enabled in the Development environment by default. That&apos;s because there&apos;s a startup cost to it, the same as for <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-2.2#scope-validation">scope validation</a>. </p>
<p>However, if you have any sort of &quot;conditional service registration&quot;, where a different service is registered in Development than in other environments, you <em>may</em> want to enable validation in other environments too. You can do this by adding an additional <code>UseDefaultServiceProvider</code> call to your default host builder, in <em>Program.cs</em>. In the example below I&apos;ve enabled <code>ValidateOnBuild</code> in all environments, but kept scope validation in Development only:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IHostBuilder</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> webBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token punctuation">&lt;</span><span class="token class-name">Startup</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">UseDefaultServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> options<span class="token punctuation">.</span>ValidateScopes <span class="token operator">=</span> context<span class="token punctuation">.</span>HostingEnvironment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> options<span class="token punctuation">.</span>ValidateOnBuild <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p>In this post I described the <code>ValidateOnBuild</code> feature which is new in .NET Core 3.0. This allows the <em>Microsoft.Extensions</em> DI container to check for errors in your service configuration when a service provider is first built. This can be used to detect issues on application startup, instead of at runtime when the misconfigured service is requested.</p>
<p>While useful, there are a number of cases that the validation won&apos;t catch, such as injection into MVC controllers, using the <code>IServiceProvider</code> service locator, and open generics. You can work around some of these, but even if you can&apos;t, it&apos;s worth keeping them in mind, and not relying on your app to catch 100% of your DI problems!</p>
</div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>