<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Authentication and the Have I Been Pwned API -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Authentication and the Have I Been Pwned API</h1>
    <section class="article_text post"> <p>The very first feature I added to Have I Been Pwned after I launched it back in December 2013 <a href="https://www.troyhunt.com/have-i-been-pwned-you-can-now-ask-api/">was the public API</a>. My thinking at the time was that it would make the data more easily accessible to more people to go and do awesome things; build mobile clients, integrate into security tools and surface more information to more people to enable them to do <em>positive and constructive things</em> with the data. I highlighted 3 really important attributes at the time of launch:</p><blockquote>
<p>There is no authentication.</p>
<p>There is no rate limiting.</p>
<p>There is no cost.</p>
</blockquote><p>One of those changed nearly 3 years ago now - <a href="https://www.troyhunt.com/the-have-i-been-pwned-api-rate-limiting-and-commercial-use/">I had to add a rate limit</a>. The other 2 are changing today and I want to clearly explain why.</p><h3 id="identifying-abusive-api-usage">Identifying Abusive API Usage</h3><p>Let me start with a graph:</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/06/image-2.png" class="kg-image"></figure><p>This is executions of the V2 API that enables you to search an individual email address. There&apos;s 1.06M requests in that 24 hour period with 491k of them in the last 4 hours. Even with the rate limit of 1 request every 1,500ms per IP address enforced, that graph shows a very clear influx of requests peaking at 14k per minute. How? Well let&apos;s pull the logs from Cloudflare and see:</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/06/image-3.png" class="kg-image"></figure><p>This is the output of a little log analyser I wrote that breaks requests down by ASN (and other metrics) over the past hour. There were 15,573 requests from AS23969 across 82 unique IP addresses. Have a look at where those IP addresses came from:</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/05/image-4.png" class="kg-image"></figure><p>There is no conceivable way that this is legitimate, organic usage of the API from Thailand. <a href="https://db-ip.com/as23969">The ASN is owned by TOT Public Company Limited</a>, <a href="https://en.wikipedia.org/wiki/TOT_Public_Company_Limited">a local Thai telco</a> that somehow, has ended up with a truckload of IP addresses hitting HIBP at <em>just </em>the right rate to not trigger the rate limit. The next top ASN is <a href="https://db-ip.com/as17451">Biznet Networks in Indonesia</a>. Then <a href="https://db-ip.com/as28573">Claro in Brazil</a>. After that <a href="https://db-ip.com/as14061">there&apos;s Digital Ocean</a> and then another Indonesian telco, <a href="https://db-ip.com/as17974">Telkomnet</a>. It makes for a geographical spread that&apos;s entirely inconsistent with legitimate usage of genuine consumers (no, HIBP isn&apos;t actually big in Iran!):</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/06/image-4.png" class="kg-image"></figure><p>Late last year after seeing a similar pattern with a well-known hosting provider, I reached out to them to try and better understand what was going on. I provided a bunch of IP addresses which they promptly investigated and reported back to me on:</p><blockquote>
<p>1- All those servers were compromised. They were either running standalone VPSs or cpanel installations.</p>
<p>2- Most of them were running WordPress or Drupal (I think only 2 were not running any of the two).</p>
<p>3- They all had a malicious cron.php running</p>
</blockquote><p>This helped me understand the source of the problem, but it didn&apos;t get me any closer to actually blocking the abusive behaviour. For the sake of transparency, let me talk about how I <em>tried </em>to tackle this because that will help everyone understand why I&apos;ve arrived at a very different model to what I started with.</p><h3 id="combating-abuse-with-firewall-rules">Combating Abuse with Firewall Rules</h3><p>Firewall rules on Cloudflare are amazingly awesome. It takes just a few seconds to have a rule like this in place:</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/05/image-5.png" class="kg-image"></figure><p>Make more than 40 requests in a minute and you&apos;re in the naughty corner for a day. Only thing is, that&apos;s IP-based and per the earlier section on abusive patterns, actors with large numbers of IP addresses can largely circumvent this approach. It&apos;s still a fantastic turn-key solution that seriously raises the bar for anyone wanting to get around it, but someone determined enough will find a way.</p><p>No problems, I&apos;ll just take abusive ASNs like the Thai one above and give them the boot. I scripted a lot of them based on patterns in the log files and create a firewall rule like this:</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/05/image-6.png" class="kg-image"></figure><p>That works pretty quickly and is very effective, except for the fact that there&apos;s an awful lot of ASNs out there being abused. Plus, it has side-effects I&apos;ll come back to shortly too.</p><p>So how about looking at user agent strings instead? I mean could always just block the ones bad actors are using, except that was never going to work particularly well for obvious reasons (you can always define whatever one you like). That said, there were a <em>heap</em> of browser UAs which clearly were (almost) never legitimate for a client making API calls. So I blocked these as well:</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/05/image-7.png" class="kg-image"></figure><p>That shouldn&apos;t have come as a surprise to anyone as the API docs were actually quite clear about this:</p><blockquote>The user agent should accurately describe the nature of the API consumer such that it can be clearly identified in the request. Not doing so may result in the request being blocked.</blockquote><p>Problem is, people don&apos;t read docs and I ended up with a heap of default user agents (such as curl&apos;s) which were summarily blocked. And, of course, the user agent requirement was easily circumvented as I expected it would be and I simply started seeing randomised strings in the UA.</p><p>Another approach I toyed with (very transiently) was blocking entire countries from accessing the API. I was always really hesitant to do this, but when 90% of the API traffic was suddenly coming from a country in West Africa, for example, that was a pretty quick win.</p><p>I&apos;m only writing about this here now because as the new model comes into place, all of this will be redundant. Plus, I wanted to shed some light on the API behaviour some people may have previously seen which they couldn&apos;t quite work out, and that brings me to the next section.</p><h3 id="the-impact-on-legitimate-usage">The Impact on Legitimate Usage</h3><p>The attempts described above to block abuse of the API also blocked a lot of good requests. I feel bad about that because it made something I&apos;d always intended to be easily accessible difficult for some people to use. I hope that by explaining the background here, people will understand why the approaches above were taken and indeed, why the changes I&apos;m going to talk about soon were necessary.</p><p>I got way too many emails from people about API requests being blocked to respond to. Often this was due to simply not meeting the API requirements, for example providing a descriptive UA string. Other times it was because they were on the same network as abusive users. There were also those who simply smashed through the rate limit too quickly and got themselves banned for a day. Other times, there were genuine API users in that West African country who found themselves unable to use the service. I was constantly balancing the desire to make the API easily accessible whilst simultaneously trying to ensure it wasn&apos;t taken advantage of. In the end, the path forward was clear - the API would need to be authenticated.</p><h3 id="the-new-model-authenticated-requests">The New Model: Authenticated Requests</h3><p>I held back on this for a long time because adding auth to the API adds a barrier to entry. It also adds coding effort on my end as well as management overhead. However, by earlier this year it became clear that this was the only way forward: requests would have to be auth&apos;d. Doing this solves a <em>heap </em>of problems in one fell swoop:</p><ol><li>The rate limit could be applied to an API key thus solving the problem of abusive actors with multiple IP addresses</li><li>Abuse associated to an IP, ASN, user agent string or country no longer has to impact other requests matching the same pattern</li><li>The rate limit can be just that - a limit rather than also dishing out punishment via the 24 hour block</li></ol><p>Making an authenticated call is a piece of cake, you just add an hibp-api-key header as follows:</p><pre><code>GET https://haveibeenpwned.com/api/v3/breachedaccount/test@example.com
hibp-api-key: [your key]</code></pre><p>However, this wasn&apos;t going to completely solve the problem, rather it moved the challenge to the way in which API keys were provisioned. It&apos;s no good putting controls around the key itself if a bad actor could just come along and register a heap of them. Anti-automation on the form where a key can be requested is one thing, stopping someone from manually registering, say, 20 of them with different email addresses and massively amplifying their request rate is quite another. I had to raise the bar <em>just</em> high enough to dissuade people from doing this, which brings me to the financial side of things.</p><h3 id="there-s-a-us-3-50-per-month-fee-to-use-the-api">There&apos;s a US$3.50 per Month Fee to Use the API</h3><p>Clearly not everyone will be happy with this so let me spend a bit of time here explaining the rationale. This fee is first and foremost to stop abuse of the API. The actors I&apos;ve seen taking advantage of it are highly unlikely to front up with a credit card and provide what amounts to personally identifiable data (i.e. make a credit card payment) in order to mass enumerate the API.</p><p>In choosing the $3.50 figure, I wanted to ensure it was a number that was inconsequential to a <em>legitimate </em>user of the service. That&apos;s about what a latte costs at my local coffee shop so spending a few bucks a month to search through billions of records seems like a pretty damn good deal, especially when that rate limit enables 57.6k requests per day.</p><p>One thing I want to be crystal clear about here is that the $3.50 fee is no way an attempt to monetise something I always wanted to provide for free. I hope the explanation above helps people understand that, and also the fact the API has run the last 5 and a half years without any auth whatsoever clearly demonstrates that financial gain has never been the intention. Plus, the service I&apos;m using to implement auth and rate limits comes with a direct cost to me:</p><figure class="kg-card kg-image-card"><img src="/content/images/2019/07/image-1.png" class="kg-image"></figure><p>This is from <a href="https://azure.microsoft.com/en-us/pricing/details/api-management/">the Azure API Management pricing page</a> which is the service I&apos;m using to provision keys and control rate limits (I&apos;ll write a more detailed post on this later on - it&apos;s kinda awesome). I chose the $3.50 figure because it represents someone making one million calls. Some people will make much less, some much more - that rate limit represents a possible 1.785 million calls per month. Plus, there&apos;s still the costs of function executions, storage queries and egress bandwidth to consider, not to mention the slice of the $3.50 that Stripe takes for processing the payment (all charges are routed through them). The point is that the $3.50 number is pretty much bang on the mark for the cost of providing the service.</p><p>What this change does it simultaneously gives me a much higher degree of confidence the API will be used in an ethical fashion whilst also ensuring that those who use it have a much more predictable experience without me dipping deeper and deeper into my own pocket.</p><h3 id="the-api-is-revving-to-version-3-and-has-some-breaking-changes-">The API is Revving to Version 3 (and Has Some Breaking Changes)</h3><p>With this change, I&apos;m revising the API up to version 3. All documentation on <a href="https://haveibeenpwned.com/API/v3">the API page</a> now reflects that and also reflects a few breaking changes, the first of which is obviously the requirement for auth. When using V3, any unauthenticated requests will result in an HTTP 401.</p><p>The second breaking change relates to how the versioning is done. Back in 2014, I wrote about <a href="https://www.troyhunt.com/your-api-versioning-is-wrong-which-is/">how your API versioning is wrong</a> and headlined it with this graphic:</p><p><img src="/content/images/2016/02/41694168readImage2.png" alt="It&apos;s not restful"></p>
<p>I outlined 3 different possible ways of expressing the desired version in API calls, each with their own technical and philosophical pros and cons:</p><ol><li>Via the URL</li><li>Via a custom request header</li><li>Via the accept header</li></ol><p>After 4 and a bit years, by far and away the most popular method with an uptake of more than 90% is versioning via the URL. So that&apos;s all V3 supports. I don&apos;t care about the philosophical arguments to the contrary, I care about working software and in this case, the people have well and truly spoken. I don&apos;t want to have to maintain code and provide support for something people barely use when there&apos;s a perfectly viable alternative.</p><p>Next, I&apos;m inverting the condition expressed in the &quot;truncateResponse&quot; query string. Previously, a call such as this would return all meta data for a breach:</p><pre><code>GET https://haveibeenpwned.com/api/v2/breachedaccount/test@example.com</code></pre><p>You&apos;d end up with not just the name of the breach, but also how many records were in it, all the impacted data classes, a big long description and a whole bunch of other largely redundant information. I say &quot;redundant&quot; because if you&apos;re hitting the API over and over again, you&apos;re pulling but the same info for each account that appears in the same breach. Using the &quot;truncateResponse&quot; parameter reduced the response size by 98% but because it wasn&apos;t the default, it wasn&apos;t used that much. I want to drive the adoption of small responses because not only are they faster for the consumer, they also reduce my bandwidth bill which is one of the most expensive components of HIBP. You can still pull back all the data for each breach if you&apos;d like, you just need to pass &quot;truncateResponse=false&quot; as true is now the default. (Just a note on that: you&apos;re far better off making a single call to <a href="https://haveibeenpwned.com/API/v3#AllBreaches">get all breached sites in the system</a> then referencing that collection by breach name after querying an individual email address.)</p><p>I&apos;m also inverting the &quot;includeUnverified&quot; parameter. The original logic for this was that when <a href="https://www.troyhunt.com/introducing-unverified-breaches-to-have-i-been-pwned/">I launched the concept of unverified breaches</a>, I didn&apos;t want existing consumers of the API to suddenly start getting results for breaches which may not be real. However, with the passage of time I&apos;ve come across a couple of issues with this and the first is that a heap of people consumed the API with the default params (which wouldn&apos;t include unverified breaches) and then contacted me asking &quot;why does the API return different results to the front page of HIBP?&quot; The other issue is that I simply haven&apos;t flagged very many breaches as unverified and I&apos;ve also added other classes of breach which deviate from the classic model of loading a single incident clearly attributable to a single site such as the original Adobe breach. There are now spam lists, for example, as well as credential stuffing lists and returning all data by default is much more consistent with the ethos of considering all breached data to be in scope.</p><p>The other major thing related to breaking stuff is this:</p><p><strong>Versions 1 and 2 of the API for searching breaches and pastes by email address will be disabled in 4 weeks from today on August 18.</strong></p><p>I have to do this on an aggressive time frame. Whilst I don&apos;t, all the problems mentioned above with abuse of the API continues. When we hit that August due date, the APIs will begin returning HTTP 400 &quot;Bad Request&quot; and that will be the end of them.</p><p>One important distinction: this <em>doesn&apos;t</em> apply to the APIs that don&apos;t pull back information about an email address; the API listing all breaches in the system, for example, is not impacted by any of the changes outlined here. It can be requested with version 3 in the path, but also with previous versions of the API. Because it returns generic, non-personal data it doesn&apos;t need to be protected in the same fashion (plus it&apos;s really aggressively cached at Cloudflare). Same too for Pwned Passwords - there&apos;s absolutely zero impact on that service.</p><p>During the next 4 weeks I&apos;ll also be getting more aggressive with locking down firewall rules on the previous versions at the first sign of misuse until they&apos;re discontinued entirely. They&apos;re an easy fix if you&apos;re blocked with V2 - get an API key and roll over to V3. Now, about that key...</p><h3 id="protecting-the-api-key-and-how-my-problem-becomes-your-problem-">Protecting the API Key (and How My Problem Becomes Your Problem)</h3><p>Now that API keys are a thing, let me touch briefly on some of the implications of this as it relates to those of you who&apos;ve built apps on top of HIBP. And just for context, have a look at <a href="https://haveibeenpwned.com/API/Consumers">the API consumers page</a> to get a sense of the breadth we&apos;re talking about; I&apos;ll draw some examples out of there.</p><p>For code bases such as <a href="https://github.com/Radial01/PwnyCorral">Brad Dial&apos;s Pwny Corral</a>, it&apos;s just a matter of adding the hibp-api-key header and a configuration for the key. Users of the script will need to go through the enrolment process to get their own key then they&apos;re good to go.</p><p>In a case like <a href="https://whatismyipaddress.com/breach-check">What&apos;s My IP Address&apos; Data Breach Check</a>, we&apos;re talking about a website with a search feature that hits their endpoint and then they call HIBP on the server side. The HIBP API key will sit privately on their end and the only thing they&apos;ll really need to do is stop people from hammering their service so it doesn&apos;t exceed the HIBP rate limit for that key. This is where it becomes their (your) problem rather than mine and that&apos;s particularly apparent in the next scenario...</p><p>Rich client apps designed for consumer usage such as <a href="https://outercorner.com/blog/2018/06/version-2.6-brings-favorites-custom-filters-and-more/">Outer Corner&apos;s Secrets app</a> will need to proxy API hits through their own service. You don&apos;t want to push the HIBP API key out with the installer plus you also need to be able to control the rate limit of <em>all </em>your customers so that it doesn&apos;t make the service unavailable for others (i.e. one user of Secrets smashes through the rate limit thus making the service unavailable for others).</p><p>One last thing on the rate limit: because it&apos;s no longer locking you out for a day if exceeded, making too many requests results in a very temporary lack of service (usually single digit seconds). If you&apos;re consuming the new auth&apos;d API, handle HTTP 429 responses from HIBP gracefully and ask the user to try again momentarily. Now, with that said, let me give you the code to make it dead easy to both proxy those requests and control the rate at which <em>your </em>subscribers hit the service; here&apos;s how to do it with Cloudflare workers and rate limits:</p><h3 id="proxying-with-a-cloudflare-worker-and-setting-rate-limits-">Proxying With a Cloudflare Worker (and Setting Rate Limits)</h3><p>The fastest way to get up and running with proxying requests to V3 of the HIBP API is with a <a href="https://www.cloudflare.com/products/cloudflare-workers/">Cloudflare Worker</a>. This is &quot;serverless code on the edge&quot; or in other words, script that runs on Cloudflare&apos;s 180 edge nodes around the world such that when someone makes a request for a particular route, the script kicks in and executes. It&apos;s easiest just to have a read of the code below:</p><p>Stand up a domain on Cloudflare&apos;s free tier (if you&apos;re not on there already) then it&apos;s $5 per month to send 10M queries through your worker which is obviously way more than you can send to the HIBP API anyway. And while you&apos;re there, go and use the firewall rules to lock down a rate limit so your own API isn&apos;t hammered too much (keeping in mind some of the challenges I faced when doing this).</p><p>The point is that if you need to protect the API key and proxy requests, it&apos;s dead simple to do.</p><h3 id="but-what-if-you-just-">&quot;But what if you just...&quot;</h3><p>I&apos;ll get a gazillion suggestions of how I could do this differently. Every single time I talk about the mechanics of how I&apos;ve built something I always do! The model described in this blog post is the best balance of a whole bunch of different factors; the sustainability of the service, the desire to limit abuse, leveraging the areas my skills lie in, the limited availability of my time and so on and so forth. There are many other factors that also aren&apos;t obvious so as much as suggestions for improvements are very welcomed, please keep in mind that they may not work in the broader sense of what&apos;s required to run this project.</p><h3 id="caveats">Caveats</h3><p>There&apos;s a couple of these and they&apos;re largely due to me trying to make sure I get this feature out as early as possible and continue to run things on a shoestring cost wise. Firstly, there&apos;s no guarantee of support. We do <a href="https://report-uri.com/#prices">the same thing with entry-level Report URI pricing</a> and it&apos;s simply because it&apos;s enormously hard to do with the time constraints of a single person running this. That said, if anything is buggy or broken I definitely want to know about it. Secondly, there&apos;s no way to retrieve or rotate the API key. If you extend the one-off subscription you&apos;ll get the same key back or if you cancel an existing subscription &#xA0;and take a new one you&apos;ll also get the same key. I&apos;ll build out better functionality around this in the future.</p><p>I&apos;m sure there&apos;ll be others that pop up and I&apos;ll expand on the items above if I&apos;ve missed any here.</p><p>The changes I&apos;ve outlined here strike a balance between making the API available for good purposes, making it harder to use for bad purposes, ensuring stability for all those in the former category and crucially, making it sustainable for me to operate. That last point in particular is critical for me both in terms of reducing abuse and reducing the overhead on me trying to achieve that objective and supporting those who ran into the previously mentioned blocks.</p><p>I expect there&apos;ll be many requests to change or evolve this model; other payment types, no payment at all for certain individuals or organisations, higher rate limits and so on and so forth. At this stage, my focus is on keeping the service sustainable as <a href="https://www.troyhunt.com/project-svalbard-the-future-of-have-i-been-pwned/">Project Svalbard</a> marches forward and once that comes to fruition, I&apos;ll be in a much better position to revisit suggestions (also, <a href="https://haveibeenpwned.uservoice.com/forums/275398-general">there&apos;s a UserVoice for that</a>). For now, I hope that this change leads to a much more sustainable service for everyone.</p> <section class="article-open_tag"> <a class="tag" href="/tag/have-i-been-pwned-3f/">Have I Been Pwned</a> </section> </section>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>