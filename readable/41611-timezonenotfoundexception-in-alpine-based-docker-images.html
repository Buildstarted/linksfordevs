<!DOCTYPE html>
<html lang="en">
<head>
    <title>
TimeZoneNotFoundException in Alpine Based Docker Images -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>TimeZoneNotFoundException in Alpine Based Docker Images</h1>
    <div class="entry-content"> <p>In this post, we&#x2019;re going to explore the cause of a <strong>TimeZoneNotFoundException</strong> in a .NET Core application, running on .NET Core 3.0 in an Alpine Linux Docker container.</p>
<p><strong><em>TL;DR;</em></strong></p>
<p><em>The default Alpine Docker image does not include time zone data by default. This causes code which depends on this data to throw exceptions. If you need this data you must add the package to your image or use a non-alpine image.</em></p>
<h2>Exploring the Problem</h2>
<p>My problems began whilst working on a multi-tenant event processing microservice. The service processes some messages from an AWS SQS queue, triggering the creation and population of a data model which is then sent onto another queue for further processing.</p>
<p>One of the inputs on the original message is a UTC DateTime which indicates when an event occurred. My service needs to translate that to a local DateTime, based on the configuration for the tenant to which the event belongs.</p>
<p>The way this works is that using the tenant identifier on the incoming message, the service queries a configuration API to get the tenant&#x2019;s configured time zone identifier (stored as a Windows ID). Using that ID, my code then converts the UTC DateTime into the local DateTime.</p>
<p>One extra complication is that the service is developed on my Windows PC and we get a Windows ID for the time zone from the configuration API. However, when deployed, the service runs in a Linux Docker container. Since Linux and Windows use a different time zone database, converting dates in a cross-platform way needs some care.</p>
<p>To work around the platform differences, I had chosen to use the TimeZoneConverter <a href="https://www.nuget.org/packages/TimeZoneConverter/">NuGet package</a> in my solution. You can read more about this approach on the Microsoft .NET Core Blog in, &#x201C;<a href="https://devblogs.microsoft.com/dotnet/cross-platform-time-zones-with-net-core/">Cross-platform Time Zones with .NET Core</a>&#x201C;.</p>
<p>When running my application on my Windows PC, everything worked as expected. However, upon testing the code running inside a Docker container, it failed with an exception.</p> <p>This surprised me as I thought that by using the TimeZoneConverter library I was protected from such errors. I spent a little while trying to isolate the issue in my code, a little longer than I care to admit!</p>
<h2>Reproducing the Exception</h2>
<p>After getting nowhere I decided it was best to produce a minimal reproduction of the code, to rule out as many potential causes as possible. I ended up created a simple .NET Core 3.0 console application. I included the dependency to the TimeZoneConverter library.</p> <p>I then added some basic code which exercised the static GetTimeZoneInfo method I was calling on TZConvert. Here is the code:</p> <p>I ran this code on Windows and the output was as expected:</p>
<pre>(UTC+00:00) Dublin, Edinburgh, Lisbon, London<br>(UTC+00:00) Dublin, Edinburgh, Lisbon, London</pre>
<p>I then created a Dockerfile for this project, based on the structure used for our .NET Core microservices:</p> <p>I built a Docker image and then ran it which resulted in the TimeZoneNotFoundException as I&#x2019;d been seeing in my original service.</p> <p>I was honestly stumped for a few minutes and resorted to some random Googling of time zone issues with Linux. Ultimately, I stumbled upon a few pages which referred to issues in Alpine Linux specifically. I was getting warmer! I narrowed my searched to Alpine specifically and hit the problem. By default, Alpine is a very slim, lightweight Linux distribution. One of the things it lacks is the time zone database. That would explain the exceptions.</p>
<h2>Solution 1</h2>
<p>Note: We can do better than this but I&#x2019;m including it for completeness.</p>
<p>The first and most obvious solution was to depend on a non-Alpine Linux image as my base. I could achieve this by switching to the mcr.microsoft.com/dotnet/core/aspnet runtime image with the tag 3.0 in my Dockerfile.</p>
<pre>FROM mcr.microsoft.com/dotnet/core/aspnet:3.0 AS base</pre> <p>After this change and rebuilding the image, I was able to run the Console1 code without exception. Hurrah!</p>
<p>This works because this tag is based on a Debian 10 distribution which includes the time zone database my code requires.</p>
<h2>Solution 2</h2>
<p>While the above solution works fine, it left me frustrated that I was unable to use the lighter Alpine images. I prefer these as we build images often as part of CI/CD and reducing the size has a fairly large effect on our image repository.</p>
<p>I set about finding a better solution and in the end, realised I could simply add the time zone database package to my Alpine image as part of my Dockerfile. I simply needed to add one command to my base runtime image in my Dockerfile:</p> <p>The final line here is the key, it uses the Alpine package management tool to install the <a href="https://pkgs.alpinelinux.org/package/edge/main/x86/tzdata">tzdata package</a>.</p>
<p>With this single run command, my Docker image now included the required time zone data and my application was able to execute correctly, without exception.</p>
<h2>Summary</h2>
<p>This was the first time I&#x2019;d run into any limitations of the Alpine runtime image so it took me a while to realise that it&#x2019;s slim nature meant I was lacking a key dependency. Problems like this crop up for developers fairly often and when one has never seen them before, solutions can be tricky. I hope this post explains why the troubleshooting steps of producing a minimal reproduction helped set me on the path to success, narrowing down the problem to a very small set of possible causes.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>