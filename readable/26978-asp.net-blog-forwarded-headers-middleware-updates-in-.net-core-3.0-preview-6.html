<!DOCTYPE html>
<html lang="en">
<head>
    <title>
ASP.NET Blog | Forwarded Headers Middleware Updates in .NET Core 3.0 preview 6 -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>ASP.NET Blog | Forwarded Headers Middleware Updates in .NET Core 3.0 preview 6</h1>
    <div class="entry-content col-12 sharepostcontent"> <div class="row justify-content-center"><div class="col-md-4"><div><img src="https://secure.gravatar.com/avatar/e2ffd37e9b37271036f8f407c0592805?s=58&amp;d=mm&amp;r=g" width="58" alt="Avatar" class="avatar avatar-58 wp-user-avatar wp-user-avatar-58 photo avatar-default"></div></div></div> <p>With the ASP.NET Core 2.1 release, we included <code>UseHsts</code> and <code>UseHttpRedirection</code> by default. These methods put a site into an infinite loop if deployed to an Azure Linux App Service, Azure Linux virtual machine (VM), or behind any other reverse proxy besides IIS. TLS is terminated by the reverse proxy, and Kestrel isn&#x2019;t made aware of the correct request scheme.</p>
<p>OAuth and OIDC also fail in this configuration because they generate incorrect redirects. Calls to <code>UseIISIntegration</code> add and configure forwarded headers middleware when running behind IIS, but there&#x2019;s no matching automatic configuration for Linux (Apache or Nginx integration). The fix for this issue is discussed in more detail in the doc article <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-2.2#forward-the-scheme-for-linux-and-non-iis-reverse-proxies">Forward the scheme for Linux and non-IIS reverse proxies</a>.</p>
<h2>Configuration-only Wire-up in Preview 6</h2>
<p>With the updates in .NET Core 3 preview 6, you no longer need to call the middleware explicitly, as the host logic has been pre-wired to enable the Forwarded Headers Middleware by default as long as the <code>ASPNETCORE_FORWARDEDHEADERS_ENABLED</code> environment variable has been set to <code>true</code>. Turning on the Forwarded Headers Middleware is as simple as setting the <code>ASPNETCORE_FORWARDEDHEADERS_ENABLED</code> setting in the Azure Portal&#x2019;s configuration blade for any App Service running on Linux or in a container.</p>
<p><img src="https://devblogs.microsoft.com/aspnet/wp-content/uploads/sites/16/2019/06/configuration.png" alt="Enabling the Forwarded Headers Middleware via config"></p>
<p>Once this setting is set to true, the middleware starts working, and features dependent on <code>Request.IsHttps</code> resulting to <code>true</code> begin to function as expected.</p>
<h2>Resolving the issue with ASP.NET Core 2.x Apps Today</h2>
<p>If you&#x2019;re currently building an ASP.NET Core 2.x app and want to run it on App Service for Linux now, there&#x2019;s a workaround that will be future-proof when the updates come out for 3.0.</p>
<p>To forward the scheme from the proxy in non-IIS scenarios, add and configure Forwarded Headers Middleware. In <code>Startup.cs</code>, use the following code:</p>
<pre><code class="csharp">// using Microsoft.AspNetCore.HttpOverrides;

public void ConfigureServices(IServiceCollection services)
{
    if (string.Equals(
        Environment.GetEnvironmentVariable(&quot;ASPNETCORE_FORWARDEDHEADERS_ENABLED&quot;), 
        &quot;true&quot;, StringComparison.OrdinalIgnoreCase))
    {
        services.Configure&lt;forwardedheadersoptions&gt;(options =&gt;
        {
            options.ForwardedHeaders = ForwardedHeaders.XForwardedFor | 
                ForwardedHeaders.XForwardedProto;
            // Only loopback proxies are allowed by default.
            // Clear that restriction because forwarders are enabled by explicit 
            // configuration.
            options.KnownNetworks.Clear();
            options.KnownProxies.Clear();
        });
    }
}

public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    app.UseForwardedHeaders();
}
</code></pre>
<p>If you enable your ASP.NET Core 2.x apps with this workaround today, when you&#x2019;re ready to upgrade to 3.0, you&#x2019;ll already have the right configuration setting in place.</p>
<h2>Base Image Update</h2>
<p>The base images used by the App Service team to streamline the creation of ASP.NET Core apps will soon be updated so that the <code>ASPNETCORE_FORWARDEDHEADERS_ENABLED</code> environment variable will be set to <code>true</code>. Once they&#x2019;re updated, you won&#x2019;t even need to explicitly set the environment variable; it&#x2019;ll be enabled by default.</p>
<h2>Try it Out</h2>
<p>If you&#x2019;re new to building ASP.NET Core apps using containers, the App Service options for Linux and Container-based hosting offer a great place to get started. The docs are loaded with guidance and examples, from how to <a href="https://docs.microsoft.com/en-us/azure/app-service/containers/quickstart-dotnetcore">Run a .NET Core app in App Service on Linux</a> to accessing a <a href="https://docs.microsoft.com/en-us/azure/app-service/containers/tutorial-dotnetcore-sqldb-app">SQL Server Database from an ASP.NET Core app running in App Service Linux</a>.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>