<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Painless Password Hash Upgrades -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Painless Password Hash Upgrades</h1>
    <div id="xsbf-entry-content" class="entry-content"> <p>Existing websites and applications implementing an older password hashing algorithm like MD5 or SHA1 must be upgraded to a more secure algorithm. Both of these older algorithms are obsolete &amp; breakable and if an attacker obtains those hashes from a lost backup tape or website vulnerability, the attacker could make quick work of determining your user&#x2019;s passwords via Rainbow Tables<sup><a href="#ref">&#x2020;</a></sup>. And since 55% of users <sup><a href="#ref">&#x2021;</a></sup> use the same password on many different websites, your compromise exposes your users elsewhere too. Ideally, this migration from insecure to secure hashes must be done without downtime or forcing a password reset situation across the entire user base.</p>
<p>It is relatively straight-forward to upgrade to new hashing algorithms, such as SHA-512 or Scrypt; this blog post gives you the steps for this upgrade and to implement salting while you&#x2019;re retrofitting the password system. We also give you advice on how to integrate over time instead of all at once. If you&#x2019;re already using Spring Security, this migration can be done nearly transparently and we will show you how to implement it.</p>
<p>This blog post was co-written by Siddharth Coontoor and Jay Ball after teaching a security class where the students in all three sessions asked the same question: &#x201C;How do we upgrade MD5 password hashes in our database without impacting our end users.&#x201D;</p>
<h2><span id="existing-implementation">Existing Implementation</span></h2>
<p>Generally, on most websites, the code to implement username &amp; password validation might look something like this pseudo-code:</p> <div id="crayon-5d72690500e1f463166183" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
username = POST[&apos;username&apos;]
password = POST[&apos;password&apos;]

passwordhash = hexstr(md5(password))   // hex-formatted string of MD5 hash

user_id = SQL_call(&apos;select user_id from users where username=$1 and passwordhash=$2&apos;, username, passwordhash)

if user_id &lt;= 0 and no_exception_thrown {
    // no username + passwordhash match
    // return error to end user
    exit
}

user_object = get_user_data(user_id)
// show welcome page for user</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e1f463166183-1"><span class="crayon-v">username</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">POST</span><span class="crayon-sy">[</span><span class="crayon-s">&apos;username&apos;</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e1f463166183-2"><span class="crayon-v">password</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">POST</span><span class="crayon-sy">[</span><span class="crayon-s">&apos;password&apos;</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e1f463166183-4"><span class="crayon-v">passwordhash</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">hexstr</span><span class="crayon-sy">(</span><span class="crayon-e">md5</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h">&#xA0;&#xA0; </span><span class="crayon-c">// hex-formatted string of MD5 hash</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e1f463166183-6"><span class="crayon-v">user_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">SQL_call</span><span class="crayon-sy">(</span><span class="crayon-s">&apos;select user_id from users where username=$1 and passwordhash=$2&apos;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">passwordhash</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e1f463166183-8"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">user_id</span><span class="crayon-h"> </span><span class="crayon-o">&lt;=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-e">no_exception_thrown</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5d72690500e1f463166183-9"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// no username + passwordhash match</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e1f463166183-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// return error to end user</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e1f463166183-14"><span class="crayon-v">user_object</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_user_data</span><span class="crayon-sy">(</span><span class="crayon-v">user_id</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d72690500e1f463166183-15"><span class="crayon-c">// show welcome page for user</span></div></div></td> </tr> </table> </div> </div> <p>From the above, replacing line 4 with <code>passwordhash = hexstr( sha512(password) )</code> seems tempting, but that would invalidate all existing passwords instantly. Remember that all passwords in the database are currently MD5, so the quick code replacement can&#x2019;t be done. There must be an interim step &#x2013; we need to determine the current type of hash used.</p>
<p>There are a few mechanisms for determining the type of hash. One manner is to create a new column in the database with the hash type. When the new column is added, set the value to be <code>1</code> for all users since everyone starts out using the legacy MD5. So, the code might be:</p> <div id="crayon-5d72690500e2a651104610" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
hash_type = SQL_call(&apos;select hash_type from users where username=$1&apos;, username)

if hash_type == 1 {
    passwordhash = hexstr(md5(password))
} elseif hash_type == 2 {
    passwordhash = hexstr(sha512(password))
} else {
    // raise an internal error
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e2a651104610-1"><span class="crayon-v">hash_type</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">SQL_call</span><span class="crayon-sy">(</span><span class="crayon-s">&apos;select hash_type from users where username=$1&apos;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e2a651104610-4"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">passwordhash</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">hexstr</span><span class="crayon-sy">(</span><span class="crayon-e">md5</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d72690500e2a651104610-5"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">elseif</span><span class="crayon-h"> </span><span class="crayon-v">hash_type</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e2a651104610-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">passwordhash</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">hexstr</span><span class="crayon-sy">(</span><span class="crayon-e">sha512</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e2a651104610-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// raise an internal error</span></div></div></td> </tr> </table> </div> </div> <p>That is one mechanism; another is by checking the length the existing hash. This method has the advantage that another database column does not need to be created to determine hash type. For the common hashes, this table shows lengths of each:</p> <table class="table table-bordered table-hover table-condensed">
<thead>
<tr>
<th>Hash</th>
<th>Digest Bits</th>
<th>Bytes</th>
<th>Hex Bytes</th>
<th>Base64 Bytes</th>
<th>Effective Security Bits</th>
<th>MCF Prefix</th>
</tr>
</thead>
<tbody>
<tr>
<td>DES</td>
<td>56</td>
<td>7</td>
<td>14</td>
<td>12</td>
<td>39-43</td>
<td>(none)</td>
</tr>
<tr>
<td>MD5</td>
<td>128</td>
<td>16</td>
<td>32</td>
<td>24</td>
<td>&lt;64</td>
<td>$1$</td>
</tr>
<tr>
<td>SHA-1</td>
<td>160</td>
<td>20</td>
<td>40</td>
<td>28</td>
<td>&lt;63</td>
<td></td>
</tr>
<tr>
<td>SHA-2 256</td>
<td>256</td>
<td>32</td>
<td>64</td>
<td>44</td>
<td>128</td>
<td>$5$</td>
</tr>
<tr>
<td>SHA-2 512</td>
<td>512</td>
<td>64</td>
<td>128</td>
<td>88</td>
<td>256</td>
<td>$6$</td>
</tr>
<tr>
<td>SHA-2 512/256</td>
<td>256</td>
<td>32</td>
<td>64</td>
<td>44</td>
<td>128</td>
<td></td>
</tr>
<tr>
<td>Bcrypt</td>
<td>184</td>
<td>23</td>
<td>46</td>
<td>32</td>
<td></td>
<td>$2$, $2a$, $2x$, $2y$ $2b$</td>
</tr>
<tr>
<td>Scrypt</td>
<td>(variable)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>PBKDF1</td>
<td>160</td>
<td>20</td>
<td>40</td>
<td>28</td>
<td></td>
<td></td>
</tr>
<tr>
<td>PBKDF2</td>
<td>(variable)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>And this code block would use the hash length to determine the hash type:</p> <div id="crayon-5d72690500e32126309743" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
hash_size = SQL_call(&apos;select length(password) from users where username=$1&apos;, username)

if hash_size == XXX {
    passwordhash = hexstr(md5(password))
} elseif hash_size == XXX {
    passwordhash = hexstr(sha512(password))
} else {
    // raise an internal error
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e32126309743-1"><span class="crayon-v">hash_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">SQL_call</span><span class="crayon-sy">(</span><span class="crayon-s">&apos;select length(password) from users where username=$1&apos;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e32126309743-4"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">passwordhash</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">hexstr</span><span class="crayon-sy">(</span><span class="crayon-e">md5</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d72690500e32126309743-5"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">elseif</span><span class="crayon-h"> </span><span class="crayon-v">hash_size</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-e">XXX</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e32126309743-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">passwordhash</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">hexstr</span><span class="crayon-sy">(</span><span class="crayon-e">sha512</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e32126309743-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// raise an internal error</span></div></div></td> </tr> </table> </div> </div> <p>As can be seen from the table, there are conflicts, such as SHA-1 and PBKDF1 are both 160 bits. Thus, if using this mechanism for differentiating hash types, the designers must ensure that any future implementations take care to use different sizes; otherwise older passwords will be lost during the migration process. Alternatively, additional logic could be employed to handle newer passwords of length 160 versus older ones of length 160 (like checking last password change date).</p>
<p>A third option is to embed the hash type into the password column itself along with the password hash. Before we describe this, let&#x2019;s make a small segue into the database schema. Many applications are designed to limit the size of the columns in the database to only what is required. If the system had allocated only enough space for md5, the password column could be a <code>CHAR(32)</code> &#x2013; enough for a 32-hex digit string. Thus, if switching the password hash algorithm, you must also remember to increase the size of the password column in the database to an appropriately large size.</p>
<p>When embedding the hash type and password hash together, it requires some type of defined format to encompass the hash type and hash value. As such, a delimiter between the hash type and password hash must be used and for that, it is suggested to use a dollar sign ($). The choice of this glyph is meaningful as $ is not a valid base64 or hex character. Another choice could be a colon, but the colon was already used in Unix password/shadow file in the form of username:password_hash. In modern contexts, the colon is also used in Basic-Auth passwords and for JSON strings. Colons would require special escape sequences which would vary depending on the context. The dollar also allows migration from older algorithms to newer.</p>
<p>For example, <code>$algorithm$salt_followed_by_hashed_password$</code> could be placed in the password column. The first part indicates the hash algorithm whose value might be SHA-512 and the remaining part would be the hash itself. If no dollar sign is in the column, then the password hash is assumed to be whatever legacy algorithm has been implemented by the system. As passwords are changed, the new storage format will be used.</p>
<p>The idea of the dollar-delimited fields can be expanded. On many Unix systems, the passwords are stored using the Modular Crypt Format (MCF), which is basically an expanded version of the above. These versions of Unix modified the standard system <code>crypt()</code> function call to utilize alternate algorithms. The crypt function expects two arguments, one is the password and the other the salt. If the salt were to begin with $, then the argument would be parsed for which algorithm to use and processed appropriately; otherwise the legacy crypt/DES mechanisms would be used. By implementing hashing in this manner, even older software could become updated to utilize modern hashes with (possibly) no code changes. In addition, because it was a silent modification to the system call, higher-level languages like Python automatically inherited the advanced features.</p>
<p>However, MCF is not standardized across the various Unix platforms. Not all versions of crypt support all algorithms. Some implementations place a $ at the end, others have different names for the same algorithm and the same name for different algorithms (as shown the MCF column in the table above). Overall, MCF is a starting point, not something we recommend.</p>
<p>The authors of Passlib, a Python-based password hashing library, attempted to document the various implementations of MCF and eventually concluded it needed to be replaced. Thus, they now recommend using the Password Hash Committee (PHC) specification which is basically:</p>
<div> <div id="crayon-5d72690500e41537631772" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
$algorithm_id$param=value(,p=v...)$salt$hash</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e41537631772-1"><span class="crayon-sy">$</span><span class="crayon-v">algorithm_id</span><span class="crayon-sy">$</span><span class="crayon-v">param</span><span class="crayon-o">=</span><span class="crayon-e">value</span><span class="crayon-sy">(</span><span class="crayon-sy">,</span><span class="crayon-v">p</span><span class="crayon-o">=</span><span class="crayon-v">v</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span><span class="crayon-sy">$</span><span class="crayon-v">salt</span><span class="crayon-sy">$</span><span class="crayon-v">hash</span></div></div></td> </tr> </table> </div> </div> </div>
<p>with each component having an explicit definition and format.</p>
<ul>
<li><code>algorithm_id</code> is the symbolic name for the function</li>
<li><code>param</code> is a parameter name</li>
<li><code>value</code> is a parameter value</li>
<li><code>salt</code> is an encoding of the salt (modified base64)</li>
<li><code>hash</code> is an encoding of the hash output (modified base64)</li>
</ul>
<p>Here is an example of a PHC string from the Passlib folks:</p>
<div> <div id="crayon-5d72690500e4a692876726" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
$5$rounds=80000$60Y7mpmAhUv6RDvj$AdseAOq6bKUZRDRTr/2QK1t38qm3P6sYeXhXKnBAmg0</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e4a692876726-1"><span class="crayon-sy">$</span><span class="crayon-cn">5</span><span class="crayon-sy">$</span><span class="crayon-v">rounds</span><span class="crayon-o">=</span><span class="crayon-cn">80000</span><span class="crayon-sy">$</span><span class="crayon-cn">60Y7mpmAhUv6RDvj</span><span class="crayon-sy">$</span><span class="crayon-v">AdseAOq6bKUZRDRTr</span><span class="crayon-o">/</span><span class="crayon-cn">2QK1t38qm3P6sYeXhXKnBAmg0</span></div></div></td> </tr> </table> </div> </div> </div>
<p>Which corresponds to</p>
<ul>
<li><code>algorithm_id</code>=5 which is SHA2-256</li>
<li><code>param=value</code> of rounds=80000 meaning, run SHA2-256(SHA2-256(&#x2026; 80000 times</li>
<li><code>salt</code> of 60Y7mpmAhUv6RDvj</li>
<li><code>hash</code> of AdseAOq6bKUZRDRTr/2QK1t38qm3P6sYeXhXKnBAmg0</li>
</ul>
<p>This entire PHC password code was generated from a plaintext password of &#x201C;fooey&#x201D; and the salt above.</p>
<p>While Passlib can manage PHC hash strings and offers bindings for non-Python languages like Java, it might not be the best choice for legacy applications. For your application, it may not even be necessary to implement an official PHC-compliant specification, only one use the concepts shown above. Before &#x201C;rolling your own&#x201D; implementation, see if another library implements some portions of the above.</p>
<h2><span id="spring-security">Spring Security</span></h2>
<p>Spring Security uses some of these concepts as part of its PasswordEncoder structure and includes support for SHA2-256, PBKDF2, Bcrypt, &amp; Scrypt with automatic salts and extra rounds of hashing. It also stores all of these parameters in the password field in the database. This password hashing mechanism also integrated with the login process.</p>
<p>For instance, we have an existing Spring application containing all user passwords stored as instances of MD5 hashes in the database.<br>
<img class="aligncenter size-full wp-image-737 jetpack-lazy-image" src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=603%2C196&amp;is-pending-load=1#038;ssl=1" alt width="603" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>Using Spring Security as an EE filter chain there are a few ways we can migrate our user&#x2019;s passwords from MD5 hashes to iterative hashing function like PBKDF2.</p>
<ol>
<li><strong>Approach 1:</strong> Upgrade algorithm upon authentication. This approach has minimal or no impact to the end user. When user attempts to login to the application, we retrieve the user password from the database and identify whether the hashing algorithm is MD5. If it is MD5, then hash the user-provided password from the request using MD5 and match it with the hash retrieved in the database. If they match, the user is authenticated and the software will automatically upgrade the user password into PBKDF2 and replace the MD5 version into database. This approach should have no impact on the end user.</li>
<li><strong>Approach 2:</strong> Force-password change, then upgrade algorithm. This approach impacts the user as we force all users who authenticate to the application to be redirected to a password change page where they are forced to change their passwords before they can continue. This password change module would use the PBKDF2 to hash the user provided passwords and store them into the database. This approach has a few advantages because this gives the application developers a chance to enforce new password complexity policies immediately. Also, this approach provides assurance to the application owners that any passwords which were compromised or password hashes which were leaked in the past can no longer be leveraged to hijack the victim&#x2019;s account. A large disadvantage is that all users will change their passwords in quick succession, which could increase helpdesk calls.</li>
<li><strong>Approach 3:</strong> Upgrade now, change password later. In this approach the application team can run a custom stored procedure on their database to force a password change at a later date. The stored procedure would look at the last login time for each user and set a column like <code>enforceChangePwdOnNextLogin</code> in the users table to true depending on whether they changed their password before or after the roll-out of the password migration process. When the users authenticate, the application checks this column and if true, the application redirects the authenticated users to a change password page where the application transform the new password to PBDFK2 and then store it into the database. At this point, ensure that the <code>enforceChangePwdOnNextLogin</code> is also set to false so that the application does not redirect the user to change password page next time they login.</li>
</ol>
<p>Depending on your business requirement, Spring Security can support you with all of these approaches irrespective of whether your application is legacy J2EE or a Spring MVC application.</p>
<p>For our demonstration, we will go with the first approach. The password migration process requires you to tweak the existing Spring Security authentication workflow.</p>
<p>One of the ways to do the migration is by rolling out a custom authentication module by implementing AuthenticationProvider class.</p> <div id="crayon-5d72690500e53327671601" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
public class CustomAuthenticationProvider implements AuthenticationProvider</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e53327671601-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">CustomAuthenticationProvider </span><span class="crayon-r">implements</span><span class="crayon-h"> </span><span class="crayon-v">AuthenticationProvider</span></div></div></td> </tr> </table> </div> </div> <p>Once you implement <code>AuthenticationProvider</code>, you will need to implement all of its abstract methods including the <code>authenticate()</code> function. This <code>authenticate()</code> function is responsible for the following:</p>
<ol>
<li>Identifying whether existing user password hash is MD5 or PBKDF2.</li>
<li>Authenticating users who are still on MD5 and migrating them to PBKDF2.</li>
<li>Authenticating users who have already migrated to PBKDF2.</li>
</ol>
<p>The implementation of this is:</p> <div id="crayon-5d72690500e5c600456363" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
public Authentication authenticate(Authentication authentication) throws AuthenticationException {

    //Retrieve user provided username and password from authentication request
    String name = authentication.getName();
    String password = authentication.getCredentials().toString();

    //Retrieve User credentials from database and store in User domain object
    //If user doesn&apos;t exist in database throw exception
    Users user = (Users)userSerivce.loadUserByUsername(name);

    if(user!=null){

        //Check if password stored in database is pbkdf2 or md5
        //This custom implementation looks at the size of the 
        //message digest to actually determine whether to use md5 or pbdfk2  
        //for authentication verification
        if(user.getPassword().length()==24){ //MD5 verification and migration

            try {
                //convert the user provided password to MD5 and compare it with retrieved password
                MessageDigest MD5Hash = MessageDigest.getInstance(&quot;MD5&quot;);
                MD5Hash.update(password.getBytes());
                byte[] digest = MD5Hash.digest();
                String hash = Base64.getEncoder().encodeToString(digest);

                if(hash.equals(user.getPassword())){
                    //Change MD5 to pbkdf2

                    pbkdf2 = new Pbkdf2PasswordEncoder();
                    String encodedPwd = pbkdf2.encode(password);

                    String sql = &quot;Update users set password = ? where username = ?&quot;;
                    int row = getJdbcTemplate().update(sql, encodedPwd, name);

                    if(row==1){
                        //Successfully migrated user from MD5 to PBKDF2
                        return new UsernamePasswordAuthenticationToken(name, encodedPwd, user.getAuthorities());
                    }

                    throw new BadCredentialsException(&quot;An error occurred. Please try again.&quot;);  
                }

                throw new BadCredentialsException(&quot;Username or Password is Incorrect!&quot;);

            } catch (NoSuchAlgorithmException e) {
                // TODO Auto-generated catch block
                logger.log(Level.SEVERE, &quot;No Algorithm Exception&quot;, e); //Log Exception 
            }
        }else { //pbkdf2 verification
            pbkdf2 = new Pbkdf2PasswordEncoder();
            if(pbkdf2.matches(password, user.getPassword())){ //check if pbkdf2 passwords match
                return new UsernamePasswordAuthenticationToken(name, password, user.getAuthorities()); //successful then return auth object
            } //else throw exception
            throw new BadCredentialsException(&quot;Username or Password is Incorrect!&quot;);
        }
    }else{ //User does not exist in database
        throw new BadCredentialsException(&quot;Username or Password is Incorrect!&quot;);
    }

    return null;
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e5c600456363-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-e">Authentication </span><span class="crayon-e">authenticate</span><span class="crayon-sy">(</span><span class="crayon-e">Authentication </span><span class="crayon-v">authentication</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-m">throws</span><span class="crayon-h"> </span><span class="crayon-e">AuthenticationException</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//Retrieve user provided username and password from authentication request</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-4"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">authentication</span><span class="crayon-sy">.</span><span class="crayon-e">getName</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">password</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">authentication</span><span class="crayon-sy">.</span><span class="crayon-e">getCredentials</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-7"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//Retrieve User credentials from database and store in User domain object</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//If user doesn&apos;t exist in database throw exception</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-9"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-e">Users </span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Users</span><span class="crayon-sy">)</span><span class="crayon-v">userSerivce</span><span class="crayon-sy">.</span><span class="crayon-e">loadUserByUsername</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-13"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//Check if password stored in database is pbkdf2 or md5</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-14"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//This custom implementation looks at the size of the </span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-15"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//message digest to actually determine whether to use md5 or pbdfk2&#xA0;&#xA0;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-16"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//for authentication verification</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-17"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getPassword</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">length</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">==</span><span class="crayon-cn">24</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">//MD5 verification and migration</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-20"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//convert the user provided password to MD5 and compare it with retrieved password</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-21"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-e">MessageDigest </span><span class="crayon-v">MD5Hash</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">MessageDigest</span><span class="crayon-sy">.</span><span class="crayon-e">getInstance</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;MD5&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-22"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">MD5Hash</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">.</span><span class="crayon-e">getBytes</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-23"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">digest</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">MD5Hash</span><span class="crayon-sy">.</span><span class="crayon-e">digest</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-24"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">hash</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Base64</span><span class="crayon-sy">.</span><span class="crayon-e">getEncoder</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">encodeToString</span><span class="crayon-sy">(</span><span class="crayon-v">digest</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-26"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-v">hash</span><span class="crayon-sy">.</span><span class="crayon-e">equals</span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getPassword</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-29"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">pbkdf2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Pbkdf2PasswordEncoder</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-30"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">encodedPwd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pbkdf2</span><span class="crayon-sy">.</span><span class="crayon-e">encode</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-32"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">&quot;Update users set password = ? where username = ?&quot;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-33"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">row</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">getJdbcTemplate</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">sql</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">encodedPwd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-36"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">//Successfully migrated user from MD5 to PBKDF2</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-37"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UsernamePasswordAuthenticationToken</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">encodedPwd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getAuthorities</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-40"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">BadCredentialsException</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;An error occurred. Please try again.&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&#xA0;&#xA0;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-43"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">BadCredentialsException</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Username or Password is Incorrect!&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-45"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">catch</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">NoSuchAlgorithmException</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-46"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// TODO Auto-generated catch block</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-47"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">logger</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">Level</span><span class="crayon-sy">.</span><span class="crayon-v">SEVERE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">&quot;No Algorithm Exception&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//Log Exception </span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-49"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">}</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">//pbkdf2 verification</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-50"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">pbkdf2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Pbkdf2PasswordEncoder</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-51"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-v">pbkdf2</span><span class="crayon-sy">.</span><span class="crayon-e">matches</span><span class="crayon-sy">(</span><span class="crayon-v">password</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getPassword</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">//check if pbkdf2 passwords match</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-52"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">UsernamePasswordAuthenticationToken</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">password</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getAuthorities</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//successful then return auth object</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-54"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">BadCredentialsException</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Username or Password is Incorrect!&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e5c600456363-56"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">}</span><span class="crayon-st">else</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">//User does not exist in database</span></div><div class="crayon-line" id="crayon-5d72690500e5c600456363-57"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">BadCredentialsException</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Username or Password is Incorrect!&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> <p>An authentication request is processed by the AuthenticationProvider and a fully authenticated object with full credentials is returned. The <code>authenticate()</code> function does the following :</p>
<ol>
<li>Retrieves username and password from the authentication request.</li>
<li>Checks whether the provided username exists in the database or not.<br>
a. This is done by implementing the <code>UserDetailsService</code> and overriding the <code>loadUserByUsername()</code> which retrieves the username from the database using JDBC and returns a user domain object.</li>
<li>The user object contains the password retrieved from the database. Check whether the user password is MD5 or PBKDF2 based on the password length(<code>MD5_STRING_LENGTH</code>). Note that, this check can vary depending on your existing implementation of hashed passwords.</li>
<li>If the retrieved password is determined to be MD5, then encode the user provided password and check if the hashes match. If the hashes match then convert the user retrieved password to PBDFK2 and store it into the database, and return authentication object with full credentials.</li>
<li>If password is determined to be PBKDF2 then use the PBDFK2 encoder to verify the hashes and return authentication object with full credentials.</li>
</ol>
<p>The default PBKDF2 password encoder will use 360000 iterations and output a hash size of 160 bytes. These default values are an aim for 0.5 seconds to validate the password, to slow down brute force attacks. Application owners should tune password verification on their own systems to their needs.<br>
The resulting hash when PBKDF2 password encoder is used defaults to hex encoding however the designers can also configure the encoder to output in base64 format as well.<sup><a href="https://docs.spring.io/spring-security/site/docs/5.0.x/api/org/springframework/security/crypto/password/Pbkdf2PasswordEncoder.html#setEncodeHashAsBase64-boolean-">&#x2021;</a></sup></p>
<p>Below is the code which implements <code>UserDetailsService</code> to obtain the user object from the database.</p> <div id="crayon-5d72690500e66759278604" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
@Repository
public class UsersDetailsDao implements UserDetailsService
{
    @Autowired
    private DataSource dataSource;
    private JdbcTemplate jdbcTemplate;

    public UserDetails loadUserByUsername(String username)
            throws UsernameNotFoundException
    {   
        try{
            
            String sql = &quot;select * from users where username = ?&quot;;
            Users user = (Users)getJdbcTemplate().queryForObject(sql, new Object[] { username }, new RowMapper&lt;Users&gt;()
            {
                public Users mapRow(ResultSet rs, int rowNum) throws SQLException
                {
                    Users user = new Users();
                    if (user.getEnabled() == null)
                        user.setEnabled(rs.getBoolean(&quot;enabled&quot;));
                    if (user.getUsername() == null)
                        user.setUsername(rs.getString(&quot;username&quot;));
                    if (user.getPassword() == null)
                        user.setPassword(rs.getString(&quot;password&quot;));
                    return user;
                }
            });

            sql = &quot;select authority from authorities where username = ?&quot;;
            List&lt;String&gt; authorities = getJdbcTemplate().queryForList(sql, new Object[] {username}, String.class);
            Set&lt;Authorities&gt; userAuths = new HashSet&lt;Authorities&gt;();
            for (String authority : authorities)
            {
                userAuths.add(new Authorities(username, authority));
            }
            user.setAuthorities(userAuths);

            return user;
            
        }catch(EmptyResultDataAccessException e){ //User does not exist in database
            return null;
        }

    }</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-2"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">UsersDetailsDao</span><span class="crayon-h"> </span><span class="crayon-r">implements</span><span class="crayon-h"> </span><span class="crayon-e">UserDetailsService</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-e">DataSource </span><span class="crayon-v">dataSource</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-e">JdbcTemplate </span><span class="crayon-v">jdbcTemplate</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-e">UserDetails </span><span class="crayon-e">loadUserByUsername</span><span class="crayon-sy">(</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">username</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-9"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">throws</span><span class="crayon-h"> </span><span class="crayon-e">UsernameNotFoundException</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-13"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">&quot;select * from users where username = ?&quot;</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-14"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-e">Users </span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Users</span><span class="crayon-sy">)</span><span class="crayon-e">getJdbcTemplate</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">queryForObject</span><span class="crayon-sy">(</span><span class="crayon-v">sql</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">Object</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-i">username</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">RowMapper</span><span class="crayon-e ">&lt;Users&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-16"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-e">Users </span><span class="crayon-e">mapRow</span><span class="crayon-sy">(</span><span class="crayon-e">ResultSet </span><span class="crayon-v">rs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">rowNum</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-m">throws</span><span class="crayon-h"> </span><span class="crayon-e">SQLException</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-18"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-e">Users </span><span class="crayon-v">user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Users</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-19"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getEnabled</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-20"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">setEnabled</span><span class="crayon-sy">(</span><span class="crayon-v">rs</span><span class="crayon-sy">.</span><span class="crayon-e">getBoolean</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;enabled&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-21"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getUsername</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-22"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">setUsername</span><span class="crayon-sy">(</span><span class="crayon-v">rs</span><span class="crayon-sy">.</span><span class="crayon-e">getString</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;username&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-23"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">getPassword</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-24"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">setPassword</span><span class="crayon-sy">(</span><span class="crayon-v">rs</span><span class="crayon-sy">.</span><span class="crayon-e">getString</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;password&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-29"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">&quot;select authority from authorities where username = ?&quot;</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-30"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">List</span><span class="crayon-e ">&lt;String&gt;</span><span class="crayon-h"> </span><span class="crayon-v">authorities</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">getJdbcTemplate</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">queryForList</span><span class="crayon-sy">(</span><span class="crayon-v">sql</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">Object</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">username</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">String</span><span class="crayon-sy">.</span><span class="crayon-t">class</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d72690500e66759278604-31"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">Set</span><span class="crayon-e ">&lt;Authorities&gt;</span><span class="crayon-h"> </span><span class="crayon-v">userAuths</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">HashSet</span><span class="crayon-e ">&lt;Authorities&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-32"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">authority</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">authorities</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-34"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">userAuths</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Authorities</span><span class="crayon-sy">(</span><span class="crayon-v">username</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">authority</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-36"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">user</span><span class="crayon-sy">.</span><span class="crayon-e">setAuthorities</span><span class="crayon-sy">(</span><span class="crayon-v">userAuths</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e66759278604-40"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">}</span><span class="crayon-st">catch</span><span class="crayon-sy">(</span><span class="crayon-i">EmptyResultDataAccessException</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">//User does not exist in database</span></div></div></td> </tr> </table> </div> </div> <p>The method for handling authorization would vary in different applications; however it is important that we return a user object through this service.</p>
<p>If the application is legacy, then invoke the custom authentication provider through configuration in web.xml using <code></code> namespace:</p> <div id="crayon-5d72690500e72130451203" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
 &lt;authentication-manager alias=&quot;authenticationManager&quot;&gt;
      &lt;authentication-provider ref=&quot;customAuthenticationProvider&quot; /&gt;
 &lt;/authentication-manager&gt;</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e72130451203-1"><span class="crayon-h"> </span><span class="crayon-r ">&lt;authentication-manager </span><span class="crayon-e ">alias</span><span class="crayon-o">=</span><span class="crayon-s ">&quot;authenticationManager&quot;</span><span class="crayon-r ">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e72130451203-2"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r ">&lt;authentication-provider </span><span class="crayon-e ">ref</span><span class="crayon-o">=</span><span class="crayon-s ">&quot;customAuthenticationProvider&quot;</span><span class="crayon-r "> /&gt;</span></div><div class="crayon-line" id="crayon-5d72690500e72130451203-3"><span class="crayon-i "> </span><span class="crayon-r ">&lt;/authentication-manager&gt;</span></div></div></td> </tr> </table> </div> </div> <p>In case you want to invoke the custom authentication provider through Java code, then it is possible by implementing <code>WebSecurityConfigurerAdapter</code> as shown below:</p> <div id="crayon-5d72690500e76629443412" class="crayon-syntax crayon-theme-bncplusplus crayon-font-monaco crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter
{

    @Autowired 
    private CustomAuthenticationProvider customAuthProvider;
    
    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth)
            throws Exception
    {
        
        // This is handy if you need to implement your own custom authentication and authorization
        auth.authenticationProvider(customAuthProvider);
            
    }
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d72690500e76629443412-3"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">SecurityConfig</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">WebSecurityConfigurerAdapter</span></div><div class="crayon-line" id="crayon-5d72690500e76629443412-7"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-e">CustomAuthenticationProvider </span><span class="crayon-v">customAuthProvider</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e76629443412-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">configureGlobal</span><span class="crayon-sy">(</span><span class="crayon-e">AuthenticationManagerBuilder </span><span class="crayon-v">auth</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5d72690500e76629443412-14"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// This is handy if you need to implement your own custom authentication and authorization</span></div><div class="crayon-line" id="crayon-5d72690500e76629443412-15"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">auth</span><span class="crayon-sy">.</span><span class="crayon-e">authenticationProvider</span><span class="crayon-sy">(</span><span class="crayon-v">customAuthProvider</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> <h2><span id="sample-run">Sample Run</span></h2>
<p>Now, with all this code and configuration, let&#x2019;s get back to seeing the seamless password migration process. As seen earlier, here is the users tables before the migration:<br>
<img class="aligncenter size-full wp-image-737 jetpack-lazy-image" src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=603%2C196&amp;is-pending-load=1#038;ssl=1" alt width="603" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>Let us login and see the custom authentication provider in action. First, the login page.<br>
<img class="aligncenter size-full wp-image-738 jetpack-lazy-image" src="https://i1.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-login-page.png?resize=551%2C368&amp;is-pending-load=1#038;ssl=1" alt width="551" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>And after authenticating, we get to the main page:<br>
<img class="aligncenter size-full wp-image-739 jetpack-lazy-image" src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-post-authentication.png?resize=679%2C286&amp;is-pending-load=1#038;ssl=1" alt width="679" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>Once authenticated successfully, let&#x2019;s check the user table to see if user &#x201C;sid&#x201D; has now been migrated to PBKDF2.</p>
<p><img src="https://i2.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-with-strong-hash.png?resize=1170%2C200&amp;is-pending-load=1#038;ssl=1" alt width="1170" class="aligncenter size-full wp-image-769 jetpack-lazy-image" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><br>
</p>
<p>Yes, &#x201C;sid&#x201D; has been upgraded while &#x201C;jay&#x201D;, as usual, is slow on the uptake.</p>
<h2><span id="now-you-try-it">Now You Try It!</span></h2>
<p>We have provided all code on our <a href="https://github.com/murlisiddharth/SpringSecurity-PasswordMigration">GitHub Repo</a> for you to fork and use. Try it yourself, make change, ask questions, file change requests, and overall, upgrade you own software using this as a basis. If you do use our code, please give a shout-out.</p>
<h2><span id="conclusion">Conclusion</span></h2>
<p>Defense in Depth is essential to keeping your systems secure. If an attacker were to acquire the password hash from a lost backup tape, network tap, or website compromise, they could attempt to reverse them using rainbow tables. To remove these threats, add a salt to the password hashing process and upgrade to a more secure hashing algorithm.</p>
<p>We have provided a working template for a Spring application leveraging Spring Security with simple integration and limited impact on the end users. The code is short and easily customizable to your existing configurations.</p>
<p>We are interested in hearing how you used this code and what changes and enhancements were done to add it to your website. Please give us feedback at addresses below.</p>
<h2><span id="references"><a></a> References</span></h2>
<p>Various things we looked at in writing this article.</p> <h2><span id="about-the-authors">About The Authors</span></h2>
<p>This blog post was co-written by Siddharth Coontoor and Jay Ball and co-published on Jay&#x2019;s blogs at <a href="https://veggiespam.com">veggiespam.com</a>; it will be mirrored to Sid&#x2019;s blog in the future. Both Sid and Jay are #infosec professionals who do penetration testing and security threat modeling in many of the skyscrapers throughout Manhattan and Jersey City. Both participate in local infosec organizations such as OWASP, 2600, HackNYC, and more. They can be reached via DM <a href="https://twitter.com/theClumsyCoder">@theClumsyCoder</a> and <a href="https://twitter.com/veggiespam">@veggiespam</a> or via email.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>