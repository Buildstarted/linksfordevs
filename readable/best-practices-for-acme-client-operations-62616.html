<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Best Practices for ACME Client Operations - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Best Practices for ACME Client Operations - linksfor.dev(s)"/>
    <meta property="article:author" content="Don&#x2019;t make assumptions about required authorizations."/>
    <meta property="og:description" content="Considerations for Long-Running TLS Certificate Management Software"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://docs.https.dev/acme-ops"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Best Practices for ACME Client Operations</title>
<div class="readable">
        <h1>Best Practices for ACME Client Operations</h1>
            <div>by Don&#x2019;t make assumptions about required authorizations.</div>
            <div>Reading time: 34-44 minutes</div>
        <div>Posted here: 09 Jun 2020</div>
        <p><a href="https://docs.https.dev/acme-ops">https://docs.https.dev/acme-ops</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><div><div><div data-editioncontainer="true"><div data-slate-editor="true" data-key="6e2db283a09a424c82904c66562fef68" autocorrect="on" spellcheck="true" data-gramm="false"><ul data-key="9f68a763f2b5439a9267fb1b8d8426bd"><li><p data-key="eb5ef4df943e4fb792306670b5bf693c"><span><span data-key="bae7741fa73e4a3bad83f2d95218adc5"><span data-offset-key="bae7741fa73e4a3bad83f2d95218adc5:0">Matthew Holt — Caddy Web Server</span></span></span></p></li><li><p data-key="d2f5993ca71447eda16d2c3a2ee9ea70"><span><span data-key="41edbd569aad498fb2a1ccfea9e594dd"><span data-offset-key="41edbd569aad498fb2a1ccfea9e594dd:0">Jacob Hoffman-Andrews — Let's Encrypt</span></span></span></p></li><li><p data-key="db3ca8e5369d4ec6a9f1a89dd23efcfc"><span><span data-key="6f0e2f3e51da46f5a4dad5844263e530"><span data-offset-key="6f0e2f3e51da46f5a4dad5844263e530:0">Erica Portnoy — Electronic Frontier Foundation</span></span></span></p></li><li><p data-key="807b19fd426d4a44afc76cba3f7b3543"><span><span data-key="f63db42a5c23434c9f1abf2734b93b79"><span data-offset-key="f63db42a5c23434c9f1abf2734b93b79:0">Daniel McCarney — Let's Encrypt</span></span></span></p></li><li><p data-key="99755566332b4e5484f8069d5317cfff"><span><span data-key="4b780f97767b4e52a3dda06574bc0ae8"><span data-offset-key="4b780f97767b4e52a3dda06574bc0ae8:0">Ryan Hurst — Google</span></span></span></p></li></ul><p data-key="2896731c0519416384b62b022971e6d2"><span><span data-key="49ea0d6c192f46a686765aa4fa002f41"><span data-offset-key="49ea0d6c192f46a686765aa4fa002f41:0">The ACME (Automated Certificate Management Environment) protocol, or </span></span><a href="https://datatracker.ietf.org/doc/rfc8555/" target="_blank" rel="noopener noreferrer" data-key="9d0bffc617624a299c8e4727cf0b1443"><span data-key="5081819037ba43eca9303d7b255baa9d"><span data-offset-key="5081819037ba43eca9303d7b255baa9d:0">RFC 8555</span></span></a><span data-key="98e85298ffdb4de983c1710ff7a57272"><span data-offset-key="98e85298ffdb4de983c1710ff7a57272:0">, is an IETF standard. It facilitates the automatic issuance and revocation of TLS certificates. Its unsupervised nature reduces errors, increases service uptime and availability, improves security, and lowers costs.</span></span></span></p><p data-key="80b97c906b20473490d869fd898d9c88"><span><span data-key="36f1d669ac3a4ae99264c521cd766761"><span data-offset-key="36f1d669ac3a4ae99264c521cd766761:0">TLS connection errors will occur if required peer certificates are missing or invalid, so the availability of websites and services will increasingly rely upon successful ACME operations. This issue becomes more important as certificates become shorter-lived and deployed at a larger scale.</span></span></span></p><p data-key="1eae1ec0cb3a45afb79fea9fc3595fad"><span><span data-key="495705cb79fb4e48bc2ced3b8b343bbc"><span data-offset-key="495705cb79fb4e48bc2ced3b8b343bbc:0">We therefore recommend these best practices or considerations for developers and operators of web servers or other long-running ACME clients at any scale to help reduce load on ACME CAs, increase site availability, decrease operator errors, and improve end user experience.</span></span></span></p><p data-key="bee8d289abaf49e78d97e188acfbceea"><span><span data-key="3446a0e22e824d8784618e869ed93f48"><span data-offset-key="3446a0e22e824d8784618e869ed93f48:0">This document is agnostic of any particular CA or software, but is crafted through experience from various industry, research, and engineering perspectives. It treats ACME operations as expensive and seeks to minimize the number and frequency of them, while maximizing security and availability of sites. Software complexity is a tradeoff worth considering in terms of the needs of a particular deployment.</span></span></span></p><p data-key="57d560ec6bb341abbd541b2880e2a291"><span><span data-key="a44fb14bf9ed4461ae4b5fcbe96493bd"><span data-offset-key="a44fb14bf9ed4461ae4b5fcbe96493bd:0">Keeping a new certificate only in memory is at risk of being lost if the process is terminated. Don't rely on process longevity by storing certificates solely in memory. Write certificates to some persistent storage medium (such as the file system) so that it can be reused even after the process goes down.</span></span></span></p><p data-key="1a0e4507d01f485f88e7aab0bf3e40fc"><span><span data-key="850e2abb2b7546248b05aa96c1190b27"><span data-offset-key="850e2abb2b7546248b05aa96c1190b27:0">Before making any ACME requests, ensure the persistent storage is configured properly and is functional. It is not a bad idea to write something to storage, read it, verify the contents are accurate, then delete it, when the server starts up or when the storage configuration is changed. If this check fails, no ACME operations should be attempted. You may also wish to check for sufficient available space.</span></span></span></p><p data-key="5758bb07a664423ebcb3a74edc3bcb23"><span><span data-key="8b0cf3db867647b6ae1095b7b53e950a"><span data-offset-key="8b0cf3db867647b6ae1095b7b53e950a:0">As a special consideration for running in containers, be sure the storage is actually persistent between container runs; destroying the certificate's storage when the container is destroyed does no good.</span></span></span></p><h2 id="if-a-valid-certificate-already-exists-in-storage-use-that-one-instead-of-obtaining-a-new-one" data-key="44915ac9d6bc4c0d929577d8e2e7552b"><p><span><span data-key="05ce42e6e11141bcad1f15668f7fe584"><span data-offset-key="05ce42e6e11141bcad1f15668f7fe584:0">If a valid certificate already exists in storage, use that one instead of obtaining a new one.</span></span></span><a href="#if-a-valid-certificate-already-exists-in-storage-use-that-one-instead-of-obtaining-a-new-one" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="b10199be4a514dae85a3d8c5c9cf1faa"><span><span data-key="410d5d732d4a4bd498e50001fa779a07"><span data-offset-key="410d5d732d4a4bd498e50001fa779a07:0">A server needing a certificate should always check persistent storage for a usable certificate before requesting a new one with ACME. This reduces load on the CA and will often prevent crippling rate limit issues. It also makes better use of the certificate's full lifetime. Ensure persistent storage is properly secured.</span></span></span></p><p data-key="b22930b020ff44e8b58c5cba581234dc"><span><span data-key="2bb33093f8d64644966c868adb9c593c"><span data-offset-key="2bb33093f8d64644966c868adb9c593c:0">Certificates are usually stored along with their private keys, which are secret. Thus, storage must be properly secured from external access. This often entails properly permissioning the file system and running programs or scripts without extra privileges.</span></span></span></p><h2 id="renew-certificates-after-of-usable-lifetime" data-key="ef1bf9e9565746d9a62a6ba98751126d"><p><span><span data-key="e379c3d288f1403d86b030825da8503a"><span data-offset-key="e379c3d288f1403d86b030825da8503a:0">Renew certificates after ⅔ of usable lifetime.</span></span></span><a href="#renew-certificates-after-of-usable-lifetime" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="9bf2d37e66f74eb09b3c44e18c0f8969"><span><span data-key="75b852dbbb074572a6dea6520375b1b9"><span data-offset-key="75b852dbbb074572a6dea6520375b1b9:0">Renewing a certificate is the single highest-risk ACME procedure because it implies that the future uptime of one or more sites depends on it succeeding before the certificate expires. Because domain validation requires external resources (namely DNS), certificate issuance can be fickle, especially as more time passes from the initial issuance.</span></span></span></p><p data-key="43fca70c1da74c37ab8c88baccaeb1be"><span><span data-key="4699a2631a924927b94be24e788c49f8"><span data-offset-key="4699a2631a924927b94be24e788c49f8:0">Technically, the initial issuance faces the same technical challenges as a renewal, but initial issuances are supervised more often than renewals (though not always) and failures of initial issuance are usually more noticeable by sysadmins, so they are fixed sooner.</span></span></span></p><p data-key="208ab0ecf8f148bfaa5cbf537ab7328c"><span><span data-key="b0dadd317f514276bc7740537df63579"><span data-offset-key="b0dadd317f514276bc7740537df63579:0">The lifetime of a certificate is defined to be the span between its NotBefore and NotAfter dates. The first renewal attempt should be positioned in that window late enough so that as much of the validity window is utilized as possible, but early enough so that there is sufficient time to be made aware of, diagnose, and fix errors before the certificate expires.</span></span></span></p><p data-key="2f599d02028f401491214040f6c3862a"><span><span data-key="605841f115ee48178878f3e38e5e725f"><span data-offset-key="605841f115ee48178878f3e38e5e725f:0">The renewal window is defined as the span of time between the first renewal attempt and the certificate's NotAfter date. A renewal window that is ⅓ of the certificate's lifetime works well in most cases. Expect that alerts may not be replied to on weekends or holidays, and that some problems may take several days to resolve if third parties are involved.</span></span></span></p><p data-key="783edee291bf45eebc950f6406db88f1"><span><span data-key="1d1c3f70284e43ae8c4648dbf8d40c50"><span data-offset-key="1d1c3f70284e43ae8c4648dbf8d40c50:0">As a special consideration when certificate lifetimes are extremely short, a longer renewal window may be preferable to allow more time for troubleshooting before certificates expire; but this will increase load on the CA. When making certificate lifetimes shorter, ACME CAs should expect that the inverse relationship of the ratio of new orders to certificate lifetime is more than linear (i.e. making lifetimes 50% shorter will likely increase orders by more than 50%).</span></span></span></p><p data-key="0c54ad8a89bf4250a20ca76aa750007e"><span><span data-key="3042ecdd5ae64164a0e0ba0b4cb60c5f"><span data-offset-key="3042ecdd5ae64164a0e0ba0b4cb60c5f:0">Examples:</span></span></span></p><ul data-key="27653e71986e44f08adba52de65bb178"><li><p data-key="3cddb25e777c40189b7070ae9bd75193"><span><span data-key="0b4cc5b3965a4cbb94a75825db61a270"><span data-offset-key="0b4cc5b3965a4cbb94a75825db61a270:0">For a 90 day certificate, attempt renewal 30 days before expiration.</span></span></span></p></li><li><p data-key="f0ffe441ebcb4b5dbcb648a8d34cfc94"><span><span data-key="e7ff5be7f5a24e97a49a75223dd6c4d4"><span data-offset-key="e7ff5be7f5a24e97a49a75223dd6c4d4:0">For a 24 hour certificate, attempt renewal 8-12 hours before expiration.</span></span></span></p></li></ul><h2 id="set-up-proper-logging-log-monitoring-and-notifications" data-key="9314c8db9e3f43da9a2bc854986e0ae5"><p><span><span data-key="c0415627b5b341d28df4125062b77820"><span data-offset-key="c0415627b5b341d28df4125062b77820:0">Set up proper logging, log monitoring, and notifications.</span></span></span><a href="#set-up-proper-logging-log-monitoring-and-notifications" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="f33da565845e4cd596b7cd884a1915f9"><span><span data-key="6ee513489dff47198a7731cb2bf5c00b"><span data-offset-key="6ee513489dff47198a7731cb2bf5c00b:0">Logging can be done a number of ways, and it is usually the primary method for becoming aware of problems in long-running processes. System administrators or site owners should be notified as soon as possible if there are issues validating their domain name(s).</span></span></span></p><p data-key="e7ebc1533e2e4712b77e1b5424776a8f"><span><span data-key="273de87deec74faabd23d8febfc0c474"><span data-offset-key="273de87deec74faabd23d8febfc0c474:0">Log entries should be classified by level (e.g. debug, info, warning, error), and administrators should be notified or alerted (email, push, or other reliable messaging mechanisms) if error-level logs are emitted.</span></span></span></p><p data-key="e978e9f0fc654639bfd8042567abece7"><span><span data-key="3051956c48de4a65bfdc478bcdca019d"><span data-offset-key="3051956c48de4a65bfdc478bcdca019d:0">Classifying log entries is not always obvious. For example, what should be classified as an error? Usually, error level entries should generate alerts, and warnings out of certain tolerances should generate alerts or produce an error. Thinking about log levels in terms of alerts and review/analysis will help guide log level decisions.</span></span></span></p><p data-key="754397e54f104294acca6a67050f13b8"><span><span data-key="61aeee0290f94925a208da1240868318"><span data-offset-key="61aeee0290f94925a208da1240868318:0">For example, a failure due to badNonce that gets retried shouldn't generate an alert. But if multiple renewal attempts fail, an alert should be generated. Similarly, generating excess ACME traffic for a very short time might be a warning, but generating much more traffic than the average in the last N minutes should be alerted.</span></span></span></p><p data-key="9f814ba88c164b09bfceec95ee092471"><span><span data-key="7daddb747bf847c19651ce9240ce4bbd"><span data-offset-key="7daddb747bf847c19651ce9240ce4bbd:0">Alerts should have minimal false positives. Return structured error values and write structured logs when possible so that notifications can be sent only when there is an error that requires your attention.</span></span></span></p><h2 id="emit-logs-liberally" data-key="7ab886237f4f49d7adab783bf22077ba"><p><span><span data-key="a9bd610fa2ea441492048a84adcb68c9"><span data-offset-key="a9bd610fa2ea441492048a84adcb68c9:0">Emit logs liberally.</span></span></span><a href="#emit-logs-liberally" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="36fc40a67b054d3f836ff414fdf0cd0d"><span><span data-key="5b4ff49f78ee4b27b515c73e36de0b87"><span data-offset-key="5b4ff49f78ee4b27b515c73e36de0b87:0">Keep detailed logs of all automation procedures for at least 2-3 times the lifetime of the certificates. This makes it possible to observe and analyze behavior before errors started occurring and compare it to the problematic behavior.</span></span></span></p><p data-key="f3b9ef360f0c4ca9b986580ff7628e10"><span><span data-key="23c07f5a58114251b436698475226f15"><span data-offset-key="23c07f5a58114251b436698475226f15:0">Some important things to include in logs are:</span></span></span></p><ul data-key="260cdf0a977042f8ab849703636a0d39"><li><p data-key="f90d03b25fda49559ff602de7e0b6dea"><span><span data-key="f95d674935f54489a09d887053194338"><span data-offset-key="f95d674935f54489a09d887053194338:0">When maintenance is beginning/ending</span></span></span></p></li><li><p data-key="4c39be25bb884d95a73b4110cb669cb1"><span><span data-key="a1fe46a2be8c46de8755bbe1cd800d05"><span data-offset-key="a1fe46a2be8c46de8755bbe1cd800d05:0">Which names are being maintained</span></span></span></p></li><li><p data-key="df03127a750c4ee297d61aadd46fc069"><span><span data-key="06cb9e0ae8314febb4f06e2478dcb11b"><span data-offset-key="06cb9e0ae8314febb4f06e2478dcb11b:0">Expiration status of certificates in the renewal window</span></span></span></p></li><li><p data-key="27037616ae2941289e5360f95fda2e20"><span><span data-key="ffc59154a456461c92f697a72860adb5"><span data-offset-key="ffc59154a456461c92f697a72860adb5:0">Each ACME HTTP request (method, URL, response code, and maybe payload in dev/debugging scenarios)</span></span></span></p></li><li><p data-key="4384b12eb71d4fa890d485f14145f48b"><span><span data-key="34a703226a594bb088cdf4b4817b6543"><span data-offset-key="34a703226a594bb088cdf4b4817b6543:0">When OCSP staples are updated, and for which names</span></span></span></p></li><li><p data-key="8f28d26f1d6148a49288e7e7fce8254e"><span><span data-key="20ab534cd2fc4eba977cd139b3960194"><span data-offset-key="20ab534cd2fc4eba977cd139b3960194:0">Authz and Order URLs and associated timestamps</span></span></span></p></li><li><p data-key="a0b22fc8cc0b4910b0805029c519c1ac"><span><span data-key="914a1708b43b47439874cb4875b9f1eb"><span data-offset-key="914a1708b43b47439874cb4875b9f1eb:0">Full error information including detail message and context</span></span></span></p></li><li><p data-key="105839de7fd749318a34f12458f201b6"><span><span data-key="f047b44299c145d0be03ac2df4fc7908"><span data-offset-key="f047b44299c145d0be03ac2df4fc7908:0">Any changes to loaded certificates</span></span></span></p></li></ul><p data-key="a17f324d1644406eb951e0886ea7f66d"><span><span data-key="83c86643c4b4430ab2c90f6652f71daf"><span data-offset-key="83c86643c4b4430ab2c90f6652f71daf:0">Logs should be structured so that only necessary and relevant notifications can be sent. If notifications are sent for unactionable errors, they will tend to be ignored. Parsing errors by substring matching should be avoided so as to not overfit the matching logic to one particular software's error messages.</span></span></span></p><h2 id="limit-the-scope-of-user-configuration-and-choose-good-defaults-for-the-maintenance-interval-and-renewal-window" data-key="117ab01cfc504399bd7cc18b65816925"><p><span><span data-key="8b5e450612a54d4e8910a23f877bf98e"><span data-offset-key="8b5e450612a54d4e8910a23f877bf98e:0">Limit the scope of user configuration and choose good defaults for the maintenance interval and renewal window.</span></span></span><a href="#limit-the-scope-of-user-configuration-and-choose-good-defaults-for-the-maintenance-interval-and-renewal-window" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="0df4346175484734ac5d60968abcb2ed"><span><span data-key="8a348c09bc4f4881aad31a33d74c687c"><span data-offset-key="8a348c09bc4f4881aad31a33d74c687c:0">There are many parameters involved with long-term certificate automation. While some should be user-configurable, most should not be. Always choose reasonable defaults that are conservative and which encourage good practices and broad interoperability.</span></span></span></p><p data-key="71ffffc8001543dda743c56042a06617"><span><span data-key="6ee80fbd23ba42a4926afd3f7ac4c92a"><span data-offset-key="6ee80fbd23ba42a4926afd3f7ac4c92a:0">The certificate maintenance interval and renewal window in particular are crucial parameters. They are affected by certificate lifetimes, which are usually out of the control of the ACME client, so they should probably be user-configurable. To properly eliminate this configuration surface, the software would need to assess the lifetimes of certificates it is currently managing and determine the ideal maintenance interval and renewal window on-the-fly. Further, certificate lifetimes may shift while the process is running. Although it is not ideal to expose these parameters for configuration due to the high chance of user error, the cost required to compute them dynamically may be even higher.</span></span></span></p><p data-key="1dd6b65684944975a503764613ad5f85"><span><span data-key="3d0ee71af4344e2a9f675d179913a09c"><span data-offset-key="3d0ee71af4344e2a9f675d179913a09c:0">In general, try to reduce the surface area for user configuration, but not at the unreasonable cost of excess software complexity.</span></span></span></p><h2 id="use-one-name-per-certificate" data-key="9c63652fdc754a16b7838f4c35438fdd"><p><span><span data-key="849c16d5f4a84a23a7c4bd34ec6f836b"><span data-offset-key="849c16d5f4a84a23a7c4bd34ec6f836b:0">Use one name per certificate.</span></span></span><a href="#use-one-name-per-certificate" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="7894dfd40e9049f6ba206442ed435bb1"><span><span data-key="c3ad3b3bcd8b4dcc8a0140a8c032b7a7"><span data-offset-key="c3ad3b3bcd8b4dcc8a0140a8c032b7a7:0">X.509v3 certificates can use extensions, one of which is Subject Alternative Name (SAN). The client provides a list of names to be validated when requesting a certificate, and the names which are validated by the CA are added as SANs.</span></span></span></p><p data-key="68da7509636c48b795d1f74065cc5bea"><span><span data-key="23f3b9cec2564ceeac7e6a470b054cc7"><span data-offset-key="23f3b9cec2564ceeac7e6a470b054cc7:0">Although it is possible to map many names to one certificate (M:1), a one-to-one (1:1) mapping is recommended. 1:1 is easy to manage, less error-prone, reduces failures at scale, reduces the impact of revocation, and speeds up certificate maintenance. It also can enhance security since each certificate can use a different private key; thus if one key is compromised, the security of connections to the other sites is not automatically compromised as well. The only notable downside is that it may use more storage space since you will have more certificates.</span></span></span></p><p data-key="b917ec770f0243e59b2fdef510a2d502"><span><span data-key="0503141a6d62493cba6058c210f72d56"><span data-offset-key="0503141a6d62493cba6058c210f72d56:0">M:1 might be required if:</span></span></span></p><ul data-key="04669bd503bc41d98ee9c1eb1547b441"><li><p data-key="af17818d139a432f8712cc18e0abeac4"><span><span data-key="3abcd629033e447183cecbd0745bc3dc"><span data-offset-key="3abcd629033e447183cecbd0745bc3dc:0">Storage space is extremely limited (unlikely, because storage is cheap).</span></span></span></p></li><li><p data-key="b4b29be3b4a1462fa9aa2c88290329a5"><span><span data-key="8442fb0c4bba4da59a1d7a0dd471fd62"><span data-offset-key="8442fb0c4bba4da59a1d7a0dd471fd62:0">The web host / service provider charges for certificates and you need to reduce that cost.</span></span></span></p></li><li><p data-key="ae56c58af47c46d48bd3d056920d13b7"><span><span data-key="eb9b548082ef46c0a805ef87dea65ee3"><span data-offset-key="eb9b548082ef46c0a805ef87dea65ee3:0">You need to manage fewer certificates due to CA-enforced rate limits.</span></span></span></p></li><li><p data-key="2a71dbb554f741f0af78ce969f2eb24d"><span><span data-key="3f61af5771af47fabeb93a601573fd05"><span data-offset-key="3f61af5771af47fabeb93a601573fd05:0">Your server software only allows one certificate per virtual host, and the virtual host serves multiple domains.</span></span></span></p></li></ul><p data-key="86c8c66eb9ba41dd91aab9de4f884716"><span><span data-key="8134c6e4b40046de8d404cb07ba9873f"><span data-offset-key="8134c6e4b40046de8d404cb07ba9873f:0">Using M:1 has little benefit in automated settings, complicates the addition and removal of names, slows down certificate issuance, and increases the chance of validation errors. There will be greater logical and operational complexity by combining many names onto one certificate. In addition, all those names necessarily share a single private key, so if one key is lost, all those sites need a new certificate with a different key. Multi-SAN certificates also have a larger size, so they slow down TLS handshakes.</span></span></span></p><p data-key="69fd8c6799fd45328f5ed4f938e57ec4"><span><span data-key="59dd6b38d59c47eda95f97779b9ae9ac"><span data-offset-key="59dd6b38d59c47eda95f97779b9ae9ac:0">If a single web server or cluster of servers is handling all subdomains of a single registered domain, it is often better to use and manage a single wildcard certificate. With Let’s Encrypt, this implies configuring the ACME DNS challenge, which requires control over the DNS for the registered domain. Managing certificates for many subdomains of the same registered domain without control over the DNS is not recommended.</span></span></span></p><h2 id="staple-ocsp-responses-to-certificates" data-key="0dacac7f64014e4185029ce87b80ca65"><p><span><span data-key="8c5af5de66804249878cb538e34e6c19"><span data-offset-key="8c5af5de66804249878cb538e34e6c19:0">Staple OCSP responses to certificates.</span></span></span><a href="#staple-ocsp-responses-to-certificates" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="0ba05c219bf14da0942ca7531a44483f"><span><span data-key="2d06558850b440d88536a7cfdcbda957"><span data-offset-key="2d06558850b440d88536a7cfdcbda957:0">OCSP responses should be stapled to certificates by the web server to reduce the burden on OCSP responders and to increase client performance by reducing connection latency. Stapling OCSP to certificates also enhances client privacy because the clients will not need to ask a third-party at connection-time whether to trust a specific certificate.</span></span></span></p><p data-key="c4e2bd6df88f44719af4894eb5e69d4b"><span><span data-key="779efe156e1744229342e3d2192b32e5"><span data-offset-key="779efe156e1744229342e3d2192b32e5:0">Some top tips for stapling OCSP properly can be found here: </span></span><a href="https://gist.github.com/sleevi/5efe9ef98961ecfb4da8" target="_blank" rel="noopener noreferrer" data-key="b3a1542da97d4ffcb0ab37ed9346fa45"><span data-key="15834927362f4b61ad4e7efc6b51e419"><span data-offset-key="15834927362f4b61ad4e7efc6b51e419:0">https://gist.github.com/sleevi/5efe9ef98961ecfb4da8</span></span></a><span data-key="14297fc53c684bf4990701638afaa4f7"><span data-offset-key="14297fc53c684bf4990701638afaa4f7:0"><span data-slate-zero-width="z">​</span></span></span></span></p><p data-key="c34e536539e54af7b4a344a61ea84871"><span><span data-key="6c1d94bef6444540ac0ab1e975c6b327"><span data-offset-key="6c1d94bef6444540ac0ab1e975c6b327:0">When updating a batch of OCSP statuses, be careful not to slam OCSP responders. How critical this is depends on whether the OCSP responder is behind a CDN, and if so, whether the subscriber sites are frequently visited by many clients or not. Frequently-visited sites will have their OCSP responses cached by the CDN, so throttling here is less critical; for other sites, throttling is encouraged. Spread requests out as evenly as possible.</span></span></span></p><h2 id="pay-attention-to-ocsp-status" data-key="eaa1cb1234c4449e894251aba29f7ed5"><p><span><span data-key="86656e7d3c584ff2963e85a2bfbe9c8a"><span data-offset-key="86656e7d3c584ff2963e85a2bfbe9c8a:0">Pay attention to OCSP status.</span></span></span><a href="#pay-attention-to-ocsp-status" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="8385e71bcc1d4702b742a2e22caf4169"><span><span data-key="29aca6a4589b44a7a3985b3dd29423d3"><span data-offset-key="29aca6a4589b44a7a3985b3dd29423d3:0">If a signed OCSP update shows that a managed certificate is Revoked, it is recommended to try replacing the certificate with a new one immediately. However, client software should be careful about being too presumptuous about the reason for the revocation. For example, revocation does not necessarily mean that the key was compromised. Clients should check the revocationReason field of an OCSP response and take the best corrective action. Sometimes, CAs will blacklist names or keys from obtaining new certificates after a revocation, so clients should not be aggressive when replacing revoked certific ates.</span></span></span></p><h2 id="on-demand-tls" data-key="50dd3152192b4143a5554c1142fa76d9"><p><span><span data-key="8e58b710c2ff4dab87eb40d573d1da89"><span data-offset-key="8e58b710c2ff4dab87eb40d573d1da89:0">On-Demand TLS</span></span></span><a href="#on-demand-tls" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="66c2affbc1b64337a1ebea3dfc7284fd"><span><span data-key="1365cf38961346b0bb776d08adf8f931"><span data-offset-key="1365cf38961346b0bb776d08adf8f931:0"><span data-slate-zero-width="z">​</span></span></span><a href="https://caddyserver.com/docs/automatic-https#on-demand" target="_blank" rel="noopener noreferrer" data-key="49659871da134532a8c753462b90253e"><span data-key="9a3ada7ad89f48a2bfef521b1b5455ec"><span data-offset-key="9a3ada7ad89f48a2bfef521b1b5455ec:0">On-Demand TLS</span></span></a><span data-key="7b8699ad82744d6b8d33e9b372514152"><span data-offset-key="7b8699ad82744d6b8d33e9b372514152:0"> is a term coined by </span></span><a href="https://github.com/caddyserver/caddy" target="_blank" rel="noopener noreferrer" data-key="586deb9793ea4799a47412b296b3bce7"><span data-key="f12f8273283d49ab97ab3ba834c25765"><span data-offset-key="f12f8273283d49ab97ab3ba834c25765:0">the Caddy project</span></span></a><span data-key="b15103c12a384746ab2a803bfd0a02a6"><span data-offset-key="b15103c12a384746ab2a803bfd0a02a6:0"> for managing certificates at handshake-time (foreground) rather than in the background. This is useful when managing certificates for a large and varying number of domains that are not known before-hand, without needing to modify the server configuration each time a domain is added or removed.</span></span></span></p><p data-key="bf3c2244a08f49edbafcfb73073369a3"><span><span data-key="0302146ef3244127be6e3eb89cc5819c"><span data-offset-key="0302146ef3244127be6e3eb89cc5819c:0">It works by checking the ServerName (SNI) value sent by the client against a whitelist when a ClientHello is received for a ServerName that the server does not yet have a certificate for. If the ServerName is allowed, the server initiates an ACME order to obtain a certificate for it, and immediately serves it to the client during the same TLS handshake, while also storing it and caching it for future use.</span></span></span></p><p data-key="a8bb465aecc04754be9a5650729aeb5b"><span><span data-key="73f0fdb3d9704ef9b9a777448c995fc6"><span data-offset-key="73f0fdb3d9704ef9b9a777448c995fc6:0">Instead of adjusting the server's configuration each time the whitelist of recognized domains changes, the server is provided a single static configuration so it can "ask" whether it is allowed to manage the certificate for a given name.</span></span></span></p><p data-key="17e9d97bef594aeabe2650b85f02ba41"><span><span data-key="69f344e6cac64cf4a22dea01f14ce21c"><span data-offset-key="69f344e6cac64cf4a22dea01f14ce21c:0">On-Demand TLS is only practical if the CA can issue a certificate for a name quickly enough so that the TLS handshake can continue. It is OK to add some latency to a TLS handshake, but it should not be used if a TLS handshake needs to be aborted and the client needs to retry later after the certificate is obtained.</span></span></span></p><p data-key="196b13d8e02446e49b5c4f9b587175d1"><span><span data-key="a8f55eef2bec431fb33edcd429ec9e00"><span data-offset-key="a8f55eef2bec431fb33edcd429ec9e00:0">In contrast to processing a huge list of domain names all at once, On-Demand TLS is generally less prone to bulk ACME operations since they are only done "as needed," however, error handling and the potential for a thundering herd must be given special consideration.</span></span></span></p><p data-key="c48ae765415a41dba42510e26d7a3e51"><span><span data-key="50c25582f05b4a7989d3fb2360b07f84"><span data-offset-key="50c25582f05b4a7989d3fb2360b07f84:0">As with background management, foreground management should be synchronized to avoid a thundering herd: only one TLS handshake should initiate an ACME transaction; other handshakes with the same ServerName should wait until that transaction completes and then share the resulting certificate.</span></span></span></p><p data-key="04d89449bd9348719720dd42fcdbb8d1"><span><span data-key="a1d138c9abfc49ef8dbb648745384938"><span data-offset-key="a1d138c9abfc49ef8dbb648745384938:0">Additional internal throttling may be required to temper dynamic pressure on the CA. If limits are reached, TLS handshakes may not be able to be completed. If a thundering herd can be predicted, ACME operations should begin early and be spread out, with exponential backoff implemented as part of error handling and retries.</span></span></span></p><p data-key="bcedb163bcb24d87b1c357a2f37e5c9b"><span><span data-key="d27181c392194271b599a53f2eaba25f"><span data-offset-key="d27181c392194271b599a53f2eaba25f:0">One easy way to ensure throttling is to have a global lock that makes ACME transactions mutually exclusive. Performing only one ACME transaction at a time is a great threat, simple throttle, but is not complete by itself: errors can cause an ACME transaction to abort immediately, so timer-based throttling (e.g. exponential backoff) is still necessary. Also, be aware that solving an ACME challenge can sometimes take an impractical amount of time (hours -- this is not too uncommon with some DNS providers), which can lead to denial-of-service if all other TLS handshakes are blocked on DNS propagation, for example.</span></span></span></p><p data-key="3f5846f2b66842faa6b010fd76f3d0c7"><span><span data-key="b8cb19cb8d7a4ab5a806cfffbaaa99f9"><span data-offset-key="b8cb19cb8d7a4ab5a806cfffbaaa99f9:0">It is often important to keep the growth of the in-memory certificate cache under control with On-Demand TLS. When to add certificates to the cache is obvious, but when to evict them is less so. Since On-demand TLS makes the long-term utility/need of a particular certificate implicit instead of explicit, there are at least two possible eviction policies to consider:</span></span></span></p><ol data-key="3165965323da46b38f0dc9e8621f614e"><li><p data-key="88de0d0e1a4b4d838f347d5a81f055ad"><span><span data-key="ba2d096897f54ad98bdba3fb5a977adf"><span data-offset-key="ba2d096897f54ad98bdba3fb5a977adf:0">Renew expiring certificates only in the foreground (during handshakes that use it). Evict in the background after certificate expires. This is like LRU.</span></span></span></p></li><li><p data-key="702ee290b77d4edb914faf1bc44d8972"><span><span data-key="881a099188ed48eb8f3526f08d13196c"><span data-offset-key="881a099188ed48eb8f3526f08d13196c:0">Renew expiring certificates in the background. If renewal fails (repeatedly), evict.</span></span></span></p></li></ol><p data-key="82f5aedd6ff749a5b5dacc376ca7a397"><span><span data-key="e091d297d89c4b0c8a2695e7bca2c2aa"><span data-offset-key="e091d297d89c4b0c8a2695e7bca2c2aa:0">Clients, and the ServerName values they send, are untrusted. Never allow arbitrary clients to initiate ACME operations indiscriminately. Always have some trusted authority (such as a whitelist) filter client requests to determine what is allowed. Failure to do this could lead to unique DoS attacks.</span></span></span></p><h2 id="avoid-using-a-production-ca-endpoint-while-testing-or-developing" data-key="14cbddec711e42509bcd768ad6657c36"><p><span><span data-key="d4577d49aa014073bd92651752e2fef5"><span data-offset-key="d4577d49aa014073bd92651752e2fef5:0">Avoid using a production CA endpoint while testing or developing.</span></span></span><a href="#avoid-using-a-production-ca-endpoint-while-testing-or-developing" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="eb631f7e5ea0491396ca1cc7799ccaa1"><span><span data-key="c2bcf6c1a9214f5ca4d69b323fe39d78"><span data-offset-key="c2bcf6c1a9214f5ca4d69b323fe39d78:0">Production CA endpoints, especially public endpoints, are often rate-limited. Never use these while testing configuration, experimenting to see if everything is set up correctly, or developing your site/project. Frivolous production testing can significantly stress shared PKI/CT infrastructure.</span></span></span></p><p data-key="da67454b75554787a17ab3e719ba6e97"><span><span data-key="0c8075e758b6479c9cf48c6dc6c747aa"><span data-offset-key="0c8075e758b6479c9cf48c6dc6c747aa:0">Use a staging or local ACME endpoint instead.</span></span></span></p><p data-key="2070903a45f745b883dd498fa226dcec"><span><span data-key="2e9e566416824fd3b899f1d896550ace"><span data-offset-key="2e9e566416824fd3b899f1d896550ace:0">For example, Let's Encrypt has a staging endpoint documented here: </span></span><a href="https://letsencrypt.org/docs/staging-environment/" target="_blank" rel="noopener noreferrer" data-key="bfe8f3d243414fc29b2280bddd4a04b4"><span data-key="b51f1f25196447ffab4847267aed53c8"><span data-offset-key="b51f1f25196447ffab4847267aed53c8:0">https://letsencrypt.org/docs/staging-environment/</span></span></a><span data-key="72ebcf0366de4a9797ada6d8c1bc0211"><span data-offset-key="72ebcf0366de4a9797ada6d8c1bc0211:0"> - be sure to treat this endpoint with respect, however, as it consumes real resources and still has rate limits.</span></span></span></p><p data-key="0d9faecbdb9b4116becd62c53ce022ce"><span><span data-key="d781810739144eb4a58d9e1585afd0e0"><span data-offset-key="d781810739144eb4a58d9e1585afd0e0:0">For extensive testing and development, it is even better to set up a local ACME server before transitioning to a public staging endpoint and then finally a production endpoint.</span></span></span></p><p data-key="314efd7d59c94aeab1794fcc37b784de"><span><span data-key="83dbad5e1e51455aad2282f505362ac4"><span data-offset-key="83dbad5e1e51455aad2282f505362ac4:0">These projects may be used to stand up a local ACME server:</span></span></span></p><ul data-key="1ca8ca6649de44ee8d06002775091837"><li></li><li></li><li></li></ul><h2 id="retry-failed-acme-operations-but-gently" data-key="ea50cf59d44140709e5ab02a32b8f5c1"><p><span><span data-key="1b84d1726a4c4ba68c60fadcf955794c"><span data-offset-key="1b84d1726a4c4ba68c60fadcf955794c:0">Retry failed ACME operations, but gently.</span></span></span><a href="#retry-failed-acme-operations-but-gently" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="86ed574f3e1045d8abfb4b741f7e3c6f"><span><span data-key="50b9d99828ab49f19d8e00393787e366"><span data-offset-key="50b9d99828ab49f19d8e00393787e366:0">It is not uncommon for network transactions to intermittently fail. It is worth retrying ACME operations with exponential backoff between attempts and a maximum cap on the interval at about one order of magnitude less than the certificate lifetime. For example, if a certificate lives 90 days, you might retry a failed renewal after one minute, then after 10 minutes, then after 1 hour, then after 1 day, but with no more than 1 day between attempts. If there is no cap on the interval, there may not be enough retris to reliably renew the certificate in time.</span></span></span></p><p data-key="3dc771b1cda14405981d2c8c0bfef387"><span><span data-key="5984c8c47bcf4457b5a87349b89b11db"><span data-offset-key="5984c8c47bcf4457b5a87349b89b11db:0">A small random variance in the exact spacing of attempts helps avoid thundering herds, and is ideal for relieving load on CAs.</span></span></span></p><p data-key="20a27901112e4a9bad30c2b05f05a11b"><span><span data-key="8c2ae6c741444d2797a208192ac8dd72"><span data-offset-key="8c2ae6c741444d2797a208192ac8dd72:0">If possible, avoid using </span><span data-offset-key="8c2ae6c741444d2797a208192ac8dd72:1"><code spellcheck="false" data-slate-leaf="true">goto</code></span><span data-offset-key="8c2ae6c741444d2797a208192ac8dd72:2"> statements or naked </span><span data-offset-key="8c2ae6c741444d2797a208192ac8dd72:3"><code spellcheck="false" data-slate-leaf="true">for</code></span><span data-offset-key="8c2ae6c741444d2797a208192ac8dd72:4"> loops; they are prone to looping bugs. Instead, us a loop counter like </span><span data-offset-key="8c2ae6c741444d2797a208192ac8dd72:5"><code spellcheck="false" data-slate-leaf="true">for i:= 0; i &lt; 3; i++</code></span><span data-offset-key="8c2ae6c741444d2797a208192ac8dd72:6">.</span></span></span></p><p data-key="331d8854fa654e07a7b5f21d96188c2d"><span><span data-key="7255d6a6de914ccc9d9566fed026ac32"><span data-offset-key="7255d6a6de914ccc9d9566fed026ac32:0">Consider writing errors with their timestamps to persistent storage so that exponential backoff can be resumed after process restarts. This is especially important in accidental tight restart loops.</span></span></span></p><h2 id="certificate-management-features-should-be-embedded-within-the-application-using-the-certificates" data-key="529890b3a8ec473182e0d7471ec85290"><p><span><span data-key="0e278e17578f44ac8523a85d73d93ca7"><span data-offset-key="0e278e17578f44ac8523a85d73d93ca7:0">Certificate management features should be embedded within the application using the certificates.</span></span></span><a href="#certificate-management-features-should-be-embedded-within-the-application-using-the-certificates" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="b19f3093654c4159bb735edf09b75074"><span><span data-key="4a555ddf0464460d8a38387f71ffc046"><span data-offset-key="4a555ddf0464460d8a38387f71ffc046:0">Because certificate maintenance is a long-running process, it is best for its functionality to live close to the application, rather than being more exposed to a countless number of external changes to the system or environment.</span></span></span></p><p data-key="8f23e9ed1b284551b00bffe036705f98"><span><span data-key="9d25e3b3f0d34834a538bc869f69799d"><span data-offset-key="9d25e3b3f0d34834a538bc869f69799d:0">Experience has shown that separate processes, scripts, and other "moving parts" considerably raises error surface. It is recommended that certificate management features be made available as dedicated, specialized libraries which are directly embeddable into the applications which need it, rather than trying to hack various scripts, utilities, and dependencies together to form a working whole.</span></span></span></p><p data-key="facb1df90999446fb276821cbadd6ba3"><span><span data-key="4304a25125fe4d07af57347a02e5302d"><span data-offset-key="4304a25125fe4d07af57347a02e5302d:0">However, if there is an external ACME tool or program (such as an ACME-enabled reverse proxy) that is vastly more capable, reliable, or robust than available embeddable libraries, it is probably better to use the external tool.</span></span></span></p><p data-key="d65a5d49d31244c7b0d9e5477f10d531"><span><span data-key="e75878406e694cbeb5a7638bc891bf7a"><span data-offset-key="e75878406e694cbeb5a7638bc891bf7a:0">Because ACME already relies on external resources to succeed, the goal here is to reduce that reliance on external systems as much as possible.</span></span></span></p><h2 id="schedule-background-certificate-maintenance" data-key="6900c823141f49cb898d22adb12b616b"><p><span><span data-key="1fbbcf6afafa42a487270c1c5976615a"><span data-offset-key="1fbbcf6afafa42a487270c1c5976615a:0">Schedule background certificate maintenance.</span></span></span><a href="#schedule-background-certificate-maintenance" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="95a3bf32113741798855f5c5568a52e6"><span><span data-key="e8c7703b37824daab1cc8219d49cdefa"><span data-offset-key="e8c7703b37824daab1cc8219d49cdefa:0">Certificates expire, so they will need to be renewed for continued use. "Renewal" actually means replacing the certificate with a new one that has a later NotAfter date. These renewals should happen in the background well before expiration. There are a few ways to go about this.</span></span></span></p><p data-key="7daabbb28e5c436294ef136bc8d8dd68"><span><span data-key="ea87a14de0914751a24b39498a6db1f0"><span data-offset-key="ea87a14de0914751a24b39498a6db1f0:0">The simplest approach is to scan the certificate cache/storage on a regular interval; any certificates that are expiring "soon" enter a renewal window and get renewed immediately, before the next interval. One nice thing about this method is that if a renewal fails (even after retries), it can be skipped and tried again at the next scan without any extra complexity. Scans should be inexpensive, so the interval can be somewhat frequent as long as the number of certificates is tractable.</span></span></span></p><p data-key="b0432d114ec24a6a8b5ec4db996f19b7"><span><span data-key="01e39c08ca5f435f9d57986dea5e1aa9"><span data-offset-key="01e39c08ca5f435f9d57986dea5e1aa9:0">The maintenance interval must be at least one order of magnitude less than the minimum certificate lifetime. Ideally, there would be at least 10 intervals during any certificate's validity period in case retries are necessary. "Very frequent" intervals are on the order of every few seconds to a minute. With longer certificate lifetimes, it is OK for intervals to be on the order of several hours.</span></span></span></p><p data-key="4c79a9a04df44c47876bdd3b9c433501"><span><span data-key="006137a9600c4af3b10aea3868903ad4"><span data-offset-key="006137a9600c4af3b10aea3868903ad4:0">A more complex but flexible approach is to individually schedule each certificate's next maintenance operation based on its status and lifetime. This avoids scanning needlessly at regular intervals since the time for each certificate's maintenance is individually scheduled. It also plays well with certificates of varying lifetimes. However, this method also requires more resources and must be able to gracefully reschedule each operation based on whether it succeeded or failed.</span></span></span></p><p data-key="38e8ffc3fe0643ee8b5c05bdeb22e87e"><span><span data-key="fb5e9df37c4e416eba25e12098287451"><span data-offset-key="fb5e9df37c4e416eba25e12098287451:0">Regardless of the method you choose, it is crucial to inject some randomness into the timing of the operations. If all clients try to renew certificates at a certain time, it could overwhelm the CA. For example, avoid setting cron jobs to run at a fixed time.</span></span></span></p><h2 id="do-not-rely-on-pre-validation-checks" data-key="f9933f4b4cb24e4582578757f0fdd1a5"><p><span><span data-key="f32595fd5a424de7a2ea03f7754311bb"><span data-offset-key="f32595fd5a424de7a2ea03f7754311bb:0">Do not rely on pre-validation checks.</span></span></span><a href="#do-not-rely-on-pre-validation-checks" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="5c88ee578bae40e18a87c3d823e22521"><span><span data-key="5013be343c154364961d85c4cbab90dc"><span data-offset-key="5013be343c154364961d85c4cbab90dc:0">Pre-validation checks are automated checks that attempt to determine if an ACME challenge will succeed or fail before proceeding with the actual challenge.</span></span></span></p><p data-key="d3093aa496424df9b3a8a7c48ed80abd"><span><span data-key="d6f25545024f4d25ac7847d735ebdd3d"><span data-offset-key="d6f25545024f4d25ac7847d735ebdd3d:0">In practice, these do not work very well for public domains.</span></span></span></p><p data-key="fe346d2635eb4d978481754bdf9f03a8"><span><span data-key="a4c53d0471f24dcbaa8d01a39a7daa75"><span data-offset-key="a4c53d0471f24dcbaa8d01a39a7daa75:0">It can be difficult to know whether an ACME challenge will succeed. Successful validations require one or more external lookups/connections on infrastructure that depends on the machine's perspective. For example, DNS lookups from the ACME client often result in different records than what the ACME server will see. External connections are difficult or impossible to reliably test internally.</span></span></span></p><p data-key="a089471c53184bb4adcf1a9df556ad6e"><span><span data-key="44e786bcff8846aea4aee0c995275349"><span data-offset-key="44e786bcff8846aea4aee0c995275349:0">It is not advisable to use a public CA's staging endpoint as a "pre-check" for all certificate issuances, as this would add considerable load at a global scale. However, it is not a bad idea to stand up one's own external ACME server for pre-checks, with the understanding that its result may not match the real ACME server's validation.</span></span></span></p><p data-key="143a023797664d5ebcfbf2bb28166e36"><span><span data-key="aadcd33b6aee4f198314cfedf2ae384a"><span data-offset-key="aadcd33b6aee4f198314cfedf2ae384a:0">So far, pre-validation checks are often inaccurate and seldom worth the effort; however, it is possible that better techniques may arise in the future.</span></span></span></p><p data-key="58ec28a70fb54d7db7eff2cbb0f5e412"><span><span data-key="14c72ca3df28428d8588164387542b77"><span data-offset-key="14c72ca3df28428d8588164387542b77:0">In the meantime, the best way to know whether a challenge will succeed is simply to try it. Before doing so, where possible, a human administrator should ensure that DNS and firewalls are properly configured. (Production ACME endpoints are not to be used for debugging or troubleshooting.)</span></span></span></p><h2 id="use-all-enabled-challenge-types" data-key="3b9681b7540a4679b7fccf06e0372748"><p><span><span data-key="092bae5e3eed4aa78bc056222fcc3f0f"><span data-offset-key="092bae5e3eed4aa78bc056222fcc3f0f:0">Use all enabled challenge types.</span></span></span><a href="#use-all-enabled-challenge-types" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="713fa18c4e9a41d5a789eabf674e4281"><span><span data-key="22ab8ca313d94841a455c74f6f4a8b68"><span data-offset-key="22ab8ca313d94841a455c74f6f4a8b68:0">Being issued a certificate is conditional upon solving one of the ACME challenges. The more challenge types that are enabled, the better. If one challenge fails, another may be tried instead.</span></span></span></p><p data-key="716d5cb112ff4205b7484d98391279a1"><span><span data-key="ae6028d857f24d0e98c4775905dbf8c5"><span data-offset-key="ae6028d857f24d0e98c4775905dbf8c5:0">It is strongly encouraged to enable both the HTTP and TLS-ALPN challenges by default if the server can accept external connections on those ports. If one challenge fails, it is highly recommended to failover and try the other one before giving up. We have seen real cases in the wild with both large and small deployments where simply trying another challenge type kept sites online where they would have otherwise gone down. This is an easy fix with a large benefit.</span></span></span></p><p data-key="a0f41483460f40e880b0cad5d5527251"><span><span data-key="3c5ca429b7c34bd19a40fbd13a2056dc"><span data-offset-key="3c5ca429b7c34bd19a40fbd13a2056dc:0">The DNS challenge is a special case. It requires explicit configuration and is usually only enabled when it is known that the HTTP and TLS-ALPN challenges will not work (for instance, if external connections are rejected), or if wildcard certificates are required. If the DNS challenge is configured, it is unlikely that using the HTTP or TLS-ALPN challenges will be successful, but this depends on the scenario.</span></span></span></p><h2 id="dont-use-muststaple-by-default" data-key="10f85a11f6704c99b95a0dcdb9b89d40"><p><span><span data-key="3f51a1a9a15b438a97b699a5ebd44343"><span data-offset-key="3f51a1a9a15b438a97b699a5ebd44343:0">Don't use MustStaple by default.</span></span></span><a href="#dont-use-muststaple-by-default" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="6bcf88b7281547f5b72ff7d5ae790ef8"><span><span data-key="2bb678021d38496ab2cfa548bed39b14"><span data-offset-key="2bb678021d38496ab2cfa548bed39b14:0">Use of OCSP MustStaple has potentially serious consequences that the system administrator should judge before enabling it. Because clients honoring MustStaple require a valid OCSP staple on a served certificate, failure of the server to properly obtain, store, and update OCSP staples can render sites unavailable. Historically, server implementations of OCSP stapling have been fickle, or at best, easy to misconfigure; and certificate revocation as a whole system has several weaknesses at scale. For these reasons, it is advisable to make MustStaple exclusively opt-in, and only after understanding the implications. Site owners should also consider their individual threat and risk models to determine if MustStaple is a necessary addition to their defense model.</span></span></span></p><h2 id="coordinate-management-in-a-cluster" data-key="601d3e39b7414713bc937d4dab18798b"><p><span><span data-key="ae81a81b92cc49ca929e99d5da65d15e"><span data-offset-key="ae81a81b92cc49ca929e99d5da65d15e:0">Coordinate management in a cluster.</span></span></span><a href="#coordinate-management-in-a-cluster" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="1975e47ea39a4d4aa019d1ebdc07b3b5"><span><span data-key="65bf152271fb4361afb2fcff800dd218"><span data-offset-key="65bf152271fb4361afb2fcff800dd218:0">Servers in a cluster using certificates for the same name(s) should share the same certificate and key, and either coordinate their ACME operations or delegate them to a single instance.</span></span></span></p><p data-key="a791e299fc604e2da47625e4295c8eca"><span><span data-key="2deb981c64474761a1b125ca76533ec5"><span data-offset-key="2deb981c64474761a1b125ca76533ec5:0">Ideally, a certificate should be issued only once, and then shared with other servers that serve the same hostname(s) and have access to the same private key. This reduces the load on CAs and greatly improves the efficiency of ACME-dependent deployments at scale.</span></span></span></p><p data-key="7867992b94584e0f8fc4670554686d0a"><span><span data-key="7d5f4e063bc449f98e6439d02d1ed09f"><span data-offset-key="7d5f4e063bc449f98e6439d02d1ed09f:0">There are two main modes for implementing this:</span></span></span></p><ol data-key="25f2026f210940a881e899887e2f45e3"><li><p data-key="ceb219b7a158488c9db8d8cc07b1862e"><span><span data-key="b4968a69e2084036910d9b467753f1ea"><span data-offset-key="b4968a69e2084036910d9b467753f1ea:0">One server is designated as the ACME client. It is this server's job to obtain &amp; renew the certificate and distribute it and its key to all servers which use it. This is simple but can have uptime issues if the one delegated instance goes down.</span></span></span></p></li><li><p data-key="1dbc3cb246d247149e11abf94b2543d2"><span><span data-key="85e9d72726dc4fb7840df47704b55451"><span data-offset-key="85e9d72726dc4fb7840df47704b55451:0">All servers act as ACME clients and coordinate their ACME operations with the other instances, ensuring that only one instance is responsible for a particular certificate at any given time. If one server begin to renew a certificate, other servers which also need to renew the certificate wait until the first instance completes its operation. The first instance then makes the new certificate available to the others in the fleet. This may be more complex depending on how it is implemented, but can also have greater reliability as there is no one instance responsible for all certificates.</span></span></span></p></li></ol><h2 id="define-behavior-for-interactive-and-non-interactive-modes" data-key="91062499dee441169feb280375dfb7cd"><p><span><span data-key="a87c5aaab7484b059fd063fd53b29ef5"><span data-offset-key="a87c5aaab7484b059fd063fd53b29ef5:0">Define behavior for interactive and non-interactive modes.</span></span></span><a href="#define-behavior-for-interactive-and-non-interactive-modes" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="b24994f5aa794c11bc5d1d788d9e4384"><span><span data-key="abba04c15bce4ac5b4c92477a8ee974f"><span data-offset-key="abba04c15bce4ac5b4c92477a8ee974f:0">ACME clients operate in a variety of settings, including short-lived, interactive CLI tools and long-lived, non-interactive server daemons. However, some CLI tools are automated in non-interactive scripts, and some server daemons are interactive at startup. These factors may drastically affect behavior related to error handling, concurrency, and throttling.</span></span></span></p><p data-key="bc325a9cbbfd4a0db306b32d3ce287a6"><span><span data-key="fa0efe5214d141be9a4d74696e74050a"><span data-offset-key="fa0efe5214d141be9a4d74696e74050a:0">The ACME client should provide a good user experience, maximize availability, and minimize potential for user and automation errors. This is easiest when framing these issues in terms of interactive and non-interactive modes.</span></span></span></p><p data-key="6f417839720440a1b67b0b064131b3d1"><span><span data-key="72b4e5c7d0fc4a64b2f54cbff3e2f02a"><span data-offset-key="72b4e5c7d0fc4a64b2f54cbff3e2f02a:0">In interactive modes (i.e. when a user is there operating it), it might be best for the program to terminate on the first error so the user can fix it and then continue. For servers that are just starting up, this might also entail blocking (not serving sites) until all initial certificate operations have successfully completed. Printing an error as soon as one happens and then quitting can be nice and user-friendly in interactive modes.</span></span></span></p><p data-key="4d061a5ca47e47aeb0228a86f41e991b"><span><span data-key="bd358a92e5e84dc38009cbe59d637866"><span data-offset-key="bd358a92e5e84dc38009cbe59d637866:0">However, in non-interactive mode (i.e. when there is no user actively overseeing the process), aborting on first error can be disastrous in terms of uptime, rate limits, and troubleshooting. In these cases, a server should do its best to start up and serve what it can, while retrying in the background under appropriate throttles and within reasonable limits, and logging all errors and attempts in as much detail as is needed for debugging. This may result in serving sites with an expired or self-signed certificate, or without a certificate at all; however, these symptoms can make troubleshooting easier.</span></span></span></p><p data-key="e724775736fa496591ea419069d31571"><span><span data-key="af410de1e75f48888c5b7c0e6735ef36"><span data-offset-key="af410de1e75f48888c5b7c0e6735ef36:0">As an example, a server may be started for 3 small sites in an interactive mode because the system administrator is manually deploying this simple setup. As the server starts, it fails to obtain a certificate for site #2, prints an error, and exits. The user fixes the error, restarts the server, and when the server finishes with all 3 certificates, it starts serving sites. The user can then leave, but will monitor logs for any errors in the future. This mode treats certificate errors like socket bind errors. If a server cannot bind a socket, it cannot serve TCP connections; if a server does not have certificates, it cannot serve TLS connections. This reasoning works well in interactive mode, but because of the dynamic nature of the Internet and the external resources required to obtain certificates, it does not work well in non-interactive mode.</span></span></span></p><p data-key="5ec73c5e26754bdf9a0048c90e669b96"><span><span data-key="270e6712d0254d48b708638905b7d3a7"><span data-offset-key="270e6712d0254d48b708638905b7d3a7:0">As an example for non-interactive mode, an advanced deployment may require 10,000 certificates to satisfy a large, dynamically-generated config that changes every few minutes. The server software is supervised with an init system like systemd, which restarts the server if it quits or if the machine is rebooted (common for security updates). When the server is started, it immediately binds the sockets and serves all 10,000 sites, even though no certificates are yet available. It performs the ACME operations in the background as quickly as possible with throttles and rate limits. As certificates are obtained, they are served, and errors are logged. Because this is an automated deployment, logs are monitored and errors cause alerts which the SRE team can fix.</span></span></span></p><p data-key="d29912aa8ae841dfa39921c886dcf6b9"><span><span data-key="e4cf63c187f54ac69be15530e0582e85"><span data-offset-key="e4cf63c187f54ac69be15530e0582e85:0">In that last example, if the server were programmed with interactive behavior, an error with certificate #12 would probably return an error and stop running, causing all sites to stay down, even if all the other certificates would not have any errors. And even if there were no other errors, it would take the server hours to start up and serve any sites if it blocked until all certificates were obtained. On error, the process supervisor would then restart the process and, if misconfigured (as is common), would hammer the CA in a tight restart loop. This should be avoided, so a clear distinction between interactive and non-interactive modes is strongly recommended.</span></span></span></p><h2 id="it-should-always-be-safe-to-reboot-the-machine-or-restart-the-process" data-key="a91f20814a3748ea973bff01eaba1645"><p><span><span data-key="bcc4a93962c44d5a99d2c800cacb8a83"><span data-offset-key="bcc4a93962c44d5a99d2c800cacb8a83:0">It should always be safe to reboot the machine or restart the process.</span></span></span><a href="#it-should-always-be-safe-to-reboot-the-machine-or-restart-the-process" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="0bf9a63dd0404cdea8f0c64068fbe814"><span><span data-key="9549861eff9c43e7bb8b645a41791032"><span data-offset-key="9549861eff9c43e7bb8b645a41791032:0">System reboots are often necessary for security updates. ACME software should try to minimize the risk that a happily-running application fails or takes a long time to come back up after a reboot. If rebooting is risky, that incentivizes people to delay security updates, which harms security.</span></span></span></p><p data-key="3b311d966ef44b05910d9a9f7a14cca0"><span><span data-key="ceba23af8812423b8168d04065bcaec3"><span data-offset-key="ceba23af8812423b8168d04065bcaec3:0">So any time an ACME-capable web server is trying to come back up, if it already has certificates it should start up right away, even if those certificates are expired or close to expiring. That ensures that the server comes back as quickly as possible, making reboots cheap and low risk. It also minimizes the chance that one broken domain on a server with hundreds of domains can prevent the whole thing from coming back up after a reboot.</span></span></span></p><h2 id="the-most-common-reasons-for-failed-acme-challenges-are-dns-firewalls-and-port-contention" data-key="105993e0e6c04ecc9518f1d761090a19"><p><span><span data-key="fbc9f524abb64dcf901399e2b5ec1065"><span data-offset-key="fbc9f524abb64dcf901399e2b5ec1065:0">The most common reasons for failed ACME challenges are DNS, firewalls, and port contention.</span></span></span><a href="#the-most-common-reasons-for-failed-acme-challenges-are-dns-firewalls-and-port-contention" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="d6328bcf86084d15bd46deb6fa773475"><span><span data-key="dc4ce8a785d345f0b40be81c69cc012a"><span data-offset-key="dc4ce8a785d345f0b40be81c69cc012a:0">When ACME challenges fail, it is a good idea to immediately question the configuration of relevant DNS and any applicable firewalls.</span></span></span></p><p data-key="abddce345ab5496ab9b2b5813c7b64c5"><span><span data-key="47e9e28018f74de98a7ce4e7943d28f1"><span data-offset-key="47e9e28018f74de98a7ce4e7943d28f1:0">DNS can be tricky because an authoritative response depends on client perspective or the nuances of a specific DNS provider. DNS affects all challenge types, not just the DNS challenge. For the HTTP and TLS-ALPN challenges, A/AAAA records must be set to the public IP address of the machine that is solving the challenge. For the DNS challenge, a TXT record must be created in the domain's zone with a special token value for the duration of the challenge. The setting (and clearing) of this record varies from provider to provider and their user interfaces or APIs.</span></span></span></p><p data-key="6073ca4e43344369ab3515dfdbbca1ab"><span><span data-key="66858e255957478789e9b71d13bbda8c"><span data-offset-key="66858e255957478789e9b71d13bbda8c:0">For the HTTP and TLS-ALPN challenges to succeed, ports 80 and 443 (respectively) on the public network interface must be open and either bound or forwarded to the client software that is solving the challenge. There is no way around this for these two challenges. If that is impossible, the DNS challenge can be used instead.</span></span></span></p><p data-key="757313bbfbb14af2a0b48a00e0f96c24"><span><span data-key="541c1a829c224341a01ce1839124aeb6"><span data-offset-key="541c1a829c224341a01ce1839124aeb6:0">Even when ports 80/443 are configured properly, it is not uncommon for other software that is not ACME-enabled to be using ports 80 or 443 instead of the ACME client. Check to make sure that the correct ACME client is listening on those ports.</span></span></span></p><h2 id="write-thorough-and-accurate-documentation-and-provide-training-as-necessary" data-key="3a97ff3e02ea4dc78446e862a34e4bcd"><p><span><span data-key="b934a385aea54b8baa7772a8477d4e87"><span data-offset-key="b934a385aea54b8baa7772a8477d4e87:0">Write thorough and accurate documentation, and provide training as necessary.</span></span></span><a href="#write-thorough-and-accurate-documentation-and-provide-training-as-necessary" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="c88ad4d6c6a8474fb89531c7f960753e"><span><span data-key="cc13c406ab3d4baa90201714da67dd0d"><span data-offset-key="cc13c406ab3d4baa90201714da67dd0d:0">Because certificates are security assets, users should understand how the certificate management software works in order to maintain security and privacy. Proper documentation goes a long way, and in some situations such as corporate/organizational settings, training is essential.</span></span></span></p><h2 id="if-an-active-certificate-cannot-be-renewed-in-time-act-according-to-your-sites-threat-model" data-key="53bf6af3f3a249c9a66e88e79b460d4b"><p><span><span data-key="76a96d01207947ff88a8d222fb2a37c9"><span data-offset-key="76a96d01207947ff88a8d222fb2a37c9:0">If an active certificate cannot be renewed in time, act according to your site's threat model.</span></span></span><a href="#if-an-active-certificate-cannot-be-renewed-in-time-act-according-to-your-sites-threat-model" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="6f0b224c9baf4a0f88a296555160ba4f"><span><span data-key="2db5809fad1a4f06b828c1557515da09"><span data-offset-key="2db5809fad1a4f06b828c1557515da09:0">If renewal errors persist to the end of the certificate's lifetime, there are several options:</span></span></span></p><ul data-key="70f214f924d6432aa15f2fd2c2634081"><li><p data-key="4bf2526879f241d39276aa05fea77bf9"><span><span data-key="951f851b28814b1dad4ce601d5bd7f8e"><span data-offset-key="951f851b28814b1dad4ce601d5bd7f8e:0"><strong data-slate-leaf="true">A)</strong></span><span data-offset-key="951f851b28814b1dad4ce601d5bd7f8e:1"> Use the expired certificate</span></span></span></p></li><li><p data-key="c33f2f9f93b04063a9495a9c2af5d5b3"><span><span data-key="fe147115854345c69096813a7df6f04a"><span data-offset-key="fe147115854345c69096813a7df6f04a:0"><strong data-slate-leaf="true">B)</strong></span><span data-offset-key="fe147115854345c69096813a7df6f04a:1"> Use a self-signed certificate</span></span></span></p></li><li><p data-key="79fef22ae7454dfbb86e3c2a029401fb"><span><span data-key="135b62a7312f42ee9323b230516e5558"><span data-offset-key="135b62a7312f42ee9323b230516e5558:0"><strong data-slate-leaf="true">C)</strong></span><span data-offset-key="135b62a7312f42ee9323b230516e5558:1"> Serve connections without TLS</span></span></span></p></li><li><p data-key="f5ab02d5a4374a799e3947d706e7e701"><span><span data-key="0ecb3b728649403e976aecebb3386a0f"><span data-offset-key="0ecb3b728649403e976aecebb3386a0f:0"><strong data-slate-leaf="true">D)</strong></span><span data-offset-key="0ecb3b728649403e976aecebb3386a0f:1"> Go offline</span></span></span></p></li></ul><p data-key="10acb8ea508449f48db37379cf8fe3b9"><span><span data-key="5e67f6383cf2458282f711083d8638d2"><span data-offset-key="5e67f6383cf2458282f711083d8638d2:0">All these choices will result in error messages with respectable clients. So, your threat model should dictate what the best thing to do is. Assess what is causing renewal to fail for continuous days or weeks. It is important in all cases to send the right message to users.</span></span></span></p><p data-key="4510de27a0564b298cb59eb966057234"><span><span data-key="326fe072122a45bbb8f22acc0f56cf01"><span data-offset-key="326fe072122a45bbb8f22acc0f56cf01:0">If the reason for the failures is simply that the administrator changed their DNS provider account credentials but forgot to set the new credentials with their ACME client, then there is virtually no risk to users. This is truly a benign mistake, so choice </span><span data-offset-key="326fe072122a45bbb8f22acc0f56cf01:1"><strong data-slate-leaf="true">A</strong></span><span data-offset-key="326fe072122a45bbb8f22acc0f56cf01:2"> is probably the least disruptive and sends the lowest-risk signal.</span></span></span></p><p data-key="55a0a9e6cb1142b6a72de5114ccdb7c7"><span><span data-key="7a847b39c63246bd91a6e07cf6a1336b"><span data-offset-key="7a847b39c63246bd91a6e07cf6a1336b:0">If, however, DNS lookups are being hijacked in an ongoing attack, then the situation is more dangerous and choices </span><span data-offset-key="7a847b39c63246bd91a6e07cf6a1336b:1"><strong data-slate-leaf="true">B</strong></span><span data-offset-key="7a847b39c63246bd91a6e07cf6a1336b:2">, </span><span data-offset-key="7a847b39c63246bd91a6e07cf6a1336b:3"><strong data-slate-leaf="true">C</strong></span><span data-offset-key="7a847b39c63246bd91a6e07cf6a1336b:4">, or </span><span data-offset-key="7a847b39c63246bd91a6e07cf6a1336b:5"><strong data-slate-leaf="true">D</strong></span><span data-offset-key="7a847b39c63246bd91a6e07cf6a1336b:6"> should probably be used instead, depending on many factors including the nature of the site's content, political concerns, physical safety, user privacy, and much more.</span></span></span></p><p data-key="226d6e3adae1410db2de9b6ee7fe3a87"><span><span data-key="c8b6c2f4d9d34581823dbe984b7e04c9"><span data-offset-key="c8b6c2f4d9d34581823dbe984b7e04c9:0">These are not always easy decisions to make, but the vast majority of sites should probably just serve the expired certificate (option </span><span data-offset-key="c8b6c2f4d9d34581823dbe984b7e04c9:1"><strong data-slate-leaf="true">A</strong></span><span data-offset-key="c8b6c2f4d9d34581823dbe984b7e04c9:2">). It is generally viewed as a low-risk error. Users with certain technical understanding will recognize this as a likely benign error and act accordingly.</span></span></span></p><p data-key="d6bdb6289a424fafb9e50d944cae05b9"><span><span data-key="a60d91acd0a64b1aa6b6e8c2d5a95cd9"><span data-offset-key="a60d91acd0a64b1aa6b6e8c2d5a95cd9:0">An expired certificate is a direct consequence of the certificate not being renewed, so serving that expired certificate quickly exposes the problem rather than hiding the symptoms behind a closed socket or self-signed certificate. In addition, User-Agents can display a meaningful error message about the certificate, which allows the user to choose how to handle the situation. Sites that are urgently needed can still be accessed, and users who are not willing to take a slightly higher risk do not need to.</span></span></span></p><p data-key="a948ac8d58fe4170b8631399ea59225e"><span><span data-key="3d7d1e36b1b34434abd0c6052674ff7f"><span data-offset-key="3d7d1e36b1b34434abd0c6052674ff7f:0">It is crucial that Web client software produce good and helpful error messages. For more discussion on instructive HTTPS errors, see </span></span><a href="https://scholarsarchive.byu.edu/etd/7403/" target="_blank" rel="noopener noreferrer" data-key="cf10e1422291468f807fa6b63a4092bd"><span data-key="4da38bd7e3814369ae11e0296be333bb"><span data-offset-key="4da38bd7e3814369ae11e0296be333bb:0"><em data-slate-leaf="true">After HTTPS: Indicating Risk Instead of Security</em></span></span></a><span data-key="7e4f2604c17144dcb234ddba074f906f"><span data-offset-key="7e4f2604c17144dcb234ddba074f906f:0">.</span></span></span></p><p data-key="45d97051e83c4b8da7d032a403836294"><span><span data-key="bf8d074aaa274206babb5eb60ad82fee"><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:0">For sites that have HSTS enabled, option </span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:1"><strong data-slate-leaf="true">C</strong></span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:2"> is not possible except on the first connection, so </span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:3"><strong data-slate-leaf="true">B</strong></span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:4"> or </span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:5"><strong data-slate-leaf="true">D</strong></span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:6"> may need to be used if option </span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:7"><strong data-slate-leaf="true">A</strong></span><span data-offset-key="bf8d074aaa274206babb5eb60ad82fee:8"> is not desired. However, if enabled only through HTTP headers, HSTS can be bypassed on first access. Keep in mind that serving the site over HTTP (without TLS) puts both the user's privacy and the integrity of your site's content at risk.</span></span></span></p><p data-key="c3e6e1327c6841bca197c07dedf0dc95"><span><span data-key="d185277e48344dfc9b83d7a0dfaf54c1"><span data-offset-key="d185277e48344dfc9b83d7a0dfaf54c1:0">Closing the socket entirely (option </span><span data-offset-key="d185277e48344dfc9b83d7a0dfaf54c1:1"><strong data-slate-leaf="true">D</strong></span><span data-offset-key="d185277e48344dfc9b83d7a0dfaf54c1:2">) is only recommended if certificate errors are unacceptable and if option </span><span data-offset-key="d185277e48344dfc9b83d7a0dfaf54c1:3"><strong data-slate-leaf="true">C</strong></span><span data-offset-key="d185277e48344dfc9b83d7a0dfaf54c1:4"> puts the user or your site's integrity at too much risk. For example, sites that provide life-saving information during disasters or emergencies should probably stay online even if unencrypted.</span></span></span></p><p data-key="3cc7324821a44bc083f0aa417e5d46f5"><span><span data-key="40e7aa9084be4da4899fbe0b5d89bd12"><span data-offset-key="40e7aa9084be4da4899fbe0b5d89bd12:0">Remember, these are extenuating circumstances. When making these decisions, always prioritize people's health and safety over pleasant user experiences.</span></span></span></p><h2 id="dont-make-assumptions-about-url-structure" data-key="1fe45be11d5f433c9d9551973f8064f7"><p><span><span data-key="b5c9438287ba40c3b329cde9c42f2115"><span data-offset-key="b5c9438287ba40c3b329cde9c42f2115:0">Don’t make assumptions about URL structure.</span></span></span><a href="#dont-make-assumptions-about-url-structure" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="00eba850ecb842db8d84f3bec0d8865b"><span><span data-key="4aa45e0f9c734b4b902cb77f8cb192b7"><span data-offset-key="4aa45e0f9c734b4b902cb77f8cb192b7:0">Clients shouldn’t make any assumptions about the structure of account, order, authorization, challenge, or certificate resource URLs. RFC 8555 allows the client to discover the URLs of resources chosen by the server. Making assumptions about numeric components of URLs or their structure will result in the ACME client being incompatible with other RFC 8555 server implementations.</span></span></span></p><p data-key="0f8c7a8f27cb49759861148c0d6d24a0"><span><span data-key="02e7562262f34fd49fa5f4e9a20f98c1"><span data-offset-key="02e7562262f34fd49fa5f4e9a20f98c1:0">The ACME server dictates what authorizations are required for a given order. The client should not make any assumptions about there being one authorization for each identifier, the order of authorization URLs within a created order resource, or other aspects of the authorization process. Instead, the client should create orders and respond dynamically to the authorizations returned in the order and their respective state.</span></span></span></p><p data-key="ec4e54e827d942349dfc589e00831ff9"><span><span data-key="9e773f6e8c5c4903b1ed274d84dd6897"><span data-offset-key="9e773f6e8c5c4903b1ed274d84dd6897:0">The following topics need more discussion and field testing as they do not yet have satisfying answers.</span></span></span></p><h2 id="can-acme-account-provisioning-and-legal-agreements-be-proxied" data-key="15e0265aba5548c0873909a163ed575a"><p><span><span data-key="8e0476065a3448819aa9fec6c2752bbe"><span data-offset-key="8e0476065a3448819aa9fec6c2752bbe:0">Can ACME account provisioning and legal agreements be proxied?</span></span></span><a href="#can-acme-account-provisioning-and-legal-agreements-be-proxied" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="a575a6fb1c0149feb4de28c1297aa4db"><span><span data-key="f8f4e2824a854fb3bc7c8a9d08a23a26"><span data-offset-key="f8f4e2824a854fb3bc7c8a9d08a23a26:0">Often, a "subscriber" is managing certificates on behalf of a client. The client is often not present during the certificate obtain process. Can/should the vendor create the ACME account on their behalf and agree to the CA's legal terms on their behalf? Or proxy that agreement either implicitly or explicitly?</span></span></span></p><p data-key="2abffef9593845868657c94d8a310c30"><span><span data-key="85361faaaa074e6dad80cc402a91ac60"><span data-offset-key="85361faaaa074e6dad80cc402a91ac60:0">Additionally, if the legal terms change between renewals, can the software agree to the updated terms on behalf of the client without explicit approval? Getting explicit approval could be difficult/impossible and lead to downtime, not to mention high complexity to implement.</span></span></span></p><h2 id="should-a-revoked-certificates-key-be-rotated-automatically" data-key="ccf8e225ad4f4559b62910c9f1d81dc6"><p><span><span data-key="43e7f22f53c04836a51bda91023e45f7"><span data-offset-key="43e7f22f53c04836a51bda91023e45f7:0">Should a revoked certificate's key be rotated automatically?</span></span></span><a href="#should-a-revoked-certificates-key-be-rotated-automatically" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="dade972971c64f5ab907e28976056bed"><span><span data-key="9a67cf09f3054a529f7715d0cb807d3e"><span data-offset-key="9a67cf09f3054a529f7715d0cb807d3e:0">Generally, it is impossible for an automated system to know the reason for the revocation. If the certificate was revoked because the private key was compromised, rotating the key and persisting it to a storage that may still be compromised is not helpful and could create a false sense of security. Instead, keys should be manually rotated if the site owner or security officer determines to.</span></span></span></p><h2 id="what-are-best-practices-for-acme-account-key-rollover" data-key="17a900e9fa2e4befaa25659357271e55"><p><span><span data-key="d0790b79d841448ab847fbcbc6518b28"><span data-offset-key="d0790b79d841448ab847fbcbc6518b28:0">What are best practices for ACME account key rollover?</span></span></span><a href="#what-are-best-practices-for-acme-account-key-rollover" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="ccfe5e5cdfda43ed9e7747e8bb76be4c"><span><span data-key="16c14a848fab4e3eb0e3fcf267b18536"><span data-offset-key="16c14a848fab4e3eb0e3fcf267b18536:0">Up for consensus.</span></span></span></p><h2 id="how-should-ca-specific-divergences-from-rfc-8555-be-handled" data-key="b6dcebf51b8a4607b696a93599ed9e57"><p><span><span data-key="16e94d95585744f29a9f9456930fbb70"><span data-offset-key="16e94d95585744f29a9f9456930fbb70:0">How should CA-specific divergences from RFC 8555 be handled?</span></span></span><a href="#how-should-ca-specific-divergences-from-rfc-8555-be-handled" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="6213824d59254a3ebd525bde7d44b2d3"><span><span data-key="3cda768aee1a41b5bd46bdea86fee72e"><span data-offset-key="3cda768aee1a41b5bd46bdea86fee72e:0">Up for consensus.</span></span></span></p><h2 id="what-are-some-ways-to-avoid-overfitting-to-lets-encrypt-so-as-to-maximize-ca-interoperability" data-key="67938944ab044a5dabf1f3124e279d65"><p><span><span data-key="10f9305f7dee4f77bc1210a08c355575"><span data-offset-key="10f9305f7dee4f77bc1210a08c355575:0">What are some ways to avoid overfitting to Let's Encrypt so as to maximize CA interoperability?</span></span></span><a href="#what-are-some-ways-to-avoid-overfitting-to-lets-encrypt-so-as-to-maximize-ca-interoperability" contenteditable="false"><span><svg preserveAspectRatio="xMidYMid meet" height="1em" width="1em" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></g></svg></span></a></p></h2><p data-key="6301d43b09ad444d80a47792b2982814"><span><span data-key="83982ddc82dd4797968882f71160145e"><span data-offset-key="83982ddc82dd4797968882f71160145e:0">Up for consensus.</span></span></span></p></div></div></div></div></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>