<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Kubernetes and .NET running on a Raspberry Pi Cluster - Dan Clarke - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Kubernetes and .NET running on a Raspberry Pi Cluster - Dan Clarke - linksfor.dev(s)"/>
    <meta property="og:description" content="I&#x27;m starting writing this blog post on the train ride home from yet another amazing DDD event! This variant being DDD South West in Bristol! For those that haven&#x27;t heard of DDD - there are various DDD conferences throughout the world - with quite a few in the UK. They are always free, and always on a Saturday. This means that it tends to attract developers who are genuinely passionate about software development, and more than happy to give up their weekend to be part of this awesome community."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.danclarke.com/k8s-on-raspberry-pis-talk"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title">devring.club</span>
				<a href="https://devring.club/site/1/previous" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Kubernetes and .NET running on a Raspberry Pi Cluster - Dan Clarke</title>
<div class="readable">
        <h1>Kubernetes and .NET running on a Raspberry Pi Cluster - Dan Clarke</h1>
            <div>Reading time: 24-30 minutes</div>
        <div>Posted here: 14 May 2019</div>
        <p><a href="https://www.danclarke.com/k8s-on-raspberry-pis-talk">https://www.danclarke.com/k8s-on-raspberry-pis-talk</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
        
        <div>
            

<div>
    

    

    <hr>

    <p>I'm starting writing this blog post on the train ride home from yet another <em>amazing</em> DDD event! This variant being <a href="https://dddsouthwest.com/">DDD South West</a> in Bristol! For those that haven't heard of DDD - there are various DDD conferences throughout the world - with quite a few in the UK. They are always free, and always on a Saturday. This means that it tends to attract developers who are <em>genuinely</em> passionate about software development, and more than happy to give up their weekend to be part of this awesome community.</p>
<p>This will be the third time I've spoken at a DDD conference - the other two times were with my <a href="https://www.danclarke.com/developer-productivity-talk-at-dddsw">Developer Productivity talk</a>. This time I was talking about Docker, Kubernetes, and running Kubernetes on a cluster of Raspberry Pis! And we had <em>real</em> hardware! This blog post covers everything I covered in the talk, as well as links to the hardware and tools used.</p>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/20190508_203505.jpg" alt=""></p>
<hr>
<h3 id="update-the-talk-as-other-venues-plus-video-and-photos">Update: The talk as other venues (plus video and photos)</h3>
<p>Since initially writing this post, I've done this talk at a couple of other venues on-top of the above-mentioned DDD conference.</p>
<p>In August 2019, I did <a href="https://www.meetup.com/dotnetoxford/events/261238064/">a 90-minute version at .NET Oxford</a>. This was actually recorded, so if you prefer to watch rather than read, the video is below...</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/VVbdIi0uanI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<p><em>(please excuse my facial expression in that cover photo - I didn't pick it!)</em></p>
<p>I cover exactly the same content in both the video, and this blog post. Plenty of photos can also be found <a href="https://www.dropbox.com/sh/3p2tj2y89d0fim4/AADFzfoUVHZBuTMuYwbhXJoga?dl=0">here</a>.</p>
<p>I also did the same talk down in Southampton in October 2019 at <a href="https://www.meetup.com/DeveloperSouthCoast/events/263249688/">Dev South Coast</a>.</p>
<hr>
<h3 id="but-why">But, Why?!</h3>
<p>So why install Kubernetes on a Raspberry Pi cluster? Well, why not?! To be fair, other than a bit of fun - there's no real reason why you'd do this. Scott Hanselman wrote <a href="https://www.hanselman.com/blog/HowToBuildAKubernetesClusterWithARMRaspberryPiThenRunNETCoreOnOpenFaas.aspx">a blog post</a> a few years ago where he did the similar, and quite a few people have also done the same and built all sorts of interesting Raspberry Pi K8S clusters. I wanted an excuse to have a play, and thought it would make a nice talk at <a href="https://www.meetup.com/dotnetoxford">.NET Oxford</a>.</p>
<p>I initially planned on doing this first at .NET Oxford, but then saw a tweet from DDDSW saying that talk submissions had opened, and I couldn't resist submitting it. It brought the timeframe of writing the talk forward a bit, but I still had a couple of month's at the time, and it meant I could rely on reverse-<a href="https://en.wikipedia.org/wiki/Parkinson%27s_law">Parkinson's Law</a> to get in done in time! :)</p>
<p>In reality, if you're going to use Kubernetes, and you have no restriction saying that you can't use the cloud - then I'd highly recommend going with a managed cluster - eg. <a href="https://azure.microsoft.com/en-gb/services/kubernetes-service/">AKS</a>. However, if you <em>have</em> to create your own cluster for whatever reason, then whilst you probably wouldn't do it on Raspberry Pis - the process is pretty similar.</p>
<hr>
<h3 id="the-agenda">The Agenda</h3>
<p>I started off going over the agenda for the talk. I'll follow a similar format in this blog post, and structure it in the same order as the talk. Here are the bullets from my agenda slide...</p>
<ul>
<li>Hardware Overview</li>
<li>Create basic .NET app, running locally with Docker and Docker-Compose</li>
<li>Intro to Kubernetes</li>
<li>How to install Kubernetes on the Raspberry Pis</li>
<li>Running our .NET apps on the Raspberry Pi Cluster</li>
</ul>
<hr>

<p>I would like to say a <em>massive</em> thank you <a href="https://www.modmypi.com/">ModMyPi</a> for sponsoring my talk by providing the Raspberry Pis, cases, and SD cards! If you're interested in Raspberry Pis, Arduinos, etc - then definitely check out their site! Not only an online store, but they also have forums and tutorials with tons of interesting info. They're <a href="https://twitter.com/ModMyPi">on Twitter too</a>.</p>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/modmypi-logo.png" alt=""></p>
<hr>
<h3 id="hardware-details">Hardware Details</h3>
<p>Below is a list of the hardware that was very kindly provided by <a href="https://www.modmypi.com/">ModMyPi</a>...</p>
<ul>
<li>4x <a href="https://www.modmypi.com/raspberry-pi/raspberry-pi-a-plusb-plus23-1015/rpi3-model-b-plus/raspberry-pi-3-model-b-plus">Raspberry Pi 3B+</a> (this model has an ethernet port)</li>
<li>2x <a href="https://www.modmypi.com/multi-pi-stackable-raspberry-pi-case">Stackable Cases</a></li>
<li>1x <a href="https://www.modmypi.com/multi-pi-stackable-raspberry-pi-case-bolt-pack">bolt pack</a> (for spares)</li>
<li>4x <a href="https://www.modmypi.com/8gb-micro-sd-class-10-pre-loaded-with-noobs">8GB SD cards</a></li>
</ul>
<p>And here's the additional bits provided by my company, <a href="https://www.everstack.com/">Everstack Ltd</a>...</p>
<ul>
<li><a href="https://www.amazon.co.uk/gp/product/B07712LKJM">GL.iNet GL-AR750 Travel AC Router</a> (thanks to <a href="">Joel</a> for <a href="https://twitter.com/rammesses/status/1116008821942566912">suggesting this</a>)</li>
<li><a href="https://www.amazon.co.uk/gp/product/B0000E5SEQ/ref=ppx_yo_dt_b_asin_title_o03_s00?ie=UTF8&amp;psc=1">NETGEAR GS105UK 5-Port Gigabit Switch</a> (because the router only has 2 internal ethernet ports)</li>
<li><a href="https://www.amazon.co.uk/gp/product/B00YSA0WI8/ref=ppx_yo_dt_b_asin_title_o05_s00?ie=UTF8&amp;psc=1">Anker Powerport</a> to power the Pis and router</li>
<li>5x <a href="https://www.amazon.co.uk/gp/product/B00QV1F1C4/ref=ppx_yo_dt_b_asin_title_o04_s00?ie=UTF8&amp;psc=1">ethernet cables (flat design)</a></li>
<li>2x <a href="https://www.amazon.co.uk/gp/product/B016BFFV6K/ref=ppx_yo_dt_b_asin_title_o05_s00?ie=UTF8&amp;psc=1">3pack of micro usb charging cables</a></li>
<li><a href="https://www.amazon.co.uk/gp/product/B06XC16QC1/ref=ppx_yo_dt_b_asin_title_o01_s00?ie=UTF8&amp;psc=1">TP-Link M7350 4G LTE MiFi</a> (because the venue didn't have internet)</li>
</ul>
<p>The 3B+ model of the Pis contain an ethernet port. Whilst I <em>could</em> have done this via wifi - I wanted to use cables to make it a bit more reliable.</p>
<p>Each <a href="https://www.modmypi.com/multi-pi-stackable-raspberry-pi-case">stackable case</a> can hold two Pis, so I needed two of these for my 4xPi cluster. Here's my tweet with pictures from when was assembling the cases...</p>
<twitter-widget id="twitter-widget-0" data-tweet-id="1116697709904314368"></twitter-widget>

<p>The travel router is <em>tiny</em>, and can connect to an external network either via wifi or wired. And it's fairly well featured too, coming with <a href="https://openwrt.org/">OpenWrt</a> pre-installed. This allowed me to connect to an external network, and then create my own private network to connect both my laptop and the Raspberry Pis to. As it only has 2 internal ethernet ports, I connected it to the Netgear switch, and plugged the Pis into the switch. My laptop then connected to the network (ie. travel router) via wifi. Unfortunately, the conference didn't have wifi - so I used the above-mentioned TP-Link Mifi device. The travel router connected to this mifi device for its external network.</p>
<p>The Pis and travel router then plugged into the Anker Powerport via USB for power. It turns out I should have also plugged in the mifi device to the Powerport, as you'll see later!</p>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/hardware-annotated.jpg" alt=""></p>
<hr>
<h3 id="creating-the.net-applications">Creating the .NET applications</h3>
<p>After introing the hardware, I wanted to start off creating the application we were going to run in the cluster. This was just a very simple 'hello world' messaging architecture to demonstrate how easy it is to have one service publishing a message onto a queue, and another service subscribing to the queue to perform some action when a message is published. The reason I wanted to do this, was that it shows multiple 'services' talking to each other allowing me to demo running multiple containers in our Kubernetes cluster - ie. two of our own containers, and a 3rd-party message queue container.</p>
<p>Here is a diagram showing the architecture we created during the talk...</p>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/diagram.jpg" alt=""></p>
<p>When we click on a link in the mvc application, it'll publish a message on a RabbitMQ message queue, then the console application will react to it by sending a message to Slack. The full source-code we ended up with at the end can be found <a href="https://github.com/dracan/k8s-raspberrypi-talk-code">on Github</a>.</p>
<p>I used the <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/">.NET CLI</a> to create both the 'web' and 'worker' projects...</p>
<pre><span>dotnet </span><span>new</span><span> mvc </span><span>-</span><span>o web
dotnet </span><span>new</span><span> console </span><span>-</span><span>o worker</span></pre>
<p>This took seconds, and we could then run them with <code>dotnet run</code>. Whilst this is the same as using "File..New" in Visual Studio - I wanted to demonstrate how quick and easy life is <a href="https://www.danclarke.com/getting-more-from-the-cli">using the CLI</a>!</p>
<p>Adding the <a href="https://www.rabbitmq.com/dotnet.html">RabbitMQ.Client</a> nuget package is then as simple as running <code>dotnet add package RabbitMQ.Client</code> against each project.</p>
<p>I then had to cheat a little (as no-one wants to watch me type boiler plate code!), and copy a couple of <em>"here's one I made earlier"</em> helper classes into our projects: <a href="https://github.com/dracan/k8s-raspberrypi-talk-code/blob/master/worker/RabbitMqMessageQueue.cs">RabbitMQHelper.cs</a> and <a href="https://github.com/dracan/k8s-raspberrypi-talk-code/blob/master/worker/SlackHelper.cs">SlackHelper.cs</a>. The RabbitMQHelper has <code>Send</code> and <code>Subscribe</code> methods, and the SlackHelper just has a <code>SendMessage</code> method. I pointed out that these were static classes just to keep the demo very simple - I would always avoid doing this in production code, as it glues this code to the calling code, meaning that the calling code isn't very testable. For this demo though, this wasn't an issue.</p>
<p>To avoid having to manually create a hyperlink on the webpage, I just called the <code>RabbitMQHelper.Send()</code> method from the stock "Privacy" page, so our message got put on the queue each time you visited that page in the navbar. Then from the 'worker' console app project, we called <code>RabbitMQHelper.Subscribe(..)</code> to react to that message and post a message to Slack. We just sent "Hello DDD!" as the message to keep it simple.</p>
<hr>
<h3 id="running-rabbitmq-using-docker">Running RabbitMQ using Docker</h3>
<p>So now our basic application is complete, but we're missing something quite important! We don't have an instance of RabbitMQ to send messages to or subscribe to! This is easily rectified thanks to Docker by running <code>docker run -p 5672:5672 rabbitmq</code>. In this section of the talk, I also explained at a high level, what containers and images were, and explained remote image registries. I won't repeat that here though, as there's a <em>ton</em> of info on the internet about this already.</p>
<p>After running the above command, we then had an instance of RabbitMQ running on my laptop! Which I can get rid of by just killing the container. No installations messing up my operating system or Windows registry - just a nice clean sandboxed container running it.</p>
<p>I use a command-line tool called <a href="https://cmder.net/">Cmder</a>, which I used in the talk. This gives a <em>much</em> better command-line experience to what you currently get out of the box with Windows (perhaps up until the new <a href="https://www.theverge.com/2019/5/6/18527870/microsoft-windows-terminal-command-line-tool">Windows Terminal</a> announcement anyway!). You're still using the shell of your choosing (eg. cmd, Powershell, or Bash), but it adds a whole heap of options - eg. tabs, split-screen panes, etc. For more information, see my blog post <a href="https://www.danclarke.com/getting-more-from-the-cli">Getting more from the Windows Command Line</a> and search for 'ComEmu'. Note that I've recently switched from ConEmu to Cmder, as IMO it looks better - however they're pretty much the same thing, as Cmder is built upon ComEmu. That blog post describes ComEmu, but the same concepts apply.</p>
<p>I used Cmder's split screen view to very quickly create three panes (<code>ctrl-shift-e</code> for horizontal split, and <code>ctrl-shift-o</code> for vertical). The left-hand pane had the RabbitMQ output from Docker running, and I then used the right-hand two panes to run our MVC app and console app with <code>dotnet run</code>.</p>
<p>Clicking on the <code>Privacy</code> link in the webpage, then successfully popped up a Slack notification with our message. So we'd now seen the application working locally end-to-end on my laptop outside of Docker (except for the RabbitMQ instance which was with Docker).</p>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/console.png" alt=""></p>
<hr>
<h3 id="running-our-app-inside-docker-too">Running our app inside Docker too</h3>
<p>The next step in the story was to run the whole thing in Docker. For this, I obviously had to explain how to build Docker images. So I added the pre-made <em>Dockerfiles</em>, and explained how this worked. See <a href="https://github.com/dracan/k8s-raspberrypi-talk-code/blob/master/web/Dockerfile">here</a> for the web Dockerfile, and <a href="https://github.com/dracan/k8s-raspberrypi-talk-code/blob/master/worker/Dockerfile">here</a> for the worker Dockerfile. They are multi-stage Docker files, so I also explained what this was. If you haven't used them before, see my blog post about <a href="https://www.danclarke.com/multistage-dockerfiles">multi-stage Docker files</a>.</p>
<p>Given we have a few different components to our simple 'hello world' app - eg. the MVC app, the console app, and RabbitMQ - I used <a href="https://docs.docker.com/compose/">Docker Compose</a> to both run, build, and push our images. I explained how Docker Compose works, and then ran our application with <code>docker-compose up --build</code>. See <a href="https://github.com/dracan/k8s-raspberrypi-talk-code/blob/master/docker-compose.yaml">here</a> for the <code>docker-compose.yaml</code> file.</p>
<p>One small change I had to make first was to change the RabbitMQ server hostname that both our mvc and console app was using from <code>localhost</code> to <code>rabbitmq</code>. This is because when our .NET app is running locally <em>outside</em> of Docker, it can talk to RabbitMQ with <code>localhost</code> - however, when running inside of Docker, where each component (ie. webapp, consoleapp, and RabbitMQ) are in their own containers - "localhost" for each will only be looking inside the container's localhost. When running a bunch of services with Docker Compose - each <em>name</em> you give each service, becomes a DNS entry. I had named the RabbitMQ service "rabbitmq" - hence why I had to change <code>localhost</code> to <code>rabbitmq</code>.</p>
<p>Again, this now successfully worked - now showing our application working end-to-end all within Docker (albeit, still on my laptop at this point).</p>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/console2.png" alt=""></p>
<hr>
<h3 id="tweaking-our-images-for-arm-then-pushing-to-docker-hub">Tweaking our images for ARM, then pushing to Docker Hub</h3>
<p>Before pushing our web and console app images to Docker Hub for our Kubernetes cluster to pull down - there was one small change I had to make...</p>
<p>Up until now, we'd built our application for the default runtime, which won't run on an ARM processor. This is easily fixed, by editing our Dockerfiles and appending the <code>RUN dotnet publish -c Release</code> command with <code>-r linux-arm</code> to specify the Linux ARM runtime. I also had to change the base-image that our Dockerfile used to use the <code>2.2-stretch-slim-arm32v7</code> tag. See the commented out lines in our previously-mentioned Docker files.</p>
<p>I then rebuilt our images and pushed them to DockerHub using our <code>docker-compose.yaml</code> file by just running <code>docker-compose push</code>. I was expecting this to take quite a while, so I then left that uploading whilst I talked about Kubernetes...</p>
<hr>
<h3 id="explaining-kubernetes">Explaining Kubernetes</h3>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/icons.png" alt=""></p>
<p>The next section in the talk was explaining what Kubernetes is, and also a few key bits of terminology. Running your apps using Docker locally is really easy, but there's much more to think about when running in production. You don't want all your applications running on just a single machine, as if that machine dies - then so does your app. This is where a <em>container orchestrator</em> comes in - where Kubernetes is by far the most popular. It basically allows you to run your containers on a cluster of machines (called a Kubernetes cluster). Kubernetes will then manage which machine your container runs on, ensuring that pods with multiple replicas (ie. pods that have been scaled out) are created across multiple machines in the cluster where possible. Kubernetes also managed health monitoring, so if I pod goes down, Kubernetes will recreate it - constantly making sure that your cluster matches the <em>desired state</em> you specified for your environment. Kubernetes also does a <em>ton</em> of other stuff, eg. load balancing, auto-scaling, and much more.</p>
<p>After explaining what Kubernetes was, I went through explaining what some of the core Kubernetes objects (resource types) are - eg. 'pods', 'deployments', and deployments 'services'. There are many more, but those are the main ones required for understanding the rest of the talk. I also explained other terminology - eg. what a node is, what the master node is, etc. I won't repeat this here as Kubernetes already has excellent <a href="https://kubernetes.io/docs/concepts/">documentation on this</a> which goes into <em>far</em> more detail that I went into in the talk.</p>
<p>I then talked about how you interact with your Kubernetes cluster. Kubernetes provides a command line tool called <a href="https://kubernetes.io/docs/reference/kubectl/overview/">Kubectl</a> which you can use to run commands against your cluster. Once you understand the core concepts, it becomes really quite intuitive. A lot of the commands follow the same pattern - eg. <code>kubectl &lt;verb&gt; &lt;noun&gt;</code>. For example, to get a list of all your pods, you can type <code>kubectl get pods</code>. To get a list of all your services, you can type <code>kubectl get services</code>. To delete a pod, you can type <code>kubectl delete pod &lt;podname&gt;</code>. You get the idea.</p>
<p>In the same way as I described earlier for the <code>docker-compose.yaml</code> file - Kubernetes also has a YAML format for describing Kubernetes objects. This means that in these YAML files, you can describe the application environment, and source-control this desired state. The yaml files I used can <a href="https://github.com/dracan/k8s-raspberrypi-talk-code/tree/master/Kubernetes">be found here</a>, and can be applied to the cluster using <code>kubectl apply -f .</code> to apply all yaml files in the currently folder, or <code>kubectl apply -f &lt;filename.yaml&gt;</code> to apply a specific file.</p>
<hr>
<h3 id="explaining-the-installation-process-of-kubernetes-on-the-raspberry-pi">Explaining the installation process of Kubernetes on the Raspberry Pi</h3>
<p>So far, we've discussed the hardware, and created an app to run on the hardware - but we haven't covered <em>how</em> to install Kubernetes on a cluster of Raspberry Pis. This is actually really easy. Below are the steps, which I'll then explain in more detail...</p>
<ul>
<li>Download <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian ISO file</a></li>
<li>Use <a href="https://www.balena.io/etcher/">Etcher</a> to flash that ISO to one of the SD cards</li>
<li>Create an empty file called 'ssh' on the root of the SD card</li>
<li>Plug the SD card into into the Pi, and turn on the Pi</li>
<li>Find out the IP address of the Pi by checking your router dashboard</li>
<li>SSH into the Pi (I use <a href="https://github.com/jimradford/superputty">SuperPutty</a>). Default username/password is pi/raspberry.</li>
<li>Change the Pi's hostname from <code>raspberry</code> to something unqiue. I did <code>pi-master</code> for my master node, then <code>pi-nodeN</code> for the three worker nodes.</li>
<li>Give each Pi a static IP address rather than the default DHCP</li>
<li>Install Kubernetes using the scripts I mention below</li>
</ul>
<p>I talked through these steps in the talk, but because of the limited time available, I had done them in advance before the talk. Here are the steps in a bit more details...</p>
<h4 id="download-the-raspbian-linux-distro">Download the Raspbian Linux Distro</h4>
<p>I used a Linux distro called <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a>, which is designed for Raspberry Pis. You can download the 'Raspbian Stretch Lite' ISO for this distro from <a href="https://www.raspberrypi.org/downloads/raspbian/">here</a>.</p>
<h4 id="flash-iso-onto-sd-card-with-etcher">Flash ISO onto SD card with Etcher</h4>
<p>Etcher is an open-source tool (built with Electron) making it easy to flash an ISO to an SD card, and it's available on Windows, Linux, and Mac. The GUI couldn't be more simple - just select your Raspbian ISO, your SD card drive, and click the "Flash" button.</p>
<h4 id="create-empty-ssh-file">Create empty 'ssh' file</h4>
<p>By default, SSH mode isn't enabled on Raspbian. To avoid having to plug in a keyboard and screen to each Raspberry Pi, just create an empty file called <code>ssh</code> on the root of your SD card after you flashing it. You'll then be able to SSH straight onto the Pi.</p>
<h4 id="ssh-onto-the-pi">SSH onto the Pi</h4>
<p>Now you can just plug in the SD card into the Raspberry Pi, and turn it on. When it boots up, it'll initially have a DHCP IP address. You can find out what IP address it was assigned by looking at your router's dashboard to see the connected machines. For SSH, I use a tool called <a href="https://github.com/jimradford/superputty">SuperPutty</a>, which is a GUI wrapper around <a href="https://www.putty.org/">Putty</a> that has a multi-tab interface and better connection bookmarking support. Enter the IP address of the Pi, then use the default Raspbian username and password of 'pi' and 'raspberry'.</p>
<h4 id="change-default-hostname">Change default hostname</h4>
<p>The default hostname is <code>raspberrypi</code>. Obviously having 4 Pis with the name hostname isn't great! So let's change this. There are two files you need to edit: <code>/etc/hostname</code>, which literally just contains the hostname; and <code>/etc/hosts</code>.</p>
<h4 id="change-to-a-static-ip-address">Change to a static IP address</h4>
<p>To keep things simple, let's also assign a static IP address so things don't change under our feet. To do this, just add the following block of code to the bottom of the existing file called <code>/etc/dhcpcd.conf</code>...</p>
<pre>interface eth0
static ip_address=192.168.8.100/24
static routers=192.168.8.1
static domain_name_servers=192.168.8.1
</pre>
<p>Where the <code>192.168.8</code> part is the subnet for the router's network, and I assigned the Raspberry Pi IP addresses from <code>192.168.8.100</code> to <code>192.168.8.103</code>.</p>
<h4 id="installing-kubernetes">Installing Kubernetes</h4>
<p>Once done, we now just need to install Kubernetes itself. Below are the two files I used - <code>InstallKubernetes.sh</code> and <code>InitMaster.sh</code>. <code>InstallKubernetes.sh</code> is run on each Raspberry Pi, and installs both Docker and Kubernetes. Then for <em>just</em> the master node, after running <code>InstallKubernetes.sh</code> and rebooting - also run <code>InitMaster.sh</code> to setup the master node. I use <a href="https://winscp.net/eng/download.php">WinSCP</a> to copy these files onto the Pi, and the above-mentioned SuperPutty tool I use for SSH has a nice WinSCP integration, allowing me to right-click on my bookmark and immediately create a WinSCP session!</p>
<div id="gist96143196">
    <div>
      <div>
        <div>
  <div id="file-initmaster-sh">
    

  <div itemprop="text">
      
<table data-tab-size="8">
      <tbody><tr>
        <td id="file-initmaster-sh-L1" data-line-number="1"></td>
        <td id="file-initmaster-sh-LC1"><span><span>#!</span>/bin/bash</span></td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L2" data-line-number="2"></td>
        <td id="file-initmaster-sh-LC2">
</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L3" data-line-number="3"></td>
        <td id="file-initmaster-sh-LC3"><span><span>#</span> Pre-pull the requisites Docker images needed to run a Kubernetes master</span></td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L4" data-line-number="4"></td>
        <td id="file-initmaster-sh-LC4">kubeadm config images pull -v3</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L5" data-line-number="5"></td>
        <td id="file-initmaster-sh-LC5">
</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L6" data-line-number="6"></td>
        <td id="file-initmaster-sh-LC6"><span><span>#</span> Init master node</span></td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L7" data-line-number="7"></td>
        <td id="file-initmaster-sh-LC7">kubeadm init --token-ttl=0 --pod-network-cidr=10.244.0.0/16 <span><span>#</span> This uses the Flannel pod network addon</span></td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L8" data-line-number="8"></td>
        <td id="file-initmaster-sh-LC8">
</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L9" data-line-number="9"></td>
        <td id="file-initmaster-sh-LC9"><span><span>#</span> Setup local access to the cluster via the kubectl command</span></td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L10" data-line-number="10"></td>
        <td id="file-initmaster-sh-LC10">mkdir -p <span>$HOME</span>/.kube</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L11" data-line-number="11"></td>
        <td id="file-initmaster-sh-LC11">cp -i /etc/kubernetes/admin.conf <span>$HOME</span>/.kube/config</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L12" data-line-number="12"></td>
        <td id="file-initmaster-sh-LC12">chown <span><span>$(</span>id -u<span>)</span></span>:<span><span>$(</span>id -g<span>)</span></span> <span>$HOME</span>/.kube/config</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L13" data-line-number="13"></td>
        <td id="file-initmaster-sh-LC13">
</td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L14" data-line-number="14"></td>
        <td id="file-initmaster-sh-LC14"><span><span>#</span> Install the pod network-addon</span></td>
      </tr>
      <tr>
        <td id="file-initmaster-sh-L15" data-line-number="15"></td>
        <td id="file-initmaster-sh-LC15">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
    <div>
      <div>
        <div>
  <div id="file-installkubernetes-sh">
    

  <div itemprop="text">
      
<table data-tab-size="8">
      <tbody><tr>
        <td id="file-installkubernetes-sh-L1" data-line-number="1"></td>
        <td id="file-installkubernetes-sh-LC1"><span><span>#!</span>/bin/sh</span></td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L2" data-line-number="2"></td>
        <td id="file-installkubernetes-sh-LC2">
</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L3" data-line-number="3"></td>
        <td id="file-installkubernetes-sh-LC3"><span><span>#</span> Install Docker</span></td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L4" data-line-number="4"></td>
        <td id="file-installkubernetes-sh-LC4">curl -sSL get.docker.com <span>|</span> sh <span>&amp;&amp;</span> \</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L5" data-line-number="5"></td>
        <td id="file-installkubernetes-sh-LC5">  sudo usermod pi -aG docker</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L6" data-line-number="6"></td>
        <td id="file-installkubernetes-sh-LC6">
</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L7" data-line-number="7"></td>
        <td id="file-installkubernetes-sh-LC7"><span><span>#</span> Disable swap (needs to be off for Kubernetes)</span></td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L8" data-line-number="8"></td>
        <td id="file-installkubernetes-sh-LC8">sudo dphys-swapfile swapoff <span>&amp;&amp;</span> \</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L9" data-line-number="9"></td>
        <td id="file-installkubernetes-sh-LC9">  sudo dphys-swapfile uninstall <span>&amp;&amp;</span> \</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L10" data-line-number="10"></td>
        <td id="file-installkubernetes-sh-LC10">  sudo update-rc.d dphys-swapfile remove</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L11" data-line-number="11"></td>
        <td id="file-installkubernetes-sh-LC11">
</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L12" data-line-number="12"></td>
        <td id="file-installkubernetes-sh-LC12"><span><span>#</span> Install Kubeadm</span></td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L13" data-line-number="13"></td>
        <td id="file-installkubernetes-sh-LC13">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span>|</span> sudo apt-key add - <span>&amp;&amp;</span> \</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L14" data-line-number="14"></td>
        <td id="file-installkubernetes-sh-LC14">  <span>echo</span> <span><span>"</span>deb http://apt.kubernetes.io/ kubernetes-xenial main<span>"</span></span> <span>|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list <span>&amp;&amp;</span> \</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L15" data-line-number="15"></td>
        <td id="file-installkubernetes-sh-LC15">  sudo apt-get update -q <span>&amp;&amp;</span> \</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L16" data-line-number="16"></td>
        <td id="file-installkubernetes-sh-LC16">  sudo apt-get install -qy kubeadm</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L17" data-line-number="17"></td>
        <td id="file-installkubernetes-sh-LC17">
</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L18" data-line-number="18"></td>
        <td id="file-installkubernetes-sh-LC18"><span><span>#</span> Enable cgroups</span></td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L19" data-line-number="19"></td>
        <td id="file-installkubernetes-sh-LC19"><span>echo</span> Adding <span><span>"</span> cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory<span>"</span></span> to /boot/cmdline.txt</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L20" data-line-number="20"></td>
        <td id="file-installkubernetes-sh-LC20">
</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L21" data-line-number="21"></td>
        <td id="file-installkubernetes-sh-LC21">sudo cp /boot/cmdline.txt /boot/cmdline_backup.txt</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L22" data-line-number="22"></td>
        <td id="file-installkubernetes-sh-LC22">orig=<span><span>"</span><span><span>$(</span>head -n1 /boot/cmdline.txt<span>)</span></span> cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory<span>"</span></span></td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L23" data-line-number="23"></td>
        <td id="file-installkubernetes-sh-LC23"><span>echo</span> <span>$orig</span> <span>|</span> sudo tee /boot/cmdline.txt</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L24" data-line-number="24"></td>
        <td id="file-installkubernetes-sh-LC24">
</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L25" data-line-number="25"></td>
        <td id="file-installkubernetes-sh-LC25"><span><span>#</span> Required for the Flannel network-addon</span></td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L26" data-line-number="26"></td>
        <td id="file-installkubernetes-sh-LC26">sysctl net.bridge.bridge-nf-call-iptables=1</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L27" data-line-number="27"></td>
        <td id="file-installkubernetes-sh-LC27">
</td>
      </tr>
      <tr>
        <td id="file-installkubernetes-sh-L28" data-line-number="28"></td>
        <td id="file-installkubernetes-sh-LC28"><span>echo</span> Please reboot</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>In the talk, I went through the script explaining each bit, but I won't do that here, as a lot of the code from these bash setup scripts have been borrowed from <a href="https://github.com/teamserverless/k8s-on-raspbian">this Github repository</a>, which has quite detailed information in its <a href="https://github.com/teamserverless/k8s-on-raspbian/blob/master/GUIDE.md">GUIDE.md</a> file explaining the different commands. A big thanks to <a href="https://twitter.com/alexellisuk">Alex Ellis</a> for this Github repo - it was a great help!</p>
<p>After you've run the <code>InitMaster.sh</code> script, the console output will mention a "join" command to copy. Make sure you make a note of this. You can then run this command on the other nodes to get them to join the cluster.</p>
<p>And that's it! You now have a fully working Kubernetes cluster running on a cluster of Raspberry Pis!</p>
<h3 id="accessing-the-cluster-remotely">Accessing the Cluster remotely</h3>
<p>Next, we need to access the cluster remotely - in my case, from my laptop. I already have the <a href="https://kubernetes.io/docs/reference/kubectl/overview/">Kubectl</a> command line tool installed locally (it came with Docker). But how do I point it at (and authenticate it with) my Raspberry Pi cluster? If you look back at the <code>InitMaster.sh</code> script above, you'll see that a file called <code>admin.conf</code> is copied to the <code>$HOME/.kube/config</code> folder. You'll need to copy that from the master node (I just used the above-mentioned Winscp to tranfer the file to my laptop). Copy it to your <code>C:\Users\&lt;username&gt;\.kube</code> folder (sorry, I don't know the Mac equivilant). Obviously if you're already using Kubernetes for other stuff, you'll have to merge it with your existing config file instead of overwriting it! Perhaps create a backup of your existing config file before doing this.</p>
<p>Once done, the kubectl commands should interact directly with our Raspberry Pi cluster!</p>
<hr>
<h3 id="the-demo-gods-come-to-play">The Demo Gods come to play :(</h3>
<p><img src="https://danclarkeblogstorage.blob.core.windows.net/images/2019-04-k8spitalk/demo-gods-02b.jpg" alt=""></p>
<p>So now, we've seen our application working and posting to Slack locally - both inside and outside of Docker. The next step is to apply our YAML files to the Raspberry Pi cluster to run our application on our Raspberry Pis! We do this just via the <code>kubectl apply -f .</code> command I mentioned above.</p>
<p>Unfortunately, after explaining Kubernetes, I switched back to the command line where I had left the Docker images being pushed to Docker Hub - and it had timed out due to having no internet!! I checked my mifi device to find that the battery had gone flat! This was the first time I'd used it, so it was surprising that the battery didn't last long at all. In fact, using it since then, strangely, it seems to last much longer.</p>
<p>As we were right at the very end of the hour at this stage, I didn't have time to fix the issue. Frustrating as it was, at least everyone had seen the app running locally on my laptop, and also saw all the steps required for it to run on the Raspberry Pi cluster. It was just the final demo showing it actually working that failed. So <em>really</em>, there wasn't any actual content missed other than seeing a Slack notification message appear - which the audience had already seen working.</p>
<hr>
<h3 id="lessons-learn-for-next-time-i-do-the-talk">Lessons learn for next time I do the talk</h3>
<p>The obvious lesson learnt would be to plug my mifi device into the Anchor USB powerblock that was sat just a few inches away from it anyway! ;) But other than that - I had tried to pack an awful lot into a single hour. Luckily, when I do this talk in <a href="https://www.meetup.com/dotnetoxford/events/261238064/">August at .NET Oxford</a>, I have the entire night (ie. an hour an a half), which feels a much better time for the talk. I'd also like to do more with the Raspberry Pis themselves. Perhaps adding some LEDs into the mix, indicating what Pi our containers are running on. Given the extra time I have at .NET Oxford - I'd also like to demonstrate randomly unplugging the Pis, showing that our application still stays up.</p>
<p>Even with the demo failure at the end, I still had fantastic feedback from the audience via the <a href="https://github.com/RossDScott/PocketDDD">PocketDDD</a> app that the conference was using for feedback. A <em>massive</em> thank you to everyone who came to the talk and gave such amazing feedback - you're all awesome :)</p>
<hr>
<h3 id="links-and-references">Links and References</h3>
<ul>
<li><a href="https://github.com/dracan/k8s-raspberrypi-talk-code">Our final code for our C# 'hello world' app</a></li>
<li><a href="https://www.dropbox.com/s/2ec5feh6piw18qo/KubernetesAndRaspberryPis.pdf?dl=1">Slides</a></li>
<li><a href="https://github.com/teamserverless/k8s-on-raspbian">The Github project mentioned above that I used for reference</a></li>
<li><a href="https://www.modmypi.com/">ModMyPi</a></li>
<li>Software Utilities:
<ul>
<li><a href="https://github.com/jimradford/superputty">SuperPutty</a></li>
<li><a href="https://www.balena.io/etcher/">Etcher</a></li>
<li><a href="https://winscp.net/eng/index.php">WinSCP</a></li>
<li><a href="https://cmder.net/">Cmder</a></li>
</ul>
</li>
</ul>
<hr>
<p><strong>Please retweet if you enjoyed this post ...</strong></p>
<twitter-widget id="twitter-widget-1" data-tweet-id="1128264159014080513"></twitter-widget>


</div>


    
    
    
    
        </div>
        
    </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>