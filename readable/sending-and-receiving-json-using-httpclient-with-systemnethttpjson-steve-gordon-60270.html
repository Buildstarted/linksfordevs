<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Sending and Receiving JSON using HttpClient with System.Net.Http.Json - Steve Gordon - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Sending and Receiving JSON using HttpClient with System.Net.Http.Json - Steve Gordon - linksfor.dev(s)"/>
    <meta property="article:author" content="Steve Gordon"/>
    <meta property="og:description" content="In this post, I introduce System.Net.Http.Json for sending and recieveing JSON content to external services using HttpClient in .NET."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.stevejgordon.co.uk/sending-and-receiving-json-using-httpclient-with-system-net-http-json"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Sending and Receiving JSON using HttpClient with System.Net.Http.Json - Steve Gordon</title>
<div class="readable">
        <h1>Sending and Receiving JSON using HttpClient with System.Net.Http.Json - Steve Gordon</h1>
            <div>by Steve Gordon</div>
            <div>Reading time: 19-24 minutes</div>
        <div>Posted here: 01 Apr 2020</div>
        <p><a href="https://www.stevejgordon.co.uk/sending-and-receiving-json-using-httpclient-with-system-net-http-json">https://www.stevejgordon.co.uk/sending-and-receiving-json-using-httpclient-with-system-net-http-json</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="pryc-wp-acctp-original-content">
<p>In this post, I will introduce a new library, called <strong>System.Net.Http.Json</strong>, which has been added to .NET in the last few days. We’ll look at the problem which this library helps to solve. We’ll then explore some examples of how to use it in your code today.</p>
<p><strong><em>WARNING:&nbsp;This library is currently available as a pre-release package from NuGet. While I expect the public API surface to remain relatively stable, some details may change based on feedback. It’s always worth checking for the latest available package if you begin using this in your applications.</em></strong></p>
<h2>Options Before System.Net.Http.Json</h2>
<p>JSON is a widespread and popular serialisation format for data sent to and from modern web APIs. I often find myself making external HTTP calls using HttpClient to endpoints where I expect JSON content in the response. To handle the response manually, I will typically validate the status code on the response, check the content is not null and then attempt to deserialised from the content Stream when the content type is “application/json”.</p>
<p>Using Newtonsoft.Json, the code would look something like this:</p>



<div id="gist102097859">
    <div>
      <div>
        <div>
  <div id="file-program-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-program-cs-L1" data-line-number="1"></td>
        <td id="file-program-cs-LC1"><span>private</span> <span>static</span> <span>async</span> <span>Task</span>&lt;<span>User</span>&gt; <span>StreamWithNewtonsoftJson</span>(<span>string</span> <span>uri</span>, <span>HttpClient</span> <span>httpClient</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L2" data-line-number="2"></td>
        <td id="file-program-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-program-cs-L3" data-line-number="3"></td>
        <td id="file-program-cs-LC3">    <span>using</span> <span>var</span> <span>httpResponse</span> <span>=</span> <span>await</span> <span>httpClient</span>.<span>GetAsync</span>(<span>uri</span>, <span>HttpCompletionOption</span>.<span>ResponseHeadersRead</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L4" data-line-number="4"></td>
        <td id="file-program-cs-LC4">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L5" data-line-number="5"></td>
        <td id="file-program-cs-LC5">    <span>httpResponse</span>.<span>EnsureSuccessStatusCode</span>(); <span><span>//</span> throws if not 200-299</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L6" data-line-number="6"></td>
        <td id="file-program-cs-LC6">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L7" data-line-number="7"></td>
        <td id="file-program-cs-LC7">    <span>if</span> (<span>httpResponse</span>.<span>Content</span> <span>is</span> <span>object</span> <span>&amp;&amp;</span> <span>httpResponse</span>.<span>Content</span>.<span>Headers</span>.<span>ContentType</span>.<span>MediaType</span> <span>==</span> <span><span>"</span>application/json<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L8" data-line-number="8"></td>
        <td id="file-program-cs-LC8">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L9" data-line-number="9"></td>
        <td id="file-program-cs-LC9">        <span>var</span> <span>contentStream</span> <span>=</span> <span>await</span> <span>httpResponse</span>.<span>Content</span>.<span>ReadAsStreamAsync</span>();</td>
      </tr>
      <tr>
        <td id="file-program-cs-L10" data-line-number="10"></td>
        <td id="file-program-cs-LC10">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L11" data-line-number="11"></td>
        <td id="file-program-cs-LC11">        <span>using</span> <span>var</span> <span>streamReader</span> <span>=</span> <span>new</span> <span>StreamReader</span>(<span>contentStream</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L12" data-line-number="12"></td>
        <td id="file-program-cs-LC12">        <span>using</span> <span>var</span> <span>jsonReader</span> <span>=</span> <span>new</span> <span>JsonTextReader</span>(<span>streamReader</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L13" data-line-number="13"></td>
        <td id="file-program-cs-LC13">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L14" data-line-number="14"></td>
        <td id="file-program-cs-LC14">        <span>JsonSerializer</span> <span>serializer</span> <span>=</span> <span>new</span> <span>JsonSerializer</span>();</td>
      </tr>
      <tr>
        <td id="file-program-cs-L15" data-line-number="15"></td>
        <td id="file-program-cs-LC15">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L16" data-line-number="16"></td>
        <td id="file-program-cs-LC16">        <span>try</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L17" data-line-number="17"></td>
        <td id="file-program-cs-LC17">        {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L18" data-line-number="18"></td>
        <td id="file-program-cs-LC18">            <span>return</span> <span>serializer</span>.<span>Deserialize</span>&lt;<span>User</span>&gt;(<span>jsonReader</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L19" data-line-number="19"></td>
        <td id="file-program-cs-LC19">        }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L20" data-line-number="20"></td>
        <td id="file-program-cs-LC20">        <span>catch</span>(<span>JsonReaderException</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L21" data-line-number="21"></td>
        <td id="file-program-cs-LC21">        {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L22" data-line-number="22"></td>
        <td id="file-program-cs-LC22">            <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>Invalid JSON.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L23" data-line-number="23"></td>
        <td id="file-program-cs-LC23">        } </td>
      </tr>
      <tr>
        <td id="file-program-cs-L24" data-line-number="24"></td>
        <td id="file-program-cs-LC24">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L25" data-line-number="25"></td>
        <td id="file-program-cs-LC25">    <span>else</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L26" data-line-number="26"></td>
        <td id="file-program-cs-LC26">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L27" data-line-number="27"></td>
        <td id="file-program-cs-LC27">        <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>HTTP Response was invalid and cannot be deserialised.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L28" data-line-number="28"></td>
        <td id="file-program-cs-LC28">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L29" data-line-number="29"></td>
        <td id="file-program-cs-LC29">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L30" data-line-number="30"></td>
        <td id="file-program-cs-LC30">    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="file-program-cs-L31" data-line-number="31"></td>
        <td id="file-program-cs-LC31">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>




<p>It’s not a tremendous amount of code, but it’s something that we need to write whenever we receive JSON data from an external service. In a microservices environment, this may be in multiple places, across many individual services.</p>
<p>It’s also possible and tempting to access the JSON as a string using <code>GetStringAsync</code> on the HttpClient or <code>ReadAsStringAsync</code> on the HttpContent. Strings can be deserialised directly by both Newtonsoft.Json and System.Text.Json. The issue with this approach is that the string allocation may be quite significant as it represents the entire JSON payload. This is a wasted allocation since the data already exists as bytes in a Stream which, as I’ve shown above, can be used for deserialization.</p>
<p>By using the stream, it’s also possible to further improve performance, as I wrote about in my post, <a href="https://www.stevejgordon.co.uk/using-httpcompletionoption-responseheadersread-to-improve-httpclient-performance-dotnet">Using HttpCompletionOption to Improve HttpClient Performance</a>.</p>
<p>If you’ve worked with HttpClient in the past and dealt with endpoints which return JSON, you may have utilised the <a href="https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Client" target="_blank" rel="noopener noreferrer">Microsoft.AspNet.WebApi.Client</a> library. I’ve used this in the past as it provides useful extension methods to support efficient JSON deserialization from the content stream on a HttpResponseMessage. This library depends on Newtonsoft.Json and uses its stream-based APIs to support efficient deserialization of data. This is a handy library which I’ve used for a few years.</p>
<p>With this library included in a project, the above code can be reduced.</p>



<div id="gist102097983">
    <div>
      <div>
        <div>
  <div id="file-program-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-program-cs-L1" data-line-number="1"></td>
        <td id="file-program-cs-LC1"><span>private</span> <span>static</span> <span>async</span> <span>Task</span>&lt;<span>User</span>&gt; <span>WebApiClient</span>(<span>string</span> <span>uri</span>, <span>HttpClient</span> <span>httpClient</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L2" data-line-number="2"></td>
        <td id="file-program-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-program-cs-L3" data-line-number="3"></td>
        <td id="file-program-cs-LC3">    <span>using</span> <span>var</span> <span>httpResponse</span> <span>=</span> <span>await</span> <span>httpClient</span>.<span>GetAsync</span>(<span>uri</span>, <span>HttpCompletionOption</span>.<span>ResponseHeadersRead</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L4" data-line-number="4"></td>
        <td id="file-program-cs-LC4">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L5" data-line-number="5"></td>
        <td id="file-program-cs-LC5">    <span>httpResponse</span>.<span>EnsureSuccessStatusCode</span>(); <span><span>//</span> throws if not 200-299</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L6" data-line-number="6"></td>
        <td id="file-program-cs-LC6">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L7" data-line-number="7"></td>
        <td id="file-program-cs-LC7">    <span>try</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L8" data-line-number="8"></td>
        <td id="file-program-cs-LC8">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L9" data-line-number="9"></td>
        <td id="file-program-cs-LC9">        <span>return</span> <span>await</span> <span>httpResponse</span>.<span>Content</span>.<span>ReadAsAsync</span>&lt;<span>User</span>&gt;();</td>
      </tr>
      <tr>
        <td id="file-program-cs-L10" data-line-number="10"></td>
        <td id="file-program-cs-LC10">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L11" data-line-number="11"></td>
        <td id="file-program-cs-LC11">    <span>catch</span> <span><span>//</span> Could be ArgumentNullException or UnsupportedMediaTypeException</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L12" data-line-number="12"></td>
        <td id="file-program-cs-LC12">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L13" data-line-number="13"></td>
        <td id="file-program-cs-LC13">        <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>HTTP Response was invalid or could not be deserialised.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L14" data-line-number="14"></td>
        <td id="file-program-cs-LC14">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L15" data-line-number="15"></td>
        <td id="file-program-cs-LC15">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L16" data-line-number="16"></td>
        <td id="file-program-cs-LC16">    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="file-program-cs-L17" data-line-number="17"></td>
        <td id="file-program-cs-LC17">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>




<p>More recently in .NET, the team introduced a built-in JSON library, System.Text.Json. This library was built from the ground up to make use of the latest .NET performance features such as Span&lt;T&gt;. For low overhead, rapid serialisation and deserialization, this is now my preferred library. It’s included as part of the BCL (Base Class Library) since .NET Core 3.0, so you do not need to reference an additional package to use the library.</p>
<p>Today, I tend to prefer the use of System.Text.Json, mainly when working with a Stream. The code is a little more concise when compared to the first Newtonsoft.Json example above.</p>



<div id="gist102097995">
    <div>
      <div>
        <div>
  <div id="file-program-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-program-cs-L1" data-line-number="1"></td>
        <td id="file-program-cs-LC1"><span>private</span> <span>static</span> <span>async</span> <span>Task</span>&lt;<span>User</span>&gt; <span>StreamWithSystemTextJson</span>(<span>string</span> <span>uri</span>, <span>HttpClient</span> <span>httpClient</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L2" data-line-number="2"></td>
        <td id="file-program-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-program-cs-L3" data-line-number="3"></td>
        <td id="file-program-cs-LC3">    <span>using</span> <span>var</span> <span>httpResponse</span> <span>=</span> <span>await</span> <span>httpClient</span>.<span>GetAsync</span>(<span>uri</span>, <span>HttpCompletionOption</span>.<span>ResponseHeadersRead</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L4" data-line-number="4"></td>
        <td id="file-program-cs-LC4">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L5" data-line-number="5"></td>
        <td id="file-program-cs-LC5">    <span>httpResponse</span>.<span>EnsureSuccessStatusCode</span>(); <span><span>//</span> throws if not 200-299</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L6" data-line-number="6"></td>
        <td id="file-program-cs-LC6">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L7" data-line-number="7"></td>
        <td id="file-program-cs-LC7">    <span>if</span> (<span>httpResponse</span>.<span>Content</span> <span>is</span> <span>object</span> <span>&amp;&amp;</span> <span>httpResponse</span>.<span>Content</span>.<span>Headers</span>.<span>ContentType</span>.<span>MediaType</span> <span>==</span> <span><span>"</span>application/json<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L8" data-line-number="8"></td>
        <td id="file-program-cs-LC8">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L9" data-line-number="9"></td>
        <td id="file-program-cs-LC9">        <span>var</span> <span>contentStream</span> <span>=</span> <span>await</span> <span>httpResponse</span>.<span>Content</span>.<span>ReadAsStreamAsync</span>();</td>
      </tr>
      <tr>
        <td id="file-program-cs-L10" data-line-number="10"></td>
        <td id="file-program-cs-LC10">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L11" data-line-number="11"></td>
        <td id="file-program-cs-LC11">        <span>try</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L12" data-line-number="12"></td>
        <td id="file-program-cs-LC12">        {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L13" data-line-number="13"></td>
        <td id="file-program-cs-LC13">            <span>return</span> <span>await</span> <span>System</span>.<span>Text</span>.<span>Json</span>.<span>JsonSerializer</span>.<span>DeserializeAsync</span>&lt;<span>User</span>&gt;(<span>contentStream</span>, <span>new</span> <span>System</span>.<span>Text</span>.<span>Json</span>.<span>JsonSerializerOptions</span> { <span>IgnoreNullValues</span> <span>=</span> <span>true</span>, <span>PropertyNameCaseInsensitive</span> <span>=</span> <span>true</span> });</td>
      </tr>
      <tr>
        <td id="file-program-cs-L14" data-line-number="14"></td>
        <td id="file-program-cs-LC14">        }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L15" data-line-number="15"></td>
        <td id="file-program-cs-LC15">        <span>catch</span> (<span>JsonException</span>) <span><span>//</span> Invalid JSON</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L16" data-line-number="16"></td>
        <td id="file-program-cs-LC16">        {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L17" data-line-number="17"></td>
        <td id="file-program-cs-LC17">            <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>Invalid JSON.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L18" data-line-number="18"></td>
        <td id="file-program-cs-LC18">        }                </td>
      </tr>
      <tr>
        <td id="file-program-cs-L19" data-line-number="19"></td>
        <td id="file-program-cs-LC19">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L20" data-line-number="20"></td>
        <td id="file-program-cs-LC20">    <span>else</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L21" data-line-number="21"></td>
        <td id="file-program-cs-LC21">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L22" data-line-number="22"></td>
        <td id="file-program-cs-LC22">        <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>HTTP Response was invalid and cannot be deserialised.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L23" data-line-number="23"></td>
        <td id="file-program-cs-LC23">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L24" data-line-number="24"></td>
        <td id="file-program-cs-LC24">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L25" data-line-number="25"></td>
        <td id="file-program-cs-LC25">    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="file-program-cs-L26" data-line-number="26"></td>
        <td id="file-program-cs-LC26">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>




<p>Since it reduces the number of third-party dependencies required in my project and should be more performant, I prefer System.Text.Json. However, while this code is now pretty straightforward, there’s still some boilerplate which I am required to write. From a concise code perspective, the best option so far is to use the Microsoft.AspNet.WebApi.Client extension methods.</p>
<h2>Introducing System.Net.Http.Json</h2>
<p>I’ve been watching the progress of this new library since February when the <a href="https://github.com/dotnet/designs/blob/master/accepted/2020/json-http-extensions/json-http-extentions.md" target="_blank" rel="noopener noreferrer">design</a>&nbsp;and <a href="https://github.com/dotnet/runtime/issues/32937" target="_blank" rel="noopener noreferrer">issue</a> first appeared on GitHub. These document the requirements and the proposed API surface. A summary of the problem statement and objectives is included in the <a href="https://github.com/dotnet/designs/blob/master/accepted/2020/json-http-extensions/json-http-extentions.md" target="_blank" rel="noopener noreferrer">design document</a>.</p>
<blockquote>
<p>Serializing and deserializing JSON payloads from the network is a very common operation for clients, especially in the upcoming Blazor environment. Right now, sending a JSON payload to the server requires multiple lines of code, which will be a major speed bump for those customers. We’d like to add extension methods on top of HttpClient that allows doing those operations with a single method call.</p>
</blockquote>
<p>You can read the full requirements in the design, but a few highlights are that the team required the library to work on .NET Standard 2.1, but 2.0 would be preferred. The team wanted to “Build a pit-of-success for HttpClient and System.Text.Json”. The initial release target is to ship this as a standalone NuGet package at Build, alongside Blazor, which will utilise the APIs.</p>
<p>The initial work has now been completed by <a href="https://github.com/Jozkee" target="_blank" rel="noopener noreferrer">David Cantu</a> at Microsoft and has been merged, ready to the upcoming Blazor release. It is expected to be included as part of the BCL in an upcoming .NET 5 preview. So why am I mentioning it now?</p>
<p>Well, you can grab the <a href="https://www.nuget.org/packages/system.net.http.json" target="_blank" rel="noopener noreferrer">preview package today from NuGet</a>&nbsp;and begin using it in your .NET Standard 2.0 projects. I’ve already pulled it down, and in the remainder of this blog post, I’ll explore a few of the main APIs and usage scenarios which it supports.</p>
<h2>Sending and Receiving JSON Content with HttpClient in .NET</h2>
<p>I’ve put together some basic sample code which I’ve uploaded to a <a href="https://github.com/stevejgordon/SystemNetHttpJsonSamples" target="_blank" rel="noopener noreferrer">GitHub repository</a>. I’ll share most of the code below as snippets.</p>
<p>This first step is to add the package to your project. You can achieve this using the NuGet Package Manager or via a command line with the following command.</p>
<pre>dotnet add package System.Net.Http.Json --version 3.2.0-preview3.20175.8</pre>
<p><em><strong>NOTE: A newer version may be available by the time you are reading this post!</strong></em></p>
<p>In your classes, you can add a using directive to gain access to the extension methods from the library.</p>
<p><code>using System.Net.Http.Json;</code></p>
<h3>Requesting JSON via HttpClient</h3>
<p>Let’s first look an extension method on HttpClient, which is pretty straightforward.</p>



<div id="gist102098291">
    <div>
      <div>
        <div>
  <div id="file-program-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-program-cs-L1" data-line-number="1"></td>
        <td id="file-program-cs-LC1"><span>private</span> <span>static</span> <span>async</span> <span>Task</span>&lt;<span>User</span>&gt; <span>GetJsonHttpClient</span>(<span>string</span> <span>uri</span>, <span>HttpClient</span> <span>httpClient</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L2" data-line-number="2"></td>
        <td id="file-program-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-program-cs-L3" data-line-number="3"></td>
        <td id="file-program-cs-LC3">    <span>try</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L4" data-line-number="4"></td>
        <td id="file-program-cs-LC4">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L5" data-line-number="5"></td>
        <td id="file-program-cs-LC5">        <span>return</span> <span>await</span> <span>httpClient</span>.<span>GetFromJsonAsync</span>&lt;<span>User</span>&gt;(<span>uri</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L6" data-line-number="6"></td>
        <td id="file-program-cs-LC6">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L7" data-line-number="7"></td>
        <td id="file-program-cs-LC7">    <span>catch</span> (<span>HttpRequestException</span>) <span><span>//</span> Non success</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L8" data-line-number="8"></td>
        <td id="file-program-cs-LC8">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L9" data-line-number="9"></td>
        <td id="file-program-cs-LC9">        <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>An error occurred.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L10" data-line-number="10"></td>
        <td id="file-program-cs-LC10">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L11" data-line-number="11"></td>
        <td id="file-program-cs-LC11">    <span>catch</span> (<span>NotSupportedException</span>) <span><span>//</span> When content type is not valid</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L12" data-line-number="12"></td>
        <td id="file-program-cs-LC12">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L13" data-line-number="13"></td>
        <td id="file-program-cs-LC13">        <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>The content type is not supported.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L14" data-line-number="14"></td>
        <td id="file-program-cs-LC14">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L15" data-line-number="15"></td>
        <td id="file-program-cs-LC15">    <span>catch</span> (<span>JsonException</span>) <span><span>//</span> Invalid JSON</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L16" data-line-number="16"></td>
        <td id="file-program-cs-LC16">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L17" data-line-number="17"></td>
        <td id="file-program-cs-LC17">        <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>Invalid JSON.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L18" data-line-number="18"></td>
        <td id="file-program-cs-LC18">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L19" data-line-number="19"></td>
        <td id="file-program-cs-LC19">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L20" data-line-number="20"></td>
        <td id="file-program-cs-LC20">    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="file-program-cs-L21" data-line-number="21"></td>
        <td id="file-program-cs-LC21">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>




<p><span data-preserver-spaces="true">On line 5, we call GetFromJsonAsync passing a type argument of the Type we expect to deserialize the JSON response into. The method accepts the Uri to request data from. And that’s all we need! In a single line, we have issued an HTTP Get request to an endpoint and deserialized the content into a User instance. That’s quite a simplification on the earlier code that I showed.</span><span data-preserver-spaces="true">&nbsp;</span></p>
<p><span data-preserver-spaces="true">The sample above is made more verbose by the exception handling code. Various exceptions may be thrown under different conditions. Here I handle the most likely exceptions, each in their own catch block. This could be simplified if you only require more generic logging of the operation failing.</span><span data-preserver-spaces="true">&nbsp;</span></p>
<p><span data-preserver-spaces="true">The library takes care of most of the earlier requirements. It will ensure that the status code is a success using EnsureSuccessStatusCode. This will cause a HttpRequestException to be thrown when the response is not in the 200-299 status code range.</span><span data-preserver-spaces="true">&nbsp;</span></p>
<p><span data-preserver-spaces="true">The library code will also check for the presence of a valid media type such as “application/json”. If the media type is missing or invalid, a NotSupportedException will be thrown. The check here is more complete than in my manual sample code. If the media type is anything other than “application/json” some Span&lt;T&gt; based parsing of the value will take place. This allows for a media types confirming to this format “application/&lt;something&gt;+json” to be considered valid.</span></p>
<p><span data-preserver-spaces="true">This format is in use today; an example of which can be found in the problem details standard. <a href="https://tools.ietf.org/html/rfc7159" target="_blank" rel="noopener noreferrer">RFC7159</a></span><span data-preserver-spaces="true">&nbsp;defines a way to carry machine-readable details of errors in an HTTP response and used the media type “application/problem+json”. My manual code would not have matched this, but the System.Net.Http.Json library takes care of this for us.</span></p>
<p><span data-preserver-spaces="true">Internally, the ResponseHeadersRead HttpCompletionOption is used for efficiency. I describe how this works in my <a href="https://www.stevejgordon.co.uk/using-httpcompletionoption-responseheadersread-to-improve-httpclient-performance-dotnet">recent post</a>. The library code takes care of proper disposal of the HttpResponseMessage, which is required when this option is used.</span></p>
<h4><span data-preserver-spaces="true">Transcoding</span></h4>
<p><span data-preserver-spaces="true">One final implementation detail of this library is that it includes support for transcoding the data if it is not returned as UTF-8. UTF-8 should be the standard in a vast majority of cases. However, if the charset included with the content-type header identifies a different encoding, a TranscodingStream will be used to try and encode the bytes to UTF-8 before deserialisation takes place.</span></p>
<h3>Handling JSON from HttpContent</h3>
<p>The above code is perfect if and very straightforward when all of the defaults it applies are suitable for your application. In some cases, you may want to send custom headers on the request. Or perhaps you want to inspect the response headers before deserialisation. This is also possible using extensions from System.Net.Http.Json.</p>



<div id="gist102098626">
    <div>
      <div>
        <div>
  <div id="file-program-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-program-cs-L1" data-line-number="1"></td>
        <td id="file-program-cs-LC1"><span>private</span> <span>static</span> <span>async</span> <span>Task</span>&lt;<span>User</span>&gt; <span>GetJsonFromContent</span>(<span>string</span> <span>uri</span>, <span>HttpClient</span> <span>httpClient</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L2" data-line-number="2"></td>
        <td id="file-program-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-program-cs-L3" data-line-number="3"></td>
        <td id="file-program-cs-LC3">    <span>var</span> <span>request</span> <span>=</span> <span>new</span> <span>HttpRequestMessage</span>(<span>HttpMethod</span>.<span>Get</span>, <span>uri</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L4" data-line-number="4"></td>
        <td id="file-program-cs-LC4">    <span>request</span>.<span>Headers</span>.<span>TryAddWithoutValidation</span>(<span><span>"</span>some-header<span>"</span></span>, <span><span>"</span>some-value<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L5" data-line-number="5"></td>
        <td id="file-program-cs-LC5">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L6" data-line-number="6"></td>
        <td id="file-program-cs-LC6">    <span>using</span> <span>var</span> <span>response</span> <span>=</span> <span>await</span> <span>httpClient</span>.<span>SendAsync</span>(<span>request</span>, <span>HttpCompletionOption</span>.<span>ResponseHeadersRead</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L7" data-line-number="7"></td>
        <td id="file-program-cs-LC7">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L8" data-line-number="8"></td>
        <td id="file-program-cs-LC8">    <span>if</span> (<span>response</span>.<span>IsSuccessStatusCode</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L9" data-line-number="9"></td>
        <td id="file-program-cs-LC9">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L10" data-line-number="10"></td>
        <td id="file-program-cs-LC10">        <span><span>//</span> perhaps check some headers before deserialising</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L11" data-line-number="11"></td>
        <td id="file-program-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L12" data-line-number="12"></td>
        <td id="file-program-cs-LC12">        <span>try</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L13" data-line-number="13"></td>
        <td id="file-program-cs-LC13">        {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L14" data-line-number="14"></td>
        <td id="file-program-cs-LC14">            <span>return</span> <span>await</span> <span>response</span>.<span>Content</span>.<span>ReadFromJsonAsync</span>&lt;<span>User</span>&gt;();</td>
      </tr>
      <tr>
        <td id="file-program-cs-L15" data-line-number="15"></td>
        <td id="file-program-cs-LC15">        }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L16" data-line-number="16"></td>
        <td id="file-program-cs-LC16">        <span>catch</span> (<span>NotSupportedException</span>) <span><span>//</span> When content type is not valid</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L17" data-line-number="17"></td>
        <td id="file-program-cs-LC17">        {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L18" data-line-number="18"></td>
        <td id="file-program-cs-LC18">            <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>The content type is not supported.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L19" data-line-number="19"></td>
        <td id="file-program-cs-LC19">        }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L20" data-line-number="20"></td>
        <td id="file-program-cs-LC20">        <span>catch</span> (<span>JsonException</span>) <span><span>//</span> Invalid JSON</span></td>
      </tr>
      <tr>
        <td id="file-program-cs-L21" data-line-number="21"></td>
        <td id="file-program-cs-LC21">        {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L22" data-line-number="22"></td>
        <td id="file-program-cs-LC22">            <span>Console</span>.<span>WriteLine</span>(<span><span>"</span>Invalid JSON.<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L23" data-line-number="23"></td>
        <td id="file-program-cs-LC23">        }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L24" data-line-number="24"></td>
        <td id="file-program-cs-LC24">    }</td>
      </tr>
      <tr>
        <td id="file-program-cs-L25" data-line-number="25"></td>
        <td id="file-program-cs-LC25">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L26" data-line-number="26"></td>
        <td id="file-program-cs-LC26">    <span>return</span> <span>null</span>;</td>
      </tr>
      <tr>
        <td id="file-program-cs-L27" data-line-number="27"></td>
        <td id="file-program-cs-LC27">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>




<p>In the preceding code, we have responsibility for creating and sending the HttpRequestMessage. In this sample, we’re able to customise the HttpRequestMessage to include an additional header. We can now use the SendAsync method on HttpClient to issue the request. Having confirmed that the response returned a success status code, we call the ReadFromJsonAsync extension method on the HttpContent.</p>
<p>We can still handle the NotSupportedException and JsonException which may be thrown if the content is not valid for JSON deserialisation.</p>
<h3>Posting JSON Data</h3>
<p>The final sample we’ll look at concerns sending JSON data as part of a POST request. Let’s look at two approaches to achieve this.</p>



<div id="gist102098728">
    <div>
      <div>
        <div>
  <div id="file-program-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-program-cs-L1" data-line-number="1"></td>
        <td id="file-program-cs-LC1"><span>private</span> <span>static</span> <span>async</span> <span>Task</span> <span>PostJsonHttpClient</span>(<span>string</span> <span>uri</span>, <span>HttpClient</span> <span>httpClient</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L2" data-line-number="2"></td>
        <td id="file-program-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-program-cs-L3" data-line-number="3"></td>
        <td id="file-program-cs-LC3">    <span>var</span> <span>postUser</span> <span>=</span> <span>new</span> <span>User</span> { <span>Name</span> <span>=</span> <span><span>"</span>Steve Gordon<span>"</span></span> };</td>
      </tr>
      <tr>
        <td id="file-program-cs-L4" data-line-number="4"></td>
        <td id="file-program-cs-LC4">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L5" data-line-number="5"></td>
        <td id="file-program-cs-LC5">    <span>var</span> <span>postResponse</span> <span>=</span> <span>await</span> <span>httpClient</span>.<span>PostAsJsonAsync</span>(<span>uri</span>, <span>postUser</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L6" data-line-number="6"></td>
        <td id="file-program-cs-LC6">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L7" data-line-number="7"></td>
        <td id="file-program-cs-LC7">    <span>postResponse</span>.<span>EnsureSuccessStatusCode</span>();</td>
      </tr>
      <tr>
        <td id="file-program-cs-L8" data-line-number="8"></td>
        <td id="file-program-cs-LC8">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>




<p>This first method uses the PostAsJsonAsync extension method on the HttpClient. It accepts the URI to POST the data to, and an object which we expect to be serialised to JSON. Internally it will build a HttpRequestMessage and serialise the object to the content stream.</p>
<p>In situations where you are manually creating a HttpRequestMessage, perhaps to include custom headers, you may create JsonContent directly.</p>



<div id="gist102098752">
    <div>
      <div>
        <div>
  <div id="file-program-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-program-cs-L1" data-line-number="1"></td>
        <td id="file-program-cs-LC1"><span>private</span> <span>static</span> <span>async</span> <span>Task</span> <span>PostJsonContent</span>(<span>string</span> <span>uri</span>, <span>HttpClient</span> <span>httpClient</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L2" data-line-number="2"></td>
        <td id="file-program-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-program-cs-L3" data-line-number="3"></td>
        <td id="file-program-cs-LC3">    <span>var</span> <span>postUser</span> <span>=</span> <span>new</span> <span>User</span> { <span>Name</span> <span>=</span> <span><span>"</span>Steve Gordon<span>"</span></span> };</td>
      </tr>
      <tr>
        <td id="file-program-cs-L4" data-line-number="4"></td>
        <td id="file-program-cs-LC4">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L5" data-line-number="5"></td>
        <td id="file-program-cs-LC5">    <span>var</span> <span>postRequest</span> <span>=</span> <span>new</span> <span>HttpRequestMessage</span>(<span>HttpMethod</span>.<span>Post</span>, <span>uri</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L6" data-line-number="6"></td>
        <td id="file-program-cs-LC6">    {</td>
      </tr>
      <tr>
        <td id="file-program-cs-L7" data-line-number="7"></td>
        <td id="file-program-cs-LC7">        <span>Content</span> <span>=</span> <span>JsonContent</span>.<span>Create</span>(<span>postUser</span>)</td>
      </tr>
      <tr>
        <td id="file-program-cs-L8" data-line-number="8"></td>
        <td id="file-program-cs-LC8">    };</td>
      </tr>
      <tr>
        <td id="file-program-cs-L9" data-line-number="9"></td>
        <td id="file-program-cs-LC9">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L10" data-line-number="10"></td>
        <td id="file-program-cs-LC10">    <span>var</span> <span>postResponse</span> <span>=</span> <span>await</span> <span>httpClient</span>.<span>SendAsync</span>(<span>postRequest</span>);</td>
      </tr>
      <tr>
        <td id="file-program-cs-L11" data-line-number="11"></td>
        <td id="file-program-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-program-cs-L12" data-line-number="12"></td>
        <td id="file-program-cs-LC12">    <span>postResponse</span>.<span>EnsureSuccessStatusCode</span>();</td>
      </tr>
      <tr>
        <td id="file-program-cs-L13" data-line-number="13"></td>
        <td id="file-program-cs-LC13">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>




<p>In the above code, we use the Create factory method to create a JsonContent instance, passing in an object to be serialised. JsonContent is a new type, added by System.Net.Http.Json, which subclasses HttpContent. Internally it handles object serialisation using System.Text.Json.</p>
<h2>Summary</h2>
<p>In this post, we reviewed some of the traditional approaches that could be used to deserialise content from a HttpResponseMessage into an object. We saw that the when manually calling APIs to parse the JSON, it required us to consider things like first ensuring the response was a success, and that the response is an expected media type.</p>
<p>We looked at the ReadAsAsync method provided by the Microsoft.AspNet.WebApi.Client library. Internally the library uses Newtonsoft.Json for efficient, stream-based deserialisation.</p>
<p>We concluded by introducing the new System.Net.Http.Json library, which added supports for JSON content, serialised and deserialised using System.Text.Json. This avoids a third-party dependency on Newtonsoft.Json and should be more performant in many cases, due to its Span&lt;T&gt; optimisations.</p>
<p>We then used various extension methods provided by System.Net.Http.Json to send and receive JSON data via HttpClient. In common cases, this can reduce your code down to only a few lines, and ensures consistent checking of things like valid media types.</p>
<p>As a reminder, you can grab the code for these <a href="https://github.com/stevejgordon/SystemNetHttpJsonSamples" target="_blank" rel="noopener noreferrer">samples from my GitHub repository</a>.</p>
<!-- PRyC WP: Add custom content to bottom of post/page: Standard Content START --></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>