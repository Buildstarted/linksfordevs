<!DOCTYPE html>
<html lang="en">
<head>
    <title>
OH Picker | Swedish Cubes for Unity Blog - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="OH Picker | Swedish Cubes for Unity Blog - linksfor.dev(s)"/>
    <meta property="article:author" content="Oswald Hurlem"/>
    <meta property="og:description" content="I&#x27;ve posted a new project on GitHub. It is a finished project in that I did what I wanted to do a&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://yave.handmade.network/blogs/p/3376-oh_picker"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - OH Picker | Swedish Cubes for Unity Blog</title>
<div class="readable">
        <h1>OH Picker | Swedish Cubes for Unity Blog</h1>
            <div>by Oswald Hurlem</div>
            <div>Reading time: 12-15 minutes</div>
        <div>Posted here: 27 Feb 2019</div>
        <p><a href="https://yave.handmade.network/blogs/p/3376-oh_picker">https://yave.handmade.network/blogs/p/3376-oh_picker</a></p>
        <hr/>
<div id="readability-page-1" class="page"><p><a href="http://www.ece.rochester.edu/~gsharma/papers/SharmaDarkSideColorEI2012.pdf" rel="nofollow" target="_blank">Lab isn't perfect</a> (but it's certainly good enough to be of practical use). I'm interested in knowing if any research is happening today to develop a better Lab.
</p><p>
At my previous job I implemented CIEDE2000 in D and an OpenCL kernel for RGB to LAB
</p><div><table><tbody><tr><td><div><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287</pre></div></td><td><div><pre><span></span><span>/++</span> <span>Colour</span> <span>conversion</span> <span>and</span> <span>comparison</span>
  <span>+</span> <span>Authors</span><span>:</span> <span>Mio</span> <span>Iwakura</span><span>,</span> <span>mio</span><span>.</span><span>iwakura</span><span>@gmail.com</span> <span>+/</span>
<span>module</span> <span>treecount</span><span>.</span><span>colours</span><span>;</span>
<span>import</span> <span>core.stdc.stdio</span><span>;</span>
<span>import</span> <span>std.math</span><span>,</span> <span>std.range</span><span>,</span> <span>std.stdio</span><span>;</span>
<span>import</span> <span>gl3n.linalg</span><span>;</span>
<span>import</span> <span>treecount.coords</span><span>,</span> <span>treecount.globals</span><span>,</span> <span>treecount.math</span><span>;</span>

<span>/++</span> <span>The</span> <span>CIEDE2000</span> <span>algorithm</span> <span>for</span> <span>computing</span> <span>the</span> <span>difference</span> <span>between</span> <span>two</span> <span>colours</span>
  <span>+</span>
  <span>+</span> <span>Adjusting</span> <span>the</span> <span>weighting</span> <span>factors</span> <span>is</span> <span>not</span> <span>recommended</span> <span>unless</span> <span>you</span> <span>know</span> <span>what</span> <span>you</span>
  <span>+</span> <span>are</span> <span>doing</span><span>.</span> <span>For</span> <span>our</span> <span>purposes</span><span>,</span> <span>the</span> <span>defaults</span> <span>of</span> <span>1.0</span> <span>are</span> <span>currently</span> <span>used</span><span>.</span>
  <span>+</span>
  <span>+</span> <span>If</span> <span>you</span> <span>compile</span> <span>with</span> <span>the</span> <span>debug</span> <span>tag</span> <span>`deltaE_00`</span><span>,</span> <span>intermediate</span> <span>values</span> <span>will</span> <span>be</span>
  <span>+</span> <span>printed</span> <span>to</span> <span>standard</span> <span>out</span> <span>for</span> <span>every</span> <span>invocation</span> <span>of</span> <span>the</span> <span>function</span> <span>for</span> <span>debugging</span>
  <span>+</span> <span>purposes</span><span>.</span>
  <span>+</span> <span>Standards</span><span>:</span> <span>Conforms</span> <span>to</span> <span>CIEDE2000</span> <span>specification</span>
  <span>+</span> <span>Returns</span><span>:</span> <span>The</span> <span>difference</span> <span>between</span> <span>the</span> <span>two</span> <span>input</span> <span>colours</span> <span>as</span> <span>defined</span> <span>by</span> <span>the</span>
  <span>+</span>          <span>CIEDE2000</span> <span>algorithm</span><span>.</span> <span>Small</span> <span>values</span> <span>mean</span> <span>the</span> <span>colours</span> <span>are</span> <span>close</span><span>,</span>
  <span>+</span>          <span>big</span> <span>values</span> <span>mean</span> <span>they</span> <span>are</span> <span>far</span> <span>away</span><span>.</span> <span>The</span> <span>range</span> <span>of</span> <span>values</span> <span>seems</span> <span>to</span>
  <span>+</span>          <span>be</span> <span>around</span> <span>[</span><span>0</span><span>,</span> <span>100</span><span>]</span> <span>but</span> <span>I</span><span>'m not an expert on this algorithm and did</span>
  <span>+</span>          <span>not</span> <span>find</span> <span>clear</span> <span>documentation</span> <span>regarding</span> <span>the</span> <span>range</span> <span>of</span> <span>values</span> <span>produced</span>
  <span>+</span>          <span>by</span> <span>the</span> <span>algorithm</span><span>.</span>
  <span>+</span> <span>Params</span><span>:</span>
  <span>+</span>     <span>colour1</span> <span>=</span> <span>The</span> <span>first</span> <span>input</span> <span>colour</span>
  <span>+</span>     <span>colour2</span> <span>=</span> <span>The</span> <span>second</span> <span>input</span> <span>colour</span>
  <span>+</span>     <span>kL</span> <span>=</span> <span>A</span> <span>weighting</span> <span>factor</span> <span>for</span> <span>lightness</span>
  <span>+</span>     <span>kC</span> <span>=</span> <span>A</span> <span>weighting</span> <span>factor</span> <span>for</span> <span>chroma</span>
  <span>+</span>     <span>kH</span> <span>=</span> <span>A</span> <span>weighting</span> <span>factor</span> <span>for</span> <span>hue</span>
  <span>+</span> <span>Bugs</span><span>:</span> <span>The</span> <span>unit</span> <span>tests</span> <span>all</span> <span>pass</span> <span>with</span> <span>phobos</span><span>'s default std.math.approxEqual,</span>
  <span>+</span>       <span>but</span> <span>I</span><span>'ve noticed small discrepancies, a few of which are documented</span>
  <span>+</span>       <span>in</span> <span>code</span> <span>comments</span><span>.</span> <span>If</span> <span>you</span> <span>have</span> <span>any</span> <span>insights</span> <span>or</span> <span>suggestions</span><span>,</span> <span>please</span>
  <span>+</span>       <span>don</span><span>'t hesitate to submit an issue and/or open a pull request!</span>
  <span>+</span>       <span>Github</span> <span>issues</span> <span>is</span> <span>the</span> <span>prefered</span> <span>platform</span> <span>for</span> <span>discussion</span><span>,</span> <span>but</span> <span>if</span>
  <span>+</span>       <span>nothing</span> <span>else</span><span>,</span> <span>you</span> <span>can</span> <span>contact</span> <span>the</span> <span>author</span> <span>of</span> <span>this</span> <span>module</span> <span>by</span> <span>email</span><span>.</span>
  <span>+</span> <span>See_Also</span><span>:</span>
  <span>+</span>     <span>$</span><span>(</span><span>LINK</span> <span>http</span><span>:</span><span>//</span><span>www</span><span>.</span><span>ece</span><span>.</span><span>rochester</span><span>.</span><span>edu</span><span>/~</span><span>gsharma</span><span>/</span><span>ciede2000</span><span>/</span><span>ciede2000noteCRNA</span><span>.</span><span>pdf</span><span>)</span> <span>+/</span>
<span>float</span> <span>deltaE_00</span><span>(</span><span>in</span> <span>Lab</span> <span>colour1</span><span>,</span> <span>in</span> <span>Lab</span> <span>colour2</span><span>,</span> <span>in</span> <span>float</span> <span>kL</span> <span>=</span> <span>1.0</span><span>,</span> <span>in</span> <span>float</span> <span>kC</span> <span>=</span> <span>1.0</span><span>,</span>
    <span>in</span> <span>float</span> <span>kH</span> <span>=</span> <span>1.0</span><span>)</span> <span>pure</span> <span>nothrow</span> <span>@nogc</span> <span>@trusted</span>
<span>{</span>
    <span>/*</span> <span>The</span> <span>number</span> <span>comments</span> <span>correspond</span> <span>to</span> <span>sections</span> <span>in</span>
     <span>*</span> <span>"The CIEDE2000 Color-Difference Formula: Implementation Notes,</span>
     <span>*</span>  <span>Supplementary</span> <span>Test</span> <span>Data</span><span>,</span> <span>and</span> <span>Mathematical</span> <span>Observations</span><span>" */</span>
    <span>/*</span> <span>1.</span> <span>*/</span>
    <span>//</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>
    <span>immutable</span> <span>avgC</span> <span>=</span> <span>(</span><span>hypot</span><span>(</span><span>colour1</span><span>.</span><span>a</span><span>,</span> <span>colour1</span><span>.</span><span>b</span><span>)</span> <span>+</span> <span>hypot</span><span>(</span><span>colour2</span><span>.</span><span>a</span><span>,</span> <span>colour2</span><span>.</span><span>b</span><span>))</span> <span>/</span> <span>2</span><span>;</span>
    <span>//</span><span>(</span><span>4</span><span>)</span>
    <span>immutable</span> <span>G</span> <span>=</span> <span>0.5</span> <span>*</span> <span>(</span><span>1</span> <span>-</span> <span>sqrt</span><span>(</span><span>avgC</span> <span>^^</span> <span>7</span> <span>/</span> <span>(</span><span>avgC</span> <span>^^</span> <span>7</span> <span>+</span> <span>25L</span> <span>^^</span> <span>7</span><span>)));</span>
    <span>auto</span> <span>a</span><span>(</span><span>float</span> <span>colourA</span><span>)</span> <span>pure</span> <span>nothrow</span> <span>@nogc</span> <span>@safe</span>
    <span>{</span>
        <span>immutable</span> <span>result</span> <span>=</span> <span>(</span><span>1</span> <span>+</span> <span>G</span><span>)</span> <span>*</span> <span>colourA</span><span>;</span>
        <span>return</span> <span>result</span><span>;</span>
    <span>}</span>
    <span>//</span><span>(</span><span>5</span><span>)</span>
    <span>immutable</span> <span>a1</span> <span>=</span> <span>a</span><span>(</span><span>colour1</span><span>.</span><span>a</span><span>);</span>
    <span>immutable</span> <span>a2</span> <span>=</span> <span>a</span><span>(</span><span>colour2</span><span>.</span><span>a</span><span>);</span>
    <span>//</span><span>BUG</span><span>:</span> <span>pair</span> <span>22</span> <span>a2</span> <span>-&gt;</span> <span>4.9449</span> <span>instead</span> <span>of</span> <span>4.9450</span>
    <span>//</span>     <span>4.94492</span><span>,</span> <span>these</span> <span>bugs</span> <span>aren</span><span>'t just bankers rounding!</span>
    <span>//</span><span>NOTE</span><span>:</span> <span>equations</span> <span>6</span><span>-</span><span>7</span> <span>are</span> <span>Lab</span> <span>-&gt;</span> <span>LCh</span>
    <span>//</span><span>(</span><span>6</span><span>)</span>
    <span>immutable</span> <span>C1</span> <span>=</span> <span>hypot</span><span>(</span><span>a1</span><span>,</span> <span>colour1</span><span>.</span><span>b</span><span>);</span>
    <span>immutable</span> <span>C2</span> <span>=</span> <span>hypot</span><span>(</span><span>a2</span><span>,</span> <span>colour2</span><span>.</span><span>b</span><span>);</span>
    <span>//</span><span>BUG</span><span>:</span> <span>pair</span> <span>21</span> <span>C2</span> <span>-&gt;</span> <span>4.7955</span> <span>instead</span> <span>of</span> <span>4.7954</span>
    <span>//</span><span>BUG</span><span>:</span> <span>pair</span> <span>22</span> <span>C2</span> <span>-&gt;</span> <span>4.9449</span> <span>instead</span> <span>of</span> <span>4.9450</span>
    <span>auto</span> <span>h</span><span>(</span><span>float</span> <span>a</span><span>,</span> <span>float</span> <span>b</span><span>)</span> <span>pure</span> <span>nothrow</span> <span>@nogc</span> <span>@safe</span>
    <span>{</span>
        <span>//</span><span>article</span> <span>does</span> <span>not</span> <span>mention</span> <span>floating</span> <span>point</span> <span>quirks</span><span>,</span>
        <span>//</span><span>but</span> <span>I</span> <span>assume</span> <span>accounting</span> <span>for</span> <span>it</span> <span>is</span> <span>necessary</span>
        <span>immutable</span> <span>result</span> <span>=</span> <span>a</span><span>.</span><span>approxEqual</span><span>(</span><span>0</span><span>)</span> <span>&amp;&amp;</span> <span>b</span><span>.</span><span>approxEqual</span><span>(</span><span>0</span><span>)</span> <span>?</span> <span>0</span> <span>:</span> <span>atan2</span><span>(</span><span>b</span><span>,</span> <span>a</span><span>)</span><span>.</span><span>toDegrees</span><span>();</span>
        <span>return</span> <span>result</span><span>;</span>
    <span>}</span>
    <span>//</span><span>(</span><span>7</span><span>)</span>
    <span>immutable</span> <span>h1</span> <span>=</span> <span>h</span><span>(</span><span>a1</span><span>,</span> <span>colour1</span><span>.</span><span>b</span><span>);</span>
    <span>//</span><span>BUG</span><span>:</span> <span>various</span> <span>values</span> <span>are</span> <span>slightly</span> <span>off</span>
    <span>immutable</span> <span>h2</span> <span>=</span> <span>h</span><span>(</span><span>a2</span><span>,</span> <span>colour2</span><span>.</span><span>b</span><span>);</span>
    <span>/*</span> <span>2.</span> <span>*/</span>
    <span>//</span><span>(</span><span>8</span><span>)</span>
    <span>immutable</span> <span>deltaL</span> <span>=</span> <span>colour2</span><span>.</span><span>L</span> <span>-</span> <span>colour1</span><span>.</span><span>L</span><span>;</span>
    <span>//</span><span>(</span><span>9</span><span>)</span>
    <span>immutable</span> <span>deltaC</span> <span>=</span> <span>C2</span> <span>-</span> <span>C1</span><span>;</span>
    <span>//</span><span>(</span><span>10</span><span>)</span>
    <span>immutable</span> <span>C1C2</span> <span>=</span> <span>C1</span> <span>*</span> <span>C2</span><span>;</span>
    <span>float</span> <span>deltah</span> <span>=</span> <span>h2</span> <span>-</span> <span>h1</span><span>;</span>
    <span>if</span> <span>(</span><span>C1C2</span><span>.</span><span>approxEqual</span><span>(</span><span>0.0</span><span>))</span>
        <span>deltah</span> <span>=</span> <span>0.0</span><span>;</span>
    <span>else</span> <span>if</span> <span>(</span><span>deltah</span> <span>&gt;</span> <span>180.0</span><span>)</span>
        <span>deltah</span> <span>-=</span> <span>360.0</span><span>;</span>
    <span>else</span> <span>if</span> <span>(</span><span>deltah</span> <span>&lt;</span> <span>-</span><span>180.0</span><span>)</span>
        <span>deltah</span> <span>+=</span> <span>360.0</span><span>;</span>
    <span>//</span><span>(</span><span>11</span><span>)</span>
    <span>immutable</span> <span>deltaH</span> <span>=</span> <span>2</span> <span>*</span> <span>sqrt</span><span>(</span><span>C1C2</span><span>)</span> <span>*</span> <span>sin</span><span>((</span><span>deltah</span> <span>/</span> <span>2</span><span>)</span><span>.</span><span>toRadians</span><span>());</span>
    <span>/*</span> <span>3.</span> <span>*/</span>
    <span>//</span><span>(</span><span>12</span><span>)</span>
    <span>immutable</span> <span>avgL</span> <span>=</span> <span>(</span><span>colour1</span><span>.</span><span>L</span> <span>+</span> <span>colour2</span><span>.</span><span>L</span><span>)</span> <span>/</span> <span>2</span><span>;</span>
    <span>//</span><span>(</span><span>13</span><span>)</span>
    <span>immutable</span> <span>avgNewC</span> <span>=</span> <span>(</span><span>C1</span> <span>+</span> <span>C2</span><span>)</span> <span>/</span> <span>2</span><span>;</span>
    <span>//</span><span>(</span><span>14</span><span>)</span>
    <span>float</span> <span>avgh</span><span>;</span>
    <span>{</span>
        <span>immutable</span> <span>h1ph2</span> <span>=</span> <span>h1</span> <span>+</span> <span>h2</span><span>;</span>
        <span>if</span> <span>(</span><span>C1C2</span><span>.</span><span>approxEqual</span><span>(</span><span>0.0</span><span>))</span>
            <span>avgh</span> <span>=</span> <span>h1ph2</span><span>;</span>
        <span>else</span> <span>if</span> <span>(</span><span>abs</span><span>(</span><span>h1</span> <span>-</span> <span>h2</span><span>)</span> <span>&lt;=</span> <span>180.0</span><span>)</span>
            <span>avgh</span> <span>=</span> <span>h1ph2</span> <span>/</span> <span>2.0</span><span>;</span>
        <span>else</span> <span>if</span> <span>(</span><span>h1ph2</span> <span>&lt;</span> <span>360.0</span><span>)</span>
            <span>avgh</span> <span>=</span> <span>(</span><span>h1ph2</span> <span>+</span> <span>360.0</span><span>)</span> <span>/</span> <span>2.0</span><span>;</span>
        <span>else</span>
            <span>avgh</span> <span>=</span> <span>(</span><span>h1ph2</span> <span>-</span> <span>360.0</span><span>)</span> <span>/</span> <span>2.0</span><span>;</span>
    <span>}</span>
    <span>//</span><span>(</span><span>15</span><span>)</span>
    <span>immutable</span> <span>T</span> <span>=</span> <span>1</span> <span>-</span> <span>0.17</span> <span>*</span> <span>cos</span><span>((</span><span>avgh</span> <span>-</span> <span>30</span><span>)</span><span>.</span><span>toRadians</span><span>())</span> <span>+</span> <span>0.24</span> <span>*</span> <span>cos</span><span>((</span><span>2</span> <span>*</span> <span>avgh</span><span>)</span><span>.</span><span>toRadians</span><span>())</span> <span>+</span> <span>0.32</span> <span>*</span> <span>cos</span><span>(</span>
        <span>(</span><span>3</span> <span>*</span> <span>avgh</span> <span>+</span> <span>6</span><span>)</span><span>.</span><span>toRadians</span><span>())</span> <span>-</span> <span>0.20</span> <span>*</span> <span>cos</span><span>((</span><span>4</span> <span>*</span> <span>avgh</span> <span>-</span> <span>63</span><span>)</span><span>.</span><span>toRadians</span><span>());</span>
    <span>//</span><span>(</span><span>16</span><span>)</span>
    <span>immutable</span> <span>deltaTheta</span> <span>=</span> <span>30</span> <span>*</span> <span>exp</span><span>(</span><span>-</span><span>1</span> <span>*</span> <span>((</span><span>avgh</span> <span>-</span> <span>275</span><span>)</span> <span>/</span> <span>25</span><span>)</span> <span>^^</span> <span>2</span><span>);</span>
    <span>//</span><span>(</span><span>17</span><span>)</span>
    <span>immutable</span> <span>RC</span> <span>=</span> <span>2</span> <span>*</span> <span>sqrt</span><span>(</span><span>avgNewC</span> <span>^^</span> <span>7</span> <span>/</span> <span>(</span><span>avgNewC</span> <span>^^</span> <span>7</span> <span>+</span> <span>25L</span> <span>^^</span> <span>7</span><span>));</span>
    <span>//</span><span>(</span><span>18</span><span>)</span>
    <span>immutable</span> <span>SL</span> <span>=</span> <span>1</span> <span>+</span> <span>(</span><span>0.015</span> <span>*</span> <span>(</span><span>avgL</span> <span>-</span> <span>50</span><span>)</span> <span>^^</span> <span>2</span><span>)</span> <span>/</span> <span>(</span><span>sqrt</span><span>(</span><span>20</span> <span>+</span> <span>(</span><span>avgL</span> <span>-</span> <span>50</span><span>)</span> <span>^^</span> <span>2</span><span>));</span>
    <span>//</span><span>(</span><span>19</span><span>)</span>
    <span>immutable</span> <span>SC</span> <span>=</span> <span>1</span> <span>+</span> <span>0.045</span> <span>*</span> <span>avgNewC</span><span>;</span>
    <span>//</span><span>(</span><span>20</span><span>)</span>
    <span>immutable</span> <span>SH</span> <span>=</span> <span>1</span> <span>+</span> <span>0.015</span> <span>*</span> <span>avgNewC</span> <span>*</span> <span>T</span><span>;</span>
    <span>//</span><span>(</span><span>21</span><span>)</span>
    <span>immutable</span> <span>RT</span> <span>=</span> <span>-</span><span>1</span> <span>*</span> <span>sin</span><span>((</span><span>2</span> <span>*</span> <span>deltaTheta</span><span>)</span><span>.</span><span>toRadians</span><span>())</span> <span>*</span> <span>RC</span><span>;</span>
    <span>//</span><span>(</span><span>22</span><span>)</span>
    <span>immutable</span> <span>dCdkCSC</span> <span>=</span> <span>deltaC</span> <span>/</span> <span>(</span><span>kC</span> <span>*</span> <span>SC</span><span>);</span>
    <span>immutable</span> <span>dHdkHSH</span> <span>=</span> <span>deltaH</span> <span>/</span> <span>(</span><span>kH</span> <span>*</span> <span>SH</span><span>);</span>
    <span>debug</span> <span>(</span><span>deltaE_00</span><span>)</span>
    <span>{</span>
        <span>printf</span><span>(</span>
            <span>"</span><span>%.4f</span><span>\t</span><span>%.4f</span><span>\t</span><span>%.4f</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4lf</span><span>\t</span><span>%.4lf</span><span>\t</span><span>"</span> <span>~</span> <span>"</span><span>%.4Lf</span><span>\t</span><span>%.4lf</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4Lf</span><span>\n</span><span>"</span><span>,</span>
            <span>colour1</span><span>.</span><span>L</span><span>,</span> <span>colour1</span><span>.</span><span>a</span><span>,</span> <span>colour1</span><span>.</span><span>b</span><span>,</span> <span>a1</span><span>,</span> <span>C1</span><span>,</span> <span>h1</span><span>,</span> <span>avgh</span><span>,</span> <span>G</span><span>,</span> <span>T</span><span>,</span> <span>SL</span><span>,</span> <span>SC</span><span>,</span>
            <span>SH</span><span>,</span> <span>RT</span><span>,</span> <span>sqrt</span><span>((</span><span>deltaL</span> <span>/</span> <span>(</span><span>kL</span> <span>*</span> <span>SL</span><span>))</span> <span>^^</span> <span>2</span> <span>+</span> <span>dCdkCSC</span> <span>^^</span> <span>2</span> <span>+</span> <span>dHdkHSH</span> <span>^^</span> <span>2</span> <span>+</span> <span>RT</span> <span>*</span> <span>dCdkCSC</span> <span>*</span> <span>dHdkHSH</span><span>));</span>
        <span>printf</span><span>(</span><span>"</span><span>%.4f</span><span>\t</span><span>%.4f</span><span>\t</span><span>%.4f</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4Lf</span><span>\t</span><span>%.4lf</span><span>\n</span><span>"</span><span>,</span> <span>colour2</span><span>.</span><span>L</span><span>,</span> <span>colour2</span><span>.</span><span>a</span><span>,</span>
            <span>colour2</span><span>.</span><span>b</span><span>,</span> <span>a2</span><span>,</span> <span>C2</span><span>,</span> <span>h2</span><span>);</span>
    <span>}</span>
    <span>immutable</span> <span>result</span> <span>=</span> <span>sqrt</span><span>((</span><span>deltaL</span> <span>/</span> <span>(</span><span>kL</span> <span>*</span> <span>SL</span><span>))</span> <span>^^</span> <span>2</span> <span>+</span> <span>dCdkCSC</span> <span>^^</span> <span>2</span> <span>+</span> <span>dHdkHSH</span> <span>^^</span> <span>2</span> <span>+</span> <span>RT</span> <span>*</span> <span>dCdkCSC</span> <span>*</span> <span>dHdkHSH</span><span>);</span>
    <span>return</span> <span>result</span><span>;</span>
<span>}</span>
<span>///</span>
<span>unittest</span>
<span>{</span>
    <span>immutable</span> <span>Lab</span><span>[</span><span>34</span><span>]</span> <span>inputA</span> <span>=</span> <span>[{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.6772</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>79.7751</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>3.1571</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>77.2803</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.8361</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>74.0200</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>1.3802</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>84.2814</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>1.1848</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>84.8006</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.9009</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>85.5211</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>1.0000</span><span>,</span> <span>b</span> <span>:</span> <span>2.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>0.0010</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>0.0010</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>0.0010</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>0.0010</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.0010</span><span>,</span> <span>b</span> <span>:</span> <span>2.4900</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.0010</span><span>,</span> <span>b</span> <span>:</span> <span>2.4900</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.0010</span><span>,</span> <span>b</span> <span>:</span> <span>2.4900</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>2.5000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>60.2574</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>34.0099</span><span>,</span> <span>b</span> <span>:</span> <span>36.2677</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>63.0109</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>31.0961</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>5.8663</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>61.2901</span><span>,</span> <span>a</span> <span>:</span> <span>3.7196</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>5.3901</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>35.0831</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>44.1164</span><span>,</span> <span>b</span> <span>:</span> <span>3.7933</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>22.7233</span><span>,</span> <span>a</span> <span>:</span> <span>20.0904</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>46.6940</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>36.4612</span><span>,</span> <span>a</span> <span>:</span> <span>47.8580</span><span>,</span> <span>b</span> <span>:</span> <span>18.3852</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>90.8027</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>2.0831</span><span>,</span> <span>b</span> <span>:</span> <span>1.4410</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>90.9257</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.5406</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>0.9208</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>6.7747</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.2908</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>2.4247</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>2.0776</span><span>,</span> <span>a</span> <span>:</span> <span>0.0795</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>1.1350</span><span>}];</span>
    <span>immutable</span> <span>Lab</span><span>[</span><span>34</span><span>]</span> <span>inputB</span> <span>=</span> <span>[{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>82.7485</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>82.7485</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>82.7485</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>82.7485</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>82.7485</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>82.7485</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>1.0000</span><span>,</span> <span>b</span> <span>:</span> <span>2.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>0.0009</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>0.0010</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>0.0011</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>2.4900</span><span>,</span> <span>b</span> <span>:</span> <span>0.0012</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0009</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>2.4900</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0010</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>2.4900</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0011</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>2.4900</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>0.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>2.5000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>73.0000</span><span>,</span> <span>a</span> <span>:</span> <span>25.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>18.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>61.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>5.0000</span><span>,</span> <span>b</span> <span>:</span> <span>29.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>56.0000</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>27.0000</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>3.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>58.0000</span><span>,</span> <span>a</span> <span>:</span> <span>24.0000</span><span>,</span> <span>b</span> <span>:</span> <span>15.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>3.1736</span><span>,</span> <span>b</span> <span>:</span> <span>0.5854</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>3.2972</span><span>,</span> <span>b</span> <span>:</span> <span>0.0000</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>1.8634</span><span>,</span> <span>b</span> <span>:</span> <span>0.5757</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>50.0000</span><span>,</span> <span>a</span> <span>:</span> <span>3.2592</span><span>,</span> <span>b</span> <span>:</span> <span>0.3350</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>60.4626</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>34.1751</span><span>,</span> <span>b</span> <span>:</span> <span>39.4387</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>62.8187</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>29.7946</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>4.0864</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>61.4292</span><span>,</span> <span>a</span> <span>:</span> <span>2.2480</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>4.9620</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>35.0232</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>40.0716</span><span>,</span> <span>b</span> <span>:</span> <span>1.5901</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>23.0331</span><span>,</span> <span>a</span> <span>:</span> <span>14.9730</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>42.5619</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>36.2715</span><span>,</span> <span>a</span> <span>:</span> <span>50.5065</span><span>,</span> <span>b</span> <span>:</span> <span>21.2231</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>91.1528</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>1.6435</span><span>,</span> <span>b</span> <span>:</span> <span>0.0447</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>88.6381</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.8985</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>0.7239</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>5.8714</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.0985</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>2.2286</span><span>},</span> <span>{</span><span>L</span><span>:</span>
    <span>0.9033</span><span>,</span> <span>a</span> <span>:</span> <span>-</span><span>0.0636</span><span>,</span> <span>b</span> <span>:</span> <span>-</span><span>0.5514</span><span>}];</span>
    <span>immutable</span> <span>float</span><span>[</span><span>34</span><span>]</span> <span>expectedResults</span> <span>=</span> <span>[</span>
        <span>2.0425</span><span>,</span> <span>2.8615</span><span>,</span> <span>3.4412</span><span>,</span> <span>1.0000</span><span>,</span> <span>1.0000</span><span>,</span> <span>1.0000</span><span>,</span> <span>2.3669</span><span>,</span> <span>2.3669</span><span>,</span> <span>7.1792</span><span>,</span>
        <span>7.1792</span><span>,</span> <span>7.2195</span><span>,</span> <span>7.2195</span><span>,</span> <span>4.8045</span><span>,</span> <span>4.8045</span><span>,</span> <span>4.7461</span><span>,</span> <span>4.3065</span><span>,</span> <span>27.1492</span><span>,</span>
        <span>22.8977</span><span>,</span> <span>31.9030</span><span>,</span> <span>19.4535</span><span>,</span> <span>1.0000</span><span>,</span> <span>1.0000</span><span>,</span> <span>1.0000</span><span>,</span> <span>1.0000</span><span>,</span> <span>1.2644</span><span>,</span>
        <span>1.2630</span><span>,</span> <span>1.8731</span><span>,</span> <span>1.8645</span><span>,</span> <span>2.0373</span><span>,</span> <span>1.4146</span><span>,</span> <span>1.4441</span><span>,</span> <span>1.5381</span><span>,</span> <span>0.6377</span><span>,</span> <span>0.9082</span>
    <span>];</span>
    <span>float</span><span>[]</span> <span>actualResultA</span><span>;</span>
    <span>float</span><span>[]</span> <span>actualResultB</span><span>;</span>
    <span>debug</span> <span>(</span><span>deltaE_00</span><span>)</span>
    <span>{</span>
        <span>foreach</span> <span>(</span><span>ref</span> <span>a</span><span>,</span> <span>ref</span> <span>b</span><span>;</span> <span>lockstep</span><span>(</span><span>inputA</span><span>[],</span> <span>inputB</span><span>[]))</span>
        <span>{</span>
            <span>actualResultA</span> <span>~=</span> <span>deltaE_00</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>);</span>
        <span>}</span>
    <span>}</span>
    <span>else</span>
    <span>{</span>
        <span>writeln</span><span>(</span><span>"[deltaE_00 test]"</span><span>);</span>
        <span>foreach</span> <span>(</span><span>ref</span> <span>a</span><span>,</span> <span>ref</span> <span>b</span><span>;</span> <span>lockstep</span><span>(</span><span>inputA</span><span>[],</span> <span>inputB</span><span>[]))</span>
        <span>{</span>
            <span>actualResultA</span> <span>~=</span> <span>deltaE_00</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>);</span>
            <span>actualResultB</span> <span>~=</span> <span>deltaE_00</span><span>(</span><span>b</span><span>,</span> <span>a</span><span>);</span>
        <span>}</span>
        <span>foreach</span> <span>(</span><span>size_t</span> <span>i</span><span>,</span> <span>ref</span> <span>a</span><span>,</span> <span>ref</span> <span>b</span><span>,</span> <span>ref</span> <span>e</span><span>;</span> <span>lockstep</span><span>(</span><span>actualResultA</span><span>[],</span>
                <span>actualResultB</span><span>[],</span> <span>expectedResults</span><span>[]))</span>
        <span>{</span>
            <span>writefln</span><span>(</span><span>"(</span><span>%s</span><span>) ΔE₀₀¹²: </span><span>%.4f</span><span>\t</span><span>ΔE₀₀²¹: </span><span>%.4f</span><span>\t</span><span>ΔE₀₀: </span><span>%.4f</span><span>"</span><span>,</span>
                <span>i</span> <span>+</span> <span>1</span><span>,</span> <span>a</span><span>,</span> <span>b</span><span>,</span> <span>e</span><span>);</span>
            <span>assert</span><span>(</span><span>a</span><span>.</span><span>approxEqual</span><span>(</span><span>e</span><span>)</span> <span>&amp;&amp;</span> <span>b</span><span>.</span><span>approxEqual</span><span>(</span><span>e</span><span>));</span>
        <span>}</span>
    <span>}</span>
<span>}</span>

<span>/++</span> <span>Calculates</span> <span>the</span> <span>average</span> <span>colour</span> <span>of</span> <span>every</span> <span>pixel</span> <span>of</span> <span>the</span> <span>sample</span>
  <span>+</span> <span>in</span> <span>Lab</span> <span>space</span>
  <span>+</span> <span>Returns</span><span>:</span> <span>the</span> <span>average</span> <span>colour</span>
  <span>+</span> <span>Params</span><span>:</span>
  <span>+</span>     <span>rect</span> <span>=</span> <span>the</span> <span>sample</span> <span>to</span> <span>average</span> <span>+/</span>
<span>auto</span> <span>calculateAvgColour</span><span>(</span><span>in</span> <span>vec4</span> <span>rect</span><span>)</span>
<span>in</span>
<span>{</span>
    <span>assert</span><span>(</span><span>!</span><span>imageLab</span><span>.</span><span>empty</span><span>);</span>
<span>}</span>
<span>body</span>
<span>{</span>
    <span>/**</span> <span>This</span> <span>naive</span> <span>implementation</span> <span>suffers</span> <span>from</span> <span>floating</span><span>-</span><span>point</span> <span>error</span><span>.</span>
      <span>*</span> <span>I</span> <span>recommend</span> <span>using</span> <span>pairwise</span> <span>summation</span> <span>because</span> <span>it</span> <span>could</span> <span>be</span> <span>sped</span> <span>up</span> <span>with</span>
      <span>*</span> <span>SIMD</span><span>,</span> <span>which</span> <span>is</span> <span>probably</span> <span>the</span> <span>best</span> <span>option</span> <span>to</span> <span>get</span> <span>better</span> <span>speed</span> <span>and</span> <span>accuracy</span><span>.</span>
      <span>*</span> <span>OpenCL</span> <span>would</span> <span>be</span> <span>too</span> <span>much</span> <span>overhead</span><span>,</span> <span>because</span> <span>our</span> <span>samples</span> <span>are</span> <span>small</span><span>,</span> <span>although</span>
      <span>*</span> <span>task</span> <span>parallelism</span> <span>could</span> <span>be</span> <span>viable</span> <span>if</span> <span>samples</span> <span>are</span> <span>averaged</span> <span>in</span> <span>batch</span><span>.</span> <span>*/</span>
    <span>immutable</span> <span>sample</span> <span>=</span> <span>rect</span><span>.</span><span>asPixelCoords</span><span>();</span>
    <span>auto</span> <span>average</span> <span>=</span> <span>Lab</span><span>(</span><span>0.0</span><span>f</span><span>,</span> <span>0.0</span><span>f</span><span>,</span> <span>0.0</span><span>f</span><span>);</span>
    <span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>sample</span><span>.</span><span>y</span><span>;</span> <span>i</span> <span>&lt;</span> <span>sample</span><span>.</span><span>y</span> <span>+</span> <span>sample</span><span>.</span><span>q</span><span>;</span> <span>++</span><span>i</span><span>)</span>
        <span>for</span> <span>(</span><span>int</span> <span>j</span> <span>=</span> <span>sample</span><span>.</span><span>x</span><span>;</span> <span>j</span> <span>&lt;</span> <span>sample</span><span>.</span><span>x</span> <span>+</span> <span>sample</span><span>.</span><span>p</span><span>;</span> <span>++</span><span>j</span><span>)</span>
        <span>{</span>
            <span>immutable</span> <span>idx</span> <span>=</span> <span>j</span> <span>+</span> <span>i</span> <span>*</span> <span>originalImageDimensions</span><span>.</span><span>x</span><span>;</span>
            <span>average</span><span>.</span><span>L</span> <span>+=</span> <span>imageLab</span><span>[</span><span>idx</span><span>]</span><span>.</span><span>L</span><span>;</span>
            <span>average</span><span>.</span><span>a</span> <span>+=</span> <span>imageLab</span><span>[</span><span>idx</span><span>]</span><span>.</span><span>a</span><span>;</span>
            <span>average</span><span>.</span><span>b</span> <span>+=</span> <span>imageLab</span><span>[</span><span>idx</span><span>]</span><span>.</span><span>b</span><span>;</span>
        <span>}</span>
    <span>average</span><span>.</span><span>L</span> <span>/=</span> <span>sample</span><span>.</span><span>p</span> <span>*</span> <span>sample</span><span>.</span><span>q</span><span>;</span>
    <span>average</span><span>.</span><span>a</span> <span>/=</span> <span>sample</span><span>.</span><span>p</span> <span>*</span> <span>sample</span><span>.</span><span>q</span><span>;</span>
    <span>average</span><span>.</span><span>b</span> <span>/=</span> <span>sample</span><span>.</span><span>p</span> <span>*</span> <span>sample</span><span>.</span><span>q</span><span>;</span>
    <span>return</span> <span>average</span><span>;</span>
<span>}</span>
<span>///</span><span>A</span> <span>colour</span> <span>in</span> <span>the</span> <span>CIE</span> <span>L</span><span>*</span><span>a</span><span>*</span><span>b</span><span>*</span> <span>(</span><span>CIELAB</span><span>)</span> <span>colour</span> <span>space</span>
<span>struct</span> <span>Lab</span>
<span>{</span>
    <span>float</span> <span>L</span><span>;</span> <span>///</span><span>L</span><span>*</span> <span>component</span> <span>representing</span> <span>lightness</span>
    <span>float</span> <span>a</span><span>;</span> <span>///</span><span>a</span><span>*</span> <span>component</span> <span>representing</span> <span>position</span> <span>between</span> <span>red</span><span>/</span><span>magenta</span> <span>and</span> <span>green</span>
    <span>float</span> <span>b</span><span>;</span> <span>///</span><span>b</span><span>*</span> <span>component</span> <span>representing</span> <span>position</span> <span>between</span> <span>yellow</span> <span>and</span> <span>blue</span>
    <span>private</span> <span>float</span> <span>_p</span><span>;</span> <span>//</span><span>padding</span>
    <span>/*</span> <span>The</span> <span>padding</span> <span>is</span> <span>because</span> <span>OpenCL</span> <span>uses</span> <span>32</span><span>bpp</span> <span>images</span><span>,</span> <span>and</span> <span>we</span> <span>want</span> <span>to</span> <span>be</span> <span>able</span>
     <span>*</span> <span>to</span> <span>cast</span> <span>the</span> <span>output</span> <span>of</span> <span>our</span> <span>rgb</span> <span>to</span> <span>lab</span> <span>kernel</span> <span>to</span> <span>Lab</span><span>[]</span> <span>*/</span>
<span>}</span>
</pre></div>
</td></tr></tbody></table></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>