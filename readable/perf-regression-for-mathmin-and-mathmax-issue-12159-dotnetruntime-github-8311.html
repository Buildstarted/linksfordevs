<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Perf regression for Math.Min and Math.Max &#xB7; Issue #12159 &#xB7; dotnet/runtime - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Perf regression for Math.Min and Math.Max &#xB7; Issue #12159 &#xB7; dotnet/runtime - linksfor.dev(s)"/>
    <meta property="article:author" content="tannergooding"/>
    <meta property="og:description" content="The Math.Min and Math.Max functions that take double/float were updated to be IEEE compliant in dotnet/coreclr#20912. However, the JIT does not do a great job optimizing this code and it has result..."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://github.com/dotnet/coreclr/issues/22951"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Perf regression for Math.Min and Math.Max &#xB7; Issue #12159 &#xB7; dotnet/runtime</title>
<div class="readable">
        <h1>Perf regression for Math.Min and Math.Max &#xB7; Issue #12159 &#xB7; dotnet/runtime</h1>
            <div>by tannergooding</div>
            <div>Reading time: 13-16 minutes</div>
        <div>Posted here: 12 Mar 2019</div>
        <p><a href="https://github.com/dotnet/coreclr/issues/22951">https://github.com/dotnet/coreclr/issues/22951</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div data-channel="marked-as-read:issue:557938278">

              
<div data-gid="MDU6SXNzdWU1NTc5MzgyNzg=" data-url="/_render_node/MDU6SXNzdWU1NTc5MzgyNzg=/issues/body" data-channel="issue:557938278">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issue-557938278">
  <div data-body-version="f8ad652270004aaf37586b84cbe8c312" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>The <code>Math.Min</code> and <code>Math.Max</code> functions that take <code>double</code>/<code>float</code> were updated to be IEEE compliant in <a data-error-text="Failed to load issue title" data-id="379244411" data-permission-text="Issue title is private" data-url="https://github.com/dotnet/coreclr/issues/20912" data-hovercard-type="pull_request" data-hovercard-url="/dotnet/coreclr/pull/20912/hovercard" href="https://github.com/dotnet/coreclr/pull/20912">dotnet/coreclr#20912</a>. However, the JIT does not do a great job optimizing this code and it has resulted in a regression.</p>
<p>For example, in the Ray Tracer that Matt Warren ported to C# as part of <a rel="nofollow" href="https://mattwarren.org/2019/03/01/Is-CSharp-a-low-level-language/#using-mathf-functions-instead-of-math">https://mattwarren.org/2019/03/01/Is-CSharp-a-low-level-language/#using-mathf-functions-instead-of-math</a>, I see the following locally:</p>
<ul>
<li>C++ 19.16: 26sec</li>
<li>C# netcoreapp2.2: 36sec</li>
<li>C# netcoreapp3.0: 57sec</li>
</ul>
<p>Reverting the change back to the original implementation gives:</p>
<ul>
<li>C# netcoreapp3.0: 31sec</li>
</ul>
<p>The function could likely be intrinsified in order to help with the codegen here. This can't be done using exclusively <code>minss</code> as that always returns the second operand if either of the operands is <code>NaN</code>, so we could emulate this branchlessly using the recommendation in the architecture manual:</p>
<blockquote>
<p>If only one value is a NaN (SNaN or QNaN) for this instruction, the second source operand, either a NaN or a valid floating-point value, is written to the result. If instead of this behavior, it is required that the NaN in either source operand be returned, the action of MINSD can be emulated using a sequence of instructions, such as, a comparison followed by AND, ANDN and OR.</p>
</blockquote>
<p>I believe that should be something similar to the following:</p>
<div><pre><span>if</span> (<span>Sse</span>.<span>IsSupported</span>)
{
    <span>var</span> <span>lhs</span> <span>=</span> <span>Vector128</span>.<span>CreateScalarUnsafe</span>(<span>val1</span>);
    <span>var</span> <span>rhs</span> <span>=</span> <span>Vector128</span>.<span>CreateScalarUnsafe</span>(<span>val2</span>);

    <span>var</span> <span>tmp1</span> <span>=</span> <span>Sse</span>.<span>MinScalar</span>(<span>rhs</span>, <span>lhs</span>);
    <span>var</span> <span>tmp2</span> <span>=</span> <span>Sse</span>.<span>CompareUnorderedScalar</span>(<span>lhs</span>, <span>lhs</span>);

    <span>if</span> (<span>Avx</span>.<span>IsSupported</span>)
    {
        <span>return</span> <span>Avx</span>.<span>BlendVariable</span>(<span>tmp1</span>, <span>rhs</span>, <span>tmp2</span>).<span>ToScalar</span>();
    }
    <span>else</span>
    {
        <span>var</span> <span>tmp3</span> <span>=</span> <span>Sse</span>.<span>And</span>(<span>tmp2</span>, <span>rhs</span>);
        <span>tmp2</span> <span>=</span> <span>Sse</span>.<span>AndNot</span>(<span>tmp2</span>, <span>tmp1</span>);
        <span>return</span> <span>Sse</span>.<span>Or</span>(<span>tmp2</span>, <span>tmp3</span>).<span>ToScalar</span>();
    }
}</pre></div>
      </div>
</task-lists>


        



    </div>

  </div>
</div>

</div>


              

  


  
  


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODcyMjY4OQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODcyMjY4OQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODcyMjY4OQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468722689">
    <div>
      

  

<details data-body-version="52e4f1b7e0433fd67172011a4a31b3ba">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="52e4f1b7e0433fd67172011a4a31b3ba" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>The above suggested fix brings the time back down to:</p>
<ul>
<li>C# netcoreapp3.0: 30sec</li>
</ul>
<p>Will need to finish validating that it is also correct.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODczMDk3OA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODczMDk3OA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODczMDk3OA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/jkotas/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/jkotas"><img height="40" width="40" alt="@jkotas" src="https://avatars3.githubusercontent.com/u/6668460?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468730978">
    <div>
      

  

<details data-body-version="1079248344114503087ea1ccad9bc29c">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="1079248344114503087ea1ccad9bc29c" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Please make sure to fix this regression on all supported platforms, not just x64.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODczNTQ1OA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODczNTQ1OA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODczNTQ1OA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468735458">
    <div>
      

  

<details data-body-version="a1fa722aa2e68254c408f713b92eb154">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="a1fa722aa2e68254c408f713b92eb154" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>Please make sure to fix this regression on all supported platforms, not just x64.</p>
</blockquote>
<p>Fixing it for x86 and x64 is just the above. Fixing it for ARM/ARM64 will likely require the JIT to treat the method as intrinsic until the HWIntrinsic support actually becomes available.</p>
<p>The root problem is the JIT doesn't handle NaN comparisons very well, which results in a bunch of branches in a small window of code. I'll try to give some more thought on if I can also improve the software fallback case.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc1NjE5OA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc1NjE5OA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODc1NjE5OA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/jkotas/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/jkotas"><img height="40" width="40" alt="@jkotas" src="https://avatars3.githubusercontent.com/u/6668460?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468756198">
    <div>
      

  

<details data-body-version="2ac4bcb97fcbe7f33696829390ad0968">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="2ac4bcb97fcbe7f33696829390ad0968" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>What is the implementation strategy used for this by other environments, e.g. C/C++ compilers? Does the compiler handles it, or is the <code>max</code> implementation handcrafted in library code?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc2Mjk5Mg==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc2Mjk5Mg==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODc2Mjk5Mg==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468762992">
    <div>
      

  

<details data-body-version="f6e17478a583f4c8a638dcc102105a4d">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="f6e17478a583f4c8a638dcc102105a4d" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>GCC and MSVC both forward down to the CRT software implementation (<code>fmin</code> and <code>fmax</code>). Clang (when optimizations are enabled) emits some assembly similar to my prototype above.</p>
<p>All of them have a "fast floating-point math" switch and just emit <code>minss</code> when that is enabled.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc2NDgyNQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc2NDgyNQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODc2NDgyNQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/jkotas/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/jkotas"><img height="40" width="40" alt="@jkotas" src="https://avatars3.githubusercontent.com/u/6668460?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468764825">
    <div>
      

  

<details data-body-version="ba4a31c9141b8d7aa8d8b8642890ad89">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="ba4a31c9141b8d7aa8d8b8642890ad89" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>GCC and MSVC both forward down to the CRT software implementation (<code>fmin</code> and <code>fmax</code>).</p>
</blockquote>
<p>I think we should do the same here like we do for majority of the other Math operations. Would that fix the regression?</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc2OTk3NA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODc2OTk3NA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODc2OTk3NA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468769974">
    <div>
      

  

<details data-body-version="905e7dc6dc1779d1aafcb61c62bda18c">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="905e7dc6dc1779d1aafcb61c62bda18c" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>Would that fix the regression?</p>
</blockquote>
<p>I'll check, but I find it doubtful as the CRT implementations are roughly what we already have in the C# implementation.</p>
<p>From previous analysis on related functions, the cost of the two calls (one to our <code>COMSingle::Min</code> and one from that to <code>fminf</code>) ends up being more expensive than the actual assembly being run.</p>
<p>For reference: just aggressively inlining the current "correct" implementation cuts the time down from 57sec to 48sec, showing that the call is a significant portion of the current cost.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODgwMzgxMA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODgwMzgxMA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODgwMzgxMA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468803810">
    <div>
      

  

<details data-body-version="596e4ecb4d0340ca717befe1c77951b4">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="596e4ecb4d0340ca717befe1c77951b4" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p><a data-hovercard-type="user" data-hovercard-url="/users/jkotas/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/jkotas">@jkotas</a>, Unfortunately, my suspicion was correct. Changing these to FCALL into the CRT <code>fmin</code> and <code>fmax</code> regresses the time from <code>57sec</code> to <code>78sec</code>.</p>
<p>I'll continue looking at the software fallback case to see if I can improve it standalone as well. I expect we might be able to just emulate the <code>cmp, and, andnot, or</code> sequence using bit manipulation to get a speedup.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODgwNzYyOA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODgwNzYyOA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODgwNzYyOA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/mikedn/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/mikedn"><img height="40" width="40" alt="@mikedn" src="https://avatars3.githubusercontent.com/u/9973420?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468807628">
    <div>
      

  

<details data-body-version="38bd41fb9f21060a63359b5e5e5af34e">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="38bd41fb9f21060a63359b5e5e5af34e" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>The root problem is the JIT doesn't handle NaN comparisons very well, which results in a bunch of branches in a small window of code</p>
</blockquote>
<p>I can improve NaN comparisons in the JIT. Though last time I tried it didn't seem to make a difference.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODgxMjczMw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODgxMjczMw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODgxMjczMw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/mikedn/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/mikedn"><img height="40" width="40" alt="@mikedn" src="https://avatars3.githubusercontent.com/u/9973420?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468812733">
    <div>
      

  

<details data-body-version="fc50188e5fac89f45d40e3737811ca87">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="fc50188e5fac89f45d40e3737811ca87" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Though it looks to me that the C++ version of the raytracer is using</p>
<div><pre><span>float</span> <span>min</span>(<span>float</span> l, <span>float</span> r) { <span>return</span> l &lt; r ? l : r; }</pre></div>
<p>and that has nothing to do with <code>Math.Min</code>. And it's not uncommon for this kind of code to not care about NaN-accuracy and I don't see why the C# version would do it differently.</p>
<p>Still, it's probably worth taking a look at what can be done to improve <code>Math.Min/Max</code>, even though it will probably never match <code>x &lt; y ? x : y</code>.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg4OTkwNQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg4OTkwNQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODg4OTkwNQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468889905">
    <div>
      

  

<details data-body-version="5f9f30b12976e5e3404dc9598f429154">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="5f9f30b12976e5e3404dc9598f429154" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>I have a PR up which resolves this for x86/x64: <a data-error-text="Failed to load issue title" data-id="416362321" data-permission-text="Issue title is private" data-url="https://github.com/dotnet/coreclr/issues/22965" data-hovercard-type="pull_request" data-hovercard-url="/dotnet/coreclr/pull/22965/hovercard" href="https://github.com/dotnet/coreclr/pull/22965">dotnet/coreclr#22965</a>. The prototype I wrote in the original post was nearly correct, but didn't handle <code>-0.0</code> vs <code>+0.0</code> correctly; where-as the PR has the additional checks to do that.</p>
<p>The software fallback implementation has a few problems.</p>
<p>First, the codegen for <code>IsNaN</code> is pretty bad. This is because the implementation for <code>IsNaN</code> is doing a strict bit-comparison. The fix is actually fairly trivial in that we could change the implementation to <code>bool IsNaN(float x) =&gt; x != x</code> and the JIT correctly emits a <code>ucomiss</code> instruction followed by <code>jp</code>.</p>
<ul>
<li><code>BitConverter.SingleToInt32Bits</code> also currently goes through the stack, rather than using <code>movd</code>, which might be nice to fix as a separate issue</li>
</ul>
<p>Second, the <code>IsNaN</code> checks are being done first; when they could be handled last since they are the uncommon case and either operand being <code>NaN</code> causes every other comparison to return <code>false</code>.</p>
<p>Third, the JIT treats <code>x &lt; y</code> as commutative with <code>y &gt;= x</code>. This is normally great, since the IEEE spec says that <code>-0.0</code> and <code>+0.0</code> are equal, and this is the only case that could matter. However, it makes it very difficult to "efficiently" handle cases where this difference does matter; and so we end up having to do 2 separate comparisons (first the equality and then the less than comparison) to get this working correctly.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5MzAzNA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5MzAzNA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODg5MzAzNA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/mikedn/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/mikedn"><img height="40" width="40" alt="@mikedn" src="https://avatars3.githubusercontent.com/u/9973420?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468893034">
    <div>
      

  

<details data-body-version="98920d10389d82686d027beb7ba91380">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="98920d10389d82686d027beb7ba91380" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>I see the following locally:<br>
C++ 19.16: 26ms<br>
C# netcoreapp2.2: 36ms<br>
C# netcoreapp3.0: 57ms</p>
</blockquote>
<p>Can you tell me what exactly are you measuring? I've been looking other that blog post but I don't see such values. And attempting to run the raytracer takes a lot longer, minutes on my machine.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5NDAxMQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5NDAxMQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODg5NDAxMQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468894011">
    <div>
      

  

<details data-body-version="3ce3a2f64826c9d6a4bbea72f1fb30e6">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="3ce3a2f64826c9d6a4bbea72f1fb30e6" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <blockquote>
<p>Can you tell me what exactly are you measuring?</p>
</blockquote>
<p>The execution of the entire program using the <code>time-windows</code> tool listed in the blog post (which is a port of the unix <code>time</code> command).</p>
<p>The programs are exactly as given in the blog post, with the C++ code modified to be 2 samples (also specified in th blog post).</p>
<p>The times I gave above should be seconds though, not sure why I typed <code>ms</code> (probably just habit, editing them now).</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5NDQ1Ng==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5NDQ1Ng==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODg5NDQ1Ng==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468894456">
    <div>
      

  

<details data-body-version="1ab8c992da360ac5f3a5215f1629cb8b">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="1ab8c992da360ac5f3a5215f1629cb8b" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Times should be updated to be in the correct unit (seconds not ms). Sorry for the confusion.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5ODg1Nw==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODg5ODg1Nw==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODg5ODg1Nw==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/mikedn/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/mikedn"><img height="40" width="40" alt="@mikedn" src="https://avatars3.githubusercontent.com/u/9973420?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468898857">
    <div>
      

  

<details data-body-version="1d197e7724e3c73f9de943d6cae582b3">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="1d197e7724e3c73f9de943d6cae582b3" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>Thanks. I also discovered that I was using a debug corelib and that's why it was taking minutes for me. Now I get 58s (and 33s for the C++ version, compiled with VS2019). So the results are comparable and I can play a bit with it.</p>
<p>First observation is that changing <code>min</code> to <code>return l &lt; r ? l : r;</code> like in the C++ version brings down the C# time to 35s.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODkwMzk2OA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODkwMzk2OA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODkwMzk2OA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/mikedn/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/mikedn"><img height="40" width="40" alt="@mikedn" src="https://avatars3.githubusercontent.com/u/9973420?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468903968">
    <div>
      

  

<details data-body-version="7ef4ac694868db8a2cc00dc66c485b18">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="7ef4ac694868db8a2cc00dc66c485b18" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <p>This <code>Math.Min</code> comment is kind of misleading:</p>
<blockquote>
<p>Doing (val1 &lt; val2) first could get transformed into (val2 &gt;= val1) by the JIT</p>
</blockquote>
<p>The JIT will transform <code>val1 &lt; val2</code> into <code>val2 &gt; val1</code> pretty much always. The JIT may sometimes transform <code>val1 &lt; val2</code> into <code>!(val1 &gt;= val2)</code>, or in the specific case of <code>Min</code> code - <code>return (val1 &lt; val2) ? val1 : val2;</code> into <code>return (val1 &gt;= val2) ? val2 : val1;</code>.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODk0MDIxNQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ2ODk0MDIxNQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ2ODk0MDIxNQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/mikedn/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/mikedn"><img height="40" width="40" alt="@mikedn" src="https://avatars3.githubusercontent.com/u/9973420?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-468940215">
    <div>
      

  

<details data-body-version="a3c0289b036686bc3e91139ef3b8d24c">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  <div data-body-version="a3c0289b036686bc3e91139ef3b8d24c" data-unfurl-hide-url="/content_reference_attachments/hide">
    


    <div>

      
<task-lists disabled="" sortable="">
<div>
          <ul>
<li>Using <code>movd</code> saves 2-3s, around 6%. Might worth doing it but it is not enough.</li>
<li>Using <code>x != x</code> rather than <code>IsNaN</code> doesn't seem to make a difference performance wise but it does generate smaller code</li>
</ul>
<p>But the current <code>Min</code> code seems pretty bad, it doesn't take advantage of facts like <code>x &lt; NaN = false</code>. I need to stare at it a bit more but the following should be equivalent and generates far less code:</p>
<div><pre><span>public</span> <span>static</span> <span>float</span> <span>Min31</span>(<span>float</span> <span>val1</span>, <span>float</span> <span>val2</span>)
{
    <span>if</span> (((<span>val1</span> <span>==</span> <span>val2</span>) <span>&amp;&amp;</span> <span>float</span>.<span>IsNegative</span>(<span>val2</span>)) <span>||</span>
        (<span>val1</span> <span>&gt;</span> <span>val2</span>) <span>||</span>
        (<span>val1</span> <span>!=</span> <span>val1</span>))
    {
        <span>val1</span> <span>=</span> <span>val2</span>;
    }

    <span>return</span> <span>val1</span>;
}</pre></div>
<p>runs in ~47s and generates</p>
<div><pre><span>G_M14706_IG01:</span>
<span>       C5F877               </span><span>vzeroupper</span>
<span>       </span><span>6690</span><span>                 </span><span>nop</span>
<span>G_M14706_IG02:</span>
<span>       C5F82EC1             </span><span>vucomiss</span><span> </span><span>xmm0</span><span>,</span><span> </span><span>xmm1</span>
<span>       7A0C                 </span><span>jp</span><span>       SHORT G_M14706_IG03</span>
<span>       750A                 </span><span>jne</span><span>      SHORT G_M14706_IG03</span>
<span>       C5F97EC8             </span><span>vmovd</span><span>    </span><span>eax</span><span>,</span><span> </span><span>xmm1</span>
<span>       85C0                 </span><span>test</span><span>     </span><span>eax</span><span>,</span><span> </span><span>eax</span>
<span>       7C10                 </span><span>jl</span><span>       SHORT G_M14706_IG04</span>
<span>G_M14706_IG03:</span>
<span>       C5F82EC1             </span><span>vucomiss</span><span> </span><span>xmm0</span><span>,</span><span> </span><span>xmm1</span>
<span>       </span><span>7708</span><span>                 </span><span>ja</span><span>       SHORT G_M14706_IG04</span>
<span>       C5F82EC0             </span><span>vucomiss</span><span> </span><span>xmm0</span><span>,</span><span> </span><span>xmm0</span>
<span>       7B07                 </span><span>jnp</span><span>      SHORT G_M14706_IG05</span>
<span>G_M14706_IG04:</span>
<span>       C5F828C1             </span><span>vmovaps</span><span>  </span><span>xmm0</span><span>,</span><span> </span><span>xmm1</span>
<span>G_M14706_IG05:</span>
<span>       C3                   </span><span>ret</span>
<span>; Total bytes of code 38, prolog size 5 for method Program:Min31(float,float):float</span></pre></div>
<p>There may be an way to eliminate one of the <code>vucomiss xmm0, xmm1</code> but I don't see it right now, the negative 0 check is in the way.</p>
<p>It's a bit large to force inline it but doing that brings the time down to 39s.</p>
      </div>
</task-lists>


        



    </div>

  </div>
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ4NjAxMzg4NA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ4NjAxMzg4NA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ4NjAxMzg4NA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/CarolEidt/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/CarolEidt"><img height="40" width="40" alt="@CarolEidt" src="https://avatars1.githubusercontent.com/u/2973870?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-486013884">
    <div>
      

  

<details data-body-version="93fe0166bece60f06f7bb55d5d845fbc">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  
</div>


</div>


</div>


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ4NjAxNTgwOQ==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ4NjAxNTgwOQ==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ4NjAxNTgwOQ==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/tannergooding/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/tannergooding"><img height="40" width="40" alt="@tannergooding" src="https://avatars2.githubusercontent.com/u/10487869?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-486015809">
    <div>
      

  

<details data-body-version="dfa29cf08021613769e05371bf5ccf1f">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  
</div>


</div>


</div>


  
  


  
  
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ4NjAxOTA5OA==">
  
    
<div data-gid="MDEyOklzc3VlQ29tbWVudDQ4NjAxOTA5OA==" data-url="/_render_node/MDEyOklzc3VlQ29tbWVudDQ4NjAxOTA5OA==/timeline/issue_comment">

  
<p><a data-hovercard-type="user" data-hovercard-url="/users/CarolEidt/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/CarolEidt"><img height="40" width="40" alt="@CarolEidt" src="https://avatars1.githubusercontent.com/u/2973870?s=88&amp;v=4"></a>

</p>


  
<div id="issuecomment-486019098">
    <div>
      

  

<details data-body-version="dd9544a287f1590726906f8b641c6d56">
    <summary>
      <div>
        <h3>
              This comment has been minimized.

        </h3>
        
      </div>
    </summary>
</details>


    </div>
  
</div>


</div>


</div>


  
  







<!-- Rendered timeline since 2020-01-30 22:20:18 -->



            </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>