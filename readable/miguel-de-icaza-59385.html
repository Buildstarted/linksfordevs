<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Miguel de Icaza - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Miguel de Icaza - linksfor.dev(s)"/>
    <meta property="article:author" content="@COPYRIGHT@"/>
    <meta property="og:description" content="Miguel de Icaza&#x27;s Blog"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://tirania.org/blog/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Miguel de Icaza</title>
<div class="readable">
        <h1>Miguel de Icaza</h1>
            <div>by @COPYRIGHT@</div>
            <div>Reading time: 29-36 minutes</div>
        <div>Posted here: 07 Mar 2020</div>
        <p><a href="https://tirania.org/blog/">https://tirania.org/blog/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
            <!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	
<p><img src="https://tirania.org/images/Unity-Editor-Breakdown.png" width="240"></p><p>The Unity3D engine features a capability where developers can edit the
code for their program, hit “play” and observe the changes right away,
without a visible compilation step.  C# code is compiled and executed
immediately inside the Unity editor in a seamless way.</p>
<p>This is a scenario where scripted code runs with full trust within the
original application.  The desired outcome is to not crash the host,
be able to reload new versions of the code over and over, and not
really about providing a security boundary.</p>
<p>This capability was built into Unity using .NET Application Domains: a
code isolation technology that was originally built in .NET that
allowed code to be loaded, executed and discarded after it was no
longer needed.</p>
<p>Other developers used Application Domains as a security boundary in
conjuction with other security technologies in .NET.  But this
combination turned out to have some holes, and Application Domains,
once popular among .NET developers, fell from grace.</p>
<p>With .NET Core, Application domains are no longer supported, and
alternative options for code-reloading have been created (dynamic
loading of code can be achieved these days with AssemblyLoadContext).</p>
<p>While Unity was ahead of the industry in terms of code hot reloading,
but other folks have used embedded runtimes to provide this sort of
capability over the years, Javascript being one of the most popular
ones.</p>
<p>Recently, I have been fascinated by WebAssembly for solving this
particular scenario and solve it very well (some folks are also using
WebAssembly to isolate sensitive code).</p>
<p>WebAssembly was popularized by the Web crowd, and it offers a number
of capabilities that neither Javascript, Application Domains or other
scripting languages solve very well for scripting applications.</p>
<p>Outside of the Web browser domain, WebAssembly checks all of the boxes
in my book:</p>
<ul>
<li>Provides great code isolation and memory isolation</li>
<li>Easily discard unused code and data</li>
<li>Wide reach: in addition to being available on the Web there are runtimes suitable for
almost every scenario: fast JIT compilation, optimizing compilers,
static compilation and assorted interpreters.   One of my favorites is <a href="https://wasmer.io/">Wasmer</a></li>
<li>Custom operations can be surfaced to WebAssembly to connect the
embedded code with the host.</li>
<li>Many languages can target this runtime.  C, C++, C#, F#, Go, Rust
and Swift among others.</li>
</ul>
<p>WebAssembly is low-level enough that it does not come with a garbage
collector, which means that it will not pause to garbage collect your
code like .NET/Mono or JavaScript would.  That depends entirely on the
language that you run inside WebAssembly.  If you run C, Rust or Swift
code, there would be no time taken by a garbage collector, but if you
run .NET or Go code there would be.</p>
<p>Going back to the Unity scenario: the fascinating feature for me, is
that IDEs/Editors/Tools could leverage WebAssembly to host their
favorite language for scripting during the development stage, but for
the final build of a product (like Unity, Godot, Rhino3D, Unreal
Engine and really any other application that offers scripting
capabilities) they could bundle the native code without having to take
a WebAssembly dependency.</p>
<p>For the sake of the argument, imagine the Godot game engine.  Today
Godot has support for GodotScript and .NET.  But it could be extended
to support for Swift for scripting, and use WebAssembly during
development to hot-reload the code, but generate Swift code directly
for the final build of a game.</p>
<p>The reason I listed the game engines here is that users of those
products are as happy with the garbage collector taking some time to
tidy up your heap as they are with a parent calling them to dinner
just as they are swarming an enemy base during a 2-hour campaign.</p>
<p>WebAssembly is an incredibly exciting space, and every day it seems
like it opens possibilities that we could only dream of before.</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2020/Mar-02.html">02 Mar 2020</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	
<p>12 years ago, I wrote a small UI Library to build console applications
in Unix using C#.  I enjoyed writing a <a href="https://tirania.org/blog/archive/2007/Apr-16.html">blog post that
hyped</a> this tiny
library as a platform for Rich Internet Applications (“RIA”).  The
young among you might not know this, but back in 2010, “RIA” platforms
were all the rage, like Bitcoin was two years ago.</p>
<p>The blog post was written in a tongue-in-cheek style, but linked to
actual screenshots of this toy library, which revealed the joke:</p>
<p><img src="https://tirania.org/pictures/gui.cs.2007.png" alt="First gui.cs application - a MonoTorrent client"></p>
<p>This was the day that I realized that some folks did not read the
whole blog post, nor clicked on the screenshot links, as I received
three pieces of email about it.</p>
<p>The first was from an executive at Adobe asking why we were competing,
rather than partnering on this RIA framework.  Back in 2010, Adobe was
famous for building the Flash and Flex platforms, two of the leading
RIA systems in the industry.  The second was from a journalist trying
to find out more details about this new web framework, he was
interested in getting on the phone to discuss the details of the
announcement, and the third piece was from an industry analyst that
wanted to understand what this announcement did for the
strategic placement of my employer in their five-dimensional industry
tracking mega-deltoid.</p>
<p>This tiny library was part of my <a href="https://github.com/mono/mono-curses">curses
binding</a> for Mono in a time where
I dreamed of writing and bringing a complete terminal stack to .NET in
my copious spare time.  Little did I know, that I was about to run out
of time, as in little less than a month, <a href="https://tirania.org/blog/archive/2007/May-22.html">I would start
Moonlight</a> - the
open source clone of Microsoft Silverlight and that would consume my
time for a couple of years.</p>

<p>While Silverlight might have died, my desire to have a UI toolkit for
console applications with .NET did not.  Some fourteen months ago, I
decided to work again on <code>gui.cs</code>, this is a screenshot of the result:</p>
<p><img src="https://tirania.org/pictures/gui.cs.2019.png" alt="Sample app"></p>
<p>In many ways the world had changed.  You can now expect a fairly
modern version of curses to be available across all Unices and Unix
systems have proper <code>terminfo</code> databases installed.</p>
<p>Because I am a hopeless romantic, I called this new incarnation of the
UI toolkit, <code>gui.cs</code>.  This time around, I have updated it to modern
.NET idioms, modern .NET build systems, and embraced the UIKit design
for some of the internals of the framework and Azure DevOps to run my
continuous builds and manage my releases to NuGet.</p>
<p>In addition, the toolkit is no longer tied to Unix, but contains
drivers for the Windows console, the .NET <code>System.Console</code> (a less
powerful version of the Windows console) and the ncurses library.</p>
<p>You can find the result in GitHub
<a href="https://github.com/migueldeicaza/gui.cs">https://github.com/migueldeicaza/gui.cs</a> and you can install it on your
favorite operating system by installing the <code>Terminal.Gui</code> NuGet
package.</p>
<p>I have published both
<a href="https://migueldeicaza.github.io/gui.cs/articles/overview.html">conceptual</a>
and <a href="https://migueldeicaza.github.io/gui.cs/api/Terminal.Gui.html">API
documentation</a>
for folks to get started with.  Hopefully I will beat my previous
record of two users.</p>
<p>The original layout system for <code>gui.cs</code> was based on absolute
positioning - not bad for a quick hack.  But this time around I wanted
something simpler to use.  Sadly, UIKit is not a good source of
inspiration for simple to use layout systems, so I came up with a
novel system for <a href="https://migueldeicaza.github.io/gui.cs/articles/overview.html#layout">widget
layout</a>,
one that I am quite fond of.  This new system introduces two data
types <code>Pos</code> for specifying positions and <code>Dim</code> for specifying
dimensions.</p>
<p>As a developer, you assign <code>Pos</code> values to <code>X</code>, <code>Y</code> and <code>Dim</code> values
to <code>Width</code> and <code>Height</code>.  The system comes with a range of ways of
specifying positions and dimensions, including referencing properties
from other views.  So you can specify the layout in a way similar to
specifying formulas in a spreadsheet.</p>
<p>There is a one hour long presentation introducing various tools for
console programming with .NET.  The section dealing just with <code>gui.cs</code>
<a href="https://www.youtube.com/watch?v=Se1zNWJwDUE&amp;t=29m28s">starts at minute
29:28</a>, and you
can also get a <a href="https://tirania.org/Retro.pdf">copy of the slides</a>.</p>
<p><a href="https://youtu.be/Se1zNWJwDUE">https://youtu.be/Se1zNWJwDUE</a></p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2019/Apr-22.html">22 Apr 2019</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	
<p>Last year, I wrote about <a href="https://tirania.org/blog/archive/2018/Dec-04.html">structural changes that we made to the .NET
Foundation</a>.</p>
<p>Out of 715 applications to become members of the foundation, <a href="https://twitter.com/jongalloway/status/1111324076981682176">477 have
been
accepted</a>.</p>
<p>Jon has posted the <a href="https://dotnetfoundation.org/blog/2019/03/28/net-foundation-board-of-directors-election-results">results of our first
election</a>.
From Microsoft, neither Scott Hunter or myself ran for the board of
directors, and only Beth Massi remains.  So we went from having a
majority of Microsoft employees on the board to only having <a href="https://election.dotnetfoundation.org/campaign-2019/beth-massi.html">Beth
Massi</a>,
with six fresh directors joining: <a href="https://election.dotnetfoundation.org/campaign-2019/iris-classon.html">Iris
Classon</a>,
<a href="https://election.dotnetfoundation.org/campaign-2019/ben-adams.html">Ben
Adams</a>,
<a href="https://election.dotnetfoundation.org/campaign-2019/jon-skeet.html">Jon
Skeet</a>,
<a href="https://election.dotnetfoundation.org/campaign-2019/phil-haack.html">Phil
Haack</a>,
<a href="https://election.dotnetfoundation.org/campaign-2019/sara-chipps.html">Sara
Chipps</a>
and <a href="https://election.dotnetfoundation.org/campaign-2019/oren-novotny.html">Oren
Novotny</a></p>
<p>I am stepping down very happy knowing that I achieved my main goal, to
turn the .NET Foundation into a more diverse and member-driven foundation.</p>
<p>Congratulations and good luck .NET Board of 2019!</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2019/Mar-29.html">29 Mar 2019</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	
<p>Today we <a href="https://dotnetfoundation.org/blog/2018/12/04/announcing-net-foundation-open-membership">announced a major change to the .NET
Foundation</a>,
in which we fundamentally changed the way that the foundation
operates.  The new foundation draws inspiration from the Gnome
Foundation and the F# Foundation.</p>
<p>We are making the following changes:</p>
<ul>
<li><p>The Board of Directors of the Foundation will now be elected by the
.NET Foundation membership, and they will be in charge of steering
the direction of the foundation.  The Board of Directors will be
elected annually via direct vote from the members of the Foundation,
with just one permanent member from Microsoft.</p>
</li>
<li><p>Anyone contributing to projects in the .NET Foundation can become a
voting member of the Foundation.  The main benefit is that you get
to vote for who should represent you in the board of directors.  To
become a member, we will judge contributions to the projects in the
foundation, which can either be code contributions, documentation,
evangelism or other activities that advance .NET and its ecosystem.</p>
</li>
<li><p>Membership fee: we are adding a membership fee that will give the
.NET Foundation independence from Microsoft when it comes to how it
chooses to promote .NET and the ecosystem around it.  We realize
that not everyone can pay this fee, so this fee can be waived.  But
those that contribute to the Foundation will help us fund activities
that will expand .NET.</p>
</li>
<li><p>We intend to have elections every year, so individuals will campaign
on what they intend to bring to the board.</p>
</li>
<li><p>There is a limit in the number of members on the board representing
a single company, which prevents the board from being stacked up by
contributors for a single company, and will encourage our community
to vote for board members with diverse backgrounds, strengthening
the views of the board.</p>
</li>
<li><p>Companies do not vote.  The only way to vote is for contributors to
the .NET ecosystem, which could be affiliated with a company to
vote, but the companies themselves have no vote.  Our corporate
sponsors are sponsors that care as much as we care as the growth and
health of our ecosystem.</p>
</li>
</ul>
<p>These changes are very close to my heart and took a lot of work to
make them happen and make sure that Microsoft the company was
comfortable with giving up the control over the .NET Foundation.</p>
<p>I want to thank <a href="https://twitter.com/jongalloway">Jon Galloway</a>, the
Executive Director of the current .NET Foundation to help make this a
reality.</p>
<p>Going from the idea to the execution took a long time.
<a href="https://twitter.com/martinwoodward?lang=en">Martin</a>
<a href="https://twitter.com/martinwoodward">Woodward</a> did some of the early
foot work to get various people at Microsoft comfortable with the
idea.  Then Jon took over, and had to continue this process to get
everyone on board and get everyone to accept that our little baby was
ready to graduate, go to college and start its own independent life.</p>
<p>I want to thank my peers in the board of directors that supported this
move, <a href="https://twitter.com/coolcsh">Scott Hunter</a>, <a href="https://twitter.com/onovotny">Oren
Novotny</a>, Rachel Reese as well as the entire
supporting crew that helped us make this happen, <a href="http://bethmassi/">Beth
Massi</a>, Jay Schmelzer and the various heroes in the
Microsoft legal department that crossed all the t’s and dotted all the
i’s.</p>
<p>See you on the campaign trail!</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2018/Dec-04.html">04 Dec 2018</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	<p>With <a href="https://developer.xamarin.com/releases/xamarin-forms/xamarin-forms-3.0/3.0.0/">Xamarin.Forms 3.0</a>
in addition to the many new feature work that we did, we have been
doing some general optimizations across the board, from compile times
to startup times and wanted to share some recent results on the net
effect on one of our larger sample apps.</p>
<p>These are the results when doing a cold start for the SmartHotel360
application on Android when compiled for 32bits (armeabi-v7a) on a
Google Pixel (1st gen).</p>
<table>
<thead>
<tr>
<th></th>
<th>Release</th>
<th>Release/AOT</th>
<th>Release/AOT+LLVM</th>
</tr>
</thead>
<tbody>
<tr>
<td>Forms 2.5.0</td>
<td>6.59s</td>
<td>1.66s</td>
<td>1.61s</td>
</tr>
<tr>
<td>Forms 3.0.0</td>
<td>3.52s</td>
<td>1.41s</td>
<td>1.38s</td>
</tr>
</tbody>
</table>
<p>This is independent of the work that we are doing to improve Android's
startup speed, that both brings additional benefits today, and will bring
additional benefits in the future.</p>
<p>One of the areas that we are investing on for Android is to remove any
dynamic code execution at startup to integrate with the Java runtime,
instead all of this is being statically computed, similar to what we
are doing on Mac and iOS where we completely eliminated reflection and
code generation from startup.</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2018/May-18.html">18 May 2018</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	<p>My friend Aras <a href="https://aras-p.info/blog/2018/03/28/Daily-Pathtracer-Part-3-CSharp-Unity-Burst/">recently
wrote</a>
the same ray tracer in various languages, including C++, C# and the
upcoming Unity Burst compiler.  While it is natural to expect C# to be
slower than C++, what was interesting to me was that Mono was so much
slower than .NET Core.</p>
<p>The numbers that <a href="https://github.com/aras-p/ToyPathTracer/blob/2ad173716917d51d484cabb1971b5bd941010c04/readme.md">he posted</a>
did not look good:</p>
<ul>
<li>C# (.NET Core): Mac 17.5 Mray/s,</li>
<li>C# (Unity, Mono): Mac 4.6 Mray/s,</li>
<li>C# (Unity, IL2CPP): Mac 17.1 Mray/s,</li>
</ul>
<p>I decided to look at what was going on, and document possible areas
for improvement.</p>
<p>As a result of this benchmark, and looking into this problem, we
identified three areas of improvement:</p>
<ul>
<li>First, we need better defaults in Mono, as users will not tune their parameters</li>
<li>Second, we need to better inform the world about the LLVM code optimizing backend in Mono</li>
<li>Third, we tuned some of the parameters in Mono.</li>
</ul>
<p>The baseline for this test, was to run <a href="https://github.com/aras-p/ToyPathTracer">Aras ray
tracer</a> on my machine, since
we have different hardware, I could not use his numbers to compare.
The results on my iMac at home were as follows for Mono and .NET Core:</p>
<table>
<thead>
<tr>
<th>Runtime</th>
<th>Results MRay/sec</th>
</tr>
</thead>
<tbody>
<tr>
<td>.NET Core 2.1.4, debug build <code>dotnet run</code></td>
<td>3.6</td>
</tr>
<tr>
<td>.NET Core 2.1.4, release build, <code>dotnet run -c Release</code></td>
<td>21.7</td>
</tr>
<tr>
<td>Vanilla Mono, <code>mono Maths.exe</code></td>
<td>6.6</td>
</tr>
<tr>
<td>Vanilla Mono, with LLVM and float32</td>
<td>15.5</td>
</tr>
</tbody>
</table>
<p>During the process of researching this problem, we found a couple of
problems, which once we fixed, produced the following results:</p>
<table>
<thead>
<tr>
<th>Runtime</th>
<th>Results MRay/sec</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mono with LLVM and float32</td>
<td>15.5</td>
</tr>
<tr>
<td>Improved Mono with LLVM, float32 and fixed inline</td>
<td>29.6</td>
</tr>
</tbody>
</table>
<p>Aggregated:</p>
<p><img src="https://d2mxuefqeaa7sj.cloudfront.net/s_2AC6DF5A96B25F97ED9DBA2022727A5DAF2636E0692861719A46B6C05022B776_1523462931615_image.png" width="720px" alt="Chart visualizing the results of the table above"></p><p>Just using LLVM and float32 your code can get almost a 2.3x
performance improvement in your floating point code.  And with the
tuning that we added to Mono’s as a result of this exercise, you can
get 4.4x over running the plain Mono - these will be the defaults in
future versions of Mono.</p>
<p>This blog post explains our findings.</p>
<h2 id="and-64-bit-floats">32 and 64 bit Floats</h2>
<p>Aras is using 32-bit floats for most of his math (the <code>float</code> type in
C#, or <code>System.Single</code> in .NET terms).  In Mono, decades ago, we made
the mistake of performing all 32-bit float computations as 64-bit
floats while still storing the data in 32-bit locations.</p>
<p>My memory at this point is not as good as it used to be and do not
quite recall why we made this decision.</p>
<p>My best guess is that it was a decision rooted in the trends and ideas
of the time.</p>
<p>Around this time there was a positive aura around extended precision
computations for floats.  For example the Intel x87 processors use
80-bit precision for their floating point computations, even when the
operands are doubles, giving users better results.</p>
<p>Another theme around that time was that the Gnumeric spreadsheet, one
of my previous projects, had implemented better statistical functions
than Excel had, and this was well received in many communities that
could use the more correct and higher precision results.</p>
<p>In the early days of Mono, most mathematical operations available
across all platforms only took doubles as inputs.  C99, Posix and ISO
had all introduced 32-bit versions, but they were not generally
available across the industry in those early days (for example, <code>sinf</code>
is the float version of <code>sin</code>, <code>fabsf</code> of <code>fabs</code> and so on).</p>
<p>In short, the early 2000’s were a time of optimism.</p>
<p>Applications did pay a heavier price for the extra computation time,
but Mono was mostly used for Linux desktop application, serving HTTP
pages and some server processes, so floating point performance was
never an issue we faced day to day.  It was only noticeable in some
scientific benchmarks, and those were rarely the use case for .NET
usage in the 2003 era.</p>
<p>Nowadays, Games, 3D applications image processing, VR, AR and machine
learning have made floating point operations a more common data type
in modern applications.  When it rains, it pours, and this is no
exception.  Floats are no longer your friendly data type that you
sprinkle in a few places in your code, here and there.  They come in
an avalanche and there is no place to hide. There are so many of them,
and they won’t stop coming at you.</p>
<h2 id="the-float32-runtime-flag">The “float32” runtime flag</h2>
<p>So a couple of years ago we decided to add support for performing
32-bit float operations with 32-bit operations, just like everyone
else.  We call this runtime feature “float32”, and in Mono, you enable
this by passing the <code>--O=float32</code> option to the runtime, and for
Xamarin applications, you change this setting on the project
preferences.</p>
<p>This new flag has been well received by our mobile users, as the
majority of mobile devices are still not very powerful and they rather
process data faster than they need the precision.  Our guidance for
our mobile users has been both to turn on the LLVM optimizing compiler
and float32 flag at the same time.</p>
<p>While we have had the flag for some years, we have not made this the
default, to reduce surprises for our users.  But we find ourselves
facing scenarios where the current 64-bit behavior is already
surprises to our users, for example, see this <a href="https://github.com/mono/mono/issues/7522">bug report filed by a
Unity user</a>.</p>
<p>We are now going to change the default in Mono to be <code>float32</code>, you
can track the progress here: <a href="https://github.com/mono/mono/issues/6985">https://github.com/mono/mono/issues/6985</a>.</p>
<p>In the meantime, I went back to my friend Aras project.  He has been
using some new APIs that were introduced in .NET Core.  While .NET
core always performed 32-bit float operations as 32-bit floats, the
<code>System.Math</code> API still forced some conversions from <code>float</code> to
<code>double</code> in the course of doing business.  For example, if you wanted
to compute the sine function of a float, your only choice was to call
<code>Math.Sin (double)</code> and pay the price of the float to double
conversion.</p>
<p>To address this, .NET Core has introduced a new <code>System.MathF</code> type,
which contains single precision floating point math operations, and we
have just <a href="https://github.com/mono/mono/pull/7941">brought this</a>
<code>[System.MathF](https://github.com/mono/mono/pull/7941)</code> <a href="https://github.com/mono/mono/pull/7941">to
Mono</a> now.</p>
<p>While moving from 64 bit floats to 32 bit floats certainly improves
the performance, as you can see in the table below:</p>
<table>
<thead>
<tr>
<th><strong>Runtime and Options</strong></th>
<th>Mrays/second</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mono with System.Math</td>
<td>6.6</td>
</tr>
<tr>
<td>Mono with System.Math, using <code>-O=float32</code></td>
<td>8.1</td>
</tr>
<tr>
<td>Mono with System.MathF</td>
<td>6.5</td>
</tr>
<tr>
<td>Mono with System.MathF, using <code>-O=float32</code></td>
<td>8.2</td>
</tr>
</tbody>
</table>
<p>So using <code>float32</code> really improves things for this test, the MathF had
a small effect.</p>

<p>During the course of this research, we discovered that while Mono’s
Fast JIT compiler had support for <code>float32</code>, we had not added this
support to the LLVM backend.  This meant that Mono with LLVM was still
performing the expensive float to double conversions.</p>
<p>So Zoltan added support for <code>float32</code> to our LLVM code generation
engine.</p>
<p>Then he noticed that our inliner was using the same heuristics for the
Fast JIT than it was using for LLVM.  With the Fast JIT, you want to
strike a balance between JIT speed and execution speed, so we limit
just how much we inline to reduce the work of the JIT engine.</p>
<p>But when you are opt into using LLVM with Mono, you want to get the
fastest code possible, so we adjusted the setting accordingly.  Today
you can change this setting via an environment variable
<code>MONO_INLINELIMIT</code>, but this really should be baked into the defaults.</p>
<p>With the tuned LLVM setting, these are the results:</p>
<table>
<thead>
<tr>
<th>Runtime and Options</th>
<th>Mrays/seconds</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mono with System.Math <code>--llvm -O=float32</code></td>
<td>16.0</td>
</tr>
<tr>
<td>Mono with System.Math <code>--llvm -O=float32</code> fixed heuristics</td>
<td>29.1</td>
</tr>
<tr>
<td>Mono with System.MathF <code>--llvm -O=float32</code> fixed heuristics</td>
<td>29.6</td>
</tr>
</tbody>
</table>

<p>The work to bring some of these improvements was relatively low.  We
had some on and off discussions on Slack which lead to these
improvements.  I even managed to spend a few hours one evening to
bring <code>System.MathF</code> to Mono.</p>
<p>Aras RayTracer code was an ideal subject to study, as it was
self-contained, it was a real application and not a synthetic
benchmark.  We want to find more software like this that we can use to
review the kind of bitcode that we generate and make sure that we are
giving LLVM the best data that we can so LLVM can do its job.</p>
<p>We also are considering upgrading the LLVM that we use, and leverage
any new optimizations that have been added.</p>

<p>The extra precision has some nice side effects.  For example,
recently, while reading the pull requests for the Godot engine, I saw
that they were busily discussing making floating point precision for
the engine configurable at compile time
(<a href="https://github.com/godotengine/godot/pull/17134">https://github.com/godotengine/godot/pull/17134</a>).</p>
<p>I asked Juan why anyone would want to do this, I thought that games
were just content with 32-bit floating point operations.</p>
<p>Juan explained to that while floats work great in general, once you
“move away” from the center, say in a game, you navigate 100
kilometers out of the center of your game, the math errors start to
accumulate and you end up with some interesting visual glitches.
There are various mitigation strategies that can be used, and higher
precision is just one possibility, one that comes with a performance
cost.</p>
<p>Shortly after our conversation, this blog showed up on my Twitter
timeline showing this problem:</p>
<p><a href="http://pharr.org/matt/blog/2018/03/02/rendering-in-camera-space.html">http://pharr.org/matt/blog/2018/03/02/rendering-in-camera-space.html</a></p>
<p><em>A few images show the problem. First, we have a sports car model from the</em> <a href="http://pbrt.org/scenes-v3.html"><em>pbrt-v3-scenes</em></a> **<em>distribution. Both the camera and the scene are near the origin and everything looks good.</em>
<img src="http://pharr.org/matt/blog/images/sportscar.png" alt=""></p>
<p>**  <em>(Cool sports car model courtesy</em> <a href="https://twitter.com/MirageYM"><em>Yasutoshi Mori</em></a><em>.)</em>
<em>Next, we’ve translated both the camera and the scene 200,000 units from the origin in xx, yy, and zz. We can see that the car model is getting fairly chunky; this is entirely due to insufficient floating-point precision.</em>
<img src="http://pharr.org/matt/blog/images/sportscar-200k.png" alt=""></p>
<p>**  <em>(Thanks again to</em> <a href="https://twitter.com/MirageYM"><em>Yasutoshi Mori</em></a><em>.)</em>
<em>If we move 5×5× farther away, to 1 million units from the origin, things really fall apart; the car has become an extremely coarse voxelized approximation of itself—both cool and horrifying at the same time. (Keanu wonders: is Minecraft chunky purely because everything’s rendered really far from the origin?)</em>
<img src="http://pharr.org/matt/blog/images/sportscar-1m.png" alt=""></p>
<p>**  <em>(Apologies to</em> <a href="https://twitter.com/MirageYM"><em>Yasutoshi Mori</em></a> <em>for what has been done to his nice model.)</em></p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2018/Apr-11.html">11 Apr 2018</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	<p>This was driving me insane.  For years, I have been using
Command-Shift-4 to take screenshots on my Mac.  When you hit that
keypress, you get to select a region of the screen, and the result
gets placed on your <code>~/Desktop</code> directory.</p>
<p>Recently, the feature stopped working.</p>
<p>I first blamed Dropbox settings, but that was not it.</p>
<p>I read every article on the internet on how to change the default
location, restart the <code>SystemUIServer</code>.</p>
<p>The <code>screencapture</code> command line tool worked, but not the hotkey.</p>
<p>Many reboots later, I disabled System Integrity Protection so I could
use <code>iosnoop</code> and <code>dtruss</code> to figure out why <code>screencapture</code> was not
logging.  I was looking at the logs right there, and saw where things
were different, but could not figure out what was wrong.</p>
<p>Then another one of my Macs got infected.  So now I had two Mac
laptops that could not take screenshots.</p>
<p>And then I realized what was going on.</p>
<p>When you trigger Command-Shift-4, the TouchBar lights up and lets you
customize how you take the screenshot, like this:</p>
<p><img src="https://tirania.org/pictures/tb-1.png" width="800"></p><p>And if you scroll it, you get these other options:</p>
<p><img src="https://tirania.org/pictures/tb-2.png" width="800"></p><p>And I had recently used these settings.</p>
<p>If you change your default here, it will be preserved, so even if the
shortcut is Command-Shift-4 for take-screenshot-and-save-in-file, if
you use the TouchBar to make a change, this will override any future
uses of the command.</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2018/Apr-04.html">04 Apr 2018</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	<p><img src="https://unity3d.com/profiles/unity3d/themes/unity/images/company/brand/logos/primary/unity-master-black.svg" width="220"> While I had promised my friend Lucas that I would build
a game in Unity for what seems like a decade, I still have not managed
to build one.</p>
<p>Recently <a href="https://twitter.com/aras_p">Aras</a> shared his excitement for
<a href="http://aras-p.info/blog/2018/02/18/Unity-in-2018/">Unity in 2018</a>.
There is a ton on that blog post to unpack.</p>
<p>What I am personally excited about is that Unity <a href="https://docs.unity3d.com/Manual/ScriptingRuntimeUpgrade.html">now ships an
up-to-date
Mono</a> in
the core.</p>
<p><a href="https://docs.unity3d.com/Manual/ScriptingRuntimeUpgrade.html">
<img src="https://tirania.org/images/ScriptingRunetimePreview.png" width="720">
</a></p><p><a href="https://twitter.com/jon_cham?lang=en">Jonathan Chambers</a> and his team
of amazing low-level VM hackers have been hard at work in upgrading
Unity's VM and libraries to bring you the latest and greatest Mono
runtime to Unity.   We have had the privilege of assisting in this
migration and providing them with technical support for this
migration.</p>
<p>The work that the Unity team has done lays down the foundation for an
ongoing update to their .NET capabilities, so future innovation on the
platform can be quickly adopted, bringing new and more joyful
capabilities to developers in the platform.</p>
<p>With this new runtime, Unity developers will be able to access and
consume a large portion of third party .NET libraries, including all
those shiny .NET Standard Libraries - the new universal way of sharing
code in the .NET world.</p>
<p><img src="https://tirania.org/images/netstandard-unity.png" width="720"></p>
<p>The Unity team has also provided very valuable guidance to the C#
team which have directly influenced features in C# 7 like <a href="https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-7#ref-locals-and-returns">ref locals
and
returns</a></p>
<ul>
<li>In our own tests using C# for an AR application, we doubled the
speed of managed-code AR processing by using these new features.</li>
</ul>
<p>When users use the new Mono support in Unity, they default to C# 6, as
this is the version that Mono's C# compiler fully supports.  One of
the challenges is that Mono's C# compiler <a href="https://github.com/mono/mono/issues/6854">has not fully implemented
support for C# 7</a>, as Mono
itself moved to Roslyn.</p>
<p>The team at Unity is now working with the Roslyn team to adopt the
Roslyn C# compiler in Unity.    Because Roslyn is a larger compiler,
it is a slower compiler to startup, and Unity does many small
incremental compilations.   So the team is working towards adopting
the server compilation mode of Roslyn.   This runs the Roslyn C#
compiler as a reusable service which can compile code very quickly,
without having to pay the price for startup every time.</p>

<p>If you install the Unity beta today, you will also see that on Mac, it
now defaults to Visual Studio for Mac as its default editor.</p>
<p>JB evain leads our Unity support for Visual Studio and he has <a href="https://blogs.msdn.microsoft.com/visualstudio/2017/05/10/unity-game-development-with-visual-studio-for-mac/">brought
the
magic</a>
of his Unity plugin to Visual Studio for Mac.</p>
<p>As Unity upgrades its Mono runtime, they also benefit from the
extended debugger protocol support in Mono, which bring years of
improvements to the debugging experience.</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2018/Feb-20.html">20 Feb 2018</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	<p>Mono has a pure C# implementation of the Windows.Forms stack which
works on Mac, Linux and Windows.  It emulates some of the core of the
Win32 API to achieve this.</p>
<p>While Mono's Windows.Forms is not an actively developed UI stack, it
is required by a number of third party libraries, some data types are
consumed by other Mono libraries (part of the original design
contract), so we have kept it around.</p>
<center>
<a href="https://tirania.org/images/mac-mwf-2018.png">
<img src="https://tirania.org/images/mac-mwf-2018.png" width="720">
</a>
</center>
<p>On Mac, Mono's Windows.Forms was built on top of Carbon, an old
C-based API that was available on MacOS.  This backend was written by
Geoff Norton for Mono many years ago.</p>
<p>As Mono switched to 64 bits by default, this meant that Windows.Forms
could not be used.  We have a couple of options, try to upgrade the
32-bit Carbon code to 64-bit Carbon code or build a new backend on top
of Cocoa (<a href="https://developer.xamarin.com/guides/mac/getting_started/hello,_mac/">using Xamarin.Mac</a>).</p>
<p>For years, I had assumed that Carbon on 64 was not really supported,
but a recent trip to the console shows that Apple has added a 64-bit
port.  Either my memory is failing me (common at this age), or Apple
at some point changed their mind.  I spent all of 20 minutes trying to
do an upgrade, but the header files and documentation for the APIs we
rely on are just not available, so at best, I would be doing some
guess work as to which APIs have been upgraded to 64 bits, and which
APIs are available (rumors on Google searches indicate that while
Carbon is 64 bits, not all APIs might be there).</p>
<p>I figured that I could try to build a Cocoa backend with Xamarin.Mac,
so I sent <a href="https://github.com/mono/mono/pull/7100">this pull request</a>
to let me do this outside of the Mono tree on my copious spare time,
so this weekend I did some work on the <a href="https://github.com/migueldeicaza/CocoaDriver">Cocoa Driver</a>.</p>
<p>But this morning, on twitter, <a href="https://twitter.com/filipnavara">Filip Navarra</a> noticed the above, and contacted me:</p>
<twitter-widget id="twitter-widget-0" data-tweet-id="965865850015281152"></twitter-widget>

<p>He has been kind enough to upload this <a href="https://github.com/filipnavara/mac-playground">Cocoa-based backend to GitHub</a>.</p>
<h2 id="going-native">Going Native</h2>
<p>There are a couple of interesting things about this Windows.Forms backend for Cocoa.</p>
<p>The first one, is that it is using
<a href="https://github.com/mono/sysdrawing-coregraphics">sysdrawing-coregraphics</a>,
a custom version of System.Drawing that we had originally developed
for iOS users that implements the API in terms of <a href="https://developer.xamarin.com/guides/ios/platform_features/graphics_animation_ios/core_graphics/">CoreGraphics</a> instead
of using Cairo, FontConfig, FreeType and Pango.</p>
<p>The second one, is that some controls are backed by native AppKit
controls, those that implement the
<a href="https://github.com/filipnavara/mac-playground/blob/master/mono/mcs/class/System.Windows.Forms/System.Windows.Forms.CocoaInternal/IMacNativeControl.cs">IMacNativeControl</a>
interface.  Among those you can find Button, ComboBox, ProgressBar,
ScrollBar and the UpDownStepper.</p>
<p>I will now abandon my weekend hack, and instead get this code drop
integrated as the 64-bit Cocoa backend.</p>
<p>Stay tuned!</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2018/Feb-20-1.html">20 Feb 2018</a></p>

<hr>


<!-- Blog Post -->

<!-- Title -->


<!-- Author -->
<p>
    by <a href="#">Miguel de Icaza</a>
</p>

<!--<hr>-->
<!-- Preview Image -->
<!--img class="img-responsive" src="http://placehold.it/900x300" alt=""-->
<!--<hr>-->

<!-- Post Content -->
<div>
	<p>Even these days, I still spend too much time on the command line.   My
friends still make fun of my MacOS desktop when they see that I run a
full screen terminal, and the main program that I am running there is
the Midnight Commander:</p>
<center>
<a href="https://tirania.org/images/mc-full-screen.png">
<img src="https://tirania.org/images/mc-full-screen-min.png" width="720">
</a>
</center>
<p>Every once in a while I write an interactive application, and I want
to have full bash-like command line editing, history and search.   The
Unix world used to have GNU readline as a C library, but I wanted
something that worked on both Unix and Windows with minimal
dependencies.</p>
<p>Almost 10 years ago I wrote myself a C# library to do this, it works
on both Unix and Windows and it was the library that has been used by
Mono's interactive C# shell for the last decade or so.</p>
<p>This library used to be called <btt>getline.cs, and it was part
of a series of single source file libraries that we distributed with
Mono.</btt></p>
<p>The idea of distributing libraries that were made up of a
single source file did not really catch on.   So we have modernized
our own ways and now we publish these single-file libraries as NuGet
packages that you can use.</p>
<p>You can now add an interactive command line shell with NuGet by
installing the
<a href="https://www.nuget.org/packages/Mono.Terminal">Mono.Terminal</a> NuGet
package into your application.</p>
<p>We also moved the single library from being part of the gigantic Mono
repository into its own <a href="https://github.com/mono/LineEditor">repository</a>.</p>
<p>The GitHub page has more information on the key bindings available,
how to use the history and how to add code-completion (even including
a cute popup).</p>
<center>
<img src="https://github.com/mono/LineEditor/raw/master/LineEditor/csharp.png" width="720">
</center>
<p>The library is built entirely on top of <code>System.Console</code>, and is
distributed as a .NET Standard library which can run on your choice of
.NET runtime (.NET Core, .NET Desktop or Mono).</p>
<p>Check the <a href="https://github.com/mono/LineEditor">GitHub project page</a>
for more information.</p>

</div>
<!-- Date/Time -->
<p><span></span> Posted on <a href="https://tirania.org/blog/archive/2018/Jan-12.html">12 Jan 2018</a></p>

<hr>




	    <p><a href="https://tirania.org/blog/page1.html">Older entries »</a>
	</p></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>