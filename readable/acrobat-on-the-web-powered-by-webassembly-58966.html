<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Acrobat on the Web, Powered by WebAssembly - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Acrobat on the Web, Powered by WebAssembly - linksfor.dev(s)"/>
    <meta property="article:author" content="https://medium.com/@tapananand"/>
    <meta property="og:description" content="We describe how we used WebAssembly to bring Adobe&#x2019;s performant and pixel-perfect rendering on the Web with the Document Cloud View SDK."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://medium.com/adobetech/acrobat-on-the-web-powered-by-webassembly-782385e4947e"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Acrobat on the Web, Powered by WebAssembly</title>
<div class="readable">
        <h1>Acrobat on the Web, Powered by WebAssembly</h1>
            <div>by https://medium.com/@tapananand</div>
            <div>Reading time: 8-10 minutes</div>
        <div>Posted here: 25 Feb 2020</div>
        <p><a href="https://medium.com/adobetech/acrobat-on-the-web-powered-by-webassembly-782385e4947e">https://medium.com/adobetech/acrobat-on-the-web-powered-by-webassembly-782385e4947e</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><section><div><div><div><div><div><div><div><a rel="noopener" href="https://medium.com/@tapananand?source=post_page-----782385e4947e----------------------"><div><p><img alt="Tapan Anand" src="https://miro.medium.com/fit/c/96/96/2*8M9a8uhOgsnyb31NmDtUuA.png" width="48" height="48"></p></div></a></div></div></div></div></div><p id="8512" data-selectable-paragraph="">PDF documents are a major part of our digital lives and, in an era where we spend most of our time working inside a web browser, enhancing the PDF experience on the web is crucial for providing a seamless, multi-device experience. As the creators of PDF, this led Adobe to envision Acrobat Web; we embarked on our Acrobat Web journey with the introduction of the <a href="https://www.adobe.io/apis/documentcloud/dcsdk/viewsdk.html" target="_blank" rel="noopener nofollow">Document Cloud View SDK</a> last year.</p><p id="6b6e" data-selectable-paragraph="">View SDK offers Adobe’s pixel perfect PDF viewing on the web with the promise of performance and ease of integration on all major browsers. It also offers UI customization and integration with Adobe Analytics. You can see View SDK in action <a href="https://documentcloud.adobe.com/view-sdk-demo/index.html" target="_blank" rel="noopener nofollow">here</a>.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*HqelSM6beWmKZHdo_oF3Yg.png?q=20" width="480" height="400" role="presentation"></p><p><img width="480" height="400" role="presentation" src="https://miro.medium.com/max/480/1*HqelSM6beWmKZHdo_oF3Yg.png"></p></div></div></div></figure><p id="7c3e" data-selectable-paragraph="">PDF rendering and viewing in the View SDK is done purely on the client’s browser. All the client-side PDF heavy lifting is performed by the core component of the View SDK called <strong>Acrobat JS.</strong></p><p id="7cff" data-selectable-paragraph="">Acrobat JS is a web-based PDF library powered by <a href="https://webassembly.org/" target="_blank" rel="noopener nofollow">WebAssembly</a>. WebAssembly (WASM) is an open standard that enables reusing native C/C++/Rust applications in a web browser at near native performance. Acrobat JS leverages WebAssembly by using Adobe’s Mobile PDF library on the web; the same library that powers Adobe’s Acrobat Mobile Apps. The library’s C++ code has been compiled to WebAssembly to bring Adobe’s high-fidelity PDF rendering on the Web.</p><p id="2855" data-selectable-paragraph="">The Acrobat JS project started in the very early phases of WebAssembly in 2016, which meant the documentation and support was still very new. The browser implementations and the standard were continuously changing. Debugging support was also not very convenient, especially for large codebases like ours. But the fun of working with such an amazing technology made it all worth it.</p><p id="a410" data-selectable-paragraph="">Ever since we started working on Acrobat JS, we always had two major goals: g<strong>ood</strong> p<strong>erformance </strong>and<strong> high fidelity</strong>. To ensure high fidelity, our rendering technology is based on doing a pixel-perfect rendering of the PDF instead of translating the PDF content streams to Canvas or HTML. The output is a high quality bitmap which is shown to the user using an <em>&lt;img&gt;</em> tag. The bitmap is compressed to PNG to save memory.</p><p id="07cd" data-selectable-paragraph="">Similarly, to ensure that text selection is accurate, we pass the user interaction events to the PDF library, which provides us the quads to be drawn based on the page content. This is in contrast to doing selection on a hidden text layer on top of the bitmap as it may lead to alignment issues when there are fonts embedded in the PDF or if there is a font mismatch or font substitution.</p><p id="8984" data-selectable-paragraph="">In this section, I will talk about various challenging problems we solved to ensure both our goals for Acrobat JS: <strong>performance</strong> and <strong>high fidelity</strong>.</p><h2 id="a7ef" data-selectable-paragraph="">Performance</h2><p id="1bda" data-selectable-paragraph="">A major performance metric for us was the time it takes for us to load and initialize the PDF library as a WebAssembly (WASM) module and show the first page to the user. We like to call this metric as <strong>timeTillFirstRender. </strong>Currently, in the View SDK, this time is under <strong>900ms</strong> for <strong>75 percent</strong> of files from our benchmarking set (composition derived from real world analytics data). We reached these numbers after working through an improvement of about 300 percent in <strong>timeTillFirstRender </strong>by using various strategies that we discuss here.</p><p id="9277" data-selectable-paragraph="">A major bottleneck for <strong>timeTillFirstRender</strong> was the time it takes for the WASM module to get compiled and ready for use. This was specially difficult when <a href="https://v8.dev/blog/liftoff" target="_blank" rel="noopener nofollow">tiered compilation</a> was not part of JS engines. A lot of the work went into keeping the WASM size as low as possible. We used various strategies to accomplish this:</p><ol><li id="f6da" data-selectable-paragraph=""><strong>WASM Swapping</strong></li><li id="fc8d" data-selectable-paragraph=""><strong>Dynamic linking</strong></li><li id="3f92" data-selectable-paragraph=""><strong>Moving out font data from the binary: </strong>Separating out static data like fonts from the binary and, instead, having it load dynamically when needed helped us in reducing WASM file size by about <strong>1MB</strong>.</li></ol><p id="96de" data-selectable-paragraph="">Let’s talk about these in more detail.</p><h2 id="6dc4" data-selectable-paragraph="">WASM Swapping</h2><p id="e8f1" data-selectable-paragraph="">WebAssembly currently doesn’t have built-in exception handling support and thus, in the web environment, it is emulated with the help of JavaScript. This translates to size and performance penalties if exceptions are enabled and used in the code.</p><blockquote><p id="0f90" data-selectable-paragraph="">In order to overcome this performance penalty for our critical rendering path of showing the first page to the user, we innovated an approach where, by default, we load the thinner WASM file with exceptions disabled and only load the exception enabled binary when an actual exception is encountered. That’s why we call this strategy as <strong>WASM Swapping</strong>.</p></blockquote><p id="b7ed" data-selectable-paragraph="">We further extended this to implement something similar to a PGO (profile guided optimization), where we identified the hot and cold areas of our code on a big test set and then got rid of all the ‘colder’ areas from the thinner binary.</p><p id="f066" data-selectable-paragraph="">The below graph shows the gains we observed at the time of implementing this strategy on our benchmarking set:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*BnJQikRCFLN0FSvZcdMltA.png?q=20" width="939" height="427" role="presentation"></p><p><img width="939" height="427" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">Initial improvements provided by the WASM swapping approach</figcaption></figure><p id="dc52" data-selectable-paragraph="">As you can see, this offered about 40 percent improvements in both size and performance for us, which was huge. We further made changes in our Mobile PDF Library code to reduce the use of exceptions and also, with advancements in WebAssembly and JS engines, the penalty of exceptions became less costly with time than in the relatively early days. We will still stick to this strategy as it still offers us about 20 percent gains in both size and load time performance.</p><h2 id="dd0f" data-selectable-paragraph="">Dynamic linking</h2><p id="b692" data-selectable-paragraph="">Along our journey of bringing more and more PDF goodness to the web we encountered situations where adding more PDF features to the library meant adding to the WASM size, thus affecting the overall performance. We could have extended our WASM Swapping approach to get around this, but we needed a more long-term approach to this. That’s where <a href="https://github.com/emscripten-core/emscripten/wiki/Linking" target="_blank" rel="noopener nofollow">dynamic linking</a> comes into picture.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*dpoTCMsAtu4Bh4x_H5qseg.png?q=20" width="733" height="400" role="presentation"></p><p><img width="733" height="400" role="presentation"></p></div></div></div></div></figure><p id="4b48" data-selectable-paragraph="">As part of dynamic linking, we divided the WASM module into a main module and several side modules. All the core PDF viewing features reside in the main module and additional features are present in side modules. We load only the main module for the critical rendering path while the side modules are loaded lazily on demand.</p><p id="aca3" data-selectable-paragraph="">This allowed us to keep adding new features without severely affecting the critical rendering path performance by adding incremental features in side modules. The current main module size is <strong>865kB</strong> <strong>gzipped</strong>.</p><h2 id="43b0" data-selectable-paragraph="">Rendering non-embedded fonts with high fidelity</h2><p id="5523" data-selectable-paragraph="">Fonts required to render text in a PDF are usually embedded as part of the PDF itself, but with documents in the wild, it is not very uncommon to find PDFs where the font is not actually embedded inside the PDF. In such a scenario, we had to fallback to font substitution which meant we could not meet our goal of ensuring high fidelity rendering.</p><blockquote><p id="7dab" data-selectable-paragraph="">For most native implementations, the font, if present on a user’s machine, can be used or a close substitution of that font could be used. But for us this was not possible since we were not using HTML rendering and the JavaScript and WASM sandbox can’t access native fonts directly. We innovated a solution around the Canvas API and our Mobile PDF library to render such PDFs with the correct font when available on the user’s machine.</p></blockquote><p id="7a80" data-selectable-paragraph="">The following images show the results of this:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*eQNNI9sCD954LvgxYQtkNg.png?q=20" width="1280" height="302" role="presentation"></p><p><img width="1280" height="302" role="presentation"></p></div></div></div></div><figcaption data-selectable-paragraph="">Differences are specially visible in lower-case <strong>y</strong> and upper-case <strong>I.</strong></figcaption></figure><p id="1410" data-selectable-paragraph="">This is an excerpt from a PDF which requires the font <strong>Tahoma </strong>for rendering, but it’s not embedded in the PDF. One can notice the differences in fonts between the above two images specially in characters like lower-case “y” and upper-case “I”.</p><p id="df26" data-selectable-paragraph="">WebAssembly has opened so many opportunities on the Web. Performing high octane tasks efficiently on the browser is no longer a far-fetched dream. Our journey with running high fidelity rendering on the browser in a performant way demonstrates this.</p><p id="2d3a" data-selectable-paragraph="">The WebAssembly working group, the browsers and everyone involved, is doing an awesome job of ensuring WebAssembly keeps getting better and better every day. Some of the recent interesting developments have been around threads and SIMD support and we are working towards using them in the View SDK. We keep a close watch on the upcoming WebAssembly advancements and <a href="https://github.com/WebAssembly/design/blob/master/FutureFeatures.md" target="_blank" rel="noopener nofollow">features</a>. We are really excited about features like Exception Handling and SIMD. We look forward to advancing the Web with the help of WebAssembly.</p></div></div></section></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>