<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Effectively stubbing remote HTTP service dependencies with HttpClient Interception - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Effectively stubbing remote HTTP service dependencies with HttpClient Interception - linksfor.dev(s)"/>
    <meta property="og:description" content="In this post we take a look at how we can use the HttpClient Interception library to stub responses from upstream APIs"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="http://josephwoodward.co.uk/2020/05/stubbing-remote-http-api-services-httpclient-interception"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Effectively stubbing remote HTTP service dependencies with HttpClient Interception</title>
<div class="readable">
        <h1>Effectively stubbing remote HTTP service dependencies with HttpClient Interception</h1>
            <div>Reading time: 14-17 minutes</div>
        <div>Posted here: 26 May 2020</div>
        <p><a href="http://josephwoodward.co.uk/2020/05/stubbing-remote-http-api-services-httpclient-interception">http://josephwoodward.co.uk/2020/05/stubbing-remote-http-api-services-httpclient-interception</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
			<p>Recently I've been reading the new <a href="https://www.amazon.co.uk/dp/B0859PF5HB">Software Engineering at Google book</a> where I've found the chapters on testing to be particularly interesting. One paragraph that especially resonated with my own personal experiences with testing was the following excerpt:</p>
<p><img src="https://pbs.twimg.com/media/EV9CZOFWoAA976h?format=jpg&amp;name=medium" alt="Excerpt from the Software Engineering at Google book"></p>
<p>This chapter got me thinking a lot about my preference for testing units of behaviour as opposed to implementation details, and as someone that works with a lot of services that communicate via HTTP there's one particular library that's helped me time and time again, so much so that I feel deserves its own post.</p>
<h2>Introducing HttpClient Interception</h2>
<p>From a high level, <a href="https://github.com/justeat/httpclient-interception">HttpClient Interception</a> is a .NET Standard library designed to intercept server-side HTTP dependencies.</p>
<p>Prior to learning about it the two patterns I most frequently used in order to stub responses from an upstream API were either to create a custom <code>HttpMessageHandler</code> (which would return desired responses/assertions on a given input), or create an interface over an <code>HttpClient</code>. Both approaches tend to be painful (the former being difficult to mock due to lack of an interface and the latter somewhat the same).</p>
<p>HttpClient Interception, the brainchild of <a href="https://twitter.com/martin_costello">Martin Costello</a>, aims to alleviate these pains making <a href="https://en.wikipedia.org/wiki/Black-box_testing">Black Box testing</a> code that depends on one or more external HTTP APIs much less intrusive.</p>
<h2>Let's take a look</h2>
<p>HttpClient Interception offers a convenient builder pattern over returning a desired response for a given input. Let's take a look at what a simple test would look like this:</p>
<div id="gist103226709">
    <div>
      <div>
        <div>
  <div id="file-hc1-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-hc1-cs-L1" data-line-number="1"></td>
        <td id="file-hc1-cs-LC1"><span><span>//</span> Arrange</span></td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L2" data-line-number="2"></td>
        <td id="file-hc1-cs-LC2"><span>var</span> <span>options</span> <span>=</span> <span>new</span> <span>HttpClientInterceptorOptions</span> {<span>ThrowOnMissingRegistration</span> <span>=</span> <span>true</span>};</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L3" data-line-number="3"></td>
        <td id="file-hc1-cs-LC3"><span>new</span> <span>HttpRequestInterceptionBuilder</span>()</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L4" data-line-number="4"></td>
        <td id="file-hc1-cs-LC4">    .<span>Requests</span>()</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L5" data-line-number="5"></td>
        <td id="file-hc1-cs-LC5">    .<span>ForHttps</span>()</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L6" data-line-number="6"></td>
        <td id="file-hc1-cs-LC6">    .<span>ForHost</span>(<span><span>"</span>bbc.co.uk<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L7" data-line-number="7"></td>
        <td id="file-hc1-cs-LC7">    .<span>ForPath</span>(<span><span>"</span>/news<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L8" data-line-number="8"></td>
        <td id="file-hc1-cs-LC8">    .<span>Responds</span>()</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L9" data-line-number="9"></td>
        <td id="file-hc1-cs-LC9">    .<span>WithStatus</span>(<span>500</span>)</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L10" data-line-number="10"></td>
        <td id="file-hc1-cs-LC10">    .<span>RegisterWith</span>(<span>options</span>);</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L11" data-line-number="11"></td>
        <td id="file-hc1-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L12" data-line-number="12"></td>
        <td id="file-hc1-cs-LC12"><span><span>//</span> Act</span></td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L13" data-line-number="13"></td>
        <td id="file-hc1-cs-LC13"><span>HttpClient</span> <span>client</span> <span>=</span> <span>options</span>.<span>CreateHttpClient</span>();</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L14" data-line-number="14"></td>
        <td id="file-hc1-cs-LC14"><span>var</span> <span>response</span> <span>=</span> <span>await</span> <span>client</span>.<span>GetAsync</span>(<span><span>"</span>https://bbc.co.uk/news<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L15" data-line-number="15"></td>
        <td id="file-hc1-cs-LC15">
</td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L16" data-line-number="16"></td>
        <td id="file-hc1-cs-LC16"><span><span>//</span> Assert</span></td>
      </tr>
      <tr>
        <td id="file-hc1-cs-L17" data-line-number="17"></td>
        <td id="file-hc1-cs-LC17"><span>response</span>.<span>StatusCode</span>.<span>ShouldBe</span>(<span>HttpStatusCode</span>.<span>InternalServerError</span>);</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>In this example we create an instance of <code>HttpRequestInterceptionBuilder</code> then specify the request we wish to match against and the response we'd like to return. We then register the builder against our <code>HttpClientInterceptionOptions</code> type and use it to create an instance of an <code>HttpClient</code>.</p>
<p>Now any requests that match our builder's parameters will return the response defined (a <code>500</code> response code) without the request leaving the <code>HttpClient</code>.</p>
<h2>Missing Registrations</h2>
<p>At this point it's worth calling out the <code>ThrowOnMissingRegistration</code> property.</p>
<p>Setting <code>ThrowOnMissingRegistration</code> to <code>true</code> ensures no request leaves an <code>HttpClient</code> created or modified by HttpClient Interception. This is helpful for ensuring you have visibility over unmatched requests, otherwise leaving <code>ThrowOnMissingRegistration</code> as false could mean your request gets handled by the real upstream service, causing a false positive or having a negative impact on your test without you being aware of it.</p>
<p>Though naturally it all depends on your use case so in some instances this may actually be a desired behaviour so consideration is required.</p>
<h2>Matching multiple requests</h2>
<p>If you want to stub the response to more than one HTTP request you can register multiple builders like so:</p>
<div id="gist103226715">
    <div>
      <div>
        <div>
  <div id="file-hc2-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-hc2-cs-L1" data-line-number="1"></td>
        <td id="file-hc2-cs-LC1"><span><span>//</span> Arrange</span></td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L2" data-line-number="2"></td>
        <td id="file-hc2-cs-LC2"><span>var</span> <span>options</span> <span>=</span> <span>new</span> <span>HttpClientInterceptorOptions</span> {<span>ThrowOnMissingRegistration</span> <span>=</span> <span>true</span>};</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L3" data-line-number="3"></td>
        <td id="file-hc2-cs-LC3"><span>new</span> <span>HttpRequestInterceptionBuilder</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L4" data-line-number="4"></td>
        <td id="file-hc2-cs-LC4">    .<span>Requests</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L5" data-line-number="5"></td>
        <td id="file-hc2-cs-LC5">    .<span>ForHttps</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L6" data-line-number="6"></td>
        <td id="file-hc2-cs-LC6">    .<span>ForHost</span>(<span><span>"</span>bbc.co.uk<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L7" data-line-number="7"></td>
        <td id="file-hc2-cs-LC7">    .<span>ForPath</span>(<span><span>"</span>/news<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L8" data-line-number="8"></td>
        <td id="file-hc2-cs-LC8">    .<span>Responds</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L9" data-line-number="9"></td>
        <td id="file-hc2-cs-LC9">    .<span>WithStatus</span>(<span>500</span>)</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L10" data-line-number="10"></td>
        <td id="file-hc2-cs-LC10">    .<span>RegisterWith</span>(<span>options</span>);</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L11" data-line-number="11"></td>
        <td id="file-hc2-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L12" data-line-number="12"></td>
        <td id="file-hc2-cs-LC12"><span>new</span> <span>HttpRequestInterceptionBuilder</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L13" data-line-number="13"></td>
        <td id="file-hc2-cs-LC13">    .<span>Requests</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L14" data-line-number="14"></td>
        <td id="file-hc2-cs-LC14">    .<span>ForHttps</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L15" data-line-number="15"></td>
        <td id="file-hc2-cs-LC15">    .<span>ForHost</span>(<span><span>"</span>bbc.co.uk<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L16" data-line-number="16"></td>
        <td id="file-hc2-cs-LC16">    .<span>ForPath</span>(<span><span>"</span>/sport<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L17" data-line-number="17"></td>
        <td id="file-hc2-cs-LC17">    .<span>Responds</span>()</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L18" data-line-number="18"></td>
        <td id="file-hc2-cs-LC18">    .<span>WithStatus</span>(<span>404</span>)</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L19" data-line-number="19"></td>
        <td id="file-hc2-cs-LC19">    .<span>RegisterWith</span>(<span>options</span>);</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L20" data-line-number="20"></td>
        <td id="file-hc2-cs-LC20">
</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L21" data-line-number="21"></td>
        <td id="file-hc2-cs-LC21"><span><span>//</span> Act</span></td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L22" data-line-number="22"></td>
        <td id="file-hc2-cs-LC22"><span>var</span> <span>client</span> <span>=</span> <span>options</span>.<span>CreateHttpClient</span>();</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L23" data-line-number="23"></td>
        <td id="file-hc2-cs-LC23"><span>var</span> <span>news</span> <span>=</span> <span>await</span> <span>client</span>.<span>GetAsync</span>(<span><span>"</span>https://bbc.co.uk/news<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L24" data-line-number="24"></td>
        <td id="file-hc2-cs-LC24"><span>var</span> <span>sport</span> <span>=</span> <span>await</span> <span>client</span>.<span>GetAsync</span>(<span><span>"</span>https://bbc.co.uk/sport<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L25" data-line-number="25"></td>
        <td id="file-hc2-cs-LC25">
</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L26" data-line-number="26"></td>
        <td id="file-hc2-cs-LC26"><span><span>//</span> Assert</span></td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L27" data-line-number="27"></td>
        <td id="file-hc2-cs-LC27"><span>news</span>.<span>StatusCode</span>.<span>ShouldBe</span>(<span>HttpStatusCode</span>.<span>InternalServerError</span>);</td>
      </tr>
      <tr>
        <td id="file-hc2-cs-L28" data-line-number="28"></td>
        <td id="file-hc2-cs-LC28"><span>sport</span>.<span>StatusCode</span>.<span>ShouldBe</span>(<span>HttpStatusCode</span>.<span>NotFound</span>);</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>Here I've registered two separate endpoints on the same <code>HttpClientInterceptorOptions</code> object which is then used to create our <code>HttpClient</code>. Now requests to any of the two registered endpoints will result in either a Not Found response (404) or an Internal Server Error (500) response.</p>
<h2>Creating an HttpMessageHandler</h2>
<p>Not all libraries will enable you to use a custom HttpClient, some may only offer you the ability to add a new <code>HttpMessageHandler</code>, thankfully HttpClient Interception can also create an <code>HttpMessageHandler</code> that can be passed to the <code>HttpClient</code>.</p>
<p>For example:</p>
<div id="gist103226979">
    <div>
      <div>
        <div>
  <div id="file-hc3-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-hc3-cs-L1" data-line-number="1"></td>
        <td id="file-hc3-cs-LC1"><span><span>//</span> Arrange</span></td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L2" data-line-number="2"></td>
        <td id="file-hc3-cs-LC2"><span>var</span> <span>options</span> <span>=</span> <span>new</span> <span>HttpClientInterceptorOptions</span> {<span>ThrowOnMissingRegistration</span> <span>=</span> <span>true</span>};</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L3" data-line-number="3"></td>
        <td id="file-hc3-cs-LC3"><span>new</span> <span>HttpRequestInterceptionBuilder</span>()</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L4" data-line-number="4"></td>
        <td id="file-hc3-cs-LC4">    .<span>Requests</span>()</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L5" data-line-number="5"></td>
        <td id="file-hc3-cs-LC5">    .<span>ForHttps</span>()</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L6" data-line-number="6"></td>
        <td id="file-hc3-cs-LC6">    .<span>ForHost</span>(<span><span>"</span>bbc.co.uk<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L7" data-line-number="7"></td>
        <td id="file-hc3-cs-LC7">    .<span>ForPath</span>(<span><span>"</span>/news<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L8" data-line-number="8"></td>
        <td id="file-hc3-cs-LC8">    .<span>Responds</span>()</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L9" data-line-number="9"></td>
        <td id="file-hc3-cs-LC9">    .<span>WithStatus</span>(<span>500</span>)</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L10" data-line-number="10"></td>
        <td id="file-hc3-cs-LC10">    .<span>RegisterWith</span>(<span>options</span>);</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L11" data-line-number="11"></td>
        <td id="file-hc3-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L12" data-line-number="12"></td>
        <td id="file-hc3-cs-LC12"><span>var</span> <span>handler</span> <span>=</span> <span>options</span>.<span>CreateHttpMessageHandler</span>();</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L13" data-line-number="13"></td>
        <td id="file-hc3-cs-LC13">
</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L14" data-line-number="14"></td>
        <td id="file-hc3-cs-LC14"><span><span>//</span> Act</span></td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L15" data-line-number="15"></td>
        <td id="file-hc3-cs-LC15"><span>var</span> <span>client</span> <span>=</span> <span>new</span> <span>HttpClient</span>(<span>handler</span>);</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L16" data-line-number="16"></td>
        <td id="file-hc3-cs-LC16"><span>var</span> <span>response</span> <span>=</span> <span>await</span> <span>client</span>.<span>GetAsync</span>(<span><span>"</span>https://bbc.co.uk/news<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L17" data-line-number="17"></td>
        <td id="file-hc3-cs-LC17">
</td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L18" data-line-number="18"></td>
        <td id="file-hc3-cs-LC18"><span><span>//</span> Assert</span></td>
      </tr>
      <tr>
        <td id="file-hc3-cs-L19" data-line-number="19"></td>
        <td id="file-hc3-cs-LC19"><span>response</span>.<span>StatusCode</span>.<span>ShouldBe</span>(<span>HttpStatusCode</span>.<span>InternalServerError</span>);</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<h2>Using HttpClientInterception with ASP.NET Core and IHttpClientFactory.</h2>
<p>Now we've seen what HttpClient Interception can offer, let's take a look at how we could use it to test an ASP.NET Core application depends on an upstream API. This example is taken straight from the <a href="https://github.com/justeat/httpclient-interception/tree/master/samples">Sample application</a> within the HttpClient Interception repository.</p>
<p>Imagine we have an application that makes a remote call to GitHub’s API via Refit. This is what the controller action might look like:</p>
<div id="gist103226989">
    <div>
      <div>
        <div>
  <div id="file-reposcontroller-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-reposcontroller-cs-L1" data-line-number="1"></td>
        <td id="file-reposcontroller-cs-LC1">[<span>ApiController</span>]</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L2" data-line-number="2"></td>
        <td id="file-reposcontroller-cs-LC2">[<span>Route</span>(<span><span>"</span>api/[controller]<span>"</span></span>)]</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L3" data-line-number="3"></td>
        <td id="file-reposcontroller-cs-LC3"><span>public</span> <span>class</span> <span>ReposController</span> : <span>Controller</span></td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L4" data-line-number="4"></td>
        <td id="file-reposcontroller-cs-LC4">{</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L5" data-line-number="5"></td>
        <td id="file-reposcontroller-cs-LC5">    <span>private</span> <span>readonly</span> <span>IGitHub</span> <span>_github</span>;</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L6" data-line-number="6"></td>
        <td id="file-reposcontroller-cs-LC6">
</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L7" data-line-number="7"></td>
        <td id="file-reposcontroller-cs-LC7">    <span>public</span> <span>ReposController</span>(<span>IGitHub</span> <span>github</span>)</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L8" data-line-number="8"></td>
        <td id="file-reposcontroller-cs-LC8">    {</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L9" data-line-number="9"></td>
        <td id="file-reposcontroller-cs-LC9">        <span>_github</span> <span>=</span> <span>github</span>;</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L10" data-line-number="10"></td>
        <td id="file-reposcontroller-cs-LC10">    }</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L11" data-line-number="11"></td>
        <td id="file-reposcontroller-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L12" data-line-number="12"></td>
        <td id="file-reposcontroller-cs-LC12">    [<span>HttpGet</span>]</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L13" data-line-number="13"></td>
        <td id="file-reposcontroller-cs-LC13">    <span>public</span> <span>async</span> <span>Task</span>&lt;<span>ICollection</span>&lt;<span>string</span>&gt;&gt; <span>Get</span>()</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L14" data-line-number="14"></td>
        <td id="file-reposcontroller-cs-LC14">    {</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L15" data-line-number="15"></td>
        <td id="file-reposcontroller-cs-LC15">        <span>var</span> <span>repositories</span> <span>=</span> <span>await</span> <span>_github</span>.<span>GetRepositoriesAsync</span>(<span><span>"</span>weyland-yutani<span>"</span></span>, <span>count</span>: <span>10</span>);</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L16" data-line-number="16"></td>
        <td id="file-reposcontroller-cs-LC16">        <span>var</span> <span>names</span> <span>=</span> <span>repositories</span>.<span>Select</span>(<span>repository</span> <span>=&gt;</span> <span>repository</span>.<span>Name</span>).<span>ToList</span>();</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L17" data-line-number="17"></td>
        <td id="file-reposcontroller-cs-LC17">        <span>names</span>.<span>Sort</span>();</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L18" data-line-number="18"></td>
        <td id="file-reposcontroller-cs-LC18">        <span>return</span> <span>names</span>;</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L19" data-line-number="19"></td>
        <td id="file-reposcontroller-cs-LC19">    }</td>
      </tr>
      <tr>
        <td id="file-reposcontroller-cs-L20" data-line-number="20"></td>
        <td id="file-reposcontroller-cs-LC20">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>
 
<p>To test this we can utilise HttpClient Interception to stub the response from GitHub's API with the following fixture (based on the common <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests">WebApplicationFactory approach documented here</a>).</p>
<p>Notice that when overriding <code>ConfigureWebHost</code> we're taking advantage of the <code>IHttpMessageHandlerBuilderFilter</code> interface to add an additional <code>HttpMessageHandler</code> (created by HttpClient Interception) to any <code>HttpClient</code> created via the IHttpClientFactory API.</p>
<p>It's worth noting that you can also register the <code>HttpMessageHandler</code> using the <code>ConfigurePrimaryHttpMessageHandler</code> (see <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.httpclientbuilderextensions.configureprimaryhttpmessagehandler?view=dotnet-plat-ext-3.1">the docs here</a>) method that lives on the <code>IHttpClientBuilder</code> interface.</p>
<div id="gist103227034">
    <div>
      <div>
        <div>
  <div id="file-fixture-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-fixture-cs-L1" data-line-number="1"></td>
        <td id="file-fixture-cs-LC1"><span>public</span> <span>class</span> <span>Fixture</span>&lt;<span>TStartup</span>&gt; : <span>WebApplicationFactory</span>&lt;<span>TStartup</span>&gt; <span>where</span> <span>TStartup</span> : <span>class</span></td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L2" data-line-number="2"></td>
        <td id="file-fixture-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L3" data-line-number="3"></td>
        <td id="file-fixture-cs-LC3">    <span>public</span> <span>HttpClientInterceptorOptions</span> <span>InterceptorOptions</span> { <span>get</span>; } <span>=</span></td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L4" data-line-number="4"></td>
        <td id="file-fixture-cs-LC4">        <span>new</span> <span>HttpClientInterceptorOptions</span> {<span>ThrowOnMissingRegistration</span> <span>=</span> <span>true</span>};</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L5" data-line-number="5"></td>
        <td id="file-fixture-cs-LC5">
</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L6" data-line-number="6"></td>
        <td id="file-fixture-cs-LC6">    <span>protected</span> <span>override</span> <span>void</span> <span>ConfigureWebHost</span>(<span>IWebHostBuilder</span> <span>builder</span>)</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L7" data-line-number="7"></td>
        <td id="file-fixture-cs-LC7">    {</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L8" data-line-number="8"></td>
        <td id="file-fixture-cs-LC8">        <span>builder</span>.<span>ConfigureServices</span>(<span>s</span></td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L9" data-line-number="9"></td>
        <td id="file-fixture-cs-LC9">            <span>=</span><span>&gt;</span> <span>s</span>.<span>AddSingleton</span>&lt;<span>IHttpMessageHandlerBuilderFilter</span>, <span>InterceptionFilter</span>&gt;(</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L10" data-line-number="10"></td>
        <td id="file-fixture-cs-LC10">                <span>_</span> <span>=&gt;</span> <span>new</span> <span>InterceptionFilter</span>(<span>InterceptorOptions</span>)));</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L11" data-line-number="11"></td>
        <td id="file-fixture-cs-LC11">
</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L12" data-line-number="12"></td>
        <td id="file-fixture-cs-LC12">        <span>base</span>.<span>ConfigureWebHost</span>(<span>builder</span>);</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L13" data-line-number="13"></td>
        <td id="file-fixture-cs-LC13">    }</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L14" data-line-number="14"></td>
        <td id="file-fixture-cs-LC14">
</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L15" data-line-number="15"></td>
        <td id="file-fixture-cs-LC15">    <span>private</span> <span>sealed</span> <span>class</span> <span>InterceptionFilter</span> : <span>IHttpMessageHandlerBuilderFilter</span></td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L16" data-line-number="16"></td>
        <td id="file-fixture-cs-LC16">    {</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L17" data-line-number="17"></td>
        <td id="file-fixture-cs-LC17">        <span>private</span> <span>readonly</span> <span>HttpClientInterceptorOptions</span> <span>_options</span>;</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L18" data-line-number="18"></td>
        <td id="file-fixture-cs-LC18">
</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L19" data-line-number="19"></td>
        <td id="file-fixture-cs-LC19">        <span>internal</span> <span>InterceptionFilter</span>(<span>HttpClientInterceptorOptions</span> <span>options</span>)</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L20" data-line-number="20"></td>
        <td id="file-fixture-cs-LC20">            <span>=&gt;</span> <span>_options</span> <span>=</span> <span>options</span>;</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L21" data-line-number="21"></td>
        <td id="file-fixture-cs-LC21">
</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L22" data-line-number="22"></td>
        <td id="file-fixture-cs-LC22">        <span>public</span> <span>Action</span>&lt;<span>HttpMessageHandlerBuilder</span>&gt; <span>Configure</span>(<span>Action</span>&lt;<span>HttpMessageHandlerBuilder</span>&gt; <span>next</span>)</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L23" data-line-number="23"></td>
        <td id="file-fixture-cs-LC23">            <span>=&gt;</span> <span>builder</span> <span>=&gt;</span></td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L24" data-line-number="24"></td>
        <td id="file-fixture-cs-LC24">            {</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L25" data-line-number="25"></td>
        <td id="file-fixture-cs-LC25">                <span>next</span>(<span>builder</span>);</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L26" data-line-number="26"></td>
        <td id="file-fixture-cs-LC26">                <span>builder</span>.<span>AdditionalHandlers</span>.<span>Add</span>(<span>_options</span>.<span>CreateHttpMessageHandler</span>());</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L27" data-line-number="27"></td>
        <td id="file-fixture-cs-LC27">            };</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L28" data-line-number="28"></td>
        <td id="file-fixture-cs-LC28">    }</td>
      </tr>
      <tr>
        <td id="file-fixture-cs-L29" data-line-number="29"></td>
        <td id="file-fixture-cs-LC29">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>Now we can easily control the responses from the GitHub API from within our tests, without having to mock any internal implementation details of our application.</p>
<div id="gist103227056">
    <div>
      <div>
        <div>
  <div id="file-controllertests-cs">
    

  <div itemprop="text">
      
<table data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-controllertests-cs-L1" data-line-number="1"></td>
        <td id="file-controllertests-cs-LC1"><span>public</span> <span>class</span> <span>ControllerTests</span> : <span>IClassFixture</span>&lt;<span>Fixture</span>&lt;<span>Startup</span>&gt;&gt;</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L2" data-line-number="2"></td>
        <td id="file-controllertests-cs-LC2">{</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L3" data-line-number="3"></td>
        <td id="file-controllertests-cs-LC3">    <span>private</span> <span>readonly</span> <span>Fixture</span>&lt;<span>Startup</span>&gt; <span>_fixture</span>;</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L4" data-line-number="4"></td>
        <td id="file-controllertests-cs-LC4">
</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L5" data-line-number="5"></td>
        <td id="file-controllertests-cs-LC5">    <span>public</span> <span>ControllerTests</span>(<span>Fixture</span>&lt;<span>Startup</span>&gt; <span>fixture</span>) <span>=&gt;</span> <span>_fixture</span> <span>=</span> <span>fixture</span>;</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L6" data-line-number="6"></td>
        <td id="file-controllertests-cs-LC6">
</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L7" data-line-number="7"></td>
        <td id="file-controllertests-cs-LC7">    [<span>Fact</span>]</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L8" data-line-number="8"></td>
        <td id="file-controllertests-cs-LC8">    <span>public</span> <span>async</span> <span>Task</span> <span>ReturnsOrganizationRepositories</span>()</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L9" data-line-number="9"></td>
        <td id="file-controllertests-cs-LC9">    {</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L10" data-line-number="10"></td>
        <td id="file-controllertests-cs-LC10">        <span><span>//</span> Arrange</span></td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L11" data-line-number="11"></td>
        <td id="file-controllertests-cs-LC11">        <span>using</span> <span>var</span> <span>_</span> <span>=</span> <span>_fixture</span>.<span>InterceptorOptions</span>.<span>BeginScope</span>();</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L12" data-line-number="12"></td>
        <td id="file-controllertests-cs-LC12">        <span>new</span> <span>HttpRequestInterceptionBuilder</span>()</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L13" data-line-number="13"></td>
        <td id="file-controllertests-cs-LC13">            .<span>Requests</span>()</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L14" data-line-number="14"></td>
        <td id="file-controllertests-cs-LC14">            .<span>ForHttps</span>()</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L15" data-line-number="15"></td>
        <td id="file-controllertests-cs-LC15">            .<span>ForHost</span>(<span><span>"</span>api.github.com<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L16" data-line-number="16"></td>
        <td id="file-controllertests-cs-LC16">            .<span>ForPath</span>(<span><span>"</span>orgs/weyland-yutani/repos<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L17" data-line-number="17"></td>
        <td id="file-controllertests-cs-LC17">            .<span>ForQuery</span>(<span><span>"</span>per_page=10<span>"</span></span>)</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L18" data-line-number="18"></td>
        <td id="file-controllertests-cs-LC18">            .<span>Responds</span>()</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L19" data-line-number="19"></td>
        <td id="file-controllertests-cs-LC19">            .<span>WithSystemTextJsonContent</span>(<span>new</span>[] {<span>new</span> {<span>id</span> <span>=</span> <span>1</span>, <span>name</span> <span>=</span> <span><span>"</span>foo<span>"</span></span>}, <span>new</span> {<span>id</span> <span>=</span> <span>2</span>, <span>name</span> <span>=</span> <span><span>"</span>bar<span>"</span></span>}})</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L20" data-line-number="20"></td>
        <td id="file-controllertests-cs-LC20">            .<span>RegisterWith</span>(<span>_fixture</span>.<span>InterceptorOptions</span>);</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L21" data-line-number="21"></td>
        <td id="file-controllertests-cs-LC21">
</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L22" data-line-number="22"></td>
        <td id="file-controllertests-cs-LC22">        <span><span>//</span> Act</span></td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L23" data-line-number="23"></td>
        <td id="file-controllertests-cs-LC23">        <span>using</span> <span>var</span> <span>httpClient</span> <span>=</span> <span>_fixture</span>.<span>CreateClient</span>();</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L24" data-line-number="24"></td>
        <td id="file-controllertests-cs-LC24">
</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L25" data-line-number="25"></td>
        <td id="file-controllertests-cs-LC25">        <span>string</span> <span>json</span> <span>=</span> <span>await</span> <span>httpClient</span>.<span>GetStringAsync</span>(<span><span>"</span>api/repos<span>"</span></span>);</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L26" data-line-number="26"></td>
        <td id="file-controllertests-cs-LC26">        <span>var</span> <span>actual</span> <span>=</span> <span>JsonConvert</span>.<span>DeserializeObject</span>&lt;<span>string</span>[]&gt;(<span>json</span>);</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L27" data-line-number="27"></td>
        <td id="file-controllertests-cs-LC27">
</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L28" data-line-number="28"></td>
        <td id="file-controllertests-cs-LC28">        <span><span>//</span> Assert</span></td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L29" data-line-number="29"></td>
        <td id="file-controllertests-cs-LC29">        <span>actual</span>.<span>ShouldBe</span>(<span>new</span>[] {<span><span>"</span>bar<span>"</span></span>, <span><span>"</span>foo<span>"</span></span>});</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L30" data-line-number="30"></td>
        <td id="file-controllertests-cs-LC30">    }</td>
      </tr>
      <tr>
        <td id="file-controllertests-cs-L31" data-line-number="31"></td>
        <td id="file-controllertests-cs-LC31">}</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<h2>On Closing</h2>
<p>Hopefully this post has demonstrated just how helpful and versatile HttpClient Interception can be and how it can create maintainable tests that don't break the moment you change an implementation detail. I'd highly recommend you check it our as this post only scratches the surface of what it can do.</p>
<p>I'd like to close this post with a <a href="https://stackoverflow.com/questions/153234/how-deep-are-your-unit-tests/153565#153565">quote from Kent Beck</a>:</p>
<blockquote>
<p>"I get paid for code that works, not for tests, so my philosophy is to test as little as possible to reach a given level of confidence."</p>
</blockquote>

		</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>