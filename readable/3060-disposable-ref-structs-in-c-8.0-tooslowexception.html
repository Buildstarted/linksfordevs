<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Disposable ref structs in C# 8.0 &#x2013; TooSlowException -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Disposable ref structs in C# 8.0 – TooSlowException</h1><div><div class="entry-content" itemprop="articleBody"><p>Among many things that are coming with the upcoming C# 8.0, one perfectly fits the <a href="http://tooslowexception.com/ref-struct-byref-like-type-and-byreference-byref-like-instance-field/">topic of ref structs I’ve raised in my previous post</a> – <em>disposable ref structs</em>.</p><p>As <a href="https://blogs.msdn.microsoft.com/dotnet/2019/01/24/do-more-with-patterns-in-c-8-0/">one of the blog posts announcing C# 8.0 changes</a> (in Visual Studio 2019 Preview 2) mentions:</p><blockquote><p>“Ref structs were introduced in C# 7.2, and this is not the place to reiterate their usefulness, but in return they come with some severe limitations, such as not being able to implement interfaces. Ref structs can now be disposable without implementing the IDisposable interface, simply by having a Dispose method in them.”</p></blockquote><p>Indeed, as we should remember from my previous post, ref structs cannot implement interface because it would expose them to boxing possibility. But because of that we cannot make them implementing <em>IDisposable</em>, and thus we cannot use them in <em>using</em> statement:</p><div id="crayon-5e41f77f486ae763574834" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
   static void Main(string[] args)
   {
      using (var book = new Book())
      {
         Console.WriteLine("Hello World!");
      }
   }
}

ref struct Book : IDisposable
{
   public void Dispose()
   {
   }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-2">2</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-4">4</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-6">6</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-8">8</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-10">10</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-12">12</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-14">14</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486ae763574834-16">16</p><p class="crayon-num" data-line="crayon-5e41f77f486ae763574834-17">17</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f486ae763574834-1"><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-e">Program</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486ae763574834-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486ae763574834-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">book</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">Book</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486ae763574834-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-s">"Hello World!"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f486ae763574834-9"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-10"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-12"><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-t">struct</span><span class="crayon-h"></span><span class="crayon-v">Book</span><span class="crayon-h"></span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-e">IDisposable</span></p><p class="crayon-line" id="crayon-5e41f77f486ae763574834-13"><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-14"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e41f77f486ae763574834-15"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486ae763574834-16"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f486ae763574834-17"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>The above code ends with compilation eerror</p><div id="crayon-5e41f77f486c2058654708" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">Error CS8343 'Book': ref structs cannot implement interfaces</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><p class="crayon-num" data-line="crayon-5e41f77f486c2058654708-1">1</p></td><td class="crayon-code"><p class="crayon-line" id="crayon-5e41f77f486c2058654708-1"><span class="crayon-e">Error </span><span class="crayon-i">CS8343</span><span class="crayon-h"></span><span class="crayon-s">'Book'</span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-e">ref </span><span class="crayon-e">structs </span><span class="crayon-e">cannot </span><span class="crayon-e">implement </span><span class="crayon-v">interfaces</span></p></td></tr></tbody></table></div></div><p>But from now on, if we add <strong>public</strong><em>Dispose</em> method to our ref struct, it will be auto-magically consumed by the <em>using</em> statement and the whole thing compiles:</p><div id="crayon-5e41f77f486cc868738575" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
   static void Main(string[] args)
   {
      using (var book = new Book())
      {
         // ...
      }
    }
}

ref struct Book
{
   public void Dispose()
   {
   }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-2">2</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-4">4</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-6">6</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-8">8</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-10">10</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-12">12</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-14">14</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486cc868738575-16">16</p><p class="crayon-num" data-line="crayon-5e41f77f486cc868738575-17">17</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f486cc868738575-1"><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-e">Program</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486cc868738575-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486cc868738575-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">book</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">Book</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486cc868738575-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// ...</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f486cc868738575-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-10"><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-12"><span class="crayon-e">ref</span><span class="crayon-h"></span><span class="crayon-t">struct</span><span class="crayon-h"></span><span class="crayon-e">Book</span></p><p class="crayon-line" id="crayon-5e41f77f486cc868738575-13"><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-14"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e41f77f486cc868738575-15"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486cc868738575-16"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f486cc868738575-17"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Even more, due to changes in the using statement itself (described in the mentioned blog post), we can now use more concise way of using… using (so-called <em>using declarations</em>):</p><div id="crayon-5e41f77f486d6464172655" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
   static void Main(string[] args)
   {
      using var book = new Book();
      // ...
   }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f486d6464172655-1"><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-e">Program</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486d6464172655-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486d6464172655-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486d6464172655-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486d6464172655-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">using</span><span class="crayon-h"></span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">book</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">Book</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486d6464172655-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// ...</span></p><p class="crayon-line" id="crayon-5e41f77f486d6464172655-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486d6464172655-8"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><h4>But… why?</h4><p>This is a long topic but in general explicit cleanup (deterministic finalization) is preferred over implicit one (not-deterministic finalization). This is somehow intuitive. It is better to explicitly make a cleanup as soon as it is possible (by calling <em>Close</em>, <em>Dispose</em>, or <em>using</em> statement), instead of waiting for non-explicit cleanup that will occur “at some time” (by the runtime executing finalizers).</p><p>Thus, when designing type owning some resource, we would like to have some explicit cleanup possibility. In C# the choice is obvious – we have a well-known contract in the form of <em>IDisposable</em> interface and its <em>Dispose</em> method.</p><p><em>Note. Please note that in case of ref structs the cleanup choice is also limited to explicit cleanup as ref structs cannot have finalizers defined.</em></p><p>Let’s take an example of a trivial “unmanaged memory pool wrapper” presented below, for illustrative purposes. Dedicated to performance-freaks, it is a ref struct to make it as lightweight as possible (no heap utilization ever):</p><div id="crayon-5e41f77f486e0555001016" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">public unsafe ref struct UnmanagedArray&lt;T&gt; where T : unmanaged
{
   private T* data;
     public UnmanagedArray(int length)
   {
      data = // get memory from some pool
   }

   public ref T this[int index]
   {
      get { return ref data[index]; }
   }

   public void Dispose()
   {
      // return memory to the pool
   }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-2">2</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-4">4</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-6">6</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-8">8</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-10">10</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-12">12</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-14">14</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-16">16</p><p class="crayon-num" data-line="crayon-5e41f77f486e0555001016-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f486e0555001016-18">18</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f486e0555001016-1"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-m">unsafe</span><span class="crayon-h"></span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-t">struct</span><span class="crayon-h"></span><span class="crayon-v">UnmanagedArray</span><span class="crayon-o">&lt;</span><span class="crayon-v">T</span><span class="crayon-o">&gt;</span><span class="crayon-h"></span><span class="crayon-i">where</span><span class="crayon-h"></span><span class="crayon-v">T</span><span class="crayon-h"></span><span class="crayon-o">:</span><span class="crayon-h"></span><span class="crayon-e">unmanaged</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486e0555001016-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-v">T</span><span class="crayon-o">*</span><span class="crayon-h"></span><span class="crayon-v">data</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">UnmanagedArray</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-v">length</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e41f77f486e0555001016-5"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">data</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-c">// get memory from some pool</span></p><p class="crayon-line" id="crayon-5e41f77f486e0555001016-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f486e0555001016-9"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-e">T</span><span class="crayon-h"></span><span class="crayon-r">this</span><span class="crayon-sy">[</span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-e">index</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-10"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486e0555001016-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">get</span><span class="crayon-h"></span><span class="crayon-sy">{</span><span class="crayon-h"></span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-v">index</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-12"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-14"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e41f77f486e0555001016-15"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// return memory to the pool</span></p><p class="crayon-line" id="crayon-5e41f77f486e0555001016-17"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e0555001016-18"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>As it owns unmanaged resource underneath, we introduced <em>Dispose</em> method to cleanup it at the end of usage. Thus, example usage could look like:</p><div id="crayon-5e41f77f486e9945231289" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">static void Main(string[] args)
{
   var array = new UnmanagedArray&lt;int&gt;(10);
   Console.WriteLine(array[0]);
   array.Dispose();
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f486e9945231289-1"><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e9945231289-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486e9945231289-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-t">array</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-v">UnmanagedArray</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e9945231289-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-t">array</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e41f77f486e9945231289-5"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">array</span><span class="crayon-sy">.</span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486e9945231289-6"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>This is obviously cumbersome – we need to remember about calling <em>Dispose</em>. And obviously not-happy-path, like exception handling, is not properly handled here. This is why <em>using</em> statement was introduced, to make sure it will be called underneath. But as already said, till C# 8.0 it could not be used here.</p><p>But now in C# 8.0, without a problem, we can make use of all benefits from the using statement:</p><div id="crayon-5e41f77f486f3404096687" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">static void Main(string[] args)
{
   using (var array = new UnmanagedArray&lt;int&gt;(10))
   {
      Console.WriteLine(array[0]);
   }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f486f3404096687-1"><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486f3404096687-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486f3404096687-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-st">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">array</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-v">UnmanagedArray</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486f3404096687-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486f3404096687-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-v">array</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486f3404096687-6"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f486f3404096687-7"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Even more, thanks to using declarations, our code becomes more concise:</p><div id="crayon-5e41f77f486fc272915490" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">static void Main(string[] args)
{
   using var array = new UnmanagedArray&lt;int&gt;(10);
   Console.WriteLine(array[0]);
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f486fc272915490-1"><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486fc272915490-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f486fc272915490-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">using </span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-t">array</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-v">UnmanagedArray</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f486fc272915490-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-t">array</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e41f77f486fc272915490-5"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>Another two examples presented below (with a lot of code cut off for brevity) come from <a href="https://github.com/dotnet/corefx">CoreFX repository</a>.</p><p>The first example is <a href="https://github.com/dotnet/corefx/blob/a10890f4ffe0fadf090c922578ba0e606ebdd16c/src/Common/src/System/Text/ValueUtf8Converter.cs"><em>ValueUtf8Converter</em></a>ref struct that wraps around <em>byte[]</em> array from the array pool:</p><div id="crayon-5e41f77f48706163345603" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">internal ref struct ValueUtf8Converter
{
   private byte[] _arrayToReturnToPool;
   ...

   public ValueUtf8Converter(Span&lt;byte&gt; initialBuffer)
   {
      _arrayToReturnToPool = null;
   }

   public Span&lt;byte&gt; ConvertAndTerminateString(ReadOnlySpan&lt;char&gt; value)
   {
      ...
   }

   public void Dispose()
   {
      byte[] toReturn = _arrayToReturnToPool;
      if (toReturn != null)
      {
         _arrayToReturnToPool = null;
         ArrayPool&lt;byte&gt;.Shared.Return(toReturn);
      }
   }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-2">2</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-4">4</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-6">6</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-8">8</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-10">10</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-12">12</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-14">14</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-16">16</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-18">18</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-19">19</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-20">20</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-21">21</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-22">22</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-23">23</p><p class="crayon-num crayon-striped-num" data-line="crayon-5e41f77f48706163345603-24">24</p><p class="crayon-num" data-line="crayon-5e41f77f48706163345603-25">25</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f48706163345603-1"><span class="crayon-m">internal</span><span class="crayon-h"></span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-t">struct</span><span class="crayon-h"></span><span class="crayon-e">ValueUtf8Converter</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-t">byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">_arrayToReturnToPool</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-6"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-e">ValueUtf8Converter</span><span class="crayon-sy">(</span><span class="crayon-v">Span</span><span class="crayon-o">&lt;</span><span class="crayon-t">byte</span><span class="crayon-o">&gt;</span><span class="crayon-h"></span><span class="crayon-v">initialBuffer</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">_arrayToReturnToPool</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-t">null</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-9"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-11"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-v">Span</span><span class="crayon-o">&lt;</span><span class="crayon-t">byte</span><span class="crayon-o">&gt;</span><span class="crayon-h"></span><span class="crayon-e">ConvertAndTerminateString</span><span class="crayon-sy">(</span><span class="crayon-v">ReadOnlySpan</span><span class="crayon-o">&lt;</span><span class="crayon-t">char</span><span class="crayon-o">&gt;</span><span class="crayon-h"></span><span class="crayon-v">value</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-12"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-14"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-16"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-17"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">toReturn</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">_arrayToReturnToPool</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">toReturn</span><span class="crayon-h"></span><span class="crayon-o">!=</span><span class="crayon-h"></span><span class="crayon-t">null</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">_arrayToReturnToPool</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-t">null</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">ArrayPool</span><span class="crayon-o">&lt;</span><span class="crayon-t">byte</span><span class="crayon-o">&gt;</span><span class="crayon-sy">.</span><span class="crayon-v">Shared</span><span class="crayon-sy">.</span><span class="crayon-st">Return</span><span class="crayon-sy">(</span><span class="crayon-v">toReturn</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48706163345603-24"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f48706163345603-25"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><p>The second example is <a href="https://github.com/dotnet/corefx/blob/a10890f4ffe0fadf090c922578ba0e606ebdd16c/src/System.Text.RegularExpressions/src/System/Text/RegularExpressions/RegexWriter.cs"><em>RegexWriter</em></a>that wraps two <em>ValueListBuilder</em> ref structs that need to be explicitly cleaned (as they also manage arrays from the array pool):</p><div id="crayon-5e41f77f48710595120113" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">internal ref struct RegexWriter
{
   ...
   private ValueListBuilder&lt;int&gt; _emitted;
   private ValueListBuilder&lt;int&gt; _intStack;
   ...

   public void Dispose()
   {
      _emitted.Dispose();
      _intStack.Dispose();
   }
}</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41f77f48710595120113-1"><span class="crayon-m">internal</span><span class="crayon-h"></span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-t">struct</span><span class="crayon-h"></span><span class="crayon-e">RegexWriter</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48710595120113-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5e41f77f48710595120113-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48710595120113-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-v">ValueListBuilder</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-h"></span><span class="crayon-v">_emitted</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e41f77f48710595120113-5"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-v">ValueListBuilder</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-h"></span><span class="crayon-v">_intStack</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48710595120113-6"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48710595120113-8"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5e41f77f48710595120113-9"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48710595120113-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">_emitted</span><span class="crayon-sy">.</span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5e41f77f48710595120113-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">_intStack</span><span class="crayon-sy">.</span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5e41f77f48710595120113-12"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5e41f77f48710595120113-13"><span class="crayon-sy">}</span></p></div></td></tr></tbody></table></div></div><h4>In summary</h4><p>We can treat disposable ref structs as lightweight types that have A REAL destructor, known from C++. It will be executed as soon as the corresponding instance goes out of the scope of the underlying using statement (or enclosing scope in case of using declaration).</p><p>For sure it is not a feature that will suddenly become extremely popular in writing regular, business-driven code. But few layers below, when writing high-performant low-level code, it is worth to know about such possibility!</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>