<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Securing ASP.NET Core in Docker -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Securing ASP.NET Core in Docker</h1><div><div class="entry-content"><p>Some time ago, I blogged about how you can get some <a href="https://rehansaeed.com/docker-read-file-systems/">extra security when running Docker containers</a> by making their file systems read-only. This ensures that should an attacker get into the container somehow, they won’t be able to change any files. This only works with certain containers that support it however and unfortunately, at that time ASP.NET Core did not support running in a Docker container with a read-only file system. Happily, this is now fixed!</p><p>Lets see an example. I created a brand new hello world ASP.NET Core project and added this Dockerfile:</p><div id="crayon-5e41fff78de0f447532363" class="crayon-syntax crayon-theme-vs2012-black crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">FROM microsoft/dotnet:2.2-sdk AS builder
WORKDIR /source
COPY *.csproj .
RUN dotnet restore
COPY . .
RUN dotnet publish --output /app/ --configuration Release

FROM microsoft/dotnet:2.2-aspnetcore-runtime
WORKDIR /app
COPY --from=builder /app .
ENTRYPOINT ["dotnet", "ReadOnlyTest.dll"]</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5e41fff78de0f447532363-1"><span class="crayon-e">FROM </span><span class="crayon-v">microsoft</span><span class="crayon-o">/</span><span class="crayon-v">dotnet</span><span class="crayon-o">:</span><span class="crayon-cn">2.2</span><span class="crayon-o">-</span><span class="crayon-e">sdk </span><span class="crayon-st">AS</span><span class="crayon-h"></span><span class="crayon-e">builder</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-2"><span class="crayon-v">WORKDIR</span><span class="crayon-h"></span><span class="crayon-o">/</span><span class="crayon-e">source</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-3"><span class="crayon-e ">COPY *</span><span class="crayon-sy">.</span><span class="crayon-i">csproj</span><span class="crayon-h"></span><span class="crayon-sy">.</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-4"><span class="crayon-e">RUN </span><span class="crayon-e">dotnet </span><span class="crayon-e">restore</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-5"><span class="crayon-i">COPY</span><span class="crayon-h"></span><span class="crayon-sy">.</span><span class="crayon-h"></span><span class="crayon-sy">.</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-6"><span class="crayon-e">RUN </span><span class="crayon-e">dotnet </span><span class="crayon-v">publish</span><span class="crayon-h"></span><span class="crayon-o">--</span><span class="crayon-v">output</span><span class="crayon-h"></span><span class="crayon-o">/</span><span class="crayon-v">app</span><span class="crayon-o">/</span><span class="crayon-h"></span><span class="crayon-o">--</span><span class="crayon-e">configuration </span><span class="crayon-e">Release</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-8"><span class="crayon-e">FROM </span><span class="crayon-v">microsoft</span><span class="crayon-o">/</span><span class="crayon-v">dotnet</span><span class="crayon-o">:</span><span class="crayon-cn">2.2</span><span class="crayon-o">-</span><span class="crayon-v">aspnetcore</span><span class="crayon-o">-</span><span class="crayon-e">runtime</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-9"><span class="crayon-v">WORKDIR</span><span class="crayon-h"></span><span class="crayon-o">/</span><span class="crayon-e">app</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-10"><span class="crayon-v">COPY</span><span class="crayon-h"></span><span class="crayon-o">--</span><span class="crayon-v">from</span><span class="crayon-o">=</span><span class="crayon-v">builder</span><span class="crayon-h"></span><span class="crayon-o">/</span><span class="crayon-i">app</span><span class="crayon-h"></span><span class="crayon-sy">.</span></p><p class="crayon-line" id="crayon-5e41fff78de0f447532363-11"><span class="crayon-i">ENTRYPOINT</span><span class="crayon-h"></span><span class="crayon-sy">[</span><span class="crayon-s">"dotnet"</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-s">"ReadOnlyTest.dll"</span><span class="crayon-sy">]</span></p></div></td></tr></tbody></table></div></div><p>I build the Docker image using this command:</p><div id="crayon-5e41fff78de30968157949" class="crayon-syntax crayon-theme-vs2012-black crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">docker build -t read-only-test .</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><p class="crayon-num" data-line="crayon-5e41fff78de30968157949-1">1</p></td><td class="crayon-code"><p class="crayon-line" id="crayon-5e41fff78de30968157949-1"><span class="crayon-e">docker </span><span class="crayon-v">build</span><span class="crayon-h"></span><span class="crayon-o">-</span><span class="crayon-i">t</span><span class="crayon-h"></span><span class="crayon-v">read</span><span class="crayon-o">-</span><span class="crayon-v">only</span><span class="crayon-o">-</span><span class="crayon-i">test</span><span class="crayon-h"></span><span class="crayon-sy">.</span></p></td></tr></tbody></table></div></div><p>If I run this image with a read-only file system:</p><div id="crayon-5e41fff78de46007307333" class="crayon-syntax crayon-theme-vs2012-black crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">docker run --rm --read-only -it -p 8000:80 read-only-test</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><p class="crayon-num" data-line="crayon-5e41fff78de46007307333-1">1</p></td><td class="crayon-code"><p class="crayon-line" id="crayon-5e41fff78de46007307333-1"><span class="crayon-e">docker </span><span class="crayon-v">run</span><span class="crayon-h"></span><span class="crayon-o">--</span><span class="crayon-v">rm</span><span class="crayon-h"></span><span class="crayon-o">--</span><span class="crayon-v">read</span><span class="crayon-o">-</span><span class="crayon-v">only</span><span class="crayon-h"></span><span class="crayon-o">-</span><span class="crayon-v">it</span><span class="crayon-h"></span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"></span><span class="crayon-cn">8000</span><span class="crayon-o">:</span><span class="crayon-cn">80</span><span class="crayon-h"></span><span class="crayon-v">read</span><span class="crayon-o">-</span><span class="crayon-v">only</span><span class="crayon-o">-</span><span class="crayon-v">test</span></p></td></tr></tbody></table></div></div><p>This outputs the following error as read-only file systems are not supported by default:</p><blockquote class="wp-block-quote"><p>Failed to initialize CoreCLR, HRESULT: 0x80004005</p></blockquote><p>If I now run the same image with the COMPlus_EnableDiagnostics environment variable turned off:</p><div id="crayon-5e41fff78de5c894588073" class="crayon-syntax crayon-theme-vs2012-black crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><p class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">docker run --rm --read-only -it -p 8000:80 -e COMPlus_EnableDiagnostics=0 read-only-test</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><p class="crayon-num" data-line="crayon-5e41fff78de5c894588073-1">1</p></td><td class="crayon-code"><p class="crayon-line" id="crayon-5e41fff78de5c894588073-1"><span class="crayon-e">docker </span><span class="crayon-v">run</span><span class="crayon-h"></span><span class="crayon-o">--</span><span class="crayon-v">rm</span><span class="crayon-h"></span><span class="crayon-o">--</span><span class="crayon-v">read</span><span class="crayon-o">-</span><span class="crayon-v">only</span><span class="crayon-h"></span><span class="crayon-o">-</span><span class="crayon-v">it</span><span class="crayon-h"></span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"></span><span class="crayon-cn">8000</span><span class="crayon-o">:</span><span class="crayon-cn">80</span><span class="crayon-h"></span><span class="crayon-o">-</span><span class="crayon-i">e</span><span class="crayon-h"></span><span class="crayon-v">COMPlus_EnableDiagnostics</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h"></span><span class="crayon-v">read</span><span class="crayon-o">-</span><span class="crayon-v">only</span><span class="crayon-o">-</span><span class="crayon-v">test</span></p></td></tr></tbody></table></div></div><p>The app now starts! The COMPlus_EnableDiagnostics environment variable (which is <a href="https://github.com/dotnet/docs/issues/10217">undocumented</a>) turns off debugging and profiling support, so I would not bake this environment variable into the Dockerfile. For some reason these features need a read/write file system to work properly. If you’d like to try this yourself, you can checkout all the code in <a href="https://github.com/RehanSaeed/ReadOnlyDockerTest">this repo</a>.</p><h3 class="jp-relatedposts-headline"><em>Related</em></h3></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>