<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using Dapper in ASP.NET Core applications - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Using Dapper in ASP.NET Core applications - linksfor.dev(s)"/>
    <meta property="article:author" content="Gunnar Peipman"/>
    <meta property="og:description" content="Using Dapper in ASP.NET Core applications by creating querying and repository classes. Discussion about complexities and solutions."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://gunnarpeipman.com/aspnet-core-dapper/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
				<a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Using Dapper in ASP.NET Core applications</title>
<div class="readable">
        <h1>Using Dapper in ASP.NET Core applications</h1>
            <div>by Gunnar Peipman</div>
            <div>Reading time: 12-15 minutes</div>
        <div>Posted here: 15 May 2020</div>
        <p><a href="https://gunnarpeipman.com/aspnet-core-dapper/">https://gunnarpeipman.com/aspnet-core-dapper/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><p>Times ago I blogged about micro ORM-s. I have been busy through all Covid-19 times learning technical side of DDD and during that I met again my old friend Dapper. There are applications where Dapper is used to query read-only data without overhead coming with ORM-s. Also there are simple applications where for one or another reason developers decided to keep as close to raw SQL as possible. This blog post is brief introduction to Dapper anbd how to use it in ASP.NET Core applications.</p><h3>What is Micro-ORM?</h3><p><a title="What is Micro ORM?" href="https://gunnarpeipman.com/micro-orm/">Micro-ORMs</a> are lightweight object-relational mappers (ORM). They have thin communication interface that makes it easy to query objects from database and – in some cases – to get them easily back to database too. Micro-ORMs doesn’t generate SQL based on object queries like full-blown ORM-s do. Also they usually don’t have change tracking and any other advanced features. As SQL is not generated for us we have to write it manually.</p><p>Manually written SQL and lack of powerful features of full-blown ORM-s means one thing – querying of database is easy task to do but updating of object graphs can be challenging.</p><h3>Introducing Dapper</h3><p><a title="Dapper @ GitHub" href="https://github.com/StackExchange/Dapper">Dapper</a> is perhaps most popular micro-ORM. It is worked out by Stack Exchange and one of the most popular sites it is running is Stack Overflow. Yeah, the same Stack Overflow we all know and from where tons code come to our systems thaks to Copy-Paste Driven Development.</p><p>I like Dapper because it is simple and damn easy to use and understand. It is implemented as set of extension methods to ADO.NET database connection and it sets itself on our way minimally. There are no interfaces to implement, no instances to create and take care of – only simple extension methods to use on objects we have to create anyway.</p><p>Here’s the example of list method for invoices.</p><pre><span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>IEnumerable</span>&lt;<span>Invoice</span>&gt;&gt; <span>ListInvoices</span>(<span>int</span>&nbsp;<span>page</span>, <span>int</span>&nbsp;<span>pageSize</span>)<br>{<br>&nbsp;&nbsp;&nbsp; <span>using</span> (<span>var</span>&nbsp;<span>connection</span> = _provider.<span>GetDbConnection</span>())<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>parameters</span> = <span>new</span> { Skip = (<span>page</span> - 1)*<span>pageSize</span>, Take = <span>pageSize</span> };<p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>query</span> = <span>"select * from Invoices order by CURRENT_TIMESTAMP "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"OFFSET @Skip ROWS "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"FETCH NEXT @Take ROWS ONLY"</span>;</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>await</span>&nbsp;<span>connection</span>.<span>QueryAsync</span>&lt;<span>Invoice</span>&gt;(<span>query</span>, <span>parameters</span>);<br>&nbsp;&nbsp;&nbsp; }<br>}</p></pre><p>QueryAsync() method is extension method by Dapper. It takes query and parameters object to build command, execute it and return objects of given type. There are also other methods for returning single object or results from multiple queries that were sent to server with one batch.</p><h3>Querying database using Dapper</h3><p>I wrote simple CRUD application on ASP.NET Core to demonstrate how to use Dapper. To keep code clean and SQL in one place I went with query classes similar to ones I demonstrated in my blog post <a title="Implementing repository querying interface in EF Core DbContext" href="https://gunnarpeipman.com/ef-core-dbcontext-repository/">Implementing repository querying interface in EF Core DbContextImplementing repository querying interface in EF Core DbContext</a>.</p><p>Let’s take a look at class for querying invoices. Notice GetInvoiceById() method that loads invoice rows from database only if user wants it to do so.</p><pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>SqlServerInvoiceQueries</span> : <span>IInvoiceQueries</span><br>{<br>&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>SqlServerConnectionProvider</span> _provider;<p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>SqlServerInvoiceQueries</span>(<span>SqlServerConnectionProvider</span>&nbsp;<span>provider</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _provider = <span>provider</span>;<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>Invoice</span>&gt; <span>GetInvoiceById</span>(<span>int</span>&nbsp;<span>id</span>, <span>bool</span>&nbsp;<span>includeRows</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>using</span>(<span>var</span>&nbsp;<span>connection</span> = _provider.<span>GetDbConnection</span>())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>invoice</span> = <span>await</span>&nbsp;<span>connection</span>.<span>QueryFirstAsync</span>&lt;<span>Invoice</span>&gt;(<span>"select * from invoices where id="</span> + <span>id</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span>(<span>invoice</span> == <span>null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span>(<span>includeRows</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>query</span> = <span>"select * from InvoiceLines where InvoiceId="</span> + <span>id</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>invoice</span>.InvoiceLines = (<span>await</span>&nbsp;<span>connection</span>.<span>QueryAsync</span>&lt;<span>InvoiceLine</span>&gt;(<span>query</span>)).<span>ToList</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>invoice</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>IEnumerable</span>&lt;<span>Invoice</span>&gt;&gt; <span>ListInvoices</span>(<span>int</span>&nbsp;<span>page</span>, <span>int</span>&nbsp;<span>pageSize</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>using</span> (<span>var</span>&nbsp;<span>connection</span> = _provider.<span>GetDbConnection</span>())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>parameters</span> = <span>new</span> { Skip = (<span>page</span> - 1)*<span>pageSize</span>, Take = <span>pageSize</span> };</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>query</span> = <span>"select * from Invoices order by CURRENT_TIMESTAMP "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"OFFSET @Skip ROWS "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"FETCH NEXT @Take ROWS ONLY"</span>;</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>await</span>&nbsp;<span>connection</span>.<span>QueryAsync</span>&lt;<span>Invoice</span>&gt;(<span>query</span>, <span>parameters</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</p></pre><p>Queries classed need database connection provider – custom class to provide correct connection to query classes. For ASP.NET Core applications I register connection provider and query classes with framework-level dependency injection. Here is my MSSQL connection provider.</p><pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>SqlServerConnectionProvider</span><br>{<br>&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span> _connectionString;<p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>SqlServerConnectionProvider</span>(<span>string</span>&nbsp;<span>connectionString</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _connectionString = <span>connectionString</span>;<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>IDbConnection</span>&nbsp;<span>GetDbConnection</span>()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>new</span>&nbsp;<span>SqlConnection</span>(_connectionString);<br>&nbsp;&nbsp;&nbsp; }<br>}</p></pre><p>Queries are plain SQL with parameters. Dapper takes away some pain on building parameters and adding these to commands. If our queries grow long, ugly and complex then we can move them to separate files or resource strings to keep query classes clean.</p><p>We can inject these query classes to ASP.NET Core controllers and call their methods to get data.</p><pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>HomeController</span> : <span>Controller</span><br>{<br>&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>IInvoiceQueries</span> _invoiceQueries;<p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>HomeController</span>(<span>IInvoiceQueries</span>&nbsp;<span>invoiceQueries</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _invoiceQueries = <span>invoiceQueries</span>;<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>IActionResult</span>&gt; <span>Index</span>(<span>int</span>&nbsp;<span>page</span> = 1)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>page</span> = <span>Math</span>.<span>Max</span>(1, <span>page</span>);</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>invoices</span> = <span>await</span> _invoiceQueries.<span>ListInvoices</span>(<span>page</span>, 10);</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>View</span>(<span>invoices</span>);<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; <span>// More actions follow</span><br>}</p></pre><p>For very primitive applications I don’t usually even bother to go with query classes. I need to get some simple objects from simple database tables and save them back. Be careful, of course, and don’t use this approach if there’s chance that application will grow. Example of this minimalistic approach can be found from my GitHub repository <a title="gpeipman/DapperDemo @ GitHub" href="https://github.com/gpeipman/DapperDemo">gpeipman/DapperDemo</a>.</p><h3>Modifying data using Dapper</h3><p>When we want to modify data then things get complex pretty fast. Things are easy until we work with primitive entities. But dealing with object graphs is different story.</p><p>Let’s take sample entities from one of my demos.</p><pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>Invoice</span><br>{<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>int</span> Id { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>DateTime</span> Date { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>DateTime</span> DueDate { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>string</span> Customer { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>string</span> InvoiceNo { <span>get</span>; <span>set</span>; }<p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>IList</span>&lt;<span>InvoiceLine</span>&gt; InvoiceLines { <span>get</span>; <span>set</span>; }</p><p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>Invoice</span>()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InvoiceLines = <span>new</span>&nbsp;<span>List</span>&lt;<span>InvoiceLine</span>&gt;();<br>&nbsp;&nbsp;&nbsp; }<br>}</p><p> <span>public</span>&nbsp;<span>class</span>&nbsp;<span>InvoiceLine</span><br>{<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>int</span> Id { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>string</span> LineItem { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>decimal</span> Amount { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>string</span> Unit { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>decimal</span> UnitPrice { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>int</span> VatPercent { <span>get</span>; <span>set</span>; }<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>decimal</span> Total { <span>get</span> { <span>return</span> Amount * UnitPrice * (1 + 20 / 100); } <span>set</span> { } }<br>}</p></pre><p>Suppose we have a form where we can create or modify invoice and lines it has. It’s all done dynamically in browser and when user clicks save button then invoice with rows is sent back to server.</p><p>Here are ASP.NET Core controller actions to update invoice.</p><pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>HomeController</span> : <span>Controller</span><br>{<br>&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>IInvoiceQueries</span> _invoiceQueries;<br>&nbsp;&nbsp;&nbsp; <span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>IInvoiceRepository</span> _invoiceRepository;<p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>HomeController</span>(<span>IInvoiceQueries</span>&nbsp;<span>invoiceQueries</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>IInvoiceRepository</span>&nbsp;<span>invoiceRepository</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _invoiceQueries = <span>invoiceQueries</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _invoiceRepository = <span>invoiceRepository</span>;<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>void</span>&nbsp;<span>Index</span>() { }</p><p> &nbsp;&nbsp;&nbsp; <span>// Some actions here</span></p><p> &nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>IActionResult</span>&gt; <span>Edit</span>(<span>int</span>&nbsp;<span>id</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>invoice</span> = <span>await</span> _invoiceQueries.<span>GetInvoiceById</span>(<span>id</span>, <span>true</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span> (<span>invoice</span> == <span>null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>NotFound</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>View</span>(<span>invoice</span>);<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; [<span>HttpPost</span>]<br>&nbsp;&nbsp;&nbsp; <span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>IActionResult</span>&gt; <span>Edit</span>(<span>Invoice</span>&nbsp;<span>invoice</span>)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span>(!ModelState.IsValid)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>View</span>(<span>nameof</span>(<span>this</span>.<span>Edit</span>), <span>invoice</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>await</span> _invoiceRepository.<span>Save</span>(<span>invoice</span>);</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>return</span>&nbsp;<span>RedirectToAction</span>(<span>nameof</span>(<span>this</span>.<span>Index</span>));<br>&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp; <span>// More actions follow</span><br>}</p></pre><p>As insert and delete parts are actually simple ones I leave them out. But update is not so easy when written manually without using full-blown ORM. It consists of four steps that are run in database transaction:</p><ol><li>Update invoice in database</li><li>Update existing invoice lines in database</li><li>Insert new invoice lines</li><li>Delete removed invoice lines</li></ol><p>Just to show how it looks in code here is the example of Update() method of my sample invoice repository.</p><pre><span>private</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&nbsp;<span>Update</span>(<span>Invoice</span>&nbsp;<span>invoice</span>)<br>{<br>&nbsp;&nbsp;&nbsp; <span>using</span> (<span>var</span>&nbsp;<span>connection</span> = <span>await</span>&nbsp;<span>GetOpenConnection</span>())<br>&nbsp;&nbsp;&nbsp; <span>using</span> (<span>var</span>&nbsp;<span>transaction</span> = <span>connection</span>.<span>BeginTransaction</span>())<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>try</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>query</span> = <span>"UPDATE Invoices SET Date=@Date, DueDate=@DueDate "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"WHERE Id=@Id"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>await</span>&nbsp;<span>connection</span>.<span>ExecuteAsync</span>(<span>query</span>, <span>invoice</span>, <span>transaction</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>lineIds</span> = <span>new</span>&nbsp;<span>List</span>&lt;<span>int</span>&gt;();<p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>lineIds</span>.<span>AddRange</span>(<span>invoice</span>.InvoiceLines.<span>Where</span>(<span>l</span> =&gt; <span>l</span>.Id != 0).<span>Select</span>(<span>l</span> =&gt; <span>l</span>.Id));</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>foreach</span> (<span>var</span>&nbsp;<span>line</span>&nbsp;<span>in</span>&nbsp;<span>invoice</span>.InvoiceLines)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span> (<span>line</span>.Id == 0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> = <span>"INSERT INTO InvoiceLines (LineItem, Amount, Unit, UnitPrice, VatPercent, InvoiceId)"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"VALUES (@LineItem, @Amount, @Unit, @UnitPrice, @VatPercent,"</span> + <span>invoice</span>.Id + <span>"); "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"SELECT CAST(SCOPE_IDENTITY() AS INT)"</span>;</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>var</span>&nbsp;<span>id</span> = <span>await</span>&nbsp;<span>connection</span>.<span>QueryFirstAsync</span>&lt;<span>int</span>&gt;(<span>query</span>, <span>line</span>, <span>transaction</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>lineIds</span>.<span>Add</span>(<span>id</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> = <span>"UPDATE InvoiceLines SET LineItem=@LineItem,Amount=@Amount,Unit=@Unit,"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"UnitPrice=@UnitPrice,VatPercent=@VatPercent "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"WHERE Id=@Id"</span>;</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>await</span>&nbsp;<span>connection</span>.<span>ExecuteAsync</span>(<span>query</span>, <span>line</span>, <span>transaction</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>if</span> (<span>lineIds</span>.Count &gt; 0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> = <span>"DELETE FROM InvoiceLines WHERE InvoiceId="</span> + <span>invoice</span>.Id + <span>" AND "</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>query</span> += <span>"Id NOT IN("</span> + <span>string</span>.<span>Join</span>(<span>','</span>, <span>lineIds</span>) + <span>")"</span>;</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>await</span>&nbsp;<span>connection</span>.<span>ExecuteAsync</span>(<span>query</span>, <span>transaction</span>: <span>transaction</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>transaction</span>.<span>Commit</span>();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>catch</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>transaction</span>.<span>Rollback</span>();</p><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>throw</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</p></pre><p>I’m sure we don’t want to write code like this and this is why I don’t consider Dapper or any other micro-ORM as a best choice for modifying data.</p><h3>Taking best from the both worlds – CQRS</h3><p>Command Query Responsibility Segregation (CQRS) is pattern first introduced by Greg Young. It’s about separating operations that query data from those that modify system state. On queries side we have data querying – it’s read-only and we are using Dapper. On commands side we modify system state and there we can use EF Core, NHibernate and other full-blown ORM-s.</p><p><picture><source data-srcset="https://static.gunnarpeipman.com/wp-content/uploads/2020/05/martin-fowler-cqrs.png.webp" type="image/webp"><img width="637" height="464" title="martin-fowler-cqrs" alt="martin-fowler-cqrs" src="https://static.gunnarpeipman.com/wp-content/uploads/2020/05/martin-fowler-cqrs.png" data-src="https://static.gunnarpeipman.com/wp-content/uploads/2020/05/martin-fowler-cqrs.png"></picture><br><em>CQRS illustrated. Image is taken from <a title="CQRS by Martin Fowler" href="https://martinfowler.com/bliki/CQRS.html">CQRS</a> page by Martin Fowler.</em></p><p>CQRS is not must-be. It’s like any other pattern – think before you use it. It doesn’t solve all your problems and it’s not a silver bullet. In his <a title="CQRS by Martin Fowler" href="https://martinfowler.com/bliki/CQRS.html">CQRS article</a> Martin Fowler warns: “For some situations, this separation can be valuable, but beware that for most systems CQRS adds risky complexity.”</p><h3>Wrapping up</h3><p>Using Dapper we can write SQL to execute directly against the database server we are using. It is easy to use and there are just some methods we need to call to get objects out from database. As we saw from examples then querying for data is easy and straightforward but modifying data can be very challenging when it comes to object graphs. Because of this we may want to go with CQRS pattern to have separate interfaces and models for querying and modifying data. CQRS is not a silver bullet and we have to think if we want to apply it in our system or not. For applications with simple object graphs we can go with Dapper based repositories without making things too complex.</p></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>