<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How to write a Roslyn Analyzer | .NET Blog - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="How to write a Roslyn Analyzer | .NET Blog - linksfor.dev(s)"/>
    <meta property="article:author" content="Mika DumontFollow Mika"/>
    <meta property="og:description" content="Roslyn analyzers inspect your code for style, quality, maintainability, design and other issues. Because they are powered by the .NET Compiler Platform, they can produce warnings in your code as you type even before you&#x2019;ve finished the line. In other words,"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://devblogs.microsoft.com/dotnet/how-to-write-a-roslyn-analyzer/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - How to write a Roslyn Analyzer | .NET Blog</title>
<div class="readable">
        <h1>How to write a Roslyn Analyzer | .NET Blog</h1>
            <div>by Mika DumontFollow Mika</div>
            <div>Reading time: 6-8 minutes</div>
        <div>Posted here: 04 Mar 2020</div>
        <p><a href="https://devblogs.microsoft.com/dotnet/how-to-write-a-roslyn-analyzer/">https://devblogs.microsoft.com/dotnet/how-to-write-a-roslyn-analyzer/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="featured"><div><div><div><div><p><img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2019/07/Mika-Headshot-150x150.jpg" width="58" height="58" alt="Mika Dumont"></p><p>Mika</p></div></div></div><p>March 4th, 2020</p><p>Roslyn analyzers inspect your code for style, quality, maintainability, design and other issues. Because they are powered by the .NET Compiler Platform, they can produce warnings in your code as you type even before you’ve finished the line. In other words, you don’t have to build your code to find out that you made a mistake. Analyzers can also surface an automatic code fix through the Visual Studio light bulb prompt that allows you to clean up your code immediately. With live, project-based code analyzers in Visual Studio, API authors can ship domain-specific code analysis as part of their NuGet packages.</p><p>You don’t have to be a professional API author to write an analyzer. In this post, I’ll show you how to write your very first analyzer.</p><p><strong>Getting started</strong></p><p>In order to create a Roslyn Analyzer project, you need to install the .NET Compiler Platform SDK via the Visual Studio Installer. There are two different ways to find the .NET Compiler Platform SDK in the Visual Studio Installer:</p><p>Install using the Visual Studio Installer – Workloads view:</p><ol><li>Run the Visual Studio Installer and select Modify.<p> <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-installer.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-installer.png" alt="Visual Studio Installer" width="1182" height="422" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-installer.png 1182w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-installer-300x107.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-installer-1024x366.png 1024w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-installer-768x274.png 768w" sizes="(max-width: 1182px) 100vw, 1182px"> </a></p></li><li>Check the Visual Studio extension development workload.<p> <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-extension-development.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-extension-development.png" alt="Visual Studio Extension Development Workload" width="1182" height="422"> </a></p></li></ol><p>Install using the Visual Studio Installer – Individual components tab:</p><ol><li>Run the Visual Studio Installer and select Modify.</li><li>Select the Individual components tab.</li><li>Check the box for .NET Compiler Platform SDK.<p> <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-individual-components.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-individual-components.png" alt="Visual Studio Individual Components" width="1713" height="490" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-individual-components.png 1713w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-individual-components-300x86.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-individual-components-1024x293.png 1024w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-individual-components-768x220.png 768w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/visual-studio-individual-components-1536x439.png 1536w" sizes="(max-width: 1713px) 100vw, 1713px"> </a></p></li></ol><p><strong>Writing an analyzer</strong></p><p>Let’s begin by creating a syntax tree analyzer. This analyzer generates a syntax warning for any statement that is not enclosed in a block that has curly braces <code>{</code> and <code>}</code>. For example, the following code generates a warning for both the <code>if</code>-statement and the <code>System.Console.WriteLine</code> invocation statement, but the <code>while</code> statement is not flagged:</p><p><br><a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic.png" alt="Brace Analyzer Diagnostic" width="938" height="427" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic.png 938w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-300x137.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-768x350.png 768w" sizes="(max-width: 938px) 100vw, 938px"> </a></p><ol><li>Open Visual Studio.</li><li>On the Create a new project dialog search VSIX and select <strong>Analyzer with Code Fix (.NET Standard)</strong> in C# and click Next.<p> <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/create-new-project-dialog.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/create-new-project-dialog.png" alt="Create New Project Dialog" width="1429" height="954" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/create-new-project-dialog.png 1429w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/create-new-project-dialog-300x200.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/create-new-project-dialog-1024x684.png 1024w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/create-new-project-dialog-768x513.png 768w" sizes="(max-width: 1429px) 100vw, 1429px"> </a></p></li><li>Name your project <strong>BraceAnalyzer</strong> and click OK. The solution should contain 3 projects: BraceAnalyzer, BraceAnalyzer.Test, BraceAnalyzer.Vsix.<p>  <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/analyzer-solution-layout.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/analyzer-solution-layout.png" alt="Analyzer Solution Layout" width="624" height="315" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/analyzer-solution-layout.png 624w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/analyzer-solution-layout-300x151.png 300w" sizes="(max-width: 624px) 100vw, 624px"> </a></p><ul><li>BraceAnalyzer: This is the core analyzer project that contains the default analyzer implementation that reports a diagnostic for all type names that contain any lowercase letter.</li><li>BraceAnalyzer.Test: This is a unit test project that lets you make sure your analyzer is producing the right diagnostics and fixes.</li><li>BraceAnalyzer. Vsix: The VSIX project bundles the analyzer into an extension package (.vsix file). This is the startup project in the solution.</li></ul></li><li>In the Solution Explorer, open <strong>Resources.resx</strong> in the BraceAnalyzer project. This displays the resource editor.</li><li>Replace the existing resource string values for AnalyzerDescription, AnalyzerMessageFormat, and AnalyzerTitle with the following strings:<ul><li>Change AnalyzerDescription to <code>Enclose statement with curly braces</code>.</li><li>Change AnalyzerMessageFormat to <code>`{` brace expected</code>.</li><li>Change AnalyzerTitle to <code>Enclose statement with curly braces</code>.</li></ul><p> <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/resources-resx.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/resources-resx.png" alt="Resources Resx" width="1428" height="330" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/resources-resx.png 1428w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/resources-resx-300x69.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/resources-resx-1024x237.png 1024w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/resources-resx-768x177.png 768w" sizes="(max-width: 1428px) 100vw, 1428px"> </a></p></li><li>Within the BraceAnalyzerAnalyzer.cs file, replace the Initialize method implementation with the following code:</li><pre><span>public</span><span> </span><span>override</span><span> </span><span>void</span><span> </span><span>Initialize</span><span>(</span><span>AnalysisContext</span><span> context</span><span>)</span><span>
</span><span>{</span><span>
    context</span><span>.</span><span>RegisterSyntaxTreeAction</span><span>(</span><span>syntaxTreeContext </span><span>=&gt;</span><span>
    </span><span>{</span><span>
        </span><span>// Iterate through all statements in the tree</span><span>
        </span><span>var</span><span> root </span><span>=</span><span> syntaxTreeContext</span><span>.</span><span>Tree</span><span>.</span><span>GetRoot</span><span>(</span><span>syntaxTreeContext</span><span>.</span><span>CancellationToken</span><span>);</span><span>
        </span><span>foreach</span><span> </span><span>(</span><span>var</span><span> statement </span><span>in</span><span> root</span><span>.</span><span>DescendantNodes</span><span>().</span><span>OfType</span><span>&lt;</span><span>StatementSyntax</span><span>&gt;())</span><span>
        </span><span>{</span><span>
            </span><span>// Skip analyzing block statements </span><span>
            </span><span>if</span><span> </span><span>(</span><span>statement </span><span>is</span><span> </span><span>BlockSyntax</span><span>)</span><span>
            </span><span>{</span><span>
                </span><span>continue</span><span>;</span><span>
            </span><span>}</span><span>

            </span><span>// Report issues for all statements that are nested within a statement</span><span>
            </span><span>// but not a block statement</span><span>
            </span><span>if</span><span> </span><span>(</span><span>statement</span><span>.</span><span>Parent</span><span> </span><span>is</span><span> </span><span>StatementSyntax</span><span> </span><span>&amp;&amp;</span><span> </span><span>!(</span><span>statement</span><span>.</span><span>Parent</span><span> </span><span>is</span><span> </span><span>BlockSyntax</span><span>))</span><span>
            </span><span>{</span><span>
                </span><span>var</span><span> diagnostic </span><span>=</span><span> </span><span>Diagnostic</span><span>.</span><span>Create</span><span>(</span><span>Rule</span><span>,</span><span> statement</span><span>.</span><span>GetFirstToken</span><span>().</span><span>GetLocation</span><span>());</span><span>
                syntaxTreeContext</span><span>.</span><span>ReportDiagnostic</span><span>(</span><span>diagnostic</span><span>);</span><span>
            </span><span>}</span><span>
        </span><span>}</span><span>
    </span><span>});</span><span>
</span><span>}</span></pre><li>Check your progress by pressing F5 to run your analyzer. Make sure that the BraceAnalyzer.Vsix project is the startup project before pressing F5. Running the VSIX project loads an experimental instance of Visual Studio, which lets Visual Studio keep track of a separate set of Visual Studio extensions.</li><li>In the Visual Studio instance, create a new C# class library with the following code to verify that the analyzer diagnostic is neither reported for the method block nor the <code>while</code> statement, but is reported for the <code>if</code> statement and <code>System.Console.WriteLine</code> invocation statement:<p>  <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic.png" alt="Brace Analyzer Diagnostic" width="938" height="427" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic.png 938w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-300x137.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-768x350.png 768w" sizes="(max-width: 938px) 100vw, 938px"> </a></p></li><li>Now, add curly braces around the <code>System.Console.WriteLine</code> invocation statement and verify that the only single warning is now reported for the <code>if</code> statement:<p>  <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-for-if-statement.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-for-if-statement.png" alt="Brace Diagnostic For If Statement" width="873" height="410" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-for-if-statement.png 873w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-for-if-statement-300x141.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/brace-diagnostic-for-if-statement-768x361.png 768w" sizes="(max-width: 873px) 100vw, 873px"> </a></p></li></ol><p><strong>Writing a code fix</strong></p><p>An analyzer can provide one or more code fixes. A code fix defines an edit that addresses the reported issue. For the analyzer that you created, you can provide a code fix that encloses a statement with a curly brace.</p><ol><li>Open the BraceAnalyzerCodeFixProvider.cs file. This code fix is already wired up to the Diagnostic ID produced by your diagnostic analyzer, but it doesn’t yet implement the right code transform.</li><li>Change the title string to “Add brace”:</li><pre><span>private</span><span> </span><span>const</span><span> </span><span>string</span><span> title </span><span>=</span><span> </span><span>"Add brace"</span><span>;</span></pre><li>Change the following line to register a code fix. Your fix will create a new document that results from adding braces.</li><pre><span>context</span><span>.</span><span>RegisterCodeFix</span><span>(</span><span>
        </span><span>CodeAction</span><span>.</span><span>Create</span><span>(</span><span>
            title</span><span>:</span><span> title</span><span>,</span><span>
            createChangedDocument</span><span>:</span><span> c </span><span>=&gt;</span><span> </span><span>AddBracesAsync</span><span>(</span><span>context</span><span>.</span><span>Document</span><span>,</span><span> diagnostic</span><span>,</span><span> root</span><span>),</span><span>
            equivalenceKey</span><span>:</span><span> title</span><span>),</span><span>
        diagnostic</span><span>);</span></pre><li>You’ll notice red squiggles in the code you just added on the <code>AddBracesAsync</code> symbol. Add a declaration for <code>AddBracesAsync</code> by replacing the <code>MakeUpperCaseAsync</code> method with the following code:</li><pre><span>Task</span><span>&lt;</span><span>Document</span><span>&gt;</span><document><span> </span><span>AddBracesAsync</span><span>(</span><span>Document</span><span> document</span><span>,</span><span> </span><span>Diagnostic</span><span> diagnostic</span><span>,</span><span> </span><span>SyntaxNode</span><span> root</span><span>)</span><span>
        </span><span>{</span><span>
            </span><span>var</span><span> statement </span><span>=</span><span> root</span><span>.</span><span>FindNode</span><span>(</span><span>diagnostic</span><span>.</span><span>Location</span><span>.</span><span>SourceSpan</span><span>).</span><span>FirstAncestorOrSelf</span><span>&lt;</span><span>StatementSyntax</span><span>&gt;();</span><span>
            </span><span>var</span><span> newRoot </span><span>=</span><span> root</span><span>.</span><span>ReplaceNode</span><span>(</span><span>statement</span><span>,</span><span> </span><span>SyntaxFactory</span><span>.</span><span>Block</span><span>(</span><span>statement</span><span>));</span><span>
            </span><span>return</span><span> </span><span>Task</span><span>.</span><span>FromResult</span><span>(</span><span>document</span><span>.</span><span>WithSyntaxRoot</span><span>(</span><span>newRoot</span><span>));</span><span>
        </span><span>}</span></document></pre><li>Press F5 to run the analyzer project in a second instance of Visual Studio. Place your cursor on the diagnostic and press (<strong>Ctrl+.</strong>) to trigger the <strong>Quick Actions and Refactorings</strong> menu. Notice your code fix to add a brace!<p>  <a href="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2020/03/brace-analyzer-code-fix2.png" data-featherlight="image"> <img src="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2020/03/brace-analyzer-code-fix2.png" alt="Image brace analyzer code fix2" width="1267" height="792" srcset="https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2020/03/brace-analyzer-code-fix2.png 1267w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2020/03/brace-analyzer-code-fix2-300x188.png 300w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2020/03/brace-analyzer-code-fix2-1024x640.png 1024w, https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2020/03/brace-analyzer-code-fix2-768x480.png 768w" sizes="(max-width: 1267px) 100vw, 1267px"> </a></p></li></ol><p><strong>Conclusion</strong></p><p>Congratulations! You’ve created your first Roslyn analyzer that performs on-the-fly code analysis to detect an issue and provides a code fix to correct it. Now that you’re familiar with the <a href="https://docs.microsoft.com/dotnet/csharp/roslyn-sdk/" target="_blank">.NET Compiler Platform SDK</a> (Roslyn APIs), writing your next analyzer will be a breeze.</p></div></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>