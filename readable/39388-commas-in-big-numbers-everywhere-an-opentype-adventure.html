<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Commas in big numbers everywhere: An OpenType adventure -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Commas in big numbers everywhere: An OpenType adventure</h1>
    <div class="post-content"> <p>My job involves a lot of staring at large numbers, mostly latencies in
nanoseconds, and picking out magnitudes like microseconds. I noticed
myself constantly counting digits in my text editor, in my terminal,
and in <a href="https://jupyter.org/">Jupyter</a> notebooks in my browser.</p> <p>I could have made specific solutions for each, but I thought &#x201C;How
could I solve this in the most general way possible?&#x201D; and an idea came
to me: <strong>I could make a font that uses fancy font shaping features to
insert commas in <em>all</em> numbers</strong>, everywhere.</p> <p>It was a fun idea, so I decided to play with it on my own time. After
an evening reading documentation and a Sunday spent tinkering, I had it
working! I&#x2019;ve been using the resulting font at work for a few weeks now
and it&#x2019;s been a really pleasant improvement.</p> <p>In this post I&#x2019;ll describe the basics of OpenType shaping, how I used
it to make a font that emphasizes digit grouping, and how I extended it
with even fancier variations.</p> <p>I call it &#x201C;Numderline.&#x201D; Below you can see a preview of the main
variant. For more samples or to download the font, see
<a href="https://thume.ca/numderline/">here</a>, or read on.</p> <p><a href="/commas-in-big-numbers-everywhere/numderline_preview.png"><img src="/commas-in-big-numbers-everywhere/numderline_preview.png" alt="Preview of the numderline font"></a></p> <div> The flagship underlining variant of the Numderline font. Notice how digits are grouped visually.
</div> <h2 id="learning-how-font-shaping-works">Learning how font shaping works</h2> <p>I knew that font shaping was
<a href="https://aftertheflood.com/projects/sparks/">extremely</a>
<a href="https://litherum.blogspot.com/2019/03/addition-font.html">powerful</a>
and driven by &#x201C;tables&#x201D; inside fonts, but I had no idea what the tables
were like and how the process of shaping worked. So I found <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/">the
OpenType
specification</a>
and learned that the word &#x201C;table&#x201D; is used in a very loose sense just to
refer to some defined binary data structure.</p> <p>Font shaping is the process of mapping a string of unicode text (using
the &#x201C;cmap&#x201D; table) to a sequence of &#x201C;glyphs.&#x201D; Those glyphs have various
substitutions applied to them, for example turning the sequence &#x201C;&#xB9F;,&#xBC1;&#x201D;
into the &#x201C;&#xB9F;&#xBC1;&#x201D; glyph, the substitutions coming from a multi-level
hierarchy in the &#x201C;GSUB&#x201D; table. Then, the positions of the glyphs are
adjusted using information in the &#x201C;GPOS&#x201D; table, for example to place
accent glyphs in the correct location. The final result of font shaping
is a sequence of positioned glyph IDs, which is rendered on your screen
using the information in the &#x201C;glyf&#x201D; table on the shape of each glyph
(usually caching a rendered version of each glyph in an &#x201C;atlas&#x201D; for
efficiency).</p> <p>GSUB seemed like the table I wanted, but as I read through its various
substitution types, I became worried my plan wouldn&#x2019;t work. They all
seemed to work forward through the text, whereas I needed to count
digits backwards from the end of a number! Luckily at the very end
of the list I found the feature I needed, intended for shaping Arabic
calligraphy: &#x201C;<a href="https://docs.microsoft.com/en-us/typography/opentype/spec/gsub#lookuptype-8-reverse-chaining-contextual-single-substitution-subtable">Reverse Chaining Contextual Single
Substitution</a>.&#x201D;</p> <p>Substitution rules work a bit like a limited form of regular
expressions. You provide &#x201C;classes&#x201D; of glyphs, which are basically just
lists of glyph IDs. Reverse chaining substitution matches zero or more
backtracking classes: a single class for the glyph to be replaced,
then zero or more lookahead classes. If it matches, it substitutes
using a mapping table, which provides a replacement glyph for every
glyph in the matching class. If multiple reverse chaining
substitutions are provided, they can all chain with each other.</p> <p>At first I thought I might need to build these binary tables by hand,
but after some more research I discovered that font designers often
use a language defined by Adobe called &#x201C;<a href="https://adobe-type-tools.github.io/afdko/OpenTypeFeatureFileSpecification.html">feature
files</a>,&#x201D;
which compiles down to OpenType tables.</p> <p>Here&#x2019;s an example of what a feature file looks like. It makes strings
of vowels alternate in capitalization, starting from what they were on
the right:</p> <div class="language-ini highlighter-rouge"><pre class="highlight"><code><span class="c"># Tell OpenType to use a system with fancy shaping features for latin characters
</span><span class="err">languagesystem</span> <span class="err">DFLT</span> <span class="err">dflt</span><span class="c">;
</span><span class="err">languagesystem</span> <span class="err">latn</span> <span class="err">dflt</span><span class="c">;
# Classes can be given names and you can reference glyphs by name
</span><span class="err">@</span><span class="py">lowercase</span><span class="p">=</span><span class="s">[a o e u i];</span>
<span class="err">@</span><span class="py">uppercase</span><span class="p">=</span><span class="s">[A O E U I];</span> <span class="c"># Substitutions are put under &quot;features&quot;, which have different capabilities.
# The one I use is &quot;contextual alternates&quot;, which is enabled by default
# and allows contextual substitutions.
</span><span class="err">feature</span> <span class="err">calt</span> <span class="err">{</span> <span class="c"># Matches a lowercase followed by a lowercase and replaces it with
</span> <span class="c"># the corresponding uppercase version, and vice versa.
</span> <span class="c"># The &apos; signifies the glyph in the pattern to be substituted.
</span> <span class="c"># This turns AoeUI into AoEuI
</span> <span class="err">reversesub</span> <span class="err">@lowercase&apos;</span> <span class="err">@lowercase</span> <span class="err">by</span> <span class="err">@uppercase</span><span class="c">;
</span> <span class="err">reversesub</span> <span class="err">@uppercase&apos;</span> <span class="err">@uppercase</span> <span class="err">by</span> <span class="err">@lowercase</span><span class="c">;
</span><span class="err">}</span> <span class="err">calt</span><span class="c">;
</span></code></pre>
</div> <h2 id="using-the-knowledge">Using the knowledge</h2> <p>I realized that instead of inserting commas, I wanted to underline
alternating groups of 3 digits so that the font would work in monospace
contexts. This would require keeping track of each digit&#x2019;s position
from the right of the number modulo 6. Unfortunately the only way to
keep track of state is by replacing glyphs: notice how in the above
example we effectively count modulo 2 by matching on the case (state)
of the glyph on the right and ensuring the alternating
uppercase/lowercase pattern continues.</p> <p>So I needed to make six copies of each digit glyph, corresponding to
the six possible states. For instance I would have six different &#x201C;4&#x201D;
glyphs, each with a different glyph ID that I could match on
separately, with the first three glyphs looking normal and the last
three having an underline. My feature file would have six class
definitions for each set of the digits 0-9, and my substitutions would
substitute one class for another based on the class it matched from
the right.</p> <p>I looked up how <a href="https://github.com/powerline/fontpatcher">the Powerline font
patcher</a> worked and read the
<a href="https://fontforge.github.io/en-US/">FontForge</a> <a href="http://dmtr.org/ff.php">API
documentation</a>. I modified the patcher to make
multiple copies of each digit glyph and to use string templating to
generate a feature file with class definitions that reference the
different sets of copies followed by substitutions that use them.</p> <p>I then needed a way to test the resulting font, but I didn&#x2019;t want to
have to reinstall the font constantly and worry about stale caches. I
ended up using a test web page which loaded the font as a web font.</p> <p>I implemented the counting modulo six using &#x201C;reversesub&#x201D; rules, but
the FontForge API segfaulted when I tried to compile the feature file!
It turns out there&#x2019;s been an open issue about this for years but
&#x201C;reversesub&#x201D; rules are so infrequently used that it hasn&#x2019;t been
fixed. So I switched to using
<a href="https://github.com/fonttools/fonttools">fontTools</a> to add in my
feature files, and it worked!</p> <p><a href="/commas-in-big-numbers-everywhere/numderline_steps.png"><img src="/commas-in-big-numbers-everywhere/numderline_steps.png" alt="Diagram of how Numderline works"></a></p> <p>Now I just needed to modify some of the copies of the digits to display
the digit grouping. In order to add the underline I found the
underscore glyph and pasted it on top of the digit copies corresponding
to 3 to 5 mod 6 from the right. When used on a font with a sufficiently
wide, low, and thin underscore like DejaVu Sans Mono, these alternating
groups of 3 underlined digits looked reasonably pleasant.</p> <h2 id="improvements">Improvements</h2> <p>I had accomplished my basic goal, but I still had other ideas. I
modified the feature file code so that it wouldn&#x2019;t touch numbers less
than 4 digits, and it numbered digits after the decimal place left to
right instead of right to left. I also added a debug mode that pasted
the index of the copy under each glyph in the copied digit set to
visualize how the font was working:</p> <p><a href="/commas-in-big-numbers-everywhere/numderline_ndebug.png"><img src="/commas-in-big-numbers-everywhere/numderline_ndebug.png" alt="The debug version of the font"></a></p> <p>Note that there&#x2019;s a &#x201C;6&#x201D; copy that&#x2019;s different from the &#x201C;0&#x201D; copy. This
was so that I could implement my original goal of inserting commas by
pasting the comma next to the correct digit, but without having a
comma to the right of the number, or to the left of 3 digit numbers. I
also made grouping digits after the decimal point optional so that
inserting commas didn&#x2019;t look as weird.</p> <p><a href="/commas-in-big-numbers-everywhere/numderline_nommas.png"><img src="/commas-in-big-numbers-everywhere/numderline_nommas.png" alt="The comma insertion version of the font"></a></p> <p>The underlying text above has no commas and that selection is one
character! A friend suggested I try squishing groups of 3 digits
together, so I tried that as well, by scaling and translating
different copies in different ways:</p> <p><a href="/commas-in-big-numbers-everywhere/numderline_ngroup.png"><img src="/commas-in-big-numbers-everywhere/numderline_ngroup.png" alt="Squishing groups together"></a></p> <p>And then I combined it with the commas to make a version that can
insert commas even in monspace contexts:</p> <p><a href="/commas-in-big-numbers-everywhere/numderline_nonocommas.png"><img src="/commas-in-big-numbers-everywhere/numderline_nonocommas.png" alt="Monospace comma insertion"></a></p> <p>After all these improvements my final feature files looked like this:</p> <div class="language-ini highlighter-rouge"><pre class="highlight"><code><span class="err">languagesystem</span> <span class="err">DFLT</span> <span class="err">dflt</span><span class="c">;
</span><span class="err">languagesystem</span> <span class="err">latn</span> <span class="err">dflt</span><span class="c">;
</span><span class="err">@</span><span class="py">digits</span><span class="p">=</span><span class="s">[zero one two three four five six seven eight nine];</span>
<span class="c"># class definitions for all my copies of the digit glyphs
</span><span class="err">@</span><span class="py">nd0</span><span class="p">=</span><span class="s">[nd0.0 nd0.1 nd0.2 nd0.3 nd0.4 nd0.5 nd0.6 nd0.7 nd0.8 nd0.9];</span>
<span class="c"># [clipped] lines for @nd1 through @nd5 ...
</span><span class="err">@</span><span class="py">nd6</span><span class="p">=</span><span class="s">[nd6.0 nd6.1 nd6.2 nd6.3 nd6.4 nd6.5 nd6.6 nd6.7 nd6.8 nd6.9];</span> <span class="err">feature</span> <span class="err">calt</span> <span class="err">{</span> <span class="c"># Number glyphs after a period left to right by forward chaining off an @nd2
</span> <span class="err">sub</span> <span class="err">period</span> <span class="err">@digits&apos;</span> <span class="err">by</span> <span class="err">@nd2</span><span class="c">;
</span> <span class="err">sub</span> <span class="err">@nd2</span> <span class="err">@digits&apos;</span> <span class="err">by</span> <span class="err">@nd1</span><span class="c">;
</span> <span class="err">sub</span> <span class="err">@nd1</span> <span class="err">@digits&apos;</span> <span class="err">by</span> <span class="err">@nd6</span><span class="c">;
</span> <span class="c"># [clipped] lines for @nd5 through @nd3 ...
</span> <span class="err">sub</span> <span class="err">@nd3</span> <span class="err">@digits&apos;</span> <span class="err">by</span> <span class="err">@nd2</span><span class="c">;
</span> <span class="c"># Only convert numbers with at least 4 digits
</span> <span class="err">sub</span> <span class="err">@digits&apos;</span> <span class="err">@digits</span> <span class="err">@digits</span> <span class="err">@digits</span> <span class="err">by</span> <span class="err">@nd0</span><span class="c">;
</span> <span class="c"># Chain to mark rightmost digit as @nd0
</span> <span class="err">sub</span> <span class="err">@nd0</span> <span class="err">@digits&apos;</span> <span class="err">by</span> <span class="err">@nd0</span><span class="c">;
</span> <span class="c"># Chain in reverse from the rightmost @nd0
</span> <span class="err">reversesub</span> <span class="err">@nd0&apos;</span> <span class="err">@nd0</span> <span class="err">by</span> <span class="err">@nd1</span><span class="c">;
</span> <span class="err">reversesub</span> <span class="err">@nd0&apos;</span> <span class="err">@nd1</span> <span class="err">by</span> <span class="err">@nd2</span><span class="c">;
</span> <span class="c"># [clipped] lines for @nd3 through @nd5 ...
</span> <span class="err">reversesub</span> <span class="err">@nd0&apos;</span> <span class="err">@nd5</span> <span class="err">by</span> <span class="err">@nd6</span><span class="c">;
</span> <span class="err">reversesub</span> <span class="err">@nd0&apos;</span> <span class="err">@nd6</span> <span class="err">by</span> <span class="err">@nd1</span><span class="c">;
</span><span class="err">}</span> <span class="err">calt</span><span class="c">;
</span></code></pre>
</div> <h2 id="using-it-at-work">Using it at work</h2> <p>At work I used the <a href="https://chrome.google.com/webstore/detail/stylebot/oiaejidbmkiecgbjeifoejpgmdaleoha?hl=en">StyleBot Chrome
extension</a>
to inject custom CSS in my <a href="https://jupyter.org/">Jupyter</a> notebooks,
which made my <a href="https://pandas.pydata.org">Pandas</a> tables right-aligned,
and used my font, so that I could now more easily parse the columns of
large numbers. I also switched to the <a href="https://sw.kovidgoyal.net/kitty/index.html">Kitty
terminal</a>, one of the few
that supports font shaping, and set it up with my font so that I could
use it with Jane Street&#x2019;s command line data retrieval
tools.</p> <p>Unfortunately I couldn&#x2019;t use it in my text editor since Emacs doesn&#x2019;t
support font shaping, and while Sublime Text 3 does, it has an
optimization where it doesn&#x2019;t apply font shaping to alphanumeric
characters to save space in the shaping cache.</p> <p>I&#x2019;ve been really enjoying it for the couple weeks I&#x2019;ve used it &#x2013; it
makes visually parsing tables easier, and in my Jupyter notebooks,
even though Python 3 now supports underscores in numbers, I don&#x2019;t need
to manually add them and update them when I change a number
anymore. My font makes them obsolete.</p> <p>I&#x2019;ve also gotten lots of interest in using the font from my coworkers,
because it turns out many people at Jane Street spend time staring at
various types of large numbers.</p> <p><a href="/commas-in-big-numbers-everywhere/numderline_pandas.png"><img src="/commas-in-big-numbers-everywhere/numderline_pandas.png" alt="Using Numderline in Jupyter"></a></p> <div>
A custom stylesheet makes Jupyter notebooks use Numderline and right-align Pandas tables
</div> <h2 id="conclusion">Conclusion</h2> <p>You can preview the various versions of the font at
<a href="https://thume.ca/numderline/">https://thume.ca/numderline/</a> and download pre-patched versions of
some selected fonts, or look at <a href="https://github.com/trishume/numderline">the
source</a> and use the patcher
yourself.</p> <p>On the one hand, this whole project seems like a hack which uses font
shaping for something it&#x2019;s not intended to do, but on the other hand I
think that font shaping is the natural place to apply stylistic features
that make text easier to read.</p> <p>Over the years, as font shaping has rolled out more advanced features
and made more languages display better in more places, I think it was
a failure of imagination to not improve the display of English text
and numbers as well. I think digit grouping should always have been
the job of font shaping. Indeed, it is the programming languages and
style guides suggesting you insert commas and underscores every three
digits that are the hacky workarounds!</p> <p>I think this is a great example of what can be accomplished by knowing
all the parts of a system so that you can find the best place to
implement something. Notably, I didn&#x2019;t need to understand how OpenType
shaping worked to come up with the idea. I just had to know it existed
and have an idea of what it was capable of, so that I knew to go
research it further.</p> <p>My work is in performance engineering, where understanding the basics
of how the entire system works end to end, then diving deep and
learning about some overlooked area, is a great way of finding
potential optimizations. Nearly every day I spend time learning about
a new part of a system, or profit from past learning by coming up with
an idea based on some thing I vaguely remember reading years ago. I
think it&#x2019;s really valuable to constantly learn about interesting
things just outside your usual domain so that you can realize when
they might be applicable after all.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>