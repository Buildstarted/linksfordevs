<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Monitoring your own infrastructure using Grafana, InfluxDB, and CollectD - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Monitoring your own infrastructure using Grafana, InfluxDB, and CollectD - linksfor.dev(s)"/>
    <meta property="og:description" content="Have you ever wondered which node consumes more resources? Managing a bespoke dashboard for your infrastructure. Learn how to create it."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://serhack.me/articles/monitoring-infrastructure-grafana-influxdb-connectd/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Monitoring your own infrastructure using Grafana, InfluxDB, and CollectD</title>
<div class="readable">
        <h1>Monitoring your own infrastructure using Grafana, InfluxDB, and CollectD</h1>
            <div>Reading time: 10-13 minutes</div>
        <div>Posted here: 21 Jul 2020</div>
        <p><a href="https://serhack.me/articles/monitoring-infrastructure-grafana-influxdb-connectd/">https://serhack.me/articles/monitoring-infrastructure-grafana-influxdb-connectd/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><p><img src="https://serhack.me/images/grafana/all%20together%20now_wide.jpg" alt="Grafana, InfluxDB and CollectD"></p><h4 id="for-some-companies-infrastructure-is-the-heart-of-its-business-specifically-i-am-referring-to-those-companies-which-need-to-manage-data-and-applications-located-on-more-than-one-server">For some companies, infrastructure is the heart of its business. Specifically, I am referring to those companies which need to manage data and applications located on more than one server.</h4><p>It is essential for a company to monitor its infrastructure nodes, especially if the company does not have on-site access to intervene when issues arise. In fact, the intensive use of some resources can be an indication of malfunctioning or overcrowding. However, in addition to prevention, monitoring could be used to assess possible implications of new software in the production environment. Currently, there are several “ready-to-use” solutions on the market to keep track of all the resources consumed. These solutions, which appear reasonable, present two key problems: the high price of setup and security issues related to third parties.</p><p>The first problem is related to cost. Prices vary from 10 euros per month up to thousands depending on how many hosts you need to monitor — with the former being consumer pricing and the latter being enterprise pricing. So, for example, let’s imagine that I have three nodes to monitor during the course of a year. At 10 euros per month, I would spend 120 euros. For smaller enterprises, where the price can range between 10,000 and 20,000 euro per year, such an expense can bloat its underlying cost structure and become financially untenable.</p><p>The second problem is third party risk. Typically, infrastructure data must pass through a third party company in order to be seen and analysed for the customer — whether that be an individual consumer or an enterprise. How does the third party company capture the data and then present it to the customer? Simply put, the third party company often collects data through a custom agent that is installed onto a node and monitored. Quite often is it found that this installation is not up-to-date and compatible with operating systems. Previous work has been done by security researchers who cast light upon problems with <a href="https://www.rapid7.com/db/modules/exploit/linux/misc/nagios_nrpe_arguments">“proprietary collectors”</a>. Would you trust them? I would not.</p><p>In keeping nodes for both <a href="https://trac.torproject.org/projects/tor/wiki/TorRelayGuide">Tor</a> and some <a href="https://getmonero.org/">cryptocurrencies</a>, I prefer to opt for a cost free, easy to configure, and open-source alternative. Here, we will use the triad: Grafana, InfluxDB, and CollectD.</p><p><img src="https://serhack.me/images/grafana/grafana-graphs.png" alt="An example of a Grafana dashboard"></p><h2 id="monitoring">Monitoring</h2><p>In order to be able to analyse every metric of our infrastructure, it is necessary to use a program capable of capturing statistics on the machines we want to monitor. In this regard, <a href="https://collectd.org/">CollectD</a> comes to your aid: it is a daemon that groups and collects (hence the name) all the parameters that can be stored on disk or sent over the network.</p><p>The data will be transmitted to an instance of <a href="https://www.influxdata.com/">InfluxDB</a>: a particular time series database that associates to each data the time (coded in UNIX timestamp) in which the server received it. In this way, the data sent by CollectD will already be set in a temporal way, as a succession of events.</p><p>Finally, you will use <a href="http://grafana.org/">Grafana</a> which will connect to InfluxDB to create flashy dashboards to display the data in a user-friendly way. Through histograms and graphs of every kind, it will be possible to observe in real time all the data related to CPU, RAM, etc.</p><p><img src="https://serhack.me/images/grafana/grafana-diagram.png" alt="Grafana infrastructure"></p><h2 id="influxdb">InfluxDB</h2><picture>
<source media="(min-width: 535px)" data-original-set="/images/grafana/db_alone.jpg 1x,
                /images/grafana/db_alone_wide.jpg 2x"><source media="(max-width: 534px)" data-original-set="/images/grafana/db_alone.jpg 1x,
                /images/grafana/db_alone.jpg 2x" src-set="/images/grafana/db_alone.jpg 1x,
                /images/grafana/db_alone.jpg 2x"><img data-original="/images/grafana/db_alone.jpg" data-original-set="/images/grafana/db_alone_wide.jpg 2x" src="https://serhack.me/images/grafana/db_alone_wide.jpg" alt=""></picture><p>Let’s start with InfluxDB, which is the beating heart of our monitoring “system”. InfluxDB is a time series database <a href="https://github.com/influxdata/influxdb">open-source</a> developed in <a href="https://golang.org/">Go</a> to store data as a sequence of events.</p><p>Each time data is added, it is linked to <a href="https://en.wikipedia.org/wiki/Unix_time">a UNIX timestamp</a> by default. This allows enormous flexibility for the user who no longer has to worry about saving, as an example, the “time” variable, which is sometimes cumbersome to configure. Let’s imagine we have several machines located in a number of continents. How do we manage the “time” variable? Do we use the <a href="https://en.wikipedia.org/wiki/Greenwich_Mean_Time">Greenwich</a> meridian for all the data? Or do we set a different time zone for each node? If data is saved on different time zones, how can we accurately display the graphs? As you can see, this can be very complicated.</p><p>As a time-aware database that automatically timestamps any data point, InfluxDB has the advantage of simultaneously being able to write to a certain database. This is why we often imagine InfluxDB as a timeline. Writing data does not affect the performance of the database (as sometimes happens in MySQL), since writing is simply the addition of a certain event to the timeline. The name of the program derives precisely from the conception of time as an infinite and indefinite “flow” that flows.</p><h3 id="installation-and-configuration">Installation and configuration</h3><p>Another advantage of InflxuDB is the <a href="https://docs.influxdata.com/influxdb/v1.8/introduction/install/">ease of installation</a> and the extensive <a href="https://docs.influxdata.com/">documentation</a> provided by the community that widely supports the project. It has two types of interfaces: via <a href="https://docs.influxdata.com/influxdb/v1.8/tools/shell/">Command Line</a> (which is powerful and flexible for developers, but poorly prepared to see large amounts of data) and an <a href="https://docs.influxdata.com/influxdb/v1.8/guides/write_data/#sidebar">HTTP API</a> that allows direct communication with the database.</p><p>InfluxDB can be downloaded not only from the official website, but also from the package manager of the distribution (in this example we use a Debian system). It is advisable to check the package via GPG before installation, so (below) we import the keys of the InfluxDB package:</p><div><pre><code data-lang="bash">root@node#~: curl -sL https://repos.influxdata.com/influxdb.key | sudo apt-key add -
root@node#~: source /etc/os-release
root@node#~: echo <span>"deb https://repos.influxdata.com/debian </span><span>$(</span>lsb_release -cs<span>)</span><span> stable"</span> | sudo tee /etc/apt/sources.list.d/influxdb.list</code></pre></div><p>Finally, we update and install InfluxDB:</p><div><pre><code data-lang="bash">root@node#~: apt-get update 
root@node#~: apt-get install influxdb</code></pre></div><p>To start it, we use <code>systemctl</code>:</p><div><pre><code data-lang="bash">root@node#~: service start influxdb </code></pre></div><p>To make sure that no one nefarious enters, we create the user “administrator”. InfluxDB uses a particular query language called <a href="https://docs.influxdata.com/influxdb/v1.8/query_language/">“InfluxQL”</a>, similar to SQL, which allows you to interact with the database. To create a new entry, we use the query <a href="https://docs.influxdata.com/influxdb/v1.8/administration/authentication_and_authorization/#user-management-commands"><code>CREATE USER</code></a>.</p><div><pre><code data-lang="bash">root@node#~: influx
Connected to http://localhost:8086
InfluxDB shell version: x.y.z
&gt;
&gt; CREATE USER admin WITH PASSWORD <span>'MYPASSISCOOL'</span> WITH ALL PRIVILEGES</code></pre></div><p>From the same CLI interface, we create the “metrics” database that will be used as a container for our metrics.</p><div><pre><code data-lang="bash">&gt; CREATE DATABASE metrics</code></pre></div><p>Next, let’s modify the configuration of InfluxDB (<code>/etc/influxdb/influxdb.conf</code>) to have the interface open on port <strong>24589</strong> (UDP) with direct connection to the database named “metrics” in support of CollectD. You also need to download and place the <a href="https://raw.githubusercontent.com/collectd/collectd/master/src/types.db">types.db</a> file in <code>/usr/share/collectd/</code> (or any other folder) to define the data that <a href="https://docs.influxdata.com/influxdb/v1.8/supported_protocols/collectd/">CollectD sends in native format</a>.</p><div><pre><code data-lang="bash">root@node#~: nano /etc/influxdb/influxdb.conf
<span>[</span>Collectd<span>]</span>
enabled <span>=</span> true
bind-address <span>=</span> <span>":24589"</span>
database <span>=</span> <span>"metrics"</span>
typesdb <span>=</span> <span>"/usr/share/collectd/types.db"</span></code></pre></div><p>For further information on the CollectD block within the configuration, see the <a href="https://docs.influxdata.com/influxdb/v1.8/administration/config/#collectd-settings">reference to documentation</a>.</p><h2 id="collectd">CollectD</h2><picture>
<source media="(min-width: 535px)" data-original-set="/images/grafana/daemon_alone.jpg 1x,
                /images/grafana/daemon_alone_wide.jpg 2x"><source media="(max-width: 534px)" data-original-set="/images/grafana/daemon_alone.jpg 1x,
                /images/grafana/daemon_alone.jpg 2x" src-set="/images/grafana/daemon_alone.jpg 1x,
                /images/grafana/daemon_alone.jpg 2x"><img data-original="/images/grafana/daemon_alone.jpg" data-original-set="/images/grafana/daemon_alone_wide.jpg 2x" src="https://serhack.me/images/grafana/daemon_alone_wide.jpg" alt=""></picture><p>CollectD is a data aggregator, in our monitoring infrastructure, that facilitates the transmission of data to InfluxDB. By default, CollectD captures metrics on CPU, RAM, memory (on disk), network interfaces, processes, etc. The potential of the program is endless, given that it can be extended with a preinstalled <a href="https://collectd.org/wiki/index.php/Table_of_Plugins">plugin enablement</a> or through the <a href="https://collectd.org/wiki/index.php/Roadmap#Wishlist_.2F_Ideas">creation of new ones</a>.</p><p>As you can see, installing CollectD is simple:</p><div><pre><code data-lang="bash">root@node#~: apt-get install collectd collectd-utils</code></pre></div><p>In a simplistic manner, let’s illustrate how CollectD works. Suppose that I want to check how many processes my node has. In doing so, CollectD does nothing more than make an API call to get the number of processes per time unit (defined as 5000 ms, by default). Once captured, the data will be sent to InfluxDB via a module (called “Network”) to be configured.</p><p>Open the file <code>/etc/collectd.conf</code> with our editor, scroll to find the <code>Network</code> section, and edit as written in the following snippet. Be sure to specify the IP where the interface of InfluxDB (<code>INFLUXDB_IP</code>) is located.</p><div><pre><code data-lang="bash">root@node#~: nano /etc/collectd.conf
    ...
&lt;Plugin network&gt;
  &lt;Server <span>"INFLUXDB_IP"</span> <span>"24589"</span>&gt;
  &lt;/Server&gt;
  ReportStats true
&lt;/Plugin&gt;
    ...</code></pre></div><p>My suggestion is to modify, within the configuration, the hostname that is sent to InfluxDB (which in our infrastructure is a “centralized” database, since it resides on a single node). In doing so, the data will not be redundant and there is no risk that other nodes will overwrite the information.</p><p><img src="https://serhack.me/images/grafana/tres_caballeros.jpg" alt="Three daemon"></p><h2 id="grafana">Grafana</h2><p><img src="https://serhack.me/images/grafana/grafana_alone.jpg" alt=""></p><blockquote><p>A graph is worth thousand of images</p></blockquote><p>In remembrance of this famous “quote”, observing the infrastructure metrics live through graphs and tables enables us to act in an efficient and timely manner. To create and configure the dashboard, we will use Grafana.</p><p>Grafana is an open-source tool, compatible with a wide range of databases (including InfluxDB), that presents a graphical representation of metrics and allows a user to create alerts if a particular piece of data meets a condition. For example, if your CPU reaches high peaks, you can be notified on Slack, Mattermost, by email, etc. In fact, I have personally configured an alert every time someone enters SSH, so I can actively monitor who “enters” my infrastructure.</p><p>Grafana does not require any special settings: once again, it is InfluxDB that “scans” the “time” variable. The integration is simple. Let’s start by import the public key to add the package from the <a href="https://grafana.com/grafana/download">Grafana official website</a> (it depends on the OS you are using):</p><div><pre><code data-lang="bash">root@node#~: wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
root@node#~: echo <span>"deb https://packages.grafana.com/oss/deb stable main"</span> | sudo tee -a /etc/apt/sources.list.d/grafana.list 
root@node#~: apt-get update <span>&amp;&amp;</span> apt-get install grafana</code></pre></div><p>Let’s start it through systemctl:</p><div><pre><code data-lang="bash">root@node#~: systemctl start grafana-web</code></pre></div><p>Next, as we go to the localhost:3000 page through the browser, we should be presented with a login interface for Grafana. By default, you should use <strong>admin</strong> as username and <strong>admin</strong> as password (it is advisable to change the password after the first login).</p><p><img src="https://serhack.me/images/grafana/login-page.png" alt="Login page"></p><p>Let’s go to Sources and add our Influx database:</p><p><img src="https://serhack.me/images/grafana/add-data-source.png" alt="Add data source to Grafana"></p><p><img src="https://serhack.me/images/grafana/influxdb.png" alt="InfluxDB"></p><p>The screen now shows a small green rectangle just below the New Dashboard. Hover your mouse over this rectangle and select Add Panel, then Graph:</p><p><img src="https://serhack.me/images/grafana/add-new-panel.png" alt="Add a new panel"></p><p>A graph with the test data is now shown. Click on the title of this chart and choose Edit. Grafana allows the writing of intelligent queries: you do not have to know every field of the database, as Grafana proposes them through a list from which you can choose the parameter to analyse.</p><p><img src="https://grafana.com/static/img/docs/v45/influxdb_query.gif" alt="Intelligent queries"></p><p>Writing queries has never been easier: just select the measurement you would like to trace and click Refresh. I also recommend differentiating the metrics by hostname, so it is easier to isolate any problems. If you are looking for other ideas for creating dashboards, I recommend visiting <a href="https://grafana.com/grafana/dashboards?orderBy=name&amp;direction=asc">Grafana showcase</a> for inspiration.</p><p>As we have noticed, Grafana is very extensible and allows us to compare data of different nature. There is no metric that cannot be captured, so creativity is your only limit. Monitor your machine and get a universal, live view of your infrastructure!</p><p><img src="https://serhack.me/images/grafana/theend.jpg" alt="the end"></p></div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>