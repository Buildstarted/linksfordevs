<!DOCTYPE html>
<html lang="en">
<head>
    <title>
IndexedDB in Blazor -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>IndexedDB in Blazor</h1>
    <div class="body"> <p>Almost all rich client-side web apps (SPAs) involve interacting with a data store. Normally, that data store is held on some server, and the browser-based app queries it by making HTTP calls to some API endpoint. Another option, though, is to store a database <em>client-side</em> in the browser. The great benefit of doing so is that it permits completely instant querying, and can even work offline.</p> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDB</a> has been around for ages, and remains the dominant way to put a client-side database in your SPA. It&#x2019;s an indexed store of JSON objects, which lets you configure your own versioned data schema and perform efficient queries against the indexes you&#x2019;ve defined. Naturally, it works both offline and online.</p> <h2 id="using-indexeddb-with-blazor">Using IndexedDB with Blazor</h2> <p>You <em>could</em> use the native IndexedDB APIs through Blazor&#x2019;s JS interop capability. But you&#x2019;ll have a rough time, because - to put it kindly - the IndexedDB APIs are atrocious. IndexedDB came onto the scene before <code class="highlighter-rouge">Promise</code>, so it has an events-based asynchrony model, which is a disaster to work with.</p> <p>So, I was pretty intrigued when I heard about <a href="https://github.com/Reshiru/Blazor.IndexedDB.Framework"><code class="highlighter-rouge">Reshiru.Blazor.IndexedDB.Framework</code></a>, a NuGet package described as:</p> <blockquote> <p>An easy way to interact with IndexedDB and make it feel like EFCore</p>
</blockquote> <p>Taking the bizarre IndexedDB APIs and turning them into nice, idiomatic .NET ones? Let&#x2019;s have a look.</p> <p><strong>Update</strong>: Internally, <code class="highlighter-rouge">Reshiru.Blazor.IndexedDB.Framework</code> is built on <a href="https://www.nuget.org/packages/TG.Blazor.IndexedDB"><code class="highlighter-rouge">TG.Blazor.IndexedDB</code></a> by William Tulloch, which surfaces the IndexedDB features in .NET. Reshiru&#x2019;s package builds on this by adding an EF-like DB context API.</p> <h2 id="getting-started">Getting started</h2> <p>First, in your Blazor app&#x2019;s <code class="highlighter-rouge">.csproj</code>, add a reference to the <code class="highlighter-rouge">Reshiru.Blazor.IndexedDB.Framework</code>:</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;PackageReference</span> <span class="na">Include=</span><span class="s">&quot;Reshiru.Blazor.IndexedDB.Framework&quot;</span> <span class="na">Version=</span><span class="s">&quot;1.0.1&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div></div> <p>In your <code class="highlighter-rouge">Startup.cs</code>&#x2019;s <code class="highlighter-rouge">ConfigureServices</code>, set up the <code class="highlighter-rouge">IIndexedDbFactory</code>. As far as I know, the <code class="highlighter-rouge">IndexedDbFactory</code> doesn&#x2019;t maintain any state so it&#x2019;s safe to make it <em>singleton</em>, but if in the future it becomes stateful, you&#x2019;d want to use <em>scoped</em>:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">IIndexedDbFactory</span><span class="p">,</span> <span class="n">IndexedDbFactory</span><span class="p">&gt;();</span>
</code></pre></div></div> <p>Now you&#x2019;re ready to define your data schema. This package makes it dead easy, since as with EF, it&#x2019;s just C# classes:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">MyApp.Data</span>
<span class="p">{</span> <span class="c1">// Represents the database</span> <span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleDb</span> <span class="p">:</span> <span class="n">IndexedDb</span> <span class="p">{</span> <span class="k">public</span> <span class="nf">ExampleDb</span><span class="p">(</span><span class="n">IJSRuntime</span> <span class="n">jSRuntime</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">jSRuntime</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span> <span class="c1">// These are like tables. Declare as many of them as you want.</span> <span class="k">public</span> <span class="n">IndexedSet</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">People</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span> <span class="p">{</span> <span class="p">[</span><span class="n">Key</span><span class="p">]</span> <span class="k">public</span> <span class="kt">long</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">[</span><span class="n">Required</span><span class="p">]</span> <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">[</span><span class="n">Required</span><span class="p">]</span> <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <code class="highlighter-rouge">[Key]</code> property will be populated automatically by the package using the auto-incrementing unique value given by the browser to each stored entity.</p> <p>The <code class="highlighter-rouge">[Required]</code> annotations aren&#x2019;t used by the data store at all, but I want them so my edit form will have validation rules later.</p> <h2 id="querying-for-data">Querying for data</h2> <p>Next it&#x2019;s time to build some UI that shows what&#x2019;s in the DB and lets you add and remove items.</p> <p>To make the Reshiru IndexedDB APIs available in your <code class="highlighter-rouge">.razor</code> files, add the following to <code class="highlighter-rouge">_Imports.razor</code> in the root folder of the app:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">@using</span> <span class="n">Blazor</span><span class="p">.</span><span class="n">IndexedDB</span><span class="p">.</span><span class="n">Framework</span>
<span class="n">@using</span> <span class="n">MyApp</span><span class="p">.</span><span class="n">Data</span> <span class="c1">// Or wherever your data classes are</span>
</code></pre></div></div> <p>Then, at the top of some <code class="highlighter-rouge">.razor</code> component that will fetch and display data, inject the DB service:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">@inject</span> <span class="n">IIndexedDbFactory</span> <span class="n">DbFactory</span>
</code></pre></div></div> <p>You can now write a <code class="highlighter-rouge">@code</code> block that will get access to the database via the <code class="highlighter-rouge">DbFactory</code> and fetch some data from it:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">@code</span> <span class="p">{</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">people</span><span class="p">;</span> <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnInitAsync</span><span class="p">()</span> <span class="p">{</span> <span class="k">using</span> <span class="nn">var</span> <span class="n">db</span> <span class="p">=</span> <span class="k">await</span> <span class="n">DbFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">ExampleDb</span><span class="p">&gt;();</span> <span class="n">people</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">People</span><span class="p">.</span><span class="nf">ToList</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Notice that I&#x2019;m using a C# <em>using declaration</em>. This is a brand-new C# language feature, so to make this compile, it&#x2019;s necessary to use the latest version of the compiler. Enable this by putting the following into a <code class="highlighter-rouge">&lt;PropertyGroup&gt;</code> in your <code class="highlighter-rouge">.csproj</code>:</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;LangVersion&gt;</span>preview<span class="nt">&lt;/LangVersion&gt;</span>
</code></pre></div></div> <p>Finally, we can add some Razor markup to display the contents of the <code class="highlighter-rouge">people</code> list:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>People<span class="nt">&lt;/h1&gt;</span> @if (people != null)
{ <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;thead&gt;</span> <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;th&gt;</span>ID<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>First name<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;th&gt;</span>Last name<span class="nt">&lt;/th&gt;</span> <span class="nt">&lt;/tr&gt;</span> <span class="nt">&lt;/thead&gt;</span> <span class="nt">&lt;tbody&gt;</span> @foreach (var person in people) { <span class="nt">&lt;tr&gt;</span> <span class="nt">&lt;td&gt;</span>@person.Id<span class="nt">&lt;/td&gt;</span> <span class="nt">&lt;td&gt;</span>@person.FirstName<span class="nt">&lt;/td&gt;</span> <span class="nt">&lt;td&gt;</span>@person.LastName<span class="nt">&lt;/td&gt;</span> <span class="nt">&lt;/tr&gt;</span> } <span class="nt">&lt;/tbody&gt;</span> <span class="nt">&lt;/table&gt;</span>
}
</code></pre></div></div> <p>Looks good! Running the application now, you&#x2019;ll see it fetch and display zero items, because of course the database is empty. But if you use the browser&#x2019;s dev tools, you can see that the Reshiru IndexedDB NuGet package did in fact create the database matching our schema:</p> <p><img src="/wp-content/uploads/2019/08/03/devtools-emptydb.png" alt="Empty DB schema"></p> <h2 id="inserting-data">Inserting data</h2> <p>Blank databases aren&#x2019;t very interesting. Let&#x2019;s make a form into which users can enter details for a new entity, and then insert it into the database. Here&#x2019;s a very basic validated form using standard Blazor APIs, which I put into the same <code class="highlighter-rouge">.razor</code> file as above:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;fieldset&gt;</span> <span class="nt">&lt;legend&gt;</span>Add new person<span class="nt">&lt;/legend&gt;</span> <span class="nt">&lt;EditForm</span> <span class="na">Model=</span><span class="s">&quot;@newPerson&quot;</span> <span class="na">OnValidSubmit=</span><span class="s">&quot;@SaveNewPerson&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;InputText</span> <span class="err">@</span><span class="na">bind-Value=</span><span class="s">&quot;@newPerson.FirstName&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;First name...&quot;</span> <span class="nt">/&gt;</span> <span class="nt">&lt;InputText</span> <span class="err">@</span><span class="na">bind-Value=</span><span class="s">&quot;@newPerson.LastName&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;Last name...&quot;</span> <span class="nt">/&gt;</span> <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Add<span class="nt">&lt;/button&gt;</span> <span class="nt">&lt;p&gt;&lt;ValidationSummary</span> <span class="nt">/&gt;&lt;/p&gt;</span> <span class="nt">&lt;DataAnnotationsValidator</span> <span class="nt">/&gt;</span> <span class="nt">&lt;/EditForm&gt;</span>
<span class="nt">&lt;/fieldset&gt;</span>

@code {
    Person newPerson = new Person();

    async Task SaveNewPerson()
    {
        // TODO
    }

    // ... rest as before
}
</code></pre></div></div> <p>This displays as follows. As you can see, it enforces the validation rules defined on the model type:</p> <p><img src="/wp-content/uploads/2019/08/03/form.png" alt="Basic form"></p> <p>All that remains is to put in some implementation for the <code class="highlighter-rouge">SaveNewPerson</code> method:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="n">Task</span> <span class="nf">SaveNewPerson</span><span class="p">()</span>
<span class="p">{</span> <span class="k">using</span> <span class="nn">var</span> <span class="n">db</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">DbFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">ExampleDb</span><span class="p">&gt;();</span> <span class="n">db</span><span class="p">.</span><span class="n">People</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">newPerson</span><span class="p">);</span> <span class="k">await</span> <span class="n">db</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span> <span class="c1">// Refresh list and reset the form</span> <span class="n">newPerson</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Person</span><span class="p">();</span> <span class="k">await</span> <span class="nf">OnInitAsync</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>&#x2026; and that&#x2019;s all there is to it. The user can now insert new records to their client-side database without any requests having to go to a server:</p> <p><img src="/wp-content/uploads/2019/08/03/adding-people.gif" alt="Adding people"></p> <p>In case you&#x2019;re wondering, the browser&#x2019;s dev tools also confirm that the data was saved:</p> <p><img src="/wp-content/uploads/2019/08/03/devtools-withpeople.png" alt="IndexedDB with contents"></p> <h2 id="deleting-data">Deleting data</h2> <p>To complete this example, let&#x2019;s put in some <em>Delete</em> buttons. I added the following markup at the end of the <code class="highlighter-rouge">&lt;tr&gt;</code> that gets rendered for each row:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;td&gt;&lt;button</span> <span class="err">@</span><span class="na">onclick=</span><span class="s">&quot;@(() =&gt; DeletePerson(person))&quot;</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/button&gt;&lt;/td&gt;</span>
</code></pre></div></div> <p>&#x2026; and added the following C# handler method to the <code class="highlighter-rouge">@code</code> block:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="n">Task</span> <span class="nf">DeletePerson</span><span class="p">(</span><span class="n">Person</span> <span class="n">person</span><span class="p">)</span>
<span class="p">{</span> <span class="k">using</span> <span class="nn">var</span> <span class="n">db</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">DbFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">ExampleDb</span><span class="p">&gt;();</span> <span class="n">db</span><span class="p">.</span><span class="n">People</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">person</span><span class="p">);</span> <span class="k">await</span> <span class="n">db</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span> <span class="k">await</span> <span class="nf">OnInitAsync</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="a-bigger-example">A bigger example</h2> <p>The most compelling benefits of client-side databases are:</p> <ul> <li>Instant querying (with no HTTP traffic per query)</li> <li>Offline support</li>
</ul> <p>To experience this with the <code class="highlighter-rouge">Reshiru.Blazor.IndexedDB.Framework</code> package, I built a very simple &#x201C;recipe database&#x201D; app that:</p> <ol> <li><strong>Fetches a database of recipes from the server</strong>, and uses it to populate a client-side database. This is only fetched once, and remains stored in the browser.</li> <li>Offers <strong>instant search-on-every-keystroke</strong> for recipes in that database</li>
</ol> <p>It would be pretty trivial to make this <a href="https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps/Offline_Service_workers">work offline using a service worker</a>.</p> <p>Likewise, it would be simple enough to make the app synchronize updates with changes coming from the server. Give each record a &#x201C;modified date&#x201D;, and have the SPA request all records modified since the last batch it received, and insert/update/delete those.</p> <p>Here&#x2019;s how it looks:</p> <p><img src="/wp-content/uploads/2019/08/03/recipe-site.gif" alt="Recipe app"></p> <p>The <a href="/wp-content/uploads/2019/08/03/RecipeApp.zip">source code is available here</a>.</p> <h3 id="what-i-learned">What I learned</h3> <p>After my quick experiment with the recipes app, I think there are some really great aspects of the <code class="highlighter-rouge">Reshiru.Blazor.IndexedDB.Framework</code>, and some aspects that make it not quite ready yet.</p> <p>On the positive side, the package does a fantastic job of keeping the APIs simple and familiar for .NET developers. It&#x2019;s as easy as, or perhaps easier than, using Entity Framework. The data schema is inferred directly from your model classes, and all aspects of serialization are handled for you. I&#x2019;m convinced it&#x2019;s possible to create an experience on par with EF backed by IndexedDB in the browser.</p> <p>However, I suspect this package has a couple more steps to go before it&#x2019;s really practical for use in a real application, both of which are already tracked in GitHub issues:</p> <ul> <li><strong>It doesn&#x2019;t yet have any foreign key (FK) support</strong> (<a href="https://github.com/Reshiru/Blazor.IndexedDB.Framework/issues/8">issue #8</a>) <ul> <li>Currently it&#x2019;s limited to JSON-serializing your entire entities, without any native way to represent associations between them</li> </ul> </li> <li><strong>It can&#x2019;t yet query against IndexedDB itself, but instead loads the entire DB into .NET memory</strong> (fixing this is a <a href="https://github.com/Reshiru/Blazor.IndexedDB.Framework#planned-features-or-optimizations">planned feature</a>) <ul> <li>It&#x2019;s pretty slow right now, and one of the major reasons is that when you do <code class="highlighter-rouge">DbFactory.Create</code>, it literally fetches <em>all</em> the data and deserializes it into an in-memory collection. Querying is then done in .NET memory via normal LINQ operations. So currently, it&#x2019;s not actually using the native indexes on the IndexedDB.</li> </ul> </li>
</ul> <p>Since both of these capabilities already exist in the underlying <code class="highlighter-rouge">TG.Blazor.IndexedDB</code> package, it&#x2019;s probably quite feasible for them to be surfaced through Reshiru&#x2019;s DB context APIs.</p> <p>I&#x2019;m greatly looking forwards to seeing this package mature, as it&#x2019;s clearly showing that a great client-side database experience is possible on .NET on WebAssembly.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>