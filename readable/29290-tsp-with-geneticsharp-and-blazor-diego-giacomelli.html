<!DOCTYPE html>
<html lang="en">
<head>
    <title>
TSP with GeneticSharp and Blazor | Diego Giacomelli -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>TSP with GeneticSharp and Blazor | Diego Giacomelli</h1><div><div class="entry"><center><img src="/assets/loading-image.png" data-src="/assets/logos/city.png" class="lazy" alt="Logo do post"></center><div class="post-info-box"><p class="post-info"><i class="fas fa-calendar-alt"></i><span class="post-date"></span>10/07/2019</p><p class="post-info"><i class="fas fa-clock"></i><span class="post-date"></span>9 minutes to read</p></div><p>In this post I will show how to use GeneticSharp and Blazor to solve the TSP (Travelling salesman problem).</p><h2 id="introduction">Introduction</h2><p>According to Wikipedia The travelling salesman problem (TSP) asks the following question:<em><strong>“Given a list of cities and the distances between each pair of cities, what is the shortest possible route that visits each city and returns to the origin city?”</strong></em></p><p>TSP is a classic sample to test some optimization techniques, as well it’s fairly used to demonstrate how to implement a genetic algorithm. For these reasons I will use it to show you how to implement a basic genetic algorithm in Blazor using GeneticSharp.</p><p>This post is a like a mirror of the <a href="/tsp-with-GeneticSharp-and-Unity3d">TSP with GeneticSharp an Unity3D</a>. It’s using the same format to teach TSP and GeneticSharp, but instead of Unity3D, this one is about Blazor.</p><p>You can see the final result of this tutorial on <a href="/apps/geneticsharp-runner-blazorapp">http://diegogiacomelli/apps/geneticsharp-runner-blazorapp</a>.</p><p>Note that the performance presented on this demo is not the performance that GeneticSharp presents in other apps kinds, like a ASP .NET Core backend app, a console app or in a Unity 3D game. As WebAssembly do not support create a new thread, we get limited to use a Timer to made this sample interactive. More details about this in next sections of the post.</p><h2 id="prerequisites">Prerequisites</h2><p>To better understand this tutorial, you need to have some experiences/knowledges in:</p><ul><li>Blazor (beginner)</li><li>Genetic algorithms (beginner).</li></ul><p>We will perform a very basic use of Blazor and everything you need to complete this tutorial will be explained or provided by the code samples, but if you want to find out better what’s happening under the hood, take a look on <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/get-started?view=aspnetcore-3.0&amp;viewFallbackFrom=aspnetcore-2.2&amp;tabs=netcore-cli">Blazor Get Started page</a>.</p><p>If you need an introduction to genetic algorithms, take a look at this tutorial <a href="/function-optimization-with-geneticsharp/">Function optimization with GeneticSharp</a>.</p><h2 id="creating-the-blazor-project">Creating the Blazor project</h2><p>Open a terminal and type:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new <span class="nt">-i</span> Microsoft.AspNetCore.Blazor.Templates::3.0.0-preview6.19307.2
</code></pre></div></div><center><span><p>This will install the latest Blazor templates for .NET Core.</p></span></center><p>This tutorial is based on Blazor <code class="highlighter-rouge">preview6</code>. If you are doing this tutorial using a newer Blazor version and have encountered some problem, leave a comment at the end of the post or contact me on <a href="https://twitter.com/ogiacomelli">Twitter</a>.</p><p>Now we’ll create a scaffold Blazor app using the <code class="highlighter-rouge">blazor</code> template:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new blazor <span class="nt">-o</span> TspWithGeneticSharp
<span class="nb">cd </span>TspWithGeneticSharp
dotnet watch run
</code></pre></div></div><p>Wait for the message <code class="highlighter-rouge">Application started. Press Ctrl+C to shut down</code> show up in terminal, then open the url <a href="http://localhost:5000">http://localhost:5000</a> on your browser, you should see something like this:</p><center><img class="lazy" src="/assets/2019/07/10/tsp-with-geneticsharp-and-blazor/blazor-scaffold-app.png "></center><h2 id="installing-geneticsharp">Installing GeneticSharp</h2><p>Open a new terminal in the same folder and type:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet add package GeneticSharp
</code></pre></div></div><center><span><p>This will install the latest <a href="https://www.nuget.org/packages/GeneticSharp/">GeneticSharp NuGet package</a> in your newly created Blazor app.</p></span></center><h2 id="opening-the-project">Opening the project</h2><p>I recommend to you use <a href="https://code.visualstudio.com/">Visual Studio Code</a> to open the project. There are some cool VS Code extensions to work with Blazor.</p><p>In the same terminal where you added the GeneticSharp package, type:</p><center><span><p>This will open the Blazor project with VS Code.</p></span></center><p>In the root folder of your Blazor project create a new subfolder called <code class="highlighter-rouge">Tsp</code>. We’ll add all our C# classes inside this folder.</p><h2 id="defining-the-tsp-chromosome">Defining the TSP chromosome</h2><center><img class="lazy" src="/assets/logos/route.png "></center><p>The chromosome represents a solution of the problem we are trying to solve. In our case the TSP chromosome should represent <em><strong>“the shortest possible route that visits each city and returns to the origin city”</strong></em>.</p><p>To represent the cities route each gene of our chromosome will represent an index of a city in the route.</p><p>Create a file called <code class="highlighter-rouge">TspChromosome.cs</code>:</p><h2 id="representing-a-city">Representing a city</h2><p>The next step is define our genetic algorithm fitness function, but first we need to create a simple class to represent a city on a 2D space.</p><p>Create a file called <code class="highlighter-rouge">TspCity.cs</code>:</p><h2 id="the-fitness-function">The fitness function</h2><p>Now we need to evaluate the <code class="highlighter-rouge">TspChromosome</code>.</p><p>Our fitness function will evaluate the chromosome fitness based on the total distance to reach all cities in the route represented by the chromosome. The shorter the distance, the better the chromosome.</p><p>Create a file called <code class="highlighter-rouge">TspFitness.cs</code>: </p><h2 id="configuring-the-genetic-algorithm">Configuring the Genetic Algorithm</h2><p>In this step we need to configure our genetic algorithm using the <code class="highlighter-rouge">TspChromosome</code>, <code class="highlighter-rouge">TspFitness</code> and some classic GA operators already built in GeneticSharp.</p><p>Create a file called <code class="highlighter-rouge">TspGA.cs</code>: </p><div class="note"><h3 id="why-use-timer">Why use Timer?</h3><p>GeneticSharp can be used as single threading or multithreading to evaluate chromosomes with the fitness function, but WebAssembly (and Blazor) can use just the UI thread, in this scenario when we call <code class="highlighter-rouge">GeneticAlgorithm.Start</code> method it freezes the UI until the GA finish.</p><p>To avoid this behavior, the solution is: run each generation of the GA inside a step in a <code class="highlighter-rouge">System.Threading.Timer</code> as you can see in the <code class="highlighter-rouge">TspGA.Run</code> method.</p><blockquote><p>APIs that aren’t applicable inside of a web browser (for example, accessing the file system, opening a socket, and <strong>threading</strong>) throw a PlatformNotSupportedException.
(<a href="https://docs.microsoft.com/pt-br/aspnet/core/blazor/?view=aspnetcore-3.0">https://docs.microsoft.com/pt-br/aspnet/core/blazor/?view=aspnetcore-3.0</a>)</p></blockquote></div><h2 id="creating-the-razor-page">Creating the Razor page</h2><p>Inside the folder <code class="highlighter-rouge">Pages</code> create a file called <code class="highlighter-rouge">Tsp.razor</code>: </p><p>As we need to interop with JavaScript to manipulate DOM, we will use some helper JS functions. Add the file <code class="highlighter-rouge">canvas-helper.js</code> inside the folder <code class="highlighter-rouge">wwwroot/js</code>:  </p><p>Open the file <code class="highlighter-rouge">index.html</code> and add the tag below inside the tag <code class="highlighter-rouge">head</code>:  </p><p>Check your terminal window where the command <code class="highlighter-rouge">dotnet watch run</code> is running, if there is no error in that window you can access the url <a href="http://localhost:5000/tsp">http://localhost:5000/tsp</a>.</p><p>Hit the <code class="highlighter-rouge">Run</code> button and take a look on the browser console window, you will see the distance to reach all cities getting smaller as the generations ran.</p><center><img class="lazy" src="/assets/2019/07/10/tsp-with-geneticsharp-and-blazor/console-window.png "></center><p>This is not a tutorial about Blazor good pratices, so everything here is done in the simplest possible way to introduce how to use GenticSharp with Blazor.  I do not talk about things you should use when working with Blazor, such as separate logic from UI and use Blazor components.</p><h2 id="drawing-the-cities">Drawing the cities</h2><p>Now our GA is running inside the browser, but it needs to display the cities route better.
We need to create a visual representation to the cities.</p><p>In the <code class="highlighter-rouge">Tsp.razor</code> add the method <code class="highlighter-rouge">DrawCitiesAsync</code>:</p><p>Then call it from <code class="highlighter-rouge">OnAfterRenderAsync</code> method, after the <code class="highlighter-rouge">clearCanvas</code> call:</p><p>Reload the url <a href="http://localhost:5000/tsp">http://localhost:5000/tsp</a>.</p><p>Now you should see something like this:</p><center><img class="lazy" src="/assets/2019/07/10/tsp-with-geneticsharp-and-blazor/draw-cities.gif "></center><h2 id="drawing-the-route">Drawing the route</h2><p>In the previous step we drawn the cities and we have the visual of the problem: the cities.</p><p>Now we need to draw the solution: the route represented by the best chromosome of each generation.</p><p>Add the following method to the <code class="highlighter-rouge">Tsp.razor</code>:</p><p>Then call it from <code class="highlighter-rouge">OnAfterRenderAsync</code> method, after the <code class="highlighter-rouge">DrawCitiesAsync</code> call:</p><p>Reload the url <a href="http://localhost:5000/tsp">http://localhost:5000/tsp</a> again, and hit the <code class="highlighter-rouge">Run</code> button, now you should see the route been optimizing as the generations are ran:</p><center><img class="lazy" src="/assets/2019/07/10/tsp-with-geneticsharp-and-blazor/draw-route.gif "></center><h2 id="conclusion">Conclusion</h2><p>With only 4 C# classes, 1 JS file and 1 Blazor page we built a pretty nice sample of genetic algorithms using Blazor with GeneticSharp. Now you can improve it with your own ideas or use some of mine ;):</p><ul><li>Maybe let user change the genetic algorithm operators (crossover, mutation, selection, etc)?</li><li>Move the DrawCitiesAsync and DrawRouteAsync to <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/components?view=aspnetcore-3.0">Blazor components</a> responsible to only draw them?</li></ul><p>The full source code used in this post can be download or fork from this Gist: <a href="https://gist.github.com/giacomelli/9addc5182943ba25eb82201e30c76418">https://gist.github.com/giacomelli/9addc5182943ba25eb82201e30c76418</a></p><p>Let’s evolve!</p><p>Icons made by <a href="http://www.freepik.com">Freepik</a>, <a href="http://www.flaticon.com/authors/vignesh-oviyan">Vignesh Oviyan</a> and <a href="https://www.flaticon.com/authors/eucalyp" title="Eucalyp">Eucalyp</a> from <a href="http://www.flaticon.com">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons BY 3.0</a></p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>