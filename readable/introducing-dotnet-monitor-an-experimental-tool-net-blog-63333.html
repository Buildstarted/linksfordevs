<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Introducing dotnet-monitor, an experimental tool | .NET Blog - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Introducing dotnet-monitor, an experimental tool | .NET Blog - linksfor.dev(s)"/>
    <meta property="article:author" content="Sourabh ShirhattiFollow"/>
    <meta property="og:description" content="dotnet-monitor aims to simplify the process of collecting diagnostics artifacts by exposing a REST API."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://devblogs.microsoft.com/dotnet/introducing-dotnet-monitor/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Introducing dotnet-monitor, an experimental tool | .NET Blog</title>
<div class="readable">
        <h1>Introducing dotnet-monitor, an experimental tool | .NET Blog</h1>
            <div>by Sourabh ShirhattiFollow</div>
            <div>Reading time: 12-15 minutes</div>
        <div>Posted here: 23 Jun 2020</div>
        <p><a href="https://devblogs.microsoft.com/dotnet/introducing-dotnet-monitor/">https://devblogs.microsoft.com/dotnet/introducing-dotnet-monitor/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="featured"><div><div><div><div><p><img src="https://secure.gravatar.com/avatar/07efe6bbd54a0f6649a09f43acb183d8?s=58&amp;d=mm&amp;r=g" width="58" height="58" alt="Avatar"></p><p>Sourabh</p></div></div></div><p>June 23rd, 2020</p><p><code><span>dotnet</span><span>-</span><span>monitor</span></code> is an experimental tool that makes it easier to get access to diagnostics information in a dotnet process.</p><p>When running a dotnet application differences in diverse local and production environments can make collecting diagnostics artifacts (e.g., logs, traces, process dumps) challenging. <code><span>dotnet</span><span>-</span><span>monitor</span></code> aims to simplify the process by exposing a consistent REST API regardless of where your application is run.</p><p>This blog post details how to get started with <code><span>dotnet</span><span>-</span><span>monitor</span></code> and covers the following:</p><ol><li>How to setup <code><span>dotnet</span><span>-</span><span>monitor</span></code></li><li>What diagnostics artifacts can be collected; and</li><li>How to collect each of the artifacts</li></ol><h2 id="tour-of-dotnet-monitor">Tour of dotnet-monitor<a href="#tour-of-dotnet-monitor"></a></h2><h3 id="setup-dotnet-monitor-">Setup <code><span>dotnet</span><span>-</span><span>monitor</span></code><a href="#setup-dotnet-monitor-"></a></h3><p><code><span>dotnet</span><span>-</span><span>monitor</span></code> will be made available via two different distribution mechanism:</p><ol><li>As a .NET Core global tool; and</li><li>As a container image available via the Microsoft Container Registry (MCR)</li></ol><p>The setup instructions for <code><span>dotnet</span><span>-</span><span>monitor</span></code> vary based on the target environment. The following section covers some common environments.</p><p>In the default configuration <code><span>dotnet</span><span>-</span><span>monitor</span></code> binds to two different groups of URLs. The URLs controlled via the <code><span>--</span><span>urls</span></code> parameter (defaults to <a href="http://localhost:52323/" target="_blank">http://localhost:52323</a>) expose all the collection endpoints. The URLs controlled via the <code><span>--</span><span>metricUrls</span></code> parameter (defaults to <a href="http://localhost:52325/" target="_blank">http://localhost:52325</a>) only expose the <code><span>/</span><span>metrics</span></code> endpoint. Since diagnostics artifacts such as logs, dumps, and traces can leak sensitive information about the application, it is <strong>strongly recommended</strong> that you do not publicly expose these endpoints.</p><h4 id="local-machine">Local Machine</h4><p>To get started with <code><span>dotnet</span><span>-</span><span>monitor</span></code> locally, you will need to have <a href="https://dotnet.microsoft.com/download" target="_blank">.NET Core</a> installed on your machine. You can then install<code><span>dotnet</span><span>-</span><span>monitor</span></code> as a global tool using the following command:</p><pre><code><span><span>dotnet tool install </span></span><span><span>-</span></span><span><span>g dotnet</span></span><span><span>-</span></span><span><span>monitor </span></span><span><span>--</span></span><span><span><span>add</span></span></span><span><span>-</span></span><span><span><span>source</span></span></span><span><span> http</span></span><span><span><span>s</span></span><span><span>:</span></span></span><span><span>//</span></span><span><span>dnceng</span></span><span><span>.</span></span><span><span>pkgs</span></span><span><span>.</span></span><span><span>visualstudio</span></span><span><span>.</span></span><span><span><span>com</span></span></span><span><span>/</span></span><span><span>public</span></span><span><span>/</span></span><span><span>_packaging</span></span><span><span>/</span></span><span><span>dotnet5</span></span><span><span>-</span></span><span><span>transport</span></span><span><span>/</span></span><span><span>nuget</span></span><span><span>/</span></span><span><span>v3</span></span><span><span>/</span></span><span><span><span>index</span></span></span><span><span>.</span></span><span><span>json </span></span><span><span>--</span></span><span><span><span>version</span></span></span><span><span> </span></span><span><span><span>5.0</span></span></span><span><span>.</span></span><span><span><span>0</span></span></span><span><span>-</span></span><span><span>preview</span></span><span><span>*</span></span></code></pre><p>Once installed you can run <code><span>dotnet</span><span>-</span><span>monitor</span></code> via the following command:</p><pre><code><span><span>dotnet</span></span><span><span><span> monitor </span></span></span><span><span>collect</span></span></code></pre><h4 id="running-in-docker">Running in Docker</h4><p>When consuming <code><span>dotnet</span><span>-</span><span>monitor</span></code> as a container image, it can be pulled from <a href="https://hub.docker.com/_/microsoft-dotnet-nightly-monitor/" target="_blank">MCR</a> using the following command:</p><pre><code><span><span>docker pull mcr</span></span><span><span><span>.</span></span><span><span>microsoft</span></span></span><span><span><span>.</span></span><span><span>com</span></span></span><span><span>/</span></span><span><span>dotnet</span></span><span><span>/</span></span><span><span>nightly</span></span><span><span>/</span></span><span><span>monitor</span></span><span><span>:</span></span><span><span><span>5.0</span></span></span><span><span>.</span></span><span><span><span>0</span></span></span><span><span>-</span></span><span><span>preview1</span></span></code></pre><p>Once you have the image pulled locally, you will need to share a volume mount between your application container and <code><span>dotnet</span><span>-</span><span>monitor</span></code> using the following commands:</p><pre><code><span><span>docker volume create diagnosticserver
docker run </span></span><span><span>-</span></span><span><span>d </span></span><span><span>--</span></span><span><span>rm </span></span><span><span>-</span></span><span><span><span>p</span></span></span><span><span> </span></span><span><span><span>8000</span></span></span><span><span>:</span></span><span><span><span>80</span></span></span><span><span> </span></span><span><span>-</span></span><span><span>v diagnosticsserver</span></span><span><span>:/</span></span><span><span>tmp mcr</span></span><span><span><span>.</span></span><span><span>microsoft</span></span></span><span><span><span>.</span></span><span><span>com</span></span></span><span><span>/</span></span><span><span>dotnet</span></span><span><span>/</span></span><span><span>core</span></span><span><span>/</span></span><span><span>samples</span></span><span><span>:</span></span><span><span>aspnetapp
docker run </span></span><span><span>-</span></span><span><span>it </span></span><span><span>--</span></span><span><span>rm </span></span><span><span>-</span></span><span><span><span>p</span></span></span><span><span> </span></span><span><span><span>52323</span></span></span><span><span>:</span></span><span><span><span>52323</span></span></span><span><span> </span></span><span><span>-</span></span><span><span>v diagnosticsserver</span></span><span><span>:/</span></span><span><span>tmp mcr</span></span><span><span><span>.</span></span><span><span>microsoft</span></span></span><span><span><span>.</span></span><span><span>com</span></span></span><span><span>/</span></span><span><span>dotnet</span></span><span><span>/</span></span><span><span>nightly</span></span><span><span>/</span></span><span><span>monitor</span></span><span><span>:</span></span><span><span><span>5.0</span></span></span><span><span>.</span></span><span><span><span>0</span></span></span><span><span>-</span></span><span><span>preview1 </span></span><span><span>--</span></span><span><span>urls http</span></span><span><span>:</span></span>
</code></pre><h4 id="running-in-a-kubernetes-cluster">Running in a Kubernetes cluster</h4><p>When running in a cluster, it is recommend to run the <code><span>dotnet</span><span>-</span><span>monitor</span></code> container as a sidecar alongside your application container in the same pod. The sample Kubernetes manifest below shows how to configure your deployment to include a sidecar container.</p><pre><code><span><span><span>apiVersion</span></span></span><span><span>:</span></span><span><span> apps</span></span><span><span>/</span></span><span><span>v1
</span></span><span><span><span>kind</span></span></span><span><span>:</span></span><span><span> </span></span><span><span>Deployment</span></span><span><span>
</span></span><span><span><span>metadata</span></span></span><span><span>:</span></span><span><span>
  </span></span><span><span><span>name</span></span></span><span><span>:</span></span><span><span> dotnet</span></span><span><span>-</span></span><span><span>hello</span></span><span><span>-</span></span><span><span>world
</span></span><span><span><span>spec</span></span></span><span><span>:</span></span><span><span>
  </span></span><span><span><span>replicas</span></span></span><span><span>:</span></span><span><span> </span></span><span><span><span>1</span></span></span><span><span>
  </span></span><span><span><span>selector</span></span></span><span><span>:</span></span><span><span>
    </span></span><span><span><span>matchLabels</span></span></span><span><span>:</span></span><span><span>
      </span></span><span><span><span>app</span></span></span><span><span>:</span></span><span><span> dotnet</span></span><span><span>-</span></span><span><span>hello</span></span><span><span>-</span></span><span><span>world
  </span></span><span><span><span>template</span></span></span><span><span>:</span></span><span><span>
    </span></span><span><span><span>metadata</span></span></span><span><span>:</span></span><span><span>
      </span></span><span><span><span>labels</span></span></span><span><span>:</span></span><span><span>
        </span></span><span><span><span>app</span></span></span><span><span>:</span></span><span><span> dotnet</span></span><span><span>-</span></span><span><span>hello</span></span><span><span>-</span></span><span><span>world
    </span></span><span><span><span>spec</span></span></span><span><span>:</span></span><span><span>
      </span></span><span><span><span>volumes</span></span></span><span><span>:</span></span><span><span>
      </span></span><span><span>-</span></span><span><span> </span></span><span><span><span>name</span></span></span><span><span>:</span></span><span><span> diagnostics
        </span></span><span><span><span>emptyDir</span></span></span><span><span>:</span></span><span><span> </span></span><span><span>{}</span></span><span><span>
      </span></span><span><span><span>containers</span></span></span><span><span>:</span></span><span><span>
      </span></span><span><span>-</span></span><span><span> </span></span><span><span><span>name</span></span></span><span><span>:</span></span><span><span> server
        </span></span><span><span><span>image</span></span></span><span><span>:</span></span><span><span> mcr</span></span><span><span>.</span></span><span><span>microsoft</span></span><span><span>.</span></span><span><span>com</span></span><span><span>/</span></span><span><span>dotnet</span></span><span><span>/</span></span><span><span>core</span></span><span><span>/</span></span><span><span><span>samples</span></span></span><span><span>:</span></span><span><span>aspnetapp
        </span></span><span><span><span>ports</span></span></span><span><span>:</span></span><span><span>
        </span></span><span><span>-</span></span><span><span> </span></span><span><span><span>containerPort</span></span></span><span><span>:</span></span><span><span> </span></span><span><span><span>80</span></span></span><span><span>
        </span></span><span><span><span>volumeMounts</span></span></span><span><span>:</span></span><span><span>
          </span></span><span><span>-</span></span><span><span> </span></span><span><span><span>mountPath</span></span></span><span><span>:</span></span><span><span> </span></span><span><span>/</span></span><span><span>tmp
            </span></span><span><span><span>name</span></span></span><span><span>:</span></span><span><span> diagnostics
      </span></span><span><span>-</span></span><span><span> </span></span><span><span><span>name</span></span></span><span><span>:</span></span><span><span> sidecar
        </span></span><span><span><span>image</span></span></span><span><span>:</span></span><span><span> mcr</span></span><span><span>.</span></span><span><span>microsoft</span></span><span><span>.</span></span><span><span>com</span></span><span><span>/</span></span><span><span>dotnet</span></span><span><span>/</span></span><span><span>nightly</span></span><span><span>/</span></span><span><span>monitor
        </span></span><span><span><span>ports</span></span></span><span><span>:</span></span><span><span>
        </span></span><span><span>-</span></span><span><span> </span></span><span><span><span>containerPort</span></span></span><span><span>:</span></span><span><span> </span></span><span><span><span>52325</span></span></span><span><span>
        </span></span><span><span># </span></span><span><span><span>args</span></span></span><span><span>: [</span></span><span><span><span>"--urls"</span></span></span><span><span>, </span></span><span><span><span>"http://*:52323"</span></span></span><span><span>, </span></span><span><span><span>"--metricUrls"</span></span></span><span><span>, </span></span><span><span><span>"http://*:52325"</span></span></span><span><span>]</span></span><span><span>
        </span></span><span><span><span>volumeMounts</span></span></span><span><span>:</span></span><span><span>
          </span></span><span><span>-</span></span><span><span> </span></span><span><span><span>name</span></span></span><span><span>:</span></span><span><span> diagnostics
            </span></span><span><span><span>mountPath</span></span></span><span><span>:</span></span><span><span> </span></span><span><span>/</span></span><span><span>tmp</span></span></code></pre><p>Unlike other target environments, this configuration does not make the diagnostics endpoint available on your host network. You will need to port forward traffic from your host to your target cluster.</p><p>To do this, obtain the name of the pod you wish to forward traffic to using the <code><span>kubectl</span></code> command:</p><pre><code><span><span>$ kubectl get pod </span></span><span><span>-</span></span><span><span>l app</span></span><span><span>=</span></span><span><span>dotnet</span></span><span><span>-</span></span><span><span>hello</span></span><span><span>-</span></span><span><span>world
NAME                                 READY   STATUS    RESTARTS   AGE
dotnet</span></span><span><span>-</span></span><span><span>hello</span></span><span><span>-</span></span><span><span>world</span></span><span><span>-</span></span><span><span>dc6f67566</span></span><span><span>-</span></span><span><span>t2dzd   </span></span><span><span><span>2</span></span></span><span><span>/</span></span><span><span><span>2</span></span></span><span><span>     </span></span><span><span>Running</span></span><span><span>   </span></span><span><span><span>0</span></span></span><span><span>          </span></span><span><span><span>37</span></span></span><span><span>m</span></span></code></pre><p>Once you have your target pod name, forward traffic using the <code><span>kubectl port</span><span>-</span><span>forward</span></code> command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span><span>$job</span></span></span><span><span> </span></span><span><span>=</span></span><span><span> </span></span><span><span>Start</span></span><span><span>-</span></span><span><span><span>Job</span></span></span><span><span> </span></span><span><span>-</span></span><span><span>ScriptBlock</span></span><span><span> </span></span><span><span>{</span></span><span><span> kubectl port</span></span><span><span>-</span></span><span><span>forward pods</span></span><span><span>/</span></span><span><span>dotnet</span></span><span><span>-</span></span><span><span>hello</span></span><span><span>-</span></span><span><span>world</span></span><span><span>-</span></span><span><span>dc6f67566</span></span><span><span>-</span></span><span><span>t2dzd </span></span><span><span><span>52323</span></span></span><span><span>:</span></span><span><span><span>52323</span></span></span><span><span> </span></span><span><span>}</span></span></code></pre><p>In bash,</p><pre><code><span><span>$ kubectl port</span></span><span><span>-</span></span><span><span>forward pods</span></span><span><span>/</span></span><span><span>dotnet</span></span><span><span>-</span></span><span><span>hello</span></span><span><span>-</span></span><span><span>world</span></span><span><span>-</span></span><span><span>dc</span></span><span><span><span>6f67566</span></span></span><span><span>-</span></span><span><span>t2dzd </span></span><span><span><span>52323</span></span><span><span>:</span></span><span><span>52323</span></span></span><span><span> </span></span><span><span>&gt;/</span></span><span><span>dev</span></span><span><span>/</span></span><span><span>null </span></span><span><span>&amp;</span></span></code></pre><p>Once you have started forwarding traffic from your local network to the desired pod, you can make your desired API call. As an example, you can run the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Invoke</span></span><span><span>-</span></span><span><span>RestMethod</span></span><span><span> </span></span><span><span><span>http</span></span><span><span>:</span></span></span>
</code></pre><p>In bash,</p><pre><code><span><span><span>$ </span></span></span><span><span>curl </span></span><span><span>-</span></span><span><span>s </span></span><span><span><span>http</span></span><span><span>:</span></span></span><span><span>/</span></span><span><span><span>/</span></span><span><span>localhost</span></span><span><span>:</span></span><span><span>52323</span></span><span><span>/</span></span><span><span>processes</span></span></span><span><span> </span></span><span><span>|</span></span><span><span> jq</span></span></code></pre><p>Once you have completed collecting the desired diagnostics artifacts, you can stop forwarding traffic into the container using the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Stop</span></span><span><span>-</span></span><span><span><span>Job</span></span></span><span><span> </span></span><span><span><span>$job</span></span></span><span><span>
PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Remove</span></span><span><span>-</span></span><span><span><span>Job</span></span></span><span><span> </span></span><span><span><span>$job</span></span></span>
</code></pre><p>In bash,</p><pre><code><span><span><span>$ </span></span></span><span><span>pkill kubectl</span></span></code></pre><h3 id="endpoints">Endpoints<a href="#endpoints"></a></h3><p>The REST API exposed by dotnet-monitor exposes the following endpoints:</p><ul><li><code><span>/</span><span>processes</span></code></li><li><code><span>/dump/</span><span>{</span><span>pid</span><span>?}</span></code></li><li><code><span>/gcdump/</span><span>{</span><span>pid</span><span>?}</span></code></li><li><code><span>/trace/</span><span>{</span><span>pid</span><span>?}</span></code></li><li><code><span>/logs/</span><span>{</span><span>pid</span><span>?}</span></code></li><li><code><span>/</span><span>metrics</span></code></li></ul><p>In the sections that follow, we’ll look at the functionality exposed by each of these endpoints and use these endpoints to collect diagnostics artifacts.</p><h3 id="processes">Processes<a href="#processes"></a></h3><p>The <code><span>/</span><span>processes</span></code> endpoint returns a list of target processes accessible to <code><span>dotnet</span><span>-</span><span>monitor</span></code>.</p><p>To get a list of available processes, run the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Invoke</span></span><span><span>-</span></span><span><span>RestMethod</span></span><span><span> http</span></span><span><span>:</span></span><span><span>//localhost:52323/processes</span></span><span><span>

</span></span><span><span><span>pid
</span></span><span><span>---</span></span></span><span><span>
</span></span><span><span><span>  </span></span><span><span>1</span></span></span>
</code></pre><p>In bash,</p><pre><code><span><span>$ curl </span></span><span><span>-</span></span><span><span><span>s</span></span></span><span><span> http</span></span><span><span>:</span></span><span><span><span>//</span></span><span><span>localhost</span></span></span><span><span>:</span></span><span><span><span>52323</span></span></span><span><span>/</span></span><span><span>processes </span></span><span><span>|</span></span><span><span> j</span></span><span><span><span>q
</span></span><span><span>[</span></span><span><span>
  </span></span><span><span>{</span></span><span><span>
    </span></span><span><span>"pid"</span></span><span><span>:</span></span><span><span> </span></span><span><span>1</span></span><span><span>
  </span></span><span><span>}</span></span><span><span>
</span></span><span><span>]</span></span></span>
</code></pre><p>As a convenience, when there is only one accessible process, <code><span>dotnet</span><span>-</span><span>monitor</span></code> does not require you to specify a process id for the remaining diagnostic endpoints.</p><blockquote><p>Known Issue: When running locally the <code><span>dotnet</span><span>-</span><span>monitor</span></code> tools lists itself as one of the target processes.</p></blockquote><h3 id="dump">Dump<a href="#dump"></a></h3><p>The <code><span>/</span><span>dump</span></code> endpoint returns a process dump of the target process.</p><p>To collect a process dump, run the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Start</span></span><span><span>-</span></span><span><span><span>Process</span></span></span><span><span> http</span></span><span><span>:</span></span>
</code></pre><p>In bash,</p><pre><code><span><span><span>$ </span></span></span><span><span>wget </span></span><span><span>--</span></span><span><span>content</span></span><span><span>-</span></span><span><span>disposition </span></span><span><span><span>http</span></span><span><span>:</span></span></span><span><span>/</span></span><span><span><span>/</span></span><span><span>localhost</span></span><span><span>:</span></span><span><span>52323</span></span><span><span>/</span></span><span><span>dump</span></span></span>
</code></pre><p>A dump artifact cannot be analyzed on a machine of a different OS/Architecture than where it was captured. When collecting a dump from a Kubernetes cluster running Linux, the resulting core dump cannot be analyzed on a Windows or a macOS machine. You can however use the existing <a href="https://docs.microsoft.com/dotnet/core/diagnostics/dotnet-dump" target="_blank">dotnet-dump</a> tool to analyze the generated dump in a Docker container using the following commands:</p><pre><code><span><span>docker run </span></span><span><span>--</span></span><span><span>rm </span></span><span><span>-</span></span><span><span>it </span></span><span><span>-</span></span><span><span>v C</span></span><span><span>:</span></span><span><span><span>/</span></span><span><span>dumpFiles</span></span><span><span>:/</span></span></span><span><span>dumpFiles mcr</span></span><span><span>.</span></span><span><span>microsoft</span></span><span><span>.</span></span><span><span>com</span></span><span><span><span>/</span></span><span><span>dotnet</span></span><span><span>/</span></span></span><span><span>sdk </span></span><span><span><span>/</span></span><span><span>bin</span></span><span><span>/</span></span></span><span><span>sh

</span></span><span><span>
dotnet tool install </span></span><span><span>-</span></span><span><span>g dotnet</span></span><span><span>-</span></span><span><span>dump
</span></span><span><span><span>/</span></span><span><span>root</span></span><span><span>/</span></span></span><span><span>.</span></span><span><span>dotnet</span></span><span><span><span>/</span></span><span><span>tools</span></span><span><span>/</span></span></span><span><span>dotnet</span></span><span><span>-</span></span><span><span>dump analyze </span></span><span><span><span>/</span></span><span><span>dumpFiles</span></span><span><span>/</span></span></span><span><span>core_20200618_083349</span></span></code></pre><h3 id="gc-dump">GC Dump<a href="#gc-dump"></a></h3><p>The <code><span>/</span><span>gcdump</span></code> endpoint returns a GC dump of the target process.</p><p>To collect a GC dump, run the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Start</span></span><span><span>-</span></span><span><span><span>Process</span></span></span><span><span> http</span></span><span><span>:</span></span>
</code></pre><p>In bash,</p><pre><code><span><span><span>$ </span></span></span><span><span>wget </span></span><span><span>--</span></span><span><span>content</span></span><span><span>-</span></span><span><span>disposition </span></span><span><span><span>http</span></span><span><span>:</span></span></span><span><span>/</span></span><span><span><span>/</span></span><span><span>localhost</span></span><span><span>:</span></span><span><span>52323</span></span><span><span>/</span></span><span><span>gcdump</span></span></span>
</code></pre><p>Unlike a process dump, a GC dump is a portable format which can be analyzed by Visual Studio and <a href="https://github.com/microsoft/perfview" target="_blank">perfview</a> regardless of the platform it was collected on. To learn more about when to collect GC dumps and how to analyze them, take a look at our <a href="https://devblogs.microsoft.com/dotnet/collecting-and-analyzing-memory-dumps/">earlier blog post</a>.</p><h3 id="traces">Traces<a href="#traces"></a></h3><p>The <code><span>/</span><span>trace</span></code> endpoint returns a trace of the target process. The default trace profile includes sampled CPU stacks, HTTP request start/stop events, and metrics for a duration of 30 seconds.</p><p>The duration of collection can be customized via the <code><span>durationSeconds</span></code> querystring parameter. The diagnostic data present in the trace can be customized via the <code><span>profile</span></code> querystring parameter to include any combination of the preset profiles:</p><ul><li><code><span>CPU</span></code> (CPU profiler),</li><li><code><span>Http</span></code> (Request start/stop events from ASP.NET Core),</li><li><code><span>Logs</span></code> (Logging from the <code><span>EventSourceLogger</span></code> from <code><span>Microsoft</span><span>.</span><span>Extensions</span><span>.</span><span>Logging</span></code> library); and</li><li><code><span>Metrics</span></code>(Runtime and ASP.NET Core <code><span>EventCounters</span></code>).</li></ul><p>For example, a request to <code><span>/</span><span>trace</span><span>?</span><span>profile</span><span>=</span><span>cpu</span><span>,</span><span>logs</span></code> will enable the collection of the CPU profiler and logs.</p><p>In addition to the <code><span>GET</span></code> endpoint, there is <code><span>POST</span></code> version of the endpoint which allows you to specify what <code><span>EventSource</span></code> providers to enable via the request body.</p><p>To collect a trace of the target process, run the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Start</span></span><span><span>-</span></span><span><span><span>Process</span></span></span><span><span> http</span></span><span><span>:</span></span>
</code></pre><p>In bash,</p><pre><code><span><span><span>$ </span></span></span><span><span>wget </span></span><span><span>--</span></span><span><span>content</span></span><span><span>-</span></span><span><span>disposition </span></span><span><span><span>http</span></span><span><span>:</span></span></span><span><span>/</span></span><span><span><span>/</span></span><span><span>localhost</span></span><span><span>:</span></span><span><span>52323</span></span><span><span>/</span></span><span><span>trace</span></span></span>
</code></pre><p>The resulting <code><span>.</span><span>nettrace</span></code> file can be analyzed with both Visual Studio and PerfView.</p><h3 id="logs">Logs<a href="#logs"></a></h3><p>The <code><span>/</span><span>logs</span></code> endpoint will stream logs from the target process for a duration of 30 seconds.</p><p>The duration of collection can be customized via the <code><span>durationSeconds</span></code> querystring parameter. The logs endpoint is capable of returning either newline delimited JSON(<a href="https://github.com/ndjson/ndjson-spec" target="_blank">application/x-ndjson</a>) or the Event stream format(<a href="https://developer.mozilla.org/docs/Web/API/Server-sent_events/Using_server-sent_events#Event_stream_format" target="_blank">text/event-stream</a>) based on the specified <code><span>Accept</span></code> header in the HTTP request.</p><p>To start streaming logs from the target process, run the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Start</span></span><span><span>-</span></span><span><span><span>Process</span></span></span><span><span> http</span></span><span><span>:</span></span>
</code></pre><p>In bash,</p><pre><code><span><span>$ curl </span></span><span><span>-</span></span><span><span>H </span></span><span><span><span>"Accept:application/x-ndjson"</span></span></span><span><span> http</span></span><span><span>://</span></span><span><span>localhost</span></span><span><span>:</span></span><span><span><span>52323</span></span></span><span><span>/</span></span><span><span>logs </span></span><span><span>--</span></span><span><span>no</span></span><span><span>-</span></span><span><span>buffer

</span></span><span><span>{</span></span><span><span><span>"LogLevel"</span></span></span><span><span>:</span></span><span><span><span>"Information"</span></span></span><span><span>,</span></span><span><span><span>"EventId"</span></span></span><span><span>:</span></span><span><span><span>"1"</span></span></span><span><span>,</span></span><span><span><span>"Category"</span></span></span><span><span>:</span></span><span><span><span>"Microsoft.AspNetCore.Hosting.Diagnostics"</span></span></span><span><span>,</span></span><span><span><span>"Message"</span></span></span><span><span>:</span></span><span><span><span>"Request starting HTTP/1.1 GET http://localhost:7001/  "</span></span></span><span><span>,</span></span><span><span><span>"Scopes"</span></span></span><span><span>:{</span></span><span><span><span>"RequestId"</span></span></span><span><span>:</span></span><span><span><span>"0HM0N9ARKHVJK:00000002"</span></span></span><span><span>,</span></span><span><span><span>"RequestPath"</span></span></span><span><span>:</span></span><span><span><span>"/"</span></span></span><span><span>,</span></span><span><span><span>"SpanId"</span></span></span><span><span>:</span></span><span><span><span>"|88c401de-4df03365b379aaa4."</span></span></span><span><span>,</span></span><span><span><span>"TraceId"</span></span></span><span><span>:</span></span><span><span><span>"88c401de-4df03365b379aaa4"</span></span></span><span><span>,</span></span><span><span><span>"ParentId"</span></span></span><span><span>:</span></span><span><span><span>""</span></span></span><span><span>},</span></span><span><span><span>"Arguments"</span></span></span><span><span>:{</span></span><span><span><span>"Protocol"</span></span></span><span><span>:</span></span><span><span><span>"HTTP/1.1"</span></span></span><span><span>,</span></span><span><span><span>"Method"</span></span></span><span><span>:</span></span><span><span><span>"</span></span><span><span><span>GET</span></span></span><span><span>"</span></span></span><span><span>,</span></span><span><span><span>"ContentType"</span></span></span><span><span>:</span></span><span><span>null</span></span><span><span>,</span></span><span><span><span>"ContentLength"</span></span></span><span><span>:</span></span><span><span>null</span></span><span><span>,</span></span><span><span><span>"Scheme"</span></span></span><span><span>:</span></span><span><span><span>"http"</span></span></span><span><span>,</span></span><span><span><span>"Host"</span></span></span><span><span>:</span></span><span><span><span>"localhost:7001"</span></span></span><span><span>,</span></span><span><span><span>"PathBase"</span></span></span><span><span>:</span></span><span><span><span>""</span></span></span><span><span>,</span></span><span><span><span>"Path"</span></span></span><span><span>:</span></span><span><span><span>"/"</span></span></span><span><span>,</span></span><span><span><span>"QueryString"</span></span></span><span><span>:</span></span><span><span><span>""</span></span></span><span><span>}}</span></span><span><span>
</span></span><span><span>{</span></span><span><span><span>"LogLevel"</span></span></span><span><span>:</span></span><span><span><span>"Information"</span></span></span><span><span>,</span></span><span><span><span>"EventId"</span></span></span><span><span>:</span></span><span><span><span>"ExecutingEndpoint"</span></span></span><span><span>,</span></span><span><span><span>"Category"</span></span></span><span><span>:</span></span><span><span><span>"Microsoft.AspNetCore.Routing.EndpointMiddleware"</span></span></span><span><span>,</span></span><span><span><span>"Message"</span></span></span><span><span>:</span></span><span><span><span>"Executing endpoint '/Index'"</span></span></span><span><span>,</span></span><span><span><span>"Scopes"</span></span></span><span><span>:{</span></span><span><span><span>"RequestId"</span></span></span><span><span>:</span></span><span><span><span>"0HM0N9ARKHVJK:00000002"</span></span></span><span><span>,</span></span><span><span><span>"RequestPath"</span></span></span><span><span>:</span></span><span><span><span>"/"</span></span></span><span><span>,</span></span><span><span><span>"SpanId"</span></span></span><span><span>:</span></span><span><span><span>"|88c401de-4df03365b379aaa4."</span></span></span><span><span>,</span></span><span><span><span>"TraceId"</span></span></span><span><span>:</span></span><span><span><span>"88c401de-4df03365b379aaa4"</span></span></span><span><span>,</span></span><span><span><span>"ParentId"</span></span></span><span><span>:</span></span><span><span><span>""</span></span></span><span><span>},</span></span><span><span><span>"Arguments"</span></span></span><span><span>:{</span></span><span><span><span>"EndpointName"</span></span></span><span><span>:</span></span><span><span><span>"/Index"</span></span></span><span><span>,</span></span><span><span><span>"{OriginalFormat}"</span></span></span><span><span>:</span></span><span><span><span>"Executing endpoint '{EndpointName}'"</span></span></span><span><span>}}</span></span></code></pre><h3 id="metrics">Metrics<a href="#metrics"></a></h3><p>The <code><span>/</span><span>metrics</span></code> endpoint will return a snapshot of runtime and ASP.NET Core metrics in the <a href="https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format" target="_blank">prometheus exposition format</a>. Unlike the other diagnostics endpoints, the metrics endpoint will not be available if <code><span>dotnet</span><span>-</span><span>trace</span></code> detects more than one target process. In addition to being accessible via the URLs configured via the <code><span>--</span><span>urls</span></code> parameters, the metrics endpoint is also accessible from the URLs configured via the <code><span>--</span><span>metricUrls</span></code>. When running in Kubernetes, it may be suitable to expose the metrics URL to other services in your cluster to allow them to scrape metrics.</p><p>When deploying in-cluster, a common pattern to collect metrics is to use Prometheus or another monitoring tool to scrape the metrics endpoint exposed by your application. As an example, when running in Azure Kubernetes Services(AKS), you can <a href="https://docs.microsoft.com/azure/azure-monitor/insights/container-insights-prometheus-integration" target="_blank">configure Azure Monitor to scrape prometheus metrics</a> exposed by <code><span>dotnet</span><span>-</span><span>monitor</span></code>. By following the instructions in the linked document, you can enable Azure Monitor to <a href="https://gist.github.com/shirhatti/0222017e8e2fdb481f735002f7bd72f7/revisions" target="_blank">enable monitoring pods</a> that have been <a href="https://gist.github.com/shirhatti/ad7a986137d7ca6b1dc094a3e0a61a0d#file-hello-world-deployment-yaml-L18-L19" target="_blank">annotated</a>.</p><p>Like in the case of the other diagnostics endpoints, it is also possible to view a snapshot of current metrics by running the following command:</p><p>In PowerShell,</p><pre><code><span><span>PS</span></span><span><span>&gt;</span></span><span><span> </span></span><span><span>Invoke</span></span><span><span>-</span></span><span><span>RestMethod</span></span><span><span> </span></span><span><span><span>http</span></span><span><span>:</span></span></span>
</code></pre><p>In bash,</p><pre><code><span><span>$ curl </span></span><span><span>-</span></span><span><span>S http</span></span><span><span>://</span></span><span><span>localhost</span></span><span><span>:</span></span><span><span>52323</span></span><span><span>/</span></span><span><span>metrics

</span></span><span><span>
</span></span><span><span>
systemruntime_alloc_rate_bytes</span></span><span><span><span> </span></span><span><span>96784</span></span><span><span> </span></span></span><span><span>1592899673335</span></span><span><span>
systemruntime_alloc_rate_bytes</span></span><span><span><span> </span></span><span><span>96784</span></span><span><span> </span></span></span><span><span>1592899683336</span></span><span><span>
systemruntime_alloc_rate_bytes</span></span><span><span><span> </span></span><span><span>96784</span></span><span><span> </span></span></span><span><span>1592899693336</span></span><span><span>
</span></span><span><span>
</span></span><span><span>
systemruntime_assembly_count</span></span><span><span><span> </span></span><span><span>136</span></span><span><span> </span></span></span><span><span>1592899673335</span></span><span><span>
systemruntime_assembly_count</span></span><span><span><span> </span></span><span><span>136</span></span><span><span> </span></span></span><span><span>1592899683336</span></span><span><span>
systemruntime_assembly_count</span></span><span><span><span> </span></span><span><span>136</span></span><span><span> </span></span></span><span><span>1592899693336</span></span><span><span>
</span></span><span><span>
</span></span><span><span>
systemruntime_active_timer_count</span></span><span><span><span> </span></span><span><span>1</span></span><span><span> </span></span></span><span><span>1592899673335</span></span><span><span>
systemruntime_active_timer_count</span></span><span><span><span> </span></span><span><span>1</span></span><span><span> </span></span></span><span><span>1592899683336</span></span><span><span>
systemruntime_active_timer_count</span></span><span><span><span> </span></span><span><span>1</span></span><span><span> </span></span></span><span><span>1592899693336</span></span><span><span>
</span></span><span><span>
</span></span>
</code></pre><p>While metrics collection is enabled by default when <code><span>dotnet</span><span>-</span><span>monitor</span></code> detects exactly one target process, it can be configured to disable to collection of metrics entirely via the <code><span>--</span><span>metrics</span></code> parameter. In the example below, metrics collection will not be enabled.</p><pre><code><span><span>dotnet</span></span><span><span><span> monitor </span></span></span><span><span>collect </span></span><span><span>--</span></span><span><span>metrics false</span></span></code></pre><h2 id="roadmap">Roadmap<a href="#roadmap"></a></h2><p>While we are excited about the promise dotnet-monitor holds, it is an experimental project and not a committed product. During this experimental phase we expect to engage deeply with anyone trying out dotnet-monitor to hear feedback and suggestions.</p><p>dotnet-monitor is currently committed as an experiment until .NET 5 ships. At which point we will be evaluating what we have and all that we’ve learnt to decide what we should do in the future.</p><h2 id="conclusion">Conclusion<a href="#conclusion"></a></h2><p>We are excited to introduce the first preview of <code><span>dotnet</span><span>-</span><span>monitor</span></code> and want your feedback. Let us know what we can do to make it easier to diagnose what’s wrong with your dotnet application. We’d love for you to try it out and let us know what you think.</p><p>You can create issues or just follow along with the progress of the project on our <a href="https://github.com/dotnet/diagnostics" target="_blank">GitHub repository</a>.</p></div></div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>