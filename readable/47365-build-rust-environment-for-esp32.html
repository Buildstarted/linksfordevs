<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Build Rust environment for ESP32 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Build Rust environment for ESP32</h1><div><div class="outline-text-2" id="text-orgb5685ec"><div class="org-src-container"><pre class="src src-shell-script">git clone git@github.com:lexxvir/esp32-hello.git  
<span class="org-builtin">cd</span> esp32-hello
rmdir esp-idf
ln -s $<span class="org-variable-name">IDF_PATH</span> esp-idf
</pre></div><p>
Manipulate .carg/config to work with your esp-idf environment.
</p><div class="org-src-container"><pre class="src src-diff"><span class="org-diff-context">diff --git a/.cargo/config b/.cargo/config</span><span class="org-diff-context">index f7c9d09..04a57ef 100644</span><span class="org-diff-function"> target = "xtensa-none-elf"</span><span class="org-diff-context"> [target.xtensa-none-elf]</span><span class="org-diff-context"> rustflags = [</span><span class="org-diff-indicator-added">+</span><span class="org-diff-added">  "-C", "target-cpu=esp32",</span><span class="org-diff-context">   "-C", "save-temps",</span><span class="org-diff-context">   "-C", "link-arg=-nostdlib",</span><span class="org-diff-function"> rustflags = [</span><span class="org-diff-context">   "-C", "link-arg=-Lesp-idf/components/esp32/ld",</span><span class="org-diff-context">   "-C", "link-arg=-Tesp32_out.ld",</span><span class="org-diff-indicator-removed">-</span><span class="org-diff-removed">  "-C", "link-arg=-Tbuild/esp32/esp32.project.ld",</span><span class="org-diff-indicator-added">+</span><span class="org-diff-added">  "-C", "link-arg=-Tbuild/esp32/esp32.common.ld",</span><span class="org-diff-context">   "-C", "link-arg=-Tesp32.rom.ld",</span><span class="org-diff-context">   "-C", "link-arg=-Tesp32.peripherals.ld",</span>
   "-C", "link-arg=-Tesp32.rom.libgcc.ld",
</pre></div><p>
add XARGO_RUST_SRC to setenv.sh
</p><div class="org-src-container"><pre class="src src-shell-script"><span class="org-builtin">echo</span><span class="org-string">"export XARGO_RUST_SRC='$MY_BUILD_ROOT/rust-xtensa/src'"</span> &gt;&gt; setenv.sh
</pre></div><p>
Modify build.sh to use <code>rustup run xtensa xargo</code></p><div class="org-src-container"><pre class="src src-diff"><span class="org-diff-context">diff --git a/build.sh b/build.sh</span><span class="org-diff-context">index e7bcb40..70be266 100755</span><span class="org-diff-function"> source setenv.sh</span><span class="org-diff-context"> # export V=1</span><span class="org-diff-context"> make -j6 app</span><span class="org-diff-indicator-removed">-</span><span class="org-diff-removed">cargo build --release #--verbose</span><span class="org-diff-indicator-added">+</span><span class="org-diff-added">rustup run xtensa xargo build --release #--verbose</span><span class="org-diff-context"> $IDF_PATH/components/esptool_py/esptool/esptool.py \</span>
        --chip esp32 \
</pre></div><p>
Build the sample. <code>target/xtensa-none-elf/release/esp32-hello.bin</code> will appear if successfull.
</p><div class="org-src-container"><pre class="src src-shell-script">./build.sh
ls target/xtensa-none-elf/release/esp32-hello.bin
</pre></div><p>
Flash it.
</p><div class="org-src-container"><pre class="src src-shell-script">python $<span class="org-variable-name">IDF_PATH</span>/components/esptool_py/esptool/esptool.py <span class="org-sh-escaped-newline">\</span>
 --chip esp32 --port /dev/ttyUSB0 --baud 115200 <span class="org-sh-escaped-newline">\</span>
 --before default_reset --after hard_reset write_flash -z --flash_mode dio <span class="org-sh-escaped-newline">\</span>
 --flash_freq 40m --flash_size detect 0x1000 build/bootloader/bootloader.bin 0x10000 <span class="org-sh-escaped-newline">\</span>
 target/xtensa-none-elf/release/esp32-hello.bin <span class="org-sh-escaped-newline">\</span>
 0x8000 build/partitions_singleapp.bin
</pre></div><p>
Connect a LED to GPIO2, you will see  the LED is blinking.
</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>