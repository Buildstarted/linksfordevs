<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How to add an optimization for C# to RyuJIT -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>How to add an optimization for C# to RyuJIT</h1>
    <p class="notranslate"> <ol class="j-transcripts transcripts no-bullet no-style"> <li> 1. How to add an optimization for C#
to JIT compiler
@EgorBo
Engineer at Microsoft </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-2-638.jpg?cb=1568214658"> 2. </a> RuyJIT
From C# to machine code
2
C# IL IR ASM </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-3-638.jpg?cb=1568214658"> 3. </a> float y = x / 2;
float y = x * 0.5f;
Let&#x2019;s start with a simple optimization
3
vdivss (Latency: 20, R.Throughput: 14)
vmulss (Latency: 5, R.Throughput: 0.5)
^ for my MacBook (Haswell) </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-4-638.jpg?cb=1568214658"> 4. </a> X / C
4
double y = x / 2;
float y = x / 2;
double y = x / 10;
double y = x / 8;
double y = x / -0.5;
float x = 48.665f;
Console.WriteLine(x / 10f); // 4.8665
Console.WriteLine(x * 0.1f); // 4.8665004
= x * 0.5
= x * 0.5f
= x * 0.1
= x * 0.125
= x * -2 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-5-638.jpg?cb=1568214658"> 5. </a> X / C &#x2013; let me optimize it in Roslyn!
5
static float GetSpeed(float distance, float time)
{
return distance / time;
}
...
float speed = GetSpeed(distance, 2);
Does Roslyn see &#x201C;X/C&#x201D; here?
NO! It doesn&#x2019;t inline methods </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-6-638.jpg?cb=1568214658"> 6. </a> Where to implement my custom optimization?
6
&#x2022; Roslyn
+ No time constraints
+ It&#x2019;s written in C# - easy to add optimizations, easy to debug and experiment
- No cross-assembly optimizations
- No CPU-dependent optimizations (IL is cross-platform)
- Doesn&#x2019;t know how the code will look like after inlining, CSE, loop optimizations, etc.
- F# doesn&#x2019;t use Roslyn
&#x2022; JIT
+ Inlining, CSE, Loop opts, etc phases create more opportunities for optimizations
+ Knows everything about target platform, CPU capabilities
- Written in C++, difficult to experiment
- Time constraints for optimizations (probably not that important with Tiering)
&#x2022; R2R (AOT)
+ No time constraints (some optimizations are really time consuming, e.g. full escape analysis)
- No CPU-dependent optimizations
- Will be most likely re-jitted anyway?
&#x2022; ILLink Custom Step
+ Cross-assembly IL optimizations
+ Written in C#
+ We can manually de-virtualize types/methods/calls (if we know what we are doing)
- Still no inlining, CSE, etc.. </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-7-638.jpg?cb=1568214658"> 7. </a> RuyJIT: phases
7 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-8-638.jpg?cb=1568214658"> 8. </a> RuyJIT: where to morph my X/C?
8 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-9-638.jpg?cb=1568214658"> 9. </a> GenTree
GenTreeStmt
GenTree
(GenTreeOp)
BasicBlock
GenTree
(GenTreeDblCon)
GenTree
(GenTreeDblCon)
GenTree
(GenTreeCall)
GenTree
(GenTreeLclVar)
static float Test(float x)
{
return Foo(x, 3.14) * 2;
}
Compiler
MUL
2.0
3.14x
Foo </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-10-638.jpg?cb=1568214658"> 10. </a> Dump IR via COMPlus_JitDump </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-11-638.jpg?cb=1568214658"> 11. </a> Back to X/C: Morph IR Tree
static float Calculate(float distance, float v0)
{
return distance / 2 + v0;
}
ADD
DIV
LCL_VAR
(v0)
CNS_DBL
(2.0)
LCL_VAT
(distance)
ADD
MUL
LCL_VAR
(v0)
CNS_DBL
(0.5)
LCL_VAR
(distance)
Morph </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-12-638.jpg?cb=1568214658"> 12. </a> Implementing the opt in morph.cpp
DIV
op2op1 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-13-638.jpg?cb=1568214658"> 13. </a> Inspired by GT_ROL
13
/// &lt;summary&gt;
/// Rotates the specified value left by the specified number of bits.
/// &lt;/summary&gt;
public static uint RotateLeft(uint value, int offset)
=&gt; (value &lt;&lt; offset) | (value &gt;&gt; (32 - offset));
OR ROL
/ / / / LSH RSZ =&gt; x y
/ / x AND x AND
/ / y 31 ADD 31
/ NEG 32
|
y
rol eax, cl </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-14-638.jpg?cb=1568214658"> 14. </a> 15
&quot;Hello&quot;.Length -&gt; 5
static void Append(string str)
{
if (str.Length &lt;= 2)
QuickAppend(str);
else
SlowAppend(str);
}
...
builder.Append(&quot;/&gt;&quot;);
builder.QuickAppend(&quot;/&gt;&quot;);
Inline, remove if (2 &lt;= 2) </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-15-638.jpg?cb=1568214658"> 15. </a> 16
&quot;Hello&quot;.Length =&gt; 5
ARR_LENGTH
CNS_STR
(ScpHnd, SconCPX)
CNS_INT
(5)
VM
case GT_ARR_LENGTH:
{
if (op1-&gt;OperIs(GT_CNS_STR))
{
GenTreeStrCon* strCon = op1-&gt;AsStrCon();
int len = info.compCompHnd-&gt;getStringLength(
strCon-&gt;gtScpHnd, strCon-&gt;gtSconCPX);
return gtNewIconNode(len);
}
break;
}
JIT &lt;-&gt; VM
Interface
op1
Access VM&#x2019;s data from JIT </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-16-638.jpg?cb=1568214658"> 16. </a> 17
bool Test1(int x) =&gt; x % 4 == 0; bool Test1(int x) =&gt; x &amp; 3 == 0;
MOD
EQ/NE
CNS_INT
(0)
CNS_INT
(4)
anything
op1 op2
op2op1
AND
EQ/NE
CNS_INT
(0)
CNS_INT
(3)
anything
op1 op2
op2op1 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-17-638.jpg?cb=1568214658"> 17. </a> Roslyn and &#x201C;!=&#x201C; operator
(unexpected optimization)
18
public static bool Test1(int x) =&gt; x != 42;
public static bool Test2(int x) =&gt; x != 0;
IL_0000: ldarg.0
IL_0001: ldc.i4.42
IL_0002: ceq
IL_0004: ldc.i4.0
IL_0005: ceq
IL_0007: ret
IL_0000: ldarg.0
IL_0001: ldc.i4.0
IL_0002: cgt.un
IL_0004: ret
return (uint)x &gt; 0
return (x == 42) == false
JIT: ok, it&#x2019;s GT_NE
JIT: what?.. ok, GT_GT </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-18-638.jpg?cb=1568214658"> 18. </a> 19
Math.Pow(x, 2)
Math.Pow(x, 1)
Math.Pow(x, 4)
Math.Pow(x, -1)
// can be added:
Math.Pow(42, 3)
Math.Pow(1, x)
Math.Pow(2, x)
Math.Pow(x, 0)
Math.Pow(x, 0.5)
| x * x
| x
| x * x * x * x
| 1 / x
| 74088
| 1
| exp2(x)
| 1
| sqrt(x) </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-19-638.jpg?cb=1568214658"> 19. </a> Range check elimination
20 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-20-638.jpg?cb=1568214658"> 20. </a> Range check elimination
21
public static void Test(int[] a)
{
a[0] = 4;
a[1] = 2;
for (int i = 0; i &lt; a.Length; i++)
{
a[i] = 0;
}
a[1] = 2;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-21-638.jpg?cb=1568214658"> 21. </a> Range check elimination
22
public static void Test(int[] a)
{
if (a.Length &lt;= 0) throw new IndexOutOfRangeException();
a[0] = 4;
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
for (int i = 0; i &lt; a.Length; i++)
{
if (a.Length &lt;= i) throw new IndexOutOfRangeException();
a[i] = 0;
}
if (a.Length &lt;= 2) throw new IndexOutOfRangeException();
a[1] = 2;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-22-638.jpg?cb=1568214658"> 22. </a> Range check elimination
23
public static void Test(int[] a)
{
if (a.Length &lt;= 0) throw new IndexOutOfRangeException();
a[0] = 4;
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
for (int i = 0; i &lt; a.Length; i++)
{
if (a.Length &lt;= i) throw new IndexOutOfRangeException();
a[i] = 0;
}
if (a.Length &lt;= 2) throw new IndexOutOfRangeException();
a[1] = 2;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-23-638.jpg?cb=1568214658"> 23. </a> Range check elimination
24
public static void Test(int[] a)
{
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[0] = 4;
for (int i = 0; i &lt; a.Length; i++)
{
if (a.Length &lt;= i) throw new IndexOutOfRangeException();
a[i] = 0;
}
if (a.Length &lt;= 2) throw new IndexOutOfRangeException();
a[1] = 2;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-24-638.jpg?cb=1568214658"> 24. </a> Range check elimination
25
public static void Test(int[] a)
{
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
a[0] = 4;
for (int i = 0; i &lt; a.Length; i++)
{
a[i] = 0;
}
a[1] = 2;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-25-638.jpg?cb=1568214658"> 25. </a> rangecheck.cpp (simplified)
26
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-26-638.jpg?cb=1568214658"> 26. </a> rangecheck.cpp (simplified)
27
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-27-638.jpg?cb=1568214658"> 27. </a> rangecheck.cpp (simplified)
28
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-28-638.jpg?cb=1568214658"> 28. </a> Byte array
29
private static readonly byte[] _data =
new byte[256] { 1, 2, 3, &#x2026; };
public static byte GetByte(int i)
{
return _data[i];
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-29-638.jpg?cb=1568214658"> 29. </a> Byte array: Roslyn hack (new feature)
30
private static ReadOnlySpan&lt;byte&gt; _data =&gt;
new byte[256] { 1, 2, 3, &#x2026; };
public static byte GetByte(int i)
{
return _data[i];
}
256 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-30-638.jpg?cb=1568214658"> 30. </a> Byte array: byte index (my PR)
31
private static ReadOnlySpan&lt;byte&gt; _data =&gt;
new byte[256] { 1, 2, 3, &#x2026; };
public static byte GetByte(int i)
{
return _data[(byte)i];
}
Byte indexer will never go out of bounds! </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-31-638.jpg?cb=1568214658"> 31. </a> rangecheck.cpp (simplified)
32
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
}
[Byte.MinValue ... Byte.MaxValue]
ArrLen = 256 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-32-638.jpg?cb=1568214658"> 32. </a> Loop optimizations
33 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-33-638.jpg?cb=1568214658"> 33. </a> Loop Invariant Code Hoisting
34
public static bool Test(int[] a, int c)
{
for (int i = 0; i &lt; a.Length; i++)
{
if (a[i] == c + 44)
return false;
}
return true;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-34-638.jpg?cb=1568214658"> 34. </a> Loop Invariant Code Hoisting
35
public static bool Test(int[] a, int c)
{
int tmp = c + 44;
for (int i = 0; i &lt; a.Length; i++)
{
if (a[i] == tmp)
return false;
}
return true;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-35-638.jpg?cb=1568214658"> 35. </a> NYI: Loop-unrolling
36
public static int Test(int[] a)
{
int sum = 0;
for (int i = 0; i &lt; a.Length; i++)
{
sum += a[i];
}
return sum;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-36-638.jpg?cb=1568214658"> 36. </a> NYI: Loop-unrolling
37
public static int Test(int[] a)
{
int sum = 0;
for (int i = 0; i &lt; a.Length - 3; i += 4)
{
sum += a[i];
sum += a[i+1];
sum += a[i+2];
sum += a[i+3];
}
return sum;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-37-638.jpg?cb=1568214658"> 37. </a> NYI: Loop-unswitch
38
public static int Test(int[] a, bool condition)
{
int agr = 0;
for (int i = 0; i &lt; a.Length; i++)
{
if (condition)
agr += a[i];
else
agr *= a[i];
}
return agr;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-38-638.jpg?cb=1568214658"> 38. </a> NYI: Loop-unswitch
39
public static int Test (int[] a, bool condition)
{
int agr = 0;
if (condition)
for (int i = 0; i &lt; a.Length; i++)
agr += a[i];
else
for (int i = 0; i &lt; a.Length; i++)
agr *= a[i];
return agr;
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-39-638.jpg?cb=1568214658"> 39. </a> NYI: Loop-deletion
40
public static void Test()
{
for (int i = 0; i &lt; 10; i++) { }
}
; Method Program:Test()
G_M44187_IG01:
G_M44187_IG02:
xor eax, eax
G_M44187_IG03:
inc eax
cmp eax, 10
jl SHORT G_M44187_IG03
G_M44187_IG04:
ret
; Total bytes of code: 10 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-40-638.jpg?cb=1568214658"> 40. </a> NYI: Loop-deletion
41
public static void Test()
{
}
; Method Program:DeadLoop()
ret
; Total bytes of code: 1 </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-41-638.jpg?cb=1568214658"> 41. </a> NYI: InductiveRangeCheckElimination
42
public static void Zero1000Elements(int[] array)
{
for (int i = 0; i &lt; 1000; i++)
array[i] = 0; // bound checks will be inserted here
} </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-42-638.jpg?cb=1568214658"> 42. </a> NYI: InductiveRangeCheckElimination
43
public static void Zero1000Elements(int[] array)
{
int limit = Math.Min(array.Length, 1000);
for (int i = 0; i &lt; limit; i++)
array[i] = 0; // bound checks are not needed here!
for (int i = limit; i &lt; 1000; i++)
array[i] = 0; // bound checks are needed here
// so at least we could &quot;zero&quot; first `limit` elements without bound checks
}
NOTE: this LLVM optimization pass is not enabled by default in `opt &#x2013;O2`.
Contributed by Azul developers (LLVM for JVM) </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-43-638.jpg?cb=1568214658"> 43. </a> NYI: InductiveRangeCheckElimination
44
public static void Zero1000Elements(int[] array)
{
int limit = Math.Min(array.Length, 1000);
for (int i = 0; i &lt; limit - 3; i += 4)
{
array[i] = 0;
array[i+1] = 0;
array[i+2] = 0;
array[i+3] = 0;
}
for (int i = limit; i &lt; 1000; i++)
array[i] = 0; // bound checks are needed here
// so at least we could &quot;zero&quot; first `limit` elements without bound checks
}
Now we can even unroll the first loop! </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-44-638.jpg?cb=1568214658"> 44. </a> NYI: InductiveRangeCheckElimination
45
public static void Zero1000Elements(int[] array)
{
int limit = Math.Min(array.Length, 1000);
memset(array, 0, limit);
for (int i = limit; i &lt; 1000; i++)
array[i] = 0; // bound checks are needed here
// so at least we could &quot;zero&quot; first `limit` elements without bound checks
}
Or just replace with memset call </li> <li> <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-45-638.jpg?cb=1568214658"> 45. </a> Q&amp;A
Twitter: EgorBo </li> </ol> </p>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>