<!DOCTYPE html>
<html lang="en">
<head>
    <title>
tabs &#x21B9; over &#x2423; &#x2423; &#x2423; spaces -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>tabs &#x21B9; over &#x2423; &#x2423; &#x2423; spaces</h1>
    <div><article> <p>Pretty stupid question, right? Because if it&#x2019;s more than, say, 20 or 100, it&#x2019;s enough. But still. Where is the limit?</p> <p>We can look at this in, at least, two ways. First is obviously what the runtime is willing to load and the other is what Roslyn is able to compile. And there&#x2019;s a good chance, that these two limits are the same.</p>
<h4>Roslyn</h4>
<p>Let&#x2019;s first check the compiler, because that&#x2019;s how most people would create such type. Obviously, I&#x2019;m not going to type that type manually, but I&#x2019;m going to use T4. With the code below you can easily try that the limit is <code>65535</code> or <code>2^16 - 1</code> using the current .NET Core 3.0.</p>
<pre><code class="language-text">&lt;#@ assembly name=&quot;System.Core&quot; #&gt;
&lt;#@ assembly name=&quot;System.Runtime&quot; #&gt;
&lt;#@ import namespace=&quot;System.Linq&quot; #&gt;
&lt;#@ import namespace=&quot;System.Collections.Generic&quot; #&gt;
&lt;#
IEnumerable&lt;long&gt; Range(long start, long end)
{
	for (var i = start; i &lt; end; i++)
		yield return i;
}
IEnumerable&lt;T&gt; Repeat&lt;T&gt;(T value, long count)
{
	for (var i = 0; i &lt; count; i++)
		yield return value;
}

const int Max = 65535;
var ts = string.Join(&quot;, &quot;, Range(0, Max).Select(x =&gt; $&quot;T{x}&quot;));
var referenceTypes = string.Join(&quot;, &quot;, Repeat(&quot;string&quot;, Max));
var valueTypes = string.Join(&quot;, &quot;, Repeat(&quot;int&quot;, Max));
#&gt;
namespace ConsoleApp1
{
	class RealGenericClass&lt;&lt;#=ts#&gt;&gt;
	{
	}
	static class RealGenericClass
	{
		public static RealGenericClass&lt;&lt;#=referenceTypes#&gt;&gt; CreateWithReferenceTypes() =&gt; new RealGenericClass&lt;&lt;#=referenceTypes#&gt;&gt;();
		public static RealGenericClass&lt;&lt;#=valueTypes#&gt;&gt; CreateWithValueTypes() =&gt; new RealGenericClass&lt;&lt;#=valueTypes#&gt;&gt;();
	}
}
</code></pre>
<h4>Reflection.Emit</h4>
<p>Another way, way less common yet somewhat in the middle, is using <code>Reflection.Emit</code>. In my case there&#x2019;s not much to emit, just define type and try to load it. With the simple code below the process fails again at <code>65535</code>/<code>2^16 - 1</code>.</p>
<pre><code class="language-csharp">static void ReflectionEmit()
{
	var assemblyBuilder = AssemblyBuilder.DefineDynamicAssembly(new AssemblyName(&quot;Dummy&quot;), AssemblyBuilderAccess.Run);
	var moduleBuilder = assemblyBuilder.DefineDynamicModule(&quot;Dummy&quot;);
	var typeBuilder = moduleBuilder.DefineType(&quot;RealGenericClass&quot;, TypeAttributes.Class);
	typeBuilder.DefineGenericParameters(Ts().ToArray());
	var generic = typeBuilder.CreateType();
	var t = generic.MakeGenericType(Repeat(typeof(int), Max).ToArray());
	var instance = Activator.CreateInstance(t);
	Console.WriteLine(instance);

	static IEnumerable&lt;string&gt; Ts()
	{
		return Range(0, Max).Select(x =&gt; $&quot;T{x}&quot;);
	}

	static IEnumerable&lt;long&gt; Range(long start, long end)
	{
		for (var i = start; i &lt; end; i++)
			yield return i;
	}

	static IEnumerable&lt;T&gt; Repeat&lt;T&gt;(T value, long count)
	{
		for (var i = 0; i &lt; count; i++)
			yield return value;
	}
}
</code></pre>
<p>Maybe if I create the assembly using some non-.NET-provided library (where the limitations are probably aligned), I might get lucky&#x2026;</p>
<h4>Manual assembly creation using <em>Mono.Cecil</em></h4>
<p>I took the trusty <a href="https://www.mono-project.com/docs/tools+libraries/libraries/Mono.Cecil/"><em>Mono.Cecil</em></a> library and started generating. Here&#x2019;s the important part.</p>
<pre><code class="language-csharp">var typeDefinition = new Mono.Cecil.TypeDefinition(&quot;ConsoleApp1&quot;, &quot;RealGenericClass&quot;, Mono.Cecil.TypeAttributes.Class, baseType);
foreach (var item in Ts())
{
	typeDefinition.GenericParameters.Add(new Mono.Cecil.GenericParameter(item, typeDefinition));
}
assemblyDefinition.MainModule.Types.Add(typeDefinition);

static IEnumerable&lt;string&gt; Ts()
{
	return Range(0, Max).Select(x =&gt; $&quot;T{x}&quot;);
}

static IEnumerable&lt;long&gt; Range(long start, long end)
{
	for (var i = start; i &lt; end; i++)
		yield return i;
}
</code></pre>
<p>Sadly, although I was able to create type with more than <code>65535</code> generic parameters, runtime refuses to load it with known <code>Internal limitation: Too many generic arguments.</code>. Fair enough, I think.</p>
<p>Surprisingly <em>ildasm</em> shows the type. And <em>ILSpy</em> wraps over the <code>2^16</code> and shows just two generic arguments for my type with 65538 of these.</p>
<p><img src="https://i.tabsoverspaces.com/233802/65538_generics.png" alt="Type with 65538 generic arguments in ildasm"></p>
<h4>Closing</h4>
<p>I think <code>65535</code> of generic parameters is fair. It&#x2019;s way beyond what would person type or use manually. And for generated code, well, I think it&#x2019;s still plenty and if you need more, I&#x2019;m sure, given it&#x2019;s generated code, you can find way around it.</p>
<p>What&#x2019;s the biggest generic type you&#x2019;ve ever created?</p> </article><article> <p class="bio"> <a href="/about"><img src="/assets/bio_image.png" alt="Profile Picture"></a> Ji&#x159;&#xED; &#x10C;in&#x10D;ura is an independent developer focusing on data and business layers, language constructs, parallelism and databases. Specifically Entity Framework, asynchronous and parallel programming, cloud and Azure. He&apos;s Microsoft Most Valuable Professional and you can read his articles, guides, tips and tricks at www.tabsoverspaces.com. </p> </article></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>