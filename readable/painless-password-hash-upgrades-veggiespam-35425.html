<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Painless Password Hash Upgrades - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Painless Password Hash Upgrades - linksfor.dev(s)"/>
    <meta property="article:author" content="About The Authors"/>
    <meta property="og:description" content="Background &amp; Summary Existing websites and applications implementing an older password hashing algorithm like MD5 or SHA1 must be upgraded to a more secure algorithm. Both of these older algori&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://veggiespam.com/painless-password-hash-upgrades/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Painless Password Hash Upgrades</title>
<div class="readable">
        <h1>Painless Password Hash Upgrades</h1>
            <div>by About The Authors</div>
            <div>Reading time: 22-27 minutes</div>
        <div>Posted here: 06 Sep 2019</div>
        <p><a href="https://veggiespam.com/painless-password-hash-upgrades/">https://veggiespam.com/painless-password-hash-upgrades/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="primary">
		<main id="main" role="main">

		
			
<article id="post-733">

	
<!-- .entry-header -->
	
	<div id="xsbf-entry-content">
		
<p>Existing websites and applications implementing an older password hashing algorithm like MD5 or SHA1 must be upgraded to a more secure algorithm. Both of these older algorithms are obsolete &amp; breakable and if an attacker obtains those hashes from a lost backup tape or website vulnerability, the attacker could make quick work of determining your user’s passwords via Rainbow Tables<sup><a href="#ref">†</a></sup>. And since 55% of users <sup><a href="#ref">‡</a></sup> use the same password on many different websites, your compromise exposes your users elsewhere too. Ideally, this migration from insecure to secure hashes must be done without downtime or forcing a password reset situation across the entire user base.</p>
<p>It is relatively straight-forward to upgrade to new hashing algorithms, such as SHA-512 or Scrypt; this blog post gives you the steps for this upgrade and to implement salting while you’re retrofitting the password system. We also give you advice on how to integrate over time instead of all at once. If you’re already using Spring Security, this migration can be done nearly transparently and we will show you how to implement it.</p>
<p>This blog post was co-written by Siddharth Coontoor and Jay Ball after teaching a security class where the students in all three sessions asked the same question: “How do we upgrade MD5 password hashes in our database without impacting our end users.”</p>

<p>Generally, on most websites, the code to implement username &amp; password validation might look something like this pseudo-code:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641a4804666756" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>username</span><span> </span><span>=</span><span> </span><span>POST</span><span>[</span><span>'username'</span><span>]</span></p><p><span>password</span><span> </span><span>=</span><span> </span><span>POST</span><span>[</span><span>'password'</span><span>]</span></p><p><span>passwordhash</span><span> </span><span>=</span><span> </span><span>hexstr</span><span>(</span><span>md5</span><span>(</span><span>password</span><span>)</span><span>)</span><span>&nbsp;&nbsp; </span><span>// hex-formatted string of MD5 hash</span></p><p><span>user_id</span><span> </span><span>=</span><span> </span><span>SQL_call</span><span>(</span><span>'select user_id from users where username=$1 and passwordhash=$2'</span><span>,</span><span> </span><span>username</span><span>,</span><span> </span><span>passwordhash</span><span>)</span></p><p><span>if</span><span> </span><span>user_id</span><span> </span><span>&lt;=</span><span> </span><span>0</span><span> </span><span>and</span><span> </span><span>no_exception_thrown</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// no username + passwordhash match</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// return error to end user</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exit</span></p><p><span>}</span></p><p><span>user_object</span><span> </span><span>=</span><span> </span><span>get_user_data</span><span>(</span><span>user_id</span><span>)</span></p><p><span>// show welcome page for user</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->

<p>From the above, replacing line 4 with <code>passwordhash = hexstr( sha512(password) )</code> seems tempting, but that would invalidate all existing passwords instantly. Remember that all passwords in the database are currently MD5, so the quick code replacement can’t be done. There must be an interim step – we need to determine the current type of hash used.</p>
<p>There are a few mechanisms for determining the type of hash. One manner is to create a new column in the database with the hash type. When the new column is added, set the value to be <code>1</code> for all users since everyone starts out using the legacy MD5. So, the code might be:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641ae021582124" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>hash_type</span><span> </span><span>=</span><span> </span><span>SQL_call</span><span>(</span><span>'select hash_type from users where username=$1'</span><span>,</span><span> </span><span>username</span><span>)</span></p><p><span>if</span><span> </span><span>hash_type</span><span> </span><span>==</span><span> </span><span>1</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>passwordhash</span><span> </span><span>=</span><span> </span><span>hexstr</span><span>(</span><span>md5</span><span>(</span><span>password</span><span>)</span><span>)</span></p><p><span>}</span><span> </span><span>elseif</span><span> </span><span>hash_type</span><span> </span><span>==</span><span> </span><span>2</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>passwordhash</span><span> </span><span>=</span><span> </span><span>hexstr</span><span>(</span><span>sha512</span><span>(</span><span>password</span><span>)</span><span>)</span></p><p><span>}</span><span> </span><span>else</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// raise an internal error</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>That is one mechanism; another is by checking the length the existing hash. This method has the advantage that another database column does not need to be created to determine hash type. For the common hashes, this table shows lengths of each:</p>

<table>
<thead>
<tr>
<th>Hash</th>
<th>Digest Bits</th>
<th>Bytes</th>
<th>Hex Bytes</th>
<th>Base64 Bytes</th>
<th>Effective Security Bits</th>
<th>MCF Prefix</th>
</tr>
</thead>
<tbody>
<tr>
<td>DES</td>
<td>56</td>
<td>7</td>
<td>14</td>
<td>12</td>
<td>39-43</td>
<td>(none)</td>
</tr>
<tr>
<td>MD5</td>
<td>128</td>
<td>16</td>
<td>32</td>
<td>24</td>
<td>&lt;64</td>
<td>$1$</td>
</tr>
<tr>
<td>SHA-1</td>
<td>160</td>
<td>20</td>
<td>40</td>
<td>28</td>
<td>&lt;63</td>
<td></td>
</tr>
<tr>
<td>SHA-2 256</td>
<td>256</td>
<td>32</td>
<td>64</td>
<td>44</td>
<td>128</td>
<td>$5$</td>
</tr>
<tr>
<td>SHA-2 512</td>
<td>512</td>
<td>64</td>
<td>128</td>
<td>88</td>
<td>256</td>
<td>$6$</td>
</tr>
<tr>
<td>SHA-2 512/256</td>
<td>256</td>
<td>32</td>
<td>64</td>
<td>44</td>
<td>128</td>
<td></td>
</tr>
<tr>
<td>Bcrypt</td>
<td>184</td>
<td>23</td>
<td>46</td>
<td>32</td>
<td></td>
<td>$2$, $2a$, $2x$, $2y$ $2b$</td>
</tr>
<tr>
<td>Scrypt</td>
<td>(variable)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>PBKDF1</td>
<td>160</td>
<td>20</td>
<td>40</td>
<td>28</td>
<td></td>
<td></td>
</tr>
<tr>
<td>PBKDF2</td>
<td>(variable)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>And this code block would use the hash length to determine the hash type:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641b6953996940" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>hash_size</span><span> </span><span>=</span><span> </span><span>SQL_call</span><span>(</span><span>'select length(password) from users where username=$1'</span><span>,</span><span> </span><span>username</span><span>)</span></p><p><span>if</span><span> </span><span>hash_size</span><span> </span><span>==</span><span> </span><span>XXX</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>passwordhash</span><span> </span><span>=</span><span> </span><span>hexstr</span><span>(</span><span>md5</span><span>(</span><span>password</span><span>)</span><span>)</span></p><p><span>}</span><span> </span><span>elseif</span><span> </span><span>hash_size</span><span> </span><span>==</span><span> </span><span>XXX</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>passwordhash</span><span> </span><span>=</span><span> </span><span>hexstr</span><span>(</span><span>sha512</span><span>(</span><span>password</span><span>)</span><span>)</span></p><p><span>}</span><span> </span><span>else</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// raise an internal error</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>As can be seen from the table, there are conflicts, such as SHA-1 and PBKDF1 are both 160 bits. Thus, if using this mechanism for differentiating hash types, the designers must ensure that any future implementations take care to use different sizes; otherwise older passwords will be lost during the migration process. Alternatively, additional logic could be employed to handle newer passwords of length 160 versus older ones of length 160 (like checking last password change date).</p>
<p>A third option is to embed the hash type into the password column itself along with the password hash. Before we describe this, let’s make a small segue into the database schema. Many applications are designed to limit the size of the columns in the database to only what is required. If the system had allocated only enough space for md5, the password column could be a <code>CHAR(32)</code> – enough for a 32-hex digit string. Thus, if switching the password hash algorithm, you must also remember to increase the size of the password column in the database to an appropriately large size.</p>
<p>When embedding the hash type and password hash together, it requires some type of defined format to encompass the hash type and hash value. As such, a delimiter between the hash type and password hash must be used and for that, it is suggested to use a dollar sign ($). The choice of this glyph is meaningful as $ is not a valid base64 or hex character. Another choice could be a colon, but the colon was already used in Unix password/shadow file in the form of username:password_hash. In modern contexts, the colon is also used in Basic-Auth passwords and for JSON strings. Colons would require special escape sequences which would vary depending on the context. The dollar also allows migration from older algorithms to newer.</p>
<p>For example, <code>$algorithm$salt_followed_by_hashed_password$</code> could be placed in the password column. The first part indicates the hash algorithm whose value might be SHA-512 and the remaining part would be the hash itself. If no dollar sign is in the column, then the password hash is assumed to be whatever legacy algorithm has been implemented by the system. As passwords are changed, the new storage format will be used.</p>
<p>The idea of the dollar-delimited fields can be expanded. On many Unix systems, the passwords are stored using the Modular Crypt Format (MCF), which is basically an expanded version of the above. These versions of Unix modified the standard system <code>crypt()</code> function call to utilize alternate algorithms. The crypt function expects two arguments, one is the password and the other the salt. If the salt were to begin with $, then the argument would be parsed for which algorithm to use and processed appropriately; otherwise the legacy crypt/DES mechanisms would be used. By implementing hashing in this manner, even older software could become updated to utilize modern hashes with (possibly) no code changes. In addition, because it was a silent modification to the system call, higher-level languages like Python automatically inherited the advanced features.</p>
<p>However, MCF is not standardized across the various Unix platforms. Not all versions of crypt support all algorithms. Some implementations place a $ at the end, others have different names for the same algorithm and the same name for different algorithms (as shown the MCF column in the table above). Overall, MCF is a starting point, not something we recommend.</p>
<p>The authors of Passlib, a Python-based password hashing library, attempted to document the various implementations of MCF and eventually concluded it needed to be replaced. Thus, they now recommend using the Password Hash Committee (PHC) specification which is basically:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641bf943505056" data-settings=" minimize scroll-mouseover">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>$</span><span>algorithm_id</span><span>$</span><span>param</span><span>=</span><span>value</span><span>(</span><span>,</span><span>p</span><span>=</span><span>v</span><span>.</span><span>.</span><span>.</span><span>)</span><span>$</span><span>salt</span><span>$</span><span>hash</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
</div>
<p>with each component having an explicit definition and format.</p>
<ul>
<li><code>algorithm_id</code> is the symbolic name for the function</li>
<li><code>param</code> is a parameter name</li>
<li><code>value</code> is a parameter value</li>
<li><code>salt</code> is an encoding of the salt (modified base64)</li>
<li><code>hash</code> is an encoding of the hash output (modified base64)</li>
</ul>
<p>Here is an example of a PHC string from the Passlib folks:</p>
<div><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641c3793516008" data-settings=" minimize scroll-mouseover">
		
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>$</span><span>5</span><span>$</span><span>rounds</span><span>=</span><span>80000</span><span>$</span><span>60Y7mpmAhUv6RDvj</span><span>$</span><span>AdseAOq6bKUZRDRTr</span><span>/</span><span>2QK1t38qm3P6sYeXhXKnBAmg0</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
</div>
<p>Which corresponds to</p>
<ul>
<li><code>algorithm_id</code>=5 which is SHA2-256</li>
<li><code>param=value</code> of rounds=80000 meaning, run SHA2-256(SHA2-256(… 80000 times</li>
<li><code>salt</code> of 60Y7mpmAhUv6RDvj</li>
<li><code>hash</code> of AdseAOq6bKUZRDRTr/2QK1t38qm3P6sYeXhXKnBAmg0</li>
</ul>
<p>This entire PHC password code was generated from a plaintext password of “fooey” and the salt above.</p>
<p>While Passlib can manage PHC hash strings and offers bindings for non-Python languages like Java, it might not be the best choice for legacy applications. For your application, it may not even be necessary to implement an official PHC-compliant specification, only one use the concepts shown above. Before “rolling your own” implementation, see if another library implements some portions of the above.</p>

<p>Spring Security uses some of these concepts as part of its PasswordEncoder structure and includes support for SHA2-256, PBKDF2, Bcrypt, &amp; Scrypt with automatic salts and extra rounds of hashing. It also stores all of these parameters in the password field in the database. This password hashing mechanism also integrated with the login process.</p>
<p>For instance, we have an existing Spring application containing all user passwords stored as instances of MD5 hashes in the database.<br>
<img src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=603%2C196&amp;is-pending-load=1#038;ssl=1" alt="" width="603" height="196" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?w=603&amp;ssl=1 603w, https://i2.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=300%2C98&amp;ssl=1 300w" data-lazy-sizes="(max-width: 603px) 100vw, 603px" data-lazy-src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=603%2C196&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>Using Spring Security as an EE filter chain there are a few ways we can migrate our user’s passwords from MD5 hashes to iterative hashing function like PBKDF2.</p>
<ol>
<li><strong>Approach 1:</strong> Upgrade algorithm upon authentication. This approach has minimal or no impact to the end user. When user attempts to login to the application, we retrieve the user password from the database and identify whether the hashing algorithm is MD5. If it is MD5, then hash the user-provided password from the request using MD5 and match it with the hash retrieved in the database. If they match, the user is authenticated and the software will automatically upgrade the user password into PBKDF2 and replace the MD5 version into database. This approach should have no impact on the end user.</li>
<li><strong>Approach 2:</strong> Force-password change, then upgrade algorithm. This approach impacts the user as we force all users who authenticate to the application to be redirected to a password change page where they are forced to change their passwords before they can continue. This password change module would use the PBKDF2 to hash the user provided passwords and store them into the database. This approach has a few advantages because this gives the application developers a chance to enforce new password complexity policies immediately. Also, this approach provides assurance to the application owners that any passwords which were compromised or password hashes which were leaked in the past can no longer be leveraged to hijack the victim’s account. A large disadvantage is that all users will change their passwords in quick succession, which could increase helpdesk calls.</li>
<li><strong>Approach 3:</strong> Upgrade now, change password later. In this approach the application team can run a custom stored procedure on their database to force a password change at a later date. The stored procedure would look at the last login time for each user and set a column like <code>enforceChangePwdOnNextLogin</code> in the users table to true depending on whether they changed their password before or after the roll-out of the password migration process. When the users authenticate, the application checks this column and if true, the application redirects the authenticated users to a change password page where the application transform the new password to PBDFK2 and then store it into the database. At this point, ensure that the <code>enforceChangePwdOnNextLogin</code> is also set to false so that the application does not redirect the user to change password page next time they login.</li>
</ol>
<p>Depending on your business requirement, Spring Security can support you with all of these approaches irrespective of whether your application is legacy J2EE or a Spring MVC application.</p>
<p>For our demonstration, we will go with the first approach. The password migration process requires you to tweak the existing Spring Security authentication workflow.</p>
<p>One of the ways to do the migration is by rolling out a custom authentication module by implementing AuthenticationProvider class.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641cc763027767" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>class</span><span> </span><span>CustomAuthenticationProvider </span><span>implements</span><span> </span><span>AuthenticationProvider</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>Once you implement <code>AuthenticationProvider</code>, you will need to implement all of its abstract methods including the <code>authenticate()</code> function. This <code>authenticate()</code> function is responsible for the following:</p>
<ol>
<li>Identifying whether existing user password hash is MD5 or PBKDF2.</li>
<li>Authenticating users who are still on MD5 and migrating them to PBKDF2.</li>
<li>Authenticating users who have already migrated to PBKDF2.</li>
</ol>
<p>The implementation of this is:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641df520692150" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p></div>
				</td>
						<td><div><p><span>public</span><span> </span><span>Authentication </span><span>authenticate</span><span>(</span><span>Authentication </span><span>authentication</span><span>)</span><span> </span><span>throws</span><span> </span><span>AuthenticationException</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//Retrieve user provided username and password from authentication request</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>String</span><span> </span><span>name</span><span> </span><span>=</span><span> </span><span>authentication</span><span>.</span><span>getName</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>String</span><span> </span><span>password</span><span> </span><span>=</span><span> </span><span>authentication</span><span>.</span><span>getCredentials</span><span>(</span><span>)</span><span>.</span><span>toString</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//Retrieve User credentials from database and store in User domain object</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//If user doesn't exist in database throw exception</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Users </span><span>user</span><span> </span><span>=</span><span> </span><span>(</span><span>Users</span><span>)</span><span>userSerivce</span><span>.</span><span>loadUserByUsername</span><span>(</span><span>name</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>user</span><span>!=</span><span>null</span><span>)</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//Check if password stored in database is pbkdf2 or md5</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//This custom implementation looks at the size of the </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//message digest to actually determine whether to use md5 or pbdfk2&nbsp;&nbsp;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//for authentication verification</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>user</span><span>.</span><span>getPassword</span><span>(</span><span>)</span><span>.</span><span>length</span><span>(</span><span>)</span><span>==</span><span>24</span><span>)</span><span>{</span><span> </span><span>//MD5 verification and migration</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//convert the user provided password to MD5 and compare it with retrieved password</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MessageDigest </span><span>MD5Hash</span><span> </span><span>=</span><span> </span><span>MessageDigest</span><span>.</span><span>getInstance</span><span>(</span><span>"MD5"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MD5Hash</span><span>.</span><span>update</span><span>(</span><span>password</span><span>.</span><span>getBytes</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>byte</span><span>[</span><span>]</span><span> </span><span>digest</span><span> </span><span>=</span><span> </span><span>MD5Hash</span><span>.</span><span>digest</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>String</span><span> </span><span>hash</span><span> </span><span>=</span><span> </span><span>Base64</span><span>.</span><span>getEncoder</span><span>(</span><span>)</span><span>.</span><span>encodeToString</span><span>(</span><span>digest</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>hash</span><span>.</span><span>equals</span><span>(</span><span>user</span><span>.</span><span>getPassword</span><span>(</span><span>)</span><span>)</span><span>)</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//Change MD5 to pbkdf2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pbkdf2</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Pbkdf2PasswordEncoder</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>String</span><span> </span><span>encodedPwd</span><span> </span><span>=</span><span> </span><span>pbkdf2</span><span>.</span><span>encode</span><span>(</span><span>password</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>String</span><span> </span><span>sql</span><span> </span><span>=</span><span> </span><span>"Update users set password = ? where username = ?"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>int</span><span> </span><span>row</span><span> </span><span>=</span><span> </span><span>getJdbcTemplate</span><span>(</span><span>)</span><span>.</span><span>update</span><span>(</span><span>sql</span><span>,</span><span> </span><span>encodedPwd</span><span>,</span><span> </span><span>name</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>row</span><span>==</span><span>1</span><span>)</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//Successfully migrated user from MD5 to PBKDF2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>new</span><span> </span><span>UsernamePasswordAuthenticationToken</span><span>(</span><span>name</span><span>,</span><span> </span><span>encodedPwd</span><span>,</span><span> </span><span>user</span><span>.</span><span>getAuthorities</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>BadCredentialsException</span><span>(</span><span>"An error occurred. Please try again."</span><span>)</span><span>;</span><span>&nbsp;&nbsp;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>BadCredentialsException</span><span>(</span><span>"Username or Password is Incorrect!"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span> </span><span>catch</span><span> </span><span>(</span><span>NoSuchAlgorithmException</span><span> </span><span>e</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// TODO Auto-generated catch block</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>log</span><span>(</span><span>Level</span><span>.</span><span>SEVERE</span><span>,</span><span> </span><span>"No Algorithm Exception"</span><span>,</span><span> </span><span>e</span><span>)</span><span>;</span><span> </span><span>//Log Exception </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>else</span><span> </span><span>{</span><span> </span><span>//pbkdf2 verification</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pbkdf2</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Pbkdf2PasswordEncoder</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>pbkdf2</span><span>.</span><span>matches</span><span>(</span><span>password</span><span>,</span><span> </span><span>user</span><span>.</span><span>getPassword</span><span>(</span><span>)</span><span>)</span><span>)</span><span>{</span><span> </span><span>//check if pbkdf2 passwords match</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>new</span><span> </span><span>UsernamePasswordAuthenticationToken</span><span>(</span><span>name</span><span>,</span><span> </span><span>password</span><span>,</span><span> </span><span>user</span><span>.</span><span>getAuthorities</span><span>(</span><span>)</span><span>)</span><span>;</span><span> </span><span>//successful then return auth object</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span> </span><span>//else throw exception</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>BadCredentialsException</span><span>(</span><span>"Username or Password is Incorrect!"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>else</span><span>{</span><span> </span><span>//User does not exist in database</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throw</span><span> </span><span>new</span><span> </span><span>BadCredentialsException</span><span>(</span><span>"Username or Password is Incorrect!"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>null</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0059 seconds] -->

<p>An authentication request is processed by the AuthenticationProvider and a fully authenticated object with full credentials is returned. The <code>authenticate()</code> function does the following :</p>
<ol>
<li>Retrieves username and password from the authentication request.</li>
<li>Checks whether the provided username exists in the database or not.<br>
a. This is done by implementing the <code>UserDetailsService</code> and overriding the <code>loadUserByUsername()</code> which retrieves the username from the database using JDBC and returns a user domain object.</li>
<li>The user object contains the password retrieved from the database. Check whether the user password is MD5 or PBKDF2 based on the password length(<code>MD5_STRING_LENGTH</code>). Note that, this check can vary depending on your existing implementation of hashed passwords.</li>
<li>If the retrieved password is determined to be MD5, then encode the user provided password and check if the hashes match. If the hashes match then convert the user retrieved password to PBDFK2 and store it into the database, and return authentication object with full credentials.</li>
<li>If password is determined to be PBKDF2 then use the PBDFK2 encoder to verify the hashes and return authentication object with full credentials.</li>
</ol>
<p>The default PBKDF2 password encoder will use 360000 iterations and output a hash size of 160 bytes. These default values are an aim for 0.5 seconds to validate the password, to slow down brute force attacks. Application owners should tune password verification on their own systems to their needs.<br>
The resulting hash when PBKDF2 password encoder is used defaults to hex encoding however the designers can also configure the encoder to output in base64 format as well.<sup><a href="https://docs.spring.io/spring-security/site/docs/5.0.x/api/org/springframework/security/crypto/password/Pbkdf2PasswordEncoder.html#setEncodeHashAsBase64-boolean-">‡</a></sup></p>
<p>Below is the code which implements <code>UserDetailsService</code> to obtain the user object from the database.</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641e9567451242" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p></div>
				</td>
						<td><div><p><span>@Repository</span></p><p><span>public</span><span> </span><span>class</span><span> </span><span>UsersDetailsDao</span><span> </span><span>implements</span><span> </span><span>UserDetailsService</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@Autowired</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>DataSource </span><span>dataSource</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>JdbcTemplate </span><span>jdbcTemplate</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>UserDetails </span><span>loadUserByUsername</span><span>(</span><span>String</span><span> </span><span>username</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throws</span><span> </span><span>UsernameNotFoundException</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span><span>&nbsp;&nbsp; </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>String</span><span> </span><span>sql</span><span> </span><span>=</span><span> </span><span>"select * from users where username = ?"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Users </span><span>user</span><span> </span><span>=</span><span> </span><span>(</span><span>Users</span><span>)</span><span>getJdbcTemplate</span><span>(</span><span>)</span><span>.</span><span>queryForObject</span><span>(</span><span>sql</span><span>,</span><span> </span><span>new</span><span> </span><span>Object</span><span>[</span><span>]</span><span> </span><span>{</span><span> </span><span>username</span><span> </span><span>}</span><span>,</span><span> </span><span>new</span><span> </span><span>RowMapper</span><span>&lt;Users&gt;</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>Users </span><span>mapRow</span><span>(</span><span>ResultSet </span><span>rs</span><span>,</span><span> </span><span>int</span><span> </span><span>rowNum</span><span>)</span><span> </span><span>throws</span><span> </span><span>SQLException</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Users </span><span>user</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Users</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>user</span><span>.</span><span>getEnabled</span><span>(</span><span>)</span><span> </span><span>==</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>user</span><span>.</span><span>setEnabled</span><span>(</span><span>rs</span><span>.</span><span>getBoolean</span><span>(</span><span>"enabled"</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>user</span><span>.</span><span>getUsername</span><span>(</span><span>)</span><span> </span><span>==</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>user</span><span>.</span><span>setUsername</span><span>(</span><span>rs</span><span>.</span><span>getString</span><span>(</span><span>"username"</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>user</span><span>.</span><span>getPassword</span><span>(</span><span>)</span><span> </span><span>==</span><span> </span><span>null</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>user</span><span>.</span><span>setPassword</span><span>(</span><span>rs</span><span>.</span><span>getString</span><span>(</span><span>"password"</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>user</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sql</span><span> </span><span>=</span><span> </span><span>"select authority from authorities where username = ?"</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>List</span><span>&lt;String&gt;</span><span> </span><span>authorities</span><span> </span><span>=</span><span> </span><span>getJdbcTemplate</span><span>(</span><span>)</span><span>.</span><span>queryForList</span><span>(</span><span>sql</span><span>,</span><span> </span><span>new</span><span> </span><span>Object</span><span>[</span><span>]</span><span> </span><span>{</span><span>username</span><span>}</span><span>,</span><span> </span><span>String</span><span>.</span><span>class</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Set</span><span>&lt;Authorities&gt;</span><span> </span><span>userAuths</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>HashSet</span><span>&lt;Authorities&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>(</span><span>String</span><span> </span><span>authority</span><span> </span><span>:</span><span> </span><span>authorities</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>userAuths</span><span>.</span><span>add</span><span>(</span><span>new</span><span> </span><span>Authorities</span><span>(</span><span>username</span><span>,</span><span> </span><span>authority</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>user</span><span>.</span><span>setAuthorities</span><span>(</span><span>userAuths</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>user</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>catch</span><span>(</span><span>EmptyResultDataAccessException</span><span> </span><span>e</span><span>)</span><span>{</span><span> </span><span>//User does not exist in database</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>null</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0045 seconds] -->

<p>The method for handling authorization would vary in different applications; however it is important that we return a user object through this service.</p>
<p>If the application is legacy, then invoke the custom authentication provider through configuration in web.xml using <code></code> namespace:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641f4114171825" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span> </span><span>&lt;authentication-manager </span><span>alias</span><span>=</span><span>"authenticationManager"</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;authentication-provider </span><span>ref</span><span>=</span><span>"customAuthenticationProvider"</span><span> /&gt;</span></p><p><span> </span><span>&lt;/authentication-manager&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<p>In case you want to invoke the custom authentication provider through Java code, then it is possible by implementing <code>WebSecurityConfigurerAdapter</code> as shown below:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a1a78641f9258634709" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p></div>
				</td>
						<td><div><p><span>@Configuration</span></p><p><span>@EnableWebSecurity</span></p><p><span>public</span><span> </span><span>class</span><span> </span><span>SecurityConfig</span><span> </span><span>extends</span><span> </span><span>WebSecurityConfigurerAdapter</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@Autowired</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span> </span><span>CustomAuthenticationProvider </span><span>customAuthProvider</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@Autowired</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>void</span><span> </span><span>configureGlobal</span><span>(</span><span>AuthenticationManagerBuilder </span><span>auth</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>throws</span><span> </span><span>Exception</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// This is handy if you need to implement your own custom authentication and authorization</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>auth</span><span>.</span><span>authenticationProvider</span><span>(</span><span>customAuthProvider</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->


<p>Now, with all this code and configuration, let’s get back to seeing the seamless password migration process. As seen earlier, here is the users tables before the migration:<br>
<img src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=603%2C196&amp;is-pending-load=1#038;ssl=1" alt="" width="603" height="196" data-recalc-dims="1" data-lazy-srcset="https://i2.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?w=603&amp;ssl=1 603w, https://i2.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=300%2C98&amp;ssl=1 300w" data-lazy-sizes="(max-width: 603px) 100vw, 603px" data-lazy-src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-before-upgrade.png?resize=603%2C196&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>Let us login and see the custom authentication provider in action. First, the login page.<br>
<img src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-login-page.png?resize=551%2C368&amp;is-pending-load=1#038;ssl=1" alt="" width="551" height="368" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-login-page.png?w=551&amp;ssl=1 551w, https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-login-page.png?resize=300%2C200&amp;ssl=1 300w" data-lazy-sizes="(max-width: 551px) 100vw, 551px" data-lazy-src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-login-page.png?resize=551%2C368&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>And after authenticating, we get to the main page:<br>
<img src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-post-authentication.png?resize=679%2C286&amp;is-pending-load=1#038;ssl=1" alt="" width="679" height="286" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-post-authentication.png?w=679&amp;ssl=1 679w, https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-post-authentication.png?resize=300%2C126&amp;ssl=1 300w" data-lazy-sizes="(max-width: 679px) 100vw, 679px" data-lazy-src="https://i0.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-post-authentication.png?resize=679%2C286&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></p>
<p>Once authenticated successfully, let’s check the user table to see if user “sid” has now been migrated to PBKDF2.</p>
<p><img src="https://i1.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-with-strong-hash.png?resize=1170%2C200&amp;is-pending-load=1#038;ssl=1" alt="" width="1170" height="200" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-with-strong-hash.png?w=2005&amp;ssl=1 2005w, https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-with-strong-hash.png?resize=300%2C51&amp;ssl=1 300w, https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-with-strong-hash.png?resize=768%2C131&amp;ssl=1 768w, https://i0.wp.com/www.veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-with-strong-hash.png?resize=1024%2C175&amp;ssl=1 1024w" data-lazy-sizes="(max-width: 1170px) 100vw, 1170px" data-lazy-src="https://i1.wp.com/veggiespam.com/blog/wp-content/uploads/2017/12/PPHU-db-with-strong-hash.png?resize=1170%2C200&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><br>
</p>
<p>Yes, “sid” has been upgraded while “jay”, as usual, is slow on the uptake.</p>

<p>We have provided all code on our <a href="https://github.com/murlisiddharth/SpringSecurity-PasswordMigration" target="_blank" rel="noopener">GitHub Repo</a> for you to fork and use.  Try it yourself, make change, ask questions, file change requests, and overall, upgrade you own software using this as a basis.  If you do use our code, please give a shout-out.</p>

<p>Defense in Depth is essential to keeping your systems secure. If an attacker were to acquire the password hash from a lost backup tape, network tap, or website compromise, they could attempt to reverse them using rainbow tables. To remove these threats, add a salt to the password hashing process and upgrade to a more secure hashing algorithm.</p>
<p>We have provided a working template for a Spring application leveraging Spring Security with simple integration and limited impact on the end users. The code is short and easily customizable to your existing configurations.</p>
<p>We are interested in hearing how you used this code and what changes and enhancements were done to add it to your website. Please give us feedback at addresses below.</p>

<p>Various things we looked at in writing this article.</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Rainbow_table">Description of Rainbow Tables</a> and some good online reversing engines:
<ul>
<li><a href="https://crackstation.net/">crackstation.net</a></li>
<li><a href="https://hashkiller.co.uk/">hashkiller.co.uk</a></li>
<li><a href="http://project-rainbowcrack.com/index.htm">project-rainbowcrack.com</a></li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/Secure_Hash_Algorithms">Hash sizes &amp; effective protections</a></li>
<li><a href="https://passlib.readthedocs.io/en/stable/modular_crypt_format.html">Modular Crypt Format</a> (deprecated for PHC)</li>
<li><a href="https://github.com/P-H-C/phc-string-format/blob/master/phc-sf-spec.md">PHC string format</a></li>
<li><a href="http://www.baeldung.com/spring-security-authentication-provider">Spring Security Authentication Provider</a></li>
<li><a href="https://stackoverflow.com/questions/43205889/spring-security-custom-authentication-not-working">Stack Overflow: spring security custom authentication advice</a></li>
<li><a href="https://projects.spring.io/spring-security/">Spring Security Project</a></li>
<li><a href="https://nakedsecurity.sophos.com/2013/04/23/users-same-password-most-websites/">55% of net users use the same password for most, if not all, websites. When will they learn?</a></li>
</ul>

<p>This blog post was co-written by Siddharth Coontoor and Jay Ball and co-published on Jay’s blogs at <a href="https://veggiespam.com/">veggiespam.com</a>; it will be mirrored to Sid’s blog in the future. Both Sid and Jay are #infosec professionals who do penetration testing and security threat modeling in many of the skyscrapers throughout Manhattan and Jersey City.  Both participate in  local infosec organizations such as OWASP, 2600, HackNYC, and more.  They can be reached via DM <a href="https://twitter.com/theClumsyCoder">@theClumsyCoder</a> and <a href="https://twitter.com/veggiespam">@veggiespam</a> or via email.</p>
<!-- .after-content -->		
		

	<!-- .entry-meta -->



		
		
	</div><!-- .entry-content -->

</article><!-- #post-## -->

			
		
		</main><!-- #main -->
	</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>