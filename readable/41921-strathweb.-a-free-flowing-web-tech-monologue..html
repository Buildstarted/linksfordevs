<!DOCTYPE html>
<html lang="en">
<head>
    <title>
StrathWeb. A free flowing web tech monologue. -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>StrathWeb. A free flowing web tech monologue.</h1>
    <article class="post-6570 post type-post status-publish format-standard hentry category-net category-net-core category-c"> <div class="entry-content clearfix"> <p>In this blog post we will look at how you could create an instance of an object in C# without calling its constructor &#x2013; which sounds a bit crazy, but is actually something that has been supported by both CLR and Core CLR for a long time now.</p>
<p>More after the jump.</p> <h3 id="toc_1">The language spec</h3>
<p>The C# language specification is quite clear in terms of what is required to instantiate an object. It states that you must use the instance constructor.</p>
<blockquote>
<p>10.11 Instance constructors</p>
<p>An instance constructor is a member that implements the actions required to initialize an instance of a class. </p>
</blockquote>
<p>This is quite obvious if you are C# developer, right? We have always used the language this way &#x2013; if you have some work to be run at object creation, we put it in the instance constructor. This is very important as it guarantees certain level of consistency and safety in our code &#x2013; especially as we share code with other teams and developers.</p>
<h3 id="toc_2">Example</h3>
<p>This example is adapted from some real life code I encountered recently. It&#x2019;s of course super-simplified to allow us to focus on the important concepts that are the theme of this blog, but the gist of this example, nevertheless, comes from a real world usage. </p>
<p>Imagine you have a library that deals with tax calculation &#x2013; in this particular case, calculating the value-added tax.</p>
<div> <div id="crayon-5dcd6becde563563745145" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
    public class TaxCalculator
    {
        public double CalculateVAT(double price)
        {
            return Math.Round(price * 0.22, 2);
        }
    }</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5dcd6becde563563745145-1"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">TaxCalculator</span></div><div class="crayon-line" id="crayon-5dcd6becde563563745145-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">double</span><span class="crayon-h"> </span><span class="crayon-e">CalculateVAT</span><span class="crayon-sy">(</span><span class="crayon-t">double</span><span class="crayon-h"> </span><span class="crayon-v">price</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5dcd6becde563563745145-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">Math</span><span class="crayon-sy">.</span><span class="crayon-e">Round</span><span class="crayon-sy">(</span><span class="crayon-e ">price *</span><span class="crayon-h"> </span><span class="crayon-cn">0.22</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> </div>
<p>Now, imagine you distribute this library to other developers, and you require a license to be used in other for the library to function. You might think, OK, let&#x2019;s rely on the constructor to validate the license &#x2013; after all no one will be able to instantiate your calculator without going through the constructor.</p>
<p>So you add some code like this, that will validate the license in the constructor of your <em>TaxCalculator</em>.</p>
<div> <div id="crayon-5dcd6becde578378298821" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
public class TaxCalculator
{
    public TaxCalculator(string license)
    {
        ValidateLicense(license);
    }

    // dummy validation for illustration only
    private void ValidateLicense(string license)
    {
        if (string.IsNullOrEmpty(license))
        {
            throw new ArgumentException(&quot;Your license is invalid, you stupid developer&quot;, nameof(license));
        }
    }

    public double CalculateVAT(double price)
    {
        return Math.Round(price * 0.22, 2);
    }
}</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> <div class="crayon-nums-content"></div> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5dcd6becde578378298821-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">TaxCalculator</span></div><div class="crayon-line" id="crayon-5dcd6becde578378298821-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-e">TaxCalculator</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">license</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5dcd6becde578378298821-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-e">ValidateLicense</span><span class="crayon-sy">(</span><span class="crayon-v">license</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5dcd6becde578378298821-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// dummy validation for illustration only</span></div><div class="crayon-line" id="crayon-5dcd6becde578378298821-9"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">private</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">ValidateLicense</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">license</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5dcd6becde578378298821-11"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-e">IsNullOrEmpty</span><span class="crayon-sy">(</span><span class="crayon-v">license</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5dcd6becde578378298821-13"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">throw</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">ArgumentException</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;Your license is invalid, you stupid developer&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">nameof</span><span class="crayon-sy">(</span><span class="crayon-v">license</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5dcd6becde578378298821-17"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">double</span><span class="crayon-h"> </span><span class="crayon-e">CalculateVAT</span><span class="crayon-sy">(</span><span class="crayon-t">double</span><span class="crayon-h"> </span><span class="crayon-v">price</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5dcd6becde578378298821-19"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">Math</span><span class="crayon-sy">.</span><span class="crayon-e">Round</span><span class="crayon-sy">(</span><span class="crayon-e ">price *</span><span class="crayon-h"> </span><span class="crayon-cn">0.22</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> </div>
<p>Now you are happy because each user of this code has to present a valid license upon object construction. By the way, let&#x2019;s take a short pause here &#x2013; the code used here is purely to illustrate the concept of bypassing the constructor. It is not a tutorial on how to do licensing! It&#x2019;s an example, and we should not read too much into it.</p>
<p>Anyway, now our users can use the <em>TaxCalculator</em> in the following way, and if you have a valid license, everything works fine:</p>
<div> <div id="crayon-5dcd6becde586761706063" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
var calculator = new TaxCalculator(&quot;valid_license&quot;);
Console.WriteLine(calculator.CalculateVAT(11.99));
// prints 2.64</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5dcd6becde586761706063-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">calculator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">TaxCalculator</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;valid_license&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5dcd6becde586761706063-2"><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-v">calculator</span><span class="crayon-sy">.</span><span class="crayon-e">CalculateVAT</span><span class="crayon-sy">(</span><span class="crayon-cn">11.99</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> </div>
<h3 id="toc_3">Bypassing the constructor</h3>
<p>Unfortunately, by putting the validation and integrity/sanity check into the constructor, we fell into a small trap. Turns out, it is actually possible (and officially supported) to create an object instance in .NET without running its instance constructor. In fact, it&#x2019;s been there since .NET 1.1.</p>
<p>The relatively unknown API is called <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.serialization.formatterservices.getuninitializedobject?view=netframework-4.8">FormatterServices.GetUninitializedObject</a> and it will allocate an object without running any initalization code, including the instance constructor. The object is completely uninitialized, which also means that, for example, members would not be initialized to their values.</p>
<p>There is a sibling API in the <em>System.Runtime.CompilerServices</em> namespace and it&#x2019;s called <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.compilerservices.runtimehelpers.getuninitializedobject?view=netcore-3.0">RuntimeHelpers.GetUninitializedObject</a>; it was only added in .NET Core 2.0 and is available in .NET Standard 2.1. The former API (<em>FormatterServices</em>) actually ends up calling the latter (<em>CompilerServices</em>) internally on .NET Core.</p>
<p>Specifically on Core CLR, you can have a look at the implementation of this creation of uninitialized object <a href="https://github.com/dotnet/coreclr/blob/b6488e511db32bb36614becb1a938d4a162f951d/src/vm/reflectioninvocation.cpp#L2410">in the native code here</a>. If you follow that code, you&#x2019;d see that the Core CLR basically only checks against a few restrictions such as if the type is generic or abstract, and then ends up allocating an object and returning it, completely bypassing constructors.</p>
<p>Afterwards you are free to use it. For example, the following code is perfectly valid:</p>
<div> <div id="crayon-5dcd6becde594035035610" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
var calculator = RuntimeHelpers.GetUninitializedObject(typeof(TaxCalculator)) as TaxCalculator;
Console.WriteLine(calculator.CalculateVAT(11.99));
// prints 2.64</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5dcd6becde594035035610-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">calculator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">RuntimeHelpers</span><span class="crayon-sy">.</span><span class="crayon-e">GetUninitializedObject</span><span class="crayon-sy">(</span><span class="crayon-e">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">TaxCalculator</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">TaxCalculator</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5dcd6becde594035035610-2"><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-v">calculator</span><span class="crayon-sy">.</span><span class="crayon-e">CalculateVAT</span><span class="crayon-sy">(</span><span class="crayon-cn">11.99</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> </div>
<p>It works the same way as previously, and we end up getting same result. The difference is, of course, that we ended up bypassing the constructor and avoided the check we put there (license check) in the first place.</p>
<p>Another interesting aspect of this is that you can use the same technique to create instances of objects that only have private constructors. This is typical in builder patterns. For example, given the following:</p>
<div> <div id="crayon-5dcd6becde5a1261109368" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
    public class Dog
    {
        private Dog() { }

        // factory method to be used instead of constructor
        public static Dog CreateDog()
        {
            // some validation on how Dog must be created
            return new Dog();
        }

        public string Bark() =&gt; &quot;woof!&quot;;
    }</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5dcd6becde5a1261109368-5"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// factory method to be used instead of constructor</span></div><div class="crayon-line crayon-striped-line" id="crayon-5dcd6becde5a1261109368-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-m">static</span><span class="crayon-h"> </span><span class="crayon-e">Dog </span><span class="crayon-e">CreateDog</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5dcd6becde5a1261109368-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-c">// some validation on how Dog must be created</span></div><div class="crayon-line crayon-striped-line" id="crayon-5dcd6becde5a1261109368-12"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-e">Bark</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-s">&quot;woof!&quot;</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> </div>
<p>You could just use <em>GetUninitializedObject</em> APIs and bypass the factory method completely: </p>
<div> <div id="crayon-5dcd6becde5bb622114476" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
var dog = RuntimeHelpers.GetUninitializedObject(typeof(Dog)) as Dog;
Console.WriteLine(dog.Bark());
// prints woof!</textarea></div> <div class="crayon-main"> <table class="crayon-table"> <tr class="crayon-row"> <td class="crayon-nums "> </td> <td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5dcd6becde5bb622114476-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">dog</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">RuntimeHelpers</span><span class="crayon-sy">.</span><span class="crayon-e">GetUninitializedObject</span><span class="crayon-sy">(</span><span class="crayon-e">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Dog</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">Dog</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5dcd6becde5bb622114476-2"><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-v">dog</span><span class="crayon-sy">.</span><span class="crayon-e">Bark</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td> </tr> </table> </div> </div> </div>
<h3 id="toc_4">Summary</h3>
<p>These <em>GetUninitializedObject</em> are actually used quite widely in serialization libraries and frameworks. The lesson here, however, is that when designing your own code that will be consumed by other developers, don&#x2019;t always assume that they will go through the constructor &#x2013; sometimes moving a certain check to a different place (i.e. from constructor to a specific method) can help avoid certain misbehavior or prevent others from doing something stupid!</p>
<p>There is really not much there, but if you are interested, the demo code for this article is available on <a href="https://github.com/filipw/Strathweb.Samples.NoConstructor">Github</a>.</p> </div> </article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>