<!DOCTYPE html>
<html lang="en">
<head>
    <title>linksfor.dev(s)</title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">ðŸŽ‰</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <div class="readable">
        <h1>New IL instruction for typeswitch &#xB7; Issue #12260 &#xB7; dotnet/runtime</h1>
        <p>
by gafter <br/>Reading time: 2-3 minutes        </p>
        <p><a href="https://github.com/dotnet/coreclr/issues/23241">https://github.com/dotnet/coreclr/issues/23241</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div disabled="" sortable="">
<div>
          <p>It seems like this is something that might fit fairly well as an intrinsic. No new IL or IL pattern matching would be needed, and it could be engineered so that jit/runtime optimization was possible but also optional.</p>
<p>We'd agree on some BCL method(s) for this operation, eg <code>int TypeSwitch(Type t, Type x_0, Type x_1, ...)</code>, and find an efficient way to cope with the varadic cases (one can always just implement up to some N, and chain calls to handle cases larger than N, I suppose). This would return the index <code>i</code>  of the lowest-numbered <code>x_i</code> that satisfies <code>t isinst x_i</code>, or -1 if none satisfy.</p>
<p>This method (or set of methods) would be targeted by C#, which when doing pattern matching would follow this up with an actual switch to direct control to the appropriate label. There might be some complexities fitting this in with side effect ordering -- I don't know how much code can run during the matching phase currently.</p>
<p>The <code>TypeSwitch</code> method(s) would be fully implemented in the BCL by default. So no jit or runtime work would be required. This implementation could be via hashtable, linear search, etc, whatever seems suitable.</p>
<p>The <code>TypeSwitch</code> method(s) could also be marked with <code>[Intrinsic]</code> so that the they could be recognized by the jit as methods with known behavior. Doing this allows the possibility for special handling, but does not create an obligation. Then when the jit encountered a call to <code>TypeSwitch</code> where the <code>x_i</code> are all jit-time known types, the jit could interact with the runtime to see if it was possible to optimize the test away entirely (say, <code>t</code>'s type is known at jit time), or if it made sense to peel off some of the cases for eager testing, or build a full decision tree based on what is known about the likely types of <code>t</code> and the class relationships of the <code>x_i</code>, or fuse the call and following switch into a hash-based indirect jump sequence. If the <code>x_i</code> are not jit-time constants, or the evidence for benefit from specialization is weak, the jit could just defer to calling the helper.</p>
      </div>
</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>

</body>
</html>