<!DOCTYPE html>
<html lang="en">
<head>
    <title>
ASP.NET Core 3 signatures &#xB7; Issue #207 &#xB7; CarterCommunity/Carter &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>ASP.NET Core 3 signatures · Issue #207 · CarterCommunity/Carter · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p><code>UseCarter</code> should hang off <code>IEndpointConventionBuilder</code> instead of hanging off <code>IApplicationBuilder</code> (and would be renamed to MapCarter).</p><p>Middleware can act on selected endpoints when chosen so things like authorization/cors can be moved outside of the framework into middleware. As part of route registration users should have a way to add metadata to their route.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">ProductsModule</span> : <span class="pl-en">CaterModule</span>
{
    <span class="pl-k">public</span><span class="pl-en">MyModule</span>() : <span class="pl-k">base</span>(<span class="pl-s"><span class="pl-pds">"</span>/products<span class="pl-pds">"</span></span>)
    {
        <span class="pl-k">this</span>.<span class="pl-en">Get</span>(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, <span class="pl-smi">ctx</span><span class="pl-k">=&gt;</span><span class="pl-smi">ctx</span>.<span class="pl-en">WriteAsync</span>(<span class="pl-s"><span class="pl-pds">"</span>hi<span class="pl-pds">"</span></span>)).<span class="pl-en">RequireAuthorization</span>();
    }
}</pre></div><p>The <code>CarterModule</code> would be a mini DSL over routing.</p><p>Quickly looking at the code I'm not sure how you could expose the <code>IEndpointConventionBuilder</code> from the route registration methods without a breaking change. Maybe it could be an argument instead?</p><p>Here's a strawman:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span><span class="pl-en">System</span>;
<span class="pl-k">using</span><span class="pl-en">System</span>.<span class="pl-en">Collections</span>.<span class="pl-en">Generic</span>;
<span class="pl-k">using</span><span class="pl-en">Microsoft</span>.<span class="pl-en">AspNetCore</span>.<span class="pl-en">Builder</span>;
<span class="pl-k">using</span><span class="pl-en">Microsoft</span>.<span class="pl-en">AspNetCore</span>.<span class="pl-en">Hosting</span>;
<span class="pl-k">using</span><span class="pl-en">Microsoft</span>.<span class="pl-en">AspNetCore</span>.<span class="pl-en">Http</span>;
<span class="pl-k">using</span><span class="pl-en">Microsoft</span>.<span class="pl-en">AspNetCore</span>.<span class="pl-en">Routing</span>;
<span class="pl-k">using</span><span class="pl-en">Microsoft</span>.<span class="pl-en">Extensions</span>.<span class="pl-en">DependencyInjection</span>;
<span class="pl-k">using</span><span class="pl-en">Microsoft</span>.<span class="pl-en">Extensions</span>.<span class="pl-en">Hosting</span>;

<span class="pl-k">namespace</span><span class="pl-en">CarterDemo</span>
{
    <span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">HelloModule</span> : <span class="pl-en">CarterModule</span>
    {
        <span class="pl-k">public</span><span class="pl-en">HelloModule</span>()
        {
            <span class="pl-en">Get</span>(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, <span class="pl-smi">context</span><span class="pl-k">=&gt;</span><span class="pl-smi">context</span>.<span class="pl-smi">Response</span>.<span class="pl-en">WriteAsync</span>(<span class="pl-s"><span class="pl-pds">"</span>Hello World<span class="pl-pds">"</span></span>)).<span class="pl-en">RequireAuthorization</span>();
        }
    }

    <span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">CarterModule</span>
    {
        <span class="pl-k">internal</span><span class="pl-k">readonly</span><span class="pl-en">Dictionary</span>&lt;(<span class="pl-k">string</span><span class="pl-en">verb</span>, <span class="pl-k">string</span><span class="pl-en">path</span>), (<span class="pl-en">RequestDelegate</span><span class="pl-en">handler</span>, <span class="pl-en">RouteConventions</span><span class="pl-en">conventions</span>)&gt; <span class="pl-smi">Routes</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Dictionary</span>&lt;(<span class="pl-k">string</span><span class="pl-en">verb</span>, <span class="pl-k">string</span><span class="pl-en">path</span>), (<span class="pl-en">RequestDelegate</span><span class="pl-en">handler</span>, <span class="pl-en">RouteConventions</span><span class="pl-en">conventions</span>)&gt;();

        <span class="pl-k">public</span><span class="pl-en">IEndpointConventionBuilder</span><span class="pl-en">Get</span>(<span class="pl-k">string</span><span class="pl-smi">path</span>, <span class="pl-en">RequestDelegate</span><span class="pl-smi">handler</span>)
        {
            <span class="pl-k">var</span><span class="pl-smi">conventions</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">RouteConventions</span>();
            <span class="pl-smi">Routes</span>.<span class="pl-en">Add</span>((<span class="pl-smi">HttpMethods</span>.<span class="pl-smi">Get</span>, <span class="pl-smi">path</span>), (<span class="pl-smi">handler</span>, <span class="pl-smi">conventions</span>));
            <span class="pl-k">return</span><span class="pl-smi">conventions</span>;
        }

        <span class="pl-k">internal</span><span class="pl-k">class</span><span class="pl-en">RouteConventions</span> : <span class="pl-en">IEndpointConventionBuilder</span>
        {
            <span class="pl-k">private</span><span class="pl-k">readonly</span><span class="pl-en">List</span>&lt;<span class="pl-en">Action</span>&lt;<span class="pl-en">EndpointBuilder</span>&gt;&gt; <span class="pl-smi">_actions</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">List</span>&lt;<span class="pl-en">Action</span>&lt;<span class="pl-en">EndpointBuilder</span>&gt;&gt;();

            <span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Add</span>(<span class="pl-en">Action</span>&lt;<span class="pl-en">EndpointBuilder</span>&gt; <span class="pl-smi">convention</span>)
            {
                <span class="pl-smi">_actions</span>.<span class="pl-en">Add</span>(<span class="pl-smi">convention</span>);
            }

            <span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Apply</span>(<span class="pl-en">IEndpointConventionBuilder</span><span class="pl-smi">builder</span>)
            {
                <span class="pl-k">foreach</span> (<span class="pl-k">var</span><span class="pl-smi">a</span><span class="pl-k">in</span><span class="pl-smi">_actions</span>)
                {
                    <span class="pl-smi">builder</span>.<span class="pl-en">Add</span>(<span class="pl-smi">a</span>);
                }
            }
        }
    }

    <span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">class</span><span class="pl-en">CarterExtensions</span>
    {
        <span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-en">IEndpointConventionBuilder</span><span class="pl-en">MapCarter</span>(<span class="pl-k">this</span><span class="pl-en">IEndpointRouteBuilder</span><span class="pl-smi">builder</span>)
        {
            <span class="pl-k">var</span><span class="pl-smi">builders</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">List</span>&lt;<span class="pl-en">IEndpointConventionBuilder</span>&gt;();

            <span class="pl-smi">using</span><span class="pl-k">var</span><span class="pl-smi">scope</span><span class="pl-k">=</span><span class="pl-smi">builder</span>.<span class="pl-smi">ServiceProvider</span>.<span class="pl-en">CreateScope</span>();
            <span class="pl-k">foreach</span> (<span class="pl-k">var</span><span class="pl-smi">module</span><span class="pl-k">in</span><span class="pl-smi">scope</span>.<span class="pl-smi">ServiceProvider</span>.<span class="pl-en">GetServices</span>&lt;<span class="pl-en">CarterModule</span>&gt;())
            {
                <span class="pl-k">foreach</span> (<span class="pl-k">var</span><span class="pl-smi">route</span><span class="pl-k">in</span><span class="pl-smi">module</span>.<span class="pl-smi">Routes</span>)
                {
                    <span class="pl-k">var</span><span class="pl-smi">conventionBuilder</span><span class="pl-k">=</span><span class="pl-smi">builder</span>.<span class="pl-en">MapMethods</span>(<span class="pl-smi">route</span>.<span class="pl-smi">Key</span>.<span class="pl-smi">path</span>, <span class="pl-k">new</span>[] { <span class="pl-smi">route</span>.<span class="pl-smi">Key</span>.<span class="pl-smi">verb</span> }, <span class="pl-smi">route</span>.<span class="pl-smi">Value</span>.<span class="pl-smi">handler</span>);
                    <span class="pl-smi">route</span>.<span class="pl-smi">Value</span>.<span class="pl-smi">conventions</span>.<span class="pl-en">Apply</span>(<span class="pl-smi">conventionBuilder</span>);
                    <span class="pl-smi">builders</span>.<span class="pl-en">Add</span>(<span class="pl-smi">conventionBuilder</span>);
                }
            }

            <span class="pl-c"><span class="pl-c">//</span> Allow the user to apply conventions to all modules</span><span class="pl-k">return</span><span class="pl-k">new</span><span class="pl-en">CompositeConventionBuilder</span>(<span class="pl-smi">builders</span>);
        }

        <span class="pl-k">private</span><span class="pl-k">class</span><span class="pl-en">CompositeConventionBuilder</span> : <span class="pl-en">IEndpointConventionBuilder</span>
        {
            <span class="pl-k">private</span><span class="pl-k">readonly</span><span class="pl-en">List</span>&lt;<span class="pl-en">IEndpointConventionBuilder</span>&gt; <span class="pl-smi">_builders</span>;
            <span class="pl-k">public</span><span class="pl-en">CompositeConventionBuilder</span>(<span class="pl-en">List</span>&lt;<span class="pl-en">IEndpointConventionBuilder</span>&gt; <span class="pl-smi">builders</span>)
            {
                <span class="pl-smi">_builders</span><span class="pl-k">=</span><span class="pl-smi">builders</span>;
            }

            <span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Add</span>(<span class="pl-en">Action</span>&lt;<span class="pl-en">EndpointBuilder</span>&gt; <span class="pl-smi">convention</span>)
            {
                <span class="pl-k">foreach</span> (<span class="pl-k">var</span><span class="pl-smi">builder</span><span class="pl-k">in</span><span class="pl-smi">_builders</span>)
                {
                    <span class="pl-smi">builder</span>.<span class="pl-en">Add</span>(<span class="pl-smi">convention</span>);
                }
            }
        }
    }

    <span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">Startup</span>
    {
        <span class="pl-c"><span class="pl-c">//</span> This method gets called by the runtime. Use this method to add services to the container.</span><span class="pl-c"><span class="pl-c">//</span> For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940</span><span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">ConfigureServices</span>(<span class="pl-en">IServiceCollection</span><span class="pl-smi">services</span>)
        {
            <span class="pl-smi">services</span>.<span class="pl-en">AddAuthorization</span>();
            <span class="pl-smi">services</span>.<span class="pl-en">AddScoped</span>&lt;<span class="pl-en">CarterModule</span>, <span class="pl-en">HelloModule</span>&gt;();
        }

        <span class="pl-c"><span class="pl-c">//</span> This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span><span class="pl-k">public</span><span class="pl-k">void</span><span class="pl-en">Configure</span>(<span class="pl-en">IApplicationBuilder</span><span class="pl-smi">app</span>, <span class="pl-en">IWebHostEnvironment</span><span class="pl-smi">env</span>)
        {
            <span class="pl-k">if</span> (<span class="pl-smi">env</span>.<span class="pl-en">IsDevelopment</span>())
            {
                <span class="pl-smi">app</span>.<span class="pl-en">UseDeveloperExceptionPage</span>();
            }

            <span class="pl-smi">app</span>.<span class="pl-en">UseRouting</span>();

            <span class="pl-smi">app</span>.<span class="pl-en">UseAuthorization</span>();

            <span class="pl-smi">app</span>.<span class="pl-en">UseEndpoints</span>(<span class="pl-smi">endpoints</span><span class="pl-k">=&gt;</span>
            {
                <span class="pl-smi">endpoints</span>.<span class="pl-en">MapCarter</span>();
            });
        }
    }
}</pre></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>