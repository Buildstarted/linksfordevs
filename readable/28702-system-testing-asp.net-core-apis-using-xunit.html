<!DOCTYPE html>
<html lang="en">
<head>
    <title>
System Testing ASP.NET Core APIs using XUnit -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>System Testing ASP.NET Core APIs using XUnit</h1><div><div class="entry-content"><p>This article shows how an ASP.NET Core API could be tested using system tests implemented using <a href="https://xunit.net/">XUnit</a>. The API is protected using JWT Bearer token authorization, and the API uses a secure token server to validate the API requests. When running the tests, the access token needs to be requested, and used to access the APIs. We can then validate, for example if invalid tokens are rejected.</p><p><strong>Code:</strong><a href="https://github.com/damienbod/AspNetCoreMvcProtobufFormatters" rel="nofollow">https://github.com/damienbod/AspNetCoreMvcProtobufFormatters</a></p><p>The demo sofware has two solutions. The target software has an APP which implements the API and a secure token service (STS) which provides and validates the tokens. The second solution is for the system tests. The tests will only work when both the API and the STS are running. We need to run and test the tests locally and well as when the solution is deployed. This means it must be possible to configure different URLs and secrets for the different deployments, so that the tests can be run in each of the different dev, test, production deployments, or whatever system you have.</p><p><img data-attachment-id="12520" data-permalink="https://damienbod.com/2019/07/07/system-testing-asp-net-core-apis-using-xunit/system_test_01/" data-orig-file="https://damienbod.files.wordpress.com/2019/07/system_test_01.png" data-orig-size="871,466" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="system_test_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2019/07/system_test_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2019/07/system_test_01.png?w=640" src="https://damienbod.files.wordpress.com/2019/07/system_test_01.png?w=640&amp;h=342" alt="" width="640" height="342" class="alignnone size-full wp-image-12520" srcset="https://damienbod.files.wordpress.com/2019/07/system_test_01.png?w=640&amp;h=342 640w, https://damienbod.files.wordpress.com/2019/07/system_test_01.png?w=150&amp;h=80 150w, https://damienbod.files.wordpress.com/2019/07/system_test_01.png?w=600&amp;h=321 600w, https://damienbod.files.wordpress.com/2019/07/system_test_01.png?w=768&amp;h=411 768w, https://damienbod.files.wordpress.com/2019/07/system_test_01.png 871w" sizes="(max-width: 640px) 100vw, 640px"></p><p>The API is implemented and secured using the Authorize attribute. Only valid requests with the correct authorization can access this API.</p><pre class="brush: csharp; title: ; notranslate" title="">[Authorize]
[Route("api/[controller]")]
public class ValuesController : Controller
{
	// GET api/values/5
	[HttpGet("{id}")]
	public ProtobufModelDto Get(int id)
	{
		return new ProtobufModelDto() { 
		  Id = 1, Name = "HelloWorld", 
		  StringValue = "My first MVC 6 Protobuf service" 
		};
	}
</pre><p>The Startup class ConfigureServices method implements the authentication and authorization settings for the API. The API only accepts access token from the correct STS and tokens which have the apiproto scope, otherwise the request will not be authorized.</p><pre class="brush: csharp; title: ; notranslate" title="">public void ConfigureServices(IServiceCollection services)
{
	services.AddAuthentication(IdentityServerAuthenticationDefaults.AuthenticationScheme)
	  .AddIdentityServerAuthentication(options =&gt;
	  {
		  options.Authority = "https://localhost:44318";
		  options.ApiName = "apiproto";
		  options.ApiSecret = "apiprotoSecret";
	  });

	services.AddAuthorization(options =&gt;
	   options.AddPolicy("RequiredScope", policy =&gt;
	   {
		   policy.RequireClaim("scope", "apiproto");
	   })
	);

	...
}
</pre><p><strong>Test Setup</strong></p><p>The system tests are setup to read app settings for the different URLs and secrets, so that it can be run against the different deployments.</p><pre class="brush: csharp; title: ; notranslate" title="">private readonly HttpClient _client;
private readonly ApiTokenInMemoryClient  _tokenService;
private readonly IConfigurationRoot _configurationRoot;

public ProtobufApiTests()
{
	_configurationRoot = GetIConfigurationRoot();
	//Arrange;
	_client = new HttpClient
	{
		BaseAddress = new System.Uri(_configurationRoot["ApiUrl"])
	};

	_tokenService = 
	  new ApiTokenInMemoryClient(
	    _configurationRoot["StsUrl"], 
		new HttpClient());
}
</pre><p>The access token is requested using the SetTokenAsync method.</p><pre class="brush: csharp; title: ; notranslate" title="">private async Task SetTokenAsync(HttpClient client)
{
	var access_token = await _tokenService.GetApiToken(
			"ClientProtectedApi",
			"apiproto",
			_configurationRoot["ApiSecret"]
		);

	client.SetBearerToken(access_token);
}
</pre><p>The token service is used to get an access token for the correct scope, secret and API.</p><pre class="brush: csharp; title: ; notranslate" title="">using IdentityModel.Client;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Net.Http;
using System.Threading.Tasks;

namespace AspNetCoreProtobuf.Tests
{
    public class ApiTokenInMemoryClient
    {
        private readonly HttpClient _httpClient;
        private readonly string _stsServerUrl;

        private class AccessTokenItem
        {
            public string AccessToken { get; set; } = string.Empty;
            public DateTime ExpiresIn { get; set; }
        }

        private ConcurrentDictionary&lt;string, AccessTokenItem&gt; _accessTokens = new ConcurrentDictionary&lt;string, AccessTokenItem&gt;();

        public ApiTokenInMemoryClient(
            string stsServerUrl,
            HttpClient httpClient)
        {
            _httpClient = httpClient;
            _stsServerUrl = stsServerUrl;
        }

        public async Task&lt;string&gt; GetApiToken(string api_name, string api_scope, string secret)
        {
            if (_accessTokens.ContainsKey(api_name))
            {
                var accessToken = _accessTokens.GetValueOrDefault(api_name);
                if (accessToken.ExpiresIn &gt; DateTime.UtcNow)
                {
                    return accessToken.AccessToken;
                }
                else
                {
                    // remove
                    _accessTokens.TryRemove(api_name, out AccessTokenItem accessTokenItem);
                }
            }

            var newAccessToken = await getApiToken( api_name,  api_scope,  secret);
            _accessTokens.TryAdd(api_name, newAccessToken);

            return newAccessToken.AccessToken;
        }

        private async Task&lt;AccessTokenItem&gt; getApiToken(string api_name, string api_scope, string secret)
        {
            try
            {
                var disco = await HttpClientDiscoveryExtensions.GetDiscoveryDocumentAsync(
                    _httpClient,
                    _stsServerUrl);

                if (disco.IsError)
                {
                    throw new ApplicationException($"Status code: {disco.IsError}, Error: {disco.Error}");
                }

                var tokenResponse = await HttpClientTokenRequestExtensions.RequestClientCredentialsTokenAsync(_httpClient, new ClientCredentialsTokenRequest
                {
                    Scope = api_scope,
                    ClientSecret = secret,
                    Address = disco.TokenEndpoint,
                    ClientId = api_name
                });

                if (tokenResponse.IsError)
                {
                    throw new ApplicationException($"Status code: {tokenResponse.IsError}, Error: {tokenResponse.Error}");
                }

                return new AccessTokenItem
                {
                    ExpiresIn = DateTime.UtcNow.AddSeconds(tokenResponse.ExpiresIn),
                    AccessToken = tokenResponse.AccessToken
                };
                
            }
            catch (Exception e)
            {
                throw new ApplicationException($"Exception {e}");
            }
        }
    }
}

</pre><p><strong>The Tests</strong></p><p>Once the system tests are setup and have an access token, the tests can be run. The following test checks if the basic GET request works with the correct token.</p><pre class="brush: csharp; title: ; notranslate" title="">[Fact]
public async Task GetProtobufDataAsString()
{
	await SetTokenAsync(_client);
	// Act
	_client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/x-protobuf"));
	var response = await _client.GetAsync("/api/values/1");
	response.EnsureSuccessStatusCode();

	var responseString = System.Text.Encoding.UTF8.GetString(
		await response.Content.ReadAsByteArrayAsync()
	);

	// Assert
	Assert.Equal("application/x-protobuf", response.Content.Headers.ContentType.MediaType);
	Assert.Equal("\b\u0001\u0012\nHelloWorld\u001a\u001fMy first MVC 6 Protobuf service", responseString);
}
</pre><p>The API can also be tested that a 401 is returned, when no token is sent.</p><pre class="brush: csharp; title: ; notranslate" title="">[Fact]
public async Task Get401ForNoToken()
{
	// Act
	_client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/x-protobuf"));
	var response = await _client.GetAsync("/api/values/1");

	// Assert
	Assert.Equal("Unauthorized", response.StatusCode.ToString());
}
</pre><p>The following test uses a valid token, but one which was not created for this API and is rejected. The API must also return a 401.</p><pre class="brush: csharp; title: ; notranslate" title="">[Fact]
public async Task Get401ForIncorrectToken()
{
	var access_token = await _tokenService.GetApiToken(
			"ClientProtectedApi",
			"dummy",
			"apiprotoSecret"
		);

	_client.SetBearerToken(access_token);

	// Act
	_client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/x-protobuf"));
	var response = await _client.GetAsync("/api/values/1");

	// Assert
	Assert.Equal("Unauthorized", response.StatusCode.ToString());
}

</pre><p>With this setup, it is really easy to do system tests for you API. These tests are really easy to maintain, as the same technologies are used as the ones the developers use, and so that with each change, the developers have less effort to maintain this.</p><p><strong>Links:</strong></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-2.2" rel="nofollow">https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-2.2</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-2.2" rel="nofollow">https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-2.2</a></p><p><a href="https://xunit.net/" rel="nofollow">https://xunit.net/</a></p><div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><h3 class="jp-relatedposts-headline"><em>Related</em></h3></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>