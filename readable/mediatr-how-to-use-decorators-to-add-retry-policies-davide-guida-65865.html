<!DOCTYPE html>
<html lang="en">
<head>
    <title>
MediatR: how to use Decorators to add retry policies - Davide Guida - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="MediatR: how to use Decorators to add retry policies - Davide Guida - linksfor.dev(s)"/>
    <meta property="article:author" content="https://www.facebook.com/davide.guida"/>
    <meta property="og:description" content="Today we&#x27;ll see how we can leverate the Decorator Pattern in conjunction with Polly and Scrutor to add retry policies to MediatR."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.davideguida.com/mediatr-how-to-use-decorators-to-add-retry-policies/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - MediatR: how to use Decorators to add retry policies - Davide Guida</title>
<div class="readable">
        <h1>MediatR: how to use Decorators to add retry policies - Davide Guida</h1>
            <div>by https://www.facebook.com/davide.guida</div>
            <div>Reading time: 7-8 minutes</div>
        <div>Posted here: 19 Aug 2020</div>
        <p><a href="https://www.davideguida.com/mediatr-how-to-use-decorators-to-add-retry-policies/">https://www.davideguida.com/mediatr-how-to-use-decorators-to-add-retry-policies/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
				
<p>Hi All! Today we’ll see an interesting technique to add retry policies to <a href="https://www.davideguida.com/event-sourcing-in-net-core-part-4-query-models/" target="_blank" rel="noreferrer noopener">Med</a><a href="https://www.davideguida.com/command-handlers-return-values-in-cqrs/" target="_blank" rel="noreferrer noopener">i</a><a href="https://www.davideguida.com/event-sourcing-in-net-core-part-4-query-models/" target="_blank" rel="noreferrer noopener">atR</a>. It can actually be used also for other types of policies (fallback, circuit breaker, and so on), but we’ll focusing on retries to keep things simple.</p>



<p>As you might have guessed, this “magic trick” involves the use of the Decorator Pattern. We talked already about it <a href="https://www.davideguida.com/using-decorators-to-handle-cross-cutting-concerns/" target="_blank" rel="noreferrer noopener">in another article</a> so I’m not going to spend time on it. Let’s jump into the code!</p>



<div><div><div><p><span>public</span><span> </span><span>class</span><span> RetryDecorator</span><span>&lt;</span><span>TNotification</span><span>&gt;</span><span> : MediatR.</span><span>INotificationHandler</span><span>&lt;</span><span>TNotification</span><span>&gt;</span><span></span></p></div><div><p><span>        </span><span>where</span><span> TNotification : MediatR.</span><span>INotification</span><span></span></p></div><div><p><span>    </span><span>private</span><span> </span><span>readonly</span><span> INotificationHandler</span><span>&lt;</span><span>TNotification</span><span>&gt;</span><span> _inner;</span></p></div><div><p><span>    </span><span>private</span><span> </span><span>readonly</span><span> Polly.</span><span>IAsyncPolicy</span><span> _retryPolicy;</span></p></div><div><p><span>    </span><span>public</span><span> </span><span>RetryDecorator</span><span>(</span><span>MediatR.</span><span>INotificationHandler</span><span>&lt;</span><span>TNotification</span><span>&gt;</span><span> inner</span><span>)</span><span></span></p></div><div><p><span>        _retryPolicy = Polly.</span><span>Policy</span><span>.</span><span>Handle</span><span>&lt;</span><span>ArgumentOutOfRangeException</span><span>&gt;()</span><span></span></p></div><div><p><span>                i =</span><span>&gt;</span><span> TimeSpan.</span><span>FromSeconds</span><span>(</span><span>i</span><span>))</span><span>;</span></p></div><div><p><span>    </span><span>public</span><span> Task </span><span>Handle</span><span>(</span><span>TNotification notification, CancellationToken cancellationToken</span><span>)</span><span></span></p></div><div><p><span>        </span><span>return</span><span> _retryPolicy.</span><span>ExecuteAsync</span><span>(()</span><span> =</span><span>&gt;</span><span> _inner.</span><span>Handle</span><span>(</span><span>notification, cancellationToken</span><span>))</span><span>;</span></p></div></div><p>public class RetryDecorator&lt;TNotification&gt; : MediatR.INotificationHandler&lt;TNotification&gt;
        where TNotification : MediatR.INotification
{
    private readonly INotificationHandler&lt;TNotification&gt; _inner;
    private readonly Polly.IAsyncPolicy _retryPolicy;

    public RetryDecorator(MediatR.INotificationHandler&lt;TNotification&gt; inner)
    {
        _inner = inner; 
        _retryPolicy = Polly.Policy.Handle&lt;ArgumentOutOfRangeException&gt;()
            .WaitAndRetryAsync(3,
                i =&gt; TimeSpan.FromSeconds(i));
    }

    public Task Handle(TNotification notification, CancellationToken cancellationToken)
    {
        return _retryPolicy.ExecuteAsync(() =&gt; _inner.Handle(notification, cancellationToken));
    }
}</p></div><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public class RetryDecorator&lt;TNotification&gt; : MediatR.INotificationHandler&lt;TNotification&gt;
        where TNotification : MediatR.INotification
{
	private readonly INotificationHandler&lt;TNotification&gt; _inner;
	private readonly Polly.IAsyncPolicy _retryPolicy;

	public RetryDecorator(MediatR.INotificationHandler&lt;TNotification&gt; inner)
	{
		_inner = inner; 
		_retryPolicy = Polly.Policy.Handle&lt;ArgumentOutOfRangeException&gt;()
			.WaitAndRetryAsync(3,
				i =&gt; TimeSpan.FromSeconds(i));
	}

	public Task Handle(TNotification notification, CancellationToken cancellationToken)
	{
		return _retryPolicy.ExecuteAsync(() =&gt; _inner.Handle(notification, cancellationToken));
	}
}</pre>



<p>I showed this class already in another article of my <a href="https://www.davideguida.com/event-sourcing-in-net-core-part-4-query-models/" target="_blank" rel="noreferrer noopener">Event Sourcing</a> series, but without going too much into the details. Today we’ll see how we can register it in our system using Dependency Injection.</p>



<p>This class is decorating an instance of <a href="https://github.com/jbogard/MediatR/blob/master/src/MediatR/INotificationHandler.cs" target="_blank" rel="noreferrer noopener">INotificationHandler</a>. In <a href="https://github.com/mizrael/SuperSafeBank" target="_blank" rel="noreferrer noopener">SuperSafeBank</a>, I use Notification Handlers to react to Integration Events and update the Query Models. </p>



<h4>However, sometimes an update might fail, maybe because other dependencies are (still) not available or there’s a network issue with the DB server or whatever.</h4>



<p>In those cases, we can make use of <a href="https://github.com/App-vNext/Polly" target="_blank" rel="noreferrer noopener">Polly</a> and add a policy wrapping the “unstable” code. But how can we decorate all our Handlers?</p>



<p>Most of the IoC libraries available have already commodity functions to register decorators. But to be honest, I like the built-in .NET Core IoC Container, it covers all the basic scenarios and lifetimes. Moreover, if you’re in need of something more exotic, most of the time you’d have to review the design.</p>



<p>Unfortunately though, Decorators are not part of the library. But we can use another interesting NuGet: <a href="https://github.com/khellang/Scrutor" target="_blank" rel="noreferrer noopener">Scrutor</a>. It’s a tiny library, created specifically for this: “<em>Assembly scanning and decoration extensions for Microsoft.Extensions.DependencyInjection</em>“. Perfect for us.</p>



<p>So, the first thing is to look for all our handlers and register them:</p>



<div><div><div><p><span>public</span><span> </span><span>void</span><span> </span><span>ConfigureServices</span><span>(</span><span>IServiceCollection services</span><span>){</span><span></span></p></div><div><p><span>        scan.</span><span>FromAssembliesOf</span><span>(</span><span>typeof</span><span>(</span><span>Startup</span><span>))</span><span></span></p></div><div><p><span>            .</span><span>RegisterHandlers</span><span>(</span><span>typeof</span><span>(</span><span>INotificationHandler</span><span>&lt;&gt;))</span><span>;</span></p></div></div><p>public void ConfigureServices(IServiceCollection services){
    services.Scan(scan =&gt; {
        scan.FromAssembliesOf(typeof(Startup))
            .RegisterHandlers(typeof(INotificationHandler&lt;&gt;));
    });
}</p></div><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public void ConfigureServices(IServiceCollection services){
	services.Scan(scan =&gt; {
		scan.FromAssembliesOf(typeof(Startup))
			.RegisterHandlers(typeof(INotificationHandler&lt;&gt;));
	});
}</pre>



<p>Here we use the <em>.Scan()</em> method to go through the assembly containing a specific type and retrieving all the classes implementing <em>INotificationHandler&lt;&gt;</em>. For the sake of the example, I’m assuming that our handlers are in the same assembly as the <em>Startup</em> class.<br>We have to be also take into account that <em>RetryDecorator </em>implements <em>INotificationHandler&lt;&gt;</em> as well, and we don’t want any cyclic registration. This is handled nicely by <em>.RegisterHandlers()</em> :</p>



<div><div><div><p><span>public</span><span> </span><span>static</span><span> </span><span>class</span><span> IImplementationTypeSelectorExtensions</span></p></div><div><p><span>    </span><span>public</span><span> </span><span>static</span><span> IImplementationTypeSelector </span><span>RegisterHandlers</span><span>(</span><span>this</span><span> IImplementationTypeSelector selector, Type type</span><span>)</span><span></span></p></div><div><p><span>        </span><span>return</span><span> selector.</span><span>AddClasses</span><span>(</span><span>c =</span><span>&gt;</span><span></span></p></div><div><p><span>                    .</span><span>Where</span><span>(</span><span>t =</span><span>&gt;</span><span> t != </span><span>typeof</span><span>(</span><span>RetryDecorator</span><span>&lt;&gt;))</span><span></span></p></div><div><p><span>            .</span><span>UsingRegistrationStrategy</span><span>(</span><span>RegistrationStrategy.</span><span>Append</span><span>)</span><span></span></p></div><div><p><span>            .</span><span>AsImplementedInterfaces</span><span>()</span><span></span></p></div></div><p>public static class IImplementationTypeSelectorExtensions
{
    public static IImplementationTypeSelector RegisterHandlers(this IImplementationTypeSelector selector, Type type)
    {
        return selector.AddClasses(c =&gt;
                c.AssignableTo(type)
                    .Where(t =&gt; t != typeof(RetryDecorator&lt;&gt;))
            )
            .UsingRegistrationStrategy(RegistrationStrategy.Append)
            .AsImplementedInterfaces()
            .WithScopedLifetime();
    }
}</p></div><pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public static class IImplementationTypeSelectorExtensions
{
	public static IImplementationTypeSelector RegisterHandlers(this IImplementationTypeSelector selector, Type type)
	{
		return selector.AddClasses(c =&gt;
				c.AssignableTo(type)
					.Where(t =&gt; t != typeof(RetryDecorator&lt;&gt;))
			)
			.UsingRegistrationStrategy(RegistrationStrategy.Append)
			.AsImplementedInterfaces()
			.WithScopedLifetime();
	}
}</pre>



<p>Let’s see what’s happening here. The call to <em>AddClasses</em>() is going through the classes picked by our <em>selector</em> and adding them to the <em>IServicesCollection</em>. But with a twist: we only want classes that are assignable to a specific <em>type</em> (in this case <em>INotificationHandler</em>&lt;&gt; ) <strong>and</strong> we skip the current class if it’s <em>RetryDecorator</em>. </p>



<p>The rest of the code is making sure that the selected classes are <em>appended </em>to the container, without replacing existing ones. We also want them to be registered and discoverable using their implemented interfaces. And finally, we want them to use the <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1#scoped" target="_blank" rel="noreferrer noopener">Scoped lifetime</a>.</p>



<p>Piece of cake!</p>

			</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>