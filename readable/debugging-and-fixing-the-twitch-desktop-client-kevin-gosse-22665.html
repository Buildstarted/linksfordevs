<!DOCTYPE html>
<html lang="en">
<head>
    <title>linksfor.dev(s)</title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <meta property="article:author" content="Buildstarted"/>
    <meta property="og:site_name" content="linksfor.dev(s)" />
    <meta property="og:title" content="linksfor.dev(s)" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="A curated list of sources of development information including c#, c++, and other dev related links." />
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">üéâ</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Debugging and fixing the Twitch desktop client</title>
<div class="readable">
        <h1>Debugging and fixing the Twitch desktop client</h1>
        <p>
by Kevin Gosse <br/>Reading time: 13-16 minutes        </p>
        <p><a href="https://medium.com/@kevingosse/debugging-and-fixing-the-twitch-desktop-client-d1b38a349186">https://medium.com/@kevingosse/debugging-and-fixing-the-twitch-desktop-client-d1b38a349186</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><div><div><div><div><div><p><a rel="noopener" href="https://medium.com/@kevingosse?source=post_page-----d1b38a349186----------------------"><img alt="Kevin Gosse" src="https://miro.medium.com/fit/c/96/96/1*uQa2E6LGdotlsEg6fCm1yw.jpeg" width="48" height="48"></a></p></div></div></div></div><p id="ec08" data-selectable-paragraph="">I‚Äôve seen through the years that debugging is often misunderstood. Many people that are unfamiliar with debugging tend to think it‚Äôs all about mastering difficult and austere tools. I often had coworkers ask me ‚Äúwhat sequence of commands should I type in WinDbg to debug this kind of issue?‚Äù, as if debugging was about applying a simple flowchart with a complex tool. This is in fact quite the opposite. Debugging is all about the mindset and the methodology, and the tooling is the simple part. Thinking that debugging is about learning how to use WinDbg is like thinking you can become an investigative journalist by learning how to use a camera. Sure, this will help, but you won‚Äôt go very far with just that skill.</p><p id="9c3d" data-selectable-paragraph="">Where am I going with all this? A few days ago, I ran into a bug with the Twitch desktop app, and after a few hours and a bit of luck I was able to find the cause and fix it. I thought this would be a nice opportunity to explain the mindset and methodology involved in the debugging of an application you know almost nothing about. To that effect, this article won‚Äôt detail the tooling in depth but will retrace as exhaustively as possible the steps I took during the investigation, including the trial and error and false leads.</p><p id="7300" data-selectable-paragraph="">So, what‚Äôs the actual bug? When I tried to open the ‚ÄúMods‚Äù tab of the application, the page refused to load, just displaying a loading animation that went on forever:</p></div></div><div><div><p id="9df2" data-selectable-paragraph="">A quick search on forums revealed that the bug was widespread and had began with an application update in early April. Some users suggested workarounds that looked random, and none of those worked in my case. In the process, I discovered that at least part of the application is written in .NET (cue the <code>TwitchAgent.exe.config</code> file in the application folder). Unable to launch my game, I ended-up <em>de facto</em> with some free time that I decided to spend on debugging.</p><p id="b9cb" data-selectable-paragraph="">The first step was to gain more information on the issue itself. I quickly noticed a ‚Äúlogs‚Äù folder and started digging into it.</p><p id="bec1" data-selectable-paragraph="">One of the log files, for the TwitchUI process, revealed a lot about what was happening. The interesting sequence of logs was:</p><pre><span id="8d8b" data-selectable-paragraph="">[ElectronMain] Launching process (name: TwitchAgent.exe)<br>[ElectronMain] Connecting to service (name: TwitchAgent.exe)<br>[ElectronMain] Connecting (route: Twitch-App-Pipe-21572)<br>[ElectronMain] Creating IPC connection‚Ä¶<br>[ElectronMain] IPC Connection timed out!<br>[ElectronMain] Retrying connection.<br>[ElectronMain] Creating IPC connection‚Ä¶<br>[ElectronMain] IPC Connection timed out!<br>[ElectronMain] Retrying connection.<br>** same thing a few times**<br>[ElectronMain] No more connection retries. Process will relaunch once closed.<br>[ElectronMain] Process has closed.<br>** whole sequence would repeat a few times **<br>[ElectronMain] Reached attempt limit for process restarts; try to restart or reinstall!</span></pre><p id="5699" data-selectable-paragraph="">What can we deduce from this? There are two processes involved: TwitchUI and TwitchAgent. TwitchUI spawns a child TwitchAgent, then tries to establish a communication, probably using named pipes (<code>Twitch-App-Pipe-21572</code>). The connection would fail despite the numerous retries.</p><p id="81af" data-selectable-paragraph="">I tried using <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer" target="_blank" rel="noopener nofollow">Process Explorer</a> to confirm the sequence of events, and indeed I could see the child TwitchAgent process being spawned by TwitchUI, do some work for about 20 seconds, then exit. After 4‚Äì5 times, no more TwitchAgent processes were spawned.</p><p id="01d3" data-selectable-paragraph="">At that point, the most obvious possibility was that something wrong was going on with TwitchAgent. Luckily, that process also had logs, and at least one exception was logged:</p><pre><span id="38d1" data-selectable-paragraph="">"message": "Value cannot be null.\r\nParameter name: path1",<br>    "type": "System.ArgumentNullException",<br>    "stack": [<br>      "System.IO.Path.Combine(String,String)",<br>      "Curse.Radium.Minecraft.Utility.JavaFinder.FindJavas_Win(,<br>      "Curse.Radium.Minecraft.Utility.JavaFinder.FindJavas(),<br>      "Curse.Radium.Minecraft.Utility.JavaFinder.Refresh(),<br>      "Curse.Radium.Minecraft.MinecraftPlugin+&lt;&gt;c.&lt;InitInternal&gt;b__3_2(),<br>      "Curse.Common.Extensions.TaskEx+&lt;&gt;c__DisplayClass8_0.&lt;TryRun&gt;b__0(),<br>      "System.Threading.Tasks.Task.InnerInvoke()",<br>      "System.Threading.Tasks.Task.Execute()"</span></pre><p id="d9bf" data-selectable-paragraph="">Was it our culprit? After decompiling the <code>Curse.Radium.Minecraft.Utility.JavaFinder</code> class and looking at the <code>FindJavas_Win</code> method, I isolated the few calls to <code>Path.Combine</code>:</p><figure><div></div></figure><p id="1413" data-selectable-paragraph="">Since it was unlikely that the <code>Environment.GetFolderPath</code> method would return null, it seemed reasonable to think that <code>MinecraftLauncherManager.Instance.RuntimeFolder</code> was the culprit. To confirm it, I tried attaching a debugger configured to break on first chance exceptions. After breaking into <code>FindJavas_Win</code>, I inspected the value of the property, and sure enough it was null:</p></div></div><div><div><p id="0292" data-selectable-paragraph="">How to fix that? The property had a getter but not setter, so no easy way to assign a value from the debugger:</p><figure><div></div></figure><p id="c269" data-selectable-paragraph="">I tried tracking back to where the value initially came from, but quickly got lost. Instead, I figured out it would be easier to directly patch the assembly. I used a nifty feature from <a href="https://www.jetbrains.com/decompiler/" target="_blank" rel="noopener nofollow">Jetbrains dotPeek</a> to fully decompile the assembly and generate a csproj, and modified the code of the method to use a hardcoded value instead of the call to <code>Path.Combine</code>. Then I recompiled it and replaced the original assembly with the patched one. After starting the application, the issue was still there. More intriguing, the same exception was logged! Had I missed something?</p><p id="d874" data-selectable-paragraph="">Maybe the application wasn‚Äôt loading the right assembly and instead was using some kind of shadow copy. To check that, I reattached the debugger to the process and checked the ‚ÄúModules‚Äù window to make sure the assembly was loaded from the correct path. And it was, so something else was going on.</p><p id="7365" data-selectable-paragraph="">I then noticed that the module was marked as ‚ÄúOptimized‚Äù even though I compiled it in debug mode:</p></div></div><div><div><p id="5db2" data-selectable-paragraph="">Maybe I actually forgot to copy the file? Checking the modification date, the file was a few weeks old‚Ä¶ Silly me!</p><p id="540c" data-selectable-paragraph="">Making extra sure to copy the right assembly this time, I tried again and‚Ä¶ same result. Re-checking the file modification date, I noted it was back to a few weeks ago. Clearly, the application was overwriting it at startup, probably because of the auto-update feature. How to prevent that? I could find the auto-update code and patch it, but I decided it would be simpler to just remove the write permissions from the file. By chance, the auto-updater logged an error when failing to replace the file but wouldn‚Äôt prevent the application from starting.</p><p id="8323" data-selectable-paragraph="">After starting the application with the assembly properly patched, the aforementioned exception was gone. But the ‚ÄúMods‚Äù page still wouldn‚Äôt load. I found other exceptions in the logs, more patching to do?</p><p id="11f6" data-selectable-paragraph="">After fixing two more of those exceptions and still seeing no change with the bug, I decided to take a step back. It looked like all those exceptions were caused by uninitialized variables and were just the consequence of using the default settings in the app. They were logged but properly handled in the code, so I probably was on the wrong track.</p><p id="6941" data-selectable-paragraph="">I decided to spend more time analyzing the logs of TwitchAgent, this time ignoring the exceptions. After a while, I noticed this sequence of events:</p><pre><span id="eaf5" data-selectable-paragraph="">Connecting to IPC via pipe Twitch-App-Pipe-21572<br>Attempting Desktop Service connection.<br>Service connection timed out!<br>Attempting to reconnect. 2 attempts remaining<br>Attempting Desktop Service connection.<br>Service connection timed out!<br>Attempting to reconnect. 1 attempts remaining<br>Attempting Desktop Service connection.<br>Service connection timed out!<br>No connection retries remaining; performing safe shutdown.</span></pre><p id="6fd4" data-selectable-paragraph="">This seemed to match the logs I saw on TwitchUI! It seemed that the inter-process communication was failing for some reason. I suspected earlier that the application was using named pipes, so I started by confirming that in Process Explorer:</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*ThzjMrWOP9fujxgReKol3A.png?q=20" width="328" height="15" role="presentation"></p><p><img width="328" height="15" role="presentation"></p></div></div></div></figure><p id="8a8e" data-selectable-paragraph="">Sure enough, there was a named pipe with the naming pattern seen in the logs. Maybe a permission issue? I tried launching the app with administrator rights, but it didn‚Äôt change anything. I also cross-checked the logs of the two processes to make sure they were using the same name to connect to the pipe.</p><p id="dfb5" data-selectable-paragraph="">I decided to check the code in TwitchAgent responsible for connecting to the pipe to see if I could find an obvious mistake. Unfortunately, the inter-process communication was handled by a native library, TwitchIPC.dll, and decompiling native code is outside of my skill set. Instead, I tried to write two custom console applications that communicated using that library‚Ä¶ and it worked perfectly. So the issue wasn‚Äôt the library itself, but how the Twitch desktop app was using it. While writing my custom console application, I discovered that the TwitchIPC library had an integrated logger that could be activated by the caller. Seeing this, I decided to patch the TwitchAgent to enable those logs, the same way I did when fixing the exceptions. This allowed me to get the following logs:</p><pre><span id="c51a" data-selectable-paragraph="">9:44:10 PM: Creating server for pipe Twitch-App-Pipe-16688<br>9:44:10 PM: Twitch-App-Pipe-16688: starting connection.<br>9:44:10 PM: Twitch-App-Pipe-16688: starting with endpoint: \\.\pipe\Twitch-App-Pipe-16688‚Äì0<br>9:44:10 PM: Twitch-App-Pipe-16688: started successfully<br>9:44:10 PM: Twitch-App-Pipe-16688: connecting to endpoint \\.\pipe\Twitch-App-Pipe-16688‚Äì1<br>9:44:10 PM: Twitch-App-Pipe-16688: connection finished with status: connectFailed<br>9:44:10 PM: Twitch-App-Pipe-16688: remote does not exist yet. waiting for incomming connection.<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:10 PM: Twitch-App-Pipe-16688: sending message of length: 138<br>9:44:11 PM: Twitch-App-Pipe-16688: sending message of length: 218<br>9:44:11 PM: Twitch-App-Pipe-16688: sending message of length: 129<br>9:44:11 PM: Twitch-App-Pipe-16688: sending message of length: 116<br>9:44:13 PM: Twitch-App-Pipe-16688: disconnecting<br>9:44:13 PM: Twitch-App-Pipe-16688: shutting down</span></pre><p id="5831" data-selectable-paragraph="">What surprised me was how the agent was trying to send data (<em>sending message of length: 138</em>) even though the connection wasn‚Äôt properly established (<em>remote does not exist yet. waiting for incoming connection</em>). Maybe there was no buffering in TwitchIPC.dll, and TwitchAgent would send all the data before TwitchUI was ready to receive it? To test this hypothesis, I patched TwitchAgent once more, adding a semaphore to prevent the process from sending the data before the communication was established. But even so, the bug was still there! The logs would stop at <code>remote does not exist yet. waiting for incoming connection</code>, and nothing more would happen. An unexpected side-effect of my semaphore was that it also prevented the process from auto-exiting, since the main thread was blocked on my lock. I used that opportunity to connect my custom console app to the named pipe‚Ä¶ And I instantly received all the data! This meant that TwitchAgent was in fact working properly, the issue was on TwitchUI side.</p><p id="35ed" data-selectable-paragraph="">From that point, I started digging further in the logs of the TwitchUI process. Another interesting side-effect of my semaphore was helping me to see the moment when TwitchAgent tried to establish the connection: if the CPU usage of the process fell to 0%, it meant that the process was waiting on the lock. Thanks to this, and by watching closely the sequence of logs from TwitchUI during the startup of the application, I finally noticed something peculiar: the TwitchUI process would log <code>Reached attempt limit for process restarts; try to restart or reinstall</code> <strong><em>before</em> </strong>TwitchAgent established the connection! I double-checked with the timestamps in the logs to confirm and indeed: TwitchAgent took about 20 seconds to start, but TwitchUI would make 3 connection attempts of 3 seconds each, giving up after 9 seconds in total. The bug was probably that TwitchAgent took longer to start after the update, but the developers didn‚Äôt think of adjusting the timeout on TwitchUI side. It also explained the randomness of the workarounds found on the forums, since it was a timing issue.</p><p id="890e" data-selectable-paragraph="">Finding the issue is great, but we still need to fix it. Given that I already had patched a few assemblies used by TwitchAgent, I was confident that I could do the same thing with TwitchUI to adjust the timeout. That‚Äôs when I discovered that TwitchUI was an <a href="https://electronjs.org/" target="_blank" rel="noopener nofollow">Electron</a> app. DotPeek wouldn‚Äôt help me with that one.</p><p id="0825" data-selectable-paragraph="">Fortunately, by searching ‚Äúdecompile electron app‚Äù on Google, I quickly found <a target="_blank" rel="noopener" href="https://medium.com/how-to-electron/how-to-get-source-code-of-any-electron-application-cbb5c7726c37">this article</a> that explained everything I needed to know. It was easy to decompile TwitchUI (or really more ‚Äúunpack‚Äù, since an Electron app is just a Chromium frame running a web page) using a tool named ‚Äúasar‚Äù. Using it, I was able to extract the Javascript code that ran in the process. It was minified, but after pasting it <a href="https://beautifier.io/" target="_blank" rel="noopener nofollow">in a beautifier</a> and looking for the <code>IPC Connection timed out</code> message I saw in the logs, I was able to find this code:</p><figure><div></div></figure><p id="ba38" data-selectable-paragraph="">That confirmed the 3 seconds timeout I noticed in the logs. After changing the value to 60 seconds and re-launching the app, the bug was gone!</p></div></div><div><div><p id="daae" data-selectable-paragraph="">I hope this article gave some clues on how to debug an issue when you only have a limited knowledge of the application code. The key is to experiment as much as you can: gather as much information as possible, make a theory about what‚Äôs happening (no matter how crazy), and test it. You will very likely be wrong, but in the process you will gain more information, which in turn will help you building a new theory‚Ä¶ Until you hopefully manage to understand the issue. Patience is key, and don‚Äôt be afraid to fail.</p></div></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>