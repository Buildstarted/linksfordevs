<!DOCTYPE html>
<html lang="en">
<head>
    <title>
&#x201C;UPSERT&#x201D; Race Condition With MERGE - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="&#x201C;UPSERT&#x201D; Race Condition With MERGE - linksfor.dev(s)"/>
    <meta property="og:description" content="I mentioned in Conditional INSERT/UPDATE Race Conditionthat most &#x201C;UPSERT&#x201D; code is defective and can lead to constraint violations and data integrity issues in a multi-user environment .In this post, I&#x2019;ll show how to prevent duplicate key errors and data problems with the MERGE statement too."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://weblogs.sqlteam.com/dang/2009/01/31/upsert-race-condition-with-merge/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">üéâ</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - &#x201C;UPSERT&#x201D; Race Condition With MERGE</title>
<div class="readable">
        <h1>&#x201C;UPSERT&#x201D; Race Condition With MERGE</h1>
            <div>Reading time: 16-20 minutes</div>
        <div>Posted here: 23 Sep 2019</div>
        <p><a href="https://weblogs.sqlteam.com/dang/2009/01/31/upsert-race-condition-with-merge/">https://weblogs.sqlteam.com/dang/2009/01/31/upsert-race-condition-with-merge/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
      <div>
        <div>

          


<article>
  <header>
    <h2><a href="https://weblogs.sqlteam.com/dang/2009/01/31/upsert-race-condition-with-merge/">‚ÄúUPSERT‚Äù Race Condition With MERGE</a></h2>
    <p><time datetime="2009-01-31T12:43:12-06:00">Sat Jan 31, 2009</time> by Dan Guzman</p>
  </header>
  <p><span face="Calibri" size="3">I mentioned in </span><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><span face="Calibri" size="3">Conditional INSERT/UPDATE Race Condition</span></a><span face="Calibri" size="3"> that most ‚ÄúUPSERT‚Äù code is defective and can lead to constraint violations and data integrity issues in a multi-user environment .<span>&nbsp; </span>In this post, I‚Äôll show how to prevent duplicate key errors and data problems with the MERGE statement too.<span>&nbsp; </span>You might want to peruse </span><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><span face="Calibri" size="3">Conditional INSERT/UPDATE Race Condition</span></a><span face="Calibri" size="3"> before reading this for a background on these concurrency concerns.</span></p>
<h2><span face="Calibri" color="#17365d" size="4">Background on MERGE</span></h2>
<p><span face="Calibri" size="3">Microsoft introduced the ANSI-standard MERGE statement in SQL Server 2008.<span>&nbsp; </span>MERGE is very powerful in that it can perform multiple actions in a single statement that previously required separate INSERT/UPDATE/DELETE statements.<span>&nbsp; </span>MERGE is also a good alternative to the proprietary UPDATE‚Ä¶FROM syntax allowed in the T-SQL dialect. </span></p>
<p><span face="Calibri" size="3">MERGE can (and in my opinion should) be used to address the requirement to either INSERT or UPDATE depending on whether the source data already exists.<span>&nbsp; </span>One need only include the MERGE statement clauses WHEN MATCHED THEN UPDATE and WHEN NOT MATCHED THEN INSERT in order to take the proper action, all within a single statement.</span></p>
<h2><span size="4"><span color="#17365d"><span face="Calibri"><span>&nbsp;</span>‚ÄúUPSERT‚Äù MERGE Concurrency Test</span></span></span></h2>
<p><span face="Calibri" size="3">Even though MERGE provides the means to perform multiple actions within a single statement, developers still need to consider concurrency with MERGE to prevent errors and data issues.<span>&nbsp; </span>Let me illustrate using the table and stored procedure that I originally posted in </span><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><span face="Calibri" size="3">Conditional INSERT/UPDATE Race Condition</span></a><span face="Calibri" size="3">:</span></p>
<div>
            <p><span>CREATE</span><span> <span>TABLE</span> dbo<span>.</span>Foo<o:p></o:p></span></p>
            <p><span>(<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ID <span>int</span> <span>NOT</span> <span>NULL<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>CONSTRAINT</span> PK_Foo <span>PRIMARY</span> <span>KEY</span><span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Bar <span>int</span> <span>NOT</span> <span>NULL<o:p></o:p></span></span></p>
            <p><span>);<o:p></o:p></span></p>
            <p><span>GO<o:p></o:p></span></p>
            
            <p><span>CREATE</span><span> <span>PROCEDURE</span> dbo<span>.</span>Merge_Foo<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@ID <span>int</span><span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@Bar <span>int<o:p></o:p></span></span></p>
            <p><span>AS<o:p></o:p></span></p>
            
            <p><span>SET</span><span> <span>NOCOUNT</span><span>,</span> <span>XACT_ABORT</span> <span>ON</span><span>;<o:p></o:p></span></span></p>
            
            <p><span>MERGE</span><span> dbo<span>.</span>Foo <span>AS</span> f<o:p></o:p></span></p>
            <p><span>USING </span><span>(</span><span>SELECT</span><span> @ID <span>AS</span> ID<span>,</span> @Bar <span>AS</span> Bar<span>)</span> <span>AS</span> new_foo<o:p></o:p></span></p>
            <p><span>ON</span><span> f<span>.</span>ID <span>=</span> new_foo<span>.</span>ID<o:p></o:p></span></p>
            <p><span>WHEN</span><span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>UPDATE</span> <span>SET</span> f<span>.</span>Bar <span>=</span> new_foo<span>.</span>Bar<o:p></o:p></span></p>
            <p><span>WHEN</span><span> <span>NOT</span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>INSERT </span><span>(</span>ID<span>,</span> Bar<span>)<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>VALUES </span><span>(</span>new_foo<span>.</span>ID<span>,</span> new_foo<span>.</span>Bar<span>);<o:p></o:p></span></span></p>
            
            <p><span>RETURN</span><span> <span>@@ERROR</span><span>;<o:p></o:p></span></span></p>
            <p><span>GO</span></p>
            </div>
<p><span face="Calibri" size="3">I ran the script below from 2 different SSMS windows after changing the time to the near future so that both executed at the same time.<span>&nbsp; </span>My test box had a single quad-core processor with SQL Server 2008 Developer Edition installed, which I expected to have enough multi-processing power to create the error.</span></p>
<div>
            <p><span>WAITFOR</span><span> TIME <span>'08:00:00'<o:p></o:p></span></span></p>
            
            <p><span>EXEC</span><span> dbo<span>.</span>Merge_Foo<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@ID <span>=</span> 1<span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@Bar <span>=</span> 1</span></p>
            </div>
<p><span size="3"><span face="Calibri"><strong><em>I got a primary key violation error, showing that MERGE is vulnerable to concurrency problems like a multi-statement conditional INSERT/UPDATE technique</em></strong>. However, I couldn‚Äôt reproduce the error with MERGE nearly as consistently as I could with the conditional INSERT/UPDATE in </span></span><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><span face="Calibri" size="3">Conditional INSERT/UPDATE Race Condition</span></a><span face="Calibri" size="3">.<span>&nbsp; </span>This could be due to a number of reasons (e.g. faster processor, different SQL Server version, MERGE locking behavior) but I wanted to make sure I could reproduce the error reliably.<span>&nbsp; </span>I created a more robust test to exercise MERGE on a loop:</span></p>
<div>
            <p><span>CREATE</span><span> <span>TABLE</span> dbo<span>.</span>Foo2<o:p></o:p></span></p>
            <p><span>(<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ID <span>int</span> <span>NOT</span> <span>NULL<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>CONSTRAINT</span> PK_Foo2 <span>PRIMARY</span> <span>KEY</span><span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InsertSpid <span>int</span> <span>NOT</span> <span>NULL,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InsertTime <span>datetime2</span> <span>NOT</span> <span>NULL,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>UpdateSpid <span>int</span> <span>NULL,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>UpdateTime <span>datetime2</span> <span>NULL<o:p></o:p></span></span></p>
            <p><span>);</span></p>
            </div>

<div>
            <p><span>CREATE</span><span> <span>PROCEDURE</span> dbo<span>.</span>Merge_Foo2<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@ID <span>int<o:p></o:p></span></span></p>
            <p><span>AS<o:p></o:p></span></p>
            
            <p><span>SET</span><span> <span>NOCOUNT</span><span>,</span> <span>XACT_ABORT</span> <span>ON</span><span>;<o:p></o:p></span></span></p>
            
            <p><span>MERGE</span><span> dbo<span>.</span>Foo2 <span>AS</span> f <o:p></o:p></span></p>
            <p><span>USING </span><span>(</span><span>SELECT</span><span> @ID <span>AS</span> ID<span>)</span> <span>AS</span> new_foo<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>ON</span> f<span>.</span>ID <span>=</span> new_foo<span>.</span>ID<o:p></o:p></span></p>
            <p><span>WHEN</span><span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>UPDATE<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>SET</span> f<span>.</span>UpdateSpid <span>=</span> <span>@@SPID</span><span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>UpdateTime <span>=</span> <span>SYSDATETIME</span><span>()</span> <o:p></o:p></span></p>
            <p><span>WHEN</span><span> <span>NOT</span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>INSERT<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span>(<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ID<span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InsertSpid<span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InsertTime<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>)<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>VALUES<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span>(<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>new_foo<span>.</span>ID<span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>@@SPID</span><span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>SYSDATETIME</span><span>()<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>);<o:p></o:p></span></span></p>
            
            <p><span>RETURN</span><span> <span>@@ERROR</span><span>;</span></span></p>
            </div>
<p><span size="3"><span face="Calibri">I ran the script below from 4 different SSMS windows after changing the time to the near future so that all executed at the same time.<span>&nbsp; </span><span>&nbsp;</span></span></span></p>
<div>
            <p><span>DECLARE<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span>@NextTime <span>datetime</span><span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span>@ID <span>int</span><span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span>@MillisecondDelay <span>int</span><span>;<o:p></o:p></span></span></p>
            <p><span>SELECT<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span>@NextTime <span>=</span> <span>'08:10:00'</span><span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span>@ID <span>=</span> 1<span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span>@MillisecondDelay <span>=</span> 100<span>;<o:p></o:p></span></span></p>
            <p><span>--execute 10 times per second for 1 minute</span><span><o:p></o:p></span></p>
            <p><span>WHILE</span><span> @ID <span>&lt;=</span> 600 <span><o:p></o:p></span></span></p>
            <p><span>BEGIN<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span>--pause and sync with other sessions</span><span><o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>WAITFOR</span> <span>TIME</span> @NextTime<span>;</span><span><o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>EXEC</span> dbo<span>.</span>Merge_Foo2<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span>@ID <span>=</span> @ID<span>;<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>SELECT</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@ID <span>=</span> @ID <span>+</span> 1<span>,<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>--assume no more that 100ms per execution</span><span><o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@NextTime <span>=</span> <span>DATEADD</span><span>(</span><span>MILLISECOND</span><span>,</span> @MillisecondDelay<span>,</span> @NextTime<span>);</span><span><o:p></o:p></span></span></p>
            <p><span>END</span><span>;</span><span><o:p></o:p></span></p>
            </div>
<p><span face="Calibri" size="3">I was able to reproduce the primary key violation every time with this test script.</span></p>
<h2><span face="Calibri" color="#17365d" size="4">Addressing the MERGE Race Condition</span></h2>
<p><span face="Calibri" size="3">The underlying issue with any conditional insert technique is that data must be read before the determination can be made whether to INSERT or UPDATE.<span>&nbsp; </span>To prevent concurrent sessions from inserting data with the same key, an incompatible lock must be acquired to ensure only one session can read the key and that lock must be held until the transaction completes.</span></p>
<p><span face="Calibri" size="3">I showed how one might address the problem using both UPDLOCK and HOLDLOCK locking hints in </span><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><span face="Calibri" size="3">Conditional INSERT/UPDATE Race Condition</span></a><span face="Calibri" size="3">.<span>&nbsp; </span>MERGE is slightly different, though.<span>&nbsp; </span>I repeated the test with only the HOLDLOCK hint added:</span></p>
<div>
            <p><span>ALTER</span><span> <span>PROCEDURE</span> dbo<span>.</span>Merge_Foo2<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>@ID <span>int<o:p></o:p></span></span></p>
            <p><span>AS<o:p></o:p></span></p>
            
            <p><span>SET</span><span> <span>NOCOUNT</span><span>,</span> <span>XACT_ABORT</span> <span>ON</span><span>;<o:p></o:p></span></span></p>
            
            <p><span>MERGE</span><span> dbo<span>.</span>Foo2 <span>WITH </span><span>(</span><span>HOLDLOCK</span><span>)</span> <span>AS</span> f <o:p></o:p></span></p>
            <p><span>USING </span><span>(</span><span>SELECT</span><span> @ID <span>AS</span> ID<span>)</span> <span>AS</span> new_foo<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>ON</span> f<span>.</span>ID <span>=</span> new_foo<span>.</span>ID<o:p></o:p></span></p>
            <p><span>WHEN</span><span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>UPDATE<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>SET</span> f<span>.</span>UpdateSpid <span>=</span> <span>@@SPID</span><span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>UpdateTime <span>=</span> <span>SYSDATETIME</span><span>()</span> <o:p></o:p></span></p>
            <p><span>WHEN</span><span> <span>NOT</span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>INSERT<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span>(<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ID<span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InsertSpid<span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InsertTime<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>)<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp; </span><span>VALUES<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span>(<o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>new_foo<span>.</span>ID<span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>@@SPID</span><span>,</span> <o:p></o:p></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>SYSDATETIME</span><span>()<o:p></o:p></span></span></p>
            <p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>);<o:p></o:p></span></span></p>
            
            <p><span>RETURN</span><span> <span>@@ERROR</span><span>;</span></span></p>
            </div>
<p><span size="3"><span face="Calibri"><strong><em>This test showed that simply adding the HOLDLOCK hint prevented the primary key violation error.</em></strong><span>&nbsp; </span>Unlike the conditional INSERT/UPDATE in </span></span><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><span face="Calibri" size="3">Conditional INSERT/UPDATE Race Condition</span></a><span face="Calibri" size="3">, MERGE acquired a key update lock by default so UPDLOCK was not needed.<span>&nbsp; </span>Also, in contrast the multi-statement conditional INSERT/UPDATE technique, no explicit transaction is required because MERGE is an atomic DML statement.<span>&nbsp; </span>The HOLDLOCK hint was still needed, though, because MERGE otherwise releases the update key lock before the insert.<span>&nbsp; </span>I gleaned this by examining the locks from a Profiler trace of the MERGE without the HOLDLOCK:</span></p>
<table>
    <tbody>
        <tr>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">EventClass<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">TextData<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">Mode<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">ObjectID<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">Type<o:p></o:p></span></span></span></strong></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">SP:Starting<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap"><span face="Calibri" size="3"></span></td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1314103722<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap"><span face="Calibri" size="3"></span></td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap"><span face="Calibri" size="3"></span></td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1330103779<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - OBJECT<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1:173<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - IU<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">6 - PAGE<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">4 - U<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">4 - U<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1:173<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - IU<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">6 - PAGE<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1:173<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">6 - PAGE<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">15 - RangeI-N<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - X<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - X<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1:173<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">6 - PAGE<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap"><span face="Calibri" size="3"></span></td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1330103779<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - OBJECT<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">SP:Completed<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap"><span face="Calibri" size="3"></span></td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1314103722<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap"><span face="Calibri" size="3"></span></td>
        </tr>
    </tbody>
</table>
<p><span face="Calibri" size="3">If another concurrent MERGE of the same key occurs after the update lock is released and before the exclusive key lock is acquired, a duplicate key error will result.</span></p>
<p><span face="Calibri" size="3">The trace below of the MERGE with the HOLDLOCK hint shows that locks aren‚Äôt released until the insert (and statement) completes, this avoiding the concurrency problem with MERGE.</span></p>
<table>
    <tbody>
        <tr>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">EventClass<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">TextData<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">Mode<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">ObjectID<o:p></o:p></span></span></span></strong></p>
            </td>
            <td nowrap="nowrap">
            <p><strong><span><span size="3"><span face="Calibri">Type<o:p></o:p></span></span></span></strong></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">SP:Starting<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1314103722<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1330103779<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - OBJECT<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1:173<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - IU<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">6 - PAGE<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">4 - U<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1:173<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">6 - PAGE<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">15 - RangeI-N<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Acquired<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - X<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">(10086470766)<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - X<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">7 - KEY<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1:173<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">0<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">6 - PAGE<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">Lock:Released<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">8 - IX<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1330103779<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">5 - OBJECT<o:p></o:p></span></span></span></p>
            </td>
        </tr>
        <tr>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">SP:Completed<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            
            </td>
            <td nowrap="nowrap">
            <p><span><span size="3"><span face="Calibri">1314103722<o:p></o:p></span></span></span></p>
            </td>
            <td nowrap="nowrap">
            
            </td>
        </tr>
    </tbody>
</table>


<div>


    <table>
        
        <tbody><tr>
                <td colspan="2"><hr></td>
        </tr>
        <tr>
            <td>
                
                Vadym 
                
                <br> 
                2009-02-03</td>
            <td>re: ‚ÄúUPSERT‚Äù Race Condition With MERGE <br> I noticed that there must be something suspicious with concurency in this new operator when was reading "Introducing SQL Server 2008". And here you provide full test and description of this! Many thanks, very interesting</td>
        </tr>
        
        
        <tr>
                <td colspan="2"><hr></td>
        </tr>
        <tr>
            <td>
                
                Jens 
                
                <br> 
                2009-02-08</td>
            <td>re: ‚ÄúUPSERT‚Äù Race Condition With MERGE <br> Great Dan, this solved a lot of problems for me. But I have a very delicate issue when using Insert OVER DML with MERGE. I have a lot of similar stored procedures as in your article but I use Insert OVER DML to store/archive the old record. I will get the primary key violation error in this case and even I try to put a holdlock on the merge statement it will not work. <p>I also tried setting a HOLDLOCK on the Insert OVER DML statement but I will neither solve my problem.</p><p>Have searched everywhere for a solution, is this something you have the answer for ?</p><p>Thanks again for your article !</p></td>
        </tr>
        
        
        <tr>
                <td colspan="2"><hr></td>
        </tr>
        <tr>
            <td>
                <strong>
                Dan Guzman 
                </strong>
                <br> 
                2009-02-08</td>
            <td>re: ‚ÄúUPSERT‚Äù Race Condition With MERGE <br> Hi, Jens.<p>I see from your separate email that you were able to fix the problem.  I'm sharing below so that others might benefit from your experience.</p><p>----------------------<br>I managed to sort out the problem. I just forgot to use the new SYSDATETIME(), I used GETDATE() and it return three fraction detail which is not enough since the column is a DateTime2(7) type. This will cause a constraint failure in my case because the constraint lies on this column togheter with the ID.</p><p>Easy to solve.</p><p>B.rgd</p><p>Jens</p></td>
        </tr>
        
        
        <tr>
                <td colspan="2"><hr></td>
        </tr>
        <tr>
            <td>
                
                Ernesto Perales Soto 
                
                <br> 
                2012-08-22</td>
            <td>re: ‚ÄúUPSERT‚Äù Race Condition With MERGE <br> I had a very similar problem to the one described here. I think most of people would believe that a MERGE is atomic (in the sense that the table contents won't change between the SELECT part and the INSERT/UPDATE part). Great post. </td>
        </tr>
        
        
    </tbody></table>
</div>


  

  

</article> 



        </div> <!-- /.blog-main -->

        


      </div> <!-- /.row -->
    </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
</body>
</html>