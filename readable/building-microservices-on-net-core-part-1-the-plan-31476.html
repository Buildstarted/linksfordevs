<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Building Microservices On .NET Core - Part 1 The Plan | Wojciech Suwa&#x142;a, Head Architect, ASC LAB - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Building Microservices On .NET Core - Part 1 The Plan | Wojciech Suwa&#x142;a, Head Architect, ASC LAB - linksfor.dev(s)"/>
    <meta property="og:description" content="I liked .NET technology from its inception. In fact I left the dark star of overxmlized J2EE development to join forces of rebellion around 2004. Over the years my team here at Altkom Software &amp; Consulting built and maintained more and more complex business solutions for insurance and banking."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://altkomsoftware.pl/en/blog/building-microservices-on-net-core-1/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
				<a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Building Microservices On .NET Core - Part 1 The Plan | Wojciech Suwa&#x142;a, Head Architect, ASC LAB</title>
<div class="readable">
        <h1>Building Microservices On .NET Core - Part 1 The Plan | Wojciech Suwa&#x142;a, Head Architect, ASC LAB</h1>
            <div>Reading time: 8-10 minutes</div>
        <div>Posted here: 29 Jul 2019</div>
        <p><a href="https://altkomsoftware.pl/en/blog/building-microservices-on-net-core-1/">https://altkomsoftware.pl/en/blog/building-microservices-on-net-core-1/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="ht-page"><!-- #ht-masthead --><div id="ht-content"><section> <!--<div class="ht-service-left-bg"></div>--><div><div><article id="post-1987"><div id="blog"> <!-- .entry-meta --><figure> <a href="https://altkomsoftware.pl/en/blog/building-microservices-on-net-core-1/"> <img src="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2019/01/microservices-NET-Core.png" data-src="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2019/01/microservices-NET-Core.png" alt="Building Microservices On .NET Core – Part 1 The Plan"> </a></figure><p>I liked .NET technology from its inception. In fact I left the dark star of overxmlized J2EE development to join forces of rebellion around 2004. Over the years my team here at Altkom Software &amp; Consulting built and maintained more and more complex business solutions for <a href="https://altkomsoftware.pl/en/products/whitelabel/">insurance</a> and <a href="https://altkomsoftware.pl/en/#products">banking</a>. While Java was in stagnation .NET platform developed very quickly. Several open source libraries were created and widely adopted like for example <a href="http://nhibernate.info/" target="_blank" rel="nofollow noopener">NHibernate</a>, <a href="http://www.castleproject.org/" target="_blank" rel="nofollow noopener">Castle Project</a> or <a href="https://logging.apache.org/log4net/" target="_blank" rel="nofollow noopener">log4net</a>. Things get even better with ASP.NET MVC. But somewhere around 2014 things changed as Microsoft started to heavily invest in .NET Core. The idea seemed great – have .NET running on all major platforms. But it took many years to achieve and first releases were a bit disappointing. So many missing APIs caused that many of our favourites libraries were not ported. First versions of Entity Framework lacked critical features. The future of .NET seemed doubtful. At the same time Java 8 came out and brought coolness back to the language, also microservice based approach to architecture emerged. This together with <a href="http://spring.io/projects/spring-boot" target="_blank" rel="nofollow noopener">Spring Boot</a> convinced me to move back to Java land.</p><p>But recent .NET releases – especially .NET Core 2.x and .NET standard initiative convinced me that .NET core is back in the business. So I with my teammates decided to explore possibilities and challenges of building microservice based solutions on .NET Core.</p><p>We have a lot of experience in the microservice area as we develop and deploy systems in this architectural approach since 2015. We wanted to find out possible options for dealing with typical microsevice related tasks like service discovery, service communication synchronous and asynchronous, data access to various data sources (relational and noSQL), logging, resilience, error handling, security with JWT and api gateway building.</p><h2><strong>The Plan</strong></h2><p>In this series of articles we are going to walk through typical tasks required to build microservices based solution.</p><p>These tasks include:</p><ul><li>Designing internal architecture of a microservice with<ul><li>CQRS</li><li>Event Sourcing</li></ul></li><li>Accessing data sources with<ul><li>Entity Framework Core with PostgreSQL</li><li>NHibernate</li><li>Marten with PostgreSQL</li><li>NEST with ElasticSearch</li></ul></li><li>Communication between microservices<ul><li>Synchronous with direct HTTP REST calls</li><li>Asynchronous with RabbitMQ</li></ul></li><li>API Gateways with Ocelot</li><li>Service discovery with Eureka</li><li>Resilience with Polly</li><li>Logging with Serilog</li><li>Securing services with JWT</li><li>Running background jobs with Hangfire</li><li>Log aggregation with ELK</li><li>Metrics and monitoring</li><li>CI/CD with Azure DevOps</li><li>Deploying services to<ul><li>Azure</li><li>Kubernetes</li></ul></li></ul><h2><b>List of published articles</b></h2><p><strong>Part 2:</strong> <a href="https://altkomsoftware.pl/en/blog/microservices-net-core-cqrs-mediatr/">Shaping microservice internal architecture with CQRS and MediatR</a><br> <strong>Part 3:</strong> <a href="https://altkomsoftware.pl/en/blog/service-discovery-eureka/">Service Discovery with Eureka</a><br> <strong>Part 4:</strong> <a href="https://altkomsoftware.pl/en/blog/building-api-gateways-with-ocelot/">Building API Gateways With Ocelot</a><br> <strong>Part 5:</strong> <a href="https://altkomsoftware.pl/en/blog/building-microservices-domain-aggregates/">Marten An Ideal Repository For Your Domain Aggregates</a><br> <strong>Part 6:</strong> <a href="https://altkomsoftware.pl/en/blog/building-microservices-6/">Real time server client communication with SignalR and RabbitMQ</a></p><p>The list will be updated after the publication of a new article in the series.<br></p><h2><strong>Business Case</strong></h2><p>We are going to build very simplified system for insurance agents to sell various kind of insurance products.</p><p>Insurance agents will have to log in and system will present them list of products they can sell. Agents will be able to view products and find a product appropriate for their customers. Then they can create an offer and system will calculate a price based on provided parameters.</p><p>Finally agent will be able to confirm the sale by converting offer to policy and printing pdf certificate.</p><p>Portal will also give them ability to search and view offer and policies.</p><p>Portal will also have some basic social network features like chat for agents.</p><h2><strong>Solution Architecture</strong></h2><p>You can find architectural diagram of our system below.</p><p><a href="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1.png"><img src="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1.png" data-src="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1.png" alt="Building Microservices" width="1600" height="701" data-srcset="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1.png 1600w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1-300x131.png 300w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1-768x336.png 768w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1-1024x449.png 1024w" data-sizes="(max-width: 1600px) 100vw, 1600px" srcset="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1.png 1600w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1-300x131.png 300w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1-768x336.png 768w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-1-1024x449.png 1024w"></a></p><p>The system consists of:</p><ul><li><b>Frontend </b>– a VueJS Single Page Application that provides insurance agents ability to select appropriate product for their customers, calculate price, create an offer and conclude the sales process by converting offer to policy. This application also provides search and view functions for policies and offers. Frontend talks to backend services via api-gateway.</li><li><b>Agent Portal API Gateway</b> – is a special microservice whose main purpose it to hide complexity of the underlying back office services structure from client application. Usually we create a dedicated API gateway for each client app. In case in the future we add a Xamarin mobile app to our system, we will need to build a dedicated API gateway for it. API gateway provides also security barrier and does not allow unauthenticated request to be passed to backend services. Another popular usage of API gateways is content aggregation from multiple services.</li><li><b>Auth Service</b> – a service responsible for users authentication. Our security system will be based on <a href="https://jwt.io/" target="_blank" rel="nofollow noopener">JWT</a> tokens. Once user identifies himself correctly, auth service issues a token that is further use to check user permission and available products.</li><li><b>Chat Service</b> – a service that uses SignalR to give agents ability to chat with each other.</li><li><b>Pricing Service</b> – a service responsible for calculation of price for given insurance product based on its parametrization.</li><li><b>Policy Service</b> – main service in our system. It is responsible for creation of offers and policies. It uses Pricing Service via REST http calls to calculate the price. Once a policy is created it sends asynchronous event to the event bus (RabbitMQ) so other services can react.</li><li><b>Policy Search Service</b> – a sole purpose of this service is to expose search functionality. This service subscribes to events related to policy lifecycle and indexes given policy in ElasticSearch to provide advanced search capabilities.</li><li><b>Payment Service</b> – this service is responsible for managing financial operations related to policy. It subscribes to policy related events, creates policy account when policy is created, registers expected payments. It also has a very simplified background job that parses file with incoming payments and assigns it to proper policy account.</li><li><b>Product Service</b> – this is a product catalog. It provides basic information about each insurance product and its parameters that can be customized while creating an offer for a customer.</li><li><b>Document Service</b> – this service uses JS Report to generate pdf certificates.</li></ul><p>As you can see services are decomposed by business capability. We also have one technical service – document service. Introducing technical services makes sense when they require scalability/resilience and we want reduce time to update/fix or licence costs.</p><p>Each microservice is built around <a href="https://martinfowler.com/bliki/BoundedContext.html" target="_blank" rel="nofollow noopener">bounded context</a> in DDD terms. Also you can observe that they cooperate to achieve the main business goal – to sell an insurance product to the end customer.</p><h2><strong>Solution Structure</strong></h2><p>Below is a fragment of our solution open in <a href="https://www.jetbrains.com/rider/" target="_blank" rel="nofollow noopener">Rider IDE</a>. As you can see for each microservice we create three projects: one for API definition, one for implementation and one for tests. You can find source code for our project here on <a href="https://github.com/asc-lab/dotnetcore-microservices-poc" target="_blank" rel="nofollow noopener">our GitHub</a>. Note that it is work in progress and code will change as we progress with our series.</p><p><a href="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-2.png"><img src="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-2.png" data-src="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-2.png" alt="Building Microservices" width="351" height="694" data-srcset="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-2.png 351w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-2-152x300.png 152w" data-sizes="(max-width: 351px) 100vw, 351px" srcset="https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-2.png 351w, https://altkomsoftware.pl/en/wp-content/uploads/sites/6/2018/12/Building-Microservices-2-152x300.png 152w"></a></p><p>API definition project contains classes and interfaces that describe service capabilities exposed to the external world in form of commands it can handle, queries it can answer, events it emits and data transfer object classes it exposes. We can treat these as port definitions in a <a href="https://herbertograca.com/2017/09/14/ports-adapters-architecture/" target="_blank" rel="nofollow noopener">ports and adapters architecture</a>.</p><p>Implementation project contains command handlers, query handlers and notification handlers which together provide service functionality. Most of the business logic goes into domain model part. Adapters for talking to external world are implemented as controllers (for handling incoming HTTP requests), listeners (for events delivered via queue) and REST Clients (for handling outgoing http requests).</p><p>Test project contains both unit tests and integration test.</p><h2><strong>Summary</strong></h2><p>In our opinion .NET Core is a great platform for building microservices and in this series of articles we would like to prove it. There is a rich ecosystem of open source tools and libraries around it. The C# language itself is a great tool.</p><p>The platform and libraries are all open source and new features are delivered at very high velocity.</p><p>Also .NET Core 2.x enhancements around performance and memory usage make<a href="https://www.techempower.com/benchmarks/#section=data-r17&amp;hw=ph&amp;test=fortune" target="_blank" rel="nofollow noopener"> it even more attractive</a>.</p><p>In the coming articles we are going to present our findings and solutions for common tasks related to microservices implementation and deployment.<br> &nbsp;</p><div><h3><span><strong>Are you preparing migration to microservices?</strong></span></h3><h4><span>Find out potential benefits&nbsp; &nbsp;&nbsp;</span><span>•&nbsp; &nbsp; Check technical feasibility&nbsp; &nbsp;&nbsp;</span><span>•&nbsp; &nbsp; Get roadmap with action plan</span></h4></div><p><span id="post-ratings-1987-loading"> <img src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%2016%2016%22%3E%3C/svg%3E" data-src="https://altkomsoftware.pl/en/wp-content/plugins/wp-postratings/images/loading.gif" width="16" height="16">Loading...</span> <span><span><strong>Czy podobał Ci się artykuł?</strong></span> Jeśli tak, udostępnij go w swojej sieci!</span></p></div> <!-- .entry-content --></article> <!-- #post-## --></div></div></section></div><!-- #content --><!-- #colophon --></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>