<!DOCTYPE html>
<html lang="en">
<head>
    <title>linksfor.dev(s)</title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">üéâ</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <div class="readable">
        <h1>.NET Internals Cookbook Part 12 &#x2014; Memory structure, attributes, handles &#x2013; Random IT Utensils</h1>
        <p>
Reading time: 10-13 minutes        </p>
        <p><a href="https://blog.adamfurmanek.pl/2019/05/04/net-internals-cookbook-part-12/">https://blog.adamfurmanek.pl/2019/05/04/net-internals-cookbook-part-12/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
                         <blockquote><p>This is the twelfth part of the .NET Internals Cookbook series. For your convenience you can find other parts in the table of contents in <a href="https://blog.adamfurmanek.pl/2019/02/16/net-internals-cookbook-part-0/">Part 0 ‚Äì Table of contents</a></p></blockquote>
<h6>82. What is a bit-mapped attribute? Custom attribute? Pseudo-custom attribute?</h6>
<p>There are three types of attributes:</p>
<ol>
<li>Bit-mapped ‚Äî for instance <code>public</code></li>
<li>Custom ‚Äî the ‚Äúnormal‚Äù attributes like <code>[MyCustom]</code></li>
<li>Pseudo-custom ‚Äî look like custom attributes but behave like bit-mapped ones, for instance <code>Serializable</code></li>
</ol>
<p>Let‚Äôs take <a href="https://dotnetfiddle.net/yNidOv">this code</a>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153bdf893167235" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>using </span><span>System</span><span>;</span></p><p><span>[</span><span>Custom</span><span>]</span></p><p><span>[</span><span>Serializable</span><span>]</span></p><p><span>public</span><span> </span><span>class</span><span> </span><span>Program</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>static</span><span> </span><span>void</span><span> </span><span>Main</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p><p><span>class</span><span> </span><span>CustomAttribute</span><span> </span><span>:</span><span> </span><span>Attribute</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>CustomAttribute</span><span>(</span><span>)</span><span> </span><span>{</span><span> </span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<p>Which you can decompile to:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153be8060195332" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p></div>
				</td>
						<td><div><p><span>.</span><span>class</span><span> </span><span>public</span><span> </span><span>auto </span><span>ansi </span><span>serializable </span><span>beforefieldinit </span><span>Program</span></p><p><span>	</span><span>extends</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Object</span></p><p><span>{</span></p><p><span>	</span><span>.</span><span>custom </span><span>instance </span><span>void</span><span> </span><span>CustomAttribute</span><span>::</span><span>.</span><span>ctor</span><span>(</span><span>)</span><span> </span><span>=</span><span> </span><span>(</span></p><p><span>		</span><span>01</span><span> </span><span>00</span><span> </span><span>00</span><span> </span><span>00</span></p><p><span>	</span><span>)</span></p><p><span>	</span><span>// Methods</span></p><p><span>	</span><span>.</span><span>method </span><span>public</span><span> </span><span>hidebysig </span><span>static</span><span> </span></p><p><span>		</span><span>void</span><span> </span><span>Main</span><span> </span><span>(</span><span>)</span><span> </span><span>cil</span><span> </span><span>managed</span><span> </span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// Method begins at RVA 0x2050</span></p><p><span>		</span><span>// Code size 2 (0x2)</span></p><p><span>		</span><span>.</span><span>maxstack</span><span> </span><span>8</span></p><p><span>		</span><span>.</span><span>entrypoint</span></p><p><span>		</span><span>IL_0000</span><span>:</span><span> </span><span>nop</span></p><p><span>		</span><span>IL_0001</span><span>:</span><span> </span><span>ret</span></p><p><span>	</span><span>}</span><span> </span><span>// end of method Program::Main</span></p><p><span>	</span><span>.</span><span>method </span><span>public</span><span> </span><span>hidebysig </span><span>specialname </span><span>rtspecialname </span></p><p><span>		</span><span>instance </span><span>void</span><span> </span><span>.</span><span>ctor</span><span> </span><span>(</span><span>)</span><span> </span><span>cil</span><span> </span><span>managed</span><span> </span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// Method begins at RVA 0x2053</span></p><p><span>		</span><span>// Code size 8 (0x8)</span></p><p><span>		</span><span>.</span><span>maxstack</span><span> </span><span>8</span></p><p><span>		</span><span>IL_0000</span><span>:</span><span> </span><span>ldarg</span><span>.</span><span>0</span></p><p><span>		</span><span>IL_0001</span><span>:</span><span> </span><span>call </span><span>instance </span><span>void</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Object</span><span>::</span><span>.</span><span>ctor</span><span>(</span><span>)</span></p><p><span>		</span><span>IL_0006</span><span>:</span><span> </span><span>nop</span></p><p><span>		</span><span>IL_0007</span><span>:</span><span> </span><span>ret</span></p><p><span>	</span><span>}</span><span> </span><span>// end of method Program::.ctor</span></p><p><span>}</span><span> </span><span>// end of class Program</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->

<p>So you can see that the <code>Serializable</code> attribute is applied in the class signature:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153bec638417240" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>.</span><span>class</span><span> </span><span>public</span><span> </span><span>auto </span><span>ansi </span><span>serializable </span><span>beforefieldinit </span><span>Program</span></p><p><span>	</span><span>extends</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Object</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>Custom attribute is initialized this way:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153bf0199237766" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>.</span><span>custom </span><span>instance </span><span>void</span><span> </span><span>CustomAttribute</span><span>::</span><span>.</span><span>ctor</span><span>(</span><span>)</span><span> </span><span>=</span><span> </span><span>(</span></p><p><span>	</span><span>01</span><span> </span><span>00</span><span> </span><span>00</span><span> </span><span>00</span></p><p><span>)</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>See also <a href="https://www.red-gate.com/simple-talk/blogs/subterranean-il-pseudo-custom-attributes/">this post</a>.</p>
<h6>83. What is a handle-recycling attack?</h6>
<p><code>SafeHandle</code> identifies a native handle assigned by operating system. Handles are just numbers in a handle table which can be reused. Imagine a situation that you push a handle on the stack and then the thread is paused. Other thread closes the handle, opens something new and gets the same integer value. Now our thread is resumed and continues with the handle it already pushed on the stack but now the handle identifies different resource.</p>
<h6>84. What handle types do we have in .NET?</h6>
<ul>
<li>Strong handle ‚Äì like a normal reference</li>
<li>Short weak handle ‚Äì doesn‚Äôt stop the object from cleaning up, does not track the object if it is resurrected</li>
<li>Long weak handle ‚Äì like short weak handle but tracks the object after it gets resurrected</li>
<li>Pinned handle ‚Äì strong handle which doesn‚Äôt allow the object to be moved</li>
<li>Async pinned handle ‚Äì like pinned handle but GC knows that it can be unpinned after async (typically I/O) operation is completed</li>
<li>Ref count handle ‚Äì handle counting references, used for COM interop</li>
<li>Dependent handle ‚Äì used by <code>ConditionalWeakTable</code>, connects two objects by strong handle, but from the outside is like a weak handle</li>
</ul>
<p>You can see those by running <code>!gchandles</code> in WinDBG:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153bf4261531347" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>0</span><span>:</span><span>000</span><span>&gt;</span><span> </span><span>!</span><span>gchandles</span></p><p><span>GC </span><span>Handle </span><span>Statistics</span><span>:</span></p><p><span>Strong </span><span>Handles</span><span>:</span><span> </span><span>259</span></p><p><span>Pinned </span><span>Handles</span><span>:</span><span> </span><span>137</span></p><p><span>Async </span><span>Pinned </span><span>Handles</span><span>:</span><span> </span><span>1</span></p><p><span>Ref </span><span>Count </span><span>Handles</span><span>:</span><span> </span><span>79</span></p><p><span>Weak </span><span>Long</span><span> </span><span>Handles</span><span>:</span><span> </span><span>197</span></p><p><span>Weak </span><span>Short</span><span> </span><span>Handles</span><span>:</span><span> </span><span>650</span></p><p><span>Other </span><span>Handles</span><span>:</span><span> </span><span>0</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->

<h6>85. What is a ref local?</h6>
<p>.NET has a concept of managed pointers ‚Äî pointers not necessarily pointing to the beginning of the object. They can point to local variables, parameters and parts of an object (including array elements).</p>
<p><code>ref local</code> is a variable storing a managed pointer. You can use it <a href="https://dotnetfiddle.net/3fe6Oz">like this</a>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153bf7683678613" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></div>
				</td>
						<td><div><p><span>using </span><span>System</span><span>;</span></p><p><span>namespace</span><span> </span><span>Program</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>Program</span></p><p><span>	</span><span>{</span><span>	</span></p><p><span>		</span><span>public</span><span> </span><span>static</span><span> </span><span>void</span><span> </span><span>Main</span><span>(</span><span>string</span><span>[</span><span>]</span><span> </span><span>args</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>int</span><span> </span><span>a</span><span> </span><span>=</span><span> </span><span>5</span><span>;</span></p><p><span>			</span><span>ref </span><span>int</span><span> </span><span>b</span><span> </span><span>=</span><span> </span><span>ref</span><span> </span><span>a</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>a</span><span>)</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>b</span><span>)</span><span>;</span></p><p><span>			</span><span>a</span><span> </span><span>=</span><span> </span><span>6</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>a</span><span>)</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>b</span><span>)</span><span>;</span></p><p><span>			</span><span>b</span><span> </span><span>=</span><span> </span><span>7</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>a</span><span>)</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>b</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>The output is:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		
<!-- [Format Time: 0.0001 seconds] -->

<p>So you can see that both of the variables point to the same memory location. When you decompile the code, you get:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153bfc620394996" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>.</span><span>maxstack</span><span>&nbsp;&nbsp;</span><span>2</span></p><p><span>.</span><span>locals </span><span>init</span><span> </span><span>(</span><span>[</span><span>0</span><span>]</span><span> </span><span>int32</span><span> </span><span>a</span><span>,</span></p><p><span>		 </span><span>[</span><span>1</span><span>]</span><span> </span><span>int32</span><span>&amp;</span><span> </span><span>b</span><span>)</span></p><p><span>IL_0000</span><span>:</span><span>&nbsp;&nbsp;</span><span>nop</span></p><p><span>IL_0001</span><span>:</span><span>&nbsp;&nbsp;</span><span>ldc</span><span>.</span><span>i4</span><span>.</span><span>5</span></p><p><span>IL_0002</span><span>:</span><span>&nbsp;&nbsp;</span><span>stloc</span><span>.</span><span>0</span></p><p><span>IL_0003</span><span>:</span><span>&nbsp;&nbsp;</span><span>ldloca</span><span>.</span><span>s</span><span>&nbsp;&nbsp; </span><span>a</span></p><p><span>IL_0005</span><span>:</span><span>&nbsp;&nbsp;</span><span>stloc</span><span>.</span><span>1</span></p><p><span>IL_0006</span><span>:</span><span>&nbsp;&nbsp;</span><span>ldloc</span><span>.</span><span>0</span></p><p><span>IL_0007</span><span>:</span><span>&nbsp;&nbsp;</span><span>call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>void</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Console</span><span>::</span><span>WriteLine</span><span>(</span><span>int32</span><span>)</span></p><p><span>IL_000c</span><span>:</span><span>&nbsp;&nbsp;</span><span>nop</span></p><p><span>IL_000d</span><span>:</span><span>&nbsp;&nbsp;</span><span>ldloc</span><span>.</span><span>1</span></p><p><span>IL_000e</span><span>:</span><span>&nbsp;&nbsp;</span><span>ldind</span><span>.</span><span>i4</span></p><p><span>IL_000f</span><span>:</span><span>&nbsp;&nbsp;</span><span>call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>void</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Console</span><span>::</span><span>WriteLine</span><span>(</span><span>int32</span><span>)</span></p><p><span>IL_0014</span><span>:</span><span>&nbsp;&nbsp;</span><span>nop</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>So you can see that the type of <code>b</code> is <code>int32&amp;</code>.</p>
<p>You can also use <code>ref return</code> to return something from <a href="https://tio.run/##pZCxasMwEIZn6SlujIeWLmkGk6nQKYVChw7Gw0W5GoEthTs5IRg/uyPJcTqVFjoIof8@vhO/kQfjmaapF@sa@LhIoK7U2mFHckRD8M6@Yez0oNWx37fWgGlR5J6rQWm1jCRgiNfJ2wO8oXUrCRy9VQ3IjRQRjBqlTsgxYLzAFhydwbpQ1cN6LNOQ6SsFsI/QFtLr1ftVxosMpPPinfiWHj/ZBtpZRzNQPdVF@SMSjd@GhY87nsvflH/wzd/d/FM16my79bhUkQrIHc2tFcPcU@jZZWax3wyjHvU0XQE">a function</a>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c00757645222" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></div>
				</td>
						<td><div><p><span>using </span><span>System</span><span>;</span></p><p><span>namespace</span><span> </span><span>Program</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>class</span><span> </span><span>Program</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>static</span><span> </span><span>void</span><span> </span><span>Main</span><span>(</span><span>string</span><span>[</span><span>]</span><span> </span><span>args</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>array</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>int</span><span>[</span><span>]</span><span> </span><span>{</span><span> </span><span>5</span><span> </span><span>}</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ref </span><span>int</span><span> </span><span>bar</span><span> </span><span>=</span><span> </span><span>ref </span><span>Foo</span><span>(</span><span>array</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>array</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>bar</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>array</span><span>[</span><span>0</span><span>]</span><span> </span><span>=</span><span> </span><span>6</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>array</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>bar</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>bar</span><span> </span><span>=</span><span> </span><span>7</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>array</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>bar</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>static</span><span> </span><span>ref </span><span>int</span><span> </span><span>Foo</span><span>(</span><span>int</span><span>[</span><span>]</span><span> </span><span>array</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>ref </span><span>array</span><span>[</span><span>0</span><span>]</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<p>This prints:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		
<!-- [Format Time: 0.0001 seconds] -->

<p>As a sidenote, <a href="https://dotnetfiddle.net/RlWOQn">dotnetfiddle</a> gives this:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c06108420283" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>Run</span><span>-</span><span>time </span><span>exception</span><span> </span><span>(</span><span>line</span><span> </span><span>-</span><span>1</span><span>)</span><span>:</span><span> </span><span>Operation </span><span>could </span><span>destabilize </span><span>the </span><span>runtime</span><span>.</span></p><p><span>Stack </span><span>Trace</span><span>:</span></p><p><span>[</span><span>System</span><span>.</span><span>Security</span><span>.</span><span>VerificationException</span><span>:</span><span> </span><span>Operation </span><span>could </span><span>destabilize </span><span>the </span><span>runtime</span><span>.</span><span>]</span></p><p><span>&nbsp;&nbsp; </span><span>at </span><span>Program</span><span>.</span><span>Program</span><span>.</span><span>Foo</span><span>(</span><span>Int32</span><span>[</span><span>]</span><span> </span><span>array</span><span>)</span></p><p><span>&nbsp;&nbsp; </span><span>at </span><span>Program</span><span>.</span><span>Program</span><span>.</span><span>Main</span><span>(</span><span>String</span><span>[</span><span>]</span><span> </span><span>args</span><span>)</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

<h6>86. What is an interior pointer?</h6>
<p>Interior pointer is a managed pointer which points to the inside of an object. See <a href="https://dotnetfiddle.net/CLtsXG">this</a>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c08096543576" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></div>
				</td>
						<td><div><p><span>using </span><span>System</span><span>;</span></p><p><span>namespace</span><span> </span><span>Program</span></p><p><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>class</span><span> </span><span>Program</span></p><p><span>	</span><span>{</span><span>	</span></p><p><span>		</span><span>public</span><span> </span><span>static</span><span> </span><span>void</span><span> </span><span>Main</span><span>(</span><span>string</span><span>[</span><span>]</span><span> </span><span>args</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>var</span><span> </span><span>foo</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Foo</span><span>(</span><span>)</span><span>;</span></p><p><span>			</span><span>foo</span><span>.</span><span>Bar</span><span> </span><span>=</span><span> </span><span>5</span><span>;</span></p><p><span>			</span><span>ref </span><span>int</span><span> </span><span>bar</span><span> </span><span>=</span><span> </span><span>ref </span><span>foo</span><span>.</span><span>Bar</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>foo</span><span>.</span><span>Bar</span><span>)</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>bar</span><span>)</span><span>;</span></p><p><span>			</span><span>foo</span><span>.</span><span>Bar</span><span> </span><span>=</span><span> </span><span>6</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>foo</span><span>.</span><span>Bar</span><span>)</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>bar</span><span>)</span><span>;</span></p><p><span>			</span><span>bar</span><span> </span><span>=</span><span> </span><span>7</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>foo</span><span>.</span><span>Bar</span><span>)</span><span>;</span></p><p><span>			</span><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>bar</span><span>)</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p><p><span>class</span><span> </span><span>Foo</span><span>{</span></p><p><span>	</span><span>public</span><span> </span><span>int</span><span> </span><span>Bar</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>This outputs:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		
<!-- [Format Time: 0.0001 seconds] -->

<p>You may ask: how does GC know that interior pointer needs to keep an object alive? GC uses brick table which partitions the heap into multiple blocks. It contains an offset to the first object inside such a block so then it can traverse the chunk of memory and find the object which should be held by the interior pointer. Since this algorithm is very expensive there are limitations what you can do. For instance you cannot have a ‚Äúref field‚Äù in an object.</p>
<h6>87. What is a ref struct?</h6>
<p>It is a structure which cannot be moved to the heap. It is always stored on the stack and because of that cannot be accessed by multiple threads. You declare it like this:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c0e451168879" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>ref</span><span> </span><span>struct</span><span> </span><span>Foo</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>int</span><span> </span><span>Bar</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<p>If you try to use <code>Foo</code> as a field or property of a class, box it or create an array of it ‚Äì you will get a compilation error.</p>
<h6>88. What is an unsafe struct?</h6>
<p>If you put an array inside a structure, only the reference to the array is stored. If you want to store whole array inside a structure you need to create so called ‚Äúfixed size buffer‚Äù. It is a fixed array of primitives which you can use in unsafe structures only:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c11328849354" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>unsafe</span><span> </span><span>struct</span><span> </span><span>FixedBufferExample</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>fixed </span><span>int</span><span> </span><span>buffer</span><span>[</span><span>1024</span><span>]</span><span>;</span><span> </span><span>// This is a fixed buffer.</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<h6>89. What is a readonly struct?</h6>
<p>It is a structure which cannot be modified after creation. It differs from normal structure with readonly fields that you cannot modify <code>this</code>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c13050758207" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>readonly</span><span> </span><span>struct</span><span> </span><span>Foo</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span> </span><span>readonly </span><span>int</span><span> </span><span>Bar</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<h6>90. What is an unsafe type?</h6>
<p>This is easy, it is just a class in which you can use unsafe code. Just like an unsafe method.</p>
<h6>91. What is a blittable type?</h6>
<p>It is a type which has the same binary representation in managed an unmanaged code. Integer, pointers and floating point values are blittable. Oddly enough, <code>bool</code> is not blittable as it can be stored as 1, 2 or 4-byte value, <code>char</code> and <code>DateTime</code> are non-blittable as well. See more <a href="https://docs.microsoft.com/en-us/dotnet/framework/interop/blittable-and-non-blittable-types">here</a>.</p>
<h6>92. How is unmanaged class compiled in C++/CLI?</h6>
<p>You can create both managed and unmanaged classes and methods, see this:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c16615780708" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div>
				</td>
						<td><div><p><span>#include "stdafx.h"</span></p><p><span>#include &lt; cstdio&gt;</span></p><p><span>using </span><span>namespace</span><span> </span><span>System</span><span>;</span></p><p><span>ref</span><span> </span><span>class</span><span> </span><span>Foo</span><span> </span><span>{</span></p><p><span>}</span><span>;</span></p><p><span>class</span><span> </span><span>Bar</span><span> </span><span>{</span></p><p><span>}</span><span>;</span></p><p><span>void</span><span> </span><span>Baz</span><span>(</span><span>)</span><span> </span><span>{</span></p><p><span>	</span><span>System</span><span>::</span><span>Console</span><span>::</span><span>WriteLine</span><span>(</span><span>"In managed function."</span><span>)</span><span>;</span></p><p><span>}</span></p><p><span>#pragma managed(push, off)</span></p><p><span>void</span><span> </span><span>Taz</span><span>(</span><span>)</span><span> </span><span>{</span></p><p><span>	</span><span>printf</span><span>(</span><span>"In unmanaged function.\n"</span><span>)</span><span>;</span></p><p><span>}</span></p><p><span>#pragma managed(pop)</span></p><p><span>int</span><span> </span><span>main</span><span>(</span><span>array</span><span>&lt;</span><span>System</span><span>::</span><span>String</span><span> </span><span>^</span><span>&gt;</span><span> </span><span>^</span><span>args</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>Console</span><span>::</span><span>WriteLine</span><span>(</span><span>L</span><span>"Hello World"</span><span>)</span><span>;</span></p><p><span>	</span><span>return</span><span> </span><span>0</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>When you decompile it, you can find class <code>Foo</code>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c19241567065" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></div>
				</td>
						<td><div><p><span>.</span><span>class</span><span> </span><span>private</span><span> </span><span>auto </span><span>ansi </span><span>beforefieldinit </span><span>Foo</span></p><p><span>	</span><span>extends</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Object</span></p><p><span>{</span></p><p><span>	</span><span>// Methods</span></p><p><span>	</span><span>.</span><span>method </span><span>public</span><span> </span><span>hidebysig </span><span>specialname </span><span>rtspecialname </span></p><p><span>		</span><span>instance </span><span>void</span><span> </span><span>.</span><span>ctor</span><span> </span><span>(</span><span>)</span><span> </span><span>cil</span><span> </span><span>managed</span><span> </span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// Method begins at RVA 0x10c0</span></p><p><span>		</span><span>// Code size 7 (0x7)</span></p><p><span>		</span><span>.</span><span>maxstack</span><span> </span><span>1</span></p><p><span>		</span><span>IL_0000</span><span>:</span><span> </span><span>ldarg</span><span>.</span><span>0</span></p><p><span>		</span><span>IL_0001</span><span>:</span><span> </span><span>call </span><span>instance </span><span>void</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Object</span><span>::</span><span>.</span><span>ctor</span><span>(</span><span>)</span></p><p><span>		</span><span>IL_0006</span><span>:</span><span> </span><span>ret</span></p><p><span>	</span><span>}</span><span> </span><span>// end of method Foo::.ctor</span></p><p><span>}</span><span> </span><span>// end of class Foo</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->

<p>You can also find method <code>main</code>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c1c365341019" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></div>
				</td>
						<td><div><p><span>.</span><span>method </span><span>assembly </span><span>static</span><span> </span></p><p><span>	</span><span>int32 </span><span>main</span><span> </span><span>(</span></p><p><span>		</span><span>string</span><span>[</span><span>]</span><span> </span><span>args</span></p><p><span>	</span><span>)</span><span> </span><span>cil</span><span> </span><span>managed</span><span> </span></p><p><span>{</span></p><p><span>	</span><span>// Method begins at RVA 0x10ec</span></p><p><span>	</span><span>// Code size 16 (0x10)</span></p><p><span>	</span><span>.</span><span>maxstack</span><span> </span><span>1</span></p><p><span>	</span><span>.</span><span>locals</span><span> </span><span>(</span></p><p><span>		</span><span>[</span><span>0</span><span>]</span><span> </span><span>int32</span></p><p><span>	</span><span>)</span></p><p><span>	</span><span>IL_0000</span><span>:</span><span> </span><span>ldc</span><span>.</span><span>i4</span><span>.</span><span>0</span></p><p><span>	</span><span>IL_0001</span><span>:</span><span> </span><span>stloc</span><span>.</span><span>0</span></p><p><span>	</span><span>IL_0002</span><span>:</span><span> </span><span>ldstr</span><span> </span><span>"Hello World"</span></p><p><span>	</span><span>IL_0007</span><span>:</span><span> </span><span>call </span><span>void</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Console</span><span>::</span><span>WriteLine</span><span>(</span><span>string</span><span>)</span></p><p><span>	</span><span>IL_000c</span><span>:</span><span> </span><span>ldc</span><span>.</span><span>i4</span><span>.</span><span>0</span></p><p><span>	</span><span>IL_000d</span><span>:</span><span> </span><span>stloc</span><span>.</span><span>0</span></p><p><span>	</span><span>IL_000e</span><span>:</span><span> </span><span>ldloc</span><span>.</span><span>0</span></p><p><span>	</span><span>IL_000f</span><span>:</span><span> </span><span>ret</span></p><p><span>}</span><span> </span><span>// end of method '&lt;Module&gt;'::main</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

<p>And method <code>Baz</code>:</p>
<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4a066153c1f629278579" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>.</span><span>method </span><span>assembly </span><span>static</span><span> </span></p><p><span>	</span><span>void</span><span> </span><span>modopt</span><span>(</span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>CompilerServices</span><span>.</span><span>CallConvCdecl</span><span>)</span><span>&nbsp;&nbsp;</span><span>Baz</span><span> </span><span>(</span><span>)</span><span> </span><span>cil</span><span> </span><span>managed</span><span> </span></p><p><span>{</span></p><p><span>	</span><span>// Method begins at RVA 0x10d4</span></p><p><span>	</span><span>// Code size 11 (0xb)</span></p><p><span>	</span><span>.</span><span>maxstack</span><span> </span><span>1</span></p><p><span>	</span><span>IL_0000</span><span>:</span><span> </span><span>ldstr</span><span> </span><span>"In managed function."</span></p><p><span>	</span><span>IL_0005</span><span>:</span><span> </span><span>call </span><span>void</span><span> </span><span>[</span><span>mscorlib</span><span>]</span><span>System</span><span>.</span><span>Console</span><span>::</span><span>WriteLine</span><span>(</span><span>string</span><span>)</span></p><p><span>	</span><span>IL_000a</span><span>:</span><span> </span><span>ret</span></p><p><span>}</span><span> </span><span>// end of method '&lt;Module&gt;'::Baz</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->

<p>Class <code>Bar</code> and method <code>Taz</code> are unmanaged.</p>
                                             </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>