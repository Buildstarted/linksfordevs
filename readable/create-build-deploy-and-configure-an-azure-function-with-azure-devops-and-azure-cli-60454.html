<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Create, Build, Deploy and Configure an Azure Function with Azure DevOps and Azure CLI - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Create, Build, Deploy and Configure an Azure Function with Azure DevOps and Azure CLI - linksfor.dev(s)"/>
    <meta property="article:author" content="April 6, 2020 &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;by damienbod &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;in ASP.NET Core, Azure, devops&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xB7; 1 Comment"/>
    <meta property="og:description" content="This post shows how to create, build, deploy and configure an Azure Function using Azure DevOps, Azure CLI and Powershell. An Azure Function is created in Azure using Azure DevOps with Azure CLI an&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://damienbod.com/2020/04/06/create-build-deploy-and-configure-an-azure-function-with-azure-devops-and-azure-cli/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Create, Build, Deploy and Configure an Azure Function with Azure DevOps and Azure CLI</title>
<div class="readable">
        <h1>Create, Build, Deploy and Configure an Azure Function with Azure DevOps and Azure CLI</h1>
            <div>by April 6, 2020 &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;by damienbod &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;in ASP.NET Core, Azure, devops&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xB7; 1 Comment</div>
            <div>Reading time: 10-12 minutes</div>
        <div>Posted here: 07 Apr 2020</div>
        <p><a href="https://damienbod.com/2020/04/06/create-build-deploy-and-configure-an-azure-function-with-azure-devops-and-azure-cli/">https://damienbod.com/2020/04/06/create-build-deploy-and-configure-an-azure-function-with-azure-devops-and-azure-cli/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>

							<p>This post shows how to create, build, deploy and configure an Azure Function using Azure DevOps, Azure CLI and Powershell. An Azure Function is created in Azure using Azure DevOps with Azure CLI and Powershell. The Azure Function (V3) project is created and built using Visual Studio and C#. This project is deployed to the Azure infrastructure using a second Azure DevOps Pipeline. The Azure Function configuration settings is configured to use Azure Key Vault for secrets.</p>
<p><strong>Create Azure Infrastruture for the Azure Function</strong></p>
<p>The Azure infrastructure is created using an Azure DevOps Pipeline which connects to an Azure Key Vault and in a second task executes a Powershell script which creates the Azure infrastructure. See <a href="https://damienbod.com/2020/04/02/use-azure-key-vault-for-secrets-in-azure-devops-pipelines/">Use Azure Key Vault for Secrets in Azure DevOps Pipelines</a> for details.</p>
<div><div id="highlighter_325152"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p></td><td><div><p><code>trigger:</code></p><p><code>- master</code></p><p><code>pool:</code></p><p><code>&nbsp;&nbsp;</code><code>vmImage: </code><code>'ubuntu-latest'</code></p><p><code>stages:</code></p><p><code>&nbsp;&nbsp;</code><code>- stage: AzureCliPowershell</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: </code><code>"Azure CLI with Powershell"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>jobs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- job: AzureCliKeyVault</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>steps:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- task: AzureKeyVault</code><code>@1</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>inputs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>azureSubscription: </code><code>'Visual Studio Enterprise(777...)'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>KeyVaultName: </code><code>'damienbod'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>SecretsFilter: </code><code>'*'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- job: AzureCliPowershell</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>steps:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- task: AzureCLI</code><code>@2</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: </code><code>"Create Function"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>inputs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>azureSubscription: </code><code>'Visual Studio Enterprise(777...)'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>scriptType: </code><code>'pscore'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>scriptLocation: </code><code>'scriptPath'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>scriptPath: </code><code>'createKeyVaultExistingRG.ps1'</code></p></div></td></tr></tbody></table></div></div>
<p>The Powershell script uses Powershell variables to create everything needed for an Azure V3 Function which runs a dotnet function. Depending on your needs, maybe some command parameters would need to be changed, for each of the commands.  An identity is created for the Azure Function and this is used to allow access to the Azure Key Vault. Mark Heath has an excellent <a href="https://markheath.net/post/deploying-azure-functions-with-azure-cli">blog </a>explaining some of the steps required to create the Azure Function.</p>
<div><div id="highlighter_774659"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p></td><td><div><p><code>$keyVaultName</code> <code>= </code><code>"damienbod"</code></p><p><code>$keyVaultMySecret</code> <code>=&nbsp; az keyvault secret show --name </code><code>"MySecret"</code> <code>--vault-name </code><code>$keyVaultName</code></p><p><code>$keyVaultMySecretId</code> <code>= (</code><code>$keyVaultMySecret</code> <code>| </code><code>ConvertFrom-Json</code><code>).id</code></p><p><code>$location</code> <code>= </code><code>"westeurope"</code></p><p><code>$devopsRg</code> <code>= </code><code>"devops-damienbod-rg"</code></p><p><code>$devopsFunctionStorage</code> <code>= </code><code>"devopsdamienbodstorage"</code></p><p><code>$devopsFunctionPlanName</code> <code>= </code><code>"devopsdamienbodfunctionplanname"</code></p><p><code>$devopsFunctionName</code> <code>= </code><code>"devopsdamienbodfunctionname"</code></p><p><code>Write-Host</code> <code>"Create resource group $devopsRg"</code></p><p><code>az group create `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>-l</code> <code>$location</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>-n</code> <code>$devopsRg</code></p><p><code>Write-Host</code> <code>"Check Storage account $devopsFunctionStorage"</code></p><p><code>$storageAcct</code> <code>= az storage account check-name --name </code><code>$devopsFunctionStorage</code></p><p><code>$storageAccountNotExists</code> <code>= (</code><code>$storageAcct</code> <code>| </code><code>ConvertFrom-Json</code><code>).nameAvailable</code></p><p><code>Write-Host</code> <code>"Checked Storage account $storageAcct"</code></p><p><code>Write-Host</code> <code>"Checked Storage account&nbsp; nameAvailable = $storageAccountNotExists"</code></p><p><code>if</code> <code>(</code><code>$storageAccountNotExists</code><code>)</code></p><p><code>{&nbsp;&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>az storage account create `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--name </code><code>$devopsFunctionStorage</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--resource-group </code><code>$devopsRg</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--location </code><code>$location</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--kind StorageV2 `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--sku Standard_LRS</code></p><p><code>}</code></p><p><code>else</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Write-Host</code> <code>"$devopsFunctionStorage storage account in $Location location already exists, skipping creation"</code></p><p><code>}</code></p><p><code>Write-Host</code> <code>"Create function plan $devopsFunctionPlanName"</code></p><p><code>az functionapp plan create `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--resource-group </code><code>$devopsRg</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--name </code><code>$devopsFunctionPlanName</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--location </code><code>$location</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--sku EP1</code></p><p><code>Write-Host</code> <code>"Create function $devopsFunctionName"</code></p><p><code>$createdFunction</code> <code>= az functionapp create `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--name </code><code>$devopsFunctionName</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--functions-version 3 `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--resource-group </code><code>$devopsRg</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--storage-account </code><code>$devopsFunctionStorage</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--runtime dotnet `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--plan </code><code>$devopsFunctionPlanName</code></p><p><code>Write-Host</code> <code>"Create identity $devopsFunctionName"</code></p><p><code>$functionappIdentity</code> <code>= az functionapp identity assign `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--name </code><code>$devopsFunctionName</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--resource-group </code><code>$devopsRg</code></p><p><code>$objectId</code> <code>= (</code><code>$functionappIdentity</code> <code>| </code><code>ConvertFrom-Json</code><code>).principalId</code></p><p><code>Write-Host</code> <code>"Created identity $objectId"</code></p><p><code>Write-Host</code> <code>"Assigned $functionappIdentity"</code></p><p><code>Write-Host</code> <code>"Azure az keyvault set-policy using $objectId"</code></p><p><code>az keyvault </code><code>set-policy</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--name </code><code>$keyVaultName</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--secret-permissions get list `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--output none `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--object-id </code><code>$objectId</code></p></div></td></tr></tbody></table></div></div>
<p><strong>Create the Azure Function</strong></p>
<p>Now that the Azure infrastructure is created, an Azure Function project can be created. A simple .NET Core 3.1 Azure V3 Function was created in Visual Studio. This can be tested and run locally, if all the required development tools are installed. See the Azure Functions getting started docs. A simple HTTP API was added which has anonymous access and uses the <strong>Environment.GetEnvironmentVariable</strong> method to display the value from the secret in the HTTP Get response.</p>
<div><div id="highlighter_269413"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></td><td><div><p><code>using</code> <code>System;</code></p><p><code>using</code> <code>System.IO;</code></p><p><code>using</code> <code>System.Threading.Tasks;</code></p><p><code>using</code> <code>Microsoft.AspNetCore.Mvc;</code></p><p><code>using</code> <code>Microsoft.Azure.WebJobs;</code></p><p><code>using</code> <code>Microsoft.Azure.WebJobs.Extensions.Http;</code></p><p><code>using</code> <code>Microsoft.AspNetCore.Http;</code></p><p><code>using</code> <code>Microsoft.Extensions.Logging;</code></p><p><code>using</code> <code>Newtonsoft.Json;</code></p><p><code>namespace</code> <code>FunctionApp1</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>static</code> <code>class</code> <code>Function1</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[FunctionName(</code><code>"Function1"</code><code>)]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>static</code> <code>async</code> <code>Task&lt;IActionResult&gt; Run(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[HttpTrigger(AuthorizationLevel.Anonymous, </code><code>"get"</code><code>, Route = </code><code>null</code><code>)] </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>HttpRequest req, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ILogger log)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>mySecret = Environment.GetEnvironmentVariable(</code><code>"MySecret"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>new</code> <code>OkObjectResult($</code><code>"MySecret =&nbsp; {mySecret}"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>For local development, the <strong>local.settings.json</strong> file is used to add your configurations. User secrets can also be used if required. No secrets should be committed to the repository.</p>
<p><strong>Build, Deploy and Configure the Azure Function </strong></p>
<p>Now that the Azure Functions project is created and added to a git repository, a second Azure DevOps Pipeline is created for build and deployment. The Pipeline builds, deploys and configures the Azure Function in different steps. Azure Key Vault and Powershell is used in a third step to configure the app settings. When creating the Pipeline, choose the Azure infrastucture created in the infrastucture Pipeline.</p>
<div><div id="highlighter_823983"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p></td><td><div><p><code>trigger:</code></p><p><code>- master</code></p><p><code>variables:</code></p><p><code>&nbsp;&nbsp;</code><code>azureSubscription: </code><code>'d1495f6c-c2bf-4cb7-b75d-3740e3f1a058'</code></p><p><code>&nbsp;&nbsp;</code><code>functionAppName: </code><code>'devopsdamienbodfunctionname'</code></p><p><code>&nbsp;&nbsp;</code><code>vmImageName: </code><code>'vs2017-win2016'</code></p><p><code>&nbsp;&nbsp;</code><code>workingDirectory: </code><code>'$(System.DefaultWorkingDirectory)/FunctionApp1'</code></p><p><code>stages:</code></p><p><code>- stage: Build</code></p><p><code>&nbsp;&nbsp;</code><code>displayName: Build stage</code></p><p><code>&nbsp;&nbsp;</code><code>jobs:</code></p><p><code>&nbsp;&nbsp;</code><code>- job: Build</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: Build</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>pool:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>vmImage: $(vmImageName)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>steps:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- task: DotNetCoreCLI</code><code>@2</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: Build</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>inputs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>command: </code><code>'build'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>projects: |</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$(workingDirectory)/*.csproj</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>arguments: --output $(System.DefaultWorkingDirectory)/publish_output --configuration Release</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- task: ArchiveFiles</code><code>@2</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: </code><code>'Archive files'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>inputs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>rootFolderOrFile: </code><code>'$(System.DefaultWorkingDirectory)/publish_output'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>includeRootFolder: false</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>archiveType: zip</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>replaceExistingArchive: true</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>artifact: drop</code></p><p><code>- stage: Deploy</code></p><p><code>&nbsp;&nbsp;</code><code>displayName: Deploy stage</code></p><p><code>&nbsp;&nbsp;</code><code>dependsOn: Build</code></p><p><code>&nbsp;&nbsp;</code><code>condition: succeeded()</code></p><p><code>&nbsp;&nbsp;</code><code>jobs:</code></p><p><code>&nbsp;&nbsp;</code><code>- deployment: Deploy</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: Deploy</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>environment: </code><code>'development'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>pool:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>vmImage: $(vmImageName)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>strategy:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>runOnce:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>deploy:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>steps:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- task: AzureFunctionApp</code><code>@1</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: </code><code>'Azure functions app deploy'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>inputs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>azureSubscription: </code><code>'$(azureSubscription)'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>appType: functionApp</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>appName: $(functionAppName)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>package: </code><code>'$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'</code></p><p><code>- stage: Configure</code></p><p><code>&nbsp;&nbsp;</code><code>displayName: </code><code>"Configure App settings"</code></p><p><code>&nbsp;&nbsp;</code><code>jobs:</code></p><p><code>&nbsp;&nbsp;</code><code>- job: AzureCliKeyVault</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>steps:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- task: AzureKeyVault</code><code>@1</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>inputs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>azureSubscription: </code><code>'Visual Studio Enterprise(777...)'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>KeyVaultName: </code><code>'damienbod'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>SecretsFilter: </code><code>'*'</code></p><p><code>&nbsp;&nbsp;</code><code>- job: AzureCliPowershell</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>steps:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- task: AzureCLI</code><code>@2</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>displayName: </code><code>"Add settings"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>inputs:</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>azureSubscription: </code><code>'Visual Studio Enterprise(777...)'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>scriptType: </code><code>'pscore'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>scriptLocation: </code><code>'scriptPath'</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>scriptPath: </code><code>'AddAppSettings.ps1'</code></p></div></td></tr></tbody></table></div></div>
<p>The Powershell script uses the Azure Key Vault and the Azure CLI to set the configuration values. Each configuration, app setting would be added in this script. If you update and create new values in the Key Vault, the configuration would need to be deployed again to use the new values. This is because the Key Vault setting has an exact reference to a value in the secret. 2 <strong>^^</strong> chars are also required in Key Vault Powershell configuration, which seems strange.</p>
<div><div id="highlighter_95348"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></td><td><div><p><code>$keyVaultName</code> <code>= </code><code>"damienbod"</code></p><p><code>$keyVaultMySecret</code> <code>=&nbsp; az keyvault secret show --name </code><code>"MySecret"</code> <code>--vault-name </code><code>$keyVaultName</code></p><p><code>$keyVaultMySecretId</code> <code>= (</code><code>$keyVaultMySecret</code> <code>| </code><code>ConvertFrom-Json</code><code>).id</code></p><p><code>$devopsRg</code> <code>= </code><code>"devops-damienbod-rg"</code></p><p><code>$devopsFunctionName</code> <code>= </code><code>"devopsdamienbodfunctionname"</code></p><p><code>Write-Host</code> <code>"Azure Function add secrets from the key vault"</code></p><p><code>az functionapp config appsettings set `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--resource-group </code><code>$devopsRg</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--name </code><code>$devopsFunctionName</code> <code>`</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--output none `</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>--settings MySecret=</code><code>"@Microsoft.KeyVault(SecretUri=$keyVaultMySecretId)^^"</code></p></div></td></tr></tbody></table></div></div>
<p><img data-attachment-id="13576" data-permalink="https://damienbod.com/2020/04/06/create-build-deploy-and-configure-an-azure-function-with-azure-devops-and-azure-cli/azurefunctiondevops_01/" data-orig-file="https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png" data-orig-size="1534,476" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="azureFunctionDevOps_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=640" src="https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=640&amp;h=199" alt="" width="640" height="199" srcset="https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=640&amp;h=199 640w, https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=1280&amp;h=398 1280w, https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=150&amp;h=47 150w, https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=600&amp;h=186 600w, https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=768&amp;h=238 768w, https://damienbod.files.wordpress.com/2020/04/azurefunctiondevops_01.png?w=1024&amp;h=318 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>When the Pipeline is run, and deployed, the API can be opened in the browser, and the secret will be displayed as a demo.</p>
<p><strong>Links: </strong></p>
<p><a href="https://dev.azure.com/" rel="nofollow">https://dev.azure.com/</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-key-vault?view=azure-devops" rel="nofollow">https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-key-vault?view=azure-devops</a></p>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/keyvault/secret?view=azure-cli-latest#az-keyvault-secret-show" rel="nofollow">https://docs.microsoft.com/en-us/cli/azure/keyvault/secret?view=azure-cli-latest#az-keyvault-secret-show</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/key-vault/quick-create-cli" rel="nofollow">https://docs.microsoft.com/en-us/azure/key-vault/quick-create-cli</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/package/nuget?view=azure-devops" rel="nofollow">https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/package/nuget?view=azure-devops</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/dotnet-core?view=azure-devops" rel="nofollow">https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/dotnet-core?view=azure-devops</a></p>
<p><a href="https://zimmergren.net/using-azure-key-vault-secrets-from-azure-devops-pipeline/" rel="nofollow">https://zimmergren.net/using-azure-key-vault-secrets-from-azure-devops-pipeline/</a></p>
<p><a href="https://markheath.net/post/managed-identity-key-vault-azure-functions" rel="nofollow">https://markheath.net/post/managed-identity-key-vault-azure-functions</a></p>
<p><a href="https://markheath.net/post/deploying-azure-functions-with-azure-cli" rel="nofollow">https://markheath.net/post/deploying-azure-functions-with-azure-cli</a></p>

							
							
						</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>