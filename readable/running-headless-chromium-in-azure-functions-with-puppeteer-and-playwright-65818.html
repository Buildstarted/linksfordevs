<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Running headless Chromium in Azure Functions with Puppeteer and Playwright - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Running headless Chromium in Azure Functions with Puppeteer and Playwright - linksfor.dev(s)"/>
    <meta property="og:description" content="With a recent update to Azure Functions, it is now possible to run headless Chromium in the Linux Consumption plan. This enables some serverless browser automation scenarios using popular frameworks such as Puppeteer and Playwright."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://dev.to/azure/running-headless-chromium-in-azure-functions-with-puppeteer-and-playwright-2fgk"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Running headless Chromium in Azure Functions with Puppeteer and Playwright</title>
<div class="readable">
        <h1>Running headless Chromium in Azure Functions with Puppeteer and Playwright</h1>
            <div>Reading time: 6-7 minutes</div>
        <div>Posted here: 18 Aug 2020</div>
        <p><a href="https://dev.to/azure/running-headless-chromium-in-azure-functions-with-puppeteer-and-playwright-2fgk">https://dev.to/azure/running-headless-chromium-in-azure-functions-with-puppeteer-and-playwright-2fgk</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div data-article-id="430852" id="article-body">
          <p>With a recent update to Azure Functions, it is now possible to run headless Chromium in the Linux Consumption plan. This enables some serverless browser automation scenarios using popular frameworks such as <a href="https://github.com/puppeteer/puppeteer">Puppeteer</a> and <a href="https://playwright.dev/">Playwright</a>.</p>

<h2>
  <a name="browser-automation-with-puppeteer-and-playwright" href="#browser-automation-with-puppeteer-and-playwright">
  </a>
  Browser automation with Puppeteer and Playwright
</h2>

<p>Browser automation has been around for a long time. Selenium WebDriver was a pioneer in this space. More recently, Puppeteer and Playwright have gained in popularity. The two frameworks are very similar. Google maintains Puppeteer and Microsoft maintains Playwright. It's interesting to note that some of the folks who worked on Puppeteer are now working on Playwright.</p>

<p>Puppeteer and Playwright each support a different set of browsers. Both of them can automate Chromium. They automatically install Chromium and can use it without extra configuration.</p>

<h2>
  <a name="azure-functions-support-for-headless-chromium" href="#azure-functions-support-for-headless-chromium">
  </a>
  Azure Functions support for headless Chromium
</h2>

<p>It's been a challenge to run headless Chromium on Azure Functions, especially in the Consumption (serverless) plan. Until now, the only way to run it has been by using a custom Docker image on the Premium plan.</p>

<p>Very recently, the necessary dependencies to run headless Chromium were added to the Azure Functions Linux Consumption environment. This means that we can simply <em>npm install</em> Puppeteer or Playwright in a Node.js function app to start using one of those frameworks to interact with Chromium.</p>

<h2>
  <a name="use-puppeteer-and-playwright-in-azure-functions" href="#use-puppeteer-and-playwright-in-azure-functions">
  </a>
  Use Puppeteer and Playwright in Azure Functions
</h2>

<p>It's pretty straightforward to run either Puppeteer or Playwright in Azure Functions. We use npm to install it. Note that because it is needed at run-time, we should install the package as a production dependency. In the examples below, we use Puppeteer/Playwright with headless Chromium in an HTTP triggered function to open a web page and return a screenshot.</p>

<h3>
  <a name="puppeteer" href="#puppeteer">
  </a>
  Puppeteer
</h3>



<div><pre><code><span># also installs and uses Chromium by default</span>
npm <span>install </span>puppeteer
</code></pre></div>





<div><pre><code><span>const</span> <span>puppeteer</span> <span>=</span> <span>require</span><span>(</span><span>"</span><span>puppeteer</span><span>"</span><span>);</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>async</span> <span>function</span> <span>(</span><span>context</span><span>,</span> <span>req</span><span>)</span> <span>{</span>
    <span>const</span> <span>url</span> <span>=</span> <span>req</span><span>.</span><span>query</span><span>.</span><span>url</span> <span>||</span> <span>"</span><span>https://google.com/</span><span>"</span><span>;</span>
    <span>const</span> <span>browser</span> <span>=</span> <span>await</span> <span>puppeteer</span><span>.</span><span>launch</span><span>();</span>
    <span>const</span> <span>page</span> <span>=</span> <span>await</span> <span>browser</span><span>.</span><span>newPage</span><span>();</span>
    <span>await</span> <span>page</span><span>.</span><span>goto</span><span>(</span><span>url</span><span>);</span>
    <span>const</span> <span>screenshotBuffer</span> <span>=</span> 
        <span>await</span> <span>page</span><span>.</span><span>screenshot</span><span>({</span> <span>fullPage</span><span>:</span> <span>true</span> <span>});</span>
    <span>await</span> <span>browser</span><span>.</span><span>close</span><span>();</span>

    <span>context</span><span>.</span><span>res</span> <span>=</span> <span>{</span>
        <span>body</span><span>:</span> <span>screenshotBuffer</span><span>,</span>
        <span>headers</span><span>:</span> <span>{</span>
            <span>"</span><span>content-type</span><span>"</span><span>:</span> <span>"</span><span>image/png</span><span>"</span>
        <span>}</span>
    <span>};</span>
<span>};</span>
</code></pre></div>



<h3>
  <a name="playwright" href="#playwright">
  </a>
  Playwright
</h3>



<div><pre><code><span># the default playwright package installs Chromium, Firefox, and WebKit</span>
<span># use playwright-chromium if we only need Chromium</span>
npm <span>install </span>playwright-chromium
</code></pre></div>





<div><pre><code><span>const</span> <span>{</span> <span>chromium</span> <span>}</span> <span>=</span> <span>require</span><span>(</span><span>"</span><span>playwright-chromium</span><span>"</span><span>);</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>async</span> <span>function</span> <span>(</span><span>context</span><span>,</span> <span>req</span><span>)</span> <span>{</span>
    <span>const</span> <span>url</span> <span>=</span> <span>req</span><span>.</span><span>query</span><span>.</span><span>url</span> <span>||</span> <span>"</span><span>https://google.com/</span><span>"</span><span>;</span>
    <span>const</span> <span>browser</span> <span>=</span>  <span>await</span> <span>chromium</span><span>.</span><span>launch</span><span>();</span>
    <span>const</span> <span>page</span> <span>=</span> <span>await</span> <span>browser</span><span>.</span><span>newPage</span><span>();</span>
    <span>await</span> <span>page</span><span>.</span><span>goto</span><span>(</span><span>url</span><span>);</span>
    <span>const</span> <span>screenshotBuffer</span> <span>=</span> 
        <span>await</span> <span>page</span><span>.</span><span>screenshot</span><span>({</span> <span>fullPage</span><span>:</span> <span>true</span> <span>});</span>
    <span>await</span> <span>browser</span><span>.</span><span>close</span><span>();</span>

    <span>context</span><span>.</span><span>res</span> <span>=</span> <span>{</span>
        <span>body</span><span>:</span> <span>screenshotBuffer</span><span>,</span>
        <span>headers</span><span>:</span> <span>{</span>
            <span>"</span><span>content-type</span><span>"</span><span>:</span> <span>"</span><span>image/png</span><span>"</span>
        <span>}</span>
    <span>};</span>
<span>};</span>
</code></pre></div>



<p>For the full source, take a look at <a href="https://github.com/anthonychu/functions-headless-chromium">this repo</a>. When we run the function app locally and visit <code>http://localhost:7071/api/screenshot?url=https://bing.com/</code>, we get back a screenshot of the page.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--dK1OaEbv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/w9pdblnpuoe4z06gdg6p.png"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--dK1OaEbv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/w9pdblnpuoe4z06gdg6p.png" alt="Alt Text" loading="lazy"></a></p>

<h2>
  <a name="deploy-to-azure" href="#deploy-to-azure">
  </a>
  Deploy to Azure
</h2>

<p>Since we're deploying to a Linux environment, we have to make sure we run <em>npm install</em> in Linux so it downloads a version of Chromium that matches the deployment target. Thankfully, Azure Functions supports remote build so that the app is built in the correct Linux environment during deployment, even though we might be developing locally in macOS or Windows.</p>

<h3>
  <a name="configuring-vs-code-for-remote-build" href="#configuring-vs-code-for-remote-build">
  </a>
  Configuring VS Code for remote build
</h3>

<blockquote>
<p>If we are deploying using Azure Functions Core Tools, we can skip this step.</p>
</blockquote>

<p>By default, the Azure Functions VS Code extension will deploy the app using local build, which means it'll run <em>npm install</em> locally and deploy the app package. For remote build, we update the app's <em>.vscode/settings.json</em> to enable <code>scmDoBuildDuringDeployment</code>.<br>
</p>

<div><pre><code><span>{</span><span>
    </span><span>"azureFunctions.deploySubpath"</span><span>:</span><span> </span><span>"."</span><span>,</span><span>
    </span><span>"azureFunctions.projectLanguage"</span><span>:</span><span> </span><span>"JavaScript"</span><span>,</span><span>
    </span><span>"azureFunctions.projectRuntime"</span><span>:</span><span> </span><span>"~3"</span><span>,</span><span>
    </span><span>"debug.internalConsoleOptions"</span><span>:</span><span> </span><span>"neverOpen"</span><span>,</span><span>
    </span><span>"azureFunctions.scmDoBuildDuringDeployment"</span><span>:</span><span> </span><span>true</span><span>
</span><span>}</span><span>
</span></code></pre></div>



<p>We can also remove the <code>postDeployTask</code> and <code>preDeployTask</code> settings that runs npm commands before and after the deployment; they're not needed because we're running the build remotely.</p>

<p>And because we're running <em>npm install</em> remotely, we can add <code>node_modules</code> to <em>.funcignore</em>. This excludes the <em>node_modules</em> folder from the deployment package to make the upload as small as possible.</p>

<h3>
  <a name="creating-a-linux-consumption-function-app" href="#creating-a-linux-consumption-function-app">
  </a>
  Creating a Linux Consumption function app
</h3>

<p>We can use any tool, such as the Azure Portal or VS Code, to create a Node.js 12 Linux Consumption function app in Azure that we'll deploy the app to.</p>

<h3>
  <a name="configuring-chromium-download-location-playwright-only" href="#configuring-chromium-download-location-playwright-only">
  </a>
  Configuring Chromium download location (Playwright only)
</h3>

<p>By default, Playwright downloads Chromium to a location outside the function app's folder. In order to include Chromium in the build artifacts, we need to instruct Playwright to install Chromium in the app's <em>node_modules</em> folder. To do this, create an app setting named <code>PLAYWRIGHT_BROWSERS_PATH</code> with a value of <code>0</code> in the function app in Azure. This setting is also used by Playwright at run-time to locate Chromium in <em>node_modules</em>.</p>

<h3>
  <a name="publishing-the-app" href="#publishing-the-app">
  </a>
  Publishing the app
</h3>

<p>If using VS Code, we can use the <em>Azure Functions: Deploy to Function App...</em> command to publish the app. It'll recognize the settings we configured earlier and use remote build.</p>

<p>If using Azure Functions Core Tools, we need to run the command with the <code>--build remote</code> flag:<br>
</p>

<div><pre><code>func azure functionapp publish <span>$appName</span> <span>--build</span> remote
</code></pre></div>



<p>And that's it! We've deployed a consumption Azure Functions app that uses Puppeteer or Playwright to interact with Chromium!</p>

<h2>
  <a name="resources" href="#resources">
  </a>
  Resources
</h2>

<ul>
<li><a href="https://github.com/puppeteer/puppeteer">Puppeteer</a></li>
<li><a href="https://playwright.dev/">Playwright</a></li>
<li><a href="https://github.com/anthonychu/functions-headless-chromium">Sample code</a></li>
</ul>


        </div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>