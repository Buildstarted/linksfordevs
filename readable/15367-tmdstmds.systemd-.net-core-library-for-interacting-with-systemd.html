<!DOCTYPE html>
<html lang="en">
<head>
    <title>
tmds/Tmds.Systemd: .NET Core library for interacting with systemd -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>tmds/Tmds.Systemd: .NET Core library for interacting with systemd</h1><div><div id="" class="markdown-body entry-content p-5"><p><a href="https://travis-ci.org/tmds/Tmds.Systemd" rel="nofollow"><img src="https://camo.githubusercontent.com/9ee9aa9060ba40a05bdae3840470a062e38ad83b/68747470733a2f2f6170692e7472617669732d63692e6f72672f746d64732f546d64732e53797374656d642e7376673f6272616e63683d6d6173746572" alt="Travis" data-canonical-src="https://api.travis-ci.org/tmds/Tmds.Systemd.svg?branch=master"></a><a href="https://www.nuget.org/packages/Tmds.Systemd" rel="nofollow"><img src="https://camo.githubusercontent.com/1a40edb064e42fddf02c1489175bb799b8149345/68747470733a2f2f696d672e736869656c64732e696f2f6e756765742f762f546d64732e53797374656d642e737667" alt="NuGet" data-canonical-src="https://img.shields.io/nuget/v/Tmds.Systemd.svg"></a></p><p>Tmds.Systemd is a .NET Core library for interacting with systemd.</p><h2><a id="user-content-tmdssystemd-package" class="anchor" aria-hidden="true" href="#tmdssystemd-package"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tmds.Systemd package</h2><p>This package supports .NET Core 2.0+.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">namespace</span><span class="pl-en">Tmds</span>.<span class="pl-en">Systemd</span>
{
  <span class="pl-k">static</span><span class="pl-k">class</span><span class="pl-en">ServiceManager</span>
  {
    <span class="pl-c"><span class="pl-c">//</span> Notify service manager about start-up completion and other service status changes.</span><span class="pl-k">bool</span><span class="pl-en">Notify</span>(<span class="pl-en">ServiceState</span><span class="pl-smi">state</span>, <span class="pl-k">params</span><span class="pl-en">ServiceState</span>[] <span class="pl-smi">states</span>);
    <span class="pl-c"><span class="pl-c">//</span> Instantiate Sockets for the file descriptors passed by the service manager.</span><span class="pl-en">Socket</span>[] <span class="pl-en">GetListenSockets</span>();
    <span class="pl-c"><span class="pl-c">//</span> Whether the process is running as part of a unit.</span><span class="pl-k">bool</span><span class="pl-smi">IsRunningAsService</span>;
    <span class="pl-c"><span class="pl-c">//</span> Unique identifier of the runtime cycle of the unit.</span><span class="pl-k">string</span><span class="pl-smi">InvocationId</span>;
  }
  <span class="pl-k">static</span><span class="pl-k">class</span><span class="pl-en">Journal</span>
  {
    <span class="pl-c"><span class="pl-c">//</span> Returns whether the journal service can be available.</span><span class="pl-k">bool</span><span class="pl-smi">IsSupported</span> { <span class="pl-k">get</span>; }
    <span class="pl-c"><span class="pl-c">//</span> Returns whether the journal service is currently available.</span><span class="pl-k">bool</span><span class="pl-smi">IsAvailable</span> { <span class="pl-k">get</span>; }
    <span class="pl-c"><span class="pl-c">//</span> The syslog identifier added to each log message.</span>
    SyslogIdentifier { get; set; } = null;
    <span class="pl-c"><span class="pl-c">//</span> Obtain a cleared JournalMessage. The Message must be Disposed to return it.</span>
    JournalMessage GetMessage();
    <span class="pl-c"><span class="pl-c">//</span> Submit a log entry to the journal.</span>
    LogResult Log(LogFlags flags, JournalMessage message);
  }
  <span class="pl-k">enum</span><span class="pl-en">LogFlags</span>
  { <span class="pl-en">None</span>,
    <span class="pl-c"><span class="pl-c">//</span> Log levels.</span><span class="pl-en">Emergency</span>, ..., <span class="pl-en">Debug</span>,
    <span class="pl-c"><span class="pl-c">//</span> Don't append a syslog identifier.</span><span class="pl-en">DontAppendSyslogIdentifier</span>,
    <span class="pl-c"><span class="pl-c">//</span> Drop message instead of blocking.</span><span class="pl-en">DropWhenBusy</span>
  }
  <span class="pl-k">enum</span><span class="pl-en">LogResult</span>
  { <span class="pl-en">Success</span>, <span class="pl-en">UnknownError</span>, <span class="pl-en">NotAvailable</span>, <span class="pl-en">NotSupported</span>, ... }
  <span class="pl-k">class</span><span class="pl-en">JournalMessage</span> : <span class="pl-en">IDisposable</span>
  {
    <span class="pl-c"><span class="pl-c">//</span> Appends a field to the message.</span><span class="pl-en">JournalMessage</span><span class="pl-en">Append</span>(<span class="pl-k">string</span><span class="pl-smi">name</span>          , <span class="pl-en">Type</span><span class="pl-smi">value</span>);
    <span class="pl-en">JournalMessage</span><span class="pl-en">Append</span>(<span class="pl-en">JournalFieldName</span><span class="pl-smi">name</span>, <span class="pl-en">Type</span><span class="pl-smi">value</span>);
  }
  <span class="pl-c"><span class="pl-c">//</span> Represents a valid journal field name.</span><span class="pl-k">struct</span><span class="pl-en">JournalFieldName</span>
  {
    <span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">JournalFieldName</span><span class="pl-smi">Priority</span>;
    <span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">JournalFieldName</span><span class="pl-smi">SyslogIdentifier</span>;
    <span class="pl-k">static</span><span class="pl-k">readonly</span><span class="pl-en">JournalFieldName</span><span class="pl-smi">Message</span>;
    <span class="pl-c"><span class="pl-c">//</span> Implicit conversion from string. Throws when name is not valid.</span><span class="pl-k">static</span><span class="pl-k">implicit</span><span class="pl-k">operator</span><span class="pl-en">JournalFieldName</span>(<span class="pl-k">string</span><span class="pl-smi">str</span>);
  }
}</pre></div><h2><a id="user-content-tmdssystemdlogging-package" class="anchor" aria-hidden="true" href="#tmdssystemdlogging-package"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tmds.Systemd.Logging package</h2><p>This package allows to easly add journal logging to an ASP.NET Core application by adding the following line to the host building step:</p><p>This package supports .NET Core 2.1+.</p><div class="highlight highlight-source-diff"><pre>         public static IWebHostBuilder CreateWebHostBuilder(string[] args) =&gt;
             WebHost.CreateDefaultBuilder(args)
<span class="pl-mi1"><span class="pl-mi1">+</span>            .ConfigureLogging(_ =&gt;  _ .AddJournal())</span>
             .UseStartup&lt;Startup&gt;();
     }</pre></div><p>The logging can be configured with the following options:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">class</span><span class="pl-en">JournalLoggerOptions</span>
{
  <span class="pl-c"><span class="pl-c">//</span> Drop messages instead of blocking.</span><span class="pl-k">bool</span><span class="pl-smi">DropWhenBusy</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
  <span class="pl-c"><span class="pl-c">//</span> The syslog identifier added to each log message.</span><span class="pl-k">string</span><span class="pl-smi">SyslogIdentifier</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; } <span class="pl-k">=</span><span class="pl-smi">Journal</span>.<span class="pl-smi">SyslogIdentifier</span>;
}</pre></div><p>The logger can be configured in <code>appsettings.json</code> using the <code>Journal</code> alias. The level specified in <code>Logging.Journal.LogLevel</code> overrides anything set in <code>Logging.LogLevel</code>. For example:</p><div class="highlight highlight-source-json"><pre><span class="pl-s"><span class="pl-pds">"</span>Logging<span class="pl-pds">"</span></span>: {
  <span class="pl-s"><span class="pl-pds">"</span>LogLevel<span class="pl-pds">"</span></span>: {
    <span class="pl-s"><span class="pl-pds">"</span>IncludeScopes<span class="pl-pds">"</span></span>: <span class="pl-c1">false</span>,
    <span class="pl-s"><span class="pl-pds">"</span>Default<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Debug<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>System<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Information<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>Microsoft<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Information<span class="pl-pds">"</span></span>
  },
  <span class="pl-s"><span class="pl-pds">"</span>Journal<span class="pl-pds">"</span></span>: {
    <span class="pl-s"><span class="pl-pds">"</span>IncludeScopes<span class="pl-pds">"</span></span>: <span class="pl-c1">false</span>,
    <span class="pl-s"><span class="pl-pds">"</span>LogLevel<span class="pl-pds">"</span></span>: {
      <span class="pl-s"><span class="pl-pds">"</span>Default<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Warning<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>System<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Warning<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>Microsoft<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Warning<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>Microsoft.AspNetCore.Hosting.Internal.WebHost<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Information<span class="pl-pds">"</span></span>
    }
  }
}</pre></div><p>The logging added is <strong>structured logging</strong>. For example, these entries are stored for a GET request:</p><div class="highlight highlight-source-json"><pre>{
	<span class="pl-s"><span class="pl-pds">"</span>PRIORITY<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>6<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>SYSLOG_IDENTIFIER<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>dotnet<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>LOGGER<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>Microsoft.AspNetCore.Hosting.Internal.WebHost<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>EVENTID<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>MESSAGE<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>Request starting HTTP/1.1 GET http://localhost:5000/  <span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>PROTOCOL<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>HTTP/1.1<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>METHOD<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>SCHEME<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>http<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>HOST<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>localhost:5000<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>PATHBASE<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>PATH<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>QUERYSTRING<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>REQUESTPATH<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>CONNECTIONID<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>0HLDSN5JGSU79<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>REQUESTID<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>0HLDSN5JGSU79:00000001<span class="pl-pds">"</span></span>,
}
{
	<span class="pl-s"><span class="pl-pds">"</span>PRIORITY<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>6<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>SYSLOG_IDENTIFIER<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>dotnet<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>LOGGER<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>Microsoft.AspNetCore.Hosting.Internal.WebHost<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>EVENTID<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>2<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>STATUSCODE<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>307<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>REQUESTPATH<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>CONNECTIONID<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>0HLDSN5JGSU79<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>REQUESTID<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>0HLDSN5JGSU79:00000001<span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>MESSAGE<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>Request finished in 10.9215ms 307 <span class="pl-pds">"</span></span>,
	<span class="pl-s"><span class="pl-pds">"</span>ELAPSEDMILLISECONDS<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>10.9215<span class="pl-pds">"</span></span>,
}</pre></div><p>To follow the journal logging live you can use this command <code>journalctl -f -t dotnet -o json-pretty | grep -v \"_</code>.</p><h2><a id="user-content-using-systemd-with-net-core-applications" class="anchor" aria-hidden="true" href="#using-systemd-with-net-core-applications"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using systemd with .NET Core applications</h2><p>Services can be created on the system-level systemd instance or on a user-level instance that is running as long as the user is
logged in (unless lingering is enabled). The systemd commands, like <code>systemctl</code>, work on the system daemon by default. Passing
the <code>--user</code> flag targets the user daemon.</p><p>Manually created configuration files are placed under <code>/etc/systemd/system/ </code> and <code>~/.config/systemd/user/</code> respectively.
For system unit files, ensure <code>chmod 664</code> and <code>chown root:root</code>.</p><p>On Fedora with <a href="http://fedoraloves.net" rel="nofollow">.NET SIG packages</a>, the SELinux context needs to be updated by running the following commands:</p><div class="highlight highlight-source-shell"><pre>sudo yum install -y policycoreutils-python-util
sudo semanage fcontext -a -t bin_t /usr/lib/dotnet/dotnet
sudo restorecon -v /usr/lib64/dotnet/dotnet</pre></div><p>Services are described with a file named <code>&lt;unitname&gt;.service</code> and look like this:</p><div class="highlight highlight-source-ini"><pre><span class="pl-en">[Service]</span><span class="pl-k">Type</span>=simple
<span class="pl-k">WorkingDirectory</span>=/home/username/app
<span class="pl-k">ExecStart</span>=/usr/bin/dotnet /home/username/app/App.dll
<span class="pl-k">Restart</span>=no
<span class="pl-k">SyslogIdentifier</span>=mydaemon
<span class="pl-k">User</span>=username
<span class="pl-k">Group</span>=groupname
<span class="pl-k">Environment</span>=<span class="pl-k">ASPNETCORE_ENVIRONMENT</span>=Production

<span class="pl-en">[Install]</span><span class="pl-k">WantedBy</span>=multi-user.target</pre></div><p>The values used in the file for <code>Type</code> is the default of <code>simple</code>. As soon as the application has started, it is considered ready.
To control when the application is ready, you can set this to <code>notify</code> and call <code>ServiceManager.Notify(ServiceState.Ready)</code>.</p><p>The <code>ExecStart</code> must use a rooted path for the executable. If you are using .NET Core on RHEL7, you need to enable the proper
software collection (scl) as part of the <code>ExecStart</code>. For example, <code>ExecStart=/bin/scl enable rh-dotnet22 -- dotnet /home/username/app/App.dll</code>.</p><p><code>Restart</code> is <code>no</code> is the default value, it means the application should not be restarted if it exits.
For long running services setting this to <code>on-failure</code> is recommended.</p><p>ASP.NET Core applications will throw an unhandled exception when they fail to bind the server address. The .NET Core runtime will turn
that into a process abort. On systems using <code>systemd-coredump</code> (like Fedora) this will show up in the journal and a coredump will be created.
Because this is a bit heavy, you may want to print out the exception and return a non-zero exit code instead:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">static</span><span class="pl-k">int</span><span class="pl-en">Main</span>(<span class="pl-k">string</span>[] <span class="pl-smi">args</span>)
{
    <span class="pl-k">try</span>
    {
        <span class="pl-en">CreateWebHostBuilder</span>(<span class="pl-smi">args</span>).<span class="pl-en">Build</span>().<span class="pl-en">Run</span>();
        <span class="pl-k">return</span><span class="pl-c1">0</span>;
    }
    <span class="pl-k">catch</span> (<span class="pl-k">System</span>.<span class="pl-en">Exception</span><span class="pl-smi">e</span>)
    {
        <span class="pl-smi">Console</span>.<span class="pl-smi">Error</span>.<span class="pl-en">Write</span>(<span class="pl-s"><span class="pl-pds">"</span>Unhandled exception: <span class="pl-pds">"</span></span>);
        <span class="pl-smi">Console</span>.<span class="pl-smi">Error</span>.<span class="pl-en">WriteLine</span>(<span class="pl-smi">e</span>);
        <span class="pl-k">return</span><span class="pl-c1">1</span>;
    }
}</pre></div><p>The <code>WantedBy</code><code>multi-user.target</code> indicates that, when enabled (i.e. installed), the service should be started with the system.</p><p><code>SyslogIdentifier</code> is the log identifier used for application output from standard output and standard error. When unset, the <code>ExecStart</code> process name
will be used. Logging performed using the <code>Tmds.Systemd.Journal</code> class (and <code>Tmds.Systemd.Logging</code> package) is not aware of the value set here.
ASP.NET Core application will output some messages to standard out by default on startup and shutdown. To omit these, you can use the
SuppressStatusMessages method on the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.hosting.hostbuilder" rel="nofollow">HostBuilder</a>, for example: <code>.SuppressStatusMessages(Console.IsInputRedirected)</code>.</p><p><code>Environment</code> can be used to set environment variables. Multiple <code>Environment</code> lines can be added to the service file.</p><p>After creating/editing the service file, the following commands can be used:</p><pre><code>systemctl daemon-reload     # make systemd reload the unit files and pick up changes
systemctl start &lt;unitname&gt;  # start the service now
systemctl enable &lt;unitname&gt; # install the service so it gets started automatically (at the next boot)
</code></pre><p>To check the unit status and logging, use the following commands:</p><pre><code>systemctl status &lt;unitname&gt; # status of the unit
journalctl -t &lt;syslogid&gt;    # log output
</code></pre><h3><a id="user-content-sigterm-handling" class="anchor" aria-hidden="true" href="#sigterm-handling"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SIGTERM handling</h3><p>When systemd stops a service it does so by sending the SIGTERM signal. At that point, the service
should shut down cleanly. This signal can be handled via the <code>AppDomain.CurrentDomain.ProcessExit</code> event.
That event must be blocked during the shutdown and finally set <code>Environment.ExitCode</code> to <code>0</code> on clean shutdown.</p><p>A proper wire-up for this is part of:</p><h3><a id="user-content-socket-based-activation" class="anchor" aria-hidden="true" href="#socket-based-activation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Socket based activation</h3><p>systemd supports socket-based activation. This can be used for services that expose their functionality
via a socket. systemd will create the socket and keep it available. When someone accesses that socket
(for example, makes a TCP connection), systemd will start the service and pass the socket to it.
As long as no-one is using the service, the service will not be started. Optionally, a service can decide
to exit when it has finished its work (for example, it was idle for some time). When a new connection is made,
systemd will start it again.</p><p>The following code shows an example of obtaining the systemd socket using <code>ServiceManager.GetListenSockets</code>.
It also uses <code>Socket.Poll</code> to exit cleanly when no client has connected for some time.</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">class</span><span class="pl-en">Program</span>
{
    <span class="pl-k">const</span><span class="pl-k">int</span><span class="pl-smi">AutoExitTimeoutMs</span><span class="pl-k">=</span><span class="pl-c1">30</span><span class="pl-k">*</span><span class="pl-c1">1000</span>; <span class="pl-c"><span class="pl-c">//</span> 30 sec</span><span class="pl-k">static</span><span class="pl-k">int</span><span class="pl-en">Main</span>(<span class="pl-k">string</span>[] <span class="pl-smi">args</span>)
    {
        <span class="pl-k">try</span>
        {
            <span class="pl-en">Socket</span><span class="pl-smi">acceptSocket</span><span class="pl-k">=</span><span class="pl-smi">ServiceManager</span>.<span class="pl-en">GetListenSockets</span>()[<span class="pl-c1">0</span>];
            <span class="pl-smi">acceptSocket</span>.<span class="pl-smi">Blocking</span><span class="pl-k">=</span><span class="pl-c1">false</span>;

            <span class="pl-k">while</span> (<span class="pl-c1">true</span>)
            {
                <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-smi">acceptSocket</span>.<span class="pl-en">Poll</span>(<span class="pl-smi">AutoExitTimeoutMs</span><span class="pl-k">*</span><span class="pl-c1">1000</span>, <span class="pl-smi">SelectMode</span>.<span class="pl-smi">SelectRead</span>))
                {
                    <span class="pl-c"><span class="pl-c">//</span> Timeout expired, exit service.</span><span class="pl-smi">Console</span>.<span class="pl-en">WriteLine</span>(<span class="pl-s"><span class="pl-pds">"</span>Service idle, exiting.<span class="pl-pds">"</span></span>);
                    <span class="pl-k">return</span><span class="pl-c1">0</span>;
                }

                <span class="pl-c"><span class="pl-c">//</span> Handle client</span><span class="pl-k">try</span>
                {
                    <span class="pl-k">using</span> (<span class="pl-en">Socket</span><span class="pl-smi">clientSocket</span><span class="pl-k">=</span><span class="pl-smi">acceptSocket</span>.<span class="pl-en">Accept</span>())
                    {
                        <span class="pl-smi">clientSocket</span>.<span class="pl-en">Send</span>(<span class="pl-smi">Encoding</span>.<span class="pl-smi">UTF8</span>.<span class="pl-en">GetBytes</span>(<span class="pl-s"><span class="pl-pds">"</span>Hello<span class="pl-pds">"</span></span>));
                    }
                }
                <span class="pl-k">catch</span> (<span class="pl-en">Exception</span><span class="pl-smi">e</span>)
                {
                    <span class="pl-smi">Console</span>.<span class="pl-smi">Error</span>.<span class="pl-en">Write</span>(<span class="pl-s"><span class="pl-pds">"</span>Exception handling client: <span class="pl-pds">"</span></span>);
                    <span class="pl-smi">Console</span>.<span class="pl-smi">Error</span>.<span class="pl-en">WriteLine</span>(<span class="pl-smi">e</span>);
                }
            }
        }
        <span class="pl-k">catch</span> (<span class="pl-en">Exception</span><span class="pl-smi">e</span>)
        {
            <span class="pl-smi">Console</span>.<span class="pl-smi">Error</span>.<span class="pl-en">Write</span>(<span class="pl-s"><span class="pl-pds">"</span>Unhandled exception: <span class="pl-pds">"</span></span>);
            <span class="pl-smi">Console</span>.<span class="pl-smi">Error</span>.<span class="pl-en">WriteLine</span>(<span class="pl-smi">e</span>);
            <span class="pl-k">return</span><span class="pl-c1">1</span>;
        }
    }
}</pre></div><p>Sockets are described with a file named <code>&lt;unitname&gt;.socket</code>. When the <code>.socket</code> and <code>.service</code> file have the
same unitname, systemd will use them together.</p><div class="highlight highlight-source-ini"><pre><span class="pl-en">[Socket]</span><span class="pl-k">ListenStream</span>=8080

<span class="pl-en">[Install]</span><span class="pl-k">WantedBy</span>=sockets.target</pre></div><p><code>ListenStream</code> specifies the TCP port for our service.</p><p>The <code>WantedBy</code><code>sockets.target</code> indicates that, when enabled (i.e. installed), the socket should be started with the system.</p><p>The corresponding service file looks like this:</p><div class="highlight highlight-source-ini"><pre><span class="pl-en">[Unit]</span><span class="pl-k">Requires</span>=%N.socket
<span class="pl-k">After</span>=%N.socket

<span class="pl-en">[Service]</span><span class="pl-k">Type</span>=simple
<span class="pl-k">WorkingDirectory</span>=/home/username/app
<span class="pl-k">ExecStart</span>=/usr/bin/dotnet /home/username/app/App.dll

<span class="pl-en">[Install]</span><span class="pl-k">WantedBy</span>=multi-user.target
<span class="pl-k">Also</span>=%N.socket</pre></div><p>The <code>%N</code> placeholder here will be substituted by systemd with the unitname.</p><p>The socket unit is referenced in a few places. <code>Requires</code> indicates the service needs the socket unit to start succesfully.
<code>After</code> means that socket must be started before the service. <code>Also</code> means when we enable the service, we want to enable the socket too.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>