<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Travis logs and .NET Core console output - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Travis logs and .NET Core console output - linksfor.dev(s)"/>
    <meta property="og:description" content="This is a blog post rather than a bug report, partly because I really don&#x2019;t know what&#x2019;s at fault. Others with more knowledge of how the console works in .NET Core, or exactly what the T&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://codeblog.jonskeet.uk/2020/07/19/travis-logs-and-net-core-console-output/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Travis logs and .NET Core console output</title>
<div class="readable">
        <h1>Travis logs and .NET Core console output</h1>
            <div>Reading time: 10-12 minutes</div>
        <div>Posted here: 20 Jul 2020</div>
        <p><a href="https://codeblog.jonskeet.uk/2020/07/19/travis-logs-and-net-core-console-output/">https://codeblog.jonskeet.uk/2020/07/19/travis-logs-and-net-core-console-output/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><article id="post-1782">
	
	<!-- .entry-header -->

		<div>
		<p>This is a blog post rather than a bug report, partly because I really don’t know what’s at fault. Others with more knowledge of how the console works in .NET Core, or exactly what the Travis log does, might be able to dig deeper.</p>
<p>TL;DR: If you’re running jobs using .NET Core 3.1 on Travis and you care about the console output, you might want to set the <code>TERM</code> environment variable to avoid information being swallowed.</p>
<p>Much of my time is spent in the <a href="https://github.com/googleapis/google-cloud-dotnet">Google Cloud Libraries for .NET</a> repository. That single repository hosts a lot of libraries, and many of the pull requests are from autogenerated code where the impact on the public API surface may not be immediately obvious. (It would be easy to miss one breaking change within dozens of comment changes, for example.) Our Travis build includes a job to work out the public API changes, which is fantastically useful.  (<a href="https://travis-ci.org/github/googleapis/google-cloud-dotnet/jobs/706410737">Example</a>)</p>
<p>When we updated our .NET Core SDK to 3.1 – or at least <em>around</em> that time; it may have been coincidence – we noticed that some of the log lines in our Travis jobs seemed to be missing. They were actually missing from all the jobs, but it was particularly noticeable for that “change detection” job because the output can often be small, but should <em>always</em> contain a “Diff level” line. It’s really obvious when that line is missing.</p>
<p>I spent rather longer trying to diagnose what was going wrong than I should have done. A colleague noted that clicking on “Raw log” showed that we <em>were</em> getting all the output – it’s just that Travis was swallowing some of it, due to control characters being emitted. This blog post is a distillation of what I learned when trying to work out what was going on.</p>
<h2>A simple set of Travis jobs</h2>
<p>In my <a href="https://github.com/jskeet/democode">DemoCode repository</a> I’ve created a Travis setup for the sake of this post.</p>
<p>Here are the various files involved:</p>
<p><a href="https://github.com/jskeet/DemoCode/blob/master/.travis.yml"><code>.travis.yml</code></a>:</p>
<div><div id="highlighter_601084"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></td><td><div><p><code>dist: xenial&nbsp; </code></p><p><code>language: csharp&nbsp; </code></p><p><code>mono: none&nbsp; </code></p><p><code>dotnet: 3.1.301&nbsp; </code></p><p><code>jobs:&nbsp; </code></p><p><code>&nbsp;&nbsp;</code><code>include:&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- name: "Default terminal, no-op program"&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>script: TravisConsole/run-dotnet.sh 0&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- name: "Default terminal, write two lines"&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>script: TravisConsole/run-dotnet.sh 2&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- name: "Mystery terminal, no-op program"&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>env: TERM=mystery&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>script: TravisConsole/run-dotnet.sh 0&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- name: "Mystery terminal, write two lines"&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>env: TERM=mystery&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>script: TravisConsole/run-dotnet.sh 2&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>- name: "Mystery terminal, write two lines, no logo"&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>env: TERM=mystery DOTNET_NOLOGO=true&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>script: TravisConsole/run-dotnet.sh 2</code></p></div></td></tr></tbody></table></div></div>
<p><a href="https://github.com/jskeet/DemoCode/blob/master/TravisConsole/run-dotnet.sh"><code>TravisConsole/run-dotnet.sh</code></a>:</p>
<div><div id="highlighter_509727"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p></td><td><div><p><code>#!/bin/bash&nbsp; </code></p><p><code>set -e&nbsp; </code></p><p><code>cd $(readlink -f $(dirname ${BASH_SOURCE}))&nbsp; </code></p><p><code>echo "Before dotnet run (first)"&nbsp; </code></p><p><code>dotnet run -- $1&nbsp; </code></p><p><code>echo "After dotnet run (first)"&nbsp; </code></p><p><code>echo "Before dotnet run (second)"&nbsp; </code></p><p><code>dotnet run -- $1&nbsp; </code></p><p><code>echo "After dotnet run (second)"</code></p></div></td></tr></tbody></table></div></div>
<p><a href="https://github.com/jskeet/DemoCode/blob/master/TravisConsole/Program.cs"><code>TravisConsole/Program.cs</code></a>:</p>
<div><div id="highlighter_570254"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p></td><td><div><p><code>using</code> <code>System;&nbsp; </code></p><p><code>class</code> <code>Program&nbsp; </code></p><p><code>{&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>static</code> <code>void</code> <code>Main(</code><code>string</code><code>[] args)&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>int</code> <code>count = </code><code>int</code><code>.Parse(args[0]);&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>for</code> <code>(</code><code>int</code> <code>i = 1; i &lt;= count; i++)&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Console.WriteLine($</code><code>"Line {i}"</code><code>);&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}&nbsp; </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}&nbsp; </code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>So each job runs the same .NET Core console application twice with the same command line argument – either 0 (in which case nothing is printed out) or 2 (in which case two it prints out “Line 1” then “Line 2”). The shell script also logs before and after executing the console application. The only other differences are in terms of the environment variables:</p>
<ul>
<li>Some jobs use <code>TERM=mystery</code> instead of the default</li>
<li>The final job uses <code>DOTNET_NOLOGO=true</code></li>
</ul>
<p>I’ll come back to the final job right at the end – we’ll concentrate on the impact of the <code>TERM</code> environment variable first, as that’s the main point of the post. Next we’ll look at the output of the jobs – in each case showing it in the “pretty” log first, then in the “raw” log. The pretty log has colour, and I haven’t tried to reproduce that. I’ve also only shown the relevant bit – the call to <code>run-dotnet.sh</code>.</p>
<p>You can see all of the output shown here in the <a href="https://travis-ci.org/github/jskeet/DemoCode/builds/709650331">Travis UI</a>, of course.</p>
<h2>Job 1: Default terminal, no-op program</h2>
<h3>Pretty log</h3>

<p>Note the lack of <code>After dotnet run</code> in each case.</p>
<h3>Raw log</h3>
<div><div id="highlighter_357697"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></td><td><div><p><code>[0K$ TravisConsole/run-dotnet.sh 0</code></p><p><code>Before dotnet run (first)</code></p><p><code>Welcome to .NET Core 3.1!</code></p><p><code>---------------------</code></p><p><code>SDK Version: 3.1.301</code></p><p><code>----------------</code></p><p><code>--------------------------------------------------------------------------------------</code></p><p><code>[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=After dotnet run (first)</code></p><p><code>Before dotnet run (second)</code></p><p><code>[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=After dotnet run (second)</code></p><p><code>travis_time:end:18aa556c:start=1595144448336834755,finish=1595144452475616837,duration=4138782082,event=script</code></p><p><code>[0K[32;1mThe command "TravisConsole/run-dotnet.sh 0" exited with 0.[0m</code></p></div></td></tr></tbody></table></div></div>
<p>In the raw log, we can see that <code>After dotnet run</code> is present each time, but with <code>[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=</code> before it. Let’s see what happens when our console application actually writes to the console.</p>
<h2>Job 2: Default terminal, write two lines</h2>
<h3>Pretty log</h3>

<p>This time we don’t have <code>After dotnet run</code> – and we don’t have <code>Line 1</code> either. As expected, they <em>are</em> present in the raw log, but with control characters before them:</p>
<div><div id="highlighter_622435"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p></td><td><div><p><code>[0K$ TravisConsole/run-dotnet.sh 2</code></p><p><code>Before dotnet run (first)</code></p><p><code>Welcome to .NET Core 3.1!</code></p><p><code>---------------------</code></p><p><code>SDK Version: 3.1.301</code></p><p><code>----------------</code></p><p><code>--------------------------------------------------------------------------------------</code></p><p><code>[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=Line 1</code></p><p><code>Line 2</code></p><p><code>[?1h=After dotnet run (first)</code></p><p><code>Before dotnet run (second)</code></p><p><code>[?1h=[?1h=[?1h=[?1h=[?1h=[?1h=Line 1</code></p><p><code>Line 2</code></p><p><code>[?1h=After dotnet run (second)</code></p><p><code>travis_time:end:00729828:start=1595144445905196926,finish=1595144450121508733,duration=4216311807,event=script</code></p><p><code>[0K[32;1mThe command "TravisConsole/run-dotnet.sh 2" exited with 0.[0m</code></p></div></td></tr></tbody></table></div></div>
<p>Now let’s try with the <code>TERM</code> environment variable set.</p>
<h2>Job 3: Mystery terminal, no-op program</h2>

<p>That’s more like it!  This time the raw log doesn’t contain any characters within the script execution itself. (There are still blank lines in the “logo” part, admittedly. Not sure why, but we’ll get rid of that later anyway.)</p>
<div><div id="highlighter_130788"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></td><td><div><p><code>[0K$ TravisConsole/run-dotnet.sh 0</code></p><p><code>Before dotnet run (first)</code></p><p><code>Welcome to .NET Core 3.1!</code></p><p><code>---------------------</code></p><p><code>SDK Version: 3.1.301</code></p><p><code>----------------</code></p><p><code>--------------------------------------------------------------------------------------</code></p><p><code>After dotnet run (first)</code></p><p><code>Before dotnet run (second)</code></p><p><code>After dotnet run (second)</code></p><p><code>travis_time:end:11222e41:start=1595144449188901003,finish=1595144453242229433,duration=4053328430,event=script</code></p><p><code>[0K[32;1mThe command "TravisConsole/run-dotnet.sh 0" exited with 0.[0m</code></p></div></td></tr></tbody></table></div></div>
<p>Let’s just check that it still works with actual output:</p>
<h2>Job 4: Mystery terminal, write two lines</h2>
<h3>Pretty log</h3>

<p>Exactly what we’d expect from inspection. The raw log doesn’t hold any surprises either.</p>
<h3>Raw log</h3>
<div><div id="highlighter_960097"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p></td><td><div><p><code>[0K$ TravisConsole/run-dotnet.sh 2</code></p><p><code>Before dotnet run (first)</code></p><p><code>Welcome to .NET Core 3.1!</code></p><p><code>---------------------</code></p><p><code>SDK Version: 3.1.301</code></p><p><code>----------------</code></p><p><code>--------------------------------------------------------------------------------------</code></p><p><code>Line 1</code></p><p><code>Line 2</code></p><p><code>After dotnet run (first)</code></p><p><code>Before dotnet run (second)</code></p><p><code>Line 1</code></p><p><code>Line 2</code></p><p><code>After dotnet run (second)</code></p><p><code>travis_time:end:0203f787:start=1595144444502091825,finish=1595144448950945977,duration=4448854152,event=script</code></p><p><code>[0K[32;1mThe command "TravisConsole/run-dotnet.sh 2" exited with 0.[0m</code></p></div></td></tr></tbody></table></div></div>
<h2>Job 5: Mystery terminal, write two lines, no logo</h2>
<p>While job 4 is <em>almost</em> exactly what we want, it’s still got the annoying “Welcome to .NET Core 3.1!” section. That’s a friendly welcome for users in an interactive context, but pointless for continuous integration. Fortunately it’s now easy to turn off by setting <code>DOTNET_NOLOGO=true</code>. We now have <em>exactly</em> the log we’d want:</p>
<h3>Pretty log</h3>
<div><div id="highlighter_932405"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p></td><td><div><p><code>$ TravisConsole/run-dotnet.sh 2</code></p><p><code>Before dotnet run (first)</code></p><p><code>Line 1</code></p><p><code>Line 2</code></p><p><code>After dotnet run (first)</code></p><p><code>Before dotnet run (second)</code></p><p><code>Line 1</code></p><p><code>Line 2</code></p><p><code>After dotnet run (second)</code></p><p><code>The command "TravisConsole/run-dotnet.sh 2" exited with 0.</code></p></div></td></tr></tbody></table></div></div>
<h3>Raw log</h3>
<div><div id="highlighter_992378"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p></td><td><div><p><code>[0K$ TravisConsole/run-dotnet.sh 2</code></p><p><code>Before dotnet run (first)</code></p><p><code>Line 1</code></p><p><code>Line 2</code></p><p><code>After dotnet run (first)</code></p><p><code>Before dotnet run (second)</code></p><p><code>Line 1</code></p><p><code>Line 2</code></p><p><code>After dotnet run (second)</code></p><p><code>travis_time:end:0bb5a6d4:start=1595144448986411002,finish=1595144453476210113,duration=4489799111,event=script</code></p><p><code>[0K[32;1mThe command "TravisConsole/run-dotnet.sh 2" exited with 0.[0m</code></p></div></td></tr></tbody></table></div></div>

<p>The use of <code>mystery</code> as the value of the <code>TERM</code> environment variable isn’t special, other than “not being a terminal that either Travis or .NET Core will have any fixed expectations about”. I <em>expect</em> that .NET Core is trying to be clever with its output based on the <code>TERM</code> environment variable, and that Travis isn’t handling the control characters in quite the way that .NET Core expects it to. Which one is right, and which one is wrong? It doesn’t really matter to me, so long as I can fix it.</p>
<p>This does potentially have a cost, of course. Anything which would <em>actually</em> produce prettier output based on the <code>TERM</code> environment variable is being hampered by this change. But so far we haven’t seen any problems. (It certainly isn’t stopping our Travis logs from using colour, for example.)</p>
<p>I discovered the <code>DOTNET_NOLOGO</code> environment variable – introduced in .NET Core 3.1.301, I <em>think</em> – incidentally while researching this problem. It’s not strictly related to the core problem, but it <em>is</em> related to the matter of “making CI logs readable” so I thought I’d include it here.</p>
<p>I was rather surprised not to see complaints about this all over the place. As you can see from the code above, it’s not like I’m doing anything particularly “special” – just writing lines out to the console. Are other developers not having the same problem, or just not <em>noticing</em> the problem? Either way, I hope this post helps either the .NET Core team to dive deeper, find out what’s going on and fix it (talking to the Travis team if appropriate), or at least raise awareness of the issue so that others can apply the same workaround.</p>
	</div><!-- .entry-content -->
	
	</article></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>