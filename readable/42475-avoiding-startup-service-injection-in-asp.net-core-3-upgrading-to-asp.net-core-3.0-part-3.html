<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Avoiding Startup service injection in ASP.NET Core 3: Upgrading to ASP.NET Core 3.0 - Part 3 -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Avoiding Startup service injection in ASP.NET Core 3: Upgrading to ASP.NET Core 3.0 - Part 3</h1>
    <div class="post-content">
<p>In this post I describe one of the changes to <code>Startup</code> when moving from an ASP.NET Core 2.x app to .NET Core 3; you can not longer inject arbitrary services into the <code>Startup</code> constructor.</p> <p>In .NET Core 3.0 <a href="/ihostingenvironment-vs-ihost-environment-obsolete-types-in-net-core-3/#asp-net-core-merges-with-the-generic-host">the ASP.NET Core 3.0 hosting infrastructure has been redesigned to build on top of the generic host infrastructure</a>, instead of running in parallel to it. But what does that mean for the average developer that has an ASP.NET Core 2.x app, and wants to update to 3.0? I&apos;ve migrated several apps at this stage, and it&apos;s gone pretty smoothly so far. The <a href="https://docs.microsoft.com/en-us/aspnet/core/migration/22-to-30">migration guide document</a> does a good job of walking you through the required steps, so I strongly suggest working your way through that document. </p>
<p>For the most part I only had to address two issues:</p>
<ul>
<li>The canonical way to configure middleware in ASP.NET Core 3.0 is to use endpoint routing</li>
<li>The generic host does not allow injecting services into the <code>Startup</code> class.</li>
</ul>
<p>The first point has been pretty well publicised. Endpoint routing was introduced in ASP.NET Core 2.2, but was restricted to MVC only. In ASP.NET Core 3.0, endpoint routing is the suggested approach for terminal middleware (also called &quot;endpoints&quot;) as it provides a few benefits. Most importantly, it allows middleware to know which endpoint will <em>ultimately</em> be executed, and can retrieve metadata about that endpoint. This allows you to apply authorization to health check endpoints for example.</p>
<blockquote>
<p>Endpoint routing is very particular about the <em>order</em> of middleware. I suggest <a href="https://docs.microsoft.com/en-us/aspnet/core/migration/22-to-30#routing-startup-code">reading this section of the migration document carefully</a> when upgrading your apps. In a later post I&apos;ll show how to convert a terminal middleware to an endpoint.</p>
</blockquote>
<p>The second point, injecting services into the <code>Startup</code> class has been mentioned, but it&apos;s not been very highly publicised. I&apos;m not sure if that&apos;s because not many people are doing it, or because in many cases it&apos;s easy to work around. In this post I&apos;ll show the problem, and some ways to handle it.</p> <p>A little known feature in ASP.NET core 2.x was that you could <em>partially</em> configure your dependency injection container in <em>Program.cs</em>, and inject the configured classes into <em>Startup.cs</em>. I used this approach to configure strongly typed settings, and then use those settings when configuring the remainder of the dependency injection container. </p>
<p>Lets take the following ASP.NET Core 2.x example:</p>
<pre class="language-csharp"><code class="language-csharp"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IWebHostBuilder</span> <span class="token function">CreateWebHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> WebHost<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token punctuation">&lt;</span><span class="token class-name">Startup</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">ConfigureSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>Notice the <code>ConfigureSettings()</code> call in <code>CreateWebHostBuilder</code>? That&apos;s an extension method that I use to configure the application&apos;s strongly-typed settings. For example:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SettingsinstallerExtensions</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IWebHostBuilder</span> <span class="token function">ConfigureSettings</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IWebHostBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> services<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> config <span class="token operator">=</span> context<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionStrings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;ConnectionStrings&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionStrings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span> ctx <span class="token operator">=</span><span class="token operator">&gt;</span> ctx<span class="token punctuation">.</span>GetService<span class="token operator">&lt;</span>IOptions<span class="token operator">&lt;</span>ConnectionStrings<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>So the <code>ConfigureSettings()</code> method calls <code>ConfigureServices()</code> on the <code>IWebHostBuilder</code> instance, and configures some settings. As these services are configured in the DI container <em>before</em> <code>Startup</code> is instantiated, they can be injected into the <code>Startup</code> constructor:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span> <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">ConnectionStrings</span> ConnectionStrings<span class="token punctuation">)</span> <span class="token punctuation">{</span> Configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span> ConnectionStrings <span class="token operator">=</span> ConnectionStrings<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IConfiguration</span> Configuration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">ConnectionStrings</span> ConnectionStrings <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token punctuation">&lt;</span><span class="token class-name">BloggingContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">&gt;</span> options<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>ConnectionStrings<span class="token punctuation">.</span>BloggingDatabase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I found this pattern useful when I wanted to use strongly-typed configuration objects inside <code>ConfigureServices</code> for configuring other services. In the example above the <code>ConnectionStrings</code> object is a strongly-typed settings object, and the <a href="/adding-validation-to-strongly-typed-configuration-objects-in-asp-net-core/">properties are validated on startup</a> to ensure they&apos;re not null (indicating a configuration error). It&apos;s not a fundamental technique, but it&apos;s proven handy.</p>
<p>However if you try and take this approach after you switch to using the generic host in ASP.NET Core 3.0, you&apos;ll get an error at runtime:</p>
<pre class="language-bash"><code class="language-bash">Unhandled exception. System.InvalidOperationException: Unable to resolve <span class="token function">service</span> <span class="token keyword">for</span> <span class="token function">type</span> <span class="token string">&apos;ExampleProject.ConnectionStrings&apos;</span> <span class="token keyword">while</span> attempting to activate <span class="token string">&apos;ExampleProject.Startup&apos;</span><span class="token keyword">.</span> at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.ConstructorMatcher.CreateInstance<span class="token punctuation">(</span>IServiceProvider provider<span class="token punctuation">)</span> at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.CreateInstance<span class="token punctuation">(</span>IServiceProvider provider, Type instanceType, Object<span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">)</span> at Microsoft.AspNetCore.Hosting.GenericWebHostBuilder.UseStartup<span class="token punctuation">(</span>Type startupType, HostBuilderContext context, IServiceCollection services<span class="token punctuation">)</span> at Microsoft.AspNetCore.Hosting.GenericWebHostBuilder.<span class="token operator">&lt;</span><span class="token operator">&gt;</span>c__DisplayClass12_0.<span class="token operator">&lt;</span>UseStartup<span class="token operator">&gt;</span>b__0<span class="token punctuation">(</span>HostBuilderContext context, IServiceCollection services<span class="token punctuation">)</span> at Microsoft.Extensions.Hosting.HostBuilder.CreateServiceProvider<span class="token punctuation">(</span><span class="token punctuation">)</span> at Microsoft.Extensions.Hosting.HostBuilder.Build<span class="token punctuation">(</span><span class="token punctuation">)</span> at ExampleProject.Program.Main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">in</span> C:\repos\ExampleProject\Program.cs:line 21
</code></pre>
<p>This approach is no longer supported in ASP.NET Core 3.0. You can inject <code>IHostEnvironment</code> and <code>IConfiguration</code> into the <code>Startup</code> constructor, but that&apos;s it. And for a good reason - the previous approach has several issues, as I&apos;ll describe below.</p>
<blockquote>
<p>Note that you can actually keep using this approach if you stick to using <code>IWebHostBuilder</code> in ASP.NET Core 3.0, instead of the new generic host. I strongly suggest you don&apos;t though, and attempt to migrate where possible!</p>
</blockquote> <p>The fundamental problem with injecting services into <code>Startup</code> is that it requires building the dependency injection container twice. In the example shown previously ASP.NET Core knows you need an <code>ConnectionStrings</code> object, but the only way for it to know how to <em>create</em> one is to build an <code>IServiceProvider</code> based on the &quot;partial&quot; configuration (that we supplied in the <code>ConfigureSettings()</code> extension method).</p>
<p>But why is this a problem? The problem is that the service provider is a temporary &quot;root&quot; service provider. It creates the services and injects them into <code>Startup</code>. The remainder of the dependency injection container configuration then runs as part of <code>ConfigureServices</code>, and the temporary service provider is thrown away. A <em>new</em> service provider is then created which now contains the &quot;full&quot; configuration for the application.</p>
<p>The upshot of this is that even if a service is configured with a <code>Singleton</code> lifetime, it will be created <em>twice</em>:</p>
<ul>
<li>Once using the &quot;partial&quot; service provider, to inject into <code>Startup</code></li>
<li>Once using the &quot;full&quot; service provider, for use more generally in the application</li>
</ul>
<p>For my use case, strongly typed settings, that really didn&apos;t matter. It&apos;s not <em>essential</em> that there&apos;s only one instance of the settings, it&apos;s just preferable. But that might not always be the case. This &quot;leaking&quot; of services seems to be the main reason for changing the behaviour with the generic host - it makes things safer.</p> <p>Knowing that you <em>can&apos;t</em> do this anymore is one thing, but you also need to work around it! One use case for injecting services into <code>Startup</code> is to be able to conditionally control how you register other services in <code>Startup.ConfigureServices</code>. For example, the following is a very rudimentary example:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span><span class="token class-name">IdentitySettings</span> identitySettings<span class="token punctuation">)</span> <span class="token punctuation">{</span> IdentitySettings <span class="token operator">=</span> identitySettings<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IdentitySettings</span> IdentitySettings <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span><span class="token punctuation">(</span>IdentitySettings<span class="token punctuation">.</span>UseFakeIdentity<span class="token punctuation">)</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">IIdentityService</span><span class="token punctuation">,</span> <span class="token class-name">FakeIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">IIdentityService</span><span class="token punctuation">,</span> <span class="token class-name">RealIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This (obviously contrived) example checks a boolean property on the injected <code>IdentitySettings</code> to decide which <code>IIdentityService</code> implementation to register: either the <code>Fake</code> service or the <code>Real</code> service.</p>
<p>This approach, which requires injecting <code>IdentitySettings</code>, can be made compatible with the generic host by converting the static service registrations to use a factory function instead. For example:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span> Configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IConfiguration</span> Configuration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token punctuation">&lt;</span><span class="token class-name">IdentitySettings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;Identity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">FakeIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">RealIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">IIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> identitySettings <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">IdentitySettings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> identitySettings<span class="token punctuation">.</span>UseFakeIdentity <span class="token operator">?</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">FakeIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">RealIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This approach is obviously a lot more complicated than the previous version, but it&apos;s at least compatible with the generic host! </p>
<p>In reality, if it&apos;s only strongly typed settings that are needed (as in this case), then this approach is somewhat overkill. Instead, I&apos;d probably just &quot;rebind&quot; the settings instead:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span> Configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IConfiguration</span> Configuration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token punctuation">&lt;</span><span class="token class-name">IdentitySettings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;Identity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> identitySettings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdentitySettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;Identity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>identitySettings<span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span>identitySettings<span class="token punctuation">.</span>UseFakeIdentity<span class="token punctuation">)</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">IIdentityService</span><span class="token punctuation">,</span> <span class="token class-name">FakeIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">IIdentityService</span><span class="token punctuation">,</span> <span class="token class-name">RealIdentityService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Alternatively, I might not bother with the strongly-typed aspect at all, especially if the required setting is a string. That&apos;s the approach used in the default .NET Core templates for configuring ASP.NET Core identity - the connection string is retrieved directly from the <code>IConfiguration</code> instance:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span> Configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IConfiguration</span> Configuration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionStrings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;ConnectionStrings&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">var</span> connectionString <span class="token operator">=</span> Configuration<span class="token punctuation">[</span><span class="token string">&quot;ConnectionString:BloggingDatabase&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationDbContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">&gt;</span> options<span class="token punctuation">.</span><span class="token function">UseSqlite</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>These approaches aren&apos;t the nicest, but they get the job done, and they will probably be fine for most cases. If you didn&apos;t know about the <code>Startup</code> injection feature, then you&apos;re probably using one of these approaches already anyway! </p>
<p>Sometimes I was injecting services into Startup to configure <em>other</em> strongly typed option objects. For these cases there&apos;s a better approach, using <code>IConfigureOptions</code>.</p> <p>A common case where I used injected settings was in configuring IdentityServer authentication, <a href="http://docs.identityserver.io/en/latest/topics/apis.html#the-identityserver-authentication-handler">as described in their documentation</a>:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span><span class="token class-name">IdentitySettings</span> identitySettings<span class="token punctuation">)</span> <span class="token punctuation">{</span> IdentitySettings <span class="token operator">=</span> identitySettings<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token class-name">IdentitySettings</span> IdentitySettings <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span> services <span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>IdentityServerAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">AddIdentityServerAuthentication</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> identitySettings<span class="token punctuation">.</span>ServerFullPath<span class="token punctuation">;</span> options<span class="token punctuation">.</span>ApiName <span class="token operator">=</span> identitySettings<span class="token punctuation">.</span>ApiName<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In this example, the base-address of our IdentityServer instance and the name of the API resource are set based on the strongly typed configuration object, <code>IdentitySettings</code>. This setup doesn&apos;t work in .NET Core 3.0, so we need an alternative. We could re-bind the strongly-typed configuration as I showed previously. Or we could use the <code>IConfiguration</code> object directly to retrieve the settings.</p>
<p>A third option involves looking under the hood of the <code>AddIdentityServerAuthentication</code> method, and <a href="/access-services-inside-options-and-startup-using-configureoptions/">making use of <code>IConfigureOptions</code></a>. </p>
<p>As it turns out, the <code>AddIdentityServerAuthentication()</code> method <a href="https://github.com/IdentityServer/IdentityServer4.AccessTokenValidation/blob/12b3752f8c874a1ad912b3509e2919ee6257ee07/src/IdentityServerAuthenticationExtensions.cs#L52">does a few different things</a>. Primarily, it configures JWT bearer authentication, and configures some strongly-typed settings for the specified authentication scheme (<code>IdentityServerAuthenticationDefaults.AuthenticationScheme</code>). We can use that fact to <em>delay</em> configuring the named options and use an <code>IConfigureOptions</code> instance instead.</p>
<p>The <code>IConfigureOptions</code> interface allows you to &quot;late-configure&quot; a strongly-typed options object using other dependencies from the service provider. For example, if to configure my <code>TestSettings</code> I needed to call a method on <code>TestService</code>, I could create an <code>IConfigureOptions</code> implementation like the following:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTestSettingsConfigureOptions</span> <span class="token punctuation">:</span> <span class="token class-name">IConfigureOptions</span><span class="token operator">&lt;</span>TestSettings<span class="token operator">&gt;</span>
<span class="token punctuation">{</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TestService</span> _testService<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">MyTestSettingsConfigureOptions</span><span class="token punctuation">(</span><span class="token class-name">TestService</span> testService<span class="token punctuation">)</span> <span class="token punctuation">{</span> _testService <span class="token operator">=</span> testService<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">TestSettings</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span> options<span class="token punctuation">.</span>MyTestValue <span class="token operator">=</span> _testService<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>TestService</code> and <code>IConfigureOptions&lt;TestSettings&gt;</code> are configured in DI at the same time inside <code>Startup.ConfigureServices</code>:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token punctuation">&lt;</span><span class="token class-name">TestService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureOptions</span><span class="token punctuation">&lt;</span><span class="token class-name">MyTestSettingsConfigureOptions</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The important point is you can use standard constructor dependency injection with <code>IOptions&lt;TestSettings&gt;</code>. There&apos;s no need to &quot;partially build&quot; the service provider <em>inside</em> <code>ConfigureServices</code> just to configure the <code>TestSettings</code>. Instead we register the <em>intent</em> to configure <code>TestSettings</code>, and delay the configuration until the settings object is required.</p>
<p>So how does this help us configuring IdentityServer?</p>
<p>The <code>AddIdentityServerAuthentication</code> uses a variant of strongly-typed settings called <em>named options</em> (<a href="/configuring-named-options-using-iconfigurenamedoptions-and-configureall/">I&apos;ve discussed these several</a> <a href="/creating-singleton-named-options-with-ioptionsmonitor/">times</a> <a href="/using-multiple-instances-of-strongly-typed-settings-with-named-options-in-net-core-2-x/">before</a>). They&apos;re most commonly used for configuring authentication, as they are in this example. </p>
<p>To cut a long story short, you can use the <code>IConfigureOptions</code> approach to <em>delay</em> configuring the named options <code>IdentityServerAuthenticationOptions</code> used by the authentication handler until <em>after</em> we&apos;ve already configured the strongly-typed <code>IdentitySettings</code> object. So you can create an <code>ConfigureIdentityServerOptions</code> object that takes the <code>IdentitySettings</code> as a constructor parameter:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigureIdentityServerOptions</span> <span class="token punctuation">:</span> <span class="token class-name">IConfigureNamedOptions</span><span class="token operator">&lt;</span>IdentityServerAuthenticationOptions<span class="token operator">&gt;</span>
<span class="token punctuation">{</span> <span class="token keyword">readonly</span> <span class="token class-name">IdentitySettings</span> _identitySettings<span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token function">ConfigureIdentityServerOptions</span><span class="token punctuation">(</span><span class="token class-name">IdentitySettings</span> identitySettings<span class="token punctuation">)</span> <span class="token punctuation">{</span> _identitySettings <span class="token operator">=</span> identitySettings<span class="token punctuation">;</span> _hostingEnvironment <span class="token operator">=</span> hostingEnvironment<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">,</span> <span class="token class-name">IdentityServerAuthenticationOptions</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> IdentityServerAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span> <span class="token punctuation">{</span> options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> _identitySettings<span class="token punctuation">.</span>ServerFullPath<span class="token punctuation">;</span> options<span class="token punctuation">.</span>ApiName <span class="token operator">=</span> _identitySettings<span class="token punctuation">.</span>ApiName<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IdentityServerAuthenticationOptions</span> options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">Configure</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>DefaultName<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In <em>Startup.cs</em> you configure the strongly-typed <code>IdentitySettings</code> object, add the required IdentityServer services, and register the <code>ConfigureIdentityServerOptions</code> class so that it can configure the <code>IdentityServerAuthenticationOptions</code> when required:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token punctuation">&lt;</span><span class="token class-name">IdentitySettings</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;Identity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services <span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>IdentityServerAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">AddIdentityServerAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureOptions</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigureIdentityServerOptions</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>No need to inject anything into <code>Startup</code>, but you still get the benefits of strongly-typed settings. Win-win!</p> <p>In this post I described some of the changes you may need to make to <em>Startup.cs</em> when upgrading to ASP.NET Core 3.0. I described the problem in ASP.NET Core 2.x with injecting services into your <code>Startup</code> class, and how this feature has been removed in ASP.NET Core 3.0. I then showed how to work around some of the reasons that you may have been using this approach in the first place.</p>
</div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>