<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Battling Spam In Your ASP.NET Core Applications with Akismet | Khalid Abuhakmeh -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Battling Spam In Your ASP.NET Core Applications with Akismet  |
      Khalid Abuhakmeh</h1><div><div class="post-content"><p>You’ve spent the better part of a year building your site with hopes of positive community interaction. You deploy your application feeling you’ve accomplished something great. Days later, you realize that your community site has become flooded with horrible advertisements for the latest diet fads, get rich quick schemes, and links to the more sordid parts of the internet.</p><p>In this post, I’ll show you how to combat spam in your ASP.NET Core applications using the Akismet API and ideas for implementing necessary components you will need to keep your application data free of unwanted users and their content.</p><h2 id="what-is-spam">What Is Spam</h2><p>No, we are not talking about any kind of canned meat. <strong>Spam is any unsolicited or undesirable message from a third party.</strong> As internet folks, we deal with unwanted email spam every day. You can also find spam in user groups, search engine results, blog comments, and text messages. If a communication medium exists, it likely has a spam problem. Why would anyone want to spam your application?</p><p>As stated on Wikipedia:</p><blockquote><p>Spamming remains economically viable because advertisers have no operating costs beyond the management of their mailing lists, servers, infrastructures, IP ranges, and domain names, and it is difficult to hold senders accountable for their mass mailings. <cite>–<a href="https://en.wikipedia.org/wiki/Spamming">Wikipedia</a></cite></p></blockquote><p>Fun fact: The term <a href="https://en.wikipedia.org/wiki/Spamming"><em>spam</em></a> can be traced back to <a href="http://www.montypython.com/">Monty Python’s Flying Circus</a>.</p><h2 id="what-is-akismet">What Is Akismet</h2><p><a href="https://akismet.com">Akismet</a> is an API service provided by Wordpress. It is a database with known spam instances that can help identify comments as spam. The service works by crowd-sourcing identification to users of the API and comes bundled with every Wordpress instance.</p><blockquote><p>Used by millions of websites, Akismet filters out hundreds of millions of spam comments from the Web every day. <cite>–Akismet</cite></p></blockquote><p>As of writing this post, Akismet claims to have blocked close to 500 million spam comments.</p><p>The Akismet API has four functional endpoints:</p><ol><li><strong>Key Verification</strong>: Clients can use this endpoint to verify API keys. Mainly used by services that allow users to add their keys to the application.</li><li><strong>Comment Check</strong>: Clients can send comments (or any message) to Akismet for spam validation. The check endpoint is the most used endpoint on the service.</li><li><strong>Submit Spam</strong>: This allows applications to submit verified spam to Akismet, thus enhancing the database of known spam.</li><li><strong>Submit Ham</strong>: Allows clients to provide false positives (real comments marked as spam), giving Akismet an idea of what factors may have caused the mistake in the first place.</li></ol><p>I really recommend reading the <a href="https://akismet.com/development/api/">Akismet documentation</a>, as it gives detailed advice when testing your implementation.</p><h3 id="before-getting-started-with-akismet">Before Getting Started With Akismet</h3><p>Before using Akismet in your application, you must take into account a few factors.</p><ol><li>Akismet is <strong>not</strong> free, but is reasonably priced. For commercial use, plans start at $5 a month. You can create a free account for local development.</li><li>Akismet is <strong>not</strong> perfect. It relies on users to actively mark incoming messages as spam, and also mark false-positives as ham. Thus plan for building mechanisms in your application to manage any avenue protected by Akismet.</li><li>Akismet is a web API, so performing any spam protection will incur a network request over the internet. If you have sensitive information or require an offline solution, this is not something I would recommend.</li></ol><p>If all those caveats look reasonable to you, you can continue to the <a href="https://akismet.com/development/">Akismet developer portal</a>.</p><p><strong>Before continuing to the implementation, you will need an API key from Akismet.</strong></p><h2 id="aspnet-core-implementation">ASP.NET Core Implementation</h2><p>Now that you understand what Akismet it, you can imagine how you may use it to increase the quality of user interaction in your application. The implementation is quite simple, given Akismet is a web API.</p><p>The first step is to install the Akismet client in your ASP.NET Core application. I use a library called <a href="https://www.nuget.org/packages/Akismet/"><code class="highlighter-rouge">Akismet</code> from NuGet</a>.</p><div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"></span>Install-Package Akismet <span class="nt">-Version</span> 0.7.0
</code></pre></div></div><p>The second step will involve us registering our AkismetClient with ASP.NET Core’s dependency injection. To initialize the client, you will need an API key, the URI of your application, the name of your app.</p><div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span><span class="k">void</span><span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span><span class="n">services</span><span class="p">)</span><span class="p">{</span><span class="n">services</span><span class="p">.</span><span class="nf">AddRazorPages</span><span class="p">();</span><span class="n">services</span><span class="p">.</span><span class="nf">AddSingleton</span><span class="p">(</span><span class="k">new</span><span class="nf">AkismetClient</span><span class="p">(</span><span class="s">"&lt;Your API Key Here&gt;"</span><span class="p">,</span><span class="k">new</span><span class="nf">Uri</span><span class="p">(</span><span class="n">Configuration</span><span class="p">[</span><span class="s">"blogUrl"</span><span class="p">]),</span><span class="s">"spam-killer"</span><span class="p">)</span><span class="p">);</span><span class="p">}</span></code></pre></div></div><p>I chose to register the client as a <code class="highlighter-rouge">singleton</code> because the <code class="highlighter-rouge">AkismetClient</code> has an internal <code class="highlighter-rouge">HttpClient</code> and is otherwise stateless. Feel free to register the client for your specific needs. You may have to use a transient registration if you allow users to supply personal API keys.</p><p>The next step is to use it in our application. In this example, I am using Razor Pages with a simple form.</p><div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span><span class="k">class</span><span class="nc">Contact</span><span class="p">:</span><span class="n">PageModel</span><span class="p">{</span><span class="k">private</span><span class="k">readonly</span><span class="n">IConfiguration</span><span class="n">configuration</span><span class="p">;</span><span class="k">private</span><span class="n">AkismetClient</span><span class="n">Akismet</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="nf">Contact</span><span class="p">(</span><span class="n">AkismetClient</span><span class="n">akismet</span><span class="p">,</span><span class="n">IConfiguration</span><span class="n">configuration</span><span class="p">)</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="n">configuration</span><span class="p">=</span><span class="n">configuration</span><span class="p">??</span><span class="k">throw</span><span class="k">new</span><span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">configuration</span><span class="p">));</span><span class="n">Akismet</span><span class="p">=</span><span class="n">akismet</span><span class="p">??</span><span class="k">throw</span><span class="k">new</span><span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">akismet</span><span class="p">));</span><span class="p">}</span><span class="p">[</span><span class="n">BindProperty</span><span class="p">]</span><span class="k">public</span><span class="kt">string</span><span class="n">Comment</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="p">[</span><span class="n">BindProperty</span><span class="p">]</span><span class="k">public</span><span class="kt">string</span><span class="n">Author</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">bool</span><span class="p">?</span><span class="n">IsSpam</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="k">async</span><span class="n">Task</span><span class="nf">OnPost</span><span class="p">()</span><span class="p">{</span><span class="kt">var</span><span class="n">comment</span><span class="p">=</span><span class="k">new</span><span class="n">AkismetComment</span><span class="p">{</span><span class="n">Blog</span><span class="p">=</span><span class="k">new</span><span class="nf">Uri</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s">"blogUrl"</span><span class="p">]),</span><span class="n">CommentAuthorEmail</span><span class="p">=</span><span class="n">Author</span><span class="p">,</span><span class="n">CommentContent</span><span class="p">=</span><span class="n">Comment</span><span class="p">,</span><span class="p">};</span><span class="n">IsSpam</span><span class="p">=</span><span class="k">await</span><span class="n">Akismet</span><span class="p">.</span><span class="nf">IsSpam</span><span class="p">(</span><span class="n">comment</span><span class="p">);</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>You can see, we are using the <code class="highlighter-rouge">AkismetClient</code> to call the <code class="highlighter-rouge">IsSpam</code> endpoint with an <code class="highlighter-rouge">AkismetComment</code>. A comment has the following properties:</p><div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span><span class="n">Uri</span><span class="n">Blog</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">UserIp</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">UserAgent</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">Referrer</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">Permalink</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">CommentType</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">CommentAuthor</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">CommentAuthorEmail</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">CommentAuthorUrl</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span><span class="k">public</span><span class="kt">string</span><span class="n">CommentContent</span><span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;</span><span class="p">}</span></code></pre></div></div><p>You don’t have to set <em>all</em> the properties, but the more information you can provide Akismet, the more likely they are to flag an incoming comment as spam.</p><p>The Razor page has the following implementation:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@page
@model SpamKiller.Pages.Contact
@{
    ViewData["Title"] = "Contact";
}

@if (Model.IsSpam.HasValue)
{
    <span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span><span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span><span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"alert alert-@(Model.IsSpam.Value ? "</span><span class="na">warning</span><span class="err">"</span><span class="na">:</span><span class="err">"</span><span class="na">success</span><span class="err">")"</span><span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span><span class="nt">&lt;h4</span><span class="na">class=</span><span class="s">"alert-heading"</span><span class="nt">&gt;</span>The Results Are In!<span class="nt">&lt;/h4&gt;</span>
                @if (Model.IsSpam.Value)
                {
                    <span class="nt">&lt;p&gt;</span>Boo his, you're trying to submit SPAM to my application. You should be ashamed of your nefarious activity.<span class="nt">&lt;/p&gt;</span>
                }
                else
                {
                    <span class="nt">&lt;p&gt;</span>Aww yeah, you successfully submitted some quality stuff here. We'll get back to you as soon as we can.<span class="nt">&lt;/p&gt;</span>
                }
                <span class="nt">&lt;hr&gt;</span><span class="nt">&lt;p</span><span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span>Calling Akismet insures we filter out as much SPAM as possible.<span class="nt">&lt;/p&gt;</span><span class="nt">&lt;/div&gt;</span><span class="nt">&lt;/div&gt;</span><span class="nt">&lt;/div&gt;</span>
}

<span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span><span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span><span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span><span class="nt">&lt;form</span><span class="na">asp-page=</span><span class="s">"Contact"</span><span class="na">method=</span><span class="s">"post"</span><span class="na">name=</span><span class="s">"contact"</span><span class="nt">&gt;</span><span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span><span class="nt">&lt;label</span><span class="na">for=</span><span class="s">"email"</span><span class="nt">&gt;</span>Email address<span class="nt">&lt;/label&gt;</span><span class="nt">&lt;input</span><span class="na">type=</span><span class="s">"email"</span><span class="na">class=</span><span class="s">"form-control"</span><span class="na">id=</span><span class="s">"email"</span><span class="na">aria-describedby=</span><span class="s">"emailHelp"</span><span class="na">placeholder=</span><span class="s">"Enter email"</span><span class="na">asp-for=</span><span class="s">"Author"</span><span class="nt">&gt;</span><span class="nt">&lt;small</span><span class="na">id=</span><span class="s">"emailHelp"</span><span class="na">class=</span><span class="s">"form-text text-muted"</span><span class="nt">&gt;</span>We'll never share your email with anyone else.<span class="nt">&lt;/small&gt;</span><span class="nt">&lt;/div&gt;</span><span class="nt">&lt;div</span><span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span><span class="nt">&lt;label</span><span class="na">for=</span><span class="s">"comment"</span><span class="nt">&gt;</span>Example textarea<span class="nt">&lt;/label&gt;</span><span class="nt">&lt;textarea</span><span class="na">class=</span><span class="s">"form-control"</span><span class="na">id=</span><span class="s">"comment"</span><span class="na">rows=</span><span class="s">"3"</span><span class="na">asp-for=</span><span class="s">"Comment"</span><span class="nt">&gt;&lt;/textarea&gt;</span><span class="nt">&lt;/div&gt;</span><span class="nt">&lt;button</span><span class="na">type=</span><span class="s">"submit"</span><span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">&gt;</span>Submit<span class="nt">&lt;/button&gt;</span><span class="nt">&lt;/form&gt;</span><span class="nt">&lt;/div&gt;</span><span class="nt">&lt;/div&gt;</span><span class="nt">&lt;/div&gt;</span></code></pre></div></div><p>Akismet is easy to test, as they give you inputs that can trigger spam detection immediately. If the user’s email address is <code class="highlighter-rouge">akismet-guaranteed-spam@example.com</code>, it will immediately be marked as spam. Here are two examples: one is welcome, and the other marked immediately as spam.</p><p>The <em>“good result”</em> we expected:</p><p><img src="https://d33wubrfki0l68.cloudfront.net/082447bd338462b80bfb2b87263247f8d974077f/d0873/assets/images/generated/akismet/not_spam_result-800-c3fc95.png" alt="not spam result" srcset="https://d33wubrfki0l68.cloudfront.net/f7c8007123ecc93aebd671813f7165a6ba4d298f/5a857/assets/images/generated/akismet/not_spam_result-400-c3fc95.png 400w, https://d33wubrfki0l68.cloudfront.net/151ab5d44b8717d7a9642d6b38830d66ceee7d0e/ed481/assets/images/generated/akismet/not_spam_result-600-c3fc95.png 600w, https://d33wubrfki0l68.cloudfront.net/082447bd338462b80bfb2b87263247f8d974077f/d0873/assets/images/generated/akismet/not_spam_result-800-c3fc95.png 800w, https://d33wubrfki0l68.cloudfront.net/f4785055b7f99de3be48ca14b611ede050de8f97/74cb8/assets/images/generated/akismet/not_spam_result-1000-c3fc95.png 1000w"></p><p>The <em>“bad”</em> result we expected:</p><p><img src="https://d33wubrfki0l68.cloudfront.net/b952d8d3af61e0b6165a89b6a1e1dee01a6ddbd0/03523/assets/images/generated/akismet/spam_result-800-da2dc0.png" alt="spam result" srcset="https://d33wubrfki0l68.cloudfront.net/584b8d6aaf6b295fd7755567a58bdc30f62f771a/80ff7/assets/images/generated/akismet/spam_result-400-da2dc0.png 400w, https://d33wubrfki0l68.cloudfront.net/3a1b1509955626f441ea06367e62c7b962839119/3ce72/assets/images/generated/akismet/spam_result-600-da2dc0.png 600w, https://d33wubrfki0l68.cloudfront.net/b952d8d3af61e0b6165a89b6a1e1dee01a6ddbd0/03523/assets/images/generated/akismet/spam_result-800-da2dc0.png 800w, https://d33wubrfki0l68.cloudfront.net/c4f7157494c63365300e55a1d576f8c979d08bad/28be0/assets/images/generated/akismet/spam_result-1000-da2dc0.png 1000w"></p><p>If we log into our Akismet account, it will also show us analytics around our application.</p><p><img src="https://d33wubrfki0l68.cloudfront.net/5d1f39e925cdcf9d6e96c64f6ec674bfc1412663/53bb5/assets/images/generated/akismet/akismet_dashboard-800-909f09.png" alt="Akismet dashboard" srcset="https://d33wubrfki0l68.cloudfront.net/c6b7d454183881fb4db64bd34c03a9b5341d3902/4cfc9/assets/images/generated/akismet/akismet_dashboard-400-909f09.png 400w, https://d33wubrfki0l68.cloudfront.net/a415f7f5d4b904084e2a306bc9d2c5859ff64ab5/f2ee5/assets/images/generated/akismet/akismet_dashboard-600-909f09.png 600w, https://d33wubrfki0l68.cloudfront.net/5d1f39e925cdcf9d6e96c64f6ec674bfc1412663/53bb5/assets/images/generated/akismet/akismet_dashboard-800-909f09.png 800w, https://d33wubrfki0l68.cloudfront.net/b16b1b0d681b707bf2e91e04aa990eff8f84db24/98972/assets/images/generated/akismet/akismet_dashboard-1000-909f09.png 1000w"></p><p>If you’d like to play around with the sample application, you can clone the <a href="https://github.com/khalidabuhakmeh/SpamKiller">repository from GitHub</a>.</p><h2 id="conclusion">Conclusion</h2><p>Building interactive applications are challenging, especially when the internet has nefarious parties waiting to exploit any open form. Luckily, spam isn’t a new problem, and by using Akismet, <strong><em>even a single developer can take on an army of spammers</em></strong>.</p><p>Remember the following before using Akismet:</p><ul><li>Akismet is free for personal use but has paid tiers for commercial use.</li><li>The service is not perfect, so build mechanisms into your application to manage spam and ham (false-positives). Maybe a dashboard or notification system via email/text message.</li><li>You will be transmitting the data over the internet, so take into account the latency and sensitivity of the data.</li></ul><p>The actual implementation in code is pretty simple, and anyone can do it. I hope I’ve inspired you to battle spam and ultimately help everyone else. Good luck, and please let me know if this post has helped in any way.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>