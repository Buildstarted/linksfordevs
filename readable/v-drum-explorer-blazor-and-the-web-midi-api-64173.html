<!DOCTYPE html>
<html lang="en">
<head>
    <title>
V-Drum Explorer: Blazor and the Web MIDI API - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="V-Drum Explorer: Blazor and the Web MIDI API - linksfor.dev(s)"/>
    <meta property="og:description" content="Blazor and the Web MIDI API Friday, 9pm Yesterday, speaking to the Timestamp: 11:46 (That was surprisingly quick.) Step 4: Retrieve the &#x201C;kit 1&#x201D; name in Blazor We need two extra bits of &#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://codeblog.jonskeet.uk/2020/07/12/v-drum-explorer-blazor-and-the-web-midi-api/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - V-Drum Explorer: Blazor and the Web MIDI API</title>
<div class="readable">
        <h1>V-Drum Explorer: Blazor and the Web MIDI API</h1>
            <div>Reading time: 36-45 minutes</div>
        <div>Posted here: 12 Jul 2020</div>
        <p><a href="https://codeblog.jonskeet.uk/2020/07/12/v-drum-explorer-blazor-and-the-web-midi-api/">https://codeblog.jonskeet.uk/2020/07/12/v-drum-explorer-blazor-and-the-web-midi-api/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><article id="post-1768">
	
	<!-- .entry-header -->

		<div>
		
<h2>Friday, 9pm</h2>
<p>Yesterday, speaking to the <a href="https://www.meetup.com/NE-Tech/">NE:Tech</a> user group about V-Drum Explorer, someone mentioned the <a href="https://www.w3.org/TR/webmidi/">Web MIDI API</a>– a way of accessing local MIDI devices from a browser.</p>
<p>Now my grasp of JavaScript is tenuous at best… but that’s okay, because I can write C# using <a href="https://dotnet.microsoft.com/apps/aspnet/web-apps/blazor">Blazor</a>. So in theory, I could build an equivalent to V-Drum Explorer, but running entirely in the browser using WebAssembly. That means I’d never have to worry about the installer again…</p>
<p>Now, I don’t want to get ahead of myself here. I suspect that WPF and later <a href="https://github.com/dotnet/maui">MAUI</a> are still the way forward, but this should at least prove a fun investigation. I’ve never used the Web MIDI API, and I haven’t used Blazor for a few years. This weekend I’m sure I can find a few spare hours, so let’s see how far I can get.</p>
<p>Just for kicks, I’m going to write up my progress in this blog post as I go, adding a timestamp periodically so we can see how long it takes to do things (admittedly whilst writing it up at the same time). I promise not to edit this post other than for clarity, typos etc – if my ideas turn out to be complete failures, such is life.</p>
<p>I have a goal in mind for the end of the weekend: a Blazor web app, running locally to start with (deploying it to k8s shouldn’t be too hard, but isn’t interesting at this point), which can detect my drum module and list the names of the kits on the module.</p>
<p>Here’s the list of steps I <em>expect</em> to take. We’ll see how it goes.</p>
<ol>
<li>Use <a href="https://jsfiddle.net/">JSFiddle</a> to try to access the Web MIDI API. If I can list the ports, open an input and output port, listen for MIDI messages (dumped to the console), and send a SysEx message hard-coded to request the name for kit 1.</li>
<li>Start a new Blazor project, and check I can get it to work.</li>
<li>Try to access the MIDI ports in Blazor – just listing the ports to start with.</li>
<li>Expand the MIDI access test to do everything from step 1.</li>
<li>Loop over all the kits instead of just the first one – this will involve doing checksum computation in the app, copying code from the V-Drum Explorer project. If I get this far, I’ll be very happy.</li>
<li>As a bonus step, if I get this far, it would be really interesting to <em>try</em> to depend on V-Drum Explorer projects  (VDrumExplorer.Model and VDrumExplorer.Midi) after modifying the MIDI project to use Web MIDI. At that point, the code for the Blazor app could be really quite simple… and displaying a read-only tree view probably wouldn’t be too hard. Maybe.</li>
</ol>
<p>Sounds like I have a fun weekend ahead of me.</p>
<h2>Saturday morning</h2>
<h2>Step 1: JSFiddle + MIDI</h2>
<p>Time: 07:08</p>
<p>Turn on the TD-27, bring up the MIDI API docs and JSFiddle, and let’s give it a whirl…</p>
<p>It strikes me that it might be useful to be able to save some efforts here. A JSFiddle account may not be necessary for that, but it may make things easier… let’s create an account.</p>
<p>First problem: I can’t see how to make the console (which is where I expect all the results to end up) into more than a single line in the bottom right hand corner. I could open up Chrome’s console, of course, but as JSFiddle <em>has</em> one, it would be nice to use that. Let’s see what happens if I just write to it anyway… ah, it expands as it has data. Okay, that’ll do.</p>
<p><strong>Test 1: initialize MIDI at all</strong></p>
<p>The MIDI API docs have a really <a href="https://www.w3.org/TR/webmidi/#examples-of-web-midi-api-usage-in-javascript">handy set of examples</a> which I can just copy/paste. (I’m finding it hard to resist the temptation to change the whitespace to something I’m more comfortable with, but hey…)</p>
<p>So, copy the example in 9.1:</p>
<blockquote><p>
  “Failed to get MIDI access – SecurityError: Failed to execute ‘requestMIDIAccess’ on ‘Navigator’: Midi has been disabled in this document by Feature Policy.”
</p></blockquote>
<p>Darn. Look up Feature-Policy on MDN, then a search for “JSFiddle Feature-Policy” finds <a href="https://github.com/jsfiddle/jsfiddle-issues/issues/1106" rel="nofollow">https://github.com/jsfiddle/jsfiddle-issues/issues/1106</a> – which is specifically about MIDI access! And it has a workaround… apparently things work slightly differently with a saved Fiddle. Let’s try saving and reloading…</p>

<p>Hurray!</p>
<p><strong>Test 2: list the MIDI ports</strong></p>
<p>Copy/paste example 9.3 into the Fiddle (with a couple of extra lines to differentiate between input and output), and call <code>listInputsAndOuptuts</code> from <code>onMIDISuccess</code>…</p>
<div><div id="highlighter_635601"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p></td><td><div><p><code>"MIDI ready!"</code></p><p><code>"Input ports"</code></p><p><code>"Input port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Input port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Input port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Input port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Input port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Input port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Output ports"</code></p><p><code>"Output port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Output port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Output port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Output port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Output port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p><p><code>"Output port [type:'undefined'] id:'undefined' manufacturer:'undefined' name:'undefined' version:'undefined'"</code></p></div></td></tr></tbody></table></div></div>
<p>Hmm. That’s not ideal. It’s clearly found some ports (six inputs and outputs? I’d only expect one or two), but it can’t use any properties in them.</p>
<p>If I add <code>console.log(output)</code> in the loop, it shows “entries”, “keys”, “values”, “forEach”, “has” and “get”, suggesting that the example is iterating over the properties of a collection rather than the entries.</p>
<p>Using <code>for (var input in midiAccess.inputs.values())</code> still doesn’t give me anything obviously useful. (Keep in mind I know very little JavaScript – I’m sure the answer is obvious to many of you.)</p>
<p>Let’s try using <code>forEach</code> instead like this:</p>
<div><div id="highlighter_949757"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p></td><td><div><p><code>function</code> <code>listInputsAndOutputs( midiAccess ) {</code></p><p><code>&nbsp;&nbsp;</code><code>console.log(</code><code>"Input ports"</code><code>);</code></p><p><code>&nbsp;&nbsp;</code><code>midiAccess.inputs.forEach(input =&gt; {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>console.log( </code><code>"Input port [type:'"</code> <code>+ input.type + </code><code>"'] id:'"</code> <code>+ input.id +</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"' manufacturer:'"</code> <code>+ input.manufacturer + </code><code>"' name:'"</code> <code>+ input.name +</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"' version:'"</code> <code>+ input.version + </code><code>"'"</code> <code>);</code></p><p><code>&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;</code><code>console.log(</code><code>"Output ports"</code><code>);</code></p><p><code>&nbsp;&nbsp;</code><code>midiAccess.outputs.forEach(output =&gt; {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>console.log( </code><code>"Output port [type:'"</code> <code>+ output.type + </code><code>"'] id:'"</code> <code>+ output.id +</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"' manufacturer:'"</code> <code>+ output.manufacturer + </code><code>"' name:'"</code> <code>+ output.name +</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"' version:'"</code> <code>+ output.version + </code><code>"'"</code> <code>);</code></p><p><code>&nbsp;&nbsp;</code><code>});</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Now the output is <em>much</em> more promising:</p>
<div><div id="highlighter_63463"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p></td><td><div><p><code>"MIDI ready!"</code></p><p><code>"Input ports"</code></p><p><code>"Input port [type:'input'] id:'input-0' manufacturer:'Microsoft Corporation' name:'5- TD-27' version:'10.0'"</code></p><p><code>"Output ports"</code></p><p><code>"Output port [type:'output'] id:'output-1' manufacturer:'Microsoft Corporation' name:'5- TD-27' version:'10.0'"</code></p></div></td></tr></tbody></table></div></div>
<p><strong>Test 3: dump MIDI messages to the console</strong></p>
<p>I can just hard-code the input and output port IDs for now – when I get into C#, I can do something more reasonable.</p>
<p>Adapting example 9.4 from the Web MIDI docs very slightly, we get:</p>
<p>function logMidiMessage(message) {<br>
  var line = "MIDI message: "<br>
  for (var i = 0; i &lt; event.data.length; i++) {<br>
    line += "0x" + event.data[i].toString(16) + " ";<br>
  }<br>
  console.log(line);<br>
}</p>
<p>function onMIDISuccess(midiAccess) {<br>
  var input = midiAccess.inputs.get('input-0');<br>
  input.onmidimessage = logMidiMessage;<br>
}</p>
<p>Now when I hit a drum, I see MIDI messages – and likewise when I make a change on the module (e.g. switching kit) that gets reported as well – so I know that SysEx messages are working.</p>
<p><strong>Test 4: request the name of kit 1</strong></p>
<p>Timestamp: 07:44</p>
<p>At this point, I need to go back to the V-Drum Explorer code and the TD-27 docs. The kit name is in the first 12 bytes of the KitCommon container, which is at the start of each Kit container. The Kit container for kit 1 starts at 0x04_00_00_00, so I just need to create a Data Request message for the 12 bytes starting at that address. I can do that just by hijacking a command in my console app, and getting it to print out the MIDI message. I need to send these bytes:</p>
<div><div id="highlighter_81422"><table><tbody><tr><td><p>1</p></td><td><div><p><code>F0 41 10 00 00 00 63 11 04 00 00 00 00 00 00 0C 70 F7</code></p></div></td></tr></tbody></table></div></div>
<p>That should be easy enough, adapting example 9.5 of the Web MIDI docs…</p>
<p>(Note of annoyance at this point: forking in JSFiddle doesn’t seem to be working properly for me. I get a new ID, but I can’t change the title in a way that shows up in “Your fiddles” properly. Ah – it looks like I need to do “fork, change title, set as base”. Not ideal, but it works.)</p>
<p>So I’d expect this code to work:</p>
<div><div id="highlighter_210777"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p></td><td><div><p><code>var</code> <code>output = midiAccess.outputs.get(</code><code>'output-1'</code><code>);</code></p><p><code>var</code> <code>requestMessage = [0xf0, 0x41, 0x10, 0x00, 0x00, 0x00, 0x63, 0x11, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x70, 0xf7];</code></p><p><code>output.send(requestMessage);</code></p></div></td></tr></tbody></table></div></div>
<p>But I don’t see any sign that the kit has sent back a response – and worse, if I add <code>console.log("After send");</code> to the script, that doesn’t get logged either. Maybe it’s throwing an exception?</p>
<p>Aha – yes, there’s an exception:</p>
<blockquote><p>
  Failed to execute ‘send’ on ‘MIDIOutput’: System exclusive message is not allowed at index 0 (240).
</p></blockquote>
<p>Ah, my <code>requestMIDIAccess</code> call wasn’t specifically requesting SysEx access. It’s interesting that it was able to <em>receive</em> SysEx messages even though it couldn’t send them.</p>
<p>After changing the call to pass <code>{ sysex: true }</code>, I get back a MIDI message which looks like it probably contains the kit name. Hooray! Step 1 done :)</p>
<p>Timestamp: 08:08 (So all of this took an hour. That’s not too bad.)</p>
<h2>Step 2: Vanilla Blazor project</h2>
<p>Okay, within the existing VDrumExplorer solution, add a new project.</p>
<p>Find the Blazor project template, choose WebAssembly… and get interested by the “ASP.NET Core Hosted” option. I may want that eventually, but let’s not bother for now. (Side-thought: for the not-hosted version, I may be able to try it just by hosting the files in Google Cloud Storage. Hmmm.)</p>
<p>Let’s try to build and run… oh, it failed:</p>
<div><div id="highlighter_193994"><table><tbody><tr><td><p>1</p><p>2</p></td><td><div><p><code>The "ResolveBlazorRuntimeDependencies" task failed unexpectedly.</code></p><p><code>error MSB4018: System.IO.FileNotFoundException: Could not load file or assembly 'VDrumExplorer.Blazor.dll' or one of its dependencies. The system cannot find the file specified.</code></p></div></td></tr></tbody></table></div></div>
<p>That’s surprising. It’s also surprising that it looks like it’s got ASP.NET Core, given that I didn’t tick the box.</p>
<p>There’s a Visual Studio update available… maybe that will help? Upgrading from 16.6.1 to 16.6.3…</p>
<p>For good measure, let’s blow away the new project in case the project template has changed in 16.6.3.</p>
<p>Time to make a coffee…</p>
<p>Try again with the new version… nope, still failing in the same way.</p>
<p>I wonder whether I’ve pinned the .NET Core SDK to an older version and that’s causing a problem?</p>
<p>Ah, yes – there’s a <code>global.json</code> file in <code>Drums</code>, and that specifies 3.1.100.</p>
<p>Aha! Just updating that to use 3.1.301 works. A bit of time wasted, but not too bad.</p>
<p>Running the app now works, including hitting a breakpoint. Time to move onto MIDI stuff.</p>
<p>Timestamp: 08:33</p>
<h2>Step 3: Listing MIDI ports in Blazor</h2>
<p><strong>Substep 1: create a new page</strong></p>
<p>Let’s create a new Razor page. I’d have thought that would be “Add -&gt; New Item -&gt; Razor Page” but that comes up with a <code>.cshtml</code> file instead of the <code>.razor</code> file that everything else is.</p>
<p>Maybe despite being in a “Pages” directory with a <code>.razor</code> extension, these aren’t Razor Pages but Razor Component? Looks like it.</p>
<p>I’m feeling I could get out of my depth really rapidly here. If I were doing this “properly” I’d now read a bunch of docs on Razor. (I’ve been to various talks on it, and used it before, but I haven’t done either for quite a while.)</p>
<p>The “read up on the fundamentals first” and “hack, copy, paste, experiment” approaches to learning a new technology both have their place… I just generally feel a little less comfortable with the latter. It definitely gets to some results quicker, but doesn’t provide a good foundation for doing real work.</p>
<p>Still, I’m firmly in experimentation territory here, so hack on.</p>
<p>The new page has an “initialize MIDI” button, and two labels for input ports and output ports.</p>
<p>Add this to the nav menu, run it, and all seems well. (Eventually I may want to make this the default landing page, but that can come later.)</p>
<p>Time to dive into JS interop…</p>
<p><strong>Substep 2: initialize MIDI</strong></p>
<p>Let’s not rush to listing the ports – just initializing MIDI at all would be good. So add a <code>status</code> field and label, and start looking up JS interop.</p>
<p>I’ve heard of <a href="https://blazor-university.com/">Blazor University</a> before, so that’s probably a good starting point. And yes, there’s a section about <a href="https://blazor-university.com/javascript-interop/">JavaScript interop</a>. It’s worryingly far down the TOC (i.e. I’m skipping an awful lot of other information to get that far) but we’ll plough on.</p>
<p>Calling the <code>requestMIDIAccess</code> function from <code>InitializeMidi</code> is relatively straightforward, with one caveat: I don’t know how to express the result type. I know it’s a JavaScript promise, but how do refer to that within the C# code? Let’s just use <code>object</code> to start with:</p>
<div><div id="highlighter_92992"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p></td><td><div><p><code>private</code> <code>async</code> <code>Task InitializeMidi()</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>promise = </code><code>await</code> <code>JSRuntime.InvokeAsync&lt;</code><code>object</code><code>&gt;(</code><code>"navigator.requestMIDIAccess"</code><code>, TimeSpan.FromSeconds(3));</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Looking more carefully at some docuemntation, it doesn’t look like I can effectively keep a reference to a JavaScript object within the C# code – everything is basically JSON serialized/deserialized across the boundary.</p>
<p>That’s fairly reasonable – but it means we’ll need to write more JavaScript code, I suspect.</p>
<p>Plan:</p>
<ul>
<li>Write a bunch of JavaScript code in the Razor page. (Yes, I’d want to move it if I were doing this properly…)</li>
<li>Keep a global <code>midi</code> variable to keep “the initialized MIDI access”</li>
<li>Declare JavaScript functions for everything I need to do with MIDI, that basically proxy through the <code>midi</code> variable</li>
</ul>
<p>I’d really hoped to avoid writing <em>any</em> JavaScript while running Blazor, but never mind.</p>
<p>Plan fails on first step: we’re not meant to write scripts within Razor pages. Okay, let’s create a <code>midi.js</code> script and include that in <code>index.html</code>.</p>
<p>Unfortunately, the asynchrony turns out to be tricky. We really want to be able to pass a callback to the JavaScript code, but that involves creating a <code>DotNetObjectReference</code> and managing lifetimes. That’s slightly annoying and fiddly.</p>
<p>I’ll come back to that eventually, but for now I can just keep all the state in JavaScript, and <em>ask</em> for the status after waiting for a few seconds:</p>
<div><div id="highlighter_134312"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p></td><td><div><p><code>private</code> <code>async</code> <code>Task InitializeMidi()</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await</code> <code>JSRuntime.InvokeAsync&lt;</code><code>object</code><code>&gt;(</code><code>"initializeMidi"</code><code>, TimeSpan.FromSeconds(3));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await</code> <code>Task.Delay(3000);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>status = </code><code>await</code> <code>JSRuntime.InvokeAsync&lt;</code><code>string</code><code>&gt;(</code><code>"getMidiStatus"</code><code>);</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Result: yes, I can see that MIDI has been initialized. The C# code can fetch the status from the JavaScript.</p>
<p>That’s all the time I have for now – I have a meeting at 9:30. When I come back, I’ll look at making the JavaScript a bit cleaner, and writing a callback.</p>
<p>Timestamp: 09:25</p>
<p><strong>Substep 3: use callbacks and a better library pattern</strong></p>
<p>Timestamp: 10:55</p>
<p>Back again.</p>
<p>Currently my <code>midi.js</code> file just introduces functions into the global namespace. Let’s follow the <a href="https://www.w3.org/wiki/JavaScript_best_practices">W3C JavaScript best practices</a> page guidance instead:</p>
<div><div id="highlighter_519399"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p></td><td><div><p><code>var</code> <code>midi = </code><code>function</code><code>() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>access = </code><code>null</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>status = </code><code>"Uninitialized"</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>function</code> <code>initialize() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>success = </code><code>function</code> <code>(midiAccess) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>access = midiAccess;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>status = </code><code>"Initialized"</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>};</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>failure = (message) =&gt; status = </code><code>"Failed: "</code> <code>+ message;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>navigator.requestMIDIAccess({ sysex: </code><code>true</code> <code>})</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.then(success, failure);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>function</code> <code>getStatus() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>status;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>initialize: initialize,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>getStatus: getStatus</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>};</code></p><p><code>}();</code></p></div></td></tr></tbody></table></div></div>
<p>Is that actually any good? I really don’t know – but it’s at least good enough for now.</p>
<p>Next, let’s work out how to do a callback. Ideally, we’d be able to return something from the JavaScript <code>initialize()</code> method and await that. There’s an interesting <a href="https://joonasw.net/view/csharp-await-and-js-promises-in-blazor">blog post</a> about doing just that, but it’s <em>really</em> long. (That’s not a criticism – it’s a great post that explains everything really well. It’s just it’s very involved.)</p>
<p>I suspect that a bit of hackery will allow a “simpler but less elegant” solution, which is fine by me. Let’s create a <code>PromiseHandler</code> class with a proxy object for JavaScript:</p>
<div><div id="highlighter_380770"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p></td><td><div><p><code>using</code> <code>Microsoft.JSInterop;</code></p><p><code>using</code> <code>System;</code></p><p><code>using</code> <code>System.Threading.Tasks;</code></p><p><code>namespace</code> <code>VDrumExplorer.Blazor</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>class</code> <code>PromiseHandler : IDisposable</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>DotNetObjectReference&lt;PromiseHandler&gt; Proxy { </code><code>get</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>TaskCompletionSource&lt;</code><code>int</code><code>&gt; tcs;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>PromiseHandler()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Proxy = DotNetObjectReference.Create(</code><code>this</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>tcs = </code><code>new</code> <code>TaskCompletionSource&lt;</code><code>int</code><code>&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[JSInvokable]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>void</code> <code>Success() =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>tcs.TrySetResult(0);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[JSInvokable]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>void</code> <code>Failure(</code><code>string</code> <code>message) =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>tcs.TrySetException(</code><code>new</code> <code>Exception(message));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>Task Task =&gt; tcs.Task;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>void</code> <code>Dispose() =&gt; Proxy.Dispose();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>We can then create an instance of that in <code>InitializeMidi</code>, and pass the proxy to the JavaScript:</p>
<div><div id="highlighter_986000"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p></td><td><div><p><code>private</code> <code>async</code> <code>Task InitializeMidi()</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>handler = </code><code>new</code> <code>PromiseHandler();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await</code> <code>JSRuntime.InvokeAsync&lt;</code><code>object</code><code>&gt;(</code><code>"midi.initialize"</code><code>, TimeSpan.FromSeconds(3), handler.Proxy);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>try</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await</code> <code>handler.Task;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>status = </code><code>"Initialized"</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>catch</code> <code>(Exception e)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>status = $</code><code>"Initialization failed: {e.Message}"</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The JavaScript then uses the proxy object for its promise handling:</p>
<div><div id="highlighter_111481"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p></td><td><div><p><code>function</code> <code>initialize(handler) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>success = </code><code>function</code> <code>(midiAccess) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>access = midiAccess;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>handler.invokeMethodAsync(</code><code>"Success"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>};</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>failure = message =&gt; handler.invokeMethodAsync(</code><code>"Failure"</code><code>, message);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>navigator.requestMIDIAccess({ sysex: </code><code>true</code> <code>})</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.then(success, failure);</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>It’s all quite explicit, but it seems to do the job, at least for now, and didn’t take too long to get working.</p>
<p>Timestamp: 11:26</p>
<p><strong>Substep 4: listing MIDI ports</strong></p>
<p>Listing ports doesn’t involve promises, but it does involve an iterator, and I’m dubious that I’ll be able to return that directly. Let’s create an array in JavaScript and copy ports into it:</p>
<div><div id="highlighter_674385"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p></td><td><div><p><code>function</code> <code>getInputPorts() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>ret = [];</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>access.inputs.forEach(input =&gt; ret.push({ id: input.id, name: input.name }));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>ret;</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>(I initially tried just pushing <code>input</code> into the array, but that way I didn’t end up with any data – it’s not clear to me what JSON was returned across the JS/.NET boundary, but it didn’t match what I expected.)</p>
<p>In .NET I then just need to declare a class to receive the data:</p>
<div><div id="highlighter_692213"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p></td><td><div><p><code>public</code> <code>class</code> <code>MidiPort</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[JsonPropertyName(</code><code>"id"</code><code>)]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>Id { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[JsonPropertyName(</code><code>"name"</code><code>)]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>string</code> <code>Name { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>And I can get the input ports, and display them via a field that’s hooked up in the Razor page:</p>
<div><div id="highlighter_659437"><table><tbody><tr><td><p>1</p><p>2</p></td><td><div><p><code>var</code> <code>inputs = </code><code>await</code> <code>JSRuntime.InvokeAsync&lt;List&lt;MidiPort&gt;&gt;(</code><code>"midi.getInputPorts"</code><code>, Timeout);</code></p><p><code>inputDevices = </code><code>string</code><code>.Join(</code><code>", "</code><code>, inputs.Select(input =&gt; $</code><code>"{input.Id} ({input.Name})"</code><code>));</code></p></div></td></tr></tbody></table></div></div>
<p>Success!</p>
<p><img src="https://jonskeetcodingblog.files.wordpress.com/2020/07/blazor-list-ports.png?w=474" alt="Listing ports in Blazor"></p>
<p>Timestamp: 11:46 (That was surprisingly quick.)</p>
<h2>Step 4: Retrieve the “kit 1” name in Blazor</h2>
<p>We need two extra bits of MIDI functionality: sending and receiving data. I’m hoping that exchanging byte arrays via Blazor will be straightforward, so this <em>should</em> just be a matter of creating a callback and adding functions to the JavaScript to send messages and add a callback when a message is received.</p>
<p>Timestamp: 12:16</p>
<p>Okay, well it turned out that exchanging byte arrays wasn’t quite as simple as I’d hoped: I needed to base64-encode on the JS side, otherwise it was transmitted as a JSON object. Discovering that went via creating a <code>MidiMessage</code> class, which I might as well keep around now that I’ve got it. I can now receive messages.</p>
<p>Timestamp: 12:21</p>
<p>Blazor’s state change detection doesn’t include calls to <code>List.Add</code>, which is reasonable. It’s a shame it doesn’t spot <code>ObservableCollection.Add</code> either, though. We can fix this just by calling <code>StateHasChanged</code> though.</p>
<p>I now have a UI that can display messages. The three bits involved (as well as the simple <code>MidiMessage</code> class) are a callback class that delegates to an action:</p>
<div><div id="highlighter_747983"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p></td><td><div><p><code>public</code> <code>class</code> <code>MidiMessageHandler : IDisposable</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>DotNetObjectReference&lt;MidiMessageHandler&gt; Proxy { </code><code>get</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>Action&lt;MidiMessage&gt; handler;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>MidiMessageHandler(Action&lt;MidiMessage&gt; handler)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Proxy = DotNetObjectReference.Create(</code><code>this</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.handler = handler;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>[JSInvokable]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>void</code> <code>OnMessageReceived(MidiMessage message) =&gt; handler(message);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>void</code> <code>Dispose() =&gt; Proxy.Dispose();</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The JavaScript to use that:</p>
<div><div id="highlighter_403051"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p></td><td><div><p><code>function</code> <code>addMessageHandler(portId, handler) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>access.inputs.get(portId).onmidimessage = </code><code>function</code> <code>(message) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>jsonMessage = { data: window.btoa(message.data), timestamp: message.timestamp };</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>handler.invokeMethodAsync(</code><code>"OnMessageReceived"</code><code>, jsonMessage);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>};</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>And then the C# code to receive the callback, and subscribe to it:</p>
<div><div id="highlighter_598159"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p></td><td><div><p><code>var</code> <code>messageHandler = </code><code>new</code> <code>MidiMessageHandler(MessageReceived);</code></p><p><code>await</code> <code>JSRuntime.InvokeVoidAsync(</code><code>"midi.addMessageHandler"</code><code>, Timeout, inputs[0].Id, messageHandler.Proxy);</code></p><p><code>private</code> <code>void</code> <code>MessageReceived(MidiMessage message)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>messages.Add(BitConverter.ToString(message.Data));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>StateHasChanged();</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Timestamp: 12:26</p>
<p>Now let’s try sending the SysEx message to request kit 1’s name… this should be the easy bit!</p>
<p>… except it doesn’t work. The log shows the following error:</p>
<blockquote><p>
  Unhandled exception rendering component: Failed to execute ‘send’ on ‘MIDIOutput’: No function was found that matched the signature provided.
</p></blockquote>
<p>Maybe this is another base64-encoding issue. Let’s try explicitly base64-decoding the data in JavaScript…</p>
<p>Nope, same error. Let’s try hard-coding the data we want to send, using JavaScript that has worked before…</p>
<p>That <em>does</em> work, which suggests my <code>window.atob()</code> call isn’t behaving as expected.</p>
<p>Now I could use some logging here, but let’s try putting a breakpoint in JavaScript. I haven’t done that before. Hopefully it’ll open in the Chrome console.</p>
<p><strong>Whoa!</strong> The breakpoint worked, but in <em>Visual Studio</em> instead. That’s amazing! I can see that <code>atob(data)</code> has returned a string, not an array.</p>
<p><a href="https://stackoverflow.com/questions/21797299">This Stack Overflow question</a> has a potential option. This is really horrible, but if it works, it works…</p>
<p>And it works. Well, sort of. The MIDI message I get back is much longer than I’d expected, and it’s longer than I get in JSFiddle. Maybe my callback wasn’t working properly before.</p>
<p>Timestamp 12:42</p>
<p>Okay, so <code>btoa()</code> isn’t what I want either. <a href="https://stackoverflow.com/questions/12710001">This Stack Overflow question</a> goes into details, but the accepted answer uses a ton of code.</p>
<p>Hmmm… right-clicking on “wwwroot” gives me an option of “Add… Client-Side Library”. Let’s give that a go and see if it make both sides of the base64 problem simpler.</p>
<p>Timestamp: 12:59</p>
<p>Well it didn’t “just work”. The library was added to my <code>wwwroot</code> directory, and trying to use it from <code>midi.js</code> added an <code>import</code> statement at the start of <code>midi.js</code>… which then caused an error of:</p>
<blockquote><p>
  Cannot use import statement outside a module
</p></blockquote>
<p>I guess I really need to know what a JavaScript module is, and whether <code>midi.js</code> should be one. Hmm. Time for lunch.</p>
<h2>Saturday afternoon</h2>
<p>Timestamp: 14:41</p>
<p>Back from lunch and a chat with my parents. Let’s have another look at this base64 library…</p>
<p>(Side note: Visual Studio, while I’m not doing anything at all and I don’t have any documents open, is taking up 80% of my CPU. That doesn’t seem right. Oh well.)</p>
<p>If I just try to import the byte-base64 script directly with a <code>script</code> tag then I end up with an error of:</p>
<blockquote><p>
  Uncaught ReferenceError: exports is not defined
</p></blockquote>
<p>Bizarrely enough, the error message often refers to <code>lib.ts</code>, even if I’ve made sure there’s no Typescript library in <code>wwwroot</code>.</p>
<p>Okay, I’ve now got it to work, by the horrible hack of copying the file to <code>base64.js</code> in <code>wwwroot</code>, removing and removing everything about <code>exports</code>. I may investigate other libraries at some point, but fundamentally this inabilty to correctly base64 encode/decode has been the single most time-consuming and frustrating part so far. Sigh.</p>
<p>(Also, the result is something I’m not happy to put on GitHub, as it involves just a copy of the library file rather than using it as intended.)</p>
<p>Timestamp: 15:01</p>
<h2>Step 5: Retrieve all kit names in Blazor</h2>
<p>Okay, so I’ve got the not-at-all decoded kit name successfully.</p>
<p>Let’s try looping to get all of them, decoding as we go.</p>
<p>This will involve copying some of the “real” V-Drum Explorer code so I can create Data Request messages programmatically, and decode Data Set messages. While I’d love to just add a reference to VDrumExplorer.Midi, I’m definitely not there yet. (I’d need to remove the commons-midi references and replace everything I use. That’s going to be step 6, maybe…)</p>
<p>Timestamp: 15:41</p>
<p>Success! After copying quite a bit of code, everything just worked… nothing was particularly unexpected at this stage, which is deeply encouraging.</p>
<p><img src="https://jonskeetcodingblog.files.wordpress.com/2020/07/blazor-td27.png?w=474" alt="Listing TD-27 kits in Blazor"></p>
<p>I’m going to leave it there for the day, but tomorrow I can try to change the abstraction used by V-Drum Explorer so that it can all integrate nicely…</p>
<h2>Saturday evening</h2>
<p>Timestamp: 17:55</p>
<h2>Interlude: refactoring MIDI access</h2>
<p>Okay, so it turns out I really don’t want to wiat until tomorrow. However, the next step is going to be code I genuinely want to keep, so let’s commit everything I’ve done so far to a new branch, but then go back to the branch I was on.</p>
<p>The aim of this step is to make the MIDI access replaceable. It doesn’t need to be “hot-replaceable” – at least not yet – so I don’t mind using a static property for “the current MIDI implementation”. I make make it more DI-friendly later on.</p>
<p>The two projects I’m going to change are VDrumExplorer.Model, and VDrumExplorer.Midi. Model refers to Midi at the moment, and Midi refers to the <a href="https://github.com/atsushieno/managed-midi">managed-midi</a> library. The plan is to move most of the code from Midi to Model, but without any reference to managed-midi types. I’ll define a few interfaces (e.g. <code>IMidiInput</code>, <code>IMidiOutput</code>, <code>IMidiManager</code>) and write all the rest of the MIDI-related code to refer to those interfaces. I can then ditch VDrumExplorer.Midi, but add VDrumExplorer.Midi.ManagedMidi which will implement my Model interfaces in terms of the managed-midi library – with the hope that tomorrow I can have a Blazor implementation of the same libraries.</p>
<p>I have confidence that this will work reasonably well, as I’ve done the same thing for audio recording/playback devices (with an NAudio implementation project).</p>
<p>Let’s go for it.</p>
<p>Timestamp: 18:03</p>
<p>Okay, that went pretty much as planned. I was actually able to simplify the code a bit, which is nice. There’s potentially more refactoring to do, now that <code>ModuleAddress</code>, <code>DataSegment</code> and <code>RolandMidiClient</code> are in the same project – I can make <code>RolandMidiClient.RequestDataAsync</code> accept a <code>ModuleAddress</code> and return a <code>DataSegment</code>. That can come later though.</p>
<p>(Admittedly testing this found that kit 1 has an invalid value for one instrument. I’ll need to look into that later, but I don’t <em>think</em> it’s a new issue.)</p>
<p>Timestamp: 18:55</p>
<p>The Blazor MIDI interface implementation can wait until tomorrow – but I don’t anticipate it being tricky at all.</p>
<h2>Sunday morning</h2>
<p>Timestamp: 06:54</p>
<p>Okay, let’s do this :) My plan is:</p>
<ul>
<li>Remove all the code that I copied from the rest of V-Drum Explorer into the Blazor project; we shouldn’t need that now.</li>
<li>Add a reference from the Blazor project to VDrumExplorer.Model</li>
<li>Implement the MIDI interfaces</li>
<li>Rework the code just enough to get the previous functionality working again</li>
<li>Rewrite the code to not have any hard-coded module addresses, instead detecting the right schema and listing the kits for any attached (and supported) module, not just the TD-27</li>
<li>Maybe publish it</li>
</ul>
<p>Removing the code and adding the project reference are both trivial, of course. At that point, the code doesn’t compile, but I have a choice: I could get the code compiling again using the MIDI interfaces, but without implementing the interfaces, or I could implement the interface first.</p>
<p><strong>Rewriting existing application code</strong></p>
<p>Despite the order listed above, I’m going to rewrite the application part first, because that will clear the error list, making it easier to spot any mistakes while I <em>am</em> implementing the interface. The downside is that there’ll be bits of code I need to stash somewhere, because they’ll be part of the MIDI implementation eventually, but without wanting to get them right just yet.</p>
<p>I create a WebMidi folder for the implementation, and a scratchpad.txt file in to copy any “not required right now” code.</p>
<p>At this point I’m getting really annoyed with the syntax highlighting of the <code>.razor</code> file. I know it’s petty, but the grey background just for code is really ugly to me:</p>
<p><img src="https://jonskeetcodingblog.files.wordpress.com/2020/07/blazor-ugly-colours.png?w=474" alt="Ugly colours in Blazor"></p>
<p>As I’m going to have to go through all the code anyway, let’s actually use “Add New Razor Page” this time, and move the code into there as I fix it up.</p>
<p>Two minutes later, it looks like what VS provides (at least with that option) isn’t quite what I want. What I really want is a <em>partial</em> class, not a code-behind for the model. It’s entirely possible that they’d be equivalent in this case, but the partial class is closer to what I have right now. <a href="https://gunnarpeipman.com/blazor-partial-page-class/">This blog post</a> tells me exactly what I need.</p>
<p>Timestamp: 07:10</p>
<p>Starting to actually perform the migration, I realise I need an <code>ILogger</code>. For the minute, I’ll use a <code>NullLogger</code>, but later I’ll want to implement a logger that adds to the page. (I already have a <code>Log</code> method, so this should be simple.)</p>
<p>Timestamp: 07:19</p>
<p>That was quicker than I’d expected. Of course, I don’t know whether or not it works.</p>
<p><strong>Implementing the MIDI interfaces</strong></p>
<p>Creating the <code>WebMidiManager</code>, <code>WebMidiInput</code> and <code>WebMidiOutput</code> classes shows me just how little I really need to do – and it’s all code I’ve written before, of course.</p>
<p>For the moment, I’m not going to worry about closing the MIDI connection on <code>IMidiInput.Dispose()</code> etc – we’ll just leave everything open once it’s opened. What I <em>will</em> do is use a single .NET-side event handler for each input port, and do event subscribe/remove handling on the .NET side. If I don’t manage that, the underlying V-Drum Explorer interface will end up getting callbacks on client instances after disposal, and other oddities. The outputs can just be reused though – they’re stateless, effectively.</p>
<p>Timestamp: 07:56</p>
<p>Okay, so that wasn’t too bad. No significant surprises, although there’s one bit of slight ugliness: my <code>IMidiOutput.Send(MidiMessage)</code> method is synchronous, but we’re calling into JavaScript interop which is always asynchronous. As it happens, that’s mostly okay: the <code>Send</code> message is meant to be effectively fire-and-forget anyway, but it does mean that if the call fails, we won’t spot it.</p>
<p>Let’s see if it actually <em>works</em>…</p>
<p>Nope, not yet – initialization fails:</p>
<blockquote><p>
  Cannot read property ‘inputs’ of null
</p></blockquote>
<p>Oddly, a second click of the button <em>does</em> initialize MIDI (although it doesn’t list the kits yet). So maybe there’s a timing thing going on here. Ah yes – I’d forgotten that for initialization, I’ve got to await the initial “start the promise” call, <em>then</em> await the promise handler. That’s easy enough.</p>
<p>Okay, so that’s fixed, but we’re still not listing the kits. While I can step through in the debugger (into the Model code), it would really help if I’d got a log implementation at this point. Let’s do that quickly.</p>
<p>Timestamp: 08:07</p>
<p>Great – I now get a nice log of how device detection is going:</p>
<blockquote>
<ul>
<li>Input device: ‘5- TD-27’</li>
<li>Output device: ‘5- TD-27’</li>
<li>Detecting devices for MIDI ports with name ‘5- TD-27’</li>
<li>No devices detected for MIDI port ‘5- TD-27’. Skipping.</li>
<li>No known modules detected. Aborting</li>
</ul>
</blockquote>
<p>So it looks like we’re not receiving a response to our “what devices are on this port” request.</p>
<p>Nothing’s <em>obviously</em> wrong with the code via a quick inspection – let’s add some console logging in the JavaScript side to get a clearer picture.</p>
<p>Hmm: “Sending message to port [object Object]” doesn’t sound promising. That should be a port ID. Ah yes, simple mistake in <code>WebMidiOutput</code>. This line:</p>
<div><div id="highlighter_868766"><table><tbody><tr><td><p>1</p></td><td><div><p><code>runtime.InvokeVoidAsync(</code><code>"midi.sendMessage"</code><code>, runtime, message.Data);</code></p></div></td></tr></tbody></table></div></div>
<p>should be</p>
<div><div id="highlighter_787287"><table><tbody><tr><td><p>1</p></td><td><div><p><code>runtime.InvokeVoidAsync(</code><code>"midi.sendMessage"</code><code>, port, message.Data);</code></p></div></td></tr></tbody></table></div></div>
<p>It’s amazing how often my code goes wrong as soon as I can’t lean on static typing…</p>
<p>Fix that, and boom, it works!</p>
<p><strong>Generalizing the application code</strong></p>
<p>Timestamp: 08:16</p>
<p>So now I can list the TD-27 kits, but it won’t list anything if I’ve got my TD-17 connected instead… and I’ve got fairly nasty code computing the module addresses to fetch. Let’s see how much easier I can make this now that I’ve got the full power of the Model project to play with…</p>
<p>Timestamp: 08:21</p>
<p>It turns out it’s really easy – but very inefficient. I don’t have any public information in the schema about which field container stores the kit name. I can load <em>all</em> the data for one kit at a time, and retrieve the formatted kit name for that loaded data, but that involves loading way more information than I really need.</p>
<p>So that’s not ideal – but it <em>worked first time</em>. First I listed the kits on my TD-27, and that worked as before. Turn that off and turn on the TD-17, rerun, and boom:</p>
<p><img src="https://jonskeetcodingblog.files.wordpress.com/2020/07/blazor-td17.png?w=474" alt="Listing TD-17 kits in Blazor"></p>
<p>It even worked with my Aerophone, which I only received last week. (They’re mostly “InitTone” as the Aerophone splits user kits from preset kits, and the user kits aren’t populated to start with. The name is repeated as there’s no “kit subname” on the Aerophone, and I haven’t yet changed the code to handle that. But hey, it works…)</p>
<p><img src="https://jonskeetcodingblog.files.wordpress.com/2020/07/blazor-aerophone.png?w=474" alt="Listing Aerophone tones in Blazor"></p>
<p>That’s enough for this morning, certainly. I hadn’t honestly expected the integration to go this quickly.</p>
<p>This afternoon I’ll investigate hosting options, and try to put the code up for others to test…</p>
<p>Timestamp: 08:54</p>
<p>After just tidying up this blog post a bit, I’ve decided I definitely want to include the code on GitHub, and publish the result online. That will mean working out what to do with the base64 library (which is at least MIT-licensed, so that shouldn’t be too bad) but this will be a fabulous thing to show in the talks I give about V-Drum Explorer. And everyone can laugh at my JavaScript, of course.</p>
<h2>Sunday afternoon</h2>
<p><strong>Publishing as a web site</strong></p>
<p>Timestamp: 13:12</p>
<p>Running <code>dotnet publish -c Release</code> in the Blazor directory creates output that looks like I should be able to serve it statically, which is what I’d hoped having unchecked the “ASP.NET Core Hosting” box on project creation.</p>
<p>One simple way of serving static content is to use <a href="https://cloud.google.com/storage">Google Cloud Storage</a>, uploading all the files to a bucket and then <a href="https://cloud.google.com/storage/docs/hosting-static-website">configuring the bucket appropriately</a>. Let’s give it a go.</p>
<p>The plan is to basically follow the tutorial, but once I’ve got a simple <code>index.html</code> file working, upload the Blazor application. I already have HTTPS load balancing with Google Cloud, and the <code>jonskeet.uk</code> domain is hosted in Google Domains, so it <em>should</em> all be straightforward.</p>
<p>I won’t take you through all the steps I went through, because the tutorial does a good job of that – but the sample page is up and working, served over HTTPS with a new Google-managed SSL certificate.</p>
<p>Timestamp: 13:37</p>
<p>Time to upload the Blazor app. It’s not in a <em>brilliant</em> state at the moment – once this step is done I’ll want to get rid of the “counter” sample etc, but that can come later. I’m somewhat-expecting to have to edit MIME types as well, but we’ll see.</p>
<p>In the Google Cloud Storage browser, let’s just upload all the files – yup, it works. Admittedly it’s slightly irritating that I had to upload each of the directories separately – just uploading <code>wwwroot</code> would create a new <code>wwwroot</code> directory. I expect that using <code>gsutil</code> from the command line will make this easier in the future.</p>
<p>But then… it just worked!</p>
<p>Timestamp: 13:51 (the previous step only took a few minutes at the computer, but I was also chasing our cats away from the frogs they were hunting in the garden)</p>
<p><strong>Tidying up the Blazor app</strong></p>
<p>The point of the site is really just a single page. We don’t need the navbar etc.</p>
<p>Timestamp: 14:12</p>
<p>Okay, that looks a lot better :)</p>
<p><strong>Speeding up kit name access</strong></p>
<p>If folks are going to be using this though, I really want to speed up the kit loading. Let’s see how hard it is to do that – it should all be in Model code.</p>
<p>Timestamp: 14:20</p>
<p>Done! 8 minutes to implement the new functionality. (A bit less, actually, due to typing up what I was going to do.)</p>
<p>The point of noting that isn’t to brag – it’s to emphasize that having performed the integration with the main Model code (which I’m much more comfortable in) I can develop really quickly. Doing the same thing in either JavaScript or in the Blazor code would have been much less pleasant.</p>
<p><strong>Republish</strong></p>
<p>Let’s try that <code>gsutil</code> command I was mentioning earlier:</p>
<ul>
<li>Delete everything in the Storage bucket</li>
<li>Delete the previous release build</li>
<li>Publish again with <code>dotnet publish -c Release</code></li>
<li><code>cd bin/Release/netstandard2.1/publish</code></li>
<li><code>gsutil -m cp -r . gs://vdrumexplorer-web</code></li>
</ul>
<p>The last command explained a bit more:<br>
– <code>gustil</code>: invoke the <a href="https://cloud.google.com/storage/docs/gsutil">gsutil tool</a><br>
– <code>-m</code>: perform operations in parallel<br>
– <code>cp</code>: copy<br>
– <code>-r</code>: recursively<br>
– <code>.</code>: source directory<br>
– <code>gs://vdrumexplorer-web</code>: target bucket</p>
<p>Hooray – that’s much simpler than doing it through the web interface (useful as that is, in general).</p>
<p><strong>Load balancer updating</strong></p>
<p>My load balancer keeps on losing the configuration for the backend bucket and certificate. I strongly suspect that’s because it was created in Kubernetes engine. What I should actually do is update the k8s configuraiton and then let that flow.</p>
<p>Ah, it turns out that the k8s ingress doesn’t <em>currently</em> support a Storage Bucket backend, so I had to create a new load balancer. (While I could have served over HTTP without a load balancer, in 2020 anything without HTTPS support feels pretty ropy.)</p>
<p>Of course, load balancers cost money – I <em>may</em> not keep this up forever, just for the sake of a single demo app. But I’m sure I can afford it for a while, and it could be useful for other static sites too.</p>
<p>The other option is to serve the application from my k8s cluster – easy enough to do, just a matter of adding a service.</p>

<p>Okay, I’m done. This has been an amazing weekend – I’m thrilled with where I ended up. If you’ve got a suitable Roland instrument, you can try it for yourself at <a href="https://vdrumexplorer.jonskeet.uk/" rel="nofollow">https://vdrumexplorer.jonskeet.uk</a>.</p>
<p>The code isn’t on GitHub just yet, but I expect it to be within a week (<a href="https://github.com/jskeet/DemoCode/tree/master/Drums">in the normal place</a>).</p>
<p>I’m <em>slightly</em> disappointed that it doesn’t seem to work on my phone. I’d have been amused to see the kits listed via MIDI over Bluetooth, running .NET code via WASM on a mobile device – but I can look into all of that later.</p>
<p>The most annoying aspect of all of this was definitely the base64 issue… firstly that JavaScript doesn’t come with a reliable base64 implementation (for the situation I’m in, anyway) and secondly that adding a client library was rather more fraught than I’d have expected. I’m sure it’s all doable, but beyond my level of expertise.</p>
<p>Overall, I’ve been very impressed with Blazor, and I’ll definitely resurrect the Noda Time Blazor app for time zone conversions that I was working on a while ago.</p>
	</div><!-- .entry-content -->
	
	</article></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>