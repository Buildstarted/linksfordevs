<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Reverse Engineering Netgear&#x27;s Auth to extend my Meural - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Reverse Engineering Netgear&#x27;s Auth to extend my Meural - linksfor.dev(s)"/>
    <meta property="article:author" content="John Doe"/>
    <meta property="og:description" content="My adventure adding a Twilio powered MMS Integration to my digital picture frame"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://ma.rtin.so/posts/reverse-engineering-netgear-auth-to-extend-my-meural/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Reverse Engineering Netgear&#x27;s Auth to extend my Meural</title>
<div class="readable">
        <h1>Reverse Engineering Netgear&#x27;s Auth to extend my Meural</h1>
            <div>by John Doe</div>
            <div>Reading time: 34-44 minutes</div>
        <div>Posted here: 05 Aug 2020</div>
        <p><a href="https://ma.rtin.so/posts/reverse-engineering-netgear-auth-to-extend-my-meural/">https://ma.rtin.so/posts/reverse-engineering-netgear-auth-to-extend-my-meural/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><article><div><p>Back in January 2020 I shared a tweet demonstrating a <a href="https://www.twilio.com/">Twilio</a> integration with my <a href="https://meural.netgear.com/canvasii">Meural Canvas</a> digital picture frame.</p><p>In the months since, guests have had a lot of fun with it and it’s been awesome seeing occasional surprise memories from friends pop up. That said, building that integration wasn’t the most straightforward task. I documented the journey (and failures) I took to arrive at the ultimate solution, with the intention of illustrating that reverse engineering is largely about persistence, and full of surprises. Most notably, I did not expect to encounter a dynamically generated virtual machine that generates and injects the headers required to validate authentication requests. I did find reference to Google’s <a href="https://www.widevine.com/">Widevine Content Decryption Module</a> but I’m not certain that technology is in play, or if the code tries to check for its presence at some point.</p><h2 id="testing-the-waters">Testing the waters</h2><p>From a glance at my Google Wifi app I could see that the Meural connected to my network as <code>192.168.86.52</code>, so the first port of call was a port-scan! <a href="https://nmap.org/">nmap</a> to the rescue.</p><div><pre><code data-lang="bash">$ nmap -A -T5 -Pn 192.168.86.52
Starting Nmap 7.80 <span>(</span> https://nmap.org <span>)</span> at 2020-07-25 16:39 CDT
Warning: 192.168.86.52 giving up on port because retransmission cap hit <span>(</span>2<span>)</span>.
Nmap scan report <span>for</span> 192.168.86.52
Host is up <span>(</span>0.0100s latency<span>)</span>.
Not shown: <span>912</span> closed ports, <span>87</span> filtered ports
PORT   STATE SERVICE VERSION
80/tcp open  http  Apache httpd 2.4.18
|_http-server-header: Apache/2.4.18 <span>(</span>Ubuntu<span>)</span>
|_http-title: <span>403</span> Forbidden
Service Info: Host: 127.0.0.1

Service detection performed. Please report any incorrect results at https://nmap.org/submit/
Nmap <span>done</span>: <span>1</span> IP address <span>(</span><span>1</span> host up<span>)</span> scanned in 16.34 seconds
</code></pre></div><p>Unfortunately limited surface area, and no ssh, bummer! But… there’s a webserver, cool! Let’s try making a request.</p><p><img src="https://ma.rtin.so/img/meural-403.png" alt="Meural 403"></p><p>As <code>nmap</code> hinted, hitting the device yields a 403, but it’s good to know it’s running <a href="https://ubuntu.com/">Ubuntu</a> and <a href="https://httpd.apache.org/">Apache</a>! Great! I tried a cursory search of the <a href="https://httpd.apache.org/security/vulnerabilities_24.html">Apache Vulnerabilities</a>, but it yielded nothing exciting for <code>2.4.18</code>. Time to start fuzzing, I chose <a href="https://github.com/xmendez/wfuzz">wfuzz</a> as a lightweight simple utility to explore what may be exposed. <code>wfuzz</code> allows you, among other things, to supply a wordlist that it will substitute into a supplied URL which in our case is to attempt to find endpoints that return a non-40x http response on the device. Many <a href="https://wiki.skullsecurity.org/Passwords">great wordlists</a> exist but of the few I tried <a href="https://github.com/xmendez/wfuzz/blob/master/wordlist/general/megabeast.txt">megabeast</a> yielded the most interesting/useful results.</p><div><pre><code data-lang="bash">$ wfuzz -w wordlist/general/megabeast.txt --hc <span>403</span> http://192.168.86.52/FUZZ

Target: http://192.168.86.52/FUZZ
Total requests: 45459

<span>===================================================================</span>
ID       Response   Lines  Word   Chars     Payload
<span>===================================================================</span>

000009226:   <span>301</span>    <span>9</span> L    <span>28</span> W   <span>328</span> Ch    <span>"compile"</span>
000016580:   <span>301</span>    <span>9</span> L    <span>28</span> W   <span>326</span> Ch    <span>"files"</span>
000017134:   <span>301</span>    <span>9</span> L    <span>28</span> W   <span>326</span> Ch    <span>"fonts"</span>
000034194:   <span>200</span>    <span>17</span> L   <span>42</span> W   <span>633</span> Ch    <span>"remote"</span>
000039179:   <span>301</span>    <span>9</span> L    <span>28</span> W   <span>327</span> Ch    <span>"static"</span>
000041161:   <span>301</span>    <span>9</span> L    <span>28</span> W   <span>330</span> Ch    <span>"templates"</span>
000043724:   <span>301</span>    <span>9</span> L    <span>28</span> W   <span>315</span> Ch    <span>"vendor"</span>
000043899:   <span>301</span>    <span>9</span> L    <span>28</span> W   <span>326</span> Ch    <span>"video"</span>

Total time: 128.6474
Processed Requests: <span>45459</span>
Filtered Requests: <span>45451</span>
Requests/sec.: 353.3610
</code></pre></div><p>Running <code>wfuzz</code> showed me that the Meural exposes a remote utility — which, as far as I can tell, they don’t actually tell you about. Hmm. Accessing the remote utility at <code>http://192.168.86.52/remote</code> returns the following page:</p><p><img src="https://ma.rtin.so/img/meural-remote.png" alt="meural remote"></p><p>I poked around the remote utility for a couple of hours, but that proved fruitless; I was unable to find a security hole (kudos to the team!). While you can control the device with the remote utility, I didn’t want to expose my local network to connect it to Twilio. Since the device has both a cloud interface and an iOS application for remote management, I figured there was probably a tunnel connecting the picture frame to Meural’s backend. I decided to see if I could use their web interface to build my SMS application. Before I dove into that, I wanted to see if I could intercept that tunnel. Not only could this allow me to intercept or inject my own commands, it’d allow me to get a better understanding of how the device operates and even potentially to understand (and try to abuse) the software update process.</p><h2 id="dnsmasq-to-the-rescue">dnsmasq to the rescue!</h2><p>I started by setting up <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> on my laptop so I could hijack and forward DNS queries. I then configured my router to use my laptop as a DNS server..</p><div><pre><code data-lang="bash">Jul <span>24</span> 00:00:00 dnsmasq<span>[</span>2783<span>]</span>: query<span>[</span>AAAA<span>]</span> amqp.meural.com from 192.168.86.1
Jul <span>24</span> 00:00:00 dnsmasq<span>[</span>2783<span>]</span>: cached amqp.meural.com is &lt;CNAME&gt;
Jul <span>24</span> 00:00:00 dnsmasq<span>[</span>2783<span>]</span>: cached rabbit-meural-prod-b4fd362ef1e521da.elb.eu-west-1.amazonaws.com is NODATA-IPv6
Jul <span>24</span> 00:00:00 dnsmasq<span>[</span>2783<span>]</span>: query<span>[</span>A<span>]</span> amqp.meural.com from 192.168.86.1
Jul <span>24</span> 00:00:00 dnsmasq<span>[</span>2783<span>]</span>: cached amqp.meural.com is &lt;CNAME&gt;
Jul <span>24</span> 00:00:00 dnsmasq<span>[</span>2783<span>]</span>: cached rabbit-meural-prod-b4fd362ef1e521da.elb.eu-west-1.amazonaws.com is 99.80.99.6
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: query<span>[</span>AAAA<span>]</span> api.meural.com from 192.168.86.1
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: forwarded api.meural.com to 1.1.1.1
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: reply api.meural.com is &lt;CNAME&gt;
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: reply d15y2g2ihab1ug.cloudfront.net is 13.226.205.63
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: reply d15y2g2ihab1ug.cloudfront.net is 13.226.205.99
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: reply d15y2g2ihab1ug.cloudfront.net is 13.226.205.82
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: reply d15y2g2ihab1ug.cloudfront.net is 13.226.205.30
Jul <span>24</span> 00:09:45 dnsmasq<span>[</span>3045<span>]</span>: reply api.meural.com is &lt;CNAME&gt;
</code></pre></div><p>After changing the DNS server, I could see that the device tries to hit <code>api.meural.com</code> and <code>amqp.meural.com</code>. I wanted to see what requests the device was making to those endpoints. To do that, I attempted to coerce the device into hitting my webserver instead. I started by changing my dnsmasq configuration to redirect requests pointed at <code>api.meural.com</code> and <code>amqp.meural.com</code> to <code>mamps.laptop</code>.</p><div><pre><code data-lang="bash">log-facility<span>=</span>/tmp/dnsmasq.log
log-queries
cname<span>=</span>amqp.meural.com,mamps.laptop
cname<span>=</span>api.meural.com,mamps.laptop
</code></pre></div><p>I then generated a self-signed certificate using <a href="https://www.openssl.org/">openssl</a>, added it to my Keychain, and set up an HTTP server to dump the raw requests to stdout.</p><div><pre><code data-lang="bash">$ sudo openssl genrsa -out meural.key <span>2048</span>
$ openssl req -new -x509 -key meural.key -out meural.crt -days <span>365</span> -subj /CN<span>=</span>api.meural.com
$ security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain meural.crt
$ http-server --ssl --cert meural.crt --key meural.key --port <span>443</span> --log-ip -a 0.0.0.0
</code></pre></div><p>Finally, I made the target CNAME resolve to my laptop:</p><div><pre><code data-lang="bash">$ grep mamps /etc/hosts
192.168.86.128 mamps.laptop
</code></pre></div><p>After restarting dnsmasq I could see <code>api.meural.com</code> now resolving to my laptop:</p><div><pre><code data-lang="bash">Jul <span>24</span> 00:11:24 dnsmasq<span>[</span>3571<span>]</span>: query<span>[</span>AAAA<span>]</span> api.meural.com from 192.168.86.1
Jul <span>24</span> 00:11:24 dnsmasq<span>[</span>3571<span>]</span>: config api.meural.com is &lt;CNAME&gt;
Jul <span>24</span> 00:11:24 dnsmasq<span>[</span>3571<span>]</span>: query<span>[</span>A<span>]</span> api.meural.com from 192.168.86.1
Jul <span>24</span> 00:11:24 dnsmasq<span>[</span>3571<span>]</span>: config api.meural.com is &lt;CNAME&gt;
Jul <span>24</span> 00:11:24 dnsmasq<span>[</span>3571<span>]</span>: /etc/hosts mamps.laptop is 192.168.86.128
</code></pre></div><p>Unfortunately (but unsurprisingly) the device refuses to connect. I suspect it’s because the Meural either implements <a href="https://security.stackexchange.com/questions/29988/what-is-certificate-pinning">certificate pinning</a> or it (rightfully!) rejects the <a href="https://en.wikipedia.org/wiki/Self-signed_certificate">self-signed certificate</a> I provisioned. I tried doing a similar thing for the ELB without success. The Meural developers win again! Feeling a bit disappointed, I decided to switch gears and focus on <code>api.meural.com</code>.</p><h2 id="chartering-new-territory">Chartering new territory</h2><p>As previously mentioned, the Meural provides both a web interface and iOS application that lets you purchase art, upload photos and configure the device. The web portal leverages <code>api.meural.com</code>, and I figured I probably could too.</p><p><img src="https://ma.rtin.so/img/meural-portal.png" alt="meural portal"></p><p>Before I could start leveraging the same APIs used in this portal, I need to obtain an access token. Let’s take a look at the request made upon login using the Chrome network inspector:</p><p><img src="https://ma.rtin.so/img/meural-login.png" alt="meural login"></p><p>Viewed as a curl request, trimmed to the meaty bits:</p><div><pre><code data-lang="bash">curl <span>'https://accounts.netgear.com/mfa/auth/?redirectUrl=https://my.meural.netgear.com/'</span> <span>
</span><span></span>  -H <span>'x-lz0ckp04-f: Ay4QKYhzAQA....'</span> <span>
</span><span></span>  -H <span>'x-lz0ckp04-b: -jdr95b'</span> <span>
</span><span></span>  -H <span>'x-lz0ckp04-z: p'</span> <span>
</span><span></span>  -H <span>'x-lz0ckp04-a: 1m3FynGGY8zW3U.....'</span> <span>
</span><span></span>  -H <span>'x-lz0ckp04-c: A876J....'</span> <span>
</span><span></span>  -H <span>'cookie: ...'</span> <span>
</span><span></span>  --data-binary <span>'{"emailReset":"","serialNumber":"","sessionID":"","devtypeid":"","xtoken":"&lt;redacted&gt;","tokenType":"","userAgent":{"browser":"Chrome","platform":"MacIntel","appCodeName":"Mozilla","appName":"Netscape","vendor":"Google Inc.","product":"Gecko"}}'</span> <span>
</span><span></span>  --compressed
</code></pre></div><p>A few things here stood out to me. First of all, there’s a lot of content passed via those mysterious <code>x-lz0ckp04</code> headers. Second, it appears my password is encrypted and passed within the <code>xtoken</code> field of the request body. I wanted to find out what those headers meant and how my password was encrypted, so I dug into the admin application code. The admin application is an Angular app that, luckily, does not have minified or obscured source code (it even includes comments!). I started by digging into the LoginController (<code>https://accounts.netgear.com/js/public/login/LoginController.js</code>).</p><p>A quick look through the code shows that this is our target to recreate a token:</p><div><pre><code data-lang="js"><span>let</span> <span>xtoken</span> <span>=</span> <span>getEncrypt</span>();
<span>$scope</span>.<span>credentials</span>.<span>xtoken</span> <span>=</span> <span>xtoken</span>;
<span>$scope</span>.<span>tempCred</span>.<span>emailReset</span> <span>=</span> <span>$scope</span>.<span>credentials</span>.<span>emailReset</span>;
<span>$scope</span>.<span>tempCred</span>.<span>serialNumber</span> <span>=</span> <span>$scope</span>.<span>credentials</span>.<span>serialNumber</span>;
<span>$scope</span>.<span>tempCred</span>.<span>sessionID</span> <span>=</span> <span>$scope</span>.<span>credentials</span>.<span>sessionID</span>;
<span>$scope</span>.<span>tempCred</span>.<span>devtypeid</span> <span>=</span> <span>$scope</span>.<span>credentials</span>.<span>devtypeid</span>;
<span>$scope</span>.<span>tempCred</span>.<span>xtoken</span> <span>=</span> <span>$scope</span>.<span>credentials</span>.<span>xtoken</span>;
<span>$scope</span>.<span>tempCred</span>.<span>userAgent</span> <span>=</span> <span>globalServices</span>.<span>userAgentString</span>();

<span>$http</span>({
  <span>method</span><span>:</span> <span>'POST'</span>,
  <span>url</span><span>:</span> <span>basePath</span> <span>+</span> <span>"/mfa/authWAC/"</span> <span>+</span> <span>redirect</span>,
  <span>data</span><span>:</span> <span>$scope</span>.<span>tempCred</span>,
  <span>timeout</span><span>:</span> <span>30000</span>
}).<span>then</span>(<span>function</span> <span>successCallback</span>(<span>response</span>) {
</code></pre></div><p>And associated <code>getEncrypt</code> function:</p><div><pre><code data-lang="js"><span>var</span> <span>getEncrypt</span> <span>=</span> <span>function</span> () {
  <span>let</span> <span>epochTime</span> <span>=</span> Math.<span>round</span>((<span>new</span> Date()).<span>getTime</span>() <span>/</span> <span>1000</span>);
  <span>let</span> <span>enData</span> <span>=</span> <span>$scope</span>.<span>credentials</span>.<span>email</span> <span>+</span> <span>" ######-----##### "</span> <span>+</span> <span>$scope</span>.<span>credentials</span>.<span>password</span> <span>+</span> <span>" ######-----##### "</span> <span>+</span> <span>epochTime</span>;
  <span>let</span> <span>encrypt</span> <span>=</span> <span>new</span> <span>JSEncrypt</span>();
  <span>var</span> <span>publicKey</span> <span>=</span> <span>globalServices</span>.<span>getPublicKey</span>();
  <span>encrypt</span>.<span>setPublicKey</span>(<span>publicKey</span>);
  <span>return</span> <span>encrypt</span>.<span>encrypt</span>(<span>enData</span>);
}
</code></pre></div><p>By tracing it through to <code>globalServices</code> we can see that the public key is a constant. It’s a base64 encoded 2048bit DER key which we can verify/decode <a href="https://lapo.it/asn1js/#MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA6oLssFCWGau5e4HtxNfeb0Az8phTtcxiAUb-Whtb6asLUMiHKDwbXKUf6GmsUKkJceidR4n2x17SxmEl8us9hda3X9a53kzOEQLgb8G5sKE0jIc6oCXurvQEP3F9t4lxWRjesDU9cbH8eZmpsQYmXgAr-lFj5xDmCkbS7XF0ejfxOqF9VcwUWzCCj-WTiFYZt-C7Ujz1YNubWAqWLHCay8SwdKtF5_BUYiztGrwUyXULhCpHd4blL8zU7vPeAMCqvDuV_a-J5ZQTJwO41iv3X-n7l7inme-84jfbc-TC4pZTG2CU8EHm-rpkBxng2oiUQn_ok6dUPjVkNCfdAEpbZQIDAQAB">here</a>.</p><div><pre><code data-lang="js"><span>getPublicKey</span><span>:</span> <span>function</span>(){
  <span>var</span> <span>publicKey</span> <span>=</span> <span>"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA6oLssFCWGau5e4HtxNfeb0Az8phTtcxiAUb+Whtb6asLUMiHKDwbXKUf6GmsUKkJceidR4n2x17SxmEl8us9hda3X9a53kzOEQLgb8G5sKE0jIc6oCXurvQEP3F9t4lxWRjesDU9cbH8eZmpsQYmXgAr+lFj5xDmCkbS7XF0ejfxOqF9VcwUWzCCj+WTiFYZt+C7Ujz1YNubWAqWLHCay8SwdKtF5/BUYiztGrwUyXULhCpHd4blL8zU7vPeAMCqvDuV/a+J5ZQTJwO41iv3X+n7l7inme+84jfbc+TC4pZTG2CU8EHm+rpkBxng2oiUQn/ok6dUPjVkNCfdAEpbZQIDAQAB"</span>;
  <span>return</span> <span>publicKey</span>;
},
</code></pre></div><p>Using these pieces of information, I tried to make my own token and substitute it into the request to see if it would work.</p><div><pre><code data-lang="js"><span>const</span> <span>JSEncrypt</span> <span>=</span> <span>require</span>(<span>'node-jsencrypt'</span>);
<span>const</span> <span>publicKey</span> <span>=</span> <span>'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA6oLssFCWGau5e4HtxNfeb0Az8phTtcxiAUb+Whtb6asLUMiHKDwbXKUf6GmsUKkJceidR4n2x17SxmEl8us9hda3X9a53kzOEQLgb8G5sKE0jIc6oCXurvQEP3F9t4lxWRjesDU9cbH8eZmpsQYmXgAr+lFj5xDmCkbS7XF0ejfxOqF9VcwUWzCCj+WTiFYZt+C7Ujz1YNubWAqWLHCay8SwdKtF5/BUYiztGrwUyXULhCpHd4blL8zU7vPeAMCqvDuV/a+J5ZQTJwO41iv3X+n7l7inme+84jfbc+TC4pZTG2CU8EHm+rpkBxng2oiUQn/ok6dUPjVkNCfdAEpbZQIDAQAB'</span>;

<span>function</span> <span>getEncryptedPassword</span>(<span>email</span>, <span>password</span>) {
  <span>const</span> <span>encrypt</span> <span>=</span> <span>new</span> <span>JSEncrypt</span>();
  <span>const</span> <span>epochTime</span> <span>=</span> Math.<span>round</span>((<span>new</span> Date()).<span>getTime</span>() <span>/</span> <span>1000</span>);
  <span>encrypt</span>.<span>setPublicKey</span>(<span>publicKey</span>);
  <span>const</span> <span>enData</span> <span>=</span> <span>`</span><span>${</span><span>email</span><span>}</span><span> ######-----##### </span><span>${</span><span>password</span><span>}</span><span> ######-----##### </span><span>${</span><span>epochTime</span><span>}</span><span>`</span>;
  <span>return</span> <span>encrypt</span>.<span>encrypt</span>(<span>enData</span>);
}

<span>console</span>.<span>log</span>(<span>getEncryptedPassword</span>(<span>process</span>.<span>env</span>.<span>MEURAL_EMAIL</span>, <span>process</span>.<span>env</span>.<span>MEURAL_PW</span>));
</code></pre></div><div><pre><code data-lang="bash">$ MEURAL_EMAIL<span>=</span>&lt;redacted&gt; MEURAL_PW<span>=</span>&lt;redacted&gt; node token.js
YA6Cb62u2TVehIv+4k...

$ curl -X POST <span>'https://accounts.netgear.com/mfa/auth/?redirectUrl=https://my.meural.netgear.com/'</span> --data <span>'{"xtoken": "YA6Cb62u2TVehIv+4k...", ...}'</span>
Restricted
</code></pre></div><p>Shucks - I’ll admit that I wasn’t too surprised that didn’t work. Next, I used the Chrome debugger to set a breakpoint in the <code>getEncryptedPassword</code> function so I could double check that I was passing in the same arguments to generate a valid <code>xtoken</code>. I was. I then tested injecting one of my generated tokens, that worked too. It was clear I needed to take a closer look at the <code>x-lz0ckp04-*</code> headers.</p><h2 id="surprise-its-drm">Surprise! It’s DRM.</h2><p>I tried to hook <code>XMLHttpRequest</code>, but it seemed like the app was aware of that; it would stop setting said headers 😭! However if I just hooked <code>XMLHttpRequest.prototype.setRequestHeader</code>, it seemed unaware — a much needed, though small, win.</p><p><img src="https://ma.rtin.so/img/meural-login-debugger.png" alt="meural login debugger"></p><p>Not too far into meddling, I managed to trigger a 500 Internal Server Error and get a nice stacktrace. It’s looked like it was a node/express backend built on top of the <a href="https://sailsjs.com/">Sails.js framework</a> (a fellow Austin company!). I later learned this 500 happens if you don’t supply the <code>validDomain</code> cookie.</p><div><pre><code data-lang="js">{
  <span>"stack"</span><span>:</span> <span>"TypeError: Cannot read property 'includes' of undefined
</span><span>  at Object.validateReq (/cam_server_web/api/services/UtilityService.js:282:45)
</span><span>  at Object.wrapper [as validateReq] (/cam_server_web/node_modules/@sailshq/lodash/lib/index.js:3282:19)
</span><span>  at Object.auth (/cam_server_web/api/controllers/MfaController.js:106:20)
</span><span>  at wrapper (/cam_server_web/node_modules/@sailshq/lodash/lib/index.js:3282:19)
</span><span>  at routeTargetFnWrapper (/cam_server_web/node_modules/sails/lib/router/bind.js:181:5)
</span><span>  at callbacks (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:164:37)
</span><span>  at param (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:138:11)
</span><span>  at pass (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:145:5)
</span><span>  at nextRoute (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:100:7)
</span><span>  at callbacks (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:167:11)
</span><span>  at alwaysAllow (/cam_server_web/node_modules/sails/lib/hooks/policies/index.js:224:11)
</span><span>  at routeTargetFnWrapper (/cam_server_web/node_modules/sails/lib/router/bind.js:181:5)
</span><span>  at callbacks (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:164:37)
</span><span>  at param (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:138:11)
</span><span>  at pass (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:145:5)
</span><span>  at nextRoute (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:100:7)
</span><span>  at callbacks (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:167:11)
</span><span>  at _sendHeaders (/cam_server_web/node_modules/sails/lib/hooks/cors/to-prepare-send-headers.js:91:7)
</span><span>  at routeTargetFnWrapper (/cam_server_web/node_modules/sails/lib/router/bind.js:181:5)
</span><span>  at callbacks (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:164:37)
</span><span>  at param (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:138:11)
</span><span>  at pass (/cam_server_web/node_modules/@sailshq/express/lib/router/index.js:145:5)"</span>,
  <span>"message"</span><span>:</span> <span>"Cannot read property 'includes' of undefined"</span>
}
</code></pre></div><p>So, holy smokes, the team really turned off easy mode for this part. I assumed our <code>x-lz0ckp04-*</code> headers were some kind of XSRF token. Oddly, I could neither locate them in the html source nor was I seeing them sent back over the wire. After not finding an XHR request anywhere, I turned to <a href="https://mitmproxy.org/">mitmproxy</a> to obtain a packet capture (pcap). When I searched the pcap, the <code>x-lz0ckp04</code> string was nowhere to be found 😕. However, I did locate one of the other strings (<code>AyitXI1zAQAAjKszx1DbNZWmK1wxfkqy8tzDqhtPmqrJz6......vAAAAAA==</code>) in <code>https://accounts.netgear.com/extJS/ngr_common.js</code> 🙀. If you refresh this URL a few times you’ll see it is dynamically generated.</p><div><pre><code data-lang="js"><span>var</span> <span>H</span><span>=</span>[<span>"p_hRmNzMNq9Q0FHrthtFY9uL"</span>,<span>"b-df3bfDD4RBqg"</span>,<span>"oQOTfUc02BnwbuMeBa2x521TBA"</span>,<span>"LN2"</span>,<span>"Sutxu5TsAPIMuQPN"</span>,<span>"q60k5vjiGY1GpSz-lzg"</span>,<span>"M3DpGD11vHW7M4hrTpTklg"</span>,<span>"wVHiKQx4mWg"</span>,<span>"R54r5v3tRbRQ5mKW1nBkVtbzjDae7xcZ"</span>,<span>"GUviGDYtp1mE"</span>,<span>"W0ngf2ksrB2aSQ"</span>,<span>"bhumWxxFuXTDNsxn"</span>,<span>"ZFriUipHjii1QQ"</span>,<span>"Lz63eFgpywDpdtIrIg"</span>,<span>"qVf0eHgvnRSDWNI7demY_G5YH5oVUKE"</span>,<span>"RJt2x_7Kc9NYzkXLu2NXE5rz7WettGgFY96dweVe7p2SkohSQ37EWQI"</span>,<span>"KedPlo_EBclqwUc"</span>,<span>"_XPUIh0Qz0eKBA"</span>,<span>"7"</span>,<span>"Au8O45O6SatxoyaT3FsjOg"</span>,<span>"pgmlS3dso3L2fOMtMeL6vT8BGdc"</span>,<span>"kn_SCEIfsQ-nQsA"</span>,<span>"93"</span>,<span>"jn_RGA1KpCnuUMhvK6msxCVPRJt3Ksw"</span>,<span>"hA_he18KnX26"</span>,<span>"fkf4PD0m"</span>,<span>"XRmoZixbvF6QCA"</span>,<span>"now"</span>,<span>"aMhdp430EuonsyvZ1SpQOLCdjzuoyUVeeQ"</span>,<span>"UfRAz40"</span>,<span>"SJUrl-o"</span>,<span>"Gt9xnrG-YaZiww"</span>,<span>"RAmmdEYV7TqxLLo"</span>,<span>"gepDrIs"</span>,<span>"09ZUq4XfOKJD"</span>,<span>"pI4_78eAZw"</span>,<span>"T_Zk7YTGE4kX6leT"</span>,<span>"8UHyGkk"</span>,<span>"IFv_Ymd45kL5S-9y"</span>,<span>"OdAykYaPPu0Pmw"</span>,<span>"aC2kd2909163OrsXM5PcuQ"</span>,<span>"qo1S2orVMfoMyy-iqA"</span>,<span>"11"</span>,<span>"XaBP6-fxWQ"</span>,<span>"112"</span>,<span>"kKwJwZ-eeew3lQms5F4GPYnPuE-c3y8-FPrHmP1yq8H_0e0DSlCccxD48Rb0AOcqTII"</span>,<span>"mp4"</span>,<span>"o_0"</span>,<span>"charCodeAt"</span>,<span>"ip"</span>,<span>"RhaRSnYV_2GqD7piSPT_jSgAAMAqaKaVqAhW"</span>,<span>"w7pUu8XrQJAuuC6xmF8rP-HW"</span>,<span>"kGW7XV1Mk1c"</span>,<span>"3KpUsY0"</span>,<span>"uKkxzuyHd45Yw0Swu14vS9nn6kTaqCs5HA"</span>,<span>"filter"</span>,<span>"OKYYiPXMGOJ_pwXn6Q"</span>,<span>"32"</span>,<span>"jLhI9I-TKeZg8lm3hwJFV9yShQ"</span>,<span>"log"</span>,<span>"19"</span>,<span>"e3XZXkEC_USy"</span>,<span>"JtpYjbP6Nv8Z4k8"</span>,<span>"Ie4mjZuPJd1-gDXG"</span>,<span>"82"</span>,<span>"kULoOjRs3Br-"</span>,<span>"wss"</span>,<span>"sshyt6nvZs8S7A"</span>,<span>"hF35VS52mie4XQ"</span>,<span>"a9hnk97-Z-FL1VPqoRtaRZ2qhWvr6HYqctSQ"</span>,<span>"48Ngk8SGHQ"</span>,<span>"s7cDqdjxJ5ZL00c"</span>,<span>"T6kVy4Odf-p_gVK6tA5aPJWRuAjDhT51"</span>,<span>"gi"</span>,<span>"CK0HrYyKRogDgg"</span>,<span>"from-page-runscript"</span>,<span>"uhC0dXJy2g"</span>,<span>"8wr5TE5CiQ"</span>,<span>"47"</span>,<span>"13"</span>,<span>"YP14qr3-"</span>,<span>"Xt9tz_TbYNJ8_H8"</span>,<span>"nGXaHipd5G-y"</span>,<span>"rQGvR0ISonuCTg"</span>,<span>"QVbfKgVyzD3i"</span>,<span>"GdxB05ibeqAjiWujv0JGc5mPkRabwlM4ENTZy69A-Iin1vA"</span>,<span>"vX_3JyEKkTw"</span>,<span>"byLSeG9-zhTqUvYQAIHK534LDck"</span>,<span>"DLUd09WTePl3hCA"</span>,<span>"y2rhIzFhnATeZv8WIZGb7lxYfLBcHOLq0G00T3awch9uBSjElJM"</span>,<span>"tCXSJEZe1QunKLM"</span>,<span>"Add"</span>,<span>"TX38LRhesiQ"</span>,<span>"shKydzd-igLIZPEXH7OnwnUs"</span>,<span>"BQT1AGRB4TSPBJ8xMfmHm0xsPOUWZ-OH"</span>,<span>"nSHRKgUAtHyrL6INKN-lrWg"</span>,<span>"4uFqr4rrMv0"</span>,<span>"cYshtqj-Ut9OkSfptR1VJKs"</span>,<span>"4IwQ2ObIY-Z-gQTaokJML9ei_VuNiF8k"</span>,<span>"BRu6bn8G3gLZQsM"</span>,<span>"OjWZWGoqyhs"</span>,<span>"2l7OLApst3msNKRQTL4"</span>,<span>"3sh6htn0Y_RJxnjo"</span>,<span>"M-Vys7DALuEixw"</span>,<span>"98"</span>,<span>"r5MRxuqiZe4LqA"</span>,<span>"arr"</span>,<span>"fFjlFD1bonWAJoZ9Kw"</span>,<span>"wUe4GFR_3xSOBI9W"</span>,<span>"1aES-966Qr5p_X-Lhi1XZOvU13THkRkHPaaClI8"</span>,<span>"Vm_FBlcPrhc"</span>,<span>"fBelN3pmtkg"</span>,<span>"7220QyofrA"</span>,<span>"Z1voBytI7ALV"</span>,<span>"-GPtGjBQ9CHHA9xPJ8HfllsGEQ"</span>,<span>"Object"</span>,<span>"PxX_CWFW7jWPH4kwO_mGjU16J_YXYeCPhlZ5dHuNTDRNXQXVzOREyp1Dbug0qEqTgCBl-dQahALrgD-G"</span>,<span>"xYJBpNGxR81usiWetA"</span>,<span>"cB6gcQJ98nPaCA"</span>,<span>"_BqUQT5P0XuAGw"</span>,<span>"blT4axR2gCnuGvkUJsO1"</span>,<span>"aPUO4o-hBg"</span>,<span>"90"</span>,<span>"28"</span>,<span>"75"</span>,<span>"qUCkVXxik2j_feAhKg"</span>,<span>"nedWicPGMa95wWbopzBEZcqW"</span>,<span>"Z3X9RjBOs1GBEYE4fIzthAswL5sT"</span>,<span>"num"</span>,<span>"jj6mZ1QT-B3FSfk3Zp-t9EVL"</span>,<span>"yvhjp7e8I75AwmU"</span>,<span>"k8lq_uCnFbAb"</span>,<span>"SNF47P2nW_kMpg"</span>,<span>"jKIS7ciOeA"</span>,<span>"nKwy6M8"</span>,<span>"aw6CWHxWwH7YFYVALA"</span>,<span>"NpY1o9yBUPQm2w"</span>,<span>"CW3LKhEc5F2CHplsQYXCiBp3ZOcHaec"</span>,<span>"]"</span>,<span>"hroGyNSRYuQ5mg6izV5GIg"</span>,<span>"16"</span>,<span>"ftp"</span>,<span>"r9Jl8eSgGJwQ3EOq-mYFZdrU"</span>,<span>"Y0y6R3E"</span>,<span>"r1_VYiAW-yC7"</span>,<span>"eiCuQk4k0Vq9N6Zcecc"</span>,<span>"0AGqJQhYyQ"</span>,<span>"ycU5i52sIvEBjRrj2GMuH4P_"</span>,<span>"TC76GHBl"</span>,<span>"dRSQTkdUulOzHvY6Pc3O"</span>,<span>"Qt9FgJr2LtMOi0GEqVElaw"</span>,<span>"o6clr9nkX59D"</span>,<span>"bclmqK4"</span>,<span>"y"</span>,<span>"OFb7dnc9kiOnRdg2"</span>,<span>"b-VblM-3EqMQ5g"</span>,<span>"X2rND1IG-n-dFJRn"</span>,<span>"zR_FYxdDqAngY8YBew"</span>,<span>"12"</span>,<span>"poY97-i2VrB91Wo"</span>,<span>"2d"</span>,<span>"wrQOjMWYS9R3vAXlzkY"</span>,<span>"id"</span>,<span>"bZk08aa4T8kW"</span>,<span>"N48l4oU"</span>,<span>"1VjvNm0d_AXMXZt8BpSzlA"</span>,<span>"b_BMpufOR_Ru8WjZgCd0RqCCqQ"</span>,<span>"88"</span>,<span>"68"</span>,<span>"t60rxuuINPkzxVSV6zo"</span>,<span>"VOxJrovmO8o1vTE"</span>,<span>"62"</span>,<span>"TOxtrp8"</span>,<span>"-5JpyY2nCslG3V-T"</span>,<span>"mVP2OxdL618"</span>,<span>"map"</span>,<span>"woU40Yu6J6USgTux6VgDJNnqwTI"</span>,<span>"esAr_byuMPhBzVc"</span>,<span>"s-0NuKm9F9gtoCk"</span>,<span>"9Q2qfQR903fLDKVZ"</span>,<span>"4XHnPhpN81M"</span>,<span>"M8MZtfOvJQ"</span>,<span>"LC6RcUR2wgzhZ-lJRZr06ngZ"</span>,<span>"064419OML5BG1Es"</span>,<span>"_R6JGBhLtFnvLqQ"</span>,<span>"whuVd1Aq1i3vOecEfIA"</span>,<span>"KsJWj4LaPql-yB3v5ggKdA"</span>,<span>"kSDUaGt6xSXm"</span>,<span>"SkrKFytE7GWq"</span>,<span>"k3jiMiFTq1uBHIh5NNf4vAsE"</span>,<span>"MuABua26Ac4mmTzKwUEJN64"</span>,<span>"etF-u47uXM4D4GbSpGdoD6W0"</span>,<span>"mfdS26rVcq8_1VY"</span>,<span>"GhzyGXdj7xCdBqQDMeKbnFo"</span>,<span>"EBncL0t31UD6N6MLMNe9ow"</span>,<span>"WbUc3Yr3ef1yhQX1"</span>,<span>"u3iKJ1tO3CCtOphlSNc"</span>,<span>"aM1Uh4KBfs4n00yI6l9UaZs"</span>,<span>"4z6ZXlFf8w"</span>,<span>"SH6zM2Av6BXZKMp1T-jvp1R-GrY-"</span>,<span>"cxK9Y2c"</span>,<span>"xaBpr630EQ"</span>,<span>"49"</span>,<span>"fromCharCode"</span>,<span>"k8Mp27yHIvhTwnHY9ypfcZu78AnK"</span>,<span>"2XrPMjJtmw"</span>,<span>"dfpI9Yv-"</span>,<span>"\s"</span>,<span>"xFnYJxk"</span>,<span>"cFD1dnopmiiBQfgm"</span>,<span>"Promise"</span>,<span>"DNkpq7DUd9cV"</span>,<span>"4gGBT0BX2nq4HJQwHLfigCY8L_Bwats"</span>,<span>"b2z8JjU"</span>,<span>"gEX2NywznEuAIQ"</span>,<span>"-ZRJ_uPwRJB9"</span>,<span>"cL084ffDWt0dv2SUlnNDDazrziOl_x4bNg"</span>,<span>"QNJx6OuvCZsU8XeFxnA1Vfbjkzal9Q4NLMyzpcdOm6uR4cA"</span>,<span>"fm2DIhI_mFKwI5dPTt6pgC1QTq0DSJnstTksYwg"</span>,<span>"86"</span>,<span>"imHbHAxVrmHdVM02"</span>,<span>"i4MI08zAarI-mUO9qAMcPoPa5VA"</span>,<span>"0CicD2MV2EqQ"</span>,<span>"Hc9Ehq-HF7VG-1_m1w"</span>,<span>"Ee5Du4bmLA"</span>,<span>"hEjvbCgiiw"</span>,<span>"Yth-0KD1"</span>,<span>"HyybDU9al3LiCJg"</span>,<span>"_spdhpPED-Mu41qSzhlV"</span>,<span>"fnqEPBI51h6jJqgIWMKhvSNIUooZWJKxwg"</span>,<span>"TE34BDxDsWyMEpNiMvrWkgQwbroTe_uVx19sX1KneEozd3bs6cJlvqM1W9dfiyf4vRNNmetkq2DBrxGoZz0Wha0CI9nS8Y3EhQePGsgtmsL0U_F0H8AjFas"</span>,<span>"24"</span>,<span>"HpJQqru-Q8tK"</span>,<span>"t9dpvuqIB54H0HuB"</span>,<span>"41"</span>,<span>"duRLoJ8"</span>,<span>"hifuVDcxzRjFR_glSKw"</span>,<span>"--Nd0qz_OrE0wnirjQ"</span>,<span>"Math"</span>,<span>"Y-YPrr68AfhF6ivAwmlM"</span>,<span>"-TmsSmYW9SrhSd0xCca70kpEadk"</span>,<span>"a8pqi-y0K9gn5FI"</span>,<span>"111"</span>,<span>"iFXdEh1shHaKI6tR"</span>,<span>"pfgataKgENUl"</span>,<span>"55EAi8fNP_J3zDP86gwPNdbd3EnNhxBsX4aK"</span>,<span>"dLYv6dqlWaRW_EaPv30"</span>,<span>"o5MEztSZS6F6jQ"</span>,<span>"0XnWKhEuznO_Obk"</span>,<span>"rzWZQjgF1iDTXw"</span>,<span>"9JAMzMbmauAOl2Oh"</span>,<span>"97"</span>,<span>"console"</span>,<span>"XWfNFSBink-t"</span>,<span>"-E7AGBYA"</span>,<span>"Pz-Fa1s4tQLUWN0MU5zfnhYsNPo"</span>,<span>"Error"</span>,<span>"mXPwLg56qUOSVOMgZrT-"</span>,<span>"G6AH6fiwSw"</span>,<span>"KdEay9aWbqoYgBv5qRAIE8-f-Bw"</span>,<span>"xshorPn8HpMP8ArA134KX-Xq2W4"</span>,<span>"([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})"</span>,<span>"EoIkrO_wN8l5pALC3hs7Ke2j"</span>,<span>"FwmJXmtE7jShHNlSKauM"</span>,<span>"FQatdS5d1E7gEY5uKqc"</span>,<span>"VgjaByJZtWal"</span>,<span>"qagq4_D4KqlTrCnVkiMsDA"</span>,<span>"-S6BBXQM"</span>,<span>"4"</span>,<span>"gIct2aTEPvlIjVDg6jIUQZ-q9z3AtzFX"</span>,...<span>```
</span></code></pre></div><p><em>A 25kb array of encrypted constants (functions, offsets, keys, strings)</em></p><p>The string I located in the pcap appeared in some initialization code for a strange event: (snipped for brevity):</p><div><pre><code data-lang="js">(<span>function</span>(<span>e</span>) {
  <span>e</span>.<span>initCustomEvent</span>(<span>"XyunHUgug"</span>, <span>false</span>, <span>false</span>, [<span>"AyitXI1zAQAAjKszx1DbNZWmK1wxfkqy8tzDqhtPmqrJz6......vAAAAAA=="</span>, <span>"h-dcoMP.......gvn5C8FBHxJtIGwS9U"</span>, [],
    [<span>1099101272</span>, <span>1331287587</span>, <span>1662884978</span>, ...], <span>"OE9HjV.....MlH3DRmpaM"</span>, <span>"OE9H...."</span>, [
      [<span>/(?:)/</span>, <span>/^((?=.*.netgear.com$)(?!.*stg))/i</span>, .... , <span>/^((?=/oauth/resetpassword/))/i</span>, <span>/^(</span>
</code></pre></div><p>I wrote a <a href="https://www.tampermonkey.net/">tampermonkey</a> script and triggered a breakpoint when that event was invoked:</p><div><pre><code data-lang="js"><span>// ==UserScript==
</span><span>// @name     Meural Debugging
</span><span>// @namespace  http://tampermonkey.net/
</span><span>// @version    0.1
</span><span>// @author     Martin Amps
</span><span>// @match    https://accounts.netgear.com/login*
</span><span>// @run-at     document-start
</span><span>// @grant    none
</span><span>// ==/UserScript==
</span><span></span>
(<span>function</span>() {
  <span>var</span> <span>customEvents</span> <span>=</span> [];
  window.<span>addEventListener</span> <span>=</span> (<span>function</span>(<span>origAddEL</span>) {
    <span>return</span> <span>function</span>() {
      <span>const</span> <span>args</span> <span>=</span> <span>arguments</span>;
      <span>if</span> (<span>customEvents</span>.<span>includes</span>(<span>args</span>[<span>0</span>])) {
        <span>args</span>[<span>1</span>] <span>=</span> <span>function</span>() {
          <span>debugger</span>;
          <span>return</span> <span>args</span>[<span>1</span>].<span>apply</span>(<span>this</span>, <span>arguments</span>);
        }
      }

      <span>return</span> <span>origAddEL</span>.<span>apply</span>(<span>this</span>, <span>args</span>);
    }
  })(window.<span>addEventListener</span>);

  document.<span>createEvent</span> <span>=</span> (<span>function</span>(<span>origCE</span>) {
    <span>return</span> <span>function</span>() {
      <span>const</span> <span>e</span> <span>=</span> <span>origCE</span>.<span>apply</span>(<span>this</span>, <span>arguments</span>);

      <span>if</span> (<span>arguments</span>[<span>0</span>] <span>===</span> <span>'CustomEvent'</span>) {
        <span>const</span> <span>origICE</span> <span>=</span> <span>e</span>.<span>initCustomEvent</span>;
        <span>e</span>.<span>initCustomEvent</span> <span>=</span> <span>function</span>() {
          <span>customEvents</span>.<span>push</span>(<span>arguments</span>[<span>0</span>]);
          <span>origICE</span>.<span>apply</span>(<span>this</span>, <span>arguments</span>);
        };
      }

      <span>return</span> <span>e</span>;
    }
  })(document.<span>createEvent</span>);
})();
</code></pre></div><p>To my surprise I stumbled upon what looked like a VM …. gating their login page? …..</p><div><pre><code data-lang="js"><span>function</span> <span>iB</span>(<span>iC</span>) {
    <span>var</span> <span>iD</span>, <span>iE</span>;
    <span>for</span> (;;) {
        <span>if</span> (<span>et</span> <span>!==</span> <span>d</span>) {
            <span>iE</span> <span>=</span> <span>et</span>;
            <span>et</span> <span>=</span> <span>d</span>;
            <span>return</span> <span>iE</span>
        }
        <span>iD</span> <span>=</span> <span>iC</span>.<span>b</span>();
        <span>if</span> (<span>iC</span>.<span>c</span>.<span>length</span> <span>===</span> <span>0</span>) {
            <span>dA</span>[<span>iD</span>](<span>iC</span>)
        } <span>else</span> {
            <span>bo</span>(<span>dA</span>[<span>iD</span>], <span>iC</span>)
        }
    }
}
</code></pre></div><p>After some stepping through with the debugger, I was able to locate the decryption function:</p><div><pre><code data-lang="js"><span>function</span>(<span>dX</span>) {
    <span>var</span> <span>dY</span> <span>=</span> <span>dX</span>.<span>d2</span>();
    <span>var</span> <span>dZ</span> <span>=</span> <span>I</span>[<span>dY</span>];
    <span>if</span> (<span>typeof</span> <span>dZ</span> <span>!==</span> <span>"undefined"</span>) {
      <span>dX</span>.<span>I</span>[<span>dX</span>.<span>I</span>.<span>length</span> <span>-</span> <span>1</span>] <span>=</span> <span>dZ</span>;
      <span>return</span>
    }
    <span>var</span> <span>ea</span> <span>=</span> <span>dX</span>.<span>I</span>.<span>u</span>();
    <span>var</span> <span>eb</span> <span>=</span> <span>H</span>[<span>dY</span>];
    <span>var</span> <span>ec</span> <span>=</span> <span>M</span>(<span>eb</span>);
    <span>var</span> <span>ed</span> <span>=</span> <span>M</span>(<span>ea</span>);
    <span>var</span> <span>ee</span> <span>=</span> <span>ec</span>[<span>0</span>] <span>+</span> <span>ed</span>[<span>0</span>] <span>&amp;</span> <span>255</span>;
    <span>var</span> <span>ef</span> <span>=</span> <span>""</span>;
    <span>for</span> (<span>var</span> <span>eg</span> <span>=</span> <span>1</span>; <span>eg</span> <span>&lt;</span> <span>ec</span>.<span>length</span>; <span>++</span><span>eg</span>) {
      <span>ef</span> <span>+=</span> <span>u</span>(<span>ed</span>[<span>eg</span>] <span>^</span> <span>ec</span>[<span>eg</span>] <span>^</span> <span>ee</span>)
    }
    <span>I</span>[<span>dY</span>] <span>=</span> <span>ef</span>;
    <span>dX</span>.<span>I</span>.<span>p</span>(<span>ef</span>)
  }
</code></pre></div><p>I then set another breakpoint in the decryption function, traversed up the callstack, and after a little digging managed to (finally!) locate our magic header key:</p><div><pre><code data-lang="js">{
  <span>"uuidTokenKey"</span><span>:</span> <span>"f"</span>,
  <span>"integrityKey"</span><span>:</span> <span>"b"</span>,
  <span>"bundleSeedKey"</span><span>:</span> <span>"c"</span>,
  <span>"bundleIdKey"</span><span>:</span> <span>"d"</span>,
  <span>"firmwareKey"</span><span>:</span> <span>"z"</span>,
  <span>"payloadKey"</span><span>:</span> <span>"a"</span>,
  <span>"bundleSeed"</span><span>:</span> <span>"Ax17W41zAQAAVAahkfTXiodilKwVDdavZ_5JmtO0QjrhV7y732tdhWYCCkrGAVIc7lKucmGVwH8AAEB3AAAAAA=="</span>,
  <span>"bundleId"</span><span>:</span> <span>"o_0"</span>,
  <span>"firmware"</span><span>:</span> <span>"p"</span>,
  <span>"instrumentationStateKey"</span><span>:</span> <span>"cUsMIKCT"</span>,
  <span>"headerChunkSize"</span><span>:</span> <span>7900</span>,
  <span>"headerNamePrefix"</span><span>:</span> <span>"X-Lz0Ckp04-"</span>,
  <span>"xhrStateKey"</span><span>:</span> <span>"SrhtHHFTF"</span>,
  <span>"uuidToken"</span><span>:</span> <span>"AyitXI1zAQAAjKszx1DbNZWmK1wxfkqy8tzDqhtPmqrJz6dX4pJLKrSMldILATTKpRCucmGVwH8AAOfvAAAAAA=="</span>,
  <span>"base64Alphabet"</span><span>:</span> <span>"h-dcoMPy7lsRXZfYjWDT0aOQA3k=LNb6rEum4z21_ipKeVqgvn5C8FBHxJtIGwS9U"</span>,
  <span>"shuffleKey"</span><span>:</span> [],
  <span>"encryptionKey"</span><span>:</span> [<span>1099101272</span>, <span>1331287587</span>, <span>1662884978</span>, <span>2046360320</span>, <span>1716290900</span>, <span>326586344</span>, <span>1052250470</span>, <span>2006171371</span>],
  ...
}
</code></pre></div><p>While I was there, I used the Chrome debugger to modify the source to generate a decrypted array!</p><div><pre><code data-lang="js">{
  <span>'0ZDgbFyyUEAtlQ1R_zb-DNY69w'</span><span>:</span> <span>'Client::afterReady'</span>,
  <span>'arrpMDqUMh0WijwajxjuGrAg41U'</span><span>:</span> <span>'setLocalDescription'</span>,
  <span>'Zi8I6vdrxs24SMHMOP8B8yjL'</span><span>:</span> <span>':afterReady:start'</span>,
  <span>'2xQEkbNagpuTaPnq'</span><span>:</span> <span>':afterReady'</span>,
  <span>'LMi4KUP3IRgD'</span><span>:</span> <span>'suffixes'</span>,
  <span>'bPijO1H1OhtO50o0y3TGT8QdvleizZM'</span><span>:</span> <span>'Default Browser Helper'</span>,
  <span>'2F8P0cwy0f2mH7LaDvEY7iTXIt0Lci3KSRTpHqPMA-JnDkI'</span><span>:</span> <span>'Widevine Content Decryption Module'</span>,
  <span>'96n7difdAjgf6y0zrBb8CA'</span><span>:</span> <span>'Hel$&amp;?6%){mZ+#@'</span>,
  <span>'6AdGvIA-wQ'</span><span>:</span> <span>'canvas'</span>,
  <span>'FLDRRwGxYkZ5khtenCCD'</span><span>:</span> <span>'XMLHttpRequest'</span>,
  <span>'jqvbDTPkElIR9xxb'</span><span>:</span> <span>'originalXhr'</span>,
  ...
}
</code></pre></div><p>The shiny object above revealed how I could construct the initial set of headers, for example it clearly articulates the mapping such that <code>uuidTokenKey</code> = <code>f</code> means that <code>x-lz0ckp04-f</code> should be <code>uuidToken</code> (or <code>AyitXI1zAQAAjKszx1DbNZWmK1wxfkqy8tzDqhtPmqrJz6dX4pJLKrSMldILATTKpRCucmGVwH8AAOfvAAAAAA==</code>).</p><div><pre><code data-lang="js"><span>|</span> <span>header</span>       <span>|</span> <span>mapping</span>    <span>|</span> <span>value</span>                                                                                    <span>|</span>
<span>|--------------|------------|------------------------------------------------------------------------------------------|</span>
<span>|</span> <span>x</span><span>-</span><span>lz0ckp04</span><span>-</span><span>a</span> <span>|</span> <span>payload</span>    <span>|</span> <span>???</span>                                                                                      <span>|</span>
<span>|</span> <span>x</span><span>-</span><span>lz0ckp04</span><span>-</span><span>b</span> <span>|</span> <span>integrity</span>  <span>|</span> <span>???</span>                                                                                      <span>|</span>
<span>|</span> <span>x</span><span>-</span><span>lz0ckp04</span><span>-</span><span>c</span> <span>|</span> <span>bundleSeed</span> <span>|</span> <span>Ax17W41zAQAAVAahkfTXiodilKwVDdavZ_5JmtO0QjrhV7y732tdhWYCCkrGAVIc7lKucmGVwH8AAEB3AAAAAA</span><span>==</span> <span>|</span>
<span>|</span> <span>x</span><span>-</span><span>lz0ckp04</span><span>-</span><span>d</span> <span>|</span> <span>bundleId</span>   <span>|</span> <span>o_O</span>                                                                                      <span>|</span>
<span>|</span> <span>x</span><span>-</span><span>lz0ckp04</span><span>-</span><span>f</span> <span>|</span> <span>uuidToken</span>  <span>|</span> <span>AyitXI1zAQAAjKszx1DbNZWmK1wxfkqy8tzDqhtPmqrJz6dX4pJLKrSMldILATTKpRCucmGVwH8AAOfvAAAAAA</span><span>==</span> <span>|</span>
<span>|</span> <span>x</span><span>-</span><span>lz0ckp04</span><span>-</span><span>z</span> <span>|</span> <span>firmware</span>   <span>|</span> <span>p</span>                                                                                        <span>|</span>
</code></pre></div><p>Getting the last two items appeared to be a loooot of effort for not much return. It also seemed quite brittle; small changes in how they encrypt the payload and generate the signature could require a large investment to maintain. I decided to change strategies and blackbox the script into working in a sandboxed environment so I could exfiltrate the headers through a (theoretically) reasonably stable API..</p><h2 id="working-with-the-black-box">Working with the black box</h2><p>While it would be easier to do this with a headless browser like <a href="https://github.com/puppeteer/puppeteer">puppeteer</a>, I opted to optimize for lower latency, reduced dependencies, and most importantly, fun. To start, I downloaded the <code>ngr_common.js</code> file and loaded it in an index.html locally. Then I started deobfuscating the minified code adding logging and slowly replacing browser clases such as XMLHttpRequest with my own stubs until it would run as a standalone script. It was quite a game of whackamole and often required me to compare the executions in the browser with a version invoked via <code>node --inspect ngr_common.js</code> and infer (based on the constants decrypted) what it was doing, so I could stub out those components in the browser.</p><div><pre><code data-lang="js"><span>&lt;</span> <span>decrypted</span> <span>QBVF28A18dbABq6sPg</span> <span>afterReadyCb</span>
<span>&lt;</span> <span>decrypted</span> <span>EJ3ua2iBWmV1ryYxjFC0PuwRzQ</span> <span>Transmission</span><span>::</span><span>init</span>
<span>&lt;</span> <span>decrypted</span> <span>sfikNQH1</span> <span>fetch</span>
<span>&lt;</span> <span>decrypted</span> <span>Kea1BXKfT3FLnH9y_Ea5Wg</span> <span>onSubmitWrapper</span>
<span>&lt;</span> <span>decrypted</span> <span>eI7pOzqXOg</span> <span>submit</span>
<span>exception</span> <span>in</span> <span>ngr_common</span>.<span>js</span><span>:</span><span>5492</span>
 <span>5490</span>         }
 <span>5491</span>
<span>&gt;</span><span>5492</span>         <span>ft</span>.<span>I</span>.<span>p</span>(<span>h</span>(<span>fw</span>, <span>fx</span>, <span>fv</span>))
 <span>5493</span>     }, <span>function</span>(<span>fy</span>) {
 <span>5494</span>         <span>fy</span>.<span>m</span> <span>=</span> <span>0</span>
</code></pre></div><p>Eventually, I got it working! There were many red herrings on the way… I ended up mocking out all kinds of webrtc and browser apis such as <code>RTCPeerConnection</code>, <code>LocalStorage</code>, <code>naviator.getMediaDevices</code>, and <code>navigator.plugins</code>. Once it was working, I was able to remove those parts — their code gracefully handles the absence of those APIs.</p><p><img src="https://ma.rtin.so/img/meural-working-token.png" alt="working token"></p><p>I then combined the method I used to generate a valid xtoken with this new method of exfiltrating headers to see if I could execute a successful authentication request!</p><div><pre><code data-lang="js"><span>const</span> <span>JSEncrypt</span> <span>=</span> <span>require</span>(<span>'node-jsencrypt'</span>);
<span>const</span> <span>fetch</span> <span>=</span> <span>require</span>(<span>'node-fetch'</span>);

<span>const</span> <span>PUBLIC_KEY</span> <span>=</span> <span>'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA6oLssFCWGau5e4HtxNfeb0Az8phTtcxiAUb+Whtb6asLUMiHKDwbXKUf6GmsUKkJceidR4n2x17SxmEl8us9hda3X9a53kzOEQLgb8G5sKE0jIc6oCXurvQEP3F9t4lxWRjesDU9cbH8eZmpsQYmXgAr+lFj5xDmCkbS7XF0ejfxOqF9VcwUWzCCj+WTiFYZt+C7Ujz1YNubWAqWLHCay8SwdKtF5/BUYiztGrwUyXULhCpHd4blL8zU7vPeAMCqvDuV/a+J5ZQTJwO41iv3X+n7l7inme+84jfbc+TC4pZTG2CU8EHm+rpkBxng2oiUQn/ok6dUPjVkNCfdAEpbZQIDAQAB'</span>;

<span>const</span> <span>NGR_COMMON_URL</span> <span>=</span> <span>'https://accounts.netgear.com/extJS/ngr_common.js'</span>;
<span>let</span> <span>payload</span> <span>=</span> {<span>"emailReset"</span><span>:</span><span>""</span>, <span>"serialNumber"</span><span>:</span><span>""</span>, <span>"sessionID"</span><span>:</span><span>""</span>, <span>"devtypeid"</span><span>:</span><span>""</span>, <span>"xtoken"</span><span>:</span><span>""</span>, <span>"tokenType"</span><span>:</span><span>""</span>, <span>"userAgent"</span><span>:</span> {}};

<span>// This wrapper script will be prepended to the ngr_common.js code before we execute it to trick it into thinking it's running in a browser, so it will calculate the header values for us
</span><span></span><span>const</span> <span>wrapper</span> <span>=</span>
<span>`
</span><span>// The fake implementation of XMLHttpRequest to allow us to capture the setRequestHeader invocations, ultimately exfiltrating the x-lz0ckp04-* headers.
</span><span>class XMLHttpRequest {
</span><span>    constructor() {
</span><span>        this.headers = [];
</span><span>    }
</span><span>
</span><span>    open() { }
</span><span>    send() { }
</span><span>
</span><span>    setRequestHeader(k, v) {
</span><span>        this.headers[k] = v;
</span><span>    }
</span><span>}
</span><span>
</span><span>class CustomEvent {
</span><span>    initCustomEvent() {
</span><span>        this.type = arguments[0];
</span><span>        this.detail = arguments[3];
</span><span>    }
</span><span>}
</span><span>
</span><span>function dispatchEvent(event) {
</span><span>    const listeners = callbacks &amp;&amp; callbacks[event.type] || [];
</span><span>    for (var i = 0; i &lt; listeners.length; i++) {
</span><span>        listeners[i].call(this, event);
</span><span>    }
</span><span>
</span><span>    return true;
</span><span>}
</span><span>
</span><span>const callbacks = {};
</span><span>const document = {
</span><span>    addEventListener() { },
</span><span>
</span><span>    // Widevine uses a cool trick where it creates an &lt;a&gt; tag to which it assigns a href for the browser to helpfully parse that url so it can pull out protocol, hostname, pathname, etc for it to do comparisons against internally.
</span><span>    createElement() {
</span><span>        if (arguments[0] === 'a') {
</span><span>            myAnchor = new Object();
</span><span>            myAnchor.hostname = 'accounts.netgear.com';
</span><span>            myAnchor.search = '?redirectUrl=https://my.meural.netgear.com';
</span><span>            myAnchor.protocol = 'https:';
</span><span>            myAnchor.pathname = '/mfa/auth';
</span><span>            return myAnchor;
</span><span>        }
</span><span>    },
</span><span>
</span><span>    createEvent() {
</span><span>        return new CustomEvent();
</span><span>    }
</span><span>};
</span><span>
</span><span>const window = {
</span><span>    XMLHttpRequest: XMLHttpRequest,
</span><span>
</span><span>    removeEventListener() {
</span><span>        delete callbacks[arguments[0]];
</span><span>    },
</span><span>
</span><span>    addEventListener() {
</span><span>        callbacks[arguments[0]] = [arguments[1]];
</span><span>    },
</span><span>
</span><span>    HTMLFormElement: function () { },
</span><span>    Event: function () { },
</span><span>    dispatchEvent,
</span><span>    screen: null,
</span><span>    Array, parseInt, Object, Function, Date, Math, undefined,
</span><span>    isFinite, unescape, Infinity, document, String, encodeURIComponent
</span><span>};
</span><span>
</span><span>for (const key in window) {
</span><span>    global[key] = window[key];
</span><span>}
</span><span>
</span><span>const getHeaders = () =&gt; {
</span><span>    const xhr = new window.XMLHttpRequest();
</span><span>    xhr.open('POST', 'https://accounts.netgear.com/mfa/auth/?redirectUrl=https://my.meural.netgear.com/');
</span><span>    xhr.send('&lt;&lt;payload&gt;&gt;'); // we will string replace &lt;&lt;payload&gt;&gt; dynamically
</span><span>    return xhr.headers;
</span><span>};
</span><span>`</span>;

<span>function</span> <span>getEncryptedPassword</span>(<span>email</span>, <span>password</span>) {
  <span>const</span> <span>encrypt</span> <span>=</span> <span>new</span> <span>JSEncrypt</span>();
  <span>const</span> <span>epochTime</span> <span>=</span> Math.<span>round</span>((<span>new</span> Date()).<span>getTime</span>() <span>/</span> <span>1000</span>);
  <span>encrypt</span>.<span>setPublicKey</span>(<span>PUBLIC_KEY</span>);
  <span>return</span> <span>encrypt</span>.<span>encrypt</span>(<span>`</span><span>${</span><span>email</span><span>}</span><span> ######-----##### </span><span>${</span><span>password</span><span>}</span><span> ######-----##### </span><span>${</span><span>epochTime</span><span>}</span><span>`</span>;);
}

<span>// Download the ngr_common.js file
</span><span></span><span>fetch</span>(<span>NGR_COMMON_URL</span>, {<span>method</span><span>:</span> <span>'GET'</span>})
    .<span>then</span>(<span>res</span> =&gt; <span>res</span>.<span>text</span>())
    .<span>then</span>(<span>script</span> =&gt; {

      <span>// Add the encrypted credentials
</span><span></span>      <span>payload</span>.<span>xtoken</span> <span>=</span> <span>getEncryptedPassword</span>(<span>process</span>.<span>env</span>.<span>MEURAL_EMAIL</span>, <span>process</span>.<span>env</span>.<span>MEURAL_PW</span>);
      <span>// Substitute the xtoken into the wrapped script
</span><span></span>      <span>const</span> <span>wrappedScript</span> <span>=</span> <span>wrapper</span> <span>+</span> <span>script</span>;
      <span>const</span> <span>finalScript</span> <span>=</span> <span>wrappedScript</span>.<span>replace</span>(<span>'&lt;&lt;payload&gt;&gt;'</span>, <span>JSON</span>.<span>stringify</span>(<span>payload</span>)) <span>+</span> <span>'; getHeaders();'</span>;
      <span>// Execute the code and retrieve the result
</span><span></span>      <span>const</span> <span>headers</span> <span>=</span> eval(<span>finalScript</span>);

      <span>// Now we can invoke the auth endpoint with the correctly signed headers
</span><span></span>      <span>fetch</span>(<span>'https://accounts.netgear.com/mfa/auth/?redirectUrl=https://my.meural.netgear.com/'</span>, {
        <span>method</span><span>:</span> <span>'POST'</span>,
        <span>body</span><span>:</span> <span>JSON</span>.<span>stringify</span>(<span>payload</span>),
        <span>headers</span><span>:</span> {
          <span>'Content-Type'</span><span>:</span> <span>'application/json'</span>,
          <span>'Origin'</span><span>:</span> <span>'https://accounts.netgear.com'</span>,
          <span>'User-Agent'</span><span>:</span> <span>'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36'</span>,
          <span>'Cookie'</span><span>:</span> <span>'validDomain=https%3A%2F%2Fmy.meural.netgear.com%2F;'</span>,
          ...<span>headers</span>
        }
      }).<span>then</span>(<span>res</span> =&gt; <span>res</span>.<span>json</span>())
        .<span>then</span>(<span>json</span> =&gt; <span>console</span>.<span>dir</span>(<span>json</span>));
    });
</code></pre></div><p><img src="https://ma.rtin.so/img/meural-success-authed.png" alt="authed"></p><p>Sweet, we finally got a token! Originally I had intended this to be a weekend post to relaunch this blog but it required a couple of hours a night for several more days.</p><p><em>Disclaimer:</em> As a general rule I strongly advise <strong>against</strong> executing arbitrary javascript from a 3rd party. In my case, I am executing this in a sandboxed environment and the worst they could do is exfiltrate my meural credentials which… they already have.</p><h2 id="putting-the-pieces-together">Putting the pieces together</h2><p>Finally, with the hard part out of the way I can turn attention back to functionality, and using <a href="https://www.twilio.com/">Twilio</a> to stream MMS to our picture frame! <em>Disclaimer:</em> I am a Twilio employee and you’re welcome to use <a href="https://ma.rtin.so/posts/reverse-engineering-netgear-auth-to-extend-my-meural/www.twilio.com/referral/7U9nNY">this link</a> to receive an extra $10 in credit after upgrading your account.</p><p>When uploading an image via the Meural portal, it makes the following request:</p><p><img src="https://ma.rtin.so/img/meural-image-upload.png" alt="meural imageupload request"></p><p>So, given I’ve already figured out how to get token, all that’s left is to convert that request to Javascript and attach it to our phone number within the Twilio Console!</p><p>After purchasing a number ($1/month), I pointed it to a Twilio Function, which is essentially an AWS Lambda wrapper and shared the number with my friends where hilarity ensued.</p><p><img src="https://ma.rtin.so/img/twilio-functions-meural.png" alt="Twilio Functions Code"></p><p><img src="https://ma.rtin.so/img/twilio-number-configuration.png" alt="Twilio Number Configuration"></p><p>I hope you learned something from this post, I had a lot of fun writing it. I’d love to hear any feedback - feel free to e-mail or tweet me :)</p><p>The final artifact:</p><div><pre><code data-lang="js"><span>const</span> <span>fs</span> <span>=</span> <span>require</span>(<span>'fs'</span>);
<span>const</span> <span>url</span> <span>=</span> <span>require</span>(<span>'url'</span>);
<span>const</span> <span>path</span> <span>=</span> <span>require</span>(<span>'path'</span>);
<span>const</span> <span>request</span> <span>=</span> <span>require</span>(<span>'request'</span>);

<span>let</span> <span>tokenCache</span>;

<span>exports</span>.<span>handler</span> <span>=</span> <span>async</span> (<span>context</span>, <span>event</span>, <span>callback</span>) =&gt; {
    <span>const</span> <span>twiml</span> <span>=</span> <span>new</span> <span>Twilio</span>.<span>twiml</span>.<span>MessagingResponse</span>();
    <span>let</span> <span>broken</span> <span>=</span> <span>''</span>;

    <span>if</span> (<span>!</span><span>event</span>.<span>NumMedia</span> <span>||</span> parseInt(<span>event</span>.<span>NumMedia</span>) <span>===</span> <span>0</span>) {
        <span>twiml</span>.<span>message</span>(<span>'Please send an image!'</span>);
        <span>return</span> <span>callback</span>(<span>null</span>, <span>twiml</span>);
    }

    <span>for</span> (<span>let</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>event</span>.<span>NumMedia</span>; <span>i</span><span>++</span>) {
        <span>const</span> <span>mediaUrl</span> <span>=</span> <span>event</span>[<span>`MediaUrl</span><span>${</span><span>i</span><span>}</span><span>`</span>];
        <span>const</span> <span>mediaMime</span> <span>=</span> <span>event</span>[<span>`MediaContentType</span><span>${</span><span>i</span><span>}</span><span>`</span>];
        <span>const</span> <span>ext</span> <span>=</span> <span>mediaMime</span>.<span>split</span>(<span>'/'</span>)[<span>1</span>];
        <span>const</span> <span>mediaSid</span> <span>=</span> <span>path</span>.<span>basename</span>(<span>url</span>.<span>parse</span>(<span>mediaUrl</span>).<span>pathname</span>);

        <span>const</span> <span>target</span> <span>=</span> <span>`/tmp/</span><span>${</span><span>mediaSid</span><span>}</span><span>.</span><span>${</span><span>ext</span><span>}</span><span>`</span>;
        <span>if</span> (<span>!</span><span>fs</span>.<span>existsSync</span>(<span>target</span>)) {
            <span>await</span> <span>downloadImage</span>(<span>mediaUrl</span>, <span>target</span>);
        }

        <span>let</span> <span>MEURAL_TOKEN</span> <span>=</span> <span>tokenCache</span>;
        <span>if</span> (<span>!</span><span>MEURAL_TOKEN</span>) {
            <span>const</span> <span>tokenResult</span> <span>=</span> <span>await</span> <span>makeRequest</span>(<span>'GET'</span>, <span>null</span>, <span>context</span>.<span>MEURAL_TOKEN_SANDBOX</span>);
            <span>MEURAL_TOKEN</span> <span>=</span> <span>tokenResult</span>.<span>token</span>;
            <span>// As long as our container is alive, we'll have this token
</span><span></span>            <span>tokenCache</span> <span>=</span> <span>MEURAL_TOKEN</span>;
        }

        <span>const</span> <span>customOptions</span> <span>=</span> {
            <span>formData</span><span>:</span> {
                <span>image</span><span>:</span> <span>fs</span>.<span>createReadStream</span>(<span>target</span>),
            }
        };

        <span>const</span> <span>result</span> <span>=</span> <span>await</span> <span>makeRequest</span>(<span>'POST'</span>, <span>MEURAL_TOKEN</span>, <span>'https://api.meural.com/v0/items'</span>, <span>customOptions</span>);
        <span>if</span> (<span>!</span><span>result</span> <span>||</span> <span>!</span><span>result</span>.<span>id</span>) {
            <span>// prepend a broken message to the SMS to my cell so I can investigate
</span><span></span>            <span>broken</span> <span>=</span> <span>'(broken!)'</span>;
        } <span>else</span> {
            <span>await</span> Promise.<span>all</span>([
                <span>makeRequest</span>(<span>'POST'</span>, <span>MEURAL_TOKEN</span>, <span>`https://api.meural.com/v0/galleries/</span><span>${</span><span>context</span>.<span>MEURAL_GALLERY_ID</span><span>}</span><span>/items/</span><span>${</span><span>result</span>.<span>id</span><span>}</span><span>`</span>),
                <span>makeRequest</span>(<span>'POST'</span>, <span>MEURAL_TOKEN</span>, <span>`https://api.meural.com/v0/devices/</span><span>${</span><span>context</span>.<span>MEURAL_DEVICE_ID</span><span>}</span><span>/items/</span><span>${</span><span>result</span>.<span>id</span><span>}</span><span>`</span>),
            ]);
        }
    }

    <span>if</span> (<span>event</span>.<span>From</span> <span>!=</span> <span>context</span>.<span>MAMPS_CELL</span>) {
        <span>const</span> <span>mms</span> <span>=</span> <span>twiml</span>.<span>message</span>({
            <span>to</span><span>:</span> <span>context</span>.<span>MAMPS_CELL</span>
        });

        <span>mms</span>.<span>body</span>(<span>`</span><span>${</span><span>broken</span><span>}</span><span> Meural got a new photo from </span><span>${</span><span>event</span>.<span>From</span><span>}</span><span>`</span>);
        <span>mms</span>.<span>media</span>(<span>event</span>[<span>'MediaUrl0'</span>]);
    }

    <span>twiml</span>.<span>message</span>(<span>'Thank you!'</span>);
    <span>callback</span>(<span>null</span>, <span>twiml</span>);
};

<span>async</span> <span>function</span> <span>makeRequest</span>(<span>method</span>, <span>token</span>, <span>url</span>, <span>customOptions</span>) {
    <span>return</span> <span>new</span> Promise((<span>resolve</span>, <span>reject</span>) =&gt; {
        <span>const</span> <span>options</span> <span>=</span> Object.<span>assign</span>({
            <span>url</span>,
            <span>method</span>,
            <span>headers</span><span>:</span> {}
        }, <span>customOptions</span>);

        <span>if</span> (<span>token</span>) {
            <span>options</span>.<span>headers</span>[<span>'Authorization'</span>] <span>=</span> <span>`Token </span><span>${</span><span>token</span><span>}</span><span>`</span>;
        }

        <span>request</span>(<span>options</span>, (<span>err</span>, <span>httpRes</span>, <span>body</span>) =&gt; {
            <span>if</span> (<span>err</span>) {
                <span>reject</span>(<span>err</span>);
            }

            <span>let</span> <span>parsed</span>;
            <span>try</span> {
                <span>parsed</span> <span>=</span> <span>JSON</span>.<span>parse</span>(<span>body</span>);
            } <span>catch</span> (<span>e</span>) {
                <span>return</span> <span>reject</span>(<span>`failed to parse json: </span><span>${</span><span>e</span>.<span>message</span><span>}</span><span>`</span>);
            }

            <span>return</span> <span>resolve</span>(<span>parsed</span>.<span>data</span>);
        });
    });
}

<span>async</span> <span>function</span> <span>downloadImage</span>(<span>source</span>, <span>target</span>) {
    <span>const</span> <span>writer</span> <span>=</span> <span>fs</span>.<span>createWriteStream</span>(<span>target</span>)
    <span>const</span> <span>response</span> <span>=</span> <span>await</span> <span>axios</span>({
        <span>url</span><span>:</span> <span>source</span>,
        <span>method</span><span>:</span> <span>'GET'</span>,
        <span>responseType</span><span>:</span> <span>'stream'</span>
    });

    <span>response</span>.<span>data</span>.<span>pipe</span>(<span>writer</span>);
    <span>return</span> <span>new</span> Promise((<span>resolve</span>, <span>reject</span>) =&gt; {
        <span>writer</span>.<span>on</span>(<span>'finish'</span>, <span>resolve</span>);
        <span>writer</span>.<span>on</span>(<span>'error'</span>, <span>reject</span>);
    });
};
</code></pre></div></div></article></div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>