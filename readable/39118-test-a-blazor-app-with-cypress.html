<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Test A Blazor App With Cypress -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Test A Blazor App With Cypress</h1><div><div id="" class="post-content"><p>On my <a href="https://github.com/RemiBou/Toss.Blazor">Toss project</a>, I chose to have some end-to-end (e2e). End-to-end test on web project are tests that automate a browsing session on a web browser. Most of the time it works by using API provided by an existing browser (like chrome). Those kind of tests have many drawbacks :</p><ul><li>Force you to add ids everywhere on your html code so you can find element on your test code</li><li>Are often flaky because some load time might vary between two test run or you can change your front-end code without thinking about the changes needed in the test</li><li>Are hard to build first because you can forget some steps, like scroll down or click here.</li></ul><p>But they are important for making sure that your app works and you don’t have a huge error when your app startup because you miss a js reference or something else.</p><p>At first I started my tests with Selenium. Mainly because it’s the most common way to do this and because there was some example on the aspnet core repo. But Selenium tests are hard to write and very flaky (just look at my <a href="https://github.com/RemiBou/Toss.Blazor/commits/master">git logs</a>) for many reasons :</p><ul><li>An element must be displayed on the screen before accepting interactions, so you must code the scrolling up/down, size screen etc …</li><li>You can only use the browser like a normal user so you can’t add code for waiting the end of an http query or check the status of a xhr.</li><li>There isn’t much debugging information provided : screenshot are hard to get and videos impossible.</li></ul><p>I heard a lot of good thing about <a href="https://www.cypress.io/">cypress</a> so I decided to give it a shot after an unsuccessful battle against Selenium.</p><h2 id="start-the-application-and-dependencies">Start the application and dependencies</h2><p>Because my previous E2E test used Selenium it was a .NET Core project. This was usefull for launching  RavenEB.Embedded. Cypress running on the browser runtime, I won’t have this project anymore. I needed an other way for starting my ravendb server : so I picked docker-compose, which I could use for starting my whole system : my app and the dependencies. 
I really like docker and using docker-compose for running E2E tests seems like a good idea. For running my app in a docker-compose I need to build a docker image for it, here it is :</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> mcr.microsoft.com/dotnet/core/runtime:2.2.7-alpine as runtime227</span><span class="k">FROM</span><span class="s"> mcr.microsoft.com/dotnet/core/sdk:3.0.100-alpine AS build</span><span class="c"># import sdk from 2.2.7 because we need it for running ravendb embedded</span><span class="k">COPY</span><span class="s"> --from=runtime227 /usr/share/dotnet /usr/share/dotnet </span><span class="k">WORKDIR</span><span class="s"> /src</span><span class="k">COPY</span><span class="s"> ./Toss.Client/Toss.Client.csproj ./Toss.Client/</span><span class="k">COPY</span><span class="s"> ./Toss.Server/Toss.Server.csproj ./Toss.Server/</span><span class="k">COPY</span><span class="s"> ./Toss.Shared/Toss.Shared.csproj ./Toss.Shared/</span><span class="k">COPY</span><span class="s"> ./Toss.Tests/Toss.Tests.csproj ./Toss.Tests/</span><span class="k">COPY</span><span class="s"> ./Toss.sln ./</span><span class="k">RUN </span>dotnet restore ./Toss.sln
<span class="k">COPY</span><span class="s"> ./Toss.Client ./Toss.Client</span><span class="k">COPY</span><span class="s"> ./Toss.Server ./Toss.Server</span><span class="k">COPY</span><span class="s"> ./Toss.Shared ./Toss.Shared</span><span class="k">COPY</span><span class="s"> ./Toss.Tests ./Toss.Tests</span><span class="k">RUN </span>dotnet <span class="nb">test</span> ./Toss.Tests
<span class="k">RUN </span>dotnet publish Toss.Server/Toss.Server.csproj <span class="nt">-c</span> Release <span class="nt">-o</span> /app

<span class="k">FROM</span><span class="s"> mcr.microsoft.com/dotnet/core/aspnet:3.0</span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="k">COPY</span><span class="s"> --from=build /app .</span><span class="k">EXPOSE</span><span class="s"> 80</span><span class="k">ENTRYPOINT</span><span class="s"> ["dotnet", "Toss.Server.dll"]</span></code></pre></div></div><ul><li>We can see a really nice feature of Docker : I was able to import the 2.2.7 runtime into a 3.0 sdk docker image . I needed this because my integration tests runs RavenDB.Embedded which is not compatible with runtime 3.</li><li>With multi stage build I can use the sdk for building my app then only the runtime for executing it which will make my final docker image smaller</li><li>I first copy the csproj and sln files for optimizing layer caching : if I don’t change anything to my csproj files, then the “RUN dotnet restore ./Toss.sln” line will use the cached version of this layer, making my build faster (even though Azure DevOps doesn’t provide docker layer caching yet).</li><li>“RUN dotnet test ./Toss.Tests” runs my integration tests, not the E2E.</li></ul><p>Then I need to create a docker-compose file describing my app and its dependencies :</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span><span class="s1">'</span><span class="s">3.5'</span><span class="na">services</span><span class="pi">:</span><span class="na">web</span><span class="pi">:</span><span class="na">build</span><span class="pi">:</span><span class="na">context</span><span class="pi">:</span><span class="s">.</span><span class="na">restart</span><span class="pi">:</span><span class="s">always</span><span class="na">environment</span><span class="pi">:</span><span class="pi">-</span><span class="s">GoogleClientId=AAA</span><span class="pi">-</span><span class="s">GoogleClientSecret=AAA</span><span class="pi">-</span><span class="s">MailJetApiKey=</span><span class="pi">-</span><span class="s">MailJetApiSecret=</span><span class="pi">-</span><span class="s">MailJetSender=</span><span class="pi">-</span><span class="s">RavenDBEndpoint=http://ravendb:8080</span><span class="pi">-</span><span class="s">RavenDBDataBase=Tests</span><span class="pi">-</span><span class="s">StripeSecretKey=</span><span class="pi">-</span><span class="s">test=true</span><span class="na">depends_on</span><span class="pi">:</span><span class="pi">-</span><span class="s">ravendb</span><span class="na">ports</span><span class="pi">:</span><span class="pi">-</span><span class="s">80:80</span><span class="na">ravendb</span><span class="pi">:</span><span class="na">image</span><span class="pi">:</span><span class="s">ravendb/ravendb</span></code></pre></div></div><ul><li>I expose the port 80 so I can access the app in my dev computer</li><li>“test=true” tells my app to use fake dependencies for things like external services (mailjet, stripe) or non deterministic data (random, datetime.now)</li><li>The good thing with docker-compose is that the services run on their own network and are accessible inside this network accessible via their name, so I can run ravendb inside this network and it won’t have an impact on the other ravendb I might be running on my dev computer.</li></ul><p>Now I can run my app with the following command :</p><p>Maybe I’ll use it as a starting point for hosting my app in production but it is not the point right now.</p><h2 id="cypress-test">Cypress Test</h2><p>First I create the folder “Toss.Tests.E2E.Cypress” in my solution then cd on it. You need npm installed on your computer. Then type on your terminal :</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm init
npm <span class="nb">install </span>cypress
</code></pre></div></div><p>Once installed I got a cypress folder containing multiple folder, I cleaned up all the samples in the folder called “integration”. My new test will be a js file inside this integration folder :</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// &lt;reference types="Cypress" /&gt;</span><span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Toss Full Test</span><span class="dl">'</span><span class="p">,</span><span class="kd">function</span><span class="p">()</span><span class="p">{</span><span class="kd">let</span><span class="nx">polyfill</span><span class="p">;</span><span class="kd">const</span><span class="nx">uuid</span><span class="o">=</span><span class="nx">Cypress</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="nx">e6</span><span class="p">)</span><span class="nx">before</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span><span class="kd">const</span><span class="nx">polyfillUrl</span><span class="o">=</span><span class="dl">'</span><span class="s1">https://unpkg.com/whatwg-fetch@3.0.0/dist/fetch.umd.js</span><span class="dl">'</span><span class="p">;</span><span class="nx">cy</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">polyfillUrl</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="o">=&gt;</span><span class="p">{</span><span class="nx">polyfill</span><span class="o">=</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="p">});</span><span class="p">});</span><span class="nx">Cypress</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">window:before:load</span><span class="dl">'</span><span class="p">,</span><span class="nx">win</span><span class="o">=&gt;</span><span class="p">{</span><span class="k">delete</span><span class="nx">win</span><span class="p">.</span><span class="nx">fetch</span><span class="p">;</span><span class="nx">win</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="nx">polyfill</span><span class="p">);</span><span class="p">});</span><span class="kd">const</span><span class="nx">SubscribeEmail</span><span class="o">=</span><span class="dl">"</span><span class="s2">tosstests</span><span class="dl">"</span><span class="o">+</span><span class="nx">uuid</span><span class="o">+</span><span class="dl">"</span><span class="s2">@yopmail.com</span><span class="dl">"</span><span class="p">;</span><span class="kd">const</span><span class="nx">SubscribePassword</span><span class="o">=</span><span class="dl">"</span><span class="s2">tossTests123456!!</span><span class="dl">"</span><span class="p">;</span><span class="kd">const</span><span class="nx">SubscribeLogin</span><span class="o">=</span><span class="dl">"</span><span class="s2">tosstests</span><span class="dl">"</span><span class="o">+</span><span class="nx">uuid</span><span class="p">;</span><span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Full process</span><span class="dl">'</span><span class="p">,</span><span class="kd">function</span><span class="p">()</span><span class="p">{</span><span class="nx">cy</span><span class="p">.</span><span class="nx">server</span><span class="p">();</span><span class="c1">//used for listenning to register api call and getting the recirction url from the http headers</span><span class="nx">cy</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">/api/account/register</span><span class="dl">'</span><span class="p">).</span><span class="k">as</span><span class="p">(</span><span class="dl">'</span><span class="s1">register</span><span class="dl">'</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">/api/account/login</span><span class="dl">'</span><span class="p">).</span><span class="k">as</span><span class="p">(</span><span class="dl">'</span><span class="s1">login</span><span class="dl">'</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">/api/toss/create</span><span class="dl">'</span><span class="p">).</span><span class="k">as</span><span class="p">(</span><span class="dl">'</span><span class="s1">create</span><span class="dl">'</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">);</span><span class="nx">disableCaptcha</span><span class="p">();</span><span class="c1">//this could be long as ravendb is starting</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#LinkLogin</span><span class="dl">"</span><span class="p">,</span><span class="p">{</span><span class="na">timeout</span><span class="p">:</span><span class="mi">20000</span><span class="p">}).</span><span class="nx">click</span><span class="p">();</span><span class="c1">//register</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#LinkRegister</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#NewEmail</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="nx">SubscribeEmail</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#NewName</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="nx">SubscribeLogin</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#NewPassword</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="nx">SubscribePassword</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#NewConfirmPassword</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="nx">SubscribePassword</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#BtnRegister</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="nx">wait</span><span class="p">(</span><span class="dl">'</span><span class="s1">@register</span><span class="dl">'</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">@register</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span><span class="p">{</span><span class="nx">expect</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span><span class="nx">expect</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">x-test-confirmationlink</span><span class="dl">'</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">empty</span><span class="p">;</span><span class="nx">cy</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Redirect URL : </span><span class="dl">"</span><span class="o">+</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">x-test-confirmationlink</span><span class="dl">'</span><span class="p">]);</span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">x-test-confirmationlink</span><span class="dl">'</span><span class="p">]);</span><span class="nx">disableCaptcha</span><span class="p">();</span><span class="c1">//login</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#UserName</span><span class="dl">"</span><span class="p">,</span><span class="p">{</span><span class="na">timeout</span><span class="p">:</span><span class="mi">20000</span><span class="p">}).</span><span class="nx">type</span><span class="p">(</span><span class="nx">SubscribeEmail</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#Password</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="nx">SubscribePassword</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#BtnLogin</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="nx">wait</span><span class="p">(</span><span class="dl">'</span><span class="s1">@login</span><span class="dl">'</span><span class="p">);</span><span class="c1">//publish toss</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#LinkNewToss</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="kd">var</span><span class="nx">newTossContent</span><span class="o">=</span><span class="dl">"</span><span class="s2">lorem ipsum lorem ipsumlorem ipsum lorem ipsumlorem ipsum lorem ipsumlorem ipsum lorem ipsum #test</span><span class="dl">"</span><span class="p">;</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#TxtNewToss</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="nx">newTossContent</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#BtnNewToss</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="nx">wait</span><span class="p">(</span><span class="dl">'</span><span class="s1">@create</span><span class="dl">'</span><span class="p">);</span><span class="c1">//publish toss x2</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#LinkNewToss</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="kd">var</span><span class="nx">newTossContent2</span><span class="o">=</span><span class="dl">"</span><span class="s2"> lorem ipsum lorem ipsumlorem ipsum lorem ipsumlorem ipsum  lorem ipsumlorem ipsum lorem ipsum #toto</span><span class="dl">"</span><span class="p">;</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#TxtNewToss</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="nx">newTossContent2</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#BtnNewToss</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="nx">wait</span><span class="p">(</span><span class="dl">'</span><span class="s1">@create</span><span class="dl">'</span><span class="p">);</span><span class="c1">//add new hashtag</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#TxtAddHashTag</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#TxtAddHashTag</span><span class="dl">"</span><span class="p">).</span><span class="nx">type</span><span class="p">(</span><span class="dl">"</span><span class="s2">{enter}</span><span class="dl">"</span><span class="p">);</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#BtnAddHashTag</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">.toss-preview</span><span class="dl">"</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">.toss-detail .toss-content</span><span class="dl">"</span><span class="p">).</span><span class="nx">should</span><span class="p">(</span><span class="dl">"</span><span class="s2">contain</span><span class="dl">"</span><span class="p">,</span><span class="nx">newTossContent</span><span class="p">);</span><span class="c1">// logout</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#LinkAccount</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">#BtnLogout</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span><span class="nx">cy</span><span class="p">.</span><span class="nx">url</span><span class="p">().</span><span class="nx">should</span><span class="p">(</span><span class="dl">"</span><span class="s2">eq</span><span class="dl">"</span><span class="p">,</span><span class="nx">Cypress</span><span class="p">.</span><span class="nx">config</span><span class="p">().</span><span class="nx">baseUrl</span><span class="o">+</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">);</span><span class="p">});</span><span class="p">})</span><span class="p">})</span><span class="kd">function</span><span class="nx">disableCaptcha</span><span class="p">()</span><span class="p">{</span><span class="nx">cy</span><span class="p">.</span><span class="nb">window</span><span class="p">()</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">win</span><span class="o">=&gt;</span><span class="p">{</span><span class="nx">win</span><span class="p">.</span><span class="nx">runCaptcha</span><span class="o">=</span><span class="k">new</span><span class="nx">win</span><span class="p">.</span><span class="nb">Function</span><span class="p">([</span><span class="dl">'</span><span class="s1">action</span><span class="dl">'</span><span class="p">],</span><span class="dl">'</span><span class="s1">return Promise.resolve(action)</span><span class="dl">'</span><span class="p">);</span><span class="p">});</span><span class="p">}</span></code></pre></div></div><ul><li>Cypress uses mocha for running the tests, so your test fixture must be a call to “describe()” function and inside each test there is multiple calls to a “it” function. As in every test runner, there are hooks for running things before/after each/every tests.</li><li>Cypress is able to read every XHR request done by your site, but Blazor uses fetch for http call. We need to remove the current implementation of fetch and replace it by a polyfill that uses xhr.</li><li>We can see with the route() and wait() call how you can wait until an http request is done and how we can read its content : here I needed a way to get the confirmation link after a subscribtion, so server side I send this link in the http response header (only in test mode) and I read it on client side and then visit() the link.</li><li>For E2E I prefer to write one big test that does a lot of thing, it’s just a mater of taste. I don’t practice TDD with E2E test it would be too hard, I prefer to create it when the development is done just for making sure it will keep working after my future updates.</li><li>The method disableCaptcha is used for disabling recaptcha. Be careful here, I create the method with a “new win.Function” for a specific reason. When you do interop C# -&gt; js, Microsoft.JSINterop (used by Blazor) <a href="https://github.com/aspnet/Extensions/blob/master/src/JSInterop/Microsoft.JSInterop.JS/src/src/Microsoft.JSInterop.ts">check that the argument send is a function</a> with this code</li></ul><div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="k">instanceof</span><span class="nb">Function</span><span class="p">)</span><span class="p">{</span><span class="nx">result</span><span class="o">=</span><span class="nx">result</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">lastSegmentValue</span><span class="p">);</span><span class="nx">cachedJSFunctions</span><span class="p">[</span><span class="nx">identifier</span><span class="p">]</span><span class="o">=</span><span class="nx">result</span><span class="p">;</span><span class="k">return</span><span class="nx">result</span><span class="p">;</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="k">throw</span><span class="k">new</span><span class="nb">Error</span><span class="p">(</span><span class="s2">`The value '</span><span class="p">${</span><span class="nx">resultIdentifier</span><span class="p">}</span><span class="s2">' is not a function.`</span><span class="p">);</span><span class="p">}</span></code></pre></div></div><p>Here is the catch : on my test if I write “win.runCaptcha = function(action){return Promise.resolve(action);}” it would throw an error “The value ‘window.runCaptcha’ is not a function.” because class definition (like Function) are namespaced by window so my method would be a function in the namespace of the cypress window, not on the namespace of the tested app window (it took me no less than 2 days to figure it out).</p><p>Now for testing this I cd on the test directory and enter</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./node_modules/.bin/cypress open
</code></pre></div></div><p>Which opens a web UI where I can run my test and see them while they are executing. This GUI is really nice because you can go in the past and see the state of the UI or even browse the DOM. Now that my test passes I want to integrate cypress into my docker-compose so I can run it without installing cypress, which will help when I’ll run it in my CI environment.</p><h2 id="integrate-cypress-into-the-docker-compose">Integrate Cypress into the docker-compose</h2><p>I added the following service to my docker-compose.yml</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">cypress</span><span class="pi">:</span><span class="na">image</span><span class="pi">:</span><span class="s">cypress/included:3.4.1</span><span class="na">depends_on</span><span class="pi">:</span><span class="pi">-</span><span class="s">web</span><span class="na">environment</span><span class="pi">:</span><span class="pi">-</span><span class="s">CYPRESS_baseUrl=http://web</span><span class="na">working_dir</span><span class="pi">:</span><span class="s">/e2e</span><span class="na">volumes</span><span class="pi">:</span><span class="pi">-</span><span class="s">./Toss.Tests.E2E.Cypress/:/e2e</span></code></pre></div></div><ul><li>I mount the cypress tests as a volume, so I can also get the cypress test execution artifacts back (screenshot and video)</li><li>The “depends_on” is really usefull for starting things in order (ravendb -&gt; web -&gt; cypress)</li><li>By default cypress tries to test http://localhost, here I change it for the service url with the env variable CYPRESS_baseUrl</li></ul><p>Then for running the test I run the following command from the root fo my project</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">--renew-anon-volumes</span><span class="nt">--exit-code-from</span> cypress <span class="nt">--build</span></code></pre></div></div><ul><li>”–renew-anon-volumes” is used for cleaning ravendb volumes before each run, so I start with an empty DB.</li><li>”–exit-code-from cypress” is used for telling docker-compose to kill all the other services when the service “cypress” is done and it’ll use the cypress return code as its own.</li><li>”–build” will build our service with build specification (only “web”)</li></ul><h2 id="integration-on-azure-devops">Integration on Azure DevOps</h2><p>Now that I got a fully running integration I can replace the existing one for this. Because it uses docker-compose it’ll be easier to maintain (I can test it on my dev machine and on multiple OS) and will also help for running other servcies. Here is my new “azure-pipelines.yml” file</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pool</span><span class="pi">:</span><span class="na">name</span><span class="pi">:</span><span class="s">Azure Pipelines</span><span class="na">vmImage</span><span class="pi">:</span><span class="s">ubuntu-16.04</span><span class="na">steps</span><span class="pi">:</span><span class="pi">-</span><span class="na">task</span><span class="pi">:</span><span class="s">DockerCompose@0</span><span class="na">displayName</span><span class="pi">:</span><span class="s1">'</span><span class="s">Run</span><span class="nv"></span><span class="s">a</span><span class="nv"></span><span class="s">docker-compose</span><span class="nv"></span><span class="s">command'</span><span class="na">inputs</span><span class="pi">:</span><span class="na">containerregistrytype</span><span class="pi">:</span><span class="s1">'</span><span class="s">Container</span><span class="nv"></span><span class="s">Registry'</span><span class="na">dockerRegistryEndpoint</span><span class="pi">:</span><span class="s1">'</span><span class="s">dockerhub</span><span class="nv"></span><span class="s">remibou'</span><span class="na">dockerComposeFile</span><span class="pi">:</span><span class="s1">'</span><span class="s">docker-compose.yml'</span><span class="na">dockerComposeCommand</span><span class="pi">:</span><span class="s1">'</span><span class="s">up</span><span class="nv"></span><span class="s">--renew-anon-volumes</span><span class="nv"></span><span class="s">--exit-code-from</span><span class="nv"></span><span class="s">cypress</span><span class="nv"></span><span class="s">--build'</span><span class="pi">-</span><span class="na">task</span><span class="pi">:</span><span class="s">PublishPipelineArtifact@1</span><span class="na">displayName</span><span class="pi">:</span><span class="s1">'</span><span class="s">Publish</span><span class="nv"></span><span class="s">Pipeline</span><span class="nv"></span><span class="s">Artifact'</span><span class="na">inputs</span><span class="pi">:</span><span class="na">targetPath</span><span class="pi">:</span><span class="s">Toss.Tests.E2E.Cypress/cypress/videos/</span><span class="na">artifact</span><span class="pi">:</span><span class="s1">'</span><span class="s">Cypress</span><span class="nv"></span><span class="s">videos'</span><span class="na">condition</span><span class="pi">:</span><span class="s">succeededOrFailed()</span></code></pre></div></div><ul><li>I use an ubuntu image because it’s lighter than windows and I don’t think I’ll run my app on windows server so it’s better to do my build and test on a linux OS.</li><li>You need to create a docker endpoint on Azure DevOps so it can login into docker hub for pulling public images</li><li>I publish the cypress video as artifact so I won’t have any problem for debugging it when it fails</li></ul><h2 id="conclusion">Conclusion</h2><p>I hope this new test suite will make my E2E tests less flaky and more enjoyable to maintain and improve.</p><p>I can also say that Cypress is waaaay better than Selenium in every possible way :</p><ul><li>installation : a single docker service or an npm package</li><li>development : no need to add wait everywhere and you can watch XHR requests</li><li>execution : a web UI or a single command line</li><li>debug. : on the web UI you can browse all the test execution and you have a video of the whole thing.</li></ul></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>