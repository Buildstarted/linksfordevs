<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Life, part 25 - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Life, part 25 - linksfor.dev(s)"/>
    <meta property="og:description" content="Let&#x2019;s crisp up the problem from last episode. The problem for today&#x2019;s episode is to write a method that takes these nine 2-quads: Computes these sixteen 1-quads: And returns these four &#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://ericlippert.com/2020/07/20/life-part-25/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Life, part 25</title>
<div class="readable">
        <h1>Life, part 25</h1>
            <div>Reading time: 10-12 minutes</div>
        <div>Posted here: 20 Jul 2020</div>
        <p><a href="https://ericlippert.com/2020/07/20/life-part-25/">https://ericlippert.com/2020/07/20/life-part-25/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
		<p>Let’s crisp up the problem from last episode. The problem for today’s episode is to write a method that takes these nine 2-quads:</p>
<p><a href="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg"><img data-attachment-id="7537" data-permalink="https://ericlippert.com/2020/07/16/life-part-24/tjin4k0krdw2/" data-orig-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg" data-orig-size="385,385" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="tjin4k0krdw2" data-image-description="" data-medium-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg?w=300" data-large-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg?w=385" src="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg?w=584" alt="" srcset="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg 385w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg?w=150 150w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw2.jpg?w=300 300w" sizes="(max-width: 385px) 100vw, 385px"></a>Computes these sixteen 1-quads:</p>
<p><a href="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg"><img data-attachment-id="7553" data-permalink="https://ericlippert.com/2020/07/16/life-part-24/l0mbkp22rvp6/" data-orig-file="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg" data-orig-size="385,385" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="l0mbkp22rvp6" data-image-description="" data-medium-file="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg?w=300" data-large-file="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg?w=385" src="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg?w=584" alt="" srcset="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg 385w, https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg?w=150 150w, https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp6.jpg?w=300 300w" sizes="(max-width: 385px) 100vw, 385px"></a></p>
<p>And returns these four 2-quads:</p>
<p><a href="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg"><img data-attachment-id="7562" data-permalink="https://ericlippert.com/2020/07/20/life-part-25/l0mbkp22rvp7/" data-orig-file="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg" data-orig-size="385,385" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="l0mbkp22rvp7" data-image-description="" data-medium-file="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg?w=300" data-large-file="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg?w=385" src="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg?w=584" alt="" srcset="https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg 385w, https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg?w=150 150w, https://ericlippert.files.wordpress.com/2020/07/l0mbkp22rvp7.jpg?w=300 300w" sizes="(max-width: 385px) 100vw, 385px"></a></p>
<p>Those four 2-quads form a 3-quad; I haven’t written a 3-quad data structure yet, but I’m sure you can imagine how it goes. We’ll write it out later; it’s just a struct containing four 2-quads. I like to start by writing the signature of the method:</p>
<pre>static Quad3 Step9Quad2ToQuad3(
  Quad2 nw, Quad2 n, Quad2 ne,
  Quad2 w, Quad2 c, Quad2 e,
  Quad2 sw, Quad2 s, Quad2 se)
{</pre>
<p>The first step is to get those twelve additional 2-quads. The first four we need are these:</p>
<p><a href="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg"><img data-attachment-id="7543" data-permalink="https://ericlippert.com/2020/07/16/life-part-24/tjin4k0krdw3-3/" data-orig-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg" data-orig-size="385,385" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="tjin4k0krdw3" data-image-description="" data-medium-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg?w=300" data-large-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg?w=385" src="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg?w=584" alt="" srcset="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg 385w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg?w=150 150w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw3-2.jpg?w=300 300w" sizes="(max-width: 385px) 100vw, 385px"></a></p>
<p>Start at the beginning: how are we going to get the western 2-quad on the northern edge? Plainly it is made up of parts of the 2-quads I’ve labeled NW and N. A couple episodes ago I added an “or” operator to 2-quads and masks that get the eastern and western edges, so how about this?</p>
<pre>Quad2 n_w = nw.EastEdge | n.WestEdge;</pre>
<p>Do you see why that’s not quite right?&nbsp; That is this 2-quad:</p>
<p><a href="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw6.jpg"><img data-attachment-id="7567" data-permalink="https://ericlippert.com/2020/07/20/life-part-25/tjin4k0krdw6/" data-orig-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw6.jpg" data-orig-size="128,129" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="tjin4k0krdw6" data-image-description="" data-medium-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw6.jpg?w=128" data-large-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw6.jpg?w=128" src="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw6.jpg?w=584" alt=""></a></p>
<p>We’ve pasted the east edge of nw and the west edge of n together, but we also need to swap eastness with westness. The result we’ve got is <em>mirror-imaged-at-the-level-of-1-quads</em> the 2-quad that we want. Make sure that this step is clear in your head because cprrectly understanding how this is “mirrored” is important in this algorithm.</p>
<p>We’re going to be doing these operations a lot in this episode, so in keeping with my general attitude of “there’s nothing too small to go in a method”, I’m going to make two helper methods on Quad2 right now; one creates a problem and one fixes it:</p>
<pre>public Quad2 HorizontalMiddleMirrored(Quad2 right) =&gt;
  EastEdge | right.WestEdge;
public Quad2 Mirror =&gt;
  new Quad2((ushort)((cells &lt;&lt; 8) | (cells &gt;&gt; 8)));</pre>
<p>Now we can write correct code for extracting the <code>n_w</code> 2-quad:</p>
<pre>Quad2 n_w = nw.HorizontalMiddleMirrored(n).Mirror;</pre>
<p>Why not combine these into one helper function <code>HorizontalMiddle</code>? Normally I would, but… we will come back to this point in a bit.</p>
<p>So far we’ve done two ands, two ors and two shifts. We can do three times that work to similarly get:</p>
<pre>Quad2 n_e = n.HorizontalMiddleMirrored(ne).Mirror;
Quad2 c_w = w.HorizontalMiddleMirrored(c).Mirror;
Quad2 c_e = c.HorizontalMiddleMirrored(e).Mirror;
</pre>
<p>We now have eight of the sixteen 2-quads that we need. I’m sure you see how we can get these four:</p>
<p><a href="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg"><img data-attachment-id="7575" data-permalink="https://ericlippert.com/2020/07/16/life-part-24/tjin4k0krdw7/" data-orig-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg" data-orig-size="385,385" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="tjin4k0krdw7" data-image-description="" data-medium-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg?w=300" data-large-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg?w=385" src="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg?w=584" alt="" srcset="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg 385w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg?w=150 150w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw7.jpg?w=300 300w" sizes="(max-width: 385px) 100vw, 385px"></a>We need to do the same thing again but this time for the vertical direction. And this time the 2-quads are going to come out flipped north-for-south instead of mirrored east-for-west. Two more helper methods!</p>
<pre>public Quad2 VerticalMiddleFlipped(Quad2 bottom) =&gt;
  SouthEdge | bottom.NorthEdge;
public Quad2 Flip =&gt; 
  new Quad2((ushort)(((cells &amp; SouthEdgeMask) &lt;&lt; 4) | 
    ((cells &amp; NorthEdgeMask) &gt;&gt; 4)));
</pre>
<p>and now we can compute those four:</p>
<pre>Quad2 w_n = nw.VerticalMiddleFlipped(w).Flip;
Quad2 w_s = w.VerticalMiddleFlipped(sw).Flip;
Quad2 c_n = n.VerticalMiddleFlipped(center).Flip;
Quad2 c_s = center.VerticalMiddleFlipped(s).Flip;</pre>
<p>We’re 75% of the way to getting our sixteen needed 2-quads. How are we going to get these?</p>
<p><a href="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg"><img data-attachment-id="7550" data-permalink="https://ericlippert.com/2020/07/16/life-part-24/tjin4k0krdw5/" data-orig-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg" data-orig-size="385,385" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="tjin4k0krdw5" data-image-description="" data-medium-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg?w=300" data-large-file="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg?w=385" src="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg?w=584" alt="" srcset="https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg 385w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg?w=150 150w, https://ericlippert.files.wordpress.com/2020/07/tjin4k0krdw5.jpg?w=300 300w" sizes="(max-width: 385px) 100vw, 385px"></a></p>
<p>Three of them are pretty easy; they can be constructed from what we already have in hand.</p>
<pre>Quad2 c_nw = w_n.HorizontalMiddleMirrored(c_n).Mirror;
Quad2 c_sw = w_s_flip.HorizontalMiddleMirrored(c_s).Mirror;
Quad2 c_ne = n_e.VerticalMiddleFlipped(c_e).Flip;</pre>
<p>That last one is a little tricky but we can get it:</p>
<pre>Quad2 s_e = s.HorizontalMiddleMirrored(se).Mirror;
Quad2 c_se = c_e.VerticalMiddleFlipped(s_e).Flip;</pre>
<p>So far we’ve done 26 each of and, or, shift, to get the 16 2-quads we need.</p>
<p>We supposed that we had a fast lookup table that took a 2-quad and returned a 1-quad; let’s actually build that. The 2-quad key is a ushort and the returned 1-quad is an integer where the low four bits are the bits of the 1-quad:</p>
<pre>static int[] lookup = new int[65536];
... initialized as ...
for (int i = 0; i &lt;= 0xffff; i += 1)
  lookup[i] = StepQuad2(new Quad2((ushort)i));
</pre>
<p>We can therefore solve our problem with this mess:</p>
<pre>Quad2 newNW = new Quad2((ushort)(
  (lookup[(ushort)nw] &lt;&lt; 12) | // NW is bits 12-15
  (lookup[(ushort)w_n] &lt;&lt; 8) | // SW is 8-11
  (lookup[(ushort)n_w] &lt;&lt; 4) | // NE is 4-7
  (lookup[(ushort)c_nw])));    // SE is 0-3
Quad2 newNE = new Quad2((ushort)(
  (lookup[(ushort)n] &lt;&lt; 12) |
  (lookup[(ushort)c_n] &lt;&lt; 8) |
  (lookup[(ushort)n_e] &lt;&lt; 4) |
  (lookup[(ushort)c_ne])));
Quad2 newSW = new Quad2((ushort)(
  (lookup[(ushort)w] &lt;&lt; 12) |
  (lookup[(ushort)w_s] &lt;&lt; 8) |
  (lookup[(ushort)c_w] &lt;&lt; 4) |
  (lookup[(ushort)c_sw])));
Quad2 newSE = new Quad2((ushort)(
  (lookup[(ushort)c] &lt;&lt; 12) |
  (lookup[(ushort)c_s] &lt;&lt; 8) |
  (lookup[(ushort)c_e] &lt;&lt; 4) |
  (lookup[(ushort)c_se])));
return new Quad3(newNW, newNE, newSW, newSE);</pre>
<p>What I like about this: it would work.</p>
<p>What I dislike about this: we’re back in the mechanism domain. We are treating 1-quads as ints and constantly going back and forth between ushorts and Quad2s. The implementation detail of how a Quad2 is laid out in memory is once again front and center in this algorithm. Also, it feels like we are doing more work than we need to throughout this algorithm.</p>
<p>And we are wasting a bunch of space in the lookup table. We have 65536 32-bit integers but we are only using 4 of those bits. That seems like a small problem; memory is cheap after all but… wait a minute… <strong>what if we could fix several of these problems at once?</strong></p>
<p>The first step in fixing this mess is: we’re going to make the lookup table an array of Quad2s, where <strong>each Quad2 contains four copies of the 1-quad</strong>:</p>
<pre>static Quad2[] lookup = new Quad2[65536];
... initialized as ...
for (int i = 0; i &lt;= 0xffff; i += 1)
{
  int n = StepQuad2(new Quad2((ushort)i));
  lookup[i] = new Quad2((ushort)(
    (n &lt;&lt; 12) | (n &lt;&lt; 8) | (n &lt;&lt; 4) | n));
}
...
static Quad2 Lookup(Quad2 q) =&gt; lookup[(ushort)q];
</pre>
<p>I mean, why not? We have plenty of bits to spare, so use them.</p>
<p>Now the call site looks like this:</p>
<pre>Quad2 newNW =  Lookup(nw).NW | Lookup(w_n).SW | Lookup(n_w).NE | Lookup(c_nw).SE;
Quad2 newNE =  Lookup(n).NW  | Lookup(c_n).SW | Lookup(n_e).NE | Lookup(c_ne).SE;
Quad2 newSW =  Lookup(w).NW  | Lookup(w_s).SW | Lookup(c_w).NE | Lookup(c_sw).SE;
Quad2 newSE =  Lookup(c).NW  | Lookup(c_s).SW | Lookup(c_e).NE | Lookup[c_se].SE;
return new Quad3(newNW, newNE, newSW, newSW);</pre>
<p>Look at that improvement in the readability of the code! We plainly see that we are constructing new Quad2s out of the parts of old ones. We’re keeping all the typing consistent. This is great.</p>
<p>Could it be even better?</p>
<p>Take a look at those sixteen computations of a quad1 on the next tick. You notice something?</p>
<ul>
<li>All the ones that are going in the NW of a new 2-quad are lookups on an argument that was passed in to this method: nw, n, w and c.</li>
<li>All the ones that are going to the SW were computed by “flipping” something: w_n, c_n, w_s and c_s.</li>
<li>All the ones that are going to the NE were computed by “mirroring” something: n_w, n_e, c_w and c_e</li>
<li>All the ones going to the SE were both flipped and mirrored: c_nw, c_ne, c_sw, c_se.</li>
</ul>
<p>What does this mean?</p>
<p><strong>It means we can move the flipping and mirroring operations back in time into the lookup table as well. Read this next bit carefully because it is tricky. </strong>We’re going to initialize the lookup table like this:</p>
<pre>for (int i = 0; i &lt;= 0xffff; i += 1)
{
  Quad2 normal = new Quad2((ushort)i);
  Quad2 mirror = normal.Mirror;
  Quad2 flip = normal.Flip;
  Quad2 both = mirror.Flip;
  int result = StepQuad2(normal);
  lookup[(ushort)both] |= new Quad2((ushort)result);           // SE
  lookup[(ushort)mirror] |= new Quad2((ushort)(result &lt;&lt; 4));  // NE
  lookup[(ushort)flip] |= new Quad2((ushort)(result &lt;&lt; 8));    // SW
  lookup[(ushort)normal] |= new Quad2((ushort)(result &lt;&lt; 12)); // NW
}
</pre>
<p>And now we can remove all the flips and mirrors when computing the new Quad2s! Put it all together:</p>
<pre>static Quad3 Step9Quad2ToQuad3(
  Quad2 nw, Quad2 n, Quad2 ne,
  Quad2 w, Quad2 c, Quad2 e,
  Quad2 sw, Quad2 s, Quad2 se)
{
  // These are mirrored
  Quad2 n_w = nw.HorizontalMiddleMirrored(n);
  Quad2 n_e = n.HorizontalMiddleMirrored(ne);
  Quad2 c_w = w.HorizontalMiddleMirrored(c);
  Quad2 c_e = c.HorizontalMiddleMirrored(e);
  // These are flipped
  Quad2 w_n = nw.VerticalMiddleFlipped(w);
  Quad2 c_n = n.VerticalMiddleFlipped(c);
  Quad2 w_s = w.VerticalMiddleFlipped(sw);
  Quad2 c_s = c.VerticalMiddleFlipped(s);
  // These are mirrored and flipped
  Quad2 c_nw = w_n.HorizontalMiddleMirrored(c_n);
  Quad2 c_ne = n_e.VerticalMiddleFlipped(c_e);
  Quad2 c_sw = w_s.HorizontalMiddleMirrored(c_s);
  Quad2 c_se = c_e.SouthEdge | c_s.NE | se.NW;
  Quad2 newNW =  Lookup(nw).NW | Lookup(w_n).SW | Lookup(n_w).NE | Lookup(c_nw).SE;
  Quad2 newNE =  Lookup(n).NW  | Lookup(c_n).SW | Lookup(n_e).NE | Lookup(c_ne).SE;
  Quad2 newSW =  Lookup(w).NW  | Lookup(w_s).SW | Lookup(c_w).NE | Lookup(c_sw).SE;
  Quad2 newSE =  Lookup(c).NW  | Lookup(c_s).SW | Lookup(c_e).NE | Lookup[c_se].SE;
  return new Quad3(newNW, newNE, newSW, newSW);
}
</pre>
<p>Computing c_se actually gets easier, which is a nice bonus.</p>
<p>What’s our final tally? To move ahead an 8×8 portion of a 12×12 grid we do 41 ands, 25 ors and 16 array lookups. And zero shifts. All the other bit operations have been moved backwards in time to run during the computation of the lookup table.</p>
<p>Could we do even less work?</p>
<p>Yes; we could eliminate 16 of those ands if we had four lookup tables each with four bits in the right place and zeros everywhere else; we then would not have to do any masking. It would just be:</p>
<pre>  Quad2 newNW =  LookupNW(nw) | LookupSW(w_n) | LookupNE(n_w) | LookupSE(c_nw);
  ...
</pre>
<p>But that’s not how the original implementation did it, and so that’s not what I’m doing here. It would be an interesting experiment to find out of that makes a difference; maybe we will come back to that point later in the series, but probably not.</p>
<p>Oh, and incidentally, you remember that fragment of bit-twiddling code that I posted from the original implementation?</p>
<pre>int ix01 = (ix00 &amp; 0xf0f0) | (cN.q[14] &amp; 0x0f0f);
int ix11 = (ix10 &amp; 0xf0f0) | (cN.q[15] &amp; 0x0f0f);
int ix03 = (ix02 &amp; 0xf0f0) | (ix01 &amp; 0x0f00) | (cN.q[7] &amp; 0x000f);
</pre>
<p>I bet you can figure out what it does now!</p>
<p>Well that was quite the journey to get a fast method that can step an 8×8 fragment of a 12×12 grid forwards one tick by memoizing the “4×4 step to 2×2” problem. Why is this method useful?</p>
<p><strong>Next time on FAIC:</strong> Yeah, why?</p>
			</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>