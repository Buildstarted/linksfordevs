<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How YOU can learn to build real-time Web Apps that scales, using .NET Core, C#, Azure SignalR Service and JavaScript - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="How YOU can learn to build real-time Web Apps that scales, using .NET Core, C#, Azure SignalR Service and JavaScript - linksfor.dev(s)"/>
    <meta property="og:description" content="[object Object]"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://softchris.github.io/pages/dotnet-signalr.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">ðŸŽ‰</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - How YOU can learn to build real-time Web Apps that scales, using .NET Core, C#, Azure SignalR Service and JavaScript</title>
<div class="readable">
        <h1>How YOU can learn to build real-time Web Apps that scales, using .NET Core, C#, Azure SignalR Service and JavaScript</h1>
            <div>Reading time: 20-25 minutes</div>
        <div>Posted here: 16 Nov 2019</div>
        <p><a href="https://softchris.github.io/pages/dotnet-signalr.html">https://softchris.github.io/pages/dotnet-signalr.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><p>Follow me on <a href="https://twitter.com/chris_noring" target="_blank" rel="noopener noreferrer">Twitter</a>, happy to take your suggestions on topics or improvements /Chris</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/praxk0bmzsbnls7uw9mi.jpg" alt=""></p> <blockquote><p>Ok, so you want to build real-time applications? There are some things to consider like what do I do if the browser doesn't support Web Sockets, what's my fallback technology? Also, how do I scale? What about CORS? As you can see there's more to it than just creating a Web Socket. That's why SignalR exists to tackle the above scenarios.</p></blockquote> <p>TLDR; There are two things this article will tackle, one is SignalR itself, what it is and why use it. We will also go into Azure SignalR service and talk about the difference. Lastly, we will show a demo using SignalR service and Serverless.</p> <h2 id="references"> References</h2> <ul><li><p><a href="https://azure.microsoft.com/free/?wt.mc_id=personal-blog-chnoring" target="_blank" rel="noopener noreferrer">Sign up for a free Azure account</a>
To be able to use the Azure SignalR Service part you will need a free Azure account</p></li> <li><p><a href="https://docs.microsoft.com/en-us/aspnet/signalr/overview/getting-started/introduction-to-signalr?wt.mc_id=personal-blog-chnoring" target="_blank" rel="noopener noreferrer">SignalR overview</a>
A great page that explains what SignalR is, how it works etc.</p></li> <li><p><a href="https://docs.microsoft.com/en-us/aspnet/core/signalr/introduction?view=aspnetcore-3.0&amp;wt.mc_id=personal-blog-chnoring" target="_blank" rel="noopener noreferrer">ASP.NET Core SignalR</a>
Great overview. Not as detail-heavy as the first page but still covers the basic concepts well a TLDR; version if you will.</p></li> <li><p><a href="https://github.com/signalr?wt.mc_id=personal-blog-chnoring" target="_blank" rel="noopener noreferrer">SignalR GitHub repo</a>
It's open-source and contains examples using different languages for the Serverless part and also clients with and without Auth.</p></li> <li><p><a href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/signalr?view=aspnetcore-3.0&amp;tabs=visual-studio-code&amp;wt.mc_id=peersonal-blog-chnoring" target="_blank" rel="noopener noreferrer">SginalR + .NET Core Tutorial</a>
This tutorial covers how to build a SignalR backend in .NET Core Web project and how we call it from a Client.</p></li></ul> <h2 id="signalr"> SignalR</h2> <p>ASP.NET SignalR is a library for ASP.NET developers that simplifies the process of adding real-time web functionality to applications. Real-time web functionality is the ability to have server code <em>push</em> content to connected clients instantly as it becomes available, rather than having the server wait for a client to request new data.</p> <blockquote><p>What can I use it for?</p></blockquote> <p>While chat is often used as an example, you can do a whole lot more like Dashboards and monitoring applications, collaborative applications (such as simultaneous editing of documents), job progress updates, and real-time forms.</p> <blockquote><p>How do I recognize when I should be using SignalR?</p></blockquote> <p>Any time a user refreshes a web page to see new data, or the page implements long polling to retrieve new data, it is a candidate for using SignalR.</p> <blockquote><p>How does it work?</p></blockquote> <p>SignalR provides a simple API for creating server-to-client remote procedure calls (RPC) that call JavaScript functions in client browsers (and other client platforms) from server-side .NET code.</p> <p><img src="https://docs.microsoft.com/en-us/aspnet/signalr/overview/getting-started/introduction-to-signalr/_static/image1.png" alt=""></p> <blockquote><p>Ok, so SignalR calls my JavaScript code when there's new data?</p></blockquote> <p>Correct.</p> <p>SignalR handles connection management automatically and lets you broadcast messages to all connected clients simultaneously, like a chat room. You can also send messages to specific clients.</p> <blockquote><p><em>Broadcast</em> and I can also target specific clients, got it.</p></blockquote> <p>SignalR uses the new WebSocket transport where available and falls back to older transports where necessary. While you could certainly write your app using WebSocket directly, using SignalR means that a lot of the extra functionality you would need to implement is already done for you.</p> <blockquote><p>Oh, so I could be using WebSockets instead of SignalR but if that doesn't work I would need to code a fallback myself. But if I use SignalR, I don't need to care? I get WebSocket primarily but a fallback behavior?</p></blockquote> <p>Correct.</p> <h3 id="hosting"> Hosting</h3> <p>There are two ways to host SignalR:</p> <ul><li><strong>Self-hosted</strong>, we host SignalR ourselves as part of a Web App</li> <li><strong>Azure SignalR Service</strong>, this is SignalR living in the Cloud as a service, it comes with a lot of benefits</li></ul> <p>Here's an overview:</p> <p><img src="https://docs.microsoft.com/en-us/azure/azure-signalr/media/signalr-overview/managed-signalr-service.png" alt=""></p> <h3 id="azure-signalr-service"> Azure SignalR Service</h3> <blockquote><p>Why should I go with the Service over self-hosted?</p></blockquote> <p>Switching to SignalR Service will remove the need to manage <em>backplanes</em> that handle the scales and client connections.</p> <blockquote><p>Ok so you handle client connections for me and scaling. Nice, I like the sound of that.</p></blockquote> <p>The fully managed service also simplifies web applications and saves hosting costs.</p> <blockquote><p>Simplifications and saves me money. No objections from me ðŸ˜ƒ</p></blockquote> <p>SignalR Service offers global reach and world-class data center and network, scales to millions of connections, guarantees SLA, while providing all the compliance and security at Azure standard.</p> <blockquote><p>Millions of connections! That's a large chat room ðŸ˜‰ SLA compliance, that will make my CEO and legal department happy ðŸ˜ƒ Good security is a must of course.</p></blockquote> <h2 id="how"> HOW</h2> <p>I know you want to learn to use this so shall we? We will:</p> <ul><li><strong>Provision</strong> an Azure SignalR service</li> <li><strong>Create an Azure Function app</strong>, that will allow us to connect to the Azure SignalR Service. We will learn how to manage connections and also how to receive and send messages.</li> <li><strong>Create a UI</strong> that is able to connect to our Azure Function App and send/receive messages.</li></ul> <h2 id="provision-an-azure-signalr-service"> Provision an Azure SignalR Service</h2> <ol><li><p>Go to <code>portal.azure.com</code></p></li> <li><p>Click <code>+ Create a resource</code></p></li> <li><p>Enter <code>SignalR Service</code> in the search field</p></li></ol> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/1prqkfx1eey55a6adn60.png" alt=""></p> <ol start="4"><li>Press <code>Review + Create</code> and then <code>Create</code> on the next screen.</li></ol> <p>NOTE, One last step. We need to set up our Azure SignalR service so that it can communicate with Serverless apps, otherwise the handshake, when connecting, will fail. I learned that <em>the hard way</em> ðŸ˜ƒ</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/b336gn981pg0gcjr86di.png" alt=""></p> <h2 id="create-azure-function-app"> Create Azure Function App</h2> <p>This involves us creating an Azure Function app. It will have two different functions in it:</p> <ul><li><strong>negotiate</strong>, this will talk to our Azure SignalR service and give back an API key that we can use when we want to do things like sending messages</li> <li><strong>messages</strong>, this endpoint will be used to send messages</li></ul> <h3 id="pre-requisites"> Pre requisites</h3> <p>First off, as with any Azure Function we need to ensure we have installed the prerequisites which look different on different OSs:</p> <p>For Mac:</p> <div><pre><code>brew tap azure/functions
brew install azure-functions-core-tools
</code></pre> <p><span>1</span><br><span>2</span><br></p></div><p>For Windows:</p> <div><pre><code>npm install -g azure-functions-core-tools
</code></pre> <p><span>1</span><br></p></div><p>Read more here if you have Linux as OS:</p> <blockquote><p>https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local</p></blockquote> <p>One more thing, to make authoring a Serverless Function I recommend installing the Azure Function extension. This will enable you to scaffold functions as well as debugging and deploying them. Go to your extension tab in VS Code and install the below:</p> <p><img src="https://docs.microsoft.com/en-us/azure/includes/media/functions-install-vs-code-extension/vscode-install-extension.png" alt=""></p> <p>If you are on Visual Studio, have a look here:</p> <blockquote><p>https://docs.microsoft.com/en-us/azure/azure-functions/functions-develop-vs</p></blockquote> <h3 id="create-our-serverless-functions"> Create our Serverless functions</h3> <p>Ok then, for the sake of this article we will be using VS Code as our IDE of choice. We will do the following:</p> <ul><li><strong>Create an Azure Function App</strong>, an Azure Function needs to belong to an app</li> <li><strong>Scaffold two Azure Functions</strong>, <code>negotiate</code> and <code>messages</code></li> <li><strong>Configure</strong> our two functions to work with our Azure SignalR service</li></ul> <p>Bring up the command palette <code>View/Command Palette</code>, or <code>CMD+SHIFT+P</code> on a Mac.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/a97mmz4yb21q8iqm69wq.png" alt=""></p> <p>Next, select a directory for your app (I usually pick the one I'm standing in)</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/17va0s9nvxjqo49rreu3.png" alt=""></p> <p>After that, we are asked to select a language. As you can see below we have quite a few options. Let's go with <code>C#</code> for this one.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/j4rut669vt2r0c5hnjbr.png" alt=""></p> <p>The next step is to select a <code>Trigger</code> for your first function (first time when you create a Serverless project it will create project + one function). A <code>Trigger</code> determines how our function will be started. In this case, we want it to be started/triggered by an HTTP call so we select <code>HttpTrigger</code> below:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/gl99cdac8z2ie074ral6.png" alt=""></p> <p>We have two more steps here, those are:</p> <ul><li><strong>Name</strong> of our function, let's call it <code>negotiate</code></li> <li><strong>Namespace</strong>, call it <code>Company</code></li> <li><strong>Authorization</strong> let's go with <code>Anonymous</code></li></ul> <p>Ok, so now we have gotten a Serverless .NET Core project. Let's bring up the command palette once more <code>View/Command Palette</code> and enter <code>Azure Functions: Create Function</code> like the below.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/ico320t1ihuu3p7evizg.png" alt=""></p> <p>Select:</p> <ul><li><strong>Trigger</strong> select <code>HttpTrigger</code></li> <li><strong>Function name</strong>, call it <code>messages</code></li> <li><strong>Namespace</strong> call it <code>Company</code></li> <li><strong>Authorization level</strong>, let's select <code>anonymous</code></li></ul> <p>Ok, then, we should at this point have a create a Function app/Function Project with two functions in it. It should look like this, after you renamed <code>negotiate.cs</code> to <code>Negotiate.cs</code> and <code>messages.cs</code> have been renamed to <code>Messages.cs</code>:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/xsjm3poe4dmv0vr5nc2e.png" alt=""></p> <h3 id="configure-signalr"> Configure SignalR</h3> <p>At this point we need to do two things:</p> <ul><li><strong>Add SignalR decorators in code</strong>, this ensures we are connecting to the correct Azure SignalR instance in the Cloud</li> <li><strong>Add Connection String information</strong>, we need to add this information to our config file so it knows what SignalR instance to talk to</li></ul> <p><strong>Add SignalR decorators</strong></p> <p>Let's open up <code>Negotiate.cs</code> and give it the following code:</p> <div><pre><code>
<span>using</span> Microsoft<span>.</span>AspNetCore<span>.</span>Http<span>;</span>
<span>using</span> Microsoft<span>.</span>Azure<span>.</span>WebJobs<span>;</span>
<span>using</span> Microsoft<span>.</span>Azure<span>.</span>WebJobs<span>.</span>Extensions<span>.</span>Http<span>;</span>
<span>using</span> Microsoft<span>.</span>Azure<span>.</span>WebJobs<span>.</span>Extensions<span>.</span>SignalRService<span>;</span>

<span>namespace</span> Company
<span>{</span>
  <span>public</span> <span>static</span> <span>class</span> <span>Negotiate</span>
  <span>{</span>
      <span>[</span><span>FunctionName</span><span>(</span><span>"negotiate"</span><span>)</span><span>]</span>
      <span>public</span> <span>static</span> <span>SignalRConnectionInfo</span> <span>GetSignalRInfo</span><span>(</span>
          <span>[</span><span>HttpTrigger</span><span>(</span>AuthorizationLevel<span>.</span>Anonymous<span>,</span> <span>"post"</span><span>)</span><span>]</span> <span>HttpRequest</span> req<span>,</span>
          <span>[</span><span>SignalRConnectionInfo</span><span>(</span>HubName <span>=</span> <span>"chat"</span><span>)</span><span>]</span> <span>SignalRConnectionInfo</span> connectionInfo<span>)</span>
      <span>{</span>
          <span>return</span> connectionInfo<span>;</span>
      <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></p></div><p>From the above code, we can see that we have the decorator <code>SignalRConnectionInfo</code> and we point out a so-called hub called <code>chat</code>. Additionally, we see that the function ends up returning a <code>connectionInfo</code> object. What goes on here is that when this endpoint is being hit by an HTTP request we handshake with our Azure SignalR Service in the Cloud and it ends up giving us the needed connection info back so we can keep talking it when doing things like sending messages.</p> <p>Now let's open <code>Messages.cs</code> and give it the following code:</p> <div><pre><code>
<span>using</span> System<span>.</span>Threading<span>.</span>Tasks<span>;</span>
<span>using</span> Microsoft<span>.</span>Azure<span>.</span>WebJobs<span>;</span>
<span>using</span> Microsoft<span>.</span>Azure<span>.</span>WebJobs<span>.</span>Extensions<span>.</span>Http<span>;</span>
<span>using</span> Microsoft<span>.</span>Azure<span>.</span>WebJobs<span>.</span>Extensions<span>.</span>SignalRService<span>;</span>

<span>namespace</span> Company
<span>{</span>
  <span>public</span> <span>static</span> <span>class</span> <span>Messages</span>
  <span>{</span>

    <span>[</span><span>FunctionName</span><span>(</span><span>"messages"</span><span>)</span><span>]</span>
    <span>public</span> <span>static</span> <span>Task</span> <span>SendMessage</span><span>(</span>
          <span>[</span><span>HttpTrigger</span><span>(</span>AuthorizationLevel<span>.</span>Anonymous<span>,</span> <span>"post"</span><span>)</span><span>]</span> <span>object</span> message<span>,</span>
          <span>[</span><span>SignalR</span><span>(</span>HubName <span>=</span> <span>"chat"</span><span>)</span><span>]</span> IAsyncCollector<span>&lt;</span>SignalRMessage<span>&gt;</span> signalRMessages<span>)</span>
    <span>{</span>
      <span>return</span> signalRMessages<span>.</span><span>AddAsync</span><span>(</span>
          <span>new</span> <span>SignalRMessage</span>
          <span>{</span>
            Target <span>=</span> <span>"newMessage"</span><span>,</span>
            Arguments <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span> message <span>}</span>
          <span>}</span><span>)</span><span>;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></p></div><p>This time around we also use a decorator, but it's called <code>SignalR</code> but we still give it the Hub value <code>chat</code>. Our SignalR decorator decorates a list of messages that has the parameter name <code>signalRMessages</code>.</p> <p>Let's have a look at the function body next. We see that we call <code>signalRMessages.AddAsync()</code>. What does that do? Well, it passes in <code>SignalRMessage</code> that consists of two things:</p> <ul><li><strong>Target</strong>, this is the name of an event, in this case, <code>newMessage</code>. A client can listen to this event and render its payload for example</li> <li><strong>Arguments</strong>, this is simply the payload, in this case, we just want to broadcast all messages that come from one client, to ensure other listening clients would be updated on the fact that there is new data.</li></ul> <p><strong>Add Connection String</strong></p> <p>Ok, so we learned that our code needs SignalR decorators in the code to work properly. Nothing will work however unless we add the Connection String information to our project configuration file called <code>local.setting.json</code>.</p> <p>Let's have a look at the current state of the file:</p> <div><pre><code><span>{</span>
    <span>"IsEncrypted"</span><span>:</span> <span>false</span><span>,</span>
    <span>"Values"</span><span>:</span> <span>{</span>
        <span>"FUNCTIONS_WORKER_RUNTIME"</span><span>:</span> <span>"dotnet"</span><span>,</span>
        <span>"AzureSignalRConnectionString"</span><span>:</span> <span>"&lt;add connection string info here&gt;"</span>
    <span>}</span><span>,</span>
    <span>"Host"</span><span>:</span> <span>{</span>
        <span>"LocalHttpPort"</span><span>:</span> <span>7071</span><span>,</span>
        <span>"CORS"</span><span>:</span> <span>"&lt;add allowed client domains here&gt;"</span><span>,</span>
        <span>"CORSCredentials"</span><span>:</span> <span>true</span>
    <span>}</span>
<span>}</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></p></div><p>Let's look at <code>AzureSignalRConnectionString</code> , this needs to have the correct Connection String info. We can find that if we go our Azure SignalR Service in the Cloud.</p> <ol><li>Go to <code>portal.azure.com</code></li> <li>Select your Azure SignalR Service</li> <li>Click <code>keys</code> in the left menu</li> <li>Copy the value under <code>CONNECTION STRING</code></li></ol> <p>Next, let's update the <code>CORS</code> property. Because we are running this locally we need to allow, for now, that <code>http://localhost:8080</code> is allowed to talk our Azure Function App and Azure SignalR Service.</p> <p>NOTE, we will ensure that the client we are about to create will be run on port <code>8080</code>.</p> <h3 id="create-a-ui"> Create a UI</h3> <p>Ok, we've taken all the necessary steps to create a backend, and an Azure SignalR service that is able to scale our real-time connections. We've also added a serverless function that is able to proxy any calls made to our Azure SignalR service. What remains is the application code, the part our users will see.</p> <p>We will build a chat application. So our app will be able to do the following:</p> <ul><li><strong>Establish</strong> a connection to our Azure SignalR Service</li> <li><strong>Show incoming messages</strong> from other clients</li> <li><strong>Send messages</strong> to other clients</li></ul> <h3 id="establish-a-connection"> Establish a connection</h3> <p>Let's select a different directory than that of our serverless app. Now create a file <code>index.html</code> and give it the following content:</p> <div><pre><code><span><span><span>&lt;</span>html</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>body</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.2/dist/browser/signalr.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span><span>&gt;</span></span><span><span>
    
    </span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
  <span><span><span>&lt;/</span>body</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>html</span><span>&gt;</span></span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></p></div><p>Above we have added some script tags:</p> <ul><li><strong>Vue.js</strong>, this is a link to a CDN version on Vue.js, you can go with whatever SPA framework you want here or Vanilla JS</li> <li><strong>SignalR</strong>, this is a link to a CDN version of SignalR, this is a must, we need this to establish a connection to our SignalR Hub and also for sending messages that other clients can listen to</li> <li><strong>Axios</strong>, this is a link to a CDN version of Axios, Axios is a library for handling HTTP requests. You are fine using the native fetch in this case, up to you</li></ul> <p>How do we establish a connection in code? The code below will do just that. We point <code>apiBaseUrl</code> to the location of our Serverless Function App, once it's up and running.</p> <div><pre><code><span>const</span> apiBaseUrl <span>=</span> <span>'http://localhost:7071'</span><span>;</span>

<span>const</span> connection <span>=</span> <span>new</span> <span>signalR<span>.</span>HubConnectionBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>withUrl</span><span>(</span><span><span>`</span><span><span>${</span>apiBaseUrl<span>}</span></span><span>/api`</span></span><span>)</span>
    <span>.</span><span>configureLogging</span><span>(</span>signalR<span>.</span>LogLevel<span>.</span>Information<span>)</span>
    <span>.</span><span>build</span><span>(</span><span>)</span><span>;</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></p></div><p>The above will set up a connection object. To actually connect we need to call <code>start()</code> on our connection object.</p> <div><pre><code>console<span>.</span><span>log</span><span>(</span><span>'connecting...'</span><span>)</span><span>;</span>
connection<span>.</span><span>start</span><span>(</span><span>)</span>
  <span>.</span><span>then</span><span>(</span><span>(</span><span>response</span><span>)</span> <span>=&gt;</span> <span>{</span>
    console<span>.</span><span>log</span><span>(</span><span>'connection established'</span><span>,</span> response<span>)</span><span>;</span>
  <span>}</span><span>)</span>
  <span>.</span><span>catch</span><span>(</span>logError<span>)</span><span>;</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></p></div><p>Before we move on let's try to verify that we can connect to our Serverless function and the Azure SignalR service.</p> <p><strong>Take it for a spin</strong></p> <p>We need to take the following steps to test things out:</p> <ol><li><strong>Startup</strong> our Serverless function in Debug mode</li> <li><strong>Startup</strong> our client on <code>http://localhost:8080</code></li> <li><strong>Ensure</strong> the <code>connection established</code> message is shown in the client</li></ol> <p>Go to our Serverless app and select <code>Debug/Start Debugging</code> from the menu. It should look like the below.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/691hfwgue4ioll0mdft0.png" alt=""></p> <p>Also, place a breakpoint in <code>Negotiate.cs</code> and the first line of the function, so we can capture when the client is trying to connect.</p> <p>Next, let's start up the client at <code>http://localhost:8080</code>. Use for example <code>http-server</code> for that at the root of your client code:</p> <blockquote><p>http-server -p 8080</p></blockquote> <p>As soon as you go open up a browser on <code>http://localhost:8080</code> it should hit your Serverless function <code>negotiate</code>, like so:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/2lgfgw55qinnnf5fc4wp.png" alt=""></p> <p>As you can see above, the Azure SignalR service is sending back an <code>AccessToken</code> and the <code>URL</code> you were connecting against.</p> <p>Looking at the browser, we should see something like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/rukk4st7j2h73re7514r.png" alt=""></p> <p>Good, everything works so far. This was the hard part. So what remains is building this out to an app that the user wants to use, so that's next. ðŸ˜ƒ</p> <h3 id="build-our-vue-js-app"> Build our Vue.js app</h3> <p>Our app should support:</p> <ul><li><strong>Connecting to Azure SignalR Service</strong>, we got that down already</li> <li><strong>Show messages</strong>, be able to show messages from other clients</li> <li><strong>Send message</strong>, the user should be able to send a message</li></ul> <p>Let's get to work ðŸ˜ƒ</p> <p><strong>Create a Vue.js app</strong></p> <p>We need to create a Vue app and ensure it renders on a specific DOM element, like so:</p> <div><pre><code><span><span><span>&lt;</span>html</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>body</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>div</span> <span>id</span><span><span>=</span><span>"</span>app<span>"</span></span><span>&gt;</span></span>
      App goes here
    <span><span><span>&lt;/</span>div</span><span>&gt;</span></span>

    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.2/dist/browser/signalr.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span><span>&gt;</span></span><span><span>
      <span>const</span> app <span>=</span> <span>new</span> <span>Vue</span><span>(</span><span>{</span>
        el<span>:</span> <span>'#app'</span><span>,</span>    
      <span>}</span><span>)</span><span>;</span>

      <span>const</span> apiBaseUrl <span>=</span> <span>'http://localhost:7071'</span><span>;</span>

      <span>const</span> connection <span>=</span> <span>new</span> <span>signalR<span>.</span>HubConnectionBuilder</span><span>(</span><span>)</span>
        <span>.</span><span>withUrl</span><span>(</span><span><span>`</span><span><span>${</span>apiBaseUrl<span>}</span></span><span>/api`</span></span><span>)</span>
        <span>.</span><span>configureLogging</span><span>(</span>signalR<span>.</span>LogLevel<span>.</span>Information<span>)</span>
        <span>.</span><span>build</span><span>(</span><span>)</span><span>;</span>

      console<span>.</span><span>log</span><span>(</span><span>'connecting...'</span><span>)</span><span>;</span>
      connection<span>.</span><span>start</span><span>(</span><span>)</span>
        <span>.</span><span>then</span><span>(</span><span>(</span><span>response</span><span>)</span> <span>=&gt;</span> <span>{</span>
          console<span>.</span><span>log</span><span>(</span><span>'connection established'</span><span>,</span> response<span>)</span><span>;</span>
      <span>}</span><span>)</span>
        <span>.</span><span>catch</span><span>(</span>logError<span>)</span><span>;</span>

      
    </span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
  <span><span><span>&lt;/</span>body</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>html</span><span>&gt;</span></span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br></p></div><p>Above we have the entire code so far. Let's specifically highlight:</p> <div><pre><code><span><span><span>&lt;</span>div</span> <span>id</span> <span><span>=</span><span>"</span>app<span>"</span></span><span>&gt;</span></span>
<span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
</code></pre> <p><span>1</span><br><span>2</span><br></p></div><p>and</p> <div><pre><code><span>const</span> app <span>=</span> <span>new</span> <span>Vue</span><span>(</span><span>{</span>
  el<span>:</span> <span>'#app'</span><span>,</span>    
<span>}</span><span>)</span><span>;</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br></p></div><p>Now we have an app, but it does nothing.</p> <p><strong>Show messages</strong></p> <p>To be able to show messages we need to listen to events being raised from our Serverless function. If you remember, in our Serverless function we called the following code in our <code>Messages.cs</code>:</p> <div><pre><code><span>return</span> signalRMessages<span>.</span><span>AddAsync</span><span>(</span>
  <span>new</span> <span>SignalRMessage</span>
  <span>{</span>
    Target <span>=</span> <span>"newMessage"</span><span>,</span>
    Arguments <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span> message <span>}</span>
  <span>}</span><span>)</span><span>;</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></p></div><p>We are interested in listening to the event <code>newMessage</code> being raised by the above function. The code for that looks like so:</p> <div><pre><code>connection<span>.</span><span>on</span><span>(</span><span>'newMessage'</span><span>,</span> newMessage<span>)</span><span>;</span>

<span>function</span> <span>newMessage</span><span>(</span><span>message</span><span>)</span> <span>{</span>
  
<span>}</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></p></div><blockquote><p>Ok, how do I get that message to show in my Vue.js app?</p></blockquote> <p>Let's make sure to update our markup to this:</p> <div><pre><code><span><span><span>&lt;</span>div</span> <span>id</span><span><span>=</span><span>"</span>app<span>"</span></span><span>&gt;</span></span>
  <span><span><span>&lt;</span>h2</span><span>&gt;</span></span>Messages<span><span><span>&lt;/</span>h2</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>div</span> <span>v-for</span><span><span>=</span><span>"</span>message in messages<span>"</span></span><span>&gt;</span></span>
    <span><span><span>&lt;</span>strong</span><span>&gt;</span></span>{{message.sender}}<span><span><span>&lt;/</span>strong</span><span>&gt;</span></span> {{message.text}}
  <span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></p></div><p>and our app code to:</p> <div><pre><code><span>const</span> data <span>=</span> <span>{</span>
  messages<span>:</span> <span>[</span><span>]</span>
<span>}</span>

<span>const</span> app <span>=</span> <span>new</span> <span>Vue</span><span>(</span><span>{</span>
  el<span>:</span> <span>'#app'</span><span>,</span>    
  data<span>:</span> data
<span>}</span><span>)</span><span>;</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></p></div><p>and this:</p> <div><pre><code><span>function</span> <span>newMessage</span><span>(</span><span>message</span><span>)</span> <span>{</span>
  data<span>.</span>messages <span>=</span> <span>[</span><span>...</span>data<span>.</span>messages<span>,</span> <span>{</span><span>...</span>message<span>}</span><span>]</span>
<span>}</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br></p></div><p>Now we can render all the messages.</p> <blockquote><p>But there are no messages to show and I'm the only person in the chat room and I can't send a message?</p></blockquote> <p>Fair point, let's give you that ability:</p> <p><strong>Send message</strong></p> <p>We need a way for the user to type in a message in HTML and also a way to send that message to the SignalR Hub in code. Let's start with the HTML</p> <div><pre><code><span><span><span>&lt;</span>div</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>input</span> <span>type</span><span><span>=</span><span>"</span>text<span>"</span></span> <span>v-model</span><span><span>=</span><span>"</span>newMessage<span>"</span></span> <span>id</span><span><span>=</span><span>"</span>message-box<span>"</span></span> <span>class</span><span><span>=</span><span>"</span>form-control<span>"</span></span>
    <span>placeholder</span><span><span>=</span><span>"</span>Type message here...<span>"</span></span> <span>autocomplete</span><span><span>=</span><span>"</span>off<span>"</span></span> <span>/&gt;</span></span>
  <span><span><span>&lt;</span>button</span> <span>@click</span><span><span>=</span><span>"</span>sendMessage<span>"</span></span><span>&gt;</span></span>Send message<span><span><span>&lt;/</span>button</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></p></div><p>and the code for the <em>send</em> function:</p> <div><pre><code><span>function</span> <span>createMessage</span><span>(</span><span>sender<span>,</span> messageText</span><span>)</span> <span>{</span>
  <span>return</span> axios<span>.</span><span>post</span><span>(</span><span><span>`</span><span><span>${</span>apiBaseUrl<span>}</span></span><span>/api/messages`</span></span><span>,</span> <span>{</span>
    sender<span>:</span> sender<span>,</span>
    text<span>:</span> messageText
  <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>resp</span> <span>=&gt;</span> console<span>.</span><span>log</span><span>(</span><span>'success sending message'</span><span>,</span>resp<span>.</span>data<span>)</span><span>;</span>
<span>}</span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></p></div><p>Our full code so far looks like this:</p> <div><pre><code><span><span><span>&lt;</span>html</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>body</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>div</span> <span>id</span><span><span>=</span><span>"</span>app<span>"</span></span><span>&gt;</span></span>
      <span><span><span>&lt;</span>h2</span><span>&gt;</span></span>
        User
      <span><span><span>&lt;/</span>h2</span><span>&gt;</span></span>
      <span><span><span>&lt;</span>div</span><span>&gt;</span></span>
        <span><span><span>&lt;</span>input</span> <span>type</span><span><span>=</span><span>"</span>text<span>"</span></span> <span>v-model</span><span><span>=</span><span>"</span>user<span>"</span></span> <span>placeholder</span><span><span>=</span><span>"</span>user name<span>"</span></span> <span>/&gt;</span></span>
      <span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
      <span><span><span>&lt;</span>div</span><span>&gt;</span></span>
          <span><span><span>&lt;</span>input</span> <span>type</span><span><span>=</span><span>"</span>text<span>"</span></span> <span>v-model</span><span><span>=</span><span>"</span>newMessage<span>"</span></span> <span>id</span><span><span>=</span><span>"</span>message-box<span>"</span></span> <span>class</span><span><span>=</span><span>"</span>form-control<span>"</span></span>
            <span>placeholder</span><span><span>=</span><span>"</span>Type message here...<span>"</span></span> <span>autocomplete</span><span><span>=</span><span>"</span>off<span>"</span></span> <span>/&gt;</span></span>
        <span><span><span>&lt;</span>button</span> <span>@click</span><span><span>=</span><span>"</span>sendMessage<span>"</span></span><span>&gt;</span></span>Send message<span><span><span>&lt;/</span>button</span><span>&gt;</span></span>
      <span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
      <span><span><span>&lt;</span>h2</span><span>&gt;</span></span>Messages<span><span><span>&lt;/</span>h2</span><span>&gt;</span></span>
      <span><span><span>&lt;</span>div</span> <span>v-for</span><span><span>=</span><span>"</span>message in messages<span>"</span></span><span>&gt;</span></span>
        <span><span><span>&lt;</span>strong</span><span>&gt;</span></span>{{message.sender}}<span><span><span>&lt;/</span>strong</span><span>&gt;</span></span> {{message.text}}
      <span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
    <span><span><span>&lt;/</span>div</span><span>&gt;</span></span>

    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.2/dist/browser/signalr.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>"</span>https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js<span>"</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span><span>&gt;</span></span><span><span>
      <span>const</span> data <span>=</span> <span>{</span>
        user<span>:</span> <span>'change me'</span><span>,</span>
        messages<span>:</span> <span>[</span><span>]</span><span>,</span>
        newMessage<span>:</span> <span>''</span>
      <span>}</span>

      <span>const</span> app <span>=</span> <span>new</span> <span>Vue</span><span>(</span><span>{</span>
        el<span>:</span> <span>'#app'</span><span>,</span>    
        data<span>:</span> data<span>,</span>
        methods<span>:</span> <span>{</span>
          <span>sendMessage</span><span>(</span><span>)</span> <span>{</span>
            <span>createMessage</span><span>(</span><span>this</span><span>.</span>user<span>,</span> <span>this</span><span>.</span>newMessage<span>)</span><span>;</span>
          <span>}</span>
        <span>}</span>
      <span>}</span><span>)</span><span>;</span>

      <span>const</span> apiBaseUrl <span>=</span> <span>'http://localhost:7071'</span><span>;</span>

      <span>const</span> connection <span>=</span> <span>new</span> <span>signalR<span>.</span>HubConnectionBuilder</span><span>(</span><span>)</span>
        <span>.</span><span>withUrl</span><span>(</span><span><span>`</span><span><span>${</span>apiBaseUrl<span>}</span></span><span>/api`</span></span><span>)</span>
        <span>.</span><span>configureLogging</span><span>(</span>signalR<span>.</span>LogLevel<span>.</span>Information<span>)</span>
        <span>.</span><span>build</span><span>(</span><span>)</span><span>;</span>

      console<span>.</span><span>log</span><span>(</span><span>'connecting...'</span><span>)</span><span>;</span>
      connection<span>.</span><span>start</span><span>(</span><span>)</span>
        <span>.</span><span>then</span><span>(</span><span>(</span><span>response</span><span>)</span> <span>=&gt;</span> <span>{</span>
          console<span>.</span><span>log</span><span>(</span><span>'connection established'</span><span>,</span> response<span>)</span><span>;</span>
      <span>}</span><span>)</span>
        <span>.</span><span>catch</span><span>(</span>logError<span>)</span><span>;</span>

      connection<span>.</span><span>on</span><span>(</span><span>'newMessage'</span><span>,</span> newMessage<span>)</span><span>;</span>

      <span>function</span> <span>newMessage</span><span>(</span><span>message</span><span>)</span> <span>{</span>
        data<span>.</span>messages <span>=</span> <span>[</span><span>...</span>data<span>.</span>messages<span>,</span> <span>{</span><span>...</span>message<span>}</span><span>]</span>
      <span>}</span>

      <span>function</span> <span>logError</span><span>(</span><span>err</span><span>)</span> <span>{</span>
        console<span>.</span><span>error</span><span>(</span><span>'Error establishing connection'</span><span>,</span> err<span>)</span><span>;</span>
      <span>}</span>

      <span>function</span> <span>createMessage</span><span>(</span><span>sender<span>,</span> messageText</span><span>)</span> <span>{</span>
        <span>return</span> axios<span>.</span><span>post</span><span>(</span><span><span>`</span><span><span>${</span>apiBaseUrl<span>}</span></span><span>/api/messages`</span></span><span>,</span> <span>{</span>
          sender<span>:</span> sender<span>,</span>
          text<span>:</span> messageText
        <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>resp</span> <span>=&gt;</span> <span>{</span>
          console<span>.</span><span>log</span><span>(</span><span>'message sent'</span><span>,</span> resp<span>)</span><span>;</span>
        <span>}</span><span>)</span><span>;</span>
      <span>}</span>

    </span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
  <span><span><span>&lt;/</span>body</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>html</span><span>&gt;</span></span>
</code></pre> <p><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br></p></div><p>and running this with two different windows side by side should look something like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/7h60p0u3lopio04y2vzp.png" alt=""></p> <p>As you can see this works pretty well but it ain't pretty so feel free to add Bootstrap, Bulma, Animations or whatever else you feel is needed to make it a great app.</p> <h2 id="summary"> Summary</h2> <p>We've learned the following:</p> <ul><li><strong>SignalR</strong>, what it is and how it can be hosted either as part of your Web App in App Service or via an Azure SignalR Service + Serverless</li> <li><strong>Serverless</strong>, we've taken our first steps in serverless and learned how to scaffold an app with functions</li> <li><strong>Chat</strong>, we've learned how to build a Chat by Creating a Serverless app as an endpoint and we've also built a Client in Vue.js</li></ul></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>