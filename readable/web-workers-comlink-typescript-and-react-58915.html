<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Web Workers, comlink, TypeScript and React - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Web Workers, comlink, TypeScript and React - linksfor.dev(s)"/>
    <meta property="og:description" content="JavaScript is famously single threaded.  However, if you&#x27;re developing for the web, you may well know that this is not quite accurate.  Ther..."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://blog.johnnyreilly.com/2020/02/web-workers-comlink-typescript-and-react.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
				<a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Web Workers, comlink, TypeScript and React</title>
<div class="readable">
        <h1>Web Workers, comlink, TypeScript and React</h1>
            <div>Reading time: 13-17 minutes</div>
        <div>Posted here: 24 Feb 2020</div>
        <p><a href="https://blog.johnnyreilly.com/2020/02/web-workers-comlink-typescript-and-react.html">https://blog.johnnyreilly.com/2020/02/web-workers-comlink-typescript-and-react.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="post-body-6819248093077473951" itemprop="description articleBody">
<p>JavaScript is famously single threaded.  However, if you're developing for the web, you may well know that this is not quite accurate.  There are <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers"><code>Web Workers</code></a>:</p>
<blockquote>
<p>A worker is an object created using a constructor (e.g. <code>Worker()</code>) that runs a named JavaScript file — this file contains the code that will run in the worker thread; workers run in another global context that is different from the current window.</p>
</blockquote>
<p>Given that there is a way to use other threads for background processing, why doesn't this happen all the time? Well there's a number of reasons; not the least of which is the ceremony involved in interacting with Web Workers. Consider the following example that illustrates moving a calculation into a worker:</p>
<pre><code><span>// main.js</span><span>
</span><span>function</span><span> add2NumbersUsingWebWorker</span><span>()</span><span> </span><span>{</span><span>
    </span><span>const</span><span> myWorker </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>"worker.js"</span><span>);</span><span>

    myWorker</span><span>.</span><span>postMessage</span><span>([</span><span>42</span><span>,</span><span> </span><span>7</span><span>]);</span><span>
    console</span><span>.</span><span>log</span><span>(</span><span>'Message posted to worker'</span><span>);</span><span>

    myWorker</span><span>.</span><span>onmessage </span><span>=</span><span> </span><span>function</span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span><span>
        console</span><span>.</span><span>log</span><span>(</span><span>'Message received from worker'</span><span>,</span><span> e</span><span>.</span><span>data</span><span>);</span><span>
    </span><span>}</span><span>
</span><span>}</span><span>

add2NumbersUsingWebWorker</span><span>();</span><span>

</span><span>// worker.js</span><span>
onmessage </span><span>=</span><span> </span><span>function</span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span><span>
  console</span><span>.</span><span>log</span><span>(</span><span>'Worker: Message received from main script'</span><span>);</span><span>
  </span><span>const</span><span> result </span><span>=</span><span> e</span><span>.</span><span>data</span><span>[</span><span>0</span><span>]</span><span> </span><span>*</span><span> e</span><span>.</span><span>data</span><span>[</span><span>1</span><span>];</span><span>
  </span><span>if</span><span> </span><span>(</span><span>isNaN</span><span>(</span><span>result</span><span>))</span><span> </span><span>{</span><span>
    postMessage</span><span>(</span><span>'Please write two numbers'</span><span>);</span><span>
  </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span><span>
    </span><span>const</span><span> workerResult </span><span>=</span><span> </span><span>'Result: '</span><span> </span><span>+</span><span> result</span><span>;</span><span>
    console</span><span>.</span><span>log</span><span>(</span><span>'Worker: Posting message back to main script'</span><span>);</span><span>
    postMessage</span><span>(</span><span>workerResult</span><span>);</span><span>
  </span><span>}</span><span>
</span><span>}</span></code></pre>
<p><em>This is not simple.</em>  It's hard to understand what's happening. Also, this approach only supports a single method call.  I'd much rather write something that looked more like this:</p>
<pre><code><span>// main.js</span><span>
</span><span>function</span><span> add2NumbersUsingWebWorker</span><span>()</span><span> </span><span>{</span><span>
    </span><span>const</span><span> myWorker </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>"worker.js"</span><span>);</span><span>

    </span><span>const</span><span> total </span><span>=</span><span> myWorker</span><span>.</span><span>add2Numbers</span><span>([</span><span>42</span><span>,</span><span> </span><span>7</span><span>]);</span><span>
    console</span><span>.</span><span>log</span><span>(</span><span>'Message received from worker'</span><span>,</span><span> total</span><span>);</span><span>
</span><span>}</span><span>

add2NumbersUsingWebWorker</span><span>();</span><span>

</span><span>// worker.js</span><span>
</span><span>export</span><span> </span><span>function</span><span> add2Numbers</span><span>(</span><span>firstNumber</span><span>,</span><span> secondNumber</span><span>)</span><span> </span><span>{</span><span>
  </span><span>const</span><span> result </span><span>=</span><span> firstNumber </span><span>+</span><span> secondNumber</span><span>;</span><span>
  </span><span>return</span><span> </span><span>(</span><span>isNaN</span><span>(</span><span>result</span><span>))</span><span>
    </span><span>?</span><span> </span><span>'Please write two numbers'</span><span>
    </span><span>:</span><span> </span><span>'Result: '</span><span> </span><span>+</span><span> result</span><span>;</span><span>
</span><span>}</span></code></pre>
<p>There's a way to do this using a library made by Google called <a href="https://github.com/GoogleChromeLabs/comlink">comlink</a>. This post will demonstrate how we can use this.  We'll use TypeScript and webpack.  We'll also examine how to integrate this approach into a React app.</p>
<h4>A use case for a Web Worker</h4>
<p>Let's make ourselves a TypeScript web app. We're going to use <code>create-react-app</code> for this:</p>
<pre><code><span>npx create</span><span>-</span><span>react</span><span>-</span><span>app webworkers</span><span>-</span><span>comlink</span><span>-</span><span>typescript</span><span>-</span><span>react </span><span>--</span><span>template</span><span> typescript</span></code></pre>
<p>Create a <code>takeALongTimeToDoSomething.ts</code> file alongside <code>index.tsx</code>:</p>
<pre><code><span>export</span><span> </span><span>function</span><span> takeALongTimeToDoSomething</span><span>()</span><span> </span><span>{</span><span>
    console</span><span>.</span><span>log</span><span>(</span><span>'Start our long running job...'</span><span>);</span><span>
    </span><span>const</span><span> seconds </span><span>=</span><span> </span><span>5</span><span>;</span><span>
    </span><span>const</span><span> start </span><span>=</span><span> </span><span>new</span><span> </span><span>Date</span><span>().</span><span>getTime</span><span>();</span><span>
    </span><span>const</span><span> delay </span><span>=</span><span> seconds </span><span>*</span><span> </span><span>1000</span><span>;</span><span>

    </span><span>while</span><span> </span><span>(</span><span>true</span><span>)</span><span> </span><span>{</span><span>
        </span><span>if</span><span> </span><span>((</span><span>new</span><span> </span><span>Date</span><span>().</span><span>getTime</span><span>()</span><span> </span><span>-</span><span> start</span><span>)</span><span> </span><span>&gt;</span><span> delay</span><span>)</span><span> </span><span>{</span><span>
            </span><span>break</span><span>;</span><span>
        </span><span>}</span><span>
    </span><span>}</span><span>
    console</span><span>.</span><span>log</span><span>(</span><span>'Finished our long running job'</span><span>);</span><span>
</span><span>}</span></code></pre>
<p>To <code>index.tsx</code> add this code:</p>
<pre><code><span>import</span><span> </span><span>{</span><span> takeALongTimeToDoSomething </span><span>}</span><span> </span><span>from</span><span> </span><span>'./takeALongTimeToDoSomething'</span><span>;</span><span>

</span><span>// ...</span><span>

console</span><span>.</span><span>log</span><span>(</span><span>'Do something'</span><span>);</span><span>
takeALongTimeToDoSomething</span><span>();</span><span>
console</span><span>.</span><span>log</span><span>(</span><span>'Do another thing'</span><span>);</span></code></pre>
<p>When our application runs we see this behaviour:</p>

<p><a href="https://3.bp.blogspot.com/-1NFBdptu-Mo/XjUqgCVVisI/AAAAAAAATa8/eYCZ_5XcmZoTAlykNW4Lp4m5uhXnr7KogCPcBGAYYCw/s1600/blocking.gif" imageanchor="1"><img data-original-height="613" data-original-width="1600" height="245" src="https://3.bp.blogspot.com/-1NFBdptu-Mo/XjUqgCVVisI/AAAAAAAATa8/eYCZ_5XcmZoTAlykNW4Lp4m5uhXnr7KogCPcBGAYYCw/s640/blocking.gif" width="640"></a></p><p>The app starts and logs <code>Do something</code> and <code>Start our long running job...</code> to the console. It then blocks the UI until the <code>takeALongTimeToDoSomething</code> function has completed running.  During this time the screen is empty and unresponsive. This is a poor user experience.</p>
<h4>Hello <code>worker-plugin</code> and <code>comlink</code></h4>
<p>To start using comlink we're going to need to eject our <code>create-react-app</code> application.  The way <code>create-react-app</code> works is by giving you a setup that handles a high percentage of the needs for a typical web app.  When you encounter an unsupported use case, you can run the <code>yarn eject</code> command to get direct access to the configuration of your setup.</p>
<p>Web Workers are not that commonly used in day to day development at present. Consequently there isn't yet a "plug'n'play" solution for workers supported by <code>create-react-app</code>.  There's a number of potential ways to support this use case and you can track the various discussions happening against <code>create-react-app</code> that covers this.  For now, let's eject with:</p>
<pre><code><span>yarn eject</span></code></pre>
<p>Then let's install the packages we're going to be using:</p>
<ul>
<li><a href="https://github.com/GoogleChromeLabs/worker-plugin"><code>worker-plugin</code></a> - this webpack plugin automatically compiles modules loaded in Web Workers</li>
<li><code>comlink</code> - this library provides the RPC-like experience that we want from our workers</li>
</ul>
<pre><code>yarn add comlink worker-plugin
</code></pre>
<p>We now need to tweak our <code>webpack.config.js</code> to use the <code>worker-plugin</code>:</p>
<pre><code><span>const</span><span> </span><span>WorkerPlugin</span><span> </span><span>=</span><span> require</span><span>(</span><span>'worker-plugin'</span><span>);</span><span>

</span><span>// ....</span><span>

    plugins</span><span>:</span><span> </span><span>[</span><span>
      </span><span>new</span><span> </span><span>WorkerPlugin</span><span>(),</span><span>

</span><span>// ....</span><span>
</span></code></pre>
<p>Do note that there's a number of <code>plugins</code> statements in the <code>webpack.config.js</code>.  You want the top level one; look out for the <code>new HtmlWebpackPlugin</code> statement and place your <code>new WorkerPlugin(),</code> before that.</p>
<h4>Workerize our slow process</h4>
<p>Now we're ready to take our long running process and move it into a worker.  Inside the <code>src</code> folder, create a new folder called <code>my-first-worker</code>.  Our worker is going to live in here.  Into this folder we're going to add a <code>tsconfig.json</code> file:</p>
<pre><code><span>{</span><span>
  </span><span>"compilerOptions"</span><span>:</span><span> </span><span>{</span><span>
    </span><span>"strict"</span><span>:</span><span> </span><span>true</span><span>,</span><span>
    </span><span>"target"</span><span>:</span><span> </span><span>"esnext"</span><span>,</span><span>
    </span><span>"module"</span><span>:</span><span> </span><span>"esnext"</span><span>,</span><span>
    </span><span>"lib"</span><span>:</span><span> </span><span>[</span><span>
      </span><span>"webworker"</span><span>,</span><span>
      </span><span>"esnext"</span><span>
    </span><span>],</span><span>
    </span><span>"moduleResolution"</span><span>:</span><span> </span><span>"node"</span><span>,</span><span>
    </span><span>"noUnusedLocals"</span><span>:</span><span> </span><span>true</span><span>,</span><span>
    </span><span>"sourceMap"</span><span>:</span><span> </span><span>true</span><span>,</span><span>
    </span><span>"allowJs"</span><span>:</span><span> </span><span>false</span><span>,</span><span>
    </span><span>"baseUrl"</span><span>:</span><span> </span><span>"."</span><span>
  </span><span>}</span><span>
</span><span>}</span></code></pre>
<p>This file exists to tell TypeScript that this is a Web Worker.  Do note the <code>"lib": [ "webworker"</code> usage which does exactly that.</p>
<p>Alongside the <code>tsconfig.json</code> file, let's create an <code>index.ts</code> file.  This will be our worker:</p>
<pre><code><span>import</span><span> </span><span>{</span><span> expose </span><span>}</span><span> </span><span>from</span><span> </span><span>'comlink'</span><span>;</span><span>
</span><span>import</span><span> </span><span>{</span><span> takeALongTimeToDoSomething </span><span>}</span><span> </span><span>from</span><span> </span><span>'../takeALongTimeToDoSomething'</span><span>;</span><span>

</span><span>const</span><span> exports </span><span>=</span><span> </span><span>{</span><span>
    takeALongTimeToDoSomething
</span><span>};</span><span>
</span><span>export</span><span> type </span><span>MyFirstWorker</span><span> </span><span>=</span><span> </span><span>typeof</span><span> exports</span><span>;</span><span>

expose</span><span>(</span><span>exports</span><span>);</span></code></pre>
<p>There's a number of things happening in our small worker file.  Let's go through this statement by statement:</p>
<pre><code><span>import</span><span> </span><span>{</span><span> expose </span><span>}</span><span> </span><span>from</span><span> </span><span>'comlink'</span><span>;</span></code></pre>
<p>Here we're importing the <code>expose</code> method from comlink.  Comlink’s goal is to make <em>expose</em>d values from one thread available in the other.  The <code>expose</code> method can be viewed as the comlink equivalent of <code>export</code>. It is used to export the RPC style signature of our worker.  We'll see it's use later.</p>
<pre><code><span>import</span><span> </span><span>{</span><span> takeALongTimeToDoSomething </span><span>}</span><span> </span><span>from</span><span> </span><span>'../takeALongTimeToDoSomething'</span><span>;</span></code></pre>
<p>Here we're going to import our <code>takeALongTimeToDoSomething</code> function that we wrote previously, so we can use it in our worker.</p>
<pre><code><span>const</span><span> exports </span><span>=</span><span> </span><span>{</span><span>
    takeALongTimeToDoSomething
</span><span>};</span></code></pre>
<p>Here we're creating the public facing API that we're going to expose.</p>
<pre><code><span>export</span><span> type </span><span>MyFirstWorker</span><span> </span><span>=</span><span> </span><span>typeof</span><span> exports</span><span>;</span></code></pre>
<p>We're going to want our worker to be strongly typed.  This line creates a type called <code>MyFirstWorker</code> which is derived from our <code>exports</code> object literal.</p>
<pre><code><span>expose</span><span>(</span><span>exports</span><span>);</span></code></pre>
<p>Finally we expose the <code>exports</code> using comlink.  We're done; that's our worker finished.  Now let's consume it.  Let's change our <code>index.tsx</code> file to use it.  Replace our import of <code>takeALongTimeToDoSomething</code>:</p>
<pre><code><span>import</span><span> </span><span>{</span><span> takeALongTimeToDoSomething </span><span>}</span><span> </span><span>from</span><span> </span><span>'./takeALongTimeToDoSomething'</span><span>;</span></code></pre>
<p>With an import of <code>wrap</code> from comlink that creates a local <code>takeALongTimeToDoSomething</code> function that wraps interacting with our worker:</p>
<pre><code><span>import</span><span> </span><span>{</span><span> wrap </span><span>}</span><span> </span><span>from</span><span> </span><span>'comlink'</span><span>;</span><span>

</span><span>function</span><span> takeALongTimeToDoSomething</span><span>()</span><span> </span><span>{</span><span>
    </span><span>const</span><span> worker </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>'./my-first-worker'</span><span>,</span><span> </span><span>{</span><span> name</span><span>:</span><span> </span><span>'my-first-worker'</span><span>,</span><span> type</span><span>:</span><span> </span><span>'module'</span><span> </span><span>});</span><span>
    </span><span>const</span><span> workerApi </span><span>=</span><span> wrap</span><span>&lt;</span><span>import</span><span>(</span><span>'./my-first-worker'</span><span>).</span><span>MyFirstWorker</span><span>&gt;(</span><span>worker</span><span>);</span><span>
    workerApi</span><span>.</span><span>takeALongTimeToDoSomething</span><span>();</span><span>    
</span><span>}</span></code></pre>
<p>Now we're ready to demo our application using our function offloaded into a Web Worker. It now behaves like this:</p>

<p><a href="https://2.bp.blogspot.com/-UDxm0xHbJpY/XjUrg4BwgTI/AAAAAAAATbE/F2jZ2F4nI9c05puL6zP8n6VYvrPsEOjIQCLcBGAsYHQ/s1600/non-blocking.gif" imageanchor="1"><img data-original-height="627" data-original-width="1600" height="251" src="https://2.bp.blogspot.com/-UDxm0xHbJpY/XjUrg4BwgTI/AAAAAAAATbE/F2jZ2F4nI9c05puL6zP8n6VYvrPsEOjIQCLcBGAsYHQ/s640/non-blocking.gif" width="640"></a></p><p>There's a number of exciting things to note here:</p>
<ol>
<li>The application is now non-blocking.  Our long running function is now not preventing the UI from updating</li>
<li>The functionality is lazily loaded via a <code>my-first-worker.chunk.worker.js</code> that has been created by the <code>worker-plugin</code> and <code>comlink</code>.</li>
</ol>
<h4>Using Web Workers in React</h4>
<p>The example we've showed so far demostrates how you could use Web Workers and why you might want to.  However, it's a far cry from a real world use case.  Let's take the next step and plug our Web Worker usage into our React application.  What would that look like?  Let's find out.</p>
<p>We'll return <code>index.tsx</code> back to it's initial state.  Then we'll make a simple adder function that takes some values and returns their total.  To our <code>takeALongTimeToDoSomething.ts</code> module let's add:</p>
<pre><code><span>export</span><span> </span><span>function</span><span> takeALongTimeToAddTwoNumbers</span><span>(</span><span>number1</span><span>:</span><span> number</span><span>,</span><span> number2</span><span>:</span><span> number</span><span>)</span><span> </span><span>{</span><span>
    console</span><span>.</span><span>log</span><span>(</span><span>'Start to add...'</span><span>);</span><span>
    </span><span>const</span><span> seconds </span><span>=</span><span> </span><span>5</span><span>;</span><span>
    </span><span>const</span><span> start </span><span>=</span><span> </span><span>new</span><span> </span><span>Date</span><span>().</span><span>getTime</span><span>();</span><span>
    </span><span>const</span><span> delay </span><span>=</span><span> seconds </span><span>*</span><span> </span><span>1000</span><span>;</span><span>
    </span><span>while</span><span> </span><span>(</span><span>true</span><span>)</span><span> </span><span>{</span><span>
        </span><span>if</span><span> </span><span>((</span><span>new</span><span> </span><span>Date</span><span>().</span><span>getTime</span><span>()</span><span> </span><span>-</span><span> start</span><span>)</span><span> </span><span>&gt;</span><span> delay</span><span>)</span><span> </span><span>{</span><span>
            </span><span>break</span><span>;</span><span>
        </span><span>}</span><span>
    </span><span>}</span><span>
    </span><span>const</span><span> total </span><span>=</span><span> number1 </span><span>+</span><span> number2</span><span>;</span><span>
    console</span><span>.</span><span>log</span><span>(</span><span>'Finished adding'</span><span>);</span><span>
    </span><span>return</span><span> total</span><span>;</span><span>
</span><span>}</span></code></pre>
<p>Let's start using our long running calculator in a React component.  We'll update our <code>App.tsx</code> to use this function and create a simple adder component:</p>
<pre><code><span>import</span><span> </span><span>React</span><span>,</span><span> </span><span>{</span><span> useState </span><span>}</span><span> </span><span>from</span><span> </span><span>"react"</span><span>;</span><span>
</span><span>import</span><span> </span><span>"./App.css"</span><span>;</span><span>
</span><span>import</span><span> </span><span>{</span><span> takeALongTimeToAddTwoNumbers </span><span>}</span><span> </span><span>from</span><span> </span><span>"./takeALongTimeToDoSomething"</span><span>;</span><span>

</span><span>const</span><span> </span><span>App</span><span>:</span><span> </span><span>React</span><span>.</span><span>FC </span><span>=</span><span> </span><span>()</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
  </span><span>const</span><span> </span><span>[</span><span>number1</span><span>,</span><span> setNumber1</span><span>]</span><span> </span><span>=</span><span> useState</span><span>(</span><span>1</span><span>);</span><span>
  </span><span>const</span><span> </span><span>[</span><span>number2</span><span>,</span><span> setNumber2</span><span>]</span><span> </span><span>=</span><span> useState</span><span>(</span><span>2</span><span>);</span><span>

  </span><span>const</span><span> total </span><span>=</span><span> takeALongTimeToAddTwoNumbers</span><span>(</span><span>number1</span><span>,</span><span> number2</span><span>);</span><span>

  </span><span>return</span><span> </span><span>(</span><span>
    </span><span>&lt;</span><span>div className</span><span>=</span><span>"App"</span><span>&gt;</span><span>
      </span><span>&lt;h1&gt;</span><span>Web</span><span> </span><span>Workers</span><span> </span><span>in</span><span> action</span><span>!&lt;/</span><span>h1</span><span>&gt;</span><span>

      </span><span>&lt;div&gt;</span><span>
        </span><span>&lt;label&gt;</span><span>Number</span><span> to </span><span>add</span><span>:</span><span> </span><span>&lt;/</span><span>label</span><span>&gt;</span><span>
        </span><span>&lt;</span><span>input
          type</span><span>=</span><span>"number"</span><span>
          onChange</span><span>={</span><span>e </span><span>=&gt;</span><span> setNumber1</span><span>(</span><span>parseInt</span><span>(</span><span>e</span><span>.</span><span>target</span><span>.</span><span>value</span><span>))}</span><span>
          </span><span>value</span><span>={</span><span>number1</span><span>}</span><span>
        </span><span>/&gt;</span><span>
      </span><span>&lt;/</span><span>div</span><span>&gt;</span><span>
      </span><span>&lt;div&gt;</span><span>
        </span><span>&lt;label&gt;</span><span>Number</span><span> to </span><span>add</span><span>:</span><span> </span><span>&lt;/</span><span>label</span><span>&gt;</span><span>
        </span><span>&lt;</span><span>input
          type</span><span>=</span><span>"number"</span><span>
          onChange</span><span>={</span><span>e </span><span>=&gt;</span><span> setNumber2</span><span>(</span><span>parseInt</span><span>(</span><span>e</span><span>.</span><span>target</span><span>.</span><span>value</span><span>))}</span><span>
          </span><span>value</span><span>={</span><span>number2</span><span>}</span><span>
        </span><span>/&gt;</span><span>
      </span><span>&lt;/</span><span>div</span><span>&gt;</span><span>
      </span><span>&lt;h2&gt;</span><span>Total</span><span>:</span><span> </span><span>{</span><span>total</span><span>}&lt;/</span><span>h2</span><span>&gt;</span><span>
    </span><span>&lt;/</span><span>div</span><span>&gt;</span><span>
  </span><span>);</span><span>
</span><span>};</span><span>

</span><span>export</span><span> </span><span>default</span><span> </span><span>App</span><span>;</span></code></pre>
<p>When you try it out you'll notice that entering a single digit locks the UI for 5 seconds whilst it adds the numbers. From the moment the cursor stops blinking to the moment the screen updates the UI is non-responsive:</p>

<p><a href="https://2.bp.blogspot.com/-ngQ_wdVxKYw/XjUr33bOiWI/AAAAAAAATbM/kkMzEWKCu8w0NrD6CZeyNRW8CYQ78eRzgCLcBGAsYHQ/s1600/blocking-react.gif" imageanchor="1"><img data-original-height="249" data-original-width="544" height="293" src="https://2.bp.blogspot.com/-ngQ_wdVxKYw/XjUr33bOiWI/AAAAAAAATbM/kkMzEWKCu8w0NrD6CZeyNRW8CYQ78eRzgCLcBGAsYHQ/s640/blocking-react.gif" width="640"></a></p><p>So far, so classic. Let's Web Workerify this!</p>
<p>We'll update our <code>my-first-worker/index.ts</code> to import this new function:</p>
<pre><code><span>import</span><span> </span><span>{</span><span> expose </span><span>}</span><span> </span><span>from</span><span> </span><span>"comlink"</span><span>;</span><span>
</span><span>import</span><span> </span><span>{</span><span>
  takeALongTimeToDoSomething</span><span>,</span><span>
  takeALongTimeToAddTwoNumbers
</span><span>}</span><span> </span><span>from</span><span> </span><span>"../takeALongTimeToDoSomething"</span><span>;</span><span>

</span><span>const</span><span> exports </span><span>=</span><span> </span><span>{</span><span>
  takeALongTimeToDoSomething</span><span>,</span><span>
  takeALongTimeToAddTwoNumbers
</span><span>};</span><span>
</span><span>export</span><span> type </span><span>MyFirstWorker</span><span> </span><span>=</span><span> </span><span>typeof</span><span> exports</span><span>;</span><span>

expose</span><span>(</span><span>exports</span><span>);</span></code></pre>
<p>Alongside our <code>App.tsx</code> file let's create an <code>App.hooks.ts</code> file.</p>
<pre><code><span>import</span><span> </span><span>{</span><span> wrap</span><span>,</span><span> releaseProxy </span><span>}</span><span> </span><span>from</span><span> </span><span>"comlink"</span><span>;</span><span>
</span><span>import</span><span> </span><span>{</span><span> useEffect</span><span>,</span><span> useState</span><span>,</span><span> useMemo </span><span>}</span><span> </span><span>from</span><span> </span><span>"react"</span><span>;</span><span>

</span><span>/**
 * Our hook that performs the calculation on the worker
 */</span><span>
</span><span>export</span><span> </span><span>function</span><span> useTakeALongTimeToAddTwoNumbers</span><span>(</span><span>
  number1</span><span>:</span><span> number</span><span>,</span><span>
  number2</span><span>:</span><span> number
</span><span>)</span><span> </span><span>{</span><span>
  </span><span>// We'll want to expose a wrapping object so we know when a calculation is in progress</span><span>
  </span><span>const</span><span> </span><span>[</span><span>data</span><span>,</span><span> setData</span><span>]</span><span> </span><span>=</span><span> useState</span><span>({</span><span>
    isCalculating</span><span>:</span><span> </span><span>false</span><span>,</span><span>
    total</span><span>:</span><span> </span><span>undefined</span><span> as number </span><span>|</span><span> </span><span>undefined</span><span>
  </span><span>});</span><span>

  </span><span>// acquire our worker</span><span>
  </span><span>const</span><span> </span><span>{</span><span> workerApi </span><span>}</span><span> </span><span>=</span><span> useWorker</span><span>();</span><span>

  useEffect</span><span>(()</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
    </span><span>// We're starting the calculation here</span><span>
    setData</span><span>({</span><span> isCalculating</span><span>:</span><span> </span><span>true</span><span>,</span><span> total</span><span>:</span><span> </span><span>undefined</span><span> </span><span>});</span><span>

    workerApi
      </span><span>.</span><span>takeALongTimeToAddTwoNumbers</span><span>(</span><span>number1</span><span>,</span><span> number2</span><span>)</span><span>
      </span><span>.</span><span>then</span><span>(</span><span>total </span><span>=&gt;</span><span> setData</span><span>({</span><span> isCalculating</span><span>:</span><span> </span><span>false</span><span>,</span><span> total </span><span>}));</span><span> </span><span>// We receive the result here</span><span>
  </span><span>},</span><span> </span><span>[</span><span>workerApi</span><span>,</span><span> setData</span><span>,</span><span> number1</span><span>,</span><span> number2</span><span>]);</span><span>

  </span><span>return</span><span> data</span><span>;</span><span>
</span><span>}</span><span>

</span><span>function</span><span> useWorker</span><span>()</span><span> </span><span>{</span><span>
  </span><span>// memoise a worker so it can be reused; create one worker up front</span><span>
  </span><span>// and then reuse it subsequently; no creating new workers each time</span><span>
  </span><span>const</span><span> workerApiAndCleanup </span><span>=</span><span> useMemo</span><span>(()</span><span> </span><span>=&gt;</span><span> makeWorkerApiAndCleanup</span><span>(),</span><span> </span><span>[]);</span><span>

  useEffect</span><span>(()</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
    </span><span>const</span><span> </span><span>{</span><span> cleanup </span><span>}</span><span> </span><span>=</span><span> workerApiAndCleanup</span><span>;</span><span>

    </span><span>// cleanup our worker when we're done with it</span><span>
    </span><span>return</span><span> </span><span>()</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
      cleanup</span><span>();</span><span>
    </span><span>};</span><span>
  </span><span>},</span><span> </span><span>[</span><span>workerApiAndCleanup</span><span>]);</span><span>

  </span><span>return</span><span> workerApiAndCleanup</span><span>;</span><span>
</span><span>}</span><span>

</span><span>/**
 * Creates a worker, a cleanup function and returns it
 */</span><span>
</span><span>function</span><span> makeWorkerApiAndCleanup</span><span>()</span><span> </span><span>{</span><span>
  </span><span>// Here we create our worker and wrap it with comlink so we can interact with it</span><span>
  </span><span>const</span><span> worker </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>"./my-first-worker"</span><span>,</span><span> </span><span>{</span><span>
    name</span><span>:</span><span> </span><span>"my-first-worker"</span><span>,</span><span>
    type</span><span>:</span><span> </span><span>"module"</span><span>
  </span><span>});</span><span>
  </span><span>const</span><span> workerApi </span><span>=</span><span> wrap</span><span>&lt;</span><span>import</span><span>(</span><span>"./my-first-worker"</span><span>).</span><span>MyFirstWorker</span><span>&gt;(</span><span>worker</span><span>);</span><span>

  </span><span>// A cleanup function that releases the comlink proxy and terminates the worker</span><span>
  </span><span>const</span><span> cleanup </span><span>=</span><span> </span><span>()</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
    workerApi</span><span>[</span><span>releaseProxy</span><span>]();</span><span>
    worker</span><span>.</span><span>terminate</span><span>();</span><span>
  </span><span>};</span><span>

  </span><span>const</span><span> workerApiAndCleanup </span><span>=</span><span> </span><span>{</span><span> workerApi</span><span>,</span><span> cleanup </span><span>};</span><span>

  </span><span>return</span><span> workerApiAndCleanup</span><span>;</span><span>
</span><span>}</span></code></pre>
<p>The <code>useWorker</code> and <code>makeWorkerApiAndCleanup</code> functions make up the basis of a shareable worker hooks approach.  It would take very little work to paramaterise them so this could be used elsewhere.  That's outside the scope of this post but would be extremely straightforward to accomplish.</p>
<p>Time to test!  We'll change our <code>App.tsx</code> to use the new <code>useTakeALongTimeToAddTwoNumbers</code> hook:</p>
<pre><code><span>import</span><span> </span><span>React</span><span>,</span><span> </span><span>{</span><span> useState </span><span>}</span><span> </span><span>from</span><span> </span><span>"react"</span><span>;</span><span>
</span><span>import</span><span> </span><span>"./App.css"</span><span>;</span><span>
</span><span>import</span><span> </span><span>{</span><span> useTakeALongTimeToAddTwoNumbers </span><span>}</span><span> </span><span>from</span><span> </span><span>"./App.hooks"</span><span>;</span><span>

</span><span>const</span><span> </span><span>App</span><span>:</span><span> </span><span>React</span><span>.</span><span>FC </span><span>=</span><span> </span><span>()</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
  </span><span>const</span><span> </span><span>[</span><span>number1</span><span>,</span><span> setNumber1</span><span>]</span><span> </span><span>=</span><span> useState</span><span>(</span><span>1</span><span>);</span><span>
  </span><span>const</span><span> </span><span>[</span><span>number2</span><span>,</span><span> setNumber2</span><span>]</span><span> </span><span>=</span><span> useState</span><span>(</span><span>2</span><span>);</span><span>

  </span><span>const</span><span> total </span><span>=</span><span> useTakeALongTimeToAddTwoNumbers</span><span>(</span><span>number1</span><span>,</span><span> number2</span><span>);</span><span>

  </span><span>return</span><span> </span><span>(</span><span>
    </span><span>&lt;</span><span>div className</span><span>=</span><span>"App"</span><span>&gt;</span><span>
      </span><span>&lt;h1&gt;</span><span>Web</span><span> </span><span>Workers</span><span> </span><span>in</span><span> action</span><span>!&lt;/</span><span>h1</span><span>&gt;</span><span>

      </span><span>&lt;div&gt;</span><span>
        </span><span>&lt;label&gt;</span><span>Number</span><span> to </span><span>add</span><span>:</span><span> </span><span>&lt;/</span><span>label</span><span>&gt;</span><span>
        </span><span>&lt;</span><span>input
          type</span><span>=</span><span>"number"</span><span>
          onChange</span><span>={</span><span>e </span><span>=&gt;</span><span> setNumber1</span><span>(</span><span>parseInt</span><span>(</span><span>e</span><span>.</span><span>target</span><span>.</span><span>value</span><span>))}</span><span>
          </span><span>value</span><span>={</span><span>number1</span><span>}</span><span>
        </span><span>/&gt;</span><span>
      </span><span>&lt;/</span><span>div</span><span>&gt;</span><span>
      </span><span>&lt;div&gt;</span><span>
        </span><span>&lt;label&gt;</span><span>Number</span><span> to </span><span>add</span><span>:</span><span> </span><span>&lt;/</span><span>label</span><span>&gt;</span><span>
        </span><span>&lt;</span><span>input
          type</span><span>=</span><span>"number"</span><span>
          onChange</span><span>={</span><span>e </span><span>=&gt;</span><span> setNumber2</span><span>(</span><span>parseInt</span><span>(</span><span>e</span><span>.</span><span>target</span><span>.</span><span>value</span><span>))}</span><span>
          </span><span>value</span><span>={</span><span>number2</span><span>}</span><span>
        </span><span>/&gt;</span><span>
      </span><span>&lt;/</span><span>div</span><span>&gt;</span><span>
      </span><span>&lt;h2&gt;</span><span>
        </span><span>Total</span><span>:{</span><span>" "</span><span>}</span><span>
        </span><span>{</span><span>total</span><span>.</span><span>isCalculating </span><span>?</span><span> </span><span>(</span><span>
          </span><span>&lt;em&gt;</span><span>Calculating</span><span>...&lt;/</span><span>em</span><span>&gt;</span><span>
        </span><span>)</span><span> </span><span>:</span><span> </span><span>(</span><span>
          </span><span>&lt;strong&gt;</span><span>{</span><span>total</span><span>.</span><span>total</span><span>}&lt;/</span><span>strong</span><span>&gt;</span><span>
        </span><span>)}</span><span>
      </span><span>&lt;/</span><span>h2</span><span>&gt;</span><span>
    </span><span>&lt;/</span><span>div</span><span>&gt;</span><span>
  </span><span>);</span><span>
</span><span>};</span><span>

</span><span>export</span><span> </span><span>default</span><span> </span><span>App</span><span>;</span></code></pre>
<p>Now our calculation takes place off the main thread and the UI is no longer blocked!</p>

<p><a href="https://3.bp.blogspot.com/-WOTMRZzhaVk/XjUsJTMXBxI/AAAAAAAATbU/6WXtrpk66mY6aFyxBcgvBktQScq_AhyZwCLcBGAsYHQ/s1600/non-blocking-react.gif" imageanchor="1"><img data-original-height="249" data-original-width="544" height="293" src="https://3.bp.blogspot.com/-WOTMRZzhaVk/XjUsJTMXBxI/AAAAAAAATbU/6WXtrpk66mY6aFyxBcgvBktQScq_AhyZwCLcBGAsYHQ/s640/non-blocking-react.gif" width="640"></a></p><p><a href="https://blog.logrocket.com/integrating-web-workers-in-a-react-app-with-comlink/">This post was originally published on LogRocket.</a></p>
<p><a href="https://github.com/johnnyreilly/webworkers-comlink-typescript-react">The source code for this project can be found here.</a></p>

</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>