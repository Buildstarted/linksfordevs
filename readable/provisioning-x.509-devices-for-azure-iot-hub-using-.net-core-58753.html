<!DOCTYPE html>
<html lang="en">
<head>
    <title>linksfor.dev(s)</title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        <h1>
                <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">ðŸŽ‰</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Provisioning X.509 Devices for Azure IoT Hub using .NET Core</title>
<div class="readable">
        <h1>Provisioning X.509 Devices for Azure IoT Hub using .NET Core</h1>
        <p>
by damienbod <br/>Reading time: 12-16 minutes        </p>
        <p><a href="https://damienbod.com/2020/02/20/provisioning-x-509-devices-for-azure-iot-hub-using-net-core/">https://damienbod.com/2020/02/20/provisioning-x-509-devices-for-azure-iot-hub-using-net-core/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>

							<p>This article shows how Azure <a href="https://docs.microsoft.com/en-us/azure/iot-dps/">device provisioning service</a> can be used to setup an Azure <a href="https://docs.microsoft.com/en-us/azure/iot-hub/">IoT Hub</a> and provision devices using X.509 certificates in an enrollment group. The certificates are created using the nuget package <a href="https://github.com/damienbod/AspNetCoreCertificates">CertificateManager</a>. By using this package, the X.509 certificates can be created in .NET Core and created on the fly as needed.</p>
<p><strong>Code: </strong> <a href="https://github.com/damienbod/AzureIoTHubDps" rel="nofollow">https://github.com/damienbod/AzureIoTHubDps</a></p>
<p><strong>Setting up the Project </strong></p>
<p>The demo project is a .NET Core console project, and the Microsoft.Azure.Devices nuget packages are added as well as the CertificateManager package. The Azure packages can be used for Azure DPS and also Azure IoT Hub. The <a href="https://github.com/Azure/azure-iot-sdk-csharp">Azure IoT C# SDK</a> has lots of examples, and the code in this demo was built based on these.</p>
<div><div id="highlighter_905581"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p></td><td><div><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"CertificateManager"</code> <code>Version</code><code>=</code><code>"1.0.3"</code> <code>/&gt;</code></p><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"Microsoft.Azure.Devices"</code> <code>Version</code><code>=</code><code>"1.18.4"</code> <code>/&gt;</code></p><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"Microsoft.Azure.Devices.Provisioning.Service"</code> <code>Version</code><code>=</code><code>"1.5.2"</code> <code>/&gt;</code></p><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"Microsoft.Azure.Devices.Client"</code> <code>Version</code><code>=</code><code>"1.22.0"</code> <code>/&gt;</code></p><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"Microsoft.Azure.Devices.Provisioning.Client"</code> <code>Version</code><code>=</code><code>"1.4.1"</code> <code>/&gt;</code></p><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"Microsoft.Azure.Devices.Provisioning.Transport.Amqp"</code> <code>Version</code><code>=</code><code>"1.1.10"</code> <code>/&gt;</code></p><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"Microsoft.Azure.Devices.Provisioning.Transport.Http"</code> <code>Version</code><code>=</code><code>"1.1.7"</code> <code>/&gt;</code></p><p><code>&lt;</code><code>PackageReference</code> <code>Include</code><code>=</code><code>"Microsoft.Azure.Devices.Provisioning.Transport.Mqtt"</code> <code>Version</code><code>=</code><code>"1.1.9"</code> <code>/&gt;</code></p></div></td></tr></tbody></table></div></div>
<p><strong>Creating the X.509 certificates</strong></p>
<p>A X.509 chain is created from a self signed root certificate. This certificate is then used to create the intermediate certificates which will be used to create the Azure device provisioning service enrollment groups. The certificates are exported as pfx files and also the public key in the pem format. The pem file will be used to setup the Azure IoT Hub and the Azure DPS.</p>
<div><div id="highlighter_334744"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p></td><td><div><p><code>var</code> <code>serviceProvider = </code><code>new</code> <code>ServiceCollection()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.AddCertificateManager()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.BuildServiceProvider();</code></p><p><code>string</code> <code>password = </code><code>"1234"</code><code>;</code></p><p><code>var</code> <code>cc = serviceProvider.GetService&lt;CreateCertificatesClientServerAuth&gt;();</code></p><p><code>var</code> <code>iec = serviceProvider.GetService&lt;ImportExportCertificate&gt;();</code></p><p><code>var</code> <code>dpsCa = cc.NewRootCertificate(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>DistinguishedName { CommonName = </code><code>"dpsCa"</code><code>, Country = </code><code>"CH"</code> <code>},</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>ValidityPeriod { ValidFrom = DateTime.UtcNow, ValidTo = DateTime.UtcNow.AddYears(10) },</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>3, </code><code>"dpsCa"</code><code>);</code></p><p><code>dpsCa.FriendlyName = </code><code>"developement root certificate"</code><code>;</code></p><p><code>var</code> <code>dpsIntermediate1 = cc.NewIntermediateChainedCertificate(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>DistinguishedName { CommonName = </code><code>"dpsIntermediate1"</code><code>, Country = </code><code>"CH"</code> <code>},</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>ValidityPeriod { ValidFrom = DateTime.UtcNow, ValidTo = DateTime.UtcNow.AddYears(10) },</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>2, </code><code>"dpsIntermediate1"</code><code>, dpsCa);</code></p><p><code>dpsIntermediate1.FriendlyName = </code><code>"dpsIntermediate1 certificate"</code><code>;</code></p><p><code>var</code> <code>dpsIntermediate2 = cc.NewIntermediateChainedCertificate(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>DistinguishedName { CommonName = </code><code>"dpsIntermediate2"</code><code>, Country = </code><code>"CH"</code> <code>},</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>ValidityPeriod { ValidFrom = DateTime.UtcNow, ValidTo = DateTime.UtcNow.AddYears(10) },</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>2, </code><code>"dpsIntermediate2"</code><code>, dpsCa);</code></p><p><code>dpsIntermediate2.FriendlyName = </code><code>"dpsIntermediate2 certificate"</code><code>;</code></p><p><code>var</code> <code>rootCertInPfxBtyes = iec.ExportRootPfx(password, dpsCa);</code></p><p><code>File.WriteAllBytes(</code><code>"dpsCa.pfx"</code><code>, rootCertInPfxBtyes);</code></p><p><code>var</code> <code>dpsIntermediate1Btyes = iec.ExportChainedCertificatePfx(password, dpsIntermediate1, dpsCa);</code></p><p><code>File.WriteAllBytes(</code><code>"dpsIntermediate1.pfx"</code><code>, dpsIntermediate1Btyes);</code></p><p><code>var</code> <code>dpsIntermediate2Btyes = iec.ExportChainedCertificatePfx(password, dpsIntermediate2, dpsCa);</code></p><p><code>File.WriteAllBytes(</code><code>"dpsIntermediate2.pfx"</code><code>, dpsIntermediate2Btyes);</code></p><p><code>Console.WriteLine(</code><code>"Certificates exported to pfx and cer files"</code><code>);</code></p><p><code>var</code> <code>dpsCaPEM = iec.PemExportPublicKeyCertificate(dpsCa);</code></p><p><code>File.WriteAllText(</code><code>"dpsCa.pem"</code><code>, dpsCaPEM);</code></p><p><code>var</code> <code>dpsIntermediate1PEM = iec.PemExportPublicKeyCertificate(dpsIntermediate1);</code></p><p><code>File.WriteAllText(</code><code>"dpsIntermediate1.pem"</code><code>, dpsIntermediate1PEM);</code></p><p><code>var</code> <code>dpsIntermediate2PEM = iec.PemExportPublicKeyCertificate(dpsIntermediate2);</code></p><p><code>File.WriteAllText(</code><code>"dpsIntermediate2.pem"</code><code>, dpsIntermediate2PEM);</code></p></div></td></tr></tbody></table></div></div>
<p><strong>Create an Azure Device Provisioning service</strong></p>
<p>Create a new Azure Device Provisioning service. You can use the Azure UI for this, or automate this using arm templates, or Azure cli.</p>
<p><img data-attachment-id="13325" data-permalink="https://damienbod.com/2020/02/20/provisioning-x-509-devices-for-azure-iot-hub-using-net-core/azure_dps_cert_01/" data-orig-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png" data-orig-size="1162,873" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="azure_dps_cert_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=640" src="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=640&amp;h=481" alt="" width="640" height="481" srcset="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=640&amp;h=481 640w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=150&amp;h=113 150w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=600&amp;h=451 600w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=768&amp;h=577 768w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png?w=1024&amp;h=769 1024w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_01.png 1162w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Then create an Azure IoT Hub and connect this to the Azure DPS. See the Azure docs for this.</p>
<p>Add the root certificate to the Certificates in the Azure IoT Hub and also the Azure DPS. The pem file with the certificate public key is used to do this. This also needs to be verified. Again, see the Azure documentation for this. The demo code provides a console application which creates the verify certificate for the Azure process.</p>
<p><strong>Create an Enrollment group</strong></p>
<p>An enrollment group can be created using the intermediate certificate created above. The devices will be registered to this group. This is useful, if you need to manage the devices per group, for example per customer, country, etc. </p>
<div><div id="highlighter_764490"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p></td><td><div><p><code>public</code> <code>async</code> <code>Task CreateDpsEnrollmentGroupAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>string</code> <code>enrollmentGroupId,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>X509Certificate2 pemCertificate)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation(</code><code>"Starting CreateDpsEnrollmentGroupAsync..."</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation(</code><code>"Creating a new enrollmentGroup..."</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Attestation attestation = X509Attestation.CreateFromRootCertificates(pemCertificate);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>EnrollmentGroup enrollmentGroup = </code><code>new</code> <code>EnrollmentGroup(enrollmentGroupId, attestation)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ProvisioningStatus = ProvisioningStatus.Enabled,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ReprovisionPolicy = </code><code>new</code> <code>ReprovisionPolicy</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>MigrateDeviceData = </code><code>false</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>UpdateHubAssignment = </code><code>true</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Capabilities = </code><code>new</code> <code>DeviceCapabilities</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>IotEdge = </code><code>false</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>InitialTwinState = </code><code>new</code> <code>TwinState(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>TwinCollection(</code><code>"{ "updatedby":""</code> <code>+ </code><code>"damien"</code> <code>+ </code><code>"", "timeZone":""</code> <code>+ TimeZoneInfo.Local.DisplayName + </code><code>"" }"</code><code>),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>TwinCollection(</code><code>"{ }"</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>};</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation($</code><code>"{enrollmentGroup}"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation($</code><code>"Adding new enrollmentGroup..."</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>EnrollmentGroup enrollmentGroupResult = </code><code>await</code> <code>_provisioningServiceClient</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.CreateOrUpdateEnrollmentGroupAsync(enrollmentGroup)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.ConfigureAwait(</code><code>false</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation($</code><code>"EnrollmentGroup created with success."</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation($</code><code>"{enrollmentGroupResult}"</code><code>);</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The method <em>CreateDpsEnrollmentGroupAsync</em> can be used to create a new enrollment group.</p>
<div><div id="highlighter_638535"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p></td><td><div><p><code>/// -- DPS Create Enrollment Group</code></p><p><code>var</code> <code>dpsEnrollmentGroup = sp.GetService&lt;DpsEnrollmentGroup&gt;();</code></p><p><code>var</code> <code>dpsEnrollmentCertificate = </code></p><p><code>&nbsp;&nbsp;</code><code>new</code> <code>X509Certificate2($</code><code>"{pathToCerts}dpsIntermediate1.pem"</code><code>);</code></p><p><code>await</code> <code>dpsEnrollmentGroup</code></p><p><code>&nbsp;&nbsp;&nbsp;</code><code>.CreateDpsEnrollmentGroupAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"dpsIntermediate1"</code><code>, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>dpsEnrollmentCertificate</code></p><p><code>&nbsp;&nbsp;&nbsp;</code><code>);</code></p></div></td></tr></tbody></table></div></div>
<p>The enrollment group can be viewed in the Azure portal UI.</p>
<p><img data-attachment-id="13328" data-permalink="https://damienbod.com/2020/02/20/provisioning-x-509-devices-for-azure-iot-hub-using-net-core/azure_dps_cert_02/" data-orig-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png" data-orig-size="738,1244" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="azure_dps_cert_02" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png?w=356" data-large-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png?w=607" src="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png?w=640&amp;h=1079" alt="" width="640" height="1079" srcset="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png?w=640&amp;h=1079 640w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png?w=89&amp;h=150 89w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png?w=356&amp;h=600 356w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_02.png 738w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>It would also be possible to create the certificate on the fly, and use this to create the Azure DPS enrollment group. Then this process could be automated. You would need to save the certificate somewhere for later use, otherwise you cannot add device registrations to the group.</p>
<div><div id="highlighter_182804"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p></td><td><div><p><code>private</code> <code>static</code> <code>async</code> <code>Task&lt;X509Certificate2&gt; CreateEnrollmentGroup(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>string</code> <code>enrollmentGroup, X509Certificate2 parentCert)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>cc = _sp.GetService&lt;CreateCertificatesClientServerAuth&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>dpsEnrollmentGroup = _sp.GetService&lt;DpsEnrollmentGroup&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>iec = _sp.GetService&lt;ImportExportCertificate&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>enrollmentGroupCert = cc.NewIntermediateChainedCertificate(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>DistinguishedName { CommonName = enrollmentGroup },</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>ValidityPeriod { ValidFrom = DateTime.UtcNow, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ValidTo = DateTime.UtcNow.AddYears(10) },</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>2, enrollmentGroup, parentCert);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>enrollmentGroupCert.FriendlyName = $</code><code>"{enrollmentGroup} certificate"</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>enrollmentGroupPEM = </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>iec.PemExportPublicKeyCertificate(enrollmentGroupCert);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>cert = iec.PemImportCertificate(enrollmentGroupPEM);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await</code> <code>dpsEnrollmentGroup.CreateDpsEnrollmentGroupAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>enrollmentGroup, </code><code>new</code> <code>X509Certificate2(cert));</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>enrollmentGroupCert;</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p><strong>Enroll a device</strong></p>
<p>The device can be created be creating a X.509 certificate using the device ID (which must be lowercase). The device is registered to the enrollment group, and this then creates a new Azure IoT Hub device.</p>
<div><div id="highlighter_529761"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></td><td><div><p><code>private</code> <code>static</code> <code>async</code> <code>Task&lt;X509Certificate2&gt; CreateDeviceAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>string</code> <code>deviceId, X509Certificate2 parentCertificate, </code><code>string</code> <code>password)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>deviceId = deviceId.ToLower();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>cc = _sp.GetService&lt;CreateCertificatesClientServerAuth&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>iec = _sp.GetService&lt;ImportExportCertificate&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>dpsRegisterDevice = _sp.GetService&lt;DpsRegisterDevice&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>device = cc.NewDeviceChainedCertificate(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>DistinguishedName { CommonName = deviceId },</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>ValidityPeriod { ValidFrom = DateTime.UtcNow, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>ValidTo = DateTime.UtcNow.AddYears(10) },</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>deviceId, parentCertificate);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>device.FriendlyName = $</code><code>"IoT device {deviceId}"</code><code>;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>deviceInPfxBytes = iec.ExportChainedCertificatePfx(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>password, device, parentCertificate);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>deviceCert = </code><code>new</code> <code>X509Certificate2(deviceInPfxBytes, password);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>await</code> <code>dpsRegisterDevice.RegisterDeviceAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>deviceCert, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>parentCertificate);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>device;</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The RegisterDeviceAsync method registers the device with the certificate using the device certificate and the enrollment certificate.</p>
<div><div id="highlighter_669590"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p></td><td><div><p><code>using</code> <code>Microsoft.Azure.Devices.Provisioning.Client;</code></p><p><code>using</code> <code>Microsoft.Azure.Devices.Provisioning.Client.Transport;</code></p><p><code>using</code> <code>Microsoft.Azure.Devices.Shared;</code></p><p><code>using</code> <code>Microsoft.Extensions.Configuration;</code></p><p><code>using</code> <code>Microsoft.Extensions.Logging;</code></p><p><code>using</code> <code>System.Collections.Generic;</code></p><p><code>using</code> <code>System.Security.Cryptography.X509Certificates;</code></p><p><code>using</code> <code>System.Threading.Tasks;</code></p><p><code>namespace</code> <code>DpsManagement</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>class</code> <code>DpsRegisterDevice</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>IConfiguration Configuration { </code><code>get</code><code>; </code><code>set</code><code>; }</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>readonly</code> <code>ILogger&lt;DpsRegisterDevice&gt; _logger;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>DpsRegisterDevice(IConfiguration config, ILoggerFactory loggerFactory)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Configuration = config;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger = loggerFactory.CreateLogger&lt;DpsRegisterDevice&gt;();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>async</code> <code>Task&lt;DeviceRegistrationResult&gt; RegisterDeviceAsync(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>X509Certificate2 deviceCertificate,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>X509Certificate2 enrollmentCertificate)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>scopeId = Configuration[</code><code>"ScopeId"</code><code>];</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>//// The cert from the enrollment group is required for group registrations</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>using</code> <code>(</code><code>var</code> <code>security = </code><code>new</code> <code>SecurityProviderX509Certificate(deviceCertificate,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>new</code> <code>X509Certificate2Collection(enrollmentCertificate)))</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>using</code> <code>(</code><code>var</code> <code>transport = </code><code>new</code> <code>ProvisioningTransportHandlerAmqp(TransportFallbackType.TcpOnly))</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>client = ProvisioningDeviceClient.Create(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"global.azure-devices-provisioning.net"</code><code>, scopeId, security, transport);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>result = </code><code>await</code> <code>client.RegisterAsync();</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation($</code><code>"DPS client created: {result}"</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>result;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The registered devices can be viewed in the enrollment group.</p>
<p><img data-attachment-id="13334" data-permalink="https://damienbod.com/2020/02/20/provisioning-x-509-devices-for-azure-iot-hub-using-net-core/azure_dps_cert_03/" data-orig-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png" data-orig-size="1158,803" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="azure_dps_cert_03" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=640" src="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=640&amp;h=444" alt="" width="640" height="444" srcset="https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=640&amp;h=444 640w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=150&amp;h=104 150w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=600&amp;h=416 600w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=768&amp;h=533 768w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png?w=1024&amp;h=710 1024w, https://damienbod.files.wordpress.com/2020/02/azure_dps_cert_03.png 1158w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Disable a device in the Azure IoT Hub</strong></p>
<p>If an Azure IoT Hub device needs to be disabled, the RegistryManager can be used to update the device on the hub. The device status is set to DeviceStatus.Disabled. You could also delete the device which would also prevent data from being sent.</p>
<div><div id="highlighter_551547"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p></td><td><div><p><code>public</code> <code>async</code> <code>Task DisableDeviceAsync(</code><code>string</code> <code>deviceId)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>device = </code><code>await</code> <code>_registryManager.GetDeviceAsync(deviceId);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>device.Status = DeviceStatus.Disabled;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>device = </code><code>await</code> <code>_registryManager.UpdateDeviceAsync(device);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_logger.LogInformation($</code><code>"iot hub device disabled&nbsp; {device}"</code><code>);</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p><strong>Disable an enrollment group</strong></p>
<p>The enrollment can be disabled, which prevents new devices from being registered. The ProvisioningServiceClient is used for this. This will not prevent data from being sent on the Azure IoT Hub devices already registered.</p>
<div><div id="highlighter_15130"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p></td><td><div><p><code>public</code> <code>async</code> <code>Task DisableEnrollmentGroupAsync(</code><code>string</code> <code>enrollmentGroupId)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>groupEnrollment = </code><code>await</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_provisioningServiceClient</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.GetEnrollmentGroupAsync(enrollmentGroupId);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(groupEnrollment.ProvisioningStatus.Value != ProvisioningStatus.Disabled)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>groupEnrollment.ProvisioningStatus = ProvisioningStatus.Disabled;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var</code> <code>update = </code><code>await</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>_provisioningServiceClient</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.CreateOrUpdateEnrollmentGroupAsync(groupEnrollment);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>It is very easy to setup a certificate chain, and add Azure IoT devices using the Device Provisioning service. Now that this is setup, the next step would be to define how the devices can be updated and send data from the cloud, and to the cloud. Then the data from the devices can be consumed and routed to the next Azure service.</p>
<p><strong>Links</strong></p>
<p><a href="https://docs.microsoft.com/en-us/azure/iot-hub/" rel="nofollow">https://docs.microsoft.com/en-us/azure/iot-hub/</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/iot-dps/" rel="nofollow">https://docs.microsoft.com/en-us/azure/iot-dps/</a></p>
<p><a href="https://github.com/damienbod/AspNetCoreCertificates" rel="nofollow">https://github.com/damienbod/AspNetCoreCertificates</a></p>
<p><a href="https://github.com/Azure/azure-iot-sdk-csharp" rel="nofollow">https://github.com/Azure/azure-iot-sdk-csharp</a></p>

							
							
						</div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>