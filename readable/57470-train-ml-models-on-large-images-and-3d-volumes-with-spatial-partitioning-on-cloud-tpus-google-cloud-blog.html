<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Train ML models on large images and 3D volumes with spatial partitioning on Cloud TPUs | Google Cloud Blog -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Train ML models on large images and 3D volumes with spatial partitioning on Cloud TPUs | Google Cloud Blog</h1>
    <div class="wrapper"><page-loading></page-loading><site-header></site-header><p class="content"><router-outlet></router-outlet><dynamic-page class="ng-star-inserted"><article-page class="ng-star-inserted"><main id="jump-content"><article><article-header-block><section class="h-c-page article-hero"></section></article-header-block><article-aspect-image-block class="ng-star-inserted"><figure class="article-image--full-aspect article-module"></figure></article-aspect-image-block><div class="h-c-page article-meta__page"><div class="h-c-grid"><div class="article-meta__content h-c-grid__col h-c-grid__col--8 h-c-grid__col--offset-2 h-c-grid__col-l--2 h-c-grid__col-l--offset-1"><div class="ng-star-inserted"><article-author-block><div><div class="article-meta__author ng-star-inserted"><div class="article-meta__author-title"> Software Engineer, Google Brain </div></div><div class="article-meta__author ng-star-inserted"><div class="article-meta__author-title"> Software Engineer, Google Brain </div></div><div class="article-meta__author ng-star-inserted"><div class="article-meta__author-title"> Software Engineer, DeepMind </div></div><span class="article-meta__published-at"> September 12, 2019 </span></div></article-author-block></div></div></div><article-cta><div class="h-c-grid article-meta__cta ng-star-inserted"><div class="article-meta__content h-c-grid__col h-c-grid__col--8 h-c-grid__col--offset-2 h-c-grid__col-l--2 h-c-grid__col-l--offset-1"><p class="utility-copy article-meta__cta-copy"><span class="ng-star-inserted">Get $300 free credit to spend over 12 months.</span></p><a class="h-c-button h-c-button--primary article-meta__cta-anchor" href="https://cloud.google.com/free/"><span class="ng-star-inserted">Free Trial</span></a></div></div></article-cta></div><article-share-block></article-share-block><article-sticky-share-block></article-sticky-share-block><section class="uni-container"><div class="uni-wrapper"><div class="uni-content uni-blog-article-container uni-tombstone"><article-content-stream-block class="ng-star-inserted"><div class="ng-star-inserted"><div class="module--text h-c-page ng-star-inserted"><div class="h-c-grid"><div class="uni-paragraph h-c-grid__col h-c-grid__col--8 h-c-grid__col-m--6 h-c-grid__col-l--6 h-c-grid__col--offset-2 h-c-grid__col-m--offset-3 h-c-grid__col-l--offset-3"><paragraph-block class="ng-star-inserted"><div class="rich-text"><p><a href="https://en.wikipedia.org/wiki/Convolutional_neural_network">Convolutional neural networks</a> (CNNs) are the foundation of recent advances in image classification, object detection, image segmentation, and many other computer vision applications. However, practitioners often encounter a problem when they try to train and run state-of-the-art computer vision models on larger input images: their CNN no longer fits on a single accelerator chip!</p><p>To overcome this limitation, Cloud TPUs now provide a new <a href="https://github.com/tensorflow/estimator/blob/master/tensorflow_estimator/python/estimator/tpu/spatial_partitioning_api.md">spatial partitioning capability</a> that makes it possible to split up a single model across several TPU chips to process much larger input data sizes. This technique is general enough to handle large 2D images as well as 3D volumes, which makes it valuable for applications ranging from object detection for autonomous navigation to analysis of 3D medical scans. For example, Mayo Clinic has used spatial partitioning on Cloud TPU Pods to segment CT scans at their full 256x256x256 pixel resolution instead of being forced to downsample, which can cause accuracy loss and other issues.</p><p>At Google, we have been using <a href="https://github.com/tensorflow/estimator/blob/master/tensorflow_estimator/python/estimator/tpu/spatial_partitioning_api.md">spatial partitioning</a> for many different applications, including medical image segmentation, video content analysis, and object detection for autonomous driving.&#xA0;</p><p><b>Cloud TPU spatial partitioning</b> allows you to seamlessly scale your model by leveraging 2, 4, 8, or even 16 cores for training ML models that would otherwise not fit into the memory on a single TPU core. When using more than one core for your model, our <a href="https://www.tensorflow.org/xla">XLA compiler</a> will automatically handle the necessary communications among all cores. This means there are no code changes required! All you need to do is configure how the inputs to the model should be partitioned.</p><p>Below is an example of how one big image can be split up into four smaller images that are then processed separately on individual TPU cores.</p></div></paragraph-block></div></div></div></div><div class="ng-star-inserted"><article-image-block class="ng-star-inserted"><div class="article-module h-c-page"><div class="h-c-grid"><figure class="article-image--large h-c-grid__col h-c-grid__col--6 h-c-grid__col--offset-3"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/four-way_spatial_partitioning.max-600x600.png" sizes srcset alt="four-way spatial partitioning.png" class="ng-star-inserted"><img src alt class="ng-star-inserted"></figure></div></div></article-image-block></div><div class="ng-star-inserted"><div class="module--text h-c-page ng-star-inserted"><div class="h-c-grid"><div class="uni-paragraph h-c-grid__col h-c-grid__col--8 h-c-grid__col-m--6 h-c-grid__col-l--6 h-c-grid__col--offset-2 h-c-grid__col-m--offset-3 h-c-grid__col-l--offset-3"><paragraph-block class="ng-star-inserted"><div class="rich-text"><p>The TPU spatial partitioning API is supported in TPUEstimator; to use it, you specify in TPUConfig how to partition each input tensor.&#xA0;</p><p>The following is a TPUConfig example of four-way spatial partitioning for an image classification model. This configuration will split the features tensor into four parts along the height dimension (assuming the tensor has shape [batch, height, width, channel]).</p></div></paragraph-block></div></div></div></div><div class="ng-star-inserted"><div class="module--text h-c-page ng-star-inserted"><div class="h-c-grid"><div class="uni-paragraph h-c-grid__col h-c-grid__col--8 h-c-grid__col-m--6 h-c-grid__col-l--6 h-c-grid__col--offset-2 h-c-grid__col-m--offset-3 h-c-grid__col-l--offset-3"><article-code-block class="ng-star-inserted"><pre> <code class="ng-star-inserted">tpu_config=tpu_config.TPUConfig(</code><code class="ng-star-inserted">    iterations_per_loop=100,</code><code class="ng-star-inserted">    num_cores_per_replica=4,</code><code class="ng-star-inserted">    per_host_input_for_training=tpu_config.InputPipelineConfig.PER_HOST_V2,</code><code class="ng-star-inserted">    input_partition_dims=[[1, 4, 1, 1], None]])</code>
</pre></article-code-block></div></div></div></div><div class="ng-star-inserted"><div class="module--text h-c-page ng-star-inserted"><div class="h-c-grid"><div class="uni-paragraph h-c-grid__col h-c-grid__col--8 h-c-grid__col-m--6 h-c-grid__col-l--6 h-c-grid__col--offset-2 h-c-grid__col-m--offset-3 h-c-grid__col-l--offset-3"><paragraph-block class="ng-star-inserted"><div class="rich-text"><p><b>2D object detection<br></b><a href="https://github.com/tensorflow/tpu/tree/master/models/official/detection">RetinaNet</a> is an object detection model that localizes objects in images with a bounding box and also classifies the identified objects. The largest image size that fits on a single Cloud TPU core (with per-device batch 8) is 1280x1280. With spatial partitioning, we can train 4x larger images across the eight TPU cores of a single Cloud TPU device.&#xA0;</p><p>The table below shows that spatial partitioning can also be used across a multi-host Cloud TPU Pod slice to accommodate an even larger image size (2560x2560). By automatically distributing all of the necessary processing across 64 TPU cores, the overall step time remains low even when working with a much larger image:</p></div></paragraph-block></div></div></div></div><div class="ng-star-inserted"><article-image-block class="ng-star-inserted"><div class="article-module h-c-page"><div class="h-c-grid"><figure class="article-image--large h-c-grid__col h-c-grid__col--6 h-c-grid__col--offset-3"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/2D_object_detection.0999064219990372.max-2000x2000.png" sizes srcset alt="2D object detection.png" class="ng-star-inserted"><img src alt class="ng-star-inserted"></figure></div></div></article-image-block></div><div class="ng-star-inserted"><div class="module--text h-c-page ng-star-inserted"><div class="h-c-grid"><div class="uni-paragraph h-c-grid__col h-c-grid__col--8 h-c-grid__col-m--6 h-c-grid__col-l--6 h-c-grid__col--offset-2 h-c-grid__col-m--offset-3 h-c-grid__col-l--offset-3"><paragraph-block class="ng-star-inserted"><div class="rich-text"><p><b>3D image segmentation<br></b><a href="https://github.com/tensorflow/tpu/tree/master/models/official/unet3d">3D UNet</a> is a popular dense 3D segmentation model which has been widely used in the medical imaging domain. The original resolution for CT images can be as large as 256x256x256, which is too large to fit into a single Cloud TPU core. In the past, medical researchers would typically need to downsample the input volume to 128x128x128, potentially giving up accuracy in the process. With Cloud TPU spatial partitioning, no compromise is necessary: 16-way spatial partitioning makes it possible to process CT image scans at the the full input resolution of 256x256x256.</p><p>The table below shows that spatial partitioning across 128 TPU cores makes it possible to process a full-resolution 256x256x256 CT scan sample even faster than a 128x128x128 sample can be processed on a smaller number of cores.</p></div></paragraph-block></div></div></div></div><div class="ng-star-inserted"><article-image-block class="ng-star-inserted"><div class="article-module h-c-page"><div class="h-c-grid"><figure class="article-image--large h-c-grid__col h-c-grid__col--6 h-c-grid__col--offset-3"><img src="https://storage.googleapis.com/gweb-cloudblog-publish/images/3D_image_segmentation.0999064019990386.max-2000x2000.png" sizes srcset alt="3D image segmentation.png" class="ng-star-inserted"><img src alt class="ng-star-inserted"></figure></div></div></article-image-block></div><div class="ng-star-inserted"><div class="module--text h-c-page ng-star-inserted"><div class="h-c-grid"><div class="uni-paragraph h-c-grid__col h-c-grid__col--8 h-c-grid__col-m--6 h-c-grid__col-l--6 h-c-grid__col--offset-2 h-c-grid__col-m--offset-3 h-c-grid__col-l--offset-3"><paragraph-block class="ng-star-inserted"><div class="rich-text"><p>To learn how to configure spatial partitioning properly for your applications, consult this <a href="https://github.com/tensorflow/estimator/blob/master/tensorflow_estimator/python/estimator/tpu/spatial_partitioning_api.md">guide</a>. You can also try out our reference models (<a href="https://github.com/tensorflow/tpu/tree/master/models/official/detection">RetinaNet</a>, <a href="https://github.com/tensorflow/tpu/tree/master/models/official/unet3d">3D UNet</a>) to train 2D object detection and 3D image segmentation models with spatial partitioning enabled.</p><p><b>Acknowledgements<br></b>Many thanks to our collaborators Panagiotis Korfiatis, Ph.D., and Daniel Blezek, Ph.D., from Mayo Clinic for providing the initial 3D UNet model and training data.</p><p>Thanks also to those who contributed to this post and who helped implement spatial partitioning on Cloud TPUs, including Zak Stone, Wes Wahlin, Xiaodan Song, Greg Mikels, Yeqing Li, Le Hou, Chiachen Chou, and Allen Wang.</p></div></paragraph-block><span class="tombstone ng-star-inserted"></span></div></div></div></div></article-content-stream-block><article-tag-list-block class="ng-star-inserted"><div class="uni-blog-article-tags ng-star-inserted"></div></article-tag-list-block></div><related-articles-block class="ng-tns-c27-1"></related-articles-block><related-articles-drawer-block></related-articles-drawer-block></div></section></article></main></article-page></dynamic-page></p><site-footer><footer class="h-c-footer h-c-footer--topmargin h-c-footer--standard h-has-social" id="footer-standard"></footer></site-footer></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>