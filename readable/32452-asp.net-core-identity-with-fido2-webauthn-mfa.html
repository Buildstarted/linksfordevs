<!DOCTYPE html>
<html lang="en">
<head>
    <title>
ASP.NET Core Identity with Fido2 WebAuthn&#xA0;MFA -
linksfor.dev(s)
    </title>
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>ASP.NET Core Identity with Fido2 WebAuthn&#xA0;MFA</h1>
    <div class="entry-content"> <p>This article shows how Fido2 WebAuthn could be used as 2FA and integrated into an ASP.NET Core Identity application. The Fido2 WebAuthn is implemented using the <a href="https://github.com/abergs/fido2-net-lib">fido2-net-lib</a> Nuget package, and demo code created by <a href="https://github.com/abergs">Anders &#xC5;berg</a>. The application is implemented using <a href="https://docs.microsoft.com/en-us/aspnet/core/?view=aspnetcore-3.0">ASP.NET Core 3.0</a> with Identity. For information about <a href="https://fidoalliance.org/fido2/">Fido2 </a>and <a href="https://www.w3.org/TR/webauthn/">WebAuthn</a>, please refer to the links at the bottom.</p>
<p><strong>Code:</strong> <a href="https://github.com/damienbod/AspNetCoreIdentityFido2Mfa">https://github.com/damienbod/AspNetCoreIdentityFido2Mfa</a></p>
<p><strong>Creating the ASP.NET Core Application with Identity</strong></p>
<p>The application was created using the ASP.NET Core 3.0 Razor Page template with Identity (Individual User Accounts). </p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_01.png?w=640" alt width="640" class="alignnone size-full wp-image-12623" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_01.png?w=640&amp;h=412 640w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_01.png?w=1280&amp;h=824 1280w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_01.png?w=150&amp;h=96 150w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_01.png?w=600&amp;h=386 600w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_01.png?w=768&amp;h=494 768w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_01.png?w=1024&amp;h=659 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>The following NuGet packages were added. Fido2 is used to implement the Fido2 2FA. Microsoft.AspNetCore.Mvc.NewtonsoftJson is required for the serialization of the Fido requests, responses.</p>
<pre class="brush: xml; title: ; notranslate">
&lt;Project Sdk=&quot;Microsoft.NET.Sdk.Web&quot;&gt;

  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;netcoreapp3.0&lt;/TargetFramework&gt;
    &lt;UserSecretsId&gt;aspnet-AspNetCoreIdentityFido2Mfa-590BDC19-E82D-4E23-9F2E-346DA31B5198&lt;/UserSecretsId&gt;
  &lt;/PropertyGroup&gt;

  &lt;ItemGroup&gt;
    &lt;PackageReference Include=&quot;Fido2&quot; Version=&quot;1.0.1&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore&quot; Version=&quot;3.0.0-preview7.19365.7&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Identity.EntityFrameworkCore&quot; Version=&quot;3.0.0-preview7.19365.7&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Identity.UI&quot; Version=&quot;3.0.0-preview7.19365.7&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Mvc.NewtonsoftJson&quot; Version=&quot;3.0.0-preview7.19365.7&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.EntityFrameworkCore.SqlServer&quot; Version=&quot;3.0.0-preview7.19362.6&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.EntityFrameworkCore.Tools&quot; Version=&quot;3.0.0-preview7.19362.6&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.Extensions.Logging.Debug&quot; Version=&quot;3.0.0-preview7.19362.4&quot; /&gt;
    &lt;PackageReference Include=&quot;Microsoft.VisualStudio.Web.CodeGeneration.Design&quot; Version=&quot;3.0.0-preview7-19378-04&quot; /&gt;
  &lt;/ItemGroup&gt;

&lt;/Project&gt;
</pre>
<p>The Identity UI Pages were then scaffolded into the project.</p>
<p><strong>Adding the 2FA using Fido2</strong></p>
<p>Fido2 with the YubiKey 5 Series is used as a 2FA for Identity. For this to work, the user needs to be able to register and activate the Fido2 2FA, then the user can login using the Fido2 2FA and identity. The application also needs a way to deactivate or remove the 2FA.</p>
<p>The demo project from <a href="https://github.com/abergs/fido2-net-lib">https://github.com/abergs/fido2-net-lib</a> was used to implement the Fido2 logic and also the nuget package. See the docs in the repo.</p>
<p>First the Javascript scripts were added to the wwwroot. <a href="https://github.com/abergs/fido2-net-lib/blob/master/Demo/wwwroot/js/mfa.login.js">mfa.login.js</a> and <a href="https://github.com/abergs/fido2-net-lib/blob/master/Demo/wwwroot/js/mfa.register.js">mfa.register.js</a> plus the 2 required script were added. The scripts were then changed to match the Razor Page templates and the identity requirements.</p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_02.png?w=569" alt class="alignnone size-full wp-image-12634" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_02.png 569w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_02.png?w=150 150w" sizes="(max-width: 569px) 100vw, 569px"></p>
<p>These scripts depend on other npm packages, CDNs. These were added to the _Layout.cshtml.</p>
<pre class="brush: xml; title: ; notranslate">
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
    &lt;title&gt;@ViewData[&quot;Title&quot;] - AspNetCoreIdentityFido2Mfa&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;~/lib/bootstrap/dist/css/bootstrap.css&quot; /&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;~/css/site.css&quot; /&gt;

    &lt;link href=&quot;https://fonts.googleapis.com/css?family=Work+Sans&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js&quot; integrity=&quot;sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;https://cdn.jsdelivr.net/npm/sweetalert2&quot;&gt;&lt;/script&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.10.1/sweetalert2.min.css&quot; /&gt;
    &lt;script defer src=&quot;https://use.fontawesome.com/releases/v5.3.1/js/all.js&quot;&gt;&lt;/script&gt;

&lt;/head&gt;
</pre>
<p><strong>Register Fido 2FA</strong></p>
<p>A Fido2Mfa Razor Page view was created and added to the Identity/Account/Manage folder. The page uses the logged in user. The page can only be accessed when the user has already logged in. The page is used to activate and register the Fido2 device.</p>
<pre class="brush: xml; title: ; notranslate">
@page &quot;/Fido2Mfa/{handler?}&quot;
@using Microsoft.AspNetCore.Identity
@inject SignInManager&lt;IdentityUser&gt; SignInManager
@inject UserManager&lt;IdentityUser&gt; UserManager
@model AspNetCoreIdentityFido2Mfa.Areas.Identity.Pages.Account.Manage.MfaModel
@{
    Layout = &quot;_Layout.cshtml&quot;;
    ViewData[&quot;Title&quot;] = &quot;Two-factor authentication (2FA)&quot;;
    ViewData[&quot;ActivePage&quot;] = ManageNavPages.Fido2Mfa;
}

&lt;h4&gt;@ViewData[&quot;Title&quot;]&lt;/h4&gt;
&lt;div class=&quot;section&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;h1 class=&quot;title is-1&quot;&gt;2FA/MFA&lt;/h1&gt;
        &lt;div class=&quot;content&quot;&gt;&lt;p&gt;This is scenario where we just want to use FIDO as the MFA. The user register and logins with their username and password. For demo purposes, we trigger the MFA registering on sign up.&lt;/p&gt;&lt;/div&gt;
        &lt;div class=&quot;notification is-danger&quot; style=&quot;display:none&quot;&gt;
            Please note: Your browser does not seem to support WebAuthn yet. &lt;a href=&quot;https://caniuse.com/#search=webauthn&quot; target=&quot;_blank&quot;&gt;Supported browsers&lt;/a&gt;
        &lt;/div&gt;

        &lt;div class=&quot;columns&quot;&gt;
            &lt;div class=&quot;column is-4&quot;&gt;

                &lt;h3 class=&quot;title is-3&quot;&gt;Add a Fido2 MFA&lt;/h3&gt;
                &lt;form action=&quot;/Fido2Mfa&quot; method=&quot;post&quot; id=&quot;register&quot;&gt;
                    &lt;div class=&quot;field&quot;&gt;
                        &lt;label class=&quot;label&quot;&gt;Username&lt;/label&gt;
                        &lt;div class=&quot;control has-icons-left has-icons-right&quot;&gt;
                            &lt;input class=&quot;form-control&quot; type=&quot;text&quot; readonly placeholder=&quot;email&quot; value=&quot;@User.Identity.Name&quot; name=&quot;username&quot; required&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;

                    &lt;div class=&quot;field&quot; style=&quot;margin-top:10px;&quot;&gt;
                        &lt;div class=&quot;control&quot;&gt;
                            &lt;button class=&quot;btn btn-primary&quot;&gt;Add Fido2 MFA&lt;/button&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;


    &lt;/div&gt;
&lt;/div&gt;

&lt;script src=&quot;~/js/helpers.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;~/js/instant.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;~/js/mfa.register.js&quot;&gt;&lt;/script&gt;
</pre>
<p>The mfa.register.js uses the RegisterFido2Controller to make the Credential Options and to make the Credential. If successful, 2FA is enabled for the Identity using the Identity UserManager. </p>
<pre class="brush: csharp; title: ; notranslate">
using System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;
using Fido2NetLib.Objects;
using Fido2NetLib;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;
using static Fido2NetLib.Fido2;
using System.IO;
using Microsoft.AspNetCore.Identity;

namespace AspNetCoreIdentityFido2Mfa
{

    [Route(&quot;api/[controller]&quot;)]
    public class RegisterFido2Controller : Controller
    {
        private Fido2 _lib;
        public static IMetadataService _mds;
        private string _origin;
        private readonly Fido2Storage _fido2Storage;
        private readonly UserManager&lt;IdentityUser&gt; _userManager;

        public RegisterFido2Controller(IConfiguration config, Fido2Storage fido2Storage, UserManager&lt;IdentityUser&gt; userManager)
        {
            _userManager = userManager;
            _fido2Storage = fido2Storage;
            var MDSAccessKey = config[&quot;fido2:MDSAccessKey&quot;];
            var MDSCacheDirPath = config[&quot;fido2:MDSCacheDirPath&quot;] ?? Path.Combine(Path.GetTempPath(), &quot;fido2mdscache&quot;); 
            _mds = string.IsNullOrEmpty(MDSAccessKey) ? null : MDSMetadata.Instance(MDSAccessKey, MDSCacheDirPath);
            if (null != _mds)
            {
                if (false == _mds.IsInitialized())
                    _mds.Initialize().Wait();
            }
            _origin = config[&quot;fido2:origin&quot;];
            if(_origin == null)
            {
                _origin = &quot;https://localhost:44388&quot;;
            }

            var domain = config[&quot;fido2:serverDomain&quot;];
            if (domain == null)
            {
                domain = &quot;localhost&quot;;
            }

            _lib = new Fido2(new Fido2Configuration()
            {
                ServerDomain = domain,
                ServerName = &quot;Fido2IdentityMfa&quot;,
                Origin = _origin,
                // Only create and use Metadataservice if we have an acesskey
                MetadataService = _mds,
                TimestampDriftTolerance = config.GetValue&lt;int&gt;(&quot;fido2:TimestampDriftTolerance&quot;)
            });
        }

        private string FormatException(Exception e)
        {
            return string.Format(&quot;{0}{1}&quot;, e.Message, e.InnerException != null ? &quot; (&quot; + e.InnerException.Message + &quot;)&quot; : &quot;&quot;);
        }

        [HttpPost]
        [Route(&quot;/makeCredentialOptions&quot;)]
        public async Task&lt;JsonResult&gt; MakeCredentialOptions([FromForm] string username, [FromForm] string displayName, [FromForm] string attType, [FromForm] string authType, [FromForm] bool requireResidentKey, [FromForm] string userVerification)
        {
            try
            {
                if (string.IsNullOrEmpty(username))
                {
                    username = $&quot;{displayName} (Usernameless user created at {DateTime.UtcNow})&quot;;
                }

                var identityUser = await _userManager.FindByEmailAsync(username);
                var user = new Fido2User
                {
                    DisplayName = identityUser.UserName,
                    Name = identityUser.UserName,
                    Id = Encoding.UTF8.GetBytes(identityUser.UserName) // byte representation of userID is required
                };

                // 2. Get user existing keys by username
                var items = await _fido2Storage.GetCredentialsByUsername(identityUser.UserName);
                var existingKeys = new List&lt;PublicKeyCredentialDescriptor&gt;();
                foreach(var publicKeyCredentialDescriptor in items)
                {
                    existingKeys.Add(publicKeyCredentialDescriptor.Descriptor);
                }

                // 3. Create options
                var authenticatorSelection = new AuthenticatorSelection
                {
                    RequireResidentKey = requireResidentKey,
                    UserVerification = userVerification.ToEnum&lt;UserVerificationRequirement&gt;()
                };

                if (!string.IsNullOrEmpty(authType))
                    authenticatorSelection.AuthenticatorAttachment = authType.ToEnum&lt;AuthenticatorAttachment&gt;();

                var exts = new AuthenticationExtensionsClientInputs() { Extensions = true, UserVerificationIndex = true, Location = true, UserVerificationMethod = true, BiometricAuthenticatorPerformanceBounds = new AuthenticatorBiometricPerfBounds { FAR = float.MaxValue, FRR = float.MaxValue } };

                var options = _lib.RequestNewCredential(user, existingKeys, authenticatorSelection, attType.ToEnum&lt;AttestationConveyancePreference&gt;(), exts);

                // 4. Temporarily store options, session/in-memory cache/redis/db
                HttpContext.Session.SetString(&quot;fido2.attestationOptions&quot;, options.ToJson());

                // 5. return options to client
                return Json(options);
            }
            catch (Exception e)
            {
                return Json(new CredentialCreateOptions { Status = &quot;error&quot;, ErrorMessage = FormatException(e) });
            }
        }

        [HttpPost]
        [Route(&quot;/makeCredential&quot;)]
        public async Task&lt;JsonResult&gt; MakeCredential([FromBody] AuthenticatorAttestationRawResponse attestationResponse)
        {
            try
            {
                // 1. get the options we sent the client
                var jsonOptions = HttpContext.Session.GetString(&quot;fido2.attestationOptions&quot;);
                var options = CredentialCreateOptions.FromJson(jsonOptions);

                // 2. Create callback so that lib can verify credential id is unique to this user
                IsCredentialIdUniqueToUserAsyncDelegate callback = async (IsCredentialIdUniqueToUserParams args) =&gt;
                {
                    var users = await _fido2Storage.GetUsersByCredentialIdAsync(args.CredentialId);
                    if (users.Count &gt; 0) return false;

                    return true;
                };

                // 2. Verify and make the credentials
                var success = await _lib.MakeNewCredentialAsync(attestationResponse, options, callback);

                // 3. Store the credentials in db
                await _fido2Storage.AddCredentialToUser(options.User, new FidoStoredCredential
                {
                    Username = options.User.Name,
                    Descriptor = new PublicKeyCredentialDescriptor(success.Result.CredentialId),
                    PublicKey = success.Result.PublicKey,
                    UserHandle = success.Result.User.Id,
                    SignatureCounter = success.Result.Counter,
                    CredType = success.Result.CredType,
                    RegDate = DateTime.Now,
                    AaGuid = success.Result.Aaguid
                });

                // 4. return &quot;ok&quot; to the client

                var user = await _userManager.GetUserAsync(User);
                if (user == null)
                {
                    return Json(new CredentialMakeResult { Status = &quot;error&quot;, ErrorMessage = $&quot;Unable to load user with ID &apos;{_userManager.GetUserId(User)}&apos;.&quot; });
                }

                await _userManager.SetTwoFactorEnabledAsync(user, true);
                var userId = await _userManager.GetUserIdAsync(user);

                return Json(success);
            }
            catch (Exception e)
            {
                return Json(new CredentialMakeResult { Status = &quot;error&quot;, ErrorMessage = FormatException(e) });
            }
        }
    }
}

</pre>
<p>The RegisterFido2Controller class uses the FidoStoredCredential entity and the Fido2Storage to persist the Fido2 data to the SQL database using Entity Framework Core. The PublicKeyCredentialDescriptor property is persisted as a Json string.</p>
<pre class="brush: csharp; title: ; notranslate">
public class FidoStoredCredential
{
	public string Username { get; set; }
	public byte[] UserId { get; set; }
	public byte[] PublicKey { get; set; }
	public byte[] UserHandle { get; set; }
	public uint SignatureCounter { get; set; }
	public string CredType { get; set; }
	public DateTime RegDate { get; set; }
	public Guid AaGuid { get; set; }

	[NotMapped]
	public PublicKeyCredentialDescriptor Descriptor
	{
		get { return string.IsNullOrWhiteSpace(DescriptorJson) ? null : JsonConvert.DeserializeObject&lt;PublicKeyCredentialDescriptor&gt;(DescriptorJson); }
		set { DescriptorJson = JsonConvert.SerializeObject(value); }
	}
	public string DescriptorJson { get; set; }
}
</pre>
<p>Teh entity is added to the ApplicationDbContext. The Username which is the unique email, is used as a key.</p>
<pre class="brush: csharp; title: ; notranslate">
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace AspNetCoreIdentityFido2Mfa.Data
{
    public class ApplicationDbContext : IdentityDbContext
    {
        public ApplicationDbContext(DbContextOptions&lt;ApplicationDbContext&gt; options)
            : base(options)
        {
        }

        public DbSet&lt;FidoStoredCredential&gt; FidoStoredCredential { get; set; }

        protected override void OnModelCreating(ModelBuilder builder)
        {
            builder.Entity&lt;FidoStoredCredential&gt;().HasKey(m =&gt; m.Username);

            base.OnModelCreating(builder);
        }
    }
}

</pre>
<p>The FidoStoredCredential class can now be used to interact with the database.</p>
<pre class="brush: csharp; title: ; notranslate">
using AspNetCoreIdentityFido2Mfa.Data;
using Fido2NetLib;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AspNetCoreIdentityFido2Mfa
{
    public class Fido2Storage
    {
       private readonly ApplicationDbContext _applicationDbContext;

        public Fido2Storage(ApplicationDbContext applicationDbContext)
        {
            _applicationDbContext = applicationDbContext;
        }

        public async Task&lt;List&lt;FidoStoredCredential&gt;&gt; GetCredentialsByUsername(string username)
        {
            return await _applicationDbContext.FidoStoredCredential.Where(c =&gt; c.Username == username).ToListAsync();
        }

        public async Task RemoveCredentialsByUsername(string username)
        {
            var item = await _applicationDbContext.FidoStoredCredential.Where(c =&gt; c.Username == username).FirstOrDefaultAsync();
            if(item != null)
            {
                _applicationDbContext.FidoStoredCredential.Remove(item);
                await _applicationDbContext.SaveChangesAsync();
            }
        }

        public async Task&lt;FidoStoredCredential&gt; GetCredentialById(byte[] id)
        {
            var credentialIdString = Base64Url.Encode(id);
            //byte[] credentialIdStringByte = Base64Url.Decode(credentialIdString);

            var cred = await _applicationDbContext.FidoStoredCredential
                .Where(c =&gt; c.DescriptorJson.Contains(credentialIdString)).FirstOrDefaultAsync();

            return cred;
        }

        public Task&lt;List&lt;FidoStoredCredential&gt;&gt; GetCredentialsByUserHandleAsync(byte[] userHandle)
        {
            return Task.FromResult(_applicationDbContext.FidoStoredCredential.Where(c =&gt; c.UserHandle.SequenceEqual(userHandle)).ToList());
        }

        public async Task UpdateCounter(byte[] credentialId, uint counter)
        {
            var credentialIdString = Base64Url.Encode(credentialId);
            //byte[] credentialIdStringByte = Base64Url.Decode(credentialIdString);

            var cred = await _applicationDbContext.FidoStoredCredential
                .Where(c =&gt; c.DescriptorJson.Contains(credentialIdString)).FirstOrDefaultAsync();

            cred.SignatureCounter = counter;
            await _applicationDbContext.SaveChangesAsync();
        }

        public async Task AddCredentialToUser(Fido2User user, FidoStoredCredential credential)
        {
            credential.UserId = user.Id;
            _applicationDbContext.FidoStoredCredential.Add(credential);
            await _applicationDbContext.SaveChangesAsync();
        }

        public async Task&lt;List&lt;Fido2User&gt;&gt; GetUsersByCredentialIdAsync(byte[] credentialId)
        {
            var credentialIdString = Base64Url.Encode(credentialId);
            //byte[] credentialIdStringByte = Base64Url.Decode(credentialIdString);

            var cred = await _applicationDbContext.FidoStoredCredential
                .Where(c =&gt; c.DescriptorJson.Contains(credentialIdString)).FirstOrDefaultAsync();

            if (cred == null)
            {
                return new List&lt;Fido2User&gt;();
            }

            return await _applicationDbContext.Users
                    .Where(u =&gt; Encoding.UTF8.GetBytes(u.UserName)
                    .SequenceEqual(cred.UserId))
                    .Select(u =&gt; new Fido2User
                    {
                        DisplayName = u.UserName,
                        Name = u.UserName,
                        Id = Encoding.UTF8.GetBytes(u.UserName) // byte representation of userID is required
                    }).ToListAsync();
        }
    }
}

</pre>
<p>Now the user can register and activate a Fido2 2FA with Identity. Start the application and login. Click your email, and then Two-Factor authentication.</p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_03.png?w=640" alt width="640" class="alignnone size-full wp-image-12645" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_03.png?w=640&amp;h=503 640w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_03.png?w=150&amp;h=118 150w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_03.png?w=600&amp;h=472 600w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_03.png?w=768&amp;h=604 768w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_03.png?w=1024&amp;h=805 1024w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_03.png 1235w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Click Add Fido2 MFA</p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_04.png?w=640" alt width="640" class="alignnone size-full wp-image-12646" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_04.png?w=640&amp;h=449 640w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_04.png?w=1280&amp;h=898 1280w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_04.png?w=150&amp;h=105 150w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_04.png?w=600&amp;h=420 600w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_04.png?w=768&amp;h=538 768w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_04.png?w=1024&amp;h=718 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Click Add Fido2 MFA. Now you can use your hardware key to complete the request.</p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_05.png?w=640" alt width="640" class="alignnone size-full wp-image-12647" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_05.png?w=640&amp;h=713 640w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_05.png?w=1280&amp;h=1426 1280w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_05.png?w=135&amp;h=150 135w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_05.png?w=538&amp;h=600 538w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_05.png?w=768&amp;h=856 768w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_05.png?w=919&amp;h=1024 919w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Login with Fido2</strong></p>
<p>The next step is to implement the login with Fido2 2FA. A code if statement to use the Fido 2FA is added to the Account login page. The Fido2Storage instance is added and this is user to check if a Fido2 registration exists for this user. If so, after a successful login, the user is redirected to the second step at the LoginFido2Mfa Razor Page.</p>
<pre class="brush: csharp; title: ; notranslate">
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Text.Encodings.Web;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Logging;

namespace AspNetCoreIdentityFido2Mfa.Areas.Identity.Pages.Account
{
    [AllowAnonymous]
    public class LoginModel : PageModel
    {
        private readonly UserManager&lt;IdentityUser&gt; _userManager;
        private readonly SignInManager&lt;IdentityUser&gt; _signInManager;
        private readonly ILogger&lt;LoginModel&gt; _logger;
        private readonly IEmailSender _emailSender;
        private readonly Fido2Storage _fido2Storage;

        public LoginModel(SignInManager&lt;IdentityUser&gt; signInManager, 
            ILogger&lt;LoginModel&gt; logger,
            UserManager&lt;IdentityUser&gt; userManager,
            IEmailSender emailSender,
            Fido2Storage fido2Storage)
        {
            _fido2Storage = fido2Storage;
            _userManager = userManager;
            _signInManager = signInManager;
            _emailSender = emailSender;
            _logger = logger;
        }

        public async Task&lt;IActionResult&gt; OnPostAsync(string returnUrl = null)
        {
            returnUrl = returnUrl ?? Url.Content(&quot;~/&quot;);

            if (ModelState.IsValid)
            {
                // This doesn&apos;t count login failures towards account lockout
                // To enable password failures to trigger account lockout, set lockoutOnFailure: true
                var result = await _signInManager.PasswordSignInAsync(Input.Email, Input.Password, Input.RememberMe, lockoutOnFailure: true);
                if (result.Succeeded)
                {
                    _logger.LogInformation(&quot;User logged in.&quot;);
                    return LocalRedirect(returnUrl);
                }
                if (result.RequiresTwoFactor)
                {
                    var fido2ItemExistsForUser = await _fido2Storage.GetCredentialsByUsername(Input.Email);
                    if (fido2ItemExistsForUser.Count &gt; 0)
                    {
                        return RedirectToPage(&quot;./LoginFido2Mfa&quot;, new { ReturnUrl = returnUrl, RememberMe = Input.RememberMe });
                    }
                    else
                    {
                        return RedirectToPage(&quot;./LoginWith2fa&quot;, new { ReturnUrl = returnUrl, RememberMe = Input.RememberMe });
                    }
                }
                
                if (result.IsLockedOut)
                {
                    _logger.LogWarning(&quot;User account locked out.&quot;);
                    return RedirectToPage(&quot;./Lockout&quot;);
                }
                else
                {
                    ModelState.AddModelError(string.Empty, &quot;Invalid login attempt.&quot;);
                    return Page();
                }
            }

            // If we got this far, something failed, redisplay form
            return Page();
        }
    }
}

</pre>
<p>The LoginFido2Mfa Razor Page uses the mfa.login.js to implement the Fido2 logic.</p>
<pre class="brush: csharp; title: ; notranslate">
@page 
@using Microsoft.AspNetCore.Identity
@inject SignInManager&lt;IdentityUser&gt; SignInManager
@inject UserManager&lt;IdentityUser&gt; UserManager
@model AspNetCoreIdentityFido2Mfa.Areas.Identity.Pages.Account.MfaModel
@{
    ViewData[&quot;Title&quot;] = &quot;Login with Fido2 MFA&quot;;
}

&lt;h4&gt;@ViewData[&quot;Title&quot;]&lt;/h4&gt;
&lt;div class=&quot;section&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;h1 class=&quot;title is-1&quot;&gt;2FA/MFA&lt;/h1&gt;
        &lt;div class=&quot;content&quot;&gt;&lt;p&gt;This is scenario where we just want to use FIDO as the MFA. The user register and logins with their username and password. For demo purposes, we trigger the MFA registering on sign up.&lt;/p&gt;&lt;/div&gt;
        &lt;div class=&quot;notification is-danger&quot; style=&quot;display:none&quot;&gt;
            Please note: Your browser does not seem to support WebAuthn yet. &lt;a href=&quot;https://caniuse.com/#search=webauthn&quot; target=&quot;_blank&quot;&gt;Supported browsers&lt;/a&gt;
        &lt;/div&gt;

        &lt;div class=&quot;columns&quot;&gt;
            &lt;div class=&quot;column is-4&quot;&gt;

                &lt;h3 class=&quot;title is-3&quot;&gt;Fido2 2FA&lt;/h3&gt;
                &lt;form action=&quot;/LoginFido2Mfa&quot; method=&quot;post&quot; id=&quot;signin&quot;&gt;

                    &lt;div class=&quot;field&quot;&gt;
                        &lt;div class=&quot;control&quot;&gt;
                            &lt;button class=&quot;btn btn-primary&quot;&gt;2FA with Fido2 device&lt;/button&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;

&lt;script src=&quot;~/js/helpers.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;~/js/instant.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;~/js/mfa.login.js&quot;&gt;&lt;/script&gt;
</pre>
<p>The mfa.login.js script uses the SignInFidoController to complete the login. This controller has two methods, AssertionOptionsPost and MakeAssertion.</p>
<pre class="brush: csharp; title: ; notranslate">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Fido2NetLib.Objects;
using Fido2NetLib;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;
using static Fido2NetLib.Fido2;
using System.IO;
using Microsoft.AspNetCore.Identity;

namespace AspNetCoreIdentityFido2Mfa
{

    [Route(&quot;api/[controller]&quot;)]
    public class SignInFidoController : Controller
    {
        private Fido2 _lib;
        public static IMetadataService _mds;
        private string _origin;
        private readonly Fido2Storage _fido2Storage;
        private readonly UserManager&lt;IdentityUser&gt; _userManager;
        private readonly SignInManager&lt;IdentityUser&gt; _signInManager;

        public SignInFidoController(IConfiguration config,
            Fido2Storage fido2Storage,
            UserManager&lt;IdentityUser&gt; userManager,
            SignInManager&lt;IdentityUser&gt; signInManager)
        {
            _signInManager = signInManager;
            _userManager = userManager;
            _fido2Storage = fido2Storage;
            var MDSAccessKey = config[&quot;fido2:MDSAccessKey&quot;];
            var MDSCacheDirPath = config[&quot;fido2:MDSCacheDirPath&quot;] ?? Path.Combine(Path.GetTempPath(), &quot;fido2mdscache&quot;);
            _mds = string.IsNullOrEmpty(MDSAccessKey) ? null : MDSMetadata.Instance(MDSAccessKey, MDSCacheDirPath);
            if (null != _mds)
            {
                if (false == _mds.IsInitialized())
                    _mds.Initialize().Wait();
            }
            _origin = config[&quot;fido2:origin&quot;];
            _lib = new Fido2(new Fido2Configuration()
            {
                ServerDomain = config[&quot;fido2:serverDomain&quot;],
                ServerName = &quot;Fido2 test&quot;,
                Origin = _origin,
                // Only create and use Metadataservice if we have an acesskey
                MetadataService = _mds,
                TimestampDriftTolerance = config.GetValue&lt;int&gt;(&quot;fido2:TimestampDriftTolerance&quot;)
            });
        }

        private string FormatException(Exception e)
        {
            return string.Format(&quot;{0}{1}&quot;, e.Message, e.InnerException != null ? &quot; (&quot; + e.InnerException.Message + &quot;)&quot; : &quot;&quot;);
        }

        [HttpPost]
        [Route(&quot;/assertionOptions&quot;)]
        public async Task&lt;ActionResult&gt; AssertionOptionsPost([FromForm] string username, [FromForm] string userVerification)
        {
            try
            {
                var identityUser = await _signInManager.GetTwoFactorAuthenticationUserAsync();
                if (identityUser == null)
                {
                    throw new InvalidOperationException($&quot;Unable to load two-factor authentication user.&quot;);
                }

                var existingCredentials = new List&lt;PublicKeyCredentialDescriptor&gt;();

                if (!string.IsNullOrEmpty(identityUser.UserName))
                {
                    
                    var user = new Fido2User
                    {
                        DisplayName = identityUser.UserName,
                        Name = identityUser.UserName,
                        Id = Encoding.UTF8.GetBytes(identityUser.UserName) // byte representation of userID is required
                    };

                    if (user == null) throw new ArgumentException(&quot;Username was not registered&quot;);

                    // 2. Get registered credentials from database
                    var items = await _fido2Storage.GetCredentialsByUsername(identityUser.UserName);
                    existingCredentials = items.Select(c =&gt; c.Descriptor).ToList();
                }

                var exts = new AuthenticationExtensionsClientInputs() { SimpleTransactionAuthorization = &quot;FIDO&quot;, GenericTransactionAuthorization = new TxAuthGenericArg { ContentType = &quot;text/plain&quot;, Content = new byte[] { 0x46, 0x49, 0x44, 0x4F } }, UserVerificationIndex = true, Location = true, UserVerificationMethod = true };

                // 3. Create options
                var uv = string.IsNullOrEmpty(userVerification) ? UserVerificationRequirement.Discouraged : userVerification.ToEnum&lt;UserVerificationRequirement&gt;();
                var options = _lib.GetAssertionOptions(
                    existingCredentials,
                    uv,
                    exts
                );

                // 4. Temporarily store options, session/in-memory cache/redis/db
                HttpContext.Session.SetString(&quot;fido2.assertionOptions&quot;, options.ToJson());

                // 5. Return options to client
                return Json(options);
            }

            catch (Exception e)
            {
                return Json(new AssertionOptions { Status = &quot;error&quot;, ErrorMessage = FormatException(e) });
            }
        }

        [HttpPost]
        [Route(&quot;/makeAssertion&quot;)]
        public async Task&lt;JsonResult&gt; MakeAssertion([FromBody] AuthenticatorAssertionRawResponse clientResponse)
        {
            try
            {
                // 1. Get the assertion options we sent the client
                var jsonOptions = HttpContext.Session.GetString(&quot;fido2.assertionOptions&quot;);
                var options = AssertionOptions.FromJson(jsonOptions);

                // 2. Get registered credential from database
                var creds = await _fido2Storage.GetCredentialById(clientResponse.Id);

                if (creds == null)
                {
                    throw new Exception(&quot;Unknown credentials&quot;);
                }

                // 3. Get credential counter from database
                var storedCounter = creds.SignatureCounter;

                // 4. Create callback to check if userhandle owns the credentialId
                IsUserHandleOwnerOfCredentialIdAsync callback = async (args) =&gt;
                {
                    var storedCreds = await _fido2Storage.GetCredentialsByUserHandleAsync(args.UserHandle);
                    return storedCreds.Exists(c =&gt; c.Descriptor.Id.SequenceEqual(args.CredentialId));
                };

                // 5. Make the assertion
                var res = await _lib.MakeAssertionAsync(clientResponse, options, creds.PublicKey, storedCounter, callback);

                // 6. Store the updated counter
                await _fido2Storage.UpdateCounter(res.CredentialId, res.Counter);

                // complete sign-in
                var user = await _signInManager.GetTwoFactorAuthenticationUserAsync();
                if (user == null)
                {
                    throw new InvalidOperationException($&quot;Unable to load two-factor authentication user.&quot;);
                }
                
                var result = await _signInManager.TwoFactorSignInAsync(&quot;FIDO2&quot;, string.Empty, false, false);

                // 7. return OK to client
                return Json(res);
            }
            catch (Exception e)
            {
                return Json(new AssertionVerificationResult { Status = &quot;error&quot;, ErrorMessage = FormatException(e) });
            }
        }
    }
}

</pre>
<p>If the Fido2 login is successful, the signInManager.TwoFactorSignInAsync method is used to complete the 2FA in Identity.</p>
<p>This requires an implementation of the IUserTwoFactorTokenProvider to complete the login. The Fifo2UserTwoFactorTokenProvider implements the IUserTwoFactorTokenProvider interface and just returns true.</p>
<pre class="brush: csharp; title: ; notranslate">
using Microsoft.AspNetCore.Identity;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AspNetCoreIdentityFido2Mfa
{
    public class Fifo2UserTwoFactorTokenProvider : IUserTwoFactorTokenProvider&lt;IdentityUser&gt;
    {
        public Task&lt;bool&gt; CanGenerateTwoFactorTokenAsync(UserManager&lt;IdentityUser&gt; manager, IdentityUser user)
        {
            return Task.FromResult(true);
        }

        public Task&lt;string&gt; GenerateAsync(string purpose, UserManager&lt;IdentityUser&gt; manager, IdentityUser user)
        {
            return Task.FromResult(&quot;fido2&quot;);
        }

        public Task&lt;bool&gt; ValidateAsync(string purpose, string token, UserManager&lt;IdentityUser&gt; manager, IdentityUser user)
        {
            return Task.FromResult(true);
        }
    }
}

</pre>
<p>For all of this to work, the services and everything needs to be configured in the startup class. The AddControllers method is used to add the services for the Fido2 controllers as well as the extension method AddNewtonsoftJson(). The AddTokenProvider method is used to add the Fido2 2FA provider. Fido2Storage is added as a scoped service.</p>
<pre class="brush: csharp; title: ; notranslate">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.UI;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.HttpsPolicy;
using Microsoft.EntityFrameworkCore;
using AspNetCoreIdentityFido2Mfa.Data;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;

namespace AspNetCoreIdentityFido2Mfa
{
    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {

            services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;
                options.UseSqlServer(
                    Configuration.GetConnectionString(&quot;DefaultConnection&quot;)));
            services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true)
                .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()
                .AddTokenProvider&lt;Fifo2UserTwoFactorTokenProvider&gt;(&quot;FIDO2&quot;);


            services.AddControllers()
               .AddNewtonsoftJson();

            services.AddRazorPages();

            services.AddScoped&lt;Fido2Storage&gt;();
            // Adds a default in-memory implementation of IDistributedCache.
            services.AddDistributedMemoryCache();
            services.AddSession(options =&gt;
            {
                // Set a short timeout for easy testing.
                options.IdleTimeout = TimeSpan.FromMinutes(2);
                options.Cookie.HttpOnly = true;
                options.Cookie.SameSite = Microsoft.AspNetCore.Http.SameSiteMode.None;
            });

        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
                app.UseDatabaseErrorPage();
            }
            else
            {
                app.UseExceptionHandler(&quot;/Error&quot;);
                // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
                app.UseHsts();
            }

            app.UseHttpsRedirection();
            app.UseStaticFiles();

            app.UseRouting();

            app.UseAuthentication();
            app.UseAuthorization();

            app.UseSession();

            app.UseEndpoints(endpoints =&gt;
            {
                endpoints.MapRazorPages();
                endpoints.MapControllers();
            });
        }
    }
}

</pre>
<p>Now that your user is registered, you can click the login button:</p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_06.png?w=640" alt width="640" class="alignnone size-full wp-image-12653" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_06.png?w=640&amp;h=812 640w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_06.png?w=118&amp;h=150 118w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_06.png?w=473&amp;h=600 473w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_06.png?w=768&amp;h=974 768w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_06.png 850w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Then the user will be asked to do a second factor auth using the Fido2 device.</p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_07.png?w=640" alt width="640" class="alignnone size-full wp-image-12654" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_07.png?w=640&amp;h=568 640w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_07.png?w=150&amp;h=133 150w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_07.png?w=600&amp;h=533 600w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_07.png?w=768&amp;h=682 768w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_07.png 930w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>And you can complete the login using the hardware device.</p>
<p><img src="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_08.png?w=640" alt width="640" class="alignnone size-full wp-image-12655" srcset="https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_08.png?w=640&amp;h=731 640w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_08.png?w=1280&amp;h=1462 1280w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_08.png?w=131&amp;h=150 131w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_08.png?w=525&amp;h=600 525w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_08.png?w=768&amp;h=877 768w, https://damienbod.files.wordpress.com/2019/08/aspnetcore_fido_08.png?w=897&amp;h=1024 897w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Disable Fido2 2FA</strong></p>
<p>The identity Disable Razor Page is extended to remove the Fido data for this user. </p>
<pre class="brush: csharp; title: ; notranslate">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Logging;

namespace AspNetCoreIdentityFido2Mfa.Areas.Identity.Pages.Account.Manage
{
    public class Disable2faModel : PageModel
    {
        private readonly UserManager&lt;IdentityUser&gt; _userManager;
        private readonly Fido2Storage _fido2Storage;
        private readonly ILogger&lt;Disable2faModel&gt; _logger;

        public Disable2faModel(
            UserManager&lt;IdentityUser&gt; userManager,
            ILogger&lt;Disable2faModel&gt; logger,
            Fido2Storage fido2Storage)
        {
            _userManager = userManager;
            _fido2Storage = fido2Storage;
            _logger = logger;
        }

        [TempData]
        public string StatusMessage { get; set; }

        public async Task&lt;IActionResult&gt; OnGet()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
            {
                return NotFound($&quot;Unable to load user with ID &apos;{_userManager.GetUserId(User)}&apos;.&quot;);
            }

            if (!await _userManager.GetTwoFactorEnabledAsync(user))
            {
                throw new InvalidOperationException($&quot;Cannot disable 2FA for user with ID &apos;{_userManager.GetUserId(User)}&apos; as it&apos;s not currently enabled.&quot;);
            }

            return Page();
        }

        public async Task&lt;IActionResult&gt; OnPostAsync()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
            {
                return NotFound($&quot;Unable to load user with ID &apos;{_userManager.GetUserId(User)}&apos;.&quot;);
            }

            // remove Fido2 MFA if it exists
            await _fido2Storage.RemoveCredentialsByUsername(user.UserName);

            var disable2faResult = await _userManager.SetTwoFactorEnabledAsync(user, false);
            if (!disable2faResult.Succeeded)
            {
                throw new InvalidOperationException($&quot;Unexpected error occurred disabling 2FA for user with ID &apos;{_userManager.GetUserId(User)}&apos;.&quot;);
            }

            _logger.LogInformation(&quot;User with ID &apos;{UserId}&apos; has disabled 2fa.&quot;, _userManager.GetUserId(User));
            StatusMessage = &quot;2fa has been disabled. You can reenable 2fa when you setup an authenticator app&quot;;
            return RedirectToPage(&quot;./TwoFactorAuthentication&quot;);
        }
    }
}
</pre>
<p><strong>Add the recovery codes for the Fido2 2FA</strong></p>
<p>The demo code is not complete, the user should be redirected to the generated recovery codes, so if he/she loses the Fido2 hardware device, the account can be recovered.</p>
<p><strong>Hardware</strong></p>
<p>This code and application was tested using <a href="https://www.yubico.com/products/yubikey-hardware/">YubiKey 5 Series</a>. This works really good, and is only about 50$ to buy. Many online services already support this, and I would recommend this device.</p>
<p><strong>Links:</strong></p>
<p><a href="https://github.com/abergs/fido2-net-lib">https://github.com/abergs/fido2-net-lib</a></p>
<p class="jetpack-video-wrapper"><span class="embed-youtube"><iframe class="youtube-player" type="text/html" width="640" height="360" src="https://www.youtube.com/embed/qgZ3JO2khFg?version=3&amp;rel=1&amp;fs=1&amp;autohide=2&amp;showsearch=0&amp;showinfo=1&amp;iv_load_policy=1&amp;wmode=transparent"></iframe></span></p>
<blockquote class="wp-embedded-content"><p><a href="https://www.yubico.com/products/yubikey-hardware/">The YubiKey</a></p></blockquote> <p class="jetpack-video-wrapper"><span class="embed-youtube"><iframe class="youtube-player" type="text/html" width="640" height="360" src="https://www.youtube.com/embed/2KfZJRsacNM?version=3&amp;rel=1&amp;fs=1&amp;autohide=2&amp;showsearch=0&amp;showinfo=1&amp;iv_load_policy=1&amp;wmode=transparent"></iframe></span></p>
<p><a href="https://www.troyhunt.com/beyond-passwords-2fa-u2f-and-google-advanced-protection/">https://www.troyhunt.com/beyond-passwords-2fa-u2f-and-google-advanced-protection/</a></p>
<blockquote class="wp-embedded-content"><p><a href="https://fidoalliance.org/fido2/">FIDO2: WebAuthn &amp; CTAP</a></p></blockquote> <p><a href="https://www.w3.org/TR/webauthn/">https://www.w3.org/TR/webauthn/</a></p>
<p><a href="https://www.scottbrady91.com/FIDO/A-FIDO2-Primer-and-Proof-of-Concept-using-ASPNET-Core">https://www.scottbrady91.com/FIDO/A-FIDO2-Primer-and-Proof-of-Concept-using-ASPNET-Core</a></p>
<p><a href="https://github.com/herrjemand/awesome-webauthn">https://github.com/herrjemand/awesome-webauthn</a></p>
<p><a href="https://developers.yubico.com/FIDO2/Libraries/Using_a_library.html">https://developers.yubico.com/FIDO2/Libraries/Using_a_library.html</a></p>
<p><a class="m-profile" href="https://medium.com/@herrjemand">View at Medium.com</a></p>
<p><a href="https://docs.microsoft.com/en-us/aspnet/core/?view=aspnetcore-3.0">https://docs.microsoft.com/en-us/aspnet/core/?view=aspnetcore-3.0</a></p>
<p><a href="https://www.nuget.org/packages/Fido2/">https://www.nuget.org/packages/Fido2/</a> </p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>