<!DOCTYPE html>
<html lang="en">
<head>
    <title>
CQRS with MediatR (for Commands) and Odata (for Queries) -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>CQRS with MediatR (for Commands) and Odata (for Queries)</h1><div><div><p><strong>tl;dr:</strong> In this post we will implement a simple CQRS pattern with MediatR and Odata. We will handle Commands (aka requests that have side-effects) with MediatR and Queries (requests without side-effects) with Odata.</p><hr><p><span class="gatsby-resp-image-wrapper"><a class="gatsby-resp-image-link" href="/blog/static/d284b6f6f257d203c79ecc486f2d14a5/b768e/picture.jpg" target="_blank" rel="noopener"><span class="gatsby-resp-image-background-image"></span><img class="gatsby-resp-image-image" alt="a bridge with separate paths for cars and pedestrians" title="a bridge with separate paths for cars and pedestrians" src="/blog/static/d284b6f6f257d203c79ecc486f2d14a5/29d31/picture.jpg" srcset="/blog/static/d284b6f6f257d203c79ecc486f2d14a5/e52aa/picture.jpg 175w,
/blog/static/d284b6f6f257d203c79ecc486f2d14a5/70ebb/picture.jpg 350w,
/blog/static/d284b6f6f257d203c79ecc486f2d14a5/29d31/picture.jpg 700w,
/blog/static/d284b6f6f257d203c79ecc486f2d14a5/9ecec/picture.jpg 1050w,
/blog/static/d284b6f6f257d203c79ecc486f2d14a5/b768e/picture.jpg 1350w" sizes="(max-width: 700px) 100vw, 700px" loading="lazy"></a></span></p><h2>Pragmatic CQRS with ASP.NET Core and SPAs - Series overview</h2><ol><li><a href="https://www.jannikbuschke.de/blog/odata-getting-started/">Getting Started with Odata: Expose a Queryable Api</a></li><li><a href="https://www.jannikbuschke.de/blog/webapi-enable-query/">Enhance ASP.NET Core Api Controllers with Odata</a></li><li><a href="https://www.jannikbuschke.de/blog/expose-aspnetcore-validation/">Expose ASP.NET Core Validation for HTTP Clients</a></li><li>▶️ CQRS with MediatR (Commands) and Odata (Queries)</li><li>Shallow- and Deep Validation with FluentValidation and MediatR</li><li>Centralized Validation- and Error-Handling</li><li>Optimized Forms for SPAs (with Formik)</li><li>Full Example</li></ol><h1>Why CQRS?</h1><p>This <a href="https://martinfowler.com/bliki/CQRS.html">blogpost</a> by Martin Fowler is probably the canonical introduction to Command Query Responsibility Segregation (CQRS). The patterns core idea is that two different models can be used for reading data vs. changing data. It seems that this is much better approach for applications that go beyond some trivial features. Only the most basic examples will not benefit from the Read/Write distinction. Read the blog post for a more in-depth motivation.</p><h2>Why Odata?</h2><p>Odata is good at exposing a queryable api, especially in combination with Entity Framework Core (EF) and a SQL-like database. After a relative simple setup, it is <a href="https://www.jannikbuschke.de/blog/odata-getting-started/">trivial</a> to enable clients to get the data they need.</p><h2>Why MediatR?</h2><p>Odata is not a silver bullet when it comes to api design. Especially implementing write-models is not easy and straight forward. Odata imposes to many restrictions that are annoying.</p><p>MediatR is a “simple and unambitious” in process command and event dispatcher that gives decoupling and a middle-ware pipeline to implement cross-cutting-concerns.</p><p>Related articles that give some more in-depth motivation:
<a href="https://lostechies.com/jimmybogard/2015/05/05/cqrs-with-mediatr-and-automapper/">CQRS with MediatR and AutoMapper</a> by Jimmy Bogard (author of MediatR) and
<a href="https://www.stevejgordon.co.uk/cqrs-using-mediatr-asp-net-core">CQRS with MediatR and ASP.NET Core</a> by Steve Gordon.</p><h2>Why this blog post?</h2><p>I have never seen any one talking about combining MediatR and Odata. Usually MediatR is used for both commands and queries. And Odata seems to be avoided altogether (at least outside of the Microsoft world), as it has some problems. It seems to be a bit overengineered, has no good tooling, documentation is mediocre, the write-model is overly restrictive… However not everything in Odata is bad, especially the read-side and the integration with ASP.NET Core and EF Core is really good.</p><p>Taking the best of both worlds provides an excellent CQRS implementation. Hence this post.</p><h1>Setup</h1><p>In <a href="">part 1</a> of this blog series we already got started with Odata for ASP.NET Core. In this blogpost I will just provide the steps we need to take to add MediatR and Odata (and api-versioning) to a plain ASP.NET Core web-api project without further explanations.</p><p>If you want to follow along you need to download and install the <a href="https://dotnet.microsoft.com/download/dotnet-core/2.2">.NET Core SDK 2.2</a>.</p><p>Lets go:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">dotnet new web --name Sample
cd Sample
dotnet add package Microsoft.EntityFrameworkCore.InMemory --version 2.2.4
dotnet add package MediatR --version 7.0.0
dotnet add package MediatR.Extensions.Microsoft.DependencyInjection --version 7.0.0
dotnet add package Microsoft.AspNetCore.OData --version 7.1.0
dotnet add package Microsoft.AspNetCore.Mvc.Versioning --version 3.1.2
dotnet add package Microsoft.AspNetCore.OData.Versioning --version 3.1.0</code></pre></div><p>Our csproj now looks like this:</p><div class="gatsby-highlight" data-language="xml"><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Project</span><span class="token attr-name">Sdk</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.NET.Sdk.Web<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFramework</span><span class="token punctuation">&gt;</span></span>netcoreapp2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFramework</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AspNetCoreHostingModel</span><span class="token punctuation">&gt;</span></span>InProcess<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AspNetCoreHostingModel</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AssemblyName</span><span class="token punctuation">&gt;</span></span>Samples<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AssemblyName</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RootNamespace</span><span class="token punctuation">&gt;</span></span>Samples<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RootNamespace</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageId</span><span class="token punctuation">&gt;</span></span>Sample4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PackageId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.App<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.OData<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7.1.0<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Mvc.Versioning<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.1.2<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.OData.Versioning<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.1.0<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MediatR<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7.0.0<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.EntityFrameworkCore.InMemory<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.2.4<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span><span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MediatR.Extensions.Microsoft.DependencyInjection<span class="token punctuation">"</span></span><span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7.0.0<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Project</span><span class="token punctuation">&gt;</span></span></code></pre></div><p>In the <code class="language-text">Startup.cs</code> we need to configure our services and the request pipeline:</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetCompatibilityVersion</span><span class="token punctuation">(</span>CompatibilityVersion<span class="token punctuation">.</span>Version_2_2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token punctuation">&lt;</span><span class="token class-name">DataContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">UseInMemoryDatabase</span><span class="token punctuation">(</span><span class="token string">"inmem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token function">AddMediatR</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Startup<span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span><span class="token class-name">IHostingEnvironment</span> env<span class="token punctuation">,</span><span class="token class-name">VersionedODataModelBuilder</span> modelBuilder<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">UseHsts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span>builder <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Expand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OrderBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MaxTop</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">MapVersionedODataRoutes</span><span class="token punctuation">(</span><span class="token string">"odata"</span><span class="token punctuation">,</span><span class="token string">"odata"</span><span class="token punctuation">,</span> modelBuilder<span class="token punctuation">.</span><span class="token function">GetEdmModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></div><p>Our <code class="language-text">DataContext</code> and database model is implemented like this:</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">Person</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">Guid</span> Id <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">string</span> FirstName <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">int</span> Age <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">DataContext</span><span class="token punctuation">:</span><span class="token class-name">DbContext</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token function">DataContext</span><span class="token punctuation">(</span>DbContextOptions<span class="token operator">&lt;</span>DataContext<span class="token operator">&gt;</span> options<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> Persons <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div><p>We als need to add an <code class="language-text">IModelConfiguration</code> implementation where the Odata model is configured:</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">OdataModelConfiguration</span><span class="token punctuation">:</span><span class="token class-name">IModelConfiguration</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">Apply</span><span class="token punctuation">(</span><span class="token class-name">ODataModelBuilder</span> builder<span class="token punctuation">,</span><span class="token class-name">ApiVersion</span> apiVersion<span class="token punctuation">)</span><span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">EntitySet</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"Persons"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div><h1>Commands</h1><p>Incoming commands are data transfer objects (DTOs) and implement MediatRs <code class="language-text">IRequest&lt;Response&gt;</code> marker interface. They are deserialized by a web-api Controller and handled by a MediatR <code class="language-text">IRequestHandler&lt;Request,Response&gt;</code>:</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">CreatePerson</span><span class="token punctuation">:</span><span class="token class-name">IRequest</span><span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">string</span> FirstName <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">int</span> Age <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">ApiVersion</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">PersonCommandsController</span><span class="token punctuation">:</span><span class="token class-name">ControllerBase</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IMediator</span> mediator<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">PersonCommandsController</span><span class="token punctuation">(</span><span class="token class-name">IMediator</span> mediator<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ActionResult<span class="token operator">&lt;</span>Person<span class="token operator">&gt;&gt;</span><span class="token function">CreatePerson</span><span class="token punctuation">(</span><span class="token class-name">CreatePerson</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> person <span class="token operator">=</span><span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> person<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">PersonHandler</span><span class="token punctuation">:</span><span class="token class-name">IRequestHandler</span><span class="token operator">&lt;</span>CreatePerson<span class="token punctuation">,</span> Person<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">DataContext</span> ctx<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">PersonHandler</span><span class="token punctuation">(</span><span class="token class-name">DataContext</span> ctx<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">CreatePerson</span> request<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> person <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">Person</span><span class="token punctuation">{</span>
            FirstName <span class="token operator">=</span> request<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span>
            Age <span class="token operator">=</span> request<span class="token punctuation">.</span>Age<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> person<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div><h1>Queries</h1><p>Now that we are able to create Persons let’s implement the Query-side with an ODataController:</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">PersonsController</span><span class="token punctuation">:</span><span class="token class-name">ODataController</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">DataContext</span> ctx<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">PersonsController</span><span class="token punctuation">(</span><span class="token class-name">DataContext</span> ctx<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">EnableQuery</span><span class="token punctuation">]</span><span class="token keyword">public</span> SingleResult<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token function">GetPerson</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token keyword">new</span><span class="token generic-method"><span class="token function">SingleResult</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Persons<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>v <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>Id <span class="token operator">==</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">EnableQuery</span><span class="token punctuation">]</span><span class="token keyword">public</span> IQueryable<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token function">GetPersons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> ctx<span class="token punctuation">.</span>Persons<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div><p>Note that we are exposing the code-first database model directly. If the database model is well designed and/or the client does not need an optimized read-model this is fine. In my experience to get started this is really enough. In some scenarios special read-models that are based on SQL-Views / custom SQL-Queries are needed.</p><p>Now we can create and query persons:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /api/Persons
content-type: application/json
{
    "firstName": "Alice",
    "age": 25
}

GET /odata/Persons

GET /odata/Persons&amp;$orderby=firstName&amp;$top10

GET /odata/Persons/:id</code></pre></div><h2>More Commands</h2><p>Lets add features to updates and deletes. As we only really differentiate between requests that have side-effects and requests that don’t, we also only need two HTTP verbs: POST for Commands and GET for Queries.</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">UpdatePerson</span><span class="token punctuation">:</span><span class="token class-name">IRequest</span><span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">Guid</span> Id <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">string</span> FirstName <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">int</span> Age <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">DeletePerson</span><span class="token punctuation">:</span><span class="token class-name">IRequest</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token class-name">Guid</span> Id <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">"api/Persons"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">PersonCommandsController</span><span class="token punctuation">:</span><span class="token class-name">ControllerBase</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">IMediator</span> mediator<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">PersonCommandsController</span><span class="token punctuation">(</span><span class="token class-name">IMediator</span> mediator<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ActionResult<span class="token operator">&lt;</span>Person<span class="token operator">&gt;&gt;</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token class-name">CreatePerson</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> person <span class="token operator">=</span><span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> person<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"update"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ActionResult<span class="token operator">&lt;</span>Person<span class="token operator">&gt;&gt;</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">UpdatePerson</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> person <span class="token operator">=</span><span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> person<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>IActionResult<span class="token operator">&gt;</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token class-name">DeletePerson</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">PersonHandler</span><span class="token punctuation">:</span><span class="token class-name">IRequestHandler</span><span class="token operator">&lt;</span>CreatePerson<span class="token punctuation">,</span> Person<span class="token operator">&gt;</span><span class="token punctuation">,</span> IRequestHandler<span class="token operator">&lt;</span>UpdatePerson<span class="token punctuation">,</span> Person<span class="token operator">&gt;</span><span class="token punctuation">,</span> IRequestHandler<span class="token operator">&lt;</span>DeletePerson<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">DataContext</span> ctx<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">PersonHandler</span><span class="token punctuation">(</span><span class="token class-name">DataContext</span> ctx<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">CreatePerson</span> request<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> person <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">Person</span><span class="token punctuation">{</span>
            Age <span class="token operator">=</span> request<span class="token punctuation">.</span>Age<span class="token punctuation">,</span>
            FirstName <span class="token operator">=</span> request<span class="token punctuation">.</span>FirstName
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> person<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">UpdatePerson</span> request<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> person <span class="token operator">=</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>Persons<span class="token punctuation">.</span><span class="token function">SingleOrDefaultAsync</span><span class="token punctuation">(</span>v <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>Id <span class="token operator">==</span> request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>person <span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">throw</span><span class="token keyword">new</span><span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Record does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        person<span class="token punctuation">.</span>Age <span class="token operator">=</span> request<span class="token punctuation">.</span>Age<span class="token punctuation">;</span>
        person<span class="token punctuation">.</span>FirstName <span class="token operator">=</span> request<span class="token punctuation">.</span>FirstName<span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>Persons<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> person<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">async</span> Task<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">DeletePerson</span> request<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> person <span class="token operator">=</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>Persons<span class="token punctuation">.</span><span class="token function">SingleOrDefaultAsync</span><span class="token punctuation">(</span>v <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>Id <span class="token operator">==</span> request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>person <span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">throw</span><span class="token keyword">new</span><span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Record does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>Persons<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> Unit<span class="token punctuation">.</span>Value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div><p>The api now can handle Commands at the routes</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /api/Persons/create
POST /api/Person/update
POST /api/Persons/delete</code></pre></div><p>and Queries at</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">GET /odata/Persons
GET /odata/Persons/:id</code></pre></div><p>POST for Commands (arguments in the payload), GET for Queries (arguments in the odata-query-parameters). Simple and effective!</p><h1>Closing notes</h1><p>The CQRS pattern itself is quite simple and straight forward. Implementing it in ASP.NET Core with the help of MediatR and Odata is a breeze. The accompanying source code is available on github (Sample #4):</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">git clone https://github.com/jannikbuschke/pragmatic-cqrs-with-asp-net-core-for-spas</code></pre></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>