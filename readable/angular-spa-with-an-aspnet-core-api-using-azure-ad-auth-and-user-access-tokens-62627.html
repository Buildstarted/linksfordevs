<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Angular SPA with an ASP.NET Core API using Azure AD Auth and user access tokens - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Angular SPA with an ASP.NET Core API using Azure AD Auth and user access tokens - linksfor.dev(s)"/>
    <meta property="article:author" content="June 8, 2020 &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;by damienbod &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;in ASP.NET Core, angular, Azure&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xB7; 1 Comment"/>
    <meta property="og:description" content="This post shows how to authenticate an Angular SPA application using Azure AD and consume secure data from an ASP.NET Core API which is protected by Azure AD. Azure AD App registrations are used to&#x2026;"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Angular SPA with an ASP.NET Core API using Azure AD Auth and user access tokens</title>
<div class="readable">
        <h1>Angular SPA with an ASP.NET Core API using Azure AD Auth and user access tokens</h1>
            <div>by June 8, 2020 &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;by damienbod &#xB7;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;in ASP.NET Core, angular, Azure&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xB7; 1 Comment</div>
            <div>Reading time: 7-9 minutes</div>
        <div>Posted here: 09 Jun 2020</div>
        <p><a href="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/">https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>

							<p>This post shows how to authenticate an Angular SPA application using Azure AD and consume secure data from an ASP.NET Core API which is protected by Azure AD. Azure AD App registrations are used to configure and setup the authentication and authorization. The Angular application uses the OpenID Connect Code flow with PKCE and the silent renew is implemented using iframes. </p>
<p><strong>Code</strong>: <a href="https://github.com/damienbod/AzureAD-Auth-MyUI-with-MyAPI" rel="nofollow">https://github.com/damienbod/AzureAD-Auth-MyUI-with-MyAPI</a></p>
<p><strong>Posts in this Series</strong></p>
<ul>
<li><a href="https://damienbod.com/2020/05/29/login-and-use-asp-net-core-api-with-azure-ad-auth-and-user-access-tokens/">Login and use an ASP.NET Core API with Azure AD Auth and user access tokens</a></li>
<li><a href="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/">Angular SPA with an ASP.NET Core API using Azure AD Auth and user access tokens</a></li>
</ul>
<p><strong>Setup the SPA APP registration</strong></p>
<p>In this demo, we will create an APP registration for the Angular application, which will use the API from the first blog in this series. The SPA is a public client and so user access tokens are used. An application running in the browser cannot keep a secret and cannot use a service to service API. In your Azure AD tenant. add a new App registration and select a single page application.</p>
<p><img data-attachment-id="13878" data-permalink="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/aad_spa_00/" data-orig-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png" data-orig-size="1938,1192" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_spa_00" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=640" src="https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=640&amp;h=394" alt="" width="640" height="394" srcset="https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=640&amp;h=394 640w, https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=1280&amp;h=788 1280w, https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=150&amp;h=92 150w, https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=600&amp;h=369 600w, https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=768&amp;h=472 768w, https://damienbod.files.wordpress.com/2020/06/aad_spa_00.png?w=1024&amp;h=630 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>The redirct URLs need to match your Angular application. For development, we use localhost. The silent renew URL is also required.</p>
<p><img data-attachment-id="13879" data-permalink="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/aad_spa_01/" data-orig-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png" data-orig-size="1421,1456" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_spa_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=586" data-large-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=640" src="https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=640&amp;h=656" alt="" width="640" height="656" srcset="https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=640&amp;h=656 640w, https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=1280&amp;h=1312 1280w, https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=146&amp;h=150 146w, https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=586&amp;h=600 586w, https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=768&amp;h=787 768w, https://damienbod.files.wordpress.com/2020/06/aad_spa_01.png?w=999&amp;h=1024 999w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>Add the API permissions which are required for the UI and the API requests. The Web API which was created in the previous blog needs to be added here, so that the SPA application can access the API which is protected by Azure AD.</p>
<p><img data-attachment-id="13880" data-permalink="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/aad_spa_02/" data-orig-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png" data-orig-size="1556,1205" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_spa_02" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=640" src="https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=640&amp;h=496" alt="" width="640" height="496" srcset="https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=640&amp;h=496 640w, https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=1280&amp;h=992 1280w, https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=150&amp;h=116 150w, https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=600&amp;h=465 600w, https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=768&amp;h=595 768w, https://damienbod.files.wordpress.com/2020/06/aad_spa_02.png?w=1024&amp;h=793 1024w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p>The email claim is added to the access token and the id token as an optional claim. This is used in the API and the UI. </p>
<p><img data-attachment-id="13881" data-permalink="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/aad_spa_03/" data-orig-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png" data-orig-size="1104,1085" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_spa_03" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=640" src="https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=640&amp;h=629" alt="" width="640" height="629" srcset="https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=640&amp;h=629 640w, https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=150&amp;h=147 150w, https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=600&amp;h=590 600w, https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=768&amp;h=755 768w, https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png?w=1024&amp;h=1006 1024w, https://damienbod.files.wordpress.com/2020/06/aad_spa_03.png 1104w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Angular application</strong></p>
<p>The Angular single page application is implemented using the <a href="https://www.npmjs.com/package/angular-auth-oidc-client">angular-auth-oidc-client</a> npm package. Open ID Connect code flow with PKCE is used to authenticate. The Angular application was created using Angular-CLI.</p>
<div><div id="highlighter_868596"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></td><td><div><p><code>{</code></p><p><code>&nbsp;&nbsp;</code><code>"name"</code><code>: </code><code>"angular-oidc-oauth2"</code><code>,</code></p><p><code>&nbsp;&nbsp;</code><code>"version"</code><code>: </code><code>"0.0.0"</code><code>,</code></p><p><code>&nbsp;&nbsp;</code><code>"scripts"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"ng"</code><code>: </code><code>"ng"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"start"</code><code>: </code><code>"ng serve --ssl true -o"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"build"</code><code>: </code><code>"ng build"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"test"</code><code>: </code><code>"ng test"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"lint"</code><code>: </code><code>"ng lint"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"e2e"</code><code>: </code><code>"ng e2e"</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p><p><code>&nbsp;&nbsp;</code><code>"private"</code><code>: </code><code>true</code><code>,</code></p><p><code>&nbsp;&nbsp;</code><code>"dependencies"</code><code>: {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/animations"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/common"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/compiler"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/core"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/forms"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/platform-browser"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/platform-browser-dynamic"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"@angular/router"</code><code>: </code><code>"~9.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"angular-auth-oidc-client"</code><code>: </code><code>"^11.1.3"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"rxjs"</code><code>: </code><code>"~6.5.4"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"tslib"</code><code>: </code><code>"^1.10.0"</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"zone.js"</code><code>: </code><code>"~0.10.2"</code></p><p><code>&nbsp;&nbsp;</code><code>},</code></p></div></td></tr></tbody></table></div></div>
<p>In the <a href="https://github.com/damienbod/AzureAD-Auth-MyUI-with-MyAPI/blob/master/MySpaAngularUI/angular.json">angular.json</a> file, the silent renew html needs to be added to the assets, and the https configuration which uses your developer certificates are added to the serve json object. Here’s a link to an example.</p>
<p>angular.json <a href="https://github.com/damienbod/AzureAD-Auth-MyUI-with-MyAPI/blob/master/MySpaAngularUI/angular.json#L84">silent-renew.html</a></p>
<p>angular.json <a href="https://github.com/damienbod/AzureAD-Auth-MyUI-with-MyAPI/blob/master/MySpaAngularUI/angular.json#L61-L62">certificates</a></p>
<p>The silent renew for code flow in an iframe can be created as follows:</p>
<div><div id="highlighter_657050"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p></td><td><div><p><code>&lt;!</code><code>doctype</code> <code>html&gt;</code></p><p><code>&lt;</code><code>html</code><code>&gt;</code></p><p><code>&lt;</code><code>head</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>base</code> <code>href</code><code>=</code><code>"./"</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>meta</code> <code>charset</code><code>=</code><code>"utf-8"</code> <code>/&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>meta</code> <code>name</code><code>=</code><code>"viewport"</code> <code>content</code><code>=</code><code>"width=device-width, initial-scale=1.0"</code> <code>/&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>title</code><code>&gt;silent-renew&lt;/</code><code>title</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>&lt;</code><code>meta</code> <code>http-equiv</code><code>=</code><code>"content-type"</code> <code>content</code><code>=</code><code>"text/html; charset=utf-8"</code> <code>/&gt;</code></p><p><code>&lt;/</code><code>head</code><code>&gt;</code></p><p><code>&lt;</code><code>body</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;</code><code>script</code><code>&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>window.onload = function () {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>/* The parent window hosts the Angular application */</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var parent = window.parent;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>/* Send the id_token information to the oidc message handler */</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var event = new CustomEvent('oidc-silent-renew-message', { detail: window.location });</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>parent.dispatchEvent(event);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>};</code></p><p><code>&nbsp;&nbsp;</code><code>&lt;/</code><code>script</code><code>&gt;</code></p><p><code>&lt;/</code><code>body</code><code>&gt;</code></p><p><code>&lt;/</code><code>html</code><code>&gt;</code></p></div></td></tr></tbody></table></div></div>
<p>In the app.module, the OIDC Azure configuration is added. This example is for a user of a tenant. The tenant ‘7ff95b15-dc21-4ba6-bc92-824856578fc1’ is used for the token server and the authWellknownEndpoint. Code flow is configured and the silent renew is activated and the redirect is setup like configured in the App registration. The ID token is used for the user data and the user data request is not activated. The scope <strong>api://98328d53-55ec-4f14-8407-0ca5ff2f2d20/access_as_user</strong> needs to be requested to access the API.</p>
<div><div id="highlighter_660225"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></td><td><div><p><code>export function configureAuth(oidcConfigService: OidcConfigService) {</code></p><p><code>&nbsp;&nbsp;</code><code>return</code> <code>() =&gt;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>oidcConfigService.withConfig({</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>redirectUrl: window.location.origin,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>clientId: </code><code>'ad6b0351-92b4-4ee9-ac8d-3e76e5fd1c67'</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>scope: </code><code>'openid profile email api://98328d53-55ec-4f14-8407-0ca5ff2f2d20/access_as_user'</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>responseType: </code><code>'code'</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>silentRenew: </code><code>true</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>maxIdTokenIatOffsetAllowedInSeconds: 600,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>issValidationOff: </code><code>false</code><code>, </code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>autoUserinfo: </code><code>false</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>silentRenewUrl: window.location.origin + </code><code>'/silent-renew.html'</code><code>,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>logLevel: LogLevel.Debug</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>A HttpInterceptor is used to add the access token to all requests which match a base address of the API. It is really important that the access token is only sent to APIs where the access token was intended to be used. Don’t not send the access token with every HTTP request. Localhost with port 44390 is where the API secured with Azure AD is hosted for our development.</p>
<div><div id="highlighter_478633"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p></td><td><div><p><code>import { HttpInterceptor, HttpRequest, HttpHandler } </code><code>from</code> <code>'@angular/common/http'</code><code>;</code></p><p><code>import { Injectable } </code><code>from</code> <code>'@angular/core'</code><code>;</code></p><p><code>import { AuthService } </code><code>from</code> <code>'./auth.service'</code><code>;</code></p><p><code>@Injectable()</code></p><p><code>export </code><code>class</code> <code>AuthInterceptor implements HttpInterceptor {</code></p><p><code>&nbsp;&nbsp;</code><code>constructor(</code><code>private</code> <code>authService: AuthService) {}</code></p><p><code>&nbsp;&nbsp;</code><code>intercept(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>request: HttpRequest&lt;any&gt;,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>next: HttpHandler</code></p><p><code>&nbsp;&nbsp;</code><code>) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(!</code><code>this</code><code>.secureRoutes.find((x) =&gt; request.url.startsWith(x))) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>next.handle(request);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>const</code> <code>token = </code><code>this</code><code>.authService.token;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(!token) {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>next.handle(request);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>request = request.clone({</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>headers: request.headers.</code><code>set</code><code>(</code><code>'Authorization'</code><code>, </code><code>'Bearer '</code> <code>+ token),</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code> <code>next.handle(request);</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>The home component starts the sign in for the APP and the user. If successful, the API can be called and the data is returned.</p>
<div><div id="highlighter_953057"><table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p></td><td><div><p><code>import { Component, OnInit } </code><code>from</code> <code>'@angular/core'</code><code>;</code></p><p><code>import { Observable, of } </code><code>from</code> <code>'rxjs'</code><code>;</code></p><p><code>import { catchError } </code><code>from</code> <code>'rxjs/operators'</code><code>;</code></p><p><code>import { AuthService } </code><code>from</code> <code>'../auth.service'</code><code>;</code></p><p><code>import { HttpClient } </code><code>from</code> <code>'@angular/common/http'</code><code>;</code></p><p><code>@Component({</code></p><p><code>&nbsp;&nbsp;</code><code>selector: </code><code>'app-home'</code><code>,</code></p><p><code>&nbsp;&nbsp;</code><code>templateUrl: </code><code>'home.component.html'</code><code>,</code></p><p><code>})</code></p><p><code>export </code><code>class</code> <code>HomeComponent implements OnInit {</code></p><p><code>&nbsp;&nbsp;</code><code>userData$: Observable&lt;any&gt;;</code></p><p><code>&nbsp;&nbsp;</code><code>dataFromAzureProtectedApi$: Observable&lt;any&gt;;</code></p><p><code>&nbsp;&nbsp;</code><code>isAuthenticated$: Observable&lt;boolean&gt;;</code></p><p><code>&nbsp;&nbsp;</code><code>constructor(</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>authservice: AuthService,</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>httpClient: HttpClient</code></p><p><code>&nbsp;&nbsp;</code><code>) {}</code></p><p><code>&nbsp;&nbsp;</code><code>ngOnInit() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.userData$ = </code><code>this</code><code>.authservice.userData;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.isAuthenticated$ = </code><code>this</code><code>.authservice.signedIn;</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>callApi() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.dataFromAzureProtectedApi$ = </code><code>this</code><code>.httpClient</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>.pipe(catchError((error) =&gt; of(error)));</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>login() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.authservice.signIn();</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>forceRefreshSession() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.authservice.forceRefreshSession().subscribe((data) =&gt; {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>console.log(</code><code>'Refresh completed'</code><code>);</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>});</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;</code><code>logout() {</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.authservice.signOut();</code></p><p><code>&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table></div></div>
<p>Start the API and then the Angular application. After you login, the SPA can call the API and access the API data.</p>
<p><img data-attachment-id="13891" data-permalink="https://damienbod.com/2020/06/08/angular-spa-with-an-asp-net-core-api-using-azure-ad-auth-and-user-access-tokens/aad_spa_04/" data-orig-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png" data-orig-size="950,758" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="aad_spa_04" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png?w=640" src="https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png?w=640&amp;h=511" alt="" width="640" height="511" srcset="https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png?w=640&amp;h=511 640w, https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png?w=150&amp;h=120 150w, https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png?w=600&amp;h=479 600w, https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png?w=768&amp;h=613 768w, https://damienbod.files.wordpress.com/2020/06/aad_spa_04.png 950w" sizes="(max-width: 640px) 100vw, 640px"></p>
<p><strong>Links</strong>:</p>
<p><a href="https://github.com/AzureAD/microsoft-identity-web" rel="nofollow">https://github.com/AzureAD/microsoft-identity-web</a></p>
<p><a href="https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2" rel="nofollow">https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2</a></p>
<p><a href="https://jwt.io/" rel="nofollow">https://jwt.io/</a></p>
<p><a href="https://www.npmjs.com/package/angular-auth-oidc-client" rel="nofollow">https://www.npmjs.com/package/angular-auth-oidc-client</a></p>

							
							
						</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>