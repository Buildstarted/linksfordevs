<!DOCTYPE html>
<html lang="en">
<head>
    <title>
ploeh blog - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="ploeh blog - linksfor.dev(s)"/>
    <meta property="article:author" content="Mark Seemann"/>
    <meta property="og:description" content="Danish software design"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://blog.ploeh.dk/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - ploeh blog</title>
<div class="readable">
        <h1>ploeh blog</h1>
            <div>by Mark Seemann</div>
            <div>Reading time: 98-125 minutes</div>
        <div>Posted here: 16 Mar 2020</div>
        <p><a href="https://blog.ploeh.dk/">https://blog.ploeh.dk/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
        



<div>
  <div>
    




   <h2><a href="https://blog.ploeh.dk/2020/03/09/polymorphic-builder/">Polymorphic Builder</a></h2>
   <p>Monday, 09 March 2020 06:47:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>Keeping illegal states unrepresentable with the Builder pattern.</em>
	</p>
	<p>
		As a reaction to <a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms">my article on Builder isomorphisms</a> Tyson Williams asked:
		</p><blockquote>
			<p>
				"If a <code>GET</code> or <code>DELETE</code> request had a body or if a <code>POST</code> request did not have a body, then I would suspect that such behavior was a bug.
			</p>
			<p>
				"For the sake of a question that I would like to ask, let's suppose that a body must be added if and only if the method is <code>POST</code>. Under this assumption, <code>HttpRequestMessageBuilder</code> can create invalid messages. For example, it can create a <code>GET</code> request with a body, and it can create a <code>POST</code> request without a body. Under this assumption, how would you modify your design so that only valid messages can be created?"
			</p>
		</blockquote><p>
		I'm happy to receive that question, because I struggled to find a compelling example of a <a href="https://en.wikipedia.org/wiki/Builder_pattern">Builder</a> where polymorphism seems warranted. Here, it does.
	</p>
	<h3 id="49a6ffa95ffd44dfbf7c1160879af8e9">
		Valid combinations <a href="#49a6ffa95ffd44dfbf7c1160879af8e9" title="permalink">#</a>
	</h3>
	<p>
		Before showing code, I think a few comments are in order. As far as I'm aware, the HTTP specification doesn't prohibit weird combinations like a <code>GET</code> request with a body. Still, such a combination is so odd that it seems fair to design an API to prevent this.
	</p>
	<p>
		On the other hand I think that a <code>POST</code> request without a body should still be allowed. It's not too common, but there are edge cases where this combination is valid. If you want to cause a side effect to happen, a <code>GET</code> is inappropriate, but sometimes all you want do to is to produce an effect. In the <a href="http://amzn.to/YFnkRg">Restful Web Services Cookbook</a> Subbu Allamaraju gives this example of a <em>fire-and-forget bulk task:</em>
	</p>
	<pre>POST /address-correction?before=2010-01-01 HTTP/1.1</pre>
	
	<p>
		As he puts it, <em>"in essence, the client is "flipping a switch" to start the work."</em>
	</p>
	<p>
		I'll design the following API to allow this combination, also because it showcases how that sort of flexibility can still be included. On the other hand, I'll prohibit the combination of a request body in a <code>GET</code> request, as Tyson Williams suggested.
	</p>
	<h3 id="5509ba650064423097e277f6f532d578">
		Expanded API <a href="#5509ba650064423097e277f6f532d578" title="permalink">#</a>
	</h3>
	<p>
		I'll expand on the <code>HttpRequestMessageBuilder</code> example shown in the previous article. As <a href="https://blog.ploeh.dk/2020/02/17/builder-as-a-monoid#6d834828809b4ac2b36f59bb244e5952">outlined in another article</a>, apart from the <code>Build</code> method the Builder really only has two capabilities:
		</p><ul>
			<li>Change the HTTP method</li>
			<li>Add (or update) a JSON body</li>
		</ul><p>
		These are the two combinations we now need to model differently. If I do that now, there'd be no other affordances offered by the Builder API. In order to make the example more explicit, I'll first add a pair of new capabilities:
		</p><ul>
			<li>Add or change the <code>Accept</code> header</li>
			<li>Add or change a <code>Bearer</code> token</li>
		</ul><p>
		When I do that, the <code>HttpRequestMessageBuilder</code> class now looks like this:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>HttpRequestMessageBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>Uri</span>&nbsp;url;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>object</span>?&nbsp;jsonBody;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;acceptHeader;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;bearerToken;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>string</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>new</span>&nbsp;<span>Uri</span>(<span>url</span>))&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>)&nbsp;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>(<span>url</span>,&nbsp;<span>HttpMethod</span>.Get,&nbsp;<span>null</span>,&nbsp;<span>null</span>,&nbsp;<span>null</span>)&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>HttpRequestMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>Uri</span>&nbsp;<span>url</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>HttpMethod</span>&nbsp;<span>method</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>object</span>?&nbsp;<span>jsonBody</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>?&nbsp;<span>acceptHeader</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>?&nbsp;<span>bearerToken</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.url&nbsp;=&nbsp;<span>url</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;=&nbsp;<span>method</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.jsonBody&nbsp;=&nbsp;<span>jsonBody</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.acceptHeader&nbsp;=&nbsp;<span>acceptHeader</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.bearerToken&nbsp;=&nbsp;<span>bearerToken</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpMethod</span>&nbsp;Method&nbsp;{&nbsp;<span>get</span>;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>WithMethod</span>(<span>HttpMethod</span>&nbsp;<span>newMethod</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>newMethod</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jsonBody,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptHeader,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>AddJsonBody</span>(<span>object</span>&nbsp;<span>jsonBody</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>jsonBody</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptHeader,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>WithAcceptHeader</span>(<span>string</span>&nbsp;<span>newAcceptHeader</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jsonBody,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>newAcceptHeader</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>WithBearerToken</span>(<span>string</span>&nbsp;<span>newBearerToken</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jsonBody,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptHeader,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>newBearerToken</span>);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessage</span>&nbsp;<span>Build</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>message</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessage</span>(Method,&nbsp;url);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>BuildBody</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>AddAcceptHeader</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>AddBearerToken</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>message</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>BuildBody</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(jsonBody&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>&nbsp;<span>json</span>&nbsp;=&nbsp;<span>JsonConvert</span>.<span>SerializeObject</span>(jsonBody);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Content&nbsp;=&nbsp;<span>new</span>&nbsp;<span>StringContent</span>(<span>json</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Content.Headers.ContentType.MediaType&nbsp;=&nbsp;<span>"application/json"</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>AddAcceptHeader</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(acceptHeader&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Headers.Accept.<span>ParseAdd</span>(acceptHeader);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>AddBearerToken</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(bearerToken&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Headers.Authorization&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>&nbsp;<span>AuthenticationHeaderValue</span>(<span>"Bearer"</span>,&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		Notice that I've added the methods <code>WithAcceptHeader</code> and <code>WithBearerToken</code>, with supporting implementation. So far, those are the only changes.
	</p>
	<p>
		It enables you to build HTTP request messages like this:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithBearerToken</span>(<span>"cGxvZWg="</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>Build</span>();</pre>
	
	<p>
		Or this:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithMethod</span>(<span>HttpMethod</span>.Post)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>AddJsonBody</span>(<span>new</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;=&nbsp;<span>Guid</span>.<span>NewGuid</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;=&nbsp;<span>"2021-02-09&nbsp;19:15:00"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span>"Hervor"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;email&nbsp;=&nbsp;<span>"hervor@example.com"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quantity&nbsp;=&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;})
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithAcceptHeader</span>(<span>"application/vnd.foo.bar+json"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithBearerToken</span>(<span>"cGxvZWg="</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>Build</span>();</pre>
	
	<p>
		It still doesn't address Tyson Williams' requirement, because you can build an HTTP request like this:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>AddJsonBody</span>(<span>new</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;=&nbsp;<span>Guid</span>.<span>NewGuid</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;=&nbsp;<span>"2020-03-22&nbsp;19:30:00"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span>"Ælfgifu"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;email&nbsp;=&nbsp;<span>"ælfgifu@example.net"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quantity&nbsp;=&nbsp;1&nbsp;})
&nbsp;&nbsp;&nbsp;&nbsp;.<span>Build</span>();</pre>
	
	<p>
		Recall that the default HTTP method is <code>GET</code>. Since the above code doesn't specify a method, it creates a <code>GET</code> request with a message body. That's what shouldn't be possible. Let's <a href="https://blog.janestreet.com/effective-ml-video">make illegal states unrepresentable</a>.
	</p>
	<h3 id="95ac7d907e2b461ea56247bfe4eec6da">
		Builder interface <a href="#95ac7d907e2b461ea56247bfe4eec6da" title="permalink">#</a>
	</h3>
	<p>
		Making illegal states unrepresentable is a catch phrase coined by <a href="https://twitter.com/yminsky">Yaron Minsky</a> to describe advantages of statically typed functional programming. Unintentionally, it also describes a fundamental tenet of object-oriented programming. In <a href="http://amzn.to/1claOin">Object-Oriented Software Construction</a> Bertrand Meyer describes object-oriented programming as the discipline of guaranteeing that an object can never be in an invalid state.
	</p>
	<p>
		In the present example, we can't allow an arbitrary HTTP Builder object to afford an operation to add a body, because that Builder object might produce a <code>GET</code> request. On the other hand, there are operations that are <em>always</em> legal: adding an <code>Accept</code> header or a <code>Bearer</code> token. Because these operations are always legal, they constitute a shared API. Extract those to an interface:
	</p>
	<pre><span>public</span>&nbsp;<span>interface</span>&nbsp;<span>IHttpRequestMessageBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>IHttpRequestMessageBuilder</span>&nbsp;<span>WithAcceptHeader</span>(<span>string</span>&nbsp;<span>newAcceptHeader</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>IHttpRequestMessageBuilder</span>&nbsp;<span>WithBearerToken</span>(<span>string</span>&nbsp;<span>newBearerToken</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>HttpRequestMessage</span>&nbsp;<span>Build</span>();
}</pre>
	
	<p>
		Notice that both the <code>With[...]</code> methods return the new interface. Any <code>IHttpRequestMessageBuilder</code> must implement the interface, but is free to support other operations not part of the interface.
	</p>
	<h3 id="23af7eedc51441118c8bd8819f9b3ce3">
		HTTP GET Builder <a href="#23af7eedc51441118c8bd8819f9b3ce3" title="permalink">#</a>
	</h3>
	<p>
		You can now implement the interface to build HTTP <code>GET</code> requests:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>HttpGetMessageBuilder</span>&nbsp;:&nbsp;<span>IHttpRequestMessageBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>Uri</span>&nbsp;url;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;acceptHeader;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;bearerToken;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpGetMessageBuilder</span>(<span>string</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>new</span>&nbsp;<span>Uri</span>(<span>url</span>))&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpGetMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>url</span>,&nbsp;<span>null</span>,&nbsp;<span>null</span>)&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>HttpGetMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>Uri</span>&nbsp;<span>url</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>?&nbsp;<span>acceptHeader</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>?&nbsp;<span>bearerToken</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.url&nbsp;=&nbsp;<span>url</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.acceptHeader&nbsp;=&nbsp;<span>acceptHeader</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.bearerToken&nbsp;=&nbsp;<span>bearerToken</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>IHttpRequestMessageBuilder</span>&nbsp;<span>WithAcceptHeader</span>(<span>string</span>&nbsp;<span>newAcceptHeader</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpGetMessageBuilder</span>(url,&nbsp;<span>newAcceptHeader</span>,&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>IHttpRequestMessageBuilder</span>&nbsp;<span>WithBearerToken</span>(<span>string</span>&nbsp;<span>newBearerToken</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpGetMessageBuilder</span>(url,&nbsp;acceptHeader,&nbsp;<span>newBearerToken</span>);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessage</span>&nbsp;<span>Build</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>message</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessage</span>(<span>HttpMethod</span>.Get,&nbsp;url);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>AddAcceptHeader</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>AddBearerToken</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>message</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>AddAcceptHeader</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(acceptHeader&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Headers.Accept.<span>ParseAdd</span>(acceptHeader);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>AddBearerToken</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(bearerToken&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Headers.Authorization&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>&nbsp;<span>AuthenticationHeaderValue</span>(<span>"Bearer"</span>,&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		Notice that the <code>Build</code> method hard-codes <code>HttpMethod.Get</code>. When you're using an <code>HttpGetMessageBuilder</code> object, you can't modify the HTTP method. You also can't add a request body, because there's no API that affords that operation.
	</p>
	<p>
		What you <em>can</em> do, for example, is to create an HTTP request with an <code>Accept</code> header:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpGetMessageBuilder</span>(<span>url</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithAcceptHeader</span>(<span>"application/vnd.foo.bar+json"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>Build</span>();</pre>
	
	<p>
		This creates a request with an <code>Accept</code> header, but no <code>Bearer</code> token.
	</p>
	<h3 id="b96c590c45394c1d86ec0ff841b82a52">
		HTTP POST Builder <a href="#b96c590c45394c1d86ec0ff841b82a52" title="permalink">#</a>
	</h3>
	<p>
		As a peer to <code>HttpGetMessageBuilder</code> you can implement the <code>IHttpRequestMessageBuilder</code> interface to support <code>POST</code> requests:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>HttpPostMessageBuilder</span>&nbsp;:&nbsp;<span>IHttpRequestMessageBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>Uri</span>&nbsp;url;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>object</span>?&nbsp;jsonBody;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;acceptHeader;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;bearerToken;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpPostMessageBuilder</span>(<span>string</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>new</span>&nbsp;<span>Uri</span>(<span>url</span>))&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpPostMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>url</span>,&nbsp;<span>null</span>,&nbsp;<span>null</span>,&nbsp;<span>null</span>)&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpPostMessageBuilder</span>(<span>string</span>&nbsp;<span>url</span>,&nbsp;<span>object</span>&nbsp;<span>jsonBody</span>)&nbsp;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>(<span>new</span>&nbsp;<span>Uri</span>(<span>url</span>),&nbsp;<span>jsonBody</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpPostMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>,&nbsp;<span>object</span>&nbsp;<span>jsonBody</span>)&nbsp;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>(<span>url</span>,&nbsp;<span>jsonBody</span>,&nbsp;<span>null</span>,&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>HttpPostMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>Uri</span>&nbsp;<span>url</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>object</span>?&nbsp;<span>jsonBody</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>?&nbsp;<span>acceptHeader</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>?&nbsp;<span>bearerToken</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.url&nbsp;=&nbsp;<span>url</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.jsonBody&nbsp;=&nbsp;<span>jsonBody</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.acceptHeader&nbsp;=&nbsp;<span>acceptHeader</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.bearerToken&nbsp;=&nbsp;<span>bearerToken</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>IHttpRequestMessageBuilder</span>&nbsp;<span>WithAcceptHeader</span>(<span>string</span>&nbsp;<span>newAcceptHeader</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpPostMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jsonBody,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>newAcceptHeader</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>IHttpRequestMessageBuilder</span>&nbsp;<span>WithBearerToken</span>(<span>string</span>&nbsp;<span>newBearerToken</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpPostMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jsonBody,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptHeader,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>newBearerToken</span>);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessage</span>&nbsp;<span>Build</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>message</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessage</span>(<span>HttpMethod</span>.Post,&nbsp;url);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>BuildBody</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>AddAcceptHeader</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>AddBearerToken</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>message</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>BuildBody</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(jsonBody&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>&nbsp;<span>json</span>&nbsp;=&nbsp;<span>JsonConvert</span>.<span>SerializeObject</span>(jsonBody);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Content&nbsp;=&nbsp;<span>new</span>&nbsp;<span>StringContent</span>(<span>json</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Content.Headers.ContentType.MediaType&nbsp;=&nbsp;<span>"application/json"</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>AddAcceptHeader</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(acceptHeader&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Headers.Accept.<span>ParseAdd</span>(acceptHeader);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>AddBearerToken</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(bearerToken&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Headers.Authorization&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>&nbsp;<span>AuthenticationHeaderValue</span>(<span>"Bearer"</span>,&nbsp;bearerToken);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		This class affords various constructor overloads. Two of them don't take a JSON body, and two of them do. This supports both the case where you do want to supply a request body, and the edge case where you don't.
	</p>
	<p>
		I didn't add an explicit <code>WithJsonBody</code> method to the class, so you can't change your mind once you've created an instance of <code>HttpPostMessageBuilder</code>. The only reason I didn't, though, was to save some space. You can add such a method if you'd like to. As long as it's not part of the interface, but only part of the concrete <code>HttpPostMessageBuilder</code> class, illegal states are still unrepresentable. You can represent a <code>POST</code> request with or without a body, but you can't represent a <code>GET</code> request with a body.
	</p>
	<p>
		You can now build requests like this:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>&nbsp;<span>HttpPostMessageBuilder</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>url</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;=&nbsp;<span>Guid</span>.<span>NewGuid</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;=&nbsp;<span>"2021-02-09&nbsp;19:15:00"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span>"Hervor"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;email&nbsp;=&nbsp;<span>"hervor@example.com"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quantity&nbsp;=&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithAcceptHeader</span>(<span>"application/vnd.foo.bar+json"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithBearerToken</span>(<span>"cGxvZWg="</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>Build</span>();</pre>
	
	<p>
		This builds a <code>POST</code> request with both a JSON body, an <code>Accept</code> header, and a <code>Bearer</code> token.
	</p>
	<h3 id="4104677292a94451a896e6bee22df93a">
		Is polymorphism required? <a href="#4104677292a94451a896e6bee22df93a" title="permalink">#</a>
	</h3>
	<p>
		In <a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms">my previous Builder article</a>, I struggled to produce a compelling example of a polymorphic Builder. It seems that I've now mended the situation. Or have I?
	</p>
	<p>
		Is the <code>IHttpRequestMessageBuilder</code> interface really required?
	</p>
	<p>
		Perhaps. It depends on your usage scenarios. I can actually delete the interface, and none of the usage examples I've shown here need change.
	</p>
	<p>
		On the other hand, had I written helper methods against the interface, obviously I couldn't just delete it.
	</p>
	<p>
		The bottom line is that polymorphism can be helpful, but it still strikes me as being non-essential to the Builder pattern.
	</p>
	<h3 id="07ed5f99efb549509a3af0c7b510553a">
		Conclusion <a href="#07ed5f99efb549509a3af0c7b510553a" title="permalink">#</a>
	</h3>
	<p>
		In this article, I've shown how to guarantee that Builders never get into invalid states (according to the rules we've arbitrarily established). I used the common trick of <a href="https://blog.ploeh.dk/2011/05/30/DesignSmellDefaultConstructor">using constructors for object initialisation</a>. If a constructor completes without throwing an exception, we should expect the object to be in a valid state. The price I've paid for this design is some code duplication.
	</p>
	<p>
		You may have noticed that there's duplicated code between <code>HttpGetMessageBuilder</code> and <code>HttpPostMessageBuilder</code>. There are ways to address that concern, but I'll leave that as an exercise.
	</p>
	<p>
		For the sake of brevity, I've only shown examples written as Immutable Fluent Builders. You can refactor all the examples to mutable Fluent Builders or to the original Gang-of-Four Builder pattern. This, too, will remain an exercise for the interested reader.
	</p>
</div>


   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/03/02/impureim-sandwich/">Impureim sandwich</a></h2>
   <p>Monday, 02 March 2020 07:03:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>Pronounced 'impurium sandwich'.</em>
	</p>
	<p>
		<a href="https://blog.ploeh.dk/2017/01/27/from-dependency-injection-to-dependency-rejection">Since January 2017</a> I've been singing the praise of the <em>impure/pure/impure</em> sandwich, but I've never published an article that defines the term. I intend this article to remedy the situation.
	</p>
	<h3 id="b1755f32e36d4a07b336d1b8fdc1b227">
		Functional architecture <a href="#b1755f32e36d4a07b336d1b8fdc1b227" title="permalink">#</a>
	</h3>
	<p>
		In <a href="https://blog.ploeh.dk/2018/11/19/functional-architecture-a-definition">a functional architecture</a> <a href="https://en.wikipedia.org/wiki/Pure_function">pure functions</a> can't call impure actions. On the other hand, as <a href="https://en.wikipedia.org/wiki/Simon_Peyton_Jones">Simon Peyton Jones</a> observed in a lecture, <em>observing the result of pure computation is a side-effect</em>. In practical terms, <em>executing</em> a pure function is also impure, because it happens non-deterministically. Thus, even for a piece of software written in a functional style, the entry point must be impure.
	</p>
	<p>
		While pure functions can't call impure actions, there's no rule to prevent the obverse. Impure actions <em>can</em> call pure functions.
	</p>
	<p>
		Therefore, the best we can ever hope to achieve is an impure entry point that calls pure code and impurely reports the result from the pure function.
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/impure-pure-impure-sandwich-box.png" alt="A box with a thin red slice on top, a thick green middle, and a thin red slice at the bottom.">
	</p>
	<p>
		The flow of code here goes from top to bottom:
		</p><ol>
			<li>Gather data from impure sources.</li>
			<li>Call a pure function with that data.</li>
			<li>Change state (including user interface) based on return value from pure function.</li>
		</ol><p>
		This is the <em>impure/pure/impure</em> sandwich.
	</p>
	<h3 id="c568a515c5a04024832079e491432bc4">
		Metaphor <a href="#c568a515c5a04024832079e491432bc4" title="permalink">#</a>
	</h3>
	<p>
		The reason I call this a <em>sandwich</em> is that I think that it <em>looks</em> like a sandwich, albeit, perhaps, a rather tall one. According to the <a href="https://en.wikipedia.org/wiki/Sandwich">myth of the sandwich</a>, the <a href="https://en.wikipedia.org/wiki/John_Montagu,_4th_Earl_of_Sandwich">4th Earl of Sandwich</a> was a notorious gambler. While playing cards, he'd order two slices of bread with meat in between. This enabled him to keep playing without greasing the cards. His compatriots would order <em>the same as Sandwich</em>, or simply <em>a Sandwich</em>, and the name stuck.
	</p>
	<p>
		I like the sandwich as a metaphor. The bread is an <em>affordance</em>, in <a href="http://amzn.to/1NVqXQH">the spirit of Donald A. Norman</a>. It enables you to handle the meat without getting your fingers greased. In the same way, I think, impure actions enable you to handle a pure function. They let you invoke and observe the result of it.
	</p>
	<h3 id="0aa40b6f0f7c4648ac9a83f8fe2ab449">
		Examples <a href="#0aa40b6f0f7c4648ac9a83f8fe2ab449" title="permalink">#</a>
	</h3>
	<p>
		One of the cleanest examples of an <em>impureim sandwich</em> remains <a href="https://blog.ploeh.dk/2017/02/02/dependency-rejection">my original article</a>:
	</p>
	<pre><span>tryAcceptComposition</span>&nbsp;::&nbsp;<span>Reservation</span>&nbsp;<span>-&gt;</span>&nbsp;IO&nbsp;(Maybe&nbsp;Int)
tryAcceptComposition&nbsp;reservation&nbsp;<span>=</span>&nbsp;runMaybeT&nbsp;<span>$</span>
<span>&nbsp;&nbsp;liftIO&nbsp;(<span>DB</span><span>.</span>readReservations&nbsp;connectionString&nbsp;<span>$</span>&nbsp;date&nbsp;reservation)</span>
<span>&nbsp;&nbsp;<span>&gt;&gt;=</span>&nbsp;<span>MaybeT</span>&nbsp;<span>.</span>&nbsp;return&nbsp;<span>.</span>&nbsp;flip&nbsp;(tryAccept&nbsp;<span>10</span>)&nbsp;reservation</span>
<span>&nbsp;&nbsp;<span>&gt;&gt;=</span>&nbsp;liftIO&nbsp;<span>.</span>&nbsp;<span>DB</span><span>.</span>createReservation&nbsp;connectionString</span></pre>
	
	<p>
		I've here repeated the code, but coloured the background of the impure, pure, and impure parts of the sandwich.
	</p>
	<p>
		I've shown plenty of other examples of this sandwich architecture, recently, for example, while <a href="https://blog.ploeh.dk/2019/12/02/refactoring-registration-flow-to-functional-architecture">refactoring a registration flow</a> in <a href="https://fsharp.org/">F#</a>:
	</p>
	<pre><span>let</span>&nbsp;sut&nbsp;pid&nbsp;r&nbsp;=&nbsp;async&nbsp;{
<span>&nbsp;&nbsp;&nbsp;&nbsp;<span>let!</span>&nbsp;validityOfProof&nbsp;=&nbsp;AsyncOption.traverse&nbsp;(twoFA.VerifyProof&nbsp;r.Mobile)&nbsp;pid</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;<span>let</span>&nbsp;decision&nbsp;=&nbsp;completeRegistrationWorkflow&nbsp;r&nbsp;validityOfProof</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;<span>return!</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;decision
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;AsyncResult.traverseBoth&nbsp;db.CompleteRegistration&nbsp;twoFA.CreateProof
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;AsyncResult.cata&nbsp;(<span>fun</span>&nbsp;()&nbsp;<span>-&gt;</span>&nbsp;RegistrationCompleted)&nbsp;ProofRequired</span>
&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
	
	<p>
		This last example looks as though the bottom part of the sandwich is larger then the rest of the composition. This can sometimes happen (and, in fact, last line of code is also pure). On the other hand, the pure part in the middle will typically <a href="https://blog.ploeh.dk/2019/12/09/put-cyclomatic-complexity-to-good-use">look like just a single line of code, even when the invoked function performs work of significant complexity</a>.
	</p>
	<p>
		The sandwich is a pattern independent of language. You can also <a href="https://blog.ploeh.dk/2019/02/11/asynchronous-injection">apply it in C#</a>:
	</p>
	<pre><span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>IActionResult</span>&gt;&nbsp;Post(<span>Reservation</span>&nbsp;reservation)
{
<span>&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>await</span>&nbsp;Repository.ReadReservations(reservation.Date)</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Select(rs&nbsp;=&gt;&nbsp;maîtreD.TryAccept(rs,&nbsp;reservation))</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.SelectMany(m&nbsp;=&gt;&nbsp;m.Traverse(Repository.Create))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Match(InternalServerError(<span>"Table&nbsp;unavailable"</span>),&nbsp;Ok);</span>
}</pre>
	
	<p>
		Like in the previous F# example, the final <code>Match</code> is most likely pure. In practice, <a href="https://blog.ploeh.dk/2020/02/24/discerning-and-maintaining-purity">you may not know</a>, because a method like <code>InternalServerError</code> or <code>Ok</code> is an inherited base class method. Regardless, I don't think that it's architecturally important, because what's going on there is rather trivial.
	</p>
	<h3 id="de8d05083dcd4dedae2b8b714702cc44">
		Naming <a href="#de8d05083dcd4dedae2b8b714702cc44" title="permalink">#</a>
	</h3>
	<p>
		Since the metaphor occurred to me, I've been looking for a better name. The term <em>impure/pure/impure sandwich</em> seems too inconvenient, but nevertheless, people seem to have picked it up.
	</p>
	<p>
		I want a more distinct name, but have had trouble coming up with one. I've been toying with various abbreviations of <em>impure</em> and <em>pure</em>, but have finally settled on <em>impureim sandwich</em>. It's a contraction of <strong>im</strong>pure/<strong>pure</strong>/<strong>im</strong>pure.
	</p>
	<p>
		Why this particular contraction?
	</p>
	<p>
		I've played with lots of alternatives:
		</p><ul>
			<li>impureim: <strong>im</strong>pure/<strong>pure</strong>/<strong>im</strong>pure</li>
			<li>ipi: <strong>i</strong>mpure/<strong>p</strong>ure/<strong>i</strong>mpure</li>
			<li>impi: <strong>im</strong>pure/<strong>p</strong>ure/<strong>i</strong>mpure</li>
			<li>impim: <strong>im</strong>pure/<strong>p</strong>ure/<strong>im</strong>pure</li>
		</ul><p>
		and so on...
	</p>
	<p>
		I like <em>impureim</em> because the only <a href="https://en.wikipedia.org/wiki/Anagram">anagram</a> that I'm aware of is <em>imperium</em>. I therefore suggest that you pronounce it <em>impurium sandwich</em>. That'll work as a <a href="https://martinfowler.com/bliki/Neologism.html">neologic</a> <a href="https://en.wikipedia.org/wiki/Shibboleth">shibboleth</a>.
	</p>
	<h3 id="df74d63c013646aa9355b95e74fc3edc">
		Summary <a href="#df74d63c013646aa9355b95e74fc3edc" title="permalink">#</a>
	</h3>
	<p>
		Functional architecture prohibits pure functions from invoking impure actions. On the other hand, a pure function is useless if you can't observe its result. A functional architecture, thus, must have an impure entry point that invokes a pure function and uses another impure action to act on the result.
	</p>
	<p>
		I suggest that we call such an <em>impure/pure/impure</em> interaction an <em>impureim sandwich</em>, and that we pronounce it an <em>impurium sandwich</em>.
	</p>
</div>



   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/02/24/discerning-and-maintaining-purity/">Discerning and maintaining purity</a></h2>
   <p>Monday, 24 February 2020 07:31:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>Functional programming depends on referential transparency, but identifying and keeping functions pure requires deliberate attention.</em>
	</p>
	<p>
		<a href="https://en.wikipedia.org/wiki/Referential_transparency">Referential transparency</a> is the essence of functional programming. Most other traits that people associate with functional programming emerge from it: immutability, recursion, <a href="https://en.wikipedia.org/wiki/Higher-order_function">higher-order functions</a>, <a href="https://blog.ploeh.dk/2018/03/22/functors">functors</a> and monads, etcetera.
	</p>
	<p>
		To summarise, a <a href="https://en.wikipedia.org/wiki/Pure_function">pure function</a> has to obey two rules:
		</p><ul>
			<li>The same input always produces the same output.</li>
			<li>Calling it causes no side effects.</li>
		</ul><p>
		While those rules are easy to understand and remember, in practice they're harder to follow than most people realise.
	</p>
	<h3 id="8435839fae0b484399d4ada9f06e695d">
		Lack of abstraction <a href="#8435839fae0b484399d4ada9f06e695d" title="permalink">#</a>
	</h3>
	<p>
		Mainstream programming languages don't distinguish between pure functions and impure actions. I'll use C# for examples, but you can draw the same conclusions for Java, C, C++, Visual Basic .NET and so on - even for <a href="https://fsharp.org/">F#</a> and <a href="https://clojure.org/">Clojure</a>.
	</p>
	<p>
		Consider this line of code:
	</p>
	<pre><span>string</span>&nbsp;<span>validationMsg</span>&nbsp;=&nbsp;<span>Validator</span>.<span>Validate</span>(<span>dto</span>);</pre>
	
	<p>
		Is <code>Validate</code> a pure function?
	</p>
	<p>
		You might want to look at the method signature before you answer:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>string</span>&nbsp;<span>Validate</span>(<span>ReservationDto</span>&nbsp;<span>dto</span>)</pre>
	
	<p>
		This is, unfortunately, not helpful. Will <code>Validate</code> always return the same <code>string</code> for the same <code>dto</code>? Can we guarantee that there's no side effects?
	</p>
	<p>
		You can't answer these questions only by examining the method signature. You'll have to go and <em>read</em> the code.
	</p>
	<p>
		This breaks <a href="https://blog.ploeh.dk/encapsulation-and-solid">encapsulation</a>. It ruins abstraction. It makes code harder to maintain.
	</p>
	<p>
		I can't stress this enough. This is what I've attempted to describe in my <a href="https://cleancoders.com/episode/humane-code-real-episode-1/show">Humane Code</a> video. We waste significant time <em>reading</em> existing code. Mostly because it's difficult to understand. It doesn't fit in our brains.
	</p>
	<p>
		<a href="http://amzn.to/19W4JHk">Agile Principles, Patterns, and Practices</a> defines an <em>abstraction</em> as
		</p><blockquote>
			<p>
				"the amplification of the essential and the elimination of the irrelevant"
			</p>
			
		</blockquote><p>
		This fits with the definition of encapsulation from <a href="http://amzn.to/1claOin">Object-Oriented Software Construction</a>. You should be able to interact with an object without knowledge of its implementation details.
	</p>
	<p>
		When you have to read the code of a method, it indicates a lack of abstraction and encapsulation. Unfortunately, that's the state of affairs when it comes to referential transparency in mainstream programming languages.
	</p>
	<h3 id="eabec7ed53c3482d86d1e4968101741f">
		Manual analysis <a href="#eabec7ed53c3482d86d1e4968101741f" title="permalink">#</a>
	</h3>
	<p>
		If you read the source code of the <code>Validate</code> method, however, it's easy to figure out whether it's pure:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>string</span>&nbsp;<span>Validate</span>(<span>ReservationDto</span>&nbsp;<span>dto</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(!<span>DateTime</span>.<span>TryParse</span>(<span>dto</span>.Date,&nbsp;<span>out</span>&nbsp;<span>var</span>&nbsp;<span>_</span>))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>$"Invalid&nbsp;date:&nbsp;</span>{<span>dto</span>.Date}<span>."</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>""</span>;
}</pre>
	
	<p>
		Is the method deterministic? It seems like it. In fact, in order to answer that question, you need to know if <code>DateTime.TryParse</code> is deterministic. Assume that it is. Apart from the <code>TryParse</code> call, you can easily reason about the rest of this method. There's no randomness or other sources of non-deterministic behaviour in the method, so it seems reasonable to conclude that it's deterministic.
	</p>
	<p>
		Does the method produce side effects? Again, you have to know about the behaviour of <code>DateTime.TryParse</code>, but I think it's safe to conclude that there's no side effects.
	</p>
	<p>
		In other words, <code>Validate</code> is a pure function.
	</p>
	<h3 id="58667892c58f45ebac8e50946a9f1f2a">
		Testability <a href="#58667892c58f45ebac8e50946a9f1f2a" title="permalink">#</a>
	</h3>
	<p>
		Pure functions are <a href="https://blog.ploeh.dk/2015/05/07/functional-design-is-intrinsically-testable">intrinsically testable</a> because they depend exclusively on their input.
	</p>
	<pre>[<span>Fact</span>]
<span>public</span>&nbsp;<span>void</span>&nbsp;<span>ValidDate</span>()
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>dto</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>ReservationDto</span>&nbsp;{&nbsp;Date&nbsp;=&nbsp;<span>"2021-12-21&nbsp;19:00"</span>,&nbsp;Quantity&nbsp;=&nbsp;2&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>actual</span>&nbsp;=&nbsp;<span>Validator</span>.<span>Validate</span>(<span>dto</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>Assert</span>.<span>Empty</span>(<span>actual</span>);
}</pre>
	
	<p>
		This unit test creates a reservation <a href="https://en.wikipedia.org/wiki/Data_transfer_object">Data Transfer Object</a> (DTO) with a valid date string and a positive quantity. There's no error message to produce for a valid DTO. The test asserts that the error message is empty. It passes.
	</p>
	<p>
		You can with similar ease write a test that verifies what happens if you supply an invalid <code>Date</code> string.
	</p>
	<h3 id="de8e9b17b8c14448a76165337ebdc410">
		Maintaining purity <a href="#de8e9b17b8c14448a76165337ebdc410" title="permalink">#</a>
	</h3>
	<p>
		The problem with manual analysis of purity is that any conclusion you reach only lasts until someone edits the code. Every time the code changes, you must re-evaluate.
	</p>
	<p>
		Imagine that you need to add a new validation rule. The system shouldn't accept reservations in the past, so you edit the <code>Validate</code> method:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>string</span>&nbsp;<span>Validate</span>(<span>ReservationDto</span>&nbsp;<span>dto</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(!<span>DateTime</span>.<span>TryParse</span>(<span>dto</span>.Date,&nbsp;<span>out</span>&nbsp;<span>var</span>&nbsp;<span>date</span>))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>$"Invalid&nbsp;date:&nbsp;</span>{<span>dto</span>.Date}<span>."</span>;

&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(<span>date</span>&nbsp;<span>&lt;</span>&nbsp;<span>DateTime</span>.Now)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>$"Invalid&nbsp;date:&nbsp;</span>{<span>dto</span>.Date}<span>."</span>;

&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>""</span>;
}</pre>
	
	<p>
		Is the method still pure? No, it's not. It's now non-deterministic. One way to observe this is to let time pass. Assume that you wrote the above unit test well before December 21, 2021. That test still passes when you make the change, but months go by. One day (on December 21, 2021 at 19:00) the test starts failing. No code changed, but now you have a failing test.
	</p>
	<p>
		I've made sure that the examples in this article are simple, so that they're easy to follow. This could mislead you to think that the shift from referential transparency to impurity isn't such a big deal. After all, the test is easy to read, and it's clear why it starts failing.
	</p>
	<p>
		Imagine, however, that the code is as complex as the code base you work with professionally. A subtle change to a method deep in the bowels of a system can have profound impact on the entire architecture. You thought that you had a <a href="https://blog.ploeh.dk/2018/11/19/functional-architecture-a-definition">functional architecture</a>, but you probably don't.
	</p>
	<p>
		Notice that no types changed. The method signature remains the same. It's surprisingly difficult to maintain purity in a code base, even if you explicitly set out to do so. There's no <a href="https://en.wikipedia.org/wiki/Poka-yoke">poka-yoke</a> here; constant vigilance is required.
	</p>
	<h3 id="dcf2b00c3b4f49d192a10f0cb269d427">
		Automation attempts <a href="#dcf2b00c3b4f49d192a10f0cb269d427" title="permalink">#</a>
	</h3>
	<p>
		When I explain these issues, people typically suggest some sort of annotation mechanism. Couldn't we use attributes to identify pure functions? Perhaps like this:
	</p>
	<pre>[<span>Pure</span>]
<span>public</span>&nbsp;<span>static</span>&nbsp;<span>string</span>&nbsp;<span>Validate</span>(<span>ReservationDto</span>&nbsp;<span>dto</span>)</pre>
	
	<p>
		This doesn't solve the problem, though, because this still still compiles:
	</p>
	<pre>[<span>Pure</span>]
<span>public</span>&nbsp;<span>static</span>&nbsp;<span>string</span>&nbsp;<span>Validate</span>(<span>ReservationDto</span>&nbsp;<span>dto</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(!<span>DateTime</span>.<span>TryParse</span>(<span>dto</span>.Date,&nbsp;<span>out</span>&nbsp;<span>var</span>&nbsp;<span>date</span>))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>$"Invalid&nbsp;date:&nbsp;</span>{<span>dto</span>.Date}<span>."</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(<span>date</span>&nbsp;<span>&lt;</span>&nbsp;<span>DateTime</span>.Now)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>$"Invalid&nbsp;date:&nbsp;</span>{<span>dto</span>.Date}<span>."</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>""</span>;
}</pre>
	
	<p>
		That's an impure action annotated with the <code>[Pure]</code> attribute. It still compiles and passes all tests (if you run them before December 21, 2021). The annotation is a lie.
	</p>
	<p>
		As I've already implied, you also have the compound problem that you need to know the purity (or lack thereof) of all APIs from the base library or third-party libraries. Can you be sure that no pure function becomes impure when you update a library from version 2.3.1 to 2.3.2?
	</p>
	<p>
		I'm not aware of any robust automated way to verify referential transparency in mainstream programming languages.
	</p>
	<h3 id="5413987a6af14316aee1b1de82aee73d">
		Language support <a href="#5413987a6af14316aee1b1de82aee73d" title="permalink">#</a>
	</h3>
	<p>
		While no mainstream languages distinguish between pure functions and impure actions, there are languages that do. The most famous of these is <a href="https://www.haskell.org/">Haskell</a>, but other examples include <a href="http://www.purescript.org/">PureScript</a> and <a href="https://www.idris-lang.org/">Idris</a>.
	</p>
	<p>
		I find Haskell useful for exactly that reason. The compiler enforces the functional interaction law. You can't call impure actions from pure functions. Thus, you wouldn't be able to make a change to a function like <code>Validate</code> without changing its type. That would break most consuming code, which is a good thing.
	</p>
	<p>
		You could write an equivalent to the original, pure version of <code>Validate</code> in Haskell like this:
	</p>
	<pre><span>validateReservation</span>&nbsp;::&nbsp;<span>ReservationDTO</span>&nbsp;<span>-&gt;</span>&nbsp;<span>Either</span>&nbsp;<span>String</span>&nbsp;<span>ReservationDTO</span>
validateReservation&nbsp;r@(ReservationDTO&nbsp;_&nbsp;d&nbsp;_&nbsp;_&nbsp;_)&nbsp;=
&nbsp;&nbsp;<span>case</span>&nbsp;readMaybe&nbsp;d&nbsp;<span>of</span>
&nbsp;&nbsp;&nbsp;&nbsp;Nothing&nbsp;-&gt;&nbsp;Left&nbsp;$&nbsp;<span>"Invalid&nbsp;date:&nbsp;"</span>&nbsp;++&nbsp;d&nbsp;++&nbsp;<span>"."</span>
&nbsp;&nbsp;&nbsp;&nbsp;Just&nbsp;(_&nbsp;::&nbsp;LocalTime)&nbsp;-&gt;&nbsp;Right&nbsp;r</pre>
	
	<p>
		This is a pure function, because all Haskell functions are pure by default.
	</p>
	<p>
		You can change it to also check for reservations in the past, but only if you also change the type:
	</p>
	<pre><span>validateReservation</span>&nbsp;::&nbsp;<span>ReservationDTO</span>&nbsp;<span>-&gt;</span>&nbsp;<span>IO</span>&nbsp;(<span>Either</span>&nbsp;<span>String</span>&nbsp;<span>ReservationDTO</span>)
validateReservation&nbsp;r@(ReservationDTO&nbsp;_&nbsp;d&nbsp;_&nbsp;_&nbsp;_)&nbsp;=
&nbsp;&nbsp;<span>case</span>&nbsp;readMaybe&nbsp;d&nbsp;<span>of</span>
&nbsp;&nbsp;&nbsp;&nbsp;Nothing&nbsp;-&gt;&nbsp;<span>return</span>&nbsp;$&nbsp;Left&nbsp;$&nbsp;<span>"Invalid&nbsp;date:&nbsp;"</span>&nbsp;++&nbsp;d&nbsp;++&nbsp;<span>"."</span>
&nbsp;&nbsp;&nbsp;&nbsp;Just&nbsp;date&nbsp;-&gt;&nbsp;<span>do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;utcNow&nbsp;&lt;-&nbsp;getCurrentTime
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tz&nbsp;&lt;-&nbsp;getCurrentTimeZone
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>let</span>&nbsp;now&nbsp;=&nbsp;utcToLocalTime&nbsp;tz&nbsp;utcNow
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;date&nbsp;&lt;&nbsp;now
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>then</span>&nbsp;<span>return</span>&nbsp;$&nbsp;Left&nbsp;$&nbsp;<span>"Invalid&nbsp;date:&nbsp;"</span>&nbsp;++&nbsp;d&nbsp;++&nbsp;<span>"."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>else</span>&nbsp;<span>return</span>&nbsp;$&nbsp;Right&nbsp;r</pre>
	
	<p>
		Notice that I had to change the return type from <code>Either String ReservationDTO</code> to <code>IO (Either String ReservationDTO)</code>. The presence of <code>IO</code> marks the 'function' as impure. If I hadn't changed the type, the code simply wouldn't have compiled, because <code>getCurrentTime</code> and <code>getCurrentTimeZone</code> are impure actions. These types ripple through entire code bases, enforcing the functional interaction law at every level of the code base.
	</p>
	<h3 id="938b7dc2db644b6b94f6a484d65bb320">
		Pure date validation <a href="#938b7dc2db644b6b94f6a484d65bb320" title="permalink">#</a>
	</h3>
	<p>
		How would you validate, then, that a reservation is in the future? In Haskell, like this:
	</p>
	<pre><span>validateReservation</span>&nbsp;::&nbsp;<span>LocalTime</span>&nbsp;<span>-&gt;</span>&nbsp;<span>ReservationDTO</span>&nbsp;<span>-&gt;</span>&nbsp;<span>Either</span>&nbsp;<span>String</span>&nbsp;<span>ReservationDTO</span>
validateReservation&nbsp;now&nbsp;r@(ReservationDTO&nbsp;_&nbsp;d&nbsp;_&nbsp;_&nbsp;_)&nbsp;=
&nbsp;&nbsp;<span>case</span>&nbsp;readMaybe&nbsp;d&nbsp;<span>of</span>
&nbsp;&nbsp;&nbsp;&nbsp;Nothing&nbsp;-&gt;&nbsp;Left&nbsp;$&nbsp;<span>"Invalid&nbsp;date:&nbsp;"</span>&nbsp;++&nbsp;d&nbsp;++&nbsp;<span>"."</span>
&nbsp;&nbsp;&nbsp;&nbsp;Just&nbsp;date&nbsp;-&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;date&nbsp;&lt;&nbsp;now
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>then</span>&nbsp;Left&nbsp;$&nbsp;<span>"Invalid&nbsp;date:&nbsp;"</span>&nbsp;++&nbsp;d&nbsp;++&nbsp;<span>"."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>else</span>&nbsp;Right&nbsp;r</pre>
	
	<p>
		This function remains pure, although it still changes type. It now takes an additional <code>now</code> argument that represents the current time. You can retrieve the current time as an impure action before you call <code>validateReservation</code>. Impure actions can always call pure functions. This enables you to keep your complex domain model pure, which makes it simpler, and easier to test.
	</p>
	<p>
		Translated to C#, that corresponds to this version of <code>Validate</code>:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>string</span>&nbsp;<span>Validate</span>(<span>DateTime</span>&nbsp;<span>now</span>,&nbsp;<span>ReservationDto</span>&nbsp;<span>dto</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(!<span>DateTime</span>.<span>TryParse</span>(<span>dto</span>.Date,&nbsp;<span>out</span>&nbsp;<span>var</span>&nbsp;<span>date</span>))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>$"Invalid&nbsp;date:&nbsp;</span>{<span>dto</span>.Date}<span>."</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(<span>date</span>&nbsp;<span>&lt;</span>&nbsp;<span>now</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>$"Invalid&nbsp;date:&nbsp;</span>{<span>dto</span>.Date}<span>."</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>""</span>;
}</pre>
	
	<p>
		This version takes an additional <code>now</code> input parameter, but remains deterministic and free of side effects. Since it's pure, it's trivial to unit test.
	</p>
	<pre>[<span>Theory</span>]
[<span>InlineData</span>(<span>"2010-01-01&nbsp;00:01"</span>,&nbsp;<span>"2011-09-11&nbsp;18:30"</span>,&nbsp;3)]
[<span>InlineData</span>(<span>"2019-11-26&nbsp;13:59"</span>,&nbsp;<span>"2019-11-26&nbsp;19:00"</span>,&nbsp;2)]
[<span>InlineData</span>(<span>"2030-10-02&nbsp;23:33"</span>,&nbsp;<span>"2030-10-03&nbsp;00:00"</span>,&nbsp;2)]
<span>public</span>&nbsp;<span>void</span>&nbsp;<span>ValidDate</span>(<span>string</span>&nbsp;<span>now</span>,&nbsp;<span>string</span>&nbsp;<span>reservationDate</span>,&nbsp;<span>int</span>&nbsp;<span>quantity</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>dto</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>ReservationDto</span>&nbsp;{&nbsp;Date&nbsp;=&nbsp;<span>reservationDate</span>,&nbsp;Quantity&nbsp;=&nbsp;<span>quantity</span>&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>actual</span>&nbsp;=&nbsp;<span>Validator</span>.<span>Validate</span>(<span>DateTime</span>.<span>Parse</span>(<span>now</span>),&nbsp;<span>dto</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>Assert</span>.<span>Empty</span>(<span>actual</span>);
}</pre>
	
	<p>
		Notice that while the <code>now</code> parameter plays the <em>role</em> of the current time, the fact that it's just a value makes it trivial to run <em>simulations</em> of what would have happened if you ran this function in 2010, or what will happen when you run it in 2030. A test is really just a simulation by another name.
	</p>
	<h3 id="67101ecee7b94a849b24126ac01851fe">
		Summary <a href="#67101ecee7b94a849b24126ac01851fe" title="permalink">#</a>
	</h3>
	<p>
		Most programming languages don't explicitly distinguish between pure and impure code. This doesn't make it impossible to do functional programming, but it makes it arduous. Since the language doesn't help you, you must constantly review changes to the code and its dependencies to evaluate whether code that's supposed to be pure remains pure.
	</p>
	<p>
		Tests can help, particularly if you employ <a href="https://blog.ploeh.dk/property-based-testing-intro">property-based testing</a>, but vigilance is still required.
	</p>
	<p>
		While Haskell isn't a mainstream programming language, I find that it helps me flush out my wrong assumptions about functional programming. I write many prototypes and proofs of concept in Haskell for that reason.
	</p>
	<p>
		Once you get the hang of it, it becomes easier to spot sources of impurity in other languages as well.
		</p><ul>
			<li>Anything with the <code>void</code> return type must be assumed to induce side effects.</li>
			<li>Everything that involves random numbers is non-deterministic.</li>
			<li>Everything that relies on the system clock is non-deterministic.</li>
			<li>Generating a GUID is non-deterministic.</li>
			<li>Everything that involves input/output is non-deterministic. That includes the file system and everything that involves network communication. In C# this implies that all <a href="https://blog.ploeh.dk/2016/04/11/async-as-surrogate-io">asynchronous APIs should be considered highly suspect</a>.</li>
		</ul><p>
		If you want to harvest the benefits of functional programming in a mainstream language, you must look out for such pitfalls. There's no tooling to assist you.
	</p>
</div>


   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/02/17/builder-as-a-monoid/">Builder as a monoid</a></h2>
   <p>Monday, 17 February 2020 07:18:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>Builder, particularly Fluent Builder, is one of the more useful design patterns. Here's why.</em>
	</p>
	<p>
		This article is part of <a href="https://blog.ploeh.dk/2018/03/05/some-design-patterns-as-universal-abstractions/">a series of articles about design patterns and their universal abstraction counterparts</a>.
	</p>
	<p>
		The <a href="https://en.wikipedia.org/wiki/Builder_pattern">Builder design pattern</a> is an occasionally useful pattern, but mostly in its Fluent Builder variation. I've already described that <a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms">Builder, Fluent Builder, and Immutable Fluent Builder are isomorphic</a>. The Immutable Fluent Builder variation is a set of <a href="https://en.wikipedia.org/wiki/Pure_function">pure functions</a>, so among the three variations, it best fits the set of universal abstractions that I've so far discussed in <a href="https://blog.ploeh.dk/2017/10/04/from-design-patterns-to-category-theory">this article series</a>.
	</p>
	<p>
		<a href="http://amzn.to/XBYukB">Design Patterns</a> describes 23 patterns. Some of these are more useful than others. I first read the book in 2003, and while I initially used many of the patterns, after some years I settled into a routine where I'd reach for the same handful of patterns and ignore the rest.
	</p>
	<p>
		What makes some design patterns more universally useful than others? There's probably components of both subjectivity and chance, but I also believe that there's some correlation to universal abstractions. I consider abstractions universal when they are derived from universal truths (i.e. mathematics) instead of language features or 'just' experience. That's what the overall article series is about. In this article, you'll learn how the Builder pattern is an instance of a universal abstraction. Hopefully, this goes a long way towards explaining why it seems to be so universally useful.
	</p>
	<h3 id="6d834828809b4ac2b36f59bb244e5952">
		Builder API, isolated <a href="#6d834828809b4ac2b36f59bb244e5952" title="permalink">#</a>
	</h3>
	<p>
		I'll start with the <code>HttpRequestMessageBuilder</code> from the article about <a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms">Builder isomorphisms</a>, particularly its Immutable Fluent Builder incarnation. Start by isolating those methods that manipulate the Builder. These are the functions that had <code>void</code> return types in the original Builder incarnation. Imagine, for example, that you extract an interface of only those methods. What would such an interface look like?
	</p>
	<pre><span>public</span>&nbsp;<span>interface</span>&nbsp;<span>IHttpRequestMessageBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>AddJsonBody</span>(<span>object</span>&nbsp;<span>jsonBody</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>WithMethod</span>(<span>HttpMethod</span>&nbsp;<span>newMethod</span>);
}</pre>
	
	<p>
		Keep in mind that on all instance methods, <a href="https://blog.ploeh.dk/2018/02/12/object-isomorphisms">the instance itself can be viewed as 'argument 0'</a>. In that light, each of these methods take two arguments: a Builder and the formal argument (<code>jsonBody</code> and <code>newMethod</code>, respectively). Each method returns a Builder. I've <a href="https://blog.ploeh.dk/2019/01/28/better-abstractions-revisited#047886dcfa5a4a1398965138669e0ddc">already described how this is equivalent to an endomorphism</a>. An <a href="https://en.wikipedia.org/wiki/Endomorphism">endomorphism</a> is a function that returns the same type of output as its input, and <a href="https://blog.ploeh.dk/2017/11/13/endomorphism-monoid">it forms a monoid</a>.
	</p>
	<p>
		This can be difficult to see, so I'll make it explicit. The code that follows only exists to illustrate the point. In no way do I endorse that you write code in this way.
	</p>
	<h3 id="e022825850dc4fbf8d78b550bebb5d7c">
		Explicit endomorphism <a href="#e022825850dc4fbf8d78b550bebb5d7c" title="permalink">#</a>
	</h3>
	<p>
		You can define a formal interface for an endomorphism:
	</p>
	<pre><span>public</span>&nbsp;<span>interface</span>&nbsp;<span>IEndomorphism</span>&lt;<span>T</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>T</span>&nbsp;<span>Run</span>(<span>T</span>&nbsp;<span>x</span>);
}</pre>
	
	<p>
		Notice that it's completely generic. The <code>Run</code> method takes a value of the generic type <code>T</code> and returns a value of the type <code>T</code>. The identity of the <a href="https://blog.ploeh.dk/2017/10/06/monoids">monoid</a>, you may recall, is the eponymously named <em>identity</em> function which returns its input without modification. You can also define the monoidal combination of two endomorphisms:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>AppendEndomorphism</span>&lt;<span>T</span>&gt;&nbsp;:&nbsp;<span>IEndomorphism</span>&lt;<span>T</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>IEndomorphism</span>&lt;<span>T</span>&gt;&nbsp;morphism1;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>IEndomorphism</span>&lt;<span>T</span>&gt;&nbsp;morphism2;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>AppendEndomorphism</span>(<span>IEndomorphism</span>&lt;<span>T</span>&gt;&nbsp;<span>morphism1</span>,&nbsp;<span>IEndomorphism</span>&lt;<span>T</span>&gt;&nbsp;<span>morphism2</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.morphism1&nbsp;=&nbsp;<span>morphism1</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.morphism2&nbsp;=&nbsp;<span>morphism2</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>T</span>&nbsp;<span>Run</span>(<span>T</span>&nbsp;<span>x</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;morphism2.<span>Run</span>(morphism1.<span>Run</span>(<span>x</span>));
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		This implementation of <code>IEndomorphism&lt;T&gt;</code> composes two other <code>IEndomorphism&lt;T&gt;</code> objects. When its <code>Run</code> method is called, it first calls <code>Run</code> on <code>morphism1</code> and then uses the return value of that method call (still a <code>T</code> object) as input for <code>Run</code> on <code>morphism2</code>.
	</p>
	<p>
		If you need to combine more than two endomorphisms then that's also possible, because <a href="https://blog.ploeh.dk/2017/11/20/monoids-accumulate">monoids accumulate</a>.
	</p>
	<h3 id="5f10f8e180b349a0b0584812a0c62431">
		Explicit endomorphism to change HTTP method <a href="#5f10f8e180b349a0b0584812a0c62431" title="permalink">#</a>
	</h3>
	<p>
		You can adapt the <code>WithMethod</code> method to the <code>IEndomorphism&lt;HttpRequestMessageBuilder&gt;</code> interface:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>ChangeMethodEndomorphism</span>&nbsp;:&nbsp;<span>IEndomorphism</span>&lt;<span>HttpRequestMessageBuilder</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>HttpMethod</span>&nbsp;newMethod;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>ChangeMethodEndomorphism</span>(<span>HttpMethod</span>&nbsp;<span>newMethod</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.newMethod&nbsp;=&nbsp;<span>newMethod</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>Run</span>(<span>HttpRequestMessageBuilder</span>&nbsp;<span>x</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(<span>x</span>&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>throw</span>&nbsp;<span>new</span>&nbsp;<span>ArgumentNullException</span>(<span>nameof</span>(<span>x</span>));
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>x</span>.<span>WithMethod</span>(newMethod);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		In itself, this is simple code, but it does turn things on their head. The <code>newMethod</code> argument is now a class field (and constructor argument), while the <code>HttpRequestMessageBuilder</code> has been turned into a method argument. Keep in mind that I'm not doing this because I endorse this style of API design; I do it to demonstrate how the Immutable Fluent Builder pattern is an endomorphism.
	</p>
	<p>
		Since <code>ChangeMethodEndomorphism</code> is an <a href="https://en.wikipedia.org/wiki/Adapter_pattern">Adapter</a> between <code>IEndomorphism&lt;HttpRequestMessageBuilder&gt;</code> and the <code>WithMethod</code> method, I hope that this is becoming apparent. I'll show one more Adapter.
	</p>
	<h3 id="73a3f6e43a19457a937b36ed8682defa">
		Explicit endomorphism to add a JSON body <a href="#73a3f6e43a19457a937b36ed8682defa" title="permalink">#</a>
	</h3>
	<p>
		In the example code, there's one more method that modifies an <code>HttpRequestMessageBuilder</code> object, and that's the <code>AddJsonBody</code> method. You can also create an Adapter over that method:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>AddJsonBodyEndomorphism</span>&nbsp;:&nbsp;<span>IEndomorphism</span>&lt;<span>HttpRequestMessageBuilder</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>object</span>&nbsp;jsonBody;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>AddJsonBodyEndomorphism</span>(<span>object</span>&nbsp;<span>jsonBody</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.jsonBody&nbsp;=&nbsp;<span>jsonBody</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>Run</span>(<span>HttpRequestMessageBuilder</span>&nbsp;<span>x</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(<span>x</span>&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>throw</span>&nbsp;<span>new</span>&nbsp;<span>ArgumentNullException</span>(<span>nameof</span>(<span>x</span>));
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>x</span>.<span>AddJsonBody</span>(jsonBody);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		While the <code>AddJsonBody</code> method itself is more complicated than <code>WithMethod</code>, the Adapter is strikingly similar.
	</p>
	<h3 id="680c696032f542ae8cddcf7a520e84eb">
		Running an explicit endomorphism <a href="#680c696032f542ae8cddcf7a520e84eb" title="permalink">#</a>
	</h3>
	<p>
		You can use the <code>IEndomorphism&lt;T&gt;</code> API to compose a pipeline of operations that will, for example, make an <code>HttpRequestMessageBuilder</code> build an HTTP <code>POST</code> request with a JSON body:
	</p>
	<pre><span>IEndomorphism</span>&lt;<span>HttpRequestMessageBuilder</span>&gt;&nbsp;<span>morphism</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>AppendEndomorphism</span>&lt;<span>HttpRequestMessageBuilder</span>&gt;(
&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>&nbsp;<span>ChangeMethodEndomorphism</span>(<span>HttpMethod</span>.Post),
&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>&nbsp;<span>AddJsonBodyEndomorphism</span>(<span>new</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;=&nbsp;<span>Guid</span>.<span>NewGuid</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;=&nbsp;<span>"2020-03-22&nbsp;19:30:00"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span>"Ælfgifu"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;email&nbsp;=&nbsp;<span>"ælfgifu@example.net"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quantity&nbsp;=&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;}));</pre>
	
	<p>
		You can then <code>Run</code> the endomorphism over a new <code>HttpRequestMessageBuilder</code> object to produce an HTTP request:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>morphism</span>.<span>Run</span>(<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>)).<span>Build</span>();</pre>
	
	<p>
		The <code>msg</code> object represents an HTTP <code>POST</code> request with the supplied JSON body.
	</p>
	<p>
		Once again, I stress that the purpose of this little exercise is only to demonstrate how an Immutable Fluent Builder is an endomorphism, which is a monoid.
	</p>
	<h3 id="cfbf771a96144050ac21bf7c58333595">
		Test Data Builder endomorphism <a href="#cfbf771a96144050ac21bf7c58333595" title="permalink">#</a>
	</h3>
	<p>
		You can give <a href="http://www.natpryce.com/articles/000714.html">Test Data Builders</a> the same treatment, again only to demonstrate that the reason they compose so well is because they're monoids. I'll use an immutable variation of the <code>AddressBuilder</code> from <a href="https://blog.ploeh.dk/2017/08/15/test-data-builders-in-c">this article</a>.
	</p>
	<p>
		For example, to modify a city, you can introduce an endomorphism like this:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>CityEndomorphism</span>&nbsp;:&nbsp;<span>IEndomorphism</span>&lt;<span>AddressBuilder</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>&nbsp;city;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>CityEndomorphism</span>(<span>string</span>&nbsp;<span>city</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.city&nbsp;=&nbsp;<span>city</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>AddressBuilder</span>&nbsp;<span>Run</span>(<span>AddressBuilder</span>&nbsp;<span>x</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>x</span>.<span>WithCity</span>(city);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		You can use it to create an address in Paris like this:
	</p>
	<pre><span>IEndomorphism</span>&lt;<span>AddressBuilder</span>&gt;&nbsp;<span>morphism</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>CityEndomorphism</span>(<span>"Paris"</span>);
<span>Address</span>&nbsp;<span>address</span>&nbsp;=&nbsp;<span>morphism</span>.<span>Run</span>(<span>new</span>&nbsp;<span>AddressBuilder</span>()).<span>Build</span>();</pre>
	
	<p>
		The <code>address</code> is fully populated with <code>Street</code>, <code>PostCode</code>, and so on, but apart from <code>City</code>, you know none of the values.
	</p>
	<h3 id="c5d669df78134e22a5910233da2cc813">
		Sweet spot <a href="#c5d669df78134e22a5910233da2cc813" title="permalink">#</a>
	</h3>
	<p>
		Let's return to the question from the introduction to the article. What makes some design patterns useful? I don't think that there's a single answer to that question, but I find it intriguing that so many of the useful patterns turn out to be equivalent to universal abstractions. The Builder pattern is a monoid. From a programming perspective, the most useful characteristic of <a href="https://blog.ploeh.dk/2017/11/27/semigroups">semigroups</a> and monoids is that they enable you to treat many objects as one object. Monoids compose.
	</p>
	<p>
		Of the three Builder variations, the Immutable Fluent Builder is the most useful. It's also the variation that most clearly corresponds to the endomorphism monoid. Viewing it as an endomorphism reveals its strengths. When or where is a Builder most useful?
	</p>
	<p>
		Don't be mislead by <em>Design Patterns</em>, which states the intent of the Builder pattern like this:
		</p><blockquote>
			<p>
				"Separate the construction of a complex object from its representation so that the same construction process can create different representations."
			</p>
			
		</blockquote><p>
		This may still be the case, but I don't find that this is the primary advantage offered by the pattern. We've learned much about the utility of each design pattern since 1994, so I don't blame the Gang of Four for not seeing this. I do think, however, that it's important to emphasise that the benefit you can derive from a pattern may differ from the original motivation.
	</p>
	<p>
		An endomorphism represents a modification of a value. You need a value to get started, and you get a modified value (of the same type) as output.
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/single-step-endomorphism.png" alt="An object (a little circle) to the left, going into a horizontally oriented pipe, and coming out to the right in a different colour.">
	</p>
	<p>
		Sometimes, all you need is the initial object.
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/single-object-depicted-as-a-circle.png" alt="An object represented as a little circle.">
	</p>
	<p>
		And sometimes, you need to compose several changes.
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/double-step-endomorphism.png" alt="An object (a little circle) to the left, going into two horizontally oriented pipe, on after the other, and coming out to the right in a different colour.">
	</p>
	<p>
		To me, this makes the sweet spot for the pattern clear. Use an (Immutable) Fluent Builder when you have a basic object that's useful in itself, but where you want to give client code the option to make changes to the defaults.
	</p>
	<p>
		Sometimes, the initial object has self-contained default values. Test Data Builders are good examples of that:
	</p>
	<pre><span>public</span>&nbsp;<span>AddressBuilder</span>()
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.street&nbsp;=&nbsp;<span>""</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.city&nbsp;=&nbsp;<span>""</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.postCode&nbsp;=&nbsp;<span>new</span>&nbsp;<span>PostCodeBuilder</span>().<span>Build</span>();
}</pre>
	
	<p>
		The <code>AddressBuilder</code> constructor fully initialises the object. You can use its <code>WithNoPostcode</code>, <code>WithStreet</code>, etcetera methods to make changes to it, but you can also use it as is.
	</p>
	<p>
		In other cases, client code must initialise the object to be built. The <code>HttpRequestMessageBuilder</code> is an example of that:
	</p>
	<pre><span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>string</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>new</span>&nbsp;<span>Uri</span>(<span>url</span>))&nbsp;{&nbsp;}
 
<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>url</span>,&nbsp;<span>HttpMethod</span>.Get,&nbsp;<span>null</span>)&nbsp;{&nbsp;}
 
<span>private</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>,&nbsp;<span>HttpMethod</span>&nbsp;<span>method</span>,&nbsp;<span>object</span>?&nbsp;<span>jsonBody</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.url&nbsp;=&nbsp;<span>url</span>;
&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;=&nbsp;<span>method</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.jsonBody&nbsp;=&nbsp;<span>jsonBody</span>;
}</pre>
	
	<p>
		While there's more than one constructor overload, client code must supply a <code>url</code> in one form or other. That's the precondition of this class. Given a valid <code>url</code>, though, an <code>HttpRequestMessageBuilder</code> object can be useful without further modification, but you can also modify it by calling its methods.
	</p>
	<p>
		You often see the Builder pattern used for configuration APIs. The ASP.NET Core <a href="https://docs.microsoft.com/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder">IApplicationBuilder</a> is a prominent example of the Fluent Builder pattern. The <a href="https://docs.particular.net/samples/endpoint-configuration">NServiceBus endpoint configuration API</a>, on the other hand, is based on the classic Builder pattern. It makes sense to use an endomorphic design for framework configuration. Framework designers want to make it as easy to get started with their framework as possible. For this reason, it's important to provide a useful default configuration, so that you can get started with as little <a href="https://blog.ploeh.dk/2019/12/16/zone-of-ceremony">ceremony</a> as possible. On the other hand, a framework must be flexible. You need a way to tweak the configuration to support your particular needs. The Builder pattern supports both scenarios.
	</p>
	<p>
		Other examples include Test Data Builders, as well as specialised Builders such as <a href="https://docs.microsoft.com/dotnet/api/system.uribuilder">UriBuilder</a> and <a href="https://docs.microsoft.com/dotnet/api/system.data.sqlclient.sqlconnectionstringbuilder">SqlConnectionStringBuilder</a>.
	</p>
	<p>
		It's also worth noting that <a href="https://docs.microsoft.com/dotnet/fsharp/language-reference/copy-and-update-record-expressions">F# copy-and-update expressions</a> are endomorphisms. That's the reason that when you have immutable records, <a href="https://blog.ploeh.dk/2017/09/11/test-data-without-builders">you need no Test Data Builders</a>.
	</p>
	<h3 id="64b49f4143eb49fc80ab6344e247a0bd">
		Summary <a href="#64b49f4143eb49fc80ab6344e247a0bd" title="permalink">#</a>
	</h3>
	<p>
		The Builder pattern comes in (at least) three variations: the Gang-of-Four Builder pattern, Fluent Builder, and Immutable Fluent Builder. All are isomorphic to each other, and are equivalent to the endomorphism monoid.
	</p>
	<p>
		Viewing Builders as endomorphisms may mostly be an academic exercise, but I think it highlights the sweet spot for the pattern. It's particularly useful when you wish to expose an API that offers simple defaults, while at the same time enabling client code to make changes to those defaults. When those changes involve several steps (as e.g. <code>AddJsonBody</code>) you can view each modifier method as a <a href="https://en.wikipedia.org/wiki/Facade_pattern">Facade</a>.
	</p>
	<p>
		<strong>Next:</strong> <a href="https://blog.ploeh.dk/2018/06/25/visitor-as-a-sum-type">Visitor as a sum type</a>.
	</p>
</div>
   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms/">Builder isomorphisms</a></h2>
   <p>Monday, 10 February 2020 07:06:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>The Builder pattern is equivalent to the Fluent Builder pattern.</em>
	</p>
	<p>
		This article is part of <a href="https://blog.ploeh.dk/2018/01/08/software-design-isomorphisms">a series of articles about software design isomorphisms</a>. An isomorphism is when a bi-directional lossless translation exists between two representations. Such translations exist between the <a href="https://en.wikipedia.org/wiki/Builder_pattern">Builder</a> pattern and two variations of the <em>Fluent Builder</em> pattern. Since the names sound similar, this is hardly surprising.
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/builder-fluent-builder-isomorphism.png" alt="isomorphism between Builder, Fluent Builder, and Immutable Fluent Builder.">
	</p>
	<p>
		Given an implementation that uses one of those three patterns, you can translate your design into one of the other options. This doesn't imply that each is of equal value. When it comes to composability, both versions of Fluent Builder are superior to the classic Builder pattern.
	</p>
	<h3 id="553fdf908eb84ccb86a7c7972d45bc77">
		A critique of the Maze Builder example <a href="#553fdf908eb84ccb86a7c7972d45bc77" title="permalink">#</a>
	</h3>
	<p>
		In these articles, I usually first introduce the form presented in <a href="http://amzn.to/XBYukB">Design Patterns</a>. The code example given by the Gang of Four is, however, problematic. I'll start by pointing out the problems and then proceed to present a simpler, more useful example.
	</p>
	<p>
		The book presents an example centred on a <code>MazeBuilder</code> abstract class. The original example is in C++, but I here present my C# interpretation:
	</p>
	<pre><span>public</span>&nbsp;<span>abstract</span>&nbsp;<span>class</span>&nbsp;<span>MazeBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>virtual</span>&nbsp;<span>void</span>&nbsp;<span>BuildMaze</span>()&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>virtual</span>&nbsp;<span>void</span>&nbsp;<span>BuildRoom</span>(<span>int</span>&nbsp;<span>room</span>)&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>virtual</span>&nbsp;<span>void</span>&nbsp;<span>BuildDoor</span>(<span>int</span>&nbsp;<span>roomFrom</span>,&nbsp;<span>int</span>&nbsp;<span>roomTo</span>)&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>virtual</span>&nbsp;<span>Maze</span>&nbsp;<span>GetMaze</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>null</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		As the book states, "the maze-building operations of MazeBuilder do nothing by default. They're not declared pure virtual to let derived classes override only those methods in which they're interested." This means that you could technically write a derived class that overrides only <code>BuildRoom</code>. That's unlikely to be useful, since <code>GetMaze</code> still returns <code>null</code>.
	</p>
	<p>
		Moreover, the presence of the <code>BuildMaze</code> method indicates <a href="https://en.wikipedia.org/wiki/Sequential_coupling">sequential coupling</a>. A client (a <em>Director</em>, in the pattern language of <em>Design Patterns</em>) is supposed to first call <code>BuildMaze</code> before calling any of the other methods. What happens if a client forgets to call <code>BuildMaze</code>? What happens if client code calls the method <em>after</em> some of the other methods. What happens if it calls it multiple times?
	</p>
	<p>
		Another issue with the sample code is that it's unclear how it accomplishes its stated goal of separating "the construction of a complex object from its representation." The <code>StandardMazeBuilder</code> presented seems tightly coupled to the <code>Maze</code> class to a degree where it's hard to see how to untangle the two. The book fails to make a compelling example by instead presenting a <code>CountingMazeBuilder</code> that never implements <code>GetMaze</code>. It never constructs the desired complex object.
	</p>
	<p>
		Don't interpret this critique as a sweeping dismissal of the pattern, or the book in general. As this article series implies, I've invested significant energy in it. I consider the book seminal, but we've learned much since its publication in 1994. A common experience is that not all of the patterns in the book are equally useful, and of those that are, some are useful for different reasons than the book gives. The Builder pattern is an example of that.
	</p>
	<p>
		The Builder pattern isn't useful only because it enables you to "separate the construction of a complex object from its representation." It's useful because it enables you to present an API that comes with good default behaviour, but which can be tweaked into multiple configurations. The pattern is useful even without polymorphism.
	</p>
	<h3 id="ed99bc3715f541be8b6b9239848395e3">
		HTTP request Builder <a href="#ed99bc3715f541be8b6b9239848395e3" title="permalink">#</a>
	</h3>
	<p>
		The <a href="https://docs.microsoft.com/dotnet/api/system.net.http.httprequestmessage">HttpRequestMessage</a> class is a versatile API with good default behaviour, but it can be a bit awkward if you want to make an HTTP request with a body and particular headers. You can often get around the problem by using methods like <a href="https://docs.microsoft.com/dotnet/api/system.net.http.httpclient.postasync">PostAsync</a> on <a href="https://docs.microsoft.com/dotnet/api/system.net.http.httpclient">HttpClient</a>, but sometimes you need to drop down to <a href="https://docs.microsoft.com/dotnet/api/system.net.http.httpclient.sendasync">SendAsync</a>. When that happens, you need to build your own <code>HttpRequestMessage</code> objects. A Builder can encapsulate some of that work.
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>HttpRequestMessageBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>Uri</span>&nbsp;url;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>object</span>?&nbsp;jsonBody;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>string</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>new</span>&nbsp;<span>Uri</span>(<span>url</span>))&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.url&nbsp;=&nbsp;<span>url</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;=&nbsp;<span>HttpMethod</span>.Get;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpMethod</span>&nbsp;Method&nbsp;{&nbsp;<span>get</span>;&nbsp;<span>set</span>;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>void</span>&nbsp;<span>AddJsonBody</span>(<span>object</span>&nbsp;<span>jsonBody</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.jsonBody&nbsp;=&nbsp;<span>jsonBody</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>HttpRequestMessage</span>&nbsp;<span>Build</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>message</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessage</span>(Method,&nbsp;url);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>BuildBody</span>(<span>message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>message</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>void</span>&nbsp;<span>BuildBody</span>(<span>HttpRequestMessage</span>&nbsp;<span>message</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(jsonBody&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>&nbsp;<span>json</span>&nbsp;=&nbsp;<span>JsonConvert</span>.<span>SerializeObject</span>(jsonBody);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Content&nbsp;=&nbsp;<span>new</span>&nbsp;<span>StringContent</span>(<span>json</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>message</span>.Content.Headers.ContentType.MediaType&nbsp;=&nbsp;<span>"application/json"</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		Compared to <em>Design Patterns'</em> example, <code>HttpRequestMessageBuilder</code> isn't polymorphic. It doesn't inherit from a base class or implement an interface. As I pointed out in my critique of the <code>MazeBuilder</code> example, polymorphism doesn't seem to be the crux of the matter. You could easily introduce a base class or interface that defines the <code>Method</code>, <code>AddJsonBody</code>, and <code>Build</code> members, but what would be the point? Just like the <code>MazeBuilder</code> example fails to present a compelling <em>second</em> implementation, I can't think of another useful implementation of a hypothetical <code>IHttpRequestMessageBuilder</code> interface.
	</p>
	<p>
		Notice that I dropped the <em>Build</em> prefix from most of the Builder's members. Instead, I reserved the word <code>Build</code> for the method that actually creates the desired object. This is consistent with most modern Builder examples I've encountered.
	</p>
	<p>
		The <code>HttpRequestMessageBuilder</code> comes with a reasonable set of default behaviours. If you just want to make a <code>GET</code> request, you can easily do that:
	</p>
	<pre><span>var</span>&nbsp;<span>builder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>);
<span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>builder</span>.<span>Build</span>();
 
<span>HttpClient</span>&nbsp;<span>client</span>&nbsp;=&nbsp;<span>GetClient</span>();
<span>var</span>&nbsp;<span>response</span>&nbsp;=&nbsp;<span>await</span>&nbsp;<span>client</span>.<span>SendAsync</span>(<span>msg</span>);</pre>
	
	<p>
		Since you only call the <code>builder</code>'s <code>Build</code> method, but never any of the other members, you get the default behaviour. A <code>GET</code> request with no body.
	</p>
	<p>
		Notice that the <code>HttpRequestMessageBuilder</code> protects its invariants. It follows the maxim that you should never be able to put an object into an invalid state. Contrary to <em>Design Patterns'</em> <code>StandardMazeBuilder</code>, it uses its constructors to enforce an invariant. Regardless of what sort of <code>HttpRequestMessage</code> you want to build, it must have a URL. Both constructor overloads require all clients to supply one. (In order to keep the code example as simple as possible, I've omitted all sorts of precondition checks, like checking that <code>url</code> isn't null, that it's a valid URL, and so on.)
	</p>
	<p>
		If you need to make a <code>POST</code> request with a JSON body, you can change the defaults:
	</p>
	<pre><span>var</span>&nbsp;<span>builder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>);
<span>builder</span>.Method&nbsp;=&nbsp;<span>HttpMethod</span>.Post;
<span>builder</span>.<span>AddJsonBody</span>(<span>new</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;=&nbsp;<span>Guid</span>.<span>NewGuid</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;=&nbsp;<span>"2020-03-22&nbsp;19:30:00"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span>"Ælfgifu"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;email&nbsp;=&nbsp;<span>"ælfgifu@example.net"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;quantity&nbsp;=&nbsp;1&nbsp;});
<span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>builder</span>.<span>Build</span>();
 
<span>HttpClient</span>&nbsp;<span>client</span>&nbsp;=&nbsp;<span>GetClient</span>();
<span>var</span>&nbsp;<span>response</span>&nbsp;=&nbsp;<span>await</span>&nbsp;<span>client</span>.<span>SendAsync</span>(<span>msg</span>);</pre>
	
	<p>
		Other combinations of <code>Method</code> and <code>AddJsonBody</code> are also possible. You could, for example, make a <code>DELETE</code> request without a body by only changing the <code>Method</code>.
	</p>
	<p>
		This incarnation of <code>HttpRequestMessageBuilder</code> is cumbersome to use. You must first create a <code>builder</code> object and then mutate it. Once you've invoked its <code>Build</code> method, you rarely need the object any longer, but the <code>builder</code> variable is still in scope. You can address those usage issues by refactoring a Builder to a Fluent Builder.
	</p>
	<h3 id="38b145cd45674bd989ebd37ca92b40f6">
		HTTP request Fluent Builder <a href="#38b145cd45674bd989ebd37ca92b40f6" title="permalink">#</a>
	</h3>
	<p>
		In the Gang of Four Builder pattern, no methods return anything, except the method that creates the object you're building (<code>GetMaze</code> in the <code>MazeBuilder</code> example, <code>Build</code> in the <code>HttpRequestMessageBuilder</code> example). It's always possible to refactor such a Builder so that the <code>void</code> methods return something. They can always return the object itself:
	</p>
	<pre><span>public</span>&nbsp;<span>HttpMethod</span>&nbsp;Method&nbsp;{&nbsp;<span>get</span>;&nbsp;<span>private</span>&nbsp;<span>set</span>;&nbsp;}
 
<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>WithMethod</span>(<span>HttpMethod</span>&nbsp;<span>newMethod</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;=&nbsp;<span>newMethod</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>this</span>;
}
 
<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>AddJsonBody</span>(<span>object</span>&nbsp;<span>jsonBody</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.jsonBody&nbsp;=&nbsp;<span>jsonBody</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>this</span>;
}</pre>
	
	<p>
		Changing <code>AddJsonBody</code> is as easy as changing its return type and returning <code>this</code>. Refactoring the <code>Method</code> property is a bit more involved. It's a language feature of C# (and a few other languages) that classes can have properties, so this concern isn't general. In languages without properties, things are simpler. In C#, however, I chose to make the property setter private and instead add a method that returns <code>HttpRequestMessageBuilder</code>. Perhaps it's a little confusing that the name of the method includes the word <em>method</em>, but keep in mind that the method in question is an HTTP method.
	</p>
	<p>
		You can now create a <code>GET</code> request with a one-liner:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>).<span>Build</span>();</pre>
	
	<p>
		You don't have to declare any <code>builder</code> variable to mutate. Even when you need to change the defaults, you can just start with a builder and keep on chaining method calls:
	</p>
	<pre><span>HttpRequestMessage</span>&nbsp;<span>msg</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>WithMethod</span>(<span>HttpMethod</span>.Post)
&nbsp;&nbsp;&nbsp;&nbsp;.<span>AddJsonBody</span>(<span>new</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;=&nbsp;<span>Guid</span>.<span>NewGuid</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;=&nbsp;<span>"2020-03-22&nbsp;19:30:00"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span>"Ælfgifu"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;email&nbsp;=&nbsp;<span>"ælfgifu@example.net"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quantity&nbsp;=&nbsp;1&nbsp;})
&nbsp;&nbsp;&nbsp;&nbsp;.<span>Build</span>();</pre>
	
	<p>
		This creates a <code>POST</code> request with a JSON message body.
	</p>
	<p>
		We can call this pattern <em>Fluent Builder</em> because this version of the Builder pattern has a <a href="https://www.martinfowler.com/bliki/FluentInterface.html">Fluent Interface</a>.
	</p>
	<p>
		This usually works well enough in practice, but is vulnerable to <a href="https://en.wikipedia.org/wiki/Aliasing_(computing)">aliasing</a>. What happens if you reuse an <code>HttpRequestMessageBuilder</code> object?
	</p>
	<pre><span>var</span>&nbsp;<span>builder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>);
<span>var</span>&nbsp;<span>deleteMsg</span>&nbsp;=&nbsp;<span>builder</span>.<span>WithMethod</span>(<span>HttpMethod</span>.Delete).<span>Build</span>();
<span>var</span>&nbsp;<span>getMsg</span>&nbsp;=&nbsp;<span>builder</span>.<span>Build</span>();</pre>
	
	<p>
		As the variable names imply, the programmer responsible for these three lines of code incorrectly believed that without the call to <code>WithMethod</code>, the <code>builder</code> will use its default behaviour when <code>Build</code> is called. The previous line of code, however, mutated the <code>builder</code> object. Its <code>Method</code> property remains <code>HttpMethod.Delete</code> until another line of code changes it!
	</p>
	<h3 id="a75c7962ece449f6b6161fe6ae7beb1e">
		HTTP request Immutable Fluent Builder <a href="#a75c7962ece449f6b6161fe6ae7beb1e" title="permalink">#</a>
	</h3>
	<p>
		You can disarm the aliasing booby trap by making the Fluent Builder immutable. A good first step in that refactoring is making sure that all class fields are <code>readonly</code>:
	</p>
	<pre><span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>Uri</span>&nbsp;url;
<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>object</span>?&nbsp;jsonBody;</pre>
	
	<p>
		The <code>url</code> field was already marked <code>readonly</code>, so the change only applies to the <code>jsonBody</code> field. In addition to the class fields, don't forget any automatic properties:
	</p>
	<pre><span>public</span>&nbsp;<span>HttpMethod</span>&nbsp;Method&nbsp;{&nbsp;<span>get</span>;&nbsp;}</pre>
	
	<p>
		The <code>HttpMethod</code> property previously had a <code>private</code> setter, but this is now gone. It's also strictly read only.
	</p>
	<p>
		Now that all data is read only, the only way you can 'change' values is via a constructor. Add a constructor overload that receives all data and chain the other constructors into it:
	</p>
	<pre><span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>string</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>new</span>&nbsp;<span>Uri</span>(<span>url</span>))&nbsp;{&nbsp;}
 
<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>)&nbsp;:&nbsp;<span>this</span>(<span>url</span>,&nbsp;<span>HttpMethod</span>.Get,&nbsp;<span>null</span>)&nbsp;{&nbsp;}
 
<span>private</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>Uri</span>&nbsp;<span>url</span>,&nbsp;<span>HttpMethod</span>&nbsp;<span>method</span>,&nbsp;<span>object</span>?&nbsp;<span>jsonBody</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.url&nbsp;=&nbsp;<span>url</span>;
&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;=&nbsp;<span>method</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.jsonBody&nbsp;=&nbsp;<span>jsonBody</span>;
}</pre>
	
	<p>
		I'm usually not keen on allowing <code>null</code> arguments, but I made the all-encompassing constructor <code>private</code>. In that way, at least no client code gets the wrong idea.
	</p>
	<p>
		The optional modification methods can now only do one thing: return a new object:
	</p>
	<pre><span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>WithMethod</span>(<span>HttpMethod</span>&nbsp;<span>newMethod</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(url,&nbsp;<span>newMethod</span>,&nbsp;jsonBody);
}
 
<span>public</span>&nbsp;<span>HttpRequestMessageBuilder</span>&nbsp;<span>AddJsonBody</span>(<span>object</span>&nbsp;<span>jsonBody</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(url,&nbsp;Method,&nbsp;<span>jsonBody</span>);
}</pre>
	
	<p>
		The client code looks the same as before, but now you no longer have an aliasing problem:
	</p>
	<pre><span>var</span>&nbsp;<span>builder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>HttpRequestMessageBuilder</span>(<span>url</span>);
<span>var</span>&nbsp;<span>deleteMsg</span>&nbsp;=&nbsp;<span>builder</span>.<span>WithMethod</span>(<span>HttpMethod</span>.Delete).<span>Build</span>();
<span>var</span>&nbsp;<span>getMsg</span>&nbsp;=&nbsp;<span>builder</span>.<span>Build</span>();</pre>
	
	<p>
		Now <code>deleteMsg</code> represents a <code>Delete</code> request, and <code>getMsg</code> truly represents a <code>GET</code> request.
	</p>
	<p>
		Since this variation of the Fluent Builder pattern is immutable, it's natural to call it an <em>Immutable Fluent Builder</em>.
	</p>
	<p>
		You've now seen how to refactor from Builder via Fluent Builder to Immutable Fluent Builder. If these three pattern variations are truly isomorphic, it should also be possible to move in the other direction. I'll leave it as an exercise for the reader to do this with the HTTP request Builder example. Instead, I will briefly discuss another example that starts at the Fluent Builder pattern.
	</p>
	<h3 id="87464a8b3f4d4922b3929c50e098c344">
		Test Data Fluent Builder <a href="#87464a8b3f4d4922b3929c50e098c344" title="permalink">#</a>
	</h3>
	<p>
		A prominent example of the Fluent Builder pattern would be the set of all <a href="http://www.natpryce.com/articles/000714.html">Test Data Builders</a>. I'm going to use the example I've <a href="https://blog.ploeh.dk/2017/08/15/test-data-builders-in-c">already covered</a>. You can visit the previous article for all details, but in summary, you can, for example, write code like this:
	</p>
	<pre><span>Address</span>&nbsp;<span>address</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>AddressBuilder</span>().<span>WithCity</span>(<span>"Paris"</span>).<span>Build</span>();</pre>
	
	<p>
		This creates an <code>Address</code> object with the <code>City</code> property set to <code>"Paris"</code>. The <code>Address</code> class comes with other properties. You can trust that the <code>AddressBuilder</code> gave them values, but you don't know what they are. You can use this pattern in unit tests when you need an <code>Address</code> in <a href="https://en.wikipedia.org/wiki/Paris">Paris</a>, but you don't care about any of the other data.
	</p>
	<p>
		In my previous article, I implemented <code>AddressBuilder</code> as a Fluent Builder. I did that in order to stay as true to <a href="http://www.natpryce.com/">Nat Pryce</a>'s original example as possible. Whenever I use the Test Data Builder pattern in earnest, however, I use the immutable variation so that I avoid the aliasing issue.
	</p>
	<h3 id="4274fe6c008e41bd8d4e596b9cc11762">
		Test Data Builder as a Gang-of-Four Builder <a href="#4274fe6c008e41bd8d4e596b9cc11762" title="permalink">#</a>
	</h3>
	<p>
		You can easily refactor a typical Test Data Builder like <code>AddressBuilder</code> to a shape more reminiscent of the Builder pattern presented in <em>Design Patterns</em>. Apart from the <code>Build</code> method that produces the object being built, change all other methods to <code>void</code> methods:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>AddressBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>string</span>&nbsp;street;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>string</span>&nbsp;city;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>PostCode</span>&nbsp;postCode;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>AddressBuilder</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.street&nbsp;=&nbsp;<span>""</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.city&nbsp;=&nbsp;<span>""</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.postCode&nbsp;=&nbsp;<span>new</span>&nbsp;<span>PostCodeBuilder</span>().<span>Build</span>();
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>void</span>&nbsp;<span>WithStreet</span>(<span>string</span>&nbsp;<span>newStreet</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.street&nbsp;=&nbsp;<span>newStreet</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>void</span>&nbsp;<span>WithCity</span>(<span>string</span>&nbsp;<span>newCity</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.city&nbsp;=&nbsp;<span>newCity</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>void</span>&nbsp;<span>WithPostCode</span>(<span>PostCode</span>&nbsp;<span>newPostCode</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.postCode&nbsp;=&nbsp;<span>newPostCode</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>void</span>&nbsp;<span>WithNoPostcode</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.postCode&nbsp;=&nbsp;<span>new</span>&nbsp;<span>PostCode</span>();
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>Address</span>&nbsp;<span>Build</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>Address</span>(<span>this</span>.street,&nbsp;<span>this</span>.city,&nbsp;<span>this</span>.postCode);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
	
	<p>
		You can still build a test address in Paris, but it's now more inconvenient.
	</p>
	<pre><span>var</span>&nbsp;<span>addressBuilder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>AddressBuilder</span>();
<span>addressBuilder</span>.<span>WithCity</span>(<span>"Paris"</span>);
 
<span>Address</span>&nbsp;<span>address</span>&nbsp;=&nbsp;<span>addressBuilder</span>.<span>Build</span>();</pre>
	
	<p>
		You can still use multiple Test Data Builders to build more complex test data, but the classic Builder pattern doesn't compose well.
	</p>
	<pre><span>var</span>&nbsp;<span>invoiceBuilder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>InvoiceBuilder</span>();
<span>var</span>&nbsp;<span>recipientBuilder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>RecipientBuilder</span>();
<span>var</span>&nbsp;<span>addressBuilder</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>AddressBuilder</span>();
<span>addressBuilder</span>.<span>WithNoPostcode</span>();
<span>recipientBuilder</span>.<span>WithAddress</span>(<span>addressBuilder</span>.<span>Build</span>());
<span>invoiceBuilder</span>.<span>WithRecipient</span>(<span>recipientBuilder</span>.<span>Build</span>());
<span>Invoice</span>&nbsp;<span>invoice</span>&nbsp;=&nbsp;<span>invoiceBuilder</span>.<span>Build</span>();</pre>
	
	<p>
		These seven lines of code creates an <code>Invoice</code> object with a address without a post code. Compare that with the Fluent Builder <a href="https://blog.ploeh.dk/2017/08/15/test-data-builders-in-c#de2e6fb74f6f4319a0fef86dcd9b839e">example in the previous article</a>. This is a clear example that while the variations are isomorphic, they aren't equally useful. The classic Builder pattern isn't as practical as one of the Fluent variations.
	</p>
	<p>
		You might protest that this variation of <code>AddressBuilder</code>, <code>InvoiceBuilder</code>, etcetera isn't equivalent to the Builder pattern. After all, the Builder shown in <em>Design Patterns</em> is polymorphic. That's really not an issue, though. Just extract an interface from the concrete builder:
	</p>
	<pre><span>public</span>&nbsp;<span>interface</span>&nbsp;<span>IAddressBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>Address</span>&nbsp;<span>Build</span>();
&nbsp;&nbsp;&nbsp;&nbsp;<span>void</span>&nbsp;<span>WithCity</span>(<span>string</span>&nbsp;<span>newCity</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>void</span>&nbsp;<span>WithNoPostcode</span>();
&nbsp;&nbsp;&nbsp;&nbsp;<span>void</span>&nbsp;<span>WithPostCode</span>(<span>PostCode</span>&nbsp;<span>newPostCode</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>void</span>&nbsp;<span>WithStreet</span>(<span>string</span>&nbsp;<span>newStreet</span>);
}</pre>
	
	<p>
		Make the concrete class implement the interface:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>AddressBuilder</span>&nbsp;:&nbsp;<span>IAddressBuilder</span></pre>
	
	<p>
		You could argue that this adds no value. You'd be right. This goes contrary to the <a href="http://www.codemanship.co.uk/parlezuml/blog/?postid=934">Reused Abstractions Principle</a>. I think that the same criticism applies to <em>Design Patterns</em>' original description of the pattern, as I've already pointed out. The utility in the pattern comes from how it gives client code good defaults that it can then tweak as necessary.
	</p>
	<h3 id="a1e866bafec74def9a66f5ba96a0cca4">
		Summary <a href="#a1e866bafec74def9a66f5ba96a0cca4" title="permalink">#</a>
	</h3>
	<p>
		The Builder pattern was originally described in <em>Design Patterns</em>. Later, smart people like Nat Pryce figured out that by letting each mutating operation return the (mutated) Builder, such a Fluent API offered superior composability. A further improvement to the Fluent Builder pattern makes the Builder immutable in order to avoid aliasing issues.
	</p>
	<p>
		All three variations are isomorphic. Work that one of these variations afford is also afforded by the other variations.
	</p>
	<p>
		On the other hand, the variations aren't equally useful. Fluent APIs offer superior composability.
	</p>
	<p>
		<strong>Next:</strong> <a href="https://blog.ploeh.dk/2018/05/22/church-encoding">Church encoding</a>.
	</p>
</div>


   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/02/03/non-exceptional-averages/">Non-exceptional averages</a></h2>
   <p>Monday, 03 February 2020 06:38:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>How do you code without exceptions? Here's one example.</em>
	</p>
	<p>
		Encouraging object-oriented programmers to <a href="https://hackernoon.com/the-throw-keyword-was-a-mistake-l9e532di">avoid throwing exceptions</a> is as fun as telling them to renounce null references. To be fair, exception-throwing is such an ingrained feature of C#, Java, C++, etcetera that it can be hard to see how to do without it.
	</p>
	<p>
		To be clear, I don't insist that you pretend that exceptions don't exist in languages that have them. I'm also <a href="https://eiriktsarpalis.wordpress.com/2017/02/19/youre-better-off-using-exceptions">not advocating that you catch all exceptions in order to resurface them as railway-oriented programming</a>. On the other hand, I do endorse the generally good advice that you shouldn't use exceptions for <a href="https://en.wikipedia.org/wiki/Control_flow">control flow</a>.
	</p>
	<p>
		What can you do instead? Despite <a href="https://fsharpforfunandprofit.com/posts/against-railway-oriented-programming">all the warnings against railway-oriented programming</a>, <a href="https://blog.ploeh.dk/2018/06/11/church-encoded-either">Either</a> is still a good choice for a certain kind of control flow. Exceptions are for <em>exceptional</em> situations, such as network partitions, running out of memory, disk failures, and so on. Many run-time errors are both foreseeable and preventable. Prefer code that prevents errors.
	</p>
	<p>
		There's a few ways you can do that. One of them is to protect invariants by enforcing pre-conditions. If you have a static type system, you can use the type system to prevent errors.
	</p>
	<h3 id="ccb791521ac0417f870a2fe4dac946c7">
		Average duration <a href="#ccb791521ac0417f870a2fe4dac946c7" title="permalink">#</a>
	</h3>
	<p>
		How would you calculate the average of a set of durations? You might, for example, <a href="https://blog.ploeh.dk/2017/06/27/pure-times">need to calculate average duration of message handling for a polling consumer</a>. C# offers many built-in overloads of the <a href="https://docs.microsoft.com/dotnet/api/system.linq.enumerable.average">Average</a> extension method, but none that calculates the average of <a href="https://docs.microsoft.com/dotnet/api/system.timespan">TimeSpan</a> values.
	</p>
	<p>
		How would you write that method yourself?
	</p>
	<p>
		It's not a trick question.
	</p>
	<p>
		Based on my experience coaching development teams, this is a representative example:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>TimeSpan</span>&nbsp;<span>Average</span>(<span>this</span>&nbsp;<span>IEnumerable</span>&lt;<span>TimeSpan</span>&gt;&nbsp;<span>timeSpans</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>sum</span>&nbsp;=&nbsp;<span>TimeSpan</span>.Zero;
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>count</span>&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;<span>foreach</span>&nbsp;(<span>var</span>&nbsp;<span>ts</span>&nbsp;<span>in</span>&nbsp;<span>timeSpans</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>sum</span>&nbsp;<span>+=</span>&nbsp;<span>ts</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>count</span>++;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>sum</span>&nbsp;<span>/</span>&nbsp;<span>count</span>;
}</pre>
	
	<p>
		This gets the job done in most situations, but it has two error modes. It doesn't work if <code>timeSpans</code> is empty, and it doesn't work if it's infinite.
	</p>
	<p>
		When the input collection is empty, you'll be trying to divide by zero, which isn't allowed. How do you deal with that? Most programmers I've met just shrug and say: <em>don't call the method with an empty collection.</em> Apparently, it's your responsibility as the caller. You have to memorise that this particular <code>Average</code> method has that particular precondition.
	</p>
	<p>
		I don't think that's a professional position. This puts the burden on client developers. In a world like that, you have to learn by rote the preconditions of thousands of APIs.
	</p>
	<p>
		What can you do? You could add a <a href="https://en.wikipedia.org/wiki/Guard_(computer_science)">Guard Clause</a> to the method.
	</p>
	<h3 id="38f629930c7845c0af1c50c586dfcb82">
		Guard Clause <a href="#38f629930c7845c0af1c50c586dfcb82" title="permalink">#</a>
	</h3>
	<p>
		Adding a Guard Clause doesn't really make the method much easier to reason about for client developers, but at least it protects an invariant.
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>TimeSpan</span>&nbsp;<span>Average</span>(<span>this</span>&nbsp;<span>IEnumerable</span>&lt;<span>TimeSpan</span>&gt;&nbsp;<span>timeSpans</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(!<span>timeSpans</span>.<span>Any</span>())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>throw</span>&nbsp;<span>new</span>&nbsp;<span>ArgumentOutOfRangeException</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>nameof</span>(<span>timeSpans</span>),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>"Can't&nbsp;calculate&nbsp;the&nbsp;average&nbsp;of&nbsp;an&nbsp;empty&nbsp;collection."</span>);
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>sum</span>&nbsp;=&nbsp;<span>TimeSpan</span>.Zero;
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>count</span>&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;<span>foreach</span>&nbsp;(<span>var</span>&nbsp;<span>ts</span>&nbsp;<span>in</span>&nbsp;<span>timeSpans</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>sum</span>&nbsp;<span>+=</span>&nbsp;<span>ts</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>count</span>++;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>sum</span>&nbsp;<span>/</span>&nbsp;<span>count</span>;
}</pre>
	
	<p>
		Don't get me wrong. I often write code like this because it makes it easier for me as a library developer to reason about the rest of the method body. On the other hand, it basically just replaces one run-time exception with another. Before I added the Guard Clause, calling <code>Average</code> with an empty collection would cause it to throw an <code>OverflowException</code>; now it throws an <code>ArgumentOutOfRangeException</code>.
	</p>
	<p>
		From client developers' perspective, this is only a marginal improvement. You're still getting no help from the type system, but at least the run-time error is a bit more informative. Sometimes, that's the best you can do.
	</p>
	<h3 id="3825bb6fb4db4cd28b9134763d202b3a">
		Finite collections <a href="#3825bb6fb4db4cd28b9134763d202b3a" title="permalink">#</a>
	</h3>
	<p>
		The <code>Average</code> method has two preconditions, but we've only addressed one. The other precondition is that the input <code>timeSpans</code> must be finite. Unfortunately, this compiles:
	</p>
	<pre><span>static</span>&nbsp;<span>IEnumerable</span>&lt;<span>T</span>&gt;&nbsp;<span>InfinitelyRepeat</span>&lt;<span>T</span>&gt;(<span>T</span>&nbsp;<span>x</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>while</span>&nbsp;(<span>true</span>)&nbsp;<span>yield</span>&nbsp;<span>return</span>&nbsp;<span>x</span>;
}
<span>var</span>&nbsp;<span>ts</span>&nbsp;=&nbsp;<span>new</span>&nbsp;<span>TimeSpan</span>(1,&nbsp;2,&nbsp;3,&nbsp;4);
<span>var</span>&nbsp;<span>tss</span>&nbsp;=&nbsp;<span>InfinitelyRepeat</span>(<span>ts</span>);
 
<span>var</span>&nbsp;<span>avg</span>&nbsp;=&nbsp;<span>tss</span>.<span>Average</span>();</pre>
	
	<p>
		Since <code>tss</code> infinitely repeats <code>ts</code>, the <code>Average</code> method call (theoretically) loops forever; in fact it quickly overflows because it keeps adding <code>TimeSpan</code> values together.
	</p>
	<p>
		Infinite collections aren't allowed. Can you make that precondition explicit?
	</p>
	<p>
		I don't know of a way to test that <code>timeSpans</code> is finite at run time, but I can change the input type:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>TimeSpan</span>&nbsp;<span>Average</span>(<span>this</span>&nbsp;<span>IReadOnlyCollection</span>&lt;<span>TimeSpan</span>&gt;&nbsp;<span>timeSpans</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(!<span>timeSpans</span>.<span>Any</span>())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>throw</span>&nbsp;<span>new</span>&nbsp;<span>ArgumentOutOfRangeException</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>nameof</span>(<span>timeSpans</span>),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>"Can't&nbsp;calculate&nbsp;the&nbsp;average&nbsp;of&nbsp;an&nbsp;empty&nbsp;collection."</span>);
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>sum</span>&nbsp;=&nbsp;<span>TimeSpan</span>.Zero;
&nbsp;&nbsp;&nbsp;&nbsp;<span>foreach</span>&nbsp;(<span>var</span>&nbsp;<span>ts</span>&nbsp;<span>in</span>&nbsp;<span>timeSpans</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>sum</span>&nbsp;<span>+=</span>&nbsp;<span>ts</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>sum</span>&nbsp;<span>/</span>&nbsp;<span>timeSpans</span>.Count;
}</pre>
	
	<p>
		Instead of accepting any <code>IEnumerable&lt;TimeSpan&gt;</code> as an input argument, I've now constrained <code>timeSpans</code> to an <code>IReadOnlyCollection&lt;TimeSpan&gt;</code>. <a href="https://docs.microsoft.com/dotnet/api/system.collections.generic.ireadonlycollection-1">This interface</a> has been in .NET since .NET 4.5 (<a href="https://blog.ploeh.dk/2013/07/20/linq-versus-the-lsp">I think</a>), but it lives a quiet existence. Few people know of it.
	</p>
	<p>
		It's just <code>IEnumerable&lt;T&gt;</code> with an extra constraint:
	</p>
	<pre><span>public</span>&nbsp;<span>interface</span>&nbsp;<span>IReadOnlyCollection</span>&lt;<span>T</span>&gt;&nbsp;:&nbsp;<span>IEnumerable</span>&lt;<span>T</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;Count&nbsp;{&nbsp;<span>get</span>;&nbsp;}
}</pre>
	
	<p>
		The <code>Count</code> property strongly implies that the <code>IEnumerable&lt;T&gt;</code> is finite. Also, that the value is an <code>int</code> implies that the maximum size of the collection is 2,147,483,647. That's probably going to be enough for most day-to-day use.
	</p>
	<p>
		You can no longer pass an infinite stream of values to the <code>Average</code> method. It's simply not going to compile. That both communicates and protects the invariant that infinite collections aren't allowed. It also makes the implementation code simpler, since the method doesn't have to count the elements. That information is already available from <code>timeSpans.Count</code>.
	</p>
	<p>
		If a type can address one invariant, can it also protect the other?
	</p>
	<h3 id="b1464fa0dafc42838b6f7db24d8356c8">
		Non-empty collection <a href="#b1464fa0dafc42838b6f7db24d8356c8" title="permalink">#</a>
	</h3>
	<p>
		You can change the input type again. Here I've used <a href="https://blog.ploeh.dk/2017/12/11/semigroups-accumulate">this NotEmptyCollection&lt;T&gt; implementation</a>:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>TimeSpan</span>&nbsp;<span>Average</span>(<span>this</span>&nbsp;<span>NotEmptyCollection</span>&lt;<span>TimeSpan</span>&gt;&nbsp;<span>timeSpans</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>sum</span>&nbsp;=&nbsp;<span>timeSpans</span>.Head;
&nbsp;&nbsp;&nbsp;&nbsp;<span>foreach</span>&nbsp;(<span>var</span>&nbsp;<span>ts</span>&nbsp;<span>in</span>&nbsp;<span>timeSpans</span>.Tail)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>sum</span>&nbsp;<span>+=</span>&nbsp;<span>ts</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>sum</span>&nbsp;<span>/</span>&nbsp;<span>timeSpans</span>.Count;
}</pre>
	
	<p>
		Now client code can no longer call the <code>Average</code> method with an empty collection. That's also not going to compile.
	</p>
	<p>
		You've replaced a run-time check with a compile-time check. It's now clear to client developers who want to call the method that they must supply a <code>NotEmptyCollection&lt;TimeSpan&gt;</code>, instead of just any <code>IReadOnlyCollection&lt;TimeSpan&gt;</code>.
	</p>
	<p>
		You can also simplify the implementation code:
	</p>
	<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>TimeSpan</span>&nbsp;<span>Average</span>(<span>this</span>&nbsp;<span>NotEmptyCollection</span>&lt;<span>TimeSpan</span>&gt;&nbsp;<span>timeSpans</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;<span>sum</span>&nbsp;=&nbsp;<span>timeSpans</span>.<span>Aggregate</span>((<span>x</span>,&nbsp;<span>y</span>)&nbsp;=&gt;&nbsp;<span>x</span>&nbsp;<span>+</span>&nbsp;<span>y</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>sum</span>&nbsp;<span>/</span>&nbsp;<span>timeSpans</span>.Count;
}</pre>
	
	<p>
		How do we know that <code>NotEmptyCollection&lt;T&gt;</code> contains at least one element? The constructor enforces that constraint:
	</p>
	<pre><span>public</span>&nbsp;<span>NotEmptyCollection</span>(<span>T</span>&nbsp;<span>head</span>,&nbsp;<span>params</span>&nbsp;<span>T</span>[]&nbsp;<span>tail</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(<span>head</span>&nbsp;==&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>throw</span>&nbsp;<span>new</span>&nbsp;<span>ArgumentNullException</span>(<span>nameof</span>(<span>head</span>));
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.Head&nbsp;=&nbsp;<span>head</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.Tail&nbsp;=&nbsp;<span>tail</span>;
}</pre>
	
	<p>
		But wait, there's a Guard Clause and a <code>throw</code> there! Have we even accomplished anything, or did we just move the <code>throw</code> around?
	</p>
	<h3 id="ef73390937dc4f88997c7d42496b591e">
		Parse, don't validate <a href="#ef73390937dc4f88997c7d42496b591e" title="permalink">#</a>
	</h3>
	<p>
		A Guard Clause is a kind of validation. It validates that input fulfils preconditions. The problem with validation is that you have to repeat it in various different places. Every time you receive some data as an input argument, it may or may not have been validated. A receiving method can't tell. There's no flag on a string, or a number, or a collection, which is set when data has been validated. 
	</p>
	<p>
		Every method that receives such an input will have to perform validation, just to be sure that the preconditions hold. This leads to validation code being duplicated over a code base. When you duplicate code, you later update it in most of the places it appears, but forget to update it in a few places. Even if you're meticulous, a colleague may not know about the proper way of validating a piece of data. This leads to bugs.
	</p>
	<p>
		As <a href="https://lexi-lambda.github.io/">Alexis King</a> explains in her <a href="https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate">Parse, don’t validate</a> article, 'parsing' is the process of validating input of weaker type into a value of a stronger type. The stronger type indicates that validation has happened. It's like a Boolean flag that indicates that, yes, the data contained in the type has been through validation, and found to hold.
	</p>
	<p>
		This is also the case of <code>NotEmptyCollection&lt;T&gt;</code>. If you have an object of that type, you know that it has already been validated. You know that the collection isn't empty. Even if you think that it looks like we've just replaced one exception with another, that's not the point. The point is that we've replaced scattered and unsystematic validation code with a single verification step.
	</p>
	<p>
		You may still be left with the nagging doubt that I didn't really avoid throwing an exception. I think that the <code>NotEmptyCollection&lt;T&gt;</code> constructor strikes a pragmatic balance. If you look only at the information revealed by the type (i.e. what an <a href="https://en.wikipedia.org/wiki/Integrated_development_environment">IDE</a> would display), you'll see this when you program against the class:
	</p>
	<pre><span>public</span>&nbsp;<span>NotEmptyCollection</span>(<span>T</span>&nbsp;<span>head</span>,&nbsp;<span>params</span>&nbsp;<span>T</span>[]&nbsp;<span>tail</span>)</pre>
	
	<p>
		While you could, technically, pass <code>null</code> as the <code>head</code> parameter, it should be clear to you that you're trying to do something you're not supposed to do: <code>head</code> is <em>not</em> an optional argument. Had it been optional, the API designer should have provided an overload that you could call without any value. Such a constructor overload isn't available here, so if you try to cheat the compiler by passing <code>null</code>, don't be surprised to get a run-time exception.
	</p>
	<p>
		For what it's worth, I believe that you can only be pragmatic if you know how to be dogmatic. Is it possible to protect <code>NotEmptyCollection&lt;T&gt;</code>'s invariants without throwing exceptions?
	</p>
	<p>
		Yes, you could do that by making the constructor <code>private</code> and instead afford a static factory method that returns a <a href="https://blog.ploeh.dk/2018/03/26/the-maybe-functor">Maybe</a> or <a href="https://blog.ploeh.dk/2018/06/11/church-encoded-either">Either</a> value. In <a href="https://www.haskell.org/">Haskell</a>, this is typically called a <em>smart constructor</em>. It's only a few lines of code, so I could easily show it here. I chose not to, though, because I'm concerned that readers will interpret this article the wrong way. I like Maybe and Either a lot, but I agree with the above critics that it may not be <a href="https://blog.ploeh.dk/2015/08/03/idiomatic-or-idiosyncratic">idiomatic</a> in object-oriented languages.
	</p>
	<h3 id="737101b053e847f08124d49659804bf6">
		Summary <a href="#737101b053e847f08124d49659804bf6" title="permalink">#</a>
	</h3>
	<p>
		<em>Encapsulation</em> is central to object-oriented design. It's the notion that it's an object's own responsibility to protect its invariants. In statically typed object-oriented programming languages, objects are instances of classes. Classes are types. Types encapsulate invariants; they carry with them guarantees.
	</p>
	<p>
		You can sometimes model invariants by using types. Instead of performing a run-time check on input arguments, you can declare constructors and methods in such a way that they only take arguments that are already guaranteed to be valid.
	</p>
	<p>
		That's one way to reduce the amount of exceptions that your code throws.
	</p>
</div>


   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/01/27/the-maitre-d-kata/">The Maître d' kata</a></h2>
   <p>Monday, 27 January 2020 06:45:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>A programming kata.</em>
	</p>
	<p>
		I <a href="https://blog.ploeh.dk/2020/01/13/on-doing-katas">recently wrote about doing programming katas</a>. You can find katas in many different places. Some sites exist exclusively for that purpose, such as the <a href="http://bit.ly/codekatas">Coding Dojo</a> or <a href="http://codekata.com/">CodeKata</a>. In other cases, you can find individual katas on blogs; one of my favourites is the <a href="http://claysnow.co.uk/recycling-tests-in-tdd">Diamond kata</a>. You can also lift exercises from other sources and treat them as katas. For example, I recently followed <a href="https://github.com/mikehadlow/Journeys">Mike Hadlow's lead</a> and <a href="https://blog.ploeh.dk/2019/10/28/a-basic-haskell-solution-to-the-robot-journeys-coding-exercise">turned a job applicant test into a programming exercise</a>. I've also taken exercises from books and repurposed them. For example, <a href="https://blog.ploeh.dk/2017/10/23/convex-hull-monoid">I've implemented the Graham Scan algorithm for finding convex hulls</a> a couple of times.
	</p>
	<p>
		In this article, I'll share an exercise that I've found inspiring myself. I'll call it <em>the Maître d' kata</em>.
	</p>
	<p>
		I present no code in this article. Part of what makes the exercise interesting, I think, is to figure out how to model the problem domain. I will, however, later publish one of my attempts at the kata.
	</p>
	<h3 id="73c0d7c81c1047d598cb6dbc8a49c99b">
		Problem statement <a href="#73c0d7c81c1047d598cb6dbc8a49c99b" title="permalink">#</a>
	</h3>
	<p>
		Imagine that you're developing an online restaurant reservation system. Part of the behaviour of such a system is to decide whether or not to accept a reservation. At a real restaurant, employees fill various roles required to make it work. In a high-end restaurant, the <a href="https://en.wikipedia.org/wiki/Ma%C3%AEtre_d%27h%C3%B4tel">maître d'</a> is responsible for taking reservations. I've named the kata after this role. If you're practising <a href="https://en.wikipedia.org/wiki/Domain-driven_design">domain-driven design</a>, you might want to name your object, class, or module <code>MaîtreD</code> or some such.
	</p>
	<p>
		The objective of the exercise is to implement the <code>MaîtreD</code> decision logic.
	</p>
	<p>
		Reservations are accepted on a first-come, first-served basis. As long as the restaurant has available seats for the desired reservation, it'll accept it.
	</p>
	<p>
		A reservation contains, at a minimum, a date and time as well as a positive quantity. Here's some examples:
		</p><table>
			<thead>
				<tr>
					<td>Date</td>
					<td>Quantity</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>August 8, 2050 at 19:30</td>
					<td>3</td>
				</tr>
				<tr>
					<td>November 27, 2022 at 18:45</td>
					<td>4</td>
				</tr>
				<tr>
					<td>February 27, 2014 at 13:22</td>
					<td>12</td>
				</tr>
			</tbody>
		</table>
	
	<p>
		Notice that dates can be in your future or past. You might want to assume that the maître d' would reject reservations in the past, but you can't assume <em>when</em> the code runs (or ran), so don't worry about that. Notice also that quantities are positive integers. While a quantity shouldn't be negative or zero, it could conceivably be large. I find it realistic, however, to keep quantities at low two-digit numbers or less.
	</p>
	<p>
		A reservation will likely contain other data, such as the name of the person making the reservation, contact information such as email or phone number, possibly also an ID, and so on. You may add these details if you want to make the exercise more realistic, but they're not required.
	</p>
	<p>
		I'm going to present one feature requirement at a time. If you read the entire article before you do the exercise, it'd correspond to gathering detailed requirements before starting to code. Alternatively, you could read the first requirement, do the exercise, read the next requirement, refactor your code, and so on. This would simulate a situation where your organisation gradually uncovers how the system ought to work.
	</p>
	<h3 id="f538ee06b5c54215bae10f661385893c">
		Boutique restaurant <a href="#f538ee06b5c54215bae10f661385893c" title="permalink">#</a>
	</h3>
	<p>
		As readers of <a href="https://blog.ploeh.dk/dippp">my book</a> may have detected, I'm a foodie. Some years ago I ate at <a href="https://www.blancanyc.com/">Blanca</a> in Brooklyn. That restaurant has one communal bar where everyone sits. There was room for twelve people, and dinner started at 19:00 whether you arrived on time or not. Such restaurants actually exist. It's an easy first step for the kata. Assume that the restaurant is only open for dinner, has no second seating, and a single shared table. This implies that the time of day of reservations doesn't matter, while the date still matters. Some possible test cases could be:
		</p><table>
			<thead>
				<tr>
					<td>Table size</td>
					<td>Existing reservations</td>
					<td>Candidate reservation</td>
					<td>Expected outcome</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>12</td>
					<td><em>none</em></td>
					<td>Quantity: 1</td>
					<td>Accepted</td>
				</tr>
				<tr>
					<td>12</td>
					<td><em>none</em></td>
					<td>Quantity: 13</td>
					<td>Rejected</td>
				</tr>
				<tr>
					<td>12</td>
					<td><em>none</em></td>
					<td>Quantity: 12</td>
					<td>Accepted</td>
				</tr>
				<tr>
					<td>4</td>
					<td>Quantity: 2, Date: 2023-09-14</td>
					<td>Quantity: 3, Date: 2023-09-14</td>
					<td>Rejected</td>
				</tr>
				<tr>
					<td>10</td>
					<td>Quantity: 2, Date: 2023-09-14</td>
					<td>Quantity: 3, Date: 2023-09-14</td>
					<td>Accepted</td>
				</tr>
				<tr>
					<td>10</td>
					<td>
						Quantity: 3, Date: 2023-09-14<br>
						Quantity: 2, Date: 2023-09-14<br>
						Quantity: 3, Date: 2023-09-14
					</td>
					<td>Quantity: 3, Date: 2023-09-14</td>
					<td>Rejected</td>
				</tr>
				<tr>
					<td>4</td>
					<td>Quantity: 2, Date: 2023-09-15</td>
					<td>Quantity: 3, Date: 2023-09-14</td>
					<td>Accepted</td>
				</tr>
			</tbody>
		</table>
	
	<p>
		This may not be an exhaustive set of test cases, but hopefully illustrates the desired behaviour. Try using the <a href="https://blog.ploeh.dk/2019/10/07/devils-advocate">Devil's Advocate technique</a> or <a href="https://blog.ploeh.dk/property-based-testing-intro">property-based testing</a> to identify more test cases.
	</p>
	<h3 id="05f0ec26d90044288845f5ad308742c2">
		Haute cuisine <a href="#05f0ec26d90044288845f5ad308742c2" title="permalink">#</a>
	</h3>
	<p>
		The single-shared-table configuration is unusual. Most restaurants have separate tables. High-end restaurants like those on the <a href="https://www.theworlds50best.com/">World's 50 best</a> list, or those with <a href="https://en.wikipedia.org/wiki/Michelin_Guide">Michelin stars</a> often have only a single seating. This is a good expansion of the domain logic.
	</p>
	<p>
		Assume that a restaurant has several tables, perhaps of different sizes. A table for four will seat one, two, three, or four people. Once a table is reserved, however, all the seats at that table are reserved. A reservation for three people will occupy a table for four, and the redundant seat is wasted. Obviously, the restaurant wants to maximise the number of guests, so it'll favour reserving two-person tables for one and two people, four-person tables for three and four people, and so on.
	</p>
	<p>
		In order to illustrate the desired behaviour, here's some extra test cases to add to the ones already in place:
		</p><table>
			<thead>
				<tr>
					<td>Tables</td>
					<td>Existing reservations</td>
					<td>Candidate reservation</td>
					<td>Expected outcome</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>
						Two tables for two<br>
						Two tables for four
					</td>				
					<td><em>none</em></td>
					<td>Quantity: 4, Date: 2024-06-07</td>
					<td>Accepted</td>
				</tr>
				<tr>
					<td>
						Two tables for two<br>
						Two tables for four
					</td>				
					<td><em>none</em></td>
					<td>Quantity: 5, Date: 2024-06-07</td>
					<td>Rejected</td>
				</tr>
				<tr>
					<td>
						Two tables for two<br>
						One table for four
					</td>				
					<td>Quantity: 2, Date: 2024-06-07</td>
					<td>Quantity: 4, Date: 2024-06-07</td>
					<td>Accepted</td>
				</tr>
				<tr>
					<td>
						Two tables for two<br>
						One table for four
					</td>				
					<td>Quantity: 3, Date: 2024-06-07</td>
					<td>Quantity: 4, Date: 2024-06-07</td>
					<td>Rejected</td>
				</tr>
			</tbody>
		</table>
	
	<p>
		Again, you should consider adding more test cases if you're unit-testing the kata.
	</p>
	<h3 id="e008d27660b54882816e2e496ee89709">
		Second seatings <a href="#e008d27660b54882816e2e496ee89709" title="permalink">#</a>
	</h3>
	<p>
		Some restaurants (even some of those on the <em>World's 50 best</em> list) have a second seating. As a diner, you have a limited time (e.g. 2½ hours) to complete your meal. After that, other guests get your table.
	</p>
	<p>
		This implies that you must now consider the time of day of reservations. You should also be able to use an arbitrary (positive) seating duration. All previous rules should still apply. New test cases include:
		</p><table>
			<thead>
				<tr>
					<td>Seating duration</td>
					<td>Tables</td>
					<td>Existing reservations</td>
					<td>Candidate reservation</td>
					<td>Expected outcome</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>2 hours</td>
					<td>
						Two tables for two<br>
						One table for four
					</td>				
					<td>Quantity: 4, Date: 2023-10-22, Time: 18:00</td>
					<td>Quantity: 3, Date: 2023-10-22, Time: 20:00</td>
					<td>Accepted</td>
				</tr>
				<tr>
					<td>2½ hours</td>
					<td>
						One table for two<br>
						Two tables for four
					</td>				
					<td>
						Quantity: 2, Date: 2023-10-22, Time: 18:00<br>
						Quantity: 1, Date: 2023-10-22, Time: 18:15<br>
						Quantity: 2, Date: 2023-10-22, Time: 17:45
					</td>
					<td>Quantity: 3, Date: 2023-10-22, Time: 20:00</td>
					<td>Rejected</td>
				</tr>
				<tr>
					<td>2½ hours</td>
					<td>
						One table for two<br>
						Two tables for four
					</td>				
					<td>
						Quantity: 2, Date: 2023-10-22, Time: 18:00<br>
						Quantity: 2, Date: 2023-10-22, Time: 17:45
					</td>
					<td>Quantity: 3, Date: 2023-10-22, Time: 20:00</td>
					<td>Accepted</td>
				</tr>
				<tr>
					<td>2½ hours</td>
					<td>
						One table for two<br>
						Two tables for four
					</td>				
					<td>
						Quantity: 2, Date: 2023-10-22, Time: 18:00<br>
						Quantity: 1, Date: 2023-10-22, Time: 18:15<br>
						Quantity: 2, Date: 2023-10-22, Time: 17:45
					</td>
					<td>Quantity: 3, Date: 2023-10-22, Time: 20:15</td>
					<td>Accepted</td>
				</tr>
			</tbody>
		</table>
	
	<p>
		If you make the seating duration short enough, you may even make room for a third seating, and so on.
	</p>
	<h3 id="cec332ae8ea444de929c2f5ca5603e90">
		Alternative table configurations <a href="#cec332ae8ea444de929c2f5ca5603e90" title="permalink">#</a>
	</h3>
	<p>
		If tables are rectangular, the restaurant has the option to combine several smaller tables into one larger. Consider a typical restaurant layout like this:
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/restaurant-configuration-with-three-individual-two-person-tables.png" alt="A map of a restaurant including three adjacent two-person tables.">
	</p>
	<p>
		There's a round four-person table, as well as a few small tables that can't easily be pushed together. There's also three (orange) two-person tables where one guest sits against the wall, and the other diner faces him or her. These can be used as shown above, but the restaurant can also push two of these tables together to accommodate four people:
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/restaurant-configuration-with-two-two-person-tables-combined.png" alt="A map of a restaurant where two of the three adjacent two-person tables have been pushed together.">
	</p>
	<p>
		This still leaves one of the adjacent two-person tables as an individual table, but the restaurant can also push all three tables together to accommodate six people:
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/restaurant-configuration-with-all-two-person-tables-combined.png" alt="A map of a restaurant where all three adjacent two-person tables have been pushed together.">
	</p>
	<p>
		Implement decision logic that allows for alternative table configurations. Remember to take seating durations into account. Consider both the configuration illustrated, as well as other configurations. Note that in the above configuration, not all two-person tables can be combined.
	</p>
	<h3 id="fa8d74d3a39f462ca23818f79eefb7a8">
		More domain logic <a href="#fa8d74d3a39f462ca23818f79eefb7a8" title="permalink">#</a>
	</h3>
	<p>
		You can, if you will, invent extra rules. For example, restaurants have opening hours. A restaurant that opens at 18:00 and closes at 0:00 will not accept reservations for 13:30, regardless of table configuration, existing reservations, seating duration, and so on.
	</p>
	<p>
		Building on that idea, some restaurants have different opening hours on various weekdays. Some are closed Mondays, serve dinner only Tuesday to Friday, but are then open for both lunch and dinner in the weekend.
	</p>
	<p>
		Going in that direction, however, opens a can of worms. Perhaps the restaurant is closed on public holidays. Or perhaps it's explicitly open on public holidays, to cater for an audience that may not otherwise dine out. <a href="https://blog.ploeh.dk/2017/04/24/simple-holidays">But implementing a holiday calender is far from as simple as it sounds</a>. That's the reason I left such rules out of the above specifications of the kata.
	</p>
	<p>
		Another idea that you may consider is to combine communal bar seating with more traditional tables. <a href="https://thecloveclub.com/">The Clove Club</a> is an example of restaurant that does it that way.
	</p>
	<h3 id="66b7a3d1b3e5453ca343494ccd0bc51a">
		Summary <a href="#66b7a3d1b3e5453ca343494ccd0bc51a" title="permalink">#</a>
	</h3>
	<p>
		This is a programming kata description. Implement the decision logic of a maître d': <em>Can the restaurant accept a given reservation?</em>
	</p>
	<p>
		After some time has gone by, I'll post at least one of my own attempts. You're welcome to <a href="https://github.com/ploeh/ploeh.github.com#comments">leave a comment</a> if you do the kata and wish to share your results.
	</p>
</div>
   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/01/20/algebraic-data-types-arent-numbers-on-steroids/">Algebraic data types aren't numbers on steroids</a></h2>
   <p>Monday, 20 January 2020 07:39:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>A common red herring in the type debate.</em>
	</p>
	<p>
		I regularly get involved in debates about static versus dynamic typing. This post isn't an attempt to persuade anyone that static types are better. One of the reasons that I so often find myself debating this topic is that it intrigues me. I get the impression that most of the software luminaries that I admire (e.g. <a href="https://en.wikipedia.org/wiki/Kent_Beck">Kent Beck</a>, <a href="https://en.wikipedia.org/wiki/Robert_C._Martin">Robert C. Martin</a>, <a href="https://www.r7krecon.com/michael-feathers-bio">Michael Feathers</a>) seem to favour dynamically typed languages. What is it that smart people have figured out that I haven't?
	</p>
	<p>
		The debate continues, and this article isn't going to stop it. It may, perhaps, put one misconception to rest. There are still good arguments on either side. It's not my goal to dispute any of the good arguments. It's my goal to counter a common bad argument.
	</p>
	<h3 id="41cff26ef5fe4a56943d34da2e7ad657">
		Misconception: static typing as numbers on steroids <a href="#41cff26ef5fe4a56943d34da2e7ad657" title="permalink">#</a>
	</h3>
	<p>
		I get the impression that many people think about static types as something that has to do with strings and numbers - particularly numbers. Introductions to programming languages often introduce strings first. That's natural, since the most common first example is <a href="https://en.wikipedia.org/wiki/%22Hello,_World!%22_program">Hello, world!</a>. After that usually follows an introduction to basic arithmetic, and that often includes an explanation about types of numbers - at least the distinction between integers and floating-point numbers. At the time I'm writing this, <a href="https://docs.microsoft.com/dotnet/csharp/tutorials/">the online C# tutorial</a> is a typical example of this. <a href="http://bit.ly/real-world-haskell">Real World Haskell</a> takes the same approach to introducing types.
	</p>
	<p>
		It's a natural enough way to introduce static types, but it seems to leave some learners with the impression that static types are mostly useful to prevent them from calling a method with a floating-point number when an integer was expected. That's the vibe I'm getting from <a href="https://blog.cleancoder.com/uncle-bob/2017/01/13/TypesAndTests.html">this article by Robert C. Martin</a>.
	</p>
	<p>
		When presented with the notion of a 'stronger' type system, people with that mindset seem to extrapolate what they already know about static types.
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/extrapolation-of-static-primitive-types.png" alt="Three boxes, from left to right: no types, static primitive types, and static primitive types on steroids.">
	</p>
	<p>
		If you mostly think of static types as a way to distinguish between various primitive types (such as strings and a zoo of number types), I can't blame you for extrapolating that notion. This seems to happen often, and it leads to a lot of frustration.
	</p>
	<p>
		People who want 'stronger numbers' try to:
		</p><ul>
			<li>Model natural numbers; i.e. to define a type that represents only positive integers</li>
			<li>Model positive numbers; i.e. rational or real numbers greater than zero</li>
			<li>Model non-negative numbers</li>
			<li>Model numbers in a particular range; e.g. between 0 and 100</li>
			<li><a href="https://ren.zone/articles/safe-money">Model money in different currencies</a></li>
		</ul><p>
		Particularly, people run into all sorts of trouble when they try to accomplish such goals with <a href="https://www.haskell.org/">Haskell</a>. They've heard that Haskell has a powerful type system, and now they want to do those things.
	</p>
	<p>
		Haskell does have a powerful type system, but it's a type system that builds on the concept of <a href="https://en.wikipedia.org/wiki/Algebraic_data_type">algebraic data types</a>. (If you want to escape the jargon of that Wikipedia article, I recommend <a href="http://tomasp.net/">Tomas Petricek</a>'s lucid and straightforward explanation <a href="http://tomasp.net/blog/types-and-math.aspx">Power of mathematics: Reasoning about functional types</a>.)
	</p>
	<p>
		There are type systems that enable you to take the notion of numbers to the next level. This is called either <a href="https://en.wikipedia.org/wiki/Refinement_type">refinement types</a> or <a href="https://en.wikipedia.org/wiki/Dependent_type">dependent types</a>, contingent on what exactly it is that you want to do. Haskell doesn't support that out of the box. The most prominent dependently-typed programming language is probably <a href="https://www.idris-lang.org/">Idris</a>, which is still a research language. As far as I know, there's no 'production strength' languages that support refinement or dependent types, unless you consider <a href="https://en.wikipedia.org/wiki/Liquid_Haskell">Liquid Haskell</a> to fit that description. Honestly, all this is at the fringe of my expertise.
	</p>
	<p>
		I'll return to an example of this kind of frustration later, and also suggest a simple alternative. Before I do that, though, I'd like to outline what it is proponents of 'strong' type systems mean.
	</p>
	<h3 id="76b0c9b8e461448796d44443351619f1">
		Make illegal states unrepresentable <a href="#76b0c9b8e461448796d44443351619f1" title="permalink">#</a>
	</h3>
	<p>
		Languages like Haskell, <a href="https://ocaml.org/">OCaml</a>, and <a href="https://fsharp.org/">F#</a> have algebraic type systems. They still distinguish between various primitive types, but they take the notion of static types in a completely different direction. They introduce a new dimension of static type safety, so to speak.
	</p>
	<p>
		<img src="https://blog.ploeh.dk/content/binary/algebraic-data-types-as-another-dimension.png" alt="Three boxes. At the bottom left: no types. To the right of that: static primitive types. To the top of the no-types box: algebraic data types">
	</p>
	<p>
		It's a completely different way to think about static types. The advantage isn't that it prevents you from using a floating point where an integer was required. The advantage is that it enables you to model domain logic in a way that flushes out all sorts of edge cases at compile time.
	</p>
	<p>
		I've previously <a href="https://blog.ploeh.dk/2016/11/28/easy-domain-modelling-with-types">described a real-world example of domain modelling with types</a>, so I'm not going to repeat that effort here. Most business processes can be described as a progression of states. With algebraic data types, not only can you model what a valid state looks like - you can also model the state machine in such a way that you can't represent illegal states.
	</p>
	<p>
		This notion is eloquently captured by the aphorism:
		</p><blockquote>
			<p>
				Make illegal states unrepresentable.
			</p>
			
		</blockquote><p>
		This is solving an entirely different type of problem than distinguishing between 32-bit and 64-bit integers. Writing even moderately complex code involves dealing with many edge cases. In most mainstream languages (including C# and Java), it's your responsibility to ensure that you've handled all edge cases. It's easy to overlook or forget a few of those. With algebraic data types, the compiler keeps track of that for you. That's a tremendous boon because it enables you to forget about those technical details and instead focus on adding value.
	</p>
	<p>
		Scott Wlaschin wrote <a href="https://amzn.to/2OyI51M">an entire book about domain modelling with algebraic data types</a>. That's what we talk about when we talk about stronger type systems. Not 'numbers on steroids'.
	</p>
	<h3 id="4c5ac4aa723f4f078d5cfbb13164194c">
		Exhibit: summing notionals <a href="#4c5ac4aa723f4f078d5cfbb13164194c" title="permalink">#</a>
	</h3>
	<p>
		I consider this notion of <em>strong type systems viewed as numbers on steroids</em> a red herring. I don't blame anyone from extrapolating from what they already know. That's a natural way to try to make sense of the world. We all do it.
	</p>
	<p>
		I came across a recent example of this way of thinking in a great article by <a href="https://alexnixon.github.io/">Alex Nixon</a> titled <a href="https://alexnixon.github.io/2020/01/14/static-types-are-dangerous.html">Static types are dangerously interesting</a>. The following is in no way meant to excoriate Alex or his article, but I think it's a great example of how easily one can be lead astray by thinking that strong type systems imply numbers on steroids.
	</p>
	<p>
		You should read the article. It's well-written and uses more sophisticated features of Haskell than I'm comfortable with. The example problem it tries to solve is basically this: Given a set of trades, calculate the <em>total notional in each currency</em>. Consider a collection of trades:
	</p>
	<pre>Quantity, Ticker, Price, Currency
100,      VOD.L,  1,     GBP
200,      VOD.L,  2,     GBP
300,      AAPL.O, 3,     USD
50,       4151.T, 5,     JPY</pre>
	
	<p>
		I'll let Alex explain what it is that he wants to do:
		</p><blockquote>
			<p>
				"I want to write a function which calculates the <em>total notional in each currency</em>. The word <em>notional</em> is a fancy way of saying <code>price * quantity</code>. Think of it as "value of the thing that changed hands".
			</p>
			<p>
				"For illustration, the function signature might look something like this:
			</p>
			<p>
				"<code>sumNotionals :: [Trade] -&gt; Map Currency Rational</code>
			</p>
			<p>
				"In English, it’s a function that takes a list of trades and returns a map from currency to quantity."
			</p>
		</blockquote><p>
		If given the above trades, the output would be:
	</p>
	<pre>Currency, Notional
GBP,      500
USD,      900
JPY,      250</pre>
	
	<p>
		The article proceeds to explore how to model this problem with Haskell's strong type system. Alex wants to be able to calculate with money, but on the other hand, he wants the type system to prevent accidents. You can't add <em>100 GBP</em> to <em>300 USD</em>. The type system should prevent that.
	</p>
	<p>
		Early on, he defines a <a href="https://en.wikipedia.org/wiki/Tagged_union">sum type</a> to model currencies:
	</p>
	<pre><span>data</span>&nbsp;Currency
&nbsp;&nbsp;=&nbsp;USD
&nbsp;&nbsp;|&nbsp;GBP
&nbsp;&nbsp;|&nbsp;JPY
&nbsp;&nbsp;<span>deriving</span>&nbsp;(<span>Eq</span>,&nbsp;<span>Ord</span>,&nbsp;<span>Show</span>)</pre>
	
	<p>
		Things basically go downhill from there. Read the article; it's good.
	</p>
	<h3 id="f04845b0c38f4924a5d34d1d5802912e">
		Sum types should distinguish behaviour, not values <a href="#f04845b0c38f4924a5d34d1d5802912e" title="permalink">#</a>
	</h3>
	<p>
		I doubt that Alex Nixon views his proposed <code>Currency</code> type as anything but a proof of concept. In a 'real' code base, you'd enumerate all the currencies you'd trade, right?
	</p>
	<p>
		I wouldn't. This is the red herring in action. Algebraic data types are useful because they enable us to distinguish between cases that we should treat differently, by writing specific code that deals with each case. That's not the case with a currency. You add US dollars together in exactly the same way that you add euros together. The currency doesn't change the behaviour of that operation.
	</p>
	<p>
		But we can't just enable addition of arbitrary monetary values, right? After all, we shouldn't be able to add <em>20 USD</em> and <em>300 DKK</em>. At least, without an exchange rate, that shouldn't compile.
	</p>
	<p>
		Let's imagine, for the sake of argument, that we encode all the currencies we trade into a type. What happens if our traders decide to trade a currency that they haven't previously traded? What if a country decides to <a href="https://en.wikipedia.org/wiki/Redenomination">reset their currency</a>? What if a country splits into two countries, each with <a href="https://en.wikipedia.org/wiki/South_Sudanese_pound">their own currency</a>?
	</p>
	<p>
		If you model currency as a type, you'd have to edit and recompile your code every time such an external event occurs. I don't think this is a good use of a type system.
	</p>
	<p>
		Types should, I think, help us programmers identify the parts of our code bases where we need to treat various cases differently. They shouldn't be used to distinguish run-time values. Types provide value at compile time; run-time values only exist at run time. To paraphrase Kent Beck, <em>keep things together that change together; keep things apart that don't</em>.
	</p>
	<p>
		I'd model currency as a run-time value, because the behaviour of money doesn't vary with the currency.
	</p>
	<h3 id="cfa838f3fad84259b9629f24f09f37eb">
		Boring Haskell <a href="#cfa838f3fad84259b9629f24f09f37eb" title="permalink">#</a>
	</h3>
	<p>
		How would I calculate the notionals, then? With <a href="https://www.snoyman.com/blog/2019/11/boring-haskell-manifesto">boring Haskell</a>. Really boring Haskell, in fact. I'm only going to need two imports and no language pragmas:
	</p>
	<pre><span>module</span>&nbsp;Trades&nbsp;<span>where</span>
 
<span>import</span>&nbsp;Data.List
<span>import</span>&nbsp;Data.Map.Strict&nbsp;(<span>Map</span>)
<span>import</span>&nbsp;<span>qualified</span>&nbsp;Data.Map.Strict&nbsp;<span>as</span>&nbsp;Map</pre>
	
	<p>
		Which types do I need? For this particular purpose, I think I'll just stick with a single <code>Trade</code> type:
	</p>
	<pre><span>data</span>&nbsp;Trade&nbsp;=&nbsp;Trade&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;tradeQuantity&nbsp;::&nbsp;Int
&nbsp;&nbsp;,&nbsp;tradeTicker&nbsp;::&nbsp;String
&nbsp;&nbsp;,&nbsp;tradePrice&nbsp;::&nbsp;Rational
&nbsp;&nbsp;,&nbsp;tradeCurrency&nbsp;::&nbsp;String&nbsp;}
&nbsp;&nbsp;<span>deriving</span>&nbsp;(<span>Eq</span>,&nbsp;<span>Show</span>)</pre>
	
	<p>
		Shouldn't I introduce a <code>Money</code> type? I could, but I don't have to. As <a href="https://lexi-lambda.github.io/">Alexis King</a> so clearly explains, <a href="https://lexi-lambda.github.io/blog/2020/01/19/no-dynamic-type-systems-are-not-inherently-more-open">you don't have to model more than you need to do the job</a>.
	</p>
	<p>
		By not introducing a <code>Money</code> type and making it an instance of various type classes, I still prevent client code from adding things together that shouldn't be added together. You can't add <code>Trade</code> values together because <code>Trade</code> isn't a <code>Num</code> instance.
	</p>
	<p>
		How do we calculate the notionals, then? It's easy; it's a one-liner:
	</p>
	<pre><span>sumNotionals</span>&nbsp;::&nbsp;<span>Foldable</span>&nbsp;t&nbsp;<span>=&gt;</span>&nbsp;t&nbsp;<span>Trade</span>&nbsp;<span>-&gt;</span>&nbsp;<span>Map</span>&nbsp;<span>String</span>&nbsp;<span>Rational</span>
sumNotionals&nbsp;=&nbsp;foldl'&nbsp;(\m&nbsp;t&nbsp;-&gt;&nbsp;Map.insertWith&nbsp;<span>(+)</span>&nbsp;(key&nbsp;t)&nbsp;(value&nbsp;t)&nbsp;m)&nbsp;Map.empty
&nbsp;&nbsp;<span>where</span>&nbsp;key&nbsp;&nbsp;&nbsp;(Trade&nbsp;_&nbsp;_&nbsp;_&nbsp;currency)&nbsp;=&nbsp;currency
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value&nbsp;(Trade&nbsp;quantity&nbsp;_&nbsp;price&nbsp;_)&nbsp;=&nbsp;<span>toRational</span>&nbsp;quantity&nbsp;*&nbsp;price</pre>
	
	<p>
		Okay, that looks more like four lines of code, but the first is an optional type declaration, so it doesn't count. The <code>key</code> and <code>value</code> functions could be inlined to make the function a single (wide) line of code, but I made them two named functions in order to make the code more readable.
	</p>
	<p>
		It gets the job done:
	</p>
	<pre>*Trades&gt; sumNotionals trades
fromList [("GBP",500 % 1),("JPY",250 % 1),("USD",900 % 1)]</pre>
	
	<p>
		While this code addresses this particular problem, you probably consider it cheating because I've failed to address a wider concern. How does one model money in several currencies? I've <a href="https://blog.ploeh.dk/2017/10/16/money-monoid">previously covered that, including a simple Haskell example</a>, but in general, I consider it more productive to have a problem and <em>then</em> go looking for a solution, rather than inventing a solution and go looking for a problem.
	</p>
	<h3 id="8d472a61051e4ddfaf2698c8d215d658">
		Summary <a href="#8d472a61051e4ddfaf2698c8d215d658" title="permalink">#</a>
	</h3>
	<p>
		When people enter into a debate, they use the knowledge they have. This is also the case in the debate about static versus dynamic types. Most programmers have experience with statically typed languages like C# or Java. It's natural to argue from what you know, and extrapolate from that.
	</p>
	<p>
		I think that when confronted with a phrase like <em>a more powerful type system</em>, many people extrapolate and think that they know what that means. They think that it means statically typed numbers on steroids. That's a red herring.
	</p>
	<p>
		That's usually not what we mean when we talk about <em>more powerful type systems</em>. We talk about algebraic data types, which make illegal states unrepresentable. Judged by the debates I've participated in, you can't <em>extrapolate</em> from mainstream type systems to algebraic data types. If you haven't tried programming with both sum and <a href="https://en.wikipedia.org/wiki/Product_type">product types</a>, you aren't going to <a href="http://bit.ly/stranger-in-a-strange-land">grok</a> what we mean when we talk about <em>strong type systems</em>.
	</p>
</div>



   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/01/13/on-doing-katas/">On doing katas</a></h2>
   <p>Monday, 13 January 2020 06:23:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>Approach programming katas differently than martial arts katas.</em>
	</p>
	<p>
		Would you like to become a better programmer? Then practice. It's no different from becoming a better musician, a better sports(wo)man, a better cook, a better artist, etcetera.
	</p>
	<p>
		How do you practice programming?
	</p>
	<p>
		There's many ways. Doing <a href="https://en.wikipedia.org/wiki/Kata_(programming)">programming katas</a> is one way.
	</p>
	<h3 id="16e8612d24b14930a4d7cc02ebad6fd6">
		Variation, not repetition <a href="#16e8612d24b14930a4d7cc02ebad6fd6" title="permalink">#</a>
	</h3>
	<p>
		When I talk to other programmers about katas, I often get the impression that people fail to extract value from the exercises. You can find catalogues of exercises on the internet, but there's a dearth of articles that discuss <em>how</em> to do katas.
	</p>
	<p>
		Part of the problem is, I think, that <a href="https://en.wikipedia.org/wiki/Kata">the term comes from martial arts practice</a>. In martial arts, one repeats the same movements over and over again in order to build up <a href="https://en.wikipedia.org/wiki/Muscle_memory">muscle memory</a>. Repetition produces improvements.
	</p>
	<p>
		Some people translate that concept literally. They try to do programming katas by doing the <em>same exercise</em> again and again, with no variation. After a few days or weeks, they stop because they can't see the point.
	</p>
	<p>
		That's no wonder. Neither can I.
	</p>
	<p>
		Programming and software design is mostly an intellectual (and perhaps artistic) endeavour. Unless you can't <a href="https://en.wikipedia.org/wiki/Touch_typing">touch type</a>, there's little need to build up muscle memory. You train your brain unlike you train your muscles. Repetition numbs the brain. Variation stimulates it.
	</p>
	<h3 id="5e0804109e5c40cb80f0c3c9274afb30">
		Suggested variations <a href="#5e0804109e5c40cb80f0c3c9274afb30" title="permalink">#</a>
	</h3>
	<p>
		I find that doing a kata is a great opportunity to explore alternatives. A kata is usually a limited exercise, which means that you can do it multiple times and compare outcomes.
	</p>
	<p>
		You can find various kata catalogues on the internet. One of my favourites is the <a href="http://bit.ly/codekatas">Coding Dojo</a>. Among the katas there, I particularly like the <a href="http://codingdojo.org/kata/Tennis">Tennis kata</a>. I'll use that as an example to describe how I often approach a kata.
	</p>
	<p>
		The first time I encounter a kata I've never done before, I do it with as little fuss as possible. I use the programming language I'm most comfortable with, and don't attempt any stunts. I no longer remember when I first encountered the Tennis kata, but it's many years ago, and C# was my preferred language. I'd do the Tennis kata in C#, then, just to get acquainted with the problem.
	</p>
	<p>
		Most good katas contain small surprises. They may sound simpler than they actually turn out to be. On the other hand, they're typically not overwhelmingly difficult. It pays to overcome the surprise the kata may hold without getting bogged down by trying some feat. The Tennis kata, for example, sounds easy, but most people stumble on the rules associated with <em>deuce</em> and <em>advantage</em>. How to model the API? How do you implement the algorithm?
	</p>
	<p>
		Once you're comfortable with the essence of the exercise, introduce variations. Most of the variations I use take the form of some sort of constraint. <a href="https://www.dotnetrocks.com/?show=1542">Constraints liberate</a>. <a href="https://blog.ploeh.dk/2015/04/13/less-is-more-language-features">Less is more</a>.
	</p>
	<p>
		Here's a list of suggestions:
		</p><ul>
			<li><a href="https://blog.ploeh.dk/2019/10/21/a-red-green-refactor-checklist">Follow test-driven development</a> (TDD). That's my usual modus operandi, but if you don't normally practice TDD, a kata is a great opportunity.</li>
			<li>Use the (<em>Gollum style</em>) <a href="https://blog.ploeh.dk/2019/10/07/devils-advocate">Devil's Advocate</a> technique with TDD.</li>
			<li>Follow the <a href="https://blog.cleancoder.com/uncle-bob/2013/05/27/TheTransformationPriorityPremise.html">Transformation Priority Premise</a>.</li>
			<li>Do TDD without mocks.</li>
			<li>Do TDD with mocks.</li>
			<li>Use the <a href="http://www.natpryce.com/articles/000714.html">Test Data Builder design pattern</a>.</li>
			<li>Try <a href="https://blog.ploeh.dk/property-based-testing-intro">property-based testing</a>. I've <a href="https://blog.ploeh.dk/2016/02/10/types-properties-software">done that with the Tennis</a> kata multiple times.</li>
			<li>Put your mouse away.</li>
			<ins datetime="2020-02-20T08:38Z"><li>Hide the file tree in your editor or IDE. In Visual Studio, this is called the <em>Solution Explorer</em>, in Visual Studio Code it's just <em>Explorer</em>. Navigate the code by other means.</li></ins>
			<li>Use another editor or IDE.</li>
			<li>Use another programming language. A kata is a great way to practice a new language. When you're learning a new language, you're often fighting with unfamiliar syntax, which is the reason I recommend that you <em>first</em> do the kata in a language with which you're familiar.</li>
			<li>Use only immutable data structures. This is a good first step towards learning functional programming.</li>
			<li>Keep the <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity">cyclomatic complexity</a> of all methods at <em>1</em>. I <a href="https://blog.ploeh.dk/2011/05/16/TennisKatawithimmutabletypesandacyclomaticcomplexityof1">once did that with the Tennis kata</a>.</li>
			<li>Use an unfamiliar API. If you normally use <a href="https://nunit.org/">NUnit</a> then try <a href="https://xunit.net/">xUnit.net</a> instead. Use a new Test Double library. Use a different assertion library. I once did the Tennis kata in <a href="https://www.haskell.org/">Haskell</a> using the <a href="http://hackage.haskell.org/package/lens">lens</a> library because I wanted to hone those skills. I've also done the <em>Mark IV coffee maker</em> exercise from <a href="http://amzn.to/19W4JHk">APPP</a> with <a href="http://reactivex.io/">Reactive Extensions</a>.</li>
			<li>Employ a design pattern you'd like to understand better. I've had particular success with the <a href="https://en.wikipedia.org/wiki/Visitor_pattern">Visitor design pattern</a>.</li>
			<li>Refactor an existing kata solution to another design.</li>
			<li>Refactor another programmer's kata solution.</li>
			<li><a href="https://en.wikipedia.org/wiki/Pair_programming">Pair-program</a> the kata.</li>
			<li>Use the <a href="http://wiki.c2.com/?PairProgrammingPingPongPattern">Ping Pong pattern</a> when pair programming.</li>
			<li><a href="https://en.wikipedia.org/wiki/Mob_programming">Mob-program</a> it.</li>
		</ul><p>
		You'll probably come up with your own list of variations.
	</p>
	<p>
		What I like about katas is that they're small enough that you can do the same exercise multiple times, but with different designs. This makes it easy to learn new ways of doing things, because you can compare different approaches to the same problem.
	</p>
	<h3 id="1faffc34ac644021b87c7f0b0691eeef">
		Conclusion <a href="#1faffc34ac644021b87c7f0b0691eeef" title="permalink">#</a>
	</h3>
	<p>
		The way that the idea of a programming kata <a href="http://www.butunclebob.com/ArticleS.UncleBob.TheProgrammingDojo">was originally introduced</a> is a bit unfortunate. On one hand, the metaphor may have helped adoption because martial arts are cool, and Japanese is a beautiful language. On the other hand, the underlying message is one of repetition, which is hardly helpful when it comes to exercising the brain.
	</p>
	<p>
		Repetition dulls the brain, while variation stimulates it. Katas are great because they're short exercises, but you have to deliberately introduce diversity to make them work for you. You're not building muscle memory, you're forming new neural pathways.
	</p>
</div>


   </div>
   <hr>


   <h2><a href="https://blog.ploeh.dk/2020/01/06/the-case-of-the-unbalanced-brackets/">The case of the unbalanced brackets</a></h2>
   <p>Monday, 06 January 2020 06:37:00 UTC</p>
   <div>
    


<div id="post">
	<p>
		<em>A code mystery.</em>
	</p>
	<p>
		One of my clients was kind enough to let me look at some of their legacy code. As I was struggling to understand how it worked, I encountered something that <em>looked</em> like this:
	</p>
	<pre>ApplyDueAmountG89.<span>Calculate</span>(<span>postState</span>.PartialMebershipsBAT.<span>Where</span>(
&nbsp;&nbsp;&nbsp;&nbsp;<span>d</span>&nbsp;=&gt;&nbsp;(<span>d</span>.Data.Choicetype&nbsp;==&nbsp;<span>GarplyChoicetype</span>.AtoC&nbsp;||
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>retirablePartialMembershipNr</span>.<span>Contains</span>(<span>d</span>.Data.PartialMembershipNr)).<span>ToList</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplyDueAmountG89.Situation.Depreciation,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplyDueAmountG89.RecordType.Primo);</pre>
	
	<p>
		For the record, this isn't the actual code that my client gave me. I wouldn't post someone else's code without their permission. It is, however, a faithful imitation of the original code. What's wrong with it?
	</p>
	<p>
		I'll wait.
	</p>
	<h3 id="4eb9d6fa6cf04f45a4afdeb3638a9c8a">
		Brackets <a href="#4eb9d6fa6cf04f45a4afdeb3638a9c8a" title="permalink">#</a>
	</h3>
	<p>
		Count the brackets. There's a missing closing bracket.
	</p>
	<p>
		Yet, the code compiles. How?
	</p>
	<p>
		Legacy code isn't <a href="https://cleancoders.com/video-details/humane-code-real-episode-1">humane code</a>. There's a multitude of ways in which code can be obscure. This article describes one of them.
	</p>
	<p>
		When brackets are nested and far apart, it's hard for the brain to parse and balance them. Yet, on closer inspection the brackets seem unbalanced.
	</p>
	<h3 id="0595d741e4ff4a139d3b26ab8fb3e75d">
		Show whitespace <a href="#0595d741e4ff4a139d3b26ab8fb3e75d" title="permalink">#</a>
	</h3>
	<p>
		Ever since I started programming in <a href="https://fsharp.org/">F#</a>, I've turned on the Visual Studio feature that shows whitespace. F# does, after all, use significant whitespace (AKA the <a href="https://en.wikipedia.org/wiki/Off-side_rule">Off-side rule</a>), and it helps to be able to detect if a tab character has slipped in among the spaces.
	</p>
	<p>
		Visual Studio shows whitespace with pale blue dots and arrows. When that feature is turned on (<kbd>Ctrl</kbd> + <kbd>e</kbd>, <kbd>s</kbd>), the above code example looks different:
	</p>
	<pre>ApplyDueAmountG89.<span>Calculate</span>(<span>postState</span>.PartialMebershipsBAT.<span>Where</span>(
<span>····</span><span>d</span><span>·</span>=&gt;<span>·</span>(<span>d</span>.Data.Choicetype<span>·</span>==<span>·</span><span>GarplyChoicetype</span>.AtoC<span>·</span>||<span>···············································</span>
<span>············</span><span>retirablePartialMembershipNr</span>.<span>Contains</span>(<span>d</span>.Data.PartialMembershipNr)).<span>ToList</span>(),
<span>············</span>ApplyDueAmountG89.Situation.Depreciation,
<span>············</span>ApplyDueAmountG89.RecordType.Primo);</pre>
	
	<p>
		Notice the space characters that seem to run off to the right of the <code>||</code> operator. What's at the end of those spaces?
	</p>
	<p>
		Yes, you guessed it: another Boolean expression, including the missing closing bracket:
	</p>
	<pre><span>d</span>.Data.Choicetype&nbsp;==&nbsp;<span>GarplyChoicetype</span>.BtoC)&nbsp;&amp;&amp;</pre>
	
	<p>
		If you delete all those redundant spaces, this is the actual code:
	</p>
	<pre>ApplyDueAmountG89.<span>Calculate</span>(<span>postState</span>.PartialMebershipsBAT.<span>Where</span>(
&nbsp;&nbsp;&nbsp;&nbsp;<span>d</span>&nbsp;=&gt;&nbsp;(<span>d</span>.Data.Choicetype&nbsp;==&nbsp;<span>GarplyChoicetype</span>.AtoC&nbsp;||&nbsp;<span>d</span>.Data.Choicetype&nbsp;==&nbsp;<span>GarplyChoicetype</span>.BtoC)&nbsp;&amp;&amp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>retirablePartialMembershipNr</span>.<span>Contains</span>(<span>d</span>.Data.PartialMembershipNr)).<span>ToList</span>(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplyDueAmountG89.Situation.Depreciation,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplyDueAmountG89.RecordType.Primo);</pre>
	
	<p>
		Imagine troubleshooting code like that, and not realising that there's another Boolean expression so far right that even a large screen doesn't show it. In the actual legacy code where I found this example, the extra Boolean expression started at column 209.
	</p>
	<h3 id="8a3d025a78304704864a782aa162e6e3">
		Conclusion <a href="#8a3d025a78304704864a782aa162e6e3" title="permalink">#</a>
	</h3>
	<p>
		Hiding significant code so far right that it's effectively invisible seems positively <em>evil</em>, but I don't think anyone did it deliberately. Rather, my guess is that someone performed a search-and-replace through the code base, and that this automatic change somehow removed a newline character.
	</p>
	<p>
		In any case, keeping an eye on the line width of code could prevent something like this from happening. <a href="https://blog.ploeh.dk/2019/11/04/the-80-24-rule">Stay within 80 characters</a>.
	</p>
</div>
   </div>
   <hr>


<!-- Pagination links -->

<p>Page 1 of 51</p>

<!-- Comments visibility -->

  </div>
  <div>
  	







<div>
  
  <p><em>"Our team wholeheartedly endorses Mark. His expert service provides tremendous value."</em>
  <br>
  <a href="https://blog.ploeh.dk/hire-me">Hire me!</a>
</p></div>
  </div>
</div>


      </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>