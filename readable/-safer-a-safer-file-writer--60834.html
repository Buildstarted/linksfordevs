<!DOCTYPE html>
<html lang="en">
<head>
    <title>
&#x270F;&#xFE0F; safer: a safer file writer &#x270F;&#xFE0F; - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="&#x270F;&#xFE0F; safer: a safer file writer &#x270F;&#xFE0F; - linksfor.dev(s)"/>
    <meta property="article:author" content="https://medium.com/@TomSwirly"/>
    <meta property="og:description" content="Part 1 of the Coroniad"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://medium.com/@TomSwirly/%EF%B8%8F-safer-a-safer-file-writer-%EF%B8%8F-5fe267dbe3f5"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
				<a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - &#x270F;&#xFE0F; safer: a safer file writer &#x270F;&#xFE0F;</title>
<div class="readable">
        <h1>&#x270F;&#xFE0F; safer: a safer file writer &#x270F;&#xFE0F;</h1>
            <div>by https://medium.com/@TomSwirly</div>
            <div>Reading time: 11-14 minutes</div>
        <div>Posted here: 19 Apr 2020</div>
        <p><a href="https://medium.com/@TomSwirly/%EF%B8%8F-safer-a-safer-file-writer-%EF%B8%8F-5fe267dbe3f5">https://medium.com/@TomSwirly/%EF%B8%8F-safer-a-safer-file-writer-%EF%B8%8F-5fe267dbe3f5</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><section><div><div><div><div><div><div><a rel="noopener" href="https://medium.com/@TomSwirly?source=post_page-----5fe267dbe3f5----------------------"><div><p><img alt="Tom Ritchford" src="https://miro.medium.com/fit/c/96/96/1*cqedISQ99oPTtLtEq1Pr7Q.jpeg" width="48" height="48"></p></div></a></div></div></div></div><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*s3rOMd6_PKJb4-gFaPK7pQ.jpeg?q=20" width="320" height="188" role="presentation"></p><p><img width="320" height="188" srcset="https://miro.medium.com/max/552/1*s3rOMd6_PKJb4-gFaPK7pQ.jpeg 276w, https://miro.medium.com/max/640/1*s3rOMd6_PKJb4-gFaPK7pQ.jpeg 320w" sizes="320px" role="presentation" src="https://miro.medium.com/max/320/1*s3rOMd6_PKJb4-gFaPK7pQ.jpeg"></p></div></div></div><figcaption data-selectable-paragraph=""><a href="https://en.wikipedia.org/wiki/Pencil#/media/File:Caran_d'Ache_Farbstifte.JPG" target="_blank" rel="noopener nofollow">Pencil</a></figcaption></figure><h2 id="74bb" data-selectable-paragraph="">Introduction</h2><p id="2c9f" data-selectable-paragraph=""><a target="_blank" rel="noopener" href="https://medium.com/@TomSwirly/the-coroniad-8b7f7c0c82f4">This series of articles</a> is aimed at any Python reader past the beginner level. The article describes not just a tiny library that does just one essential thing, but some of the backstory of how it went from being a humble utility in a project somewhere to being a slightly less humble, productionized library.</p><h2 id="812b" data-selectable-paragraph="">What is safer?</h2><p id="d287" data-selectable-paragraph="">It’s a tiny, <a href="https://github.com/rec/safer/blob/master/safer.py" target="_blank" rel="noopener nofollow">single file</a> <a href="https://github.com/rec/safer" target="_blank" rel="noopener nofollow">Python library</a> for safely writing to files where either the entire file is written, or nothing is changed.</p><h2 id="f6bb" data-selectable-paragraph="">Why would you use it?</h2><p id="0e79" data-selectable-paragraph="">In all programming languages, it’s very easy to start writing an important file, and then run into an exceptional condition, and fail to finish, leaving the file broken.</p><p id="db2b" data-selectable-paragraph="">For example, in Python, to write a JSON file you often see code like this:</p><pre><span id="663f" data-selectable-paragraph="">with open(filename, 'w') as fp:<br>    json.dump(data, fp)</span></pre><p id="a872" data-selectable-paragraph="">(<code>fp</code> is a <em>stream</em>: a Python object that reads and/or writes strings.)</p><p id="5b9f" data-selectable-paragraph="">And that might code work perfectly well for years. But one day, something goes wrong — say, by mistake the wrong sort of object gets into the <code>data</code> dictionary, maybe under some conditions that your tests don’t cover — and <code>json.dump()</code> raises an exception.</p><p id="7397" data-selectable-paragraph="">Which would be easily fixed by pushing out a new release…<em>except</em> that the JSON file is already partially written, and the data file is corrupted.</p><p id="6617" data-selectable-paragraph="">One bad software release and users’ data files are destroyed. <a href="https://webcomicname.com/" target="_blank" rel="noopener nofollow">Oh no</a>.</p><p id="4d25" data-selectable-paragraph="">With <code>safer</code>, you write almost identical code:</p><pre><span id="fe36" data-selectable-paragraph="">with safer.writer(filename) as fp:<br>    json.dump(data, fp)</span></pre><p id="36a8" data-selectable-paragraph="">Now if <code>json.dump()</code> throws an exception, the original file is unchanged, so your important data file lives to see another day.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*q5YNepllzOpmB8JuwnaUbA.jpeg?q=20" width="320" height="213" role="presentation"></p><p><img width="320" height="213" srcset="https://miro.medium.com/max/552/1*q5YNepllzOpmB8JuwnaUbA.jpeg 276w, https://miro.medium.com/max/640/1*q5YNepllzOpmB8JuwnaUbA.jpeg 320w" sizes="320px" role="presentation" src="https://miro.medium.com/max/320/1*q5YNepllzOpmB8JuwnaUbA.jpeg"></p></div></div></div><figcaption data-selectable-paragraph="">Photo by form <a href="https://pxhere.com/en/photo/958154" target="_blank" rel="noopener nofollow"><strong>PxHere</strong></a></figcaption></figure><h2 id="bdfc" data-selectable-paragraph="">What can you learn from this code?</h2><p id="dcf1" data-selectable-paragraph=""><strong>It’s short enough to understand completely</strong></p><p id="bf6e" data-selectable-paragraph="">The actual executable Python code is <a href="https://github.com/rec/safer/blob/v1.0.0/safer.py#L70-L97" target="_blank" rel="noopener nofollow">28 lines here</a> and <a href="https://github.com/rec/safer/blob/v1.0.0/safer.py#L103-L104" target="_blank" rel="noopener nofollow">two lines there</a> — almost nothing. There’s also some <a href="https://github.com/rec/safer/blob/v1.0.0/safer.py#L100-L101" target="_blank" rel="noopener nofollow">wrapping and decorators</a>, and those are <em>like</em> code, and much harder to grasp than regular old code, but those still add a handful of lines.</p><p id="3a98" data-selectable-paragraph="">Compared with some <a href="https://github.com/rec/safer/blob/v1.0.0/test_safer.py#L10-L171" target="_blank" rel="noopener nofollow">150 executable lines of test code</a>, it’s almost nothing. But the tiny target code hides a turbulent history.</p><p id="3127" data-selectable-paragraph="">I had pulled <a href="https://github.com/rec/safer/blob/892d76029192264c85e92fb8fae8ece682c27902/safe_writer.py#L8-L26" target="_blank" rel="noopener nofollow">working code</a> in with <a href="https://github.com/rec/safer/blob/892d76029192264c85e92fb8fae8ece682c27902/test_safe_writer.py" target="_blank" rel="noopener nofollow">tests</a> from another project named <code>gitz</code>.</p><p id="a12d" data-selectable-paragraph="">It was working fine on the second commit — <a href="https://github.com/rec/safer/commits/master" target="_blank" rel="noopener nofollow">and then a couple of dozen commits later I felt it was finished.</a></p><p id="5880" data-selectable-paragraph="">I needed <code>safer</code> in another project, but I realized fast that I needed a <em>printer</em> — a callable object that looks like the built-in <code>print()</code> function — and not a <em>writer — </em>a stream that can be written to.</p><p id="32ea" data-selectable-paragraph="">I added <a href="https://github.com/rec/safer/blob/v0.9.4/safer.py#L10-L22" target="_blank" rel="noopener nofollow">a lot of features</a> but I kept only a few and threw most of them away. I found a lot of edge cases and tweaked it. It became a lot bigger and then I cut it down again.</p><p id="6cea" data-selectable-paragraph="">And a lot of renaming and re-renaming went on to get things as clear as absolutely possible.</p><p id="07a9" data-selectable-paragraph=""><strong>It’s a chance to study Python context managers</strong></p><p id="72dc" data-selectable-paragraph="">One of the nice things about Python is that so many parts of the language are immediately understandable and elegant.</p><p id="4e11" data-selectable-paragraph="">Context managers are still very elegant, but somewhat more difficult to understand. Luckily, you can use a context manager perfectly successfully without really understanding how they work: I certainly did for a long time.</p><p id="eaf3" data-selectable-paragraph="">When you first start Python, you might write data to a JSON file like this:</p><pre><span id="9e24" data-selectable-paragraph="">fp = open(filename, 'w')<br>json.dump(data, fp)</span></pre><p id="2190" data-selectable-paragraph="">It works for you, but it turns out there’s a subtle trap there that might one day bite you.</p><p id="54b6" data-selectable-paragraph="">Let me ask you a question here: in the Python code above, when does the data get written to the file on disk?</p><figure><div><div><div><p><img src="https://miro.medium.com/max/46/1*uPRL1liVbEJlu4AW8X6zgw.png?q=20" width="185" height="240" role="presentation"></p><p><img width="185" height="240" srcset="" sizes="185px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph=""><a href="https://nl.m.wikipedia.org/wiki/Bestand:Question_mark_alternate.svg" target="_blank" rel="noopener nofollow">Question mark?</a></figcaption></figure><p id="fee3" data-selectable-paragraph="">Trick question: it is nowhen in that code. In fact, that code fragment above is not technically speaking <em>guaranteed</em> to actually write any data to the file at all. Surprise!</p><p id="d18a" data-selectable-paragraph="">Oh, <code>json.dump()</code> certainly writes to the <em>stream</em> <code>fp</code> but most streams like the one you get from <code>open()</code> are <em>buffered streams</em>: it would be horribly inefficient to write each tiny bit of data to the actual file on disk, so the stream writes data to an internal buffer with a fixed size, and that buffer only gets written to the file when it fills up, or when the stream is closed.</p><p id="b231" data-selectable-paragraph="">If <code>data</code> isn’t very big, it probably won’t overflow the buffer, so it won’t get written until <code>fp</code> is closed.</p><p id="6dd4" data-selectable-paragraph="">So what closes that stream <code>fp</code>?</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*XdiaBHskfSzMyKvVxDAAfQ.jpeg?q=20" width="400" height="266" role="presentation"></p><p><img width="400" height="266" srcset="https://miro.medium.com/max/552/1*XdiaBHskfSzMyKvVxDAAfQ.jpeg 276w, https://miro.medium.com/max/800/1*XdiaBHskfSzMyKvVxDAAfQ.jpeg 400w" sizes="400px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph=""><a href="https://www.flickr.com/photos/lfeng/5695880051/" target="_blank" rel="noopener nofollow">Garbage collector (Lu Feng)</a></figcaption></figure><p id="52ae" data-selectable-paragraph="">It is Python’s famous <a href="https://rushter.com/blog/python-garbage-collector/" target="_blank" rel="noopener nofollow">garbage collector</a> that does the dirty work.</p><p id="8eb6" data-selectable-paragraph="">After the code above is executed, <code>fp</code> is not referenced anymore, and “probably very soon” the garbage collector finds the stream and calls the stream’s destructor, which closes the stream, which flushes its buffer, which actually writes to the file.</p><p id="d03b" data-selectable-paragraph="">The garbage collector is amazingly good, but it isn’t perfect, and there are no hard guarantees on how quickly this will happen. More, the garbage collector <a href="https://stackoverflow.com/questions/14628486/why-arent-destructors-guaranteed-to-be-called-on-interpreter-exit" target="_blank" rel="noopener nofollow">doesn’t even guarantee</a> to call the destructor on every object, though the cases where it doesn’t are very rare.</p><p id="cbeb" data-selectable-paragraph="">So the actual answer is that you don’t know for 100%-guaranteed-every-single-time sure when or even <em>if</em> it gets written.</p><p id="7b02" data-selectable-paragraph="">In practice, the data is nearly always written except in the most unusual circumstances, and it “nearly always” happens “almost immediately”… but sometimes that just isn’t good enough, particularly if some other thread or process immediately starts reading the incomplete file, or if you accidentally keep the reference to the stream so it’s never garbage collected.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*YRKW8rxpb4Rj4Bv71nyscQ.png?q=20" width="320" height="138" role="presentation"></p><p><img width="320" height="138" srcset="https://miro.medium.com/max/552/1*YRKW8rxpb4Rj4Bv71nyscQ.png 276w, https://miro.medium.com/max/640/1*YRKW8rxpb4Rj4Bv71nyscQ.png 320w" sizes="320px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph=""><a href="https://commons.wikimedia.org/wiki/File:Pencil_Diagram.svg" target="_blank" rel="noopener nofollow">Pencil Diagram</a></figcaption></figure><h2 id="ac7b" data-selectable-paragraph="">Managing resources</h2><p id="4064" data-selectable-paragraph="">A <em>resource </em>is some software thing with a limited lifespan that you, the programmer, need to manage.</p><p id="5973" data-selectable-paragraph="">Resources are potentially expensive and important: memory that’s been allocated, a socket or database connection, or a cursor within a database query, or a temporary file, or many other things you can’t just drop on the floor and hope it all works out.</p><p id="d179" data-selectable-paragraph="">The Pythonic way to manage resources is with a <a href="https://jeffknupp.com/blog/2016/03/07/python-with-context-managers/" target="_blank" rel="noopener nofollow"><em>context manager</em></a>, which sets up before hand, runs a block of code, then cleans up afterwards.</p><p id="4d61" data-selectable-paragraph="">So now, instead of</p><pre><span id="356f" data-selectable-paragraph="">fp = open(filename, 'w')<br>json.dump(data, fp)</span></pre><p id="ab03" data-selectable-paragraph="">where <code>fp</code> almost certainly gets closed very soon, you write</p><pre><span id="2dd5" data-selectable-paragraph="">with open(filename, 'w') as fp:<br>    json.dump(data, fp)</span></pre><p id="70c2" data-selectable-paragraph="">where <code>fp</code> is definitely closed once the block is finished, whether or not an exception is raised.</p><p id="0a6d" data-selectable-paragraph="">This is better, but, if an exception is raised, then the file will be partially overwritten, and you probably don’t want that.</p><p id="df3e" data-selectable-paragraph="">And so <code>safer.writer()</code> is a context manager that offers exactly the same functionality that you get from <code>open()</code>, but goes one step further by not actually overwriting the original file until the context exits.</p><p id="f6ac" data-selectable-paragraph="">There are two ways to create a context manager, and <code>safer</code> uses the easiest one: the decorator <code><a href="https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager" target="_blank" rel="noopener nofollow">contextlib.contextmanager</a></code>.</p><p id="906e" data-selectable-paragraph=""><a href="https://github.com/rec/safer/blob/v0.9.10/safer.py#L34" target="_blank" rel="noopener nofollow">Here’s</a> the place in the code where <code>safer</code> uses the decorator, and <a href="https://github.com/rec/safer/blob/v0.9.10/safer.py#L82-L94" target="_blank" rel="noopener nofollow">here’s</a> where the actual context manager is implemented: the <code>yield</code> statement on <a href="https://github.com/rec/safer/blob/v0.9.10/safer.py#L84" target="_blank" rel="noopener nofollow">line 84</a> is where the user gets given the stream <code>fp</code> to write to.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*vzJtK99ZjSO3ljytTzHebA.jpeg?q=20" width="288" height="216" role="presentation"></p><p><img width="288" height="216" srcset="https://miro.medium.com/max/552/1*vzJtK99ZjSO3ljytTzHebA.jpeg 276w, https://miro.medium.com/max/576/1*vzJtK99ZjSO3ljytTzHebA.jpeg 288w" sizes="288px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph="">Photo by <a href="https://unsplash.com/@plushdesignstudio?utm_source=medium&amp;utm_medium=referral" target="_blank" rel="noopener nofollow">Plush Design Studio</a> on <a href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" target="_blank" rel="noopener nofollow">Unsplash</a></figcaption></figure><p id="baef" data-selectable-paragraph=""><code><strong>safer</strong></code><strong> uses </strong><code><strong>functools.wraps()</strong></code><strong> for something that isn’t a decorator</strong></p><p id="5732" data-selectable-paragraph=""><code>functools.wraps()</code> lets your function copy the signature and documentation of another function.</p><p id="84f5" data-selectable-paragraph="">A decorator is a function that wraps other functions, so you should always use <code>functools.wraps()</code> if you are writing a decorator, and up until now I had never used it for anything else.</p><p id="d6a7" data-selectable-paragraph="">But <code>safer</code> has exactly two public functions — <code>safer.writer()</code> and <code>safer.printer()</code>. Both functions have the same signature and very similar documentation.</p><p id="c300" data-selectable-paragraph="">In earlier versions of <code>safer</code>, <a href="http://b42e1d5a72ddcfdea1fc485c54c1884845cd3271/" target="_blank" rel="noopener nofollow">the documentation and signature were duplicated</a> and got out of sync more than once. Oh no.</p><p id="7fa4" data-selectable-paragraph=""><code>functools.wraps()</code> copies the signature and documented of <code>safer.writer</code> onto <code>safer.printer</code>, so <a href="https://github.com/rec/safer/blob/v0.9.10/safer.py#L97-L101" target="_blank" rel="noopener nofollow">the definition of </a><code><a href="https://github.com/rec/safer/blob/v0.9.10/safer.py#L97-L101" target="_blank" rel="noopener nofollow">safer.printer()</a></code> just looks like this:</p><pre><span id="4975" data-selectable-paragraph="">@functools.wraps(writer)<br>@contextlib.contextmanager<br>def printer(*args, **kwargs):<br>    with writer(*args, **kwargs) as fp:        <br>        yield functools.partial(print, file=fp)</span></pre><p id="697d" data-selectable-paragraph="">and <code>help(safer.printer())</code> still shows the full signature and documentation.</p><p id="fe14" data-selectable-paragraph="">One source of error lost, less code, but I keep the correct method signature: it’s like free money.</p><p id="4f95" data-selectable-paragraph="">I’ve run into this issue of massive duplication between function signatures in several projects, and this is the first time I’ve thought of using <code>functools.wraps()</code>.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*VfLaNde7qAiLixw-eCga4Q.jpeg?q=20" width="320" height="205" role="presentation"></p><p><img width="320" height="205" srcset="https://miro.medium.com/max/552/1*VfLaNde7qAiLixw-eCga4Q.jpeg 276w, https://miro.medium.com/max/640/1*VfLaNde7qAiLixw-eCga4Q.jpeg 320w" sizes="320px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph=""><a href="https://commons.wikimedia.org/wiki/File:Colourful_pencils.jpg" target="_blank" rel="noopener nofollow">https://commons.wikimedia.org/wiki/File:Colourful_pencils.jpg</a></figcaption></figure><p id="5bf9" data-selectable-paragraph=""><code><strong>safer</strong></code><strong> works on every version of Python, including 2.7</strong></p><p id="9261" data-selectable-paragraph="">Python 2.7 is the only remaining version of Python 2 and it’s rather a curiosity to be writing new code that supports 2.7.</p><p id="4c76" data-selectable-paragraph="">Python 2 is supposed to be dead and gone, and the porting procedure from 2 to 3 is near trivial and can be done incrementally, one file at a time, but some people are still on legacy systems. The lazy need to be provided for too!</p><p id="e9a1" data-selectable-paragraph="">Me, I stopped supporting Python 2 last year, and I had <code>safer</code> mostly written before I realized that I was using almost nothing from Python 3 at all.</p><p id="b2ea" data-selectable-paragraph="">So for a lark, I ported it to Python 2 (and did old Python 3.4 at the same time).</p><p id="bed8" data-selectable-paragraph="">This was not my greatest lark, because even though the changes to the code itself were tiny, the <em>tests</em> relied on several Python 3 features and to come up with a neat way around it, I had to write <a href="https://github.com/rec/safer/blob/v0.9.10/test_safer.py#L126-L156" target="_blank" rel="noopener nofollow">all this</a> and then rewrite every test — and then later on I’ve made changes that broke in just one version (2.7 or 3.4) though I quickly learned to test just those two versions in development.</p><p id="f556" data-selectable-paragraph="">But it worked. And so you can use this on any Python codebase.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/40/1*t5MihvKMbKsDDVYSFmCaLg.jpeg?q=20" width="320" height="480" role="presentation"></p><p><img width="320" height="480" srcset="https://miro.medium.com/max/552/1*t5MihvKMbKsDDVYSFmCaLg.jpeg 276w, https://miro.medium.com/max/640/1*t5MihvKMbKsDDVYSFmCaLg.jpeg 320w" sizes="320px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph=""><a href="https://www.wallpaperflare.com/pencil-education-creativity-cross-write-school-colored-pencil-wallpaper-axbig/download/320x480" target="_blank" rel="noopener nofollow">Wallpaperflare</a></figcaption></figure><p id="3708" data-selectable-paragraph=""><a href="https://github.com/rec/safer/blob/master/README.rst" target="_blank" rel="noopener nofollow">The </a><code><a href="https://github.com/rec/safer/blob/master/README.rst" target="_blank" rel="noopener nofollow"><strong>README.rst</strong></a></code><strong> is automatically generated with almost no machinery</strong></p><p id="1a11" data-selectable-paragraph="">If you write Python code that you want other people to use, you need to make sure that the documentation in the source file ends up being documentation on the web.</p><p id="8aa5" data-selectable-paragraph="">For a one-file library, you can put it all into one file, often named <code>README.rst</code>.</p><p id="e6fe" data-selectable-paragraph="">You still don’t want to have to change the documentation by hand every time you you change the code, so you need a tool to extract the code documentation into web documentation.</p><p id="eeae" data-selectable-paragraph="">Unfortunately, <a href="https://www.sphinx-doc.org/en/master/" target="_blank" rel="noopener nofollow">Sphinx</a>, the industry-standard documentation tool for Python, is both complex and complicated, and in previous projects I and other developers have struggled to set it up, then struggled further to make seemingly minor tweaks.</p><p id="2f9f" data-selectable-paragraph="">Having to debug your documentation is demoralizing and a waste of time. It’s particularly annoying when your whole darned program is only one file in the first place.</p><p id="eeb4" data-selectable-paragraph="">This time, I asked, “What’s the least amount of work I’d have to put in to do it myself? How can I make a useful document extractor just for this project in the absolute minimum amount of work?” (Because I love to work, but I also want to do the least possible amount of work to get results.)</p><p id="9ca2" data-selectable-paragraph="">And here it is, <code><a href="https://github.com/rec/safer/blob/v1.0.0/doc_safer.py" target="_blank" rel="noopener nofollow">doc_safer.py</a></code>. It took me much, much less time than wrestling with Sphinx ever did.</p><p id="80d8" data-selectable-paragraph="">Now I never directly touch <code>README.rst</code> at all, but instead change the comments in <code><a href="https://github.com/rec/safer/blob/v1.0.0/safer.py" target="_blank" rel="noopener nofollow">safer.py</a></code> and run <code><a href="https://github.com/rec/safer/blob/v1.0.0/doc_safer.py" target="_blank" rel="noopener nofollow">doc_safer.py</a></code>.</p><p id="6166" data-selectable-paragraph="">To be fair, Sphinx can write several formats including <code>html</code>, and I just wanted to generate <code><a href="https://docutils.sourceforge.io/rst.html" target="_blank" rel="noopener nofollow">.rst</a></code><a href="https://docutils.sourceforge.io/rst.html" target="_blank" rel="noopener nofollow"> files</a>, so I simply put a little reStructuredText into the Python source code. This changes the problem from sophisticated parsing and productions to mostly just copying things around.</p><p id="a545" data-selectable-paragraph="">The real work is just in <a href="https://github.com/rec/safer/blob/v1.0.0/doc_safer.py#L14-L19" target="_blank" rel="noopener nofollow">these few lines here</a>, which use Python’s <code><a href="https://docs.python.org/3/library/inspect.html" target="_blank" rel="noopener nofollow">inspect</a></code> module to pull the signatures and documentation out from each public function in <code>safer</code>. There’s a bit of a hack to get the <code><a href="https://github.com/rec/safer/blob/master/README.rst#examples" target="_blank" rel="noopener nofollow">EXAMPLES</a></code><a href="https://github.com/rec/safer/blob/master/README.rst#examples" target="_blank" rel="noopener nofollow"> section</a> that I wanted, but overall it came out nicely, and I’m thinking of extracting it into a tiny tool for a later article.</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*9tw4Lpd1pGB3RnQA3JASlw.jpeg?q=20" width="369" height="226" role="presentation"></p><p><img width="369" height="226" srcset="https://miro.medium.com/max/552/1*9tw4Lpd1pGB3RnQA3JASlw.jpeg 276w, https://miro.medium.com/max/738/1*9tw4Lpd1pGB3RnQA3JASlw.jpeg 369w" sizes="369px" role="presentation"></p></div></div></div><figcaption data-selectable-paragraph=""><a href="https://pxhere.com/en/photo/636904" target="_blank" rel="noopener nofollow">pencil-wood-pen-pattern-reflection-color-macro</a></figcaption></figure><p id="daf9" data-selectable-paragraph=""><strong>It’s a good template for a single-file library</strong></p><p id="2560" data-selectable-paragraph=""><a href="https://github.com/rec/safer/commit/892d76029192264c85e92fb8fae8ece682c27902?diff=unified" target="_blank" rel="noopener nofollow">This first commit</a> has everything — a single file, a test, an installer, instructions to <a href="https://flake8.pycqa.org/en/latest/" target="_blank" rel="noopener nofollow">flake8</a>, and a continuous integration setup with <a href="https://travis-ci.org/" target="_blank" rel="noopener nofollow">Travis</a> (you need to sign up for it, but you can use it for free for open source).</p><h2 id="098a" data-selectable-paragraph="">Thanks for reading!</h2><p id="23bb" data-selectable-paragraph="">If you want to read more:</p><ul><li id="d7e3" data-selectable-paragraph="">Click on <code>Watch</code> in <a href="https://github.com/rec/coroniad" target="_blank" rel="noopener nofollow">the Coroniad repository</a> (which only gets this series)</li><li id="8259" data-selectable-paragraph="">Or <a target="_blank" rel="noopener" href="https://medium.com/@TomSwirly">follow me</a> on Medium (which gets all my posts)</li></ul></div></div></section></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>