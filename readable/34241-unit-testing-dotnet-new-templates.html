<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Unit Testing dotnet new Templates -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>Unit Testing dotnet new Templates</h1>
    <div class="entry-content"> <p>As I talked about in my previous post some time ago about dotnet new project templates, it&#x2019;s possible to enable feature selection, so that developers can toggle certain features of a project template on or off. This is not a feature that many templates in the wild use a lot. Quite often I&#x2019;ve seen templates have no optional features or only a few. One reason is that it gets very complicated to test that toggling your optional features doesn&#x2019;t break the generated project in some way by stopping it from building for example. This is why I decided to write a small unit test helper library for dotnet new project templates. It is unit test framework agnostic and can work with xUnit, NUnit, MSTest or any other unit test framework.</p>
<h2>Example Usage</h2>
<p>Below is an example showing how you can use it inside an xUnit test project.</p> <div id="crayon-5d62ccab1396e641168727" class="crayon-syntax crayon-theme-vs2012-black crayon-font-consolas crayon-os-pc print-yes notranslate"> <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no">
public class ApiTemplateTest
{
    public ApiTemplateTest() =&gt; DotnetNew.Install&lt;ApiTemplateTest&gt;(&quot;ApiTemplate.sln&quot;).Wait();

    [Theory]
    [InlineData(&quot;StatusEndpointOn&quot;, &quot;status-endpoint=true&quot;)]
    [InlineData(&quot;StatusEndpointOff&quot;, &quot;status-endpoint=false&quot;)]
    public async Task RestoreAndBuild_CustomArguments_IsSuccessful(string name, params string[] arguments)
    {
        using (var tempDirectory = TempDirectory.NewTempDirectory())
        {
            var dictionary = arguments
                .Select(x =&gt; x.Split(&apos;=&apos;, StringSplitOptions.RemoveEmptyEntries))
                .ToDictionary(x =&gt; x.First(), x =&gt; x.Last());
            var project = await tempDirectory.DotnetNew(&quot;api&quot;, name, dictionary);
            await project.DotnetRestore();
            await project.DotnetBuild();
        }
    }

    [Fact]
    public async Task Run_DefaultArguments_IsSuccessful()
    {
        using (var tempDirectory = TempDirectory.NewTempDirectory())
        {
            var project = await tempDirectory.DotnetNew(&quot;api&quot;, &quot;DefaultArguments&quot;);
            await project.DotnetRestore();
            await project.DotnetBuild();
            await project.DotnetRun(
                @&quot;Source\DefaultArguments&quot;,
                async (httpClient, httpsClient) =&gt;
                {
                    var httpResponse = await httpsClient.GetAsync(&quot;status&quot;);
                    Assert.Equal(HttpStatusCode.OK, httpResponse.StatusCode);
                });
        }
    }
}</textarea></div>
<div class="crayon-main">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums ">
<div class="crayon-nums-content"></div>
</td>
<td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5d62ccab1396e641168727-1"><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">ApiTemplateTest</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-3"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-e">ApiTemplateTest</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">DotnetNew</span><span class="crayon-sy">.</span><span class="crayon-v">Install</span><span class="crayon-o">&lt;</span><span class="crayon-v">ApiTemplateTest</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;ApiTemplate.sln&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">Wait</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-6"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">[</span><span class="crayon-e">InlineData</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;StatusEndpointOn&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">&quot;status-endpoint=true&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-7"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">[</span><span class="crayon-e">InlineData</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;StatusEndpointOff&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">&quot;status-endpoint=false&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-8"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-e">Task </span><span class="crayon-e">RestoreAndBuild_CustomArguments_IsSuccessful</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">params</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">arguments</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-10"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">tempDirectory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">TempDirectory</span><span class="crayon-sy">.</span><span class="crayon-e">NewTempDirectory</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-12"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">dictionary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">arguments</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-13"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">.</span><span class="crayon-e">Select</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-e">Split</span><span class="crayon-sy">(</span><span class="crayon-s">&apos;=&apos;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">StringSplitOptions</span><span class="crayon-sy">.</span><span class="crayon-v">RemoveEmptyEntries</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-14"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-sy">.</span><span class="crayon-e">ToDictionary</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-e">First</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-e">Last</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-15"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">project</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">tempDirectory</span><span class="crayon-sy">.</span><span class="crayon-e">DotnetNew</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;api&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dictionary</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-16"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">project</span><span class="crayon-sy">.</span><span class="crayon-e">DotnetRestore</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-17"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">project</span><span class="crayon-sy">.</span><span class="crayon-e">DotnetBuild</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-22"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">public</span><span class="crayon-h"> </span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-e">Task </span><span class="crayon-e">Run_DefaultArguments_IsSuccessful</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-24"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-st">using</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">tempDirectory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">TempDirectory</span><span class="crayon-sy">.</span><span class="crayon-e">NewTempDirectory</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-26"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">project</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">tempDirectory</span><span class="crayon-sy">.</span><span class="crayon-e">DotnetNew</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;api&quot;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">&quot;DefaultArguments&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-27"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">project</span><span class="crayon-sy">.</span><span class="crayon-e">DotnetRestore</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-28"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">project</span><span class="crayon-sy">.</span><span class="crayon-e">DotnetBuild</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-30"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-s ">@&quot;Source\DefaultArguments&quot;</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-31"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-m">async</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">httpClient</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">httpsClient</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-33"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">httpResponse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">await</span><span class="crayon-h"> </span><span class="crayon-v">httpsClient</span><span class="crayon-sy">.</span><span class="crayon-e">GetAsync</span><span class="crayon-sy">(</span><span class="crayon-s">&quot;status&quot;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5d62ccab1396e641168727-34"><span class="crayon-h">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</span><span class="crayon-v">Assert</span><span class="crayon-sy">.</span><span class="crayon-e">Equal</span><span class="crayon-sy">(</span><span class="crayon-v">HttpStatusCode</span><span class="crayon-sy">.</span><span class="crayon-v">OK</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">httpResponse</span><span class="crayon-sy">.</span><span class="crayon-v">StatusCode</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div> <p>The first thing it does in the constructor is install the dotnet new project templates in your solution. It needs to know the name of the solution file. It then walks the sub-directory tree below your solution file and installs all project templates for you.</p>
<p>If we then look at the first unit test, we first need a temporary directory, where we can create a project from our dotnet new project template. We will generate a project from the template in this directory and then delete the directory at the end of the test. We then run dotnet new with the name of a project template, the name we want to give to the generated project and any custom arguments that particular project template supports. Using xUnit, I&#x2019;ve parameterised the arguments, so we can run multiple tests while tweaking the arguments for each test. Running DotnetNew returns a project which contains some metadata about the project that we&#x2019;ve just created and we can also use it to further dotnet commands against.</p>
<p>Finally, we run dotnet restore and dotnet build against the project. So this test ensures that toggling the StatusEndpointOn option on our project template doesn&#x2019;t stop the generated project from restoring NuGet packages or building successfully.</p>
<p>The second unit test method is where it get&#x2019;s really cool. If the project template is an ASP.NET Core project, we can use dotnet run to start the project listening on some random free ports on the machine. The unit test framework then gives you two HttpClient&#x2019;s (One for HTTP and one for HTTPS) with which to call your newly generated project. In summary, not only can you test that the generated projects build, you can test that the features in your generated project work as they should.</p>
<p>This API is pretty similar to the ASP.NET Core TestHost API that also gives you a HttpClient to test the API with. The difference is that this framework is actually running the app using the dotnet run command. I have experimented with using the TestHost API to run the generated project in memory, so it could be run a bit faster but the .NET Core API&#x2019;s for dynamically loading DLL files needs some work which .NET Core 3.0 might solve.</p>
<h2>Where To Get It?</h2>
<p>You can download the <a href="https://www.nuget.org/packages/Boxed.DotnetNewTest/">Boxed.DotnetNewTest</a> NuGet package or see the <a href="https://github.com/Dotnet-Boxed/Framework#boxeddotnetnewtest">source code</a> on GitHub.</p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>