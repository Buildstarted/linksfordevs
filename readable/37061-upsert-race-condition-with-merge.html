<!DOCTYPE html>
<html lang="en">
<head>
    <title>
&#x201C;UPSERT&#x201D; Race Condition With MERGE -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>&#x201C;UPSERT&#x201D; Race Condition With MERGE</h1>
    <article class="blog-post"> <header> </header> <p class="MsoNormal"><font>I mentioned in </font><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><font>Conditional INSERT/UPDATE Race Condition</font></a><font> that most &#x201C;UPSERT&#x201D; code is defective and can lead to constraint violations and data integrity issues in a multi-user environment .<span>&#xA0; </span>In this post, I&#x2019;ll show how to prevent duplicate key errors and data problems with the MERGE statement too.<span>&#xA0; </span>You might want to peruse </font><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><font>Conditional INSERT/UPDATE Race Condition</font></a><font> before reading this for a background on these concurrency concerns.</font></p>
<h2><font>Background on MERGE</font></h2>
<p class="MsoNormal"><font>Microsoft introduced the ANSI-standard MERGE statement in SQL Server 2008.<span>&#xA0; </span>MERGE is very powerful in that it can perform multiple actions in a single statement that previously required separate INSERT/UPDATE/DELETE statements.<span>&#xA0; </span>MERGE is also a good alternative to the proprietary UPDATE&#x2026;FROM syntax allowed in the T-SQL dialect. </font></p>
<p class="MsoNormal"><font>MERGE can (and in my opinion should) be used to address the requirement to either INSERT or UPDATE depending on whether the source data already exists.<span>&#xA0; </span>One need only include the MERGE statement clauses WHEN MATCHED THEN UPDATE and WHEN NOT MATCHED THEN INSERT in order to take the proper action, all within a single statement.</font></p>
<h2><font><font><font><span>&#xA0;</span>&#x201C;UPSERT&#x201D; MERGE Concurrency Test</font></font></font></h2>
<p class="MsoNormal"><font>Even though MERGE provides the means to perform multiple actions within a single statement, developers still need to consider concurrency with MERGE to prevent errors and data issues.<span>&#xA0; </span>Let me illustrate using the table and stored procedure that I originally posted in </font><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><font>Conditional INSERT/UPDATE Race Condition</font></a><font>:</font></p>
<table class="MsoNormalTable"> <tbody> <tr> <td width="394"> <p class="MsoNormal"><span>CREATE</span><span> <span>TABLE</span> dbo<span>.</span>Foo<o:p></o:p></span></p> <p class="MsoNormal"><span>(<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>ID <span>int</span> <span>NOT</span> <span>NULL<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>CONSTRAINT</span> PK_Foo <span>PRIMARY</span> <span>KEY</span><span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>Bar <span>int</span> <span>NOT</span> <span>NULL<o:p></o:p></span></span></p> <p class="MsoNormal"><span>);<o:p></o:p></span></p> <p class="MsoNormal"><span>GO<o:p></o:p></span></p> <p class="MsoNormal"><span>CREATE</span><span> <span>PROCEDURE</span> dbo<span>.</span>Merge_Foo<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@ID <span>int</span><span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@Bar <span>int<o:p></o:p></span></span></p> <p class="MsoNormal"><span>AS<o:p></o:p></span></p> <p class="MsoNormal"><span>SET</span><span> <span>NOCOUNT</span><span>,</span> <span>XACT_ABORT</span> <span>ON</span><span>;<o:p></o:p></span></span></p> <p class="MsoNormal"><span>MERGE</span><span> dbo<span>.</span>Foo <span>AS</span> f<o:p></o:p></span></p> <p class="MsoNormal"><span>USING </span><span>(</span><span>SELECT</span><span> @ID <span>AS</span> ID<span>,</span> @Bar <span>AS</span> Bar<span>)</span> <span>AS</span> new_foo<o:p></o:p></span></p> <p class="MsoNormal"><span>ON</span><span> f<span>.</span>ID <span>=</span> new_foo<span>.</span>ID<o:p></o:p></span></p> <p class="MsoNormal"><span>WHEN</span><span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>UPDATE</span> <span>SET</span> f<span>.</span>Bar <span>=</span> new_foo<span>.</span>Bar<o:p></o:p></span></p> <p class="MsoNormal"><span>WHEN</span><span> <span>NOT</span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>INSERT </span><span>(</span>ID<span>,</span> Bar<span>)<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>VALUES </span><span>(</span>new_foo<span>.</span>ID<span>,</span> new_foo<span>.</span>Bar<span>);<o:p></o:p></span></span></p> <p class="MsoNormal"><span>RETURN</span><span> <span>@@ERROR</span><span>;<o:p></o:p></span></span></p> <p class="MsoNormal"><span>GO</span></p> </td> </tr> </tbody>
</table>
<p class="MsoNormal"><font>I ran the script below from 2 different SSMS windows after changing the time to the near future so that both executed at the same time.<span>&#xA0; </span>My test box had a single quad-core processor with SQL Server 2008 Developer Edition installed, which I expected to have enough multi-processing power to create the error.</font></p>
<table class="MsoNormalTable"> <tbody> <tr> <td width="280"> <p class="MsoNormal"><span>WAITFOR</span><span> TIME <span>&apos;08:00:00&apos;<o:p></o:p></span></span></p> <p class="MsoNormal"><span>EXEC</span><span> dbo<span>.</span>Merge_Foo<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@ID <span>=</span> 1<span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@Bar <span>=</span> 1</span></p> </td> </tr> </tbody>
</table>
<p class="MsoNormal"><font><font><strong><em>I got a primary key violation error, showing that MERGE is vulnerable to concurrency problems like a multi-statement conditional INSERT/UPDATE technique</em></strong>. However, I couldn&#x2019;t reproduce the error with MERGE nearly as consistently as I could with the conditional INSERT/UPDATE in </font></font><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><font>Conditional INSERT/UPDATE Race Condition</font></a><font>.<span>&#xA0; </span>This could be due to a number of reasons (e.g. faster processor, different SQL Server version, MERGE locking behavior) but I wanted to make sure I could reproduce the error reliably.<span>&#xA0; </span>I created a more robust test to exercise MERGE on a loop:</font></p>
<table class="MsoNormalTable"> <tbody> <tr> <td width="347"> <p class="MsoNormal"><span>CREATE</span><span> <span>TABLE</span> dbo<span>.</span>Foo2<o:p></o:p></span></p> <p class="MsoNormal"><span>(<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>ID <span>int</span> <span>NOT</span> <span>NULL<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>CONSTRAINT</span> PK_Foo2 <span>PRIMARY</span> <span>KEY</span><span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>InsertSpid <span>int</span> <span>NOT</span> <span>NULL,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>InsertTime <span>datetime2</span> <span>NOT</span> <span>NULL,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>UpdateSpid <span>int</span> <span>NULL,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>UpdateTime <span>datetime2</span> <span>NULL<o:p></o:p></span></span></p> <p class="MsoNormal"><span>);</span></p> </td> </tr> </tbody>
</table> <table class="MsoNormalTable"> <tbody> <tr> <td width="377"> <p class="MsoNormal"><span>CREATE</span><span> <span>PROCEDURE</span> dbo<span>.</span>Merge_Foo2<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@ID <span>int<o:p></o:p></span></span></p> <p class="MsoNormal"><span>AS<o:p></o:p></span></p> <p class="MsoNormal"><span>SET</span><span> <span>NOCOUNT</span><span>,</span> <span>XACT_ABORT</span> <span>ON</span><span>;<o:p></o:p></span></span></p> <p class="MsoNormal"><span>MERGE</span><span> dbo<span>.</span>Foo2 <span>AS</span> f <o:p></o:p></span></p> <p class="MsoNormal"><span>USING </span><span>(</span><span>SELECT</span><span> @ID <span>AS</span> ID<span>)</span> <span>AS</span> new_foo<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>ON</span> f<span>.</span>ID <span>=</span> new_foo<span>.</span>ID<o:p></o:p></span></p> <p class="MsoNormal"><span>WHEN</span><span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>UPDATE<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>SET</span> f<span>.</span>UpdateSpid <span>=</span> <span>@@SPID</span><span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>UpdateTime <span>=</span> <span>SYSDATETIME</span><span>()</span> <o:p></o:p></span></p> <p class="MsoNormal"><span>WHEN</span><span> <span>NOT</span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>INSERT<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span></span><span>(<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>ID<span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>InsertSpid<span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>InsertTime<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>)<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>VALUES<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span></span><span>(<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>new_foo<span>.</span>ID<span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>@@SPID</span><span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>SYSDATETIME</span><span>()<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>);<o:p></o:p></span></span></p> <p class="MsoNormal"><span>RETURN</span><span> <span>@@ERROR</span><span>;</span></span></p> </td> </tr> </tbody>
</table>
<p class="MsoNormal"><font><font>I ran the script below from 4 different SSMS windows after changing the time to the near future so that all executed at the same time.<span>&#xA0; </span><span>&#xA0;</span></font></font></p>
<table class="MsoNormalTable"> <tbody> <tr> <td width="899"> <p class="MsoNormal"><span>DECLARE<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span>@NextTime <span>datetime</span><span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span>@ID <span>int</span><span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span>@MillisecondDelay <span>int</span><span>;<o:p></o:p></span></span></p> <p class="MsoNormal"><span>SELECT<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span>@NextTime <span>=</span> <span>&apos;08:10:00&apos;</span><span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span>@ID <span>=</span> 1<span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span>@MillisecondDelay <span>=</span> 100<span>;<o:p></o:p></span></span></p> <p class="MsoNormal"><span>--execute 10 times per second for 1 minute</span><span><o:p></o:p></span></p> <p class="MsoNormal"><span>WHILE</span><span> @ID <span>&lt;=</span> 600 <span><o:p></o:p></span></span></p> <p class="MsoNormal"><span>BEGIN<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span>--pause and sync with other sessions</span><span><o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>WAITFOR</span> <span>TIME</span> @NextTime<span>;</span><span><o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>EXEC</span> dbo<span>.</span>Merge_Foo2<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span></span><span>@ID <span>=</span> @ID<span>;<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>SELECT</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@ID <span>=</span> @ID <span>+</span> 1<span>,<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>--assume no more that 100ms per execution</span><span><o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@NextTime <span>=</span> <span>DATEADD</span><span>(</span><span>MILLISECOND</span><span>,</span> @MillisecondDelay<span>,</span> @NextTime<span>);</span><span><o:p></o:p></span></span></p> <p class="MsoNormal"><span>END</span><span>;</span><span><o:p></o:p></span></p> </td> </tr> </tbody>
</table>
<p class="MsoNormal"><font>I was able to reproduce the primary key violation every time with this test script.</font></p>
<h2><font>Addressing the MERGE Race Condition</font></h2>
<p class="MsoNormal"><font>The underlying issue with any conditional insert technique is that data must be read before the determination can be made whether to INSERT or UPDATE.<span>&#xA0; </span>To prevent concurrent sessions from inserting data with the same key, an incompatible lock must be acquired to ensure only one session can read the key and that lock must be held until the transaction completes.</font></p>
<p class="MsoNormal"><font>I showed how one might address the problem using both UPDLOCK and HOLDLOCK locking hints in </font><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><font>Conditional INSERT/UPDATE Race Condition</font></a><font>.<span>&#xA0; </span>MERGE is slightly different, though.<span>&#xA0; </span>I repeated the test with only the HOLDLOCK hint added:</font></p>
<table class="MsoTableGrid"> <tbody> <tr> <td width="638"> <p class="MsoNormal"><span>ALTER</span><span> <span>PROCEDURE</span> dbo<span>.</span>Merge_Foo2<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>@ID <span>int<o:p></o:p></span></span></p> <p class="MsoNormal"><span>AS<o:p></o:p></span></p> <p class="MsoNormal"><span>SET</span><span> <span>NOCOUNT</span><span>,</span> <span>XACT_ABORT</span> <span>ON</span><span>;<o:p></o:p></span></span></p> <p class="MsoNormal"><span>MERGE</span><span> dbo<span>.</span>Foo2 <span>WITH </span><span>(</span><span>HOLDLOCK</span><span>)</span> <span>AS</span> f <o:p></o:p></span></p> <p class="MsoNormal"><span>USING </span><span>(</span><span>SELECT</span><span> @ID <span>AS</span> ID<span>)</span> <span>AS</span> new_foo<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>ON</span> f<span>.</span>ID <span>=</span> new_foo<span>.</span>ID<o:p></o:p></span></p> <p class="MsoNormal"><span>WHEN</span><span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>UPDATE<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>SET</span> f<span>.</span>UpdateSpid <span>=</span> <span>@@SPID</span><span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>UpdateTime <span>=</span> <span>SYSDATETIME</span><span>()</span> <o:p></o:p></span></p> <p class="MsoNormal"><span>WHEN</span><span> <span>NOT</span> <span>MATCHED</span> <span>THEN<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>INSERT<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span></span><span>(<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>ID<span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>InsertSpid<span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>InsertTime<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>)<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0; </span><span>VALUES<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span></span><span>(<o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span>new_foo<span>.</span>ID<span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>@@SPID</span><span>,</span> <o:p></o:p></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>SYSDATETIME</span><span>()<o:p></o:p></span></span></p> <p class="MsoNormal"><span><span>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; </span><span>);<o:p></o:p></span></span></p> <p class="MsoNormal"><span>RETURN</span><span> <span>@@ERROR</span><span>;</span></span></p> </td> </tr> </tbody>
</table>
<p class="MsoNormal"><font><font><strong><em>This test showed that simply adding the HOLDLOCK hint prevented the primary key violation error.</em></strong><span>&#xA0; </span>Unlike the conditional INSERT/UPDATE in </font></font><a href="http://weblogs.sqlteam.com/dang/archive/2007/10/28/Conditional-INSERTUPDATE-Race-Condition.aspx"><font>Conditional INSERT/UPDATE Race Condition</font></a><font>, MERGE acquired a key update lock by default so UPDLOCK was not needed.<span>&#xA0; </span>Also, in contrast the multi-statement conditional INSERT/UPDATE technique, no explicit transaction is required because MERGE is an atomic DML statement.<span>&#xA0; </span>The HOLDLOCK hint was still needed, though, because MERGE otherwise releases the update key lock before the insert.<span>&#xA0; </span>I gleaned this by examining the locks from a Profiler trace of the MERGE without the HOLDLOCK:</font></p>
<table class="MsoNormalTable" width="599"> <tbody> <tr> <td width="105"> <p class="MsoNormal"><strong><span><font><font>EventClass<o:p></o:p></font></font></span></strong></p> </td> <td width="220"> <p class="MsoNormal"><strong><span><font><font>TextData<o:p></o:p></font></font></span></strong></p> </td> <td width="99"> <p class="MsoNormal"><strong><span><font><font>Mode<o:p></o:p></font></font></span></strong></p> </td> <td width="92"> <p class="MsoNormal"><strong><span><font><font>ObjectID<o:p></o:p></font></font></span></strong></p> </td> <td width="83"> <p class="MsoNormal"><strong><span><font><font>Type<o:p></o:p></font></font></span></strong></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>SP:Starting<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></font></font></span></p> </td> <td width="99"><font></font></td> <td width="92"> <p class="MsoNormal"><span><font><font>1314103722<o:p></o:p></font></font></span></p> </td> <td width="83"><font></font></td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"><font></font></td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>1330103779<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>5 - OBJECT<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>1:173<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>7 - IU<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>6 - PAGE<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>4 - U<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>4 - U<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>1:173<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>7 - IU<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>6 - PAGE<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>1:173<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>6 - PAGE<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>15 - RangeI-N<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>5 - X<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>5 - X<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>1:173<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>6 - PAGE<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"><font></font></td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="92"> <p class="MsoNormal"><span><font><font>1330103779<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>5 - OBJECT<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>SP:Completed<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></font></font></span></p> </td> <td width="99"><font></font></td> <td width="92"> <p class="MsoNormal"><span><font><font>1314103722<o:p></o:p></font></font></span></p> </td> <td width="83"><font></font></td> </tr> </tbody>
</table>
<p class="MsoNormal"><font>If another concurrent MERGE of the same key occurs after the update lock is released and before the exclusive key lock is acquired, a duplicate key error will result.</font></p>
<p class="MsoNormal"><font>The trace below of the MERGE with the HOLDLOCK hint shows that locks aren&#x2019;t released until the insert (and statement) completes, this avoiding the concurrency problem with MERGE.</font></p>
<table width="596" class="MsoNormalTable"> <tbody> <tr> <td width="105"> <p class="MsoNormal"><strong><span><font><font>EventClass<o:p></o:p></font></font></span></strong></p> </td> <td width="220"> <p class="MsoNormal"><strong><span><font><font>TextData<o:p></o:p></font></font></span></strong></p> </td> <td width="99"> <p class="MsoNormal"><strong><span><font><font>Mode<o:p></o:p></font></font></span></strong></p> </td> <td width="89"> <p class="MsoNormal"><strong><span><font><font>ObjectID<o:p></o:p></font></font></span></strong></p> </td> <td width="83"> <p class="MsoNormal"><strong><span><font><font>Type<o:p></o:p></font></font></span></strong></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>SP:Starting<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></font></font></span></p> </td> <td width="99"> </td> <td width="89"> <p class="MsoNormal"><span><font><font>1314103722<o:p></o:p></font></font></span></p> </td> <td width="83"> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> </td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>1330103779<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>5 - OBJECT<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>1:173<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>7 - IU<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>6 - PAGE<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>4 - U<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>1:173<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>6 - PAGE<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>15 - RangeI-N<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Acquired<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>5 - X<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>(10086470766)<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>5 - X<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>7 - KEY<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>1:173<o:p></o:p></font></font></span></p> </td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>0<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>6 - PAGE<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>Lock:Released<o:p></o:p></font></font></span></p> </td> <td width="220"> </td> <td width="99"> <p class="MsoNormal"><span><font><font>8 - IX<o:p></o:p></font></font></span></p> </td> <td width="89"> <p class="MsoNormal"><span><font><font>1330103779<o:p></o:p></font></font></span></p> </td> <td width="83"> <p class="MsoNormal"><span><font><font>5 - OBJECT<o:p></o:p></font></font></span></p> </td> </tr> <tr> <td width="105"> <p class="MsoNormal"><span><font><font>SP:Completed<o:p></o:p></font></font></span></p> </td> <td width="220"> <p class="MsoNormal"><span><font><font>EXEC dbo.Merge_Foo2 @ID = 1<o:p></o:p></font></font></span></p> </td> <td width="99"> </td> <td width="89"> <p class="MsoNormal"><span><font><font>1314103722<o:p></o:p></font></font></span></p> </td> <td width="83"> </td> </tr> </tbody>
</table> <div> <table> <tr> <td></td> </tr> <tr> <td> Vadym <br> 2009-02-03</td> <td>re: &#x201C;UPSERT&#x201D; Race Condition With MERGE <br> I noticed that there must be something suspicious with concurency in this new operator when was reading &quot;Introducing SQL Server 2008&quot;. And here you provide full test and description of this! Many thanks, very interesting</td> </tr> <tr> <td></td> </tr> <tr> <td> Jens <br> 2009-02-08</td> <td>re: &#x201C;UPSERT&#x201D; Race Condition With MERGE Great Dan, this solved a lot of problems for me. But I have a very delicate issue when using Insert OVER DML with MERGE. I have a lot of similar stored procedures as in your article but I use Insert OVER DML to store/archive the old record. I will get the primary key violation error in this case and even I try to put a holdlock on the merge statement it will not work. I also tried setting a HOLDLOCK on the Insert OVER DML statement but I will neither solve my problem.Have searched everywhere for a solution, is this something you have the answer for ?<p>Thanks again for your article !</p></td> </tr> <tr> <td></td> </tr> <tr> <td> <strong> Dan Guzman </strong> <br> 2009-02-08</td> <td>re: &#x201C;UPSERT&#x201D; Race Condition With MERGE Hi, Jens.I see from your separate email that you were able to fix the problem. I&apos;m sharing below so that others might benefit from your experience.----------------------I managed to sort out the problem. I just forgot to use the new SYSDATETIME(), I used GETDATE() and it return three fraction detail which is not enough since the column is a DateTime2(7) type. This will cause a constraint failure in my case because the constraint lies on this column togheter with the ID.Easy to solve.B.rgd<p>Jens</p></td> </tr> <tr> <td></td> </tr> <tr> <td> Ernesto Perales Soto <br> 2012-08-22</td> <td>re: &#x201C;UPSERT&#x201D; Race Condition With MERGE <br> I had a very similar problem to the one described here. I think most of people would believe that a MERGE is atomic (in the sense that the table contents won&apos;t change between the SELECT part and the INSERT/UPDATE part). Great post. </td> </tr> </table>
</div> </article>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
    <script>
        (function() {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function() {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) {}
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>