<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Size matters - Babylon.js - Medium -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Size matters - Babylon.js - Medium</h1><div><div class="ac ae af ag ah cz aj ak"><p id="aecd" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">The scene graph and all the tools and features of Babylon.js rely on an engine which functions as the central hub from which all orders are dispatched to WebGL (or <a href="https://doc.babylonjs.com/features/WebGL2" class="at cg gh gi gj gk" target="_blank" rel="noopener nofollow">WebGL2</a>, or <a href="https://doc.babylonjs.com/extensions/webgpu" class="at cg gh gi gj gk" target="_blank" rel="noopener nofollow">WebGPU</a>). This engine is a simple and thin API that handles command caching, shader compilation, etc…</p><p id="f6df" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">For our 4.1 release we decided to extend the scope of Babylon.js beyond just 3D rendering, and open up the engine for all types of GPU accelerated experiences. To this end, we are now working on decoupling the the engine itself from the scene graph so it can easily be used independently.</p><p id="90ad" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">Why? Because WebGL (or in a broader way accelerated hardware) can also be used for more 2D oriented features like (and not limited to):</p><ul class=""><li id="c9f4" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg gl gm gn">Rendering inking</li><li id="a788" class="ft fu dc bk fv b fw go fy gp ga gq gc gr ge gs gg gl gm gn">Rendering shapes</li><li id="1964" class="ft fu dc bk fv b fw go fy gp ga gq gc gr ge gs gg gl gm gn">Compositing images</li><li id="b43c" class="ft fu dc bk fv b fw go fy gp ga gq gc gr ge gs gg gl gm gn">Applying effects (blur, sepia, etc…)</li><li id="428c" class="ft fu dc bk fv b fw go fy gp ga gq gc gr ge gs gg gl gm gn">Creating GPU accelerated UI controls (going beyond HTML limitations)</li></ul><p id="bad5" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">Prior to 4.0, the engine, scene and other components were highly coupled, not allowing developers to use <a href="https://www.youtube.com/watch?v=OUGPYCiZNiw" class="at cg gh gi gj gk" target="_blank" rel="noopener nofollow">ES6 modules features like treeshaking</a>.</p><p id="6e94" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">The remaining problem that we want to solve for 4.1 is the size of the engine itself.</p><p id="ec85" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">During our build process, we measure the size of a bundle where only the engine is used. The <a href="https://github.com/BabylonJS/Babylon.js/blob/master/dist/preview%20release/packagesSizeBaseLine.json" class="at cg gh gi gj gk" target="_blank" rel="noopener nofollow">current size</a> of that bundle is around 246 KB (around 40KB when gzipped by the web servers). This might not seem that large, but for some partners (including some Microsoft products) every tiny enhancement and file size reduction amounts to a big win for our partners with products at large scale. The simple truth is: the smaller the package, the faster it is to compile and run.</p><h1 id="a8c4" class="gt gu dc bk bj gv de gw dg gx gy gz ha hb hc hd he">The Right Tool for the Right Job</h1><p id="ff84" class="ft fu dc bk fv b fw hf fy hg ga hh gc hi ge hj gg cu">Bundling the engine is equivalent to bringing together all of the files required by the engine to run. As a developer, you can have an idea of which dependencies your project will require, but it could quickly become tricky to find all of them.</p><p id="7c3c" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">For instance the engine can reference fileA, but fileA may need fileB and fileC, and tracking all of these networked dependencies is not an easy task.</p><p id="8005" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">Fortunately we found this wonderful tool by the webpack team: <a href="https://webpack.github.io/analyse/" class="at cg gh gi gj gk" target="_blank" rel="noopener nofollow">https://webpack.github.io/analyse/</a></p><p id="aa44" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">If you run the following command line:</p><pre class="hk hl hm hn ho hp hq hr"><span id="09ac" class="hs gu dc bk ht b en hu hv r hw">webpack --profile --json &gt; webpack-stats.json</span></pre><p id="3661" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">you will get a json file that you can give to the webpack analyser tool to get a dependency map:</p><figure class="hk hl hm hn ho hy cl cm paragraph-image"><figcaption class="bo en io ip iq cn cl cm ir is bj em">First analysis of engine dependencies</figcaption></figure><p id="842f" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">Thanks to the tool, we learned that math.js and tools.js are a couple of the largest contributors to the file size.</p><h1 id="a279" class="gt gu dc bk bj gv de gw dg gx gy gz ha hb hc hd he">Removing dependencies</h1><p id="5a4c" class="ft fu dc bk fv b fw hf fy hg ga hh gc hi ge hj gg cu">Math.js is our math library (no kidding?) and we quickly discovered that the engine was barely using it. As a result, we decided to make some easy changes eliminating the need for engine to rely on it anymore.</p><p id="d259" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">For instance, instead of referencing Color4 directly, it was easier to create a local interface named <a href="https://github.com/BabylonJS/Babylon.js/blob/master/src/Engines/engine.ts#L44" class="at cg gh gi gj gk" target="_blank" rel="noopener nofollow">IColor4Like</a>. No need to get all of the features of the Color4 class when you just need to use its fields.</p><p id="fefe" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">Removing the dependency to Tools was a bit more complicated. Removing it from Engine.ts was not a big deal but unfortunately, doing so did not help reduce the overall size. For a good reason: Another file was holding it back.</p><p id="1edb" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">So again, we use the wonderful tool from Webpack to find who was dragging Tools.js. In addition with the list of files and their sizes, the analyzer provides a visual graph where each node is a file, so you can see who depends on what:</p><figure class="hk hl hm hn ho hy cl cm paragraph-image"><figcaption class="bo en io ip iq cn cl cm ir is bj em">Dependency graph</figcaption></figure><p id="b169" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">More precisely for tools.js, here is the graph:</p><figure class="hk hl hm hn ho hy cl cm paragraph-image"><figcaption class="bo en io ip iq cn cl cm ir is bj em">Tools.js dependency graph</figcaption></figure><p id="9c23" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">The red dots are the ones requiring tool.js. By clicking the red dots, it is now easy to find out who is using tools.js:</p><figure class="hk hl hm hn ho hy cl cm paragraph-image"><figcaption class="bo en io ip iq cn cl cm ir is bj em">Promise.js node</figcaption></figure><p id="5146" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">For instance, we can see here that our promise fallback is one of the culprits.</p><h1 id="0618" class="gt gu dc bk bj gv de gw dg gx gy gz ha hb hc hd he">Final outcome</h1><p id="ee34" class="ft fu dc bk fv b fw hf fy hg ga hh gc hi ge hj gg cu">Now that all files requiring tools.js were identified, it was easy to decouple them.</p><p id="cc15" class="ft fu dc bk fv b fw fx fy fz ga gb gc gd ge gf gg cu">And I’m happy to announce that our hardware abstraction layer is now fully usable in an autonomous way and the file size went down from <strong class="fv iz">246KB </strong>to <strong class="fv iz">162KB</strong>. We saved 84KB (34%) with no feature change!</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>