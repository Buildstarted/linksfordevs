<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Inserting middleware between UseRouting() and UseEndpoints() as a library author -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Inserting middleware between UseRouting() and UseEndpoints() as a library author</h1><div><div class="post-content"><p>This post is in response to a question from a reader about how library authors can ensure consumers of their library insert the library's middleware at the right point in the app's middleware pipeline. Unfortunately there's not really a great solution to that (with a couple of exceptions), but this post highlights one possible approach.</p><h2 id="introduction-ordering-is-important-for-middleware" class="heading-with-anchor">Introduction: ordering is important for middleware<a href="#introduction-ordering-is-important-for-middleware"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>One of the big changes I discussed in <a href="/series/upgrading-to-asp-net-core-3/">my recent series on ASP.NET Core 3.0</a> is that <a href="/converting-a-terminal-middleware-to-endpoint-routing-in-aspnetcore-3/#the-evolution-of-routing">routing now uses Endpoint Routing by default</a>. This manifests most visibly in your ASP.NET Core apps as two separate calls in the <code>Startup.Configure</code> method that configures the middleware pipeline for your app:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span><span class="token punctuation">{</span>

    app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>As shown above, there are two separate calls related to routing in a typical .NET Core 3.0 middleware pipeline: <code>UseRouting()</code> and <code>UseEndpoints()</code>. In addition, middleware can be be placed before, or between these calls. One thing that often trips people up in general is that <strong>where you place your middleware is very important</strong>. It's important you understand <em>what each piece of middleware is doing</em> so that you can put it in the right point in the pipeline.</p><p>For example, in ASP.NET Core 3.0 it's important that you place the <code>AuthenticationMiddleware</code> and <code>AuthorizationMiddleware</code><em>between</em> the two routing middleware calls (and that you place authentication middleware before the authorization middleware):</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span><span class="token punctuation">{</span>

    app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>This requirement is <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-3.1#endpoint-routing">mentioned in the documentation</a>, but it's not very obvious. For example, <a href="https://github.com/aspnet/AspNetCore/issues/14049">an issue Rick Strahl ran into</a> when <a href="https://weblog.west-wind.com/posts/2019/Sep/24/Upgrading-my-AlbumViewer-Sample-to-NET-Core-30#gotcha-order-matters">upgrading his Album Viewer sample to .NET Core 3.0</a> was related to exactly this - middleware added in the wrong order.</p><blockquote><p>ASP.NET Core now does some checks to try and warn you at runtime when you have configured your pipeline incorrectly, as in the case described above. However it only catches a couple of cases, so you still need to be careful when building your pipeline.</p></blockquote><p>This leads us to the heart of the question I received - if you're a library author, how can you ensure your middleware is added at the correct point in a consumer's middleware pipeline? </p><h2 id="using-istartupfilter" class="heading-with-anchor">Using IStartupFilter<a href="#using-istartupfilter"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The simplest scenario is where you need to add middleware to a user's app and you can add it near the <em>start</em> of the middleware pipeline. For this use-case, there's <code>IStartupFilter</code>. I discussed <code>IStartupFilter</code><a href="/exploring-istartupfilter-in-asp-net-core/">in a previous post</a> (over 3 years ago now, doesn't time fly!) but nothing has really changed about it since then, so I'll only describe it briefly here - check out <a href="/exploring-istartupfilter-in-asp-net-core/">that previous post for a more detailed explanation</a>.</p><p><a href="https://github.com/aspnet/AspNetCore/blob/7ae6d1e3791e09db1fe2b032044208b04d4cc3b1/src/Hosting/Abstractions/src/IStartupFilter.cs"><code>IStartupFilter</code></a> provides a mechanism for adding middleware to an app's pipeline by adding a <em>service</em> to the DI container. When building an app's middleware pipeline, the ASP.NET Core infrastructure looks for any registered <code>IStartupFilter</code>s and runs them, essentially providing a mechanism for tacking middleware onto the beginning of an app's pipeline.</p><p>For example, <a href="https://github.com/aspnet/AspNetCore/blob/7ae6d1e3791e09db1fe2b032044208b04d4cc3b1/src/DefaultBuilder/src/ForwardedHeadersStartupFilter.cs">the <code>ForwardedHeadersStartupFilter</code></a> automatically adds <a href="https://github.com/aspnet/AspNetCore/blob/7ae6d1e3791e09db1fe2b032044208b04d4cc3b1/src/Middleware/HttpOverrides/src/ForwardedHeadersMiddleware.cs">the <code>ForwardedHeadersMiddleware</code></a> to the start of a middleware pipeline. This <code>IStartupFilter</code><a href="https://github.com/aspnet/AspNetCore/blob/1480b998660d2f77d0605376eefab6a83474ce07/src/DefaultBuilder/src/WebHost.cs#L240-L252">is (conditionally) added to the DI container by the <code>WebHost</code> on app startup</a>, so you don't have to remember explicitly add it as part of your app's middleware configuration.</p><p>This approach is very useful in many cases, but has one significant limitation - you can only add middleware at the start (or end) of the pipeline defined in <code>Startup.Configure</code>. There's no simple way to add middleware in the middle.</p><p>Unfortunately, that requirement has likely become more common in ASP.NET Core 3.0 with endpoint routing and the separate <code>UseRouting()</code> and <code>UseEndpoints()</code> calls. <code>IStartupFilter</code> doesn't provide an easy mechanism for adding middleware at an arbitrary location in the pipeline, so you have to get inventive.</p><h2 id="taking-a-lead-from-the-analysismiddleware" class="heading-with-anchor">Taking a lead from the AnalysisMiddleware<a href="#taking-a-lead-from-the-analysismiddleware"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>After initially dismissing the task as impossible, I had a small flashback <a href="/tag/middleware-analysis-package/">to some posts I wrote about the <em>Microsoft.AspNetCore.MiddlewareAnalysis</em> package</a>. This package can be used to log all the middleware that is executed as part of the middleware pipeline. </p><p>I explored how to use the package <a href="/understanding-your-middleware-pipeline-with-the-middleware-analysis-package/">in a previous post</a>, and looked at how it was implemented <a href="/under-the-hood-of-the-middleware-analysis-package/">in another</a>. Given we're going to use a similar approach to insert middleware between the calls to <code>UseRouting()</code> and <code>UseEndpoints()</code>, I'll give an overview of the approach here. For a more detailed understanding, <a href="/under-the-hood-of-the-middleware-analysis-package/">check out my previous posts</a>. </p><p>The <em>MiddlewareAnalysis</em> package uses an <code>IStartupFilter</code> to hook into the middleware configuration process of an app. But instead of just adding middleware to the start (or end) of the pipeline, it <em>wraps</em> the <code>IApplicationBuilder</code> instance in a new type, the <code>AnalysisBuilder</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">AnalysisStartupFilter</span><span class="token punctuation">:</span><span class="token class-name">IStartupFilter</span><span class="token punctuation">{</span><span class="token keyword">public</span> Action<span class="token operator">&lt;</span>IApplicationBuilder<span class="token operator">&gt;</span><span class="token function">Configure</span><span class="token punctuation">(</span>Action<span class="token operator">&lt;</span>IApplicationBuilder<span class="token operator">&gt;</span> next<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> builder <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">var</span> wrappedBuilder <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">AnalysisBuilder</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">next</span><span class="token punctuation">(</span>wrappedBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The <code>AnalysisBuilder</code> implements <code>IApplicationBuilder</code>, and its purpose is to intercept any calls to <code>Use()</code> that add middleware to the pipeline. If you follow the method calls far enough down, all calls to <code>IApplicationBuilder</code> that modify the pipeline call <code>Use()</code>, whether it's <code>UseStaticFiles()</code>, <code>UseAuthentication()</code>, or <code>UseMiddleware&lt;MyCustomMiddleware&gt;()</code>.</p><p>When the app calls <code>Use</code> on the <code>AnalysisBuilder</code>, the builder adds it to the pipeline as normal, but it <em>first</em> adds an extra piece of middleware, the <code>AnalysisMiddleware</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">AnalysisBuilder</span><span class="token punctuation">:</span><span class="token class-name">IApplicationBuilder</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token class-name">IApplicationBuilder</span> InnerBuilder <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token function">AnalysisBuilder</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> inner<span class="token punctuation">)</span><span class="token punctuation">{</span>
        InnerBuilder <span class="token operator">=</span> inner<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">IApplicationBuilder</span><span class="token function">Use</span><span class="token punctuation">(</span>Func<span class="token operator">&lt;</span>RequestDelegate<span class="token punctuation">,</span> RequestDelegate<span class="token operator">&gt;</span> middleware<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> InnerBuilder
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseMiddleware</span><span class="token punctuation">&lt;</span><span class="token class-name">AnalysisMiddleware</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The end result is that an instance of <code>AnalysisMiddleware</code> is interleaved between all the other middleware in your pipeline:</p><p><img src="/content/images/2017/02/Analysis-Middleware.png" alt="A middleware pipeline where the AnalysisMiddleware is added before every other middleware "></p><p>The <code>AnalysisMiddleware</code> itself determines the name of the <em>next</em> middleware in the pipeline in its constructor by interrogating the provided <code>RequestDelegate</code>:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">AnalysisMiddleware</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token keyword">string</span> _middlewareName
    <span class="token keyword">public</span><span class="token function">AnalysisMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _middlewareName <span class="token operator">=</span> next<span class="token punctuation">.</span>Target<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>FullName<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>After looking through the code, I gleaned a few key points:</p><ul><li>We can create an <code>IStartupFilter</code>/<code>IApplicationBuilder</code> that can "bookend" each middleware added with an extra piece of middleware</li><li>The <code>Type</code> of the <em>next</em> middleware in the pipeline can be retrieved when the middleware is <em>processing</em>, but not when it's being constructed. i.e. you can get the name of the next middleware in the pipeline from <code>AnalysisMiddleware</code>, but not from the <code>AnalysisBuilder</code>.</li><li>You can't easily get the name of the <em>previous</em> middleware in the pipeline.</li></ul><p>With this in mind, I set about finding a solution to the original problem, inserting middleware between the <code>UseRouting()</code> and <code>UseEndpoints()</code> from a class library.</p><h2 id="inserting-middleware-before-useendpoints" class="heading-with-anchor">Inserting middleware before UseEndpoints<a href="#inserting-middleware-before-useendpoints"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>Given the final point raised in the previous section - it's not possible to check which middleware executed <em>previously</em> to the current one, I decided the easiest location to insert middleware would be just before the <code>UseEndpoints()</code> call which adds the <code>EndpointMiddleware</code> to the pipeline. </p><p>The overall approach is <em>very</em> similar to that used in the <em>MiddlewareAnalysis</em> package. For this example I named the middleware <code>ConditionalMiddleware</code>, as it only runs under a single condition - when the next middleware is of a given type:</p><ul><li>Create an <code>IStartupFilter</code> that replaces the default <code>IApplicationBuilder</code> with a custom one, <code>ConditionalMiddlewareBuilder</code>, that intercepts calls to <code>Use(...)</code></li><li>Every time middleware is added to the pipeline, add an instance of the <code>ConditionalMiddleware</code> first. </li><li>When the <code>ConditionalMiddleware</code> executes, check if the <em>next</em> middleware is the one we're looking for. If it is, run the additional logic before invoking the next middleware in the pipeline.</li></ul><p>I'll start with the easy bit, the <code>ConditionalMiddleware</code> itself. For this example the "extra logic" we're going to execute is just to write out a log message. In practice you might use it to set a request feature or do some sort of request-specific check.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">internal</span><span class="token keyword">class</span><span class="token class-name">ConditionalMiddleware</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span><span class="token keyword">private</span><span class="token keyword">readonly</span> ILogger<span class="token operator">&lt;</span>ConditionalMiddleware<span class="token operator">&gt;</span> _logger<span class="token punctuation">;</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token keyword">string</span> _runBefore<span class="token punctuation">;</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token keyword">bool</span> _runMiddleware<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">ConditionalMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span> ILogger<span class="token operator">&lt;</span>ConditionalMiddleware<span class="token operator">&gt;</span> logger<span class="token punctuation">,</span><span class="token keyword">string</span> runBefore<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _runMiddleware <span class="token operator">=</span> next<span class="token punctuation">.</span>Target<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>FullName <span class="token operator">==</span> runBefore<span class="token punctuation">;</span>

        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        _runBefore <span class="token operator">=</span> runBefore<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">async</span><span class="token class-name">Task</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> httpContext<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>_runMiddleware<span class="token punctuation">)</span><span class="token punctuation">{</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Running conditional middleware before {NextMiddleware}"</span><span class="token punctuation">,</span> _runBefore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">await</span><span class="token function">_next</span><span class="token punctuation">(</span>httpContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>In this example I'm passing in the name of the middleware that we want to run our custom logic before (i.e.<code>"EndpointMiddleware"</code> for my original example). We then check whether the next middleware is the one we're looking for. We can do the check in the constructor, as the middleware pipeline is fixed after it's built - the check ensures that the additional functionality is only run where we need it to be:</p><picture><source srcset="/content/images/2020/conditional_middleware.svg" type="image/svg+xml"><img src="/content/images/2020/conditional_middleware.png" alt="Conditional middleware is added between all the other middleware, but only executes its logic in one location"></picture><p>Next up is the <code>ConditionalMiddlewareBuilder</code>. This is the wrapper class that we use to inject our <code>ConditionalMiddleware</code> between each "real" middleware in the pipeline. It's mostly just a wrapper around the <code>InnerBuilder</code> provided in the constructor:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">internal</span><span class="token keyword">class</span><span class="token class-name">ConditionalMiddlewareBuilder</span><span class="token punctuation">:</span><span class="token class-name">IApplicationBuilder</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token keyword">string</span> _runBefore<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">ConditionalMiddlewareBuilder</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> inner<span class="token punctuation">,</span><span class="token keyword">string</span> runBefore<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _runBefore <span class="token operator">=</span> runBefore<span class="token punctuation">;</span>
        InnerBuilder <span class="token operator">=</span> inner<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span><span class="token class-name">IApplicationBuilder</span> InnerBuilder <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token class-name">IServiceProvider</span> ApplicationServices
    <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token operator">=</span><span class="token operator">&gt;</span> InnerBuilder<span class="token punctuation">.</span>ApplicationServices<span class="token punctuation">;</span><span class="token keyword">set</span><span class="token operator">=</span><span class="token operator">&gt;</span> InnerBuilder<span class="token punctuation">.</span>ApplicationServices <span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> IDictionary<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span><span class="token keyword">object</span><span class="token operator">&gt;</span> Properties <span class="token operator">=</span><span class="token operator">&gt;</span> InnerBuilder<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token class-name">IFeatureCollection</span> ServerFeatures <span class="token operator">=</span><span class="token operator">&gt;</span> InnerBuilder<span class="token punctuation">.</span>ServerFeatures<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token class-name">RequestDelegate</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> InnerBuilder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token class-name">IApplicationBuilder</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">throw</span><span class="token keyword">new</span><span class="token class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token class-name">IApplicationBuilder</span><span class="token function">Use</span><span class="token punctuation">(</span>Func<span class="token operator">&lt;</span>RequestDelegate<span class="token punctuation">,</span> RequestDelegate<span class="token operator">&gt;</span> middleware<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> InnerBuilder
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseMiddleware</span><span class="token punctuation">&lt;</span><span class="token class-name">ConditionalMiddleware</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>_runBefore<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>The <code>ConditionalMiddlewareBuilder</code> is added to the application using an <code>IStartupFilter</code> that wraps the "original" <code>IApplicationBuilder</code> with our imposter:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">ConditionalMiddlewareStartupFilter</span><span class="token punctuation">:</span><span class="token class-name">IStartupFilter</span><span class="token punctuation">{</span><span class="token keyword">private</span><span class="token keyword">readonly</span><span class="token keyword">string</span> _runBefore<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token function">ConditionalMiddlewareStartupFilter</span><span class="token punctuation">(</span><span class="token keyword">string</span> runBefore<span class="token punctuation">)</span><span class="token punctuation">{</span>
        _runBefore <span class="token operator">=</span> runBefore<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> Action<span class="token operator">&lt;</span>IApplicationBuilder<span class="token operator">&gt;</span><span class="token function">Configure</span><span class="token punctuation">(</span>Action<span class="token operator">&lt;</span>IApplicationBuilder<span class="token operator">&gt;</span> next<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> builder <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">var</span> wrappedBuilder <span class="token operator">=</span><span class="token keyword">new</span><span class="token class-name">ConditionalMiddlewareBuilder</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> _runBefore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">next</span><span class="token punctuation">(</span>wrappedBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Finally, lets create a couple of extension methods to make adding our new middleware easy:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">static</span><span class="token keyword">class</span><span class="token class-name">ConditionalMiddlewareExtensions</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token class-name">IServiceCollection</span><span class="token function">AddConditionalMiddleware</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span><span class="token keyword">string</span> beforeMiddleware<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token punctuation">&lt;</span><span class="token class-name">IStartupFilter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">new</span><span class="token class-name">ConditionalMiddlewareStartupFilter</span><span class="token punctuation">(</span>beforeMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">static</span><span class="token class-name">IServiceCollection</span><span class="token function">AddConditionalMiddlewareBeforeEndpoints</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> services<span class="token punctuation">.</span><span class="token function">AddConditionalMiddleware</span><span class="token punctuation">(</span><span class="token string">"Microsoft.AspNetCore.Routing.EndpointMiddleware"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>With all that configured, the one thing that remains is to add the middleware to our app:</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span><span class="token keyword">class</span><span class="token class-name">Startup</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>
        services<span class="token punctuation">.</span><span class="token function">AddRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token function">AddConditionalMiddlewareBeforeEndpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span><span class="token keyword">void</span><span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span><span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
            endpoints<span class="token punctuation">.</span><span class="token function">MapRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>As you can see, we only had to add one line. This is great for library authors, as they don't have to deal with issues arising from users putting the middleware in the wrong place. And it's great for consumers because they don't have to worry about getting it wrong either! Just add the services to your DI container and you're good to go.</p><p>Of course, this example is just a proof of concept - it doesn't do anything interesting other than print the following log message just before the <code>EndpointMiddleware</code>, but it demonstrates an interesting technique:</p><pre class="language-bash"><code class="language-bash">info: MyTestApp.ConditionalMiddleware<span class="token punctuation">[</span>0<span class="token punctuation">]</span>
      Running conditional middleware before Microsoft.AspNetCore.Routing.EndpointMiddleware
</code></pre><p>The other good thing is that while this <em>looks</em> complicated, and it adds a <em>lot</em> of extra middleware, the impact at runtime should be minimal. The "next middleware check" is only executed once per middleware instance, and when the evaluation returns <code>false</code> the runtime effect will be very small - a single additional <code>if</code> check per middleware. Still, I haven't found myself needing to do something like this before, so I'd be interested to hear if someone tries it and how they get on!</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>In this post I discussed the problem of a library author trying to insert middleware at a precise point in a consuming app's pipeline. You can use <code>IStartupFilter</code> to insert middleware at the <em>start</em> of the pipeline, but it doesn't allow you to insert middleware at an arbitrary location, such as between the <code>UseRouting()</code> and <code>UseEndpoints()</code> calls.</p><p>As a potential solution to the problem, I gave a brief overview of the <em>MiddlewareAnalysis</em> package that I've discussed previously, which inserts <code>AnalysisMiddleware</code> between every other middleware in your pipeline. </p><p>I then described a similar approach that can be used to insert our <code>ConditionalMiddleware</code> between each middleware in the pipeline. The <code>ConditionalMiddleware</code> can access the name of the next middleware in the pipeline, so that only the middleware instance placed just before the target middleware (<code>EndpointMiddleware</code>) executes its logic. The end result is somewhat convoluted, but achieves the desired goals!</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>