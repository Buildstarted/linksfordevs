<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Peeking under the hood of Command &amp; Conquer - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Peeking under the hood of Command &amp; Conquer - linksfor.dev(s)"/>
    <meta property="article:author" content="Eric Urban"/>
    <meta property="og:description" content="Looking at the newly released source for Command &amp; Conquer to see what makes it tick."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="http://www.hydrogen18.com/blog/peeking-under-the-hood-of-command-conquer.html"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
	<div class="devring" style="background: #222">
		<div class="grid">
			<div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
				<span class="devring-title">devring.club</span>
				<a href="https://devring.club/site/1/previous" class="devring-previous">Previous</a>
				<a href="https://devring.club/random" class="devring-random">Random</a>
				<a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
			</div>
		</div>
	</div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Peeking under the hood of Command &amp; Conquer</title>
<div class="readable">
        <h1>Peeking under the hood of Command &amp; Conquer</h1>
            <div>by Eric Urban</div>
            <div>Reading time: 32-40 minutes</div>
        <div>Posted here: 08 Jun 2020</div>
        <p><a href="http://www.hydrogen18.com/blog/peeking-under-the-hood-of-command-conquer.html">http://www.hydrogen18.com/blog/peeking-under-the-hood-of-command-conquer.html</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><p>The original source code for <a href="https://en.wikipedia.org/wiki/Command_%26_Conquer">Command &amp; Conquer</a> as well as <a href="https://en.wikipedia.org/wiki/Command_%26_Conquer:_Red_Alert">Command &amp; Conqueror: Red Alert</a> have been released by Electronic Arts. You can grab <a href="https://github.com/electronicarts/CnC_Remastered_Collection">it here on GitHub</a>.</p>
<p>Everything is licensed under the <a href="https://github.com/hydrogen18/CnC_Remastered_Collection/blob/master/License.txt">GPL v3</a> and the source code contains all the original comments. The original changelog from whatever VSC was used is not present. It looks like everything was just put into Git very recently.</p>
<p>I decided to take a peak at what goes on inside this game engine. I'm not going to spend my time reviewing every line of code, but it 
should at least be interesting to find out what game development in C++ was like in the early 1990s.</p>
<p>I'm looking only at the source code for "Command &amp; Conquer: Red Alert" as it looks like it is a fork of the original. You can find it under the
<code>REDALERT</code> directory.</p>

<ol>
<li>290 C++ Header files</li>
<li>296 C++ implementation files</li>
<li>14 assembler files containing x86 assembler instructions</li>
<li>222090 lines of C++ code</li>
</ol>
<p>I got the lines of code figure by counting up the non empty lines then subtracting out lines that were obviously just comments.</p>
<p>Almost all file names are uppercase only.</p>
<p>There is also a  "RedAlert.vcxproj" file, so presumably this is ready to build in newer versions of visual studio. I did not confirm this.</p>
<h2>Is this everything?</h2>
<p>First off, there are no assets at all. Not even a test set. So you would need to somehow legally acquire those, for example you might buy the game from EA.
Until you do that, even if you compile the code you can't really prove it works.</p>
<p>The code is littered with <code>#ifdef WIN32</code>, in fact there are at least 430 occurences. There is a folder <code>WIN32LIB</code> that contains some platform
specific implementations for Microsoft Windows. There are no other platforms implemented. The compiler directives for <code>#ifdef WIN32</code> don't have an <code>#else</code>
anywhere I saw for other platforms. So I'm not entirely sure what the point was, but DOS was a supported platform. So maybe all the checks
allow a build of the game that works on DOS but not Windows. </p>
<p>I thought I found two files <code>LCW.CPP</code> and <code>LCWUNCMP.CPP</code> which
reference the playstation platform indirectly</p>
<div><pre><span></span><span>// From LCW.CPP</span>
 <span>*</span>               <span>Project</span> <span>Name</span> <span>:</span> <span>WESTWOOD</span> <span>LIBRARY</span> <span>(</span><span>PSX</span><span>)</span>                     <span>*</span>
</pre></div>
<p>This file implements the <a href="http://www.shikadi.net/moddingwiki/Westwood_LCW">LCW compression</a> algorithm.</p>
<p>But what the "PSX" actually refers to is the <a href="https://en.wikipedia.org/wiki/POSIX">POSIX</a> standard through a less than common acronym. There is even another implementation of the same compression function <code>LCW_Comp</code> from <code>LCW.CPP</code> in <code>LCWCOMP.ASM</code>. I think the C++ implementation must have just been used
on some platforms where the assembly code wouldn't work.</p>
<p>So I guess they didn't release the Playstation port. I don't even know if the Playstation port was done by Westwood or if it was just subcontracted out.</p>
<p>Interestingly, LZO &amp; LZW compression algorithms are also implemented. So I guess Westwood studios strategy for choosing which technology was "all of the above".
LCW should have been sufficient to dodge the Unisys patent claims on LZW, but maybe the LZW code just stuck around. The only usage of the 
LZW code is in <code>LZWPIPE.CPP</code> which defines the <code>LZWPipe</code> class. The only usage of that code is commented out </p>
<div><pre><span></span><span>// From SAVELOAD.CPP:423</span>

        <span>LZOPipe</span> <span>pipe</span><span>(</span><span>LZOPipe</span><span>::</span><span>COMPRESS</span><span>,</span> <span>SAVE_BLOCK_SIZE</span><span>);</span>
<span>//      LZWPipe pipe(LZWPipe::COMPRESS, SAVE_BLOCK_SIZE);</span>
<span>//      LCWPipe pipe(LCWPipe::COMPRESS, SAVE_BLOCK_SIZE);</span>
</pre></div>
<p>It looks like a few different algorithms were tried in this case and LZO was settled on. So LZW appears to be available, but not used.</p>
<p>Unisys patent claim against LZW expired a long time ago, so there is no longer any concern over this.</p>
<h2>Weird headers</h2>
<p>A header like this present in LZW.H and other files</p>
<div><pre><span></span><span>// From the top of LZW.H</span>
<span>/* $Header: /CounterStrike/LZW.H 1     3/03/97 10:25a Joe_bostic $ */</span>
</pre></div>
<p>The "CounterStrike" here refers to "Command And Conquer: Counterstrike" which is an expansion pack. There are 215 occurences of <code>#ifdef FIXIT_CSII</code> that 
somehow changes things for the expansion pack. The full explanation comes from "awj" on 9-28-1998 in a comment </p>
<div><pre><span></span><span>// From DEFINES.H</span>

<span>#define FIXIT_CSII                                      </span><span>// Adds Aftermath CounterStrike II units</span>
<span>//      ajw 9/28/98 - Note about FIXIT_CSII. Changes seem to have been made for Aftermath ("Counterstrike II") that: a) were</span>
<span>//      bug fixes that should never be rolled back, b) change the nature of the game, at least in multi-player. This meant</span>
<span>//      that the "Red Alert" executable ( == Counterstrike executable ) could no longer be built. Apparently, at the time,</span>
<span>//      this was justified, as it was believed that no further patches to the RA executable would ever be necessary.</span>
<span>//      Given that Denzil's DVD changes and my WOLAPI integration are essentially a patch, we've got a problem.</span>
<span>//      We've decided to level the field and make sure every who gets or patches to the new version of Red Alert, CS, AM, (and</span>
<span>//      their DVD equivalent(s)) will have the same executable. So we're assuming that all of the FIXIT_CSII changes are </span>
<span>//      permanent (as, in fact, all prior FIXIT_'s are - makes me wonder why the old non-compiling code has to hang around</span>
<span>//      forever), and fixing the code so that the assumption "this is an Aftermath game" is no longer hard-coded, but can </span>
<span>//      change at runtime. (Which is what should have been done when Aftermath was created.)</span>
<span>//      &lt;This goes for the following three defines as well.&gt;</span>
<span>#define FIXIT_CARRIER                           </span><span>// Adds Aftermath aircraft carrier</span>
<span>#define FIXIT_PHASETRANSPORT            </span><span>// Adds Aftermath cloaking APC</span>
<span>//      ajw - Discovered that engineer changing fields were specifically left out of aftrmath.ini, thus this has no effect.</span>
<span>//      Engineer changes (and other game rule changes) are in mplayer.ini, which was loaded before aftermath-only mplayer games.</span>
<span>#define FIXIT_ENGINEER                          </span><span>// Adds Engineer rules.ini overrides</span>
</pre></div>
<h2>Missing source code</h2>
<p>There is also the question of <code>WOLAPI.dll</code> which seems to mean "Westwood Online API". This was used for online matchmaking. The author of
Command &amp; Conquer: Red Alert apparently disliked this library enough to write a complete wrapper around it, it is in <code>WOLAPIOB.H</code>. You can probably
just go find the original <code>wolsetup.exe</code> file and extract the DLL from it. But it also likely isn't very useful.</p>
<p>Funnily enough, it appears that <code>WOLAPI.dll</code> was actually <a href="https://github.com/hifi-unmaintained/wolapi">reverse engineered over 9 years ago</a></p>
<p>This <strong>is not a full source code release</strong>, but should be enough for people to understand the internal game mechanics. EA stated the reason for their release was to help modders, so this probably accomplishes that. With substantial work a standalone game could be built.</p>

<p>I decided to start by looking at how the game starts up. Startup code usually gives you a good idea of how a game engine communicates
with the operating system. This is presented roughly in the order that it actually is in the code, but not exactly. Anything not
interesting is skipped.</p>
<h2>The C++ <code>main</code> function.</h2>
<p>The <code>main</code> function is defined in <code>STARTUP.CPP</code>. The game appears to have recently been rebuilt as a DLL, presumably for the remastered
version that is being released. So the first thing it does is assigns <code>RunningAsDLL = true;</code></p>
<p>The main function checks <code>#ifdef MPEGMOVIE</code> as well as <code>#ifdef MCIMPEG</code> all over the place. In <code>DEFINES.H</code> this is commented out entirely</p>
<div><pre><span></span><span>//</span> <span>Define</span> <span>DVD</span> <span>to</span> <span>turn</span> <span>on</span> <span>RADVD</span> <span>additions</span><span>/</span><span>changes</span> <span>-</span> <span>Denzil</span>
#<span>ifdef</span> <span>DVD</span>
<span>//</span>#<span>define</span> <span>INTERNET_OFF</span>
<span>//</span>#<span>define</span> <span>MPEGMOVIE</span> <span>//</span><span>PG</span>
<span>//</span>#<span>define</span> <span>MCIMPEG</span>
#<span>endif</span>
</pre></div>
<p>So presumably the functionality to play MPEG cinematics is missing from the game.</p>
<p>The first thing that happens is it checks for another copy of the game runing and refuses to start. This seems to have been disabled with
a <code>#if (0)</code>. There are many sections of code disabled in this manner, each one featuring a <code>//PG</code>. One of the committers in Git is 
<code>PG-SteveT</code> so I guess the same person who put this project in Git was responsible for porting this to be a DLL rather than a standalone
executable. There are many more sections like this in the <code>main</code> function, I am referring to them just as disabled from here forward.</p>
<p>Next up is checking for free memory. The first check is just allocate 13 megabytes of memory and if that works free it. There is another check
that is disabled that tries to allocate 13 megabytes of memory in a loop. Each iteration of the loop reduces the requested allocation by 1 kilobyte
until it passes. I think it is safe to assume modern computers running Command &amp; Conquer will have the needed 13 megabytes of memory, so it
is sensible that this is disabled.</p>
<p>The next check is to see if the command line contains <code>f:\\projects\\c&amp;c0</code> or <code>F:\\PROJECTS\C&amp;C0</code> and refuse to start if that is the case.
If it is, a dialog box saying "Playing off of the network is not allowed." pops up and the game exits. A quick inspection of some header 
files lead me to find this</p>
<div><pre><span></span> <span>"/* $Header:   F:\projects\c&amp;c0</span><span>\v</span><span>cs\code\wwalloc.h_v   4.9   07 May 1996 17:14:00   JOE_BOSTIC  $ */"</span> <span>in</span> <span>WWALLOC</span><span>.</span><span>H</span><span>.</span>
</pre></div>
<p>Since "vcs" is in the path it seems like an early version control system was used, that acted as a mounted drive in Microsoft Windows. The last time I used IBM Rational ClearCase it still works like this. This probably was done to prevent people from running the game from the network share and constantly
overwriting each other's save files.</p>
<p>The game implements its own command line parsing logic, implemented inline in the main function</p>
<div><pre><span></span><span>// From STARTUP.CPP</span>

        <span>/*</span>
<span>        ** Get pointers to command line arguments just like if we were in DOS</span>
<span>        **</span>
<span>        ** The command line we get is cr/zero? terminated.</span>
<span>        **</span>
<span>        */</span>

        <span>command_scan</span><span>=</span><span>0</span><span>;</span>

        <span>do</span> <span>{</span>
                <span>/*</span>
<span>                ** Scan for non-space character on command line</span>
<span>                */</span>
                <span>do</span> <span>{</span>
                        <span>command_char</span> <span>=</span> <span>*</span><span>(</span> <span>command_line</span><span>+</span><span>command_scan</span><span>++</span> <span>);</span>
                <span>}</span> <span>while</span> <span>(</span> <span>command_char</span><span>==</span><span>' '</span> <span>);</span>

                <span>if</span> <span>(</span> <span>command_char</span><span>!=</span><span>0</span> <span>&amp;&amp;</span> <span>command_char</span> <span>!=</span> <span>13</span> <span>)</span> <span>{</span>
                        <span>argv</span><span>[</span><span>argc</span><span>++</span><span>]</span><span>=</span><span>command_line</span><span>+</span><span>command_scan</span><span>-</span><span>1</span><span>;</span>

                        <span>/*</span>
<span>                        ** Scan for space character on command line</span>
<span>                        */</span>
                        <span>bool</span> <span>in_quotes</span> <span>=</span> <span>false</span><span>;</span>
                        <span>do</span> <span>{</span>
                                <span>command_char</span> <span>=</span> <span>*</span><span>(</span> <span>command_line</span><span>+</span><span>command_scan</span><span>++</span> <span>);</span>
                                <span>if</span> <span>(</span><span>command_char</span> <span>==</span> <span>'"'</span><span>)</span> <span>{</span>
                                        <span>in_quotes</span> <span>=</span> <span>!</span><span>in_quotes</span><span>;</span>
                                <span>}</span>
                        <span>}</span> <span>while</span> <span>(</span> <span>(</span><span>in_quotes</span> <span>||</span> <span>command_char</span><span>!=</span><span>' '</span><span>)</span> <span>&amp;&amp;</span> <span>command_char</span> <span>!=</span> <span>0</span> <span>&amp;&amp;</span> <span>command_char</span><span>!=</span><span>13</span> <span>);</span>
                <span>*</span><span>(</span> <span>command_line</span><span>+</span><span>command_scan</span><span>-</span><span>1</span> <span>)</span> <span>=</span> <span>0</span><span>;</span>
                <span>}</span>

        <span>}</span> <span>while</span> <span>(</span> <span>command_char</span> <span>!=</span> <span>0</span> <span>&amp;&amp;</span> <span>command_char</span> <span>!=</span> <span>13</span> <span>&amp;&amp;</span> <span>argc</span><span>&lt;</span><span>20</span> <span>);</span>
</pre></div>
<p>I didn't really bother proving this works, but  it looks like it scans for things being in quotes on the command line and then
tries to treat them as groups if they are quoted using <code>"</code>. I guess the Windows command line couldn't handle this so it was done in the
game directly. I actually don't know if <code>cmd.exe</code> implements this quoting logic even today.</p>
<p>Main then saves off the original working directory and drive the game was launched from, before changing to the directory with the
executable. Interestingly this seems to default to <code>A:</code> which would usually be a floppy drive on Windows. This code path is disabled
entirely now.</p>
<p>Next up is the first <code>#ifdef WOLAPI_INTEGRATION</code>. This isn't defined and the source code for the Westwood Online API is not available.
If it were defined, the game would try and find a file named <code>wolsetup.exe</code> and run it, before checking for a Windows registry key
indicating that setup is complete. A rather interesting comment shows up here</p>
<div><pre><span></span><span>// From STARTUP.CPP</span>

        <span>//      I've been having problems getting the patch to delete "conquer.eng", which is present in the game</span>
        <span>//      directory for 1.08, but which must NOT be present for this version (Aftermath mix files provide the</span>
        <span>//      string overrides that the 1.08 separate conquer.eng did before Aftermath).</span>
        <span>//      Delete conquer.eng if it's found.</span>
        <span>if</span><span>(</span> <span>FindFirstFile</span><span>(</span> <span>"conquer.eng"</span><span>,</span> <span>&amp;</span><span>wfd</span> <span>)</span> <span>!=</span> <span>INVALID_HANDLE_VALUE</span> <span>)</span>
                <span>DeleteFile</span><span>(</span> <span>"conquer.eng"</span> <span>);</span>
</pre></div>
<p>Apparently the developers after version 1.08 of the game really needed to not have "conquer.eng" be present. So they just
try and delete it every time the game starts up. Why this is packed in with the Westwood Online code, I don't know.</p>
<p>Now we move on to a check for <code>#if(TEN)</code> which is not defined. If it were defined, the game would setup for support for the 
<a href="https://en.wikipedia.org/wiki/Total_Entertainment_Network">Total Entertainment Network</a>.</p>
<p>Right after that check there is a check for <code>#if(MPATH)</code> which is also not defined. It if were then the game would 
have support for the <a href="https://en.wikipedia.org/wiki/MPlayer.com">MPlayer</a>.</p>
<p>Both were decently popular online gaming platforms in the last half of the 1990s. 
My guess is there was a custom build for MPlayer &amp; TEN support. Neither exists today. I discuss these more later
in this article.</p>
<p>Now the game starts a Windows timer, sleeps for 1000 milliseconds and makes sure the system clock has advances. If
this fails it exits the game. I guess the implementation of <code>sleep</code> on some platforms was sufficiently faulty to warrant
such a check during startup. This code has now been disabled.</p>
<div><pre><span></span><span>// From STARTUP.CPP</span>

<span>#if (0)</span><span>//PG</span>
                <span>int</span> <span>time_test</span> <span>=</span> <span>WindowsTimer</span><span>-&gt;</span><span>Get_System_Tick_Count</span><span>();</span>
                <span>Sleep</span> <span>(</span><span>1000</span><span>);</span>
                <span>if</span> <span>(</span><span>WindowsTimer</span><span>-&gt;</span><span>Get_System_Tick_Count</span><span>()</span> <span>==</span> <span>time_test</span><span>){</span>
                        <span>MessageBox</span><span>(</span><span>0</span><span>,</span> <span>TEXT_ERROR_TIMER</span><span>,</span> <span>TEXT_SHORT_TITLE</span><span>,</span> <span>MB_OK</span><span>|</span><span>MB_ICONSTOP</span><span>);</span>
                        <span>return</span><span>(</span><span>EXIT_FAILURE</span><span>);</span>
                <span>}</span>
<span>#endif</span>
</pre></div>
<p>Then the game checks for free disk space and if it doesn't have enough it exits. This code has now been disabled.</p>
<p>It's now onwards to loading the configuration generated from the <code>ccsetup</code> program that comae with the original game.
This doesn't do anything too interesting, but I did notice this </p>
<div><pre><span></span>: <span>cpp</span>

<span>//</span> <span>From</span> <span>STARTUP</span>.<span>CPP</span>

                        <span>if</span> <span>(</span><span>!</span><span>Debug_Quiet</span><span>)</span> {
                                <span>Audio_Init</span><span>(</span><span>NewConfig</span>.<span>DigitCard</span>,
                                                <span>NewConfig</span>.<span>Port</span>,
                                                <span>NewConfig</span>.<span>IRQ</span>,
                                                <span>NewConfig</span>.<span>DMA</span>,
                                                <span>PLAYBACK_RATE_NORMAL</span>,
<span>//</span>                                              <span>(</span><span>NewConfig</span>.<span>Speed</span><span>)</span> ? <span>PLAYBACK_RATE_SLOW</span> : <span>PLAYBACK_RATE_NORMAL</span>,
                                                <span>NewConfig</span>.<span>BitsPerSample</span>,
<span>//</span>                                              <span>4</span>,
                                                <span>(</span><span>Get_CPU</span><span>()</span> <span>&lt;</span> <span>5</span><span>)</span> ? <span>3</span> : <span>5</span>,
<span>//</span>                                              <span>(</span><span>NewConfig</span>.<span>Speed</span><span>)</span> ? <span>3</span> : <span>5</span>,
                                                <span>NewConfig</span>.<span>Reverse</span><span>)</span><span>;</span>
                                <span>SoundOn</span> <span>=</span> <span>true</span><span>;</span>
                        } <span>else</span> {
                                <span>Audio_Init</span><span>(</span><span>0</span>, <span>-</span><span>1</span>, <span>-</span><span>1</span>, <span>-</span><span>1</span>, <span>PLAYBACK_RATE_NORMAL</span>, <span>8</span>, <span>5</span>, <span>false</span><span>)</span><span>;</span>
                        }
</pre></div>
<p>A "DebugQuiet" configuration was added that appears to select an audio output that does nothing. I suppose it would be quite
annoying if you were testing the game to be continually subjected to the noise.</p>
<p>At this point the game is ready to configure the display resolution. This code is <em>exceptionally</em> interesting. The first step is to check for a
screen height of 400, which means a mode of 640 x 400 has been selected. If this can't be set it falls back to 640 x 480.
Any other screen resolution is uset directly. What is so special about a mode of 640 x 400? </p>
<p>To actually do rendering the game needs graphics memory access.
A screen width of 320 results in a special code path running to initialize the display buffers. My guess is anyone running
on a video mode of 320x240 (which is still VGA) is running on such old hardware they don't bother trying to use hardware buffers.
Any other screen height results in an attempt to allocate hardware buffers for the visible memory page and a hidden memory page.
I suspect double buffering of the graphics is used, hence two buffers. For the visible memory page it is mandatory that hardware
memory is available. There is some interesting logic around this allocation</p>
<div><pre><span></span><span>// From STARTUP.CPP</span>

                                <span>VisiblePage</span><span>.</span><span>Init</span><span>(</span> <span>ScreenWidth</span> <span>,</span> <span>ScreenHeight</span> <span>,</span> <span>NULL</span> <span>,</span> <span>0</span> <span>,</span> <span>(</span><span>GBC_Enum</span><span>)(</span><span>GBC_VISIBLE</span> <span>|</span> <span>GBC_VIDEOMEM</span><span>));</span>

                                <span>/*</span>
<span>                                ** Check that we really got a video memory page. Failure is fatal.</span>
<span>                                */</span>
                                <span>memset</span> <span>(</span><span>&amp;</span><span>surface_capabilities</span><span>,</span> <span>0</span><span>,</span> <span>sizeof</span><span>(</span><span>surface_capabilities</span><span>));</span>
                                <span>VisiblePage</span><span>.</span><span>Get_DD_Surface</span><span>()</span><span>-&gt;</span><span>GetCaps</span><span>(</span><span>&amp;</span><span>surface_capabilities</span><span>);</span>
                                <span>if</span> <span>(</span><span>surface_capabilities</span><span>.</span><span>dwCaps</span> <span>&amp;</span> <span>DDSCAPS_SYSTEMMEMORY</span><span>)</span> <span>{</span>
                                        <span>/*</span>
<span>                                        ** Aaaarrgghh!</span>
<span>                                        */</span>
                                        <span>WWDebugString</span><span>(</span><span>TEXT_DDRAW_ERROR</span><span>);</span><span>WWDebugString</span><span>(</span><span>"</span><span>\n</span><span>"</span><span>);</span>
                                        <span>MessageBox</span><span>(</span><span>MainWindow</span><span>,</span> <span>TEXT_DDRAW_ERROR</span><span>,</span> <span>TEXT_SHORT_TITLE</span><span>,</span> <span>MB_ICONEXCLAMATION</span><span>|</span><span>MB_OK</span><span>);</span>
                                        <span>if</span> <span>(</span><span>WindowsTimer</span><span>)</span> <span>delete</span> <span>WindowsTimer</span><span>;</span>
                                        <span>return</span> <span>(</span><span>EXIT_FAILURE</span><span>);</span>
                                <span>}</span>
</pre></div>
<p>I can only imagine that the "Aaaarrgghh!" comment was added after a long session of debugging performance issues on some machines. At some
point someone realized that the DirectDraw API (part of DirectX) could return a system memory page even when a hardware video page is 
asked for.</p>
<p>The hidden page is a bit more lenient, but has the logic and even better comments</p>
<div><pre><span></span><span>// From STARTUP.CPP</span>

                                <span>/*</span>
<span>                                ** If we have enough left then put the hidpage in video memory unless...</span>
<span>                                **</span>
<span>                                ** If there is no blitter then we will get better performance with a system</span>
<span>                                ** memory hidpage</span>
<span>                                **</span>
<span>                                ** Use a system memory page if the user has specified it via the ccsetup program.</span>
<span>                                */</span>
                                <span>unsigned</span> <span>video_memory</span> <span>=</span> <span>Get_Free_Video_Memory</span><span>();</span>
                                <span>unsigned</span> <span>video_capabilities</span> <span>=</span> <span>Get_Video_Hardware_Capabilities</span><span>();</span>
                                <span>if</span> <span>(</span><span>video_memory</span> <span>&lt;</span> <span>(</span><span>unsigned</span> <span>int</span><span>)(</span><span>ScreenWidth</span><span>*</span><span>ScreenHeight</span><span>)</span> <span>||</span>
                                                <span>(</span><span>!</span> <span>(</span><span>video_capabilities</span> <span>&amp;</span> <span>VIDEO_BLITTER</span><span>))</span> <span>||</span>
                                                <span>(</span><span>video_capabilities</span> <span>&amp;</span> <span>VIDEO_NO_HARDWARE_ASSIST</span><span>)</span> <span>||</span>
                                                <span>!</span><span>VideoBackBufferAllowed</span><span>)</span> <span>{</span>
                                        <span>HiddenPage</span><span>.</span><span>Init</span> <span>(</span><span>ScreenWidth</span> <span>,</span> <span>ScreenHeight</span> <span>,</span> <span>NULL</span> <span>,</span> <span>0</span> <span>,</span> <span>(</span><span>GBC_Enum</span><span>)</span><span>0</span><span>);</span>
                                <span>}</span> <span>else</span> <span>{</span>
                                        <span>//HiddenPage.Init (ScreenWidth , ScreenHeight , NULL , 0 , (GBC_Enum)0);</span>
                                        <span>HiddenPage</span><span>.</span><span>Init</span> <span>(</span><span>ScreenWidth</span> <span>,</span> <span>ScreenHeight</span> <span>,</span> <span>NULL</span> <span>,</span> <span>0</span> <span>,</span> <span>(</span><span>GBC_Enum</span><span>)</span><span>GBC_VIDEOMEM</span><span>);</span>

                                        <span>/*</span>
<span>                                        ** Make sure we really got a video memory hid page. If we didnt then things</span>
<span>                                        ** will run very slowly.</span>
<span>                                        */</span>
                                        <span>memset</span> <span>(</span><span>&amp;</span><span>surface_capabilities</span><span>,</span> <span>0</span><span>,</span> <span>sizeof</span><span>(</span><span>surface_capabilities</span><span>));</span>
                                        <span>HiddenPage</span><span>.</span><span>Get_DD_Surface</span><span>()</span><span>-&gt;</span><span>GetCaps</span><span>(</span><span>&amp;</span><span>surface_capabilities</span><span>);</span>
                                        <span>if</span> <span>(</span><span>surface_capabilities</span><span>.</span><span>dwCaps</span> <span>&amp;</span> <span>DDSCAPS_SYSTEMMEMORY</span><span>)</span> <span>{</span>

                                                <span>/*</span>
<span>                                                ** Oh dear, big trub. This must be an IBM Aptiva or something similarly cruddy.</span>
<span>                                                ** We must redo the Hidden Page as system memory.</span>
<span>                                                */</span>
                                                <span>AllSurfaces</span><span>.</span><span>Remove_DD_Surface</span><span>(</span><span>HiddenPage</span><span>.</span><span>Get_DD_Surface</span><span>());</span>  <span>// Remove the old surface from the AllSurfaces list</span>
                                                <span>HiddenPage</span><span>.</span><span>Get_DD_Surface</span><span>()</span><span>-&gt;</span><span>Release</span><span>();</span>
                                                <span>HiddenPage</span><span>.</span><span>Init</span> <span>(</span><span>ScreenWidth</span> <span>,</span> <span>ScreenHeight</span> <span>,</span> <span>NULL</span> <span>,</span> <span>0</span> <span>,</span> <span>(</span><span>GBC_Enum</span><span>)</span><span>0</span><span>);</span>
                                        <span>}</span> <span>else</span> <span>{</span>
                                                <span>VisiblePage</span><span>.</span><span>Attach_DD_Surface</span><span>(</span><span>&amp;</span><span>HiddenPage</span><span>);</span>
                                        <span>}</span>
                                <span>}</span>
</pre></div>
<p>The same "double check" applies to this page as well, but can fallback to system memory.
The comment specifically calls out the <a href="https://en.wikipedia.org/wiki/IBM_Aptiva">IBM Aptiva</a> as a source of these issues. I suspect the IBM Aptiva must have 
been the butt of many jokes during develpoment because <code>DEFINES.H</code> even has a line for <code>#define FIXIT_APTIVA_MODEM</code> which does in fact use special
logic for dealing with the IBM Aptiva's modem.</p>
<p>At this point the game now configures the ScreenHeight to exactly 3072. A graphics buffer is attached to the visible &amp; hidden pages it with dimensions of 3072 x 3072. As far as I can tell almost all the above code around getting hardware memory is in fact disabled by the use of <code>#if</code> statements. It's such a mess it is hard to tell what is enabled and what is not. But all the press releases about the remaster mention "4K" support. So maybe the real resolution of this "4K" remaster is in fact 3072 x 3072.</p>
<p>As recently as 2019, some changes were made with comments indicating the date and time. Someone with initials JAS added a check to see if they were running from the editor (presumably the level editor) 
and avoids taking over the mosue if that is the case. The remaster was announce in Novement 2018, so this timeframe makes sense for various changes
need to implement &amp; test 4K support with new asset files.</p>
<p>There is all kinds of now disabled logic about forcing the intro cinematic on the first run through. It's almost
bipolar, unable to make its mind up as to whether or not the user <em>really</em> needs to see this cinematic. At some point this was 
commented out, probably during the remaster development. I imagine developers and testers got very tired of watching the intro cinematic very quick, so
I suspect it would have been removed during the original devlopment as well.</p>
<p>The game is now ready to play!
It then runs <code>Main_Game</code> (from <code>CONQUER.CPP</code>) which is the actual game loop. The start date in a comment in this file is "April 3, 1991", so the original Command &amp; Conquer had 4 years of development before release in 1995!</p>
<p>Once the game is complete, the <code>Main_Game</code> function can return. There is a bunch of cleanup code, but before we get there we have this check</p>
<div><pre><span></span><span>// From STARTUP.CPP</span>

                        <span>if</span> <span>(</span><span>RunningAsDLL</span><span>)</span> <span>{</span>     <span>//PG</span>
                                <span>return</span> <span>(</span><span>EXIT_SUCCESS</span><span>);</span>
                        <span>}</span>
</pre></div>
<p>So presumably the DLL leaves the graphics in a weird state and probably leaks memory all over the place.</p>

<p>I decided to spend some time looking at other things I found interesting, based off the filenames.</p>
<h2>Windows 95 Stack traces.</h2>
<p>The file <code>W95TRACE.CPP</code> contains the comment </p>
<div><pre><span></span><span>/</span> <span>*</span> <span>Implementation</span> <span>of</span> <span>Win95</span> <span>tracing</span> <span>facility</span> <span>to</span> <span>mimic</span> <span>that</span> <span>of</span> <span>NT</span><span>".  */</span>
</pre></div>
<p>This seems to suggest development was done on Windows NT, but testing was probably done on Windows 95 to make sure it worked for the intended audience. This would make sense as NT would be available as early as July 1993 to developers working on the game. I suspect the Windows 95 stack traces are woefully unhelpful compared to what Windows NT could provide.</p>
<p><strong>Update 2020-06-08</strong> A <a href="https://old.reddit.com/r/programming/comments/gymfhx/analyzing_early_1990s_video_game_code_command/ftbqvr6/">reddit user by the name of /u/elder_george</a> pointed out that in fact this is not for stack traces, but instead provides logging
and tracing. In fact it apeears to be based off an <a href="https://www.drdobbs.com/a-dbwin32-debugger-for-windows/184403245">article published back in October of 1996</a>.</p>
<h2>Watcom compiler</h2>
<p>There is also <code>WATCOM.H</code> that defines lots of "#pragma", which are all obviously specific to the then popular Watcom compiler.</p>
<p>This is sort of interesting, because the <a href="https://en.wikipedia.org/wiki/Watcom_C/C%2B%2B">Watcom compiler</a> first release was 1993 for C++ support. There are other
development notes indicating this project goes back to 1991. Did it start off as a C project and move to C++? Or did they have another C++ compiler available?</p>
<p>There is also this gem from the same file, I guess some compiler writers could not be bothered to implement true &amp; false at this time</p>
<div><pre><span></span><span>// From WATCOM.H</span>

<span>// Fix deficiency in Watcom so that true/false will be defined.</span>
<span>#ifndef __BORLANDC__</span>
<span>#ifndef TRUE_FALSE_DEFINED</span>
<span>#define TRUE_FALSE_DEFINED</span>
<span>enum</span> <span>{</span><span>false</span><span>=</span><span>0</span><span>,</span><span>true</span><span>=</span><span>1</span><span>};</span>
<span>typedef</span> <span>int</span> <span>bool</span><span>;</span>
<span>#endif</span>
<span>#endif</span>
</pre></div>
<h2>Encryption</h2>
<p>Blowfish encryption is implemented in BLOWFISH.CPP, which presumably is the well known <a href="https://en.wikipedia.org/wiki/Blowfish_(cipher)">Blowfish cipher</a>. The only
real use I can think for for this is to obfuscate network traffic.</p>
<h2>Entity system</h2>
<p>The <code>CCPtr</code> class in CCPTR.H is a pointer like type that uses an <code>ID</code> as an offset into a memory heap. This is pretty common, because it makes saving the state of the 
game to disk easier if all objects are tracked in one place. This functions as a very simple way to have an entity system. If you're curious about what the 
advantages of an entity system are in a video game, you can <a href="http://gamesfromwithin.com/managing-data-relationships">read more here</a>.</p>
<h2>Vectors</h2>
<p>The <code>VECTOR.H</code> class defines a template class vaguely similar to std::vector. Presumably this was developed too early to take advantage of STL.</p>
<h2>Dipthongs</h2>
<p>So a <a href="https://en.wikipedia.org/wiki/Diphthong">dipthong</a> is a combination of two adjacent vowel sounds within the same syllable. What does this 
have to do with video game code? Nothing honestly. The strangest file is <code>WIN32LIHB/DIPTHONG.H</code>. The actual description given of this is 
found in the header</p>
<div><pre><span></span><span>// From WIN32LIB/DIPTHONG.CPP</span>

 <span>*</span> <span>DIGRAM</span> <span>or</span> <span>DIATOMIC</span> <span>encoding</span> <span>is</span> <span>the</span> <span>correct</span> <span>term</span> <span>for</span> <span>this</span> <span>method</span><span>.</span>        <span>*</span>
 <span>*</span> <span>This</span> <span>is</span> <span>a</span> <span>fixed</span> <span>dictionary</span> <span>digram</span> <span>encoding</span> <span>optimized</span> <span>for</span> <span>English</span> <span>text</span><span>.</span>  <span>*</span>
</pre></div>
<p>This is bascially a simple compression algorithm that assumes you're compressing text and does
some subsequence replacement.</p>
<p>In the code we find the magic number <code>4567</code> used when making some defines</p>
<div><pre><span></span><span>// From WIN32LIB/DIPTHONG.CPP</span>
<span>#define TXT_GUEST                                       4567+3</span>
<span>#define TXT_LOGIN                                       4567+4</span>
<span>#define TXT_LOGIN_TO_INTERNET   4567+5</span>
<span>#define TXT_YOUR_HANDLE                         4567+6</span>
<span>#define TXT_YOUR_PASSWORD               4567+7</span>
<span>#define TXT_INTERNET_HOST               4567+8</span>
<span>#define TXT_INTERNET_JOIN               4567+9</span>
<span>#define TXT_INTERNET_GAME_TYPE  4567+10</span>
<span>#define TXT_JOIN_INTERNET_GAME  4567+11</span>
<span>#define TXT_ENTER_IP_ADDRESS    4567+12</span>
<span>#define TXT_WINSOCK_CONNECTING                                                  4567+13</span>
<span>#define TXT_WINSOCK_NOT_CONNECTING                                      4567+14</span>
<span>#define TXT_WINSOCK_UNABLE_TO_CONNECT_TO_SERVER 4567+15</span>
<span>#define TXT_WINSOCK_CONTACTING_SERVER                           4567+16</span>
<span>#define TXT_WINSOCK_SERVER_ADDRESS_LOOKUP_FAILED        4567+17</span>
<span>#define TXT_WINSOCK_UNABLE_TO_ACCEPT_CLIENT             4567+18</span>
<span>#define TXT_WINSOCK_UNABLE_TO_CONNECT                           4567+19</span>
<span>#define TXT_WINSOCK_CONNECTION_LOST                                     4567+20</span>
<span>#define TXT_WINSOCK_RESOLVING_HOST_ADDRESS                      4567+21</span>
</pre></div>
<p>The following code runs as part of decompression</p>
<div><pre><span></span><span>// From WIN32LIB/DIPTHONG.CPP</span>
<span>if</span> <span>(</span><span>string</span> <span>&gt;=</span> <span>4567</span><span>)</span> <span>return</span> <span>(</span><span>InternetTxt</span><span>[</span><span>string</span><span>-</span><span>4567</span><span>]);</span>

        <span>ptr</span> <span>=</span> <span>(</span><span>unsigned</span> <span>short</span> <span>int</span> <span>const</span> <span>*</span><span>)</span><span>data</span><span>;</span>
        <span>return</span> <span>(((</span><span>char</span><span>*</span><span>)</span><span>data</span><span>)</span> <span>+</span> <span>ptr</span><span>[</span><span>string</span><span>]);</span>
</pre></div>
<p>The array "InternetTxt" is just a bunch of predefined strings. It appears anything equal to or above "4567" is considered to be a predefined string. 
My guess is this constant was chosen by the developer pressing the keys 4-5-6-7 on the digits row on their keyboard. When I need to generate a random
integer to use as a constant, I prefer <a href="https://xkcd.com/221/">this method</a>.</p>
<h2>The Entertainment Network &amp; MPlayer</h2>
<p>As I mentioned up above, there appear to be custom builds for supporting The Entertainment Network &amp; MPlayer. These were online multiplayer
services at the time.</p>
<p>Each service got its own custom initialization &amp; teardown code.</p>
<h3>The Entertainment Network (TEN) files</h3>
<ol>
<li>CCTEN.CPP</li>
<li>TENMGR.H</li>
</ol>
<p>The following functions are used but have no implementation in the source code</p>
<ol>
<li>tenArSendToPlayer</li>
<li>tenArExitArena</li>
<li>tenArIdleArena</li>
<li>tenArReturnGameOptions</li>
<li>tenArReturnPlayerOptions</li>
<li>tenArSendToOtherPlayers</li>
<li>tenArSendToPlayer</li>
<li>tenArSetAlertMessageRoutine</li>
<li>tenArSetIncomingPacketRoutine</li>
<li>tenArSetOption</li>
<li>tenArSetPlayerEnteredRoutine</li>
<li>tenArSetPlayerState</li>
<li>tenArSetPregameHookRoutine</li>
<li>tenArUnreliableSendToOtherPlayers</li>
<li>tenArUnreliableSendToPlayer</li>
</ol>
<h3>MPlayer (MPATH) files</h3>
<ol>
<li>CCMPATH.CPP</li>
<li>MPMGRW.H</li>
<li>MPMGRD.H</li>
</ol>
<p>The following functions are used but have no implementation in the source code</p>
<ol>
<li>MGenMoveTo</li>
<li>MGenGetMasterNode</li>
<li>MGenFlushNodes</li>
<li>MGenMCount</li>
<li>MGenSanityCheck</li>
<li>MGenGetNode</li>
<li>MGenGetQueueCtr</li>
</ol>
<p>I can't find any details on the missing functions from the TEN code.</p>
<p>The "MPATH" code calls a bunch of "MGen" functions which are also missing. However, you can just go 
<a href="https://github.com/id-Software/Quake/blob/master/WinQuake/mplib.c">look them up in the Quake Source code</a>. Quake was
also available on both of these networks. The TEN code isn't present in the public Quake source however. I am guessing
that MPlayer integration was done by just sharing a standard library with the development studio and having them integrate it.</p>
<p>My guess is EA was cautious and didn't feel they owned this code, whereas id software may have simply not cared at the time that
Quake was released.</p>
<p>Of course, no one <em>actually needs</em> this code. It's just the last thing that remains of what was a staple of late 1990s gaming services.</p>
<p><strong>Update 2020-06-08</strong> <a href="http://www.larryhastings.com/">Larry Hastings</a> reached out to me directly to correct some of my assumptions. It turns out the source code
 that I presumed was in fact the MPlayer implementation is not. In fact it is a piece of software called the "chunnel" which allows a DOS mode application running 
on  Windows 95 to interact with the networking stack provided by Windows. He also shared some details of how MPlayer integrated with
games. I've reproduced it here, with the names of other individuals removed.</p>
<blockquote>
<p>First, most companies didn't do their own integration with Mplayer; they just sent us a code drop and we had to figure out how to build it and do all the integration work ourselves.  But I think Westwood was the exception to the rule.  I remember one of our "porting engineers" took a trip out to visit Westwood before Red Alert shipped.  He was very impressed by the RA network model!</p>
<p>Second, all Mplayer assets were sold to GameSpy, who didn't want any of the online services (Mplayer / POP.X / Global Rankings).  All they wanted was the userbase, and... the ad sales team, maybe?  Anyway, GameSpy folded in 2013, and their assets were sold to Glu Mobile, so I guess theoretically they own the IP now.  Meanwhile, in 1998 TEN pivoted to do "classic" online games, in 1999 they rebranded themselves as Pogo.com, and in 2001 they were bought by... EA!  So EA is probably safe shipping the TEN code.  And I doubt anybody cares about the Mplayer code either, it's long dead.</p>
<p>Third, remember how I said companies tended to do a code drop and Mplayer did the integration work themselves? That was true of id software too. The Mplayer code you saw inside Quake 1 is not integration with the Mplayer gaming service!  It's actually technology we licensed to id called the "chunnel", written by a British programmer guy named ***. The "chunnel" was a library that let 386 protected mode DOS programs running under Windows make calls into Windows 95's Winsock networking stack.  Remember, this is circa 1996, gaming under Windows hadn't quite happened yet.  Quake initially shipped as a DOS program and wasn't ported to Win32 until a year or two later.  The "chunnel" solved a real problem for id, letting their 386 protected mode DOS program participate in network play when run under Windows.  Part of how they showed their thanks was, Mplayer got every id game (while it was a going concern).  Note that if you run early versions of Quake for DOS, like the initial shareware demo, the "splash screen" has the original Mplayer logo (the golden waveform), and a note about "technology licensed from".  And that explains the "-mpath" command-line setting for the DOS builds of Quake ;-)</p>
</blockquote>
<h2>Translation &amp; Localization</h2>
<p>It's always common to see games ported to other languages, so they can appeal to a wider market than the English speaking world.
Interesting, the localization was done at least in part by using <code>#ifdef GERMAN</code> statements sprinkled around as well as being checked 
in <code>LANGUAGE.H</code> before defining things like <code>TEXT_SETUP_FIRST</code>.</p>
<p>The check <code>#ifdef GERMAN</code> shows up 28 times, but <code>#ifdef FRENCH</code> shows up 37 times. Maybe the French translation was just a bit more thorough.</p>
<p>Of course <code>DEFINES.H</code> has the best translation implementation</p>
<div><pre><span></span><span>//</span> <span>From</span> <span>DEFINES</span><span>.</span><span>H</span>
<span>//#</span><span>define</span> <span>SPAIN</span> <span>1</span>       <span>(</span><span>never</span> <span>used</span><span>)</span>
</pre></div>
<p>I guess they just never got around to the Spanish translation.</p>
<h2>Dongle protection</h2>
<p>The <a href="https://en.wikipedia.org/wiki/Software_protection_dongle">hardware dongle</a> was a common method of DRM for all sorts of software at some point in 
the past. Basically you have this obscure &amp; obfuscated piece of hardware you attach to your PC. The software issues some sort of "challenge" to it
and refuses to start if it doesn't get an answer it likes.</p>
<p>I don't think Command &amp; Conquer every shipped with this as a thing, but <code>DEFINES.H</code> does have a commented out line or two about it</p>
<div><pre><span></span><span>// From DEFINES.H</span>
<span>/**********************************************************************</span>
<span>** ColinM</span>
<span>** Set this to enable dongle protection</span>
<span>*/</span>
<span>//#define DONGLE</span>
</pre></div>
<h2>Virgin Interactive</h2>
<p>Westwood studios developed Command &amp; Conquer but was owned by Virgin Interactive. There is this uniquely named check</p>
<div><pre><span></span><span>// From DEFINES.H</span>
<span>/**********************************************************************</span>
<span>**      If this is defined, the special Virgin limited cheat keys</span>
<span>**      are enabled. This allows the "cheat" parameter and then only</span>
<span>**      allows the ALT-W to win the mission.</span>
<span>*/</span>
<span>#ifdef PLAYTEST_VERSION</span>
<span>#define VIRGIN_CHEAT_KEYS</span>
<span>#endif</span>
</pre></div>
<div><pre><span></span><span>// From INIT.CPP</span>
<span>#ifdef VIRGIN_CHEAT_KEYS</span>
                        <span>case</span> <span>PARM_PLAYTEST</span><span>:</span>
                                <span>Debug_Playtest</span> <span>=</span> <span>true</span><span>;</span>
                                <span>break</span><span>;</span>
<span>#endif</span>
</pre></div>
<p>I guess that before release, Virgin Interactive got a special built that allowed them do some play testing on the product.</p>

<p>That's it. I didn't look at everything, just what I found interesting and had time to. I learned a little bit about early 1990s video game development
and maybe I can put some of that knowledge to use in the present.</p>
<p>Maybe in the future I will visit this again. I was really looking forward 
seeing how the the Playstation port of the game compared, but I am guessing EA cannot actually release such a thing even if they have the source code still.</p></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
		<div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>