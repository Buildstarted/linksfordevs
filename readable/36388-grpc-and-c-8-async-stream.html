<!DOCTYPE html>
<html lang="en">
<head>
    <title>
gRPC and C# 8 Async stream -
linksfor.dev(s)
    </title>
	<link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <style type="text/css">
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
        }

        *, ::after, ::before {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #60656a;
            text-align: left;
            background-color: #323b44;
        }

        h1 {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 0.5rem;
            margin-bottom: 0.5rem
        }

        a {
            color: #007bff;
            color: #ccc;
            text-decoration: none;
            background-color: transparent;
            word-break: break-all;
        }

        .unseen a {
            font-weight: bold;
        }

        h3 {
            margin-top: 0;
            padding-top: 0;
            font-weight: normal;
        }

        .grid {
            -ms-flex-direction: column;
            flex-direction: column;
            width: 1024px;
            margin: 0 auto;
            flex: 1 0 auto;
        }

        .row {
            -ms-flex-direction: row;
            flex-direction: row;
            width: 100%;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            display: -ms-flexbox;
            display: flex;
        }

        .col {
            margin: 0 10px 0 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .col-3-of-4, .col-6-of-8, .col-9-of-12 {
            width: calc(75% - 20px);
        }

        .col-1-of-4, .col-2-of-8, .col-3-of-12 {
            width: calc(25% - 20px);
        }

        @media (max-width:1023px) {
            /* big landscape tablets, laptops, and desktops */
            body {
                overflow-x: hidden;
            }

            main {
                width: 99%;
            }

            h1 {
                font-size: 50px;
            }
        }

        .text-right {
            text-align: right;
        }

        footer {
            left: 0;
            width: 100%;
            margin-top: 2em;
            padding: 50px 0;
            text-align: center;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .readable {
            color: #949ba2;
        }

        svg:not(:root).svg-inline--fa {
            color: #60656a;
            overflow: visible;
        }

        .svg-inline--fa.fa-w-12 {
            width: 0.75em;
        }

        svg:not(:root) {
            overflow: hidden;
        }

        .svg-inline--fa {
            display: inline-block;
            font-size: inherit;
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }

        img {
            max-width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .readable h1 {
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <h1>gRPC and C# 8 Async stream</h1>
    <div class="main-content-wrap"> <p><a href="https://grpc.io/">gRPC</a> and its idea to describe an API in a standardized file, which can generate both client and server code to interact in different languages is a compelling idea.<br>In this post, I would like to have a quick look at the experience you would have with gRPC streaming capability and the new <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-8.0/async-streams">C# 8 async streams</a>, which sounds like a perfect match.</p>
<a id="more"></a>
<p>I am using the <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/?tabs=netcore2x">.NET Core CLI</a> to create the solution with two projects, one for the server called grpcAsyncStreamServer and one for the client grpcAsyncStreamClient. By the way, do you know you can get <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/enable-tab-autocomplete">tab completion of .NET Core CLI</a> commands? Very handy.</p>
<h2 id="Server"><a href="#Server" class="headerlink"></a>Server</h2><p> I am using the default gRPC .NET Core template to generate the server part. The template creates a greet.proto file which I will duplicate between the server and the client project. As I want to experience with the <a href="https://www.grpc.io/docs/guides/concepts/">streaming capability of gRPC</a>, I am modifying the greet.proto file adding the keyword stream in front of the SayHello HelloReply response.</p> <p> Here is how the greet.proto looks like.</p>
<figure class="highlight thrift"><figcaption><span>greet.proto</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">option csharp_namespace = <span class="string">&quot;grpcAsyncStreamServer&quot;</span>;</span><br><span class="line"></span><br><span class="line">package Greet;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Greeter</span> </span>{</span><br><span class="line"> </span><br><span class="line"> rpc SayHello (HelloRequest) returns (stream HelloReply);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message HelloRequest {</span><br><span class="line"> <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message HelloReply {</span><br><span class="line"> <span class="built_in">string</span> message = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure> <p>I modify the code of the GreeterService class coming from the template to stream 10 HelloReply back to the client, with a small delay of 200ms in between each string returned to simulate some work.</p>
<figure class="highlight csharp"><figcaption><span>GreeterService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class GreeterService : Greeter.GreeterBase</span><br><span class="line">{</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;GreeterService&gt; _logger;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">GreeterService</span>(<span class="params">ILogger&lt;GreeterService&gt; logger</span>)</span></span><br><span class="line"><span class="function"> </span>{</span><br><span class="line"> _logger = logger;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">SayHello</span>(<span class="params">HelloRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params"> IServerStreamWriter&lt;HelloReply&gt; responseStream, ServerCallContext context</span>)</span></span><br><span class="line"><span class="function"> </span>{</span><br><span class="line"> <span class="keyword">var</span> n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">foreach</span> (<span class="keyword">var</span> x <span class="keyword">in</span> Enumerable.Range(<span class="number">1</span>, <span class="number">10</span>))</span><br><span class="line"> {</span><br><span class="line"> <span class="keyword">await</span> responseStream.WriteAsync(<span class="keyword">new</span> HelloReply</span><br><span class="line"> {</span><br><span class="line"> Message = <span class="string">$&quot;Hello <span class="subst">{request.Name}</span> <span class="subst">{n++}</span>&quot;</span></span><br><span class="line"> });</span><br><span class="line"></span><br><span class="line"> <span class="keyword">await</span> Task.Delay(<span class="number">200</span>);</span><br><span class="line"> }</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></table></figure> <h2 id="Client"><a href="#Client" class="headerlink"></a>Client</h2><p>For the client, I am creating a new Console application and copying the greet.proto into a new folder which I name Protos. Then I need to add the dependencies that you can see on the following csproj, so that at compilation time, the proto file is projected to C# code which I can use in my code. That&#x2019;s nice because it means that you also get after a first compilation IntelliSense auto-completion.</p>
<figure class="highlight xml"><figcaption><span>grpcAsyncStreamClient.csproj</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">&quot;Microsoft.NET.Sdk&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp3.0<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Google.Protobuf&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;3.9.1&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Grpc.Core&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;2.23.0&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Grpc.Net.Client&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;0.2.23&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Grpc.Tools&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;2.23.0&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Protobuf</span> <span class="attr">Include</span>=<span class="string">&quot;Protos\greet.proto&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">GrpcServices</span>&gt;</span>Client<span class="tag">&lt;/<span class="name">GrpcServices</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Access</span>&gt;</span>Public<span class="tag">&lt;/<span class="name">Access</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">ProtoCompile</span>&gt;</span>True<span class="tag">&lt;/<span class="name">ProtoCompile</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">ProtoRoot</span>&gt;</span><span class="tag">&lt;/<span class="name">ProtoRoot</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">CompileOutputs</span>&gt;</span>True<span class="tag">&lt;/<span class="name">CompileOutputs</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">OutputDir</span>&gt;</span>obj\Debug\netcoreapp3.0\<span class="tag">&lt;/<span class="name">OutputDir</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Generator</span>&gt;</span>MSBuild:Compile<span class="tag">&lt;/<span class="name">Generator</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Protobuf</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure> <p>We can now use the new C# 8 Async stream to iterate on the server answers asynchronously.</p> <p>The code is greatly readable with this.</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">{</span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"> </span>{</span><br><span class="line"> <span class="keyword">var</span> channel = GrpcChannel.ForAddress(<span class="string">&quot;https://localhost:5001&quot;</span>);</span><br><span class="line"> <span class="keyword">var</span> client = <span class="keyword">new</span> Greeter.GreeterClient(channel);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> replies = client.SayHello(<span class="keyword">new</span> HelloRequest { Name = <span class="string">&quot;Laurent&quot;</span> });</span><br><span class="line"></span><br><span class="line"> <span class="keyword">await</span> <span class="keyword">foreach</span> (<span class="keyword">var</span> reply <span class="keyword">in</span> replies.ResponseStream.ReadAllAsync())</span><br><span class="line"> {</span><br><span class="line"> Console.WriteLine(reply.Message);</span><br><span class="line"> }</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></table></figure> <h2 id="Conclusion"><a href="#Conclusion" class="headerlink"></a>Conclusion</h2><p>We have seen that C# 8 Async streams are nicely integrating with gRPC streaming capabilities. And it makes code more readable!</p>
<p>You can get all the code on GitHub </p> </div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2019 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
    </footer>
    
</body>
</html>