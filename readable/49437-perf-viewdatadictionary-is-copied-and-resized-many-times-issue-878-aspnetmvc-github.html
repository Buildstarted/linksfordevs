<!DOCTYPE html>
<html lang="en">
<head>
    <title>
[Perf] ViewDataDictionary is copied and resized many times &#xB7; Issue #878 &#xB7; aspnet/Mvc &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>[Perf] ViewDataDictionary is copied and resized many times · Issue #878 · aspnet/Mvc · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>When we spin up a child view, we're seeing many copies of the <code>ViewData</code> dictionary. Currently instead of 1 copy for the child view (we don't even want in many cases, but given where <code>Model</code> lives, that's a non-trivial change for the <code>&lt;T&gt;</code>), we see <strong>5 copies</strong> in total. This is in reference to Issue <a class="issue-link js-issue-link" data-error-text="Failed to load issue title" data-id="38917360" data-permission-text="Issue title is private" data-url="https://github.com/aspnet/Mvc/issues/870" data-hovercard-type="issue" data-hovercard-url="/aspnet/Mvc/issues/870/hovercard" href="https://github.com/aspnet/Mvc/issues/870">#870</a>.</p><p>4 of the 5 come from creations of <a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/AjaxHelperOfTModel.cs"><code>AjaxHelper&lt;T&gt;</code></a> and <a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/HtmlHelperOfTModel.cs"><code>HtmlHelper&lt;T&gt;</code></a> both of which have a <a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/ViewDataDictionaryOfTModel.cs"><code>ViewDataDictionary&lt;T&gt;</code></a> constructor called internally.</p><p><a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/WebViewPage.cs#L105-L110">In the non-generic <code>WebViewPage</code></a> there are 2 copies made:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">virtual</span><span class="pl-k">void</span><span class="pl-en">InitHelpers</span>()
{
    <span class="pl-smi">Ajax</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">AjaxHelper</span>&lt;<span class="pl-k">object</span>&gt;(<span class="pl-smi">ViewContext</span>, <span class="pl-k">this</span>);
    <span class="pl-smi">Html</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">HtmlHelper</span>&lt;<span class="pl-k">object</span>&gt;(<span class="pl-smi">ViewContext</span>, <span class="pl-k">this</span>);
    <span class="pl-smi">Url</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">UrlHelper</span>(<span class="pl-smi">ViewContext</span>.<span class="pl-smi">RequestContext</span>);
}</pre></div><p><a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/WebViewPageOfTModel.cs#L34-L40">And in <code>WebViewPage&lt;T&gt;</code></a> there are 2 additional copies in the <code>InitHelpers()</code> override:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">override</span><span class="pl-k">void</span><span class="pl-en">InitHelpers</span>()
{
    <span class="pl-k">base</span>.<span class="pl-en">InitHelpers</span>();

    <span class="pl-smi">Ajax</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">AjaxHelper</span>&lt;<span class="pl-en">TModel</span>&gt;(<span class="pl-smi">ViewContext</span>, <span class="pl-k">this</span>);
    <span class="pl-smi">Html</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">HtmlHelper</span>&lt;<span class="pl-en">TModel</span>&gt;(<span class="pl-smi">ViewContext</span>, <span class="pl-k">this</span>);
}</pre></div><p><a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/WebViewPageOfTModel.cs#L42-L47">Also in <code>WebViewPage&lt;T&gt;</code></a> in the <code>SetViewData()</code> override is another copy:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">protected</span><span class="pl-k">override</span><span class="pl-k">void</span><span class="pl-en">SetViewData</span>(<span class="pl-en">ViewDataDictionary</span><span class="pl-smi">viewData</span>)
{
    <span class="pl-smi">_viewData</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">ViewDataDictionary</span>&lt;<span class="pl-en">TModel</span>&gt;(<span class="pl-smi">viewData</span>);

    <span class="pl-k">base</span>.<span class="pl-en">SetViewData</span>(<span class="pl-smi">_viewData</span>);
}</pre></div><p>Since <code>ViewDataDictionary&lt;T&gt;</code><a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/ViewDataDictionary.cs#L34-L55">performs a shallow copy in its base <code>ViewDataDictionary</code> constructor</a> here:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">foreach</span> (<span class="pl-k">var</span><span class="pl-smi">entry</span><span class="pl-k">in</span><span class="pl-smi">dictionary</span>)
{
    <span class="pl-smi">_innerDictionary</span>.<span class="pl-en">Add</span>(<span class="pl-smi">entry</span>.<span class="pl-smi">Key</span>, <span class="pl-smi">entry</span>.<span class="pl-smi">Value</span>);
}</pre></div><p>We get a shallow copy of the dictionary. This has 2 issues for us:</p><ol><li>We get a lot of duplicated shallow copies that aren't really needed, they're only there for the <code>T Model</code> when it comes down to it, times 4 here.</li><li>More importantly, the <code>Dictionary&lt;string, object&gt;</code> is resized every time it's actually used, this is because <a href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/f827886fbfff38a8932a29f5018e3223c0e98d10/src/System.Web.Mvc/ViewDataDictionary.cs#L16">it's initialized at a capacity of 0</a>:</li></ol><div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span><span class="pl-k">readonly</span><span class="pl-en">Dictionary</span>&lt;<span class="pl-k">string</span>, <span class="pl-k">object</span>&gt; <span class="pl-smi">_innerDictionary</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Dictionary</span>&lt;<span class="pl-k">string</span>, <span class="pl-k">object</span>&gt;(<span class="pl-smi">StringComparer</span>.<span class="pl-smi">OrdinalIgnoreCase</span>);</pre></div><p>Number 2 means even for a few values (we typically have 2-4) we are eating a dictionary <code>.Resize()</code> 5 or more times, per view. We have hundreds of views or more on many pages so this stings pretty hard.</p><p>The way I see it, the best solution is probably to create the <code>Dictionary&lt;string, object&gt;</code> differently: in the pipeline the constructor would create a properly sized one via the <code>new Dictionary&lt;string, object&gt;(IDictionary&lt;string, object&gt; dictionary)</code> constructor, instead of inflating one from 0 size. The <code>new</code> hiding on the <code>Ajax</code> and <code>Html</code> "overrides" in <code>WebViewPage&lt;T&gt;</code> over <code>WebViewPage</code> create an additional 2 copies...can these not simply reference the <code>ViewDataDictionary&lt;T&gt;</code> from the <code>WebViewPage</code> rather than copying their own? I can't find a case where these should actually differ but I may certainly be missing something.</p><p>Assuming they still need their own shallow copy, the top of <code>ViewDataDictionary</code> could still look like this:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-k">class</span><span class="pl-en">ViewDataDictionary</span> : <span class="pl-en">IDictionary</span>&lt;<span class="pl-k">string</span>, <span class="pl-k">object</span>&gt;
{
    <span class="pl-k">private</span><span class="pl-k">readonly</span><span class="pl-en">Dictionary</span>&lt;<span class="pl-k">string</span>, <span class="pl-k">object</span>&gt; <span class="pl-smi">_innerDictionary</span>;

    <span class="pl-k">public</span><span class="pl-en">ViewDataDictionary</span>() : <span class="pl-k">this</span>((<span class="pl-k">object</span>)<span class="pl-c1">null</span>) { }

    <span class="pl-k">public</span><span class="pl-en">ViewDataDictionary</span>(<span class="pl-k">object</span><span class="pl-smi">model</span>)
    {
        <span class="pl-smi">Model</span><span class="pl-k">=</span><span class="pl-smi">model</span>; 
        <span class="pl-smi">_innerDictionary</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Dictionary</span>&lt;<span class="pl-k">string</span>, <span class="pl-k">object</span>&gt;(<span class="pl-smi">StringComparer</span>.<span class="pl-smi">OrdinalIgnoreCase</span>);
    }

    <span class="pl-k">public</span><span class="pl-en">ViewDataDictionary</span>(<span class="pl-en">ViewDataDictionary</span><span class="pl-smi">dictionary</span>)
    {
        <span class="pl-k">if</span> (<span class="pl-smi">dictionary</span><span class="pl-k">==</span><span class="pl-c1">null</span>)
        {
            <span class="pl-k">throw</span><span class="pl-k">new</span><span class="pl-en">ArgumentNullException</span>(<span class="pl-s"><span class="pl-pds">"</span>dictionary<span class="pl-pds">"</span></span>);
        }

        <span class="pl-k">if</span> (<span class="pl-smi">dictionary</span>.<span class="pl-smi">Count</span><span class="pl-k">&gt;</span><span class="pl-c1">0</span>)
        {
            <span class="pl-smi">_innerDictionary</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">Dictionary</span>&lt;<span class="pl-k">string</span>, <span class="pl-k">object</span>&gt;(<span class="pl-smi">dictionary</span>);
        }
        <span class="pl-k">foreach</span> (<span class="pl-k">var</span><span class="pl-smi">entry</span><span class="pl-k">in</span><span class="pl-smi">dictionary</span>.<span class="pl-smi">ModelState</span>)
        {
            <span class="pl-smi">ModelState</span>.<span class="pl-en">Add</span>(<span class="pl-smi">entry</span>.<span class="pl-smi">Key</span>, <span class="pl-smi">entry</span>.<span class="pl-smi">Value</span>);
        }

        <span class="pl-smi">Model</span><span class="pl-k">=</span><span class="pl-smi">dictionary</span>.<span class="pl-smi">Model</span>;
        <span class="pl-smi">TemplateInfo</span><span class="pl-k">=</span><span class="pl-smi">dictionary</span>.<span class="pl-smi">TemplateInfo</span>;

        <span class="pl-c"><span class="pl-c">//</span> PERF: Don't unnecessarily instantiate the model metadata</span><span class="pl-smi">_modelMetadata</span><span class="pl-k">=</span><span class="pl-smi">dictionary</span>.<span class="pl-smi">_modelMetadata</span>;
    }</pre></div><p>This takes care of the <code>Resize()</code> pain aspect in a fairly concise way, but not the 5x work and allocation issue. I'd propose that <code>HtmlHelper</code> and <code>AjaxHelper</code> simply set the reference if the <code>TModel</code> matches already, something like this:</p><div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span><span class="pl-en">HtmlHelper</span>(<span class="pl-en">ViewContext</span><span class="pl-smi">viewContext</span>, <span class="pl-en">IViewDataContainer</span><span class="pl-smi">viewDataContainer</span>, <span class="pl-en">RouteCollection</span><span class="pl-smi">routeCollection</span>)
    : <span class="pl-k">base</span>(<span class="pl-smi">viewContext</span>, <span class="pl-smi">viewDataContainer</span>, <span class="pl-smi">routeCollection</span>)
{
    <span class="pl-k">var</span><span class="pl-smi">sameParentViewData</span><span class="pl-k">=</span><span class="pl-smi">viewDataContainer</span>.<span class="pl-smi">ViewData</span><span class="pl-k">as</span><span class="pl-en">ViewDataDictionary</span>&lt;<span class="pl-en">TModel</span>&gt;;
    <span class="pl-k">if</span> (<span class="pl-smi">sameParentViewData</span><span class="pl-k">!=</span><span class="pl-c1">null</span>)
    {
        <span class="pl-smi">_viewData</span><span class="pl-k">=</span><span class="pl-smi">sameParentViewData</span>;
    }
    <span class="pl-k">else</span>
    {
        <span class="pl-smi">_viewData</span><span class="pl-k">=</span><span class="pl-k">new</span><span class="pl-en">ViewDataDictionary</span>&lt;<span class="pl-en">TModel</span>&gt;(<span class="pl-smi">viewDataContainer</span>.<span class="pl-smi">ViewData</span>);
    }
}</pre></div><p>Doing this in both <code>AjaxHelper</code> and <code>HtmlHelper</code> would again be fairly concise changes with hopefully no negative impact but still have a <em>huge</em> impact on allocations at our case.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>