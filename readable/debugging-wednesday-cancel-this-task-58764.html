<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Debugging Wednesday&#x200A;&#x2014;&#x200A;Cancel this task! - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Debugging Wednesday&#x200A;&#x2014;&#x200A;Cancel this task! - linksfor.dev(s)"/>
    <meta property="article:author" content="https://medium.com/@chnasarre"/>
    <meta property="og:description" content="Last Wednesday &#x201C;Debugging&#x201D; day for Kevin and myself. Let&#x2019;s share with you these frustrating but interesting minutes."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://medium.com/@chnasarre/debugging-wednesday-cancel-this-task-53ca5bea5bc8"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Debugging Wednesday&#x200A;&#x2014;&#x200A;Cancel this task!</title>
<div class="readable">
        <h1>Debugging Wednesday&#x200A;&#x2014;&#x200A;Cancel this task!</h1>
            <div>by https://medium.com/@chnasarre</div>
            <div>Reading time: 9-12 minutes</div>
        <div>Posted here: 21 Feb 2020</div>
        <p><a href="https://medium.com/@chnasarre/debugging-wednesday-cancel-this-task-53ca5bea5bc8">https://medium.com/@chnasarre/debugging-wednesday-cancel-this-task-53ca5bea5bc8</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div><section><div><div><div><div><div><div><p><a rel="noopener" href="https://medium.com/@chnasarre?source=post_page-----53ca5bea5bc8----------------------"><img alt="Christophe Nasarre" src="https://miro.medium.com/fit/c/96/96/0*p_afBNMUbL9S3Ojv" width="48" height="48"></a></p></div></div></div></div><p id="07d0" data-selectable-paragraph="">Last Wednesday was a great day for <a href="https://twitter.com/KooKiz" target="_blank" rel="noopener nofollow">Kevin</a> and myself: we spent a lot of time investigating the reasons why a test was failing. Let’s share with you these frustrating but interesting minutes.</p><p id="c26c" data-selectable-paragraph="">One of our colleagues came to us because an integration test would get stuck in some specific conditions. Here is the simplified code of the service that is supposed to do some background processing until it is stopped:</p><figure><div></div></figure><p id="7a4c" data-selectable-paragraph="">In the test, the service is created : two <code>Task</code> instances are created in the constructor (for background processing irrelevant for this discussion) that (1) are started when the service starts and (2) are cancelled when the service is stopped. A <code>CancellationTokenSource</code> is used to cancel the tasks if needed.</p><figure><div></div></figure><p id="4619" data-selectable-paragraph="">However, in the specific conditions of this test, the <code>Start</code> method would never be called, skipping straight to the <code>Stop</code> method.</p><figure><div></div></figure><p id="a720" data-selectable-paragraph="">The task is never started because the test skips the <code>Service.Start()</code> method, but it should transition to “Cancelled” state as soon as the <code>CancellationTokenSource</code> associated to the <code>CancellationToken</code> passed to the <code>Task</code> gets cancelled. In that particular situation, we expect the <code>await _backgroundProcessing</code> code to immediately return in the <code>Stop()</code> method.</p><p id="5f9c" data-selectable-paragraph="">In our colleague Visual Studio, the debugger never came back from <code>await _backgroundProcessing</code>, indicating that the task never completed…</p><p id="80b6" data-selectable-paragraph="">I wanted to un-validate any side effect related to our test framework or custom Criteo libraries, and confirm my understanding of task cancellation, so I wrote a small Console application with the same 4.7.2 version of .NET Framework with the following code:</p><figure><div></div></figure><p id="be26" data-selectable-paragraph="">And guess what?<br> I got the expected <code>TaskCancellationException</code>:</p><blockquote><p id="fc54" data-selectable-paragraph="">System.Threading.Tasks.TaskCanceledException: A task was canceled.<br>at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)<br>at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)<br>at System.Runtime.CompilerServices.TaskAwaiter.GetResult()<br>at TaskCancellation.Program.&lt;ReproduceWorking&gt;d__2.MoveNext()</p></blockquote><p id="9b87" data-selectable-paragraph="">The next step was to double-check the understanding of how tasks are working related to cancellation. So I set a breakpoint after the task is instantiated</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*lNlSNvggMbjwA7mAC33LPA.png?q=20" width="1144" height="167" role="presentation"></p><p><img width="1144" height="167" role="presentation" src="https://miro.medium.com/max/1144/1*lNlSNvggMbjwA7mAC33LPA.png"></p></div></div></div></div></figure><p id="e7cd" data-selectable-paragraph="">And its status is <strong>Created</strong>.</p><p id="a44c" data-selectable-paragraph="">Doing the same after <code>Cancel()</code> is called on the <code>CancellationTokenSource</code>, gives the expected <strong>Canceled</strong> status.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*uDQ7b1Eq2QYYmVdT1jSn1Q.png?q=20" width="1148" height="232" role="presentation"></p><p><img width="1148" height="232" role="presentation"></p></div></div></div></div></figure><p id="83f9" data-selectable-paragraph="">So, let’s do the same when debugging the test code:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*v90VjEEUTCNHm3Xre_zeHQ.png?q=20" width="1288" height="148" role="presentation"></p><p><img width="1288" height="148" role="presentation"></p></div></div></div></div></figure><p id="2041" data-selectable-paragraph="">It gives the same <strong>Created</strong> status after the task creation but after canceling the source:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*iOYZBxNZOLvrxarbcbj6Uw.png?q=20" width="1088" height="141" role="presentation"></p><p><img width="1088" height="141" role="presentation"></p></div></div></div></div></figure><p id="9f01" data-selectable-paragraph="">…the status does not switch to <strong>Canceled</strong> like in my Console repro!</p><p id="acc1" data-selectable-paragraph="">The only thing that came to my mind was: maybe the cancellation token is not taken into account. However, a <code>CancellationToken</code> is just a struct that keeps a reference to its <code>CancellationTokenSource</code>. It should be easy in Visual Studio debugger to double check that our task keeps track of the token somewhere and goes back to the cancellation source. Well… the token is not kept as a field of the task but stored inside the <code>m_contingentProperties</code> field <a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs,674" target="_blank" rel="noopener nofollow">deep during the task construction code path</a>.</p><p id="12f4" data-selectable-paragraph="">Let’s look at the value in the <strong>Quick Watch</strong> after the cancellation source gets canceled:</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*rJgSvnb9o7_Zut1D0f4fjg.png?q=20" width="694" height="290" role="presentation"></p><p><img width="694" height="290" role="presentation"></p></div></div></div></figure><p id="1248" data-selectable-paragraph="">It sounds like the cancellation token is not canceled… But if we look at the source <code>Token</code> property of our canceled <code>CancellationTokenSource</code>,</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*AduGgofUrRBXhEHlqYYueA.png?q=20" width="675" height="544" role="presentation"></p><p><img width="675" height="544" role="presentation"></p></div></div></div></figure><p id="5388" data-selectable-paragraph="">we don’t have the same value for <code>IsCancellationRequested</code>!</p><p id="198c" data-selectable-paragraph="">It’s like we don’t look at the same cancellation source… To find out, we just have to compare the reference to our <code>CancellationTokenSource</code> with the one we see in the <code>m_contingentProperties</code> token of the task. To achieve that, we could copy the expression from QuickWatch, paste it into the <strong>Debug | Windows | Memory…</strong> pane and press ENTER to get the address where the object is stored in memory</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*UVx4QML3o6xp4Ecsu6cnbw.png?q=20" width="637" height="318" role="presentation"></p><p><img width="637" height="318" role="presentation"></p></div></div></div></figure><p id="21c0" data-selectable-paragraph="">After having done the same with <code>_cancellationSource</code>, I did not get the same address:</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*cPXCRetw7iGMYQ6g1tMpcA.png?q=20" width="191" height="95" role="presentation"></p><p><img width="191" height="95" role="presentation"></p></div></div></div></figure><p id="3a4a" data-selectable-paragraph="">It means that we were dealing with two different instances of <code>CancellationTokenSource</code>.</p><p id="7ac7" data-selectable-paragraph="">But this might be too C++ish for you… Kevin prefers leveraging the <em>Make Object ID</em> feature of the C# debugger. You simply right-click the Data Tip of the cancellation source and select <strong>Make Object ID</strong>:</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*RCJafBYT7icR6YFQ6tkxdA.png?q=20" width="396" height="327" role="presentation"></p><p><img width="396" height="327" role="presentation"></p></div></div></div></figure><p id="bf2c" data-selectable-paragraph="">Once this is done, a numeric identifier is displayed for this instance in Data Tip and any Watch window (#1 in this screenshot):</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*CTf7RGYgX2otS5K6rH9azQ.png?q=20" width="689" height="173" role="presentation"></p><p><img width="689" height="173" role="presentation"></p></div></div></div></div></figure><p id="21d5" data-selectable-paragraph="">When we looked at the cancellation source of the token stored by the task,</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*aHnPvqWuL5sM0cj9ztyA4A.png?q=20" width="576" height="318" role="presentation"></p><p><img width="576" height="318" role="presentation"></p></div></div></div></figure><p id="5bfa" data-selectable-paragraph="">we didn’t see any ID so it was not the same object.</p><p id="6d78" data-selectable-paragraph="">So we decided to use Make Object ID on this <code>m_source</code> that became marked as #2.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*KZ48iXU0TobSm-A3YFUTIQ.png?q=20" width="739" height="624" role="presentation"></p><p><img width="739" height="624" role="presentation"></p></div></div></div></div></figure><p id="82ee" data-selectable-paragraph="">And when we looked at the <code>m_source</code> of the second cleanup <code>Task</code>, we realized that it was the same object but not the one we created!</p><p id="098f" data-selectable-paragraph="">We started to think that we were becoming crazy. So, let’s restart from the beginning and follow the <code>CancellationTokenSource</code> from its creation because we are sure that we passed a valid cancellation token (linked to this source) to the task constructor. Or… Did we? The QuickWatch gives a different answer just after the task gets created compared to what we’ve seen already: a token with an empty source property now!</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*z9hOeNeJ7_o6_qX08bwWaw.png?q=20" width="694" height="294" role="presentation"></p><p><img width="694" height="294" role="presentation"></p></div></div></div></figure><p id="6c56" data-selectable-paragraph="">I closed the QuickWatch pane and reopened it for Kevin to confirm. And like in a nightmare, the source was not null anymore…</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*l_2KlUeedUlG42RAej2jjA.png?q=20" width="570" height="234" role="presentation"></p><p><img width="570" height="234" role="presentation"></p></div></div></div></figure><p id="8d69" data-selectable-paragraph="">Visual Studio must be responsible for that weird behavior!</p><p id="e388" data-selectable-paragraph="">Kevin remembered the <em>”Enable property evaluation”</em> settings in the Options dialog. If it is checked (which is the default), it means that the Debugger would fetch the value of an instance fields and then call the Getter of each property in order to display its value.</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*XqOydO0OsS0noacmEDpEdg.png?q=20" width="779" height="169" role="presentation"></p><p><img width="779" height="169" role="presentation"></p></div></div></div></div></figure><p id="134b" data-selectable-paragraph="">However, if you uncheck it, only the fields are displayed. So in our case, we then always got a null <code>m_contingentProperties</code> field (and, as expected, all property would not be displayed):</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*33vZaFRFh1ii2X2APgaeXw.png?q=20" width="712" height="334" role="presentation"></p><p><img width="712" height="334" role="presentation"></p></div></div></div></div></figure><p id="4901" data-selectable-paragraph="">The <code>m_contingentProperties</code> is initialized in <code><a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs,1501" target="_blank" rel="noopener nofollow">EnsureContingentPropertiesInitialized()</a></code> when called by <code><a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs,670" target="_blank" rel="noopener nofollow">AssignCancellationToken()</a></code> from the <code>TaskContructorCore()</code> helper used by the <code>Task</code> constructor but it did not seem to be the case because it was definitively <strong>null</strong>…</p><p id="7d80" data-selectable-paragraph="">Kevin decided to stop at the <code>CancellationTokenSource</code> constructor with a new breakpoint (more on how to set a breakpoint on a .NET Framework method soon) to see where the one shown in the Debugger was created but the breakpoint was never hit. So the <code>CancellationTokenSource</code> #2 must have been created even before our own was created by our code. In fact, a static <code>CancellationTokenSource</code> is created and is set to <code>m_source</code> when <code>InitializeDefaultSource()</code> gets called by one of the Getter. This explains why we saw the same instance #2 in both tasks token.</p><p id="f2e0" data-selectable-paragraph="">To sum up, we were now sure that the passed token was not “received” by the <code>Task</code>.</p><p id="7f58" data-selectable-paragraph="">Maybe there is a magic trick done by the .NET Framework to lazily set the token source after the creation of the task. However, we did not find such a code in <a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs" target="_blank" rel="noopener nofollow">the .NET Framework</a> and this is not what we see in our repro.</p><p id="baa1" data-selectable-paragraph="">Back to the basics: are we sure that we are executing the code we think is executed? We looked for mscorlib in the <strong>Debug | Windows | Modules</strong> pane,</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*dL92Y22KRoMBJVlGaGefgQ.png?q=20" width="860" height="110" role="presentation"></p><p><img width="860" height="110" role="presentation"></p></div></div></div></div></figure><p id="d491" data-selectable-paragraph="">and we opened it with a decompiler: the code of the methods called during the <code>Task</code><strong> </strong>construction was the same as the one shown in <a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs" target="_blank" rel="noopener nofollow">https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs</a>.</p><p id="3384" data-selectable-paragraph="">Next, in order to better follow the execution and the passing of parameters (including our token), we decided to set breakpoints on <code>Task</code> <a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs,590" target="_blank" rel="noopener nofollow">private method responsible</a> for its initialization.</p><pre><span id="037d" data-selectable-paragraph="">internal void TaskConstructorCore(object action, object state, CancellationToken cancellationToken, TaskCreationOptions creationOptions, InternalTaskOptions internalOptions, TaskScheduler scheduler)</span></pre><p id="13c1" data-selectable-paragraph="">In the <strong>Debug | Windows | Breakpoints</strong> pane, click <strong>New</strong> | <strong>Function Breakpoint…</strong></p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*eODuofmyha3AvYYQ5hL52g.png?q=20" width="303" height="89" role="presentation"></p><p><img width="303" height="89" role="presentation"></p></div></div></div></figure><p id="55e8" data-selectable-paragraph="">and type the full name of the method. This is working even for a method of a class defined in the .NET Framework assembly for which you do not have the source code:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*WhyV6fYlMtw7qbTGQoOSWQ.png?q=20" width="984" height="244" role="presentation"></p><p><img width="984" height="244" role="presentation"></p></div></div></div></div></figure><p id="da69" data-selectable-paragraph="">We checked that the breakpoints was well set (i.e. no typo in the full name) by looking at the filled red circle:</p><figure><div><div><div><p><img src="https://miro.medium.com/max/60/1*csd6pFIfQdTH853g1A8Uew.png?q=20" width="597" height="183" role="presentation"></p><p><img width="597" height="183" role="presentation"></p></div></div></div></figure><p id="c05f" data-selectable-paragraph="">The <code>cancellationToken</code> parameter should contain the token that we passed at <code>Task</code> creation. Unfortunately, the QuickWatch pane displayed a “cannot read memory” error that we never saw in Visual Studio before!</p><p id="55ba" data-selectable-paragraph="">At that time, we thought we were doomed but we looked at the <strong>Call Stack</strong> pane and we realized that the code was calling <a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs,505" target="_blank" rel="noopener nofollow">the wrong <strong>Task</strong> constructor</a>:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*MC5ZN4NUzKnGIiQTufUPbw.png?q=20" width="2047" height="239" role="presentation"></p><p><img width="2047" height="239" role="presentation"></p></div></div></div></div></figure><pre><span id="d2c3" data-selectable-paragraph="">public Task(Action&lt;object&gt; action, object state, TaskCreationOptions creationOptions)</span></pre><p id="53e6" data-selectable-paragraph="">Its signature is compatible with our code:</p><pre><span id="4123" data-selectable-paragraph="">_backgroundProcessing = new Task(DoStuffInTheBackground, cancellationToken, TaskCreationOptions.LongRunning);</span></pre><p id="0f0d" data-selectable-paragraph="">and this is why the compiler did not complain.</p><p id="edc9" data-selectable-paragraph="">Our <code>CancellationToken</code> was passed as the <code>state</code> parameter given directly to our <code>DoStuffInTheBackground Action&lt;object&gt;</code>: the created <code>Task</code> had no idea that it was supposed to be its <code>CancellationToken</code>.</p><p id="585d" data-selectable-paragraph="">Note that if we had noticed the <strong>Auto Completion</strong> (Ctrl + Shift + Space) hint, we might have figured out the root cause much sooner…</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*CWW78rrNIhnbsLqCi0zniw.png?q=20" width="1119" height="194" role="presentation"></p><p><img width="1119" height="194" role="presentation"></p></div></div></div></div></figure><p id="139d" data-selectable-paragraph="">The fix was straightforward; just using <a href="https://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/Task.cs,533" target="_blank" rel="noopener nofollow">the right constructor</a>:</p><pre><span id="1da3" data-selectable-paragraph="">public Task(Action&lt;object&gt; action, object state, CancellationToken cancellationToken, TaskCreationOptions creationOptions)</span></pre><p id="9981" data-selectable-paragraph="">that accepts both a state for the callback and a <code>CancellationToken</code> for the <code>Task</code> to create:</p><pre><span id="e33b" data-selectable-paragraph="">_backgroundProcessing = new Task(DoStuffInTheBackground, cancellationToken, cancellationToken, TaskCreationOptions.LongRunning);</span></pre><p id="7a36" data-selectable-paragraph="">` _backgroundProcessing = new Task(DoStuffInTheBackground, cancellationToken, cancellationToken, TaskCreationOptions.LongRunning);</p><p id="2565" data-selectable-paragraph="">Under the debugger, we validated that the source was now the expected one:</p><figure><div><div><div><div><p><img src="https://miro.medium.com/max/60/1*43MDI_vnkwcGjiLRoxj0qQ.png?q=20" width="712" height="291" role="presentation"></p><p><img width="712" height="291" role="presentation"></p></div></div></div></div></figure><p id="1911" data-selectable-paragraph="">and the test did not hang any more.</p><p id="31aa" data-selectable-paragraph="">If, from the beginning we would have been able to step into .NET Framework compiled code like we do with Jetbrains Resharper integration in Visual Studio, we would have found the issue almost immediately. Thankfully, Microsoft has just announced <a href="https://devblogs.microsoft.com/visualstudio/decompilation-of-c-code-made-easy-with-visual-studio/" target="_blank" rel="noopener nofollow">decompilation of C# code made easy with Visual Studio</a>.</p><p id="1b57" data-selectable-paragraph="">We wish we had it last Wednesday…</p></div></div></section></div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>