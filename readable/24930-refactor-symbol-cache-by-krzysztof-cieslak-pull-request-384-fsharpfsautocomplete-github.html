<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Refactor Symbol Cache by Krzysztof-Cieslak &#xB7; Pull Request #384 &#xB7; fsharp/FsAutoComplete &#xB7; GitHub -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Refactor Symbol Cache by Krzysztof-Cieslak · Pull Request #384 · fsharp/FsAutoComplete · GitHub</h1><div><div id="" class="d-block comment-body markdown-body  js-comment-body"><p>It turns out that sending thousands of symbols serialized to JSON through HTTP is not the best idea I've ever had!</p><p>I've started working on some performance analyses, and while I don't have yet lot of experience with it there was one big elephant in the room that was noticeable even for me:</p><p>The absurd amount of <code>Int32</code> allocations caused by Newtonsoft.Json.</p><p><em>GC Heap Alloc Ignore Free:</em><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58323570-a691b480-7e24-11e9-90c8-021961edf92b.png"><img src="https://user-images.githubusercontent.com/5427083/58323570-a691b480-7e24-11e9-90c8-021961edf92b.png" alt="image"></a><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58323615-ca54fa80-7e24-11e9-8509-e94fcdd3685c.png"><img src="https://user-images.githubusercontent.com/5427083/58323615-ca54fa80-7e24-11e9-8509-e94fcdd3685c.png" alt="image"></a></p><p>Turns out this all was caused by single function - <code>SymbolCache.sendSymbols</code> that caused 56% of allocations, and was causing 12% of CPU usage:</p><p><em>GC Heap Alloc Ignore Free:</em><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58324632-b068e700-7e27-11e9-9acb-c266f6a646c3.png"><img src="https://user-images.githubusercontent.com/5427083/58324632-b068e700-7e27-11e9-9acb-c266f6a646c3.png" alt="image"></a></p><p><em>CPU Stack</em>:<br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58324729-fcb42700-7e27-11e9-9a79-cc0ea8583668.png"><img src="https://user-images.githubusercontent.com/5427083/58324729-fcb42700-7e27-11e9-9a79-cc0ea8583668.png" alt="image"></a></p><p>It was also causing ~40% of Large Object allocations:<br><em>GC Heap Alloc Ignore Free:</em><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58324861-659b9f00-7e28-11e9-98db-3dde0a5757a4.png"><img src="https://user-images.githubusercontent.com/5427083/58324861-659b9f00-7e28-11e9-98db-3dde0a5757a4.png" alt="image"></a></p><hr><p>After the refactoring main FSAC process inserts symbols to SQLite directly, and only sends notification to the SymbolCache process that the DB was updated and it should be loaded to memory.</p><p>After the refactoring <code>SymbolCache.sendSymbols</code> causes 5% of CPU usage and 14% of allocations:<br><em>GC Heap Alloc Ignore Free:</em><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58325341-af38b980-7e29-11e9-9f0d-6b24ce0eb912.png"><img src="https://user-images.githubusercontent.com/5427083/58325341-af38b980-7e29-11e9-9f0d-6b24ce0eb912.png" alt="image"></a></p><p><em>CPU Stack</em>:<br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58325172-42bdba80-7e29-11e9-85d7-5e77ceb6d900.png"><img src="https://user-images.githubusercontent.com/5427083/58325172-42bdba80-7e29-11e9-85d7-5e77ceb6d900.png" alt="image"></a></p><p>I've also observed decrease on Large Object allocations from around 3% to 1% and GCStats are not showing any LOH allocation pauses.</p><p><em>Pre refactoring</em>:<br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58325634-a7c5e000-7e2a-11e9-829e-d533d6a8bebc.png"><img src="https://user-images.githubusercontent.com/5427083/58325634-a7c5e000-7e2a-11e9-829e-d533d6a8bebc.png" alt="image"></a></p><p><em>Post refactoring:</em><br><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/5427083/58325599-8664f400-7e2a-11e9-92c3-cb7826a7c5c9.png"><img src="https://user-images.githubusercontent.com/5427083/58325599-8664f400-7e2a-11e9-92c3-cb7826a7c5c9.png" alt="image"></a></p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>