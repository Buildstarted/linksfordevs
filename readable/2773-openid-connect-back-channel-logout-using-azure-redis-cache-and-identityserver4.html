<!DOCTYPE html>
<html lang="en">
<head>
    <title>
OpenID Connect back-channel logout using Azure Redis Cache and IdentityServer4 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>OpenID Connect back-channel logout using Azure Redis Cache and IdentityServer4</h1><div><div class="entry-content"><p>This article shows how to implement an <a href="https://openid.net/specs/openid-connect-backchannel-1_0.html">OpenID Connect back-channel logout</a>, which uses <a href="https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/">Azure Redis cache</a> so that the session logout will work with multi instance deployments.</p><p><strong>Code:</strong><a href="https://github.com/damienbod/AspNetCoreBackChannelLogout" rel="nofollow">https://github.com/damienbod/AspNetCoreBackChannelLogout</a></p><p>Posts in this series:</p><p><strong>Setting up the Azure Redis Cache</strong></p><p>Before using the Azure Redis Cache in the application, this needs to be setup in Azure. Joonas Westlin has a nice <a href="https://joonasw.net/view/redis-cache-session-store">blog </a>about this. The <a href="https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/cache-faq#what-azure-cache-for-redis-offering-and-size-should-i-use">Redis Azure FAQ link</a> is also very good, which should help you decide the configuration which is correct for you. </p><p>Click “Create a Resource” and enter Redis Cache in the search input.</p><p><img data-attachment-id="11610" data-permalink="https://damienbod.com/2018/12/18/openid-connect-back-channel-logout-using-azure-redis-cache-and-identityserver4/bc_redis_azure_01/" data-orig-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png" data-orig-size="894,360" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="BC_Redis_Azure_01" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png?w=640" src="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png?w=640&amp;h=258" alt="" width="640" height="258" class="alignnone size-full wp-image-11610" srcset="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png?w=640&amp;h=258 640w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png?w=150&amp;h=60 150w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png?w=600&amp;h=242 600w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png?w=768&amp;h=309 768w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_01.png 894w" sizes="(max-width: 640px) 100vw, 640px"></p><p>Then create the Redis Cache as required:</p><p><img data-attachment-id="11615" data-permalink="https://damienbod.com/2018/12/18/openid-connect-back-channel-logout-using-azure-redis-cache-and-identityserver4/bc_redis_azure_02/" data-orig-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png" data-orig-size="779,995" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="BC_Redis_Azure_02" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png?w=470" data-large-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png?w=640" src="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png?w=640&amp;h=817" alt="" width="640" height="817" class="alignnone size-full wp-image-11615" srcset="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png?w=640&amp;h=817 640w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png?w=117&amp;h=150 117w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png?w=470&amp;h=600 470w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png?w=768&amp;h=981 768w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_02.png 779w" sizes="(max-width: 640px) 100vw, 640px"></p><p>Creating the cache takes some time. Once finished, the connection string can be copied from the Access keys</p><p><img data-attachment-id="11618" data-permalink="https://damienbod.com/2018/12/18/openid-connect-back-channel-logout-using-azure-redis-cache-and-identityserver4/bc_redis_azure_03/" data-orig-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png" data-orig-size="1279,961" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="BC_Redis_Azure_03" data-image-description="" data-medium-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=600" data-large-file="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=640" src="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=640&amp;h=481" alt="" width="640" height="481" class="alignnone size-full wp-image-11618" srcset="https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=640&amp;h=481 640w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=150&amp;h=113 150w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=600&amp;h=451 600w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=768&amp;h=577 768w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png?w=1024&amp;h=769 1024w, https://damienbod.files.wordpress.com/2018/12/BC_Redis_Azure_03.png 1279w" sizes="(max-width: 640px) 100vw, 640px"></p><p>Now that the Azure Redis is setup, you can add the cache to the ASP.NET Core application. In this example, the Microsoft.Extensions.Caching.Redis NuGet package is used to access and use the Azure Redis Cache. Add this to your project.</p><p>In the Startup class, add the distributed Redis cache using the AddDistributedRedisCache extension method from the NuGet package.</p><pre class="brush: csharp; title: ; notranslate" title="">services.AddDistributedRedisCache(options =&gt;
{
	options.Configuration = 
	  Configuration.GetConnectionString("RedisCacheConnection");
	options.InstanceName = "MvcHybridBackChannelInstance";
});
</pre><p>Add the Redis connection string to the app.settings. This example using the RedisCacheConnection. The values for this can be copied from the access keys tab in the Redis/Access keys menu which was created above. </p><p>The connection string should be added as a secret to the application, and not committed in the code.</p><pre class="brush: csharp; title: ; notranslate" title="">"ConnectionStrings": {
    "RedisCacheConnection": "redis-connection-string"
},
</pre><p><strong>Using the Cache for the Back-Channel logout</strong></p><p>The LogoutSessionManager class uses the Azure Redis cache to add or get the different logouts. The OpenID Connect back-channel specification defines how this logout works. The Secure Token Server, implemented using IdentityServer4, requests a logout URL which is handled in the client application.</p><p>The LogoutController class is used for this. If all the validation and the checks are ok, the class uses a singleton instance of LogoutSessionManager to manage the logouts for the client. The code used in this example, was created using the IdentityServer4.Samples.</p><p>The IDistributedCache is added in the constructor and saved as a read only field in the class.</p><pre class="brush: csharp; title: ; notranslate" title="">private static readonly Object _lock = new Object();
private readonly ILogger&lt;LogoutSessionManager&gt; _logger;
private IDistributedCache _cache;

// Amount of time to check for old sessions. If this is to long, 
// the cache will increase, or if you have many user sessions, 
// this will increase to much.
private const int cacheExpirationInDays = 8;

public LogoutSessionManager(ILoggerFactory loggerFactory, IDistributedCache cache)
{
	_cache = cache;
	_logger = loggerFactory.CreateLogger&lt;LogoutSessionManager&gt;();
}
</pre><p>When a logout is initialized by a user, from an application, this request is sent to the OpenID Connect server. The server does the logout logic, and sends requests back to all applications that have the back-channel configured.</p><p>The <a href="https://github.com/damienbod/AspNetCoreBackChannelLogout/blob/master/MvcHybridBackChannel/Controllers/LogoutController.cs">LogoutController </a>handles this request from the Secure Token Server, and adds a key pair to the Redis cache using the sid and the sub.</p><p>The Redis cache is shared between all instances of the client application and needs to be thread safe. Then all client instances can check if the user, application needs to be logged out.</p><pre class="brush: csharp; title: ; notranslate" title="">public void Add(string sub, string sid)
{
	_logger.LogWarning($"Add a logout to the session: sub: {sub}, sid: {sid}");
	var options = new DistributedCacheEntryOptions()
          .SetSlidingExpiration(TimeSpan.FromDays(cacheExpirationInDays));

	lock (_lock)
	{
		var key = sub + sid;
		var logoutSession = _cache.GetString(key);
		if (logoutSession != null)
		{
			var session = JsonConvert.DeserializeObject&lt;Session&gt;(logoutSession);
		}
		else
		{
			var newSession = new Session { Sub = sub, Sid = sid };
			_cache.SetString(key, JsonConvert.SerializeObject(newSession), options);
		}
	}
}
</pre><p>The IsLoggedOutAsync method is used to check if a logout request exists for the application, user. This method uses the sid and sub values, to request the Redis value, if it exists.</p><pre class="brush: csharp; title: ; notranslate" title="">public async Task&lt;bool&gt; IsLoggedOutAsync(string sub, string sid)
{
	var key = sub + sid;
	var matches = false;
	var logoutSession = await _cache.GetStringAsync(key);
	if (logoutSession != null)
	{
		var session = JsonConvert.DeserializeObject&lt;Session&gt;(logoutSession);
		matches = session.IsMatch(sub, sid);
		_logger.LogInformation($"Logout session exists T/F {matches} : {sub}, sid: {sid}");
	}

	return matches;
}
</pre><p>The method is used in the CookieEventHandler class in the ValidatePrincipal method to end the session if a logout request was found.</p><pre class="brush: csharp; title: ; notranslate" title="">public override async Task ValidatePrincipal(CookieValidatePrincipalContext context)
{
	if (context.Principal.Identity.IsAuthenticated)
	{
		var sub = context.Principal.FindFirst("sub")?.Value;
		var sid = context.Principal.FindFirst("sid")?.Value;

		if (await LogoutSessions.IsLoggedOutAsync(sub, sid))
		{
			context.RejectPrincipal();
			await context.HttpContext.SignOutAsync(
                          CookieAuthenticationDefaults.AuthenticationScheme);
		}
	}
}
</pre><p>The CookieEventHandler was added in the Startup to the cookie configuration.</p><pre class="brush: csharp; title: ; notranslate" title="">.AddCookie(options =&gt;
{
	options.ExpireTimeSpan = TimeSpan.FromMinutes(60);
	options.Cookie.Name = "mvchybridbc";

	options.EventsType = typeof(CookieEventHandler);
})
</pre><p>Now Azure Redis cache is used to handle the back-channel logouts from the Secure Token Server. </p><p><strong>Configure IdentityServer4 for custom end session Logic</strong></p><p>If you want more control over how and what back-channel clients receive a request,  you can implement the IEndSessionRequestValidator interface when using IdentityServer4. The GetClientEndSessionUrlsAsync method could be edited to change the required clients which will be called after a logout event.</p><pre class="brush: csharp; title: ; notranslate" title="">protected virtual async Task&lt;(IEnumerable&lt;string&gt; frontChannel, 
     IEnumerable&lt;BackChannelLogoutModel&gt; backChannel)&gt; 
  GetClientEndSessionUrlsAsync(EndSession endSession)
{
	var frontChannelUrls = new List&lt;string&gt;();
	var backChannelLogouts = new List&lt;BackChannelLogoutModel&gt;();

	List&lt;string&gt; backchannelLogouts = new List&lt;string&gt;
	{
		"mvc.hybrid.backchannel",
		"mvc.hybrid.backchanneltwo"
	};

	foreach (var clientId in backchannelLogouts)
	{
</pre><p>If the IEndSessionRequestValidator is implemented, this needs to be added to the ASP.NET Core IoC.</p><pre class="brush: csharp; title: ; notranslate" title="">services.AddTransient&lt;IEndSessionRequestValidator, 
   MyEndSessionRequestValidator&gt;();
</pre><p><strong>Notes, Problems</strong></p><p>One problem with this, is that all logouts are saved to the cache for n-days. If the logouts are removed to early, the logout will not work for a client application which is opened after this, or if the logout items are kept to long, the size of the Redis cache will be very large in size, and cost.</p><p><strong>Links:</strong></p><p><a href="https://joonasw.net/view/redis-cache-session-store" rel="nofollow">https://joonasw.net/view/redis-cache-session-store</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/performance/caching/distributed?view=aspnetcore-2.2#distributed-redis-cache" rel="nofollow">https://docs.microsoft.com/en-us/aspnet/core/performance/caching/distributed?view=aspnetcore-2.2#distributed-redis-cache</a></p><p><a href="https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/" rel="nofollow">https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/</a></p><p><a href="https://blogs.msdn.microsoft.com/luisdem/2016/09/06/azure-redis-cache-on-asp-net-core/" rel="nofollow">https://blogs.msdn.microsoft.com/luisdem/2016/09/06/azure-redis-cache-on-asp-net-core/</a></p><p><a href="https://openid.net/specs/openid-connect-backchannel-1_0.html" rel="nofollow">https://openid.net/specs/openid-connect-backchannel-1_0.html</a></p><p><a href="http://docs.identityserver.io/en/release/topics/signout.html" rel="nofollow">http://docs.identityserver.io/en/release/topics/signout.html</a></p><p><a class="m-story" href="https://medium.com/@robert.broeckelmann/openid-connect-logout-eccc73df758f" target="_blank" data-width="640" data-border="1" data-collapsed="">View at Medium.com</a></p><p><a class="m-story" href="https://medium.com/@piraveenaparalogarajah/openid-connect-back-channel-logout-1-0-fe1f90c83fe5" target="_blank" data-width="640" data-border="1" data-collapsed="">View at Medium.com</a></p><p><a href="https://ldapwiki.com/wiki/OpenID%20Connect%20Back-Channel%20Logout" rel="nofollow">https://ldapwiki.com/wiki/OpenID%20Connect%20Back-Channel%20Logout</a></p><p><a href="https://datatracker.ietf.org/meeting/97/materials/slides-97-secevent-oidc-logout-01" rel="nofollow">https://datatracker.ietf.org/meeting/97/materials/slides-97-secevent-oidc-logout-01</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/app-state?view=aspnetcore-2.2" rel="nofollow">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/app-state?view=aspnetcore-2.2</a></p><p><a href="https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/cache-dotnet-core-quickstart" rel="nofollow">https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/cache-dotnet-core-quickstart</a></p><div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><h3 class="jp-relatedposts-headline"><em>Related</em></h3></div><div class="byline"><span class="tags-label">Tags:</span><a href="https://damienbod.com/tag/azure/" rel="tag">Azure</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/backchannel/" rel="tag">backchannel</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/cache/" rel="tag">cache</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/deployment/" rel="tag">Deployment</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/identityserver4/" rel="tag">IdentityServer4</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/multi-instance/" rel="tag">multi instance</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/oauth2/" rel="tag">OAuth2</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/oidc/" rel="tag">OIDC</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/openid-connect/" rel="tag">OpenId connect</a><p class="readability-styled" style="display: inline;">, </p><a href="https://damienbod.com/tag/redis/" rel="tag">redis</a></div></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>