<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Prerendering a Client-side Blazor Application -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Prerendering a Client-side Blazor Application</h1><div><div class="post-content"><p>While prerendering is now the default for server-side Blazor applications, I only recently discovered (as in the last 48 hours via <a href="https://github.com/danroth27/ClientSideBlazorWithPrerendering">Daniel Roth's work</a>) that client-side Blazor applications can take advantage of this as well. In this post, I'm going to show you how you can setup your client-side Blazor application for prerendering.</p><blockquote>The example project for this post can be found on <a href="https://github.com/chrissainty/ClientSideBlazorPrerendering">GitHub</a>.</blockquote><h2 id="what-is-prerendering">What is prerendering?</h2><p>Prerendering is a process where all the elements of a web page are compiled on the server and static HTML is served to the client. This technique is used to help SPAs (Single Page Applications) improve their SEO (Search Engine Optimisation). Another benefit is that sites appear to load much faster. </p><p>What this means for a Blazor application is that the requested page will be built on the server and compiled to static HTML. This static HTML will include the <code>blazor.webassembly.js</code> file which is present in the standard client-side Blazor template. When the client receives this static HTML it will be processed and rendered as normal.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/06/blazor-client-side-prerender.jpg" class="kg-image"></figure><p>When the <code>blazor.webassembly.js</code> file is executed the mono runtime will be downloaded along with the application dlls and your application will be run. At this point all of the static prerendered elements will be replaced with interactive components and the application will become interactive. </p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/06/blazor-client-side-prerender-interactive.jpg" class="kg-image"></figure><p>Now, this may sound like a lot has to happen before your application becomes usable. But this all happens in a very short space of time and is imperceivable to most end users.</p><h2 id="the-prerendering-trade-off">The Prerendering Trade-off</h2><p>Before we look at how to enable prerendering I want to point out that there are some trade-offs with using it. </p><p>You will no longer be able to deploy your Blazor application as static files. As we'll see in a second, prerendering requires a razor page, and that means a .NET runtime is required. While this is probably not a big issue, I do want to make sure you're aware of it.</p><p>The other trade-off is that you must manage any JavaScript calls to account for prerendering. If you attempt to perform JavaScript interop in the <code>OnInit</code> or <code>OnInitAsync</code> method of a component which is being prerendered then you will get an exception. When using prerendering all JavaScript interop calls should be moved to the <code>OnAfterRenderAsync</code> life-cycle method. This method will only be called once the page is fully rendered.</p><h2 id="enabling-prerendering">Enabling Prerendering</h2><p>We're going to start with a stand alone Blazor application and go though the steps to enable prerendering. I've created a new stand alone Blazor application using the .NET CLI. You can also use the template in Visual Studio.</p><pre><code>dotnet new blazorwasm -o BlazorPrerendering.Client
</code></pre><p>If you are looking to enable prerendering on a client-side Blazor app that is already using the "Hosted" template. Then you can just add in the bits of configuration as we go along.</p><h3 id="adding-a-host-project">Adding a Host Project</h3><p>The first thing we are going to do is add a new empty ASP.NET Core Web App. Again, I'm using the .NET CLI but you can use the templates in Visual Studio if you prefer.</p><pre><code>dotnet new web -o BlazorPrerendering.Server
</code></pre><p>Our solution should now look like this.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/06/solution-structure.JPG" class="kg-image"></figure><p>Then we need to add a project reference from the server project to the client project as well as a couple of NuGet packages. So the easiest thing to do is edit the <code>csproj</code> file directly.</p><pre><code class="language-xml">&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;

  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;netcoreapp3.1&lt;/TargetFramework&gt;
    &lt;LangVersion&gt;7.3&lt;/LangVersion&gt;
  &lt;/PropertyGroup&gt;

  &lt;ItemGroup&gt;
    &lt;PackageReference Include="Microsoft.AspNetCore.Blazor.Server" Version="3.1.0-preview1.19508.20" /&gt;
    &lt;PackageReference Include="Microsoft.AspNetCore.Mvc.NewtonsoftJson" Version="3.1.0-preview1.19508.20" /&gt;
  &lt;/ItemGroup&gt;

  &lt;ItemGroup&gt;
    &lt;ProjectReference Include="..\BlazorPrerendering.Client\BlazorPrerendering.Client.csproj" /&gt;
  &lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre><p>Once you're done, your project file should look like the code above. </p><h3 id="configuring-the-host">Configuring The Host</h3><p>Now our projects are setup, we are going to make some changes to the server projects <code>Startup.cs</code>. </p><p>First, add the following code to the <code>ConfigureServices</code> method.</p><pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    services.AddMvc().AddNewtonsoftJson();
    services.AddResponseCompression(opts =&gt;
    {
        opts.MimeTypes = ResponseCompressionDefaults.MimeTypes.Concat(
            new[] { "application/octet-stream" });
    });
    
    services.AddScoped&lt;HttpClient&gt;(s =&gt;
    {
        var navigationManager = s.GetRequiredService&lt;NavigationManager&gt;();
        return new HttpClient
        {
            BaseAddress = new Uri(navigationManager.BaseUri)
        };
    });
}
</code></pre><p>We'll also need to add some using statements.</p><pre><code class="language-csharp">using System;
using System.Net.Http;
using Microsoft.AspNetCore.Components;
using Microsoft.AspNetCore.ResponseCompression;
</code></pre><p>Then replace the code in the <code>Configure</code> method with the code below.</p><pre><code class="language-csharp">public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    app.UseResponseCompression();

    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
        app.UseBlazorDebugging();
    }
    
    app.UseClientSideBlazorFiles&lt;Client.Startup&gt;();

    app.UseStaticFiles();

    app.UseRouting();

    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapDefaultControllerRoute();
        endpoints.MapFallbackToPage("/_Host");
    });
}
</code></pre><p>Finally, we need to create a folder called <code>Pages</code> in the root of the server project and create a file called <code>_Host.cshtml</code> with the following code.</p><pre><code class="language-html">@page "/"
@namespace BlazorPrerendering.Server.Pages
@using BlazorPrerendering.Client
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
    &lt;title&gt;Prerendering client-side Blazor&lt;/title&gt;
    &lt;base href="~/" /&gt;
    &lt;environment include="Development"&gt;
        &lt;link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" /&gt;
    &lt;/environment&gt;
    &lt;environment exclude="Development"&gt;
        &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
              asp-fallback-href="css/bootstrap/bootstrap.min.css"
              asp-fallback-test-class="sr-only" asp-fallback-test-property="position" asp-fallback-test-value="absolute"
              crossorigin="anonymous"
              integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" /&gt;
    &lt;/environment&gt;
    &lt;link href="css/site.css" rel="stylesheet" /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;app&gt;@(await Html.RenderComponentAsync&lt;App&gt;(RenderMode.ServerPrerendered))&lt;/app&gt;

    &lt;script src="_framework/blazor.webassembly.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h2 id="testing-prerendering">Testing Prerendering</h2><p>We should now be able to start up the server project and launch the application. Once the application has loaded, the easiest way to test prerendering is to disable JavaScript in your browser. Then reload the page, if the page loads then prerendering is working.</p><p>To achieve this in Chrome or Edgeium, open the dev tools and press <code>ctrl+shift+p</code> or <code>cmd+shift+p</code>, depending on your OS. The start typing JavaScript, you should see the option appear to disable JavaScript.</p><figure class="kg-card kg-image-card"><img src="https://chrissainty.com/content/images/2019/06/chrome-dev-tools.jpg" class="kg-image"></figure><p>You should still be able to navigate around the app but you will find components will not be interactive. Go ahead and enable JavaScript again (just repeat the steps to disable but now the option will be to <em>Enable JavaScript</em>) and refresh the page, you should now have an interactive application once more.</p><h2 id="summary">Summary</h2><p>Prerendering is a really useful tool to have available and it's great that we can now use it with both server-side and client-side Blazor. In this post, I've shown how you can enable prerendering of your client-side Blazor applications by use of a hosted server project.</p><hr><hr></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>