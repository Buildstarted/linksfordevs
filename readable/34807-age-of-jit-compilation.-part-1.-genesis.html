<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Age of JIT Compilation. Part 1. Genesis -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Age of JIT Compilation. Part 1. Genesis</h1><div><div class="entry-content"><p>The runtime topic of the .NET platform has been discussed for many times, while JIT itself, as well as a resulting code and interoperability with the execution environment, have not.</p><p>We will explore a rationale for the lack of inheritance in structs, unbound delegate roots, as well as a technique of invoking any method without reflection.</p><h2>Genesis of Value Types</h2><p>Structs in the .NET framework are plain old structures (in terms of layout, mutability, etc.). They support OOP and .NET, the inheritance from System.ValueType, which is derived from System.Object, etc.).</p><p>To better understand why structs cannot be derived from other types, it is necessary to dig into CLR’s method organization.</p><p>Instance-level methods have an implicit argument ‘this’, which is explicit indeed. While compiling a code, JIT creates the following signature:</p><div id="crayon-5e4208f697b65666772414" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">ReturnType MethodName(Type this, …arguments…)</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b65666772414-1"><span class="crayon-e">ReturnType </span><span class="crayon-e">MethodName</span><span class="crayon-sy">(</span><span class="crayon-e">Type </span><span class="crayon-r">this</span><span class="crayon-sy">,</span><span class="crayon-h"></span>…<span class="crayon-i">arguments</span>…<span class="crayon-sy">)</span></div></div></td></tr></tbody></table></div></div><p>
However, it is for reference types only.</p><p>As for value types, it has the following signature:</p><div id="crayon-5e4208f697b6d380538763" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">ReturnType MethodName(ref Type this, …arguments…)</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b6d380538763-1"><span class="crayon-e">ReturnType </span><span class="crayon-e">MethodName</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-e">Type </span><span class="crayon-r">this</span><span class="crayon-sy">,</span><span class="crayon-h"></span>…<span class="crayon-i">arguments</span>…<span class="crayon-sy">)</span></div></div></td></tr></tbody></table></div></div><p>
This is done to support mutability for structs, i.e. so that we can modify <em>this</em> pointer.</p><p>So, why is it impossible to derive structs from other types?</p><p>Suppose we have a virtual method of a base reference class. What should a compiler do in this case? Nothing. Constantly guessing and generating different code specializations (with either <em>byval</em> or <em>byref</em> semantics) in addition to <em>vtable</em> dispatch is ineffective. Also, we are adding boxing, which is required to correctly dispatch virtual method.</p><p>But… the <em>ToString</em>,&nbsp;<em>GetHashCode</em>,&nbsp;and <em>Equals</em>&nbsp;methods are virtual methods of the parent <strong>System.Object</strong> class (a reference type)<strong>.</strong></p><p>They are exceptions. JIT knows about them and generates binding and specialization only for these methods.</p><h2><span lang="EN-US">Unbound Delegates</span></h2><p>Reflection in the <strong>.NET</strong> framework allows us to create a delegate for both static and instance-level methods. However, there is a small issue – it is necessary to create a new delegate per object’s instance.</p><p>Consider the example:</p><div id="crayon-5e4208f697b70285467354" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
    static void Main(string[] args)
    {
        var calc = new Calc() { FirstOperand = 2 };

        var addMethodInfo = typeof(Calc).GetMethod("Add", 
                                            BindingFlags.Public | BindingFlags.Instance);

        var addDelegate = (Func&lt;int, int&gt;)Delegate.CreateDelegate(
                                                        typeof(Func&lt;int, int&gt;), 
                                                        calc, 
                                                        addMethodInfo);

        Console.WriteLine(addDelegate(2)); // 4
    }
}

class Calc
{
    public int FirstOperand = 0;

    public int Add(int secondOperand)
    {
        return FirstOperand + secondOperand;
    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b70285467354-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b70285467354-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">calc</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">Calc</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-sy">{</span><span class="crayon-h"></span><span class="crayon-v">FirstOperand</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-cn">2</span><span class="crayon-h"></span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e4208f697b70285467354-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">addMethodInfo</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Calc</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetMethod</span><span class="crayon-sy">(</span><span class="crayon-s">"Add"</span><span class="crayon-sy">,</span><span class="crayon-h"></span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b70285467354-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-m">Public</span><span class="crayon-h"></span><span class="crayon-o">|</span><span class="crayon-h"></span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-v">Instance</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b70285467354-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">addDelegate</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">Func</span><span class="crayon-o">&lt;</span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-r">Delegate</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDelegate</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5e4208f697b70285467354-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-e">addDelegate</span><span class="crayon-sy">(</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-c">// 4</span></div><div class="crayon-line" id="crayon-5e4208f697b70285467354-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-v">secondOperand</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b70285467354-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-v">FirstOperand</span><span class="crayon-h"></span><span class="crayon-o">+</span><span class="crayon-h"></span><span class="crayon-v">secondOperand</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><p>
In order to do this, you need to use <strong>unbound delegates</strong>. However, they have one feature – a different signature, where an additional argument is prepended – a reference to an instance.</p><p>Thus, unbound delegates are the references to a real method.</p><p>As you can see, the <em>Add(int secondOperand) </em>signature will turn into the <em>Add</em><strong><em>(</em><em>Calc this</em></strong><em>, int secondOperand) </em>signature.</p><p>Let’s check it:</p><div id="crayon-5e4208f697b73167589853" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
    static void Main(string[] args)
    {
        var addMethodInfo = typeof(Calc).GetMethod("Add", 
                                            BindingFlags.Public | BindingFlags.Instance);

        var addDelegate = (Func&lt;Calc, int, int&gt;)Delegate.CreateDelegate(
                                                        typeof(Func&lt;Calc, int, int&gt;), 
                                                        null, 
                                                        addMethodInfo);

        Console.WriteLine(addDelegate(new Calc(), 2)); // 2
    }
}

class Calc
{
    public int FirstOperand = 0;

    public int Add(int secondOperand)
    {
        return FirstOperand + secondOperand;
    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b73167589853-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b73167589853-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">addMethodInfo</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Calc</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetMethod</span><span class="crayon-sy">(</span><span class="crayon-s">"Add"</span><span class="crayon-sy">,</span><span class="crayon-h"></span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b73167589853-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-m">Public</span><span class="crayon-h"></span><span class="crayon-o">|</span><span class="crayon-h"></span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-v">Instance</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b73167589853-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">addDelegate</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">Func</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-r">Delegate</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDelegate</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5e4208f697b73167589853-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Func</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"></span></div><div class="crayon-line" id="crayon-5e4208f697b73167589853-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-e">addDelegate</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">Calc</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-c">// 2</span></div><div class="crayon-line" id="crayon-5e4208f697b73167589853-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-v">secondOperand</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b73167589853-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-v">FirstOperand</span><span class="crayon-h"></span><span class="crayon-o">+</span><span class="crayon-h"></span><span class="crayon-v">secondOperand</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><p>
Now declare the Calc type as <strong>struct</strong>&nbsp;and run the code again. ArgumentException would be thrown.</p><p>But we need to pass <strong>this byref </strong>argument to Func&lt;Calc,int,int&gt;.</p><p>How to do this?!</p><p>First, declare the FuncByRef delegate:</p><div id="crayon-5e4208f697b75492804316" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">delegate TResult FuncByRef&lt;T1, in T2, out TResult&gt;(ref T1 arg1, T2 arg2);</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b75492804316-1"><span class="crayon-r">delegate</span><span class="crayon-h"></span><span class="crayon-e">TResult </span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">T1</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-st">in</span><span class="crayon-h"></span><span class="crayon-v">T2</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-st">out</span><span class="crayon-h"></span><span class="crayon-v">TResult</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-e">T1 </span><span class="crayon-v">arg1</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-e">T2 </span><span class="crayon-v">arg2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><p>
Now, change the code again:</p><div id="crayon-5e4208f697b7b871817355" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
    delegate TResult FuncByRef&lt;T1, in T2, out TResult&gt;(ref T1 arg1, T2 arg2);

    static void Main(string[] args)
    {
        var addMethodInfo = typeof(Calc).GetMethod("Add", 
                                            BindingFlags.Public | BindingFlags.Instance);

        var addDelegate = (FuncByRef&lt;Calc, int, int&gt;)Delegate.CreateDelegate(
                                                        typeof(FuncByRef&lt;Calc, int, int&gt;),
                                                        null, 
                                                        addMethodInfo);
        var calc = new Calc();
        calc.FirstOperand = 123;

        Console.WriteLine(addDelegate(ref calc, 2)); // 125
    }
}

struct Calc
{
    public int FirstOperand;

    public int Add(int secondOperand)
    {
        return FirstOperand + secondOperand;
    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b7b871817355-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r">delegate</span><span class="crayon-h"></span><span class="crayon-e">TResult </span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">T1</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-st">in</span><span class="crayon-h"></span><span class="crayon-v">T2</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-st">out</span><span class="crayon-h"></span><span class="crayon-v">TResult</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-e">T1 </span><span class="crayon-v">arg1</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-e">T2 </span><span class="crayon-v">arg2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5e4208f697b7b871817355-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b7b871817355-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">addMethodInfo</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">Calc</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">GetMethod</span><span class="crayon-sy">(</span><span class="crayon-s">"Add"</span><span class="crayon-sy">,</span><span class="crayon-h"></span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7b871817355-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-m">Public</span><span class="crayon-h"></span><span class="crayon-o">|</span><span class="crayon-h"></span><span class="crayon-v">BindingFlags</span><span class="crayon-sy">.</span><span class="crayon-v">Instance</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7b871817355-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">addDelegate</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-r">Delegate</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDelegate</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5e4208f697b7b871817355-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r">typeof</span><span class="crayon-sy">(</span><span class="crayon-v">FuncByRef</span><span class="crayon-o">&lt;</span><span class="crayon-v">Calc</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5e4208f697b7b871817355-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-e">addDelegate</span><span class="crayon-sy">(</span><span class="crayon-m">ref</span><span class="crayon-h"></span><span class="crayon-v">calc</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"></span><span class="crayon-c">// 125</span></div><div class="crayon-line" id="crayon-5e4208f697b7b871817355-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-e">Add</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"></span><span class="crayon-v">secondOperand</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b7b871817355-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"></span><span class="crayon-v">FirstOperand</span><span class="crayon-h"></span><span class="crayon-o">+</span><span class="crayon-h"></span><span class="crayon-v">secondOperand</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><h2>Verification evasion</h2><p>Consider a simple application:</p><div id="crayon-5e4208f697b7f136306520" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">class Program
{
    static void Main(string[] args)
    {
        CallTest(new object());
        CallTestWithExlicitCasting(new object());
        Console.Read();
    }

    static void CallTest(object target)
    {
        Program p = target as Program;
        p.Test();
    }

    static void CallTestWithExlicitCasting(object target)
    {
        Program p = (Program)target;
        p.Test();
    }

    public void Test()
    {
        Console.WriteLine("Test");
    }
}</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"></div></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b7f136306520-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7f136306520-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">CallTestWithExlicitCasting</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-t">object</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7f136306520-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">CallTest</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"></span><span class="crayon-v">target</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7f136306520-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Program</span><span class="crayon-h"></span><span class="crayon-v">p</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-e">target </span><span class="crayon-st">as</span><span class="crayon-h"></span><span class="crayon-v">Program</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7f136306520-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-e">CallTestWithExlicitCasting</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"></span><span class="crayon-v">target</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7f136306520-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Program</span><span class="crayon-h"></span><span class="crayon-v">p</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">Program</span><span class="crayon-sy">)</span><span class="crayon-v">target</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b7f136306520-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Console</span><span class="crayon-sy">.</span><span class="crayon-e">WriteLine</span><span class="crayon-sy">(</span><span class="crayon-s">"Test"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td></tr></tbody></table></div></div><p>
As you can see, the application will exit with NullReferenceException&nbsp;when calling CallTest().</p><p>Well, let’s fix this situation by running <strong>ildasm</strong>.</p><div id="crayon-5e4208f697b81431525132" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">Visual Studio Command Promt -&gt; ildasm</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b81431525132-1"><span class="crayon-e">Visual </span><span class="crayon-e">Studio </span><span class="crayon-e">Command </span><span class="crayon-v">Promt</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-v">ildasm</span></div></div></td></tr></tbody></table></div></div><p><a href="https://codingsight.com/wp-content/uploads/2017/04/1.png"><img src="https://codingsight.com/wp-content/uploads/2017/04/1.png" alt="" width="400" height="321"></a></p><p>Then,</p><div id="crayon-5e4208f697b8a092226731" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">File -&gt; Dump -&gt; Save as dialog -&gt; msiltricks_patch.il</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b8a092226731-1"><span class="crayon-v">File</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-v">Dump</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-e">Save </span><span class="crayon-st">as</span><span class="crayon-h"></span><span class="crayon-v">dialog</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-v">msiltricks_patch</span><span class="crayon-sy">.</span><span class="crayon-v">il</span></div></div></td></tr></tbody></table></div></div><p>
Open the stored file msiltricks_patch.il&nbsp;in any text editor and find a body of the CallTest method:</p><div id="crayon-5e4208f697b8e107681709" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">.method private hidebysig static void  CallTest(object target) cil managed
{
  // Code size       14 (0xe)
  .maxstack  1
  .locals init ([0] class MSILTricks.Program p)
  IL_0000:  ldarg.0
  IL_0001:  isinst     MSILTricks.Program
  IL_0006:  stloc.0
  IL_0007:  ldloc.0
  IL_0008:  callvirt   instance void MSILTricks.Program::Test()
  IL_000d:  ret
} // end of method Program::CallTest</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b8e107681709-1"><span class="crayon-sy">.</span><span class="crayon-e">method </span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">hidebysig </span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">CallTest</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"></span><span class="crayon-v">target</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-e">cil</span><span class="crayon-h"></span><span class="crayon-e">managed</span></div><div class="crayon-line" id="crayon-5e4208f697b8e107681709-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-e">locals </span><span class="crayon-e">init</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-i">Program</span><span class="crayon-h"></span><span class="crayon-v">p</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b8e107681709-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">IL_0001</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">isinst&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-e">Program</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b8e107681709-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">IL_0008</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">callvirt&nbsp;&nbsp; </span><span class="crayon-e">instance </span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-v">Program</span><span class="crayon-o">::</span><span class="crayon-e">Test</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b8e107681709-12"><span class="crayon-sy">}</span><span class="crayon-h"></span><span class="crayon-c">// end of method Program::CallTest</span></div></div></td></tr></tbody></table></div></div><p>
Delete the IL_0001: isinst MSILTricks.Program line, i.e. <strong>isinst </strong>operator invocation (the <strong>as</strong> operator in C#).</p><p>The same should be done to the CallTestWithExlicitCasting method:</p><div id="crayon-5e4208f697b90399141123" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">.method private hidebysig static void  CallTestWithExlicitCasting(object target) cil managed
{
  // Code size       14 (0xe)
  .maxstack  1
  .locals init ([0] class MSILTricks.Program p)
  IL_0000:  ldarg.0
  IL_0001:  castclass  MSILTricks.Program
  IL_0006:  stloc.0
  IL_0007:  ldloc.0
  IL_0008:  callvirt   instance void MSILTricks.Program::Test()
  IL_000d:  ret
} // end of method Program::CallTestWithExlicitCasting</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b90399141123-1"><span class="crayon-sy">.</span><span class="crayon-e">method </span><span class="crayon-m">private</span><span class="crayon-h"></span><span class="crayon-e">hidebysig </span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-t">void</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">CallTestWithExlicitCasting</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-h"></span><span class="crayon-v">target</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-e">cil</span><span class="crayon-h"></span><span class="crayon-e">managed</span></div><div class="crayon-line" id="crayon-5e4208f697b90399141123-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">.</span><span class="crayon-e">locals </span><span class="crayon-e">init</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-t">class</span><span class="crayon-h"></span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-i">Program</span><span class="crayon-h"></span><span class="crayon-v">p</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5e4208f697b90399141123-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">IL_0001</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">castclass&nbsp;&nbsp;</span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-e">Program</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b90399141123-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">IL_0008</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">callvirt&nbsp;&nbsp; </span><span class="crayon-e">instance </span><span class="crayon-t">void</span><span class="crayon-h"></span><span class="crayon-v">MSILTricks</span><span class="crayon-sy">.</span><span class="crayon-v">Program</span><span class="crayon-o">::</span><span class="crayon-e">Test</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b90399141123-12"><span class="crayon-sy">}</span><span class="crayon-h"></span><span class="crayon-c">// end of method Program::CallTestWithExlicitCasting</span></div></div></td></tr></tbody></table></div></div><p>
Delete the IL_0001: castclass MSILTricks.Program line, i.e. <strong>castclass</strong>&nbsp;operator invocation (the <strong>cast</strong> operator in C#).</p><div id="crayon-5e4208f697b92730122833" class="crayon-syntax crayon-theme-ssms2012 crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"><div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">Visual Studio Command Promt -&gt; cd [your saved file dir]
Visual Studio Command Promt -&gt; ilasm msiltricks_patch.il</textarea></div><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><div class="crayon-line" id="crayon-5e4208f697b92730122833-1"><span class="crayon-e">Visual </span><span class="crayon-e">Studio </span><span class="crayon-e">Command </span><span class="crayon-v">Promt</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-i">cd</span><span class="crayon-h"></span><span class="crayon-sy">[</span><span class="crayon-e">your </span><span class="crayon-e">saved </span><span class="crayon-e">file </span><span class="crayon-v">dir</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5e4208f697b92730122833-2"><span class="crayon-e">Visual </span><span class="crayon-e">Studio </span><span class="crayon-e">Command </span><span class="crayon-v">Promt</span><span class="crayon-h"></span><span class="crayon-o">-&gt;</span><span class="crayon-h"></span><span class="crayon-e">ilasm </span><span class="crayon-v">msiltricks_patch</span><span class="crayon-sy">.</span><span class="crayon-v">il</span></div></div></td></tr></tbody></table></div></div><p>
Run <strong>msiltricks_patch.exe</strong>.</p><p>Thus, there are no exceptions, even <strong>AccessViolationException</strong>.</p><p>The thing is that our Test method does not have side effects and does not use <strong>this</strong>&nbsp;in its body.</p><h2><strong>Conclusion:</strong></h2><p><strong>&nbsp;</strong>We work with hardware. Variables of reference types are just addresses in memory –&nbsp;<strong>DWORD. </strong>Casting types is nothing more than abstraction and protection at the compile time. The CPU works with memory addresses only. CLR provides these addresses while JIT compiles code using them.</p><p>By the way, <strong>callvirt</strong>&nbsp;instruction does not check for correctness of an object. For example, to get AccessViolationException just add a virtual method to the Program class and call it in the Test method’s body.</p><h3>Also read:</h3><p><a href="https://codingsight.com/age-of-jit-compilation-part-2-clr-is-watching-you/" target="_blank" rel="noopener noreferrer">Age of JIT compilation.&nbsp;Part 2. CLR is watching you</a></p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>