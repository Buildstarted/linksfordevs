<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Authentication &amp; Authorization in ASP .NET Core 3.1 -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Authentication &amp; Authorization in ASP .NET Core 3.1</h1><div><div class="entry-content"><figure class="wp-block-image size-large"><a href="https://wakeupandcode.com/aspnetcore/#aspnetcore2020"><img src="https://wakeupandcode.com/wp-content/uploads/2020/01/aspnetcore-az-banner.png" alt="ASP .NET Core A-Z Series" class="wp-image-4421" srcset="https://wakeupandcode.com/wp-content/uploads/2020/01/aspnetcore-az-banner.png 573w, https://wakeupandcode.com/wp-content/uploads/2020/01/aspnetcore-az-banner-300x64.png 300w" sizes="(max-width: 573px) 100vw, 573px"></a></figure><p>This is&nbsp;the first of a new&nbsp;<a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://wakeupandcode.com/aspnetcore/#aspnetcore2020" target="_blank">series of posts</a>&nbsp;on ASP .NET Core 3.1 for 2020. In this series, we’ll cover 26 topics over a span of 26 weeks from January through June 2020, titled&nbsp;<strong>ASP .NET Core A-Z!</strong> To differentiate from the <a href="https://wakeupandcode.com/aspnetcore/#aspnetcore2019">2019 series</a>, the 2020 series will mostly focus on a growing single codebase (<a href="https://wakeupandcode.com/netlearner-on-asp-net-core-3-1/">NetLearner!</a>) instead of new unrelated code snippets week. </p><p>If you need some guidance before you get started with this series, check out my <a href="https://wakeupandcode.com/aspnetcore/#aspnetcore2020prelude">late 2019 posts</a>, which serve as a prelude to the 2020 series:</p><p><strong>NetLearner on GitHub</strong>: </p><h1>In this Article:</h1><h1>A is for Authentication &amp; Authorization</h1><p><em>Authentication&nbsp;</em>and&nbsp;<em>Authorization&nbsp;</em>are two different things, but they also go hand in hand. Think of Authentication as letting someone into your home and Authorization as allowing your guests to do specific things once they’re inside (e.g. wear their shoes indoors, eat your food, etc). In other words, Authentication lets your web app’s users identify themselves to get access to your app and Authorization allows them to&nbsp;get access to specific features and functionality.</p><p>In this article, we will take a look at the&nbsp;<a href="https://wakeupandcode.com/netlearner-on-asp-net-core-3-1/">NetLearner</a>&nbsp;app, on how specific pages can be restricted to users who are logged in to the application. Throughout the series, I will try to focus on new code added to NetLearner or build a smaller sample app if necessary.<br></p><h1>Authentication in ASP .NET Core</h1><p>The quickest way to add authentication to your ASP .NET Core app is to use one of the pre-built templates with one of the Authentication options. The examples below demonstrate both the CLI commands and Visual Studio UI.</p><p>Here are the CLI Commands for MVC, Razor Pages and Blazor (Server), respectively: </p><pre class="wp-block-preformatted">&gt; <strong>dotnet new </strong>mvc <strong>--auth Individual</strong> -o mvcsample
&gt; <strong>dotnet new </strong>webapp <strong>--auth Individual</strong> -o pagessample
&gt; <strong>dotnet new </strong>blazorserver <strong>--auth Individual</strong> -o blazorsample </pre><p>Things to note:</p><ul><li>The <strong>dotnet new </strong>command is followed by the template name (mvc, webapp, blazorserver). </li><li>The –auth option allows you to specify the authentication type, e.g. Individual </li><li>The -o option is an optional parameter that provides the output folder name for the project to be created in. </li></ul><p>Here is the opening dialog in Visual Studio 2019, for creating a new project with Authentication:</p><figure class="wp-block-image size-large"><img src="https://wakeupandcode.com/wp-content/uploads/2020/01/auth-vs2019-newproject-individual-1-1024x399.png" alt=" Select Authentication Type " class="wp-image-4459" srcset="https://wakeupandcode.com/wp-content/uploads/2020/01/auth-vs2019-newproject-individual-1-1024x399.png 1024w, https://wakeupandcode.com/wp-content/uploads/2020/01/auth-vs2019-newproject-individual-1-300x117.png 300w, https://wakeupandcode.com/wp-content/uploads/2020/01/auth-vs2019-newproject-individual-1-624x243.png 624w, https://wakeupandcode.com/wp-content/uploads/2020/01/auth-vs2019-newproject-individual-1.png 1448w" sizes="(max-width: 1024px) 100vw, 1024px"><figcaption>  Select Authentication Type  </figcaption></figure><p>The above example uses “Individual” authentication, which offers a couple of options:</p><ul><li><strong>Store user accounts in-app</strong>: includes a local user accounts store</li><li><strong>Connect to an existing user store in the cloud</strong>: connect to an existing Azure AD B2C application</li></ul><p>Even if I choose to start with a local database, I can update the connection string to point to a SQL Server instance on my network or in the cloud, depending on which configuration is being loaded. If you’re wondering where your Identity code lives, check out my 2019 post on&nbsp;<a rel="noreferrer noopener" href="https://wakeupandcode.com/your-first-razor-ui-library-with-asp-net-core/" target="_blank">Razor UI Libraries</a>, and jump to the last bonus section where Identity is mentioned.</p><p>From the documentation, the types of authentication are listed below.</p><ul><li><strong>None</strong>: No authentication</li><li><strong>Individual</strong>: Individual authentication</li><li><strong>IndividualB2C</strong>: Individual authentication with Azure AD B2C</li><li><strong>SingleOrg</strong>: Organizational authentication for a single tenant</li><li><strong>MultiOrg</strong>: Organizational authentication for multiple tenants</li><li><strong>Windows</strong>: Windows authentication</li></ul><p>To get help information about Authentication types, simply type ––help after the&nbsp;––auth flag, e.g. </p><pre class="wp-block-preformatted">&gt;&nbsp;dotnet new webapp <strong>--auth --help</strong></pre><h1>Authentication in&nbsp;NetLearner</h1><p>Within my NetLearner MVC app, the following snippets of code are added&nbsp;to the&nbsp;<a href="https://github.com/shahedc/NetLearnerApp/blob/master/src/NetLearner.Mvc/Startup.cs" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">Startup.cs configuration</a>: </p><pre class="wp-block-preformatted">public void <strong>ConfigureServices</strong>(IServiceCollection services)
{
...
   services.AddDbContext&lt;LibDbContext&gt;(options =&gt;
   {
      options
         .UseSqlServer(Configuration.GetConnectionString("DefaultConnection"),
         assembly =&gt;
         assembly.MigrationsAssembly
            (typeof(LibDbContext).Assembly.FullName));
   });

   services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true)
   .AddEntityFrameworkStores&lt;LibDbContext&gt;();
...
}</pre><pre class="wp-block-preformatted">public void <strong>Configure</strong>(IApplicationBuilder app, IHostingEnvironment env)
{
...
 app.UseStaticFiles();
...
 app.<strong>UseAuthentication</strong>();
 app.<strong>UseAuthorization</strong>(); 
...
 app.Endpoints(...);
}</pre><p>In the above, note that:</p><ul><li>The&nbsp;<strong>ConfigureServices</strong>() method has calls to services.<strong>AddDbContext</strong>&nbsp;and server.<strong>AddDefaultIdentity</strong>. The call to add a DB Context will vary depending on which data store you choose for authentication. The call to&nbsp;<a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity" target="_blank">AddDefaultIdentity</a>&nbsp;ensures that your app calls AddIdentity, AddDefaultUI and AddDefaultTokenProviders to add common identity features and user Register/Login functionality.</li><li>The&nbsp;<strong>Configure</strong>() method has calls to  app.UseAuthentication  and  app.UseAuthorization to ensure that authentication and authorization are used by your web app. Note that this appears&nbsp;<em>after</em>&nbsp;app.UseStaticFiles() but&nbsp;<em>before</em>&nbsp;app.UseEndpoints() to ensure that static files (html, css, js, etc) can be served without any authentication&nbsp;but MVC application-controlled routes and views/pages will follow authentication rules.</li><li>Similar to the MVC web project, you can also browse the Startup.cs file for the equivalent <a href="https://github.com/shahedc/NetLearnerApp/blob/master/src/NetLearner.Pages/Startup.cs">Razor Pages</a> and <a href="https://github.com/shahedc/NetLearnerApp/blob/master/src/NetLearner.Blazor/Startup.cs">Blazor</a> web app projects. </li></ul><h1>Authorization in ASP.NET Core (MVC)</h1><p>Even&nbsp;after adding authentication to a web app using the project template options, we can still access many parts of the application without having to log in. In order to restrict specific parts of the application, we will implement Authorization in our app.</p><p>If you’ve already worked with ASP .NET Core MVC apps before, you may be familiar with the&nbsp;<strong>[Authorize]</strong>&nbsp;attribute. This attribute can be added to a controller at the class level or even to specific action methods within a class.</p><pre class="wp-block-preformatted">[<strong>Authorize</strong>]
public class <strong>SomeController1</strong>: Controller
{
<em><strong>   // this controller class requires authentication</strong></em><em><strong>   // for all action methods</strong></em>
   public ActionResult SomeMethod()
   {
      //
   }&nbsp;
}

public class&nbsp;<strong>SomeController2</strong>: Controller
{
   public ActionResult&nbsp;SomeOpenMethod()
   {
   }

   [<strong>Authorize</strong>]
   public ActionResult&nbsp;SomeSecureMethod()
   {
<em><strong>      // this action method requires authentication</strong></em>
   }
}</pre><p><em>Well, what about Razor Pages in ASP .NET Core? If there are no controller classes, where would you add the&nbsp;<strong>[Authorize]</strong>&nbsp;attribute?</em></p><h1>Authorization in ASP.NET Core (Razor Pages)</h1><p>For Razor Pages, the quickest way to add Authorization for your pages (or entire folders of pages) is to update your&nbsp;<strong>ConfigureServices()</strong>&nbsp;method in your Startup.cs class, by calling&nbsp;<strong>AddRazorPagesOptions()</strong>&nbsp;after&nbsp;<strong>AddMvc()</strong>. The&nbsp;<a href="https://github.com/shahedc/NetLearnerApp/blob/master/src/NetLearner.Pages/Startup.cs" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">NetLearner configuration</a>&nbsp;includes the following code:</p><pre class="wp-block-preformatted">services.AddRazorPages()
     .<strong>AddRazorPagesOptions</strong>(options =&gt;
     {
         options.Conventions.<strong>AuthorizePage</strong>("/LearningResources/Create");
         options.Conventions.<strong>AuthorizePage</strong>("/LearningResources/Edit");
         options.Conventions.<strong>AuthorizePage</strong>("/LearningResources/Delete");
         options.Conventions.<strong>AuthorizePage</strong>("/ResourceLists/Create");
         options.Conventions.<strong>AuthorizePage</strong>("/ResourceLists/Edit");
         options.Conventions.<strong>AuthorizePage</strong>("/ResourceLists/Delete");
         options.Conventions.<strong>AllowAnonymousToPage</strong>("/Index");
     });</pre><p>The above code ensures that the CRUD pages for Creating, Editing and Deleting any of the LearningResources are only accessible to someone who is currently logged in.&nbsp;Each call to&nbsp;<strong>AuthorizePage</strong>() includes a specific page name identified by a known route. In this case, the&nbsp;<a href="https://github.com/shahedc/NetLearnerApp/tree/master/src/NetLearner.Pages/Pages/LearningResources" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">LearningResources folder</a>&nbsp;exists within the Pages folder of the application.</p><p>Finally, the call to&nbsp;<strong>AllowAnonymousPage()</strong>&nbsp;ensures that the app’s&nbsp;<a href="https://github.com/shahedc/NetLearnerApp/blob/master/src/NetLearner.Pages/Pages/LearningResources/Index.cshtml" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">index</a>&nbsp;page (at the root of the Pages folder) is accessible to any user without requiring any login.</p><p>If you still wish to use the&nbsp;<strong>[Authorize]</strong>&nbsp;attribute for Razor Pages, you&nbsp;may apply&nbsp;this attribute in your PageModel classes for each Razor Page, as needed.&nbsp;If I were to add it to one of my Razor Pages in the LearningResources folder, it could look like this:</p><pre class="wp-block-preformatted"><strong>[Authorize]</strong>
public class CreateModel : PageModel
{
 &nbsp; &nbsp;...
}</pre><h1>Authorization in Blazor</h1><p>In a Blazor project, you can wrap elements in an &lt;AuthorizeView&gt; component, which may contain nested elements named &lt;Authorized&gt;, &lt;NotAuthorized&gt; and &lt;Authorizing&gt;. </p><pre class="wp-block-preformatted">&lt;<strong>AuthorizeView</strong>&gt;
   &lt;<strong>Authorized </strong>Context="Auth"&gt;
<em>     authorized elements go here
</em>   &lt;/<strong>Authorized</strong>&gt;
   &lt;<strong>NotAuthorized</strong>&gt;
<em>     anonymous-accessed elements
</em>   &lt;/<strong>NotAuthorized</strong>&gt;
   &lt;<strong>Authorizing</strong>&gt;
<em>     waiting message...
</em>   &lt;/<strong>Authorizing</strong>&gt;
&lt;/<strong>AuthorizeView</strong>&gt;
</pre><p>The root element here has the following characteristics:</p><ul><li>&lt;<strong>AuthorizeView</strong>&gt; element used as a container for nested elements</li><li>Optional role attribute, e.g. &lt;<strong>AuthorizeView</strong> Roles=”Admin,RoleA”&gt; used to set a comma-separated list roles that will be used to determine who can view the authorized nested elements</li><li>Optional context attribute, e.g. &lt;<strong>AuthorizeView </strong>Context=”Auth”&gt; to define a custom context, to avoid any <a href="https://github.com/chanan/BlazorStrap/issues/149#issuecomment-519691692">conflicts with nested comments</a></li></ul><p>The nested elements represent the following:</p><ul><li><strong>Authorized</strong>: shown to users who have been authorized to view and interact with these elements</li><li><strong>NotAuthorized</strong>: shown to users who have <em>not</em> been authorized </li><li><strong>Authorizing</strong>: temporary message shown while authorization is being processed </li></ul><h1>Testing Authorization in&nbsp;NetLearner</h1><p>When I run my application, I can register and log in as a user to create new Learning Resources. On first launch, I have to apply migrations to create the database from scratch. Please refer to my 2018 post on&nbsp;<a rel="noreferrer noopener" href="https://wakeupandcode.com/ef-core-migrations-in-asp-net-core/" target="_blank">EF Core Migrations</a>&nbsp;to learn how you can do the same in your environment.</p><p><strong>NOTE: </strong>the registration feature for each web app has been disabled by default. To enable registration, please do the following:</p><ol><li>Locate scaffolded Identity pages under /Areas/Identity/Pages/Account/</li><li>In Register.cshtml, update the page to include environments in addition to Development, if desired.</li><li>In Register.cshtml.cs, replace [<strong>Authorize</strong>] with [<strong>AllowAnonymous</strong>] to allow access to registration</li></ol><p>Here are the screenshots of&nbsp;the Create page&nbsp;for a user who is logged in:</p><p>Here’s a screenshot of the page that an “anonymous” user sees when no one is logged in, indicating that the user has been redirected to the Login page. Note that all 3 web apps (MVC, Razor Pages and Blazor) have similar Identity pages. To allow manual customization, they were also auto-generated via scaffolding and included in all 3 projects. </p><p>Here are the screenshots showing the list of Learning Resources,&nbsp;visible to anyone whether they’re logged in or not:</p><h1>Other Authorization Options</h1><p>Razor Pages have multiple ways of restricting access to pages and folders, including the following methods (<em>as described in the official docs</em>):</p><ul><li><strong>AuthorizePage</strong>: Require authorization to access a page</li><li><strong>AuthorizeFolder</strong>: Require authorization to access a folder of pages</li><li><strong>AuthorizeAreaPage</strong>: Require authorization to access an area page</li><li><strong>AuthorizeAreaFolder</strong>: Require authorization to access a folder of areas</li><li><strong>AllowAnonymousToPage</strong>: Allow anonymous access to a page</li><li><strong>AllowAnonymousToFolder</strong>: Allow anonymous access to a folder of pages</li></ul><p>You can get more information on all of the above methods at the following URL:</p><h1>References</h1><p>To learn more about Authentication, Authorization and other related topics (e.g. Roles and Claims), check out the official docs:</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>