<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How to add an optimization for C# to RyuJIT - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="How to add an optimization for C# to RyuJIT - linksfor.dev(s)"/>
    <meta property="article:author" content="Egor Bogatov"/>
    <meta property="og:description" content="How to add an optimization for C# to RyuJIT"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.slideshare.net/egorbogatov/how-to-add-an-optimization-for-c-to-ryujit-170891159"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - How to add an optimization for C# to RyuJIT</title>
<div class="readable">
        <h1>How to add an optimization for C# to RyuJIT</h1>
            <div>by Egor Bogatov</div>
            <div>Reading time: 13-16 minutes</div>
        <div>Posted here: 11 Sep 2019</div>
        <p><a href="https://www.slideshare.net/egorbogatov/how-to-add-an-optimization-for-c-to-ryujit-170891159">https://www.slideshare.net/egorbogatov/how-to-add-an-optimization-for-c-to-ryujit-170891159</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div>
        
        


      

        <p><span>Successfully reported this slideshow.</span>
  </p>


      
















<div id="slideview-container">
  

  <div>

    <div id="main-panel">


      

      <div itemscope="" itemtype="https://schema.org/MediaObject">


        <div>
          <meta itemprop="inLanguage" content="en">
          <meta itemprop="image" content="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-1-638.jpg?cb=1568214658">
          <meta itemprop="thumbnailUrl" content="https://cdn.slidesharecdn.com/ss_thumbnails/ruyjitopts-190911150012-thumbnail.jpg?cb=1568214658">
          <meta itemprop="embedURL" content="https://www.slideshare.net/slideshow/embed_code/key/1pyOHTX3Bdefe3">
          <meta itemprop="playerType" content="HTML5">
          <meta itemprop="interactionCount" content="UserComments:0">
          <meta itemprop="interactionCount" content="UserLikes:4">
          <meta itemprop="interactionCount" content="UserDownloads:10">
          <meta itemprop="interactionCount" content="UserPageVisits:1216">
          <meta itemprop="interactionCount" content="UserPlays:1216">
          <meta itemprop="interactionCount" content="UserPlusOnes:0" id="meta-google">


          

          <ul id="slideshow-actions">
            <li>
              
            </li>
              <li>
                
              </li>
              <li>
                
              </li>

            <!-- Report/Flag Content -->
            <li>
              <a data-dropdown="report-dropdown" aria-controls="report-dropdown" aria-expanded="false">
                <span>...</span></a>
              <span title="You have reported this as inappropriate">
                <i></i>
                <span aria-label="You have reported this as inappropriate"></span>
              </span>
              
            </li>
          </ul>


          <div itemprop="author" itemscope="" itemtype="https://schema.org/Person">

            <p><a href="https://www.slideshare.net/egorbogatov?utm_campaign=profiletracking&amp;utm_medium=sssite&amp;utm_source=ssslideview" title="egorbogatov" itemprop="url">
                <img alt="Egor Bogatov" itemprop="image" src="https://cdn.slidesharecdn.com/profile-photo-egorbogatov-48x48.jpg?cb=1568152037">
              </a>
            </p>

            <div>
              <h2>
                </h2><p><small itemprop="jobTitle">, Software developer at Xamarin Inc.</small></p>
            </div>
          </div>

            

          <p>
            <small>
              Published on <time datetime="Sep 11, 2019" itemprop="datePublished">Sep 11, 2019</time>
            </small>
          </p>

            <div>
              <div data-ga-cat="bigfoot_slideview" data-ga-action="description>more">
                <p id="slideshow-description-paragraph">
                    How to add an optimization for C# to RyuJIT
                  </p>
                
              </div>
            </div>


            



        </div>


        

            <div>
              
              <ol itemprop="text">
                    <li>
      1.
    How to add an optimization for C#
to JIT compiler
@EgorBo
Engineer at Microsoft
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-2-638.jpg?cb=1568214658" title="RuyJIT
From C# to machine code
2
C# IL IR ASM
 " target="_blank">
        2.
      </a>
    RuyJIT
From C# to machine code
2
C# IL IR ASM
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-3-638.jpg?cb=1568214658" title="float y = x / 2;
float y = x * 0.5f;
Let’s start with a sim..." target="_blank">
        3.
      </a>
    float y = x / 2;
float y = x * 0.5f;
Let’s start with a simple optimization
3
vdivss (Latency: 20, R.Throughput: 14)
vmulss (Latency: 5, R.Throughput: 0.5)
^ for my MacBook (Haswell)
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-4-638.jpg?cb=1568214658" title="X / C
4
double y = x / 2;
float y = x / 2;
double y = x / 1..." target="_blank">
        4.
      </a>
    X / C
4
double y = x / 2;
float y = x / 2;
double y = x / 10;
double y = x / 8;
double y = x / -0.5;
float x = 48.665f;
Console.WriteLine(x / 10f); // 4.8665
Console.WriteLine(x * 0.1f); // 4.8665004
= x * 0.5
= x * 0.5f
= x * 0.1
= x * 0.125
= x * -2
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-5-638.jpg?cb=1568214658" title="X / C – let me optimize it in Roslyn!
5
static float GetSpe..." target="_blank">
        5.
      </a>
    X / C – let me optimize it in Roslyn!
5
static float GetSpeed(float distance, float time)
{
return distance / time;
}
...
float speed = GetSpeed(distance, 2);
Does Roslyn see “X/C” here?
NO! It doesn’t inline methods
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-6-638.jpg?cb=1568214658" title="Where to implement my custom optimization?
6
• Roslyn
+ No ..." target="_blank">
        6.
      </a>
    Where to implement my custom optimization?
6
• Roslyn
+ No time constraints
+ It’s written in C# - easy to add optimizations, easy to debug and experiment
- No cross-assembly optimizations
- No CPU-dependent optimizations (IL is cross-platform)
- Doesn’t know how the code will look like after inlining, CSE, loop optimizations, etc.
- F# doesn’t use Roslyn
• JIT
+ Inlining, CSE, Loop opts, etc phases create more opportunities for optimizations
+ Knows everything about target platform, CPU capabilities
- Written in C++, difficult to experiment
- Time constraints for optimizations (probably not that important with Tiering)
• R2R (AOT)
+ No time constraints (some optimizations are really time consuming, e.g. full escape analysis)
- No CPU-dependent optimizations
- Will be most likely re-jitted anyway?
• ILLink Custom Step
+ Cross-assembly IL optimizations
+ Written in C#
+ We can manually de-virtualize types/methods/calls (if we know what we are doing)
- Still no inlining, CSE, etc..
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-7-638.jpg?cb=1568214658" title="RuyJIT: phases
7
 " target="_blank">
        7.
      </a>
    RuyJIT: phases
7
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-8-638.jpg?cb=1568214658" title="RuyJIT: where to morph my X/C?
8
 " target="_blank">
        8.
      </a>
    RuyJIT: where to morph my X/C?
8
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-9-638.jpg?cb=1568214658" title="GenTree
GenTreeStmt
GenTree
(GenTreeOp)
BasicBlock
GenTree
..." target="_blank">
        9.
      </a>
    GenTree
GenTreeStmt
GenTree
(GenTreeOp)
BasicBlock
GenTree
(GenTreeDblCon)
GenTree
(GenTreeDblCon)
GenTree
(GenTreeCall)
GenTree
(GenTreeLclVar)
static float Test(float x)
{
return Foo(x, 3.14) * 2;
}
Compiler
MUL
2.0
3.14x
Foo
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-10-638.jpg?cb=1568214658" title="Dump IR via COMPlus_JitDump
 " target="_blank">
        10.
      </a>
    Dump IR via COMPlus_JitDump
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-11-638.jpg?cb=1568214658" title="Back to X/C: Morph IR Tree
static float Calculate(float dis..." target="_blank">
        11.
      </a>
    Back to X/C: Morph IR Tree
static float Calculate(float distance, float v0)
{
return distance / 2 + v0;
}
ADD
DIV
LCL_VAR
(v0)
CNS_DBL
(2.0)
LCL_VAT
(distance)
ADD
MUL
LCL_VAR
(v0)
CNS_DBL
(0.5)
LCL_VAR
(distance)
Morph
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-12-638.jpg?cb=1568214658" title="Implementing the opt in morph.cpp
DIV
op2op1
 " target="_blank">
        12.
      </a>
    Implementing the opt in morph.cpp
DIV
op2op1
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-13-638.jpg?cb=1568214658" title="Inspired by GT_ROL
13
/// <summary>
/// Rotates the specifi..." target="_blank">
        13.
      </a>
    Inspired by GT_ROL
13
/// &lt;summary&gt;
/// Rotates the specified value left by the specified number of bits.
/// &lt;/summary&gt;
public static uint RotateLeft(uint value, int offset)
=&gt; (value &lt;&lt; offset) | (value &gt;&gt; (32 - offset));
OR ROL
/  / 
/  / 
LSH RSZ =&gt; x y
/  / 
x AND x AND
/  / 
y 31 ADD 31
/ 
NEG 32
|
y
rol eax, cl
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-14-638.jpg?cb=1568214658" title="15
&quot;Hello&quot;.Length -> 5
static void Append(string str)
{
if ..." target="_blank">
        14.
      </a>
    15
"Hello".Length -&gt; 5
static void Append(string str)
{
if (str.Length &lt;= 2)
QuickAppend(str);
else
SlowAppend(str);
}
...
builder.Append("/&gt;");
builder.QuickAppend("/&gt;");
Inline, remove if (2 &lt;= 2)
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-15-638.jpg?cb=1568214658" title="16
&quot;Hello&quot;.Length => 5
ARR_LENGTH
CNS_STR
(ScpHnd, SconCPX)..." target="_blank">
        15.
      </a>
    16
"Hello".Length =&gt; 5
ARR_LENGTH
CNS_STR
(ScpHnd, SconCPX)
CNS_INT
(5)
VM
case GT_ARR_LENGTH:
{
if (op1-&gt;OperIs(GT_CNS_STR))
{
GenTreeStrCon* strCon = op1-&gt;AsStrCon();
int len = info.compCompHnd-&gt;getStringLength(
strCon-&gt;gtScpHnd, strCon-&gt;gtSconCPX);
return gtNewIconNode(len);
}
break;
}
JIT &lt;-&gt; VM
Interface
op1
Access VM’s data from JIT
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-16-638.jpg?cb=1568214658" title="17
bool Test1(int x) => x % 4 == 0; bool Test1(int x) => x ..." target="_blank">
        16.
      </a>
    17
bool Test1(int x) =&gt; x % 4 == 0; bool Test1(int x) =&gt; x &amp; 3 == 0;
MOD
EQ/NE
CNS_INT
(0)
CNS_INT
(4)
anything
op1 op2
op2op1
AND
EQ/NE
CNS_INT
(0)
CNS_INT
(3)
anything
op1 op2
op2op1
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-17-638.jpg?cb=1568214658" title="Roslyn and “!=“ operator
(unexpected optimization)
18
publi..." target="_blank">
        17.
      </a>
    Roslyn and “!=“ operator
(unexpected optimization)
18
public static bool Test1(int x) =&gt; x != 42;
public static bool Test2(int x) =&gt; x != 0;
IL_0000: ldarg.0
IL_0001: ldc.i4.42
IL_0002: ceq
IL_0004: ldc.i4.0
IL_0005: ceq
IL_0007: ret
IL_0000: ldarg.0
IL_0001: ldc.i4.0
IL_0002: cgt.un
IL_0004: ret
return (uint)x &gt; 0
return (x == 42) == false
JIT: ok, it’s GT_NE
JIT: what?.. ok, GT_GT
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-18-638.jpg?cb=1568214658" title="19
Math.Pow(x, 2)
Math.Pow(x, 1)
Math.Pow(x, 4)
Math.Pow(x,..." target="_blank">
        18.
      </a>
    19
Math.Pow(x, 2)
Math.Pow(x, 1)
Math.Pow(x, 4)
Math.Pow(x, -1)
// can be added:
Math.Pow(42, 3)
Math.Pow(1, x)
Math.Pow(2, x)
Math.Pow(x, 0)
Math.Pow(x, 0.5)
| x * x
| x
| x * x * x * x
| 1 / x
| 74088
| 1
| exp2(x)
| 1
| sqrt(x)
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-19-638.jpg?cb=1568214658" title="Range check elimination
20
 " target="_blank">
        19.
      </a>
    Range check elimination
20
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-20-638.jpg?cb=1568214658" title="Range check elimination
21
public static void Test(int[] a)..." target="_blank">
        20.
      </a>
    Range check elimination
21
public static void Test(int[] a)
{
a[0] = 4;
a[1] = 2;
for (int i = 0; i &lt; a.Length; i++)
{
a[i] = 0;
}
a[1] = 2;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-21-638.jpg?cb=1568214658" title="Range check elimination
22
public static void Test(int[] a)..." target="_blank">
        21.
      </a>
    Range check elimination
22
public static void Test(int[] a)
{
if (a.Length &lt;= 0) throw new IndexOutOfRangeException();
a[0] = 4;
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
for (int i = 0; i &lt; a.Length; i++)
{
if (a.Length &lt;= i) throw new IndexOutOfRangeException();
a[i] = 0;
}
if (a.Length &lt;= 2) throw new IndexOutOfRangeException();
a[1] = 2;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-22-638.jpg?cb=1568214658" title="Range check elimination
23
public static void Test(int[] a)..." target="_blank">
        22.
      </a>
    Range check elimination
23
public static void Test(int[] a)
{
if (a.Length &lt;= 0) throw new IndexOutOfRangeException();
a[0] = 4;
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
for (int i = 0; i &lt; a.Length; i++)
{
if (a.Length &lt;= i) throw new IndexOutOfRangeException();
a[i] = 0;
}
if (a.Length &lt;= 2) throw new IndexOutOfRangeException();
a[1] = 2;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-23-638.jpg?cb=1568214658" title="Range check elimination
24
public static void Test(int[] a)..." target="_blank">
        23.
      </a>
    Range check elimination
24
public static void Test(int[] a)
{
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[0] = 4;
for (int i = 0; i &lt; a.Length; i++)
{
if (a.Length &lt;= i) throw new IndexOutOfRangeException();
a[i] = 0;
}
if (a.Length &lt;= 2) throw new IndexOutOfRangeException();
a[1] = 2;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-24-638.jpg?cb=1568214658" title="Range check elimination
25
public static void Test(int[] a)..." target="_blank">
        24.
      </a>
    Range check elimination
25
public static void Test(int[] a)
{
if (a.Length &lt;= 1) throw new IndexOutOfRangeException();
a[1] = 2;
a[0] = 4;
for (int i = 0; i &lt; a.Length; i++)
{
a[i] = 0;
}
a[1] = 2;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-25-638.jpg?cb=1568214658" title="rangecheck.cpp (simplified)
26
void RangeCheck::OptimizeRan..." target="_blank">
        25.
      </a>
    rangecheck.cpp (simplified)
26
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-26-638.jpg?cb=1568214658" title="rangecheck.cpp (simplified)
27
void RangeCheck::OptimizeRan..." target="_blank">
        26.
      </a>
    rangecheck.cpp (simplified)
27
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-27-638.jpg?cb=1568214658" title="rangecheck.cpp (simplified)
28
void RangeCheck::OptimizeRan..." target="_blank">
        27.
      </a>
    rangecheck.cpp (simplified)
28
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-28-638.jpg?cb=1568214658" title="Byte array
29
private static readonly byte[] _data =
new by..." target="_blank">
        28.
      </a>
    Byte array
29
private static readonly byte[] _data =
new byte[256] { 1, 2, 3, … };
public static byte GetByte(int i)
{
return _data[i];
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-29-638.jpg?cb=1568214658" title="Byte array: Roslyn hack (new feature)
30
private static Rea..." target="_blank">
        29.
      </a>
    Byte array: Roslyn hack (new feature)
30
private static ReadOnlySpan&lt;byte&gt; _data =&gt;
new byte[256] { 1, 2, 3, … };
public static byte GetByte(int i)
{
return _data[i];
}
256
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-30-638.jpg?cb=1568214658" title="Byte array: byte index (my PR)
31
private static ReadOnlySp..." target="_blank">
        30.
      </a>
    Byte array: byte index (my PR)
31
private static ReadOnlySpan&lt;byte&gt; _data =&gt;
new byte[256] { 1, 2, 3, … };
public static byte GetByte(int i)
{
return _data[(byte)i];
}
Byte indexer will never go out of bounds!
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-31-638.jpg?cb=1568214658" title="rangecheck.cpp (simplified)
32
void RangeCheck::OptimizeRan..." target="_blank">
        31.
      </a>
    rangecheck.cpp (simplified)
32
void RangeCheck::OptimizeRangeCheck(GenTreeBoundsChk* bndsChk)
{
// Get the range for this index.
Range range = GetRange(...);
// If upper or lower limit is unknown, then return.
if (range.UpperLimit().IsUnknown() || range.LowerLimit().IsUnknown())
{
return;
}
// Is the range between the lower and upper bound values.
if (BetweenBounds(range, 0, bndsChk-&gt;gtArrLen))
{
m_pCompiler-&gt;optRemoveRangeCheck(treeParent, stmt);
}
return;
}
[Byte.MinValue ... Byte.MaxValue]
ArrLen = 256
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-32-638.jpg?cb=1568214658" title="Loop optimizations
33
 " target="_blank">
        32.
      </a>
    Loop optimizations
33
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-33-638.jpg?cb=1568214658" title="Loop Invariant Code Hoisting
34
public static bool Test(int..." target="_blank">
        33.
      </a>
    Loop Invariant Code Hoisting
34
public static bool Test(int[] a, int c)
{
for (int i = 0; i &lt; a.Length; i++)
{
if (a[i] == c + 44)
return false;
}
return true;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-34-638.jpg?cb=1568214658" title="Loop Invariant Code Hoisting
35
public static bool Test(int..." target="_blank">
        34.
      </a>
    Loop Invariant Code Hoisting
35
public static bool Test(int[] a, int c)
{
int tmp = c + 44;
for (int i = 0; i &lt; a.Length; i++)
{
if (a[i] == tmp)
return false;
}
return true;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-35-638.jpg?cb=1568214658" title="NYI: Loop-unrolling
36
public static int Test(int[] a)
{
in..." target="_blank">
        35.
      </a>
    NYI: Loop-unrolling
36
public static int Test(int[] a)
{
int sum = 0;
for (int i = 0; i &lt; a.Length; i++)
{
sum += a[i];
}
return sum;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-36-638.jpg?cb=1568214658" title="NYI: Loop-unrolling
37
public static int Test(int[] a)
{
in..." target="_blank">
        36.
      </a>
    NYI: Loop-unrolling
37
public static int Test(int[] a)
{
int sum = 0;
for (int i = 0; i &lt; a.Length - 3; i += 4)
{
sum += a[i];
sum += a[i+1];
sum += a[i+2];
sum += a[i+3];
}
return sum;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-37-638.jpg?cb=1568214658" title="NYI: Loop-unswitch
38
public static int Test(int[] a, bool ..." target="_blank">
        37.
      </a>
    NYI: Loop-unswitch
38
public static int Test(int[] a, bool condition)
{
int agr = 0;
for (int i = 0; i &lt; a.Length; i++)
{
if (condition)
agr += a[i];
else
agr *= a[i];
}
return agr;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-38-638.jpg?cb=1568214658" title="NYI: Loop-unswitch
39
public static int Test (int[] a, bool..." target="_blank">
        38.
      </a>
    NYI: Loop-unswitch
39
public static int Test (int[] a, bool condition)
{
int agr = 0;
if (condition)
for (int i = 0; i &lt; a.Length; i++)
agr += a[i];
else
for (int i = 0; i &lt; a.Length; i++)
agr *= a[i];
return agr;
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-39-638.jpg?cb=1568214658" title="NYI: Loop-deletion
40
public static void Test()
{
for (int ..." target="_blank">
        39.
      </a>
    NYI: Loop-deletion
40
public static void Test()
{
for (int i = 0; i &lt; 10; i++) { }
}
; Method Program:Test()
G_M44187_IG01:
G_M44187_IG02:
xor eax, eax
G_M44187_IG03:
inc eax
cmp eax, 10
jl SHORT G_M44187_IG03
G_M44187_IG04:
ret
; Total bytes of code: 10
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-40-638.jpg?cb=1568214658" title="NYI: Loop-deletion
41
public static void Test()
{
}
; Metho..." target="_blank">
        40.
      </a>
    NYI: Loop-deletion
41
public static void Test()
{
}
; Method Program:DeadLoop()
ret
; Total bytes of code: 1
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-41-638.jpg?cb=1568214658" title="NYI: InductiveRangeCheckElimination
42
public static void Z..." target="_blank">
        41.
      </a>
    NYI: InductiveRangeCheckElimination
42
public static void Zero1000Elements(int[] array)
{
for (int i = 0; i &lt; 1000; i++)
array[i] = 0; // bound checks will be inserted here
}
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-42-638.jpg?cb=1568214658" title="NYI: InductiveRangeCheckElimination
43
public static void Z..." target="_blank">
        42.
      </a>
    NYI: InductiveRangeCheckElimination
43
public static void Zero1000Elements(int[] array)
{
int limit = Math.Min(array.Length, 1000);
for (int i = 0; i &lt; limit; i++)
array[i] = 0; // bound checks are not needed here!
for (int i = limit; i &lt; 1000; i++)
array[i] = 0; // bound checks are needed here
// so at least we could "zero" first `limit` elements without bound checks
}
NOTE: this LLVM optimization pass is not enabled by default in `opt –O2`.
Contributed by Azul developers (LLVM for JVM)
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-43-638.jpg?cb=1568214658" title="NYI: InductiveRangeCheckElimination
44
public static void Z..." target="_blank">
        43.
      </a>
    NYI: InductiveRangeCheckElimination
44
public static void Zero1000Elements(int[] array)
{
int limit = Math.Min(array.Length, 1000);
for (int i = 0; i &lt; limit - 3; i += 4)
{
array[i] = 0;
array[i+1] = 0;
array[i+2] = 0;
array[i+3] = 0;
}
for (int i = limit; i &lt; 1000; i++)
array[i] = 0; // bound checks are needed here
// so at least we could "zero" first `limit` elements without bound checks
}
Now we can even unroll the first loop!
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-44-638.jpg?cb=1568214658" title="NYI: InductiveRangeCheckElimination
45
public static void Z..." target="_blank">
        44.
      </a>
    NYI: InductiveRangeCheckElimination
45
public static void Zero1000Elements(int[] array)
{
int limit = Math.Min(array.Length, 1000);
memset(array, 0, limit);
for (int i = limit; i &lt; 1000; i++)
array[i] = 0; // bound checks are needed here
// so at least we could "zero" first `limit` elements without bound checks
}
Or just replace with memset call
 
  </li>
  <li>
      <a href="https://image.slidesharecdn.com/ruyjitopts-190911150012/95/how-to-add-an-optimization-for-c-to-ryujit-45-638.jpg?cb=1568214658" title="Q&amp;A
Twitter: EgorBo
 " target="_blank">
        45.
      </a>
    Q&amp;A
Twitter: EgorBo
 
  </li>

              </ol>
            </div>
      </div>
    </div>

    
  </div>
</div>










      

      

        
    </div></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>