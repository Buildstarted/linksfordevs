<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Validating SSL Certificates With .NET ServicePointManager -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
            <h1>
                    <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">üéâ</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
            </h1>
        <div class="readable">
    <h1>Validating SSL Certificates With .NET ServicePointManager</h1>
    <p>
by Khalid Abuhakmeh <br />Reading time: 5-6 minutes    </p>
    <p><a href="https://khalidabuhakmeh.com/validating-ssl-certificates-with-dotnet-servicepointmanager">https://khalidabuhakmeh.com/validating-ssl-certificates-with-dotnet-servicepointmanager</a></p>
    <hr/>
    <div id="readability-page-1" class="page"><div id="page">
       
<!-- .site-header -->
 
      
      <div id="content">
    
    <main id="main">
        <article>
            <!-- .post-header -->
            
            <div>
                    
                    <picture>
                        <source media="(min-width: 960px)" srcset="https://images.unsplash.com/photo-1516534775068-ba3e7458af70?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=cropq=80&amp;w=1080&amp;w=1080">
                        <source media="(min-width: 650px)" srcset="https://images.unsplash.com/photo-1516534775068-ba3e7458af70?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=cropq=80&amp;w=1080&amp;w=800">
                        <source media="(min-width: 465px)" srcset="https://images.unsplash.com/photo-1516534775068-ba3e7458af70?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=cropq=80&amp;w=1080&amp;w=600">
                        <img loading="lazy" src="https://images.unsplash.com/photo-1516534775068-ba3e7458af70?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=cropq=80&amp;w=1080&amp;w=1080" alt="Validating SSL Certificates With .NET ServicePointManager">
                    </picture>
                    
                    
                        
                            <p><small>Photo by <a href="https://unsplash.com/@jeshoots" target="_blank">jeshoots</a></small>
                        
                    
            </p></div>
            
            <div>
                <p>I‚Äôve taken for granted how often I need to call a web API from my C# applications. If you‚Äôve ever had to make a web request in your .NET application, then I‚Äôm sure you‚Äôve seen the following frustrating exception message as many times as I have.</p>

<blockquote>
  <p>The underlying connection was closed: Could not establish trust relationship for the SSL/TLS secure channel.<cite>‚Äì The depths of the .NET Framework</cite></p>
</blockquote>

<p>This error message is so blunt, yet so confusing to most developers. So what‚Äôs the cause and how do you fix it?</p>

<p><strong>Normally, the exception is caused by an un-validated certificate at the target server. By default, .NET web requests need to verify the target of their request and the way developers can validate an unknown certificate is by using the ServicePointManager.</strong></p>

<p>If you need something that <em>‚Äúworks‚Äù</em>, then you might use the following code.</p>

<div><div><pre><code><span>ServicePointManager</span><span>.</span><span>ServerCertificateValidationCallback</span> <span>+=</span>
    <span>(</span><span>sender</span><span>,</span> <span>certificate</span><span>,</span> <span>chain</span><span>,</span> <span>errors</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>return</span> <span>true</span><span>;</span>
    <span>};</span>
</code></pre></div></div>

<p>I do not recommend leaving this hack in your codebase. The above code is a security risk, as <em><strong>any</strong></em> certificate, even malicious ones will be accepted. If you want a better solution read on.</p>

<h2 id="what-is-the-servicepointmanager"><a href="#what-is-the-servicepointmanager">What Is The ServicePointManager</a></h2>

<p>The Microsoft docs succinctly describes the purpose of the <code>ServicePointManager</code> class.</p>

<blockquote>
  <p>When an application requests a connection to an Internet resource Uniform Resource Identifier (URI) through the ServicePointManager object, the ServicePointManager returns a ServicePoint object that contains connection information for the host and scheme identified by the URI. <cite>‚Äì<a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.servicepointmanager?view=netframework-4.8">Microsoft</a></cite></p>
</blockquote>

<p>The class is essentially a connection manager for outgoing web requests. To validate these connections, you will need to subscribe to the <code>ServerCertificateValidationCallback</code> event, which fires on every certificate validation.</p>

<h2 id="servicepointmanager-for-development"><a href="#servicepointmanager-for-development">ServicePointManager For Development</a></h2>

<p>If you‚Äôre writing a console application or throw-away piece of code, you can use this naive implementation of a validator.</p>

<div><div><pre><code><span>ServicePointManager</span><span>.</span><span>ServerCertificateValidationCallback</span> <span>+=</span>
    <span>(</span><span>sender</span><span>,</span> <span>certificate</span><span>,</span> <span>chain</span><span>,</span> <span>errors</span><span>)</span> <span>=&gt;</span>
    <span>{</span>
        <span>// local dev, just approve all certs</span>
        <span>if</span> <span>(</span><span>development</span><span>)</span> <span>return</span> <span>true</span><span>;</span>
        <span>return</span> <span>errors</span> <span>==</span> <span>SslPolicyErrors</span><span>.</span><span>None</span> <span>;</span>
    <span>};</span>
</code></pre></div></div>

<p>The local development implementation makes sure there are at least no errors with the SSL policy.</p>

<h2 id="servicepointmanager-for-production"><a href="#servicepointmanager-for-production">ServicePointManager For Production</a></h2>

<p>If you trust and know the locations are calling, you can validate against a dictionary of certificate hashes. These certificates can either be preloaded on to the host machine or read from disk. I prefer this second impelmentation of <code>ServerCertificateValidationCallback</code> in most cases.</p>

<div><div><pre><code><span>ServicePointManager</span><span>.</span><span>ServerCertificateValidationCallback</span> <span>+=</span>
    <span>(</span><span>sender</span><span>,</span> <span>certificate</span><span>,</span> <span>chain</span><span>,</span> <span>errors</span><span>)</span> <span>=&gt;</span>
    <span>{</span>
        <span>// local dev, just approve all certs</span>
        <span>if</span> <span>(</span><span>development</span><span>)</span> <span>return</span> <span>true</span><span>;</span>
        <span>return</span> <span>errors</span> <span>==</span> <span>SslPolicyErrors</span><span>.</span><span>None</span>
            <span>&amp;&amp;</span> <span>validCerts</span><span>.</span><span>Contains</span><span>(</span><span>certificate</span><span>.</span><span>GetCertHashString</span><span>());</span>
    <span>};</span>
</code></pre></div></div>

<p>The <code>validCerts</code> variable is a dictionary that contains the hash strings of the <code>X509</code> certificates you trust. You can load these up from a configuration file or a database. You can get the hash strings from loading the certs you trust into a .NET console app and spitting them out.</p>

<div><div><pre><code><span>var</span> <span>hash</span> <span>=</span> <span>X509Certificate</span>
    <span>.</span><span>CreateFromCertFile</span><span>(</span><span>"mycert.cer"</span><span>)</span>
    <span>.</span><span>GetCertHashString</span><span>();</span>
</code></pre></div></div>

<p>Utilizing trusted certificates ensures you stop any sensitive requests from going to an unknown server. When starting a development project, you can start by accepting all certificates during local development to reduce friction, but remember to harden your security before code is deployed into production.</p>

            </div>
            
            <div>
                <p><img loading="lazy" src="https://d33wubrfki0l68.cloudfront.net/735b1a1cb51288a0b88809574c8f0847c5f2899b/5dbbb/assets/images/authorimage.jpg" alt="Khalid Abuhakmeh's Picture"></p>
                <div>
                    
                    <p>Khalid is a product designer, traveler, respected community member, and open source contributor.</p>
                    
                </div>
            </div>
            



        </article>
        
        <section>
            <h2>Read Next</h2>
            
            
            <article>
                
                
                <a href="https://khalidabuhakmeh.com/submitting-a-dictionary-to-an-asp-net-mvc-action">
                        <img loading="lazy" src="https://images.unsplash.com/photo-1524639064490-254e0a1db723?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;q=80&amp;w=1080" alt="Submitting A Dictionary To An ASP.NET MVC Action">
                </a>
                
            </article>
            
        </section><!-- .read-next -->
    </main><!-- .site-main -->
</div><!-- .site-content -->

       

      
      <!-- .site-footer -->
    </div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            let COLLECT_URL = "https://dna.buildstarted.com/t";
            let EVENT_URL = "https://dna.buildstarted.com/e";
            let SITE_ID = "linksfor.devs";
            let ENABLE_OUTLINK = true;
            let GLOBAL_VAR_NAME = "__dotnetlytics__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                let path = location.pathname;
                let referrer = document.referrer;
                let url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                fetch(url, { method: "GET" });
            };

            if (ENABLE_OUTLINK) {
                let intercept = async (e) => {
                    if (e.target.tagname === "a") {
                        let url = e.target.getattribute("href");
                        if (url) {
                            let path = location.pathname;
                            let url = EVENT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&a=" + encodeURIComponent(url) + "&e=outgoing";
                            navigator.sendbeacon(url);
                            console.log("beacon called", url);
                        }
                    }
            
                    return true;
                };
            
                if (document.addeventlistener) {
                    document.addeventlistener("click", intercept);
                } else if (document.attachevent) {
                    document.attachevent("onclick", intercept);
                }
            }

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>