<!DOCTYPE html>
<html lang="en">
<head>
    <title>
C# 8 using declarations -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>C# 8 using declarations</h1><div><div class="post-content" itemprop="articleBody"><p>Visual Studio 2019 preview 2 was released a few days ago and I took the time
to install it. Visual Studio itself is actually rather uninteresting to me,
however the inclusion of the next C# 8 preview got my attention. I glanced at
the feature highlights and posted “looks nice” on Twitter.</p><p>Predictably, I got a few responses like “I’m not sure I like that”, and there is
always a guarantee that if F# has a similar feature, an F# developer will appear
and tell you F# has had this feature for 600 years.</p><p>The one I like a lot is using declarations. This allows a local to automatically
be disposed at the end of the block. Essentially, it hides the <code class="highlighter-rouge">try</code>/<code class="highlighter-rouge">finally</code>
or the <code class="highlighter-rouge">using() {...}</code>. The .NET team’s blog kind of gave a bad example of this,
so I’ll use one from <a href="https://github.com/vcsjones/FiddlerCert">Open OPC SignTool</a>. Here is the original snippet:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span><span class="k">static</span><span class="n">X509Certificate2</span><span class="nf">GetCertificateFromCertificateStore</span><span class="p">(</span><span class="kt">string</span><span class="n">sha1</span><span class="p">)</span><span class="p">{</span><span class="k">using</span><span class="p">(</span><span class="kt">var</span><span class="n">store</span><span class="p">=</span><span class="k">new</span><span class="nf">X509Store</span><span class="p">(</span><span class="n">StoreName</span><span class="p">.</span><span class="n">My</span><span class="p">,</span><span class="n">StoreLocation</span><span class="p">.</span><span class="n">LocalMachine</span><span class="p">))</span><span class="p">{</span><span class="n">store</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">OpenFlags</span><span class="p">.</span><span class="n">OpenExistingOnly</span><span class="p">|</span><span class="n">OpenFlags</span><span class="p">.</span><span class="n">ReadOnly</span><span class="p">);</span><span class="kt">var</span><span class="n">certificates</span><span class="p">=</span><span class="n">store</span><span class="p">.</span><span class="n">Certificates</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">X509FindType</span><span class="p">.</span><span class="n">FindByThumbprint</span><span class="p">,</span><span class="n">sha1</span><span class="p">,</span><span class="k">false</span><span class="p">);</span><span class="k">return</span><span class="n">certificates</span><span class="p">.</span><span class="n">Count</span><span class="p">&gt;</span><span class="m">0</span><span class="p">?</span><span class="n">certificates</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="p">:</span><span class="k">null</span><span class="p">;</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>A <code class="highlighter-rouge">using var</code> can make this:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span><span class="k">static</span><span class="n">X509Certificate2</span><span class="nf">GetCertificateFromCertificateStore</span><span class="p">(</span><span class="kt">string</span><span class="n">sha1</span><span class="p">)</span><span class="p">{</span><span class="k">using</span><span class="nn">var</span><span class="n">store</span><span class="p">=</span><span class="k">new</span><span class="nf">X509Store</span><span class="p">(</span><span class="n">StoreName</span><span class="p">.</span><span class="n">My</span><span class="p">,</span><span class="n">StoreLocation</span><span class="p">.</span><span class="n">LocalMachine</span><span class="p">);</span><span class="n">store</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">OpenFlags</span><span class="p">.</span><span class="n">OpenExistingOnly</span><span class="p">|</span><span class="n">OpenFlags</span><span class="p">.</span><span class="n">ReadOnly</span><span class="p">);</span><span class="kt">var</span><span class="n">certificates</span><span class="p">=</span><span class="n">store</span><span class="p">.</span><span class="n">Certificates</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">X509FindType</span><span class="p">.</span><span class="n">FindByThumbprint</span><span class="p">,</span><span class="n">sha1</span><span class="p">,</span><span class="k">false</span><span class="p">);</span><span class="k">return</span><span class="n">certificates</span><span class="p">.</span><span class="n">Count</span><span class="p">&gt;</span><span class="m">0</span><span class="p">?</span><span class="n">certificates</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="p">:</span><span class="k">null</span><span class="p">;</span><span class="p">}</span></code></pre></div></div><p>This has the same effect of <code class="highlighter-rouge">store</code> having <code class="highlighter-rouge">Dispose</code> called on it at the end of
the method. The benefit here being that there is less indentation and braces.
This keeps me focused on the code that matters. I don’t care when <code class="highlighter-rouge">store</code> is
disposed in the method, I can just observe that it has a <code class="highlighter-rouge">using</code> modifier on the
local and be assured that <code class="highlighter-rouge">Dispose</code> will be called.</p><p>This isn’t the same as garbage collection or finalizers. Both of those are non-
deterministic, and can lead to unexpected program behavior. That’s less so in
the case of <code class="highlighter-rouge">X509Store</code>, so let’s look at another example:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span><span class="nn">Stream</span><span class="n">stream</span><span class="p">=</span><span class="n">entry</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span><span class="kt">var</span><span class="n">xmlDocument</span><span class="p">=</span><span class="n">XDocument</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="n">LoadOptions</span><span class="p">.</span><span class="n">PreserveWhitespace</span><span class="p">);</span><span class="k">return</span><span class="k">new</span><span class="nf">OpcRelationships</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="n">xmlDocument</span><span class="p">,</span><span class="n">readOnlyMode</span><span class="p">);</span></code></pre></div></div><p>Not disposing a stream that is backed by a file can cause access errors later in
software that might try to open that file again - it is already open, so not
only is it a bad idea it leave streams to the GC, it is just simply incorrect.</p><p>However again <code class="highlighter-rouge">using</code> on the local ensures it is deterministically closed.</p><p><em>When</em> it gets disposed I can see being slightly unclear to the developer. The
quick explanation is when the local is no longer reachable, not when it is last
used. The C# 8 above gets compiled roughly to:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span><span class="n">stream</span><span class="p">=</span><span class="n">entry</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span><span class="k">try</span><span class="p">{</span><span class="kt">var</span><span class="n">xmlDocument</span><span class="p">=</span><span class="n">XDocument</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="n">LoadOptions</span><span class="p">.</span><span class="n">PreserveWhitespace</span><span class="p">);</span><span class="k">return</span><span class="k">new</span><span class="nf">OpcRelationships</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="n">xmlDocument</span><span class="p">,</span><span class="n">readOnlyMode</span><span class="p">);</span><span class="p">}</span><span class="k">finally</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">stream</span><span class="p">!=</span><span class="k">null</span><span class="p">)</span><span class="p">{</span><span class="p">((</span><span class="n">IDisposable</span><span class="p">)</span><span class="n">stream</span><span class="p">).</span><span class="nf">Dispose</span><span class="p">();</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>The disposal is done after the return, when the local is no longer reachable,
not after <code class="highlighter-rouge">XDocument</code> is created.</p><p>I find this very helpful to keep code readable. This doesn’t work when you need
fine control over when <code class="highlighter-rouge">Dispose</code> is called. A place where this does not work
well is when the <code class="highlighter-rouge">Dispose</code> pattern is used for scopes, such as logging. The
AzureSignTool project has code similar to this in <code class="highlighter-rouge">SignCommand</code>:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span><span class="n">logger</span><span class="p">=</span><span class="n">loggerFactory</span><span class="p">.</span><span class="n">CreateLogger</span><span class="p">&lt;</span><span class="n">SignCommand</span><span class="p">&gt;();</span><span class="n">Parallel</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="n">AllFiles</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="p">()</span><span class="p">=&gt;</span><span class="p">(</span><span class="n">succeeded</span><span class="p">:</span><span class="m">0</span><span class="p">,</span><span class="n">failed</span><span class="p">:</span><span class="m">0</span><span class="p">),</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span><span class="n">pls</span><span class="p">,</span><span class="n">state</span><span class="p">)</span><span class="p">=&gt;</span><span class="p">{</span><span class="k">using</span><span class="p">(</span><span class="kt">var</span><span class="n">loopScope</span><span class="p">=</span><span class="n">logger</span><span class="p">.</span><span class="nf">BeginScope</span><span class="p">(</span><span class="s">"File: {Id}"</span><span class="p">,</span><span class="n">filePath</span><span class="p">))</span><span class="p">{</span><span class="n">logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Signing file."</span><span class="p">);</span><span class="c1">//Sign the file. omit a bunch of other code.</span><span class="n">logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Done signing the file."</span><span class="p">);</span><span class="p">}</span><span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"Incrementing success count."</span><span class="p">);</span><span class="k">return</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">succeeded</span><span class="p">+</span><span class="m">1</span><span class="p">,</span><span class="n">state</span><span class="p">.</span><span class="n">failed</span><span class="p">);</span><span class="p">}</span></code></pre></div></div><p>Here, we cannot change this to a <code class="highlighter-rouge">using var</code> because then the <code class="highlighter-rouge">LogDebug</code> would
be inside of that logging scope, which it wasn’t before. This is a place where
we continue to want <code class="highlighter-rouge">Dispose</code> to be called at a different time from the when
<code class="highlighter-rouge">loopScope</code> would no longer be in scope.</p><p>My impression from C# developers is that they do not tend to call <code class="highlighter-rouge">Dispose</code> 
on resources as soon as it can be disposed, just at a reasonable point in the
same method. Most developers do not write this code:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span><span class="kt">bool</span><span class="nf">MightBeExe</span><span class="p">(</span><span class="kt">string</span><span class="n">filePath</span><span class="p">)</span><span class="p">{</span><span class="kt">var</span><span class="n">firstBytes</span><span class="p">=</span><span class="k">new</span><span class="kt">byte</span><span class="p">[</span><span class="m">2</span><span class="p">];</span><span class="kt">int</span><span class="n">bytesRead</span><span class="p">;</span><span class="k">using</span><span class="p">(</span><span class="kt">var</span><span class="n">file</span><span class="p">=</span><span class="n">File</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span><span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">))</span><span class="p">{</span><span class="n">bytesRead</span><span class="p">=</span><span class="n">file</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">firstBytes</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">2</span><span class="p">);</span><span class="p">}</span><span class="k">return</span><span class="n">bytesRead</span><span class="p">==</span><span class="m">2</span><span class="p">&amp;&amp;</span><span class="n">firstBytes</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="p">==</span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'M'</span><span class="p">&amp;&amp;</span><span class="n">firstBytes</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="p">==</span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'Z'</span><span class="p">;</span><span class="p">}</span></code></pre></div></div><p>They will instead write something like:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span><span class="kt">bool</span><span class="nf">MightBeExe</span><span class="p">(</span><span class="kt">string</span><span class="n">filePath</span><span class="p">)</span><span class="p">{</span><span class="k">using</span><span class="p">(</span><span class="kt">var</span><span class="n">file</span><span class="p">=</span><span class="n">File</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span><span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">))</span><span class="p">{</span><span class="kt">var</span><span class="n">firstBytes</span><span class="p">=</span><span class="k">new</span><span class="kt">byte</span><span class="p">[</span><span class="m">2</span><span class="p">];</span><span class="kt">var</span><span class="n">bytesRead</span><span class="p">=</span><span class="n">file</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">firstBytes</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">2</span><span class="p">);</span><span class="k">return</span><span class="n">bytesRead</span><span class="p">==</span><span class="m">2</span><span class="p">&amp;&amp;</span><span class="n">firstBytes</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="p">==</span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'M'</span><span class="p">&amp;&amp;</span><span class="n">firstBytes</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="p">==</span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'Z'</span><span class="p">;</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>Which is a perfect candidate for <code class="highlighter-rouge">using var</code>:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span><span class="kt">bool</span><span class="nf">MightBeExe</span><span class="p">(</span><span class="kt">string</span><span class="n">filePath</span><span class="p">)</span><span class="p">{</span><span class="k">using</span><span class="nn">var</span><span class="n">file</span><span class="p">=</span><span class="n">File</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span><span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">);</span><span class="kt">var</span><span class="n">firstBytes</span><span class="p">=</span><span class="k">new</span><span class="kt">byte</span><span class="p">[</span><span class="m">2</span><span class="p">];</span><span class="kt">var</span><span class="n">bytesRead</span><span class="p">=</span><span class="n">file</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">firstBytes</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">2</span><span class="p">);</span><span class="k">return</span><span class="n">bytesRead</span><span class="p">==</span><span class="m">2</span><span class="p">&amp;&amp;</span><span class="n">firstBytes</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="p">==</span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'M'</span><span class="p">&amp;&amp;</span><span class="n">firstBytes</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="p">==</span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'Z'</span><span class="p">;</span><span class="p">}</span></code></pre></div></div><p>There are of course some reasonable limitations to this feature. For example,
it cannot be combined with out-variables.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="n">Crypto32</span><span class="p">.</span><span class="nf">CryptEncodeObjectEx</span><span class="p">(</span><span class="c1">// other stuff</span><span class="k">out</span><span class="kt">var</span><span class="n">handle</span><span class="p">,</span><span class="k">ref</span><span class="n">size</span><span class="p">)</span><span class="p">)</span><span class="p">{</span><span class="k">using</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="p">{</span><span class="c1">// Do stuff</span><span class="p">}</span><span class="p">}</span></code></pre></div></div><p>This does not work:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="n">Crypto32</span><span class="p">.</span><span class="nf">CryptEncodeObjectEx</span><span class="p">(</span><span class="c1">// other stuff</span><span class="k">out</span><span class="k">using</span><span class="nn">var</span><span class="n">handle</span><span class="p">,</span><span class="k">ref</span><span class="n">size</span><span class="p">)</span><span class="p">)</span><span class="p">{</span><span class="c1">// Do stuff</span><span class="p">}</span></code></pre></div></div><p>Jared Parsons said <a href="https://twitter.com/jaredpar/status/1088832515861663744">on Twitter</a> that C# folks thought of this, and decided
that it had “Too much confusion about ownership.” Thinking about it myself, I
agree, so it’s nice that the feature is limited in that regard.</p><p>Another limitation is that the variable cannot be reassigned. For example:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span><span class="nn">var</span><span class="n">stream</span><span class="p">=</span><span class="n">entry</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span><span class="n">stream</span><span class="p">=</span><span class="n">entry2</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span></code></pre></div></div><p>This will produce error CS1656, “Cannot assign to ‘stream’ because it is a
‘using variable’”.</p><p>All in all, I very much like this small feature in C# 8. It has reasonable guard
rails on it from doing something too weird like re-assigning to it, while giving
the benefit of less blocks, braces, indentation.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>