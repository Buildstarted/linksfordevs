<!DOCTYPE html>
<html lang="en">
<head>
    <title>
A bootstrapper script for the Cake .NET Core Global Tool on Alpine using ash -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>A bootstrapper script for the Cake .NET Core Global Tool on Alpine using ash</h1><div><div class="post-content"><p>In <a href="/how-to-build-with-cake-on-linux-using-cake-coreclr-or-the-cake-global-tool/">a previous post</a>, I described how to use Cake.CoreCLR and Cake.Tool versions of <a href="https://cakebuild.net/">Cake</a> to run build scripts on Linux, without requiring Mono. In <a href="/a-bootstrapper-script-for-the-cake-net-core-global-tool-on-windows/">a follow up post</a>, I provided a PowerShell bootstrapper script equivalent of <a href="/how-to-build-with-cake-on-linux-using-cake-coreclr-or-the-cake-global-tool/#building-on-linux-with-the-cake-global-tool">the bash bootstrapper script</a>. </p><p>As I mentioned in my previous post, one of the big advantages of Cake build scripts is that they are cross platform, so the same build script can be run across Windows Linux and Mac. Unfortunately, the <em>bootstrapping</em> scripts are generally platform-specific. Bash scripts are generally pretty portable between Linux distros, but the tiny <a href="https://alpinelinux.org/">Alpine Linux</a> is one exception; this uses the <a href="https://en.wikipedia.org/wiki/Almquist_shell">Almquist shell (ash) instead</a>.</p><p>In this post I provide a shell script version of <a href="/how-to-build-with-cake-on-linux-using-cake-coreclr-or-the-cake-global-tool/#building-on-linux-with-the-cake-global-tool">my original bash script</a> that works on the Alpine ash shell, so can be used with the tiny Alpine-based <a href="https://hub.docker.com/_/microsoft-dotnet-core-sdk/">.NET Core SDK Docker images</a>. This is of particular interest given <a href="https://devblogs.microsoft.com/dotnet/announcing-net-core-3-0-preview-7/">the reduced Docker image sizes in .NET Core 3</a>. The script installs the <a href="/how-to-build-with-cake-on-linux-using-cake-coreclr-or-the-cake-global-tool/#cake-cake-coreclr-and-cake-tool">Cake .NET Core global tool</a>.</p><p>The following script uses the same global tool approach from my previous post, but instead of using bash-specific constructs, it uses a script that should work with any POSIX shell, including Alpine's ash shell. </p><blockquote><p>Disclaimer: I'm out of my comfort zone here - with enough Googling I can just about manage bash, but figuring out what is POSIX and what is a "bashism" was a lot of trial and error… If I'm doing anything Bad™, please point it out in the comments!</p></blockquote><p>As in my previous bootstrapper scripts, this assumes you already have .NET Core and the .NET CLI installed - this script only bootstraps the Cake global tool, and runs it. Its primary use (for me) was with the .NET Core SDK Docker Alpine images. </p><pre class="language-powershell"><code class="language-powershell">
THIS_SCRIPT=`realpath <span class="token variable">$0</span>`
SCRIPT_DIR=`dirname <span class="token variable">$THIS_SCRIPT</span>`
TOOLS_DIR=<span class="token variable">$SCRIPT_DIR</span><span class="token operator">/</span>tools


SCRIPT=<span class="token string">"build.cake"</span>
CAKE_VERSION=<span class="token string">"0.33.0"</span>
CAKE_ARGUMENTS=<span class="token string">""</span><span class="token keyword">for</span> i in <span class="token string">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="684c28">[email&nbsp;protected]</a>"</span><span class="token punctuation">;</span><span class="token keyword">do</span>
    case <span class="token variable">$1</span> in
        <span class="token operator">-</span>s<span class="token punctuation">|</span><span class="token operator">--</span>script<span class="token punctuation">)</span> SCRIPT=<span class="token string">"<span class="token variable">$2</span>"</span><span class="token punctuation">;</span> shift <span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token operator">--</span>cake<span class="token operator">-</span>version<span class="token punctuation">)</span> CAKE_VERSION=<span class="token string">"--version=<span class="token variable">$2</span>"</span><span class="token punctuation">;</span> shift <span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token punctuation">)</span> shift<span class="token punctuation">;</span> CAKE_ARGUMENTS=<span class="token string">"${CAKE_ARGUMENTS} <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="527612">[email&nbsp;protected]</a>"</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token punctuation">)</span> CAKE_ARGUMENTS=<span class="token string">"${CAKE_ARGUMENTS} <span class="token variable">$1</span>"</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    esac
    shift
done

<span class="token keyword">if</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">-</span>d <span class="token string">"<span class="token variable">$TOOLS_DIR</span>"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> then
    mkdir <span class="token string">"<span class="token variable">$TOOLS_DIR</span>"</span>
fi

CAKE_PATH=<span class="token string">"<span class="token variable">$TOOLS_DIR</span>/dotnet-cake"</span>
CAKE_INSTALLED_VERSION=$<span class="token punctuation">(</span><span class="token variable">$CAKE_PATH</span><span class="token operator">--</span>version 2&gt;&amp;1<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">[</span><span class="token string">"<span class="token variable">$CAKE_VERSION</span>"</span><span class="token operator">!</span>= <span class="token string">"<span class="token variable">$CAKE_INSTALLED_VERSION</span>"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> then
    <span class="token keyword">if</span><span class="token punctuation">[</span><span class="token operator">-</span>f <span class="token string">"<span class="token variable">$CAKE_PATH</span>"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> then
        dotnet tool uninstall Cake<span class="token punctuation">.</span>Tool <span class="token operator">--</span>tool<span class="token operator">-</span>path <span class="token string">"<span class="token variable">$TOOLS_DIR</span>"</span>
    fi

    <span class="token function">echo</span><span class="token string">"Installing Cake <span class="token variable">$CAKE_VERSION</span>..."</span>
    dotnet tool install Cake<span class="token punctuation">.</span>Tool <span class="token operator">--</span>tool<span class="token operator">-</span>path <span class="token string">"<span class="token variable">$TOOLS_DIR</span>"</span><span class="token operator">--</span>version <span class="token variable">$CAKE_VERSION</span><span class="token keyword">if</span><span class="token punctuation">[</span> $? <span class="token operator">-ne</span> 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> then
        <span class="token function">echo</span><span class="token string">"An error occured while installing Cake."</span><span class="token keyword">exit</span> 1
    fi
fi



eval <span class="token string">"<span class="token variable">$CAKE_PATH</span>"</span><span class="token string">"<span class="token variable">$SCRIPT</span>"</span><span class="token string">"${CAKE_ARGUMENTS}"</span></code></pre><p>The script starts by checking the installed version of Cake.Tool (if any). If the correct version is not installed, it installs the global tool using <code>dotnet tool install</code>, providing a <code>--tool-path</code> to install the tool locally, instead of globally. After building the script arguments, it runs the tool! </p><h2 id="differences-to-the-bash-script" class="heading-with-anchor">Differences to the bash script<a href="#differences-to-the-bash-script"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>As I've already described, the need for this script arises from "bashisms" in <a href="/how-to-build-with-cake-on-linux-using-cake-coreclr-or-the-cake-global-tool/#building-on-linux-with-the-cake-global-tool">my previous bootstrapper script</a> (and <a href="https://github.com/cake-build/cake/blob/06e7983704/build.sh">other example scripts</a>). There are essentially three differences between the scripts:</p><ul><li>Getting the directory of the script being executed</li><li>Collating command line arguments into an array</li><li>Executing Cake using the provided arguments</li></ul><p>I'll briefly compare each of these below:</p><h3 id="getting-the-directory-of-the-script-being-executed" class="heading-with-anchor">Getting the directory of the script being executed<a href="#getting-the-directory-of-the-script-being-executed"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>In my original bash script, I used the <code>${BASH_SOURCE[0]}</code> variable, which contains the location of the script "in all scenarios":</p><pre class="language-bash"><code class="language-bash">SCRIPT_DIR<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cd</span><span class="token string">"$( dirname "</span>$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">}</span>" <span class="token variable">)</span></span>" <span class="token operator">&amp;&amp;</span><span class="token function">pwd</span><span class="token punctuation">)</span></code></pre><p>This is (unsurprisingly) bash-specific, so, after a lot of searching, I used a different approach for the ash shell:</p><pre class="language-bash"><code class="language-bash">THIS_SCRIPT<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>realpath $0<span class="token variable">`</span></span>
SCRIPT_DIR<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">dirname</span> $THIS_SCRIPT<span class="token variable">`</span></span></code></pre><p>There were a <em>lot</em> of different ways to do this suggested, some of which required additional tools not available in ash by default, but this one seemed to work. As far as I can see, <a href="https://stackoverflow.com/questions/29832037/how-to-get-script-directory-in-posix-sh/29835459#29835459">the following should also work</a> for our purposes, which is a more direct analogue. I don't know which is "better" or more idiomatic though! 🤷 </p><pre class="language-bash"><code class="language-bash">SCRIPT_DIR<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>CDPATH<span class="token operator">=</span><span class="token function">cd</span> -- <span class="token string">"$(dirname -- "</span>$0"<span class="token variable">)</span></span>" <span class="token operator">&amp;&amp;</span> pwd<span class="token punctuation">)</span></code></pre><h2 id="collating-command-line-arguments-into-an-array" class="heading-with-anchor">Collating command line arguments into an array<a href="#collating-command-line-arguments-into-an-array"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The next difference occurs where we're parsing the arguments passed to the script. We want to extract specific arguments like the <code>--cake-version</code> and <code>--script</code>, and collect all the other arguments for passing to the Cake invocation later. </p><p>In bash, we can use an array to hold those arguments, extract the special values, and append the other arguments to the array:</p><pre class="language-bash"><code class="language-bash">
CAKE_ARGUMENTS<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span><span class="token string">"<span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dafe9a">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token keyword">case</span><span class="token variable">$1</span><span class="token keyword">in</span>
        -s<span class="token operator">|</span>--script<span class="token punctuation">)</span> SCRIPT<span class="token operator">=</span><span class="token string">"<span class="token variable">$2</span>"</span><span class="token punctuation">;</span><span class="token function">shift</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        --cake-version<span class="token punctuation">)</span> CAKE_VERSION<span class="token operator">=</span><span class="token string">"--version=<span class="token variable">$2</span>"</span><span class="token punctuation">;</span><span class="token function">shift</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        --<span class="token punctuation">)</span><span class="token function">shift</span><span class="token punctuation">;</span> CAKE_ARGUMENTS+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"<span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="604420">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        *<span class="token punctuation">)</span> CAKE_ARGUMENTS+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"<span class="token variable">$1</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    esac
    <span class="token function">shift</span><span class="token keyword">done</span></code></pre><p>Unfortunately, we can't use arrays like this in ash. The easiest approach I could find to "simulate" an array was to use a space-separated string:</p><pre class="language-bash"><code class="language-bash">
CAKE_ARGUMENTS<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">for</span> i <span class="token keyword">in</span><span class="token string">"<span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a682e6">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">;</span><span class="token keyword">do</span><span class="token keyword">case</span><span class="token variable">$1</span><span class="token keyword">in</span>
        -s<span class="token operator">|</span>--script<span class="token punctuation">)</span> SCRIPT<span class="token operator">=</span><span class="token string">"<span class="token variable">$2</span>"</span><span class="token punctuation">;</span><span class="token function">shift</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        --cake-version<span class="token punctuation">)</span> CAKE_VERSION<span class="token operator">=</span><span class="token string">"--version=<span class="token variable">$2</span>"</span><span class="token punctuation">;</span><span class="token function">shift</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        --<span class="token punctuation">)</span><span class="token function">shift</span><span class="token punctuation">;</span> CAKE_ARGUMENTS<span class="token operator">=</span><span class="token string">"<span class="token variable">${CAKE_ARGUMENTS}</span><span class="token variable"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="301470">[email&nbsp;protected]</a></span>"</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        *<span class="token punctuation">)</span> CAKE_ARGUMENTS<span class="token operator">=</span><span class="token string">"<span class="token variable">${CAKE_ARGUMENTS}</span><span class="token variable">$1</span>"</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    esac
    <span class="token function">shift</span><span class="token keyword">done</span></code></pre><p>This approach is almost certainly not quite right, but I've found it worked fine for my attempts. I <em>haven't</em> tested it with arguments that contain spaces, or quote marks, so your mileage may vary!</p><h2 id="executing-cake-using-the-provided-arguments" class="heading-with-anchor">Executing Cake using the provided arguments<a href="#executing-cake-using-the-provided-arguments"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>This is the part of the script that I'm sure highlights that I don't really know what I'm doing… </p><p>In the bash version of the script, we can invoke Cake using <code>exec</code>, and output all of the values stored in the args array using <code>[@]</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token function">exec</span><span class="token string">"<span class="token variable">$CAKE_PATH</span>"</span><span class="token string">"<span class="token variable">$SCRIPT</span>"</span><span class="token string">"<span class="token variable">${CAKE_ARGUMENTS[@]}</span>"</span></code></pre><p>Unfortunately, if we try to use <code>exec</code> with our space-separated argument list in ash, we won't invoke Cake with <em>multiple</em> arguments, we invoke it with a <em>single</em> argument (that has lots of spaces in it!) I couldn't find a way to solve this issue, so I resorted to using <code>eval</code>. </p><pre class="language-bash"><code class="language-bash"><span class="token function">eval</span><span class="token string">"<span class="token variable">$CAKE_PATH</span>"</span><span class="token string">"<span class="token variable">$SCRIPT</span>"</span><span class="token string">"<span class="token variable">${CAKE_ARGUMENTS}</span>"</span></code></pre><p><code>eval</code> converts the provided arguments to a raw string, then executes it as though you'd written that directly. That works great for my requirements, but it can be dangerous, so is generally frowned upon. Again, it's fine for my purposes (running in Alpine Docker), but if you have a better (safer) alternative for achieving the same thing, do let me know!</p><h2 id="summary" class="heading-with-anchor">Summary<a href="#summary"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>In this post I show an Almquist shell (ash) bootstrapping script for running Cake build scripts using the Cake.Tool .NET Core global tool on Alpine Linux. The script is mostly similar to the bash bootstrapping scripts that I've provided previously, but avoids bashisms that prevent those scripts running on some shells. The script has a couple of issues (namely the use of <code>eval</code>) but it meets my needs, so hopefully it's useful for you too. </p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>