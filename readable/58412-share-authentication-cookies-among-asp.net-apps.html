<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Share authentication cookies among ASP.NET apps -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
            <h1>
                    <span style="cursor: default" title="linksfor.dev(s) has been running for 1 year! :partypopper:">ðŸŽ‰</span>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
            </h1>
        <div class="readable">
    <h1>Share authentication cookies among ASP.NET apps</h1>
    <p>
by Rick-Anderson <br />Reading time: 10-12 minutes    </p>
    <p><a href="https://docs.microsoft.com/en-gb/aspnet/core/security/cookie-sharing?view=aspnetcore-3.1">https://docs.microsoft.com/en-gb/aspnet/core/security/cookie-sharing?view=aspnetcore-3.1</a></p>
    <hr/>
    <div id="readability-page-1" class="page">


	<div data-bi-name="body">

		<div>

			

			<section>
				<div>


				<div id="main-column">

					<main id="main" role="main" data-bi-name="content" lang="en-us" dir="ltr">



						

						<ul data-bi-name="page info" lang="en-gb" dir="ltr">
							<li>
								<time role="presentation" datetime="2019-09-05T00:00:00.000Z" data-article-date-source="ms.date">05/09/2019</time>
							</li>
								<li>5 minutes to read</li>
							<li>
								<a href="https://github.com/aspnet/AspNetCore.Docs/blob/master/aspnetcore/security/cookie-sharing.md" title="6 Contributors" aria-label="6 Contributors">
									
								</a>
							</li>

						</ul>

						<nav id="center-doc-outline" data-bi-name="intopic toc" role="navigation" aria-label="Article outline">
							<h3>In this article</h3>
						<ol><li><a href="#share-authentication-cookies-with-aspnet-core-identity">Share authentication cookies with ASP.NET Core Identity</a></li><li><a href="#share-authentication-cookies-without-aspnet-core-identity">Share authentication cookies without ASP.NET Core Identity</a></li><li><a href="#share-cookies-across-different-base-paths">Share cookies across different base paths</a></li><li><a href="#share-cookies-across-subdomains">Share cookies across subdomains</a></li><li><a href="#encrypt-data-protection-keys-at-rest">Encrypt data protection keys at rest</a></li><li><a href="#share-authentication-cookies-between-aspnet-4x-and-aspnet-core-apps">Share authentication cookies between ASP.NET 4.x and ASP.NET Core apps</a></li><li><a href="#use-a-common-user-database">Use a common user database</a></li><li><a href="#additional-resources">Additional resources</a></li></ol></nav>


						<!-- <content> -->
							
<p>By <a href="https://twitter.com/RickAndMSFT" data-linktype="external">Rick Anderson</a> and <a href="https://github.com/guardrex" data-linktype="external">Luke Latham</a></p>
<p>Websites often consist of individual web apps working together. To provide a single sign-on (SSO) experience, web apps within a site must share authentication cookies. To support this scenario, the data protection stack allows sharing Katana cookie authentication and ASP.NET Core cookie authentication tickets.</p>
<p>In the examples that follow:</p>
<ul>
<li>The authentication cookie name is set to a common value of <code>.AspNet.SharedCookie</code>.</li>
<li>The <code>AuthenticationType</code> is set to <code>Identity.Application</code> either explicitly or by default.</li>
<li>A common app name is used to enable the data protection system to share data protection keys (<code>SharedCookieApp</code>).</li>
<li><code>Identity.Application</code> is used as the authentication scheme. Whatever scheme is used, it must be used consistently <em>within and across</em> the shared cookie apps either as the default scheme or by explicitly setting it. The scheme is used when encrypting and decrypting cookies, so a consistent scheme must be used across apps.</li>
<li>A common <a href="https://docs.microsoft.com/en-gb/aspnet/core/security/data-protection/implementation/key-management?view=aspnetcore-3.1" data-linktype="relative-path">data protection key</a> storage location is used.
<ul>
<li>In ASP.NET Core apps, <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.dataprotection.dataprotectionbuilderextensions.persistkeystofilesystem" data-linktype="absolute-path">PersistKeysToFileSystem</a> is used to set the key storage location.</li>
<li>In .NET Framework apps, Cookie Authentication Middleware uses an implementation of <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.dataprotection.dataprotectionprovider" data-linktype="absolute-path">DataProtectionProvider</a>. <code>DataProtectionProvider</code> provides data protection services for the encryption and decryption of authentication cookie payload data. The <code>DataProtectionProvider</code> instance is isolated from the data protection system used by other parts of the app. <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.dataprotection.dataprotectionprovider.create" data-linktype="absolute-path">DataProtectionProvider.Create(System.IO.DirectoryInfo, Action&lt;IDataProtectionBuilder&gt;)</a> accepts a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.directoryinfo" data-linktype="absolute-path">DirectoryInfo</a> to specify the location for data protection key storage.</li>
</ul>
</li>
<li><code>DataProtectionProvider</code> requires the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Extensions/" data-linktype="external">Microsoft.AspNetCore.DataProtection.Extensions</a> NuGet package:
<ul>
<li>In ASP.NET Core 2.x apps, reference the <a href="https://docs.microsoft.com/en-gb/aspnet/core/fundamentals/metapackage-app?view=aspnetcore-3.1" data-linktype="relative-path">Microsoft.AspNetCore.App metapackage</a>.</li>
<li>In .NET Framework apps, add a package reference to <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.DataProtection.Extensions/" data-linktype="external">Microsoft.AspNetCore.DataProtection.Extensions</a>.</li>
</ul>
</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.dataprotection.dataprotectionbuilderextensions.setapplicationname" data-linktype="absolute-path">SetApplicationName</a> sets the common app name.</li>
</ul>

<p>When using ASP.NET Core Identity:</p>
<ul>
<li>Data protection keys and the app name must be shared among apps. A common key storage location is provided to the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.dataprotection.dataprotectionbuilderextensions.persistkeystofilesystem" data-linktype="absolute-path">PersistKeysToFileSystem</a> method in the following examples. Use <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.dataprotection.dataprotectionbuilderextensions.setapplicationname" data-linktype="absolute-path">SetApplicationName</a> to configure a common shared app name (<code>SharedCookieApp</code> in the following examples). For more information, see <a href="https://docs.microsoft.com/en-gb/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-3.1" data-linktype="relative-path">Configure ASP.NET Core Data Protection</a>.</li>
<li>Use the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.identityservicecollectionextensions.configureapplicationcookie" data-linktype="absolute-path">ConfigureApplicationCookie</a> extension method to set up the data protection service for cookies.</li>
<li>The default authentication type is <code>Identity.Application</code>.</li>
</ul>
<p>In <code>Startup.ConfigureServices</code>:</p>
<pre tabindex="0"><code data-author-content="services.AddDataProtection()
    .PersistKeysToFileSystem(&quot;{PATH TO COMMON KEY RING FOLDER}&quot;)
    .SetApplicationName(&quot;SharedCookieApp&quot;);

services.ConfigureApplicationCookie(options => {
    options.Cookie.Name = &quot;.AspNet.SharedCookie&quot;;
});
"><span>services.AddDataProtection()
    .PersistKeysToFileSystem(<span>"{PATH TO COMMON KEY RING FOLDER}"</span>)
    .SetApplicationName(<span>"SharedCookieApp"</span>);

services.ConfigureApplicationCookie(options =&gt; {
    options.Cookie.Name = <span>".AspNet.SharedCookie"</span>;
});
</span></code></pre>

<p>When using cookies directly without ASP.NET Core Identity, configure data protection and authentication in <code>Startup.ConfigureServices</code>. In the following example, the authentication type is set to <code>Identity.Application</code>:</p>
<pre tabindex="0"><code data-author-content="services.AddDataProtection()
    .PersistKeysToFileSystem(&quot;{PATH TO COMMON KEY RING FOLDER}&quot;)
    .SetApplicationName(&quot;SharedCookieApp&quot;);

services.AddAuthentication(&quot;Identity.Application&quot;)
    .AddCookie(&quot;Identity.Application&quot;, options =>
    {
        options.Cookie.Name = &quot;.AspNet.SharedCookie&quot;;
    });
"><span>services.AddDataProtection()
    .PersistKeysToFileSystem(<span>"{PATH TO COMMON KEY RING FOLDER}"</span>)
    .SetApplicationName(<span>"SharedCookieApp"</span>);

services.AddAuthentication(<span>"Identity.Application"</span>)
    .AddCookie(<span>"Identity.Application"</span>, options =&gt;
    {
        options.Cookie.Name = <span>".AspNet.SharedCookie"</span>;
    });
</span></code></pre>

<p>An authentication cookie uses the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest.pathbase#Microsoft_AspNetCore_Http_HttpRequest_PathBase" data-linktype="absolute-path">HttpRequest.PathBase</a> as its default <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.cookiebuilder.path#Microsoft_AspNetCore_Http_CookieBuilder_Path" data-linktype="absolute-path">Cookie.Path</a>. If the app's cookie must be shared across different base paths, <code>Path</code> must be overridden:</p>
<pre tabindex="0"><code data-author-content="services.AddDataProtection()
    .PersistKeysToFileSystem(&quot;{PATH TO COMMON KEY RING FOLDER}&quot;)
    .SetApplicationName(&quot;SharedCookieApp&quot;);

services.ConfigureApplicationCookie(options => {
    options.Cookie.Name = &quot;.AspNet.SharedCookie&quot;;
    options.Cookie.Path = &quot;/&quot;;
});
"><span>services.AddDataProtection()
    .PersistKeysToFileSystem(<span>"{PATH TO COMMON KEY RING FOLDER}"</span>)
    .SetApplicationName(<span>"SharedCookieApp"</span>);

services.ConfigureApplicationCookie(options =&gt; {
    options.Cookie.Name = <span>".AspNet.SharedCookie"</span>;
    options.Cookie.Path = <span>"/"</span>;
});
</span></code></pre>

<p>When hosting apps that share cookies across subdomains, specify a common domain in the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.cookiebuilder.domain#Microsoft_AspNetCore_Http_CookieBuilder_Domain" data-linktype="absolute-path">Cookie.Domain</a> property. To share cookies across apps at <code>contoso.com</code>, such as <code>first_subdomain.contoso.com</code> and <code>second_subdomain.contoso.com</code>, specify the <code>Cookie.Domain</code> as <code>.contoso.com</code>:</p>
<pre tabindex="0"><code data-author-content="options.Cookie.Domain = &quot;.contoso.com&quot;;
"><span>options.Cookie.Domain = <span>".contoso.com"</span>;
</span></code></pre>
<h2 id="encrypt-data-protection-keys-at-rest">Encrypt data protection keys at rest<a href="#encrypt-data-protection-keys-at-rest" aria-labelledby="encrypt-data-protection-keys-at-rest"></a></h2>
<p>For production deployments, configure the <code>DataProtectionProvider</code> to encrypt keys at rest with DPAPI or an X509Certificate. For more information, see <a href="https://docs.microsoft.com/en-gb/aspnet/core/security/data-protection/implementation/key-encryption-at-rest?view=aspnetcore-3.1" data-linktype="relative-path">Key encryption At rest in ASP.NET Core</a>. In the following example, a certificate thumbprint is provided to <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.dataprotection.dataprotectionbuilderextensions.protectkeyswithcertificate" data-linktype="absolute-path">ProtectKeysWithCertificate</a>:</p>
<pre tabindex="0"><code data-author-content="services.AddDataProtection()
    .ProtectKeysWithCertificate(&quot;{CERTIFICATE THUMBPRINT}&quot;);
"><span>services.AddDataProtection()
    .ProtectKeysWithCertificate(<span>"{CERTIFICATE THUMBPRINT}"</span>);
</span></code></pre>

<p>ASP.NET 4.x apps that use Katana Cookie Authentication Middleware can be configured to generate authentication cookies that are compatible with the ASP.NET Core Cookie Authentication Middleware. This allows upgrading a large site's individual apps in several steps while providing a smooth SSO experience across the site.</p>
<p>When an app uses Katana Cookie Authentication Middleware, it calls <code>UseCookieAuthentication</code> in the project's <em>Startup.Auth.cs</em> file. ASP.NET 4.x web app projects created with Visual Studio 2013 and later use the Katana Cookie Authentication Middleware by default. Although <code>UseCookieAuthentication</code> is obsolete and unsupported for ASP.NET Core apps, calling <code>UseCookieAuthentication</code> in an ASP.NET 4.x app that uses Katana Cookie Authentication Middleware is valid.</p>
<p>An ASP.NET 4.x app must target .NET Framework 4.5.1 or later. Otherwise, the necessary NuGet packages fail to install.</p>
<p>To share authentication cookies between an ASP.NET 4.x app and an ASP.NET Core app, configure the ASP.NET Core app as stated in the <a href="#share-authentication-cookies-with-aspnet-core-identity" data-linktype="self-bookmark">Share authentication cookies among ASP.NET Core apps</a> section, then configure the ASP.NET 4.x app as follows.</p>
<p>Confirm that the app's packages are updated to the latest releases. Install the <a href="https://www.nuget.org/packages/Microsoft.Owin.Security.Interop/" data-linktype="external">Microsoft.Owin.Security.Interop</a> package into each ASP.NET 4.x app.</p>
<p>Locate and modify the call to <code>UseCookieAuthentication</code>:</p>
<ul>
<li>Change the cookie name to match the name used by the ASP.NET Core Cookie Authentication Middleware (<code>.AspNet.SharedCookie</code> in the example).</li>
<li>In the following example, the authentication type is set to <code>Identity.Application</code>.</li>
<li>Provide an instance of a <code>DataProtectionProvider</code> initialized to the common data protection key storage location.</li>
<li>Confirm that the app name is set to the common app name used by all apps that share authentication cookies (<code>SharedCookieApp</code> in the example).</li>
</ul>
<p>If not setting <code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier</code> and <code>http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider</code>, set <a href="https://docs.microsoft.com/en-us/dotnet/api/system.web.helpers.antiforgeryconfig.uniqueclaimtypeidentifier#System_Web_Helpers_AntiForgeryConfig_UniqueClaimTypeIdentifier" data-linktype="absolute-path">UniqueClaimTypeIdentifier</a> to a claim that distinguishes unique users.</p>
<p><em>App_Start/Startup.Auth.cs</em>:</p>
<pre tabindex="0"><code data-author-content="app.UseCookieAuthentication(new CookieAuthenticationOptions
{
    AuthenticationType = &quot;Identity.Application&quot;,
    CookieName = &quot;.AspNet.SharedCookie&quot;,
    LoginPath = new PathString(&quot;/Account/Login&quot;),
    Provider = new CookieAuthenticationProvider
    {
        OnValidateIdentity =
            SecurityStampValidator
                .OnValidateIdentity<ApplicationUserManager, ApplicationUser>(
                    validateInterval: TimeSpan.FromMinutes(30),
                    regenerateIdentity: (manager, user) =>
                        user.GenerateUserIdentityAsync(manager))
    },
    TicketDataFormat = new AspNetTicketDataFormat(
        new DataProtectorShim(
            DataProtectionProvider.Create(&quot;{PATH TO COMMON KEY RING FOLDER}&quot;,
                (builder) => { builder.SetApplicationName(&quot;SharedCookieApp&quot;); })
            .CreateProtector(
                &quot;Microsoft.AspNetCore.Authentication.Cookies.&quot; +
                    &quot;CookieAuthenticationMiddleware&quot;,
                &quot;Identity.Application&quot;,
                &quot;v2&quot;))),
    CookieManager = new ChunkingCookieManager()
});

System.Web.Helpers.AntiForgeryConfig.UniqueClaimTypeIdentifier =
    &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name&quot;;
"><span>app.UseCookieAuthentication(<span>new</span> CookieAuthenticationOptions
{
    AuthenticationType = <span>"Identity.Application"</span>,
    CookieName = <span>".AspNet.SharedCookie"</span>,
    LoginPath = <span>new</span> PathString(<span>"/Account/Login"</span>),
    Provider = <span>new</span> CookieAuthenticationProvider
    {
        OnValidateIdentity =
            SecurityStampValidator
                .OnValidateIdentity&lt;ApplicationUserManager, ApplicationUser&gt;(
                    validateInterval: TimeSpan.FromMinutes(<span>30</span>),
                    regenerateIdentity: (manager, user) =&gt;
                        user.GenerateUserIdentityAsync(manager))
    },
    TicketDataFormat = <span>new</span> AspNetTicketDataFormat(
        <span>new</span> DataProtectorShim(
            DataProtectionProvider.Create(<span>"{PATH TO COMMON KEY RING FOLDER}"</span>,
                (builder) =&gt; { builder.SetApplicationName(<span>"SharedCookieApp"</span>); })
            .CreateProtector(
                <span>"Microsoft.AspNetCore.Authentication.Cookies."</span> +
                    <span>"CookieAuthenticationMiddleware"</span>,
                <span>"Identity.Application"</span>,
                <span>"v2"</span>))),
    CookieManager = <span>new</span> ChunkingCookieManager()
});

System.Web.Helpers.AntiForgeryConfig.UniqueClaimTypeIdentifier =
    <span>"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"</span>;
</span></code></pre>
<p>When generating a user identity, the authentication type (<code>Identity.Application</code>) must match the type defined in <code>AuthenticationType</code> set with <code>UseCookieAuthentication</code> in <em>App_Start/Startup.Auth.cs</em>.</p>
<p><em>Models/IdentityModels.cs</em>:</p>
<pre tabindex="0"><code data-author-content="public class ApplicationUser : IdentityUser
{
    public async Task<ClaimsIdentity> GenerateUserIdentityAsync(
        UserManager<ApplicationUser> manager)
    {
        // The authenticationType must match the one defined in 
        // CookieAuthenticationOptions.AuthenticationType
        var userIdentity = 
            await manager.CreateIdentityAsync(this, &quot;Identity.Application&quot;);

        // Add custom user claims here

        return userIdentity;
    }
}
"><span><span>public</span> <span>class</span> <span>ApplicationUser</span> : <span>IdentityUser</span>
{
    <span><span>public</span> <span>async</span> Task&lt;ClaimsIdentity&gt; <span>GenerateUserIdentityAsync</span>(<span>
        UserManager&lt;ApplicationUser&gt; manager</span>)</span>
    {
        <span>// The authenticationType must match the one defined in </span>
        <span>// CookieAuthenticationOptions.AuthenticationType</span>
        <span>var</span> userIdentity = 
            <span>await</span> manager.CreateIdentityAsync(<span>this</span>, <span>"Identity.Application"</span>);

        <span>// Add custom user claims here</span>

        <span>return</span> userIdentity;
    }
}
</span></code></pre>
<h2 id="use-a-common-user-database">Use a common user database<a href="#use-a-common-user-database" aria-labelledby="use-a-common-user-database"></a></h2>
<p>When apps use the same Identity schema (same version of Identity), confirm that the Identity system for each app is pointed at the same user database. Otherwise, the identity system produces failures at runtime when it attempts to match the information in the authentication cookie against the information in its database.</p>
<p>When the Identity schema is different among apps, usually because apps are using different Identity versions, sharing a common database based on the latest version of Identity isn't possible without remapping and adding columns in other app's Identity schemas. It's often more efficient to upgrade the other apps to use the latest Identity version so that a common database can be shared by the apps.</p>
<h2 id="additional-resources">Additional resources<a href="#additional-resources" aria-labelledby="additional-resources"></a></h2>
<ul>
<li><a href="https://docs.microsoft.com/en-gb/aspnet/core/host-and-deploy/web-farm?view=aspnetcore-3.1" data-linktype="relative-path">Host ASP.NET Core in a web farm</a></li>
</ul>

						<!-- </content> -->

						</main>

						<!-- recommended content page section -->

							<nav data-bi-name="recommendation-bottom" hidden="" id="recommended-content-center" aria-labelledby="recommended-content-center-title">
								<h3 id="recommended-content-center-title">Related Articles</h3>
							</nav>

						<!-- end recommended content page section -->

						<!-- rating mobile section -->
								
						<!-- end rating mobile section -->

						<!-- feedback section -->



<section data-bi-name="feedback-section">

	<h2 id="feedback">Feedback</h2>

	

	

	

	<div data-tab-group-independent="" hidden="" data-bi-name="tab-group">
		<ul role="tablist">
			<li role="presentation">
				<a href="#tabpanel-issues-open" role="tab" aria-controls="tabpanel-issues-open" data-tab="issues-open" data-bi-name="tab" aria-selected="true" tabindex="0"></a>
			</li>
			<li role="presentation">
				<a href="#tabpanel-issues-closed" role="tab" aria-controls="tabpanel-issues-closed" data-tab="issues-closed" data-bi-name="tab" aria-selected="false" tabindex="-1"></a>
			</li>
		</ul>
		<section id="tabpanel-issues-open" role="tabpanel" data-tab="issues-open">
			
			<ul aria-label="Open issues"></ul>
		</section>
		<section id="tabpanel-issues-closed" role="tabpanel" data-tab="issues-closed" hidden="hidden" aria-hidden="true">
			<div>There are no closed issues</div>
			<ul aria-label="Closed issues"></ul>
		</section>
	</div>
	
</section>

						<!-- end feedback section -->

						<!-- feedback report section -->
						<!-- end feedback report section -->

						
					</div>

					

					<!--end of div.columns -->
				</div>

			<!--end of .primary-holder -->
			</section>

			
		</div>

		<!--end of .mainContainer -->
	</div>

	

	

	


</div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
            _dna = window._dna || {};
            _dna.siteId = "linksfor.devs";
            _dna.outlink = true;

            (function () {
                let dna = document.createElement('script');
                dna.type = 'text/javascript';
                dna.async = true;
                dna.src = '//dna.buildstarted.com/t.js';
                let s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(dna, s);
            })();
    </script>
</body>
</html>