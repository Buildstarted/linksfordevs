<!DOCTYPE html>
<html lang="en">
<head>
    <title>
How to expose your custom counters in .NET Core - Criteo R&amp;D Blog -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>How to expose your custom counters in .NET Core - Criteo R&amp;D Blog</h1><div><div class="ac ae af ag ah ea aj ak"><p id="9b32" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">This post of the series explains how to implement your own counters.</p><p id="4ce0" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Part 1: <a href="http://labs.criteo.com/2018/06/replace-net-performance-counters-by-clr-event-tracing" class="da by hc hd he hf" target="_blank" rel="noopener nofollow">Replace .NET performance counters by CLR event tracing</a>.</p><p id="76b6" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Part 2: <a href="http://labs.criteo.com/2018/07/grab-etw-session-providers-and-events/" class="da by hc hd he hf" target="_blank" rel="noopener nofollow">Grab ETW Session, Providers and Events</a>.</p><p id="3e14" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Part 3: <a href="http://labs.criteo.com/2018/09/monitor-finalizers-contention-and-threads-in-your-application/" class="da by hc hd he hf" target="_blank" rel="noopener nofollow">CLR Threading events with TraceEvent</a>.</p><p id="0601" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Part 4: <a class="da by hc hd he hf" target="_blank" rel="noopener" href="/criteo-labs/spying-on-net-garbage-collector-with-traceevent-f49dc3117de">Spying on .NET Garbage Collector with TraceEvent</a>.</p><p id="81a0" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Part 5: <a class="da by hc hd he hf" target="_blank" rel="noopener" href="/criteo-labs/c-building-your-own-java-like-gc-logs-in-net-992205fd8d4f">Building your own Java GC logs in .NET</a></p><p id="4de8" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Part 6: <a class="da by hc hd he hf" target="_blank" rel="noopener" href="/criteo-labs/spying-on-net-garbage-collector-with-net-core-eventpipes-9f2a986d5705">Spying on .NET Core Garbage Collector with .NET Core EventPipes</a></p><p id="bfe8" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Part 7: <a class="da by hc hd he hf" target="_blank" rel="noopener" href="/criteo-labs/net-core-counters-internals-how-to-integrate-counters-in-your-monitoring-pipeline-5354cd61b42e">.NET Core Counters internals: how to integrate counters in your monitoring pipeline</a></p><h1 id="29af" class="hg hh ed at as hi ef hj eh hk hl hm hn ho hp hq hr">Introduction</h1><p id="d50e" class="go gp ed at gq b gr hs gt ht gv hu gx hv gz hw hb dv">The<strong class="gq hx"> EventPipe</strong> counters are the .NET Core replacement for Windows performance counters. In the <a class="da by hc hd he hf" target="_blank" rel="noopener" href="/criteo-labs/net-core-counters-internals-how-to-integrate-counters-in-your-monitoring-pipeline-5354cd61b42e">previous post</a>, I’ve explained how to listen to CLR event pipes to get the counter’s value over time both on Windows and Linux. This post shows you how easy it is to provide your counters via the same infrastructure.</p><p id="70db" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">The example I’m using is based on a real-world case we had to investigate at Criteo. We needed to correlate request duration with garbage collections, so we decided to add new metrics to our testing dashboard: number and duration of requests but split between those processed without being interrupted by a GC and the others.</p><p id="9d95" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">For the sake of the ASP.NET Core code example, a <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-3.0" class="da by hc hd he hf" target="_blank" rel="noopener nofollow">dedicated middleware</a> is created: it simply measures the time spent to process a request and if the count of garbage collections has changed before and after the request is processed:</p><figure class="hy hz ia ib ic id"><p id="86b9" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">The interesting part is in the <code class="ii ij ik il im b">RequestCountersEventSource</code> implementation.</p><h1 id="6b22" class="hg hh ed at as hi ef hj eh hk hl hm hn ho hp hq hr">Use an EventSource Luke!</h1><p id="db4e" class="go gp ed at gq b gr hs gt ht gv hu gx hv gz hw hb dv">As explained in the previous post, an <code class="ii ij ik il im b">EventSource</code> instance is used as the “server” part of the <strong class="gq hx">EventPipe</strong> communication channel. It exposes a name that is used to identify it, but more important to listen to it with <strong class="gq hx">dotnet-trace</strong>, <strong class="gq hx">dotnet-counters,</strong> or your own listener as the <em class="in">provider</em> name.</p><figure class="hy hz ia ib ic id"><p id="5ea7" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">This name is exposed via an <code class="ii ij ik il im b">EventSourceAttribute</code> that decorates your <code class="ii ij ik il im b">EventSource</code>-derived class (you could also pass it to the constructor). The counters are created in the constructor through the <code class="ii ij ik il im b">CreateCounters</code> helper.</p><h1 id="8a1d" class="hg hh ed at as hi ef hj eh hk hl hm hn ho hp hq hr">Pick the right Counter class</h1><p id="9e2b" class="go gp ed at gq b gr hs gt ht gv hu gx hv gz hw hb dv">Before looking at the implementation of the <code class="ii ij ik il im b">CreateCounters</code> method, you need to understand what kind of counters are available for you. In the previous post, I mentioned that the CLR was using <em class="in">Mean</em> (that provides mean, max, and min values over the update interval) and <em class="in">Sum</em> (to increment a single value) kinds of counters. Note that dotnet-counter will only show the mean value for <em class="in">Mean</em> counters.</p><p>In addition, the counters could either automatically poll the value from a callback (the method used by the CLR today), or your code could change a counter value by calling the <code class="ii ij ik il im b">WriteMetric</code> method. The <code class="ii ij ik il im b">EventCounter</code> class provides this helper and it does its best to compute the min/max/mean in <a href="https://github.com/dotnet/coreclr/blob/master/src/System.Private.CoreLib/shared/System/Diagnostics/Tracing/EventCounter.cs#L144" class="da by hc hd he hf" target="_blank" rel="noopener nofollow">a lock-free way</a>.</p><figure class="hy hz ia ib ic id dm dn paragraph-image"><p id="69af" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">The next question to answer is which one should you use.</p><p id="bf51" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">In the case of the request with(out) GC example, I want to expose different metrics:</p><ul class=""><li id="64d1" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb jb jc jd"><em class="in">Request count</em>: a <code class="ii ij ik il im b">PollingCounter</code> will be used in addition to an int field incremented when a request is received.</li><li id="7664" class="go gp ed at gq b gr je gt jf gv jg gx jh gz ji hb jb jc jd"><em class="in">Request count delta</em>: an <code class="ii ij ik il im b">IncrementingCounter</code> associated with the same int value will provide the delta (i.e., number of requests processed during an interval)</li><li id="f84a" class="go gp ed at gq b gr je gt jf gv jg gx jh gz ji hb jb jc jd"><em class="in">Request with GC and without GC counts</em>: two <code class="ii ij ik il im b">PollingCounter</code> instances based on two int fields incremented when a request with (or without respectively) GC are processed.</li><li id="d115" class="go gp ed at gq b gr je gt jf gv jg gx jh gz ji hb jb jc jd"><em class="in">Duration of requests with and without GC</em>: two <code class="ii ij ik il im b">EventCounter</code> instances updated when requests are processed.</li></ul><p id="4a25" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Here is the implementation of<code class="ii ij ik il im b">CreateCounters</code>:</p><figure class="hy hz ia ib ic id"><p id="4ba7" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">The request processing code of the ASP.NET Core middleware is relying on the following helper methods to update the counters:</p><figure class="hy hz ia ib ic id"><p id="1c1c" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">And that’s it!</p><h1 id="ee08" class="hg hh ed at as hi ef hj eh hk hl hm hn ho hp hq hr">How to get these custom counters?</h1><p id="3118" class="go gp ed at gq b gr hs gt ht gv hu gx hv gz hw hb dv">The controller of the ASP.NET Core sample application is triggering (or not) garbage collections based on the parameters passed via the url:</p><figure class="hy hz ia ib ic id"><p id="c07d" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">As explained earlier, it is possible to see the counter values with <strong class="gq hx">dotnet-counters</strong> by using the event source name as a provider with the following command line:</p><p id="59e8" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">&gt; dotnet counters monitor -p &lt;pid&gt; <strong class="gq hx">Sample.RequestCounters</strong></p><p id="8866" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">Then if you trigger a few requests with and without GC, you should see the numbers change:</p><figure class="hy hz ia ib ic id dm dn paragraph-image"><p id="363b" class="go gp ed at gq b gr gs gt gu gv gw gx gy gz ha hb dv">The code available on <a href="https://github.com/chrisnas/ClrEvents" class="da by hc hd he hf" target="_blank" rel="noopener nofollow">Github</a> has been updated to provide the middleware and the event source classes that demonstrate how to expose custom .NET Core counters.</p></figure></figure></figure></figure></figure></figure></figure></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>