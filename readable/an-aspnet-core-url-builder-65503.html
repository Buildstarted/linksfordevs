<!DOCTYPE html>
<html lang="en">
<head>
    <title>
An ASP.NET Core URL Builder - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.min.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="An ASP.NET Core URL Builder - linksfor.dev(s)"/>
    <meta property="article:author" content="Mark Seemann"/>
    <meta property="og:description" content="A use case for the Immutable Fluent Builder design pattern variant."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://blog.ploeh.dk/2020/08/10/an-aspnet-core-url-builder/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1 style="margin: unset">
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - An ASP.NET Core URL Builder</title>
<div class="readable">
        <h1>An ASP.NET Core URL Builder</h1>
            <div>by Mark Seemann</div>
            <div>Reading time: 7-9 minutes</div>
        <div>Posted here: 11 Aug 2020</div>
        <p><a href="https://blog.ploeh.dk/2020/08/10/an-aspnet-core-url-builder/">https://blog.ploeh.dk/2020/08/10/an-aspnet-core-url-builder/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="post">
	<p>
		<em>A use case for the Immutable Fluent Builder design pattern variant.</em>
	</p>
	<p>
		The <a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms">Fluent Builder</a> design pattern is popular in object-oriented programming. Most programmers use the mutable variant, while I favour the immutable alternative. The advantages of Immutable Fluent Builders, however, may not be immediately clear.
		</p><blockquote>
			<p>
				"I never thought of someone reusing a configured builder (soulds like too big class/SRP violation)."
			</p>
			
		</blockquote><p>
		It inspires me when I encounter a differing perspective. Could I be wrong? Or did I fail to produce a compelling example?
	</p>
	<p>
		It's possible that I'm wrong, but in my <a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms">my recent article on Builder isomorphisms</a> I focused on the pattern variations themselves, to the point where a convincing example wasn't my top priority.
	</p>
	<p>
		I recently encountered a good use case for an Immutable Fluent Builder.
	</p>
	<h3 id="e2761ee2b9654ad982a2ec1a6264c76f">
		Build links <a href="#e2761ee2b9654ad982a2ec1a6264c76f" title="permalink">#</a>
	</h3>
	<p>
		I was developing a REST API and wanted to generate some links like these:
	</p>
	<pre>{
  "links": [
    {
      "rel": "urn:reservations",
      "href": "http://localhost:53568/reservations"
    },
    {
      "rel": "urn:year",
      "href": "http://localhost:53568/calendar/2020"
    },
    {
      "rel": "urn:month",
      "href": "http://localhost:53568/calendar/2020/7"
    },
    {
      "rel": "urn:day",
      "href": "http://localhost:53568/calendar/2020/7/7"
    }
  ]
}</pre>
	
	<p>
		As I recently described, <a href="https://blog.ploeh.dk/2020/08/03/using-the-nameof-c-keyword-with-aspnet-3-iurlhelper">the ASP.NET Core Action API is tricky</a>, and since there was some repetition, I was looking for a way to reduce the code duplication. At first I just thought I'd make a few private helper methods, but then it occurred to me that an Immutable Fluent Builder as an <a href="https://en.wikipedia.org/wiki/Adapter_pattern">Adapter</a> to the <a href="https://docs.microsoft.com/dotnet/api/microsoft.aspnetcore.mvc.urlhelperextensions.action">Action API</a> might offer a fertile alternative.
	</p>
	<h3 id="5adf09c648a54679b1b137776e4f1192">
		UrlBuilder class <a href="#5adf09c648a54679b1b137776e4f1192" title="permalink">#</a>
	</h3>
	<p>
		The various <code>Action</code> overloads all accept null arguments, so there's effectively no clear invariants to enforce on that dimension. While I wanted an Immutable Fluent Builder, I made all the fields nullable.
	</p>
	<pre><span>public</span>&nbsp;<span>sealed</span>&nbsp;<span>class</span>&nbsp;<span>UrlBuilder</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;action;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>string</span>?&nbsp;controller;
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>object</span>?&nbsp;values;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>UrlBuilder</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>private</span>&nbsp;<span>UrlBuilder</span>(<span>string</span>?&nbsp;action,&nbsp;<span>string</span>?&nbsp;controller,&nbsp;<span>object</span>?&nbsp;values)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.action&nbsp;=&nbsp;action;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.controller&nbsp;=&nbsp;controller;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>this</span>.values&nbsp;=&nbsp;values;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>//&nbsp;...</span></pre>
	
	<p>
		I also gave the <code>UrlBuilder</code> class a public constructor and a private copy constructor. That's the standard way I implement that pattern.
	</p>
	<p>
		Most of the modification methods are straightforward:
	</p>
	<pre><span>public</span>&nbsp;<span>UrlBuilder</span>&nbsp;WithAction(<span>string</span>&nbsp;newAction)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>UrlBuilder</span>(newAction,&nbsp;controller,&nbsp;values);
}
 
<span>public</span>&nbsp;<span>UrlBuilder</span>&nbsp;WithValues(<span>object</span>&nbsp;newValues)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>UrlBuilder</span>(action,&nbsp;controller,&nbsp;newValues);
}</pre>
	
	<p>
		I wanted to encapsulate <a href="https://blog.ploeh.dk/2020/08/03/using-the-nameof-c-keyword-with-aspnet-3-iurlhelper">the suffix-handling behaviour I recently described</a> in the appropriate method:
	</p>
	<pre><span>public</span>&nbsp;<span>UrlBuilder</span>&nbsp;WithController(<span>string</span>&nbsp;newController)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(newController&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>throw</span>&nbsp;<span>new</span>&nbsp;<span>ArgumentNullException</span>(<span>nameof</span>(newController));
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>const</span>&nbsp;<span>string</span>&nbsp;controllerSuffix&nbsp;=&nbsp;<span>"controller"</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;index&nbsp;=&nbsp;newController.LastIndexOf(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;controllerSuffix,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>StringComparison</span>.OrdinalIgnoreCase);
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(0&nbsp;&lt;=&nbsp;index)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newController&nbsp;=&nbsp;newController.Remove(index);
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>UrlBuilder</span>(action,&nbsp;newController,&nbsp;values);
}</pre>
	
	<p>
		The <code>WithController</code> method handles both the case where <code>newController</code> is suffixed by <code>"Controller"</code> and the case where it isn't. I also wrote unit tests to verify that the implementation works as intended.
	</p>
	<p>
		Finally, a Builder should have a method to build the desired object:
	</p>
	<pre><span>public</span>&nbsp;<span>Uri</span>&nbsp;BuildAbsolute(<span>IUrlHelper</span>&nbsp;url)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(url&nbsp;<span>is</span>&nbsp;<span>null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>throw</span>&nbsp;<span>new</span>&nbsp;<span>ArgumentNullException</span>(<span>nameof</span>(url));
 
&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;actionUrl&nbsp;=&nbsp;url.Action(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;controller,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url.ActionContext.HttpContext.Request.Scheme,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url.ActionContext.HttpContext.Request.Host.ToUriComponent());
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>Uri</span>(actionUrl);
}</pre>
	
	<p>
		One could imagine also defining a <code>BuildRelative</code> method, but I didn't need it.
	</p>
	<h3 id="bec08c507ce7475eb0038723c6f6f8a8">
		Generating links <a href="#bec08c507ce7475eb0038723c6f6f8a8" title="permalink">#</a>
	</h3>
	<p>
		Each of the objects shown above are represented by a simple Data Transfer Object:
	</p>
	<pre><span>public</span>&nbsp;<span>class</span>&nbsp;<span>LinkDto</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>string</span>?&nbsp;Rel&nbsp;{&nbsp;<span>get</span>;&nbsp;<span>set</span>;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>string</span>?&nbsp;Href&nbsp;{&nbsp;<span>get</span>;&nbsp;<span>set</span>;&nbsp;}
}</pre>
	
	<p>
		My next step was to define an extension method on <code>Uri</code>, so that I could turn a URL into a link:
	</p>
	<pre><span>internal</span>&nbsp;<span>static</span>&nbsp;<span>LinkDto</span>&nbsp;Link(<span>this</span>&nbsp;<span>Uri</span>&nbsp;uri,&nbsp;<span>string</span>&nbsp;rel)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>LinkDto</span>&nbsp;{&nbsp;Rel&nbsp;=&nbsp;rel,&nbsp;Href&nbsp;=&nbsp;uri.ToString()&nbsp;};
}</pre>
	
	<p>
		With that function I could now write code like this:
	</p>
	<pre><span>private</span>&nbsp;<span>LinkDto</span>&nbsp;CreateYearLink()
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>UrlBuilder</span>()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithAction(<span>nameof</span>(<span>CalendarController</span>.Get))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithController(<span>nameof</span>(<span>CalendarController</span>))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithValues(<span>new</span>&nbsp;{&nbsp;year&nbsp;=&nbsp;<span>DateTime</span>.Now.Year&nbsp;})
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.BuildAbsolute(Url)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Link(<span>"urn:year"</span>);
}</pre>
	
	<p>
		It's acceptable, but verbose. This only creates the <code>urn:year</code> link; to create the <code>urn:month</code> and <code>urn:day</code> links, I needed similar code. Only the <code>WithValues</code> method calls differed. The calls to <code>WithAction</code> and <code>WithController</code> were identical.
	</p>
	<h3 id="e003c737cf604f83bd61dfba8045754b">
		Shared Immutable Builder <a href="#e003c737cf604f83bd61dfba8045754b" title="permalink">#</a>
	</h3>
	<p>
		Since <code>UrlBuilder</code> is immutable, I can trivially define a shared instance:
	</p>
	<pre><span>private</span>&nbsp;<span>readonly</span>&nbsp;<span>static</span>&nbsp;<span>UrlBuilder</span>&nbsp;calendar&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span>new</span>&nbsp;<span>UrlBuilder</span>()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithAction(<span>nameof</span>(<span>CalendarController</span>.Get))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithController(<span>nameof</span>(<span>CalendarController</span>));</pre>
	
	<p>
		This enabled me to write more succinct methods for each of the relationship types:
	</p>
	<pre><span>internal</span>&nbsp;<span>static</span>&nbsp;<span>LinkDto</span>&nbsp;LinkToYear(<span>this</span>&nbsp;<span>IUrlHelper</span>&nbsp;url,&nbsp;<span>int</span>&nbsp;year)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;calendar.WithValues(<span>new</span>&nbsp;{&nbsp;year&nbsp;}).BuildAbsolute(url).Link(<span>"urn:year"</span>);
}
 
<span>internal</span>&nbsp;<span>static</span>&nbsp;<span>LinkDto</span>&nbsp;LinkToMonth(<span>this</span>&nbsp;<span>IUrlHelper</span>&nbsp;url,&nbsp;<span>int</span>&nbsp;year,&nbsp;<span>int</span>&nbsp;month)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;calendar.WithValues(<span>new</span>&nbsp;{&nbsp;year,&nbsp;month&nbsp;}).BuildAbsolute(url).Link(<span>"urn:month"</span>);
}
 
<span>internal</span>&nbsp;<span>static</span>&nbsp;<span>LinkDto</span>&nbsp;LinkToDay(<span>this</span>&nbsp;<span>IUrlHelper</span>&nbsp;url,&nbsp;<span>int</span>&nbsp;year,&nbsp;<span>int</span>&nbsp;month,&nbsp;<span>int</span>&nbsp;day)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;calendar.WithValues(<span>new</span>&nbsp;{&nbsp;year,&nbsp;month,&nbsp;day&nbsp;}).BuildAbsolute(url).Link(<span>"urn:day"</span>);
}</pre>
	
	<p>
		This is possible exactly because <code>UrlBuilder</code> is immutable. Had the Builder been mutable, such sharing would have created an <a href="https://en.wikipedia.org/wiki/Aliasing_(computing)">aliasing</a> bug, as I <a href="https://blog.ploeh.dk/2020/02/10/builder-isomorphisms">previously described</a>. Immutability enables reuse.
	</p>
	<h3 id="cc70ea76298547e893d883bcb9983f92">
		Conclusion <a href="#cc70ea76298547e893d883bcb9983f92" title="permalink">#</a>
	</h3>
	<p>
		I got my first taste of functional programming around 2010. Since then, when I'm not programming in <a href="https://fsharp.org/">F#</a> or <a href="https://www.haskell.org/">Haskell</a>, I've steadily worked on identifying good ways to enjoy the benefits of functional programming in C#.
	</p>
	<p>
		Immutability is a fairly low-hanging fruit. It requires more boilerplate code, but apart from that, it's easy to make classes immutable in C#, and Visual Studio has plenty of refactorings that make it easier.
	</p>
	<p>
		Immutability is one of those features you're unlikely to realise that you're missing. When it's not there, you work around it, but when it's there, it simplifies many tasks.
	</p>
	<p>
		The example you've seen in this article relates to the Fluent Builder pattern. At first glance, it seems as though a mutable Fluent Builder has the same capabilities as a corresponding Immutable Fluent Builder. You can, however, build upon shared Immutable Fluent Builders, which you can't with mutable Fluent Builders.
	</p>
</div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>