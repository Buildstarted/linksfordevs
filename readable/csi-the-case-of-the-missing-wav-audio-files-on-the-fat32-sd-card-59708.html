<!DOCTYPE html>
<html lang="en">
<head>
    <title>
CSI: The case of the missing WAV audio files on the FAT32 SD Card - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="CSI: The case of the missing WAV audio files on the FAT32 SD Card - linksfor.dev(s)"/>
    <meta property="article:author" content="Scott Hanselman"/>
    <meta property="og:description" content="Buckle up kids, as this is a tale. As you may know, I have a lovely podcast at https://hanselminutes.com. You should ..."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.hanselman.com/blog/CSITheCaseOfTheMissingWAVAudioFilesOnTheFAT32SDCard.aspx"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - CSI: The case of the missing WAV audio files on the FAT32 SD Card</title>
<div class="readable">
        <h1>CSI: The case of the missing WAV audio files on the FAT32 SD Card</h1>
            <div>by Scott Hanselman</div>
            <div>Reading time: 24-30 minutes</div>
        <div>Posted here: 16 Mar 2020</div>
        <p><a href="https://www.hanselman.com/blog/CSITheCaseOfTheMissingWAVAudioFilesOnTheFAT32SDCard.aspx">https://www.hanselman.com/blog/CSITheCaseOfTheMissingWAVAudioFilesOnTheFAT32SDCard.aspx</a></p>
        <hr/>
<div id="readability-page-1" class="page"><section>
	<section>
          
		<p><img title="Scott Hanselman and Altered Carbon's Chris Conner who plays Poe" alt="Scott Hanselman and Altered Carbon's Chris Conner who plays Poe" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/ETAta4nU4AAjWXp_c9d80fc2-3a10-4d8c-8d1e-a1d2fb474cfc.jpg" width="358" height="256">Buckle up kids, as this is a tale. As you may know, I have a lovely podcast at <a href="https://hanselminutes.com/">https://hanselminutes.com</a>. You should listen.</p> <p>Recently through an number of super cool random events I got the <a href="https://twitter.com/shanselman/status/1238539842020970496">opportunity to interview actor Chris Conner who plays Poe on Altered Carbon</a>. I'm a big fan of the show but especially Chris. You should watch the show because Poe is a joy and Chris owns every scene, and that's with a VERY strong cast.</p> <p>I usually do my interviews remotely for the podcast but I wanted to meet Chris and hang out in person so I used my local podcasting rig which consists <a href="https://amzn.to/2vqMQWG">of a Zoom H6 recorder</a>.</p> <p>I have <a href="https://amzn.to/2Wfqe6k">two Shure XLR mics</a>, a Mic stand, and <a href="https://amzn.to/2vqMQWG">the Zoom</a>. The Zoom H6 is a very well though of workhorse and I've used it many times before when recording shows. It's not rocket surgery but one should always test their things.</p> <p>I didn't want to take any chances to I picked up a <a href="https://amzn.to/2wUKEHe">5 pack of 32GIG high quality SD Cards</a>. I put a new one in the Zoom, the Zoom immediately recognized the SD Card so I did a local recording right there and played it back. Sounds good. I played it back locally on the Zoom and I could hear the recording from the Zoom's local speaker. It's recording the file in stereo, one side for each mic. Remember this for later.</p> <p>I went early to the meet and set up the whole recording setup. I hooked up a local monitor and tested again. Records and plays back locally. Cool. Chris shows up, we recorded a fantastic show, he's engaged and we're now besties and we go to Chipotle, talk shop, Sci-fi, acting, AIs, etc. Just a killer afternoon all around. </p> <p>I head home and pull out the SD Card and put it into the PC and I see this. I almost vomit. I get lightheaded. </p> <p><img title="Infinite folders recursing. They are empty." alt="Infinite folders recursing. They are empty." src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_92c9abb7-a5a4-4769-b14e-0fc0819717cf.png" width="750" height="727"></p> <p>I've been recording the show for over 730 episodes over 14 years and I've never lost a show. I do my homework - as should you. I'm reeling. Ok, breathe. Let's work the problem.</p> <p>Right click the drive, check properties. Breathe. This is a 32 gig drive, but Windows sees that it's <em>got 329 MB used</em>. 300ish megs is the size of a 30 minute long two channel WAV file. I know this because I've looked at 300 meg files for the last several hundred shows. Just like you might know roughly the size of a JPEG your camera makes. It's a thing you know.</p> <p><img title="A 32gig (really 29.1GB) drive with 329 MB used" alt="A 32gig (really 29.1GB) drive with 329 MB used" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_88f2a369-b99b-4250-96ba-7b99ce4be05a.png" width="506" height="216"></p> <p>Command line time. List the root directory. Empty. Check it again but "show all files," weird, there's a Mac folder there but maybe the SD Card was preformatted on a Mac.</p> <blockquote> <p><strong>Interesting Plot Point</strong> - I didn't format the SD card. I use it as it came out of the packaging from Amazon. It came preformatted and I accepted it. I tested it and it worked but I didn't "install my own carpet." I moved in to the house as-is.</p></blockquote> <p>What about a little "show me all folders from here down" action? Same as I saw in Windows Explorer. The root folder has another subfolder which is itself. It's folder "Inception" with <a href="https://inception.fandom.com/wiki/Kick">no Kick</a>!</p><pre>G:\&gt;dir /a<br>Volume in drive G has no label.<br>Volume Serial Number is 0403-0201<br>Directory of G:\<br>03/12/2020 12:29 PM &lt;DIR&gt;<br>03/13/2020 12:44 PM &lt;DIR&gt; System Volume Information<br>0 File(s) 0 bytes<br>2 Dir(s) 30,954,225,664 bytes free<br>G:\&gt;dir /s<br>Volume in drive G has no label.<br>Volume Serial Number is 0403-0201<br>Directory of G:\<br>03/12/2020 12:29 PM &lt;DIR&gt;<br>0 File(s) 0 bytes<br>Directory of G:\<br>03/12/2020 12:29 PM &lt;DIR&gt;<br>0 File(s) 0 bytes<br>IT GOES FOREVER</pre>
<p>Ok, the drive thinks there's data but I can't see it. I put the SD card back in the Zoom and try to play it back.</p>
<p><strong>The Zoom can see folders and files AND the interview itself. And the Zoom can play it back. </strong>The Zoom is an embedded device with an implementation of the FAT32 file system and it can read it, but Windows can't. Can Linux? Can a Mac?</p>
<p>Short answer. No.</p>
<blockquote>
<p><strong>Hacky Note: </strong>Since the Zoom can see and play the file and it has a headphone/monitor jack, I could always plug in an analog 1/8" headphone cable to a 1/4" input on my <a href="https://amzn.to/2WdVqCV">Peavy PV6 Mixer</a> and rescue the audio with some analog quality loss. Why don't I use the USB Audio out feature of the Zoom H6 and play the file back over a digital cable, you ask? Because the Zoom audio player doesn't support that. It supports three modes - SD Card Reader (which is a pass through to Windows and shows me the recursive directories and no files), an Audio pass-through which lets the Zoom look like an audio device to Windows but doesn't show the SD card as a drive or allow the SD Card to be played back over the digital interface, or its main mode where it's recording locally. </p></blockquote>
<h3>It's Forensics Time, Kids.</h3>
<p>We have an 32 SD Card - a disk drive as it were - that is standard FAT32 formatted, that has 300-400 megs of a two-channel (Chris and I had two mics) WAV file that was recorded locally by the Zoom H6&nbsp; audio reorder and I don't want too lose it or mess it up.</p>
<p>I need to take a byte for byte image of what's on the SD Card so I can poke and it and "virtually" mess with with it, change it, fix it, try again, without changing the physical.</p>
<p>"dd" is a command-line utility with a <a href="http://en.wikipedia.org/wiki/Dd_%28Unix%29">rich and storied history</a> going back 45 years. Even though it means "Data Definition" it'll always be "disk drive" I my head. </p>
<h3>How to clone a USB Drive or SD Card to an IMG file on Windows</h3>
<p>I have a copy of <a href="http://www.chrysocome.net/dd">dd for Windows</a> which lets me get a byte for byte stream/file that represents this SD Card. For example I could get an entire USD device:</p><pre>dd if=\\?\Device\Harddisk1\Partition0 of=c:\temp\usb2.img bs=1M --size --progress</pre>
<p>I need to know the Harddisk number and Partition number as you can see above. I usually use diskpart for this.</p><pre>&gt;diskpart<p>Microsoft DiskPart version 10.0.19041.1</p><p>Copyright (C) Microsoft Corporation.<br>On computer: IRONHEART</p><p>DISKPART&gt; list disk</p><p>  Disk ###  Status         Size     Free     Dyn  Gpt<br>  --------  -------------  -------  -------  ---  ---<br>  Disk 0    Online          476 GB      0 B        *<br>  Disk 1    Online         1863 GB      0 B        *<br>  Disk 2    Online         3725 GB      0 B<br>  Disk 3    Online         2794 GB      0 B        *<br>  Disk 8    Online           29 GB  3072 KB</p><p>DISKPART&gt; select disk 8</p><p>Disk 8 is now the selected disk.</p><p>DISKPART&gt; list part</p><p>  Partition ###  Type              Size     Offset<br>  -------------  ----------------  -------  -------<br>  Partition 1    Primary             29 GB  4096 KB</p></pre>
<p>Looks like it's Disk 8 Partition 1 on my system. Let's get it all before I panic.</p><pre>dd if=\\?\Device\Harddisk8\Partition1 of=c:\temp\ZOMG.img bs=1M --size --progress</pre>
<p>IF and OF are input file and output file, and I will do it for the whole size of the SD Card. It's likely overkill though as we'll see in a second.</p>
<p>This file ended up being totally massive and hard to work with. Remember I needed just the first 400ish megs? I'll chop of just that part.</p><pre>dd if=ZOMG.img of=SmallerZOMG.img bs=1M count=400</pre>
<p>What is this though? Remember it's an image of a File System. It just bytes in a file. It's not a WAV file or a THIS file or a THAT file. I mean, it is if we decide it is, but in fact, a way to think about it is that it's a mangled envelope that is dark when I peer inside it. We're gonna have to feel around and see if we can rebuild a sense of what the contents really are.</p>
<h3>Importing Raw Bytes from an IMG into Audition or Audacity</h3>
<p>Both Adobe Audition and Audacity are audio apps that have an "Import RAW Data" feature. However, I DO need to tell Audition how to interpret it. There's lots of WAV files out there. How many simples were there? 1 channel? 2 channel? 16 bit or 32 bit? Lots of questions.</p>
<p><img title="image" alt="image" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_81f455ca-51ee-417e-8316-1c35cea28cd3.png" width="350" height="236"></p>
<p>Can I just import this 4 gig byte array of a file system and get something?</p>
<p>Looks like something. You can see that the first part there is likely the start of the partition table, file system headers, etc. before audio data shows up. Here's importing as 2 channel.</p>
<p><img title="image" alt="image" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_36496ba8-2890-4831-b179-10ab924cc25e.png" width="640" height="450"></p>
<p>I can hear voices but they sound like chipmunks and aren't understandable. Something is "doubled." Sample rate? No, I double checked it.</p>
<p>Here's 1 channel raw data import even though I think it's two.</p>
<p><img title="Raw audio data 1 channel" alt="Raw audio data 1 channel" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_5691cc72-99d2-4db6-a62d-69a568e1aede.png" width="640" height="367"></p>
<p>Now THIS is interesting. I can hear audio at normal speed of us talking (after the preamble) BUT it's only a syllable at a time, and then a quieter version of the same syllable repeats. I don't want to (read: can't really) reassemble a 30 min interview from syllables, right?</p>
<p>Remember when I said that the Zoom H6 records a two channel file with one channel per mic? Not really. It records ONE FILE PER CHANNEL. A whateverL.wav and a whateverR.wav. I totally forgot! </p>
<p>This "one channel" file above is actually the bytes as they were laid down on disk, right? It's actually two files <em>written simultaneously</em>, a few kilobytes at a time, L,R,L,R,L,R. And here I am telling my sound software to treat this "byte for byte file system dump" as one file. It's two that were made at the same time. </p>
<p>It's like the <a href="https://villains.fandom.com/wiki/Brundlefly">Brundlefly</a>. How do I tease it apart? Well I can't treat the array as a raw file anymore, it's not. And I want (really don't have the energy yet) to write my own little app to effectively de-interlace this image. I also don't know if the segment size is perfectly reliable or if it varies as the Zoom recorded.</p>
<blockquote>
<p><strong>NOTE:</strong> Pete Brown has written about RIFF/WAV files from Sound Devices records having an incorrect FAT32 bit set. This isn't that, but it's in the same family and is worth noting if you ever have an issue with a <a href="https://github.com/Psychlist1972/Fix-SoundDevices-File-Corruption?WT.mc_id=-blog-scottha">Broadcast Wave File getting corrupted or looking encrypted</a>.</p></blockquote>
<p>Whole helping me work this issue, Pete Brown <a href="https://twitter.com/Pete_Brown/status/1238611297538920448">tweeted a hexdump</a> of the Directory Table so you can see the Zoom0001, Zoom0002, etc directories there in the image.</p>
<p><img title="Hexdump of FAT32 Directory Table shows that there ARE directories" alt="Hexdump of FAT32 Directory Table shows that there ARE directories" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/ETBuaFmWoAESqBU_cb8f95e5-75bc-44a8-b61a-34ba823970d1.png" width="640" height="219"></p>
<p>Let me move into Ubuntu on my Windows machine running WSL. Here I can run fdisk and get some sense of what this Image of the bad SD Card is. Remember also that I hacked off the first 0-400 Megs but this IMG file thinks it's a 32gig drive, because it is. It's just that's been aggressively truncated.</p><pre>$ fdisk -u -l SmallerZOMG.img<br>Disk SmallerZOMG.img: 400 MiB, 419430400 bytes, 819200 sectors<br>Units: sectors of 1 * 512 = 512 bytes<br>Sector size (logical/physical): 512 bytes / 512 bytes<br>I/O size (minimum/optimal): 512 bytes / 512 bytes<br>Disklabel type: dos<br>Disk identifier: 0x00000000<p>Device           Boot Start      End  Sectors  Size Id Type<br>SmallerZOMG.img1       8192 61157375 61149184 29.2G  c W95 FAT32 (LBA)</p></pre>
<p>Maybe I can "mount" this IMG? I make a folder on Ubuntu/WSL2 called ~/recovery. Yikes, ok there's nothing there. I can take the sector size 512 times the Start block of 8192 and use that as the offset.</p><pre>sudo mount -o loop,offset=4194304 SmallerShit.img recover/<br>$ cd recover/<br>$ ll<br>total 68<br>drwxr-xr-x  4 root  root  32768 Dec 31  1969  ./</pre>
<p>Ali Mosajjal <a href="https://twitter.com/_n0p_/status/1238654845717889025">thinks</a> perhaps "they re-wrote the FAT32 structure definition and didn't use a standard library and made a mistake," and Leandro Pereria <a href="https://twitter.com/lafp/status/1238656236523892737">postulates</a> "what could happen is that the LFN (long file name) checksum is invalid and they didn't bother filling in the 8.3 filename... so that complying implementations of VFAT tries to look at the fallback 8.3 name, it's all spaces and figures out "it's all padding, move along."</p>
<p>Ali suggested running <strong>dosfsck </strong>on the mounted image and you can see again that the files are there, but there's like 3 root entries? Note I've done a cat of /proc/mounts to see the loop that my img is mounted on so I can refer to it in the dosfsck command.</p><pre>$ sudo dosfsck -w -r -l -a -v -t /dev/loop3<br>fsck.fat 4.1 (2017-01-24)<br>Checking we can access the last sector of the filesystem<br>Boot sector contents:<br>System ID "        "<br>Media byte 0xf8 (hard disk)<br>       512 bytes per logical sector<br>     32768 bytes per cluster<br>      1458 reserved sectors<br>First FAT starts at byte 746496 (sector 1458)<br>         2 FATs, 32 bit entries<br>   3821056 bytes per FAT (= 7463 sectors)<br>Root directory start at cluster 2 (arbitrary size)<br>Data area starts at byte 8388608 (sector 16384)<br>    955200 data clusters (31299993600 bytes)<br>63 sectors/track, 255 heads<br>      8192 hidden sectors<br>  61149184 sectors total<br>Checking file /<br>Checking file /<br>Checking file /<br>Checking file /System Volume Information (SYSTEM~1)<br>Checking file /.<br>Checking file /..<br>Checking file /ZOOM0001<br>Checking file /ZOOM0002<br>Checking file /ZOOM0003<br>Checking file /ZOOM0001/.<br>Checking file /ZOOM0001/..<br>Checking file /ZOOM0001/ZOOM0001.hprj (ZOOM00~1.HPR)<br>Checking file /ZOOM0001/ZOOM0001_LR.WAV (ZOOM00~1.WAV)<br>Checking file /ZOOM0002/.<br>Checking file /ZOOM0002/..<br>Checking file /ZOOM0002/ZOOM0002.hprj (ZOOM00~1.HPR)<br>Checking file /ZOOM0002/ZOOM0002_Tr1.WAV (ZOOM00~1.WAV)<br>Checking file /ZOOM0002/ZOOM0002_Tr2.WAV (ZOOM00~2.WAV)<br>Checking file /ZOOM0003/.<br>Checking file /ZOOM0003/..<br>Checking file /ZOOM0003/ZOOM0003.hprj (ZOOM00~1.HPR)<br>Checking file /ZOOM0003/ZOOM0003_Tr1.WAV (ZOOM00~1.WAV)<br>Checking file /ZOOM0003/ZOOM0003_Tr2.WAV (ZOOM00~2.WAV)<br>Checking file /System Volume Information/.<br>Checking file /System Volume Information/..<br>Checking file /System Volume Information/WPSettings.dat (WPSETT~1.DAT)<br>Checking file /System Volume Information/ClientRecoveryPasswordRotation (CLIENT~1)<br>Checking file /System Volume Information/IndexerVolumeGuid (INDEXE~1)<br>Checking file /System Volume Information/AadRecoveryPasswordDelete (AADREC~1)<br>Checking file /System Volume Information/ClientRecoveryPasswordRotation/.<br>Checking file /System Volume Information/ClientRecoveryPasswordRotation/..<br>Checking file /System Volume Information/AadRecoveryPasswordDelete/.<br>Checking file /System Volume Information/AadRecoveryPasswordDelete/..<br>Checking for bad clusters.</pre>
<p>We can see&nbsp; them, but can't get at them with the vfat file system driver on Linux or with Windows.</p>
<p>The <a href="http://www.fysnet.net/win_dump.htm">DUMP.exe util as part of mtools for Windows</a> is amazing but I'm unable to figure out what is wrong in the FAT32 file table. I can run minfo on the Linux command land telling it to skip 8192 sectors in with the @@offset modifier:</p><pre>$ minfo -i ZOMG.img@@8192S<br>device information:<br>===================<br>filename="ZOMG.img"<br>sectors per track: 63<br>heads: 255<br>cylinders: 3807<p>mformat command line: mformat -T 61149184 -i ZOMG.img@@8192S  -h 255 -s 63 -H 8192 ::</p><p>bootsector information<br>======================<br>banner:"        "<br>sector size: 512 bytes<br>cluster size: 64 sectors<br>reserved (boot) sectors: 1458<br>fats: 2<br>max available root directory slots: 0<br>small size: 0 sectors<br>media descriptor byte: 0xf8<br>sectors per fat: 0<br>sectors per track: 63<br>heads: 255<br>hidden sectors: 8192<br>big size: 61149184 sectors<br>physical drive id: 0x80<br>reserved=0x0<br>dos4=0x29<br>serial number: 04030201<br>disk label="           "<br>disk type="FAT32   "<br>Big fatlen=7463<br>Extended flags=0x0000<br>FS version=0x0000<br>rootCluster=2<br>infoSector location=1<br>backup boot sector=6</p><p>Infosector:<br>signature=0x41615252<br>free clusters=944648<br>last allocated cluster=10551</p></pre>
<p>Ok, now we've found yet ANOTHER way to mount this corrupted file system. With mtools we'll use mdir to list the root directory. Note there is something wrong enough that I have to set mtools_skip_check=1 to ~/.mtoolsrc and continue.</p><pre>$ mdir -i ZOMG.img@@8192S ::<br>Total number of sectors (61149184) not a multiple of sectors per track (63)!<br>Add mtools_skip_check=1 to your .mtoolsrc file to skip this test<br>$ pico ~/.mtoolsrc<br>$ mdir -i ZOMG.img@@8192S ::<br> Volume in drive : is<br> Volume Serial Number is 0403-0201<br>Directory for ::/<p>             &lt;DIR&gt;     2020-03-12  12:29<br>        1 file                    0 bytes<br>                     30 954 225 664 bytes free</p></pre>
<p>Same result. I can run mdu and see just a few folders. Note the ZOOMxxxx ones are missing here</p><pre>$ mdu -i ZOMG.img@@8192S ::<br>::/System Volume Information/ClientRecoveryPasswordRotation 1<br>::/System Volume Information/AadRecoveryPasswordDelete 1<br>::/System Volume Information 5<br>::/ 6</pre>
<p>Now, ideally I want to achieve two things here. </p>
<ul>
<li>Know WHY it's broken and exactly WHAT is wrong. 
<ul>
<li>There's a nameless root directory here and I lack the patience and skill to manually hexdump and patch it.</li></ul>
</li><li>Be able to copy the files out "normally" by mounting the IMG and, well, copying them out.</li></ul>
<p><strong>UPDATE #1 </strong>- I'm back after a few minutes of thinking again. </p>
<p>If I use mmls from Sleuthkit, I can see this. </p><pre>$ mmls HolyShit.img<br>DOS Partition Table<br>Offset Sector: 0<br>Units are in 512-byte sectors<p>      Slot      Start        End          Length       Description<br>000:  Meta      0000000000   0000000000   0000000001   Primary Table (#0)<br>001:  -------   0000000000   0000008191   0000008192   Unallocated<br>002:  000:000   0000008192   0061157375   0061149184   Win95 FAT32 (0x0c)</p></pre>
<p>If I do the 512*8192 offset again and visualize the FAT32 table in Hexdump/xxd like this:</p><pre>xxd -seek 4194304 ZOMG.img  | more<br>00400000: eb00 9020 2020 2020 2020 2000 0240 b205  ...        ..@..<br>00400010: 0200 0000 00f8 0000 3f00 ff00 0020 0000  ........?.... ..<br>00400020: 0010 a503 271d 0000 0000 0000 0200 0000  ....'...........<br>00400030: 0100 0600 0000 0000 0000 0000 0000 0000  ................<br>00400040: 8000 2901 0203 0420 2020 2020 2020 2020  ..)....<br>00400050: 2020 4641 5433 3220 2020 0000 0000 0000    FAT32   ......<br>00400060: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>00400070: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>00400080: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>00400090: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>004000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>004000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>004000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</pre>
<p>I can see I seek'ed to the right spot, as the string FAT32 is just hanging out. Maybe I can clip out this table and visualize it in a better graphical tool.</p>
<p>I could grab a reasonable (read: arbitrary) chunk from this offset and put it in a very small manageable file:</p><pre>dd if=ZOMG.img ibs=1 skip=4194304 count=64000 &gt; another.img</pre>
<p>And then load it in <a href="http://www.fysnet.net/win_dump.htm">dump.exe on Windows which is really a heck of a tool</a>. It seems to be thinking thinking there's multiple FAT Root Entries (which might be why I'm seeing this weird ghost root). Note the "should be" parts as well.</p><pre>FAT Root Entry (non LFN) (0x00000000)<br>                  Name: ···     <br>             Extension:    <br>             Attribute: 0x00 <br>        FAT12:reserved: 02 40 B2 05 02 00 00 00 00 F8<br>        FAT32:reserved: 02<br>   FAT32:creation 10th: 0x40<br>   FAT32:creation time: 0x05B2<br>   FAT32:creation date: 0x0002<br>   FAT32:last accessed: 0x0000<br>FAT32:hi word start cluster: 0xF800<br>                  Time: 0x0000  (00:00:00) (hms) <br>                  Date: 0x003F  (1980/01/31) (ymd) <br>      Starting Cluster: 0x00FF (0xF80000FF)<br>             File Size: 8192<p>FAT Root Entry (non LFN) (0x00000020)<br>                  Name: ····'···<br>             Extension: ···<br>             Attribute: 0x00 <br>        FAT12:reserved: 02 00 00 00 01 00 06 00 00 00<br>        FAT32:reserved: 02<br>   FAT32:creation 10th: 0x00<br>   FAT32:creation time: 0x0000<br>   FAT32:creation date: 0x0001<br>   FAT32:last accessed: 0x0006<br>FAT32:hi word start cluster: 0x0000<br>                  Time: 0x0000  (00:00:00) (hms) <br>                  Date: 0x0000  (1980/00/00) (ymd) <br>      Starting Cluster: 0x0000 (0x00000000) &lt;--- should be 0x0002 or higher.<br>             File Size: 0</p><p>FAT Root Entry (non LFN) (0x00000040)<br>                  Name: ··)···· <br>             Extension:    <br>             Attribute: 0x20  Archive<br>        FAT12:reserved: 20 20 20 20 20 20 46 41 54 33<br>        FAT32:reserved: 20<br>   FAT32:creation 10th: 0x20<br>   FAT32:creation time: 0x2020<br>   FAT32:creation date: 0x2020<br>   FAT32:last accessed: 0x4146<br>FAT32:hi word start cluster: 0x3354<br>                  Time: 0x2032  (04:01:18) (hms) <br>                  Date: 0x2020  (1996/01/00) (ymd) <br>      Starting Cluster: 0x0000 (0x33540000)<br>             File Size: 0</p><p>FAT Root Entry (non LFN) (0x00000060)<br>                  Name: ········<br>             Extension: ···<br>             Attribute: 0x00 <br>        FAT12:reserved: 00 00 00 00 00 00 00 00 00 00<br>        FAT32:reserved: 00<br>   FAT32:creation 10th: 0x00<br>   FAT32:creation time: 0x0000<br>   FAT32:creation date: 0x0000<br>   FAT32:last accessed: 0x0000<br>FAT32:hi word start cluster: 0x0000<br>                  Time: 0x0000  (00:00:00) (hms) <br>                  Date: 0x0000  (1980/00/00) (ymd) <br>      Starting Cluster: 0x0000 (0x00000000) &lt;--- should be 0x0002 or higher.<br>             File Size: 0</p><p>FAT Root Entry (non LFN) (0x00000080)<br>                  Name: ········<br>             Extension: ···<br>             Attribute: 0x00 <br>        FAT12:reserved: 00 00 00 00 00 00 00 00 00 00<br>        FAT32:reserved: 00<br>   FAT32:creation 10th: 0x00<br>   FAT32:creation time: 0x0000<br>   FAT32:creation date: 0x0000<br>   FAT32:last accessed: 0x0000<br>FAT32:hi word start cluster: 0x0000<br>                  Time: 0x0000  (00:00:00) (hms) <br>                  Date: 0x0000  (1980/00/00) (ymd) <br>      Starting Cluster: 0x0000 (0x00000000) &lt;--- should be 0x0002 or higher.<br>             File Size: 0</p><p>FAT32 Info Block (0x00000000)<br>                   sig: 0x209000EB  (' ···') [1] &lt;--- should be 0x41615252.<br>              reserved:<br>00000004  20 20 20 20 20 20 20 00-02 40 B2 05 02 00 00 00     .........@......<br>00000014  00 F8 00 00 3F 00 FF 00-00 20 00 00 00 10 A5 03     ....?...........<br>00000024  27 1D 00 00 00 00 00 00-02 00 00 00 01 00 06 00     '...............<br>00000034  00 00 00 00 00 00 00 00-00 00 00 00 80 00 29 01     ..............).<br>00000044  02 03 04 20 20 20 20 20-20 20 20 20 20 20 46 41     ..............FA<br>00000054  54 33 32 20 20 20 00 00-00 00 00 00 00 00 00 00     T32.............</p></pre>
<p>The most confusing part is that the FAT32 signature - the magic number is always supposed to be 0x41615252. Google that. You'll see. It's <a href="https://wiki.osdev.org/FAT">a hardcoded signature</a> but maybe I've got the wrong offset and at that point all bets are off.</p>
<p>So do I have that? I can search a binary file for Hex values with a combo of xxd and grep. Note the byte swap:</p><pre>xxd another.img  | grep "6141"<br>00000200: 5252 6141 0000 0000 0000 0000 0000 0000  RRaA............<br>00000e00: 5252 6141 0000 0000 0000 0000 0000 0000  RRaA............</pre>
<p>Just before this is 55 AA which is the last two bytes of the 64 byte partition table. mm</p>
<p>Now do I have two FAT32 info blocks and three Root Entries? I'm lost. I want to dump the directory entries. </p>
<p>What does fsstat say about the Root Directory?</p><pre>File System Layout (in sectors)<br>Total Range: 0 - 61149183<br>* Reserved: 0 - 1457<br>** Boot Sector: 0<br>** FS Info Sector: 1<br>** Backup Boot Sector: 6<br>* FAT 0: 1458 - 8920<br>* FAT 1: 8921 - 16383<br>* Data Area: 16384 - 61149183<br>** Cluster Area: 16384 - 61149183<br>*** Root Directory: 16384 - 16447</pre>
<p>I'll update this part as I learn more. I'm exhausted. Someone will likely read this and be like "you dork, seek HERE" and there's the byte that's wrong in the file system. That LFN (long file name) has no short one, etc" and then I'll know.</p>
<p><strong>UPDATE #2: </strong></p>
<p>I <a href="https://twitter.com/_n0p_">skyped with Ali</a> and we think we know what's up. He suggested I format the SD Card, record the same 3 shows (two test WAVs and one actual one) and then make an image of the GOOD disk to remove variables. Smart guy! </p>
<p>We then took the first 12 megs or so of the GOOD.img and the BAD.img and piped them through xxd into HEX, then used Visual Studio Code to diff them.</p>
<p>We can now visualize on the left what a good directory structure looks like and the right what a bad one looks like. Seems like I do have two recursive root directories with a space for the name.</p><figure><a href="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_10.png"><img title="Bad directory structures" alt="Bad directory structures" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_thumb.png" width="999" height="542"></a></figure> 
<p>Now if we wanted we could manually rewrite a complete new directory entry and assign our orphaned files to it.</p>
<p>That's what I would do if I was hired to recover data.</p>
<h3>7zip all the things</h3>
<p>Here's where it gets weird and it got so weird that both Pete Brown and I were like, WELL. THAT'S AMAZING.</p>
<p>On a whim I right-clicked the IMG file and opened it in 7zip and saw this.</p><figure><img title="Opening an img in 7zip" alt="Opening an img in 7zip" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_651ac0a1-9fd8-42b7-84a7-1f299818300c.png" width="999" height="286"></figure> 
<p>See that directory there that's a nothing? A space? A something. It has no Short Name. It's an invalid entry but 7zip is cool with it. Let's go in. Watch the path and the \\. That's a path separator, nothing, and another path separator. That's not allowed or OK but again, 7zip is chill.</p><figure><img title="The recovered files" alt="The recovered files" src="https://www.hanselman.com/blog/content/binary/Windows-Live-Writer/d3d5d98e761e_F164/image_78fdccde-75e1-4d30-951b-42633ca00a7d.png" width="999" height="286"></figure> 
<p>I dragged the files out and they're fine! The day is saved.</p>
<p>The moral? There are a few I can see.</p>
<ul>
<li>Re-format the random SD cards you get from Amazon specifically on the device you're gonna use them. 
</li><li>FAT as a spec has a bunch of stuff that different "drivers" (Windows, VFAT, etc) may ignore or elide over or just not implement. 
</li><li>I've got 85% of the knowledge I need to spelunk something like this but that last 15% is a brick wall. I would need more patience and to <a href="https://forensicblog.org/recovering-a-fat-filesystem-directory-entry-in-five-phases/">read more about this</a>. 
</li><li>Knowing how to do this is useful for any engineer. It's the equivalent of knowing how to drive a stick shift in an emergency even if you usually use Lyft. 
<ul>
<li>I'm clearly not an expert but I do have a mental model that includes (but not limited to) bytes on the physical media, the file system itself, file tables, directory tables, partition tables, how they kinda work on Linux and Windows. 
</li><li>I clearly hit a wall as I know what I want to do but I'm not sure the next step. 
<ul>
<li>There's a bad Directory Table Entry. I want to rename it and make sure it's complete and to spec.</li></ul></li></ul>
</li><li>7zip is amazing. Try it first for basically everything. </li></ul>
<p>Ideally I'd be able to update this post with exactly what byte is wrong and how to fix it. Thanks to <a href="https://twitter.com/shanselman/status/1238607342989537280">Ali, Pete, and Leandro</a> for playing with me!</p>
<ul>
</ul>
<p>Your thoughts? (If you made it this far the truncated IMG of the 32 gig SD is here (<a href="https://www.dropbox.com/s/0p84yla38slk3s1/SmallerShit.img?dl=0">500 megs</a>) but you might have to <a href="https://twitter.com/_n0p_/status/1238621437427978240">pad it out with zeros</a> to make some tools like it.</p>
<p>Oh, and listen to <a href="https://hanselminutes.com/">https://hanselminutes.com/</a> as the interview was great and it's coming soon!</p>
<hr>

<p><strong>Sponsor: </strong>Have you tried <a href="https://hnsl.mn/2vMQqdX">developing in Rider</a> yet? This fast and feature-rich cross-platform IDE improves your code for .NET, ASP.NET, .NET Core, Xamarin, and Unity applications on Windows, Mac, and Linux. </p>


  
		
<div>
	<div>
	    <h4>About Scott</h4>
        <div>
			<p>Scott Hanselman is a former professor, former Chief Architect in finance, now speaker, consultant, father, diabetic, and Microsoft employee. He is a failed stand-up comic, a cornrower, and a book author.</p>
            <p><a href="https://facebook.com/shanselman"><img src="https://www.hanselman.com/images/icon-fb.png" alt="facebook"></a>
            <a href="https://twitter.com/shanselman"><img src="https://www.hanselman.com/images/icon-twitter.png" alt="twitter"></a>
            <a href="https://plus.google.com/108573066018819777334?rel=author" rel="author"><img src="https://www.hanselman.com/images/icon-gplus.png" alt="g+"></a>
            <a href="http://feeds.hanselman.com/ScottHanselman"><img src="https://www.hanselman.com/images/icon-rss.png" alt="subscribe"></a><br>
            <a href="http://hanselman.com/about">About</a> &nbsp; <a href="http://www.hanselman.com/newsletter">Newsletter</a>
        </p></div>
	</div> 
    
      <div>
          
         <p><strong>Hosting By</strong><br>
                <a rel="nofollow" href="https://sherweb.com/"><img alt="Dedicated Windows Server Hosting by SherWeb" width="125" height="125" src="https://images.sherweb.com/OrcsWeb/SherWebPoweredbyLogo_V-250x250Color.png"></a>
          </p>        

     </div>
</div>
  
  
		



		
		
		
		
		
  </section>
</section></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function () {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs" /></noscript>
</body>
</html>