<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Be careful when manually handling JSON requests in ASP.NET Core -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Be careful when manually handling JSON requests in ASP.NET Core</h1><div><div class="entry-content clearfix"><p>The other day I was reviewing some code in an ASP.NET Core app. It was an HTTP endpoint, written as a simple, lightweight middleware component (so no MVC), that was handling incoming JSON requests. </p><p>The endpoint was intended to act as an ingestion point for larger amounts of data, so by definition it was supposed to perform well. I immediately noticed a few things that raised my eyebrow, that I wanted to share with you today.</p><h3 id="toc_1">Don't buffer to string, don't do sync</h3><p>The middleware code looked, after sort of a strip down for brevity, like this:</p><div><div id="crayon-5c74fb224f1b7978471615" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">app.Use(async (ctx, next) &gt;
{
    try
    {
        string body;
        using (var streamReader = new StreamReader(ctx.Request.Body, Encoding.UTF8))
        {
            body = streamReader.ReadToEnd();
        }
        var json = JObject.Parse(body);
        
        // process JSON
    }
    catch (Exception e)
    {
        // handle exception        
    }
});</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"><div class="crayon-nums-content"><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-1">1</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-2">2</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-3">3</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-4">4</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-5">5</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-6">6</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-7">7</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-8">8</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-9">9</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-10">10</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-11">11</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-12">12</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-13">13</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-14">14</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-15">15</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-16">16</p><p class="crayon-num" data-line="crayon-5c74fb224f1b7978471615-17">17</p><p class="crayon-num crayon-striped-num" data-line="crayon-5c74fb224f1b7978471615-18">18</p></div></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-1"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-st">Use</span><span class="crayon-sy">(</span><span class="crayon-e">async</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">ctx</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">next</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">try</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">string</span><span class="crayon-h"></span><span class="crayon-v">body</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">streamReader</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">StreamReader</span><span class="crayon-sy">(</span><span class="crayon-v">ctx</span><span class="crayon-sy">.</span><span class="crayon-v">Request</span><span class="crayon-sy">.</span><span class="crayon-v">Body</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">Encoding</span><span class="crayon-sy">.</span><span class="crayon-v">UTF8</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">body</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">streamReader</span><span class="crayon-sy">.</span><span class="crayon-e">ReadToEnd</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">json</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-v">JObject</span><span class="crayon-sy">.</span><span class="crayon-e">Parse</span><span class="crayon-sy">(</span><span class="crayon-v">body</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// process JSON</span></p><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">catch</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-i">Exception</span><span class="crayon-h"></span><span class="crayon-v">e</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// handle exception&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="crayon-line" id="crayon-5c74fb224f1b7978471615-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1b7978471615-18"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></tbody></table></div></div></div><p>This is definitely not the code you'd want to have in production, and most definitely not in a service that is supposed to handle higher loads. </p><p>The code buffers the entire body of the request into memory, and it does it synchronously. Since the request body is buffered, we can easily run out of memory if a malicious caller starts hammering us with large requests.</p><p>On top of that, the body is being read (buffered) synchronously. This is really a blocking operation, that pauses the thread and holds onto it until the completion. So a number of very slow clients, sending large request payloads, can lead to thread pool starvation. One additional thing worth noting is that Kestrel itself (or more specifically its <em>HttpRequestStream</em> used to represent the request body) is async only. So even when we do the synchronous call to <em>streamReader.ReadToEnd()</em>, Kestrel ends up, internally, going through its async path with <em>GetAwaiter().GetResult()</em>.</p><p>We can fairly easily rewrite this code to improve on both of the issues we just discussed. To do that in a really simple way, we should use <em>HttpRequestStreamReader</em> from the <em>Microsoft.AspNetCore.WebUtilities</em> package (however, it's a dependency of <em>Microsoft.AspNetCore</em> package, so chances are you have it already). We'll also convert the sync code to be async.</p><div><div id="crayon-5c74fb224f1cc076917647" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">b.Use(async (ctx, next) &gt;
{
    try
    {
        using (var streamReader = new HttpRequestStreamReader(request.Body, Encoding.UTF8))
        using (var jsonReader = new JsonTextReader(streamReader))
        {
            var json = await JObject.LoadAsync(jsonReader);       
            // process JSON
        }
    }
    catch (Exception e)
    {
        // handle exception        
    }
});</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-1"><span class="crayon-v">b</span><span class="crayon-sy">.</span><span class="crayon-st">Use</span><span class="crayon-sy">(</span><span class="crayon-e">async</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-v">ctx</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">next</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-2"><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">try</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">streamReader</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">HttpRequestStreamReader</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">Body</span><span class="crayon-sy">,</span><span class="crayon-h"></span><span class="crayon-v">Encoding</span><span class="crayon-sy">.</span><span class="crayon-v">UTF8</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">using</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">jsonReader</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-r">new</span><span class="crayon-h"></span><span class="crayon-e">JsonTextReader</span><span class="crayon-sy">(</span><span class="crayon-v">streamReader</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"></span><span class="crayon-v">json</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-e">await </span><span class="crayon-v">JObject</span><span class="crayon-sy">.</span><span class="crayon-e">LoadAsync</span><span class="crayon-sy">(</span><span class="crayon-v">jsonReader</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// process JSON</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">catch</span><span class="crayon-h"></span><span class="crayon-sy">(</span><span class="crayon-i">Exception</span><span class="crayon-h"></span><span class="crayon-v">e</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// handle exception&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="crayon-line" id="crayon-5c74fb224f1cc076917647-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1cc076917647-16"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></tbody></table></div></div></div><p>The code looks very clean (I'd say that perhaps even cleaner than before), and we are no longer pre-buffering the entire JSON into a string. The code is also fully async and can be used in production safely.</p><h3 id="toc_2">Disabling synchronous I/O</h3><p>Kestrel actually allows us to disable synchronous I/O at the server level. That means that any sync read operation (on the HTTP request) or write operation (on the HTTP response) would throw. This is a great way to ensure that you don't have any sync operations anywhere.</p><p>The flag is called <em>AllowSynchronousIO</em> and is (at the moment, so up to ASP.NET Core 2.2) set to <em>true</em> by default – that's why we managed to write our crappy version of the code earlier. The flag can be applied at application startup, when configuring your <em>WebHost</em>:</p><div><div id="crayon-5c74fb224f1e4672604900" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">public static async Task Main(string[] args) &gt;
         await WebHost.CreateDefaultBuilder(args)
             .ConfigureKestrel(o &gt; 
             {
                o.AllowSynchronousIO = false;
             })
             .UseStartup&lt;Startup&gt;()
             .Build().RunAsync();</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5c74fb224f1e4672604900-1"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-e">async </span><span class="crayon-e">Task </span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1e4672604900-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">await </span><span class="crayon-v">WebHost</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDefaultBuilder</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1e4672604900-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-e">ConfigureKestrel</span><span class="crayon-sy">(</span><span class="crayon-e">o</span><span class="crayon-h"></span><span class="crayon-o">&gt;</span><span class="crayon-h"></span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1e4672604900-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5c74fb224f1e4672604900-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">o</span><span class="crayon-sy">.</span><span class="crayon-v">AllowSynchronousIO</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-t">false</span><span class="crayon-sy">;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1e4672604900-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1e4672604900-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-v">UseStartup</span><span class="crayon-o">&lt;</span><span class="crayon-v">Startup</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1e4672604900-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-e">Build</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">RunAsync</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></tbody></table></div></div></div><p>As soon as we have Kestrel set up that way, and we run our original code we should immediately see a runtime <em>InvalidOperationException</em> when attempting to read the request body – with a message “Synchronous operations are disallowed. Call ReadAsync or set AllowSynchronousIO to true instead.”</p><p>That error obviously doesn't happen in the new version of our code.</p><h3 id="toc_3">Additional JSON considerations</h3><p>When handling JSON requests manually, like we did in this post, you may want to observe some additional potential issues. </p><p>First of all, if you know upfront the maximum possible payload size that your clients would send, it could be a good idea to restrict accordingly. This is also done via the <em>KestrelOptions</em>:</p><div><div id="crayon-5c74fb224f1f2500643175" class="crayon-syntax crayon-theme-github crayon-font-courier-new crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap"><p class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="readonly">public static async Task Main(string[] args) &gt;
         await WebHost.CreateDefaultBuilder(args)
             .ConfigureKestrel(o &gt; 
             {
                o.AllowSynchronousIO = false;
                
                // 500 Kb max body size
                o.Limits.MaxRequestBodySize = 500 * 1024; 
             })
             .UseStartup&lt;Startup&gt;()
             .Build().RunAsync();</textarea></p><div class="crayon-main"><table class="crayon-table"><tbody><tr class="crayon-row"><td class="crayon-nums " data-settings="show"></td><td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-5c74fb224f1f2500643175-1"><span class="crayon-m">public</span><span class="crayon-h"></span><span class="crayon-m">static</span><span class="crayon-h"></span><span class="crayon-e">async </span><span class="crayon-e">Task </span><span class="crayon-e">Main</span><span class="crayon-sy">(</span><span class="crayon-t">string</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"></span><span class="crayon-v">args</span><span class="crayon-sy">)</span><span class="crayon-h"></span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1f2500643175-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">await </span><span class="crayon-v">WebHost</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDefaultBuilder</span><span class="crayon-sy">(</span><span class="crayon-v">args</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1f2500643175-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-e">ConfigureKestrel</span><span class="crayon-sy">(</span><span class="crayon-e">o</span><span class="crayon-h"></span><span class="crayon-o">&gt;</span><span class="crayon-h"></span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1f2500643175-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span></p><p class="crayon-line" id="crayon-5c74fb224f1f2500643175-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">o</span><span class="crayon-sy">.</span><span class="crayon-v">AllowSynchronousIO</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-t">false</span><span class="crayon-sy">;</span></p><p class="crayon-line" id="crayon-5c74fb224f1f2500643175-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 500 Kb max body size</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1f2500643175-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">o</span><span class="crayon-sy">.</span><span class="crayon-v">Limits</span><span class="crayon-sy">.</span><span class="crayon-v">MaxRequestBodySize</span><span class="crayon-h"></span><span class="crayon-o">=</span><span class="crayon-h"></span><span class="crayon-cn">500</span><span class="crayon-h"></span><span class="crayon-o">*</span><span class="crayon-h"></span><span class="crayon-cn">1024</span><span class="crayon-sy">;</span><span class="crayon-h"></span></p><p class="crayon-line" id="crayon-5c74fb224f1f2500643175-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-5c74fb224f1f2500643175-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-v">UseStartup</span><span class="crayon-o">&lt;</span><span class="crayon-v">Startup</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-5c74fb224f1f2500643175-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">.</span><span class="crayon-e">Build</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">RunAsync</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></p></div></td></tr></tbody></table></div></div></div><p>One additional setting you may want to apply, when deserializing a request into your DTO object (so once you get to deal with <em>JsonSerializerSettings</em>), is to set <em>MaxDepth</em> there. The MVC framework defaults to 32 (so 32 levels deep in the JSON structure) to prevent stack overflow caused by malicious complex JSON requests.</p></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>