<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Using Lambda@Edge to handle Angular client-side routing with S3 and CloudFront -
linksfor.dev(s)
    </title>
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta charset="utf-8">
    <meta name="Description" content="A curated source of links that devs might find interesting. Updated around the clock." />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="grid">
        
<div class="readable">
    <div id="readOverlay" class="style-ebook"><div id="readInner" class="margin-medium size-medium"><h1>Using Lambda@Edge to handle Angular client-side routing with S3 and CloudFront</h1><div><div class="post-content"><p>In this post I show how to a handle an issue you get when hosting a SPA on AWS with S3 and CloudFront, where reloading the app gives a 403 or 404 response. I'll show how to use <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-edge.html"><span class="__cf_email__" data-cfemail="450924282721240500212220">[email&nbsp;protected]</span></a> to handle this by returning the default document (<em>index.html</em>) for the app instead.</p><h2 id="deploying-a-spa-as-static-files-the-problem-with-page-reloads" class="heading-with-anchor">Deploying a SPA as static files - the problem with page reloads<a href="#deploying-a-spa-as-static-files-the-problem-with-page-reloads"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>One of the plus-sides of using a SPA framework like Angular is that the app consists of only static files (HTML and JavaScript). These files can be deployed to static file hosting and cached using a CDN. If you're deploying to AWS, the obvious choices are <a href="https://aws.amazon.com/s3/">S3</a> and <a href="https://aws.amazon.com/cloudfront/">CloudFront</a>.</p><p>There's just one problem with this. Many SPA frameworks (including Angular) use client-side routing. The app itself is loaded when you load the home page (e.g. <code>/</code>, or <code>/index.html</code>)</p><p><img src="/content/images/2019/lambda_at_edge00.png" alt="Image of a sample app loading at the route"></p><p>As you navigate around the app, the URL bar updates to reflect the client-side routing location, without loading additional files from the server:</p><p><img src="/content/images/2019/lambda_at_edge00b.png" alt="Image of client-side routing"></p><p>Unfortunately, the fact the URL updates in this way can cause problems if you are hosting your app as static files on a service like S3. If you reload the page (by pressing F5 for example), the browser will make a request to the server for the document at the provided URL. For example, reloading the page in the image above would send a request to <code>/detail/13</code>. </p><p>Unfortunately, there _is_ no file <code>/detail/13</code> or <code>/detail/13/index.html</code> on the server, so instead of loading the detail page above, you'll get a <code>404 Not Found</code> error. </p><p><img src="/content/images/2019/lambda_at_edge00c.png" alt="404 when reloading a page"></p><p>This isn't just a problem for page reloads with F5, you get the same problem when trying to navigate to a page by typing a URL in the address bar directly.</p><p>The solution to this problem is to intercept these <code>404</code> responses on the server, and return the default document for the app (<code>/index.html</code>) instead. This will bootstrap the app, and then subsequently navigate to the <code>/detail/13</code> route on the <em>client-side</em>.</p><picture><source srcset="/content/images/2019/lambda_at_edge.svg" type="image/svg+xml"><img src="/content/images/2019/lambda_at_edge.png" alt="Image of the solution returning the default document for unknown requests"></picture><p>Achieving this behaviour requires server-side logic, so your CDN or static file hosting must support it. </p><h2 id="the-simple-solution-with-s3-and-cloudfront" class="heading-with-anchor">The simple solution with S3 and CloudFront<a href="#the-simple-solution-with-s3-and-cloudfront"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>The good news is that if you're hosting your SPA files on S3 and using CloudFront as a CDN, the functionality you need is built in for simple cases. I won't go into details here, as <a href="https://medium.com/@peatiscoding/here-is-how-easy-it-is-to-deploy-an-angular-spa-single-page-app-as-a-static-website-using-s3-and-6aa446db38ef#cf55">this medium article</a> explains it very well, but in summary:</p><ul><li>Add a new distribution with the S3 bucket hosting your app's files as an origin. </li><li>Edit the settings for the distribution. </li><li>Add <strong>CustomErrorResponses</strong> for both <code>403</code> and <code>404</code> errors. Customise the response to return <code>index.html</code> instead, and change the status to <code>200</code>.</li></ul><p>This will work for most cases, where you are hosting a single app within a distribution. </p><p>However, it's possible to host multiple apps at different paths in CloudFront, and to have separate behaviours for each:</p><p><img src="/content/images/2019/lambda_at_edge00d.png" alt="Multiple behaviours hosting multiple apps in CloudFront"></p><p><strong>CustomErrorResponses</strong> are set at the <em>distribution</em> level, so they're no good in the situation above. Instead you need a <em>different</em> custom error behaviour <em>for each separate app</em> (hosted at <code>/customers.app/</code> and <code>/admin.app/</code>). You can achieve this using AWS Lambda functions deployed to CloudFront, called <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="733f121e11171233361714165d">[email&nbsp;protected]</a></p><p>For the remainder of this post I'll describe how to setup <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="216d404c4345406164454644">[email&nbsp;protected]</a> to handle the <code>404</code> (and <code>403</code>) responses by returning the appropriate <code>index.html</code> for each app, such as <code>/customers.app/index.html</code>.</p><h2 id="using-lambda-edge-to-customise-error-responses" class="heading-with-anchor">Using <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d09cb1bdb2b4b19095b4b7b5">[email&nbsp;protected]</a> to customise error responses<a href="#using-lambda-edge-to-customise-error-responses"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2><p>As described <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-edge.html">in the documentation</a>: </p><blockquote><p><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fab69b97989e9bbabf9e9d9f">[email&nbsp;protected]</a> lets you run Lambda functions to customize content that CloudFront delivers, executing the functions in AWS locations closer to the viewer. The functions run in response to CloudFront events, without provisioning or managing servers. You can use Lambda functions to change CloudFront requests and responses </p></blockquote><p>The first step is to create a new AWS Lambda function. There's many ways to do this, but I just created one by clicking <em>Create Function</em><a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions">in the <code>us-east-1</code> web console</a>:</p><blockquote><p><strong>Important:</strong> Make sure your region is set to <code>us-east-1</code> (N. Virginia), even if that's not your usual region. Lambda functions for use with <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b0fcd1ddd2d4d1f0f5d4d7d5">[email&nbsp;protected]</a><strong>must</strong> use this region!</p></blockquote><p><img src="/content/images/2019/lambda_at_edge01.png" alt="The functions list in the web console"></p><p>From the following page, choose <em>Author from scratch</em>, add a name for your function, select the <code>Node.js 8.1.0</code> runtime environment, and configure (or create) a role that will be used to execute the Lambda function:</p><p><img src="/content/images/2019/lambda_at_edge02.png" alt="Creating a new function using the web console"></p><p>You can now create your Lambda function. I'll go through the JavaScript in the next section.</p><h3 id="the-lambda-function" class="heading-with-anchor">The Lambda function<a href="#the-lambda-function"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>In this section I'll go through the Lambda function logic. First I'll present the whole function and then go through it bit-by-bit:</p><pre class="language-javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token keyword">const</span> http <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> indexPage <span class="token operator">=</span><span class="token string">'index.html'</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>handler <span class="token operator">=</span><span class="token keyword">async</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">const</span> cf <span class="token operator">=</span> event<span class="token punctuation">.</span>Records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cf<span class="token punctuation">;</span><span class="token keyword">const</span> request <span class="token operator">=</span> cf<span class="token punctuation">.</span>request<span class="token punctuation">;</span><span class="token keyword">const</span> response <span class="token operator">=</span> cf<span class="token punctuation">.</span>response<span class="token punctuation">;</span><span class="token keyword">const</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span>status<span class="token punctuation">;</span><span class="token keyword">const</span> doReplace <span class="token operator">=</span> request<span class="token punctuation">.</span>method <span class="token operator">===</span><span class="token string">'GET'</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>statusCode <span class="token operator">==</span><span class="token string">'403'</span><span class="token operator">||</span> statusCode <span class="token operator">==</span><span class="token string">'404'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> doReplace 
        <span class="token operator">?</span><span class="token keyword">await</span><span class="token function">generateResponseAndLog</span><span class="token punctuation">(</span>cf<span class="token punctuation">,</span> request<span class="token punctuation">,</span> indexPage<span class="token punctuation">)</span><span class="token punctuation">:</span> response<span class="token punctuation">;</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">async</span><span class="token keyword">function</span><span class="token function">generateResponseAndLog</span><span class="token punctuation">(</span>cf<span class="token punctuation">,</span> request<span class="token punctuation">,</span> indexPage<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">const</span> domain <span class="token operator">=</span> cf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>distributionDomainName<span class="token punctuation">;</span><span class="token keyword">const</span> appPath <span class="token operator">=</span><span class="token function">getAppPath</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> indexPath <span class="token operator">=</span><span class="token template-string"><span class="token string">`/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>indexPage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span><span class="token keyword">const</span> response <span class="token operator">=</span><span class="token keyword">await</span><span class="token function">generateResponse</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> indexPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'response: '</span><span class="token operator">+</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> response<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">async</span><span class="token keyword">function</span><span class="token function">generateResponse</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">try</span><span class="token punctuation">{</span><span class="token keyword">const</span> s3Response <span class="token operator">=</span><span class="token keyword">await</span><span class="token function">httpGet</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hostname<span class="token punctuation">:</span> domain<span class="token punctuation">,</span> path<span class="token punctuation">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> headers <span class="token operator">=</span> s3Response<span class="token punctuation">.</span>headers <span class="token operator">||</span><span class="token punctuation">{</span><span class="token string">'content-type'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span><span class="token string">'text/html;charset=UTF-8'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">{</span>
            status<span class="token punctuation">:</span><span class="token string">'200'</span><span class="token punctuation">,</span>
            headers<span class="token punctuation">:</span><span class="token function">wrapAndFilterHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span>
            body<span class="token punctuation">:</span> s3Response<span class="token punctuation">.</span>body
        <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">{</span>
            status<span class="token punctuation">:</span><span class="token string">'500'</span><span class="token punctuation">,</span>
            headers<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">'content-type'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span><span class="token string">'text/plain'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            body<span class="token punctuation">:</span><span class="token string">'An error occurred loading the page'</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span><span class="token function">httpGet</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token keyword">new</span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Fetching </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>hostname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, status code : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resp<span class="token punctuation">.</span>statusCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> result <span class="token operator">=</span><span class="token punctuation">{</span>
                headers<span class="token punctuation">:</span> resp<span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
                body<span class="token punctuation">:</span><span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            resp<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> result<span class="token punctuation">.</span>body <span class="token operator">+=</span> chunk<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resp<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Couldn't fetch </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>hostname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span><span class="token function">getAppPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token string">''</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> segments <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> segments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span><span class="token function">wrapAndFilterHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">const</span> allowedHeaders <span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">,</span><span class="token string">'content-length'</span><span class="token punctuation">,</span><span class="token string">'last-modified'</span><span class="token punctuation">,</span><span class="token string">'date'</span><span class="token punctuation">,</span><span class="token string">'etag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> responseHeaders <span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>headers<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> responseHeaders<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> propName <span class="token keyword">in</span> headers<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>allowedHeaders<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> header <span class="token operator">=</span> headers<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                responseHeaders<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token operator">=</span> header<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                responseHeaders<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span> header <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> responseHeaders<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>The <code>handler</code> function exported at the top of the file is what CloudFront will call when it gets a response from S3. The first thing the handler does is check if the response is a <code>GET</code> request and a <code>404</code> or a <code>403</code>. If it is, we'll generate a new response by calling <code>generateResponseAndLog</code>, otherwise we use the existing response.</p><p><code>generateResponseAndLog()</code> calculates the path for returning the default document by combining the original request domain, the first segment of the URL (<code>admin.app</code> in <code>/admin.app/detail/13</code>), and the default document. </p><p><code>generateResponse()</code> makes a <code>GET</code> request to S3 for the <em>index.html</em> (from the same CloudFront distribution, as we reused the same domain) and converts it into the correct format. Not all headers are allowed, and they have to be added to an object using the following format, so <code>wrapAndFilterHeaders()</code> handles that</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"header-name"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"value"</span><span class="token operator">:</span><span class="token string">"header-value"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>Finally, the response is sent with a <code>200 Ok</code> status code, including the filtered and wrapped headers, and the body of the <em>index.html</em> file.</p><h3 id="testing-the-lambda-function" class="heading-with-anchor">Testing the lambda function<a href="#testing-the-lambda-function"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h3><p>The Lambda web console includes facilities for testing your function. You can create a test event and invoke your function with it. For examples of the event structure, <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-event-structure.html#lambda-event-structure-response">see the documentation</a>. For example, the following request represents the Response event received by <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b9f5d8d4dbddd8f9fcdddedc">[email&nbsp;protected]</a> after receiving a <code>404</code> from the underlying Origin (S3):</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"Records"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"cf"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"config"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"distributionDomainName"</span><span class="token operator">:</span><span class="token string">"d12345678.cloudfront.net"</span><span class="token punctuation">,</span><span class="token property">"distributionId"</span><span class="token operator">:</span><span class="token string">"EXAMPLE"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"request"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"uri"</span><span class="token operator">:</span><span class="token string">"/admin.app/details/13"</span><span class="token punctuation">,</span><span class="token property">"method"</span><span class="token operator">:</span><span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token property">"clientIp"</span><span class="token operator">:</span><span class="token string">"2001:cdba::3257:9652"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"response"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"status"</span><span class="token operator">:</span><span class="token string">"404"</span><span class="token punctuation">,</span><span class="token property">"statusDescription"</span><span class="token operator">:</span><span class="token string">"Not Found"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>As this event contains a <code>404</code> response, the function should convert it into a <code>200</code> response:</p><p><img src="/content/images/2019/lambda_at_edge03.png" alt="Function test execution successsful"></p><p>Once you're happy with the function, you can deploy it to <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3478555956505574715053511a">[email&nbsp;protected]</a></p><p>To deploy the function to CloudFront, choose <em>Actions</em>, and then <em>Deploy to <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="92def3fff0f6f3d2d7f6f5f7">[email&nbsp;protected]</a></em></p><p><img src="/content/images/2019/lambda_at_edge04.png" alt="Creating a new function using the web console"></p><blockquote><p>If you don't see <em>Deploy to <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="256944484741446560414240">[email&nbsp;protected]</a></em> in the drop down, you've probably created the Lambda in the wrong region. Remember, you have to create your functions in the <code>us-east-1</code> region.</p></blockquote><p>After clicking <em>Deployâ€¦</em> you're presented with the deployment options. Choose the distribution for your apps and select the correct <em>behavior</em> for your app. Make sure to set the CloudFront event to <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-cloudfront-trigger-events.html">Origin response</a>, i.e. the event after the Origin responds but before it sends the response to the user:</p><p><img src="/content/images/2019/lambda_at_edge05.png" alt="Deploying to Lambda@Edge"></p><p>When you click Deploy on this page, AWS will publish the lambda as version 1, and everything should be configured and running!</p><p><img src="/content/images/2019/lambda_at_edge06.png" alt="Deploy complete"></p><p>You can test it by reloading your app on a detail page, and if all is set up right, you'll be presented with a functioning app!</p><p><img src="/content/images/2019/lambda_at_edge00b.png" alt="Client-side routing working correctly"></p><p>When you deploy your Lambda, it's automatically configured inside the CloudFront behaviour. You can see the registration yourself by going to CloudFront Distributions &gt; Distribution &gt; Behaviours &gt; Edit Behaviour &gt; Lambda Function Associations:</p><p><img src="/content/images/2019/lambda_at_edge_03.png" alt="Updating the Lambda association manually"></p><p>This can be useful if you want to update the Lambda function definition. To do so, you need to publish a new version of the Lambda, and then update the ARN in CloudFront. The last number in the ARN is the version:</p><ul><li><code>arn:aws:lambda:aws-region:acct-id:function:helloworld</code> - Unversioned ARN</li><li><code>arn:aws:lambda:aws-region:acct-id:function:helloworld:3</code> - Published ARN (version 3)</li><li><code>arn:aws:lambda:aws-region:acct-id:function:helloworld:$LATEST</code> - Unpublished ARN</li></ul><h2 id="resources" class="heading-with-anchor">Resources<a href="#resources"><img aria-hidden="true" src="/assets/img/icons-link.svg"></a></h2></div></div></div></div>
</div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
    </footer>
    
    <script>
        (function () {
            var COLLECT_URL = "https://dna.buildstarted.com/t";
            var SITE_ID = "linksfor.devs";
            var GLOBAL_VAR_NAME = "__DNA__";

            window[GLOBAL_VAR_NAME] = {};

            window[GLOBAL_VAR_NAME].sendPageView = function () {
                var path = location.pathname;
                var referrer = document.referrer;

                var url = COLLECT_URL + "?siteid=" + SITE_ID + "&p=" + encodeURIComponent(path) + "&r=" + encodeURIComponent(referrer);

                try { fetch(url, { method: "GET" }); } catch (e) { }
            };

            window[GLOBAL_VAR_NAME].sendPageView();
        })();
    </script>
</body>
</html>