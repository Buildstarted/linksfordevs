<!DOCTYPE html>
<html lang="en">
<head>
    <title>
Migrating your applications to Azure using Virtual Machine Scale Sets, Packer and Virtual Machine extensions &#x2013; Part 1 - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="Migrating your applications to Azure using Virtual Machine Scale Sets, Packer and Virtual Machine extensions &#x2013; Part 1 - linksfor.dev(s)"/>
    <meta property="og:description" content="I&#x27;m a Canadian Software Developer that is programming his life away while still maintaining a healthy lifestyle with a passion for fitness. The world of 0&#x27;s and 1&#x27;s got injected into my DNA at an early age, which made me turn a passion into a job."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.domstamand.com/migrating-your-applications-to-azure-using-virtual-machine-scale-sets-and-packer-and-vm-extensions-part-1/"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - Migrating your applications to Azure using Virtual Machine Scale Sets, Packer and Virtual Machine extensions &#x2013; Part 1</title>
<div class="readable">
        <h1>Migrating your applications to Azure using Virtual Machine Scale Sets, Packer and Virtual Machine extensions &#x2013; Part 1</h1>
            <div>Reading time: 15-19 minutes</div>
        <div>Posted here: 20 Feb 2020</div>
        <p><a href="https://www.domstamand.com/migrating-your-applications-to-azure-using-virtual-machine-scale-sets-and-packer-and-vm-extensions-part-1/">https://www.domstamand.com/migrating-your-applications-to-azure-using-virtual-machine-scale-sets-and-packer-and-vm-extensions-part-1/</a></p>
        <hr/>
<div id="readability-page-1" class="page"><div id="st-container"><nav id="offcanvas-sidebar-nav"><div><div tabindex="0">
      
                  <div>
          <ul id="offcanvas-sidebar">
            <li id="text-6"><h2>About me</h2>
			<div><img src="https://www.domstamand.com/wp-content/uploads/2016/12/display.pic_.jpg" alt="About me"><p>I'm a Canadian Software Developer that is programming his life away while still maintaining a healthy lifestyle with a passion for fitness. The world of 0's and 1's got injected into my DNA at an early age, which made me turn a passion into a job.</p></div>
		</li>
<li id="tag_cloud-2"><h2>Tags</h2>

</li>
          </ul>
          </div>
              </div></div></nav><div><div><div>




<header>
<div>
  <div>
    <div>

      <div>
            <div>
    <a href="https://www.domstamand.com/"><img src="https://www.domstamand.com/wp-content/uploads/2017/01/sitelogo.png" alt="Dominique St-Amand"></a>
        </div>
          </div>

      

      
    </div>
  </div>

</div>

        
    
    </header>


	
<div>
<div>
	<div>
		<div>
			<div>
				<article id="post-1140">
							<div>

								<div>
																																															
									

									
									
									<div>
										<span>February 16, 2020</span>
																				|										<span>by Dominique St-Amand</span>
										
																				|										<span><a href="https://www.domstamand.com/migrating-your-applications-to-azure-using-virtual-machine-scale-sets-and-packer-and-vm-extensions-part-1/#comments">3 Comments</a></span>
										
										
									</div>
																											<div>
										
<p>So you are ready to move your application to Azure but it is not fully optimized for the cloud. You looked into App Services (web apps), but to be able to really get the best of them, it would need some definitive improvements in the code. You go back to your team and management and propose them a lift and shift that would make everyone happy. You then plan your improvements in your timeline and estimates. How can you effectively lift and shift your application so that it can be highly available (within one region) and scalable? In this series of posts, I will show you how you can package your application in an image and have it ready for deployment for your IaaS VMs setup through a scale set. I will also show you how you can use that image to create a Virtual Machine Scale Set and use extensions to post provision your virtual machines.</p>

<p>I decided to do a series of posts about this topic as it touches a variety of aspects. I will use a concrete example that may or may not have happened to you and I plan to cover</p>
<ul>
<li>Building a managed image from an Ubuntu image as base, and setting up a web server to host an application (this post)</li>
<li>Creating a Virtual Machine Scale Set using ARM templates</li>
<li>Adding a post provisioning extension that will be fetching files from a blob storage that is required for the application to run once a virtual machine in the set has started</li>
</ul>

<p><a href="https://packer.io/" target="_blank" rel="noopener noreferrer">Packer</a> is a tool that allows us to create machine images in an automated way. With the tool, you can just pass it your configuration, in JSON, and it will generate you a machine image for your platform. Packer supports a variety of platforms, but today we will focus on its Azure counterpart.</p>

<p>Virtual machine images in Azure come in 2 flavors: Unmanaged images and Managed images.</p>
<p>A managed image is an Azure resource that comes from a generalized virtual machine image. A generalized image is a snapshot of an already installed Operating System without the machine specific settings and without user’s settings. A managed image is stored on managed disks, which are like a physical disk in an on-premises server but virtualized<sup><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/managed-disks-overview" target="_blank" rel="noopener noreferrer">1</a></sup>.</p>
<p>Unmanaged images are VHDs or virtual hard-disks images that are not stored on managed disks. VHDs in Azure are stored in storage accounts.</p>
<p>In this series, I will create a Managed image.</p>

<p>Lets get started with Packer locally to create the managed Linux image (Ubuntu). You can (and should definitely) automate this process using Azure DevOps with the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/packer-build?view=azure-devops" target="_blank" rel="noopener noreferrer">Packer build task</a>, but this will not be covered here. If there’s some interest about that, let me know and I can definitely write about it. Don’t be shy to use the <a href="https://www.domstamand.com/contact-me/">contact section</a>, or to contact me on twitter!.</p>
<h2>Setting up the build with Packer</h2>
<p>Go ahead and <a href="https://packer.io/" target="_blank" rel="noopener noreferrer">download</a> yourself a copy of Packer.</p>
<p>Packer uses a JSON template structure to organize its builds, a task that will produce an image for a single platform. I will be using the the following sections of the template:</p>
<ul>
<li>Variables. Variables are elements used to store information to be referenced in our template. These variables help with not hard-coding our values in the template for re-use (hint these can be used for a CI build!).</li>
<li>Builders. Builders are components of Packer that are able to create a machine image for a single platform. In my case, I will use the <a href="https://packer.io/docs/builders/azure-arm.html" target="_blank" rel="noopener noreferrer">Azure</a> builder.</li>
<li>Provisioners. Provisioners are components of Packer that install and configure software within a running machine prior to that machine being turned into a static image.</li>
</ul>
<p>First I will create a <em>packer.json</em> file, with the content below, that I will use as the template.</p>
<p>An empty packer JSON template for this scenario looks like this:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75355326821762" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75355326821762-4"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"sensitive-variables"</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<h3>Defining the variables</h3>
<p>As mentioned above, we need to have elements to store our information. Below are the elements/variables we will be needing:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e7535e593000892" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e7535e593000892-5"><span>"managed_image_prefix"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e7535e593000892-6"><span>"managed_image_resource_group_name"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e7535e593000892-7"><span>"build_resource_group_name"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e7535e593000892-8"><span>"ssh_username"</span><span>:</span><span> </span><span>"packer"</span><span>,</span></div><div id="crayon-5e4ee86e7535e593000892-10"><span>"ApplicationArtifacts"</span><span>:</span><span> </span><span>""</span><span>,</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<ul>
<li><strong>subscription_id</strong> – Subscription under which the build will be performed.</li>
<li><strong>tenant_id</strong> – The Active Directory tenant identifier with which your <em>client_id</em> and <em>subscription_id</em> are associated.</li>
<li><strong>client_id</strong> – The Active Directory service principal (SP) associated with your builder.</li>
<li><strong>client_secret</strong> – The password or secret for your service principal.
<ul>
<li>note: there are also other means of authentication for your SP such as certificate and JWT. Find them <a href="https://packer.io/docs/builders/azure-arm.html#required-options-for-authentication-" target="_blank" rel="noopener noreferrer">here</a>.</li>
</ul>
</li>
<li><strong>managed_image_prefix</strong> – The prefix that will be used used to name the managed image.</li>
<li><strong>managed_image_resource_group_name</strong> – The resource group name where the image will be stored</li>
<li><strong>ssh_username</strong> – The ssh username that packer will use to connect to the machine to run our provisioners. This accounts has admin rights.</li>
<li><strong>ssh_password</strong> – The ssh password that packer will use to connect to the machine to run our provisioners. It is important to set this here, otherwise packer will automatically generate a random password that you won’t have access to. It is important to set it as we will use it in on of our provisioners.</li>
<li><strong>ApplicationArtifacts</strong> – The application artifacts</li>
<li><strong>WorkingDirectory</strong> – The directory where all files required for the provisioners are located.</li>
</ul>
<h4>Creating a SP for use with the builder</h4>
<p>I’m a big fan of PowerShell for automation in Azure so I tend to favor PowerShell to create Azure resources. The same can be done with the Azure Portal or <a href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?view=azure-cli-latest" target="_blank" rel="noopener noreferrer">Azure CLI</a>.</p>
<p>To create a Service Principal, use the following code snippet</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75362373560307" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75362373560307-1"><span>$sp</span><span> </span><span>=</span><span> </span><span>New-AzADServicePrincipal</span><span> </span><span>-DisplayName</span><span> </span><span>"packer-application"</span></div><div id="crayon-5e4ee86e75362373560307-2"><span>$BSTR</span><span> </span><span>=</span><span> </span><span>[</span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>InteropServices</span><span>.</span><span>Marshal</span><span>]</span><span>::</span><span>SecureStringToBSTR</span><span>(</span><span>$sp</span><span>.</span><span>Secret</span><span>)</span></div><div id="crayon-5e4ee86e75362373560307-3"><span>$unsecureSecret</span><span> </span><span>=</span><span> </span><span>[</span><span>System</span><span>.</span><span>Runtime</span><span>.</span><span>InteropServices</span><span>.</span><span>Marshal</span><span>]</span><span>::</span><span>PtrToStringAuto</span><span>(</span><span>$BSTR</span><span>)</span></div><div id="crayon-5e4ee86e75362373560307-4"><span>echo</span><span> </span><span>"client_id = $sp.ApplicationId"</span></div><div id="crayon-5e4ee86e75362373560307-5"><span>echo</span><span> </span><span>"client_secret = $unsecureSecret"</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->
<p>We will set the actual values of these variables in another file that will pass to Packer to validate and build the image.</p>
<p>Create another file named <em>packer.parameters.json</em> and copy the variable object from above. Fill in the values with the values relative to your environment.</p>
<p><strong><img src="https://www.domstamand.com/wp-content/uploads/2020/02/tip-icon.png" alt="" width="32" height="32"> Tip</strong></p>
<p>You can instruct packer to read your variables from different places as shown <a href="https://packer.io/docs/templates/user-variables.html" target="_blank" rel="noopener noreferrer">here</a>. If for instance, you want Packer to read environment variables, you can replace a variable with the content 
			<span id="crayon-5e4ee86e75364918010735"><span><span>{</span><span>{</span><span>env</span><span> </span><span>`</span><span>MY_ENV_VAR</span><span>`</span><span>}</span><span>}</span></span></span> . Example:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75366542459960" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75366542459960-1"><span>"WorkingDirectory"</span><span>:</span><span> </span><span>"{{env `System_DefaultWorkingDirectory`}}"</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p><strong>Sensitive variables</strong></p>
<p>You can control the sensitivity of variables so that they aren’t logged to Packer logs and UI by using the <em>sensitive-variables&nbsp;</em>section. In this case, I set the <em>client_secret</em> variable as sensitive. The Packer UI and logs will replace the value of “client_secret” with <code>&lt;sensitive&gt;</code></p>
<h3>Defining our builder</h3>
<p>Since I’m building for Azure, I will use the <a href="https://packer.io/docs/builders/azure-arm.html" target="_blank" rel="noopener noreferrer">Azure-ARM</a> builder provider by Packer. In the builder, I specify the base image and VM size that Packer will use to create our managed image. I also set the properties of the builder which mainly are taken from our variables. The <em>{{user <code></code>}}</em> instruct Packer to use our user defined variables.</p>
<p>Also to note that I’m using&nbsp;<em>timestamp</em> as a way to uniquely identify my images. Use whatever you see fit that fits your company / team governance.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75368386986560" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75368386986560-3"><span>	</span><span>"client_id"</span><span>:</span><span> </span><span>"{{user `client_id`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-4"><span>	</span><span>"client_secret"</span><span>:</span><span> </span><span>"{{user `client_secret`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-5"><span>	</span><span>"tenant_id"</span><span>:</span><span> </span><span>"{{user `tenant_id`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-6"><span>	</span><span>"subscription_id"</span><span>:</span><span> </span><span>"{{user `subscription_id`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-7"><span>	</span><span>"build_resource_group_name"</span><span>:</span><span> </span><span>"{{user `build_resource_group_name`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-8"><span>	</span><span>"ssh_username"</span><span>:</span><span> </span><span>"{{user `ssh_username`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-9"><span>	</span><span>"ssh_password"</span><span>:</span><span> </span><span>"{{user `ssh_password`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-11"><span>	</span><span>"managed_image_name"</span><span>:</span><span> </span><span>"{{user `managed_image_prefix`}}-{{timestamp}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-12"><span>	</span><span>"managed_image_resource_group_name"</span><span>:</span><span> </span><span>"{{user `managed_image_resource_group_name`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-14"><span>	</span><span>"image_publisher"</span><span>:</span><span> </span><span>"Canonical"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-15"><span>	</span><span>"image_offer"</span><span>:</span><span> </span><span>"UbuntuServer"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-16"><span>	</span><span>"image_sku"</span><span>:</span><span> </span><span>"18.04-LTS"</span><span>,</span></div><div id="crayon-5e4ee86e75368386986560-17"><span>	</span><span>"vm_size"</span><span>:</span><span> </span><span>"Standard_DS2_v2"</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p><strong><img src="https://www.domstamand.com/wp-content/uploads/2020/02/warning-32x32-1.png" alt="" width="32" height="32"> Note</strong></p>
<p>If you don’t supply the property <em>build_resource_group_name</em>, Packer will create a new resource group and provision a VM (and its associated resources) within that resource group. To do so, your SP needs to have owner access in the subscription.</p>
<p>If you supply the&nbsp;<em>build_resource_group_name</em> property, your SP needs to have owner access in the resource group specified in that variable.</p>
<h3>Defining our provisioners</h3>
<p>In this example, I will use 3 <a href="https://packer.io/docs/provisioners/index.html" target="_blank" rel="noopener noreferrer">provisioners</a>. The last is <strong>mandatory</strong> to generalize your image. The same applies if you build a managed image based on a windows image.</p>
<p><strong>#1 – Copy the application artifacts file</strong></p>
<p>Provisioner of type <em>file</em></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e7536b480957152" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e7536b480957152-3"><span>&nbsp;&nbsp;</span><span>"source"</span><span>:</span><span> </span><span>"{{user `WorkingDirectory`}}/{{user `ApplicationArtifacts`}}"</span><span>,</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p><strong>#2 – Run the setup script to install and configure the OS and application. This includes for instance updating the OS, installing the required software(s) that I need, downloading and installing my web server, setting up permission and users, and so on.</strong></p>
<p>Provisioner of type <em>shell</em></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e7536d554322457" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e7536d554322457-3"><span>&nbsp;&nbsp;</span><span>"execute_command"</span><span>:</span><span> </span><span>"echo '{{user `ssh_pass`}}' | {{ .Vars }} sudo -S -E sh '{{ .Path }}'"</span><span>,</span></div><div id="crayon-5e4ee86e7536d554322457-4"><span>&nbsp;&nbsp;</span><span>"script"</span><span>:</span><span> </span><span>"{{user `WorkingDirectory`}}/setup.sh"</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>As you can see here, before running the script (which will be uploaded to the machine with a random name), we execute a command. This command instructs Packer to gain root privileges using sudo. This is why it was necessary to setup a ssh password so that we can pass it to sudo using stdin.</p>
<p>Also if you’re writing your script on windows, make sure it is saved with LF as the line feed and not CRLF. CRLF will not work in Linux. If this is a constraint for you you can also use a <a href="https://linux.die.net/man/1/dos2unix" target="_blank" rel="noopener noreferrer">dos2unix</a> to convert the file to use proper line feeds.</p>
<p><strong>#3 – Generalize the image so that it can be reused</strong></p>
<p>Provisioner of type <em>shell</em></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e7536f944159824" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e7536f944159824-2"><span>&nbsp;&nbsp;</span><span>"execute_command"</span><span>:</span><span> </span><span>"echo '{{user `ssh_pass`}}' | {{ .Vars }} sudo -S -E sh '{{ .Path }}'"</span><span>,</span></div><div id="crayon-5e4ee86e7536f944159824-4"><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/usr/sbin/waagent -force -deprovision+user &amp;&amp; export HISTSIZE=0 &amp;&amp; sync"</span></div><div id="crayon-5e4ee86e7536f944159824-6"><span>&nbsp;&nbsp;</span><span>"inline_shebang"</span><span>:</span><span> </span><span>"/bin/sh -x"</span><span>,</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The <a href="https://packer.io/docs/builders/azure-arm.html#skip_clean" target="_blank" rel="noopener noreferrer"><em>skip_clean</em></a> was added because Packer reported that customers have reported issues with the deprovision process where the builder hangs. One solution is to set <em>skip_clean</em> to true in the provisioner. This prevents Packer from cleaning up any helper scripts uploaded to the VM during the build.</p>
<h3>Final look</h3>
<p>Your template should now look like this</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75371082638529" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75371082638529-7"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"managed_image_prefix"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-8"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"managed_image_resource_group_name"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-9"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"build_resource_group_name"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-10"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ssh_username"</span><span>:</span><span> </span><span>"packer"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-12"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ApplicationArtifacts"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-15"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"sensitive-variables"</span><span>:</span><span> </span><span>[</span><span>"client_secret"</span><span>]</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-19"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"client_id"</span><span>:</span><span> </span><span>"{{user `client_id`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-20"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"client_secret"</span><span>:</span><span> </span><span>"{{user `client_secret`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-21"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"tenant_id"</span><span>:</span><span> </span><span>"{{user `tenant_id`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-22"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"subscription_id"</span><span>:</span><span> </span><span>"{{user `subscription_id`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-23"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"build_resource_group_name"</span><span>:</span><span> </span><span>"{{user `build_resource_group_name`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-24"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ssh_username"</span><span>:</span><span> </span><span>"{{user `ssh_username`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-25"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ssh_password"</span><span>:</span><span> </span><span>"{{user `ssh_password`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-27"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"managed_image_name"</span><span>:</span><span> </span><span>"{{user `managed_image_prefix`}}-{{timestamp}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-28"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"managed_image_resource_group_name"</span><span>:</span><span> </span><span>"{{user `managed_image_resource_group_name`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-30"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"image_publisher"</span><span>:</span><span> </span><span>"Canonical"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-31"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"image_offer"</span><span>:</span><span> </span><span>"UbuntuServer"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-32"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"image_sku"</span><span>:</span><span> </span><span>"18.04-LTS"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-33"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"vm_size"</span><span>:</span><span> </span><span>"Standard_DS2_v2"</span></div><div id="crayon-5e4ee86e75371082638529-39"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"source"</span><span>:</span><span> </span><span>"{{user `WorkingDirectory`}}/{{user `ApplicationArtifacts`}}"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-44"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"execute_command"</span><span>:</span><span> </span><span>"echo '{{user `ssh_pass`}}' | {{ .Vars }} sudo -S -E sh '{{ .Path }}'"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-45"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"script"</span><span>:</span><span> </span><span>"{{user `WorkingDirectory`}}/setup.sh"</span></div><div id="crayon-5e4ee86e75371082638529-48"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"execute_command"</span><span>:</span><span> </span><span>"echo '{{user `ssh_pass`}}' | {{ .Vars }} sudo -S -E sh '{{ .Path }}'"</span><span>,</span></div><div id="crayon-5e4ee86e75371082638529-50"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"/usr/sbin/waagent -force -deprovision+user &amp;&amp; export HISTSIZE=0 &amp;&amp; sync"</span></div><div id="crayon-5e4ee86e75371082638529-52"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"inline_shebang"</span><span>:</span><span> </span><span>"/bin/sh -x"</span><span>,</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

<h2>Run the process</h2>
<p>I am now ready to validate that the template is valid. I do so by running the following command</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75374747061476" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75374747061476-1"><span>packer </span><span>validate</span><span> </span><span>-</span><span>var</span><span>-</span><span>file</span><span>=</span><span>"packer.parameters.json"</span><span> </span><span>packer</span><span>.</span><span>json</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>If everything is successful, I start the image building process</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75376152130162" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75376152130162-1"><span>packer </span><span>build</span><span> </span><span>-</span><span>var</span><span>-</span><span>file</span><span>=</span><span>"packer.parameters.json"</span><span> </span><span>packer</span><span>.</span><span>json</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->


<p>Azure has a great product for us called <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/shared-image-galleries" target="_blank" rel="noopener noreferrer">Shared Image Gallery</a> (SIG) that can help with structuring and managing managed images. The main features of SIG are:</p>
<ul>
<li>Manage global replication of images.</li>
<li>Version and group images for easier management.</li>
<li>Make the images highly available with Zone Redundant Storage (ZRS) accounts in regions that support Availability Zones. ZRS offers better resilience against zonal failures.</li>
<li>Share images across subscriptions, and even between Active Directory (AD) tenants, using RBAC.</li>
<li>Scale your deployments with image replicas in each region.</li>
</ul>
<p>Shared Image Gallery is also very appealing for teams and companies, as mentioned by Microsoft, if you have a large number of managed images that you need to maintain and would like to make them available throughout your company / teams. If this is your case, you can use SIG as a repository that makes it easy to share your images.</p>
<p>If any of the above points hits home for you, definitely consider this product.</p>
<h2>Adding Shared Image Gallery into our Packer build</h2>
<p>If you wish to enable Packer to push to Shared Image Gallery, add the following into the builder object for Azure-ARM</p>
<p>The first thing we need to do is add the following variables to the template:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e75378287376312" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e75378287376312-1"><span>"shared_image_gallery_name"</span><span>:</span><span> </span><span>""</span><span>,</span></div><div id="crayon-5e4ee86e75378287376312-2"><span>"shared_resource_group_name"</span><span>:</span><span> </span><span>""</span><span>,</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->

<ul>
<li><strong>shared_image_gallery_name</strong> – The name of the SIG resource you created in Azure</li>
<li><strong>shared_resource_group_name</strong> – The resource group in which SIG resides in</li>
<li><strong>image_name</strong> – The image name definition in SIG</li>
<li><strong>image_version</strong> – The version of your image</li>
</ul>
<p>Once this is done, we need to add the following to the Azure-ARM builder. Be sure to change the <em>replication_regions</em> array with values that make sense for you! This property tells SIG to replicate your image in the regions you define.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5e4ee86e7537a186050011" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="hide">
					
				</td>
						<td><div><div id="crayon-5e4ee86e7537a186050011-1"><span>"shared_image_gallery_destination"</span><span>:</span><span> </span><span>{</span></div><div id="crayon-5e4ee86e7537a186050011-2"><span>	</span><span>"resource_group"</span><span>:</span><span> </span><span>"{{user `shared_resource_group_name`}}"</span><span>,</span></div><div id="crayon-5e4ee86e7537a186050011-3"><span>	</span><span>"gallery_name"</span><span>:</span><span> </span><span>"{{user `shared_image_gallery_name`}}"</span><span>,</span></div><div id="crayon-5e4ee86e7537a186050011-4"><span>	</span><span>"image_name"</span><span>:</span><span> </span><span>"{{user `image_name`}}"</span><span>,</span></div><div id="crayon-5e4ee86e7537a186050011-5"><span>	</span><span>"image_version"</span><span>:</span><span> </span><span>"{{user `image_version`}}"</span><span>,</span></div><div id="crayon-5e4ee86e7537a186050011-6"><span>	</span><span>"replication_regions"</span><span>:</span><span> </span><span>[</span><span>"CHANGE_ME"</span><span>]</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Remember however, that before pushing your image, you need to create a definition in SIG otherwise you will get an error when packer will try to push it.</p>

<p>Microsoft has introduced the <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/image-builder-overview" target="_blank" rel="noopener noreferrer">Azure Image Builder</a> that is currently in preview. With this service, you will also be able to create managed and unmanaged images like packer for Azure. Considering this product is still in preview, it does come with some limitations. Be sure to read about them before fully embarking into it.</p>
<p>If you want to read more about Packer and creating a windows image instead of a Linux one, you can read about it <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/build-image-with-packer" target="_blank" rel="noopener noreferrer">here</a>.</p>
																			</div><!-- .entry-content -->


																		</div>

							</div>

				
				<span>
					<a href="https://www.domstamand.com/tag/azure/" rel="tag">azure</a><a href="https://www.domstamand.com/tag/linux/" rel="tag">linux</a><a href="https://www.domstamand.com/tag/packer/" rel="tag">packer</a><a href="https://www.domstamand.com/tag/scaleset/" rel="tag">scaleset</a><a href="https://www.domstamand.com/tag/vmss/" rel="tag">vmss</a><a href="https://www.domstamand.com/tag/vmss-extensions/" rel="tag">vmss-extensions</a>				</span>

				
				
													


				</article>


			</div>

										
				<nav role="navigation" id="nav-below">

		
	
	</nav><!-- #nav-below -->
	
									
			

<!-- *******************************************************************************************************************-->
<!-- Comments Evolved for Wordpress v1.6.3 ( http://wordpress.org/plugins/gplus-comments/ ) -->
<!-- *******************************************************************************************************************-->

<!-- comments-evolved-tabs -->

<div id="comments-evolved-tabs">
<a name="comments"></a>
    <ul role="tablist">
    <li id="comments-evolved-disqus-control" role="tab" tabindex="0" aria-controls="comments-evolved-disqus-tab" aria-labelledby="ui-id-1" aria-selected="true" aria-expanded="true"><a href="#comments-evolved-disqus-tab" role="presentation" tabindex="-1" id="ui-id-1"><img id="comments-evolved-disqus-icon" src="https://www.domstamand.com/wp-content/plugins/gplus-comments/assets/images/icons/default/disqus.png"><span id="comments-evolved-disqus-label"></span></a></li>
  </ul>
  <!-- comments-evolved-disqus-tab -->

<!-- // comments-evolved-disqus-tab -->
</div>
<!-- //comments-evolved-tabs -->



		</div>
				
			</div>
	</div>
</div>






      


















<!-- Comments Evolved plugin -->

<!-- //Comments Evolved plugin -->


</div></div></div></div></div></div>
    </div>
    <footer>
        <div>created by <a href="https://buildstarted.com">buildstarted</a> &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>