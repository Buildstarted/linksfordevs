<!DOCTYPE html>
<html lang="en">
<head>
    <title>
HTTP headers for the responsible developer - linksfor.dev(s)    </title>
    <meta charset="utf-8">
    <link rel="alternate" type="application/rss+xml" title="Linksfor.dev(s) feed" href="https://linksfor.dev/feed.rss" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" value="notranslate">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:title" content="HTTP headers for the responsible developer - linksfor.dev(s)"/>
    <meta property="article:author" content="By Stefan Judis&#xA;      2019-04-23"/>
    <meta property="og:description" content="Guide to using HTTP headers for a better web. Learn about HTTPS, HSTS, CSP, Cacheable, immutable resources, serving WebP images, Feature-Policy and more."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.twilio.com/blog/a-http-headers-for-the-responsible-developer"/>

<meta property="og:site_name" content="linksfor.dev(s)" />
</head>
<body>
    <div class="devring" style="background: #222">
        <div style="text-align:center">Explore other dev related sites in this ring. If you would like to join this ring <a href="https://devring.club">click here</a>.</div>
        <div class="grid">
            <div style="display: grid; grid-template-columns: .5fr 1fr 1fr 1fr; text-align: center;">
                <span class="devring-title"><a href="https://devring.club/">devring.club</a></span>
                <a href="https://devring.club/sites/1/prev" class="devring-previous">Previous</a>
                <a href="https://devring.club/random" class="devring-random">Random</a>
                <a href="https://devring.club/sites/1/next" class="devring-next">Next</a>
            </div>
        </div>
    </div>
    <div class="grid">
        <h1>
<a href="/" style="color:inherit">linksfor.dev(s)</a>
        </h1>
        <title>linksfor.dev(s) - HTTP headers for the responsible developer</title>
<div class="readable">
        <h1>HTTP headers for the responsible developer</h1>
            <div>by By Stefan Judis&#xA;      2019-04-23</div>
            <div>Reading time: 23-29 minutes</div>
        <div>Posted here: 29 Apr 2019</div>
        <p><a href="https://www.twilio.com/blog/a-http-headers-for-the-responsible-developer">https://www.twilio.com/blog/a-http-headers-for-the-responsible-developer</a></p>
        <hr/>
<div id="readability-page-1" class="page"><section>
    
    
      <div><p><em>This article is a written version of the talk “HTTP headers for the responsible developer”. You can check </em><em><a href="https://speakerdeck.com/stefanjudis/http-headers-for-the-responsible-developer">the slides</a></em><em>&nbsp;or </em><em><a href="https://www.youtube.com/watch?v=1jD7dBsg_Nw&amp;list=PLPcgQFk9n9y_kZkCkvGhVhUnwhfypNoeI&amp;index=5">the recording</a></em><em>.</em></p>
<hr>
<p>Being online is the default state for many people these days. We all spend our time shopping, chatting, reading articles, and looking for information like directions. The web connects us with the whole world, but most certainly the web connects people. I myself have been using the web now for 20 years, and my relationship to it changed eight years ago when I became a web developer.</p>
<h3>Developers connect people. <br>Developers help people. <br>Developers enable people.</h3>
<p>Developers have the power to build the web for everyone, but that power needs to be used responsibly. What matters, in the end, is building things that help and enable people.</p>
<p>In this article, I want to share how HTTP headers can help you build better products for a better web for everyone.</p>
<h2>HTTP – HyperText Transfer Protocol</h2>
<p>Let’s talk about HTTP first. HTTP is the protocol used by computers to request and send data over the web.</p>
<p>When a browser requests a resource&nbsp;from a server it uses HTTP. This request includes a set of key-value pairs giving information like the version of the browser or what file formats it understands. These key-value pairs are called <strong>request headers</strong>.</p>
<p>The server answers with the requested resource&nbsp;but also sends <strong>response headers</strong>&nbsp;giving information on the resource or the server itself.</p></div>
    
      

<div>
    <div><pre><span><span>Request</span><span>:</span>
</span><span><span>GET</span> <span>https</span><span>://</span><span>the</span><span>-</span><span>responsible</span><span>.</span><span>dev</span><span>/</span>
</span><span><span>Accept</span><span>:</span> <span>text</span><span>/html,application/xhtml+xml,application/x</span><span>ml</span>
</span><span><span>Accept</span><span>-</span><span>Encoding</span><span>:</span> <span>gzip</span><span>,</span> <span>deflate</span><span>,</span> <span>br</span>
</span><span><span>Accept</span><span>-</span><span>Language</span><span>:</span> <span>en</span><span>-</span><span>GB</span><span>,</span><span>en</span><span>-</span><span>US</span><span>;</span><span>q</span><span>=</span><span>0.9</span><span>,</span><span>en</span><span>;</span><span>q</span><span>=</span><span>0.8</span><span>,</span><span>de</span><span>;</span><span>q</span><span>=</span><span>0.7</span>
</span><span><span>...</span>
</span><span>
</span><span><span>Response</span><span>:</span>
</span><span><span>Connection</span><span>:</span> <span>keep</span><span>-</span><span>alive</span>
</span><span><span>Content</span><span>-</span><span>Type</span><span>:</span> <span>text</span><span>/</span><span>html</span><span>;</span> <span>charset</span><span>=</span><span>utf</span><span>-</span><span>8</span>
</span><span><span>Date</span><span>:</span> <span>Mon</span><span>,</span> <span>11</span> <span>Mar</span> <span>2019</span> <span>12</span><span>:</span><span>59</span><span>:</span><span>38</span> <span>GMT</span>
</span><span><span>...</span>
</span><span><span>Response</span> <span>Body</span>
</span></pre></div>
</div>

    
      <div><p>HTTP is the foundation of the web today and it offers many ways to improve user experience. Let's dive into how you can use HTTP headers to build a web that is <strong>safe, affordable and respectful.</strong></p>
<h2>The web has to be safe</h2>
<p>I never used to feel unsafe while browsing the internet. The more I learned about the web, the more concerned I became though. You can read about <a href="https://shoptalkshow.com/episodes/special-one-one-hacker/">hackers potentially changing global CDN-hosted libraries</a>, <a href="https://thenextweb.com/contributors/2018/03/10/protect-website-cryptojacking-attacks/">random websites mining cryptocurrency in the browser of their visitors</a>&nbsp;and <a href="http://blog.npmjs.org/post/180565383195/details-about-the-event-stream-incident">people social engineering their way into successful open source projects regularly</a>. That’s not good, but why should you care?</p>
<p>If you’re building for the web today, it is not only you writing the code. Web development these days includes lots of people working on the same site. You are probably shipping lots of open source code, too. Additionally, you may include several third-party scripts for marketing purposes. Hundreds of people provide the code running on your site. Developers have to deal with this reality.</p>
<p>Should you trust all these people and all their source code?</p>
<p>I don’t think you can trust any third party code out there. Luckily, there are ways to secure your site and make it safer. Additionally, tools like <a href="https://www.twilio.com/blog/securing-your-express-app-html">helmet can be helpful to secure e.g. your express application</a>.</p>
<p><em>If you want to analyze how much 3rd party code runs on your website, you can have a look at the network panel of your developer tools of choice or can give </em><em><a href="http://requestmap.webperf.tools/">Request Map Generator</a></em><em>&nbsp;a try.</em></p>
<h3>HTTPS and&nbsp;HSTS – make sure your connection is safe</h3>
<p>A secure connection is the foundation of a safe internet. Without encrypted <a href="https://developers.google.com/web/fundamentals/security/encrypt-in-transit/why-https">requests running over </a><a href="https://developers.google.com/web/fundamentals/security/encrypt-in-transit/why-https">HTTPS</a>, you cannot be sure that there is no one in between your site and your visitors. A person can quickly spin up a public wifi network and perform <a href="https://www.troyhunt.com/the-beginners-guide-to-breaking-website/">a </a><a href="https://www.troyhunt.com/the-beginners-guide-to-breaking-website/">man in the middle attack</a><a href="https://www.troyhunt.com/the-beginners-guide-to-breaking-website/">&nbsp;against anyone who connects</a>. How often do you use public wifi? And moreover, how often do you check if it’s trustworthy?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>Luckily, <a href="https://letsencrypt.org/">TLS certificates are free today</a>;&nbsp;HTTPS has become a standard and browser vendors allow cutting-edge features only over secure connections and even mark non-HTTPS websites as unsafe, which drives HTTPS adoption. Unfortunately, we’re not browsing safe all the time. When someone wants to open a website they are not entering the protocol into the address bar (and why should they?). This action leads to an unencrypted HTTP request. Securely running sites then redirect to HTTPS. But what if someone intercepts the first unsecured request?</p>
<p>You can use <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security">HSTS</a>&nbsp;response headers (HTTP Strict Transport Security) to tell browsers that your site only works via HTTPS.</p></div>
    
      

<div>
    <div><pre><span><span>Strict-Transport-Security: max-age=1000; includeSubDomains; preload</span>
</span></pre></div>
</div>

    
      <div><p>This header tells the browser that you don’t want to use HTTP requests, and it will automatically make the following requests to the same origin with a secured connection. When you try to access the same URL via HTTP again browsers will use HTTPS and redirect internally.</p>
<p>You can configure how long this setting should be active (<code>max-age</code> in seconds) for the case that you might want to use HTTP again. If you want to include subdomains you can configure that using <code>includeSubDomains</code> too.</p>
<p>If you want to go the extra mile and want to ensure a browser will never request your site over HTTP, you can also set the <code>preload</code> directive and <a href="https://hstspreload.org/">submit your site</a>&nbsp;to a global list. If your site’s HSTS configuration fulfills the requirements of a minimum <code>max-age</code> of one year and is active for subdomains it can be included in an internal browser record of sites that only work over HTTPS.</p>
<p>Did you ever wonder why you can’t use local environments&nbsp;like <code>my-site.dev</code> via HTTP with your browser anymore? This internal record is the reason – <code>.dev</code> domains are automatically included in this list since it became a real top-level domain in February 2019.</p>
<p>The HSTS header not only makes your site a little bit safer but also speeds it up. Imagine someone visiting your site on a slow mobile connection. If the first request is made via HTTP only to receive a redirect the user can spend several seconds without seeing anything. Using HSTS, you can save these seconds, and the browser uses HTTPS automatically.</p>
<h3>CSP – be clear about what is allowed on your site</h3>
<p>Now that your site runs over a secure connection you might run into the problem that browsers start blocking requests that go out to an insecure address due to mixed-content policies. The <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy (CSP)</a>&nbsp;header offers an excellent way to handle these cases. You can define your CSP ruleset via meta elements in your served HTML or via HTTP headers.</p></div>
    
      

<div>
    <div><pre><span><span>Content-Security-Policy: upgrade-insecure-requests</span>
</span></pre></div>
</div>

    
      <div><p>The <code>upgrade-insecure-requests</code> directive tells the browser to upgrade all HTTP requests&nbsp;to HTTPS magically.</p>
<p>CSP is not only about the used protocol though. It offers granular ways to define what resources and actions are allowed on your site. You can define for example which scripts should be executed or where images should be loaded from. If something is not allowed the browser blocks it and prevents your site from potential attacks.</p>
<p><img alt="Browser console telling that it blocked requests violating CSP rules" height="247" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/OgnYZBz1NTYoxy42rxnEatqsFJoozi-T6o5G9apTEAIZcM.width-800.jpg" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/OgnYZBz1NTYoxy42rxnEatqsFJoozi-T6o5G9apTEAIZcM.width-800.jpg 800w, https://twilio-cms-prod.s3.amazonaws.com/images/OgnYZBz1NTYoxy42rxnEatqsFJoozi-T6o5G9apTEAIZc.width-1600.jpg 1098w" width="800"></p>
<p>At the time of writing, there are 24 different configuration options for CSP. These options range from scripts over stylesheets to even service worker origins.</p>
<p><img alt="Overview of 24 CSP directives listed on MDN" height="433" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/Q0VKdwaOOJg19jVUtF-H2nyr_cU1L5B8zxjkM9vCEo2CsH.width-800.png" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/Q0VKdwaOOJg19jVUtF-H2nyr_cU1L5B8zxjkM9vCEo2CsH.width-800.png 800w, https://twilio-cms-prod.s3.amazonaws.com/images/Q0VKdwaOOJg19jVUtF-H2nyr_cU1L5B8zxjkM9vCEo2Cs.width-1600.png 1600w" width="800"></p>
<p><em>You can find a complete overview </em><em><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">on MDN</a></em><em>.</em></p>
<p>Using CSP, you can nail down what your site should include and what not.</p></div>
    
      

<div>
    <div><pre><span><span>Content-Security-Policy: default-src 'self'; script-src 'self' just-comments.com www.google-analytics.com production-assets.codepen.io storage.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: images.contentful.com images.ctfassets.net www.gravatar.com www.google-analytics.com just-comments.com; font-src 'self' data:; connect-src 'self' cdn.contentful.com images.contentful.com videos.contentful.com images.ctfassets.net videos.ctfassets.net service.just-comments.com www.google-analytics.com; media-src 'self' videos.contentful.com videos.ctfassets.net; object-src 'self'; frame-src codepen.io; frame-ancestors 'self'; worker-src 'self'; block-all-mixed-content; manifest-src 'self' 'self'; disown-opener; prefetch-src 'self'</span>
</span></pre></div>
</div>

    
      <div><p>The ruleset above is the one I ship for my personal site and if you think that this CSP example definition is very tough to come up with – you’re entirely right. Implementing the CSP ruleset on my personal site took me three attempts to get right. I deployed it and rolled back because it broke my site several times. There is a better way to do this.</p>
<p>To avoid breaking your site, CSP also provides a report-only option.</p></div>
    
      

<div>
    <div><pre><span><span>Content-Security-Policy-Report-Only: default-src 'self'; ... report-uri https://stefanjudis.report-uri.com/r/d/csp/reportOnly</span>
</span></pre></div>
</div>

    
      <div><p>Using the <code>Content-Security-Policy-Report-Only</code> mode browsers only log resources that would be blocked to the console instead of blocking them. This reporting mechanism gives you a way to check and adjust your ruleset.</p>
<p>Both headers, <code>Content-Security-Policy</code> and <code>Content-Security-Policy-Report-Only</code>, also offer a way to define an endpoint to send the violation and log information to (<code>report-uri</code>). You can set up a logging server and use the sent log information to tweak your CSP rules until it’s ready to ship.</p>
<p>The recommended process is: deploy CSP in report mode only first, analyze the incoming violations with real traffic, and only when there are no violations of your controlled resources showing up anymore turn it on.</p>
<p><em>If you’re looking for a service that can help you deal with these logs, I’m using </em><em><a href="https://report-uri.com/">Report URI</a></em><em>, and it’s a great help.</em></p>
<h4>Overall CSP adoption</h4>
<p><a href="https://caniuse.com/#search=csp">Browser support for CSP is good these days</a>, but unfortunately, not many sites are using it. To see how many sites serve content with CSP I ran a query <a href="https://httparchive.org/">on HTTP Archive</a>&nbsp;and found out that only 6% of the crawled sites use CSP. I think we can do better to make the web a safer place and to avoid our <a href="https://thenextweb.com/contributors/2018/03/10/protect-website-cryptojacking-attacks/">users </a><a href="https://thenextweb.com/contributors/2018/03/10/protect-website-cryptojacking-attacks/">mining </a><a href="https://thenextweb.com/contributors/2018/03/10/protect-website-cryptojacking-attacks/">cryptocurrency without knowing it</a>.<img alt="Pie chart showing that 6% of all sites use CSP" height="631" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/jAQW_VflYXdzcl9ER0yTVPGpTBRQAOVZrIvgjSW6ucayZH.width-800.jpg" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/jAQW_VflYXdzcl9ER0yTVPGpTBRQAOVZrIvgjSW6ucayZH.width-800.jpg 800w, https://twilio-cms-prod.s3.amazonaws.com/images/jAQW_VflYXdzcl9ER0yTVPGpTBRQAOVZrIvgjSW6ucayZ.width-1600.jpg 1046w" width="800"></p>
<h2>The web has to be affordable</h2>
<p>While I write this article, I sit in front of a relatively new MacBook using my fast Wi-Fi connection at home. Developers often forget that a setup like this is not the default for most of our users. People visiting our sites use old phones and are on crappy connections. Heavy and bloated sites with hundreds of requests give them a bad experience.</p>
<p>It’s not only about the experience though. <a href="https://whatdoesmysitecost.com/">People pay different amounts for data depending on where they live</a>. Imagine, you’re building a hospital site. The information on this particular site might be crucial and life-saving for people.</p>
<p>If a page on a hospital site is 5MB it is not only slow but also could be too expensive for people needing it the most. The price of 5MB in Europe or the United States is nothing&nbsp;compared to the price of 5MB of data in Africa. Developers are responsible for keeping the web affordable for everybody. This responsibility includes serving the right resources, evaluation of the right tools to use (do you really need a JS framework for a landing page?), and avoiding requests.</p>
<h3>Cache-Control – avoid requests for the unchanged resources</h3>
<p>A website today easily contains hundreds of resources ranging from stylesheets to script files to images. <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control">Using the <code>Cache-Control</code> header</a>&nbsp;developers can define how long a resource should be considered “fresh” and can be served from the browser cache.</p></div>
    
      

<div>
    <div><pre><span><span>Cache-Control: max-age=30, public</span>
</span></pre></div>
</div>

    
      <div><p>By setting proper <code>Cache-Control</code> data transfer is saved, and files can be used from the browser cache for a certain amount of seconds (<code>max-age</code>). Browsers should revalidate cached resources after the time span is over.</p>
<p>However, when visitors refresh a page, <a href="https://code.fb.com/web/this-browser-tweak-saved-60-of-requests-to-facebook/">browsers still revalidate the page including referenced resources</a>&nbsp;to ensure the cached data is still valid. Servers respond with a 304 header signaling that the cached data is still good or 200 serving the updated data. This can save transferred data but not necessarily made requests.</p>
<p>This is where the <code>immutable</code> feature comes into play.</p>
<h4>immutable – never request a resource twice</h4>
<p>In modern Frontend applications, stylesheet and script files usually have a unique file name like <code>styles.123abc.css</code>. This file name depends on the contents of the particular file. When the content of these files changes, it results in a different file name.</p>
<p>These unique files could potentially be cached forever including the situation when a user refreshes a page. <a href="https://hacks.mozilla.org/2017/01/using-immutable-caching-to-speed-up-the-web/">The <code>immutable</code> feature</a>&nbsp;can tell the browser not to revalidate a resource in a certain timeframe. This makes much sense for finger-printed assets and helps to avoid revalidation requests.</p></div>
    
      

<div>
    <div><pre><span><span>Cache-Control: max-age=31536000, public, immutable</span>
</span></pre></div>
</div>

    
      <div><p><strong>Optimal caching is very hard and in particular browser caching is not very intuitive because it provides multiple configurations. I recommend having a look at the following resources:</strong></p>
<ul>
<li>Harry Roberts wrote <a href="https://csswizardry.com/2019/03/cache-control-for-civilians/">an excellent guide about cache-control and its settings</a></li>
<li>Jake Archibald gave advice on <a href="https://jakearchibald.com/2016/caching-best-practices/">caching best practices</a>&nbsp;in visual detail</li>
<li>Ilya Grigorik provided <a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching">a nice how to flow diagram on caching headers</a></li>
</ul>
<h3>Accept-Encoding – compress to the maximum (uhm… minimum)</h3>
<p>Using <code>Cache-control</code>, we can save requests and reduce the amount of data that repeatedly goes over the wire. We can not only save requests but also shrink what is transferred.</p>
<p>When serving resources, developers should make sure to send as little data as possible. For text-based resources like HTML, CSS and JavaScript compression plays a significant role in saving transferred data.</p>
<p>The most commonly used compression these days is GZIP. Servers are fast enough to compress text files on the fly and serve compressed data when requested. GZIP is not the best option anymore though.</p>
<p>If you inspect the requests your browser makes for text-based files like HTML, CSS, and JavaScript and have a look at the request headers you’ll find the <code>accept-encoding</code> header.</p></div>
    
      

<div>
    <div><pre><span><span>Accept-Encoding: gzip, deflate, br</span>
</span></pre></div>
</div>

    
      <div><p>This header tells the server what compression algorithms it understands. The not so well known <code>br</code> stands for <a href="https://github.com/google/brotli">Brotli compression</a>&nbsp;and is the compression used by high-traffic sites like Google and Facebook. To use Brotli your site has to run on HTTPS.</p>
<p>This compression algorithm was created with small file sizes in mind. When you give it a try on your local machine and compress a file by hand, you’ll find out that Brotli indeed compresses better than GZIP.</p>
<p><img alt="Terminal with the same css files. Original size 101kb, gzip compressed size 15kb and brotli compressed size 9.4kb" height="331" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/WdigoLiMIP2UPVhDrABHt_bJYNztLyO6-FFLQ8Jo8wyrXh.width-800.jpg" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/WdigoLiMIP2UPVhDrABHt_bJYNztLyO6-FFLQ8Jo8wyrXh.width-800.jpg 800w, https://twilio-cms-prod.s3.amazonaws.com/images/WdigoLiMIP2UPVhDrABHt_bJYNztLyO6-FFLQ8Jo8wyrX.width-1600.jpg 1372w" width="800"></p>
<p>You may have heard that Brotli compression performs slower, too. The reason for that is that Brotli has 11 compression modes and the default mode was chosen to guarantee small file sizes resulting in long encoding times. GZIP, on the other hand, has 9 modes and the default mode was chosen taking both, speed and file size, into consideration.</p>
<p>This decision makes Brotli’s default mode unsuitable for on-the-fly compression, but if you change the compression mode you can achieve smaller file sizes with comparable speed to GZIP. You can even use it to compress on-the-fly and treat it as a potential GZIP replacement for supporting browsers.</p>
<p>In addition to that, if you want to gain maximal file savings you could forget the idea of dynamically compressing your files and pre-generate <a href="https://www.telerik.com/blogs/maximize-compression-with-zopfli">optimized GZIP files using zopfli</a>&nbsp;and Brotli files in your build process to statically serve them.</p>
<p><em>If you want to read more about Brotli compression and how it compares to GZIP, the folks at Akamai did </em><em><a href="https://blogs.akamai.com/2016/02/understanding-brotlis-potential.html">extensive research around this topic</a></em><em>.</em></p>
<h3>Accept and Accept-CH – serve tailored resources to the user</h3>
<p>Optimizing text assets is great to save kilobytes but what about the heavier resources like images to save even more data.</p>
<h4>Accept – serve the right image format</h4>
<p>Browsers not only tell us about what compression algorithms they understand. When your browser requests an image, it also gives information about what file formats it understands.</p></div>
    
      

<div>
    <div><pre><span><span>Accept</span><span>:</span> <span>image</span><span>/webp, image/apng, image/*,*/</span><span>*;</span><span>q</span><span>=</span><span>0.8</span>
</span></pre></div>
</div>

    
      <div><p>The competition around a new image format was on for a few years, but now it looks like <code>webp</code> won. <a href="https://developers.google.com/speed/webp/">Webp is an image format invented by Google</a>,&nbsp;and <a href="https://caniuse.com/#feat=webp">the support for webp images</a>&nbsp;is pretty good these days.</p>
<p>Using this request header, developers can serve a <code>webp</code> image&nbsp;even when the browser requested <code>image.jpg</code> which results in smaller file size. Dean Hume wrote <a href="https://deanhume.com/service-workers-dynamic-responsive-images-using-webp-images/">a nice guide</a>&nbsp;on how to do this in a service worker. That’s pretty cool!</p>
<p><img alt="Chrome network panel showing a request for a JPEG which gets a webp response" height="541" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/9JczExPcmc402uz1B2mY_KmhuaQNl6UExmSYcs2ZH7yNDk.width-800.jpg" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/9JczExPcmc402uz1B2mY_KmhuaQNl6UExmSYcs2ZH7yNDk.width-800.jpg 800w, https://twilio-cms-prod.s3.amazonaws.com/images/9JczExPcmc402uz1B2mY_KmhuaQNl6UExmSYcs2ZH7yND.width-1600.jpg 1600w" width="800"></p>
<h4>Accept-CH - serve a properly sized image</h4>
<p>You can also enable <a href="https://developers.google.com/web/updates/2015/09/automating-resource-selection-with-client-hints">client hints</a>&nbsp;for supporting browsers. Client hints are a way to tell browsers to send additional headers giving information on viewport width, image width and even network conditions like RTT (round trip time) and connection type like <code>2g</code>.</p>
<p>You can enable them by including a meta element:</p></div>
    
      

<div>
    <div><pre><span><span>&lt;</span><span>meta</span> <span>http-equiv</span><span>=</span><span>"Accept-CH"</span> <span>content</span><span>=</span><span>"Viewport-Width, Downlink"</span><span>&gt;</span>
</span><span><span>&lt;</span><span>meta</span> <span>http-equiv</span><span>=</span><span>"Accept-CH-Lifetime"</span> <span>content</span><span>=</span><span>"86400"</span><span>&gt;</span>
</span></pre></div>
</div>

    
      <p>Or setting headers on the initial HTML request:</p>
    
      

<div>
    <div><pre><span><span>Accept-CH: Width, Viewport-Width</span>
</span><span><span>Accept-CH-Lifetime: 100</span>
</span></pre></div>
</div>

    
      <div><p>Supporting browsers will start sending additional information for the defined timespan (<code>Accept-CH-Lifetime</code> in seconds) in the following requests that can help developers to tailor for examples images to user conditions without changing any HTML.</p>
<p>To receive for example additional information like image width on the server side you can equip your images with a <code>sizes</code> attribute to give the browser additional information on how this image will be laid out.</p></div>
    
      

<div>
    <div><pre><span><span>&lt;!-- this images is laid over the full width | 100 viewport width --&gt;</span>
</span><span><span>&lt;</span><span>img</span> <span>class</span><span>=</span><span>"w-100"</span> <span>src</span><span>=</span><span>"/img/header.jpg"</span> <span>alt</span><span>=</span><span>""</span> <span>sizes</span><span>=</span><span>"100vw"</span><span>&gt;</span>
</span></pre></div>
</div>

    
      <div><p>With the initially received <code>Accept-CH</code> response header and images equipped with the <code>sizes</code> attribute supporting browsers will include <code>viewport-width</code> and <code>width</code> headers in the image requests telling you what image would be the best fit.</p>
<p><img alt="Chrome network panel showing a request including viewport-width and width header for a particular image" height="541" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/8u07oEaYg3fBaV6Z35RcBDXW7hehK8wPrPSthhRpQlHN3i.width-800.jpg" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/8u07oEaYg3fBaV6Z35RcBDXW7hehK8wPrPSthhRpQlHN3i.width-800.jpg 800w, https://twilio-cms-prod.s3.amazonaws.com/images/8u07oEaYg3fBaV6Z35RcBDXW7hehK8wPrPSthhRpQlHN3.width-1600.jpg 1600w" width="800"></p>
<p>Having the supported image format and image dimensions at hand you can send tailored media without the need to write error-prone&nbsp;picture elements&nbsp;taking care of file formats and sizes like the following repeatedly.</p></div>
    
      

<div>
    <div><pre><span><span>&lt;</span><span>picture</span><span>&gt;</span>
</span><span>  <span>&lt;!-- serve WebP to Chrome, Edge, Firefox and Opera --&gt;</span>
</span><span>  <span>&lt;</span><span>source</span>
</span><span>    <span>media</span><span>=</span><span>"(min-width: 50em)"</span>
</span><span>    <span>sizes</span><span>=</span><span>"50vw"</span>
</span><span>    <span>srcset</span><span>=</span><span>"/image/thing-200.webp 200w, /image/thing-400.webp 400w,</span>
</span><span><span>        /image/thing-800.webp 800w, /image/thing-1200.webp 1200w,</span>
</span><span><span>        /image/thing-1600.webp 1600w, /image/thing-2000.webp 2000w"</span>
</span><span>    <span>type</span><span>=</span><span>"image/webp"</span><span>&gt;</span>
</span><span>  <span>&lt;</span><span>source</span>
</span><span>    <span>sizes</span><span>=</span><span>"(min-width: 30em) 100vw"</span>
</span><span>    <span>srcset</span><span>=</span><span>"/image/thing-crop-200.webp 200w, /image/thing-crop-400.webp 400w,</span>
</span><span><span>        /image/thing-crop-800.webp 800w, /image/thing-crop-1200.webp 1200w,</span>
</span><span><span>        /image/thing-crop-1600.webp 1600w, /image/thing-crop-2000.webp 2000w"</span>
</span><span>    <span>type</span><span>=</span><span>"image/webp"</span><span>&gt;</span>
</span><span> <span>&lt;!-- serve JPEG to others --&gt;</span>
</span><span>  <span>&lt;</span><span>source</span>
</span><span>    <span>media</span><span>=</span><span>"(min-width: 50em)"</span>
</span><span>    <span>sizes</span><span>=</span><span>"50vw"</span>
</span><span>    <span>srcset</span><span>=</span><span>"/image/thing-200.jpg 200w, /image/thing-400.jpg 400w,</span>
</span><span><span>        /image/thing-800.jpg 800w, /image/thing-1200.jpg 1200w,</span>
</span><span><span>        /image/thing-1600.jpg 1600w, /image/thing-2000.jpg 2000w"</span><span>&gt;</span>
</span><span>  <span>&lt;</span><span>source</span>
</span><span>    <span>sizes</span><span>=</span><span>"(min-width: 30em) 100vw"</span>
</span><span>    <span>srcset</span><span>=</span><span>"/image/thing-crop-200.jpg 200w, /image/thing-crop-400.jpg 400w,</span>
</span><span><span>        /image/thing-crop-800.jpg 800w, /image/thing-crop-1200.jpg 1200w,</span>
</span><span><span>        /image/thing-crop-1600.jpg 1600w, /image/thing-crop-2000.jpg 2000w"</span><span>&gt;</span>
</span><span>  <span>&lt;!-- fallback for browsers that don't support picture --&gt;</span>
</span><span>  <span>&lt;</span><span>img</span> <span>src</span><span>=</span><span>"/image/thing.jpg"</span> <span>width</span><span>=</span><span>"50%"</span><span>&gt;</span>
</span><span><span>&lt;/</span><span>picture</span><span>&gt;</span>
</span></pre></div>
</div>

    
      <div><p>With the possibility to access viewport width and image sizes you can potentially move asset resize logic in a central place on your servers.</p>
<p>You have to consider though, that just because you have the exact image width at hand you don’t want to create images for every width. Sending images for certain dimension ranges (<code>image-200</code>, <code>image-300</code>, ...) helps to leverage CDN caches and saves computation time.</p>
<p>Additionally, with current technologies like service workers, you could even intercept and change request right in the client to serve the best image files. With enabled client hints service workers have access to layout information and in combination with an images API like for example <a href="https://cloudinary.com/">Cloudinary</a>&nbsp;you could adjust the image url right in the browser to receive properly sized images.</p>
<p><em>If you’re looking for more information on client hints, you can check </em><em><a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/client-hints/">Jeremy Wagner’s article</a></em><em>&nbsp;or </em><em><a href="https://developers.google.com/web/updates/2015/09/automating-resource-selection-with-client-hints">Ilya Grigorik’s article</a></em><em>&nbsp;on the topic.</em></p>
<h2>The web has to be respectful</h2>
<p>With all of us being online many hours a day there is the last aspect that I consider to be very important – the web has to be respectful.</p>
<h3>preload – reduce the waiting time</h3>
<p>As developers, we want to make sure to value the time of our users. Nobody wants to waste time. As discussed in the previous sections serving the right data plays a big role in saving time and data. It’s not only about what requests are made but also about the timing and order of these.</p>
<p>Let’s think of an example: if you include a stylesheet in your site browsers will show nothing until it is loaded. While nothing is displayed the browser still continues to parse the HTML looking for other resources to fetch. When the stylesheet is loaded and parsed it might include references to other critical resources like fonts which have to be requested. This sequential process can increase the loading time for your visitors.</p>
<p><a href="https://www.w3.org/TR/preload/">Using the <code>rel=preload</code></a>&nbsp;you can give the browser information on what resources will be requested in the near future.</p>
<p>You can preload resources via HTML elements:</p></div>
    
      

<div>
    <div><pre><span>  <span>&lt;</span><span>link</span> <span>rel</span><span>=</span><span>"preload"</span> <span>href</span><span>=</span><span>"/font.woff2"</span> <span>as</span><span>=</span><span>"font"</span> <span>type</span><span>=</span><span>"font/woff2"</span> <span>crossorigin</span><span>=</span><span>"anonymous"</span><span>&gt;</span>
</span></pre></div>
</div>

    
      <p>Or headers:</p>
    
      

<div>
    <div><pre><span><span>Link: &lt;/font.woff2&gt;; rel=preload; as=font; no-push</span>
</span></pre></div>
</div>

    
      <div><p>This way the browser receives the header or discovers the link element and immediately requests the resources so that these sit already in the browser cache when they are needed. This process values your visitor’s time.</p>
<p>To preload your resources in the best way and understand all the configurations I recommend having a look at the following resources:</p>
<ul>
<li><a href="https://twitter.com/yoavweiss">Yoav Weiss</a>&nbsp;is an expert on preload and published <a href="https://www.smashingmagazine.com/2016/02/preload-what-is-it-good-for/">great resources</a>&nbsp;around it</li>
<li><a href="https://twitter.com/addyosmani">Addy Osmani</a>&nbsp;went into <a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">great detail on preload and other mechanisms like <code>prefetch</code> and <code>preconnect</code></a></li>
</ul>
<h3>Feature-Policy – don’t be the annoying person</h3>
<p>If there is one last thing that I don’t want to see any longer, it is websites asking me for permissions for no reason. I can only quote <a href="https://youtu.be/uo-UOvq3-0Y?t=1020">my colleague Phil Nash on that topic</a>.</p>
<blockquote>Do not demand notification permission on page load.</blockquote>
<p>Developers should be respectful and not build sites that annoy their visitors. People just click away all the permission dialogs. Websites and developers lose much trust, and all the new shiny web features will lose their power if we as developers are not using them carefully.</p>
<p>However, what if it is mandatory for your site to include lots of third-party code and all these scripts trigger one permission dialog after another? How can you make sure that all of the included scripts behave?</p>
<p>This is where <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Feature-Policy">the <code>Feature-Policy</code> header</a>&nbsp;comes into play. Using this header you can define what features are allowed and limit the popping up permission dialogs that may be triggered by someone else running code in your site.</p></div>
    
      

<div>
    <div><pre><span><span>Feature-Policy: vibrate 'none'; geolocation 'none'</span>
</span></pre></div>
</div>

    
      <p>You can define it for your site using headers but also define it for embedded content like iframes which can be mandatory for third-party integrations.</p>
    
      

<div>
    <div><pre><span><span>&lt;</span><span>iframe</span> <span>allow</span><span>=</span><span>"camera 'none'; microphone 'none'"</span><span>&gt;</span>
</span></pre></div>
</div>

    
      <div><p>At the time of writing <code>Feature-Policy</code> is highly experimental but if you have a look at upcoming options, it’s very exciting. In the not too distant future developers cannot only limit themselves and prevent the shipping of annoying dialogs but also potentially block non-optimized media. These features will make a big difference in user experience.</p>
<p><img alt="Overview of 24 Feature policy directives listed on MDN" height="428" sizes="800px" src="https://twilio-cms-prod.s3.amazonaws.com/images/9kC_q_Icf-bbsY5eGHjS0u3KTLtTpM__7uqqmh-WfVgPc6.width-800.jpg" srcset="https://twilio-cms-prod.s3.amazonaws.com/images/9kC_q_Icf-bbsY5eGHjS0u3KTLtTpM__7uqqmh-WfVgPc6.width-800.jpg 800w, https://twilio-cms-prod.s3.amazonaws.com/images/9kC_q_Icf-bbsY5eGHjS0u3KTLtTpM__7uqqmh-WfVgPc.width-1600.jpg 1600w" width="800"></p>
<p><em>You can find a complete overview </em><em><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Feature-Policy">on MDN</a>.</em></p>
<p>Looking at the feature policy list above you might wonder what happened to the most annoying one – push notifications. It turned out that the implementation of <code>Feature-Policy</code> for push notifications is harder than expected. You can follow <a href="https://github.com/w3c/webappsec-feature-policy/issues/243">the filed GitHub issue</a>&nbsp;if you want to learn more.</p>
<p>Using feature policy, you can make sure that you and your third parties won’t turn your site into <a href="https://2018.bloomca.me/">a permission dismissal race</a>&nbsp;which unfortunately is already the default state for many sites today.</p>
<h2>The web has to be for everybody</h2>
<p>In this article, I only covered a few headers that could help improve the user experience. If you want to see an almost complete overview of headers and their possibilities I can recommend having a look at <a href="https://mobile.twitter.com/derSchepp">Christian Schaefer</a>’s slide deck <a href="https://schepp.github.io/HTTP-headers">“HTTP headers – the hidden champions”</a>.</p>
<p>I know that building a great website today is very challenging. Developers have to consider designs, devices, frameworks, and yes… headers play a role, too. Hopefully, this article gave you some ideas and you’ll consider safety, affordability, and respect in your next web projects because these are the factors that make the web truly great for everybody.</p>
<hr>
<p>If you want to say “Hi” you can reach me under the following channels:</p>
<ul>
<li>Email: <a href="mailto:sjudis@twilio.com">sjudis@twilio.com</a></li>
<li>Github: <a href="https://github.com/stefanjudis">stefanjudis</a></li>
<li>Twitter: <a href="https://twitter.com/stefanjudis">@stefanjudis</a></li>
</ul></div>
    

    

    


    
      




    
  </section></div></div>
    </div>
    <footer>
        <div>created by buildstarted &copy; 2020 <a href="/about">about</a></div>
        <div>Share this page on social media: copy and paste this url https://linksfor.dev/</div>
        <div>If you prefer RSS: <a href="https://linksfor.dev/feed.xml">https://linksfor.dev/feed.xml</a></div>
        <div>Customer satisfaction guaranteed to be optional.</div>
    </footer>
    
    <script async defer>
        _dna = window._dna || {};
        _dna.siteId = "linksfor.devs";
        _dna.outlink = true;

        (function() {
            let dna = document.createElement('script');
            dna.type = 'text/javascript';
            dna.async = true;
            dna.src = '//dna.buildstarted.com/t.js';
            let s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(dna, s);
        })();
    </script>
    <noscript><img src="//dna.buildstarted.com/g?siteId=linksfor.devs"/></noscript>
</body>
</html>